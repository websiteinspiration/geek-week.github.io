<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüé§ ü•Ç üîç Avalia√ß√£o integrada de m√©tricas de carga do servidor üíÉüèø üëçüèΩ üëàüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Trabalhando em um dos maiores bancos do pa√≠s, tive que lidar com a tarefa de avaliar a efici√™ncia do uso de recursos de aproximadamente 16 mil servido...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Avalia√ß√£o integrada de m√©tricas de carga do servidor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498360/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalhando em um dos maiores bancos do pa√≠s, tive que lidar com a tarefa de avaliar a efici√™ncia do uso de recursos de aproximadamente 16 mil servidores. </font><font style="vertical-align: inherit;">A tarefa foi formulada com muita simplicidade - era necess√°rio desenvolver uma metodologia para avaliar as m√©tricas de carga do servidor por um per√≠odo. </font><font style="vertical-align: inherit;">Idealmente, a carga do servidor por per√≠odo deve ser estimada usando um ou v√°rios (n√£o mais que 8) n√∫meros.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algumas palavras sobre os recursos do uso de servidores virtuais</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grandes organiza√ß√µes (especialmente bancos) t√™m um zool√≥gico heterog√™neo de aplicativos herdados implantados em diferentes servidores, usando uma variedade de tecnologias de virtualiza√ß√£o. Uma nuvem privada √© uma tecnologia promissora, mas, na realidade, grandes organiza√ß√µes usar√£o por muito tempo v√°rias plataformas de virtualiza√ß√£o para implantar uma variedade de aplicativos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä medida que as plataformas de virtualiza√ß√£o evoluem, chega um momento em que ningu√©m na empresa consegue entender com que efici√™ncia os recursos s√£o usados. Mesmo as ferramentas de monitoramento mais avan√ßadas n√£o fornecem uma resposta para essa pergunta devido a v√°rios cen√°rios de uso do servidor. Por exemplo, um departamento pode ter um servidor de relat√≥rio que ser√° totalmente carregado por apenas um per√≠odo limitado. Diga 3-4 horas no final do m√™s. Em cen√°rios da vida real, ningu√©m aloca recursos dinamicamente para esses servidores - isso √© dif√≠cil t√©cnica e organizacionalmente. Os recursos s√£o alocados especificamente para a carga m√°xima peri√≥dica do servidor, embora isso ocorra com pouca frequ√™ncia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resumo, em grandes organiza√ß√µes, os recursos do farm virtual s√£o gastos de maneira extremamente ineficiente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir, proponho uma metodologia com a qual voc√™ pode facilmente justificar o aumento e a diminui√ß√£o de recursos alocados ao servidor virtual, independentemente do cen√°rio.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metodologia</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para avaliar a carga de recursos, √© necess√°rio coletar estat√≠sticas de v√°rios contadores; para avaliar a carga de recursos, v√°rias m√©tricas ser√£o usadas. Convencionalmente, os contadores podem ser divididos em 2 tipos (de acordo com a taxa de varia√ß√£o): "r√°pido" e "lento". Um bom exemplo de contador "r√°pido" √© o contador de carga do processador (% de CPU). Um exemplo de contador lento √© a porcentagem de espa√ßo livre no disco r√≠gido (% FreeSpace). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A avalia√ß√£o de contadores lentos consiste em calcular o valor extremo (m√≠nimo ou m√°ximo) da m√©trica para o per√≠odo. Essa abordagem permite (por exemplo, ao avaliar o espa√ßo livre em disco) estimar o recurso livre e, se necess√°rio, alocar volumes adicionais ou reduzir os atuais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para contadores r√°pidos, uma abordagem diferente √© usada. As desvantagens do uso de m√©tricas integrais simples (m√©dia, m√°xima, m√≠nima e mediana) para avaliar a din√¢mica de tais contadores est√£o bem descritas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . As desvantagens comuns incluem a falta de informa√ß√µes sobre o aumento de cargas (m√©dio e pico). Se considerarmos o valor m√°ximo do per√≠odo como uma m√©trica integral, a presen√ßa de outliers (por exemplo, carregamento instant√¢neo da CPU de at√© 100% quando o programa for iniciado) n√£o fornecer√° informa√ß√µes objetivas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prop√µe-se usar o quantil 0,9 para estimar a m√©trica r√°pida (este √© um valor que indica o n√≠vel abaixo do qual o valor observado em 90% das amostras se encontra). Com uma carga uniforme do servidor de acordo com essa m√©trica, podemos estimar adequadamente a carga m√©dia do processador. Mas essa abordagem tem as mesmas desvantagens - a falta de informa√ß√µes sobre o aumento de cargas (m√©dio e pico). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abaixo, como ilustra√ß√£o, o gr√°fico semanal e di√°rio do contador de% de CPU. O valor m√°ximo do contador nos gr√°ficos foi de 100%.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ym/al/xi/ymalxitgoyqlsthnyhs0cjttbie.png"><br>
<br>
<img src="https://habrastorage.org/webt/wj/xk/aj/wjxkajy2y3enm93easqblqnl-x8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O gr√°fico mostra que, durante o per√≠odo indicado, h√° uma explos√£o de carga, que dura cerca de 3 horas. Para esse contador, v√°rias m√©tricas foram calculadas para a semana. A Figura 2 mostra que a mediana (linha verde, valor de 5%), a m√©dia (amarelo, valor de 12%) e o quantil 0,9 (vermelho, valor de 27%) filtram a altera√ß√£o da carga e as informa√ß√µes sobre ela s√£o perdidas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como um desenvolvimento da id√©ia de quantis, eu gostaria de propor a id√©ia de um quantil deslizante. Este √© um an√°logo da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©dia m√≥vel.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mas o quantil 0,9 √© usado como uma fun√ß√£o de janela. </font><font style="vertical-align: inherit;">Al√©m disso, usaremos 2 quantis deslizantes para estimar o n√≠vel do contador - r√°pido em um curto per√≠odo (1 hora) e lento em um longo per√≠odo (24 horas). </font><font style="vertical-align: inherit;">Um quantil r√°pido filtrar√° as emiss√µes instant√¢neas e fornecer√° informa√ß√µes de pico de carga. </font><font style="vertical-align: inherit;">Um quantil lento permitir√° estimar a carga m√©dia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver nos gr√°ficos, quantis m√≥veis de 0,9 s√£o caracter√≠sticas din√¢micas (marrom - r√°pido, roxo - lento). </font><font style="vertical-align: inherit;">Para simplificar, avaliando o status do contador como m√©tricas, prop√µe-se usar:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o valor m√°ximo do quantil com um per√≠odo de 1 hora, que mostra a carga m√°xima cont√≠nua do servidor para o per√≠odo,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o valor m√©dio do quantil com um per√≠odo de 24 horas, que mostra a carga m√©dia do servidor para o per√≠odo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No gr√°fico, o valor m√°ximo do quantil r√°pido √© a linha preta em 85%, o valor m√©dio do quantil lento √© a linha rosa em 30%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, ao analisar a carga de recursos do servidor (de acordo com o contador de% de CPU), se considerarmos a m√©dia do m√™s (12%) como uma m√©trica, podemos tomar uma decis√£o err√¥nea de reduzir os recursos alocados. </font><font style="vertical-align: inherit;">A m√©trica dupla de quantil de movimenta√ß√£o r√°pida / lenta (85 e 30%) mostra que h√° recursos alocados suficientes, mas n√£o h√° super√°vits.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decis√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A implementa√ß√£o da avalia√ß√£o da efici√™ncia do uso de recursos foi decomposta em tr√™s tarefas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cole√ß√£o de dados </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desenvolvimento de metodologia de avalia√ß√£o </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementa√ß√£o de metodologia na arquitetura atual </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acima, examinei a tarefa 2 desta implementa√ß√£o; abaixo, falaremos um pouco sobre a terceira tarefa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dados foram coletados no banco de dados ClickHouse. Esta coluna DBMS √© ideal para armazenar dados de s√©ries temporais. Isso foi discutido em detalhes no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouse Meetup</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em 5 de setembro de 2019. Uma compara√ß√£o do ClickHouse com outros DBMS de s√©ries temporais pode ser encontrada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado da coleta de dados, formamos v√°rias tabelas nas quais os dados foram organizados linha por linha (os valores de cada contador foram gravados em uma linha separada). E, claro, houve problemas com dados brutos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro problema √© a irregularidade dos intervalos entre as entradas do contador. Por exemplo, se o per√≠odo de grava√ß√£o do contador padr√£o fosse de 5 minutos, √†s vezes havia lacunas e o pr√≥ximo registro ficava a mais de 5 minutos (at√© 20 minutos) do registro anterior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo problema √© que, algumas vezes, os dados do contador vieram 2 ou mais vezes (com valores diferentes) com o mesmo registro de data e hora. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o terceiro problema - o ClickHouse n√£o possui fun√ß√µes de janela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver o primeiro problema, voc√™ pode usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASOF JOIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A id√©ia √© bastante simples - para cada contador de cada servidor criar uma tabela uniformemente com intervalos de tempo igualmente preenchidos. O uso do ASOF JOIN permite o preenchimento dos valores da nova tabela com os valores mais pr√≥ximos da tabela de dados brutos (as op√ß√µes de preenchimento semelhantes ao preenchimento e preenchimento podem ser configuradas). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solu√ß√£o para o segundo problema √© a agrega√ß√£o com a escolha do valor m√°ximo em um determinado momento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver o terceiro problema, v√°rias solu√ß√µes foram consideradas. </font><font style="vertical-align: inherit;">Primeiro, o script Python foi rejeitado devido ao desempenho insuficiente. </font><font style="vertical-align: inherit;">A segunda solu√ß√£o - copiar dados brutos para um banco de dados MSSQL, calcular m√©tricas e copiar de volta - parecia muito complicada de implementar. </font><font style="vertical-align: inherit;">O MSSQL tamb√©m possui fun√ß√µes de janela, mas n√£o √© necess√°ria nenhuma fun√ß√£o agregada. </font><font style="vertical-align: inherit;">Pode-se ficar confuso e escrever sua pr√≥pria fun√ß√£o SQL CLR. </font><font style="vertical-align: inherit;">Mas essa op√ß√£o foi rejeitada devido √† complexidade excessiva. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma solu√ß√£o funcional pode ser um script SQL para ClickHouse. </font><font style="vertical-align: inherit;">Um exemplo deste script √© dado abaixo. </font><font style="vertical-align: inherit;">Para simplificar, considerei calcular apenas o quantil r√°pido de um √∫nico contador para v√°rios servidores. </font><font style="vertical-align: inherit;">A solu√ß√£o n√£o parece muito simples e nem muito conveniente, mas funciona.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, um relat√≥rio de teste foi criado no PowerBI para demonstrar a metodologia. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qk/t9/kgqkt92tcilmz8h9gqieermwz3w.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/c_/m5/tk/c_m5tk-r1ehlvrdhh_dbsj3rzie.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Concluindo, gostaria de especular sobre o desenvolvimento da solu√ß√£o. </font><font style="vertical-align: inherit;">Se voc√™ observar a solu√ß√£o do ponto de vista dos data warehouses, poder√° ver que dessa maneira a tarefa de criar um data warehouse (Data Warehouse) a partir de uma camada de dados brutos (Staging Area) √© resolvida. </font><font style="vertical-align: inherit;">Voc√™ pode discutir a arquitetura, mas para o ClickHouse como banco de dados de colunas, a normaliza√ß√£o n√£o √© cr√≠tica (ou talvez at√© prejudicial). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desenvolvimento adicional do reposit√≥rio √© visto na cria√ß√£o de tabelas agregadas (dia \ semana \ m√™s) com diferentes vidas √∫teis (TTL). </font><font style="vertical-align: inherit;">Isso evitar√° o incha√ßo excessivo do armazenamento. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pr√≥xima etapa pode ser usar dados para an√°lises preditivas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo e os dados para teste est√£o publicados </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt498346/index.html">GoLand 2020.1 - Suporte aprimorado para os m√≥dulos Go, muito preenchimento autom√°tico e muito mais</a></li>
<li><a href="../pt498350/index.html">Os melhores materiais para entrevistas de emprego e pesquisas de emprego</a></li>
<li><a href="../pt498352/index.html">SHISHUA: o gerador de n√∫meros pseudo-aleat√≥rios mais r√°pido do mundo</a></li>
<li><a href="../pt498354/index.html">Como traduzir "Wishlist" em "hardware" ou semi-desktop semi-m√≥vel semi-ideal</a></li>
<li><a href="../pt498358/index.html">Aprenda franc√™s ou como obter um adaptador universal em um scanner de diagn√≥stico PSA</a></li>
<li><a href="../pt498362/index.html">A Kingston mant√©m a lideran√ßa nos envios de SSD: como fazemos?</a></li>
<li><a href="../pt498366/index.html">Quais algoritmos os desenvolvedores Yandex implementam todos os dias</a></li>
<li><a href="../pt498368/index.html">A hist√≥ria de um switch</a></li>
<li><a href="../pt498370/index.html">SAP UI5 e Windows de confirma√ß√£o: novamente sobre o contexto</a></li>
<li><a href="../pt498372/index.html">Tutorial do simulador de rede ns-3. cap√≠tulo 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>