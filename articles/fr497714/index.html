<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì≤ ü§õ üêè Comment prot√©ger les processus et les extensions du noyau sur macOS üëÜüèΩ üçΩÔ∏è ü§ôüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Aujourd'hui, je voudrais parler de la fa√ßon dont vous pouvez prot√©ger les processus contre les intrus dans macOS. Par exemple, il est u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment prot√©ger les processus et les extensions du noyau sur macOS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acronis/blog/497714/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font><font style="vertical-align: inherit;">Aujourd'hui, je voudrais parler de la fa√ßon dont vous pouvez prot√©ger les processus contre les intrus dans macOS. </font><font style="vertical-align: inherit;">Par exemple, il est utile pour un antivirus ou un syst√®me de sauvegarde, surtout √† la lumi√®re du fait que sous macOS, il existe plusieurs fa√ßons de ¬´tuer¬ª le processus. </font><font style="vertical-align: inherit;">Lisez √† ce sujet et sur les m√©thodes de protection sous un chat.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/403/e5f/065/403e5f065b7426d384f3c71e8cb3c8a5.jpg" alt="image"></a><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La mani√®re classique de tuer un processus</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mani√®re bien connue de ¬´tuer¬ª un processus consiste √† envoyer un signal concernant un processus SIGKILL. </font><font style="vertical-align: inherit;">Gr√¢ce √† bash, vous pouvez appeler le standard ¬´kill -SIGKILL PID¬ª ou ¬´pkill -9 NAME¬ª pour tuer. </font><font style="vertical-align: inherit;">La commande kill est connue depuis UNIX et est disponible non seulement sur macOS, mais √©galement sur d'autres syst√®mes de type UNIX. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme dans les syst√®mes de type UNIX, macOS vous permet d'intercepter tous les signaux du processus, sauf deux - SIGKILL et SIGSTOP. </font><font style="vertical-align: inherit;">Dans cet article, le signal SIGKILL sera principalement consid√©r√© comme un signal provoquant la mort d'un processus.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sp√©cificit√©s MacOS</font></font><br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur macOS, l'appel syst√®me kill dans le noyau XNU appelle la fonction psignal (SIGKILL, ...). Essayons de voir quelles autres actions utilisateur dans l'espace utilisateur peuvent appeler la fonction psignal. Nous √©liminons les appels √† la fonction psignal dans les m√©canismes internes du noyau (bien qu'ils puissent √™tre non triviaux, nous les laisserons pour un autre article :) - v√©rification de signature, erreurs de m√©moire, traitement de sortie / arr√™t, violation de la protection des fichiers, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous commen√ßons la vue d'ensemble avec la fonction et l'appel syst√®me correspondant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminate_with_payload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">On peut voir qu'en plus de l'appel de mise √† mort classique, il existe une approche alternative sp√©cifique au syst√®me d'exploitation macOS et qui ne se trouve pas dans BSD. </font><font style="vertical-align: inherit;">Les principes de fonctionnement des deux appels syst√®me sont √©galement proches. </font><font style="vertical-align: inherit;">Ce sont des appels directs √† la fonction de noyau psignal. </font><font style="vertical-align: inherit;">Notez √©galement qu'avant de tuer un processus, une v√©rification de ¬´cansignal¬ª est effectu√©e - si le processus peut envoyer un signal √† un autre processus, le syst√®me ne permet √† aucune application de tuer des processus syst√®me par exemple.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">terminate_with_payload_internal</span><span class="hljs-params">(struct proc *cur_proc, <span class="hljs-keyword">int</span> target_pid, <span class="hljs-keyword">uint32_t</span> reason_namespace,
				<span class="hljs-keyword">uint64_t</span> reason_code, <span class="hljs-keyword">user_addr_t</span> payload, <span class="hljs-keyword">uint32_t</span> payload_size,
				<span class="hljs-keyword">user_addr_t</span> reason_string, <span class="hljs-keyword">uint64_t</span> reason_flags)</span>
</span>{<font></font>
...<font></font>
	target_proc = proc_find(target_pid);<font></font>
...<font></font>
	<span class="hljs-keyword">if</span> (!cansignal(cur_proc, cur_cred, target_proc, SIGKILL)) {<font></font>
		proc_rele(target_proc);<font></font>
		<span class="hljs-keyword">return</span> EPERM;<font></font>
	}<font></font>
...<font></font>
	<span class="hljs-keyword">if</span> (target_pid == cur_proc-&gt;p_pid) {
		<span class="hljs-comment">/*
		 * psignal_thread_with_reason() will pend a SIGKILL on the specified thread or
		 * return if the thread and/or task are already terminating. Either way, the
		 * current thread won't return to userspace.
		 */</span><font></font>
		psignal_thread_with_reason(target_proc, current_thread(), SIGKILL, signal_reason);<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
		psignal_with_reason(target_proc, SIGKILL, signal_reason);<font></font>
	}<font></font>
...<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">launchd</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode standard pour cr√©er des d√©mons au d√©marrage du syst√®me et contr√¥ler leur dur√©e de vie est launchd. </font><font style="vertical-align: inherit;">J'attirerai l'attention sur le fait que le code source est pour l'ancienne version de launchctl avant macOS 10.10, des exemples de code sont donn√©s √† titre d'illustration. </font><font style="vertical-align: inherit;">Le launchctl moderne envoie des signaux launchd via XPC, la logique de launchctl lui est transf√©r√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons comment la demande est arr√™t√©e. </font><font style="vertical-align: inherit;">Avant d'envoyer un signal SIGTERM, ils essaient d'arr√™ter l'application √† l'aide de l'appel syst√®me proc_terminate.</font></font><br>
<br>
<pre><code class="cpp hljs">&lt;launchctl src/core.c&gt;<font></font>
...<font></font>
	error = proc_terminate(j-&gt;p, &amp;sig);<font></font>
	<span class="hljs-keyword">if</span> (error) {<font></font>
		job_log(j, LOG_ERR | LOG_CONSOLE, <span class="hljs-string">"Could not terminate job: %d: %s"</span>, error, strerror(error));<font></font>
		job_log(j, LOG_NOTICE | LOG_CONSOLE, <span class="hljs-string">"Using fallback option to terminate job..."</span>);<font></font>
		error = kill2(j-&gt;p, SIGTERM);<font></font>
		<span class="hljs-keyword">if</span> (error) {<font></font>
			job_log(j, LOG_ERR, <span class="hljs-string">"Could not signal job: %d: %s"</span>, error, strerror(error));<font></font>
		} <font></font>
...<font></font>
&lt;&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous le capot, proc_terminate, malgr√© son nom, peut envoyer non seulement du psignal avec SIGTERM, mais aussi SIGKILL.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âlimination indirecte - limite de ressources</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un cas plus int√©ressant peut √™tre vu dans un autre appel syst√®me </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process_policy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L'utilisation standard de cet appel syst√®me est des limites de ressources d'application, par exemple, pour l'indexeur, il y a une limite de temps processeur et de quota de m√©moire afin que le syst√®me ne ralentisse pas de mani√®re significative en raison des actions de mise en cache de fichiers. Si l'application a atteint la limite de ressources, comme le montre la fonction proc_apply_resource_actions, le signal SIGKILL est envoy√© au processus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que cet appel syst√®me puisse potentiellement tuer un processus, le syst√®me n'a pas v√©rifi√© correctement les droits du processus √† l'origine de l'appel syst√®me. En fait, une v√©rification </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existait</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais il suffit d'utiliser l'indicateur alternatif PROC_POLICY_ACTION_SET pour contourner cette condition.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, si vous ¬´limitez¬ª le quota d'utilisation du processeur par l'application (par exemple, n'autorisez que 1 ns √† √™tre ex√©cut√©), vous pouvez alors tuer n'importe quel processus du syst√®me. </font><font style="vertical-align: inherit;">Ainsi, le malware peut tuer n'importe quel processus sur le syst√®me, y compris le processus antivirus. </font><font style="vertical-align: inherit;">L'effet qui se produit quand un processus est tu√© avec pid 1 (launchctl) - panique du noyau en essayant de traiter un signal SIGKILL est √©galement int√©ressant :)</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/91e/fea/a49/91efeaa490ffd57580d2e5f4a59b4988.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment r√©soudre le probl√®me?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fa√ßon la plus simple d'emp√™cher un processus d'√™tre tu√© est de remplacer le pointeur de fonction dans la table d'appels syst√®me. Malheureusement, cette m√©thode n'est pas triviale pour de nombreuses raisons </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. Premi√®rement, le symbole qui est responsable de la position du sysent dans la m√©moire n'est pas seulement un symbole priv√© du noyau XNU, mais ne peut pas non plus √™tre trouv√© dans les symboles du noyau. Vous devrez utiliser des m√©thodes de recherche heuristiques, par exemple, le d√©montage dynamique d'une fonction et rechercher un pointeur dans celle-ci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deuxi√®mement, la structure des entr√©es du tableau d√©pend des drapeaux avec lesquels le noyau a √©t√© construit. Si le drapeau CONFIG_REQUIRES_U32_MUNGING est d√©clar√©, alors la taille de la structure sera modifi√©e - un champ suppl√©mentaire </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">sy_arg_munge32</font></a><font style="vertical-align: inherit;"> est ajout√©</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est n√©cessaire d'effectuer une v√©rification suppl√©mentaire sur l'indicateur avec lequel le noyau a √©t√© compil√©, en option, comparer les pointeurs aux fonctions avec des fonctions connues.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysent</span> {</span>         <span class="hljs-comment">/* system call table */</span>
        <span class="hljs-keyword">sy_call_t</span>       *sy_call;       <span class="hljs-comment">/* implementing function */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> CONFIG_REQUIRES_U32_MUNGING || (__arm__ &amp;&amp; (__BIGGEST_ALIGNMENT__ &gt; 4))</span>
        <span class="hljs-keyword">sy_munge_t</span>      *sy_arg_munge32; <span class="hljs-comment">/* system call arguments munger for 32-bit process */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
        <span class="hljs-keyword">int32_t</span>         sy_return_type; <span class="hljs-comment">/* system call return types */</span>
        <span class="hljs-keyword">int16_t</span>         sy_narg;        <span class="hljs-comment">/* number of args */</span>
        <span class="hljs-keyword">uint16_t</span>        sy_arg_bytes;   <span class="hljs-comment">/* Total size of arguments in bytes for
                                         * 32-bit system calls
                                         */</span><font></font>
};<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, dans les versions modernes de macOS, Apple fournit une nouvelle API pour travailler avec les processus. </font><font style="vertical-align: inherit;">L'API Endpoint Security permet aux clients d'autoriser de nombreuses demandes √† d'autres processus. </font><font style="vertical-align: inherit;">Ainsi, vous pouvez bloquer tous les signaux aux processus, y compris le signal SIGKILL en utilisant l'API susmentionn√©e.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bsm/libbsm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;EndpointSecurity/EndpointSecurity.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[])</span> </span>{
    <span class="hljs-keyword">es_client_t</span>* cli = <span class="hljs-literal">nullptr</span>;<font></font>
    {<font></font>
        <span class="hljs-keyword">auto</span> res = es_new_client(&amp;cli, ^(<span class="hljs-keyword">es_client_t</span> * client, <span class="hljs-keyword">const</span> <span class="hljs-keyword">es_message_t</span> * message) {
            <span class="hljs-keyword">switch</span> (message-&gt;event_type) {
                <span class="hljs-keyword">case</span> ES_EVENT_TYPE_AUTH_SIGNAL:<font></font>
                {<font></font>
                    <span class="hljs-keyword">auto</span>&amp; msg = message-&gt;event.signal;
                    <span class="hljs-keyword">auto</span> target = msg.target;
                    <span class="hljs-keyword">auto</span>&amp; token = target-&gt;audit_token;
                    <span class="hljs-keyword">auto</span> pid = audit_token_to_pid(token);
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"signal '%d' sent to pid '%d'\n"</span>, msg.sig, pid);<font></font>
                    es_respond_auth_result(client, message, pid == getpid() ? ES_AUTH_RESULT_DENY : ES_AUTH_RESULT_ALLOW, <span class="hljs-literal">false</span>);<font></font>
                }<font></font>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
        });<font></font>
    }<font></font>
<font></font>
    {<font></font>
        <span class="hljs-keyword">es_event_type_t</span> evs[] = { ES_EVENT_TYPE_AUTH_SIGNAL };<font></font>
        es_subscribe(cli, evs, <span class="hljs-keyword">sizeof</span>(evs) / <span class="hljs-keyword">sizeof</span>(*evs));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, getpid());<font></font>
    sleep(<span class="hljs-number">60</span>); <span class="hljs-comment">// could be replaced with other waiting primitive</span><font></font>
<font></font>
    es_unsubscribe_all(cli);<font></font>
    es_delete_client(cli);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De m√™me, vous pouvez enregistrer la politique MAC dans le noyau, qui fournit une m√©thode de protection du signal (politique proc_check_signal), mais l'API n'est pas officiellement prise en charge.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protection des extensions du noyau</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de prot√©ger les processus dans le syst√®me, la protection de l'extension du noyau elle-m√™me (kext) est √©galement n√©cessaire. macOS fournit un cadre permettant aux d√©veloppeurs de d√©velopper facilement des pilotes de p√©riph√©rique IOKit. En plus de fournir des outils pour travailler avec des p√©riph√©riques, IOKit fournit des m√©thodes d'empilement de pilotes utilisant des instances de classes C ++. Une application dans l'espace utilisateur pourra ¬´trouver¬ª une instance enregistr√©e de la classe pour √©tablir une connexion noyau-espace utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©tecter le nombre d'instances de classe dans le syst√®me, l'utilitaire ioclasscount existe.</font></font><br>
<br>
<pre><code class="cpp hljs">my_kext_ioservice = <span class="hljs-number">1</span>
my_kext_iouserclient = <span class="hljs-number">1</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toute extension de noyau qui souhaite s'inscrire sur la pile du pilote doit d√©clarer une classe h√©rit√©e d'IOService, par exemple, my_kext_ioservice dans ce cas. La connexion des applications utilisateur cr√©era une nouvelle instance de la classe qui h√©rite de IOUserClient, dans l'exemple my_kext_iouserclient. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous essayez de d√©charger le pilote du syst√®me (commande kextunload), la fonction virtuelle ¬´bool terminate (options IOOptionBits)¬ª est appel√©e. </font><font style="vertical-align: inherit;">Il suffit de retourner false lors de l'appel √† la fonction terminate lorsque vous essayez de d√©charger pour d√©sactiver kextunload.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Kext::terminate</span><span class="hljs-params">(IOOptionBits options)</span>
</span>{<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!IsUnloadAllowed)<font></font>
  {<font></font>
    <span class="hljs-comment">// Unload is not allowed, returning false</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> super::<span class="hljs-built_in">terminate</span>(options);<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'indicateur IsUnloadAllowed peut √™tre d√©fini par IOUserClient au d√©marrage. </font><font style="vertical-align: inherit;">Lorsque le chargement est limit√©, la commande kextunload renvoie la sortie suivante:</font></font><br>
<br>
<pre><code class="cpp hljs">admin@admins-Mac drivermanager % sudo kextunload ./test.kext<font></font>
Password:<font></font>
(kernel) Can<span class="hljs-number">'</span>t remove kext my.kext.test; services failed to <span class="hljs-built_in">terminate</span> - <span class="hljs-number">0xe00002c7</span>.<font></font>
Failed to unload my.kext.test - (iokit/common) unsupported function.<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une protection similaire doit √™tre effectu√©e pour IOUserClient. </font><font style="vertical-align: inherit;">Les instances de classe peuvent √™tre d√©charg√©es √† l'aide de la fonction d'espace utilisateur IOKitLib ¬´IOCatalogueTerminate (mach_port_t, indicateur uint32_t, io_name_t description);¬ª. </font><font style="vertical-align: inherit;">Vous pouvez retourner false lors d'un appel √† la commande ¬´terminate¬ª jusqu'√† ce que l'espace utilisateur de l'application meure, c'est-√†-dire qu'il n'y ait aucun appel √† la fonction clientDied.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protection des fichiers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour prot√©ger les fichiers, il suffit d'utiliser l'API Kauth, qui vous permet de restreindre l'acc√®s aux fichiers. Apple fournit aux d√©veloppeurs des notifications sur divers √©v√©nements dans la port√©e, les op√©rations KAUTH_VNODE_DELETE, KAUTH_VNODE_WRITE_DATA et KAUTH_VNODE_DELETE_CHILD sont importantes pour nous. Restreindre l'acc√®s aux fichiers est plus facile en cours de route - nous utilisons l'API ¬´vn_getpath¬ª pour obtenir le chemin d'acc√®s au fichier et comparer le pr√©fixe du chemin d'acc√®s. Notez que pour optimiser le renommage des chemins des dossiers contenant des fichiers, le syst√®me n'autorise pas l'acc√®s √† chaque fichier, mais uniquement au dossier lui-m√™me, qui a √©t√© renomm√©. Il est n√©cessaire de comparer le chemin parent et de restreindre KAUTH_VNODE_DELETE pour cela.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/6e2/ab5/2fb/6e2ab52fb8c17ea8adfe8b63bcf8f611.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'inconv√©nient de cette approche peut √™tre de faibles performances avec un nombre croissant de pr√©fixes. Pour que la comparaison ne soit pas √©gale √† O (pr√©fixe * longueur), o√π pr√©fixe est le nombre de pr√©fixes, longueur est la longueur de la cha√Æne, vous pouvez utiliser une machine √† √©tats finis d√©terministe (DFA) construite par des pr√©fixes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rez un moyen de cr√©er un DFA pour un ensemble de pr√©fixes donn√©. Nous initialisons les curseurs au d√©but de chaque pr√©fixe. Si tous les curseurs pointent vers le m√™me caract√®re, alors nous augmentons chaque curseur d'un caract√®re et nous rappelons que la longueur de la m√™me ligne est plus d'un. S'il y a deux curseurs avec des symboles diff√©rents sous eux, nous divisons les curseurs en groupes par le symbole vers lequel ils pointent et r√©p√©tons l'algorithme pour chaque groupe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le premier cas (tous les caract√®res sous les curseurs sont les m√™mes), nous obtenons l'√©tat DFA, qui n'a qu'une seule transition sur la m√™me ligne. </font><font style="vertical-align: inherit;">Dans le second cas, nous obtenons une table de transition de taille 256 (nombre de caract√®res et nombre maximum de groupes) dans les √©tats suivants obtenus en appelant r√©cursivement la fonction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons un exemple. </font><font style="vertical-align: inherit;">Pour un ensemble de pr√©fixes ("/ foo / bar / tmp /", "/ var / db / foo /", "/ foo / bar / aba /", "foo / bar / aac /"), vous pouvez obtenir le DFA suivant. </font><font style="vertical-align: inherit;">La figure montre uniquement les transitions menant √† d'autres √©tats, les autres transitions ne seront pas d√©finitives. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/190/d0f/5ec/190d0f5ec1fdd8c03df23387d83db44a.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors du passage dans les √âtats de la DKA, il peut y avoir 3 cas.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©tat final a √©t√© atteint - le chemin est prot√©g√©, nous restreignons les op√©rations KAUTH_VNODE_DELETE, KAUTH_VNODE_WRITE_DATA et KAUTH_VNODE_DELETE_CHILD</font></font></li>
<li>    ,   ‚Äú‚Äù (  -) ‚Äî   ,   KAUTH_VNODE_DELETE. ,   vnode  ,     ‚Äò/‚Äô,         ‚Äú/foor/bar/t‚Äù,  .</li>
<li>    ,   .       ,   .</li>
</ol><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le but des solutions de s√©curit√© d√©velopp√©es est d'augmenter le niveau de s√©curit√© de l'utilisateur et de ses donn√©es. D'une part, cet objectif est assur√© par le d√©veloppement du produit logiciel Acronis qui couvre les vuln√©rabilit√©s o√π le syst√®me d'exploitation lui-m√™me est ¬´faible¬ª. D'un autre c√¥t√©, nous ne devons pas n√©gliger l'am√©lioration de ces aspects de s√©curit√© qui peuvent √™tre am√©lior√©s du c√¥t√© du syst√®me d'exploitation, d'autant plus que la fermeture de ces vuln√©rabilit√©s augmente notre propre stabilit√© en tant que produit. La vuln√©rabilit√© a √©t√© signal√©e par l'√©quipe de s√©curit√© des produits Apple et a √©t√© corrig√©e dans macOS 10.14.5 (https://support.apple.com/en-gb/HT210119).</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e27/604/c24/e27604c248d5405276235cf613319754.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela ne peut √™tre fait que si votre utilitaire a √©t√© officiellement install√© dans le noyau. </font><font style="vertical-align: inherit;">Autrement dit, il n'y a pas de telles lacunes pour les logiciels externes et ind√©sirables. </font><font style="vertical-align: inherit;">Cependant, comme vous pouvez le voir, m√™me pour prot√©ger des programmes l√©gitimes tels que des antivirus et des syst√®mes de sauvegarde, vous devez travailler dur. </font><font style="vertical-align: inherit;">Mais maintenant, les nouveaux produits Acronis pour macOS b√©n√©ficieront d'une protection suppl√©mentaire contre le d√©chargement du syst√®me.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497688/index.html">Comment fonctionne l'√©cole du soir de Kubernetes</a></li>
<li><a href="../fr497696/index.html">Comment le ran√ßongiciel Ryuk qui attaque les entreprises</a></li>
<li><a href="../fr497700/index.html">Mitaps en ligne hebdomadaires sur le support et DevOps, la s√©curit√© et les robots √† partir du 17 avril</a></li>
<li><a href="../fr497702/index.html">Cinq tendances du stockage de donn√©es auxquelles vous devriez faire attention en 2020</a></li>
<li><a href="../fr497708/index.html">Nous vous invitons √† une s√©rie de webinaires Fujitsu en avril et mai</a></li>
<li><a href="../fr497724/index.html">Pr√©paration d'un serveur pour la publication d'une application Web en Python</a></li>
<li><a href="../fr497726/index.html">Mise √† l'√©chelle des tests Android √† Odnoklassniki</a></li>
<li><a href="../fr497728/index.html">Les dangers de ¬´br√ªler¬ª les puces</a></li>
<li><a href="../fr497730/index.html">BDD pratique: SpecFlow + TFS</a></li>
<li><a href="../fr497736/index.html">Examen de 10 nouveaux moteurs √† combustion interne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>