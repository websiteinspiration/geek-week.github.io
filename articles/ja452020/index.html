<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎣 👱🏿 🚭 Webアクセラレーションに最適なHTTP / 2優先順位付け 💑 ⛰️ 🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HTTP / 2はウェブを大幅にスピードアップすることを約束し、Cloudflareはずっと前にすべてのクライアントにHTTP / 2アクセスを配備しました。しかし、HTTP / 2の1つの機能、優先順位付けは、期待に応えませんでした。それは根本的に壊れているからではなく、ブラウザでの実装のためです...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Webアクセラレーションに最適なHTTP / 2優先順位付け</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452020/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/57d/5cf/dbe/57d5cfdbe917c7b464a249fb187b3ffd.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTTP / 2はウェブを大幅にスピードアップすることを約束し、Cloudflareはずっと前にすべてのクライアントにHTTP / 2アクセスを配備しました。しかし、HTTP / 2の1つの機能、優先順位付けは、期待に応えませんでした。それは根本的に壊れているからではなく、ブラウザでの実装のためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日、CloudflareはHTTP / 2の優先順位を変更することを提案しています。これにより、サーバーはインターネットを本当に高速化する優先順位の決定を制御できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これまで、Webコンテンツをダウンロードする方法とタイミングを制御したのはブラウザでした。</font><font style="vertical-align: inherit;">今日、すべての有料プランについて、このモデルに根本的な変更を加えています。</font><font style="vertical-align: inherit;">彼らはサイトの所有者に直接コントロールを移します。</font><font style="vertical-align: inherit;">Cloudflareダッシュボードの「速度」タブで、クライアントは「高度なHTTP / 2優先順位付け」を有効にできます。これにより、デフォルトのブラウザー設定が改善されたスケジューリングスキームに上書きされ、訪問者のアクセスが大幅に高速化されます（場合によっては、50％の増加が見られました）。</font><font style="vertical-align: inherit;">Cloudflareワーカーを使用すると、サイト所有者はさらに進んで、特定のニーズに合わせて設定を完全にカスタマイズできます。</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在の状況</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Webページは</font><font style="vertical-align: inherit;">、ブラウザによってダウンロードされ、最終的に表示されるコンテンツに収集さ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://discuss."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れる数十（場合によっては数百）の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">個別のリソースで構成されます。これには、ユーザーが操作する表示コンテンツ（HTML、CSS、画像）だけでなく、サイト自体のアプリケーションロジック（JavaScript）、広告、分析、マーケティング追跡ビーコンが含まれます。ユーザーの視点から見ると、これらのリソースが読み込まれる順序は非常に重要です。これは、ユーザーがコンテンツを表示してページを操作できる時間に影響します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブラウザは、実際には、HTMLドキュメントを通過して、HTMLの最初から最後まで、ページの移動に合わせてページを構築するという指示に従って、HTML処理エンジンです。スタイルシートリンク（CSS）は、ページのコンテンツにスタイルを設定する方法をブラウザーに通知します。ブラウザーは、スタイルシートを読み込むまでコンテンツの表示を遅らせます。ページ上のスクリプトにはさまざまな動作があります。スクリプトが「非同期」または「保留」としてマークされている場合、ブラウザはドキュメントの処理を続行し、スクリプトが利用可能になったときにスクリプトを実行できます。スクリプトが非同期または保留中としてマークされていない場合、ブラウザ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプトが読み込まれて実行されるまで、ドキュメントの処理を停止します。このようなスクリプトは、ブラウザがドキュメントの処理を続行できないようにするため、「ブロック」と呼ばれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTMLドキュメントは2つの部分に分かれています。 &lt;head&gt;ドキュメントのタイトルは最初にあり、コンテンツを表示するために必要なスタイルシート、スクリプト、およびその他のブラウザの手順が含まれています。見出しは&lt;body&gt;ドキュメントの本文である後、ブラウザウィンドウに表示される実際のコンテンツが含まれます（スクリプトやスタイルシートも本文に含めることができます）。ブラウザがドキュメントの本文に到達するまで、ユーザーは何も表示せず、ページは空白のままです。したがって、ヘッダーをできるだけ早く処理することが重要です。詳細に興味がある方は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTML5 Rocks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">には</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素晴らしいチュートリアルがあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブラウザの仕組み。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、ブラウザは、ページを作成してドキュメントをさらに処理するために必要なさまざまなリソースが読み込まれる順序を担当します。</font><font style="vertical-align: inherit;">HTTP / 1.xでは、ブラウザが一度にサーバーからリクエストできるオブジェクトの数に制限があります（通常、接続ごとに一度に6つの接続と1つのリソースのみ）。リクエストの順序はブラウザによって厳密に制御されます。</font><font style="vertical-align: inherit;">HTTP / 2では、状況は完全に異なります。</font><font style="vertical-align: inherit;">ブラウザは、すべてのリソースを一度に要求でき（少なくとも、リソースについて知るとすぐに）、これらのリソースの配信方法に関する詳細な指示をサーバーに提供します。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適なリソースの読み込み順序</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ページの読み込みサイクルのほとんどの部分で、ユーザーのページのアクセシビリティを最大化する最適な順序があります（最適な読み込み順序と非最適な読み込み順序の違いは50％以上に達する可能性があります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のように、ブラウザがコンテンツを表示する前に、セクションのCSSとJavaScriptによってブロックされます</font></font><code>&lt;head&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。この段階では、HTMLコードで記述されているため、チャネルを100％使用して、順番にロードするのではなく、ブロックするリソースをロードする方が有利です。これにより、ブラウザーは各要素を分析して実行しながら、次のブロッキングリソースをロードし、最適なパイプラインを作成できます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/db9/e18/fbe/db9e18fbe00d27755a152a8deabbcaa4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
並列ロードまたは順次ロードのスクリプトロード時間には違いはありませんが、順次ロードの場合、最初のスクリプトは2番目のロード中に処理および実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブロッキングリソースを読み込んだ後、状況はもう少し興味深いものになります。ここで、最適な負荷は、特定のサイトまたはビジネスの優先順位（ユーザー生成コンテンツまたは広告、または分析などの選択）に依存する場合があります。表示されたコンテンツにスタイルシートを適用した後、ブラウザが目的のフォントを検出するため、フォントに関する別の問題。したがって、ブラウザがフォントについて学習するまでに、画面に表示する準備ができているテキストを表示する必要があります。フォントの読み込みが遅れると、画面にテキストが表示されなくなります（またはテキストが間違ったフォントで表示されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、いくつかのトレードオフを考慮する必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページの表示部分（ビューポート）にあるカスタムフォントと画像は、できるだけ早く読み込まれる必要があります。</font><font style="vertical-align: inherit;">それらは、ページをロードするときのユーザーの視覚体験に直接影響します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非ブロッキングJavaScriptは、他のJavaScriptリソースに対して順次ロードして、それぞれをパイプライン処理できるようにする必要があります。</font><font style="vertical-align: inherit;">JavaScriptには、カスタムアプリケーションロジックや、分析やマーケティングのための追跡ビーコンが含まれる場合があり、それらの遅延により、ビジネスが追跡する指標が減少する場合があります。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像は並行してアップロードできます。</font><font style="vertical-align: inherit;">画像ファイルの最初の数バイトには、ブラウザのレイアウトに必要な場合があるサイズが含まれており、プログレッシブ画像を並行してロードすると、総容量の約50％を転送した後に、完全な視覚を提供できます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トレードオフを考えると、ほとんどの場合、この戦略はうまく機能します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタムフォントは順番に読み込まれ、使用可能な帯域幅をスコープ内の画像と共有します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可視画像は並列に読み込まれ、割り当てられた帯域幅の一部を共有します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォントや表示画像がなくなった場合：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非ブロッキングスクリプトは順番に読み込まれ、使用可能な帯域幅を非表示の画像（範囲外）と共有します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非表示の画像は並列に読み込まれ、割り当てられた帯域幅の一部をそれらの間で共有します。</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ユーザーに表示されるコンテンツは可能な限り迅速に読み込まれ、アプリケーションロジックは最小限に遅延され、不可視の画像は可能な限り迅速にレイアウトを完了するように読み込まれます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
説明のために、典型的なeコマースサイトの簡略化された製品カテゴリページを使用します。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">青</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ページ自体のHTMLファイル。</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">緑-1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">つの外部スタイルシート（CSSファイル）。</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オレンジ-4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;つの外部スクリプト（JavaScript）。</font><font style="vertical-align: inherit;">ページ上部にある2つのブロッキングスクリプトと2つの非同期スクリプト。</font><font style="vertical-align: inherit;">ブロッキングスクリプトは、濃いオレンジ色で表示されます。</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">赤</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;は1つのカスタムWebフォントです。</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイオレット</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-13画像。</font><font style="vertical-align: inherit;">表示ウィンドウには、ページのロゴと4つの製品画像が表示され、さらに8つの製品画像はスクロールが必要です。</font><font style="vertical-align: inherit;">5つの可視画像は、紫色の濃い色で示されます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単にするために、すべてのリソースが同じサイズで、各ロードが1秒であると仮定します。</font><font style="vertical-align: inherit;">すべてのリソースのダウンロードには合計20秒かかりますが、ロードの順序と方法は非常に重要です。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/fbd/07b/58a/fbd07b58a4c8aeff2a758ad1946d8523.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブラウザでの最適なリソースの読み込みは次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/8b2/6a8/2cd/8b26a82cdb5c546e9005200e5528b988.gif"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTML、CSS、ブロッキングスクリプトの読み込み中、最初の4秒間はページが空白です。これらはすべて100％接続を使用します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4秒のマークでは、背景とページ構造がテキストや画像なしで表示されます。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1秒後、約5秒で、ページのテキストが表示されます。</font></font><br>
</li>
<li>  5−10   ,  ,      .   7       .<br>
</li>
<li>  10          .<br>
</li>
<li>         JavaScript,     (,    .&nbsp;.).<br>
</li>
<li>   8         .</li>
</ul><br>
<h1>   </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在のすべてのブラウザエンジンは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://calendar.perfplanet.com/2018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまな優先順位付け戦略を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://calendar.perfplanet.com/2018/"><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">いますが、どれも最適ではありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft EdgeとInternet Explorer </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://calendar.perfplanet.com/2018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は優先順位付けをサポートしていないため</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、デフォルトのHTTP / 2設定で動作し、すべてを並行して読み込み、すべてのリソース間で帯域幅を均等に分散します。 Microsoft Edgeの将来のバージョンでは、Chromiumエンジンの使用に切り替わり、状況が改善される可能性があります。しかし今のところ、この例では、画像がブロックスクリプトとスタイルシートの送信を遅くするため、ほとんどの場合、ブラウザはページヘッダーでスタックします。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e9c/844/a65/e9c844a65472a56d92cb37cd27f2f035.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
視覚的には、これはかなり苦しい経験につながります。ユーザーが空白の画面を19秒間見た後、テキストの表示に1秒の遅延があります。 ：下のアニメーションを表示するときに19秒間それは何も（それはあるが）空白の画面上で起こっていないように見えるかもしれないので、我慢して</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/6c9/fae/539/6c9fae539ae1d3c99570cf53af415be4.gif"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サファリ</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://calendar.perfplanet.com/2018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並列にすべてのリソースをロードし</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、その重要性に基づいて帯域幅を共有し、リソースをブロックする（サファリによると、スクリプトやスタイルシートなどは画像よりも重要です）。画像は並列に読み込まれますが、コンテンツのブロックと同時に読み込まれます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c75/a7d/f05/c75a7df05716f5706aa4b037774733d2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Safariはすべてが同時に読み込まれるという点でEdgeに似ていますが、より多くの帯域幅をブロックするリソースに割り当てると、コンテンツをより早く表示できます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/f0c/840/5a1/f0c8405a1b6ddc40645ab7985e28a5eb.gif"><br>
<br>
<ul>
<li>  8       ,     .    ,      (   ).         ,   ,   Edge.<br>
</li>
<li>  11   .   .        ,     .       7-     .<br>
</li>
<li>   9     ,    , , ,     20 .</li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firefox</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、リソースをグループ化する依存関係ツリーを作成し、グループを次々にロードするか、グループ間で帯域幅を共有するように計画します。このグループ内では、リソースは帯域幅を共有し、同時にロードします。画像は、レンダリングをブロックするスタイルシートの後にロードされ、並列にロードされる予定ですが、レンダリングをブロックするスクリプトとスタイルシートも並列にロードされ、パイプライン化の利点が得られません。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/870/e6d/83c/870e6d83c673b9c706dac49c78d3848d.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、画像はスタイルシートのロードを待機しているため、これはSafariよりも少し速く発生します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/bd2/806/b55/bd2806b55e830bd4c2a7e08bb1b18ce4.gif"><br>
<br>
<ul>
<li>  6             (   8   Safari  4    ).<br>
</li>
<li> 8   ,            (   11   Safari  7    ).<br>
</li>
<li>   12          .</li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chrome</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（およびChromiumベースのすべてのブラウザ）は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://calendar.perfplanet.com/2018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、リストの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースに優先順位を付け</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://calendar.perfplanet.com/2018/"><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、順番に最適に読み込まれるリソースをブロックするのに非常に適していますが、画像にはあまり適していません。</font><font style="vertical-align: inherit;">各画像は、次の画像を開始する前に最大100％読み込まれます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e22/14d/4e0/e2214d4e04fab810f0a4398fe02434c1.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、これはほぼ最適なダウンロードシナリオです。唯一の違いは、イメージが一度に1つずつダウンロードされ、並行してダウンロードされないことです。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/91e/76c/d1d/91e76cd1d814aef138b35345eda46d82.gif"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大5秒で、Chromeの読み込みは最適なシナリオと同じで、4秒目に背景が表示され、5秒目にテキストコンテンツが表示されます。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の5秒間で、可視領域の画像は、プロセスが約10秒で完了するまで一度に1つずつ読み込まれます（最適なシナリオと比較して、画像が約7秒でわずかにぼやけて残りの3秒間鮮明になります）。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページのビジュアル部分を10秒で完了した後（最適なシナリオと同じ）、残りの10秒は、非同期スクリプトの実行と非表示のイメージの読み込み（最適なシナリオと同様）に費やされます。</font></font></li>
</ul><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目視比較</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
技術的にすべてのコンテンツの読み込みに同じ時間がかかりますが、視覚的な違いはかなり異なります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/62e/2a1/d5f/62e2a1d5f10b801af61992517d7f5a5a.gif"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー側の優先順位付け</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTTP / 2の優先順位付けはクライアント（ブラウザ）によって要求され、サーバーはその要求に基づいて何をするかを決定する必要があります。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://github.com/andydavies/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多数のサーバーがこの機能をまったくサポートしておらず</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、残りはクライアントの要求を満たします。別のオプションは、クライアントの要求に基づいて、サーバー側の最適な優先順位を決定することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
よると</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://http2.github.io/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕様</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、HTTP / 2優先順位付けは、リソースを相互に優先順位付けできるようにするために、現在のすべてのリクエストの完全な知識を必要とする依存関係ツリーです。これにより、信じられないほど複雑な戦略を実装できますが、ブラウザーまたはサーバー側で適切に実装することは困難です（さまざまなブラウザー戦略とさまざまなレベルのサーバーサポートから明らかです）。優先順位付けの管理を簡素化するために、最適な計画に必要なすべての柔軟性を備えた、より単純なスキームを開発しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cloudflareの優先順位付けスキームは、64の優先度「レベル」で構成され、各レベル内には、それらの間で接続を分割する方法を決定するリソースのグループがあります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ba5/7e5/efa/ba57e5efa56119a58bbd39596da3f9ce.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、すべてのリソースがより高い優先度レベルでダウンロードされ、次により低いレベルへの移行があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定の優先度レベル内には、3つの異なる同時実行グループがあります。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：グループ「0」のすべてのリソースは、100％の帯域幅を使用して、要求された順序で順番に送信されます。</font><font style="vertical-align: inherit;">グループ「0」のすべてのリソースをロードした後にのみ、同じレベルの他のグループが考慮されます。</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：同時実行グループ「1」のすべてのリソースは、要求された順序で順番に送信されます。</font><font style="vertical-align: inherit;">利用可能な帯域幅は、並列処理グループ「1」と並列処理グループ「n」の間で均等に分散されます。</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：並行性グループ「n」のリソースは並列に送信され、使用可能な帯域幅を共有します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、並列処理グループ「0」は、順次処理する必要がある重要なコンテンツ（スクリプト、CSSなど）に役立ちます。</font><font style="vertical-align: inherit;">グループ「1」は、他のリソースと帯域幅を共有できる重要度の低いコンテンツに役立ちますが、リソース自体は順次処理（非同期スクリプト、非プログレッシブ画像など）の恩恵を受けます。</font><font style="vertical-align: inherit;">並行処理グループ「n」は、並列処理のメリットを享受するリソース（プログレッシブ画像、ビデオ、オーディオなど）に役立ちます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloudflareのデフォルトの優先順位付け</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
高度な優先順位付けのオプションを使用すると、上記の「最適な」リソース読み込み順序が実装されます。</font><font style="vertical-align: inherit;">使用される特定の優先順位は次のとおりです。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b89/e96/e4f/b89e96e4f4534f5df00d732e97b5db62.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスキームでは、レンダリングをブロックするリソースを順次送信してから、可視画像を並行して送信し、その後、一定レベルの帯域幅を共有するページコンテンツの残りを送信して、アプリケーションとコンテンツの負荷のバランスをとることができます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意点*もし検出可能では</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのブラウザはスタイルシートとスクリプトの異なるタイプを区別、まだそれはすべての場合にはるかに高速になるではないということです。</font><font style="vertical-align: inherit;">特にEdgeとSafariへのビジターにとって、50％の加速は珍しいことではありません。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/u_/1n/px/u_1npxrzhg0svmgdyzelnamxj84.png"></a><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワーカーに優先順位を付ける</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトの作業はより高速ですが、Cloudflare Workersのサポートを使用して優先順位を構成できるため、サイトはリソースのデフォルトの優先順位を再定義したり、独自の優先順位スキームを実装したりできるため、非常に興味深いものになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ワーカーが応答</font></font><code>cf-priority</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">ヘッダーを追加する</font><font style="vertical-align: inherit;">と、Cloudflare Edge Serverは指定された優先度と同時実行性を適用します。ヘッダーの形式は&lt;priority&gt; / &lt;concurrency&gt;であるため、ヘッダーは</font></font><code>response.headers.set('cf-priority', “30/0”);</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この回答に対して優先度30と並列処理0を設定します。同様に、「30/1」は並列処理を「1」に設定し、「30 / n」は並列処理をnに設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような柔軟性により、サイトは必要に応じてリソースの優先順位を任意に設定できます。</font><font style="vertical-align: inherit;">たとえば、いくつかの重要な非同期スクリプトまたはメイン画像の優先度を上げるには、ブラウザがそれらが可視であると判断する前であってもダウンロードされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
優先順位の決定について通知するために、ワーカーのランタイムは、リクエストオブジェクト内の優先順位についてブラウザーから要求された情報も示します。これは、ワーカーイベントの受信者に渡されます（request.cf.requestPriority）。</font><font style="vertical-align: inherit;">着信優先順位は、セミコロンで区切られた属性のリストです。</font><font style="vertical-align: inherit;">次のようになります</font></font><code>weight=192;exclusive=0;group=3;group-weight=127</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weight</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：HTTPを優先するための重み/ 2。</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">排他的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：排他的なHTTP / 2フラグ（Chromiumベースのブラウザーでは1、その他では0）。</font></font><br>
</li>
<li><b>group</b>:   HTTP/2    (  Firefox).<br>
</li>
<li><b>group-weight</b>:  HTTP/2    (  Firefox).</li>
</ul><br>
<h1>  </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回答の優先順位を構成および制御する機能は、将来のすばらしい作業の主要な構成要素です。</font><font style="vertical-align: inherit;">これに加えて、独自の高度な最適化を実装する予定ですが、ワーカーのサポートにより、すべてのサイトと研究者はさまざまな優先順位付け戦略を試すことができます。</font><font style="vertical-align: inherit;">企業はApps Marketplaceを通じて、作業プラットフォーム上に新しい最適化サービスを作成し、他のサイトで使用できるようにすることもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proプラン以上の場合は、Cloudflareダッシュボードの[Speed]タブに移動し、[advanced HTTP / 2 priorityitization]を有効にしてサイトを高速化します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/386/d53/276/386d532767b6396ee628a7e0eb837282.png"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452004/index.html">デバイス「Bereshit」の月への落下の場所を見つけた</a></li>
<li><a href="../ja452006/index.html">Epic Meta Universe：Fortnite Authorsが作成すべき理由</a></li>
<li><a href="../ja452008/index.html">エンジニアリングのアプローチとチェックリスト：混沌としたタスクに夢中にならない方法</a></li>
<li><a href="../ja452010/index.html">Osmo Action：DJIの最初のアクションカメラ</a></li>
<li><a href="../ja452016/index.html">クラウドでの12年</a></li>
<li><a href="../ja452026/index.html">20年前、マイクロソフトはマウスの使用方法を永久に変えました</a></li>
<li><a href="../ja452028/index.html">暗い王国の光線：テクノロジーが失われた視力をどのように戻すか</a></li>
<li><a href="../ja452030/index.html">インターネットの歴史：双方向性の発見</a></li>
<li><a href="../ja452034/index.html">自己教育のための時間と本を読むための時間の自己制御</a></li>
<li><a href="../ja452036/index.html">ソフトウェア無線-それはどのように機能しますか？パート2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>