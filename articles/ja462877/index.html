<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏂🏿 🐚 👩🏾‍🤝‍👩🏽 PostgreSQLのロック：1.関係ロック 👩🏿‍🤝‍👨🏾 🤚 🚈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="これまでの2つのシリーズの記事では、分離と多元主義およびジャーナリングに焦点を当てました。
 
 このシリーズでは、ロック（ロック）について説明します。私はこの用語を忠実に守りますが、文学には別のものもあるかもしれません：城。
 
 サイクルは4つの部分で構成されます。
 
 

1. 関係ロック（...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLのロック：1.関係ロック</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/462877/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これまでの2つのシリーズの記事では、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分離と多元主義</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジャーナリングに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">焦点を当てました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このシリーズでは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ロック</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ロック）について説明します。</font><font style="vertical-align: inherit;">私はこの用語を忠実に守りますが、文学には別のものもあるかもしれません：</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">城</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイクルは4つの部分で構成されます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関係ロック（この記事）</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行ロック</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他のオブジェクトの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックと述語ロック。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMにロックします</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての記事は</font><font style="vertical-align: inherit;">、Pavelと私が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行っ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ている</font><font style="vertical-align: inherit;">管理</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">トレーニングコースに</font></a><font style="vertical-align: inherit;">基づいて</font><font style="vertical-align: inherit;">います。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プルザノフ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、しかしそれらを逐語的に繰り返さず、思慮深い読書と独立した実験を目的としています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rx/jt/bz/rxjtbz_s6otkhbwcm6agmmtldxe.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックに関する一般情報</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLは、何かをブロックするために使用される（または少なくともそれと呼ばれる）さまざまなメカニズムを使用します。</font><font style="vertical-align: inherit;">したがって、ロックが必要な理由、ロックとは何か、ロックが互いにどのように異なるのかについて、最も一般的な言葉から始めます。</font><font style="vertical-align: inherit;">次に、PostgreSQLでこの種類のものが何であるかを確認し、その後で、さまざまなタイプのロックの詳細な処理を開始します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロックは、共有リソースへの同時アクセスを合理化するために使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
競合アクセスとは、複数のプロセスの同時アクセスを指します。プロセス自体は、並行して（機器で許可されている場合）、時分割モードで順次実行できます。これは重要ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
競合がない場合、ロックは必要ありません（たとえば、共有バッファキャッシュにはロックが必要ですが、ローカルキャッシュには必要ありません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リソースにアクセスする前に、プロセスは</font><em><font style="vertical-align: inherit;">キャプチャ</font></em><font style="vertical-align: inherit;">する必要があります</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このリソースに関連付けられた（取得）ロック。つまり、特定の分野について話しています。すべてのプロセスが共有リソースにアクセスするための確立されたルールに準拠している限り、すべてが機能します。 DBMSがロックを管理する場合、DBMS自体が順序を監視します。アプリケーションによってブロックが設定されている場合、この義務は彼にあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
低レベルでは、ロックは共有メモリのセクションによって表され、ロックが解放されているか、キャプチャされているかが何らかの方法で記録されます（プロセス番号、キャプチャ時間などの追加情報が記録される可能性があります）。</font></font><br>
<br>
<blockquote> ,          ,     .     ,  ,         (,    ),  .    ,  ,    ,      .             (,  test-and-set  compare-and-swap).<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスでリソースが不要になった後、</font><font style="vertical-align: inherit;">他のユーザーがリソースを使用できるよう</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックを</font><em><font style="vertical-align: inherit;">解放し</font></em><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、ロックをロックすることは常に可能であるとは限りません。リソースはすでに他の誰かによって使用されている可能性があります。</font><font style="vertical-align: inherit;">次に、プロセスは待機キューに入り（ロックメカニズムがそのような機会を与える場合）、または一定時間後にロックの取得を再試行します。</font><font style="vertical-align: inherit;">いずれにしても、これは、リソースの解放を見越してプロセスがアイドル状態に置かれることを強いられるという事実につながります。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">時には、他の非ブロッキング戦略を適用することが可能です。</font><font style="vertical-align: inherit;">たとえば</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、マルチ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バージョニング</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">メカニズム</font></a><font style="vertical-align: inherit;">により、複数のプロセスが互いにブロックせずに異なるバージョンのデータを同時に処理できる場合があります。</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、保護されたリソースは、このリソースのみを明確に識別し、ブロッキングアドレスと一致させることができれば、何でもかまいません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、リソースは、データページ（ファイル名とファイル内の位置で識別）、テーブル（システムディレクトリ内のOID）、テーブル行（ページとページ内のオフセット）など、DBMSが使用しているオブジェクトです。リソースは、ハッシュテーブルやバッファなど、メモリ内の構造体にすることができます（事前に割り当てられた番号で識別されます）。物理的な意味を持たない抽象的なリソース（一意の番号で識別される）を使用すると便利な場合もあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロックの有効性は多くの要因の影響を受けますが、そのうちの2つを区別します。</font></font><br>
<br>
<ul>
<li><strong></strong> ( ) ,    .<br>
<br>
,    ,    .        .        ,      ,          .    ,     .<br>
<br>
       (      ).      <em> </em> () :   ,     ,        .<br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックはさまざまな</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モード</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でキャプチャでき</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モードの名前は完全に任意にすることができ、相互の互換性のマトリックスのみが重要です。</font><font style="vertical-align: inherit;">どのモードとも互換性のないモード（自分自身を含む）。通常、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">排他的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独占的</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（排他的）</font><font style="vertical-align: inherit;">と呼ばれ</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">モードに互換性がある場合、ロックは複数のプロセスで同時にキャプチャできます。</font><font style="vertical-align: inherit;">このような体制は</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（共有）</font><font style="vertical-align: inherit;">と呼ば</font><em><font style="vertical-align: inherit;">れ</font></em><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">一般に、相互に互換性のある異なるモードを区別できるほど、並列処理の機会が増えます。</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用時間に応じて、ロックはロングとショートに分けることができます。</font></font><br>
<br>
<ul>
<li><strong></strong>       (   )       ,   ()  .  , PostgreSQL    ,  ,   ,      .<br>
<br>
      ,           .        (,      )   ,                    .<br>
</li>
<li><strong></strong>      (      )         .   PostgreSQL    —      .<br>
<br>
      (  )   .        .<br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLはさまざまなタイプのロックを使用します。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトレベルのロックは、</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長期的な「重い」</font><strong><font style="vertical-align: inherit;">ロック</font></strong><font style="vertical-align: inherit;">です。ここでのリソースは、関係やその他のオブジェクトです。ブロッキングという単語が説明なしでテキストに表示されている場合、それはそのような「通常の」ブロッキングを示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長期ロックの中で、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行レベルの</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックは個別に目立ち</font><font style="vertical-align: inherit;">ます。それらの実装は、潜在的に膨大な数があるため、他の長期ロックとは異なります（1つのトランザクションで100万行を更新することを想像してください）。このようなロックについては、次の記事で説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シリーズの3番目の記事では、残りのオブジェクトレベルのロックと</font><strong><font style="vertical-align: inherit;">述語ロックに</font></strong><font style="vertical-align: inherit;">焦点を当てます</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（これらすべてのロックに関する情報は同じ方法でRAMに格納されるため）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ショートロックには</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、RAM構造の</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまな</font><strong><font style="vertical-align: inherit;">ロックが</font></strong><font style="vertical-align: inherit;">含まれ</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">サイクルの最後の記事でそれらを検討します。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトのロック</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、オブジェクトレベルのロックから始めます。</font><font style="vertical-align: inherit;">ここでは、オブジェクトは最初に</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リレーション</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、つまりテーブル、インデックス、シーケンス、マテリアライズド表現、およびその他のエンティティ</font><font style="vertical-align: inherit;">として理解され</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これらのロックは通常、オブジェクトが同時に変更されたり、オブジェクトの変更中に使用されたりするのを防ぎ、他のニーズにも対応します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あいまいな表現？</font><font style="vertical-align: inherit;">これは、このグループのロックがさまざまな目的で使用されるためです。</font><font style="vertical-align: inherit;">それらを統合するのは、それらがどのように配置されるかです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">端末</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクトロックは、サーバーの共有メモリにあります。それらの数は、2つのパラメーターの値の積によって制限されます：</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">max_locks_per_transaction</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> × </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">max_connections</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロックプールはすべてのトランザクションに共通です。つまり、1つのトランザクションが</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">max_locks_per_transaction</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より多くのロックをキャプチャでき</font><font style="vertical-align: inherit;">ます。システム内のロックの総数が設定された制限を超えないことが重要です。プールは起動時に作成されるため、示された2つのオプションのいずれかを変更すると、サーバーの再起動が必要になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのロックはpg_locksビューで確認できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リソースが互換性のないモードですでにロックされている場合、このリソースをキャプチャしようとするトランザクションはキューに入れられ、ロックが解放されるのを待ちます。保留中のトランザクションはプロセッサリソースを消費しません。対応するサービスプロセスは「スリープ状態になり」、リソースが解放されるとオペレーティングシステムによって起動します。</font><em><font style="vertical-align: inherit;">デッドロック</font></em><font style="vertical-align: inherit;">または</font><em><font style="vertical-align: inherit;">デッドロック</font></em></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
状態が</font><em><font style="vertical-align: inherit;">発生</font></em><font style="vertical-align: inherit;">する可能性があります。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（デッドロック）。1つのトランザクションは、2番目のトランザクションが占有するリソースを続行する必要があり、2番目のトランザクションは、最初のトランザクションが占有するリソースを必要とします（一般的に、デッドロックと3つ以上のトランザクションが発生する可能性があります）。</font><font style="vertical-align: inherit;">この場合、待機は無期限に続くため、PostgreSQLはそのような状況を自動的に検出し、トランザクションの1つを中止して、残りのトランザクションが引き続き動作できるようにします。</font><font style="vertical-align: inherit;">（デッドロックについては、次の記事で詳しく説明します。）</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクト型</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、この記事と次の記事で扱うロックのタイプ（または、必要に応じてオブジェクトのタイプ）のリストです。</font><font style="vertical-align: inherit;">名前は、pg_locksビューのlocktype列に従って与えられます。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リレーションシッ</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
プロック。</font></font><br>
</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transactionid</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">virtualxid</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ブロックトランザクション番号（実または仮想）。</font><font style="vertical-align: inherit;">各トランザクション自体が独自の番号の排他ロックを保持しているため、このようなロックは、別のトランザクションの終了まで待機する必要がある場合に便利です。</font></font><br>
</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タプル</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ブロックバージョン文字列。</font><font style="vertical-align: inherit;">場合によっては、同じ行をロックすることを期待するいくつかのトランザクション間で優先順位を設定するために使用されます。</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残りのタイプのロックの説明は、サイクルの3番目の記事まで延期します。</font><font style="vertical-align: inherit;">それらはすべて、例外モードでのみキャプチャされるか、排他的で共有されてキャプチャされます。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関係のあるファイルにページを追加</font><strong><font style="vertical-align: inherit;">する</font></strong><font style="vertical-align: inherit;">ときに使用されます。</font></font><br>
</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">object</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
関係ではないオブジェクト（データベース、スキーマ、サブスクリプションなど）をロックします。</font></font><br>
</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページページ</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ロック。使用頻度が低く、一部の種類のインデックスでのみ使用されます。</font></font><br>
</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">勧告</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ユーザーが手動で設定</font><strong><font style="vertical-align: inherit;">する</font></strong><font style="vertical-align: inherit;">推奨ロック。</font></font><br>
</li>
</ul><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関係ロック</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテキストを失わないようにするために、そのような画像にこれらの種類のロックにマークを付けます。これについては後で説明します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/wc/ne/odwcnenfvjv_ikwmqw8x-vaexqi.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モード</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も重要でないとしても、確かに最も「分岐した」ブロッキング-ブロッキング関係。</font><font style="vertical-align: inherit;">彼女にとって、8つの異なるモードが定義されています。</font><font style="vertical-align: inherit;">このような量は、1つのテーブルに関連するコマンドの最大数を同時に実行できるようにするために必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのモードを暗記したり、名前の意味を理解しようとしても意味がありません。</font><font style="vertical-align: inherit;">主なことは、適切なタイミング</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">目の前に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マトリックス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を配置することです。これにより、どのロックが競合しているのかがわかります。</font><font style="vertical-align: inherit;">便宜上、適切なロックレベルを必要とするコマンドの例とともに、ここに再現されています。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックモード</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なので&nbsp;</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RS&nbsp;</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RE&nbsp;</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">訴える</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;S&nbsp;</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SRE</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;E&nbsp;</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ええ&nbsp;</font></font></th>
<th><font style="vertical-align: inherit;"><nobr><font style="vertical-align: inherit;">SQLコマンドの</font></nobr><font style="vertical-align: inherit;">サンプル</font></font><nobr><font style="vertical-align: inherit;"></font></nobr></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセス共有</font></font></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">選択する</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行シェア</font></font></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新/共有を選択</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行専用</font></font></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">挿入、更新、削除</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独占更新</font></font></td>
<td></td>
<td></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM、ALTER TABLE </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">*</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、CREATE INDEX CONCURRENTLY</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共有</font></font></td>
<td></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスを作成</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行を共有しない</font></font></td>
<td></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE TRIGGER、ALTER TABLE </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">*</font></font></sup></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独占</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マットをリフレッシュします。</font><font style="vertical-align: inherit;">同時に見る</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">専用アクセス</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;バツ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DROP、TRUNCATE、VACUUM FULL、LOCK TABLE、ALTER TABLE </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">*</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、REFRESH MAT。</font><font style="vertical-align: inherit;">見る</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかのコメント：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の4つのモードではテーブル内のデータを同時に変更できますが、次の4つのモードではできません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のモード（アクセス共有）は最も弱く、最後のモード（アクセス排他）以外と互換性があります。</font><font style="vertical-align: inherit;">この最後のモードは排他的であり、どのモードとも互換性がありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLEコマンドには多くのオプションがあり、それぞれ異なるレベルのロックが必要です。</font><font style="vertical-align: inherit;">したがって、マトリックスでは、このコマンドは別の行に表示され、アスタリスクが付いています。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たとえば、</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例を挙げる。 CREATE INDEXコマンドを実行するとどうなりますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドキュメントでは、このコマンドが共有モードでロックを設定していることがわかります。マトリックスによると、コマンドはそれ自体と互換性がある（つまり、複数のインデックスを同時に作成できる）と読み取りコマンドと互換性があると判断します。したがって、SELECTコマンドは引き続き機能しますが、UPDATE、DELETE、INSERTコマンドはブロックされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、その逆-テーブル内のデータを変更する不完全なトランザクションは、CREATE INDEXコマンドの操作をブロックします。したがって、コマンドのバリアント-CREATE INDEX CONCURRENTLYがあります。これはより長く機能します（エラーで落ちる可能性もあります）が、同時にデータを変更できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは実際に見ることができます。実験では、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">最初のサイクル</font></a><font style="vertical-align: inherit;">でおなじみのものを使用し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 口座番号と金額を保存する「銀行」口座のテーブル。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> accounts(<font></font>
  acc_no <span class="hljs-type">integer</span> <span class="hljs-keyword">PRIMARY KEY</span>,<font></font>
  amount <span class="hljs-type">numeric</span><font></font>
);<font></font>
=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> accounts
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-number">1000.00</span>), (<span class="hljs-number">2</span>,<span class="hljs-number">2000.00</span>), (<span class="hljs-number">3</span>,<span class="hljs-number">3000.00</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のセッションで、トランザクションを開始します。</font><font style="vertical-align: inherit;">サービスプロセス番号が必要です。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">SELECT</span> pg_backend_pid();
</code></pre><pre><code class="plaintext hljs">|   pg_backend_pid<font></font>
|  ----------------<font></font>
|             4746<font></font>
|  (1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しく開始されたトランザクションはどのロックを保持しますか？</font><font style="vertical-align: inherit;">pg_locksを調べます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> locktype, relation::<span class="hljs-type">REGCLASS</span>, virtualxid <span class="hljs-keyword">AS</span> virtxid, transactionid <span class="hljs-keyword">AS</span> xid, mode, granted
<span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">4746</span>;
</code></pre><pre><code class="plaintext hljs">  locktype  | relation | virtxid | xid |     mode      | granted<font></font>
------------+----------+---------+-----+---------------+---------<font></font>
 virtualxid |          | 5/15    |     | ExclusiveLock | t<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに述べたように、トランザクションは常にそれ自体の番号の排他（ExclusiveLock）ロック（この場合は仮想ロック）を保持します。</font><font style="vertical-align: inherit;">このプロセスには他のロックはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、テーブルの行を更新します。</font><font style="vertical-align: inherit;">状況はどのように変化しますか？</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; \g
</code></pre><pre><code class="plaintext hljs">   locktype    |   relation    | virtxid |  xid   |       mode       | granted<font></font>
---------------+---------------+---------+--------+------------------+---------<font></font>
 relation      | accounts_pkey |         |        | RowExclusiveLock | t<font></font>
 relation      | accounts      |         |        | RowExclusiveLock | t<font></font>
 virtualxid    |               | 5/15    |        | ExclusiveLock    | t<font></font>
 transactionid |               |         | 529404 | ExclusiveLock    | t<font></font>
(4 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、UPDATEコマンドで使用される（主キー用に作成された）可変テーブルとインデックスにロックが設定されました。</font><font style="vertical-align: inherit;">両方のロックはRowExclusiveLockモードで取得されます。</font><font style="vertical-align: inherit;">さらに、実際のトランザクション番号の排他的ブロックが追加されました（トランザクションがデータを変更し始めるとすぐに表示されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のセッションでは、テーブルにインデックスを作成します。</font></font><br>
<br>
<pre><code class="pgsql hljs">||     =&gt; <span class="hljs-keyword">SELECT</span> pg_backend_pid();
</code></pre><pre><code class="plaintext hljs">||      pg_backend_pid<font></font>
||     ----------------<font></font>
||                4782<font></font>
||     (1 row)<font></font>
</code></pre><pre><code class="pgsql hljs">||     =&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> accounts(acc_no);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドは、リソースの解放を見越してフリーズします。</font><font style="vertical-align: inherit;">彼女はどのような種類のロックを取得しようとしていますか？</font><font style="vertical-align: inherit;">小切手：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> locktype, relation::<span class="hljs-type">REGCLASS</span>, virtualxid <span class="hljs-keyword">AS</span> virtxid, transactionid <span class="hljs-keyword">AS</span> xid, mode, granted
<span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> pid = <span class="hljs-number">4782</span>;
</code></pre><pre><code class="plaintext hljs">  locktype  | relation | virtxid | xid |     mode      | granted<font></font>
------------+----------+---------+-----+---------------+---------<font></font>
 virtualxid |          | 6/15    |     | ExclusiveLock | t<font></font>
 relation   | accounts |         |     | ShareLock     | f<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションがShareLockモードでテーブルロックを取得しようとしているが、できない（許可= f）ことがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョン9.6に登場した関数を使用して、ブロックプロセスの数、そして一般的にはいくつかの数を見つけるのは便利です（以前は、pg_locksのすべての内容を注意深く調べて結論を導き出す必要がありました）。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pg_blocking_pids(<span class="hljs-number">4782</span>);
</code></pre><pre><code class="plaintext hljs"> pg_blocking_pids<font></font>
------------------<font></font>
 {4746}<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、状況を理解するために、見つかった数値を含むセッションに関する情報を取得できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_activity
<span class="hljs-keyword">WHERE</span> pid = <span class="hljs-keyword">ANY</span>(pg_blocking_pids(<span class="hljs-number">4782</span>)) \gx
</code></pre><pre><code class="plaintext hljs">-[ RECORD 1 ]----+------------------------------------------------------------<font></font>
datid            | 16386<font></font>
datname          | test<font></font>
pid              | 4746<font></font>
usesysid         | 16384<font></font>
usename          | student<font></font>
application_name | psql<font></font>
client_addr      |<font></font>
client_hostname  |<font></font>
client_port      | -1<font></font>
backend_start    | 2019-08-07 15:02:53.811842+03<font></font>
xact_start       | 2019-08-07 15:02:54.090672+03<font></font>
query_start      | 2019-08-07 15:02:54.10621+03<font></font>
state_change     | 2019-08-07 15:02:54.106965+03<font></font>
wait_event_type  | Client<font></font>
wait_event       | ClientRead<font></font>
state            | idle in transaction<font></font>
backend_xid      | 529404<font></font>
backend_xmin     |<font></font>
query            | UPDATE accounts SET amount = amount + 100 WHERE acc_no = 1;<font></font>
backend_type     | client backend<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションが完了すると、ロックが解除され、インデックスが作成されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><pre><code class="plaintext hljs">|  COMMIT
</code></pre><br>
<pre><code class="plaintext hljs">||     CREATE INDEX
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">順番待ち！..</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
互換性のないブロッキングの外観が何をもたらすかをよりよく理解するために、システムの操作中にVACUUM FULLコマンドが実行されるとどうなるかを見ていきます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECTコマンドを最初にテーブルで実行してみましょう。</font><font style="vertical-align: inherit;">彼女は最も弱いレベルのAccess Shareをロックします。</font><font style="vertical-align: inherit;">ロックの解放時間を制御するには、トランザクション内でこのコマンドを実行します。トランザクションが終了するまで、ロックは解放されません。</font><font style="vertical-align: inherit;">実際には、いくつかのコマンドがテーブルを読み取り（および変更）でき、一部のクエリはかなり時間がかかる場合があります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts;
</code></pre><pre><code class="plaintext hljs"> acc_no | amount  <font></font>
--------+---------<font></font>
      2 | 2000.00<font></font>
      3 | 3000.00<font></font>
      1 | 1100.00<font></font>
(3 rows)<font></font>
</code></pre><pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> locktype, mode, granted, pid, pg_blocking_pids(pid) <span class="hljs-keyword">AS</span> wait_for
<span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> relation = <span class="hljs-string">'accounts'</span>::<span class="hljs-type">regclass</span>;
</code></pre><pre><code class="plaintext hljs"> locktype |      mode       | granted | pid  | wait_for<font></font>
----------+-----------------+---------+------+----------<font></font>
 relation | AccessShareLock | t       | 4710 | {}<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、管理者はVACUUM FULLコマンドを実行します。これには、Access Shareでさえも互換性のないAccess Exclusiveレベルのロックが必要です。</font><font style="vertical-align: inherit;">（LOCK TABLEコマンドでも同じロックが必要です。）トランザクションキュー。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
|  =&gt; <span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> accounts; <span class="hljs-comment">--  VACUUM FULL</span>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> locktype, mode, granted, pid, pg_blocking_pids(pid) <span class="hljs-keyword">AS</span> wait_for
<span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> relation = <span class="hljs-string">'accounts'</span>::<span class="hljs-type">regclass</span>;
</code></pre><pre><code class="plaintext hljs"> locktype |        mode         | granted | pid  | wait_for<font></font>
----------+---------------------+---------+------+----------<font></font>
 relation | AccessShareLock     | t       | 4710 | {}<font></font>
 relation | AccessExclusiveLock | f       | 4746 | {4710}<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、アプリケーションは引き続きクエリを発行し、SELECTコマンドがシステムに表示されます。</font><font style="vertical-align: inherit;">純粋に理論的には、VACUUM FULLが待機している間、彼女は「ずれ」ている可能性がありますが、正直に言うと、VACUUM FULLのキューに入れられます。</font></font><br>
<br>
<pre><code class="pgsql hljs">||     =&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> accounts;
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> locktype, mode, granted, pid, pg_blocking_pids(pid) <span class="hljs-keyword">AS</span> wait_for
<span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> relation = <span class="hljs-string">'accounts'</span>::<span class="hljs-type">regclass</span>;
</code></pre><pre><code class="plaintext hljs"> locktype |        mode         | granted | pid  | wait_for<font></font>
----------+---------------------+---------+------+----------<font></font>
 relation | AccessShareLock     | t       | 4710 | {}<font></font>
 relation | AccessExclusiveLock | f       | 4746 | {4710}<font></font>
 relation | AccessShareLock     | f       | 4782 | {4746}<font></font>
(3 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECTコマンドを使用した最初のトランザクションが完了してロックを解放すると、VACUUM FULLコマンドが開始されます（LOCK TABLEコマンドでシミュレートしました）。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><pre><code class="plaintext hljs">COMMIT
</code></pre><br>
<pre><code class="plaintext hljs">|  LOCK TABLE
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> locktype, mode, granted, pid, pg_blocking_pids(pid) <span class="hljs-keyword">AS</span> wait_for
<span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> relation = <span class="hljs-string">'accounts'</span>::<span class="hljs-type">regclass</span>;
</code></pre><pre><code class="plaintext hljs"> locktype |        mode         | granted | pid  | wait_for<font></font>
----------+---------------------+---------+------+----------<font></font>
 relation | AccessExclusiveLock | t       | 4746 | {}<font></font>
 relation | AccessShareLock     | f       | 4782 | {4746}<font></font>
(2 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、VACUUM FULLが作業を完了してロックを削除した後にのみ、キューに蓄積されたすべてのコマンド（この例ではSELECT）は、対応するロック（アクセス共有）をキャプチャして実行できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><pre><code class="plaintext hljs">|  COMMIT
</code></pre><br>
<pre><code class="plaintext hljs">||      acc_no | amount  <font></font>
||     --------+---------<font></font>
||           2 | 2000.00<font></font>
||           3 | 3000.00<font></font>
||           1 | 1100.00<font></font>
||     (3 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、不正確なコマンドは、コマンド自体の実行時間よりも大幅に長い時間、システムの動作を麻痺させる可能性があります。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">監視ツール</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、正しい操作にはロックが必要ですが、予期しない結果になる可能性があります。そのような期待を監視して、その原因を理解し、場合によってはそれらを排除することができます（たとえば、アプリケーションアルゴリズムを変更することによって）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに1つの方法を知っています。長いロックの時点で、pg_locksビューへのリクエストを実行し、ロック可能なトランザクションとブロッキングトランザクション（pg_blocking_pids関数）を調べ、pg_stat_activityを使用してそれらを復号化できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう1つの方法は、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log_lock_waits</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータを有効にすること</font><em><font style="vertical-align: inherit;">です</font></em><font style="vertical-align: inherit;">。この場合、トランザクションが</font><em><font style="vertical-align: inherit;">deadlock_timeout</font></em><font style="vertical-align: inherit;">よりも長く待機していると、サーバーのメッセージログに情報が表示されます</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（パラメーターがデッドロックに使用されるという事実にもかかわらず、我々は通常の期待について話している）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
試してみよう。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> log_lock_waits = <span class="hljs-keyword">on</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> pg_reload_conf();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトの</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deadlock_timeout</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータ値</font><font style="vertical-align: inherit;">は1秒です。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SHOW</span> deadlock_timeout;
</code></pre><pre><code class="plaintext hljs"> deadlock_timeout<font></font>
------------------<font></font>
 1s<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロックを再生します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount - <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><pre><code class="plaintext hljs">UPDATE 1
</code></pre><br>
<pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
|  =&gt; <span class="hljs-keyword">UPDATE</span> accounts <span class="hljs-keyword">SET</span> amount = amount + <span class="hljs-number">100.00</span> <span class="hljs-keyword">WHERE</span> acc_no = <span class="hljs-number">1</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のUPDATEコマンドはロックを予期しています。</font><font style="vertical-align: inherit;">少し待って、最初のトランザクションを完了します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pg_sleep(<span class="hljs-number">1</span>);<font></font>
=&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><pre><code class="plaintext hljs">COMMIT
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、2番目のトランザクションを完了できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">|  UPDATE 1
</code></pre><pre><code class="pgsql hljs">|  =&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><pre><code class="plaintext hljs">|  COMMIT
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、すべての重要な情報がジャーナルに取り込まれました：</font></font><br>
<br>
<pre><code class="plaintext hljs">postgres$ tail -n 7 /var/log/postgresql/postgresql-11-main.log
</code></pre><pre><code class="plaintext hljs">2019-08-07 15:26:30.827 MSK [5898] student@test LOG:  process 5898 still waiting for ShareLock on transaction 529427 after 1000.186 ms<font></font>
2019-08-07 15:26:30.827 MSK [5898] student@test DETAIL:  Process holding the lock: 5862. Wait queue: 5898.<font></font>
2019-08-07 15:26:30.827 MSK [5898] student@test CONTEXT:  while updating tuple (0,4) in relation "accounts"<font></font>
2019-08-07 15:26:30.827 MSK [5898] student@test STATEMENT:  UPDATE accounts SET amount = amount + 100.00 WHERE acc_no = 1;<font></font>
</code></pre><pre><code class="plaintext hljs">2019-08-07 15:26:30.836 MSK [5898] student@test LOG:  process 5898 acquired ShareLock on transaction 529427 after 1009.536 ms<font></font>
2019-08-07 15:26:30.836 MSK [5898] student@test CONTEXT:  while updating tuple (0,4) in relation "accounts"<font></font>
2019-08-07 15:26:30.836 MSK [5898] student@test STATEMENT:  UPDATE accounts SET amount = amount + 100.00 WHERE acc_no = 1;<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">続くこと</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462855/index.html">簡単なプログラミング：GitLabのカンバンボードで1営業日</a></li>
<li><a href="../ja462859/index.html">ヨーロッパのバス会社がロシアでどのように運営されているか：バスと乗客の違い</a></li>
<li><a href="../ja462863/index.html">8月21日Zabbixモスクワのミートアップ＃5を放送</a></li>
<li><a href="../ja462869/index.html">Agileanプロジェクト管理システム</a></li>
<li><a href="../ja462875/index.html">コストを削減し、ビジネスモデルに最適なITサポートを提供する方法。私たちは「救いの真ん中の道」を探しています</a></li>
<li><a href="../ja462879/index.html">Slurm DevOps：すべてのストップを備えたGitからSREへ</a></li>
<li><a href="../ja462881/index.html">視聴する映画を選択するのがなぜ難しいのか（そして何ができるのか）</a></li>
<li><a href="../ja462883/index.html">SEOのオンラインストアの設計：（理論+チェックリスト）</a></li>
<li><a href="../ja462885/index.html">手元のフォールトトレラントIPoEネットワーク</a></li>
<li><a href="../ja462887/index.html">動的推奨の例を使用してオンラインストアをパーソナライズする経験</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>