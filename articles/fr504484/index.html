<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙏🏿 🤟🏽 👩‍✈️ IPSec Tout-Puissant 🌔 🖱️ 🚠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour mes amis. Ce n'est pas un secret que beaucoup d'entre nous ont au moins une fois, mais ont dû faire face à la nécessité de configurer un VPN. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec Tout-Puissant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour mes amis. </font><font style="vertical-align: inherit;">Ce n'est pas un secret que beaucoup d'entre nous ont au moins une fois, mais ont dû faire face à la nécessité de configurer un VPN. </font><font style="vertical-align: inherit;">Étant un lecteur actif de Habr, j'ai remarqué que malgré l'abondance d'articles sur IPSec, pour beaucoup, cela semble toujours être quelque chose de compliqué et de surchargé. </font><font style="vertical-align: inherit;">Dans cet article, je vais essayer de dissiper ces mythes en utilisant ma propre configuration pleinement fonctionnelle comme exemple. </font><font style="vertical-align: inherit;">Dans quatre exemples, nous passerons en revue la configuration de la solution Linux (Strongswan) la plus populaire, d'un simple tunnel avec authentification latérale avec clés PSK à une connexion d'hôte à hôte avec authentification des deux côtés basée sur des certificats de Let's Encrypt. </font><font style="vertical-align: inherit;">Intéressant? </font><font style="vertical-align: inherit;">Bienvenue chez cat!</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialement, le VPN n'était prévu que pour l'organisation du canal entre le mini-routeur des parents et le serveur "chevet" domestique, qui fait office de routeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après une courte période de temps, Keenetic a été ajouté à cette société à partir de deux appareils. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais une fois démarré, il s'est avéré difficile d'arrêter, et bientôt des téléphones et un ordinateur portable sont apparus sur le diagramme, qui voulaient se cacher de l'œil publicitaire omniprésent de MT_Free et d'autres réseaux WiFi non cryptés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis le bien-aimé ILV est finalement devenu plus fort le Banhammer, dont il est incroyablement tombé amoureux en se balançant publiquement dans toutes les directions, et afin de neutraliser son souci des simples mortels, il a dû </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soutenir le secteur informatique étranger</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour acquérir des VPS à l'étranger.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, une certaine citoyenne qui ressemble à Shapoklyak, courant partout avec son </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réticule par le</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paquet, et croyant probablement que «Qui aide les gens, perd du temps. </font><font style="vertical-align: inherit;">Vous ne pouvez pas devenir célèbre pour ses bonnes actions », je voulais jeter un œil au trafic de quelqu'un d'autre et le prendre au crayon. </font><font style="vertical-align: inherit;">Nous devrons également nous défendre contre un tel amour non sollicité et VPN dans ce cas exactement ce que le médecin a ordonné. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour résumer un court résumé. </font><font style="vertical-align: inherit;">Il était nécessaire de trouver une solution qui pourrait idéalement clôturer plusieurs tâches à la fois:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interconnexion entre les routeurs Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Construisez un tunnel entre Linux et Keenetic Household</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Donner accès aux ressources domestiques et à Internet aux appareils portables (téléphones, ordinateurs portables) provenant de réseaux non fiables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Créez un tunnel crypté en toute sécurité vers le VPS distant</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas le merveilleux principe KISS - Keep It Simple, Stupid. </font><font style="vertical-align: inherit;">Moins il y aura de composants impliqués et plus il sera facile de configurer chacun d'eux - le plus fiable.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aperçu des solutions existantes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passez brièvement en revue ce qui est maintenant: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Grand-père Lénine de tous les protocoles. </font><font style="vertical-align: inherit;">Mort, "Pourri sur la moisissure et le miel de tilleul." </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Est-ce que quelqu'un d'autre qu'un fournisseur l'utilise? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
projet </font><b><font style="vertical-align: inherit;">Wireguard</font></b><font style="vertical-align: inherit;"> se développe. </font><font style="vertical-align: inherit;">Scié activement. </font><font style="vertical-align: inherit;">Il est facile de créer un tunnel entre deux pairs ayant une adresse IP statique. </font><font style="vertical-align: inherit;">Dans d'autres cas, des béquilles, des vélos à roues carrées et un ruban électrique bleu sont toujours prêts à aider, mais ce n'est pas notre façon. </font><font style="vertical-align: inherit;">
Avantages d' </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prise en charge de plusieurs plateformes - Windows, Linux, OpenWRT et ses dérivés, Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cryptage fort et prise en charge des certificats.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Flexibilité de personnalisation.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Et les inconvénients:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Travaillez entièrement dans l'espace utilisateur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Support limité des routeurs domestiques - krenenko-kosenko sur Mikrotik (sans nuire aux autres avantages des glandes) et normal dans OpenWRT.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Difficultés de configuration des clients mobiles: vous devez télécharger ou créer votre propre programme d'installation, copier les configurations quelque part.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S'il y a plusieurs tunnels, les danses attendent avec l'édition des unités systemd sur le serveur.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect (implémentation open-source du protocole Cisco Anyconnect)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Une solution très intéressante sur laquelle, malheureusement, il y a pas mal d'informations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avantages:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La prise en charge relativement large de diverses plates-formes - Windows, Android, Mac basées sur l'application native Cisco Anyconnect du magasin - est une option idéale pour fournir un accès au réseau interne d'appareils portables.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cryptage fort, prise en charge des certificats, connectivité 2FA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le protocole lui-même est entièrement basé sur TLS (contrairement à OpenVPN, qui est facilement détecté sur le port 443). </font><font style="vertical-align: inherit;">En plus de TLS, DTLS est également pris en charge - pendant la session établie, le client peut passer à la transmission de données via UDP et vice versa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Excellente coexistence sur un port d'un VPN et d'un serveur Web à part entière utilisant le sniproxy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuration facile du serveur et des clients.</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Là aussi, ce n'était pas sans inconvénients:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Travaillez entièrement dans l'espace utilisateur.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP en plus de TCP est une mauvaise idée.</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il n'y a pas de support d'équipement de qualité client.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La complexité de l'installation de tunnels entre deux Linux: théoriquement possible, pratiquement - il vaut mieux passer du temps sur quelque chose de plus utile.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S'il y a plusieurs tunnels, des danses avec plusieurs configs et éditant des unités systemd attendent.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semblerait être une impasse, mais après avoir regardé de plus près et passé un peu de temps à étudier, j'ai réalisé qu'IPSec basé sur IKEv2 est capable de remplacer tout le reste. </font><font style="vertical-align: inherit;">
Avantages </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec IKEv2</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Avec l'avènement d'IKEv2, le protocole lui-même est devenu plus facile à configurer, par rapport à la version précédente, mais au prix de perdre la compatibilité descendante.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grâce à la standardisation, le travail est assuré n'importe où et sur n'importe quoi - la liste peut être maintenue indéfiniment. </font><font style="vertical-align: inherit;">Linux, Mikrotik (dans les dernières versions de RouterOS), OpenWRT, Android, iPhone. </font><font style="vertical-align: inherit;">Windows a également un support natif à partir de Windows 7.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haute vitesse: traitement complet du trafic dans l'espace noyau. </font><font style="vertical-align: inherit;">La partie espace utilisateur n'est nécessaire que pour définir les paramètres de connexion et surveiller l'intégrité du canal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La possibilité d'utiliser plusieurs méthodes d'authentification: en utilisant à la fois PSK et certificats, et dans n'importe quelle combinaison.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plusieurs modes de fonctionnement: tunnel et transport. </font><font style="vertical-align: inherit;">Comment ils diffèrent peuvent être lus, y compris sur Habré.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paramètres peu exigeants pour les nœuds intermédiaires: si dans la première version d'IKE il y avait des problèmes causés par NAT, alors IKEv2 a des mécanismes intégrés pour surmonter NAT et la fragmentation native des messages IKE, ce qui vous permet d'établir une connexion sur des canaux avec une courbe MTU. </font><font style="vertical-align: inherit;">Pour l'avenir, je dirai que dans la pratique, je n'ai jamais rencontré de réseau WiFi, où qu'un client puisse établir une connexion.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les inconvénients, cependant, ont également:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vous devez passer du temps à étudier et à comprendre comment cela fonctionne.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une fonctionnalité qui peut dérouter un débutant: IPSec, contrairement aux solutions VPN conventionnelles, ne crée pas d'interfaces réseau. </font><font style="vertical-align: inherit;">Seules les politiques de traitement du trafic sont définies, tout le reste est résolu au moyen d'un pare-feu.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de procéder à la configuration, nous supposons que le lecteur connaît déjà un peu les concepts et termes de base. </font><font style="vertical-align: inherit;">Pour aider un débutant, vous pouvez recommander un article de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et Habr lui-même, sur lequel il existe déjà des articles très intéressants et utiles sur ce sujet.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commencer la configuration</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir décidé de la décision, nous procédons à la configuration. </font><font style="vertical-align: inherit;">Le schéma de réseau dans mon cas a la forme suivante (retiré sous le spoiler)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schéma de réseau</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le serveur domestique qui est le centre du réseau. IP externe 1.1.1.1. Un réseau interne 10.0.0.0/23 et une autre adresse 10.255.255.1/30 pour établir une session BGP privée avec VPS; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un routeur Linux basé sur un petit nettop silencieux installé par les parents. Le FAI émet une adresse IP dynamique. Réseau interne 10.0.3.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keenetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Routeur </font><b><font style="vertical-align: inherit;">Keenetic</font></b><font style="vertical-align: inherit;"> avec IPSec installé. Le FAI émet une adresse IP dynamique. Réseau interne 10.0.4.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">road-warriors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - appareils portables se connectant à partir de réseaux non fiables. Les adresses sont émises dynamiquement aux clients lorsqu'ils sont connectés à partir du pool interne (10.1.1.0/24); </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- VPS en dehors de la juridiction d'un ILV respecté. </font><font style="vertical-align: inherit;">IP externe - 5.5.5.5, adresse interne 10.255.255.2/30 pour définir une session BGP privée.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premier pas. </font><font style="vertical-align: inherit;">Du simple au complexe: tunnels utilisant des clés pré-partagées (PSK)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur les deux boîtiers Linux, nous installons les packages nécessaires:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur les deux hôtes, ouvrez les ports 500 / udp, 4500 / udp et autorisez le passage du protocole ESP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez le fichier /etc/strongswan/ipsec.secrects (côté hôte ipsecgw.example.com) et ajoutez la ligne suivante:</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le deuxième côté, de même:</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, l'ID est une adresse e-mail fictive. </font><font style="vertical-align: inherit;">Plus d'informations peuvent être trouvées sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiel </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secrets sauvés, continuant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur l'hôte ipsecgw.example.com, modifiez le fichier /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De même, nous éditons sur l'homologue distant /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous comparez les configurations, vous pouvez voir qu'elles sont presque en miroir, seules les définitions des pairs sont échangées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La directive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto = route</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oblige charon à mettre un piège pour le trafic tombant dans les directives left / rightsubnet (sélecteurs de trafic). </font><font style="vertical-align: inherit;">La coordination des paramètres du tunnel et l'échange de clés commenceront immédiatement après l'apparition d'un trafic qui tombe dans les conditions données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le serveur ipsecgw.example.com dans les paramètres du pare-feu, nous interdisons le masquage pour un réseau 10.0.3.0/24. </font><font style="vertical-align: inherit;">Autorisez le transfert de paquets entre 10.0.0.0/23 et 10.0.3.0/24 et vice versa. </font><font style="vertical-align: inherit;">Sur l'hôte distant, nous effectuons des réglages similaires en désactivant le masquage pour le réseau 10.0.0.0/23 et en configurant le transfert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous redémarrons strongswan sur les deux serveurs et essayons d'envoyer une requête ping au nœud central:</font></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assurez-vous que tout fonctionne:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il sera également utile de s'assurer que le paramètre make_before_break est défini sur yes dans le fichier /etc/strongswan/strongswan.d/charon.conf pour tous les homologues. </font><font style="vertical-align: inherit;">Dans ce cas, le démon charon servant le protocole IKEv2 ne supprimera pas l'association de sécurité actuelle pendant la procédure de changement de clé, mais en créera d'abord une nouvelle.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxième étape </font><font style="vertical-align: inherit;">L'apparition de Keenetic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une surprise agréable a été le VPN IPSec intégré dans le firmware officiel de Keenetic. </font><font style="vertical-align: inherit;">Pour l'activer, accédez simplement aux </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paramètres du composant KeeneticOS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ajoutez le package </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN IPSec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous préparons les paramètres sur le nœud central, pour cela: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Éditez /etc/strongswan/ipsec.secrects et ajoutez le PSK pour le nouveau pair:</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez /etc/strongswan/ipsec.conf et ajoutez une autre connexion à la fin:</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Côté Keenetic, la configuration se fait dans l'interface Web le long du chemin: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet -&gt; Connexions -&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autres connexions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">C'est assez simple</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3 photos)</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous prévoyez de générer des volumes de trafic importants via le tunnel, vous pouvez essayer d'activer l'accélération matérielle, qui est prise en charge par de nombreux modèles. </font><font style="vertical-align: inherit;">Activé par la commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">matérielle du moteur de chiffrement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la CLI. </font><font style="vertical-align: inherit;">Pour désactiver et traiter les processus de chiffrement et de hachage à l'aide d'instructions générales du processeur - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logiciel de moteur de cryptage</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Après avoir enregistré les paramètres, nous restaurons strongswan et laissons Keenetic réfléchir pendant une demi-minute. </font><font style="vertical-align: inherit;">Ensuite, dans le terminal, nous voyons une connexion réussie:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout fonctionne:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troisième étape </font><font style="vertical-align: inherit;">Protéger les appareils mobiles</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir lu un tas de manuels et un tas d'articles, il a été décidé de s'arrêter à un tas d'un certificat gratuit de Let's Encrypt pour authentifier le serveur et l'autorisation classique par login et mot de passe pour les clients. </font><font style="vertical-align: inherit;">Ainsi, nous nous débarrassons de la nécessité de maintenir notre propre infrastructure PKI, de surveiller l'expiration des clés et d'effectuer des gestes inutiles avec les appareils mobiles en installant des certificats auto-signés dans la liste de confiance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez les packages manquants:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons le certificat autonome (n'oubliez pas d'ouvrir 80 / tcp dans les paramètres iptables en premier):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que certbot a terminé son travail, nous devons apprendre à Strongswan à voir notre certificat:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le répertoire /etc/strongswan/ipsec.d/cacerts créez 2 liens symboliques: un vers le magasin racine des certificats de confiance dans / etc / pki / tls / certs; </font><font style="vertical-align: inherit;">et une seconde avec le nom ca.pem pointant vers /etc/letsencrypt/live/ipsecgw.example.com/chain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deux liens symboliques sont également créés dans le répertoire /etc/strongswan/ipsec.d/certs: le premier, avec le nom certificate.pem, fait référence au fichier /etc/letsencrypt/live/ipsecgw.example.com/cert.pem. </font><font style="vertical-align: inherit;">Et le second, nommé fullchain.pem, se liant à /etc/letsencrypt/live/ipsecgw.example.com/fullchain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le répertoire /etc/strongswan/ipsec.d/private, placez le lien symbolique key.pem pointant vers la clé privée générée par certbot et se trouvant le long du chemin /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez l'authentification via RSA à ipsec.secrets et un tas de connexions / mots de passe pour les nouveaux utilisateurs:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous redémarrons Strongswan et lorsque nous appelons sudo strongswan listcerts, nous devrions voir les informations du certificat:</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous décrivons la nouvelle connexion dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas de modifier le fichier / etc / sysconfig / certbot en indiquant que nous mettrons également à jour le certificat en tant que autonome, en y ajoutant CERTBOT_ARGS = "- standalone". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas non plus d'activer la minuterie certbot-refresh.timer et de configurer le hook pour redémarrer Strongswan en cas d'émission d'un nouveau certificat. </font><font style="vertical-align: inherit;">Pour ce faire, placez un simple script bash dans / etc / letsencrypt / renouvellement-hooks / deploy /, ou modifiez à nouveau le fichier / etc / sysconfig / certbot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous redémarrons Strongswan, activons le masquage pour le réseau 10.1.1.0/24 dans iptables et continuons à configurer les appareils mobiles.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez l'application </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan à</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> partir de Google Play </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous lançons et créons un nouveau</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">profil</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous enregistrons le profil, nous nous connectons et, après une seconde, nous n'avons pas à nous soucier de la possibilité pour quelqu'un de nous espionner.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous vérifions:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les fenêtres</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows des versions actuelles a été agréablement surpris. </font><font style="vertical-align: inherit;">Toute la configuration du nouveau VPN s'effectue en appelant deux applets de commande PowerShell:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et encore une chose, si Strongswan est configuré pour émettre des adresses IPv6 aux clients (oui, il peut le faire aussi):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quatrième partie, finale. </font><font style="vertical-align: inherit;">Nous ouvrons une fenêtre sur l'Europe</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ayant vu les talons du fournisseur "Le site a été bloqué par la décision du talon gauche du cinquième procureur adjoint du village Trudovye Mozoli du comté de Bogozabyt", un petit VPS discret est apparu (avec le nom de domaine bien entendu rkn.example.com) à mille kilomètres de singes qui aiment agiter avec un marteau et bloquer les réseaux de taille / 16 à la fois. Et tourner sur ce petit VPS était une merveilleuse création de collègues de NIC.CZ appelés BIRD. L'oiseau de la première version est constamment mort dans la panique de l'activité des singes avec des matraques, qui ont interdit près de 4% d'Internet au sommet de leur activité, laissant une profonde réflexion lors de la reconfiguration, il a donc été mis à jour vers la version 2.0.7. Si les lecteurs sont intéressés, je publierai un article sur la transition de BIRD à BIRD2, dans lequel le format de configuration a radicalement changé,mais la nouvelle version est devenue beaucoup plus rapide et il n'y a aucun problème avec la reconfig avec un grand nombre de routes. Et puisque nous utilisons le protocole de routage dynamique, il doit y avoir une interface réseau à travers laquelle vous devez acheminer le trafic. Par défaut, IPSec ne crée pas d'interfaces, mais en raison de sa flexibilité, nous pouvons utiliser les tunnels GRE classiques, que nous protégerons à l'avenir. En prime, les hôtes ipsecgw.example.com et rkn.example.com s'authentifieront mutuellement à l'aide de certificats auto-renouvelables Lets Encrypt. Pas de PSK, seulement des certificats, seulement du hardcore, il n'y a pas beaucoup de sécurité.Par défaut, IPSec ne crée pas d'interfaces, mais en raison de sa flexibilité, nous pouvons utiliser les tunnels GRE classiques, que nous protégerons à l'avenir. En prime, les hôtes ipsecgw.example.com et rkn.example.com s'authentifieront mutuellement à l'aide de certificats auto-renouvelables Lets Encrypt. Pas de PSK, seulement des certificats, seulement du hardcore, il n'y a pas beaucoup de sécurité.Par défaut, IPSec ne crée pas d'interfaces, mais en raison de sa flexibilité, nous pouvons utiliser les tunnels GRE classiques, que nous protégerons à l'avenir. En prime, les hôtes ipsecgw.example.com et rkn.example.com s'authentifieront mutuellement à l'aide de certificats auto-renouvelables Lets Encrypt. Pas de PSK, seulement des certificats, seulement du hardcore, il n'y a pas beaucoup de sécurité.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pensons que le VPS est prêt, Strongswan et Certbot sont déjà installés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur l'hôte ipsecgw.example.com (son IP est 1.1.1.1), nous décrivons la nouvelle interface gif0:</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mis en miroir sur l'hôte vps.example.com (son IP est 5.5.5.5):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous augmentons les interfaces, mais comme iptables n'a pas de règle qui autorise le protocole GRE, le trafic ne passera pas (ce dont nous avons besoin, car il n'y a pas de protection à l'intérieur du GRE contre les fans de tout type de «packages» législatifs).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuisson VPS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous obtenons un autre certificat pour le nom de domaine rkn.example.com. </font><font style="vertical-align: inherit;">Créez des liens symboliques dans /etc/strongswan/ipsec.d comme décrit dans la section précédente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez ipsec.secrets en y ajoutant une seule ligne:</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Côté hôte, ipsecgw.example.com est également ajouté à ipsec.conf dans la section de configuration du paramètre strictcrlpolicy = yes, qui inclut une vérification stricte de la liste de révocation de certificats. </font><font style="vertical-align: inherit;">Et décrivez une autre connexion:</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les configurations sont presque reflétées. </font><font style="vertical-align: inherit;">Le lecteur attentif pouvait déjà prêter attention à quelques points:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left / rightsubnet =% dynamic - demande à Strongswan d'appliquer des politiques à tous les types de trafic entre pairs</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas de configurer le pare-feu et de renouveler automatiquement les certificats. </font><font style="vertical-align: inherit;">Après avoir redémarré Strongswan sur les deux serveurs, commencez à envoyer une requête ping de l'autre côté du tunnel GRE et voyez une connexion réussie. </font><font style="vertical-align: inherit;">Sur VPS (rkn):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et du côté hôte ipsecgw </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sous le spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le tunnel est installé, les pings vont, dans tcpdump, il est visible que seul ESP passe entre les hôtes. </font><font style="vertical-align: inherit;">Il semblerait possible de se réjouir. </font><font style="vertical-align: inherit;">Mais vous ne pouvez pas vous détendre sans tout vérifier jusqu'au bout. </font><font style="vertical-align: inherit;">Nous essayons de réémettre le certificat pour VPS et ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chef, tout est cassé</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous commençons à comprendre et à tomber sur une caractéristique désagréable de Let's Encrypt, qui est belle dans tout le reste - avec toute réémission du certificat, la clé privée qui lui est associée change également. La clé privée a changé - et le public a changé. À première vue, la situation est désespérée pour nous: même si nous pouvons facilement extraire la clé publique lors de la réémission du certificat à l'aide du hook dans certbot et la transmettre au côté distant via SSH, il n'est pas clair comment faire relire Strongswan à distance. Mais l'aide est venue de là où ils n'ont pas attendu - systemd peut surveiller les modifications du système de fichiers et exécuter les services associés à l'événement. C'est ce que nous allons utiliser.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons créer un utilisateur du service Keywatcher sur chacun des hôtes avec les droits les plus restreints, générer des clés SSH pour chacun d'eux et les échanger entre les hôtes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur l'hôte ipsecgw.example.com, créez le répertoire / opt / ipsec-pubkey dans lequel nous plaçons 2 scripts.</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur VPS (l'hôte rkn.example.com), nous créons également un répertoire du même nom, dans lequel nous créons également des scripts similaires, en ne changeant que le nom de la clé. </font><font style="vertical-align: inherit;">Code, afin de ne pas encombrer l'article, sous</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">divulgacher</font></font></b>
                        <div class="spoiler_text">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le script pubkey-copy.sh est nécessaire pour extraire la partie publique de la clé et la copier sur l'hôte distant lors de l'émission d'un nouveau certificat. </font><font style="vertical-align: inherit;">Pour ce faire, dans le répertoire / etc / letsencrypt / renouvellement-hooks / deploy sur les deux serveurs, créez un autre microscript:</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La moitié du problème est résolu, les certificats sont réémis, les clés publiques sont extraites et copiées entre les serveurs, et le moment est venu pour systemd avec ses unités de chemin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le serveur ipsecgw.example.com dans le répertoire / etc / systemd / system, créez le fichier keyupdater.path</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De même sur l'hôte VPS:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et enfin, sur chaque serveur, nous créons un service associé à cette unité, qui sera lancé lorsque la condition (PathChanged) sera remplie - changer le fichier et le fermer après l'enregistrement. </font><font style="vertical-align: inherit;">Nous créons les fichiers /etc/systemd/system/keyupdater.service et écrivons:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas de relire les configurations systemd avec sudo systemctl daemon-reload et d'affecter le démarrage automatique aux unités de chemin via sudo systemctl enable keyupdater.path &amp;&amp; sudo systemctl start keyupdater. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dès que l'hôte distant écrit le fichier contenant la clé publique dans le répertoire de base de l'utilisateur du keywatcher et que le descripteur de fichier est fermé, systemd démarrera automatiquement le service correspondant, qui copiera la clé à l'emplacement souhaité et redémarrera Strongswan. </font><font style="vertical-align: inherit;">Le tunnel sera installé à l'aide de la bonne clé publique du deuxième côté. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez expirer et profiter du résultat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au lieu d'une conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous venons de </font><font style="vertical-align: inherit;">voir l' </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enfer</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec n'est pas aussi effrayant que cela est peint. </font><font style="vertical-align: inherit;">Tout ce qui a été décrit est une configuration entièrement opérationnelle actuellement utilisée. </font><font style="vertical-align: inherit;">Même sans beaucoup de connaissances, vous pouvez configurer un VPN et protéger de manière fiable vos données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, les moments de configuration d'iptables sont restés en dehors de la portée de l'article, mais l'article lui-même s'est avéré déjà volumineux, et beaucoup a été écrit sur iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a des points dans l'article qui peuvent être améliorés, que ce soit le refus de redémarrer le démon Strongswan, la relecture de ses configurations et certificats, mais je n'ai pas pu y parvenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, les redémarrages du démon n'étaient pas effrayants: un ou deux pings entre pairs sont perdus, les clients mobiles rétablissent eux-mêmes la connexion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'espère que mes collègues dans les commentaires proposeront la bonne solution.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504464/index.html">Comment nous avons conçu le TableAdapter et simplifié le travail avec UITableView</a></li>
<li><a href="../fr504468/index.html">Performances du Raspberry Pi: ajoutez ZRAM et modifiez les paramètres du noyau</a></li>
<li><a href="../fr504472/index.html">Mes meilleurs outils de développement gratuits</a></li>
<li><a href="../fr504480/index.html">Comment trouver un marketeur avec qui il sera rentable de travailler?</a></li>
<li><a href="../fr504482/index.html">Demandez-nous: DIT répondra aux questions</a></li>
<li><a href="../fr504486/index.html">Processus: création de Vue 3</a></li>
<li><a href="../fr504488/index.html">Quelles industries et technologies commenceront à se développer rapidement après avoir résolu le problème de COVID-19</a></li>
<li><a href="../fr504490/index.html">Résumé des événements en ligne de juin</a></li>
<li><a href="../fr504492/index.html">Appuyez sur le bouton: théorie et pratique du vote électronique - table ronde le 30 mai</a></li>
<li><a href="../fr504502/index.html">La vie courte et étrange du premier robot amical au monde</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>