<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôèüèø ü§üüèΩ üë©‚Äç‚úàÔ∏è IPSec Tout-Puissant üåî üñ±Ô∏è üö†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour mes amis. Ce n'est pas un secret que beaucoup d'entre nous ont au moins une fois, mais ont d√ª faire face √† la n√©cessit√© de configurer un VPN. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec Tout-Puissant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour mes amis. </font><font style="vertical-align: inherit;">Ce n'est pas un secret que beaucoup d'entre nous ont au moins une fois, mais ont d√ª faire face √† la n√©cessit√© de configurer un VPN. </font><font style="vertical-align: inherit;">√âtant un lecteur actif de Habr, j'ai remarqu√© que malgr√© l'abondance d'articles sur IPSec, pour beaucoup, cela semble toujours √™tre quelque chose de compliqu√© et de surcharg√©. </font><font style="vertical-align: inherit;">Dans cet article, je vais essayer de dissiper ces mythes en utilisant ma propre configuration pleinement fonctionnelle comme exemple. </font><font style="vertical-align: inherit;">Dans quatre exemples, nous passerons en revue la configuration de la solution Linux (Strongswan) la plus populaire, d'un simple tunnel avec authentification lat√©rale avec cl√©s PSK √† une connexion d'h√¥te √† h√¥te avec authentification des deux c√¥t√©s bas√©e sur des certificats de Let's Encrypt. </font><font style="vertical-align: inherit;">Int√©ressant? </font><font style="vertical-align: inherit;">Bienvenue chez cat!</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialement, le VPN n'√©tait pr√©vu que pour l'organisation du canal entre le mini-routeur des parents et le serveur "chevet" domestique, qui fait office de routeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s une courte p√©riode de temps, Keenetic a √©t√© ajout√© √† cette soci√©t√© √† partir de deux appareils. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais une fois d√©marr√©, il s'est av√©r√© difficile d'arr√™ter, et bient√¥t des t√©l√©phones et un ordinateur portable sont apparus sur le diagramme, qui voulaient se cacher de l'≈ìil publicitaire omnipr√©sent de MT_Free et d'autres r√©seaux WiFi non crypt√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis le bien-aim√© ILV est finalement devenu plus fort le Banhammer, dont il est incroyablement tomb√© amoureux en se balan√ßant publiquement dans toutes les directions, et afin de neutraliser son souci des simples mortels, il a d√ª </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soutenir le secteur informatique √©tranger</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour acqu√©rir des VPS √† l'√©tranger.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, une certaine citoyenne qui ressemble √† Shapoklyak, courant partout avec son </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©ticule par le</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paquet, et croyant probablement que ¬´Qui aide les gens, perd du temps. </font><font style="vertical-align: inherit;">Vous ne pouvez pas devenir c√©l√®bre pour ses bonnes actions ¬ª, je voulais jeter un ≈ìil au trafic de quelqu'un d'autre et le prendre au crayon. </font><font style="vertical-align: inherit;">Nous devrons √©galement nous d√©fendre contre un tel amour non sollicit√© et VPN dans ce cas exactement ce que le m√©decin a ordonn√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©sumer un court r√©sum√©. </font><font style="vertical-align: inherit;">Il √©tait n√©cessaire de trouver une solution qui pourrait id√©alement cl√¥turer plusieurs t√¢ches √† la fois:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interconnexion entre les routeurs Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Construisez un tunnel entre Linux et Keenetic Household</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Donner acc√®s aux ressources domestiques et √† Internet aux appareils portables (t√©l√©phones, ordinateurs portables) provenant de r√©seaux non fiables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©ez un tunnel crypt√© en toute s√©curit√© vers le VPS distant</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas le merveilleux principe KISS - Keep It Simple, Stupid. </font><font style="vertical-align: inherit;">Moins il y aura de composants impliqu√©s et plus il sera facile de configurer chacun d'eux - le plus fiable.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aper√ßu des solutions existantes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passez bri√®vement en revue ce qui est maintenant: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Grand-p√®re L√©nine de tous les protocoles. </font><font style="vertical-align: inherit;">Mort, "Pourri sur la moisissure et le miel de tilleul." </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Est-ce que quelqu'un d'autre qu'un fournisseur l'utilise? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
projet </font><b><font style="vertical-align: inherit;">Wireguard</font></b><font style="vertical-align: inherit;"> se d√©veloppe. </font><font style="vertical-align: inherit;">Sci√© activement. </font><font style="vertical-align: inherit;">Il est facile de cr√©er un tunnel entre deux pairs ayant une adresse IP statique. </font><font style="vertical-align: inherit;">Dans d'autres cas, des b√©quilles, des v√©los √† roues carr√©es et un ruban √©lectrique bleu sont toujours pr√™ts √† aider, mais ce n'est pas notre fa√ßon. </font><font style="vertical-align: inherit;">
Avantages d' </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prise en charge de plusieurs plateformes - Windows, Linux, OpenWRT et ses d√©riv√©s, Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cryptage fort et prise en charge des certificats.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Flexibilit√© de personnalisation.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Et les inconv√©nients:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Travaillez enti√®rement dans l'espace utilisateur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Support limit√© des routeurs domestiques - krenenko-kosenko sur Mikrotik (sans nuire aux autres avantages des glandes) et normal dans OpenWRT.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Difficult√©s de configuration des clients mobiles: vous devez t√©l√©charger ou cr√©er votre propre programme d'installation, copier les configurations quelque part.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S'il y a plusieurs tunnels, les danses attendent avec l'√©dition des unit√©s systemd sur le serveur.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect (impl√©mentation open-source du protocole Cisco Anyconnect)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Une solution tr√®s int√©ressante sur laquelle, malheureusement, il y a pas mal d'informations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avantages:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La prise en charge relativement large de diverses plates-formes - Windows, Android, Mac bas√©es sur l'application native Cisco Anyconnect du magasin - est une option id√©ale pour fournir un acc√®s au r√©seau interne d'appareils portables.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cryptage fort, prise en charge des certificats, connectivit√© 2FA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le protocole lui-m√™me est enti√®rement bas√© sur TLS (contrairement √† OpenVPN, qui est facilement d√©tect√© sur le port 443). </font><font style="vertical-align: inherit;">En plus de TLS, DTLS est √©galement pris en charge - pendant la session √©tablie, le client peut passer √† la transmission de donn√©es via UDP et vice versa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Excellente coexistence sur un port d'un VPN et d'un serveur Web √† part enti√®re utilisant le sniproxy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuration facile du serveur et des clients.</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L√† aussi, ce n'√©tait pas sans inconv√©nients:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Travaillez enti√®rement dans l'espace utilisateur.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP en plus de TCP est une mauvaise id√©e.</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Il n'y a pas de support d'√©quipement de qualit√© client.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La complexit√© de l'installation de tunnels entre deux Linux: th√©oriquement possible, pratiquement - il vaut mieux passer du temps sur quelque chose de plus utile.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S'il y a plusieurs tunnels, des danses avec plusieurs configs et √©ditant des unit√©s systemd attendent.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semblerait √™tre une impasse, mais apr√®s avoir regard√© de plus pr√®s et pass√© un peu de temps √† √©tudier, j'ai r√©alis√© qu'IPSec bas√© sur IKEv2 est capable de remplacer tout le reste. </font><font style="vertical-align: inherit;">
Avantages </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec IKEv2</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Avec l'av√®nement d'IKEv2, le protocole lui-m√™me est devenu plus facile √† configurer, par rapport √† la version pr√©c√©dente, mais au prix de perdre la compatibilit√© descendante.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√¢ce √† la standardisation, le travail est assur√© n'importe o√π et sur n'importe quoi - la liste peut √™tre maintenue ind√©finiment. </font><font style="vertical-align: inherit;">Linux, Mikrotik (dans les derni√®res versions de RouterOS), OpenWRT, Android, iPhone. </font><font style="vertical-align: inherit;">Windows a √©galement un support natif √† partir de Windows 7.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haute vitesse: traitement complet du trafic dans l'espace noyau. </font><font style="vertical-align: inherit;">La partie espace utilisateur n'est n√©cessaire que pour d√©finir les param√®tres de connexion et surveiller l'int√©grit√© du canal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La possibilit√© d'utiliser plusieurs m√©thodes d'authentification: en utilisant √† la fois PSK et certificats, et dans n'importe quelle combinaison.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plusieurs modes de fonctionnement: tunnel et transport. </font><font style="vertical-align: inherit;">Comment ils diff√®rent peuvent √™tre lus, y compris sur Habr√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Param√®tres peu exigeants pour les n≈ìuds interm√©diaires: si dans la premi√®re version d'IKE il y avait des probl√®mes caus√©s par NAT, alors IKEv2 a des m√©canismes int√©gr√©s pour surmonter NAT et la fragmentation native des messages IKE, ce qui vous permet d'√©tablir une connexion sur des canaux avec une courbe MTU. </font><font style="vertical-align: inherit;">Pour l'avenir, je dirai que dans la pratique, je n'ai jamais rencontr√© de r√©seau WiFi, o√π qu'un client puisse √©tablir une connexion.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les inconv√©nients, cependant, ont √©galement:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vous devez passer du temps √† √©tudier et √† comprendre comment cela fonctionne.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une fonctionnalit√© qui peut d√©router un d√©butant: IPSec, contrairement aux solutions VPN conventionnelles, ne cr√©e pas d'interfaces r√©seau. </font><font style="vertical-align: inherit;">Seules les politiques de traitement du trafic sont d√©finies, tout le reste est r√©solu au moyen d'un pare-feu.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de proc√©der √† la configuration, nous supposons que le lecteur conna√Æt d√©j√† un peu les concepts et termes de base. </font><font style="vertical-align: inherit;">Pour aider un d√©butant, vous pouvez recommander un article de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et Habr lui-m√™me, sur lequel il existe d√©j√† des articles tr√®s int√©ressants et utiles sur ce sujet.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commencer la configuration</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir d√©cid√© de la d√©cision, nous proc√©dons √† la configuration. </font><font style="vertical-align: inherit;">Le sch√©ma de r√©seau dans mon cas a la forme suivante (retir√© sous le spoiler)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sch√©ma de r√©seau</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le serveur domestique qui est le centre du r√©seau. IP externe 1.1.1.1. Un r√©seau interne 10.0.0.0/23 et une autre adresse 10.255.255.1/30 pour √©tablir une session BGP priv√©e avec VPS; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un routeur Linux bas√© sur un petit nettop silencieux install√© par les parents. Le FAI √©met une adresse IP dynamique. R√©seau interne 10.0.3.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keenetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Routeur </font><b><font style="vertical-align: inherit;">Keenetic</font></b><font style="vertical-align: inherit;"> avec IPSec install√©. Le FAI √©met une adresse IP dynamique. R√©seau interne 10.0.4.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">road-warriors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - appareils portables se connectant √† partir de r√©seaux non fiables. Les adresses sont √©mises dynamiquement aux clients lorsqu'ils sont connect√©s √† partir du pool interne (10.1.1.0/24); </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- VPS en dehors de la juridiction d'un ILV respect√©. </font><font style="vertical-align: inherit;">IP externe - 5.5.5.5, adresse interne 10.255.255.2/30 pour d√©finir une session BGP priv√©e.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premier pas. </font><font style="vertical-align: inherit;">Du simple au complexe: tunnels utilisant des cl√©s pr√©-partag√©es (PSK)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur les deux bo√Ætiers Linux, nous installons les packages n√©cessaires:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur les deux h√¥tes, ouvrez les ports 500 / udp, 4500 / udp et autorisez le passage du protocole ESP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez le fichier /etc/strongswan/ipsec.secrects (c√¥t√© h√¥te ipsecgw.example.com) et ajoutez la ligne suivante:</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le deuxi√®me c√¥t√©, de m√™me:</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, l'ID est une adresse e-mail fictive. </font><font style="vertical-align: inherit;">Plus d'informations peuvent √™tre trouv√©es sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> officiel </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secrets sauv√©s, continuant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur l'h√¥te ipsecgw.example.com, modifiez le fichier /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De m√™me, nous √©ditons sur l'homologue distant /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous comparez les configurations, vous pouvez voir qu'elles sont presque en miroir, seules les d√©finitions des pairs sont √©chang√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La directive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto = route</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oblige charon √† mettre un pi√®ge pour le trafic tombant dans les directives left / rightsubnet (s√©lecteurs de trafic). </font><font style="vertical-align: inherit;">La coordination des param√®tres du tunnel et l'√©change de cl√©s commenceront imm√©diatement apr√®s l'apparition d'un trafic qui tombe dans les conditions donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le serveur ipsecgw.example.com dans les param√®tres du pare-feu, nous interdisons le masquage pour un r√©seau 10.0.3.0/24. </font><font style="vertical-align: inherit;">Autorisez le transfert de paquets entre 10.0.0.0/23 et 10.0.3.0/24 et vice versa. </font><font style="vertical-align: inherit;">Sur l'h√¥te distant, nous effectuons des r√©glages similaires en d√©sactivant le masquage pour le r√©seau 10.0.0.0/23 et en configurant le transfert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous red√©marrons strongswan sur les deux serveurs et essayons d'envoyer une requ√™te ping au n≈ìud central:</font></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assurez-vous que tout fonctionne:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il sera √©galement utile de s'assurer que le param√®tre make_before_break est d√©fini sur yes dans le fichier /etc/strongswan/strongswan.d/charon.conf pour tous les homologues. </font><font style="vertical-align: inherit;">Dans ce cas, le d√©mon charon servant le protocole IKEv2 ne supprimera pas l'association de s√©curit√© actuelle pendant la proc√©dure de changement de cl√©, mais en cr√©era d'abord une nouvelle.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxi√®me √©tape </font><font style="vertical-align: inherit;">L'apparition de Keenetic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une surprise agr√©able a √©t√© le VPN IPSec int√©gr√© dans le firmware officiel de Keenetic. </font><font style="vertical-align: inherit;">Pour l'activer, acc√©dez simplement aux </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">param√®tres du composant KeeneticOS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ajoutez le package </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN IPSec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pr√©parons les param√®tres sur le n≈ìud central, pour cela: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âditez /etc/strongswan/ipsec.secrects et ajoutez le PSK pour le nouveau pair:</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez /etc/strongswan/ipsec.conf et ajoutez une autre connexion √† la fin:</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√¥t√© Keenetic, la configuration se fait dans l'interface Web le long du chemin: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet -&gt; Connexions -&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autres connexions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">C'est assez simple</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3 photos)</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous pr√©voyez de g√©n√©rer des volumes de trafic importants via le tunnel, vous pouvez essayer d'activer l'acc√©l√©ration mat√©rielle, qui est prise en charge par de nombreux mod√®les. </font><font style="vertical-align: inherit;">Activ√© par la commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mat√©rielle du moteur de chiffrement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la CLI. </font><font style="vertical-align: inherit;">Pour d√©sactiver et traiter les processus de chiffrement et de hachage √† l'aide d'instructions g√©n√©rales du processeur - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logiciel de moteur de cryptage</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Apr√®s avoir enregistr√© les param√®tres, nous restaurons strongswan et laissons Keenetic r√©fl√©chir pendant une demi-minute. </font><font style="vertical-align: inherit;">Ensuite, dans le terminal, nous voyons une connexion r√©ussie:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout fonctionne:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troisi√®me √©tape </font><font style="vertical-align: inherit;">Prot√©ger les appareils mobiles</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir lu un tas de manuels et un tas d'articles, il a √©t√© d√©cid√© de s'arr√™ter √† un tas d'un certificat gratuit de Let's Encrypt pour authentifier le serveur et l'autorisation classique par login et mot de passe pour les clients. </font><font style="vertical-align: inherit;">Ainsi, nous nous d√©barrassons de la n√©cessit√© de maintenir notre propre infrastructure PKI, de surveiller l'expiration des cl√©s et d'effectuer des gestes inutiles avec les appareils mobiles en installant des certificats auto-sign√©s dans la liste de confiance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez les packages manquants:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons le certificat autonome (n'oubliez pas d'ouvrir 80 / tcp dans les param√®tres iptables en premier):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que certbot a termin√© son travail, nous devons apprendre √† Strongswan √† voir notre certificat:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le r√©pertoire /etc/strongswan/ipsec.d/cacerts cr√©ez 2 liens symboliques: un vers le magasin racine des certificats de confiance dans / etc / pki / tls / certs; </font><font style="vertical-align: inherit;">et une seconde avec le nom ca.pem pointant vers /etc/letsencrypt/live/ipsecgw.example.com/chain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deux liens symboliques sont √©galement cr√©√©s dans le r√©pertoire /etc/strongswan/ipsec.d/certs: le premier, avec le nom certificate.pem, fait r√©f√©rence au fichier /etc/letsencrypt/live/ipsecgw.example.com/cert.pem. </font><font style="vertical-align: inherit;">Et le second, nomm√© fullchain.pem, se liant √† /etc/letsencrypt/live/ipsecgw.example.com/fullchain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le r√©pertoire /etc/strongswan/ipsec.d/private, placez le lien symbolique key.pem pointant vers la cl√© priv√©e g√©n√©r√©e par certbot et se trouvant le long du chemin /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez l'authentification via RSA √† ipsec.secrets et un tas de connexions / mots de passe pour les nouveaux utilisateurs:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous red√©marrons Strongswan et lorsque nous appelons sudo strongswan listcerts, nous devrions voir les informations du certificat:</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous d√©crivons la nouvelle connexion dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas de modifier le fichier / etc / sysconfig / certbot en indiquant que nous mettrons √©galement √† jour le certificat en tant que autonome, en y ajoutant CERTBOT_ARGS = "- standalone". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas non plus d'activer la minuterie certbot-refresh.timer et de configurer le hook pour red√©marrer Strongswan en cas d'√©mission d'un nouveau certificat. </font><font style="vertical-align: inherit;">Pour ce faire, placez un simple script bash dans / etc / letsencrypt / renouvellement-hooks / deploy /, ou modifiez √† nouveau le fichier / etc / sysconfig / certbot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous red√©marrons Strongswan, activons le masquage pour le r√©seau 10.1.1.0/24 dans iptables et continuons √† configurer les appareils mobiles.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez l'application </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan √†</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> partir de Google Play </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous lan√ßons et cr√©ons un nouveau</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">profil</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous enregistrons le profil, nous nous connectons et, apr√®s une seconde, nous n'avons pas √† nous soucier de la possibilit√© pour quelqu'un de nous espionner.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous v√©rifions:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les fen√™tres</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows des versions actuelles a √©t√© agr√©ablement surpris. </font><font style="vertical-align: inherit;">Toute la configuration du nouveau VPN s'effectue en appelant deux applets de commande PowerShell:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et encore une chose, si Strongswan est configur√© pour √©mettre des adresses IPv6 aux clients (oui, il peut le faire aussi):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quatri√®me partie, finale. </font><font style="vertical-align: inherit;">Nous ouvrons une fen√™tre sur l'Europe</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ayant vu les talons du fournisseur "Le site a √©t√© bloqu√© par la d√©cision du talon gauche du cinqui√®me procureur adjoint du village Trudovye Mozoli du comt√© de Bogozabyt", un petit VPS discret est apparu (avec le nom de domaine bien entendu rkn.example.com) √† mille kilom√®tres de singes qui aiment agiter avec un marteau et bloquer les r√©seaux de taille / 16 √† la fois. Et tourner sur ce petit VPS √©tait une merveilleuse cr√©ation de coll√®gues de NIC.CZ appel√©s BIRD. L'oiseau de la premi√®re version est constamment mort dans la panique de l'activit√© des singes avec des matraques, qui ont interdit pr√®s de 4% d'Internet au sommet de leur activit√©, laissant une profonde r√©flexion lors de la reconfiguration, il a donc √©t√© mis √† jour vers la version 2.0.7. Si les lecteurs sont int√©ress√©s, je publierai un article sur la transition de BIRD √† BIRD2, dans lequel le format de configuration a radicalement chang√©,mais la nouvelle version est devenue beaucoup plus rapide et il n'y a aucun probl√®me avec la reconfig avec un grand nombre de routes. Et puisque nous utilisons le protocole de routage dynamique, il doit y avoir une interface r√©seau √† travers laquelle vous devez acheminer le trafic. Par d√©faut, IPSec ne cr√©e pas d'interfaces, mais en raison de sa flexibilit√©, nous pouvons utiliser les tunnels GRE classiques, que nous prot√©gerons √† l'avenir. En prime, les h√¥tes ipsecgw.example.com et rkn.example.com s'authentifieront mutuellement √† l'aide de certificats auto-renouvelables Lets Encrypt. Pas de PSK, seulement des certificats, seulement du hardcore, il n'y a pas beaucoup de s√©curit√©.Par d√©faut, IPSec ne cr√©e pas d'interfaces, mais en raison de sa flexibilit√©, nous pouvons utiliser les tunnels GRE classiques, que nous prot√©gerons √† l'avenir. En prime, les h√¥tes ipsecgw.example.com et rkn.example.com s'authentifieront mutuellement √† l'aide de certificats auto-renouvelables Lets Encrypt. Pas de PSK, seulement des certificats, seulement du hardcore, il n'y a pas beaucoup de s√©curit√©.Par d√©faut, IPSec ne cr√©e pas d'interfaces, mais en raison de sa flexibilit√©, nous pouvons utiliser les tunnels GRE classiques, que nous prot√©gerons √† l'avenir. En prime, les h√¥tes ipsecgw.example.com et rkn.example.com s'authentifieront mutuellement √† l'aide de certificats auto-renouvelables Lets Encrypt. Pas de PSK, seulement des certificats, seulement du hardcore, il n'y a pas beaucoup de s√©curit√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pensons que le VPS est pr√™t, Strongswan et Certbot sont d√©j√† install√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur l'h√¥te ipsecgw.example.com (son IP est 1.1.1.1), nous d√©crivons la nouvelle interface gif0:</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mis en miroir sur l'h√¥te vps.example.com (son IP est 5.5.5.5):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous augmentons les interfaces, mais comme iptables n'a pas de r√®gle qui autorise le protocole GRE, le trafic ne passera pas (ce dont nous avons besoin, car il n'y a pas de protection √† l'int√©rieur du GRE contre les fans de tout type de ¬´packages¬ª l√©gislatifs).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuisson VPS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous obtenons un autre certificat pour le nom de domaine rkn.example.com. </font><font style="vertical-align: inherit;">Cr√©ez des liens symboliques dans /etc/strongswan/ipsec.d comme d√©crit dans la section pr√©c√©dente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez ipsec.secrets en y ajoutant une seule ligne:</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√¥t√© h√¥te, ipsecgw.example.com est √©galement ajout√© √† ipsec.conf dans la section de configuration du param√®tre strictcrlpolicy = yes, qui inclut une v√©rification stricte de la liste de r√©vocation de certificats. </font><font style="vertical-align: inherit;">Et d√©crivez une autre connexion:</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les configurations sont presque refl√©t√©es. </font><font style="vertical-align: inherit;">Le lecteur attentif pouvait d√©j√† pr√™ter attention √† quelques points:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left / rightsubnet =% dynamic - demande √† Strongswan d'appliquer des politiques √† tous les types de trafic entre pairs</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas de configurer le pare-feu et de renouveler automatiquement les certificats. </font><font style="vertical-align: inherit;">Apr√®s avoir red√©marr√© Strongswan sur les deux serveurs, commencez √† envoyer une requ√™te ping de l'autre c√¥t√© du tunnel GRE et voyez une connexion r√©ussie. </font><font style="vertical-align: inherit;">Sur VPS (rkn):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et du c√¥t√© h√¥te ipsecgw </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sous le spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le tunnel est install√©, les pings vont, dans tcpdump, il est visible que seul ESP passe entre les h√¥tes. </font><font style="vertical-align: inherit;">Il semblerait possible de se r√©jouir. </font><font style="vertical-align: inherit;">Mais vous ne pouvez pas vous d√©tendre sans tout v√©rifier jusqu'au bout. </font><font style="vertical-align: inherit;">Nous essayons de r√©√©mettre le certificat pour VPS et ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chef, tout est cass√©</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous commen√ßons √† comprendre et √† tomber sur une caract√©ristique d√©sagr√©able de Let's Encrypt, qui est belle dans tout le reste - avec toute r√©√©mission du certificat, la cl√© priv√©e qui lui est associ√©e change √©galement. La cl√© priv√©e a chang√© - et le public a chang√©. √Ä premi√®re vue, la situation est d√©sesp√©r√©e pour nous: m√™me si nous pouvons facilement extraire la cl√© publique lors de la r√©√©mission du certificat √† l'aide du hook dans certbot et la transmettre au c√¥t√© distant via SSH, il n'est pas clair comment faire relire Strongswan √† distance. Mais l'aide est venue de l√† o√π ils n'ont pas attendu - systemd peut surveiller les modifications du syst√®me de fichiers et ex√©cuter les services associ√©s √† l'√©v√©nement. C'est ce que nous allons utiliser.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons cr√©er un utilisateur du service Keywatcher sur chacun des h√¥tes avec les droits les plus restreints, g√©n√©rer des cl√©s SSH pour chacun d'eux et les √©changer entre les h√¥tes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur l'h√¥te ipsecgw.example.com, cr√©ez le r√©pertoire / opt / ipsec-pubkey dans lequel nous pla√ßons 2 scripts.</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur VPS (l'h√¥te rkn.example.com), nous cr√©ons √©galement un r√©pertoire du m√™me nom, dans lequel nous cr√©ons √©galement des scripts similaires, en ne changeant que le nom de la cl√©. </font><font style="vertical-align: inherit;">Code, afin de ne pas encombrer l'article, sous</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">divulgacher</font></font></b>
                        <div class="spoiler_text">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le script pubkey-copy.sh est n√©cessaire pour extraire la partie publique de la cl√© et la copier sur l'h√¥te distant lors de l'√©mission d'un nouveau certificat. </font><font style="vertical-align: inherit;">Pour ce faire, dans le r√©pertoire / etc / letsencrypt / renouvellement-hooks / deploy sur les deux serveurs, cr√©ez un autre microscript:</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La moiti√© du probl√®me est r√©solu, les certificats sont r√©√©mis, les cl√©s publiques sont extraites et copi√©es entre les serveurs, et le moment est venu pour systemd avec ses unit√©s de chemin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le serveur ipsecgw.example.com dans le r√©pertoire / etc / systemd / system, cr√©ez le fichier keyupdater.path</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De m√™me sur l'h√¥te VPS:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et enfin, sur chaque serveur, nous cr√©ons un service associ√© √† cette unit√©, qui sera lanc√© lorsque la condition (PathChanged) sera remplie - changer le fichier et le fermer apr√®s l'enregistrement. </font><font style="vertical-align: inherit;">Nous cr√©ons les fichiers /etc/systemd/system/keyupdater.service et √©crivons:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas de relire les configurations systemd avec sudo systemctl daemon-reload et d'affecter le d√©marrage automatique aux unit√©s de chemin via sudo systemctl enable keyupdater.path &amp;&amp; sudo systemctl start keyupdater. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√®s que l'h√¥te distant √©crit le fichier contenant la cl√© publique dans le r√©pertoire de base de l'utilisateur du keywatcher et que le descripteur de fichier est ferm√©, systemd d√©marrera automatiquement le service correspondant, qui copiera la cl√© √† l'emplacement souhait√© et red√©marrera Strongswan. </font><font style="vertical-align: inherit;">Le tunnel sera install√© √† l'aide de la bonne cl√© publique du deuxi√®me c√¥t√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez expirer et profiter du r√©sultat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au lieu d'une conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous venons de </font><font style="vertical-align: inherit;">voir l' </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enfer</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec n'est pas aussi effrayant que cela est peint. </font><font style="vertical-align: inherit;">Tout ce qui a √©t√© d√©crit est une configuration enti√®rement op√©rationnelle actuellement utilis√©e. </font><font style="vertical-align: inherit;">M√™me sans beaucoup de connaissances, vous pouvez configurer un VPN et prot√©ger de mani√®re fiable vos donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien s√ªr, les moments de configuration d'iptables sont rest√©s en dehors de la port√©e de l'article, mais l'article lui-m√™me s'est av√©r√© d√©j√† volumineux, et beaucoup a √©t√© √©crit sur iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a des points dans l'article qui peuvent √™tre am√©lior√©s, que ce soit le refus de red√©marrer le d√©mon Strongswan, la relecture de ses configurations et certificats, mais je n'ai pas pu y parvenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, les red√©marrages du d√©mon n'√©taient pas effrayants: un ou deux pings entre pairs sont perdus, les clients mobiles r√©tablissent eux-m√™mes la connexion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re que mes coll√®gues dans les commentaires proposeront la bonne solution.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504464/index.html">Comment nous avons con√ßu le TableAdapter et simplifi√© le travail avec UITableView</a></li>
<li><a href="../fr504468/index.html">Performances du Raspberry Pi: ajoutez ZRAM et modifiez les param√®tres du noyau</a></li>
<li><a href="../fr504472/index.html">Mes meilleurs outils de d√©veloppement gratuits</a></li>
<li><a href="../fr504480/index.html">Comment trouver un marketeur avec qui il sera rentable de travailler?</a></li>
<li><a href="../fr504482/index.html">Demandez-nous: DIT r√©pondra aux questions</a></li>
<li><a href="../fr504486/index.html">Processus: cr√©ation de Vue 3</a></li>
<li><a href="../fr504488/index.html">Quelles industries et technologies commenceront √† se d√©velopper rapidement apr√®s avoir r√©solu le probl√®me de COVID-19</a></li>
<li><a href="../fr504490/index.html">R√©sum√© des √©v√©nements en ligne de juin</a></li>
<li><a href="../fr504492/index.html">Appuyez sur le bouton: th√©orie et pratique du vote √©lectronique - table ronde le 30 mai</a></li>
<li><a href="../fr504502/index.html">La vie courte et √©trange du premier robot amical au monde</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>