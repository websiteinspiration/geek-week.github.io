<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔠 👩🏼‍🚒 🧑🏾 Script personnalisé lors de la fermeture du couvercle de l'ordinateur portable et du verrouillage de l'écran sans sommeil 🔱 ✊🏼 👩🏾‍🤝‍👩🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous. J'utilise Lubuntu 18.04 sur mon ordinateur portable domestique. Un beau jour, j'ai décidé que je n'étais pas satisfait des actions que...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Script personnalisé lors de la fermeture du couvercle de l'ordinateur portable et du verrouillage de l'écran sans sommeil</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491486/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour à tous. </font><font style="vertical-align: inherit;">J'utilise Lubuntu 18.04 sur mon ordinateur portable domestique. </font><font style="vertical-align: inherit;">Un beau jour, j'ai décidé que je n'étais pas satisfait des actions que Power Manager propose lors de la fermeture du couvercle d'un ordinateur portable. </font><font style="vertical-align: inherit;">Lorsque j'ai fermé le capot de l'ordinateur portable, j'ai voulu verrouiller l'écran et, après un certain temps, envoyer l'ordinateur portable en hibernation. </font><font style="vertical-align: inherit;">Pour ce faire, j'ai écrit un script et je m'empresse de le partager avec vous.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai rencontré deux problèmes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première est que l'hibernation ne fonctionne pas dans le loubunt hors de la boîte; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trouvez le swap UUID, pour cela, vous devez faire:</font></font><br>
<br>
<pre><code class="bash hljs">grep swap /etc/fstab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon cas, la sortie est la suivante:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># swap was on /dev/mmcblk0p2 during installation</span><font></font>
UUID=aebf757e-14c0-410a-b042-3d9a6044a987 none            swap    sw              0       0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez ajouter l'UUID aux paramètres d'initialisation du noyau. </font><font style="vertical-align: inherit;">Pour ce faire, ajoutez le fichier / etc / default / grub à la ligne "GRUB_CMDLINE_LINUX_DEFAULT" resume = UUID =% votre UUID%</font></font><br>
<br>
<pre><code class="bash hljs">...<font></font>
GRUB_CMDLINE_LINUX_DEFAULT=<span class="hljs-string">"quiet splash resume=UUID=aebf757e-14c0-410a-b042-3d9a6044a987"</span>
...</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et exécutez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">sudo update-grub</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, l'hibernation devrait fonctionner, pour la vérification, vous pouvez faire:</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl hibernate</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxième problème était de savoir comment verrouiller l'écran de l'utilisateur à partir de root sans envoyer l'ordinateur portable en veille. </font><font style="vertical-align: inherit;">Je l'ai résolu en utilisant dbus-send, la commande elle-même est dans le script ci-dessous. </font><font style="vertical-align: inherit;">Si quelqu'un connaît d'autres options, veuillez écrire dans les commentaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons maintenant à écrire le script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première chose que nous devons faire dans Power Manager est de sélectionner Désactiver l'affichage comme action lors de la fermeture du couvercle afin qu'il n'y ait aucun conflit avec notre script. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ve/vx/3i/vevx3ieyswyr8g0h80rpz5lxpuy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez ensuite le fichier / etc / acpi / events / laptop-lid avec le contenu suivant:</font></font><br>
<br>
<pre><code class="plaintext hljs">event=button/lid.*<font></font>
action=/etc/acpi/laptop-lid.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et créez le script /etc/acpi/laptop-lid.sh avec le contenu suivant:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#set variables</span>
<span class="hljs-comment"># BUS   environ   lxsession</span><font></font>
BUS=$(grep -z DBUS_SESSION_BUS_ADDRESS \<font></font>
	/proc/$(pidof -s lxsession)/environ | \<font></font>
	sed <span class="hljs-string">'s/DBUS_SESSION_BUS_ADDRESS=//g'</span>)
<span class="hljs-comment">#     ,    </span>
USER=$(grep -z USER /proc/$(pidof -s lxsession)/environ | sed <span class="hljs-string">'s/USER=//g'</span>)
<span class="hljs-comment">#     </span>
LID=<span class="hljs-string">"/proc/acpi/button/lid/LID0/state"</span><font></font>
<font></font>
<span class="hljs-comment">#Check lid state (return 0 if closed)</span>
<span class="hljs-function"><span class="hljs-title">check_lid</span></span> () {<font></font>
	grep -q closed <span class="hljs-variable">$LID</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">#Lock screen without sleep</span><font></font>
check_lid<font></font>
<span class="hljs-keyword">if</span> [ $? = 0 ]
<span class="hljs-keyword">then</span>
	<span class="hljs-comment">#TODO run command as root</span>
	sudo -u <span class="hljs-variable">$USER</span> -E dbus-send --bus=<span class="hljs-variable">$BUS</span> \<font></font>
				    --<span class="hljs-built_in">type</span>=method_call \<font></font>
				    --dest=<span class="hljs-string">"org.freedesktop.ScreenSaver"</span> \
				    <span class="hljs-string">"/org/freedesktop/ScreenSaver"</span> \<font></font>
				    org.freedesktop.ScreenSaver.Lock<font></font>
<span class="hljs-keyword">fi</span><font></font>
<font></font>
<span class="hljs-comment">#Wait 10 minutes and hibernate if lid is closed</span><font></font>
sleep 600<font></font>
check_lid<font></font>
<span class="hljs-keyword">if</span> [ $? = 0 ]
<span class="hljs-keyword">then</span><font></font>
	systemctl hibernate<font></font>
<span class="hljs-keyword">fi</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous rendons le script exécutable:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod a+x /etc/acpi/laptop-lid.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et redémarrez le démon acpid pour que les modifications s'appliquent:</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl restart acpid.service</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est prêt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour Gnome dans le script, vous devez changer:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lxsessin =&gt; gnome-session </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">org.freedesktop.ScreenSaver =&gt; org.gnome.ScreenSaver </font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491476/index.html">Accéléromètres, magnétomètres et angles d'orientation MEMS</a></li>
<li><a href="../fr491478/index.html">Un nouvel implant pour les aveugles se connecte directement au cerveau</a></li>
<li><a href="../fr491480/index.html">Projet CoVirus MVP - une carte en ligne de l'infection à coronavirus ou un «bouton rouge» dans votre main</a></li>
<li><a href="../fr491482/index.html">Présentation de PowerShell 7.0</a></li>
<li><a href="../fr491484/index.html">Stas Afanasyev. Juno. Pipelines basés sur io.Reader / io.Writer. Partie 1</a></li>
<li><a href="../fr491488/index.html">Que signifie être agile?</a></li>
<li><a href="../fr491490/index.html">Comment Gitlab-CI hérite-t-il des variables d'environnement?</a></li>
<li><a href="../fr491494/index.html">L'arnaque grandiose de la science soviétique: pourquoi un vaisseau orbital réutilisable s'est avéré être une fois</a></li>
<li><a href="../fr491496/index.html">Conseils et astuces IntelliJ IDEA: 1. Comparaison de fichiers et de dossiers</a></li>
<li><a href="../fr491510/index.html">Créez votre image avec Pure CentOS 8.1 dans le cloud Amazon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>