<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõåüèø üìì ‚≠êÔ∏è ¬øC√≥mo implementar una refactorizaci√≥n peligrosa para pinchar con un mill√≥n de usuarios? ü§∑üèø üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø üôèüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La pel√≠cula "Avi√≥n", 1980. 
 
 As√≠ es como me sent√≠ cuando vert√≠ otra refactorizaci√≥n en el producto. Incluso si cubre todo el c√≥digo con m√©tricas y r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>¬øC√≥mo implementar una refactorizaci√≥n peligrosa para pinchar con un mill√≥n de usuarios?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/manychat/blog/499034/"><img src="https://habrastorage.org/webt/xi/ny/b7/xinyb7sar_jz5ueywnjobp8rfrs.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La pel√≠cula "Avi√≥n", 1980. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como me sent√≠ cuando vert√≠ otra refactorizaci√≥n en el producto. </font><font style="vertical-align: inherit;">Incluso si cubre todo el c√≥digo con m√©tricas y registros, pruebe la funcionalidad en todos los entornos; esto no ahorrar√° el 100% de los fakaps despu√©s de la implementaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primer fakap</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De alguna manera reestructuramos nuestro procesamiento de integraci√≥n con Google Sheets. Para los usuarios, esta es una caracter√≠stica muy valiosa, porque usan muchas herramientas al mismo tiempo que deben vincularse entre s√≠: enviar contactos a una tabla, cargar respuestas a preguntas, exportar usuarios, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo de integraci√≥n no refactoriz√≥ desde la primera versi√≥n y se hizo cada vez m√°s dif√≠cil de mantener. Esto comenz√≥ a afectar a nuestros usuarios: se revelaron errores antiguos que ten√≠amos miedo de editar debido a la complejidad del c√≥digo. Es hora de hacer algo al respecto. No se supon√≠an cambios l√≥gicos: simplemente escriba pruebas, mueva clases y peine nombres. Por supuesto, probamos la funcionalidad en el entorno de desarrollo y fuimos a implementar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de 20 minutos, los usuarios escribieron que la integraci√≥n no funcion√≥. </font><font style="vertical-align: inherit;">La funcionalidad de enviar datos a Google Sheet se cay√≥; result√≥ que para la depuraci√≥n enviamos datos en diferentes formatos para ventas y entornos locales. </font><font style="vertical-align: inherit;">Al refactorizar, llegamos al formato de venta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arreglamos la integraci√≥n, pero sin embargo, el sedimento del feliz viernes por la noche (¬°y usted pens√≥!) Permaneci√≥. </font><font style="vertical-align: inherit;">En retrospectiva (reuni√©ndonos con el equipo para completar el sprint), comenzamos a pensar en c√≥mo prevenir tales situaciones en el futuro: necesitamos mejorar la pr√°ctica de las pruebas manuales, las pruebas autom√°ticas, trabajar con m√©tricas y alarmas, y adem√°s de esto, tuvimos la idea de usar banderas de caracter√≠sticas para probar la refactorizaci√≥n en Prode, de hecho, esto ser√° discutido.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El esquema es simple: si el usuario tiene habilitada la bandera, vaya al c√≥digo con la nueva versi√≥n, si no, al c√≥digo con la versi√≥n anterior:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span> ($user-&gt;hasFeature(UserFeatures::FEATURE_1)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con este enfoque, tenemos la oportunidad de probar la refactorizaci√≥n en prod primero en nosotros mismos y luego verterla en los usuarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Casi desde el comienzo del proyecto, tuvimos una implementaci√≥n primitiva de la funci√≥n de banderas. </font><font style="vertical-align: inherit;">En la base de datos para dos entidades b√°sicas, usuario y cuenta, se agregaron campos de caracter√≠sticas, que eran una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√°scara de bits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En el c√≥digo, registramos nuevas constantes para las funciones, que luego agregamos a la m√°scara si una funci√≥n espec√≠fica est√° disponible para el usuario.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_1 = <span class="hljs-number">0b0000001</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_2 = <span class="hljs-number">0b0000010</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_3 = <span class="hljs-number">0b0000100</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El uso en el c√≥digo se ve√≠a as√≠:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_FEATURE_1)) {
  <span class="hljs-comment">// feature 1 logic</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al refactorizar, generalmente abrimos primero la bandera para que el equipo la pruebe, luego a varios usuarios que usan activamente la funci√≥n y finalmente se abren a todos, pero a veces aparecen esquemas m√°s complejos, m√°s sobre ellos a continuaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactorizaci√≥n de lugares sobrecargados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno de nuestros sistemas acepta webhooks de Facebook y los procesa a trav√©s de la cola. El procesamiento de la cola dej√≥ de funcionar y los usuarios comenzaron a recibir ciertos mensajes con retraso, lo que podr√≠a afectar de manera cr√≠tica la experiencia de los suscriptores de bot. Comenzamos a refactorizar este lugar transfiriendo el procesamiento a un esquema de cola m√°s complejo. El lugar es cr√≠tico: es peligroso verter una nueva l√≥gica en todos los servidores, por lo que cerramos la nueva l√≥gica bajo la bandera y pudimos probarla en el producto. ¬øPero qu√© sucede cuando abrimos esta bandera? ¬øC√≥mo se comportar√° nuestra infraestructura? Esta vez desplegamos la apertura de la bandera en los servidores y seguimos las m√©tricas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo el procesamiento de datos cr√≠ticos lo hemos dividido en grupos. </font><font style="vertical-align: inherit;">Cada grupo tiene una identificaci√≥n. </font><font style="vertical-align: inherit;">Decidimos simplificar las pruebas de una refactorizaci√≥n tan compleja abriendo la funci√≥n de marca solo en ciertos servidores, la verificaci√≥n en el c√≥digo se ve as√≠:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::CGT_REFACTORING) ||<font></font>
    \in_array($cluster, Configurator::get(<span class="hljs-string">'cgt_refactoring_cluster_ids'</span>))) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, vertimos refactorizaci√≥n y abrimos las banderas al equipo. </font><font style="vertical-align: inherit;">Luego encontramos varios usuarios que utilizaron activamente la funci√≥n cgt, les abrieron banderas y observaron si todo funcionaba para ellos. </font><font style="vertical-align: inherit;">Y finalmente, comenzaron a abrir banderas en los servidores y seguir las m√©tricas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El indicador cgt_refactoring_cluster_ids se puede cambiar a trav√©s del panel de administraci√≥n. </font><font style="vertical-align: inherit;">Inicialmente, asignamos el valor cgt_refactoring_cluster_ids a una matriz vac√≠a, luego agregamos un cl√∫ster a la vez - [1], observamos las m√©tricas por un tiempo y agregamos otro cl√∫ster - [1, 2] hasta que probamos todo el sistema.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n del configurador</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hablar√© un poco sobre qu√© es Configurator y c√≥mo se implementa. </font><font style="vertical-align: inherit;">Fue escrito para poder cambiar la l√≥gica sin despliegue, por ejemplo, como en el caso anterior, cuando necesitamos retroceder bruscamente la l√≥gica. </font><font style="vertical-align: inherit;">Tambi√©n lo usamos para configuraciones din√°micas, por ejemplo, cuando necesita probar diferentes tiempos de almacenamiento en cach√©, puede sacarlo para realizar pruebas r√°pidas. </font><font style="vertical-align: inherit;">Para el desarrollador, esto parece una lista de campos con valores de administrador que se pueden cambiar. </font><font style="vertical-align: inherit;">Almacenamos todo esto en una base de datos, almacenamos en cach√© en Redis y en una estad√≠stica para nuestros trabajadores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactorizando ubicaciones desactualizadas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el pr√≥ximo trimestre, reestructuramos la l√≥gica de registro, prepar√°ndolo para la transici√≥n a la posibilidad de registro a trav√©s de varios servicios. </font><font style="vertical-align: inherit;">En nuestras condiciones, es imposible agrupar la l√≥gica de registro para que cierto usuario est√© vinculado a una l√≥gica determinada, y no se nos ocurri√≥ nada mejor que probar la l√≥gica, desplegando un porcentaje de todas las solicitudes de registro. </font><font style="vertical-align: inherit;">Esto es f√°cil de hacer de manera similar con banderas:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> (Configurator::get(<span class="hljs-string">'auth_refactoring_percentage'</span>) &gt; \random_int(<span class="hljs-number">0</span>, <span class="hljs-number">99</span>)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consecuencia, establecemos el valor de auth_refactoring_percentage en el panel de administraci√≥n de 0 a 100. Por supuesto, "untamos" toda la l√≥gica de autorizaci√≥n con m√©tricas para comprender que al final no redujimos la conversi√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©trica</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para saber c√≥mo seguimos las m√©tricas en el proceso de abrir banderas, consideraremos otro caso con m√°s detalle. </font><font style="vertical-align: inherit;">ManyChat acepta enlaces de Facebook de Facebook cuando un suscriptor env√≠a un mensaje a Facebook Messenger. </font><font style="vertical-align: inherit;">Debemos procesar cada mensaje de acuerdo con la l√≥gica empresarial. </font><font style="vertical-align: inherit;">Para la funci√≥n cgt, debemos determinar si el suscriptor inici√≥ la conversaci√≥n a trav√©s de un comentario en Facebook para enviarle un mensaje relevante en respuesta. </font><font style="vertical-align: inherit;">En el c√≥digo, parece determinar el contexto del suscriptor actual, si podemos determinar el widgetId, entonces determinamos el mensaje de respuesta a partir de √©l.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°s acerca de la funci√≥n</font></font></b>
                        <div class="spoiler_text"> Facebook                api.      ‚Äî    .        Widget,   :<br>
<br>
  ‚Äî&gt;     ‚Äî&gt;     ‚Äî&gt;         Facebook:<br>
<br>
<img src="https://habrastorage.org/webt/a7/n8/jx/a7n8jxdxulwxquozeje_kzabv_y.gif"><br>
<br>
     : <br>
  ‚Äî&gt;    ‚Äî&gt;  <br>
<br>
<img src="https://habrastorage.org/webt/y0/i7/1l/y0i71lh-zttfdvcs3n1bny56w8e.gif"><br>
<br>
     ‚Äú , !‚Äù   ,        .   ,     ‚Äú  !‚Äù   id       ,     ‚Äî   ,     id.<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, definimos el contexto de 3 maneras, se parec√≠a a esto:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;gt_widget_id_context) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_context'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $user-&gt;gt_widget_id_context;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;name) {<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByThread($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_thread'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByConversation($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_conversation'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El servicio de vigilancia env√≠a an√°lisis en el momento de la coincidencia, respectivamente, ten√≠amos m√©tricas para los tres casos: la </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bh/x5/gy/bhx5gygff9kthgcyd_zcri1fkyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cantidad de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> veces que el </font><i><font style="vertical-align: inherit;">contexto fue encontrado por diferentes m√©todos de vinculaci√≥n en el tiempo.</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Luego, encontramos otro m√©todo de coincidencia que deber√≠a reemplazar todas las opciones anteriores. </font><font style="vertical-align: inherit;">Para probar esto, tenemos otra m√©trica:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_echo_message'</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-comment">// ...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta etapa, queremos asegurarnos de que el n√∫mero de nuevos aciertos sea igual a la suma de los viejos aciertos, as√≠ que solo escriba la m√©trica sin devolver $ widgetId: el </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/kw/wp/wakwwppphodtzn7huuj_vhajdb4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√∫mero de contextos encontrados por el nuevo m√©todo cubre completamente la suma de enlaces por los m√©todos antiguos</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pero esto no nos garantiza la l√≥gica de coincidencia correcta en todos los casos. </font><font style="vertical-align: inherit;">El siguiente paso es la prueba gradual a trav√©s de la apertura de banderas:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-comment">//    ,   </span>
    <span class="hljs-keyword">If</span> (<span class="hljs-keyword">$this</span>-&gt;allowMatchingByEcho($user)) {
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allowMatchingByEcho</span>(<span class="hljs-params">User $user</span>): <span class="hljs-title">bool</span>
</span>{
  <span class="hljs-comment">//    </span>
  <span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_CGT_MATCHING_BY_ECHO)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-keyword">If</span> (\in_array(<span class="hljs-keyword">$this</span>-&gt;clusterId, Configurator::get(<span class="hljs-string">'cgt_matching_by_echo_cluster_ids'</span>))) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego comenz√≥ el proceso de prueba: al principio probamos la nueva funcionalidad por nuestra cuenta en todos los entornos y en usuarios aleatorios que a menudo usan la coincidencia abriendo la bandera UserFeatures :: ALLOW_CGT_MATCHING_BY_ECHO. </font><font style="vertical-align: inherit;">En esta etapa, detectamos algunos casos en los que el partido funcion√≥ incorrectamente y los reparamos. </font><font style="vertical-align: inherit;">Luego comenzaron a implementarse en los servidores: en promedio, implementamos un servidor en 1 d√≠a durante la semana. </font><font style="vertical-align: inherit;">Antes de realizar la prueba, advertimos al soporte t√©cnico que analicen detenidamente los tickets relacionados con la funcionalidad y nos escriban sobre cualquier rareza. </font><font style="vertical-align: inherit;">Gracias al soporte y los usuarios, se corrigieron varios casos de esquina. </font><font style="vertical-align: inherit;">Y finalmente, el √∫ltimo paso es el descubrimiento de todo incondicionalmente:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{<font></font>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-keyword">return</span> $widgetId;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nueva implementaci√≥n de la funci√≥n de bandera</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La implementaci√≥n de la funci√≥n de bandera descrita al comienzo del art√≠culo nos sirvi√≥ durante aproximadamente 3 a√±os, pero con el crecimiento de los equipos se volvi√≥ inc√≥modo: tuvimos que implementar al crear cada bandera y no olvidar borrar el valor de las banderas (reutilizamos valores constantes para diferentes funciones). </font><font style="vertical-align: inherit;">Recientemente, el componente ha sido reescrito y ahora podemos administrar de manera flexible las banderas a trav√©s del panel de administraci√≥n. </font><font style="vertical-align: inherit;">Las banderas se desataron de la m√°scara de bits y se almacenaron en una tabla separada; esto facilita la creaci√≥n de nuevas banderas. </font><font style="vertical-align: inherit;">Cada entrada tambi√©n tiene una descripci√≥n y un propietario, la gesti√≥n de la bandera se ha vuelto m√°s transparente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contras de tales enfoques</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este enfoque tiene un gran inconveniente: hay dos versiones del c√≥digo y deben ser compatibles al mismo tiempo. </font><font style="vertical-align: inherit;">Al realizar la prueba, debe tener en cuenta que hay dos ramas de la l√≥gica, y debe verificarlas todas, y esto es muy doloroso. </font><font style="vertical-align: inherit;">Durante el desarrollo, hubo situaciones en las que introdujimos una soluci√≥n en una l√≥gica, pero nos olvidamos de otra, y en alg√∫n momento se dispar√≥. </font><font style="vertical-align: inherit;">Por lo tanto, aplicamos este enfoque solo en lugares cr√≠ticos y tratamos de deshacernos de la versi√≥n anterior del c√≥digo lo m√°s r√°pido posible. </font><font style="vertical-align: inherit;">Intentamos hacer el resto de la refactorizaci√≥n en peque√±as iteraciones.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El proceso actual se ve as√≠: primero cerramos la l√≥gica bajo la condici√≥n de las banderas, luego implementamos y comenzamos a abrir gradualmente las banderas. Al expandir las banderas, monitoreamos de cerca los errores y las m√©tricas, tan pronto como algo sale mal, inmediatamente retroceda la bandera y solucione el problema. La ventaja es que abrir / cerrar la bandera es muy r√°pido, es solo un cambio en el valor en el panel de administraci√≥n. Despu√©s de un tiempo, eliminamos la versi√≥n anterior del c√≥digo, este deber√≠a ser el tiempo m√≠nimo para evitar cambios en ambas versiones del c√≥digo. Es importante advertir a los colegas sobre tal refactorizaci√≥n. Hacemos una revisi√≥n a trav√©s de github y usamos los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propietarios del c√≥digo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durante dicha refactorizaci√≥n para que los cambios no entren en el c√≥digo sin el conocimiento del autor de la refactorizaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√°s recientemente, lanc√© una nueva versi√≥n de Facebook Graph API. </font><font style="vertical-align: inherit;">En un segundo, hacemos m√°s de 3000 solicitudes a la API y cualquier error es costoso para nosotros. </font><font style="vertical-align: inherit;">Por lo tanto, implement√© el cambio bajo la bandera con un impacto m√≠nimo: result√≥ detectar un error desagradable, probar la nueva versi√≥n y eventualmente cambiarlo por completo sin preocupaciones.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es499016/index.html">Integraci√≥n con ESIA para .Net: m√°s f√°cil de lo que parece</a></li>
<li><a href="../es499018/index.html">6 aplicaciones de deportes en casa</a></li>
<li><a href="../es499020/index.html">Un estudio de un comportamiento vago.</a></li>
<li><a href="../es499030/index.html">Monitoreo del rendimiento de MySQL para Grafana en isic en 20 minutos</a></li>
<li><a href="../es499032/index.html">C√≥mo usar Prometheus para detectar anomal√≠as en GitLab</a></li>
<li><a href="../es499036/index.html">Trabajo del proveedor: una selecci√≥n de materiales sobre protocolos, TI e infraestructura de red</a></li>
<li><a href="../es499038/index.html">Mi experiencia usando un monitor vertical</a></li>
<li><a href="../es499040/index.html">Lea el fin de semana: una selecci√≥n de materiales sobre la historia del DNS, la regulaci√≥n de TI y el hardware 1cloud.ru</a></li>
<li><a href="../es499044/index.html">Noticias del mundo de OpenStreetMap No. 508 (04/07/2020/13/04/2020)</a></li>
<li><a href="../es499046/index.html">Neuroevoluci√≥n cibercalmar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>