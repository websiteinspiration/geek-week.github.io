<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïí ‚ÜîÔ∏è üå∂Ô∏è Macros pour un pythoniste. Rapport Yandex üßöüèø üíÉüèΩ ‚òùÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comment puis-je √©tendre la syntaxe Python et y ajouter les fonctionnalit√©s n√©cessaires? L'√©t√© dernier √† PyCon, j'ai essay√© de comprendre ce sujet. √Ä p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Macros pour un pythoniste. Rapport Yandex</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/495294/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment puis-je √©tendre la syntaxe Python et y ajouter les fonctionnalit√©s n√©cessaires? </font><font style="vertical-align: inherit;">L'√©t√© dernier √† PyCon, j'ai essay√© de comprendre ce sujet. </font><font style="vertical-align: inherit;">√Ä partir du rapport, vous pouvez d√©couvrir comment les biblioth√®ques de pytest, de macropie et de mod√®les sont organis√©es et comment elles permettent d'obtenir des r√©sultats aussi int√©ressants. </font><font style="vertical-align: inherit;">√Ä la fin, il y a un exemple de g√©n√©ration de code √† l'aide de macros dans HyLang, un langage de type Lisp fonctionnant au-dessus de Python.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/IMkvg45Vw70" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Salut les gars. </font><font style="vertical-align: inherit;">Tout d'abord, je tiens √† remercier les organisateurs de PyCon. </font><font style="vertical-align: inherit;">Je suis d√©veloppeur chez Yandex. </font><font style="vertical-align: inherit;">Le rapport ne portera pas du tout sur le travail, mais sur des choses exp√©rimentales. </font><font style="vertical-align: inherit;">Peut-√™tre qu'ils conduiront l'un d'entre vous √† l'id√©e qu'en Python, vous pouvez faire des choses cool que vous ne connaissiez m√™me pas auparavant, ne pensiez pas dans cette direction.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un peu pour ceux qui ne savent pas ce que sont les macros: c'est un tel moyen de g√©n√©ration de code quand une expression du langage est d√©velopp√©e en code plus complexe. </font><font style="vertical-align: inherit;">Quels sont les goodies pour vous? </font><font style="vertical-align: inherit;">Pour vous, l'enregistrement de macro est concis, il exprime une certaine abstraction, mais il fait beaucoup de travail sous le capot pour vous, et vous n'avez pas besoin d'√©crire tout ce code avec vos mains.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pytest</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tr√®s probablement, vous √™tes tomb√© sur un cadre de test pytest, beaucoup ici l'utilisent presque certainement. Je ne sais pas si vous l'avez d√©j√† remarqu√©, mais sous le capot, il fait aussi de la magie. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/al/o6/qv/alo6qvpzofmabtejvqqojenx31a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, vous avez un test aussi simple. Si vous l'ex√©cutez sans pytest, il lancera simplement une AssertionError. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ih/an/ck/ihanckzzqzelb5o87nfx9olt2vw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, mon exemple est un peu d√©g√©n√©r√©, et ici, il est imm√©diatement √©vident que len est tir√© d'une liste de trois √©l√©ments. Mais si une fonction √©tait appel√©e, vous n'auriez jamais su d'une telle AssertionError que la fonction √©tait retourn√©e. Elle a rendu juste quelque chose qui n'est pas √©gal √† cent. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/ko/sa/cukosarqifegg5uvzo14xneczkc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, si cela est ex√©cut√© sous pytest, il affichera des informations de d√©bogage suppl√©mentaires. Comment fait-il √† l'int√©rieur?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6h/g9/vr/6hg9vr5nedvvkvzxlsupjqor71a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette magie fonctionne tr√®s simplement. Pytest cr√©e son propre crochet sp√©cial qui se d√©clenche lorsque le module avec le test se charge. Apr√®s cela, pytest analyse ind√©pendamment ce fichier Python, et √† la suite de l'analyse, sa repr√©sentation interm√©diaire est obtenue, qui est appel√©e l'arbre AST. L'arbre AST est un concept de base qui vous permet de modifier le code Python √† la vol√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir re√ßu un tel arbre, pytest lui impose une transformation qui recherche toutes les expressions appel√©es assert. Il les modifie d'une certaine mani√®re, il compile la nouvelle arborescence AST r√©sultante, et il obtient un module avec des tests, qui s'ex√©cute ensuite sur une machine virtuelle Python r√©guli√®re.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t3/fj/x-/t3fjx-trld3abinbaqxioiizptg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemble l'arbre AST d'origine non converti en pytest. </font><font style="vertical-align: inherit;">La zone rouge en surbrillance est notre assertion. </font><font style="vertical-align: inherit;">Si vous regardez attentivement, vous verrez ses parties gauche et droite, la liste elle-m√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque pytest convertit cela et g√©n√®re une nouvelle ann√©e, l'arbre commence √† ressembler √† ceci. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/xh/qb/yvxhqbjsokha_vdwfn9-ksm0isi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une centaine de lignes de code g√©n√©r√©es par pytest pour vous. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/fc/zi/cufczioilng0zfzx05nbrtwgl8g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous reconvertissez cet arbre AST en Python, il ressemblera √† ceci. </font><font style="vertical-align: inherit;">Les zones surlign√©es en rouge ici sont celles o√π pytest calcule les parties gauche et droite de l'expression, g√©n√®re un message d'erreur et d√©clenche une AssertionError en cas de probl√®me avec ce message d'erreur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correspondance de motifs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que pouvez-vous faire d'autre avec une telle chose? Vous pouvez convertir n'importe quel code Python. Et il y a une merveilleuse biblioth√®que que j'ai trouv√©e tout √† fait par accident sur PyPI, c'est int√©ressant d'y creuser. Elle fait la correspondance des motifs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3k/yb/eq/3kybeqrilpfpqnvj4bmeon62ibm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre que ce code est familier √† quelqu'un. Il consid√®re factorielle r√©cursivement. Voyons comment il peut √™tre enregistr√© en utilisant la correspondance de motifs.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/cv/as/xycvassi6jwpp9getvm4sy4bbmm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, accrochez simplement le d√©corateur sur la fonction. Attention: √† l'int√©rieur du corps, la fonction fonctionne d√©j√† diff√©remment. Chacun de ces ifs est une r√®gle pour la correspondance de mod√®le, qui analyse l'expression entr√©e dans la fonction et la transforme en quelque sorte. De plus, il n'y a m√™me pas de retour explicite du r√©sultat. Parce que la biblioth√®que de mod√®les, lorsqu'elle transforme le corps de la fonction, d'une part, elle v√©rifie qu'elle ne contient que si, et d'autre part, elle ajoute des retours implicites du r√©sultat, changeant ainsi la s√©mantique du langage. Autrement dit, elle fait une nouvelle DSL, qui fonctionne un peu diff√©remment. Et gr√¢ce √† cela, vous pouvez √©crire certaines choses de mani√®re d√©clarative. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3k/yb/eq/3kybeqrilpfpqnvj4bmeon62ibm.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction pr√©c√©dente est comme si elle √©tait √©crite sur trois lignes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/cv/as/xycvassi6jwpp9getvm4sy4bbmm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/pj/fm/ux/pjfmuxf4zsl_zpppzidv9oirkim.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le reste des lignes ajoute des fonctionnalit√©s suppl√©mentaires qui permettent, par exemple, de lire factorielle √† partir d'une liste de valeurs ou de la passer par une fonction arbitraire. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment √©crire des conversions vous-m√™me? </font><font style="vertical-align: inherit;">macropie!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant vous vous demandez probablement, mais comment pouvez-vous l'appliquer vous-m√™me? Parce que c'est fastidieux √† faire, comme pytest: analyser manuellement des fichiers, recherchez le code qui doit √™tre converti. Dans pytest, cela se fait par un module s√©par√© pour un millier de lignes ou plus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de ne pas le faire par nous-m√™mes, certains gars intelligents ont d√©j√† cr√©√© un module pour nous appel√© macropy. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette version du module est destin√©e √† la fois au deuxi√®me Python et au troisi√®me. Ils l'ont √©crit √† l'√©poque du deuxi√®me Python. Ensuite, les gars ont fait une blague pour comprendre ce qui peut √™tre fait avec Python, et la biblioth√®que comprend divers exemples. Regardons-les, ils vous donneront une id√©e de ce que vous pouvez faire avec cette technique. La premi√®re chose int√©ressante qu'ils ont d√©crite dans le didacticiel est une macro qui impl√©mente des cha√Ænes de format pour le deuxi√®me Python, comme dans le troisi√®me.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/3h/vv/er3hvvz7g-0edq1spxz5bukrk3q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'expression surlign√©e en rouge n'est que la syntaxe de l'appel de macro. La lettre S est le nom de la macro, puis entre crochets l'expression qu'elle convertit. Par cons√©quent, les variables sont remplac√©es ici. Cela fonctionne dans le deuxi√®me Python, mais le troisi√®me n'est plus n√©cessaire dans une telle macro. Ainsi, par exemple, vous pouvez cr√©er votre propre macro, qui impl√©mente une s√©mantique plus complexe et fait des choses plus amusantes que les cha√Ænes de format standard.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jw/bf/hx/jwbfhxtuxzzrbjd-vvu3rhdsok8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'une macro se d√©veloppe, et cela se produit au moment du chargement du module, elle se convertit simplement en ce code. Des espaces r√©serv√©s sont ins√©r√©s dans la cha√Æne de format et la proc√©dure de substitution lui est appliqu√©e. De plus, Python compile d√©j√† de mani√®re standard tout cela. Au moment de l'ex√©cution, aucune extension de macro ne se produit. Tous se produisent lorsque le module est charg√©. Par cons√©quent, sur une telle chose, vous pouvez m√™me effectuer des optimisations ou des calculs qui se produiront au moment du chargement du module et g√©n√©rer un bytecode plus optimal. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2i/gz/9t/2igz9tsitqjebyuxpln51mhknra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxi√®me exemple est √©galement int√©ressant. Il s'agit d'une notation abr√©g√©e pour √©crire des lambdas. La macro f prend une s√©rie d'arguments et renvoie une fonction √† la place. Chaque expression commen√ßant par le nom de macro ¬´f¬ª, les crochets, puis absolument toute expression est convertie en lambda.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/l5/vq/ym/l5vqym-i-69vtjohomf2nsxfsj0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä mon avis, c'est aussi cool, surtout pour ceux qui aiment d√©velopper et √©crire du code dans un style fonctionnel et utiliser MapReduce. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0j/fx/xc/0jfxxcdmblyze8e4bcxqrqrgaoy.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un autre exemple familier. Cette fonction est factorielle, le code est surlign√© en rouge. Que se passera-t-il lorsqu'elle sera appel√©e? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ov/gj/v0/ovgjv0vqgcbzx0wxy5q-kuvozzg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il g√©n√©rera une erreur en Python, car il s'ex√©cutera dans la limite de pile et il y aura une telle RecursionError laide. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/zz/1h/wizz1haarmzw9is0q0k3n_r6mji.jpeg" width="600"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment r√©soudre ce probl√®me? En utilisant la macropie, la r√©solution du probl√®me est tr√®s simple. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wc/ej/-n/wcej-na40treik2p0hkdp1jfbns.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous accrochez le d√©corateur, il prend le corps de la fonction et le transforme de fa√ßon magique. Vous n'avez rien √† changer dans la fonction elle-m√™me, la macropie fera tout pour vous. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/c8/ld/xcc8ldcmcykmbaxjceek4xsgrka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et la fonction reviendra √† elle-m√™me un r√©sultat tout √† fait normal, allant loin dans le m√©tro. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ek/uq/mi/ekuqmigu-x5hhmdyyy8q04wob5c.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment fonctionne la macropie?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fz/1r/5f/fz1r5ff8_v-egywcvufzvw-zsec.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il remplace tous les appels √† la fonction elle-m√™me par un objet TailCall sp√©cial, qui est ensuite appel√© en boucle par le d√©corateur TCO. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dg/25/5b/dg255bb2t_mzo9ku4ucwq-uz31o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le circuit ressemble √† ceci. Le d√©corateur de la boucle appelle la fonction jusqu'√† ce qu'elle renvoie un r√©sultat normal au lieu de TailCall. Et si elle est revenue, elle le retourne. Et c'est tout. Ces choses sympas peuvent √™tre faites avec des macros! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Macropy comprend √©galement d'autres exemples. J'esp√®re que ceux qui sont curieux de vous voir par eux-m√™mes. Disons qu'il y a des choses utiles pour le d√©bogage.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wd/hg/rq/wdhgrqonz6lfdcicgdynvnfipfs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous parler d'une autre chose sympa. Un exemple est cette macro de requ√™te. Que fait-il? √Ä l'int√©rieur, vous √©crivez du code Python standard, que vous pouvez ensuite utiliser comme r√©sultat r√©gulier de l'ex√©cution de cette expression. Mais √† l'int√©rieur, macropy transforme ce code et le transforme en code de langage de requ√™te Alchemy SQL. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ag/qb/jk/agqbjkyzfbun_tbdnjxww5lutms.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il le r√©√©crit pour vous, fait cette terrible expression. Il peut √™tre r√©√©crit √† la main, puis il sera plus court. Je l'ai fait. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4k/ts/5w/4kts5wogftqmpcceukufkib56be.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici l'expression originale. Apr√®s avoir d√©velopp√© la macro, elle prend quelque chose comme √ßa. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/i0/uv/dui0uvfpouzuuioj2tmirtfyg5c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre que quelqu'un est int√©ress√© √† √©crire du code plus similaire √† Python et √† ne pas forcer ses d√©veloppeurs √† √©crire des requ√™tes sur DSL SQL Alchemy.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la m√™me mani√®re, vous pouvez g√©n√©rer n'importe quoi √† partir de Python - SQL pur, JavaScript - et l'enregistrer quelque part √† c√¥t√© du fichier, puis l'utiliser sur le frontend. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kk/s3/j3/kks3j3s2wwep0vejhof8-3fw-oq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant comment cr√©er votre propre macro. Avec la macropie, c'est tr√®s simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une macro est une fonction qui prend un arbre AST √† l'entr√©e et, en quelque sorte le transformant, en retourne un nouveau. Voici un exemple de macro qui ajoute une description √† l'appel d'assertion contenant l'expression source afin que nous puissions comprendre pourquoi l'erreur AssertionError s'est produite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, la fonction interne replace_assert est helper. Elle fait une descente r√©cursive dans un arbre pour vous. √Ä l'int√©rieur de replace_assert, l'√©l√©ment subtree est pass√©.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3u/qn/wa/3uqnwavrca79l0wumgmnfxfcm58.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour cette raison, vous pouvez v√©rifier √† l'int√©rieur son type et? s'il s'agit d'un appel Assert, faites-en quelque chose. Ici, je vais donner un exemple synth√©tique simple qui prend la partie gauche, la partie droite, en fait un message d'erreur et √©crit tout dans l'attribut msg. C'est le message qui devra √™tre renvoy√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rf/re/hn/rfrehnypphthxdzqbjwehtj3fas.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/va/ak/jm/vaakjmq4tpgqjwttqmi8nepgtym.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/x7/hq/cs/x7hqcswjuj59uhp5thatiojofja.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous l'utilisez, vous attachez une telle macro √† un bloc de code √† l'aide du gestionnaire de contexte with, et tout le code qui p√©n√®tre dans le gestionnaire de contexte passe par cette transformation. On voit ci-dessous que notre message d'erreur a √©t√© ajout√© √† AssertionError, que nous avons form√© √† partir de l'expression len ([1, 2, 3]).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yo/zo/zc/yozozclanvtdlinutuvnl58puve.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, cette m√©thode a une limitation qui me rend personnellement triste. </font><font style="vertical-align: inherit;">J'ai essay√© comme exp√©rience de faire de nouveaux designs qui fonctionneront dans la langue. </font><font style="vertical-align: inherit;">Par exemple, certaines personnes aiment le commutateur ou les constructions conditionnelles comme √† moins que. </font><font style="vertical-align: inherit;">Mais malheureusement, cela n'est pas possible: la macropie et tous les autres outils qui fonctionnent avec l'arbre AST sont utilis√©s lorsque le code source est d√©j√† lu et divis√© en jetons. </font><font style="vertical-align: inherit;">Le code est lu par l'analyseur Python, dont la grammaire est fix√©e dans l'interpr√©teur. </font><font style="vertical-align: inherit;">Pour le changer, vous devez recompiler Python. </font><font style="vertical-align: inherit;">Bien s√ªr, vous pouvez le faire, mais ce sera d√©j√† un fork de Python, et non une biblioth√®que qui peut √™tre pr√©sent√©e sur PyPI. </font><font style="vertical-align: inherit;">Par cons√©quent, il est impossible de r√©aliser de telles constructions en utilisant la macropie.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyLang</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, pendant ma longue vie, j'ai √©crit non seulement en Python et j'√©tais int√©ress√© par divers autres langages alternatifs. Il existe une syntaxe que beaucoup n'aiment pas, mais plus simple et flexible. Ce sont des expressions s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement pour nous, il existe un compl√©ment Python appel√© HyLang. Cette chose rappelle quelque peu Clojure, seul Clojure s'ex√©cute au-dessus de la JVM et HyLang s'ex√©cute au-dessus de la machine virtuelle Python. Autrement dit, il vous fournit une nouvelle syntaxe pour √©crire du code. Mais en m√™me temps, tout le code que vous √©crivez sera enti√®rement compatible avec les biblioth√®ques Python existantes, et il peut √™tre utilis√© √† partir des biblioth√®ques Python. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/54/sc/rr/54scrrucaeden67utnbyx3jva0i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ressemble √† ceci.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/vr/w7/qovrw7a-mivofegxjhx61jtlky0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La partie de gauche √©crite en Python, √† droite - sur HyLang. Et du bas pour les deux est un bytecode, qui est le r√©sultat. Vous avez probablement remarqu√© que c'est exactement la m√™me chose, seule la syntaxe change. Les expressions s HyLang, que beaucoup n'aiment pas. Les opposants aux ¬´crochets¬ª ne comprennent pas qu'une telle syntaxe donne √† la langue un pouvoir √©norme car elle donne l'uniformit√© aux constructions de la langue. Et l'uniformit√© vous permet d'utiliser des macros pour impl√©menter n'importe quelle conception. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela est d√ª au fait qu'√† l'int√©rieur de chaque expression, le premier √©l√©ment est toujours une sorte d'action. Et puis ses arguments disparaissent.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et tout le code est compos√© d'expressions imbriqu√©es faciles √† convertir et √† ouvrir des macros. Pour cette raison, absolument toutes les constructions peuvent √™tre faites en HyLang, nouvelles, en aucune fa√ßon indiscernables des fonctionnalit√©s de langage standard dans le code. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o5/-u/rw/o5-urwww9tzewkt4ufq7krycxj8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons comment fonctionne une macro simple sur HyLang. Pour faire la m√™me chose que nous avons fait avec Assert en utilisant la macropie, vous n'avez besoin que de ce code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre macro HyLang re√ßoit une entr√©e, qui est du code. En outre, une macro peut facilement utiliser n'importe quelle partie de ce code pour cr√©er un nouveau code. La principale diff√©rence entre les macros et les fonctions: les expressions sont entr√©es, pas des valeurs. Si nous appelons notre macro comme (is (= 1 2)), elle recevra alors une expression (= 1 2) au lieu de False.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uc/5b/az/uc5bazq37xtwjlsbaf54_kpe8zu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons donc g√©n√©rer un message d'erreur indiquant que quelque chose s'est mal pass√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hn/a9/cm/hna9cmzwxvf87k5e4i0py87cs84.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis retournez simplement le nouveau code. Cette syntaxe backtick et tilde signifie quelque chose comme ce qui suit. La citation arri√®re dit: prenez cette expression telle quelle et retournez-la telle quelle. Et le tilde dit: remplacez la valeur de la variable ici. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pi/qn/en/piqnenjm28v8jm0i-hfsdx3ib18.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, lorsque nous √©crivons ceci, la macro lors de l'expansion nous renverra une nouvelle expression, qui sera ainsi affirm√©e avec un message d'erreur suppl√©mentaire.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HyLang est une chose cool. </font><font style="vertical-align: inherit;">C'est vrai, alors que nous ne l'utilisons pas. </font><font style="vertical-align: inherit;">Peut-√™tre que nous ne le ferons jamais. </font><font style="vertical-align: inherit;">Tous ces √©l√©ments sont exp√©rimentaux. </font><font style="vertical-align: inherit;">Je veux que vous quittiez ici avec le sentiment qu'en Python, vous pouvez faire des choses auxquelles vous n'aviez peut-√™tre m√™me pas pens√© auparavant. </font><font style="vertical-align: inherit;">Et peut-√™tre que certains d'entre eux trouveront une application pratique dans votre travail en cours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C‚Äôest tout pour moi. </font><font style="vertical-align: inherit;">Vous pouvez voir les liens:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patterns</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacroPy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyLang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le livre OnLisp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour une √©tude avanc√©e des capacit√©s des macros. </font><font style="vertical-align: inherit;">C'est pour ceux qui sont particuli√®rement int√©ress√©s. </font><font style="vertical-align: inherit;">Certes, le livre n'est pas enti√®rement bas√© sur Python, mais sur Common Lisp. </font><font style="vertical-align: inherit;">Mais pour une √©tude plus approfondie, ce sera encore plus int√©ressant.</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495278/index.html">Bases de donn√©es, cartes, listes de contr√¥le ou Pourquoi un gestionnaire de connaissances commerciales</a></li>
<li><a href="../fr495280/index.html">Max Patrol SIEM. Pr√©sentation du syst√®me de gestion des √©v√©nements de s√©curit√© de l'information</a></li>
<li><a href="../fr495282/index.html">Validation XML √† l'aide de XSD, JAXB et Spring Framework</a></li>
<li><a href="../fr495290/index.html">Explorer la qualit√© du code du syst√®me d'exploitation Zephyr</a></li>
<li><a href="../fr495292/index.html">InterSystems IRIS 2020.1 Release</a></li>
<li><a href="../fr495296/index.html">M√©decine l√©gale, injection SQL et chat endurci: analyse de la t√¢che n ¬∞ 3 de l'√©tape en ligne NeoQUEST-2020</a></li>
<li><a href="../fr495298/index.html">√âvaluer les options de Monte Carlo Clojure</a></li>
<li><a href="../fr495302/index.html">Comment augmenter les ventes 2,5 fois en 4 mois dans une boutique en ligne - un cas pour la promotion SEO</a></li>
<li><a href="../fr495304/index.html">Rajeunissement des cellules humaines gr√¢ce √† leur reprogrammation</a></li>
<li><a href="../fr495308/index.html">Rake sur le chemin de la survie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>