<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👦🏻 🤱🏾 👾 Google CloudにDNSクラウドサポートストーリーがありません 👏🏾 👏 🉑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Googleブログの編集者から： Google Cloudテクニカルソリューション（TSE）のエンジニアがテクニカルサポートコールをどのように処理するのか疑問に思ったことはありますか？ TSEテクニカルサポートエンジニアの責任は、ユーザーが特定した問題の原因を検出して解決することです。これらの問題の...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Google CloudにDNSクラウドサポートストーリーがありません</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Googleブログの編集者から：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Google Cloudテクニカルソリューション（TSE）のエンジニアがテクニカルサポートコールをどのように処理するのか疑問に思ったことはありますか？ TSEテクニカルサポートエンジニアの責任は、ユーザーが特定した問題の原因を検出して解決することです。これらの問題の一部は非常に単純ですが、一度に複数のエンジニアの注意を必要とする魅力に出くわす場合があります。この記事では、TSEの従業員の1人が、彼の最近の実践からの1つの非常にトリッキーな問題について説明し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます-DNSパケットが失われ</font></a><font style="vertical-align: inherit;">た</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このストーリーの過程で、エンジニアがどのようにして状況を解決したか、そしてエラーを解消する過程で彼らがどのような新しいことを学んだかがわかります。このストーリーが根深いバグについて説明するだけでなく、Google Cloudのサポートリクエストを送信するときに発生するプロセスの理解にも役立つことを願っています。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
トラブルシューティングは科学と芸術の両方です。すべては、システムの非標準的な動作の原因に関する仮説を立てることから始まり、その後、強度についてテストされます。ただし、仮説を立てる前に、問題を明確に特定して正確に定式化する必要があります。質問が曖昧に聞こえる場合は、すべてを適切に分析する必要があります。これがトラブルシューティングの「技」です。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google Cloudは、ユーザーのプライバシーを保証するのに苦労しているため、Google Cloudのコンテキストでは時々複雑になります。</font><font style="vertical-align: inherit;">このため、TSEエンジニアは、システムを編集するためのアクセス権も、ユーザーと同じくらい広範囲に構成を表示する機能もありません。</font><font style="vertical-align: inherit;">したがって、私たちの仮説をテストするために、私たち（エンジニア）はシステムをすばやく修正することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部のユーザーは、自動車サービスのメカニックのようにすべてを修正し、仮想マシンのIDを送信するだけであると信じていますが、実際にはプロセスは会話形式で進行します。問題はクライアントとの通信に基づいています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検討中の問題</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日は良い結末の物語があります。</font><font style="vertical-align: inherit;">提案されたケースの解決が成功する理由の1つは、問題の非常に詳細かつ正確な説明です。</font><font style="vertical-align: inherit;">以下に、最初のチケットのコピーを示します（機密情報を非表示にするために編集されています）。</font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメッセージには、多くの役立つ情報が含まれています。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定されたVM</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題が示されている-DNSが機能しない</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題が発生した場所が示されている-VMとコンテナー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーが問題を特定するために行った手順が示されています。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
異議申し立ては「P1：重大な影響-本番環境ではサービスを使用できません」として登録されました。これは、「Follow the Sun」スキームに従って24時間年中無休で状況を監視することを意味します（リンクは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ユーザーコール</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">優先順位</font></a><font style="vertical-align: inherit;">について詳しく読むことが</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">できます</font></a><font style="vertical-align: inherit;">）。1つのテクニカルサポートチームから転送されます。タイムゾーンのシフトごとに他のタイムゾーンに。</font><font style="vertical-align: inherit;">実際、問題がチューリッヒの私たちのチームに到達したときまでに、彼女はなんとか地球を一周しました。</font><font style="vertical-align: inherit;">この時までに、ユーザーは結果を減らすための対策を講じましたが、主な理由がまだ見つからなかったため、彼は生産の状況が繰り返されることを恐れていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チケットがチューリッヒに到着するまでに、次の情報が手元にありました。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツ </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツ </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論 </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドによってコンパイルされた</font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pcapファイル</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデータを使用して、「調査」およびトラブルシューティングフェーズを開始する準備ができました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のステップ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、メタデータサーバーのログとステータスを確認し、正しく動作することを確認しました。</font><font style="vertical-align: inherit;">メタデータサーバーはIPアドレス169.254.169.254で応答し、特にドメイン名の制御を担当します。</font><font style="vertical-align: inherit;">また、ファイアウォールがVMで正しく動作し、パケットをブロックしないことを再確認しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは奇妙な問題でした：nmapテストは、UDPパケットの損失に関する私たちの主な仮説を否定したので、さらにいくつかのオプションとそれらをチェックする方法を精神的に推論しました。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パケットは選択的に消えますか？</font><font style="vertical-align: inherit;">=&gt; iptablesルールを確認する</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTUが</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小さすぎませ</font><font style="vertical-align: inherit;">んか？</font><font style="vertical-align: inherit;">=&gt;出力を確認</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題はUDPパケットまたはTCPにのみ影響しますか？</font><font style="vertical-align: inherit;">=&gt;離れてドライブ</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成されたdigパケットは返されますか？</font><font style="vertical-align: inherit;">=&gt;離れてドライブ</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdnsは正しく動作しますか？</font><font style="vertical-align: inherit;">=&gt;離れ</font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て</font><font style="vertical-align: inherit;">運転</font><font style="vertical-align: inherit;">し、両方向のパケット転送を確認する</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、ライブでトラブルシューティングするためにユーザーに電話をかけることにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通話中に、いくつかのことを確認しました。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかのチェックの後、理由のリストからiptablesルールを除外します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークインターフェイスとルーティングテーブルを確認し、MTUを再確認します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはその発見</font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（TCP）をそれが必要として働いているが、</font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（UDP）が動作していません</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た</font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それが動作中に実行</font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、私たちは、UDPパケットが返されていることがわかります</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは、実行</font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して正しく呼び出しを掘る方法を見る</font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、</font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、第二は、タイムアウトによって中断され、</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、シフトは間もなく終了し、次のタイムゾーンに問題を転送する必要があります。しかし、この魅力は私たちのチームへの関心を呼び起こし、同僚はPythonモジュールを使ってソースDNSパケットを作成することを提案しました。</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このフラグメントはDNSパケットを作成し、リクエストをメタデータサーバーに送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーがコードを実行すると、DNS応答が返され、アプリケーションはそれを受信して​​、ネットワークレベルで問題がないことを確認します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の「世界一周旅行」の後、アピールは私たちのチームに戻り、私はそれを完全に自分自身に翻訳します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その間、ユーザーはシステムイメージのスナップショットを提供することに同意してください。これは非常に朗報です。システムを自分でテストできることで、トラブルシューティングが大幅にスピードアップします。ユーザーにコマンドの実行、結果の送信、分析を依頼する必要がなくなるため、自分ですべてを行うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同僚は少しうらやましくなり始めています。</font><font style="vertical-align: inherit;">昼食時にその魅力について話し合いますが、何が起こっているのか誰にもわかりません。</font><font style="vertical-align: inherit;">幸い、ユーザー自身が既に緩和策を講じており、急いでいないので、問題を準備する時間があります。</font><font style="vertical-align: inherit;">また、イメージがあるので、興味のあるテストを実行できます。</font><font style="vertical-align: inherit;">いいね！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップに戻る</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムエンジニアへのインタビューで最も人気のある質問の1つは、</font><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.google.comに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pingを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">送信</font></a><font style="vertical-align: inherit;">するとどうなる</font><font style="vertical-align: inherit;">か」です。</font><font style="vertical-align: inherit;">候補はシェルからユーザースペース、システムのコア、さらにはネットワークに至るまで説明する必要があるため、問題は洗練されています。</font><font style="vertical-align: inherit;">私は笑います。インタビューの質問は実際の生活でも役立つ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ことがあります。このeycharの質問を現在の問題に適用することにします。</font><font style="vertical-align: inherit;">大まかに言えば、DNS名を特定しようとすると、次のことが起こります。</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションがシステムライブラリ（libdnsなど）を呼び出す</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdnsは、使用するDNSサーバーのシステム構成をチェックします（図では、169.254.169.254、メタデータサーバーです）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdnsは、システムコールを使用してUDPソケット（SOKET_DGRAM）を作成し、両方向にDNS要求と共にUDPパケットを送信します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sysctlインターフェースを使用して、カーネルレベルのUDPスタックを構成できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カーネルはハードウェアと相互作用して、ネットワークインターフェイスを介してネットワーク経由でパケットを送信します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハイパーバイザーは、パケットをキャッチしてメタデータサーバーに渡します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メタデータサーバーは、その魔術によってDNS名を決定し、同じ方法で回答を返します</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちがすでに考慮に入れている仮説を思い出させてください：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮説：壊れたライブラリ</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト1：システムでstraceを実行し、digが正しいシステムコールを引き起こすことを確認します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：正しいシステムコールが呼び出されます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト2：システムライブラリをバイパスして名前を特定できるかどうかを確認するためのsrapyを介して</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：できる</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト3：libdnsパッケージとmd5sumライブラリファイルでrpm –Vを実行する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：ライブラリコードは、動作中のオペレーティングシステムのコードと完全に同一です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト4：この動作なしでVMにユーザーのルートシステムのイメージをマウントし、chrootを実行して、DNSが機能するかどうかを確認します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：DNSは正しく機能しています</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストに基づく結論：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリに問題はない</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮説：DNS設定にエラーがある</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト1：tcpdumpをチェックし、digの実行後にDNSパケットが正しく送信および返送されているかどうかを確認します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：パケットは正しく送信されます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト2：サーバー</font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">再確認し、</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：すべてが正しい</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストベースの結論：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題はDNS構成の</font><b><font style="vertical-align: inherit;">仮説</font></b><font style="vertical-align: inherit;">ではない</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：カーネルの損傷</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト：新しいカーネルをインストールし、署名を確認して、再起動します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：同様の動作</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストに基づく結論：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カーネルは破損していない</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮説：ユーザーネットワーク（またはハイパーバイザーのネットワークインターフェイス）の不正な動作</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト1：ファイアウォール設定を確認する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：ファイアウォールがホストとGCPの両方でDNSパケットを渡します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト2：トラフィックを傍受し、DNSクエリの転送と戻りの正確さを追跡する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：tcpdumpは、ホストによる戻りパケットの受信を確認します</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストベースの結論：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題はネットワークに</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存在しない仮説：メタデータサーバーが機能しない</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト1：メタデータサーバーのログに異常がないか確認する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：ログに異常はありません</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト2：メタデータサーバーをバイパスする </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果：メタデータサーバーを使用しなくても権限に違反する</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストベースの結論：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題は、メタデータサーバではありません</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボトムライン：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは除いて、すべてのサブシステムをテストした</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランタイム設定！</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カーネルランタイム設定に飛び込む</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カーネルランタイムを構成するには、コマンドラインオプション（grub）またはsysctlインターフェースを使用できます。</font><font style="vertical-align: inherit;">調べて</font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">みたところ、いくつかのカスタム設定が見つかりました。</font><font style="vertical-align: inherit;">私は何かをつかんだかのように感じ、私は山の設定から残っているすべての非ネットワークまたは非TCP設定を閉じました</font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次に、VMがホスト権限を持っている場所に向かい、犯罪者に到達するまで、VMが壊れている設定を次々と適用し始めました。</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがDNSを壊す設定です！犯罪の道具を見つけた。しかし、なぜこれが起こっているのですか？私にはまだ動機が必要でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNSパケットバッファのベースサイズの設定は、を介して行われ</font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。典型的な値は200KiBのどこかで異なりますが、サーバーが多くのDNSパケットを受信する場合は、バッファーのサイズを増やすことができます。たとえば、アプリケーションが十分に速く処理しないために、新しいパッケージが到着した瞬間にバッファーがいっぱいになると、パケットが失われ始めます。クライアントがDNSパケットを介してメトリックを収集するためにアプリケーションを使用したため、データの損失を恐れていたため、クライアントは正しくバッファーサイズを増やしました。彼が設定した値は可能な最大値：2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1（2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を設定した場合</font><font style="vertical-align: inherit;">、カーネルは「無効な引数」を返します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
突然、nmapとscapyが正しく機能する理由に気づきました。それらはrawソケットを使用していました！ rawソケットは通常のソケットとは異なります。それらはiptablesをバイパスして機能し、バッファリングされません！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、「バッファが大きすぎる」と問題が発生するのはなぜですか。明らかに意図したとおりに機能しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、複数のコアと複数のディストリビューションで問題を再現できました。この問題はすでに3.xカーネルで発生しており、現在5.xカーネルでも発生しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
確かに、起動時</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNSが機能を停止しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単純なバイナリサーチアルゴリズムを使用して有効な値を検索し始めたところ、システムは2147481343で動作することがわかりましたが、この数値は私にとって意味のない数値のセットでした。私はクライアントにこの番号を試してみるように招待し、システムはgoogle.comで機能するが、他のドメインではまだエラーを返すと彼は答えたので、調査を続けました。</font><font style="vertical-align: inherit;">以前に使用する必要があったツールである</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">dropwatch</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
をインストールし</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これは、パッケージがカーネルのどこにあるかを正確に示します。関数は有罪</font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でした。カーネルソースをダウンロードし</font><font style="vertical-align: inherit;">、パッケージが具体的にどこに到達する</font><font style="vertical-align: inherit;">か</font><font style="vertical-align: inherit;">を追跡</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ために</font><font style="vertical-align: inherit;">いくつかの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">関数</font></a><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">追加しました</font><font style="vertical-align: inherit;">。私はすぐに適切な状態を見つけました</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2：それはすべてのものが最終的に全体像に一緒に来たこと、その後だったので、しばらく単に、彼を見つめていた</font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1、意味のない番号、アイドルドメイン...それは、内のコードの作品でした</font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意：</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 型はintです</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> タイプはu16（符号なし16ビット整数）で、パケットサイズを格納します</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 型はintであり、バッファのサイズを格納します。これは、定義により、 </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
場合</font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2接近</font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31を</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、パケットサイズを合計することにつながる可能性が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整数オーバーフロー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、それはintであるため、その値は負になり、条件がfalseである必要があるときに条件がtrueになります（これについての詳細は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で見つけることができます</font><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーは簡単な方法で修正され</font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">パッチを適用してシステムを再起動した後、DNSは再び機能し始めました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">勝利の味</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
調査結果をクライアントに転送し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LKML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カーネルパッチ</font><font style="vertical-align: inherit;">を送信しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私は満足しています。パズルのすべてのピースが1つの全体にまとめられました。観察したことを観察した理由を正確に説明できます。最も重要なのは、一緒に作業することによって問題の解決策を見つけることができたことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ケースがまれであることが判明したことを認識する価値があります。幸いなことに、そのような複雑な呼び出しがユーザーから私たちに届くことはほとんどありません。</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja503096/index.html">なぜマネージャーは労働者にリサイクルを望んでいるのですか？</a></li>
<li><a href="../ja503100/index.html">インターネットヘッド</a></li>
<li><a href="../ja503106/index.html">非標準の発見ダイジェスト：略奪植物、Twitterの真菌、グアノからの笑いガスの系譜</a></li>
<li><a href="../ja503108/index.html">虹の8色：数学の観点からの色について</a></li>
<li><a href="../ja503110/index.html">デジタル流行：CoronaVirusとCoViper</a></li>
<li><a href="../ja503118/index.html">デビッドヤン-非侵襲性、危機、焦土について</a></li>
<li><a href="../ja503126/index.html">Lipsez for VPS：Winユーザーの場合のリモートデスクトップの構成方法</a></li>
<li><a href="../ja503128/index.html">タスクの色を変更するためにColorPickerをJavaScriptガントに埋め込む方法</a></li>
<li><a href="../ja503130/index.html">何を読むべきかアドバイスする。パート2</a></li>
<li><a href="../ja503132/index.html">Apache Arrowを使用したPythonの高速Apache Parquet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>