<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😡 👶🏿 🔠 DockerとNginxによる認証 ♨️ 👩🏻‍🏭 🤵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="NASの作成時に発生する厄介な問題の1つは、すべてのソフトウェアがLDAPで機能するわけではなく、認証メカニズムが含まれていないソフトウェアがあることです。
 

解決策は、リバースプロキシを介したエンドツーエンドの認証です。
 これを行う方法の例は、この記事などで非常に詳細に説明されています。
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DockerとNginxによる認証</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456894/"><p><img src="https://habrastorage.org/webt/er/pm/ew/erpmewjegcpdjjgb6aobbkf3yda.jpeg"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NASの作成時に発生する厄介な問題の1つは、すべてのソフトウェアがLDAPで</font><font style="vertical-align: inherit;">機能するわけではなく、認証メカニズムが含まれ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いない</font><font style="vertical-align: inherit;">ソフトウェアがあること</font><font style="vertical-align: inherit;">です。</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解決策は、リバースプロキシを介したエンドツーエンドの認証です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行う方法の例は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などで非常に詳細に説明され</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ています</font></a><font style="vertical-align: inherit;">。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NASサイクルの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一部なので</font><font style="vertical-align: inherit;">、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">このソリューションをDockerコンテナー内のサービスに適応させる方法に焦点を当てます。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このソリューションは、外部の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx LDAP Auth</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エージェントを介して認証を実装する例に基づいてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、LinuxServer.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">コンテナ化されたバージョン</font></a><font style="vertical-align: inherit;">を使用します。</font><font style="vertical-align: inherit;">これは、特定の基準を満たす既製のイメージであるためです。</font></font></p><br>
<p>    ,   LinuxServer.io   HTTP ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,     .</p><br>
<h2 id="autentifikaciya-v-obschem-sluchae">   </h2><br>
<p>   ,     :</p><br>
<ul>
<li>   .</li>
<li>   ,   cookie.</li>
<li> cookie ,     .</li>
<li>     ,      LDAP .</li>
<li>  ,   cookie     .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/n_/e_/7j/n_e_7jmjle2qbyc35vfpv_0p7e4.jpeg" alt="認証スキーム"></p><br>
<p>        nginx,                  .</p><br>
<p>   OpenLDAP   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h2 id="autentifikaciya-konteynerov"> </h2><br>
<p>  NAS,    ,     ,      ,     .</p><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> ngingx-proxy</a>     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">docker-gen</a>.</p><br>
<p>    ,         Docker.</p><br>
<p> ,     —       ,       ,       ,     .</p><br>
<p>,      docker-compose.</p><br>
<h2 id="realizaciya-autentifikacii"> </h2><br>
<h3 id="modifikaciya-shablona-konfiguracii-nginx-proxy">   nginx-proxy</h3><br>
<p>     upstream,        :</p><br>
<pre><code class="nginx hljs"><span class="hljs-attribute">proxy_cache_path</span> cache/  keys_zone=auth_cache:<span class="hljs-number">10m</span>;<font></font>
<font></font>
<span class="hljs-attribute">upstream</span> ldap-backend {
        <span class="hljs-section">server</span> {{ $.Env.<span class="hljs-attribute">LDAP_BACKEND</span> }}:{{ <span class="hljs-attribute">or</span> $.Env.LDAP_LOGIN_PORT <span class="hljs-string">"9000"</span> }};<font></font>
}</code></pre><br>
<p>,       <code>${LDAP_BACKEND}</code>   <code>${LDAP_LOGIN_PORT }</code>,   9000.<br>
    docker-gen ,          <code>/etc/nginx/conf.d/default.conf</code>  :</p><br>
<pre><code class="nginx hljs"><span class="hljs-comment">### LDAP                                                                                                                  </span>
<span class="hljs-attribute">proxy_cache_path</span> cache/  keys_zone=auth_cache:<span class="hljs-number">10m</span>;                              
<span class="hljs-attribute">upstream</span> ldap-backend {                                                                                                                                                                                                
        <span class="hljs-attribute">server</span> ldap-auth:<span class="hljs-number">9000</span>;                                                                                                                                                                                         <font></font>
}                                                                                                                                                                                                                      <font></font>
<span class="hljs-comment">###</span></code></pre><br>
<p>    <code>ext_ldap_auth</code>,         <code>LDAP_EXT_AUTH</code>.<br>
,       .</p><br>
<pre><code class="nginx hljs">{{/* <span class="hljs-attribute">Nginx</span> LDAP authentication enabled */}}<font></font>
{{ $<span class="hljs-attribute">ext_ldap_auth</span> := parseBool (or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.LDAP_EXT_AUTH"</span>)) <span class="hljs-string">"false"</span>) }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">User</span> need to be participated in these groups to use service */}}<font></font>
{{ $<span class="hljs-attribute">ldap_add_groups</span> := or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.LDAP_EXT_ADD_GROUPS"</span>)) <span class="hljs-string">""</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Use</span> HTML login page or HTTP Basic authentication */}}<font></font>
{{ $<span class="hljs-attribute">ldap_use_login_page</span> := parseBool (or $.Env.LDAP_USE_LOGIN_PAGE <span class="hljs-string">"false"</span> ) }}</code></pre><br>
<p>    .  ,     <code>ext_ldap_auth</code>.<br>
 <code>ldap_use_login_page</code> ,       ,       HTTP.</p><br>
<p> <code>/auth-proxy</code> —       .<br>
     HTTP.<br>
     ,     .</p><br>
<div class="spoiler"><b class="spoiler_title">LDAP </b><div class="spoiler_text"><pre><code class="nginx hljs">        {{ <span class="hljs-attribute">if</span> (<span class="hljs-variable">$ext_ldap_auth</span>) }}
        <span class="hljs-comment">### LDAP</span><font></font>
<font></font>
        {{ <span class="hljs-attribute">if</span> (<span class="hljs-variable">$ldap_use_login_page</span>) }}<font></font>
        location /login-ldap {<font></font>
            <span class="hljs-attribute">proxy_pass</span> http://{{ $.Env.<span class="hljs-attribute">LDAP_BACKEND</span> }}:{{ <span class="hljs-attribute">or</span> $.Env.LDAP_LOGIN_PORT <span class="hljs-string">"9000"</span> }};
                <span class="hljs-comment"># Login service returns a redirect to the original URI</span>
                <span class="hljs-comment"># and sets the cookie for the ldap-auth daemon</span>
                <span class="hljs-attribute">proxy_set_header</span> X-Target <span class="hljs-variable">$request_uri</span>;<font></font>
<font></font>
                <span class="hljs-attribute">proxy_pass_request_body</span> <span class="hljs-literal">off</span>;
                <span class="hljs-attribute">proxy_set_header</span> Content-Length <span class="hljs-string">""</span>;
                <span class="hljs-attribute">proxy_cache</span> auth_cache;
                <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">10m</span>;<font></font>
<font></font>
                <span class="hljs-attribute">proxy_cache_key</span> <span class="hljs-string">"<span class="hljs-variable">$http_authorization</span><span class="hljs-variable">$cookie_nginxauth</span>"</span>;<font></font>
<font></font>
                <span class="hljs-attribute">proxy_set_header</span> X-CookieName <span class="hljs-string">"nginxauth"</span>;
                <span class="hljs-attribute">proxy_set_header</span> Cookie nginxauth=<span class="hljs-variable">$cookie_nginxauth</span>;<font></font>
        }<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    location = /auth-proxy {<font></font>
        internal;<font></font>
<font></font>
                <span class="hljs-comment"># The ldap-auth daemon listens on port $LDAP_BACKEND_PORT (8888, by default), as set</span>
                <span class="hljs-comment"># in nginx-ldap-auth-daemon.py.</span>
                <span class="hljs-comment"># Change the IP address if the daemon is not running on</span>
                <span class="hljs-comment"># the same host as NGINX/NGINX Plus.</span>
                <span class="hljs-attribute">proxy_pass</span> http://{{ $.Env.<span class="hljs-attribute">LDAP_BACKEND</span> }}:{{ <span class="hljs-attribute">or</span> $.Env.LDAP_BACKEND_PORT <span class="hljs-string">"8888"</span> }};<font></font>
<font></font>
                <span class="hljs-attribute">proxy_pass_request_body</span> <span class="hljs-literal">off</span>;
                <span class="hljs-attribute">proxy_set_header</span> Content-Length <span class="hljs-string">""</span>;
                <span class="hljs-attribute">proxy_cache</span> auth_cache;
                <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">10m</span>;<font></font>
<font></font>
                <span class="hljs-comment"># The following directive adds the cookie to the cache key</span>
                <span class="hljs-attribute">proxy_cache_key</span> <span class="hljs-string">"<span class="hljs-variable">$http_authorization</span><span class="hljs-variable">$cookie_nginxauth</span>"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># As implemented in nginx-ldap-auth-daemon.py, the ldap-auth daemon</span>
                <span class="hljs-comment"># communicates with a LDAP server, passing in the following</span>
                <span class="hljs-comment"># parameters to specify which user account to authenticate. To</span>
                <span class="hljs-comment"># eliminate the need to modify the Python code, this file contains</span>
                <span class="hljs-comment"># 'proxy_set_header' directives that set the values of the</span>
                <span class="hljs-comment"># parameters. Set or change them as instructed in the comments.</span>
                <span class="hljs-comment">#</span>
                <span class="hljs-comment">#    Parameter      Proxy header</span>
                <span class="hljs-comment">#    -----------    ----------------</span>
                <span class="hljs-comment">#    url            X-Ldap-URL</span>
                <span class="hljs-comment">#    starttls       X-Ldap-Starttls</span>
                <span class="hljs-comment">#    basedn         X-Ldap-BaseDN</span>
                <span class="hljs-comment">#    binddn         X-Ldap-BindDN</span>
                <span class="hljs-comment">#    bindpasswd     X-Ldap-BindPass</span>
                <span class="hljs-comment">#    cookiename     X-CookieName</span>
                <span class="hljs-comment">#    realm          X-Ldap-Realm</span>
                <span class="hljs-comment">#    template       X-Ldap-Template</span><font></font>
<font></font>
                <span class="hljs-comment"># (Required) Set the URL and port for connecting to the LDAP server,</span>
                <span class="hljs-comment"># by replacing 'example.com'.</span>
                <span class="hljs-comment"># Do not mix ldaps-style URL and X-Ldap-Starttls as it will not work.</span>
                <span class="hljs-attribute">proxy_set_header</span> X-Ldap-URL      <span class="hljs-string">"{{ $.Env.LDAP_HOST }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Optional) Establish a TLS-enabled LDAP session after binding to the</span>
                <span class="hljs-comment"># LDAP server.</span>
                <span class="hljs-comment"># This is the 'proper' way to establish encrypted TLS connections, see</span>
                <span class="hljs-comment"># http://www.openldap.org/faq/data/cache/185.html</span>
                {{ <span class="hljs-attribute">if</span> eq (<span class="hljs-string">"$.Env.LDAP_METHOD"</span>) <span class="hljs-string">"start_tls"</span> }}<font></font>
                proxy_set_header X-Ldap-Starttls <span class="hljs-string">"true"</span>;<font></font>
                {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
                <span class="hljs-comment"># (Required) Set the Base DN, by replacing the value enclosed in</span>
                <span class="hljs-comment"># double quotes.</span>
                proxy_set_header X-Ldap-BaseDN   <span class="hljs-string">"{{ $.Env.LDAP_BASE }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Required) Set the Bind DN, by replacing the value enclosed in</span>
                <span class="hljs-comment"># double quotes.</span>
                <span class="hljs-attribute">proxy_set_header</span> X-Ldap-BindDN   <span class="hljs-string">"{{ $.Env.LDAP_BIND_DN }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Required) Set the Bind password, by replacing 'secret'.</span>
                <span class="hljs-attribute">proxy_set_header</span> X-Ldap-BindPass <span class="hljs-string">"{{ $.Env.LDAP_PASS }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Required) The following directives set the cookie name and pass</span>
                <span class="hljs-comment"># it, respectively. They are required for cookie-based</span>
                <span class="hljs-comment"># authentication. Comment them out if using HTTP basic</span>
                <span class="hljs-comment"># authentication.</span>
                <span class="hljs-attribute">proxy_set_header</span> X-CookieName <span class="hljs-string">"nginxauth"</span>;
                <span class="hljs-attribute">proxy_set_header</span> Cookie nginxauth=<span class="hljs-variable">$cookie_nginxauth</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Required if using Microsoft Active Directory as the LDAP server)</span>
                <span class="hljs-comment"># Set the LDAP template by uncommenting the following directive.</span>
                <span class="hljs-comment">#proxy_set_header X-Ldap-Template "(sAMAccountName=%(username)s)";</span><font></font>
<font></font>
                <span class="hljs-comment"># (May be required if using Microsoft Active Directory and</span>
                <span class="hljs-comment"># getting "In order to perform this operation a successful bind</span>
                <span class="hljs-comment"># must be completed on the connection." errror)</span>
                <span class="hljs-comment">#proxy_set_header X-Ldap-DisableReferrals "true";</span><font></font>
<font></font>
                <span class="hljs-comment"># (Optional if using OpenLDAP as the LDAP server) Set the LDAP</span>
                <span class="hljs-comment"># template by uncommenting the following directive and replacing</span>
                <span class="hljs-comment"># '(cn=%(username)s)' which is the default set in</span>
                <span class="hljs-comment"># nginx-ldap-auth-daemon.py.</span>
                {{ $<span class="hljs-attribute">ldap_filter</span> := $.Env.LDAP_USER_FILTER }}<font></font>
                {{ $<span class="hljs-attribute">ldap_filter</span> := (printf <span class="hljs-string">"(&amp;%s%s)"</span> <span class="hljs-variable">$ldap_filter</span> <span class="hljs-variable">$ldap_add_groups</span>) }}<font></font>
<font></font>
                proxy_set_header X-Ldap-Template <span class="hljs-string">"{{ <span class="hljs-variable">$ldap_filter</span> }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Optional) Set the realm name, by uncommenting the following</span>
                <span class="hljs-comment"># directive and replacing 'Restricted' which is the default set</span>
                <span class="hljs-comment"># in nginx-ldap-auth-daemon.py.</span>
                <span class="hljs-comment">#proxy_set_header X-Ldap-Realm    "Restricted";</span><font></font>
        }<font></font>
        <span class="hljs-comment">### /LDAP</span>
        {{ <span class="hljs-attribute">end</span> }}</code></pre></div></div><br>
<p> ,  LDAP    ,  <code>auth_request</code>   location:</p><br>
<pre><code class="nginx hljs">    <span class="hljs-attribute">location</span> / {<font></font>
                {{ <span class="hljs-attribute">if</span> (<span class="hljs-variable">$ext_ldap_auth</span>) }}<font></font>
        auth_request /auth-proxy;<font></font>
<font></font>
        {{ <span class="hljs-attribute">if</span> (<span class="hljs-variable">$ldap_use_login_page</span>) }}
        <span class="hljs-comment"># redirect 401 to login form</span>
        <span class="hljs-comment"># Comment them out if using HTTP basic authentication.</span>
        <span class="hljs-comment"># or authentication popup won't show</span>
        error_page <span class="hljs-number">401</span> =<span class="hljs-number">200</span> /login-ldap;<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
        {{ <span class="hljs-attribute">end</span> }}
</code></pre><br>
<p>    .</p><br>
<div class="spoiler"><b class="spoiler_title">nginx.tmpl</b><div class="spoiler_text"><pre><code class="nginx hljs">{{ $<span class="hljs-attribute">CurrentContainer</span> := where $ <span class="hljs-string">"ID"</span> .Docker.CurrentContainerID | first }}<font></font>
<font></font>
{{ <span class="hljs-attribute">define</span> <span class="hljs-string">"upstream"</span> }}<font></font>
    {{ <span class="hljs-attribute">if</span> .Address }}<font></font>
        {{/* <span class="hljs-attribute">If</span> we got the containers from swarm and this container<span class="hljs-string">'s port is published to host, use host IP:PORT */}}
        {{ if and .Container.Node.ID .Address.HostPort }}
            # {{ .Container.Node.Name }}/{{ .Container.Name }}
            server {{ .Container.Node.Address.IP }}:{{ .Address.HostPort }};
        {{/* If there is no swarm node or the port is not published on host, use container'</span>s IP:PORT */}}<font></font>
        {{ <span class="hljs-attribute">else</span> if .Network }}
            <span class="hljs-comment"># {{ .Container.Name }}</span>
            server {{ .Network.<span class="hljs-attribute">IP</span> }}:{{ .Address.<span class="hljs-attribute">Port</span> }};<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
    {{ <span class="hljs-attribute">else</span> if .Network }}
        <span class="hljs-comment"># {{ .Container.Name }}</span>
        {{ <span class="hljs-attribute">if</span> .Network.IP }}<font></font>
            server {{ .Network.<span class="hljs-attribute">IP</span> }} down;<font></font>
        {{ <span class="hljs-attribute">else</span> }}<font></font>
            server <span class="hljs-number">127.0.0.1</span> down;<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
<span class="hljs-comment"># If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the</span>
<span class="hljs-comment"># scheme used to connect to this server</span>
map <span class="hljs-variable">$http_x_forwarded_proto</span> <span class="hljs-variable">$proxy_x_forwarded_proto</span> {
  <span class="hljs-attribute">default</span> <span class="hljs-variable">$http_x_forwarded_proto</span>;<font></font>
  ''      $scheme;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># If we receive X-Forwarded-Port, pass it through; otherwise, pass along the</span>
<span class="hljs-comment"># server port the client connected to</span>
<span class="hljs-attribute">map</span> <span class="hljs-variable">$http_x_forwarded_port</span> <span class="hljs-variable">$proxy_x_forwarded_port</span> {
  <span class="hljs-attribute">default</span> <span class="hljs-variable">$http_x_forwarded_port</span>;<font></font>
  ''      $server_port;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># If we receive Upgrade, set Connection to "upgrade"; otherwise, delete any</span>
<span class="hljs-comment"># Connection header that may have been passed to this server</span>
<span class="hljs-attribute">map</span> <span class="hljs-variable">$http_upgrade</span> <span class="hljs-variable">$proxy_connection</span> {
  <span class="hljs-attribute">default</span> upgrade;<font></font>
  '' close;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># Apply fix for very long server names</span>
<span class="hljs-attribute">server_names_hash_bucket_size</span> <span class="hljs-number">128</span>;<font></font>
<font></font>
<span class="hljs-comment"># Default dhparam</span>
{{ <span class="hljs-attribute">if</span> (exists <span class="hljs-string">"/etc/nginx/certs/dhparam.pem"</span>) }}<font></font>
ssl_dhparam /etc/nginx/certs/dhparam.pem;<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
<span class="hljs-comment"># Set appropriate X-Forwarded-Ssl header</span>
map <span class="hljs-variable">$scheme</span> <span class="hljs-variable">$proxy_x_forwarded_ssl</span> {
  <span class="hljs-attribute">default</span> <span class="hljs-literal">off</span>;
  <span class="hljs-attribute">https</span> <span class="hljs-literal">on</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">gzip_types</span> text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;<font></font>
<font></font>
<span class="hljs-attribute">log_format</span> vhost <span class="hljs-string">'<span class="hljs-variable">$host</span> <span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] '</span>
                 <span class="hljs-string">'"<span class="hljs-variable">$request</span>" <span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> '</span>
                 <span class="hljs-string">'"<span class="hljs-variable">$http_referer</span>" "<span class="hljs-variable">$http_user_agent</span>"'</span>;<font></font>
<font></font>
<span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;<font></font>
<font></font>
{{ <span class="hljs-attribute">if</span> $.Env.RESOLVERS }}<font></font>
resolver {{ $.Env.<span class="hljs-attribute">RESOLVERS</span> }};<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
{{ <span class="hljs-attribute">if</span> (exists <span class="hljs-string">"/etc/nginx/proxy.conf"</span>) }}<font></font>
include /etc/nginx/proxy.conf;<font></font>
{{ <span class="hljs-attribute">else</span> }}
<span class="hljs-comment"># HTTP 1.1 support</span>
proxy_http_version <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;
<span class="hljs-attribute">proxy_buffering</span> <span class="hljs-literal">off</span>;
<span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$http_host</span>;
<span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;
<span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-variable">$proxy_connection</span>;
<span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
<span class="hljs-attribute">proxy_set_header</span> X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
<span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Proto <span class="hljs-variable">$proxy_x_forwarded_proto</span>;
<span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Ssl <span class="hljs-variable">$proxy_x_forwarded_ssl</span>;
<span class="hljs-attribute">proxy_set_header</span> X-Forwarded-Port <span class="hljs-variable">$proxy_x_forwarded_port</span>;<font></font>
<font></font>
<span class="hljs-comment"># Allow iframing.</span>
<span class="hljs-attribute">proxy_hide_header</span> X-Frame-Options;<font></font>
<font></font>
<span class="hljs-comment"># Mitigate httpoxy attack (see README for details)</span>
<span class="hljs-attribute">proxy_set_header</span> Proxy <span class="hljs-string">""</span>;<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
<span class="hljs-comment">### LDAP</span><font></font>
<font></font>
proxy_cache_path cache/  keys_zone=auth_cache:<span class="hljs-number">10m</span>;<font></font>
<font></font>
<span class="hljs-attribute">upstream</span> ldap-backend {
        <span class="hljs-section">server</span> {{ $.Env.<span class="hljs-attribute">LDAP_BACKEND</span> }}:{{ <span class="hljs-attribute">or</span> $.Env.LDAP_LOGIN_PORT <span class="hljs-string">"9000"</span> }};<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">###</span><font></font>
<font></font>
{{ $<span class="hljs-attribute">enable_ipv6</span> := eq (or ($.Env.ENABLE_IPV6) <span class="hljs-string">""</span>) <span class="hljs-string">"true"</span> }}<font></font>
server {<font></font>
    <span class="hljs-attribute">server_name</span> _; <span class="hljs-comment"># This is just an invalid value which will never trigger on a real hostname.</span>
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<font></font>
    {{ <span class="hljs-attribute">if</span> <span class="hljs-variable">$enable_ipv6</span> }}<font></font>
    listen [::]:<span class="hljs-number">80</span>;<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
    access_log /var/log/nginx/access.log vhost;<font></font>
    <span class="hljs-attribute">return</span> <span class="hljs-number">503</span>;<font></font>
}<font></font>
<font></font>
{{ <span class="hljs-attribute">if</span> (and (exists <span class="hljs-string">"/etc/nginx/certs/default.crt"</span>) (exists <span class="hljs-string">"/etc/nginx/certs/default.key"</span>)) }}<font></font>
server {<font></font>
    <span class="hljs-attribute">server_name</span> _; <span class="hljs-comment"># This is just an invalid value which will never trigger on a real hostname.</span>
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2;<font></font>
    {{ <span class="hljs-attribute">if</span> <span class="hljs-variable">$enable_ipv6</span> }}<font></font>
    listen [::]:<span class="hljs-number">443</span> ssl http2;<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
    access_log /var/log/nginx/access.log vhost;<font></font>
    <span class="hljs-attribute">return</span> <span class="hljs-number">503</span>;<font></font>
<font></font>
    <span class="hljs-attribute">ssl_session_tickets</span> <span class="hljs-literal">off</span>;
    <span class="hljs-attribute">ssl_certificate</span> /etc/nginx/certs/default.crt;
    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/certs/default.key;<font></font>
}<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
{{ <span class="hljs-attribute">range</span> <span class="hljs-variable">$host</span>, <span class="hljs-variable">$containers</span> := groupByMulti $ <span class="hljs-string">"Env.VIRTUAL_HOST"</span> <span class="hljs-string">","</span> }}<font></font>
<font></font>
{{ $<span class="hljs-attribute">host</span> := trim <span class="hljs-variable">$host</span> }}<font></font>
{{ $<span class="hljs-attribute">is_regexp</span> := hasPrefix <span class="hljs-string">"~"</span> <span class="hljs-variable">$host</span> }}<font></font>
{{ $<span class="hljs-attribute">upstream_name</span> := when <span class="hljs-variable">$is_regexp</span> (sha1 <span class="hljs-variable">$host</span>) <span class="hljs-variable">$host</span> }}<font></font>
<font></font>
<span class="hljs-comment"># {{ $host }}</span>
upstream {{ $<span class="hljs-attribute">upstream_name</span> }} {<font></font>
<font></font>
{{ <span class="hljs-attribute">range</span> <span class="hljs-variable">$container</span> := <span class="hljs-variable">$containers</span> }}<font></font>
    {{ $<span class="hljs-attribute">addrLen</span> := len <span class="hljs-variable">$container</span>.Addresses }}<font></font>
<font></font>
    {{ <span class="hljs-attribute">range</span> <span class="hljs-variable">$knownNetwork</span> := <span class="hljs-variable">$CurrentContainer</span>.Networks }}<font></font>
        {{ <span class="hljs-attribute">range</span> <span class="hljs-variable">$containerNetwork</span> := <span class="hljs-variable">$container</span>.Networks }}<font></font>
            {{ <span class="hljs-attribute">if</span> (and (ne <span class="hljs-variable">$containerNetwork</span>.Name <span class="hljs-string">"ingress"</span>) (or (eq <span class="hljs-variable">$knownNetwork</span>.Name <span class="hljs-variable">$containerNetwork</span>.Name) (eq <span class="hljs-variable">$knownNetwork</span>.Name <span class="hljs-string">"host"</span>))) }}
                <span class="hljs-comment">## Can be connected with "{{ $containerNetwork.Name }}" network</span><font></font>
<font></font>
                {{/* <span class="hljs-attribute">If</span> only <span class="hljs-number">1</span> port exposed, use that */}}<font></font>
                {{ <span class="hljs-attribute">if</span> eq <span class="hljs-variable">$addrLen</span> <span class="hljs-number">1</span> }}<font></font>
                    {{ $<span class="hljs-attribute">address</span> := index <span class="hljs-variable">$container</span>.Addresses <span class="hljs-number">0</span> }}<font></font>
                    {{ <span class="hljs-attribute">template</span> <span class="hljs-string">"upstream"</span> (dict <span class="hljs-string">"Container"</span> <span class="hljs-variable">$container</span> <span class="hljs-string">"Address"</span> <span class="hljs-variable">$address</span> <span class="hljs-string">"Network"</span> <span class="hljs-variable">$containerNetwork</span>) }}<font></font>
                {{/* <span class="hljs-attribute">If</span> more than one port exposed, use the one matching VIRTUAL_PORT env var, falling back to standard web port <span class="hljs-number">80</span> */}}<font></font>
                {{ <span class="hljs-attribute">else</span> }}<font></font>
                    {{ $<span class="hljs-attribute">port</span> := coalesce <span class="hljs-variable">$container</span>.Env.VIRTUAL_PORT <span class="hljs-string">"80"</span> }}<font></font>
                    {{ $<span class="hljs-attribute">address</span> := where <span class="hljs-variable">$container</span>.Addresses <span class="hljs-string">"Port"</span> <span class="hljs-variable">$port</span> | first }}<font></font>
                    {{ <span class="hljs-attribute">template</span> <span class="hljs-string">"upstream"</span> (dict <span class="hljs-string">"Container"</span> <span class="hljs-variable">$container</span> <span class="hljs-string">"Address"</span> <span class="hljs-variable">$address</span> <span class="hljs-string">"Network"</span> <span class="hljs-variable">$containerNetwork</span>) }}<font></font>
                {{ <span class="hljs-attribute">end</span> }}<font></font>
            {{ <span class="hljs-attribute">else</span> }}
                <span class="hljs-comment"># Cannot connect to network of this container</span>
                server <span class="hljs-number">127.0.0.1</span> down;<font></font>
            {{ <span class="hljs-attribute">end</span> }}<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
}<font></font>
<font></font>
{{ $<span class="hljs-attribute">default_host</span> := or ($.Env.DEFAULT_HOST) <span class="hljs-string">""</span> }}<font></font>
{{ $<span class="hljs-attribute">default_server</span> := index (dict <span class="hljs-variable">$host</span> <span class="hljs-string">""</span> <span class="hljs-variable">$default_host</span> <span class="hljs-string">"default_server"</span>) <span class="hljs-variable">$host</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Get</span> the VIRTUAL_PROTO defined by containers w/ the same vhost, falling back to <span class="hljs-string">"http"</span> */}}<font></font>
{{ $<span class="hljs-attribute">proto</span> := trim (or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.VIRTUAL_PROTO"</span>)) <span class="hljs-string">"http"</span>) }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Get</span> the NETWORK_ACCESS defined by containers w/ the same vhost, falling back to <span class="hljs-string">"external"</span> */}}<font></font>
{{ $<span class="hljs-attribute">network_tag</span> := or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.NETWORK_ACCESS"</span>)) <span class="hljs-string">"external"</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Get</span> the HTTPS_METHOD defined by containers w/ the same vhost, falling back to <span class="hljs-string">"redirect"</span> */}}<font></font>
{{ $<span class="hljs-attribute">https_method</span> := or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.HTTPS_METHOD"</span>)) <span class="hljs-string">"redirect"</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Get</span> the SSL_POLICY defined by containers w/ the same vhost, falling back to <span class="hljs-string">"Mozilla-Intermediate"</span> */}}<font></font>
{{ $<span class="hljs-attribute">ssl_policy</span> := or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.SSL_POLICY"</span>)) <span class="hljs-string">"Mozilla-Intermediate"</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Get</span> the HSTS defined by containers w/ the same vhost, falling back to <span class="hljs-string">"max-age=31536000"</span> */}}<font></font>
{{ $<span class="hljs-attribute">hsts</span> := or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.HSTS"</span>)) <span class="hljs-string">"max-age=31536000"</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Get</span> the VIRTUAL_ROOT By containers w/ use fastcgi root */}}<font></font>
{{ $<span class="hljs-attribute">vhost_root</span> := or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.VIRTUAL_ROOT"</span>)) <span class="hljs-string">"/var/www/public"</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Nginx</span> LDAP authentication enabled */}}<font></font>
{{ $<span class="hljs-attribute">ext_ldap_auth</span> := parseBool (or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.LDAP_EXT_AUTH"</span>)) <span class="hljs-string">"false"</span>) }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">User</span> need to be participated in these groups to use service */}}<font></font>
{{ $<span class="hljs-attribute">ldap_add_groups</span> := or (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.LDAP_EXT_ADD_GROUPS"</span>)) <span class="hljs-string">""</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Use</span> HTML login page or HTTP Basic authentication */}}<font></font>
{{ $<span class="hljs-attribute">ldap_use_login_page</span> := parseBool (or $.Env.LDAP_USE_LOGIN_PAGE <span class="hljs-string">"false"</span> ) }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Get</span> the first cert name defined by containers w/ the same vhost */}}<font></font>
{{ $<span class="hljs-attribute">certName</span> := (first (groupByKeys <span class="hljs-variable">$containers</span> <span class="hljs-string">"Env.CERT_NAME"</span>)) }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Get</span> the best matching cert  by name for the vhost. */}}<font></font>
{{ $<span class="hljs-attribute">vhostCert</span> := (closest (dir <span class="hljs-string">"/etc/nginx/certs"</span>) (printf <span class="hljs-string">"%s.crt"</span> <span class="hljs-variable">$host</span>))}}<font></font>
<font></font>
{{/* <span class="hljs-attribute">vhostCert</span> is actually a filename so remove any suffixes since they are added later */}}<font></font>
{{ $<span class="hljs-attribute">vhostCert</span> := trimSuffix <span class="hljs-string">".crt"</span> <span class="hljs-variable">$vhostCert</span> }}<font></font>
{{ $<span class="hljs-attribute">vhostCert</span> := trimSuffix <span class="hljs-string">".key"</span> <span class="hljs-variable">$vhostCert</span> }}<font></font>
<font></font>
{{/* <span class="hljs-attribute">Use</span> the cert specified <span class="hljs-literal">on</span> the container or fallback to the best vhost match */}}<font></font>
{{ $<span class="hljs-attribute">cert</span> := (coalesce <span class="hljs-variable">$certName</span> <span class="hljs-variable">$vhostCert</span>) }}<font></font>
<font></font>
{{ $<span class="hljs-attribute">is_https</span> := (and (ne <span class="hljs-variable">$https_method</span> <span class="hljs-string">"nohttps"</span>) (ne <span class="hljs-variable">$cert</span> <span class="hljs-string">""</span>) (or (and (exists (printf <span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span> <span class="hljs-variable">$cert</span>)) (exists (printf <span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span> <span class="hljs-variable">$cert</span>))) (and (exists (printf <span class="hljs-string">"/etc/nginx/certs/%s.crt"</span> <span class="hljs-variable">$cert</span>)) (exists (printf <span class="hljs-string">"/etc/nginx/certs/%s.key"</span> <span class="hljs-variable">$cert</span>)))) ) }}<font></font>
<font></font>
{{ <span class="hljs-attribute">if</span> <span class="hljs-variable">$is_https</span> }}<font></font>
<font></font>
{{ <span class="hljs-attribute">if</span> eq <span class="hljs-variable">$https_method</span> <span class="hljs-string">"redirect"</span> }}<font></font>
server {<font></font>
    <span class="hljs-section">server_name</span> {{ $<span class="hljs-attribute">host</span> }};
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> {{ $<span class="hljs-attribute">default_server</span> }};<font></font>
    {{ <span class="hljs-attribute">if</span> <span class="hljs-variable">$enable_ipv6</span> }}<font></font>
    listen [::]:<span class="hljs-number">80</span> {{ $<span class="hljs-attribute">default_server</span> }};<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
    access_log /var/log/nginx/access.log vhost;<font></font>
<font></font>
    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://<span class="hljs-variable">$host</span><span class="hljs-variable">$request_uri</span>;<font></font>
}<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
server {<font></font>
    <span class="hljs-section">server_name</span> {{ $<span class="hljs-attribute">host</span> }};
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2 {{ $<span class="hljs-attribute">default_server</span> }};<font></font>
    {{ <span class="hljs-attribute">if</span> <span class="hljs-variable">$enable_ipv6</span> }}<font></font>
    listen [::]:<span class="hljs-number">443</span> ssl http2 {{ $<span class="hljs-attribute">default_server</span> }};<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
    access_log /var/log/nginx/access.log vhost;<font></font>
<font></font>
    {{ <span class="hljs-attribute">if</span> eq <span class="hljs-variable">$network_tag</span> <span class="hljs-string">"internal"</span> }}
    <span class="hljs-comment"># Only allow traffic from internal clients</span><font></font>
    include /etc/nginx/network_internal.conf;<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    {{ <span class="hljs-attribute">if</span> eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"Mozilla-Modern"</span> }}<font></font>
    ssl_protocols TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256'</span>;<font></font>
    {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"Mozilla-Intermediate"</span> }}<font></font>
    ssl_protocols TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS'</span>;<font></font>
    {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"Mozilla-Old"</span> }}<font></font>
    ssl_protocols SSLv3 TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:DES-CBC3-SHA:HIGH:SEED:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!RSAPSK:!aDH:!aECDH:!EDH-DSS-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!SRP'</span>;<font></font>
    {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"AWS-TLS-1-2-2017-01"</span> }}<font></font>
    ssl_protocols TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:AES128-GCM-SHA256:AES128-SHA256:AES256-GCM-SHA384:AES256-SHA256'</span>;<font></font>
    {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"AWS-TLS-1-1-2017-01"</span> }}<font></font>
    ssl_protocols TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span>;<font></font>
    {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"AWS-2016-08"</span> }}<font></font>
    ssl_protocols TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA'</span>;<font></font>
    {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"AWS-2015-05"</span> }}<font></font>
    ssl_protocols TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DES-CBC3-SHA'</span>;<font></font>
    {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"AWS-2015-03"</span> }}<font></font>
    ssl_protocols TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA:DES-CBC3-SHA'</span>;<font></font>
    {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$ssl_policy</span> <span class="hljs-string">"AWS-2015-02"</span> }}<font></font>
    ssl_protocols TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;
    <span class="hljs-attribute">ssl_ciphers</span> <span class="hljs-string">'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA'</span>;<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    ssl_prefer_server_ciphers <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">5m</span>;
    <span class="hljs-attribute">ssl_session_cache</span> shared:SSL:<span class="hljs-number">50m</span>;
    <span class="hljs-attribute">ssl_session_tickets</span> <span class="hljs-literal">off</span>;<font></font>
<font></font>
        {{ <span class="hljs-attribute">if</span> (and (exists (printf <span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/fullchain.pem"</span> <span class="hljs-variable">$cert</span>)) (exists (printf <span class="hljs-string">"/etc/nginx/certs/letsencrypt/live/%s/privkey.pem"</span> <span class="hljs-variable">$cert</span>))) }}<font></font>
    ssl_certificate /etc/nginx/certs/letsencrypt/live/{{ (<span class="hljs-attribute">printf</span> <span class="hljs-string">"%s/fullchain.pem"</span> <span class="hljs-variable">$cert</span>) }};
    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/certs/letsencrypt/live/{{ (<span class="hljs-attribute">printf</span> <span class="hljs-string">"%s/privkey.pem"</span> <span class="hljs-variable">$cert</span>) }};<font></font>
        {{ <span class="hljs-attribute">else</span> if (and (exists (printf <span class="hljs-string">"/etc/nginx/certs/%s.crt"</span> <span class="hljs-variable">$cert</span>)) (exists (printf <span class="hljs-string">"/etc/nginx/certs/%s.key"</span> <span class="hljs-variable">$cert</span>))) }}<font></font>
    ssl_certificate /etc/nginx/certs/{{ (<span class="hljs-attribute">printf</span> <span class="hljs-string">"%s.crt"</span> <span class="hljs-variable">$cert</span>) }};
    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/certs/{{ (<span class="hljs-attribute">printf</span> <span class="hljs-string">"%s.key"</span> <span class="hljs-variable">$cert</span>) }};<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    {{ <span class="hljs-attribute">if</span> (exists (printf <span class="hljs-string">"/etc/nginx/certs/%s.dhparam.pem"</span> <span class="hljs-variable">$cert</span>)) }}<font></font>
    ssl_dhparam {{ <span class="hljs-attribute">printf</span> <span class="hljs-string">"/etc/nginx/certs/%s.dhparam.pem"</span> <span class="hljs-variable">$cert</span> }};<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    {{ <span class="hljs-attribute">if</span> (exists (printf <span class="hljs-string">"/etc/nginx/certs/%s.chain.pem"</span> <span class="hljs-variable">$cert</span>)) }}<font></font>
    ssl_stapling <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">ssl_stapling_verify</span> <span class="hljs-literal">on</span>;
    <span class="hljs-section">ssl_trusted_certificate</span> {{ <span class="hljs-attribute">printf</span> <span class="hljs-string">"/etc/nginx/certs/%s.chain.pem"</span> <span class="hljs-variable">$cert</span> }};<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    {{ <span class="hljs-attribute">if</span> (and (ne <span class="hljs-variable">$https_method</span> <span class="hljs-string">"noredirect"</span>) (ne <span class="hljs-variable">$hsts</span> <span class="hljs-string">"off"</span>)) }}<font></font>
    add_header Strict-Transport-Security <span class="hljs-string">"{{ trim <span class="hljs-variable">$hsts</span> }}"</span> always;<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    {{ <span class="hljs-attribute">if</span> (exists (printf <span class="hljs-string">"/etc/nginx/vhost.d/%s"</span> <span class="hljs-variable">$host</span>)) }}<font></font>
    include {{ <span class="hljs-attribute">printf</span> <span class="hljs-string">"/etc/nginx/vhost.d/%s"</span> <span class="hljs-variable">$host</span> }};<font></font>
    {{ <span class="hljs-attribute">else</span> if (exists <span class="hljs-string">"/etc/nginx/vhost.d/default"</span>) }}<font></font>
    include /etc/nginx/vhost.d/default;<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
        {{ <span class="hljs-attribute">if</span> (<span class="hljs-variable">$ext_ldap_auth</span>) }}
        <span class="hljs-comment">### LDAP</span><font></font>
<font></font>
        {{ <span class="hljs-attribute">if</span> (<span class="hljs-variable">$ldap_use_login_page</span>) }}<font></font>
        location /login-ldap {<font></font>
            <span class="hljs-attribute">proxy_pass</span> http://{{ $.Env.<span class="hljs-attribute">LDAP_BACKEND</span> }}:{{ <span class="hljs-attribute">or</span> $.Env.LDAP_LOGIN_PORT <span class="hljs-string">"9000"</span> }};
                <span class="hljs-comment"># Login service returns a redirect to the original URI</span>
                <span class="hljs-comment"># and sets the cookie for the ldap-auth daemon</span>
                <span class="hljs-attribute">proxy_set_header</span> X-Target <span class="hljs-variable">$request_uri</span>;<font></font>
<font></font>
                <span class="hljs-attribute">proxy_pass_request_body</span> <span class="hljs-literal">off</span>;
                <span class="hljs-attribute">proxy_set_header</span> Content-Length <span class="hljs-string">""</span>;
                <span class="hljs-attribute">proxy_cache</span> auth_cache;
                <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">10m</span>;<font></font>
<font></font>
                <span class="hljs-attribute">proxy_cache_key</span> <span class="hljs-string">"<span class="hljs-variable">$http_authorization</span><span class="hljs-variable">$cookie_nginxauth</span>"</span>;<font></font>
<font></font>
                <span class="hljs-attribute">proxy_set_header</span> X-CookieName <span class="hljs-string">"nginxauth"</span>;
                <span class="hljs-attribute">proxy_set_header</span> Cookie nginxauth=<span class="hljs-variable">$cookie_nginxauth</span>;<font></font>
        }<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    location = /auth-proxy {<font></font>
        internal;<font></font>
<font></font>
                <span class="hljs-comment"># The ldap-auth daemon listens on port $LDAP_BACKEND_PORT (8888, by default), as set</span>
                <span class="hljs-comment"># in nginx-ldap-auth-daemon.py.</span>
                <span class="hljs-comment"># Change the IP address if the daemon is not running on</span>
                <span class="hljs-comment"># the same host as NGINX/NGINX Plus.</span>
                <span class="hljs-attribute">proxy_pass</span> http://{{ $.Env.<span class="hljs-attribute">LDAP_BACKEND</span> }}:{{ <span class="hljs-attribute">or</span> $.Env.LDAP_BACKEND_PORT <span class="hljs-string">"8888"</span> }};<font></font>
<font></font>
                <span class="hljs-attribute">proxy_pass_request_body</span> <span class="hljs-literal">off</span>;
                <span class="hljs-attribute">proxy_set_header</span> Content-Length <span class="hljs-string">""</span>;
                <span class="hljs-attribute">proxy_cache</span> auth_cache;
                <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">10m</span>;<font></font>
<font></font>
                <span class="hljs-comment"># The following directive adds the cookie to the cache key</span>
                <span class="hljs-attribute">proxy_cache_key</span> <span class="hljs-string">"<span class="hljs-variable">$http_authorization</span><span class="hljs-variable">$cookie_nginxauth</span>"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># As implemented in nginx-ldap-auth-daemon.py, the ldap-auth daemon</span>
                <span class="hljs-comment"># communicates with a LDAP server, passing in the following</span>
                <span class="hljs-comment"># parameters to specify which user account to authenticate. To</span>
                <span class="hljs-comment"># eliminate the need to modify the Python code, this file contains</span>
                <span class="hljs-comment"># 'proxy_set_header' directives that set the values of the</span>
                <span class="hljs-comment"># parameters. Set or change them as instructed in the comments.</span>
                <span class="hljs-comment">#</span>
                <span class="hljs-comment">#    Parameter      Proxy header</span>
                <span class="hljs-comment">#    -----------    ----------------</span>
                <span class="hljs-comment">#    url            X-Ldap-URL</span>
                <span class="hljs-comment">#    starttls       X-Ldap-Starttls</span>
                <span class="hljs-comment">#    basedn         X-Ldap-BaseDN</span>
                <span class="hljs-comment">#    binddn         X-Ldap-BindDN</span>
                <span class="hljs-comment">#    bindpasswd     X-Ldap-BindPass</span>
                <span class="hljs-comment">#    cookiename     X-CookieName</span>
                <span class="hljs-comment">#    realm          X-Ldap-Realm</span>
                <span class="hljs-comment">#    template       X-Ldap-Template</span><font></font>
<font></font>
                <span class="hljs-comment"># (Required) Set the URL and port for connecting to the LDAP server,</span>
                <span class="hljs-comment"># by replacing 'example.com'.</span>
                <span class="hljs-comment"># Do not mix ldaps-style URL and X-Ldap-Starttls as it will not work.</span>
                <span class="hljs-attribute">proxy_set_header</span> X-Ldap-URL      <span class="hljs-string">"{{ $.Env.LDAP_HOST }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Optional) Establish a TLS-enabled LDAP session after binding to the</span>
                <span class="hljs-comment"># LDAP server.</span>
                <span class="hljs-comment"># This is the 'proper' way to establish encrypted TLS connections, see</span>
                <span class="hljs-comment"># http://www.openldap.org/faq/data/cache/185.html</span>
                {{ <span class="hljs-attribute">if</span> eq (<span class="hljs-string">"$.Env.LDAP_METHOD"</span>) <span class="hljs-string">"start_tls"</span> }}<font></font>
                proxy_set_header X-Ldap-Starttls <span class="hljs-string">"true"</span>;<font></font>
                {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
                <span class="hljs-comment"># (Required) Set the Base DN, by replacing the value enclosed in</span>
                <span class="hljs-comment"># double quotes.</span>
                proxy_set_header X-Ldap-BaseDN   <span class="hljs-string">"{{ $.Env.LDAP_BASE }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Required) Set the Bind DN, by replacing the value enclosed in</span>
                <span class="hljs-comment"># double quotes.</span>
                <span class="hljs-attribute">proxy_set_header</span> X-Ldap-BindDN   <span class="hljs-string">"{{ $.Env.LDAP_BIND_DN }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Required) Set the Bind password, by replacing 'secret'.</span>
                <span class="hljs-attribute">proxy_set_header</span> X-Ldap-BindPass <span class="hljs-string">"{{ $.Env.LDAP_PASS }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Required) The following directives set the cookie name and pass</span>
                <span class="hljs-comment"># it, respectively. They are required for cookie-based</span>
                <span class="hljs-comment"># authentication. Comment them out if using HTTP basic</span>
                <span class="hljs-comment"># authentication.</span>
                <span class="hljs-attribute">proxy_set_header</span> X-CookieName <span class="hljs-string">"nginxauth"</span>;
                <span class="hljs-attribute">proxy_set_header</span> Cookie nginxauth=<span class="hljs-variable">$cookie_nginxauth</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Required if using Microsoft Active Directory as the LDAP server)</span>
                <span class="hljs-comment"># Set the LDAP template by uncommenting the following directive.</span>
                <span class="hljs-comment">#proxy_set_header X-Ldap-Template "(sAMAccountName=%(username)s)";</span><font></font>
<font></font>
                <span class="hljs-comment"># (May be required if using Microsoft Active Directory and</span>
                <span class="hljs-comment"># getting "In order to perform this operation a successful bind</span>
                <span class="hljs-comment"># must be completed on the connection." errror)</span>
                <span class="hljs-comment">#proxy_set_header X-Ldap-DisableReferrals "true";</span><font></font>
<font></font>
                <span class="hljs-comment"># (Optional if using OpenLDAP as the LDAP server) Set the LDAP</span>
                <span class="hljs-comment"># template by uncommenting the following directive and replacing</span>
                <span class="hljs-comment"># '(cn=%(username)s)' which is the default set in</span>
                <span class="hljs-comment"># nginx-ldap-auth-daemon.py.</span>
                {{ $<span class="hljs-attribute">ldap_filter</span> := $.Env.LDAP_USER_FILTER }}<font></font>
                {{ $<span class="hljs-attribute">ldap_filter</span> := (printf <span class="hljs-string">"(&amp;%s%s)"</span> <span class="hljs-variable">$ldap_filter</span> <span class="hljs-variable">$ldap_add_groups</span>) }}<font></font>
<font></font>
                proxy_set_header X-Ldap-Template <span class="hljs-string">"{{ <span class="hljs-variable">$ldap_filter</span> }}"</span>;<font></font>
<font></font>
                <span class="hljs-comment"># (Optional) Set the realm name, by uncommenting the following</span>
                <span class="hljs-comment"># directive and replacing 'Restricted' which is the default set</span>
                <span class="hljs-comment"># in nginx-ldap-auth-daemon.py.</span>
                <span class="hljs-comment">#proxy_set_header X-Ldap-Realm    "Restricted";</span><font></font>
        }<font></font>
        <span class="hljs-comment">### /LDAP</span>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    location / {<font></font>
                {{ <span class="hljs-attribute">if</span> (<span class="hljs-variable">$ext_ldap_auth</span>) }}<font></font>
        auth_request /auth-proxy;<font></font>
<font></font>
        {{ <span class="hljs-attribute">if</span> (<span class="hljs-variable">$ldap_use_login_page</span>) }}
        <span class="hljs-comment"># redirect 401 to login form</span>
        <span class="hljs-comment"># Comment them out if using HTTP basic authentication.</span>
        <span class="hljs-comment"># or authentication popup won't show</span>
        error_page <span class="hljs-number">401</span> =<span class="hljs-number">200</span> /login-ldap;<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
        {{ <span class="hljs-attribute">if</span> eq <span class="hljs-variable">$proto</span> <span class="hljs-string">"uwsgi"</span> }}<font></font>
        include uwsgi_params;<font></font>
        <span class="hljs-section">uwsgi_pass</span> {{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$proto</span> }}://{{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$upstream_name</span> }};<font></font>
        {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$proto</span> <span class="hljs-string">"fastcgi"</span> }}<font></font>
        root   {{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$vhost_root</span> }};
        <span class="hljs-attribute">include</span> fastcgi.conf;
        <span class="hljs-section">fastcgi_pass</span> {{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$upstream_name</span> }};<font></font>
        {{ <span class="hljs-attribute">else</span> }}<font></font>
        proxy_pass {{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$proto</span> }}://{{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$upstream_name</span> }};<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
        {{ <span class="hljs-attribute">if</span> (exists (printf <span class="hljs-string">"/etc/nginx/htpasswd/%s"</span> <span class="hljs-variable">$host</span>)) }}<font></font>
        auth_basic  <span class="hljs-string">"Restricted {{ <span class="hljs-variable">$host</span> }}"</span>;
        <span class="hljs-section">auth_basic_user_file</span>    {{ (<span class="hljs-attribute">printf</span> <span class="hljs-string">"/etc/nginx/htpasswd/%s"</span> <span class="hljs-variable">$host</span>) }};<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
        {{ <span class="hljs-attribute">if</span> (exists (printf <span class="hljs-string">"/etc/nginx/vhost.d/%s_location"</span> <span class="hljs-variable">$host</span>)) }}<font></font>
        include {{ <span class="hljs-attribute">printf</span> <span class="hljs-string">"/etc/nginx/vhost.d/%s_location"</span> <span class="hljs-variable">$host</span>}};<font></font>
        {{ <span class="hljs-attribute">else</span> if (exists <span class="hljs-string">"/etc/nginx/vhost.d/default_location"</span>) }}<font></font>
        include /etc/nginx/vhost.d/default_location;<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
    }<font></font>
}<font></font>
<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
{{ <span class="hljs-attribute">if</span> or (not <span class="hljs-variable">$is_https</span>) (eq <span class="hljs-variable">$https_method</span> <span class="hljs-string">"noredirect"</span>) }}<font></font>
<font></font>
server {<font></font>
    <span class="hljs-section">server_name</span> {{ $<span class="hljs-attribute">host</span> }};
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> {{ $<span class="hljs-attribute">default_server</span> }};<font></font>
    {{ <span class="hljs-attribute">if</span> <span class="hljs-variable">$enable_ipv6</span> }}<font></font>
    listen [::]:<span class="hljs-number">80</span> {{ $<span class="hljs-attribute">default_server</span> }};<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
    access_log /var/log/nginx/access.log vhost;<font></font>
<font></font>
    {{ <span class="hljs-attribute">if</span> eq <span class="hljs-variable">$network_tag</span> <span class="hljs-string">"internal"</span> }}
    <span class="hljs-comment"># Only allow traffic from internal clients</span><font></font>
    include /etc/nginx/network_internal.conf;<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    {{ <span class="hljs-attribute">if</span> (exists (printf <span class="hljs-string">"/etc/nginx/vhost.d/%s"</span> <span class="hljs-variable">$host</span>)) }}<font></font>
    include {{ <span class="hljs-attribute">printf</span> <span class="hljs-string">"/etc/nginx/vhost.d/%s"</span> <span class="hljs-variable">$host</span> }};<font></font>
    {{ <span class="hljs-attribute">else</span> if (exists <span class="hljs-string">"/etc/nginx/vhost.d/default"</span>) }}<font></font>
    include /etc/nginx/vhost.d/default;<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
    location / {<font></font>
        {{ <span class="hljs-attribute">if</span> eq <span class="hljs-variable">$proto</span> <span class="hljs-string">"uwsgi"</span> }}<font></font>
        include uwsgi_params;<font></font>
        <span class="hljs-section">uwsgi_pass</span> {{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$proto</span> }}://{{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$upstream_name</span> }};<font></font>
        {{ <span class="hljs-attribute">else</span> if eq <span class="hljs-variable">$proto</span> <span class="hljs-string">"fastcgi"</span> }}<font></font>
        root   {{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$vhost_root</span> }};
        <span class="hljs-attribute">include</span> fastcgi.conf;
        <span class="hljs-section">fastcgi_pass</span> {{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$upstream_name</span> }};<font></font>
        {{ <span class="hljs-attribute">else</span> }}<font></font>
        proxy_pass {{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$proto</span> }}://{{ <span class="hljs-attribute">trim</span> <span class="hljs-variable">$upstream_name</span> }};<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
        {{ <span class="hljs-attribute">if</span> (exists (printf <span class="hljs-string">"/etc/nginx/htpasswd/%s"</span> <span class="hljs-variable">$host</span>)) }}<font></font>
        auth_basic  <span class="hljs-string">"Restricted {{ <span class="hljs-variable">$host</span> }}"</span>;
        <span class="hljs-section">auth_basic_user_file</span>    {{ (<span class="hljs-attribute">printf</span> <span class="hljs-string">"/etc/nginx/htpasswd/%s"</span> <span class="hljs-variable">$host</span>) }};<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
        {{ <span class="hljs-attribute">if</span> (exists (printf <span class="hljs-string">"/etc/nginx/vhost.d/%s_location"</span> <span class="hljs-variable">$host</span>)) }}<font></font>
        include {{ <span class="hljs-attribute">printf</span> <span class="hljs-string">"/etc/nginx/vhost.d/%s_location"</span> <span class="hljs-variable">$host</span>}};<font></font>
        {{ <span class="hljs-attribute">else</span> if (exists <span class="hljs-string">"/etc/nginx/vhost.d/default_location"</span>) }}<font></font>
        include /etc/nginx/vhost.d/default_location;<font></font>
        {{ <span class="hljs-attribute">end</span> }}<font></font>
    }<font></font>
}<font></font>
<font></font>
{{ <span class="hljs-attribute">if</span> (and (not <span class="hljs-variable">$is_https</span>) (exists <span class="hljs-string">"/etc/nginx/certs/default.crt"</span>) (exists <span class="hljs-string">"/etc/nginx/certs/default.key"</span>)) }}<font></font>
server {<font></font>
    <span class="hljs-section">server_name</span> {{ $<span class="hljs-attribute">host</span> }};
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2 {{ $<span class="hljs-attribute">default_server</span> }};<font></font>
    {{ <span class="hljs-attribute">if</span> <span class="hljs-variable">$enable_ipv6</span> }}<font></font>
    listen [::]:<span class="hljs-number">443</span> ssl http2 {{ $<span class="hljs-attribute">default_server</span> }};<font></font>
    {{ <span class="hljs-attribute">end</span> }}<font></font>
    access_log /var/log/nginx/access.log vhost;<font></font>
    <span class="hljs-attribute">return</span> <span class="hljs-number">500</span>;<font></font>
<font></font>
    <span class="hljs-attribute">ssl_certificate</span> /etc/nginx/certs/default.crt;
    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/certs/default.key;<font></font>
}<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
<font></font>
{{ <span class="hljs-attribute">end</span> }}<font></font>
{{ <span class="hljs-attribute">end</span> }}</code></pre></div></div><br>
<h3 id="modifikaciya-konfiguracii-docker-compose">  docker-compose</h3><br>
<p> <code>docker-compose.yml</code>  :</p><br>
<ul>
<li>  "ldap-auth",    .</li>
<li> ,    LDAP .</li>
</ul><br>
<p>    , nginx     HTTP .<br>
     ,        .<br>
   .</p><br>
<div class="spoiler"><b class="spoiler_title">docker-compose.yml</b><div class="spoiler_text"><pre><code class="plaintext hljs">version: '2'<font></font>
<font></font>
networks:<font></font>
  internal:<font></font>
  docker0:<font></font>
    external:<font></font>
      name: docker0<font></font>
<font></font>
services:<font></font>
  ldap-auth:<font></font>
    image: linuxserver/ldap-auth:latest<font></font>
    container_name: ldap-auth<font></font>
    networks:<font></font>
      - internal<font></font>
      - docker0<font></font>
    environment:<font></font>
      - TZ=Europe/Moscow<font></font>
    expose:<font></font>
      - 8888<font></font>
      - 9000<font></font>
    restart: unless-stopped<font></font>
<font></font>
  nginx-proxy:<font></font>
    depends_on:<font></font>
      - ldap-auth<font></font>
    networks:<font></font>
      - internal<font></font>
      - docker0<font></font>
    restart: always<font></font>
    image: jwilder/nginx-proxy<font></font>
    ports:<font></font>
      - "80:80"<font></font>
      - "443:443"<font></font>
    volumes:<font></font>
      - ./certs:/etc/nginx/certs:ro<font></font>
      - ./vhost.d:/etc/nginx/vhost.d<font></font>
      - ./html:/usr/share/nginx/html<font></font>
      - /var/run/docker.sock:/tmp/docker.sock:ro<font></font>
      - ./local-config:/etc/nginx/conf.d<font></font>
      - ./nginx.tmpl:/app/nginx.tmpl<font></font>
    environment:<font></font>
      - DEFAULT_HOST=nas.nas<font></font>
      - LDAP_BACKEND=ldap-auth<font></font>
      #- LDAP_BACKEND_PORT=8888<font></font>
      #- LDAP_LOGIN_PORT=9000<font></font>
      - LDAP_HOST=ldap://172.21.0.1:389<font></font>
      #- LDAP_METHOD=start_tls<font></font>
      - LDAP_METHOD=plain<font></font>
      - LDAP_UID=uid<font></font>
      - LDAP_PASS=LDAP_PASSWORD<font></font>
      - LDAP_BASE=ou=users,dc=nas,dc=nas<font></font>
      - LDAP_BIND_DN=cn=readonly,dc=nas,dc=nas<font></font>
      - LDAP_USER_FILTER=(uid=%(username)s)<font></font>
      #- LDAP_USE_LOGIN_PAGE=true<font></font>
<font></font>
    labels:<font></font>
      - "com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"<font></font>
<font></font>
  letsencrypt-dns:<font></font>
    image: adferrand/letsencrypt-dns<font></font>
    restart: always<font></font>
    volumes:<font></font>
      - ./certs/letsencrypt:/etc/letsencrypt<font></font>
    environment:<font></font>
      - "LETSENCRYPT_USER_MAIL=MAIL@MAIL.COM"<font></font>
      - "LEXICON_PROVIDER=cloudns"<font></font>
      - "LEXICON_OPTIONS=--delegated NAS.cloudns.cc"<font></font>
      - "LEXICON_PROVIDER_OPTIONS=--auth-id=CLOUDNS_ID --auth-password=CLOUDNS_PASSWORD"</code></pre></div></div><br>
<h2 id="ispolzovanie-servisom"> </h2><br>
<p>    .<br>
         :</p><br>
<ul>
<li><code>LDAP_EXT_AUTH=true</code> —  .</li>
<li><code>LDAP_EXT_ADD_GROUPS=(memberOf=cn=users_cloud,ou=groups,dc=nas,dc=nas)</code> —  ,  ,      ,   .     .</li>
</ul><br>
<pre><code class="plaintext hljs">   environment:<font></font>
      - LDAP_EXT_AUTH=true<font></font>
      - LDAP_EXT_ADD_GROUPS=(memberOf=cn=users_cloud,ou=groups,dc=nas,dc=nas)</code></pre><br>
<h2 id="zaklyuchenie"></h2><br>
<p> ,          ,   .<br>
    NAS    ,         LDAP.</p><br>
<p>   :</p><br>
<ul>
<li>        HTML ,   <code>ldap_use_login_page</code>.       .   — .</li>
<li>   .     LDAP ,   ,   docker-gen      .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスは独立しており、各サービスは個別のサブドメインです。</font><font style="vertical-align: inherit;">また、まだ認証されていないサービスにアクセスするたびにユーザー名とパスワードを入力する必要があり、面倒です。</font><font style="vertical-align: inherit;">将来的には、私は単一の認証センターを作るでしょう。</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NAS設定は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で確認でき</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja456880/index.html">Math.RoundがTry .NETのブラウザーから印刷ウィンドウを開くのはなぜですか</a></li>
<li><a href="../ja456886/index.html">ASOチェックリスト：何も見落とさない方法</a></li>
<li><a href="../ja456888/index.html">衛星が地球の大気中で溶ける方法</a></li>
<li><a href="../ja456890/index.html">stm32のIRリモートコントロール</a></li>
<li><a href="../ja456892/index.html">Webアプリケーションの脆弱性を探す方法：8つの一般的なスキャナーの比較</a></li>
<li><a href="../ja456896/index.html">歪んだキャッシュによるTorネットワークのユーザーの実際のIPアドレスの識別</a></li>
<li><a href="../ja456898/index.html">テーブルを使用した高速整数乗算</a></li>
<li><a href="../ja456902/index.html">安全なプッシュ通知：理論から実践まで</a></li>
<li><a href="../ja456904/index.html">Webプロジェクトの負荷テスト-現金なし</a></li>
<li><a href="../ja456908/index.html">TelegramがどのようにRostelecomにマージするか</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>