<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶â üõÄüèª ‚õ∑Ô∏è Hash + cache: otimiza√ß√£o do processamento de fluxo üì¢ ü§üüèª ‚òÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O que devo fazer se quiser anotar muitos ‚Äúfatos‚Äù no banco de dados com um volume muito maior do que ele pode suportar? Primeiro, √© claro, trazemos os ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hash + cache: otimiza√ß√£o do processamento de fluxo</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498830/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que devo fazer se quiser anotar muitos ‚Äúfatos‚Äù no banco de dados com um volume muito maior do que ele pode suportar? Primeiro, √© claro, trazemos os dados para uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forma normal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mais econ√¥mica </font><font style="vertical-align: inherit;">e obtemos ‚Äúdicion√°rios‚Äù, que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escreveremos uma vez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mas como fazer isso de forma mais eficaz? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa √© exatamente a quest√£o que enfrentamos ao desenvolver o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monitoramento e a an√°lise dos logs do servidor PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , quando outros </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todos de otimiza√ß√£o do registro no banco de dados</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> foram esgotados.</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0y/34/cp/0y34cps5t4nqozitxa0xb7urypm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faremos </font><font style="vertical-align: inherit;">
uma reserva imediata de que nossos coletores est√£o executando o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , para n√£o interagirmos com os registros e caches do processador de nenhuma maneira. </font><font style="vertical-align: inherit;">E a op√ß√£o de usar "centenas" ou servi√ßos / bancos de dados em cache externos oferece muito atraso para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fluxos de entrada de v√°rias centenas de Mbps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, tentamos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">armazenar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em </font><b><font style="vertical-align: inherit;">cache tudo na RAM</font></b><font style="vertical-align: inherit;"> , especificamente na mem√≥ria do processo JavaScript. </font><font style="vertical-align: inherit;">Sobre como organizar isso de forma mais eficiente, e iremos al√©m.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache de disponibilidade</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nossa principal tarefa √© garantir que a √∫nica inst√¢ncia de qualquer objeto entre no banco de dados. Estes s√£o os textos originais repetidamente repetidos de consultas SQL, modelos de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">planos para sua implementa√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , n√≥s desses planos - em resumo, alguns </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocos de texto</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Historicamente, como identificador, usamos um </font></font><code>UUID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor-, obtido como resultado do c√°lculo direto do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash MD5 a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> partir do texto do objeto. Depois disso, verificamos a disponibilidade desse hash no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"dicion√°rio"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> local </font><b><font style="vertical-align: inherit;">na mem√≥ria do processo</font></b><font style="vertical-align: inherit;"> e, se n√£o estiver l√°, somente ent√£o escrevemos no banco de dados na tabela "dicion√°rio".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, n√£o precisamos armazenar o valor do texto original (e √†s vezes leva dezenas de kilobytes) - apenas o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fato da presen√ßa do hash correspondente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no dicion√°rio </font><font style="vertical-align: inherit;">√© suficiente </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dicion√°rio de Chaves</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse dicion√°rio pode ser mantido </font></font><code>Array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e usado </font></font><code>Array.includes()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para verificar a disponibilidade, mas isso √© bastante redundante - a pesquisa diminui (pelo menos nas vers√µes anteriores do V8) linearmente do tamanho da matriz, O (N). </font><font style="vertical-align: inherit;">E nas implementa√ß√µes modernas, apesar de todas as otimiza√ß√µes, perde a uma velocidade de 2-3%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, na era pr√©-ES6, o armazenamento era a solu√ß√£o tradicional </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, com valores armazenados como chaves. </font><font style="vertical-align: inherit;">Mas todos atribu√≠ram os valores das chaves ao que ele queria - por exemplo </font></font><code>Boolean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> dict = {};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span>(<span class="hljs-params">key</span>) </span>{
  <span class="hljs-keyword">return</span> dict[key] !== <span class="hljs-literal">undefined</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">key</span>) </span>{<font></font>
  dict[key] = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas √© √≥bvio que estamos armazenando claramente o excesso aqui - o pr√≥prio valor da chave que ningu√©m precisa. Mas e se n√£o estiver armazenado? Ent√£o o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objeto Set</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apareceu </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os testes mostram que a pesquisa com ajuda √© </font></font><code>Set.has()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aproximadamente 20 a 25% mais r√°pida que a verifica√ß√£o de chaves c </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mas essa n√£o √© sua √∫nica vantagem. Como armazenamos menos, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precisamos de menos mem√≥ria</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - e isso afeta diretamente o desempenho quando se trata de centenas de milhares dessas chaves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em que existem 100 chaves UUID em uma representa√ß√£o de texto, ele ocupa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.216 bytes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na mem√≥ria </font><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1e/n6/ge/1en6gefozucw86wki6odp-j3ria.png"><br>
<br>
<code>Set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com o mesmo conte√∫do - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.632 bytes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/59/cb/ri59cbgqbmmbqhivlopro2gspuu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, </font></font><code>Set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciona mais r√°pido e ao mesmo tempo leva</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2,5 vezes menos mem√≥ria</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o vencedor √© √≥bvio.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otimizamos o armazenamento de chaves UUID</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, na natureza dos sistemas distribu√≠dos, as chaves UUID s√£o bastante comuns - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em nosso VLSI,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> elas s√£o, no m√≠nimo, usadas para identificar documentos e regulamentos no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gerenciamento de documentos eletr√¥nicos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pessoas em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mensagens</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, vamos ver mais de perto a figura acima - cada UUID √© a chave armazenada na representa√ß√£o hexadecimal ‚Äúcusta‚Äù </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">56 bytes de mem√≥ria</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mas como temos centenas de milhares deles, √© razo√°vel perguntar: "√â poss√≠vel ter menos?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, lembre-se de que o UUID √© um identificador de 16 bytes. Essencialmente, um peda√ßo de dados bin√°rios. E para transmiss√£o por email, por exemplo, os dados bin√°rios s√£o codificados em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base64</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tente aplic√°-los:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> str = Buffer.from(uuidstr, <span class="hljs-string">'hex'</span>).toString(<span class="hljs-string">'base64'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/pd/jc/ks/pdjckslsoycw92xnx4moahgmweg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J√° 48 bytes cada um s√£o melhores, mas imperfeitos. </font><font style="vertical-align: inherit;">Vamos tentar traduzir a representa√ß√£o hexadecimal diretamente em uma string:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> str = Buffer.from(uuidstr, <span class="hljs-string">'hex'</span>).toString(<span class="hljs-string">'binary'</span>);</code></pre><br>
<img src="https://habrastorage.org/webt/6i/nn/_5/6inn_5k8y3pnogatsv-r5ntrdzo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez de 56 bytes por chave - 40 bytes, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">economizando quase 30%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mestre, trabalhador - onde armazenar dicion√°rios?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considerando que os dados de vocabul√°rio dos trabalhadores se cruzam fortemente, fizemos o armazenamento dos dicion√°rios e os escrevemos no banco de dados no processo mestre e a transmiss√£o de dados dos trabalhadores atrav√©s </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do mecanismo de mensagens do IPC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, uma parte significativa do tempo do mestre foi gasta, </font></font><code>channel.onread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou seja, processando o recebimento de pacotes com informa√ß√µes de "dicion√°rio" de processos filhos:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/kr/nr/sdkrnrm1c_amswktwm57kl3qsfo.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Barreira de grava√ß√£o de conjunto duplo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos pensar por um segundo - os trabalhadores enviam e enviam ao mestre os mesmos dados de vocabul√°rio (basicamente, esses s√£o os modelos de plano e os corpos de solicita√ß√£o repetidos), ele os analisa com o suor e ... n√£o faz nada, porque eles j√° foram enviados ao banco de dados antes ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, se </font></font><code>Set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"protegemos" o banco de dados da regrava√ß√£o do mestre com um dicion√°rio, por que n√£o usar a mesma abordagem para "proteger" o mestre de ser transferido do trabalhador? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, isso foi feito e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduzimos os custos diretos de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manuten√ß√£o do canal de troca </font><b><font style="vertical-align: inherit;">tr√™s vezes</font></b><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y1/h4/aj/y1h4ajs-o3hdg1xfoyf9j_kflpc.png"><br>
<br>
<img src="https://habrastorage.org/webt/vl/be/na/vlbenalj_sd_2jk36xdkhaouhp8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas agora os trabalhadores parecem fazer mais trabalho - armazenar dicion√°rios e filtrar por eles? </font><font style="vertical-align: inherit;">Ou n√£o? .. De fato, eles come√ßaram a trabalhar significativamente menos, j√° que a transfer√™ncia de grandes volumes (mesmo via IPC!) N√£o √© barata.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dz/7k/mb/dz7kmbdj5jnirhajahmwrpcwzfw.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nice bonus</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde que o assistente agora come√ßou a receber uma quantidade muito menor de informa√ß√µes, come√ßou a alocar muito menos mem√≥ria para esses cont√™ineres - o que significa que o tempo gasto no trabalho do Garbage Collector diminuiu significativamente, o que afetou positivamente a lat√™ncia do sistema como um todo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fg/af/el/fgafel26_6der0h-knhglqckt8k.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse esquema fornece prote√ß√£o contra entradas repetidas no n√≠vel do coletor, mas e se tivermos v√°rios coletores? </font><font style="vertical-align: inherit;">Somente o gatilho com ajudar√° aqui </font></font><code>INSERT ... ON CONFLICT DO NOTHING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acelerar o c√°lculo de hash</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nossa arquitetura, todo o fluxo de logs de um servidor PostgreSQL √© processado por um trabalhador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, um servidor √© uma tarefa para o trabalhador. Ao mesmo tempo, o carregamento de trabalhadores √© equilibrado pelo objetivo das tarefas do servidor, para que o consumo de CPU pelos trabalhadores de todos os coletores seja aproximadamente o mesmo. Este √© um distribuidor de servi√ßos separado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚ÄúEm m√©dia‚Äù, cada trabalhador lida com dezenas de tarefas que produzem aproximadamente a mesma carga total. No entanto, existem servidores que superam significativamente o restante no n√∫mero de entradas de log. E mesmo que o expedidor deixe essa tarefa como a √∫nica no trabalhador, seu download √© muito maior que os outros:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ol/p1/9a/olp19ahpqzn4e5aaek0oyg1tjt0.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Removemos o perfil da CPU deste trabalhador: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/zk/fs/2qzkfsaqceti_tietxizjhfmioi.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nas linhas superiores, o c√°lculo dos hashes MD5. </font><font style="vertical-align: inherit;">E eles s√£o realmente calculados uma quantidade enorme - para todo o fluxo de objetos recebidos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xxHash</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como otimizar esta parte, exceto por esses hashes, n√£o podemos? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidimos tentar outra fun√ß√£o de hash - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xxHash</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que implementa o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">algoritmo de hash n√£o criptogr√°fico extremamente r√°pido</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">E o m√≥dulo para o Node.js √© o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xxhash-addon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que usa a vers√£o mais recente da biblioteca xxHash 0.7.3 com o novo algoritmo XXH3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verifique executando cada op√ß√£o em um conjunto de linhas de diferentes comprimentos:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">const</span> { XXHash3, XXHash64 } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'xxhash-addon'</span>);
<span class="hljs-keyword">const</span> hasher3 = <span class="hljs-keyword">new</span> XXHash3(<span class="hljs-number">0xDEADBEAF</span>);
<span class="hljs-keyword">const</span> hasher64 = <span class="hljs-keyword">new</span> XXHash64(<span class="hljs-number">0xDEADBEAF</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> buf = Buffer.allocUnsafe(<span class="hljs-number">16</span>);
<span class="hljs-keyword">const</span> getBinFromHash = <span class="hljs-function">(<span class="hljs-params">hash</span>) =&gt;</span> buf.fill(hash, <span class="hljs-string">'hex'</span>).toString(<span class="hljs-string">'binary'</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> funcs = {
  <span class="hljs-attr">xxhash64</span> : <span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> hasher64.hash(Buffer.from(str)).toString(<span class="hljs-string">'binary'</span>)<font></font>
, <span class="hljs-attr">xxhash3</span>  : <span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> hasher3.hash(Buffer.from(str)).toString(<span class="hljs-string">'binary'</span>)<font></font>
, <span class="hljs-attr">md5</span>      : <span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> getBinFromHash(crypto.createHash(<span class="hljs-string">'md5'</span>).update(str).digest(<span class="hljs-string">'hex'</span>))<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> check = <span class="hljs-function">(<span class="hljs-params">hash</span>) =&gt;</span> {
  <span class="hljs-keyword">let</span> log = [];
  <span class="hljs-keyword">let</span> cnt = <span class="hljs-number">10000</span>;
  <span class="hljs-keyword">while</span> (cnt--) log.push(crypto.randomBytes(cnt).toString(<span class="hljs-string">'hex'</span>));<font></font>
<font></font>
  <span class="hljs-built_in">console</span>.time(hash);<font></font>
  log.forEach(funcs[hash]);<font></font>
  <span class="hljs-built_in">console</span>.timeEnd(hash);<font></font>
};<font></font>
<font></font>
<span class="hljs-built_in">Object</span>.keys(funcs).forEach(check);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resultados:</font></font><br>
<pre><code class="plaintext hljs">xxhash64 : 148.268ms<font></font>
xxhash3  : 108.337ms<font></font>
md5      : 317.584ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esperado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o xxhash3 foi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muito mais r√°pido que o MD5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resta verificar se h√° resist√™ncia a colis√µes. </font><font style="vertical-align: inherit;">Se√ß√µes de tabelas de dicion√°rios est√£o sendo criadas para n√≥s todos os dias, portanto, fora dos limites do dia, podemos permitir com seguran√ßa a interse√ß√£o de hashes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, por via das d√∫vidas, verificamos com uma margem no intervalo de tr√™s dias - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nem um √∫nico conflito</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que nos conv√©m mais que o suficiente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Substitui√ß√£o de Hash</font></font></h4><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3d/rz/ga/3drzgasyjhevujtp-etsjcwlnz8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas simplesmente n√£o podemos aceitar e alterar os antigos campos UUID para o novo hash nas tabelas de dicion√°rio, porque o banco de dados e o frontend existente esperam que os objetos continuem sendo identificados pelo UUID. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, adicionaremos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais um cache</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao coletor </font><font style="vertical-align: inherit;">- para o MD5 j√° calculado. Agora ser√° um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mapa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , no qual as chaves s√£o xxhash3, os valores s√£o MD5. Para linhas id√™nticas, n√£o recontamos o MD5 "caro" novamente, mas o retiramos do cache:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> getHashFromBin = <span class="hljs-function">(<span class="hljs-params">bin</span>) =&gt;</span> Buffer.from(bin, <span class="hljs-string">'binary'</span>).toString(<span class="hljs-string">'hex'</span>);
<span class="hljs-keyword">const</span> dictmd5 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
<span class="hljs-keyword">const</span> getmd5 = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> hash = xxhash(data);
  <span class="hljs-keyword">let</span> md5hash = dictmd5.get(hash);
  <span class="hljs-keyword">if</span> (!md5hash) {<font></font>
    md5hash = md5(data);<font></font>
    dictmd5.set(hash, getBinFromHash(md5hash));<font></font>
    <span class="hljs-keyword">return</span> md5hash;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> getHashFromBin(md5hash);<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Removemos o perfil - a fra√ß√£o do tempo para calcular hashes diminuiu acentuadamente, felicidades! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/el/5q/ce/el5qcei3ahbakyyerswutw2rulk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o agora contamos xxhash3, depois verificamos o cache MD5 e obtemos o MD5 desejado, e depois verificamos o cache do dicion√°rio - se esse md5 n√£o estiver l√°, envie-o para o banco de dados para grava√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algo muitas verifica√ß√µes ... Por que verificar o cache do dicion√°rio se voc√™ j√° verificou o cache MD5? </font><font style="vertical-align: inherit;">Acontece que todos os caches de dicion√°rio n√£o s√£o mais necess√°rios e basta ter apenas um cache - para o MD5, com o qual todas as opera√ß√µes b√°sicas ser√£o executadas: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wl/e_/uc/wle_ucs0o22wpxmrjlg_2sokzvm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
como resultado, substitu√≠mos a verifica√ß√£o em v√°rios dicion√°rios de "objetos" por um cache do MD5, e a opera√ß√£o intensiva de recursos do c√°lculo do MD5 √© O hash √© executado apenas para novas entradas, usando o xxhash muito mais eficiente para o fluxo de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
obrigado</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kilor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para obter ajuda na prepara√ß√£o do artigo.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt498816/index.html">A verdade, antes de tudo, ou por que o sistema precisa ser projetado com base no dispositivo de banco de dados</a></li>
<li><a href="../pt498820/index.html">Algumas perguntas mais complicadas sobre .NET e C #</a></li>
<li><a href="../pt498822/index.html">Desenvolvimento e cria√ß√£o do zero de uma m√°quina de arcade para quatro jogadores</a></li>
<li><a href="../pt498826/index.html">SIL e Salesforce</a></li>
<li><a href="../pt498828/index.html">Como o sal de mesa e as prote√≠nas aumentam a sobreviv√™ncia do implante</a></li>
<li><a href="../pt498832/index.html">Vis√£o geral das possibilidades do Qt Creator 4.12 e QBS 1.16 para programar microcontroladores</a></li>
<li><a href="../pt498834/index.html">33 mitaps online da semana. Escolha um ou tenha tempo para tudo?</a></li>
<li><a href="../pt498836/index.html">[Infographics] As 50 principais franquias de jogos com receita superior a um bilh√£o</a></li>
<li><a href="../pt498840/index.html">O bot monitora e controla o computador via telegramas</a></li>
<li><a href="../pt498842/index.html">Modera√ß√£o dos coment√°rios: E ainda assim, podemos confiar nos usu√°rios?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>