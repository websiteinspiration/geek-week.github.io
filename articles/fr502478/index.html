<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✊🏿 🤵🏾 🧖🏼 Nous surveillons la base de données PostgreSQL - qui est à blâmer et que faire 🧚🏻 🤚🏽 🚐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="J'ai déjà parlé de la façon dont nous «détectons» les problèmes PostgreSQL en utilisant la surveillance des journaux de masse sur des centaines de ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nous surveillons la base de données PostgreSQL - qui est à blâmer et que faire</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/502478/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai déjà parlé de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">façon dont nous «détectons» les problèmes PostgreSQL en</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilisant la surveillance des journaux de masse sur des centaines de serveurs en même temps. Mais en plus des journaux, ce SGBD nous fournit également de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombreux outils pour analyser son état</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - c'est un péché de ne pas les utiliser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certes, si vous les regardez simplement depuis la console, vous pouvez très rapidement faire le tour sans aucun avantage, car la quantité de données à notre disposition dépasse toutes les limites raisonnables.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s1/za/d-/s1zad-d3claa2klkewtgrj8zdaa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, afin que la situation reste contrôlable, nous avons </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">développé un module complémentaire pour Zabbix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui fournit des métriques, des écrans de formulaires et définit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des règles de surveillance uniformes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour tous les serveurs et bases de données sur eux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'article d'aujourd'hui porte sur les conclusions qui peuvent être tirées en observant en dynamique les différentes métriques des bases de serveurs PostgreSQL, et où le problème peut être caché.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statut de connexion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La toute première chose avec laquelle tous les désassemblements sur le sujet «qu'est-il arrivé à notre base de données / c'était mauvais» commence par la surveillance de l'état récapitulatif de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_activity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/az/zv/9k/azzv9kl_xmnaxjdfgsgjkmikr48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sur le graphique de gauche, nous voyons toutes les connexions qui attendent quelque chose, à droite - c'est quelque chose faire. </font><font style="vertical-align: inherit;">Selon la version de PG, l'état de la connexion est déterminé par </font></font><code>pg_stat_activity.state/wait_event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et / ou le texte de la demande lui-même. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que rechercher</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trop </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peu</font></font><code>idle</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - à un moment donné, votre application peut ne pas avoir suffisamment de connexions déjà ouvertes à la base de données, et lorsque vous essayez d'en ouvrir une autre, vous vous retrouverez à attendre que le processus s'initialise pour servir une nouvelle connexion.</font></font></li>
<li> <b> <code>idle</code></b>      «»    ,         <code>max_connections</code>.</li>
<li><b> <code>idle in transaction</code></b> —  ,    -  pgbouncer.            .<br>
<br>
        ,  <b>   </b>  ,     <code>idle_in_transaction_session_timeout</code>.</li>
<li><b> <code>wait</code></b> —   - «»  .       —     .<br>
<br>
     ,  <b>  «» </b>  <code>pg_terminate_backend(pid)</code>.</li>
<li><b> <code>active</code></b> ( max-) ,        «».     -     (, « »)      ,   ,    …<br>
<br>
   —       ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«» </a>.</li>
<li><b><code>maintenance</code></b> —    ,     - :<br>
<br>
<pre><code class="plaintext hljs">query ~* E'^(\\s*(--[^\\n]*\\n|/\\*.*\\*/|\\n))*(autovacuum|VACUUM|ANALYZE|REINDEX|CLUSTER|CREATE|ALTER|TRUNCATE|DROP)'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la plupart des cas, il y aura le nombre d'auto-vide / auto-analyse fonctionnant en même temps, dont le mal ne réside que dans l'utilisation des ressources du serveur pour les cas "étrangers". </font><font style="vertical-align: inherit;">Si cela est essentiel pour vous - tournez </font></font><code>autovacuum_max_workers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>autovacuum_naptime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">désactivez-le complètement - vous ne devriez pas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en même temps commence à croître </font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et</font></font><code>maintenance</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est une chance de voir si quelqu'un a décidé de déployer le code DBA ou développeur, par exemple, bloquant la moitié des chances d'applications fonctionnelles.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme il est important pour nous de supprimer non seulement un grand nombre de métriques, mais aussi de le faire le plus efficacement possible, nous essayons de filmer certaines d'entre elles de manière synchrone dans le cadre d'une seule demande:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">État de connexion et de verrouillage</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> event_types(wait_event_type) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'lwlock'</span>)<font></font>
  , (<span class="hljs-string">'lock'</span>)<font></font>
  , (<span class="hljs-string">'bufferpin'</span>)<font></font>
  , (<span class="hljs-string">'client'</span>)<font></font>
  , (<span class="hljs-string">'extension'</span>)<font></font>
  , (<span class="hljs-string">'ipc'</span>)<font></font>
  , (<span class="hljs-string">'timeout'</span>)<font></font>
  , (<span class="hljs-string">'io'</span>)<font></font>
)<font></font>
, <span class="hljs-keyword">events</span>(wait_event) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'walwritelock'</span>)<font></font>
  , (<span class="hljs-string">'wal_insert'</span>)<font></font>
  , (<span class="hljs-string">'buffer_content'</span>)<font></font>
  , (<span class="hljs-string">'buffer_io'</span>)<font></font>
  , (<span class="hljs-string">'lock_manager'</span>)<font></font>
  , (<span class="hljs-string">'relation'</span>)<font></font>
  , (<span class="hljs-string">'extend'</span>)<font></font>
  , (<span class="hljs-string">'page'</span>)<font></font>
  , (<span class="hljs-string">'tuple'</span>)<font></font>
  , (<span class="hljs-string">'transactionid'</span>)<font></font>
  , (<span class="hljs-string">'virtualxid'</span>)<font></font>
  , (<span class="hljs-string">'speculative token'</span>)<font></font>
  , (<span class="hljs-string">'object'</span>)<font></font>
  , (<span class="hljs-string">'userlock'</span>)<font></font>
  , (<span class="hljs-string">'advisory'</span>)<font></font>
  , (<span class="hljs-string">'clientread'</span>)<font></font>
  , (<span class="hljs-string">'datafileextend'</span>)<font></font>
  , (<span class="hljs-string">'datafileread'</span>)<font></font>
  , (<span class="hljs-string">'datafilewrite'</span>)<font></font>
  , (<span class="hljs-string">'slruread'</span>)<font></font>
  , (<span class="hljs-string">'slruwrite'</span>)<font></font>
)<font></font>
, states(state) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'running'</span>)<font></font>
  , (<span class="hljs-string">'maintenance'</span>)<font></font>
  , (<span class="hljs-string">'waiting'</span>)<font></font>
  , (<span class="hljs-string">'transaction'</span>)<font></font>
  , (<span class="hljs-string">'idle'</span>)<font></font>
)<font></font>
, stats <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">SELECT</span><font></font>
    pid<font></font>
  , datname<font></font>
  , state<font></font>
  , <span class="hljs-keyword">lower</span>(wait_event_type) wait_event_type<font></font>
  , <span class="hljs-keyword">lower</span>(wait_event) wait_event<font></font>
  , <span class="hljs-keyword">query</span>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_stat_activity<font></font>
  <span class="hljs-keyword">WHERE</span><font></font>
    pid &lt;&gt; pg_backend_pid()<font></font>
)<font></font>
, dbs <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">SELECT</span><font></font>
    datname<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_database db<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> db.datistemplate<font></font>
)<font></font>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(s.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , states.state<font></font>
  , <span class="hljs-literal">true</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span><font></font>
    states<font></font>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , <span class="hljs-keyword">CASE</span>
          <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">query</span> ~* E<span class="hljs-string">'^(\\s*(--[^\\n]*\\n|/\\*.*\\*/|\\n))*(autovacuum|VACUUM|ANALYZE|REINDEX|CLUSTER|CREATE|ALTER|TRUNCATE|DROP)'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'maintenance'</span>
          <span class="hljs-keyword">WHEN</span> wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
            wait_event &lt;&gt; <span class="hljs-string">'clientread'</span> <span class="hljs-keyword">AND</span>
            state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'waiting'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'running'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'idle'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'idle'</span>
          <span class="hljs-keyword">WHEN</span> state <span class="hljs-keyword">IN</span> (<span class="hljs-string">'idle in transaction'</span>, <span class="hljs-string">'idle in transaction (aborted)'</span>) <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'transaction'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'fastpath function call'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'fastpath'</span>
          <span class="hljs-keyword">ELSE</span>
            <span class="hljs-string">'disabled'</span>
        <span class="hljs-keyword">END</span> state<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) s<font></font>
<span class="hljs-keyword">UNION</span>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(t.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , event_types.wait_event_type<font></font>
  , <span class="hljs-literal">false</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span><font></font>
    event_types<font></font>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , wait_event_type<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">WHERE</span>
        wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) t<font></font>
<span class="hljs-keyword">UNION</span>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(e.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , events.wait_event<font></font>
  , <span class="hljs-literal">false</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span>
    <span class="hljs-keyword">events</span>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , wait_event<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">WHERE</span>
        wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) e;<font></font>
</code></pre></div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serrures</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque nous avons abordé le blocage de la surveillance dans le paragraphe précédent, il convient de noter que PostgreSQL aime les superposer à droite et à gauche: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nz/jl/vd/nzjlvdmvxaaqxdotpshnyuhydlo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nous sommes plus intéressés par deux types d'entre eux:</font></font><br>
<br>
<ul>
<li><b><code>Exclusive</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - se produisent généralement lors du verrouillage sur un enregistrement particulier.</font></font></li>
<li><b><code>AccessExclusive</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - lors des opérations de maintenance sur la table.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais n'oubliez pas que le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> total </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">de serrures n'est pas en caoutchouc</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les verrous consultatifs et réguliers sont stockés dans la zone de mémoire partagée, dont la taille est déterminée par les paramètres de configuration </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est important que cette mémoire soit suffisante, car </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinon le serveur ne pourra émettre </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aucun</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verrou</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ainsi, le nombre de verrous recommandés qu'un serveur peut émettre est généralement limité à des dizaines ou des centaines de milliers, selon la configuration du serveur.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En règle générale, cette situation se produit si votre «flux» d'application et les ressources ne sont pas libérées: connexions à la base de données, contextes de transaction ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verrous consultatifs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par conséquent, faites attention à la dynamique globale.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transactions par seconde (TPS)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir des informations sur les modifications dans le contexte de la base de données actuelle, vous pouvez utiliser la vue système </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_database</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais s'il existe de nombreuses bases de données sur le serveur, il est pratique de le faire immédiatement pour toutes, en se </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connectant à</font></font><code>postgres</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPS &amp; tuples</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">extract</span>(epoch <span class="hljs-keyword">from</span> <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
, datname dbname<font></font>
, pg_stat_get_db_tuples_returned(<span class="hljs-keyword">oid</span>) tup_returned<font></font>
, pg_stat_get_db_tuples_fetched(<span class="hljs-keyword">oid</span>) tup_fetched<font></font>
, pg_stat_get_db_tuples_inserted(<span class="hljs-keyword">oid</span>) tup_inserted<font></font>
, pg_stat_get_db_tuples_updated(<span class="hljs-keyword">oid</span>) tup_updated<font></font>
, pg_stat_get_db_tuples_deleted(<span class="hljs-keyword">oid</span>) tup_deleted<font></font>
, pg_stat_get_db_xact_commit(<span class="hljs-keyword">oid</span>) xact_commit<font></font>
, pg_stat_get_db_xact_rollback(<span class="hljs-keyword">oid</span>) xact_rollback
<span class="hljs-keyword">FROM</span><font></font>
  pg_database<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">NOT</span> datistemplate;
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je veux souligner séparément - ne négligez pas la sortie des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valeurs maximales des</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> métriques! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ls/yn/yt/lsynyt4rkawj8hvp2pcrnvjiozk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce graphique, nous pouvons clairement voir la situation d'un pic soudain d'augmentation du nombre de </font></font><b><code>commit</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transactions </font><font style="vertical-align: inherit;">effectuées ( </font><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Ce n'est pas un à un correspond à la charge sur le serveur et les transactions peuvent être de complexité variable, mais une croissance de 4 fois montre clairement que le serveur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doit avoir une certaine réserve de performances</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> afin de survivre à un tel pic sans problème. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, la restauration ( </font></font><b><code>rollback</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) de la transaction est une occasion de vérifier si votre application s'exécute consciemment </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ou si le serveur le fait automatiquement à la suite d'une erreur.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nombre d'opérations sur les enregistrements</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, faites attention aux enregistrements que nous soustrayons des index / tables:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/av/sw/dmavswryoevflquj7krtbykqgtw.png"><br>
<br>
<ul>
<li><b><code>tuples.returned</code></b> —   ,   «»   .</li>
<li><b><code>tuples.fetched</code></b> —   ,     « »   <code>Rows Removed by Filter</code>,   «»   .</li>
<li><b><code>tuples.ratio</code></b> — ,    ,  <b>   1</b>,   —  .   ,  ,       ,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous observez un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pic pointu</font></font><code>tuples.ratio</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vous pouvez être sûr qu'une demande inefficace de la catégorie décrite dans l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article sur les recettes pour leur traitement vous</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parviendra dans le journal </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, même si </font></font><code>ratio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idéalement égal à 1, mais le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pic est tombé</font></font><code>returned/fetched</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ne vous attendez pas non plus à bien. Habituellement, cela peut signifier qu'il y a une sorte de problème dans le plan, comme:</font></font><br>
<br>
<pre><code class="plaintext hljs">Hash Join<font></font>
  - Hash<font></font>
    - Seq Scan on BIG_TABLE<font></font>
  - Index Scan ...</code></pre><br>
<pre><code class="plaintext hljs">Merge Join<font></font>
  - Index Scan on BIG_INDEX<font></font>
  - Index Scan ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis que nous avons commencé à vérifier ce qui s'y lit, voyons comment cela se passe. </font><font style="vertical-align: inherit;">C'est-à-dire, combien d'enregistrements nous lisons par index, et combien en conséquence </font></font><b><code>Seq Scan</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7y/3o/xq/7y3oxqadodpa_zgrhyv0nfxzzua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est clair qu'ici toute croissance imprévue d'indicateurs devrait susciter des soupçons. </font><font style="vertical-align: inherit;">Par exemple, si pour une raison quelconque vous avez besoin de lire une plaque entière de 10 millions d'enregistrements chaque nuit, alors l'apparition d'un tel pic pendant la journée est une raison de démontage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi que toutes les insertions / mises à jour / suppressions de masse anormales:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/85/pn/dl/85pndlf5hstls4os3jwmtsuserc.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilisation du cache de données</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comprendre comment la relecture en masse des enregistrements aggrave vraiment la vie du serveur, examinons comment le serveur fonctionne avec les pages de données et le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rapport</font></font><code>block.read/hit</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dans un monde idéal, le serveur ne devrait pas «lire» depuis le disque ( </font></font><code>shared read</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur le nœud du plan) absolument rien, tout devrait déjà être en mémoire ( </font></font><code>shared hit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), car l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accès au disque est toujours lent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En réalité, ce n'est pas entièrement vrai, et c'est la raison d'une analyse approfondie des demandes aux heures de pointe:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/ue/xl/btuexl-qt3d384qarrm0n6chlr0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demande / transaction la plus longue</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour MVCC, les requêtes et transactions de longue durée dans les systèmes occupés sont un désastre de performances. </font><font style="vertical-align: inherit;">Les détails et les images à ce sujet peuvent être lus </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - comment pouvez-vous survivre dans de telles conditions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a0/jl/ls/a0jllsvlvmsny6hhyq_mjnhnmli.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Attraper de tels méchants nous aide </font></font><code>pg_stat_activity.query_start/xact_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme notre expérience le montre, une représentation visuelle de ces mesures est déjà suffisante pour représenter approximativement où creuser davantage:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rechercher des fuites de ressources dans l'application</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimiser les demandes ayant échoué</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mettre du matériel plus productif</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... ou assurez-vous que la charge est correctement espacée dans le temps</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502460/index.html">À quoi s'attendre sur la scène des startups ukrainiennes en 2020?</a></li>
<li><a href="../fr502462/index.html">Événements numériques à Moscou du 18 au 24 mai</a></li>
<li><a href="../fr502464/index.html">Événements numériques à Saint-Pétersbourg du 18 au 24 mai</a></li>
<li><a href="../fr502466/index.html">Nouveau RIT ++ dans les nouvelles conditions</a></li>
<li><a href="../fr502472/index.html">Surveillance Prométhée d'applications de microservices. Vitaly Levchenko</a></li>
<li><a href="../fr502480/index.html">Qu'est-ce que DHCP Snooping et comment ça marche?</a></li>
<li><a href="../fr502486/index.html">Le livre "Race with the epidemic. Antibiotiques contre les superbactéries "</a></li>
<li><a href="../fr502490/index.html">Clignotant des croyances restrictives. Pour quoi et qu'est-ce que ça donne</a></li>
<li><a href="../fr502492/index.html">Innovations dans Zextras Suite et Zimbra OSE</a></li>
<li><a href="../fr502494/index.html">7 erreurs d'un Black Friday et comment fonctionne Magento Cloud - vidéo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>