<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚ÄçüöÄ üçé üßùüèΩ And again about embedded: looking for bugs in the Embox project üë®üèæ‚Äçüíº üë©üèø‚Äçü§ù‚Äçüë©üèª üë©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Embox is a cross-platform, multi-tasking real-time operating system for embedded systems. It is designed to work in low computing resources and allows...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>And again about embedded: looking for bugs in the Embox project</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/499986/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/20f/e3c/e6220fe3c8d556e40580a1cf49eab7cb.png" alt="Figure 2"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embox is a cross-platform, multi-tasking real-time operating system for embedded systems. It is designed to work in low computing resources and allows you to run Linux-based applications on microcontrollers without using Linux itself. Of course, like any other application, Embox bugs are also not spared. This article is devoted to the analysis of errors found in the code of the Embox project.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A few months ago, I already wrote </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about checking FreeRTOS, another OS for embedded systems. </font><font style="vertical-align: inherit;">I did not find errors in it then, but I found them in libraries added by the guys from Amazon when developing their own version of FreeRTOS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The article that you see now in front of you, in a sense, continues the theme of the previous one. </font><font style="vertical-align: inherit;">We often received requests to check FreeRTOS, and we did it. </font><font style="vertical-align: inherit;">This time, there were no requests to check on a specific project, but I began to receive letters and comments from embedded developers who liked it and who want more. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, the new issue of PVS-Studio for Embedded magazine has matured and lies before you. </font><font style="vertical-align: inherit;">Enjoy watching!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analysis</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The analysis was carried out using PVS-Studio - a static code analyzer for C, C ++, C # and Java. Before analysis, the project needs to be assembled - so we will be sure that the project code is working, and we will also give the analyzer the opportunity to collect the assembly information that can be useful for better code verification. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The instructions in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">official</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Embox </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">repository</font></a><font style="vertical-align: inherit;"> offer the ability to build under different systems (Arch Linux, macOS, Debian) and using Docker. I decided to add some variety to my life and build and analyze from under Debian, which I recently installed on my virtual machine.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The assembly went smoothly. </font><font style="vertical-align: inherit;">Now it was necessary to conduct an analysis. </font><font style="vertical-align: inherit;">Debian is one of the supported PVS-Studio Linux-based systems. </font><font style="vertical-align: inherit;">A convenient way to check projects from under Linux is to compile trace. </font><font style="vertical-align: inherit;">This is a special mode in which the analyzer collects all the necessary information about the assembly so that you can then start the analysis with one click. </font><font style="vertical-align: inherit;">All I needed to do was: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Download and install PVS-Studio; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Launch assembly tracking by going to the folder with Embox and typing in the terminal</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -- make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) After waiting for the assembly to complete, run the command:</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -o /path/to/output.<span class="hljs-built_in">log</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Convert the raw report to any format convenient for you. </font><font style="vertical-align: inherit;">The analyzer comes with a special utility PlogConverter, with which you can do this. </font><font style="vertical-align: inherit;">For example, the command to convert the report to tasklist (for viewing, for example, in QtCreator) will look like this:</font></font><br>
<br>
<pre><code class="cpp hljs">plog-converter -t tasklist -o /path/to/output.tasks /path/to/project</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All! </font><font style="vertical-align: inherit;">It took me no more than 15 minutes to complete these points. </font><font style="vertical-align: inherit;">The report is ready, now you can view the errors. </font><font style="vertical-align: inherit;">Well, let's get started :)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strange cycle</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the errors found by the analyzer was the strange while loop:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span> ) {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
<font></font>
    dp.skip --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span>);       <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">do</span> {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    ....<font></font>
<font></font>
    dp.count --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.count != <span class="hljs-number">0</span>);<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">V715</font></a><font style="vertical-align: inherit;"> The 'while' operator has empty body. </font><font style="vertical-align: inherit;">Suspicious pattern detected: 'while (expr) {...} while (dp.skip! = 0);'. </font><font style="vertical-align: inherit;">dd.c 225 hm </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. </font><font style="vertical-align: inherit;">Really weird loop. </font><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expression </font><i><font style="vertical-align: inherit;">(dp.skip! = 0)</font></i><font style="vertical-align: inherit;"> is written twice, once right above the loop, and the second just below it. </font><font style="vertical-align: inherit;">In fact, now these are two different cycles: one contains expressions in curly braces, and the second is empty. </font><font style="vertical-align: inherit;">In this case, the second cycle will never be executed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below is a do ... while loop with a similar condition, which leads me to think: the strange loop was originally meant as do ... while, but something went wrong. </font><font style="vertical-align: inherit;">I think that this piece of code with a high probability contains a logical error.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memory leaks</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, not without them.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">krename</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *oldpath, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *newpath)</span> </span>{<font></font>
  <font></font>
  <span class="hljs-keyword">char</span> *newpatharg, *oldpatharg;<font></font>
<font></font>
  ....<font></font>
<font></font>
  oldpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(oldpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));<font></font>
  newpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(newpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == oldpatharg || <span class="hljs-literal">NULL</span> == newpatharg) {<font></font>
    SET_ERRNO(ENOMEM);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warnings:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">V773</a> The function was exited without releasing the 'newpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">V773</a> The function was exited without releasing the 'oldpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function creates the local variables </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oldpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inside itself </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">These pointers are assigned the addresses of new memory locations allocated internally using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If a problem occurs when allocating memory, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> returns a null pointer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What if only one memory block is allocated? </font><font style="vertical-align: inherit;">The function will crash without any memory being freed. </font><font style="vertical-align: inherit;">The site that happened to be allocated will remain in memory without any opportunity to access it again and free it for further use. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another example of a memory leak is a bit brighter:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">block_dev_test</span><span class="hljs-params">(....)</span> </span>{
  <span class="hljs-keyword">int8_t</span> *read_buf, *write_buf;<font></font>
  <font></font>
  ....<font></font>
<font></font>
  read_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
  write_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (read_buf == <span class="hljs-literal">NULL</span> || write_buf == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to allocate memory for buffer!\n"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (read_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(read_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (write_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(write_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> -ENOMEM;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (s_block &gt;= blocks) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Starting block should be less than number of blocks\n"</span>);
    <span class="hljs-keyword">return</span> -EINVAL;            <span class="hljs-comment">// &lt;=</span><font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warnings:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">V773</a> The function was exited without releasing the 'read_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">V773</a> The function was exited without releasing the 'write_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, the programmer has already shown accuracy and correctly processed the case in which it was possible to allocate only one piece of memory. </font><font style="vertical-align: inherit;">Processed correctly ... and literally in the next expression made another mistake. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to a correctly written check, we can be sure that at the time the expression is executed, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return -EINVAL; </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we will definitely have memory allocated for both </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Thus, with such a return from the function, we will have two leaks at once. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think that getting a memory leak on an embedded device can be more painful than on a classic PC. </font><font style="vertical-align: inherit;">In conditions when resources are severely limited, you need to monitor them especially carefully.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pointers mishandling</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following error code is concise and simple enough:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">scsi_write</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">char</span> *buffer,
                      <span class="hljs-keyword">size_t</span> count, <span class="hljs-keyword">blkno_t</span> blkno)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_dev</span> *<span class="hljs-title">sdev</span>;</span>
  <span class="hljs-keyword">int</span> blksize;<font></font>
<font></font>
  ....<font></font>
<font></font>
  sdev = bdev-&gt;privdata;<font></font>
  blksize = sdev-&gt;blk_size; <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!sdev) {              <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">return</span> -ENODEV;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The 'sdev' pointer was utilized before it was verified against nullptr. Check lines: 116, 118. scsi_disk.c 116 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer </font><i><font style="vertical-align: inherit;">is</font></i><font style="vertical-align: inherit;"> dereferenced just before it is checked for NULL. It is logical to assume that if someone wrote such a check, then this pointer may be null. In this case, we have the potential dereferencing of the null pointer in the string </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The error is that the check is not located where it is needed. It should have come after the line " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev = bdev-&gt; privdata;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", but before the line " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Then the potential appeal to the zero address could be avoided.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio found two more errors in the following code:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xdrrec_create</span><span class="hljs-params">(....)</span>
</span>{
  <span class="hljs-keyword">char</span> *buff;<font></font>
<font></font>
  ....<font></font>
<font></font>
  buff = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(sendsz + recvsz);<font></font>
  assert(buff != <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  ....<font></font>
<font></font>
  xs-&gt;extra.rec.in_base = xs-&gt;extra.rec.in_curr = buff;<font></font>
  xs-&gt;extra.rec.in_boundry <font></font>
    = xs-&gt;extra.rec.in_base + recvsz;                    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
  xs-&gt;extra.rec.out_base<font></font>
    = xs-&gt;extra.rec.out_hdr = buff + recvsz;             <span class="hljs-comment">// &lt;= </span><font></font>
  xs-&gt;extra.rec.out_curr <font></font>
    = xs-&gt;extra.rec.out_hdr + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">union</span> xdrrec_hdr);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio warnings:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The 'xs-&gt; extra.rec.in_base' pointer in the 'xs-&gt; extra.rec.in_base + recvsz' expression could be nullptr. </font><font style="vertical-align: inherit;">In such case, resulting value will be senseless and it should not be used. </font><font style="vertical-align: inherit;">Check lines: 56, 48. xdr_rec.c 56</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The 'buff' pointer in the 'buff + recvsz' expression could be nullptr. </font><font style="vertical-align: inherit;">In such case, resulting value will be senseless and it should not be used. </font><font style="vertical-align: inherit;">Check lines: 61, 48. xdr_rec.c 61</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The buf pointer is initialized with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and then its value is used to initialize other pointers. The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">can return a null pointer, and this should always be checked. It would seem that here is an </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> checking </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and everything should work fine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But no! The fact is that </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 's are used for debugging, and when building the project in the Release configuration, this </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be deleted. It turns out that when working in Debug, the program will work correctly, and when building in Release, the null pointer "goes" further. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in arithmetic operations is incorrect, because the result of such an operation will not make any sense, and such a result cannot be used. </font><font style="vertical-align: inherit;">This is what the analyzer warns us about. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some might argue that not checking the pointer after </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is fearless. </font><font style="vertical-align: inherit;">Like, at the first access by a null pointer, a signal / exception will occur and there will be nothing wrong. </font><font style="vertical-align: inherit;">In practice, everything is much more complicated, and if the lack of verification does not seem dangerous to you, I suggest you take a look at the article ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why is it important to check what the malloc function returned</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incorrect handling of arrays</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following error is very similar to the example before last:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fat_read_filename</span><span class="hljs-params">(struct fat_file_info *fi,
                      <span class="hljs-keyword">void</span> *p_scratch,
                      <span class="hljs-keyword">char</span> *name)</span> </span>{
  <span class="hljs-keyword">int</span> offt = <span class="hljs-number">1</span>;<font></font>
<font></font>
  ....<font></font>
<font></font>
  offt = <span class="hljs-built_in">strlen</span>(name);
  <span class="hljs-keyword">while</span> (name[offt - <span class="hljs-number">1</span>] == <span class="hljs-string">' '</span> &amp;&amp; offt &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// &lt;=</span>
    name[--offt] = <span class="hljs-string">'\0'</span>;<font></font>
  }<font></font>
  log_debug(<span class="hljs-string">"name(%s)"</span>, name);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> DFS_OK;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V781</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The value of the 'offt' index is checked after it was used. </font><font style="vertical-align: inherit;">Perhaps there is a mistake in program logic. </font><font style="vertical-align: inherit;">fat_common.c 1813 The </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offt is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> first used inside the indexing operation, and only then it is checked that its value is greater than zero. </font><font style="vertical-align: inherit;">But what happens if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> turns out to be an empty string? </font><font style="vertical-align: inherit;">The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">will return </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then a loud shot in the leg. </font><font style="vertical-align: inherit;">The program will access at a negative index, which will lead to undefined behavior. </font><font style="vertical-align: inherit;">Anything can happen, including a program crash. </font><font style="vertical-align: inherit;">Mess!</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8d/fde/b0d/a8dfdeb0d70054257d1d08162bbd39aa.png" alt="Picture 1"></div> <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suspicious conditions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And where without them? </font><font style="vertical-align: inherit;">We find such errors literally in every project that we check.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">index_descriptor_cloexec_set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> cloexec)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idesc_table</span> *<span class="hljs-title">it</span>;</span><font></font>
<font></font>
  it = task_resource_idesc_table(task_self());<font></font>
  assert(it);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (cloexec | FD_CLOEXEC) {<font></font>
    idesc_cloexec_set(it-&gt;idesc_table[fd]);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    idesc_cloexec_clear(it-&gt;idesc_table[fd]);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V617</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Consider inspecting the condition. The '0x0010' argument of the '|' bitwise operation contains a non-zero value. index_descriptor.c 55 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand what the error lies in, look at the definition of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FD_CLOEXEC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> constant </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FD_CLOEXEC 0x0010</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that in the expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (cloexec | FD_CLOEXEC) to the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> right of the bitwise ‚Äúor‚Äù there is always a nonzero constant. </font><font style="vertical-align: inherit;">The result of such an operation will always be a nonzero number. </font><font style="vertical-align: inherit;">Thus, this expression will always be equivalent to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (true)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expression </font><font style="vertical-align: inherit;">, and we will always process only the then-branch of the if-expression. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I suspect that this macro constant is used to pre-configure the Embox operating system, but even then this always true condition looks strange. </font><font style="vertical-align: inherit;">Perhaps they wanted to use the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&amp;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator here </font><font style="vertical-align: inherit;">, but they made a typo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integer division</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following error is related to one feature of the C language:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SBSIZE    1024</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2fs_format</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">void</span> *priv)</span> </span>{
  <span class="hljs-keyword">size_t</span> dev_bsize;
  <span class="hljs-keyword">float</span> dev_factor;<font></font>
<font></font>
  ....<font></font>
<font></font>
  dev_size = block_dev_size(bdev);<font></font>
  dev_bsize = block_dev_block_size(bdev);<font></font>
  dev_factor = SBSIZE / dev_bsize;            <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ext2_dflt_sb(&amp;sb, dev_size, dev_factor);<font></font>
  ext2_dflt_gd(&amp;sb, &amp;gd);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warning </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">V636</font></a><font style="vertical-align: inherit;"> The '1024 / dev_bsize' expression was implicitly cast from 'int' type to 'float' type. Consider utilizing an explicit type cast to avoid the loss of a fractional part. An example: double A = (double) (X) / Y ;. ext2.c 777 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This feature is as follows: if we divide two integer values, then the result of the division will be integer. Thus, division will occur without a remainder, or, in other words, the fractional part will be discarded from the division result. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes programmers forget about it, and errors like this are made. SBSIZE constant and variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> have integer type (int, and size_t respectively). Therefore, the result of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SBSIZE / dev_bsize expression</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will also be of integer type. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But wait a moment. </font><font style="vertical-align: inherit;">The variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Obviously, the programmer expected to get a fractional division result. </font><font style="vertical-align: inherit;">This can be further verified if you pay attention to the further use of this variable. </font><font style="vertical-align: inherit;">For example, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_dflt_sb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, where </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> passed as the third parameter, has the following signature:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ext2_dflt_sb</span><span class="hljs-params">(struct ext2sb *sb, <span class="hljs-keyword">size_t</span> dev_size, <span class="hljs-keyword">float</span> dev_factor)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Similarly, in other places where the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable is </font><i><font style="vertical-align: inherit;">used</font></i><font style="vertical-align: inherit;"> : everything indicates that a floating-point number is expected. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To correct this error, it is enough just to cast one of the division operands to a real type. </font><font style="vertical-align: inherit;">For instance:</font></font><br>
<br>
<pre><code class="cpp hljs">dev_factor = <span class="hljs-keyword">float</span>(SBSIZE) / dev_bsize;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the result of division will be a fractional number.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unverified input</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following error is associated with the use of unverified data received from outside the program.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> ret;
  <span class="hljs-keyword">char</span> text[SMTP_TEXT_LEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == fgets(&amp;text[<span class="hljs-number">0</span>], <span class="hljs-keyword">sizeof</span> text - <span class="hljs-number">2</span>, <span class="hljs-comment">/* for \r\n */</span>
      <span class="hljs-built_in">stdin</span>)) { ret = -EIO; <span class="hljs-keyword">goto</span> error; }<font></font>
    text[<span class="hljs-built_in">strlen</span>(&amp;text[<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>] = <span class="hljs-string">'\0'</span>; <span class="hljs-comment">/* remove \n */</span>    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unchecked tainted data is used in index: 'strlen (&amp; text [0])'. </font><font style="vertical-align: inherit;">sendmail.c 102 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, consider what the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function returns </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In case of successful reading of a line, the function returns a pointer to this line. </font><font style="vertical-align: inherit;">If the read encounters an </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">end-of-file</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> before at least one element is read, or if an input error occurs, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">returns </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So the expression is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL == fgets (....)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checks if the input received is correct. But there is one caveat. If you transfer a null terminal as the first character to be read (this can be done, for example, by pressing Ctrl + 2 in the Legacy mode of the Windows command line), the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">considers it without returning </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In this case, the line to which the recording is made will have only one element - ' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What will happen next? The expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen (&amp; text [0])</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will return </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . As a result, we get a negative index call:</font></font><br>
<br>
<pre><code class="cpp hljs">text[ <span class="hljs-number">0</span> - <span class="hljs-number">1</span> ] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we can ‚Äúoverturn‚Äù the program by simply passing the line termination character to the input. </font><font style="vertical-align: inherit;">This is awkward, and could potentially be used to attack systems using Embox. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My colleague, who was developing this diagnostic rule, even made a note with an example of such an attack on the NcFTP project:</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8DBQjvPQ7tk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I recommend to see if you still do not believe in such an opportunity :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, the analyzer found two more places with the same error:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Unchecked tainted data is used in index: 'strlen (&amp; from [0])'. </font><font style="vertical-align: inherit;">sendmail.c 55</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Unchecked tainted data is used in index: 'strlen (&amp; to [0])'. </font><font style="vertical-align: inherit;">sendmail.c 65</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Misra</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA is a set of guidelines and guidelines for writing secure C and C ++ code for highly responsible embedded systems. </font><font style="vertical-align: inherit;">In a sense, this is a training manual, following which will allow you to get rid of not only the so-called "code smells", but also protect your program from vulnerabilities. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA is used where human lives depend on the quality of your embedded system: in the medical, automotive, aircraft and military industries. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio has </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an extensive set of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diagnostic rules that allow you to check your code for compliance with MISRA C and MISRA C ++ standards. </font><font style="vertical-align: inherit;">By default, the mode with these diagnostics is turned off, but since we are looking for errors in the project for embedded systems, I simply could not do without MISRA.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is what I managed to find:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* find and read symlink file */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2_read_symlink</span><span class="hljs-params">(struct nas *nas,
                             <span class="hljs-keyword">uint32_t</span> parent_inumber,
                             <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **cp)</span> </span>{
  <span class="hljs-keyword">char</span> namebuf[MAXPATHLEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  *cp = namebuf;              <span class="hljs-comment">// &lt;=</span>
  <span class="hljs-keyword">if</span> (*namebuf != <span class="hljs-string">'/'</span>) {<font></font>
    inumber = parent_inumber;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    inumber = (<span class="hljs-keyword">uint32_t</span>) EXT2_ROOTINO;<font></font>
  }<font></font>
  rc = ext2_read_inode(nas, inumber);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
} </code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] Address of the local array 'namebuf' should not be stored outside the scope of this array. ext2.c 298 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The analyzer detected a suspicious assignment that could potentially lead to undefined behavior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a closer look at the code. Here, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an array created in the local scope of the function, and the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pointer is </font><font style="vertical-align: inherit;">passed to the function by pointer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to C syntax, the name of the array is a pointer to the first element in the memory area in which the array is stored. It turns out that the expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* cp = namebuf will</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> assign the address of the array </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the variable pointed to by </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Since </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> passed to the function by pointer, a change in the value that it points to will be reflected in the place where the function was called. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that after the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_read_symlink</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><i><font style="vertical-align: inherit;">finishes</font></i><font style="vertical-align: inherit;"> its work, its third parameter will indicate the area that the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> array once occupied </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is only one ‚Äúbut‚Äù: since </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an array reserved on the stack, it will be deleted when the function exits. Thus, a pointer that exists outside the function will point to the freed memory.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What will be at that address? </font><font style="vertical-align: inherit;">It is impossible to predict. </font><font style="vertical-align: inherit;">It is possible that for some time the contents of the array will continue to be in memory, or it is possible that the program will immediately erase this area with something else. </font><font style="vertical-align: inherit;">In general, accessing such an address will return an undefined value, and using such a value is a gross error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The analyzer also found another error with the same warning:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] Address of the local variable 'dst_haddr' should not be stored outside the scope of this variable. </font><font style="vertical-align: inherit;">net_tx.c 82</font></font></li>
</ul><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ba/353/6e6/2ba3536e675a564e65b802a3e596fa36.png" alt="Figure 6"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I liked working with the Embox project. Despite the fact that I did not write out all the errors found in the article, the total number of warnings was relatively small, and in general, the project code was written with high quality. Therefore, I express my gratitude to the developers, as well as to those who contributed to the project on behalf of the community. You are great! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I take this opportunity to convey greetings to the developers from Tula. I will believe that in St. Petersburg it‚Äôs not very cold right now :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is where my article comes to an end. I hope you enjoyed reading it, and you found something new for yourself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are interested in PVS-Studio and would like to independently verify some project using it, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">download and try it</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This will take no more than 15 minutes.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to share this article with an English-speaking audience, then please use the link to the translation: George Gribkov. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About embedded again: searching for bugs in the Embox project</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499970/index.html">We study the Mediastreamer2 VoIP engine. Part 12</a></li>
<li><a href="../en499972/index.html">May online events digest</a></li>
<li><a href="../en499974/index.html">3D games on Instagram Javascript, or sausage flight path</a></li>
<li><a href="../en499978/index.html">Translation of Andrew Un's book, Passion for Machine Learning, Chapters 36 and 37</a></li>
<li><a href="../en499982/index.html">Beginner Tester Plan: From ‚ÄúEnter IT‚Äù to ‚ÄúI Am an Engineer!‚Äù</a></li>
<li><a href="../en499988/index.html">Sugar and COVID-19</a></li>
<li><a href="../en499990/index.html">Geocoding How to bind 250 thousand addresses to coordinates in 10 minutes?</a></li>
<li><a href="../en499992/index.html">Design technologies for the implementation of billing systems for corporate clients (part 2)</a></li>
<li><a href="../en499994/index.html">When coronavirus will end</a></li>
<li><a href="../en500000/index.html">To Radio Day. Communication - the nerves of war</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>