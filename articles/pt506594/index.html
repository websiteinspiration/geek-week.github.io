<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéûÔ∏è üôÅ üï¥üèΩ Melhores pr√°ticas do Redis, parte 3 üßëüèø‚Äçü§ù‚Äçüßëüèº üà≥ üêç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tradu√ß√£o final das se√ß√µes Redis Best Practices no site oficial do Redis Labs. O mais incomum e interessante hoje sob o corte!
 
 
 A primeira parte es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Melhores pr√°ticas do Redis, parte 3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506594/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tradu√ß√£o final das se√ß√µes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis Best Practices</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no site oficial do Redis Labs. </font><font style="vertical-align: inherit;">O mais incomum e interessante hoje sob o corte!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hr/6y/f5/hr6yf5w1hp0fh-i5vfa0p1pxeuy.png" width="15%"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira parte est√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o segundo est√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo cont√©m os seguintes t√≥picos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seq√º√™ncias de tempo em conjuntos ordenados;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seq√º√™ncias de tempo em conjuntos lexicograficamente classificados;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seq√º√™ncias de tempo em campos de bits;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">padr√£o b√°sico de limita√ß√£o de largura de banda;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filtro de flores;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contador;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">padr√£o de contagem de bits;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyperLogLog;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts Lua.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dados da sequ√™ncia de tempo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dados da sequ√™ncia de tempo, ou dados com uma ordem de tempo natural, podem ser modelados no Redis de v√°rias maneiras, dependendo dos pr√≥prios dados e da maneira como voc√™ deseja acess√°-los. </font><font style="vertical-align: inherit;">Veremos alguns desses padr√µes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seq√º√™ncias de tempo em conjuntos ordenados;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seq√º√™ncias de tempo em conjuntos lexicograficamente classificados;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seq√º√™ncias de tempo em campos de bits;</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequ√™ncias de tempo em conjuntos classificados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sequ√™ncias de tempo em conjuntos classificados (zsets) s√£o uma maneira t√≠pica de modelar uma sequ√™ncia de tempo no Redis. </font><font style="vertical-align: inherit;">Os conjuntos classificados consistem em objetos √∫nicos cujas pontua√ß√µes s√£o armazenadas em uma chave. </font><font style="vertical-align: inherit;">O uso desse tipo de dados para conjuntos classificados significa que a contagem se comporta como um tipo de indicador de tempo (geralmente √© um carimbo de hora com precis√£o de milissegundos) e o elemento √© um dado gravado. </font><font style="vertical-align: inherit;">O √∫nico benef√≠cio √© que, como essa √© uma forma de conjunto, apenas elementos √∫nicos s√£o permitidos, e tentar gravar sequ√™ncias de tempo com os mesmos valores atualizar√° apenas a pontua√ß√£o. </font><font style="vertical-align: inherit;">Para ilustrar esse problema, tomamos o seguinte exemplo de registro peri√≥dico de temperatura:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carimbo de hora</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temperatura, C</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1586697976001</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1586697977001</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1586697978001</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ simplesmente adicion√°-los ao conjunto classificado usando ZADD, poder√° perder alguns valores: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ANTI-PATTERN</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZADD temperature 1586697976001 21<font></font>
(integer) 1<font></font>
&gt; ZADD temperature 1586697977001 22<font></font>
(integer) 1<font></font>
&gt; ZADD temperature 1586697978001 21<font></font>
(integer) 0<font></font>
&gt; ZRANGEBYSCORE temperature -inf +inf WITHSCORES<font></font>
1) "22"<font></font>
2) "1586697977001"<font></font>
3) "21"<font></font>
4) "1586697978001"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que a terceira chamada para ZADD retorna 0, o que indica que o novo item n√£o foi adicionado ao conjunto. Em ZRANGEBYSCORE, vemos que existem apenas dois registros no conjunto classificado. Por qu√™? Como o primeiro e o terceiro compartilham o mesmo objeto, acabamos de atualizar a conta para esse objeto. Existem v√°rias maneiras de contornar esse problema. Uma delas √© incluir alguns dados aleat√≥rios com varia√ß√£o suficiente, garantindo assim a exclusividade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, crie um n√∫mero real pseudo-aleat√≥rio de 0 a 1, inclusive, depois adicione-o ao nosso registro de data e hora. Em nosso exemplo, vamos deix√°-lo na forma decimal para facilitar a leitura (na realidade, seria mais razo√°vel simplesmente convert√™-lo em uma string de 8 bytes para economizar espa√ßo).</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZADD temperature2 1586697976001 21:1586697976001.2583<font></font>
(integer) 1<font></font>
&gt; ZADD temperature2 1586697977001 22:1586697977001.941678<font></font>
(integer) 1<font></font>
&gt; ZADD temperature2 1586697978001 21:1586697978001.732015<font></font>
(integer) 1<font></font>
&gt; ZRANGEBYSCORE temperature2 -inf +inf WITHSCORES<font></font>
1) "21:1586697976001.2583"<font></font>
2) "1511533205001"<font></font>
3) "22:1586697977001.941678"<font></font>
4) "1586697977001"<font></font>
5) "21:1586697978001.732015"<font></font>
6) "1586697978001"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, todos os ZADDs retornaram 1, indicando uma adi√ß√£o bem-sucedida, e ZRANGEBYSCORE retornou todos os valores. </font><font style="vertical-align: inherit;">Esse √© um m√©todo de trabalho, no entanto, n√£o √© muito eficiente devido ao desperd√≠cio de bytes para garantir a exclusividade, o que aumenta a sobrecarga do armazenamento. </font><font style="vertical-align: inherit;">Na maioria dos casos, a exclusividade ser√° simplesmente removida pelo seu aplicativo. </font><font style="vertical-align: inherit;">Deve-se observar que a adi√ß√£o de exclusividade n√£o √© necess√°ria se seus dados j√° forem exclusivos (por exemplo, dados incluindo UUIDs). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com esse m√©todo, voc√™ tem acesso a todos os m√©todos de conjuntos classificados para an√°lise e controle:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZRANGEBYSCORE permite que voc√™ obtenha uma fatia espec√≠fica entre dois carimbos de data / hora (ZREVRANGEBYSCORE retornar√° a fatia em ordem decrescente);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O ZREMRANGEBYSCORE permite excluir um intervalo espec√≠fico de carimbos de data e hora;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZCOUNT - o n√∫mero de elementos entre o intervalo do registro de data e hora;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZINTERSTORE - permite obter a interse√ß√£o de duas partes de dados e salv√°-las sob uma nova chave;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZUNIONSTORE - permite obter a uni√£o de dois dados e tamb√©m salv√°-lo com uma nova chave. </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode usar isso para duplicar um conjunto classificado.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Opera√ß√µes ZINTERSTORE e ZUNIONSTORE que funcionam com v√°rias chaves. </font><font style="vertical-align: inherit;">Ao trabalhar com um ambiente compartilhado, voc√™ deve ter cuidado para verificar se sua nova chave est√° no mesmo segmento; caso contr√°rio, esses comandos levar√£o a um erro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequ√™ncias de tempo em conjuntos lexicograficamente classificados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra maneira de trabalhar com seq√º√™ncias de tempo √© usar as propriedades lexicogr√°ficas de conjuntos classificados para armazenar um registro de data e hora e valor. Se voc√™ ainda n√£o est√° familiarizado com isso, √© hora de ler </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esta se√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com esse m√©todo, armazenamos tudo com a mesma contagem e primeiro codificamos o carimbo de data e hora e adicionamos o valor como um elemento. Veja um exemplo:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZADD lex-temperature 0 1589392163001:21<font></font>
(integer) 1<font></font>
&gt; ZADD lex-temperature 0 1589392164001:22<font></font>
(integer) 1<font></font>
&gt; ZADD lex-temperature 0 1589392165001:21<font></font>
(integer) 1<font></font>
&gt; ZRANGE lex-temperature 0 -1<font></font>
1) "1589392163001:21"<font></font>
2) "1589392164001:22"<font></font>
3) "1589392165001:21"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nessas tr√™s chamadas do ZADD, o registro de data e hora √© separado do valor por dois pontos, e podemos ver que 1 √© retornado a cada vez, o que significa que todos os tr√™s foram adicionados. No ZRANGE, vemos o pedido salvo. Por qu√™? Em conjuntos classificados, se a pontua√ß√£o for a mesma, os resultados com a mesma pontua√ß√£o ser√£o ordenados por classifica√ß√£o bin√°ria. Como os registros de data e hora nesse per√≠odo t√™m o mesmo n√∫mero de d√≠gitos, tudo ser√° classificado corretamente (se os registros de data e hora forem anteriores a 2002 ou depois de 2285, voc√™ precisar√° de mais d√≠gitos para preencher). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para obter um intervalo de valores desse tipo, use o comando ZRANGEBYLEX:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZRANGEBYLEX lex-temperature (1511533200001 +<font></font>
1) "1589392163001:21"<font></font>
2) "1589392164001:22"<font></font>
3) "1589392165001:21"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo argumento tem um prefixo (indicando a exclusividade do valor (a inclus√£o √© denotada por [). Na pr√°tica, esse formato torna a inclus√£o e a exclusividade irrelevantes, uma vez que o registro de data e hora sempre ser√° seguido por dados adicionais. O terceiro argumento + indica a falta de limites do limite superior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tente obter a data entre 1589392160001 e 1589392165001 inclusive:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZRANGEBYLEX lex-temperature [1589392160001 [1589392165001<font></font>
1) "1589392163001:21"<font></font>
2) "1589392164001:22"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que os dados do registro de data e hora 1589392165001 n√£o foram inclu√≠dos na amostra, apesar do prefixo inclusivo? </font><font style="vertical-align: inherit;">Quero acreditar que Redis de alguma forma entende que esse √© um carimbo de data e hora. </font><font style="vertical-align: inherit;">De fato, o Redis apenas v√™ a classifica√ß√£o bin√°ria. </font><font style="vertical-align: inherit;">Na classifica√ß√£o bin√°ria, 1589392165001: 21 √© maior que 1589392165001 inclusivo ou exclusivo. </font><font style="vertical-align: inherit;">A maneira correta de incluir isso no limite superior √© adicionar 1 milissegundo ao limite superior desejado e usar a exclusividade:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZRANGEBYLEX lex-temperature [1589392160001 (1589392165002<font></font>
1) "1589392163001:21"<font></font>
2) "1589392164001:22"<font></font>
3) "1589392165001:21"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sequ√™ncias tempor√°rias com conjuntos ordenados lexicograficamente t√™m um conjunto semelhante de comandos √∫teis, como sequ√™ncias tempor√°rias com conjuntos ordenados simplesmente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZRANGEBYLEX / ZREVRANGEBYLEX - Obt√©m um intervalo de valores em ordem crescente ou decrescente;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZREMRANGEBYLEX - remove um intervalo classificado espec√≠fico de valores;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZLEXCOUNT - Obt√©m o n√∫mero de elementos em um intervalo classificado de valores.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ZINTERSTORE e o ZUNIONSTORE podem ser usados ‚Äã‚Äãem conjuntos ordenados lexicograficamente, mas h√° um risco de perda de dados, porque combina√ß√µes duplicadas de carimbos de data e hora e valores n√£o ser√£o duplicados no resultado retornado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode se perguntar por que escolher conjuntos ordenados com registro de data e hora em vez de codificar conjuntos ordenados lexicograficamente. </font><font style="vertical-align: inherit;">Como regra, √© melhor trabalhar com conjuntos lexicograficamente classificados para seq√º√™ncias de tempo - se os valores nem sempre forem exclusivos, os carimbos de data e hora ser√£o mais eficazes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequ√™ncias temporais de campo de bits</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis podem efetivamente armazenar seq√º√™ncias de tempo em campos de bits. </font><font style="vertical-align: inherit;">Para fazer isso, voc√™ deve primeiro selecionar um ponto de refer√™ncia arbitr√°rio e um formato num√©rico. </font><font style="vertical-align: inherit;">Veja o exemplo da medi√ß√£o de temperatura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que desejemos medir a temperatura a cada minuto e definiremos o ponto de partida para a meia-noite todos os dias. </font><font style="vertical-align: inherit;">Medimos a temperatura ambiente em graus Celsius. </font><font style="vertical-align: inherit;">Voc√™ pode estruturar os dados da seguinte maneira:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 minuto = byte 0;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a temperatura √© gravada em um n√∫mero n√£o assinado de 8 bits (0-255).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por um dia, os dados s√£o digitados em cerca de 1,44 kb. </font><font style="vertical-align: inherit;">Voc√™ pode registrar a temperatura com o comando BITFIELD:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts SET u8 #0 22<font></font>
1) (integer) 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, usando a tecla bit-ts, o valor da temperatura 22 √© gravado no n√∫mero de 8 bits n√£o assinado (u8) √† meia-noite (# 0) Os </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
campos de bits n√£o se limitam aos valores de 8 bits n√£o assinados. </font><font style="vertical-align: inherit;">Preste aten√ß√£o ao sinal da libra antes do deslocamento. </font><font style="vertical-align: inherit;">Isso significa que o alinhamento ocorrer√° no tipo selecionado. </font><font style="vertical-align: inherit;">Por exemplo, se voc√™ especificar "# 79" - isso significa o 79¬∫ byte, "79" - o 79¬∫ bit (consulte a ajuda do BITFIELD). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O deslocamento pode ser alinhado pelo tipo do n√∫mero armazenado, come√ßando em 0. Por exemplo, se queremos escrever 1 da manh√£, considerando os slots zero, usamos o deslocamento # 59 ou deslocamento # 719 ao meio-dia.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts SET u8 #59 23 SET u8 #719 25<font></font>
1) (integer) 0<font></font>
2) (integer) 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O exemplo tamb√©m mostra que BITFIELD √© vari√°vel, ou seja, </font><font style="vertical-align: inherit;">Voc√™ pode trabalhar com v√°rios valores em uma chamada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicione mais alguns valores:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts SET u8 #60 21 SET u8 #61 20<font></font>
1) (integer) 0<font></font>
2) (integer) 0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora vamos extrair:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts GET u8 #59 GET u8 #60 GET u8 #61<font></font>
1) (integer) 23<font></font>
2) (integer) 21<font></font>
3) (integer) 20</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A assinatura do subcomando GET bit √© semelhante √† assinatura SET, com a √∫nica diferen√ßa de que ele n√£o aceita um valor como terceiro argumento. </font><font style="vertical-align: inherit;">√â normal quando conhecemos todos os √≠ndices que precisamos obter, mas √†s vezes precisamos de uma faixa de valores, e cada byte individualmente ser√° muito estressante. </font><font style="vertical-align: inherit;">Podemos usar o comando GETRANGE. </font><font style="vertical-align: inherit;">Em uma situa√ß√£o normal, √© usado para obter bytes de uma sequ√™ncia, mas os BITFIELDs s√£o apenas outra maneira de endere√ßar os mesmos dados.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; GETRANGE bit-ts 59 61<font></font>
"\x17\x15\x14"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O comando retornou os bytes 59 a 61 em hexadecimal (23, 21 e 20 em decimal. Os idiomas do cliente manipulam os dados bin√°rios melhor que o redis-cli e geralmente podem obter uma matriz de bytes espec√≠fica do idioma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso exemplo, usamos os bytes 0 , 59-61 e 719. O que acontece se solicitarmos bytes que ainda n√£o foram definidos?</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts GET u8 #40<font></font>
1) (integer) 0<font></font>
&gt; BITFIELD bit-ts GET u8 #750<font></font>
1) (integer) 0<font></font>
&gt; GETRANGE bit-ts 30 50<font></font>
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis retorna bytes n√£o especificados como 0. Isso pode causar dificuldades ao trabalhar com dados de sequ√™ncia de tempo - a l√≥gica do aplicativo precisa distinguir entre 0 e um valor indefinido. </font><font style="vertical-align: inherit;">Arredondamentos e omiss√µes de valores 0 s√£o poss√≠veis, especialmente ao usar n√∫meros inteiros assinados, pois esse pode ser um valor v√°lido no meio do seu intervalo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A dura√ß√£o real da sequ√™ncia de tempo realmente depende do √∫ltimo byte. </font><font style="vertical-align: inherit;">No exemplo, o √∫ltimo byte armazenado √© 719, portanto, o comprimento dos dados √© 720 bytes.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; STRLEN bit-ts<font></font>
(integer) 720</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As seq√º√™ncias de tempo baseadas no BITFIELD s√£o um padr√£o poderoso e compacto para armazenar dados num√©ricos ou bin√°rios. </font><font style="vertical-align: inherit;">No entanto, esta solu√ß√£o n√£o cobre todos os casos de uso, e seu uso deve ser cuidadosamente considerado para atender √†s suas necessidades.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Padr√£o b√°sico de limite de largura de banda</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Criar limitadores de largura de banda com Redis √© f√°cil gra√ßas aos comandos INCR e EXPIRE. </font><font style="vertical-align: inherit;">A id√©ia √© que voc√™ deseja limitar solicita√ß√µes a um servi√ßo espec√≠fico por um determinado per√≠odo de tempo. </font><font style="vertical-align: inherit;">Suponha que tenhamos um servi√ßo no qual os usu√°rios sejam identificados por uma chave de API. </font><font style="vertical-align: inherit;">O servi√ßo tem um limite de 20 solicita√ß√µes por minuto. </font><font style="vertical-align: inherit;">Para implementar isso, queremos criar uma chave Redis na chave da API a cada minuto. </font><font style="vertical-align: inherit;">Para n√£o desarrumar o banco de dados, o per√≠odo de validade da chave tamb√©m √© definido como 1 minuto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chave da API - zA21X31, negrito - limite atingido:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis Key</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 1</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 2</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 3</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 4</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Valor</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vinte</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vinte</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expira em</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:02</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:03</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:04</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:05</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:06</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tempo</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:00</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:01</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:02</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:03</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:04</font></font></b></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A chave √© composta da chave da API e do n√∫mero do minuto atrav√©s de dois pontos. </font><font style="vertical-align: inherit;">Como as teclas sempre expiram, basta usar apenas os n√∫meros dos minutos - com o in√≠cio da nova hora, podemos ter certeza de que n√£o existem outras 59 teclas (elas expiraram 59 minutos atr√°s). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver como isso funciona:</font></font><br>
<br>
<ol>
<li><pre><code class="plaintext hljs">&gt; GET [ API]:[ ]</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o resultado for menor que 20 ou n√£o definido, v√° para a etapa 4; caso contr√°rio, v√° para a etapa 3;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exibir uma mensagem de erro, fechar a conex√£o e finalizar;</font></font></li>
<li><pre><code class="plaintext hljs">&gt; MULTI<font></font>
OK<font></font>
&gt; INCR [user-api-key]:[current minute number]<font></font>
QUEUED<font></font>
&gt; EXPIRE [user-api-key]:[current minute number] 59<font></font>
QUEUED<font></font>
&gt; EXEC<font></font>
OK</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continue o programa.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dois pontos principais:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O INCR em uma chave inexistente sempre ser√° 1;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPIRE est√° localizado dentro da transa√ß√£o MULTI junto com o INCR, o que significa que ser√° uma opera√ß√£o at√¥mica.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pior cen√°rio √© se, por alguma raz√£o muito estranha e improv√°vel, o servidor Redis morrer entre INCR e EXPIRE. </font><font style="vertical-align: inherit;">Ao restaurar dados da AOF ou de uma r√©plica na mem√≥ria, o INCR n√£o ser√° restaurado porque a transa√ß√£o n√£o foi conclu√≠da. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao usar esse padr√£o, √© poss√≠vel que um usu√°rio tenha duas chaves: uma que est√° sendo usada no momento e a outra que expira neste minuto. </font><font style="vertical-align: inherit;">No entanto, o padr√£o √© muito eficaz.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filtro Bloom</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O filtro Bloom √© uma estrutura de dados probabil√≠stica interessante que voc√™ pode usar para verificar se um item foi adicionado anteriormente. Aqui est√° o texto intencionalmente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A probabilidade √© que s√≥ possa haver uma resposta falsa positiva, mas n√£o uma falsa negativa. O Bloom Filter fornece uma maneira muito mais compacta e r√°pida de verificar a disponibilidade do que salvar todos os elementos em um conjunto e chamar SISMEMBER.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O filtro Bloom funciona passando um elemento pela fun√ß√£o de hash r√°pido, selecionando bits dele e configurando-os para 1 e 0 em um determinado intervalo no campo de bit. Para verificar a presen√ßa de um filtro, os mesmos bits s√£o selecionados. Muitos elementos podem ter bits que se sobrep√µem, mas como a fun√ß√£o hash cria identificadores exclusivos, se um bit do hash ainda √© 0, sabemos que ele n√£o foi adicionado antes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Redis usa o filtro h√° muitos anos como uma biblioteca cliente que usa GETBIT e SETBIT para trabalhar com campos de bits. Felizmente, o m√≥dulo ReBloom est√° dispon√≠vel no Redis 4.0, o que elimina a necessidade de criar sua pr√≥pria implementa√ß√£o do filtro Bloom.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um bom caso de uso para esse filtro √© verificar se o nome de usu√°rio j√° foi usado. </font><font style="vertical-align: inherit;">N√£o h√° problemas com tamanhos de dados pequenos, mas √† medida que o servi√ßo cresce, as consultas ao banco de dados podem ser caras. </font><font style="vertical-align: inherit;">Isso √© f√°cil de corrigir com o ReBloom. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicione alguns nomes para o teste:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BF.ADD usernames funnyfred<font></font>
(integer) 1<font></font>
&gt; BF.ADD usernames fredisfunny<font></font>
(integer) 1<font></font>
&gt; BF.ADD usernames fred<font></font>
(integer) 1<font></font>
&gt; BF.ADD usernames funfred<font></font>
(integer) 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora teste o filtro Bloom:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BF.EXISTS usernames fred<font></font>
(integer) 1<font></font>
&gt; BF.EXISTS usernames fred_is_funny<font></font>
(integer) 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como esperado, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fred_is_funny</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornou 0. Isso significa que esse nome n√£o foi usado. </font><font style="vertical-align: inherit;">Embora seja imposs√≠vel dizer com certeza, uma vez que os bits podem simplesmente se sobrepor entre v√°rios elementos. </font><font style="vertical-align: inherit;">Basicamente, a chance de falsos positivos √© baixa, mas n√£o √© igual a 0. √Ä medida que o filtro Bloom √© preenchido, a chance aumenta, mas voc√™ pode ajustar a taxa de erro e o tamanho inicial (o padr√£o √© 0,01 e 100, respectivamente).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contador</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um contador no Redis pode ser implementado de v√°rias maneiras. </font><font style="vertical-align: inherit;">O mais √≥bvio √© INCR et al (INCRBY, INCRBYFLOAT, HINCRBY, HINCRBYFLOAT, ZINCRBY), que pode ser encontrado simplesmente lendo a documenta√ß√£o. </font><font style="vertical-align: inherit;">Menos √≥bvio √© o uso de BITCOUNT e PFADD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Padr√£o de contagem de bits</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BITCOUNT conta o n√∫mero de bits definido como 1 no campo de bits por chave. </font><font style="vertical-align: inherit;">Isso pode ser usado para calcular uma s√©rie de atividades durante um per√≠odo arbitr√°rio de tempo (semelhante ao padr√£o de seq√º√™ncias de tempo nos campos de bits). </font><font style="vertical-align: inherit;">O processo √© escolher um ponto no tempo e cada bit representa uma unidade de per√≠odo. </font><font style="vertical-align: inherit;">Cada vez que uma a√ß√£o √© executada durante esse per√≠odo, execute SETBIT a uma dist√¢ncia de 1 unidade do √∫ltimo ponto.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:00</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:02</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:03</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:04</font></font></th>
</tr>
<tr>
<td></td>
<td><pre><code class="plaintext hljs">&gt; SETBIT btct 2 1</code></pre></td>
<td><pre><code class="plaintext hljs">&gt; SETBIT btct 3 1</code></pre></td>
<td><pre><code class="plaintext hljs">&gt; SETBIT btct 4 1</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ponto de partida]</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aja</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aja</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aja</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para calcular em que minutos das 12:00 √†s 12:30 atividades ocorreu, voc√™ pode fazer o seguinte:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITCOUNT btct 0 30<font></font>
(integer) 3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, esse padr√£o responde √† pergunta ‚ÄúQuantas vezes?‚Äù Em vez de ‚ÄúQuantas vezes?‚Äù. </font><font style="vertical-align: inherit;">Por exemplo, um usu√°rio pode estar ativo 20 vezes em um minuto, mas isso contar√° como 1. A </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vantagem real desse modelo √© que ele fornece a pontua√ß√£o m√≠nima poss√≠vel por um determinado per√≠odo de tempo, j√° que os bits s√£o os blocos de armazenamento mais elementares. </font><font style="vertical-align: inherit;">Este √© literalmente o menor reposit√≥rio (n√£o compactado) para contagem.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyperLogLog</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contar itens exclusivos pode ser complicado. Isso geralmente significa armazenar cada elemento exclusivo e, em seguida, invocar essas informa√ß√µes de alguma forma. No Redis, isso pode ser feito usando muitas e uma equipe, no entanto, tanto o volume ocupado quanto a complexidade de tempo ser√£o muito grandes. O HyperLogLog fornece uma alternativa probabil√≠stica. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O HyperLogLog √© internamente semelhante a um filtro Bloom, tamb√©m alimenta elementos atrav√©s de uma fun√ß√£o hash n√£o criptogr√°fica e define bits em um campo de bits. Por√©m, diferentemente do filtro Bloom, o HyperLogLog armazena um contador de elementos, que √© incrementado quando um novo elemento √© adicionado que n√£o foi adicionado antes. Isso fornece uma baixa taxa de erro ao contar elementos √∫nicos em um conjunto. O HyperLogLog est√° embutido no Redis.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem 3 comandos HyperLogLog no Redis: PFADD, PFCOUNT e PFMERGE. </font><font style="vertical-align: inherit;">Digamos que criamos um scanner da web e queremos contar o n√∫mero de URLs exclusivos de p√°ginas visualizadas durante o dia. </font><font style="vertical-align: inherit;">Para cada p√°gina, execute o seguinte comando:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PFADD crawled:20200613 "http://www.google.com/"<font></font>
(integer) 1<font></font>
&gt; PFADD crawled:20200613 "http://www.redislabs.com/"<font></font>
(integer) 1<font></font>
&gt; PFADD crawled:20200613 "http://www.redis.io/"<font></font>
(integer) 1<font></font>
&gt; PFADD crawled:20200614 "http://www.redisearch.io/"<font></font>
(integer) 1<font></font>
&gt; PFADD crawled:20200614 "http://www.redis.io/"<font></font>
(integer) 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada chave acima √© indexada por dia. </font><font style="vertical-align: inherit;">Para ver quantas p√°ginas foram visualizadas em 13/06/2020, voc√™ pode fazer o seguinte:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PFCOUNT crawled:20200613<font></font>
(integer) 3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para visualizar o n√∫mero de p√°ginas de 13/06/2020 e 14/06/2020, use o comando PFMERGE para criar uma nova chave com um valor que combine dois contadores. </font><font style="vertical-align: inherit;">Observe que, como </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.redis.io</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© armazenado em ambos os conjuntos, ele ser√° calculado uma vez:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PFMERGE crawled:20200613-14 crawled:20200613 crawled:20200614<font></font>
OK<font></font>
&gt; PFCOUNT crawled:20200613-14<font></font>
(integer) 4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa opera√ß√£o pode funcionar com v√°rias chaves, portanto, tenha cuidado em um ambiente dividido, para que as chaves estejam no mesmo fragmento.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts Lua</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os Redis podem fazer coisas incr√≠veis apenas a partir de "redis-cli" e ainda mais entre Redis e sua linguagem de programa√ß√£o. √Äs vezes, por√©m, pode ser necess√°rio um comportamento que n√£o pode ser obtido na arquitetura cliente-servidor devido a problemas de efici√™ncia ou seguran√ßa - a l√≥gica precisa ser executada na camada do banco de dados. Nesses casos, Lua vem em socorro. Lua trabalha no Redis como uma linguagem de script. Com ele, voc√™ pode executar o c√≥digo no Redis, sem o custo de transporte de e para o cliente.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um caso de teste est√° adicionando um valor a um campo de hash. </font><font style="vertical-align: inherit;">Embora os Redis possam adicionar facilmente um valor a uma chave de cadeia usando APPEND, n√£o h√° comando para adicionar um valor a um campo de hash. </font><font style="vertical-align: inherit;">Voc√™ pode tentar obter isso extraindo o valor do cliente, adicionando uma nova linha ao valor e eliminando os campos de hash, mas isso √© uma m√° ideia. </font><font style="vertical-align: inherit;">Como isso n√£o √© at√¥mico, √© prov√°vel que, enquanto voc√™ adiciona um valor, outro cliente possa alter√°-lo mais cedo e voc√™ substitua o novo valor.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente 1</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente 2</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 1</font></font></td>
<td><pre><code class="plaintext hljs">&gt; HGET myhash myfield</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ol√° retorna]</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[adiciona "mundo" a "ol√°"]</font></font></td>
<td><pre><code class="plaintext hljs">&gt; HSET myhash myfield "goodbye"</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><pre><code class="plaintext hljs">&gt; HSET myhash myfield "hello world"</code></pre></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; HGET myhash myfield</code></pre></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver na linha 2, a atualiza√ß√£o ser√° perdida. </font><font style="vertical-align: inherit;">Voc√™ pode usar scripts Lua para solucionar esse problema e remover o custo de envio / recebimento de valores do cliente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em qualquer editor de texto, crie um script e chame-o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aconteceu.lua</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="lua hljs"><span class="hljs-keyword">local</span> original = redis.call(<span class="hljs-string">'HGET'</span>,KEYS[<span class="hljs-number">1</span>],ARGV[<span class="hljs-number">1</span>])
<span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'HSET'</span>,KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>], original .. ARGV[<span class="hljs-number">2</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na primeira linha, crie uma vari√°vel local </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">original</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , na qual salvamos o valor atual da chave de hash do primeiro argumento passado e o campo √© o primeiro argumento n√£o-chave. √â importante entender que os scripts Lua em tempo de execu√ß√£o distinguem entre argumentos chave e n√£o chave. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na segunda linha, HSET √© chamado para a mesma chave e campo e, em seguida, combinamos o valor original com o segundo argumento n√£o-chave. Isso retorna ao Redis, portanto, manteremos o valor de retorno HSET original.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A execu√ß√£o direta de scripts Lua com o comando EVAL pode ser confusa e ineficiente. </font><font style="vertical-align: inherit;">O Redis possui um cache de script interno que permite pr√©-carregar o script e acess√°-lo usando o hash SHA1 do script principal. </font><font style="vertical-align: inherit;">Voc√™ pode baixar esse script na linha de comando usando "cat" e "redis-cli". </font><font style="vertical-align: inherit;">Observe que, se seu script diferir em pelo menos um caractere, ele ter√° um hash completamente diferente.</font></font><br>
<br>
<pre><code class="bash hljs">$ redis-cli -a yourRedisPassword SCRIPT LOAD <span class="hljs-string">"<span class="hljs-subst">$(cat ./happend.lua)</span>"</span>
<span class="hljs-string">"d30c7f6d0c23fcfe6d4630b11f4e3db4cb2db099"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ pode usar EVALSHA para chamar o script e adicionar:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; HSET mynewhash greeting "Hello"<font></font>
(integer) 1<font></font>
&gt; EVALSHA d30c7f6d0c23fcfe6d4630b11f4e3db4cb2db099 1 mynewhash greeting " world"<font></font>
(integer) 0<font></font>
&gt; HGET mynewhash greeting<font></font>
"Hello world"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro argumento para o comando EVALSHA √© o hash do script gerado pelo SCRIPT LOAD. O segundo argumento √© o n√∫mero de chaves. No nosso caso, a chave √© uma. O terceiro argumento √© a chave na qual executamos a a√ß√£o. E, finalmente, o quarto √© o valor que adicionamos ao campo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como a adi√ß√£o ocorre dentro do script Lua, o script acima ser√° interrompido porque os scripts Lua s√£o executados de forma s√≠ncrona e at√¥mica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora Lua possa ser muito √∫til na resolu√ß√£o de problemas, voc√™ precisa us√°-lo com cuidado. O script bloqueia o servidor e pode levar a um banco de dados n√£o responsivo. Em situa√ß√µes de sharding, os scripts tentam salvar todas as opera√ß√µes em um √∫nico servidor para evitar erros cruzados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â aqui que a se√ß√£o Redis Best Practices termina. </font><font style="vertical-align: inherit;">N√£o tenha medo de experimentar, o Redis √© muito rico em funcionalidades. </font><font style="vertical-align: inherit;">Deixe seus casos de uso interessantes nos coment√°rios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que as t√©cnicas descritas o ajudem, se n√£o diretamente, pelo menos apontando o caminho certo para resolver problemas!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt506574/index.html">Visualiza√ß√£o de uma lista de mulheres vencedoras do Pr√™mio Nobel na forma de cristais em 3d usando Vue, WebGL, three.js</a></li>
<li><a href="../pt506578/index.html">Volume de chumbo gerenciado</a></li>
<li><a href="../pt506586/index.html">FizzBuzz l√≥gico</a></li>
<li><a href="../pt506588/index.html">O que √© um algoritmo! (parte 2)</a></li>
<li><a href="../pt506590/index.html">Confer√™ncia DEVOXX UK. Escolha uma estrutura: Docker Swarm, Kubernetes ou Mesos. Parte 2</a></li>
<li><a href="../pt506598/index.html">Microsoft: Rust —è–≤–ª—è–µ—Ç—Å—è '–ª—É—á—à–∏–º —à–∞–Ω—Å–æ–º' –≤ –æ—Ç—Ä–∞—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º</a></li>
<li><a href="../pt506600/index.html">O contrato para o desenvolvimento do site em termos de gerenciamento de projetos (teoria + amostra)</a></li>
<li><a href="../pt506604/index.html">Simultaneidade e efici√™ncia: Python vs FSM</a></li>
<li><a href="../pt506606/index.html">Cria√ß√£o de clicker PIXI.js</a></li>
<li><a href="../pt506610/index.html">WAL-G: Backups e recupera√ß√£o de banco de dados PostgreSQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>