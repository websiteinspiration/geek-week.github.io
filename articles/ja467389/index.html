<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐟 😟 🤽🏾 Pinterestシャーディング：MySQL Parkのスケーリング方法 🔢 🕺🏾 🏕️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="敬礼、ハブロバイト！プログラマの日すべてにおめでとうと、コース「高負荷アーキテクト」の学生のために特別に準備された記事の翻訳を共有します。
 
 
 
 「シャーディング。またはシャードしないでください。しようとせず。」
 -ヨーダ
 
 今日は、いくつかのMySQLサーバー間のデータの分離に突入し...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pinterestシャーディング：MySQL Parkのスケーリング方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/467389/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">敬礼、ハブロバイト！プログラマの日すべてにおめでとうと、コース</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「高負荷アーキテクト」の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">学生のために特別に準備された記事の翻訳を共有し</font><font style="vertical-align: inherit;">ます。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/3o/s-/k6/3os-k6l2f122mbs6d1lufcif6ke.png"><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「シャーディング。またはシャードしないでください。しようとせず。」</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -ヨーダ</font></font></i></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
今日は、いくつかのMySQLサーバー間のデータの分離に突入します。 2012年の初めにシャーディングを終了しましたが、このシステムは引き続き基本データの保存に使用されます。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを共有する方法について説明する前に、データをよりよく理解しましょう。</font><font style="vertical-align: inherit;">心地よい照明を設定し、チョコレートにイチゴを入れて、スタートレックからの引用を思い出します... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pinterestは、興味のあるすべてのものの検索エンジンです。</font><font style="vertical-align: inherit;">データに関しては、Pinterestは世界中の人間の関心の最大のグラフです。</font><font style="vertical-align: inherit;">これには、ユーザーが10億以上のボードに保存した500億を超えるピンが含まれています。</font><font style="vertical-align: inherit;">人々はいくつかのピンを自分のために保持し、他のピンと同様に、他のピン、ボード、および興味を購読し、購読しているすべてのピン、ボード、および興味のホームフィードを表示します。</font><font style="vertical-align: inherit;">いいね！</font><font style="vertical-align: inherit;">それでは、スケーラブルにしましょう！</font></font><br>
 <br>
 <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">痛みを伴う成長</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 2011年、私たちは勢いを増し始めました。</font><font style="vertical-align: inherit;">一部の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">見積もり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、その時点で知られているどのスタートアップよりも速く成長しました。</font><font style="vertical-align: inherit;">2011年9月頃、インフラストラクチャのすべてのコンポーネントが過負荷になりました。</font><font style="vertical-align: inherit;">私たちはいくつかのNoSQLテクノロジを自由に利用できましたが、それらすべては悲惨なことに対応できませんでした。</font><font style="vertical-align: inherit;">多くのMySQLスレーブもありましたが、これは以前は読み取りを行っていたため、特にキャッシングの際に多くの異常なエラーを引き起こしていました。</font><font style="vertical-align: inherit;">データストレージモデル全体を再構築しました。</font><font style="vertical-align: inherit;">効率的に作業するために、要件の開発に注意深く取り組みました。</font></font><br>
 <br>
 <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要条件</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム全体は非常に安定していて、使いやすく、サイトが大きくなるにつれて、小さな箱のサイズから月のサイズまで拡大する必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ピンナーによって生成されたすべてのコンテンツは、いつでもサイトで利用できる必要があります。</font></font></li>
<li>    N       (,         ,  ).      ,    ..</li>
<li> ,     .    ,   ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.    ( ) !</li>
</ul><br>
<h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデータが複数のデータベースにまたがるようにしたいので、データベースにまたがらないサブクエリに使用することはできますが、結合、外部キー、インデックスだけを使用してすべてのデータを収集することはできませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、データの負荷分散を維持する必要もありました。要素ごとにデータを移動すると、システムが不必要に複雑になり、多くのエラーが発生すると判断しました。データを移動する必要がある場合は、仮想ノード全体を別の物理ノードに移動することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの実装が迅速に流通するためには、最もシンプルで最も便利なソリューションと分散データプラットフォームの非常に安定したノードが必要でした。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
高可用性とMapReduceのS3へのダンプを使用して、すべてのデータをスレーブマシンに複製してバックアップを作成する必要がありました。</font><font style="vertical-align: inherit;">私たちは、生産でのみマスターと対話します。</font><font style="vertical-align: inherit;">本番環境では、スレーブでの書き込みまたは読み取りは必要ありません。</font><font style="vertical-align: inherit;">スレーブラグ、それは奇妙なバグを引き起こします。</font><font style="vertical-align: inherit;">シャーディングが行われた場合、本番環境でスレーブと対話する意味がありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、すべてのオブジェクトのユニバーサル一意識別子（UUID）を生成するための適切な方法が必要です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シャーディングの方法</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが作成しようとしているものは、要件を満たし、安定して動作し、一般に、実行可能で保守可能であると想定されていました。</font><font style="vertical-align: inherit;">そのため、基盤となるテクノロジーとして、すでにかなり成熟した</font><font style="vertical-align: inherit;">MySQL </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テクノロジー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を選択しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">MongoDB、Cassandra、Membaseの自動スケーリングのための新技術は、成熟から十分にかけ離れているため（そして私たちの場合、それらは印象的な方法で壊れました！）、意図的に警戒しています。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに、私はまだ新奇なことを避けるためにスタートアップをお勧めします-MySQLを使ってみてください。</font><font style="vertical-align: inherit;">私を信じて。</font><font style="vertical-align: inherit;">傷跡で証明できます。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL-テクノロジーは実績があり、安定しており、シンプルです-それは機能します。使用するだけでなく、スケールがさらに印象的な他社にも人気です。 MySQLは、データクエリを合理化し、特定のデータ範囲と行レベルのトランザクションを選択するという私たちのニーズを完全に満たします。実際、彼の兵器庫にははるかに多くの機会がありますが、私たち全員がそれらを必要とするわけではありません。しかし、MySQLは「ボックス化」ソリューションであるため、データを分割する必要がありました。これは私たちのソリューションがどのように見えるかです：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8つのEC2サーバー、それぞれにMySQLの1つのインスタンスから始めました：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e0/d0/o0/e0d0o0fijurp6mabuvbwecacnfi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各MySQLマスター/マスターサーバーは、プライマリ障害が発生した場合にバックアップホストに複製されます。当社の本番サーバーは、マスターに対してのみ読み取りまたは書き込みを行います。あなたもそうすることをお勧めします。これにより、レプリケーションの遅延によるエラーが大幅に簡素化および回避されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各MySQLエンティティには多くのデータベースがあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zf/vl/sx/zfvlsxbhhh6uict7kf9ly6f2y9m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各データベースは一意に名前が付けられていることに注意してください：db00000、db00001からdbNNNNN。各データベースはデータの断片です。私たちは、データの一部のみがシャードに分類され、このシャードを超えることは決してないことに基づいて、アーキテクチャ上の決定を行いました。ただし、シャードを他のマシンに移動することで、容量を増やすことができます（これについては後で説明します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どのマシンにシャードがあるかを示す構成テーブルを操作します。</font></font><br>
<br>
<pre><code class="bash hljs">[{“range”:     (0,511), “master”: “MySQL001A”, “slave”: “MySQL001B”},<font></font>
 {“range”: (512, 1023), “master”: “MySQL002A”, “slave”: “MySQL002B”},<font></font>
    ...<font></font>
 {“range”: (3584, 4095), “master”: “MySQL008A”, “slave”: “MySQL008B”}]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この構成は、シャードを移動するか、ホストを置き換える必要がある場合にのみ変更されます。</font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">死にかけている</font><font style="vertical-align: inherit;">場合</font><font style="vertical-align: inherit;">は、既存のものを使用してから</font></font><code>slave</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、新しいものを調達</font><font style="vertical-align: inherit;">できます</font><font style="vertical-align: inherit;">。設定は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZooKeeperに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり、更新されると、MySQLシャードを提供するサービスに送信されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
：各テーブルには、同じセットのシャード</font></font><code>pins</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>boards</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>users_has_pins</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>users_likes_pins</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>pin_liked_by_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、などこれについては、少し後で説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの断片のデータをどのように配布しますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シャードIDを含む64ビットのID、それに含まれるデータのタイプ、およびこのデータがテーブルにある場所（ローカルID）を作成します。</font><font style="vertical-align: inherit;">シャードIDは16ビットで構成され、タイプIDは10ビット、ローカルIDは36ビットです。</font><font style="vertical-align: inherit;">上級数学者は62ビットしかないことに気付くでしょう。</font><font style="vertical-align: inherit;">コンパイラと回路基板の開発者としての過去の経験から、バックアップビットは金の価値に見合う価値があると教えられました。</font><font style="vertical-align: inherit;">したがって、そのようなビットが2つあります（ゼロに設定）。</font></font><br>
<br>
<pre><code class="bash hljs">ID = (shard ID &lt;&lt; 46) | (<span class="hljs-built_in">type</span> ID &lt;&lt; 36) | (<span class="hljs-built_in">local</span> ID&lt;&lt;0)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このピンを見てみましょう：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ://www.pinterest.com/pin/241294492511762325/、そのID 241294492511762325を分析しましょう：</font></font><br>
<br>
<pre><code class="bash hljs">Shard ID = (241294492511762325 &gt;&gt; 46) &amp; 0xFFFF = 3429<font></font>
Type ID  = (241294492511762325 &gt;&gt; 36) &amp; 0x3FF = 1<font></font>
Local ID = (241294492511762325 &gt;&gt;  0) &amp; 0xFFFFFFFFF = 7075733</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ピンオブジェクトは3429シャードに存在します。</font><font style="vertical-align: inherit;">そのタイプは「1」（つまり「ピン」）で、ピンテーブルの行7075733にあります。</font><font style="vertical-align: inherit;">たとえば、このシャードがMySQL012Aにあるとしましょう。</font><font style="vertical-align: inherit;">次のようにしてアクセスできます。</font></font><br>
<br>
<pre><code class="bash hljs">conn = MySQLdb.connect(host=”MySQL012A”)<font></font>
conn.execute(“SELECT data FROM db03429.pins <span class="hljs-built_in">where</span> local_id=7075733”)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データには、オブジェクトとマッピングの2種類があります。</font><font style="vertical-align: inherit;">オブジェクトには、ピンデータなどのパーツが含まれます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトテーブル</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ピン、ユーザー、ボード、コメントなどのオブジェクトテーブルには、ID（ローカルID、主キーが自動的に増加する）と、すべてのオブジェクトデータを含むJSONを含むblobがあります。</font></font><br>
<br>
<pre><code class="bash hljs">CREATE TABLE pins (<font></font>
  local_id INT PRIMARY KEY AUTO_INCREMENT,<font></font>
  data TEXT,<font></font>
  ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP<font></font>
) ENGINE=InnoDB;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、ピンオブジェクトは次のようになります。</font></font><br>
<br>
<pre><code class="bash hljs">{“details”: “New Star Wars character”, “link”: “http://webpage.com/asdf”, “user_id”: 241294629943640797, “board_id”: 241294561224164665, …}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいピンを作成するには、すべてのデータを収集し、JSON BLOBを作成します。</font><font style="vertical-align: inherit;">次に、シャードIDを選択します（シャードIDを配置するボードと同じシャードIDを選択することをお勧めしますが、これは必須ではありません）。</font><font style="vertical-align: inherit;">ピンタイプ1の場合、このデータベースに接続し、JSONをピンテーブルに挿入します。</font><font style="vertical-align: inherit;">MySQLは自動的に増加するローカルIDを返します。</font><font style="vertical-align: inherit;">これでシャード、タイプ、新しいローカルIDができたので、完全な64ビットの識別子を作成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ピンを編集するには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQLトランザクション</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してJSONを読み取り、変更、書き込みし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">&gt; BEGIN<font></font>
&gt; SELECT blob FROM db03429.pins WHERE local_id=7075733 FOR UPDATE<font></font>
[Modify the json blob]<font></font>
&gt; UPDATE db03429.pins SET blob=’&lt;modified blob&gt;’ WHERE local_id=7075733<font></font>
&gt; COMMIT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ピンを削除するには、MySQLでその行を削除できます。</font><font style="vertical-align: inherit;">ただし、JSONに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「アクティブ」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドを追加</font><font style="vertical-align: inherit;">して</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「false」に</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定</font><font style="vertical-align: inherit;">し、クライアント側で結果をフィルタリングすることをお勧めします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マッピングテーブル</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マッピングテーブルは、1つのオブジェクトを別のオブジェクト、たとえばピンのあるボードにリンクします。マッピング用のMySQLテーブルには3つの列が含まれます。ID「from」の64ビット、ID「where」の64ビット、およびシーケンスID。このトリプル（from、where、sequence）にはインデックスキーがあり、それらは識別子「from」の断片にあります。</font></font><br>
<br>
<pre><code class="bash hljs">CREATE TABLE board_has_pins (<font></font>
  board_id INT,<font></font>
  pin_id INT,<font></font>
  sequence INT,<font></font>
  INDEX(board_id, pin_id, sequence)<font></font>
) ENGINE=InnoDB;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マッピングテーブルは、テーブルのように単方向</font></font><code>board_has_pins</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。反対方向が必要な場合は、別のテーブルが必要になります</font></font><code>pin_owned_by_board</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。シーケンスIDはシーケンスを定義します（新しいローカルIDが異なるため、シャード間でIDを比較することはできません）。通常、新しいボードに新しいピンを挿入します。シーケンスIDはunix（unixタイムスタンプ）の時間と同じです。シーケンスには任意の数を含めることができますが、このインジケータは単調に増加するため、unix時間は新しい材料を順次格納するのに適した方法です。マッピングテーブルのデータを確認できます。</font></font><br>
<br>
<pre><code class="bash hljs">SELECT pin_id FROM board_has_pins <font></font>
WHERE board_id=241294561224164665 ORDER BY sequence <font></font>
LIMIT 50 OFFSET 150</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、50を超えるpin_idが得られ、これを使用してpinオブジェクトを検索できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先ほど行ったのは、アプリケーション層の結合です（board_id-&gt; pin_id-&gt; pinオブジェクト）。</font><font style="vertical-align: inherit;">アプリケーションレベルでの接続の驚くべき特性の1つは、オブジェクトとは別に画像をキャッシュできることです。</font><font style="vertical-align: inherit;">pin_idはmemcacheクラスターのpinオブジェクトのキャッシュに保存しますが、redisクラスターのpin_idにはboard_idを保存します。</font><font style="vertical-align: inherit;">これにより、キャッシュされたオブジェクトに最適なテクノロジーを選択できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">容量を増やす</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムの容量を増やすには、主に3つの方法があります。マシンを更新する最も簡単な方法（スペースを増やす、より高速なハードドライブ、RAMを増やす）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
容量を増やす次の方法は、新しい範囲を開くことです。シャードIDが16ビット（合計64kシャード）で構成されていたにもかかわらず、最初は合計4096のシャードを作成しました。新しいオブジェクトは、これらの最初の4kシャードでのみ作成できます。ある時点で、4096から8191のシャードを使用して新しいMySQLサーバーを作成することを決定し、それらを埋め始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
容量を増やす最後の方法は、一部のシャードを新しいマシンに移動することです。</font><font style="vertical-align: inherit;">MySQL001A（シャードを0から511に）の容量を増やしたい場合は、次の可能な名前（MySQL009AとBなど）で新しいマスター/マスターペアを作成し、MySQL001Aからレプリケーションを開始します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d2/uf/gd/d2ufgd1tttsa6tmxvpywfzgqugs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レプリケーションが完了したらすぐに、MySQL001Aには0〜255のシャードのみ、MySQL009Aには256〜511のシャードのみが存在するように構成を変更します。これで、各サーバーは以前に処理したシャードの半分のみを処理するようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/cp/do/4fcpdo2g16molbdkkfbf8xvujbi.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかのクールな機能</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UUID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を生成するためのシステムをすでに持っている人は</font><font style="vertical-align: inherit;">、このシステムで無料でそれらを取得できることを理解するでしょう！新しいオブジェクトを作成してオブジェクトのテーブルに挿入すると、新しいローカル識別子が返されます。このローカルIDは、シャードIDおよびタイプIDと組み合わせて、UUIDを提供します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQLテーブルに列を追加するためにALTERを実行したことがある人は、それらが非常に遅く動作し、大きな問題になる可能性があることを知っています。</font><font style="vertical-align: inherit;">私たちのアプローチでは、MySQLレベルの変更は必要ありません。</font><font style="vertical-align: inherit;">Pinterestでは、おそらく過去3年間で1つだけALTERを作成しました。</font><font style="vertical-align: inherit;">オブジェクトに新しいフィールドを追加するには、JSONスキーマにいくつかの新しいフィールドがあることをサービスに伝えます。</font><font style="vertical-align: inherit;">デフォルト値を変更して、新しいフィールドのないオブジェクトからJSONを逆シリアル化するときに、デフォルト値を取得できます。</font><font style="vertical-align: inherit;">マッピングテーブルが必要な場合は、新しいマッピングテーブルを作成し、必要なときにいつでも使用できるようにします。</font><font style="vertical-align: inherit;">完了したら、送信できます！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modシャード</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まるで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mod squadの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ようですが、</font><font style="vertical-align: inherit;">まったく違うだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部のオブジェクトは、IDなしで見つける必要があります。たとえば、ユーザーがFacebookアカウントでログインする場合、Facebook IDからPinterest IDへのマッピングが必要です。私たちにとって、Facebook IDはほんの一部なので、mod shardと呼ばれる別のシャードシステムに保存します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その他の例には、IPアドレス、ユーザー名、電子メールアドレスが含まれます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mod Shardは、前のセクションで説明したシャーディングシステムと非常に似ていますが、唯一の違いは、任意の入力データを使用してデータを検索できることです。この入力はハッシュされ、システム内のシャードの総数に応じて変更されます。その結果、データが配置される、または既に配置されているシャードが取得されます。例えば：</font></font><br>
<br>
<pre><code class="bash hljs">shard = md5(“1.2.3.4<span class="hljs-string">") % 4096</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、シャードは1524になります。シャードIDに対応する構成ファイルを処理します。</font></font><br>
<br>
<pre><code class="bash hljs">[{“range”:    (0,  511), “master”: “msdb001a”, “slave”: “msdb001b”},<font></font>
  {“range”:  (512, 1023), “master”: “msdb002a”, “slave”: “msdb002b”},<font></font>
  {“range”: (1024, 1535), “master”: “msdb003a”, “slave”: “msdb003b”},<font></font>
…]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、IPアドレス1.2.3.4のデータを見つけるには、次の手順を実行する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">conn = MySQLdb.connect(host=”msdb003a”)<font></font>
conn.execute(“SELECT data FROM msdb001a.ip_data WHERE ip=<span class="hljs-string">'1.2.3.4'</span>”)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
空間的局所性など、一部の適切なシャードIDプロパティが失われています。</font><font style="vertical-align: inherit;">最初に作成されたすべてのシャードから始めて、自分でキーを作成する必要があります（自動的に生成されません）。</font><font style="vertical-align: inherit;">常に不変のIDを使用してシステム上のオブジェクトを表すことをお勧めします。</font><font style="vertical-align: inherit;">これにより、たとえばユーザーが「ユーザー名」を変更したときに、多くのリンクを更新する必要がなくなります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後の考え</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このシステムは、Pinterestで3.5年間運用されており、永遠にそこに留まる可能性があります。その実装は比較的単純でしたが、それを運用して古いマシンからすべてのデータを移動することは困難でした。新しいシャードを最初に作成したときに問題が発生した場合は、バックグラウンド処理マシンのクラスター（ヒント：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パイレスを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">）を作成して、スクリプトを</font><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">てデータを古いデータベースから新しいシャードに移動する</font><font style="vertical-align: inherit;">ことを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">検討</font></a><font style="vertical-align: inherit;">してください。どんなに頑張っても、データの一部が失われることを保証します（すべてグレムリンです、誓います）。シャード内の新しい情報の量が非常に少なくなるかまったくなくなるまで、何度もデータ転送を繰り返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このシステムにはあらゆる努力が払われています。</font><font style="vertical-align: inherit;">ただし、原子性、分離、または一貫性は保証されません。</font><font style="vertical-align: inherit;">うわー！</font><font style="vertical-align: inherit;">悪いですね！</font><font style="vertical-align: inherit;">でも心配はいりません。</font><font style="vertical-align: inherit;">きっと、あなたはそれらなしで素晴らしい気分になるでしょう。</font><font style="vertical-align: inherit;">必要に応じて、他のプロセスやシステムでこれらのレイヤーをいつでも構築できますが、デフォルトで無料で、かなりの量の稼働時間を得ることができます。</font><font style="vertical-align: inherit;">シンプルさによって達成された信頼性、さらには高速で動作します！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、耐障害性はどうですか？</font><font style="vertical-align: inherit;">MySQLシャードにサービスを提供するサービスを作成し、シャード構成テーブルをZooKeeperに保存しました。</font><font style="vertical-align: inherit;">マスターサーバーがクラッシュすると、スレーブマシンを上げてから、それを置き換えるマシンを上げます（常に最新の状態です）。</font><font style="vertical-align: inherit;">当日まで自動故障処理は行っておりません。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467377/index.html">3行連続：メビウス2019 Piterの上位10レポート</a></li>
<li><a href="../ja467381/index.html">18ルーブルの多階建てLED、スマートライト、電球</a></li>
<li><a href="../ja467383/index.html">「マネージャーはコーディングを続ける必要がある」：Stephen Chinへのインタビュー</a></li>
<li><a href="../ja467385/index.html">Java開発者インタビューからの心理的および非定型的な技術的質問の選択</a></li>
<li><a href="../ja467387/index.html">フィードバックとカスタマーエクスペリエンスを操作するためのソリューション：小規模なサービスから重いプラットフォームまで</a></li>
<li><a href="../ja467391/index.html">YandexがRPKIを導入</a></li>
<li><a href="../ja467393/index.html">NX Bootcampは10月に始まります</a></li>
<li><a href="../ja467395/index.html">Habr Weekly＃18 /新しいApple Gadgets、完全にモジュール式のスマートフォン、ベラルーシのプログラマーの村、XY現象</a></li>
<li><a href="../ja467399/index.html">持ち込みを禁止することはできません：BYODの概念を実装し、情報セキュリティに害を与えない方法</a></li>
<li><a href="../ja467401/index.html">テスラモデルSとポルシェタイカンの比較</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>