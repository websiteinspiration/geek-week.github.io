<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§öüèª ü•â üç® Kubernetes best practices. Mapping external services üö∂ ‚ô¶Ô∏è üìñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes best practices. Creating Small Containers 
 Kubernetes Best Practices. Kubernetes Organization with the Kubernetes 
 Best Practices Namespa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes best practices. Mapping external services</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/503612/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes best practices. Creating Small Containers </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes Best Practices. Kubernetes Organization with the Kubernetes </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Best Practices Namespace. Kubernetes Viability Test with Readiness and Liveness Tests Kubernetes </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Best Practices. Setting Queries and Resource Limits </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes Best Practices. Disabling Terminate Correctly</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If you are like most people, you are most likely using resources that operate outside of your cluster. You might be using the Taleo API to send text messages or analyzing images using the Google Cloud Vision API.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you use the same endpoint - the server-side request receiving point in all your environments and do not plan to transfer your servers to Kubernetes, then it is perfectly normal to have an endpoint service directly in your code. However, there are many other scenarios. In this Kubernetes Best Practices series, you'll learn how to use Kubernetes built-in mechanisms to discover services both inside and outside the cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An example of a widespread external service is a database that runs outside a Kubernetes cluster. Unlike cloud databases such as the Google Cloud Data Store or Google Cloud Spanner, which use the same endpoint for all types of access, most databases have separate endpoints for different circumstances.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Best practices for using traditional databases, such as MySQL and MongoDB, usually require you to connect to different components for different environments. You may have a large machine for production data and a smaller machine for a test environment. Each of them will have its own IP address or domain name, but you probably will not want to change your code when moving from one environment to another. Therefore, instead of hard coding these addresses, you can use the Kubernetes built-in service to discover external DNS-based services in the same way as for native Kubernetes services. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qg/lz/vj/qglzvjg0ysvnlejo7v6pvtqc1se.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose you run the MongoDB database in the Google Compute Engine. You will be stuck in this hybrid world until you manage to transfer it to a cluster.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, you can use Kubernetes static services to make your life a little easier. In this example, I created a MongoDB server using the Google Cloud Launcher. Since it was created on the same network (or Kubernetes VPC cluster), it is accessed using a high-performance internal IP address. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r3/ou/z8/r3ouz8pak0n-al5obbd6y81qkke.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the default setting on Google Cloud, so you don‚Äôt have to configure anything. Now that you have an IP address, the first step is to create a service. You may notice that there are no hearth selectors for this service. That is, we created a service that will not know where to send traffic. This will allow you to manually create an endpoint object, which will receive traffic from this service.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jo/tc/sr/jotcsra7vszs8kmlivxwl_awqsq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following code example shows that the endpoints determine the IP address for the database using the same mongo name as the service. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/dz/cb/y9dzcbounajojfgkqd-7osjcxka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes will use all IP addresses to find the endpoints as if they were regular Kubernetes pods, so now you can access the database using a simple connection string to the above name mongodb: // mongo. However, there is no need to use IP addresses in your code at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the IP addresses change in the future, you can simply update the endpoints with the new IP address, and your applications will not need to be changed in any additional way.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you use a database hosted on a third-party host, then most likely the owners of the host provided you with a unified resource identifier for the URI. So if you were given an IP address, you can simply use the previous method. This example shows that I have two MongoDB databases hosted on mLab host. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bd/er/w9/bderw9_a42oa_nap45ol_au_jla.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of them is a database of developers, and the other is a production database. The connection strings for these databases are as follows - mLab provides you with a dynamic URI and a dynamic port. As you can see, they are different. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fu/t9/v5/fut9v5yv1qtskdkx8tju2rmkmnq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To ignore this, we use Kubernetes and connect to the developers database. You can create an external Kubernetes service name, which will provide you with a static service that will redirect traffic to the external service.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jo/63/u6/jo63u6uv1quvocf8fxh1bnv_6om.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This service will perform a simple kernel-level CNAME redirect, which will have minimal performance impact. Thanks to this, you can use a simpler connection string. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/es/ip/jm/esipjmsa8t8nagtrwu4slv55isa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But since the external name uses CNAME redirection, it cannot perform port forwarding. Therefore, this solution is applicable only for static ports and cannot be used with dynamic ports. But the free mLab Free Tier, by default, provides the user with a dynamic port number, and you cannot change this. This means that for dev and prod you need different connection command lines. The bad news is that you will need to hard-code the port number. So how do you get port forwarding to work?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first step is to get the IP address from the URI. If you run the command nslookup, hostname or ping the URI, you can get the IP address of the database. If at the same time the service returns several IP addresses to you, then all these addresses can be used at the endpoints of the object. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ki/ox/oxkioxus5e4idcigbaufhqfyquk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keep in mind that URI IPs may change without prior notice, so it‚Äôs quite risky to use them in prod. Using this IP address, you can connect to a remote database without specifying a port. Thus, the Kubernetes service performs port forwarding quite transparently.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rs/iu/eo/rsiueor-lvslhr5vscjlowggkho.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mapping, or mapping external resources to internal ones, gives you the ability to flexibly use these services within the cluster in the future while minimizing refactoring efforts. </font><font style="vertical-align: inherit;">It also facilitates management and provides insight into what external services your company uses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To be continued very soon ...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/fvpq4jqtuZ8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of advertising :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for staying with us. Do you like our articles? Want to see more interesting materials? Support us by placing an order or recommending to your friends </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud-based VPS for developers from $ 4.99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique analog of entry-level servers that was invented by us for you: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The whole truth about VPS (KVM) E5-2697 v3 (6 Cores) 10GB DDR4 480GB SSD 1Gbps from $ 19 or how to divide the server?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 times cheaper at the Equinix Tier IV data center in Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Only we have </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV from $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the Netherlands!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - from $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read about</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to Build Infrastructure Bldg. </font><font style="vertical-align: inherit;">class c using Dell R730xd E5-2650 v4 servers costing 9,000 euros for a penny?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503600/index.html">STM32MP1: U-Boot, Buildroot, Arch Linux and a little Debian</a></li>
<li><a href="../en503604/index.html">Sergey and ‚Äúprogramming is better than sex‚Äù</a></li>
<li><a href="../en503606/index.html">Swift 5.3: What's New?</a></li>
<li><a href="../en503608/index.html">How we searched for virus filters</a></li>
<li><a href="../en503610/index.html">Why not make your own Lisp for the web?</a></li>
<li><a href="../en503616/index.html">How we created a prototype robot merchandiser and what's next</a></li>
<li><a href="../en503620/index.html">News from the world of OpenStreetMap No. 512 (05.05.2020-11.05.2020)</a></li>
<li><a href="../en503624/index.html">The digest of fresh materials from the world of the front-end for the last week No. 416 (May 18-24, 2020)</a></li>
<li><a href="../en503626/index.html">Testing. ISTQB certification errors or solve a million examples</a></li>
<li><a href="../en503630/index.html">Augmented reality glasses: where are we now?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>