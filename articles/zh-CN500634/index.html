<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😩 🚀 🦇 食品基础设施：我们如何支持Tanuki 🗻 👨‍❤️‍💋‍👨 🎅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="用一个著名的历史人物来解释，对我们来说最重要的服务就是送货。在目前的情况下，如果家里没有面包或比萨饼，我们该怎么办？我不想想象。碰巧的是，两年前，我们得到了最大的网络之一-Tanuki的支持。该网站每月的访问量约为一百万。现在是2020年。 Tanuki在2018年开始与我们合作时，规模缩小了2倍。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>食品基础设施：我们如何支持Tanuki</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/500634/"><img src="https://habrastorage.org/webt/vi/gs/zm/vigszmdhwabpqlqr9bgrcx_ozaw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用一个著名的历史人物来解释，对我们来说最重要的服务就是送货。在目前的情况下，如果家里没有面包或比萨饼，我们该怎么办？我不想想象。碰巧的是，两年前，我们得到了最大的网络之一</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Tanuki的支持</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。该网站每月的访问量约为一百万。现在是2020年。 Tanuki在2018年开始与我们合作时，规模缩小了2倍。我们确保毫不费力地迁移到新的数据中心，并完全重整了基础架构-实际上，由于该基础架构，站点和应用程序能够承受增加的负载而不会出现问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有时，我们非常遗憾地认为我们离最近的Tanuki餐厅很远；否则，我们的所有成功（和很少的不幸）都会被美味的面包卷所卡住。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总的来说，今天我们想告诉您有关国内“酒店业”最大的网络项目之一的支持故事。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们于2018年3月底见面。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
国际妇女节已经​​过去了很长时间，但是你们刚刚应付了它的后果。</font><font style="vertical-align: inherit;">一切都很平淡：3月8日前夕，访问量急剧增加，而且该网站长期无法使用。</font><font style="vertical-align: inherit;">真的很长，没有几个小时。</font><font style="vertical-align: inherit;">因为流量不仅通过主站点，而且还来自应用程序（适用于Android和iOS）以及聚集器（Yandex。Food，Delivery Club，Zaka-Zaka）。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们所看到的</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从技术上讲，该项目非常复杂：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该站点是具有SSR（服务器端渲染）的React应用程序。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移动应用程序-适用于iOS / Android。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API-所有应用程序都可以使用它。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部系统，包括订单处理。</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该系统是反向代理服务器：它们的流量经过DDoS攻击的保护系统，并已从那里分发到后端服务器。</font><font style="vertical-align: inherit;">在接受时，有一个旧站点和一个用于移动版本的API，因此开始了新站点的开发。</font><font style="vertical-align: inherit;">新API的开发是在单独的服务器上进行的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数据库集群由两台具有主/主复制的服务器组成，由于浮动IP，在发生故障的情况下在网络级别进行切换。</font><font style="vertical-align: inherit;">所有写入应用程序都使用此IP，而每个后端服务器上都有用于读取的MySQL从站-因此，该应用程序与localhost一起工作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在接待处，我们看到了以下问题：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据库配置中的平衡机制可靠性不足。</font><font style="vertical-align: inherit;">母版复制母版导致频繁失败。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个后端上的从站-需要大量磁盘空间。</font><font style="vertical-align: inherit;">而且任何操纵或添加新的后端服务器都是昂贵的。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有适用于应用程序的通用部署系统-通过网络存在一个独立的部署系统。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有用于收集日志的系统-因此，在使用订单系统时首先很难调查事件，因为无法确定如何接收特定订单。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有监视业务指标-无法及时记录订单减少或完全没有订单。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在对接受监视的服务器进行初步审核之后，我们从形成操作路线图开始。</font><font style="vertical-align: inherit;">最初，确定了两个主要工作领域：</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">稳定应用程序。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为新的API和网站组织一个舒适的开发环境。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一个方向的决定主要与MySQL集群的稳定性有关。我不想拒绝主复制主服务器，但是无法继续使用浮动IP。定期观察到网络连接中断，这导致群集运行中断。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们决定放弃浮动IP，转而使用代理服务器，因为我们使用nginx作为MySQL的代理，因此将在主服务器之间控制上游。第二步是为从服务器分配两个单独的服务器。还通过代理服务器组织了与他们的合作。而且自重组以来，我们忘记了与使用数据库相关的问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，我们在数据库中的查询级别监视订单。任何与规范的偏离（或多或少）都会立即引起调查。然后，在日志级别，我们形成了用于监视外部交互（特别是与订单管理系统）的度量。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据同事的要求，我们与同事一起对所有系统进行了额外的调整，以实现稳定和快速的运行。它既在调整MySQL，又在更新PHP版本。另外，同事们介绍了基于Redis的缓存系统，这也有助于减少数据库的负载。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有这些都很重要...但是，该业务的主要目的是增加销售额。在这种情况下，公司经理对新站点寄予厚望。对于开发人员来说，有必要获得一个稳定，便捷的系统来进行部署和应用程序控制。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们考虑了CI / CD应用程序的组装和交付管道，以及用于收集和处理日志的系统。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有客户端存储库都托管在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自托管的Bitbucket解决方案上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">为了组织管道，选择了詹金斯。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，习惯在开发环境上实现管道-这使我们能够显着提高开发速度。</font><font style="vertical-align: inherit;">然后将其引入生产电路，在此自动部署使我们避免了通常由人为因素引起的频繁错误。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实施后，CI / CD开始组织日志的收集并与之合作。</font><font style="vertical-align: inherit;">选择ELK堆栈作为主要堆栈，这使客户可以在发生事件时更快，更好地进行调查。</font><font style="vertical-align: inherit;">结果，应用程序开发变得更快。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“比两次大火还可怕……” </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在完成了非常复杂但仍然是标准的任务之后，Tanuki告诉了我们很久以来他们想说的话：“走吧！” </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DC的变化是由经济因素引起的。</font><font style="vertical-align: inherit;">此外，客户还通过新DC中已有的其他服务扩展了其基础架构-这也影响了迁移的决定。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任何系统的迁移，更不用说复杂的迁移，都是一个需要大量计划和大量资源的过程。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此举是反复进行的：在第一阶段，在新的DC中创建了反向代理服务器。</font><font style="vertical-align: inherit;">而且由于只有他们拥有公共ip，所以它们还充当管理员的系统访问点。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，我们启动了所有基础架构服务-日志记录和CI / CD。</font><font style="vertical-align: inherit;">一个</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">领事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">允许组织方便，可管理且相当可靠的客户端应用程序之间交互的服务。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
迁移了以下数据库，Redis和队列代理-RabbitMQ。重要的是组织所有内容，以便它们在服务发现协议中正确注册，从而控制DNS的运行。请注意，应用程序不是直接与数据库一起使用，而是通过Haproxy直接使用，这使您可以方便地在数据库之间进行平衡并在发生故障时进行切换。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在准备阶段，数据中心之间的数据库复制没有增加。我只需要传输备份。接下来，我们开始直接配置应用程序，这是通过内部DNS进行的所有交互的组织-应用程序与数据库/ Redis / RabbitMQ /外部服务（例如，订购服务）之间的交互。自然，在同一阶段，所有CI / CD机制都立即连接在一起-然后在体系结构上进行了第二次更改。以前，无法通过界面更改应用程序设置-只能通过直接在控制台中编辑文件。随即，我们推出了一种解决方案，可让您通过Web界面方便地管理设置。它基于Hashicorp保管库（Consul充当其后端），这使我们能够建立方便的机制来管理环境变量。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一步是将服务切换到新的DC。</font><font style="vertical-align: inherit;">由于所有系统的工作都是使用http协议组织的，并且所有域都经过了针对DDoS攻击的保护系统，因此切换直接在该系统的界面中进行了上游操作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前，从旧的DC到新的DC都组织了必要的副本。</font><font style="vertical-align: inherit;">然后切换到商定的工作窗口。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在什么样的基础架构</font></font></h4><br>
<br>
<img src="https://habrastorage.org/webt/bw/t8/-b/bwt8-bwnoht1bovv2dpszzcivr0.jpeg"><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有流量都流向平衡器。</font><font style="vertical-align: inherit;">到该API的流量不是直接从Tanuki应用程序（在Android / iOS上）而是通过Qrator进行的。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tanuki.ru项目的主站点位于静态服务器上，tanuki.ru项目是具有登录页面的服务器。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后端集群现在由服务器组成：前端服务器，静态服务器，应用程序服务器。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">订单传递方案</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
接收到的订单通过Qrator（我们立即过滤掉攻击）并到达API。</font><font style="vertical-align: inherit;">然后他去Raiden交付订单，去Redis并去Nginx，然后离开数据库。</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对客户有什么改变</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统的可靠性：在2019年7月发现问题-在一小时内未下达订单。</font><font style="vertical-align: inherit;">但是那是在全球行动之前。</font><font style="vertical-align: inherit;">随后未发现重大事件。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开发人员的生活：他们拥有便捷的CI / CD开发环境。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">容错能力：基础架构现在可以承受大量流量。</font><font style="vertical-align: inherit;">例如，在假期期间，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">达到550个峰值。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一步是什么</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在现代情况下，在线销售脱颖而出。</font><font style="vertical-align: inherit;">该项目应为服务客户提供可靠性和可访问性。</font><font style="vertical-align: inherit;">但是开发也是一个非常重要的组成部分：产品发布应尽可能快且对最终用户不可见。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另一个重要问题是资源的利用和减少系统维护成本。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有这些导致需要对系统进行整体审查。</font><font style="vertical-align: inherit;">第一步是组织应用程序容器化。</font><font style="vertical-align: inherit;">然后计划组织一个Kubernetes集群。</font><font style="vertical-align: inherit;">但是我们将在下一篇文章中讨论。</font><font style="vertical-align: inherit;">在此期间-好的胃口:-)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN500614/index.html">Zimbra开源版中的文件夹共享</a></li>
<li><a href="../zh-CN500616/index.html">富士通和微软联合Fuinitsu PRIMEFLEX网络研讨会</a></li>
<li><a href="../zh-CN500622/index.html">经理可以激励员工吗？</a></li>
<li><a href="../zh-CN500624/index.html">团队成员个人发展的管理</a></li>
<li><a href="../zh-CN500632/index.html">在rpm中建立哨兵及其依赖性。从rpm安装哨兵，基本设置。LDAP连接</a></li>
<li><a href="../zh-CN500638/index.html">这艘新的中国有前途的载人船。它的历史和在现代月球竞赛中的作用</a></li>
<li><a href="../zh-CN500640/index.html">如何打造成功的外包公司</a></li>
<li><a href="../zh-CN500642/index.html">Igrostroy：进入该行业的门槛，专业和可能的收入</a></li>
<li><a href="../zh-CN500644/index.html">Random Coffee Habr Edition-用于IT社区的网络</a></li>
<li><a href="../zh-CN500646/index.html">在JVM厨房中烹饪字节码</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>