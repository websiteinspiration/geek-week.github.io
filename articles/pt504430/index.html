<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçü§ù‚Äçüë®üèΩ üå∏ ‚ôìÔ∏è Everyday Life Tinkoff Security Operations Center: An√°lise de √∫nico carregador de inicializa√ß√£o üë®üèø‚Äçüéì üö¥üèæ üë©‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! 
 
 Em nosso Centro de opera√ß√µes de seguran√ßa Tinkoff, analisamos regularmente as t√©cnicas usadas em malware e ataques e, recentemente, enco...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Everyday Life Tinkoff Security Operations Center: An√°lise de √∫nico carregador de inicializa√ß√£o</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/504430/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nosso Centro de opera√ß√µes de seguran√ßa Tinkoff, analisamos regularmente as t√©cnicas usadas em malware e ataques e, recentemente, encontramos um arquivo interessante sobre o qual gostar√≠amos de falar.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/u9/yk/wju9ykf2tcl0k7ab3xohfmoilge.png" alt="imagem"><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A t√©cnica usada para criar esta obra-prima √© conhecida h√° mais de 20 anos, mas mesmo d√©cadas depois permanece relevante, pois as chamadas de algumas verifica√ß√µes na macro n√£o s√£o suspeitas e podem ser usadas em documentos leg√≠timos. </font><font style="vertical-align: inherit;">Este √© um downloader de malware escrito em macros do Excel 4.0.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferramentas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como parte da an√°lise, usaremos ferramentas de terceiros ao m√≠nimo e seguiremos com um conjunto padr√£o de programas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft Office Suite</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">editor de texto;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como uma ferramenta para analisar a√ß√µes de software, usaremos o Sysmon;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como ambiente de an√°lise, usaremos uma VM com o Windows 7 a bordo</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mnogabukaf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O documento que vamos analisar √© uma pasta de trabalho do Excel no formato xls. </font><font style="vertical-align: inherit;">O malware √© entregue em emails de phishing, quando o documento √© iniciado, a macro descarrega a ramifica√ß√£o do registro, baixa informa√ß√µes sobre as atualiza√ß√µes do Office no site da Microsoft e tamb√©m baixa e lan√ßa .dll malicioso. </font><font style="vertical-align: inherit;">Ap√≥s essas etapas, o livro √© fechado sem salvar as altera√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A principal diferen√ßa de outros carregadores desse tipo √© que ele n√£o usa macros VBA.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lise est√°tica</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir, √© apresentado um exemplo de email contendo um documento malicioso. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/sf/hl/pnsfhllpvob_d_b7sop7ljyv7jq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abra o anexo em nossa m√°quina virtual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ deve prestar aten√ß√£o imediatamente: a imagem avisa que o documento est√° "protegido" e vale a pena abri-lo localmente e clicar em "habilitar conte√∫do": </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/mj/eu/sgmjeuardcvtcxqdvuf-wpk5ul0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um aviso de seguran√ßa indica que voc√™ precisa examinar os projetos no Editor do Visual Basic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voltamos ao desenvolvedor - gerenciamento de macro (vbs), mas n√£o vemos macros vbs ou vba: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/te/jj/pn/tejjpn888lj2jfeoyj9snzxugos.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aqui √© a hora de lembrar o que s√£o documentos do escrit√≥rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada documento do Microsoft Office √© um arquivo compactado que pode ser descompactado usando qualquer arquivador, extraindo o conte√∫do do documento:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/nj/hg/kfnjhgg1rmz7xffqsfm5w0plojk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s descompactar, vemos que, dentro dos documentos, n√£o h√° arquivos xml que estamos acostumados a ver, a coisa est√° no formato de documento mais antigo - xls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na extens√£o xls, o conte√∫do n√£o √© armazenado no formato Office Open XML, mas no formato bin√°rio BIFF8. O documento usa a macro do Excel 4.0, onde macros podem ser executadas nas c√©lulas do documento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale ressaltar que a planilha com a macro n√£o est√° oculta, mas a planilha possui um grande n√∫mero de c√©lulas vazias, o que dificulta a an√°lise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem ferramentas para analisar arquivos BIFF8, ‚Äã‚Äãpor exemplo, BiffViewer, e para analisar conte√∫do, h√° uma √≥tima ferramenta - oletools. Mas vamos tentar fazer sem usar utilit√°rios de terceiros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Excel tamb√©m possui um formato baseado em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xlsm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, voc√™ pode salvar o c√≥digo de macro do VBA e as folhas de macro do Excel 4.0, o que faremos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lista completa de formatos dispon√≠veis para o Excel s√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">formatos do Excel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s salvamos nosso documento, descompacte-o: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yg/yu/8b/ygyu8bzhfi2qwajfjmekp3i5_ek.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vamos ver o que est√° nos arquivos, come√ßar com o diret√≥rio macrosheets na pasta xl e encontrar o arquivo com todos os dados na planilha de macro: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rt/9l/tw/rt9ltwvg6gyr0wipyuse7cootpe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, obtemos todos os valores nas c√©lulas da planilha de macro. </font><font style="vertical-align: inherit;">A macro em si √© ofuscada, as c√©lulas cont√™m apenas valores e f√≥rmulas num√©ricas que convertem esses valores e gravam o resultado em novas c√©lulas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, nesta f√≥rmula, os valores num√©ricos s√£o convertidos em caracteres, concatenados e gravados na c√©lula FK17653.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√≥rmula no excel</font></font></b>
                        <div class="spoiler_text">FORMULA.FILL(CHAR(CV63675+HE4018)&amp;CHAR(DG27830+HE26544)&amp;CHAR(IA33205-EW25294)&amp;CHAR(X1216+BA26751)&amp;CHAR(X1216*ER27642)&amp;CHAR(EC50683*IA4491)&amp;CHAR(CV63675*CQ12674)&amp;CHAR(CV63675-IP35389)&amp;CHAR(DL61540+AP31398)&amp;CHAR(GB59870-IB5677)&amp;CHAR(X1216+DS45768)&amp;CHAR(GB59870+FV60781)&amp;CHAR(AA45534*S4000)&amp;CHAR(CV63675*FK10514)&amp;CHAR(EC50683/GD6905)&amp;CHAR(GB59870+EM58732)&amp;CHAR(HQ31358-GI51882)&amp;CHAR(X1216+FX24913)&amp;CHAR(DL61540*EC63501)&amp;CHAR(HQ31358-IC62223)&amp;CHAR(X1216*BY50777)&amp;CHAR(X1216*FY64649)&amp;CHAR(G64471+DW7092)&amp;CHAR(HQ31358-B26139)&amp;CHAR(HQ31358/I494)&amp;CHAR(G64471*DG37241)&amp;CHAR(DL61540-ES39934)&amp;CHAR(X1216+BX48975),FK17653)</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado da f√≥rmula, obtemos a seguinte linha: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ve/xn/rqvexng052dssxefthigngmj9nq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada comando macro subsequente √© "coletado" por uma f√≥rmula semelhante, gravada na c√©lula e, em seguida, executada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que a macro seja executada automaticamente quando o documento √© aberto, a c√©lula da qual o script deve ser iniciado deve ser chamada Auto_Open. </font><font style="vertical-align: inherit;">Considere o arquivo workbook.xml:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workbook.xml</font></font></b>
                        <div class="spoiler_text">&lt;?xml version=¬´1.0¬ª encoding=¬´UTF-8¬ª standalone=¬´yes¬ª?&gt;<br>
&lt;workbook xmlns=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">schemas.openxmlformats.org/spreadsheetml/2006/main</a>¬ª xmlns:r=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">schemas.openxmlformats.org/officeDocument/2006/relationships</a>¬ª xmlns:mc=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>¬ª mc:Ignorable=¬´x15¬ª xmlns:x15=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/main</a>¬ª&gt; appName=¬´xl¬ª lastEdited=¬´6¬ª lowestEdited=¬´6¬ª rupBuild=¬´14420¬ª/&gt;&lt;workbookPr/&gt;&lt;mc:AlternateContent xmlns:mc=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>¬ª&gt; Requires=¬´x15¬ª&gt;&lt;x15ac:absPath url=¬´C:\Users\User\Desktop\malware\¬ª xmlns:x15ac=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/ac</a>¬ª/&gt;&lt;/mc:Choice&gt;&lt;/mc:AlternateContent&gt;/&gt;&lt;sheet name=¬´Sheet1¬ª sheetId=¬´1¬ª r:id=¬´rId1¬ª/&gt;&lt;sheet name=¬´Sheet2¬ª sheetId=¬´2¬ª r:id=¬´rId2¬ª/&gt;Sheet2!$IE$65406/&gt;/&gt;/&gt;</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dentro do arquivo, encontramos o nome da linha = "_ xlnm.Auto_OpenT8nee" hidden = "1"&gt; Sheet2! $ IE $ 65406 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso significa que a c√©lula com a qual a macro √© executada, IE65406, est√° oculta. </font><font style="vertical-align: inherit;">Agora sabemos o ponto de entrada para a macro.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lise din√¢mica</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nunca execute arquivos suspeitos em sua m√°quina. </font><font style="vertical-align: inherit;">Para estudar as a√ß√µes de software suspeito, √© necess√°rio usar um ambiente especialmente preparado: v√°rias caixas de areia ou uma m√°quina isolada especialmente preparada - virtual ou ferro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abra o documento e execute o conte√∫do. </font><font style="vertical-align: inherit;">A janela do prompt de comando pisca e o livro √© fechado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver os logs do Sysmon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon tem um evento de cria√ß√£o de processo (id 1), mais sobre Sysmon pode ser encontrado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pelos logs, vemos que a macro cria arquivos no diret√≥rio c: \ users \ public </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguinte √© a mensagem sysmon, que mostra que a ramifica√ß√£o do registro √© descarregada e o resultado √© gravado no arquivo:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sysmon Event ID do evento 1</font></font></b>
                        <div class="spoiler_text">sysmon event id 1 <br>
Process Create:<br>
RuleName: technique_id=T1112,technique_name=Modify Registry<br>
ProcessGuid: {2a62482c-b244-5ecf-3a00-000000002700}<br>
ProcessId: 3268<br>
Image: C:\Windows\System32\reg.exe<br>
FileVersion: 6.1.7600.16385 (win7_rtm.090713-1255)<br>
Description: Registry Console Tool<br>
Product: Microsoft Windows Operating System<br>
Company: Microsoft Corporation<br>
OriginalFileName: reg.exe<br>
CommandLine: ¬´C:\Windows\system32\reg.exe¬ª EXPORT HKCU\Software\Microsoft\Office\16.0\Excel\Security C:\Users\Public\IcItdXw.reg /y"<br>
CurrentDirectory: C:\Users\user\Documents\<br>
User: user<br>
LogonGuid: {2a62482c-b1d8-5ecf-3284-010000000000}<br>
LogonId: 0x18432<br>
TerminalSessionId: 1<br>
IntegrityLevel: High<br>
Hashes: SHA1=8BD131B03D6BA865B228CA8EE3239D2EF2B90B74,MD5=D69A9ABBB0D795F21995C2F48C1EB560,SHA256=36414C7E57AFA6136D77FD47F4C55102E35F2475FBCD719728DA7D14B1590E2A,IMPHASH=BC564726CFF18A49EBC14784593A51CA<br>
ParentProcessGuid: {2a62482c-b23f-5ecf-3900-000000002700}<br>
ParentProcessId: 3164<br>
ParentImage: C:\Program Files\Microsoft Office\Office16\EXCEL.EXE<br>
ParentCommandLine: ¬´C:\Program Files\Microsoft Office\Office16\EXCEL.EXE¬ª</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a conclus√£o, a macro exclui os arquivos criados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para proibir a exclus√£o de arquivos, altere as permiss√µes na pasta, deixe permiss√µes de leitura e grava√ß√£o e pro√≠ba a exclus√£o: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/lf/1a/go/lf1agokzzhrg21juvd4ptxlv1os.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute o documento novamente, receberemos um erro durante a execu√ß√£o da macro, o que nos permitir√° depur√°-la. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© poss√≠vel porque n√£o h√° tratamento de exce√ß√£o em algumas chamadas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0t/ul/u-/0tulu-lqdvaiqqwvif3qgy7syjg.png"><br>
 <br>
<img src="https://habrastorage.org/webt/rf/jo/em/rfjoem_yjobjgq4qnakt80zglke.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos executar a macro passo a passo; durante a depura√ß√£o, encontramos chamadas de fun√ß√£o de bibliotecas DLL, como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShellExecute</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLDownloadToFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ap√≥s a conclus√£o da macro, os seguintes arquivos estar√£o na pasta de usu√°rios compartilhados:</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dc/aw/bd/dcawbdyabmgyj-qzjxcrvzqhpqi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como conhecemos a c√©lula a partir da qual a execu√ß√£o come√ßa, podemos preencher todas as c√©lulas na planilha de macro. </font><font style="vertical-align: inherit;">Vamos passar a macro para a fun√ß√£o close (false), onde interromperemos a execu√ß√£o clicando no bot√£o "Pause".</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√©lulas de verifica√ß√£o do ambiente</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinando as c√©lulas que a macro preenche, encontramos v√°rias fun√ß√µes get.window () e get.workspace ()</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A fun√ß√£o get.window () retorna informa√ß√µes sobre a janela atual: status, status da janela, seu nome, op√ß√µes de exibi√ß√£o etc.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A fun√ß√£o get.workspace () permite descobrir informa√ß√µes sobre o ambiente em que o documento est√° sendo executado.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma lista completa de chamadas dispon√≠veis para o Excel 4.0 pode ser encontrada nos links. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, precisamos detalhar mais: meu colega e eu sugerimos que a maioria dessas chamadas est√° relacionada a tentativas de ignorar caixas de areia:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.winow (7) - verifica se a janela atual est√° oculta. </font><font style="vertical-align: inherit;">Retorna verdadeiro ou falso.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows (20) - retorna true se a janela estiver maximizada.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows (23) - pode retornar os valores 1, 2 e 3.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/d54/afe/028/d54afe0281d24b5e34040af0122cd3d7.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 - restaurado </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 - minimizado </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 - maximizado </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, ele verifica se a janela atual est√° aberta: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (31) - verifica se a macro est√° sendo depurada em etapas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (13) - verifique a largura da √°rea de trabalho em pixels: se for menor que 770, o livro ser√° fechado </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dh/zz/w3/dhzzw3m9vx-krc6nxgje-ken6x4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (14) - verifique a altura da √°rea de trabalho em pixels: se for menor que 390, o livro ser√° fechado </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4b/m5/8l/4bm58lswcaq-yi9xfjjinjc9ng0.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (19) - verifique a presen√ßa de um mouse. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (1) - retorna em qual sistema operacional o documento est√° sendo executado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso de false, em cada verifica√ß√£o, h√° uma transi√ß√£o para a c√©lula de fechamento do livro sem salvar o resultado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamadas de biblioteca externa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de verificar o ambiente, passamos √† funcionalidade principal. Vamos ver como as fun√ß√µes WinAPI s√£o chamadas a partir da macro: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. A chamada reg.exe, que vimos nos logs do Sysmon. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gy/vz/lv/gyvzlv4tfc9o4q0pmkplr9ea3eq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para chamar o utilit√°rio, a fun√ß√£o ShellExecute da biblioteca shell32.dll √© usada, os par√¢metros para a fun√ß√£o est√£o espalhados em outras c√©lulas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√©lula BN16631: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ug/af/vn/ugafvnkenyfwp2iv2mqvml0kfl8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√©lula A46097: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/qa/wy/f7/qawyf7w4clfqocrpp4ixokeyzyc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na c√©lula GN47559, o comando para exportar a ramifica√ß√£o do registro necess√°ria √© enviado, Get.workspace (2) retorna a vers√£o do Excel. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/s7/_g/w5/s7_gw5jjgmgw32b9vxugtqxnxkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A c√©lula DX48821 cont√©m o caminho em que o resultado √© gravado. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/wt/i9/-m/wti9-myhidza4-8nm7xd_s3rkmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, na macro, verifica-se a exist√™ncia do arquivo IcltdXw.reg criado e sua exclus√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Chamando a fun√ß√£o URLDownloadToFile. Essa fun√ß√£o salva o resultado de uma solicita√ß√£o get em um arquivo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A chamada √© a seguinte:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/vn/ye/buvnyevcolwz4oofwcxygw1zbam.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa chamada nos leva ao site da Microsoft, √† p√°gina com informa√ß√µes sobre as atualiza√ß√µes do Office. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par√¢metros de fun√ß√£o: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√©lula BR6547 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yc/s9/ws/ycs9wsggtysuw-zxwt_o0dt4r94.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√©lula IN49847 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/i2/an/lg/i2anlg2ev8fwcc40tb-z9f2mzmi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s executar a instru√ß√£o, √© verificado se o arquivo foi criado e tamb√©m a leitura do caractere pelo deslocamento no arquivo: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ei/by/lc/eibylc7t9nfpt1o9fpqqri2myzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muito provavelmente, essas a√ß√µes visam verificar se o ambiente em que o documento est√° executando tem acesso √† Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na f√≥rmula, a fun√ß√£o FILES √© passada para iserror e o argumento √© o nome do arquivo no qual o resultado da fun√ß√£o URLDownloadToFile deve ser gravado: a </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/rh/x1/_urhx1xm6fnl5wiaca1r1zojjba.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
c√©lula FM27223 dar√° controle √† fun√ß√£o de fechamento do livro: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/fj/ka/f2fjkalfq8wvjhotj8xyb8td5-g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s o recebimento bem-sucedido do arquivo da Microsoft, as c√©lulas s√£o preenchidas para preparar a segunda chamada para a urlmon dll.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carregamento de carga</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E aqui est√° a segunda chamada, mas para o dom√≠nio dehabadi [.] Ir, do qual a carga maliciosa deve ser carregada: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/3f/jx/db/3fjxdb9mshlwdu0y6xgnp0j_ena.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O resultado ser√° gravado em um arquivo na mesma pasta com a extens√£o html: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dh/py/vd/dhpyvdog5thduid5qvxiuclpa6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, encontraremos uma ramifica√ß√£o no c√≥digo da macro se, na primeira tentativa de baixar a carga √∫til, falha, uma segunda tentativa ser√° feita, mas a partir de um endere√ßo diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o download for bem-sucedido, um aviso aparecer√° e a biblioteca carregada ser√° chamada. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/uo/dn/gv/uodngvrubmpjcf-zkckbqj5wm-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A chamada completa √© a seguinte:</font></font><br>
<br>
<pre><code class="plaintext hljs">=CALL("shell32","ShellExecuteA","JJCCJJ",0,"open","c:\windows\systemc32\rundll32.exe","c:\users\public\4hcFC.html,DllRegisterServer",0,5) </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em uma chamada completa, a fun√ß√£o ShellExecuteA √© chamada da biblioteca Shell32 com par√¢metros para iniciar o rundll32, com o qual a fun√ß√£o exportada da biblioteca maliciosa baixada √© chamada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso completa a fun√ß√£o macro, a carga √∫til est√° em funcionamento.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como foi dito, a tecnologia √© bastante antiga ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel 4.0 para Windows 3.0 e 3.1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), mas fornece totalmente a funcionalidade que o malware precisa para atingir seus objetivos. E o objetivo deste arquivo √© colocar silenciosamente um software perigoso no sistema que pode causar s√©rios danos, come√ßando com o roubo de dados pessoais, dados de autoriza√ß√£o para sistemas, terminando com corrup√ß√£o / criptografia de dados no computador e a capacidade de executar o c√≥digo remotamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para a an√°lise de tais documentos, n√£o √© necess√°rio usar utilit√°rios e software especiais; no entanto, vale a pena mencionar um conjunto de scripts de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oletools - mais detalhes podem ser encontrados aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Terminaremos aqui, abaixo est√£o indicadores de comprometimento identificados como resultado da an√°lise. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COI recebido:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
evans [.] williamdmon [@] wp [.] </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eleventalents [.] com </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dehabadi [.] e </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps: //eleventalents.com/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps: //dehabadi.ir/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
de88d3774ae006d96121d9b45efbf1ee </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a73d1214740330013773cd733b0daf206eae2e03 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ba4adb640f777ad9b0881919e9bd1e171e64025d97a37fd585295ab611653419 </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma lista completa de indicadores de comprometimento. </font></font></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncias:</font></font></b><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Refer√™ncia de macro 4.0 </font></font></a> </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabalhou na an√°lise: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frolov Ilya </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kolenchuk Alexey</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt504402/index.html">29 de maio - Java Digest</a></li>
<li><a href="../pt504408/index.html">Modelo de estrutura de teste simples e conveniente no selenide para autotestes da interface do usu√°rio</a></li>
<li><a href="../pt504412/index.html">Campeonato de programa√ß√£o on-line "Finais Abertos de Treinamento em Moscou"</a></li>
<li><a href="../pt504414/index.html">Como a Microsoft matou o AppGet</a></li>
<li><a href="../pt504420/index.html">Escrevendo uma arena PvP baseada em turnos com movimentos simult√¢neos</a></li>
<li><a href="../pt504434/index.html">Programa educacional para os pais: como proteger as crian√ßas dos perigos na Internet</a></li>
<li><a href="../pt504438/index.html">30 mitaps por semana. Abrimos a temporada de ver√£o 2020</a></li>
<li><a href="../pt504442/index.html">Um pouco sobre realoca√ß√µes no kernel do Linux</a></li>
<li><a href="../pt504444/index.html">Usando o docker em v√°rios est√°gios para criar imagens do Windows</a></li>
<li><a href="../pt504448/index.html">Gera√ß√£o II de jogadores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>