<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤞🏻 💿 🤥 As I wrote the html parser in php, and what came of it. Part one 👩🏽‍🏫 👨🏽‍🔬 👨🏿‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. 
 
 Today I want to tell how to write an html parser, as well as what problems I encountered while developing a similar parser in php. But there ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>As I wrote the html parser in php, and what came of it. Part one</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505264/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hey. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today I want to tell how to write an html parser, as well as what problems I encountered while developing a similar parser in php. </font><font style="vertical-align: inherit;">But there were many problems. </font><font style="vertical-align: inherit;">And in the first part I will talk about the design of the parser, and about the problems encountered, because the html parser is different from the parser of the programming languages ​​familiar to everyone.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I tried to write the text of this article as clearly as possible, so that anyone who is not even familiar with the general device of parsers can understand how the html parser works. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hereinafter in the article I will call the document containing html simply </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Document”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The dom tree located in the element will be called </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Subarray"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What should the parser do?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's first decide what the parser should do in order to build on this in the future. </font><font style="vertical-align: inherit;">Namely, the parser should:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design a document-based dom tree</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If there are errors in the document, then he must solve them.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Find items in dom tree </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Find children items </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Find text </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the simplest list of what a parser should be able to do. </font><font style="vertical-align: inherit;">In a good way, it should still send information about errors, if any were found in the original document. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, these are trifles. </font><font style="vertical-align: inherit;">The basic functionality is enough to smash your head a couple of nights. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there is a problem that I immediately encountered: Html is not just a language, it is a hypertext language. </font><font style="vertical-align: inherit;">Such a language has its own syntax, and an ordinary parser will not work.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divide and rule</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get started, you need to divide the work of the parser into two stages:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Separate Plain Text from Tags</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sort all received tags in the dom tree</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This applies directly to parsing a document. I will talk about searching for elements a bit later in this chapter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To describe the first stage, I drew a diagram that clearly shows how the data is processed in the first stage: </font></font><br>
<br>
<img src="https://hsto.org/webt/vi/da/ma/vidama0m4yfx28z5lpj9n9c7ado.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided to omit all the small details. For example, how to distinguish that after the opening "&lt;" comes a tag, not text? I will talk about this in the following parts. This is enough for now. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It’s also worth clarifying. It is logical that in the document, in addition to tags, there is also text. In simple terms, if the parser finds an opening tag and if there is text in it, it will write it after the opening tag as a separate tag. Such a tag will be considered as single and will not participate in further work of the parser.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, the second stage. </font><font style="vertical-align: inherit;">The most difficult from the point of view of design, and the simplest at first glance from the point of view of understanding: </font></font><br>
<br>
<img src="https://hsto.org/webt/cl/mw/wt/clmwwtchiuag_bey_qkr0c4dwjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, the level means the level of recursion. </font><font style="vertical-align: inherit;">That is, if the parser has found an opening tag, it calls itself, "enters a lower level", and this will continue until a closing tag is found. </font><font style="vertical-align: inherit;">In this case, the recursion produces the result, "Goes a Level Up." </font><font style="vertical-align: inherit;">But what about single tags? </font><font style="vertical-align: inherit;">Such tags are considered recursion neither as opening nor as closing. </font><font style="vertical-align: inherit;">They just go to dom "As Is". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we get something like this:</font></font><br>
<br>
<pre><code class="php hljs">[<span class="hljs-number">0</span>] =&gt; <span class="hljs-keyword">Array</span><font></font>
(<font></font>
[is_closing] =&gt;<font></font>
[is_singleton] =&gt;<font></font>
[pointer] =&gt; <span class="hljs-number">215</span><font></font>
[tag] =&gt; div<font></font>
[<span class="hljs-number">0</span>] =&gt; <span class="hljs-keyword">Array</span> <span class="hljs-comment">// </span><font></font>
(<font></font>
[<span class="hljs-number">0</span>] =&gt; <span class="hljs-keyword">Array</span><font></font>
(<font></font>
[is_closing] =&gt;<font></font>
[is_singleton] =&gt;<font></font>
[pointer] =&gt; <span class="hljs-number">238</span><font></font>
[tag] =&gt; div<font></font>
[id] =&gt; <span class="hljs-keyword">Array</span><font></font>
(<font></font>
[<span class="hljs-number">0</span>] =&gt; tjojo<font></font>
)<font></font>
<font></font>
[<span class="hljs-number">0</span>] =&gt; <span class="hljs-keyword">Array</span> <span class="hljs-comment">// </span><font></font>
(<font></font>
[<span class="hljs-number">0</span>] =&gt; <span class="hljs-keyword">Array</span> <span class="hljs-comment">//     </span><font></font>
(<font></font>
[tag] =&gt; __TEXT<font></font>
[<span class="hljs-number">0</span>] =&gt; !<font></font>
<font></font>
)<font></font>
<font></font>
[<span class="hljs-number">1</span>] =&gt; <span class="hljs-keyword">Array</span><font></font>
(<font></font>
[is_closing] =&gt; <span class="hljs-number">1</span><font></font>
[is_singleton] =&gt;<font></font>
[pointer] =&gt; <span class="hljs-number">268</span><font></font>
[tag] =&gt; div<font></font>
)<font></font>
<font></font>
)<font></font>
)<font></font>
)<font></font>
)<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What about finding elements?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's talk about finding elements. But here, not everything is as clear as you might think. First you need to figure out what criteria we are looking for elements. Everything is simple here, we look for them according to the same criteria as Javascript does: tags, classes and identifiers. But here is the problem. The fact is that there can be only one tag, but the classes and identifiers of one element are many, or not at all. Therefore, searching for an item by tag will be different from searching by class or identifier. I drew a search scheme for a tag, but don’t worry: searches by class or identifier are not very different.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j4/qs/w2/j4qsw2kzjw9bzaxen6mozm6gc0i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A little clarification. </font><font style="vertical-align: inherit;">By original value, I meant the name of the tag, "div" for example. </font><font style="vertical-align: inherit;">Also, if an element is not equal to the initial value, but it has a subarray with a suitable element, the result will be written exactly the appropriate element with its subarray, if one exists. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also worth saying that the parser will have a function that allows you to search for a specific element in the document. </font><font style="vertical-align: inherit;">This will significantly accelerate the performance of the parser, which will allow it to execute faster. </font><font style="vertical-align: inherit;">It will be possible, for example, to take only the first element found, or the fifth, as you want. </font><font style="vertical-align: inherit;">You must admit that in such cases it will be much easier for the parser to search for elements.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Search for children items</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, sorted out the search for elements, but what about children elements? </font><font style="vertical-align: inherit;">Here, too, everything is simple: our parser will take all nested subarrays of elements found before this, if any. </font><font style="vertical-align: inherit;">If there are none, the parser will output an empty result and move on:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y0/4a/wy/y04awyfodd4cs4c9n5pijqetnkm.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Text search</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is nothing to talk about. </font><font style="vertical-align: inherit;">The parser will simply take all the received text from the subarray and output it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mistakes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The document may contain errors that our script must successfully handle, or, if the error is critical, display it on the screen. </font><font style="vertical-align: inherit;">Here you will find a list of all the possible errors that we will talk about in the future:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The "&gt;" symbol was not found.</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Such an error will occur if the parser reached the end of the document and did not find the closing "&gt;" symbol.</font></font><br>
</li>
<li><b>  </b><br>
    ,            .<br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">tag</span> <span class="hljs-attr">some</span> =&gt;</span><span class="hljs-comment">&lt;!--   ?    ,   --&gt;</span></code></pre><br>
</li>
<li><b> html </b><br>
     :        "&lt;",    "="  ,      .<br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">tag</span> <span class="hljs-attr">some</span> = =<span class="hljs-string">'something'</span>&gt;</span><span class="hljs-comment">&lt;!-- ,    --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">tag</span> &lt;<span class="hljs-attr">some</span> =<span class="hljs-string">'something'</span>&gt;</span><span class="hljs-comment">&lt;!--  ?  ,    ? --&gt;</span></code></pre><br>
</li>
<li><b>   </b><br>
     ,     ,    ,  .<br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span> = =<span class="hljs-string">'wefwe'</span>&gt;</span><font></font>
!<font></font>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-comment">&lt;!--   &lt;/div&gt;?--&gt;</span>
</code></pre><br>
        .<br>
</li>
<li><b>   </b><br>
  ,    ,  .<br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span> = =<span class="hljs-string">'wefwe'</span>&gt;</span><font></font>
!<font></font>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-comment">&lt;!--    ?--&gt;</span>
</code></pre><br>
     .<br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Children element not found.</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In this case, the parser will simply output an empty array.</font></font><br>
</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script, style and comments</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the parser, the script and style tags will be immediately skipped, since I do not see the point in writing them. </font><font style="vertical-align: inherit;">The situation is different with the comments. </font><font style="vertical-align: inherit;">If you want to write from, then you can enable a separate script function, and then it will write them. </font><font style="vertical-align: inherit;">Comments will be recorded in the same way as text, that is, as a separate tag.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rather, this article should be considered a small digression into the topic of html parsers. </font><font style="vertical-align: inherit;">I wrote it for those who are thinking about writing their own parser, or for those who are just interested. </font><font style="vertical-align: inherit;">Believe me, this is really fun! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article is the first introductory part. </font><font style="vertical-align: inherit;">In the next parts of this series, the code will directly participate, and there will be fewer pictures with algorithms (which is fine, because I don’t know how to draw them). </font><font style="vertical-align: inherit;">Stay tuned!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en505252/index.html">Avokado project</a></li>
<li><a href="../en505254/index.html">Snake sugar or write your range in JavaScript</a></li>
<li><a href="../en505256/index.html">Successful launch. 39th from the beginning of the year. 14th from the USA. Starlink SpaceX Satellites</a></li>
<li><a href="../en505258/index.html">Dentistry: expectation and reality</a></li>
<li><a href="../en505260/index.html">Measuring the delay from the keyboard to the photon using an optical sensor</a></li>
<li><a href="../en505268/index.html">Personal experience: from frontend developer to leader</a></li>
<li><a href="../en505274/index.html">Deadly sins of site security: what we learned from the vulnerability scanner statistics for the year</a></li>
<li><a href="../en505276/index.html">How we taught ABBYY FineReader PDF to edit whole paragraphs</a></li>
<li><a href="../en505278/index.html">39 abbreviations in English for beginner marketers and seoshnikov</a></li>
<li><a href="../en505280/index.html">Magento 2: Critical CSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>