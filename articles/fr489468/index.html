<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙇🏾 🤺 👴 Application Slack simple pour publier du contenu à partir de Google Sheets 👨🏽‍🍳 ⛹🏽 🧗🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous aimons essayer de nouvelles choses et partageons donc souvent des liens vers des informations intéressantes du monde de l'informatique et de la p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Application Slack simple pour publier du contenu à partir de Google Sheets</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489468/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous aimons essayer de nouvelles choses et partageons donc souvent des liens vers des informations intéressantes du monde de l'informatique et de la programmation avec nos collègues. Nous sommes des utilisateurs de longue date de slack et pour de tels liens, nous avons un canal éducatif séparé où chacun peut trouver quelque chose d'intéressant pour lui-même. Mais comme nous sommes des gens ordinaires, périodiquement dans le feu de l'action, nous oublions que nous devons partager ces liens, et l'activité dans la chaîne s'estompe, même si beaucoup d'entre nous ont quelque chose à partager.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons été confrontés à une tâche intéressante: développer un «bot» qui pourrait automatiquement prendre des informations pré-collectées et partager régulièrement des liens vers celles-ci. </font><font style="vertical-align: inherit;">Nous cherchions une solution toute faite sur Internet, et maintenant elle est apparue </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme une intégration de zapier et de slack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gb/zc/el/gbzcelbfefmw2trwii1temk6f2a.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, nous n'avons pas trouvé une telle intégration avant et avons décidé d'écrire notre propre petit vélo. </font><font style="vertical-align: inherit;">Ci-dessous, nous décrirons comment nous l'avons fait exactement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En pensant au problème, la solution suivante m'est venue à l'esprit: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code Javascript qui reçoit des informations sur les liens utiles pertinents de la table google et les envoie à Slack. </font><font style="vertical-align: inherit;">Appel d'un script à partir du premier élément d'un programme à l'aide de cron. </font><font style="vertical-align: inherit;">Commençons dans l'ordre.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenir un jeton pour Slack.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est simple ici et il a été décrit à plusieurs reprises dans d'autres articles, je ne donnerai donc qu'une brève description. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe deux options: créer votre propre application Slack ou utiliser des jetons hérités, la première option est un peu plus compliquée, mais elle est recommandée par Slack, la seconde est plus simple et tout à fait adaptée à nos besoins, en raison de sa simplicité, nous la choisirons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ouvrons un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien pour générer un nouveau token</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et créer un nouveau token pour l'espace de travail souhaité (n'oubliez pas de le copier, le token est émis une fois). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/fw/bq/bufwbqnmxbfoliu35xk_lky8gtm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'avenir, lors de la mise en œuvre de code qui interagit avec l'API Slack et Google Sheets, nous serons en mesure d'utiliser ce jeton aux fins prévues. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez maintenant obtenir le jeton pour Google Sheets. Tout d'abord, ouvrez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node.js Quickstart pour Google Sheets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et activez l'API Google Sheets. </font><font style="vertical-align: inherit;">Ensuite, nous copions le code index.js de l'exemple et l'exécutons, passons par le processus d'autorisation et obtenons les informations d'identification dans le fichier, qui sont utiles pour une utilisation avec notre script.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implémentation de script</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est maintenant temps de commencer à développer un script pour publier des messages de Google Sheets vers Slack. </font><font style="vertical-align: inherit;">Le code de script complet peut être trouvé en cliquant sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous analyserons la partie du code qui envoie des messages au canal mou. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela se produit en appelant l'API Slack REST.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> post = <span class="hljs-keyword">async</span> (text, channel = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CHANNEL</span> <span class="hljs-attr">ID</span>&gt;</span>) =&gt; {
  const uri = `https://slack.com/api/chat.postMessage?token=${SLACK_AUTH_TOKEN}&amp;channel=${channel}&amp;text=${text}`;
  const result = await fetch(encodeURI(uri), {
    headers: {
      'Content-Type': 'application/json',
    },
    method: 'POST',
    body: JSON.stringify({
      channel,
      text,
      as_user: true
    })
  });

  await result.json();
};
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'autorisation dans l'API Google, deux fonctions sont utilisées (autoriser, getNewToken), dont le code est extrait de Node.js Quickstart, nous ne nous attarderons pas sur celles-ci en détail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le prochain bloc de code intéressant consiste à obtenir des informations à envoyer à partir des feuilles de calcul Google, à l'aide de la fonction suivante:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> getMessageAndPost = <span class="hljs-keyword">async</span> (auth, spreadsheetId = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ID</span>  <span class="hljs-attr">Google</span> &gt;</span>) =&gt; {
  const sheets = google.sheets({ version: 'v4', auth });
  sheets.spreadsheets.values.get({
    spreadsheetId,
    range: 'Sheet1!A1:B999',
  }, async (err, res) =&gt; {
    if (err) return console.log('The API returned an error: ' + err);
    const rows = res.data.values;
    if (rows.length) {
      // Print columns A and E, which correspond to indices 0 and 4.
      const ix = rows.findIndex(r =&gt; !r[1]);
      await post(rows[ix][0]);
      sheets.spreadsheets.values.update({
        spreadsheetId: '18VzilQTEDGXBnaH1f_k-uAfa8Mb470gx32Phir6xQT4',
        range: `Sheet1!B${ix + 1}`,
        valueInputOption: 'RAW',
        requestBody: {
          range: `Sheet1!B${ix + 1}`,
          values: [['x']]
        }

      })
    } else {
      console.log('No data found.');
    }
  });
};</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le tableau avec lequel le script interagit a la forme suivante: En </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ty/lr/1r/tylr1rijbae8u53q8qvuwbls5te.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
conséquence, pour chaque lien après l'envoi d'un message à Slack, le script met «x». Ainsi, pour trouver le message que vous souhaitez envoyer, vous devez sélectionner la première ligne, qui n'a pas encore de «x», prendre le message, l'envoyer et marquer la ligne sélectionnée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le script que nous venons de démonter est assez simple et confirme ses performances depuis plusieurs années dans notre équipe. Il suffit de déployer ce script sur le serveur et de profiter de son utilisation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour cela, dans notre entreprise, nous utilisons le VPS Ubuntu habituel sur Digital Ocean (même le plus faible fera l'affaire). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, vous devez configurer l'environnement pour exécuter le code javascript, pour cela, vous devez installer node.js (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guide d'installation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cela, configurez la tâche cron pour appeler le script selon un calendrier:</font></font><br>
<br>
<pre><code class="plaintext hljs">crontab -e<font></font>
<font></font>
#### <font></font>
<font></font>
24 14 * * 1-5 cd /root/google-sheets-to-slack &amp;&amp; node post.js<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant ces paramètres, notre script du dossier / root / sera appelé quotidiennement du lundi au vendredi à 14:24. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La configuration est terminée, mais le lecteur attentif doit avoir remarqué quelques défauts dans le script, par exemple, s'il y a une erreur lors de l'appel du script, nous ne le saurons jamais, car il "tombera tranquillement" et c'est tout. </font><font style="vertical-align: inherit;">Pour résoudre ce problème, vous pouvez ajouter la gestion des erreurs et la sortie du résultat de l'appel de script dans la même feuille de calcul ou fichier journal Google. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, au lieu d'envoyer un message à une heure fixe, vous pouvez l'envoyer avec un retard aléatoire, de sorte que notre message ressemble plus à un message d'un utilisateur «en direct».</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre idée intéressante de l'un de nos collègues était de créer une deuxième table à partir de laquelle les messages seraient envoyés exclusivement le vendredi et seraient plus divertissants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, nous voyons d'innombrables idées de raffinement et nous les mettrons progressivement en œuvre, mais sous la forme existante, ce script est apparu très utilisable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un exemple de tableau utilisable est disponible </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci d'avoir lu et profitez de l'utilisation.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489444/index.html">Transformez la nature en décoration avec la numérisation 3D</a></li>
<li><a href="../fr489452/index.html">Tâches Microsoft JavaScript</a></li>
<li><a href="../fr489456/index.html">Recommandations après la nomination d'un chirurgien-dentiste</a></li>
<li><a href="../fr489460/index.html">UV à deux doigts</a></li>
<li><a href="../fr489464/index.html">"Je reviens!": Comment l'anglais d'Arnold Schwarzenegger a changé en 50 ans aux États-Unis</a></li>
<li><a href="../fr489470/index.html">Le potentiel concurrentiel des simulations de type siège</a></li>
<li><a href="../fr489472/index.html">Archive Web: substitution d'importation</a></li>
<li><a href="../fr489474/index.html">Comment compresser le modèle fastText 100 fois</a></li>
<li><a href="../fr489476/index.html">Styliser les cases à cocher et les boutons radio à l'aide de CSS3</a></li>
<li><a href="../fr489482/index.html">Ce que vous devez savoir si vous voulez appeler des fonctions Go depuis l'assembleur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>