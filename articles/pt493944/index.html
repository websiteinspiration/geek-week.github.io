<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍨 🤰🏼 👩🏻‍🚀 Continuamos analisando vulnerabilidades de comutadores industriais: executamos código arbitrário sem senha 👩🏼‍🤝‍👨🏻 👨🏿‍🍳 👼🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Na Pesquisa positiva 2019, revisamos o Moxa Industrial Switch Management Protocol. Desta vez, continuaremos este tópico e analisaremos em detalhes a v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Continuamos analisando vulnerabilidades de comutadores industriais: executamos código arbitrário sem senha</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/493944/"><img src="https://habrastorage.org/webt/wk/gg/bb/wkggbbfxuzftoyyqhtjr0hh6x6o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na Pesquisa positiva 2019, revisamos o Moxa Industrial Switch Management Protocol. </font><font style="vertical-align: inherit;">Desta vez, continuaremos este tópico e analisaremos em detalhes a vulnerabilidade CVE-2018-10731 nos comutadores Phoenix Contact da linha de modelos FL SWITCH 3xxx, FL SWITCH 4xxx e FL SWITCH 48xx identificados por nossos especialistas. </font><font style="vertical-align: inherit;">Essa vulnerabilidade, detectada na interface da web do dispositivo, permite a execução de código arbitrário sem conhecer as credenciais do dispositivo e é classificada em 9 de 10 na escala CVSS versão 3.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeira vista</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dispositivos mencionados acima estão executando o Linux e você pode usar a interface da web para configurá-los. Como em muitos outros dispositivos de IoT, domésticos e industriais, a interface da Web consiste em muitos aplicativos CGI que processam solicitações HTTP do usuário. No nosso caso, os aplicativos CGI usam ativamente a biblioteca cgic, o que facilita o trabalho com solicitações HTTP, e as funções dessa biblioteca são incorporadas à biblioteca compartilhada </font></font><code>libipinfusionweb.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localizada no sistema de arquivos do dispositivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao processar uma solicitação HTTP, o servidor da Web passa os dados da solicitação do usuário para o aplicativo CGI como um conjunto de variáveis ​​de ambiente. Seu processamento inicial é realizado pela função de </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biblioteca </font></font><code>libipinfusionweb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em seguida, a função </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chama a função do </font></font><code>cgiMain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aplicativo CGI, na qual o processamento adicional da solicitação ocorre.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eu/hm/yd/euhmydlkhy2r76pkvmiurftmv3a.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 1. Processando uma solicitação HTTP</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
No decorrer de seu trabalho, a função principal da biblioteca </font></font><code>libipinfusionweb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chama uma função </font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que determina se o usuário passou a autenticação no sistema usando os valores de Cookie passados. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/-a/tl/ra-atlrdqdebpr4qgh855ykd5f8.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 2. Fragmento de pseudocódigo da</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
função </font><i><font style="vertical-align: inherit;">principal</font></i><font style="vertical-align: inherit;"> A função </font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recebe o valor do parâmetro Cookie </font></font><code>c_session</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usando a função </font></font><code>cookies_get_value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e o armazena em uma variável </font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A variável em si </font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é uma matriz de caracteres de byte único com um comprimento de 0x80 e está localizada a uma distância de 0xE0 do início da pilha. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2s/m7/ti/2sm7tilkgmlwt5ahmjz742yonxu.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 3. Fragmento do pseudocódigo da função get_login_user</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
No entanto, no código da função </font></font><code>cookies_get_value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pode ser visto que o </font></font><code>cgiCookieString</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor do parâmetro Cookie </font><font style="vertical-align: inherit;">recebido pela função </font><font style="vertical-align: inherit;">possui um comprimento máximo de 0x400 bytes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/uz/xv/jtuzxvss3ihvfbtjp0vnq0ytr4c.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 4. Um fragmento do pseudocódigo da função cookies_get_value</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Assim, ao passar um parâmetro Cookie com mais de 0xE0 (224) caracteres, a função </font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salvará o valor desse parâmetro em sua pilha, resultando na </font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">substituição </font><font style="vertical-align: inherit;">de todas as informações na pilha atrás da variável </font><font style="vertical-align: inherit;">, incluindo o endereço função de retorno.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: Quando uma função chama outra, o endereço de retorno é armazenado na pilha. </font><font style="vertical-align: inherit;">O controle é transferido para esse endereço quando a função chamada termina seu trabalho. </font><font style="vertical-align: inherit;">Portanto, se você reescrever esse endereço, poderá obter controle sobre o processo de execução do programa. </font><font style="vertical-align: inherit;">Por exemplo, um invasor pode substituir esse endereço pelo endereço de um código de shell malicioso localizado no espaço de endereço do programa.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que a reescrita do endereço de retorno ocorre antes da verificação da autenticação, o que torna possível explorar essa vulnerabilidade para um invasor que não conhece as credenciais do dispositivo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exploração</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinamos várias opções para demonstrar a possibilidade de explorar essa vulnerabilidade. O mais simples é escrever o código da carga útil na pilha (0x400 - 0xE0 = 800 bytes permanece para ele, basta o código) e reescrever o endereço de retorno com o endereço do código. Teoricamente, essa opção era possível, pois o processador do comutador vulnerável não suporta a função NX-bit (ou seja, permite a execução de código localizado em qualquer lugar, inclusive na pilha), mas na prática tinha sérias limitações. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O processador de switch vulnerável possui uma arquitetura MIPS; muitas das instruções do processador nessa arquitetura são codificadas em sequências de bytes que contêm zero bytes. O conteúdo do buffer é gravado no primeiro byte zero (devido ao uso da função</font></font><code>strcpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), portanto, é necessário usar apenas operandos que não contenham um byte nulo, o que é impossível, pois qualquer carga útil usaria pelo menos vários desses bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao construir a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cadeia ROP,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> novamente, teríamos que enfrentar as restrições do byte nulo: o endereço dos dispositivos ROP não deve conter zeros, o que complica bastante sua pesquisa. Em geral, só poderíamos usar um zero, copiado pela função strcpy. Isso impõe uma limitação à criação de uma cadeia de ROP completa e, além disso, os gadgets de que precisávamos eram extremamente poucos. No entanto, durante as pesquisas na biblioteca libipinfusionweb, foi encontrado o seguinte fragmento de código: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/am/xs/u5/amxsu5zw9x3p9-0tfzjtu-geal8.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 5. Um fragmento do código executável da biblioteca libipinfusionweb</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde que o conteúdo do registro $ s0 seja controlado, esse fragmento de código permite executar um comando do SO usando uma função </font></font><code>mysystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(inicialmente essa função não tinha um nome, mas a renomeamos, pois é muito semelhante à função do sistema no Linux). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como estamos reescrevendo o endereço de retorno da função get_login_user, essa função será executada até o final. No epílogo da função get_login_user, você pode ver que o valor do registro $ s0 é restaurado do valor salvo anteriormente na pilha (no deslocamento 0xD8 da parte superior da pilha). No entanto, neste momento, esta área da pilha já está sob nosso controle, isto é, de fato, podemos alcançar o controle sobre o conteúdo do registrador $ s0 e, assim, executar comandos arbitrários OS usando a função </font></font><code>mysystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e3/k7/d9/e3k7d9mryjtpuojvi62ho7weooy.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 6. Um trecho do código executável da função get_login_user</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
. Para demonstrar com êxito a exploração dessa vulnerabilidade, precisamos enviar como parâmetro uma </font></font><code>Cookie c_session</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linha longa que contém:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comando de cadeia do SO, que será posteriormente passado para a função mysystem;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o endereço desse comando na pilha;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">novo endereço de retorno (endereço do fragmento de código mostrado na Fig. 5).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A carga útil final deve se parecer com a seguinte: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uz/zv/xp/uzzvxpf4lv9zws3zpnmjgdzqcyq.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 7. Carga útil</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Neste ponto, já tínhamos um shell no dispositivo obtido usando uma vulnerabilidade que precisava de direitos de administrador para operar. </font><font style="vertical-align: inherit;">Portanto, conseguimos obter informações adicionais que nos ajudaram a operar:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O ASLR no dispositivo em estudo foi desativado - portanto, os endereços do gadget usado e os comandos do SO sempre serão os mesmos.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/wi/84/v3/wi84v3-p-susaji9zxkzat8yrdq.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 8. Status do ASLR no dispositivo sob investigação</font></font></i><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O intervalo de endereços de memória em que a pilha pode estar. </font><font style="vertical-align: inherit;">Para calcular o endereço exato, examinamos todos os endereços desse intervalo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como carga útil, implementamos o carregamento de um web shell, um aplicativo CGI com o seguinte conteúdo:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">eval</span> <span class="hljs-variable">$HTTP_CMD</span> 2&gt;&amp;1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como, de acordo com o protocolo CGI, o conteúdo dos cabeçalhos HTTP é transmitido ao aplicativo CGI na forma de variáveis ​​de ambiente com os nomes HTTP_ &lt;Header Name&gt;, este shell utilizará o comando </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para executar o conteúdo do cabeçalho HTTP CMD. </font><font style="vertical-align: inherit;">A figura abaixo mostra o resultado da operação e execução bem-sucedidas do comando ls usando o shell carregado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/az/lp/um/azlpumbjd1xgx9r6q3xqhihtiqy.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 9. O resultado da operação e execução bem-sucedidas do comando ls</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusão</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Demonstramos a capacidade de explorar essa vulnerabilidade. </font><font style="vertical-align: inherit;">Como já mencionamos, sua operação não requer conhecimento da senha e, portanto, pode ser executada mesmo por um invasor não autenticado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hackear um switch de rede industrial pode comprometer toda a produção. </font><font style="vertical-align: inherit;">A violação da interação da rede pode afetar adversamente o processo até que ele pare completamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As informações sobre a vulnerabilidade e o PoC foram transmitidas ao fornecedor, que lançou a versão atualizada do firmware 1.34, e o identificador CVE-2018-10731 foi atribuído à própria vulnerabilidade.</font></font><br>
<br>
<blockquote><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À procura de uma pessoa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você deseja fazer essas coisas, estamos apenas procurando um especialista em nossa equipe. </font><font style="vertical-align: inherit;">Estamos envolvidos na análise de segurança de sistemas de controle de processos (grandes instalações industriais / de energia / transporte, etc.). </font><font style="vertical-align: inherit;">Em cada projeto, procuramos maneiras de parar ou interromper a operação desses objetos. </font><font style="vertical-align: inherit;">Cada vez que encontramos muitas maneiras de influenciar o processo de fabricação, explorando hardware e software industrial, analisando protocolos de rede proprietários. </font><font style="vertical-align: inherit;">Encontramos e relatamos muito zirodey, escrevemos relatórios (não de acordo com o GOST) e fazemos muito mais. </font><font style="vertical-align: inherit;">Quando há tempo, falamos no IB e não apenas em conferências. </font><font style="vertical-align: inherit;">Link para a vaga: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hh.ru/vacancy/36371389</font></font></a></blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Publicado por</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vyacheslav Moskvin, Positive Technologies</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt493932/index.html">Visão geral das pesquisas do Google. Por que não é adequado para pesquisas sérias</a></li>
<li><a href="../pt493934/index.html">Quem, como e no que explorou os oceanos do mundo - analisamos as bases da NOAA</a></li>
<li><a href="../pt493938/index.html">Como cortar custos na AWS</a></li>
<li><a href="../pt493940/index.html">Protocolo de tratamento natural de coronavírus 2019-nCoV</a></li>
<li><a href="../pt493942/index.html">Vírus básico em 20 minutos ou por que você deve usar antivírus</a></li>
<li><a href="../pt493948/index.html">Como eu fiz um respirador KN95 em casa a partir de materiais improvisados. instruções detalhadas</a></li>
<li><a href="../pt493950/index.html">Calculadora de rede neural para adicionar e subtrair números não muito grandes</a></li>
<li><a href="../pt493952/index.html">Como avaliar a inteligência? Abordagem do Google</a></li>
<li><a href="../pt493954/index.html">PostgreSQL Adicionar restrições não nulas a tabelas grandes</a></li>
<li><a href="../pt493960/index.html">Configurando uma impressora de etiquetas XPrinter no Linux na estação de trabalho VMware</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>