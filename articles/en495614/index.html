<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👐🏼 👯 ⛽️ FFmpeg libav manual 🔫 👩‍⚕️ 🐋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Long I searched for a book that would be chewed to use FFmpeg -like library known as libav (the name stands for lib rary a udio v ideo ). Found a text...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>FFmpeg libav manual</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/edison/blog/495614/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><div style="text-align:center;"><img width="779" height="232" src="https://habrastorage.org/webt/yn/ed/vp/ynedvpoyntkab2ppkqxuqtrbwma.png"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Long I searched for a book that would be chewed to use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -like library known as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libav</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (the name stands for </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rary </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> udio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ideo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Found a textbook " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to write a video player and fit in less than a thousand lines</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ." Unfortunately, the information there is outdated, so I had to create a manual on my own. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most of the code will be in C, but do not worry: you will easily understand everything and can apply it in your favorite language. FFmpeg libav has a lot of bindings to many languages ​​(including Python and Go). But even if your language does not have direct compatibility, you can still </font><font style="vertical-align: inherit;">get </font><font style="vertical-align: inherit;">attached via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (here is an example with</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lua</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with a short digression on what video, audio, codecs and containers are. </font><font style="vertical-align: inherit;">Then we move on to the crash course on using the FFmpeg command line, and finally write the code. </font><font style="vertical-align: inherit;">Feel free to go straight to the “The Thorny Path to Learning FFmpeg libav” section. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is an opinion (and not only mine) that streaming Internet video has already taken the baton from traditional television. </font><font style="vertical-align: inherit;">Be that as it may, FFmpeg libav is definitely worth exploring.</font></font><a name="menu"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table of contents</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video is what you see!</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audio is what you hear!</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec - Data Compression</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A container is a convenient way to store audio / video</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ffmpeg command line</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg 101 command line tool</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basic operations on video</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcoding</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexing</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transrating</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transizing</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus: adaptive streaming</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Going beyond</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   FFmpeg libav</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> 0 —  «Hello World»</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">FFmpeg libav </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">, </a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> 1 —    </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> 2 — </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> 3 — </a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></li>
</ul></li>
</ul></li>
</ul><a name="intro"></a><a name="video"></a><a name="habracut"></a><blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" title="EDISON Software - web-development"><img align="left" width="153" height="75" src="https://habrastorage.org/webt/w0/zl/to/w0zltoxvysbr0yeinstkfvw1wbg.png" alt="EDISON Software - web-development"></a><br clear="right">
     EDISON.<br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  ,  </a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   </a>.<br>
<br>
     ! ;-)</blockquote><img align="right" width="210" height="280" src="https://habrastorage.org/webt/5k/lz/nu/5klznusfiwgawobmtbcrpdboscw.jpeg"><br clear="left">
<h2> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">↑</a></h2><br>
<h3> —  ,   ! <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">↑</a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the sequence of images is changed at a given frequency (say, 24 images per second), an illusion of movement is created. </font><font style="vertical-align: inherit;">This is the main idea of ​​the video: a series of images (frames) moving at a given speed. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1886 illustration.</font></font></i><br>
<br>
<a name="audio"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audio is what you hear! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although silent video can cause a wide variety of feelings, adding sound dramatically increases the degree of pleasure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sound is vibrational waves propagating in air or in any other transmission medium (such as gas, liquid or solid). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a digital audio system, a microphone converts sound into an analog electrical signal. </font><font style="vertical-align: inherit;">Then, an analog-to-digital converter ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - usually using pulse-code modulation ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - converts an analog signal to a digital one.</font></font><br>
<br>
<div style="text-align:center;"><img width="640" height="220" src="https://habrastorage.org/webt/eu/gb/_m/eugb_mwqa5x5yctawseum7qdtss.png"></div><br>
<a name="codec"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec - data compression </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A codec is an electronic circuit or software that compresses or decompresses digital audio / video. </font><font style="vertical-align: inherit;">It converts raw (uncompressed) digital audio / video into a compressed format (or vice versa). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But if we decide to pack millions of images into one file and call it a movie, we can get a huge file. </font><font style="vertical-align: inherit;">Let's calculate: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's say we create a video with a resolution of 1080 × 1920 (height × width). </font><font style="vertical-align: inherit;">We spend 3 bytes per pixel (the minimum point on the screen) for color coding (24-bit color, which gives us </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16,777,216</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> different colors). </font><font style="vertical-align: inherit;">This video works at a speed of 24 frames per second, the total duration of 30 minutes.</font></font><br>
<br>
<pre><code class="cpp hljs">toppf = <span class="hljs-number">1080</span> * <span class="hljs-number">1920</span> <span class="hljs-comment">//    </span>
cpp = <span class="hljs-number">3</span> <span class="hljs-comment">//  </span>
tis = <span class="hljs-number">30</span> * <span class="hljs-number">60</span> <span class="hljs-comment">//   </span>
fps = <span class="hljs-number">24</span> <span class="hljs-comment">//   </span><font></font>
<font></font>
required_storage = tis * fps * toppf * cpp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This video will require approximately 250.28 GB of memory, or 1.11 Gb / s! </font><font style="vertical-align: inherit;">That's why you have to use a codec.</font></font><br>
<br>
<a name="container"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A container is a convenient way to store audio / video </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The container (wrapper) format is a metafile format whose specification describes how various data and metadata elements coexist in a computer file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a single file containing all streams (mainly audio and video), providing synchronization, containing common metadata (such as title, resolution), etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Typically, the file format is determined by its extension: for example, video.webm is most likely video using the webm container.</font></font><br>
<br>
<div style="text-align:center;"><img width="621" height="328" src="https://habrastorage.org/webt/ay/du/qa/ayduqaajbhuh59tah4vdgcu2sj0.png"></div><br>
<a name="command_line"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command line FFmpeg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Self-contained cross-platform solution for recording, converting and streaming audio / video. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For working with multimedia, we have an amazing tool - a library called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Even if you don’t use it in your program code, you still use it (are you using Chrome?). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The library has a console program for entering a command line called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (in small letters, in contrast to the name of the library itself). </font><font style="vertical-align: inherit;">This is a simple and powerful binary. </font><font style="vertical-align: inherit;">For example, you can convert from mp4 to avi by simply typing this command:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg -i input.mp4 output.avi</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We just </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remixed</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - converted from one container to another. </font><font style="vertical-align: inherit;">Technically, FFmpeg can also transcode, but more on that later.</font></font><br>
<br>
<a name="101"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command line tool FFmpeg 101 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpeg has </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> where everything is perfectly explained how what works. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schematically, the FFmpeg command-line program expects the following argument format to do its job - </font></font><code><b>ffmpeg {1} {2} -i {3} {4} {5}</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{1}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - global parameters </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{2}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - parameters of the input file </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{3}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - incoming URL </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{4}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - parameters of the output file </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{5}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - outgoing URL </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parts {2}, {3}, {4}, {5} specify as many arguments as needed. </font><font style="vertical-align: inherit;">It’s easier to understand the format of passing arguments using an example: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WARNING: a file by reference weighs 300 MB</font></font></b><br>
<br>
<pre><code class="bash hljs">$ wget -O bunny_1080p_60fps.mp4 http://distribution.bbb3d.renderfarming.net/video/mp4/bbb_sunflower_1080p_60fps_normal.mp4<font></font>
<font></font>
$ ffmpeg \<font></font>
-y \ <span class="hljs-comment">#  </span>
-c: libfdk_aac -c: v libx264 \ <span class="hljs-comment">#  </span>
-i bunny_1080p_60fps.mp4 \ <span class="hljs-comment">#  URL</span>
-c: v libvpx-vp9 -c: libvorbis \ <span class="hljs-comment">#  </span>
bunny_1080p_60fps_vp9.webm <span class="hljs-comment">#  URL</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This command takes an incoming mp4 file containing two streams (audio encoded using the aac codec, and video encoded using the h264 codec), and converts it to webm, changing also the audio and video codecs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you simplify the above command, you should consider that FFmpeg will accept the default values ​​instead of you. </font><font style="vertical-align: inherit;">For example, if you simply type</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -i input.avi output.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
which audio / video codec does it use to create output.mp4? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werner Robitz wrote a </font><font style="vertical-align: inherit;">coding and editing </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for reading / executing with FFmpeg.</font></font><br>
<br>
<a name="operations"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basic video operations </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When working with audio / video, we usually perform a number of tasks related to multimedia.</font></font><br>
<br>
<a name="transcoding"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcoding (transcoding) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<br>
<div style="text-align:center;"><img width="494" height="225" src="https://habrastorage.org/webt/uf/fl/cr/ufflcrik3ha4z6tt5axevtdfv9u.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is it? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The process of converting streaming or audio or video (or both at the same time) from one codec to another. </font><font style="vertical-align: inherit;">The file format (container) does not change. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For what? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It happens that some devices (TVs, smartphones, consoles, etc.) do not support the audio / video format X, but support the audio / video format Y. Or, newer codecs are preferable because they provide a better compression ratio. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convert, for example, video H264 (AVC) to H265 (HEVC):</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-c:v libx265 \<font></font>
bunny_1080p_60fps_h265.mp4</code></pre><br>
<a name="transmuxing"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexing </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<div style="text-align:center;"><img width="492" height="231" src="https://habrastorage.org/webt/es/vp/gm/esvpgmlkjcj38alzp2sbrdckpne.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is it? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convert from one format (container) to another. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For what? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It happens that some devices (TVs, smartphones, consoles, etc.) do not support the X file format, but support the Y file format. Or, newer containers, unlike older ones, provide the modern required functions. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convert a mp4 to webm:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-c copy \ <span class="hljs-comment"># just saying to ffmpeg to skip encoding</span>
bunny_1080p_60fps.webm</code></pre><br>
<a name="transrating"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transrating </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<div style="text-align:center;"><img width="437" height="235" src="https://habrastorage.org/webt/ev/hx/cp/evhxcp7a6y5fkjjq9s53hyfs3iq.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is it? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change the data rate or create another view. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For what? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The user can watch your video both on a 2G network on a low-power smartphone, and via fiber-optic Internet connection on a 4K TV. </font><font style="vertical-align: inherit;">Therefore, you should offer more than one option for playing the same video with different data rates. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produces playback at a bit rate between 3856K and 2000K.</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-minrate 964K -maxrate 3856K -bufsize 2000K \<font></font>
bunny_1080p_60fps_transrating_964_3856.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Typically, transrating is done in conjunction with recalibration. </font><font style="vertical-align: inherit;">Werner Robitz wrote another </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obligatory article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on speed control FFmpeg.</font></font><br>
<br>
<a name="transsizing"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transizing (recalibration) </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<div style="text-align:center;"><img width="515" height="277" src="https://habrastorage.org/webt/gj/c2/4k/gjc24kcqli3iwwdkzbb70pbue-k.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is it? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resolution change. </font><font style="vertical-align: inherit;">As stated above, transsizing is often carried out simultaneously with transrating. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For what? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the same reasons as with transrating. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reduce the resolution of 1080 to 480:</font></font><br>
<br>
<pre><code class="bash hljs">$ ffmpeg \<font></font>
-i bunny_1080p_60fps.mp4 \<font></font>
-vf scale=480:-1 \<font></font>
bunny_1080p_60fps_transsizing_480.mp4</code></pre><br>
<a name="bonus"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus: adaptive streaming </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br>
<div style="text-align:center;"><img width="750" height="134" src="https://habrastorage.org/webt/3z/az/lg/3zazlgpe3wjx3zvvhapi0z3ur68.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is it? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creation of many permissions (bitrates) and splitting the media into parts and their transmission via the http protocol. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For what? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the sake of providing flexible multimedia, which can be viewed even on a budget smartphone, even on a 4K plasma, so that it can be easily scaled and deployed (but this can add a delay). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How? </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create responsive WebM using DASH:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># video streams</span><font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 160x90 -b:v 250k -keyint_min 150 -g 150 -an -f webm -dash 1 video_160x90_250k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 320x180 -b:v 500k -keyint_min 150 -g 150 -an -f webm -dash 1 video_320x180_500k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 640x360 -b:v 750k -keyint_min 150 -g 150 -an -f webm -dash 1 video_640x360_750k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 640x360 -b:v 1000k -keyint_min 150 -g 150 -an -f webm -dash 1 video_640x360_1000k.webm<font></font>
<font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:v libvpx-vp9 -s 1280x720 -b:v 1500k -keyint_min 150 -g 150 -an -f webm -dash 1 video_1280x720_1500k.webm<font></font>
<font></font>
<span class="hljs-comment"># audio streams</span><font></font>
$ ffmpeg -i bunny_1080p_60fps.mp4 -c:a libvorbis -b:a 128k -vn -f webm -dash 1 audio_128k.webm<font></font>
<font></font>
<span class="hljs-comment"># the DASH manifest</span><font></font>
$ ffmpeg \<font></font>
 -f webm_dash_manifest -i video_160x90_250k.webm \<font></font>
 -f webm_dash_manifest -i video_320x180_500k.webm \<font></font>
 -f webm_dash_manifest -i video_640x360_750k.webm \<font></font>
 -f webm_dash_manifest -i video_640x360_1000k.webm \<font></font>
 -f webm_dash_manifest -i video_1280x720_500k.webm \<font></font>
 -f webm_dash_manifest -i audio_128k.webm \<font></font>
 -c copy -map 0 -map 1 -map 2 -map 3 -map 4 -map 5 \<font></font>
 -f webm_dash_manifest \<font></font>
 -adaptation_sets <span class="hljs-string">"id=0,streams=0,1,2,3,4 id=1,streams=5"</span> \<font></font>
 manifest.mpd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS: I pulled this example from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instructions for playing Adaptive WebM using DASH</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a name="beyond"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Going beyond </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are no other uses for FFmpeg. </font><font style="vertical-align: inherit;">I use it with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iMovie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to create / edit some YouTube videos. </font><font style="vertical-align: inherit;">And, of course, nothing prevents you from using it professionally.</font></font><br>
<br>
<a name="hard_way"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The thorny path of learning FFmpeg libav </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h2><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is it not amazing from time to time that is perceived through hearing and sight? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biologist David Robert Jones</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg is extremely useful as a command-line tool for performing important operations with multimedia files. </font><font style="vertical-align: inherit;">Maybe it can be used in programs too? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FFmpeg consists of several libraries that can be integrated into our own programs. </font><font style="vertical-align: inherit;">Usually, when you install FFmpeg, all of these libraries are automatically installed. </font><font style="vertical-align: inherit;">I will refer to a set of these libraries as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg libav</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The title of the section is a tribute to Zed Shaw's series The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thorny Path of Learning [...]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in particular his book The Thorny Path of Learning C.</font></font><br>
<br>
<a name="chapter_0"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 0 - The Simple Hello World </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello World</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you really won’t welcome the world in console language. </font><font style="vertical-align: inherit;">Instead, print the following information about the video: format (container), duration, resolution, audio channels, and finally, decrypt some frames and save them as image files.</font></font><br>
<br>
<a name="architecture"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FFmpeg libav architecture </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But before we start writing the code, let's see how the FFmpeg libav architecture works in general and how its components interact with others. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is a diagram of the video decoding process:</font></font><br>
<div style="text-align:center;"><img width="750" height="424" src="https://habrastorage.org/webt/ej/1d/ek/ej1deksvwwqdctppaujla5v5tog.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, the media file is loaded into a component called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (the video container is also a format). In fact, it does not fully download the entire file: often only the header is read. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once you have downloaded the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">minimum header of our container</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you can access its streams (they can be represented as elementary audio and video data). Each stream will be available in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> component </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose our video has two streams: audio encoded using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AAC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> codec </font><font style="vertical-align: inherit;">, and video encoded using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H264 codec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). From each stream we can extract pieces of data called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">packets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that are loaded into components called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The data inside the packets is still encoded (compressed), and to decode the packets we need to pass them to a specific </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decodes them into an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as a result of which this component gives us an uncompressed frame. </font><font style="vertical-align: inherit;">Note that the terminology and process are the same for both audio and video streams.</font></font><br>
<br>
<a name="requirements"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Requirements </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since sometimes there are problems when compiling or running examples, we will use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as a development / runtime environment. </font><font style="vertical-align: inherit;">We will also use a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video with a big rabbit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so if you do not have it on your local computer, just run the command </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make fetch_small_bunny_video</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the console </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="code"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually, the code </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TLDR </font><font style="vertical-align: inherit;">show me an example of executable code, bro:</font></font><br>
<br>
<pre><code class="bash hljs">$ make run_hello</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will omit some details, but don’t worry: the source code </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is available</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on github. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are going to allocate memory for the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> component </font><font style="vertical-align: inherit;">, which will contain information about the format (container).</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *pFormatContext = avformat_alloc_context();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we are going to open the file, read its header and fill </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext with</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> minimal format information (note that codecs usually do not open). </font><font style="vertical-align: inherit;">To do this, use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_open_input</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It expects </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a file name, and two optional arguments: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVInputFormat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (if you pass NULL, FFmpeg will determine the format) and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVDictionary</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (which are demultiplexer options).</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_open_input(&amp;pFormatContext, filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also print the name of the format and the duration of the media:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"Format %s, duration %lld us"</span>, pFormatContext-&gt;iformat-&gt;long_name, pFormatContext-&gt;duration);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To access the streams, we need to read the data from the media. </font><font style="vertical-align: inherit;">This is done by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_find_stream_info</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Now </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatContext-&gt; nb_streams</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will contain the number of threads, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFormatContext-&gt; streams [i]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will give us the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> th flow in a row ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_find_stream_info(pFormatContext,  <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's go through the loop in all threads:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pFormatContext-&gt;nb_streams; i++) {
  <span class="hljs-comment">//</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each stream, we are going to save </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecParameters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which describes the properties of the codec used by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> th stream:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecParameters *pLocalCodecParameters = pFormatContext-&gt;streams[i]-&gt;codecpar;</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the properties of the codecs, we can find the corresponding one by requesting the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_find_decoder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, we can also find the registered decoder for the codec identifier and return </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a component that knows how to encode and decode the stream:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodec *pLocalCodec = avcodec_find_decoder(pLocalCodecParameters-&gt;codec_id);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can print the codec information:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// specific for video and audio</span>
<span class="hljs-keyword">if</span> (pLocalCodecParameters-&gt;codec_type == AVMEDIA_TYPE_VIDEO) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Video Codec: resolution %d x %d"</span>, pLocalCodecParameters-&gt;width, pLocalCodecParameters-&gt;height);<font></font>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pLocalCodecParameters-&gt;codec_type == AVMEDIA_TYPE_AUDIO) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Audio Codec: %d channels, sample rate %d"</span>, pLocalCodecParameters-&gt;channels, pLocalCodecParameters-&gt;sample_rate);<font></font>
}<font></font>
<span class="hljs-comment">// general</span>
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\tCodec %s ID %d bit_rate %lld"</span>, pLocalCodec-&gt;long_name, pLocalCodec-&gt;id, pCodecParameters-&gt;bit_rate);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the codec, we allocate memory for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which will contain the context for our decoding / encoding process. </font><font style="vertical-align: inherit;">But then you need to populate this codec context with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CODEC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameters </font><font style="vertical-align: inherit;">- we do this using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_parameters_to_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After we have filled in the codec context, you need to open the codec. </font><font style="vertical-align: inherit;">We </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">call the avcodec_open2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">and then we can use it:</font></font><br>
<br>
<pre><code class="cpp hljs">AVCodecContext *pCodecContext = avcodec_alloc_context3(pCodec);<font></font>
avcodec_parameters_to_context(pCodecContext, pCodecParameters);<font></font>
avcodec_open2(pCodecContext, pCodec, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we are going to read packets from the stream and decode them into frames, but first we need to allocate memory for both components ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<pre><code class="cpp hljs">AVPacket *pPacket = av_packet_alloc();<font></font>
AVFrame *pFrame = av_frame_alloc();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's feed our packages from the streams of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">while it has the packages:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span>(av_read_frame(pFormatContext, pPacket) &gt;= <span class="hljs-number">0</span>) {
  <span class="hljs-comment">//...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we will send the raw data packet (compressed frame) to the decoder through the codec context using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs">avcodec_send_packet(pCodecContext, pPacket);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And let's get a frame of raw data (an uncompressed frame) from the decoder through the same codec context using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs">avcodec_receive_frame(pCodecContext, pFrame);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can print the frame number, PTS, DTS, frame type, etc .:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(
    <span class="hljs-string">"Frame %c (%d) pts %d dts %d key_frame %d [coded_picture_number %d, display_picture_number %d]"</span>,<font></font>
    av_get_picture_type_char(pFrame-&gt;pict_type),<font></font>
    pCodecContext-&gt;frame_number,<font></font>
    pFrame-&gt;pts,<font></font>
    pFrame-&gt;pkt_dts,<font></font>
    pFrame-&gt;key_frame,<font></font>
    pFrame-&gt;coded_picture_number,<font></font>
    pFrame-&gt;display_picture_number<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And finally, we can save our decoded frame into a simple gray image. </font><font style="vertical-align: inherit;">The process is very simple: we will use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pFrame-&gt; data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , where the index is associated with the color spaces </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Just select 0 (Y) to save our gray image:</font></font><br>
<br>
<pre><code class="cpp hljs">save_gray_frame(pFrame-&gt;data[<span class="hljs-number">0</span>], pFrame-&gt;linesize[<span class="hljs-number">0</span>], pFrame-&gt;width, pFrame-&gt;height, frame_filename);<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save_gray_frame</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *buf, <span class="hljs-keyword">int</span> wrap, <span class="hljs-keyword">int</span> xsize, <span class="hljs-keyword">int</span> ysize, <span class="hljs-keyword">char</span> *filename)</span>
</span>{<font></font>
    FILE *f;<font></font>
    <span class="hljs-keyword">int</span> i;<font></font>
    f = fopen(filename,<span class="hljs-string">"w"</span>);
    <span class="hljs-comment">// writing the minimal required header for a pgm file format</span>
    <span class="hljs-comment">// portable graymap format -&gt; https://en.wikipedia.org/wiki/Netpbm_format#PGM_example</span>
    <span class="hljs-built_in">fprintf</span>(f, <span class="hljs-string">"P5\n%d %d\n%d\n"</span>, xsize, ysize, <span class="hljs-number">255</span>);<font></font>
<font></font>
    <span class="hljs-comment">// writing line by line</span>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ysize; i++)<font></font>
        fwrite(buf + i * wrap, <span class="hljs-number">1</span>, xsize, f);<font></font>
    fclose(f);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And voila! </font><font style="vertical-align: inherit;">Now we have a 2MB grayscale image:</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="413" src="https://habrastorage.org/webt/gk/tf/i9/gktfi9xb3ylqmmzu927uc7aon9w.png"></div><br>
<a name="chapter_1"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 1 - Sync Audio and Video </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Being in the game is when a young JS developer writes a new MSE video player.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before we start writing transcoding code, let's talk about synchronization or how the video player finds out the right time to play a frame. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the previous example, we saved several frames: </font></font><br>
<img width="194" height="110" src="https://habrastorage.org/webt/gj/yz/7h/gjyz7h4agcr6n2hdkmt9w9ko5ho.png"> <img width="194" height="110" src="https://habrastorage.org/webt/is/cl/yy/isclyy5ckz1_4w2mepv4msr2dba.png"> <img width="194" height="110" src="https://habrastorage.org/webt/7z/tr/mu/7ztrmukulalxo5qihbly0cpm_5w.png"> <img width="194" height="110" src="https://habrastorage.org/webt/u3/q8/pq/u3q8pqb2qxhroy1ycatplyeveco.png"> <img width="194" height="110" src="https://habrastorage.org/webt/uu/lh/ih/uulhihectxop1sphmmss_ipvfpc.png"> <img width="194" height="110" src="https://habrastorage.org/webt/9x/ss/bm/9xssbmfyxzra5frtcob9dirkxt8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we design a video player, we need to play each frame at a certain pace, otherwise it is difficult to enjoy the video either because it plays too fast or too slow. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we need to define some logic for smooth playback of each frame. In this regard, each frame has a time representation mark ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resentation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ime </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamp), which is an increasing number taken into account in the variable</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is a rational number (where the denominator is known as the time scale - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timescale</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) divided by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frame rate</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It’s easier to understand with examples. </font><font style="vertical-align: inherit;">Let's simulate some scenarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps = 60/1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase = 1/60000,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> each </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will increase </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timescale / fps = 1000</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so the real </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> time </font><font style="vertical-align: inherit;">for each frame can be (provided that it starts at 0):</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">1000</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.016</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">2000</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.033</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Almost the same scenario, but with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timescale</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> equal to 1/60:</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">1</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.016</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">2</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.033</span>
frame=<span class="hljs-number">3</span>, PTS = <span class="hljs-number">3</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.050</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fps = 25/1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timebase = 1/75,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> each </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will increase </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timescale / fps = 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> time </font><font style="vertical-align: inherit;">can be:</font></font><br>
<br>
<pre><code class="cpp hljs">frame=<span class="hljs-number">0</span>, PTS = <span class="hljs-number">0</span>, PTS_TIME = <span class="hljs-number">0</span>
frame=<span class="hljs-number">1</span>, PTS = <span class="hljs-number">3</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.04</span>
frame=<span class="hljs-number">2</span>, PTS = <span class="hljs-number">6</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.08</span>
frame=<span class="hljs-number">3</span>, PTS = <span class="hljs-number">9</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.12</span><font></font>
...<font></font>
frame=<span class="hljs-number">24</span>, PTS = <span class="hljs-number">72</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">0.96</span><font></font>
...<font></font>
frame=<span class="hljs-number">4064</span>, PTS = <span class="hljs-number">12192</span>, PTS_TIME = PTS * timebase = <span class="hljs-number">162.56</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we can find a way to visualize this in sync with the sound of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pts_time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or with the system clock. </font><font style="vertical-align: inherit;">FFmpeg libav provides this information through its API:</font></font><br>
<br>
<pre><code class="cpp hljs">fps = AVStream-&gt;avg_frame_rate<font></font>
tbr = AVStream-&gt;r_frame_rate<font></font>
tbn = AVStream-&gt;time_base</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just out of curiosity, the frames we saved were sent in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> order </font><font style="vertical-align: inherit;">(frames: 1, 6, 4, 2, 3, 5), but reproduced in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> order </font><font style="vertical-align: inherit;">(frames: 1, 2, 3, 4, 5). </font><font style="vertical-align: inherit;">Also note how much cheaper </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> frames are compared to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> frames:</font></font><br>
<br>
<pre><code class="cpp hljs">LOG: AVStream-&gt;r_frame_rate <span class="hljs-number">60</span>/<span class="hljs-number">1</span>
LOG: AVStream-&gt;time_base <span class="hljs-number">1</span>/<span class="hljs-number">60000</span><font></font>
...<font></font>
LOG: Frame <span class="hljs-number">1</span> (type=I, size=<span class="hljs-number">153797</span> bytes) pts <span class="hljs-number">6000</span> key_frame <span class="hljs-number">1</span> [DTS <span class="hljs-number">0</span>]<font></font>
LOG: Frame <span class="hljs-number">2</span> (type=B, size=<span class="hljs-number">8117</span> bytes) pts <span class="hljs-number">7000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">3</span>]<font></font>
LOG: Frame <span class="hljs-number">3</span> (type=B, size=<span class="hljs-number">8226</span> bytes) pts <span class="hljs-number">8000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">4</span>]<font></font>
LOG: Frame <span class="hljs-number">4</span> (type=B, size=<span class="hljs-number">17699</span> bytes) pts <span class="hljs-number">9000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">2</span>]<font></font>
LOG: Frame <span class="hljs-number">5</span> (type=B, size=<span class="hljs-number">6253</span> bytes) pts <span class="hljs-number">10000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">5</span>]<font></font>
LOG: Frame <span class="hljs-number">6</span> (type=P, size=<span class="hljs-number">34992</span> bytes) pts <span class="hljs-number">11000</span> key_frame <span class="hljs-number">0</span> [DTS <span class="hljs-number">1</span>]</code></pre><br>
<a name="chapter_2"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 2 - Remultiplexing </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remultiplexing (rearrangement, remuxing) - the transition from one format (container) to another. </font><font style="vertical-align: inherit;">For example, we can easily replace MPEG-4 video with MPEG-TS using FFmpeg:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg input.mp4 -c copy output.ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The MP4 file will be demultiplexed, while the file will not be decoded or encoded ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-c copy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), and, in the end, we get the mpegts file. </font><font style="vertical-align: inherit;">If you do not specify the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-f</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> format </font><font style="vertical-align: inherit;">, ffmpeg will try to guess it based on the file extension. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The general use of FFmpeg or libav follows such a pattern / architecture or workflow:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">protocol level</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - accepting input data (for example, a file, but it can also be rtmp or HTTP download)</font></font></li>
<li><b> </b> —  , ,  ,   </li>
<li><b> </b> —       </li>
<li><b> </b> —         (,  ),  </li>
<li>…        :</li>
<li><b> </b> —  (    )  </li>
<li><b> </b> —  ( )   ( )</li>
<li><b> </b> — , ,      (   , ,    )</li>
</ul><br>
<img src="https://habrastorage.org/webt/u6/x4/g3/u6x4g3oijeetm1lpdvxnjo9hwls.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(This graph is heavily inspired by the work of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leixiaohua</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slhck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Now let's create an example using libav to provide the same effect as when executing this command:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg input.mp4 -c copy output.ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are going to read from input ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_format_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and change it to another output ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">output_format_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="cpp hljs">AVFormatContext *input_format_context = <span class="hljs-literal">NULL</span>;<font></font>
AVFormatContext *output_format_context = <span class="hljs-literal">NULL</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually, we start by allocating memory and opening the input format. </font><font style="vertical-align: inherit;">For this specific case, we are going to open the input file and allocate memory for the output file:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> ((ret = avformat_open_input(&amp;input_format_context, in_filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not open input file '%s'"</span>, in_filename);
  <span class="hljs-keyword">goto</span> end;<font></font>
}<font></font>
<span class="hljs-keyword">if</span> ((ret = avformat_find_stream_info(input_format_context, <span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed to retrieve input stream information"</span>);
  <span class="hljs-keyword">goto</span> end;<font></font>
}<font></font>
<font></font>
avformat_alloc_output_context2(&amp;output_format_context, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, out_filename);
<span class="hljs-keyword">if</span> (!output_format_context) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not create output context\n"</span>);<font></font>
  ret = AVERROR_UNKNOWN;<font></font>
  <span class="hljs-keyword">goto</span> end;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will remultiplex only streams of video, audio and subtitles. </font><font style="vertical-align: inherit;">Therefore, we fix which flows we will use in an array of indices:</font></font><br>
<br>
<pre><code class="cpp hljs">number_of_streams = input_format_context-&gt;nb_streams;<font></font>
streams_list = av_mallocz_array(number_of_streams, <span class="hljs-keyword">sizeof</span>(*streams_list));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immediately after we allocate the necessary memory, we need to cycle through all the streams, and for each of which we need to create a new output stream in our context of the output format using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_new_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Please note that we flag all streams that are not video, audio or subtitles so that we can skip them.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; input_format_context-&gt;nb_streams; i++) {<font></font>
  AVStream *out_stream;<font></font>
  AVStream *in_stream = input_format_context-&gt;streams[i];<font></font>
  AVCodecParameters *in_codecpar = in_stream-&gt;codecpar;<font></font>
  <span class="hljs-keyword">if</span> (in_codecpar-&gt;codec_type != AVMEDIA_TYPE_AUDIO &amp;&amp;<font></font>
      in_codecpar-&gt;codec_type != AVMEDIA_TYPE_VIDEO &amp;&amp;<font></font>
      in_codecpar-&gt;codec_type != AVMEDIA_TYPE_SUBTITLE) {<font></font>
    streams_list[i] = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  streams_list[i] = stream_index++;<font></font>
  out_stream = avformat_new_stream(output_format_context, <span class="hljs-literal">NULL</span>);
  <span class="hljs-keyword">if</span> (!out_stream) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed allocating output stream\n"</span>);<font></font>
    ret = AVERROR_UNKNOWN;<font></font>
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
  ret = avcodec_parameters_copy(out_stream-&gt;codecpar, in_codecpar);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Failed to copy codec parameters\n"</span>);
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now create the output file:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (!(output_format_context-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE)) {<font></font>
  ret = avio_open(&amp;output_format_context-&gt;pb, out_filename, AVIO_FLAG_WRITE);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Could not open output file '%s'"</span>, out_filename);
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
}<font></font>
<font></font>
ret = avformat_write_header(output_format_context, <span class="hljs-literal">NULL</span>);
<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error occurred when opening output file\n"</span>);
  <span class="hljs-keyword">goto</span> end;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, you can copy streams, package by package, from our input to our output streams. </font><font style="vertical-align: inherit;">This happens in a loop, as long as there are packages ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_read_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), for each package you need to recalculate </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to finally write it ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) into our context of the output format.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<font></font>
  AVStream *in_stream, *out_stream;<font></font>
  ret = av_read_frame(input_format_context, &amp;packet);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)
    <span class="hljs-keyword">break</span>;<font></font>
  in_stream  = input_format_context-&gt;streams[packet.stream_index];<font></font>
  <span class="hljs-keyword">if</span> (packet.stream_index &gt;= number_of_streams || streams_list[packet.stream_index] &lt; <span class="hljs-number">0</span>) {<font></font>
    av_packet_unref(&amp;packet);<font></font>
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  packet.stream_index = streams_list[packet.stream_index];<font></font>
  out_stream = output_format_context-&gt;streams[packet.stream_index];<font></font>
  <span class="hljs-comment">/* copy packet */</span><font></font>
  packet.pts = av_rescale_q_rnd(packet.pts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);<font></font>
  packet.dts = av_rescale_q_rnd(packet.dts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);<font></font>
  packet.duration = av_rescale_q(packet.duration, in_stream-&gt;time_base, out_stream-&gt;time_base);<font></font>
  <span class="hljs-comment">// https://ffmpeg.org/doxygen/trunk/structAVPacket.html#ab5793d8195cf4789dfb3913b7a693903</span>
  packet.pos = <span class="hljs-number">-1</span>;<font></font>
<font></font>
  <span class="hljs-comment">//https://ffmpeg.org/doxygen/trunk/group__lavf__encoding.html#ga37352ed2c63493c38219d935e71db6c1</span><font></font>
  ret = av_interleaved_write_frame(output_format_context, &amp;packet);<font></font>
  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Error muxing packet\n"</span>);
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  av_packet_unref(&amp;packet);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To complete, we need to write the stream trailer to the output media file using the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_write_trailer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs">av_write_trailer(output_format_context);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we are ready to test the code. </font><font style="vertical-align: inherit;">And the first test will be the conversion of the format (video container) from MP4 to MPEG-TS video file. </font><font style="vertical-align: inherit;">Basically we create a command line ffmpeg input.mp4 -c to copy output.ts using libav.</font></font><br>
<br>
<pre><code class="bash hljs">make run_remuxing_ts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It works! </font><font style="vertical-align: inherit;">Do not believe me ?! </font><font style="vertical-align: inherit;">Check with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffprobe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">ffprobe -i remuxed_small_bunny_1080p_60fps.ts<font></font>
<font></font>
Input <span class="hljs-comment">#0, mpegts, from 'remuxed_small_bunny_1080p_60fps.ts':</span><font></font>
  Duration: 00:00:10.03, start: 0.000000, bitrate: 2751 kb/s<font></font>
  Program 1<font></font>
    Metadata:<font></font>
      service_name    : Service01<font></font>
      service_provider: FFmpeg<font></font>
    Stream <span class="hljs-comment">#0:0[0x100]: Video: h264 (High) ([27][0][0][0] / 0x001B), yuv420p(progressive), 1920x1080 [SAR 1:1 DAR 16:9], 60 fps, 60 tbr, 90k tbn, 120 tbc</span>
    Stream <span class="hljs-comment">#0:1[0x101]: Audio: ac3 ([129][0][0][0] / 0x0081), 48000 Hz, 5.1(side), fltp, 320 kb/s</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To summarize what we have done, we can now return to our original idea of ​​how libav works. </font><font style="vertical-align: inherit;">But we missed part of the codec, which is displayed in the diagram.</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="415" src="https://habrastorage.org/webt/_i/vz/yw/_ivzywrkd4le_hfwqyf-7hhrcb8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before we finish this chapter, I would like to show such an important part of the remultiplexing process, where you can pass parameters to the multiplexer. </font><font style="vertical-align: inherit;">Suppose you want to provide the MPEG-DASH format, so you need to use fragmented mp4 (sometimes called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fmp4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) instead of MPEG-TS or ordinary MPEG-4. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the command line is easy:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -i non_fragmented.mp4 -movflags frag_keyframe+empty_moov+default_base_moof fragmented.mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is almost as simple as this in the libav version, we simply pass the options when writing the output header, immediately before copying the packages:</font></font><br>
<br>
<pre><code class="cpp hljs">AVDictionary* opts = <span class="hljs-literal">NULL</span>;<font></font>
av_dict_set(&amp;opts, <span class="hljs-string">"movflags"</span>, <span class="hljs-string">"frag_keyframe+empty_moov+default_base_moof"</span>, <span class="hljs-number">0</span>);<font></font>
ret = avformat_write_header(output_format_context, &amp;opts);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can generate this fragmented mp4 file:</font></font><br>
<br>
<pre><code class="bash hljs">make run_remuxing_fragmented_mp4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make sure everything is fair, you can use the amazing </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpac / mp4box.js tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> site or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://mp4parser.com/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to see the differences - first download mp4.</font></font><br>
<br>
<img align="left" width="212" height="81" src="https://habrastorage.org/webt/x5/hw/9u/x5hw9uxcdgvl36yvns8hkquzlca.png"><div style="text-align:center;"><img width="750" height="1" src="https://habrastorage.org/webt/nz/x-/lg/nzx-lgxsv_fsqphsci0i8gabhfi.gif"></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, it has one indivisible </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">- this is the place where the video and audio frames are located. </font><font style="vertical-align: inherit;">Now download fragmented mp4 to see how it extends mdat blocks:</font></font><br>
<br>
<img align="left" width="184" height="140" src="https://habrastorage.org/webt/pu/bv/mm/pubvmm5ogancxewrdxfgdth1d34.png"><div style="text-align:center;"><img width="750" height="1" src="https://habrastorage.org/webt/nz/x-/lg/nzx-lgxsv_fsqphsci0i8gabhfi.gif"></div><a name="chapter_3"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 3 - Transcoding </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TLDR </font><font style="vertical-align: inherit;">show me the code and execution:</font></font><br>
<br>
<pre><code class="bash hljs">$ make run_transcoding</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will skip some details, but don’t worry: the source code </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is available</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on github. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this chapter, we will create a minimalist transcoder written in C, which can convert videos from H264 to H265 using the FFmpeg libav libraries, in particular </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavcodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavformat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libavutil</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img width="750" height="396" src="https://habrastorage.org/webt/pw/zj/ys/pwzjys-eok7ggnpkztlv7n60njm.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is an abstraction for the media file format, i.e. </font><font style="vertical-align: inherit;">for a container (MKV, MP4, Webm, TS) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> represents each data type for a given format (for example: audio, video, subtitles, metadata) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a fragment of compressed data received from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that can be decoded using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (for example : av1, h264, vp9, hevc) generating raw data called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFrame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a name="cahpter_3_transmuxing"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmultiplexing </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with a simple conversion, then load the input file.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Allocate an AVFormatContext</span><font></font>
avfc = avformat_alloc_context();<font></font>
<span class="hljs-comment">// Open an input stream and read the header.</span>
avformat_open_input(avfc, in_filename, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
<span class="hljs-comment">// Read packets of a media file to get stream information.</span>
avformat_find_stream_info(avfc, <span class="hljs-literal">NULL</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now configure the decoder. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will give us access to all components of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and for each of which we can get their </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and create a specific </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And finally, we can open this codec to go to the decoding process. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains media configuration data, such as data rate, frame rate, sample rate, channels, pitch, and many others.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; avfc-&gt;nb_streams; i++) {<font></font>
  AVStream *avs = avfc-&gt;streams[i];<font></font>
  AVCodec *avc = avcodec_find_decoder(avs-&gt;codecpar-&gt;codec_id);<font></font>
  AVCodecContext *avcc = avcodec_alloc_context3(*avc);<font></font>
  avcodec_parameters_to_context(*avcc, avs-&gt;codecpar);<font></font>
  avcodec_open2(*avcc, *avc, <span class="hljs-literal">NULL</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You also need to prepare the output media file for conversion. </font><font style="vertical-align: inherit;">First, allocate memory for the output </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVFormatContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Create each stream in the output format. </font><font style="vertical-align: inherit;">To properly pack the stream, copy the codec parameters from the decoder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Set the flag </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AV_CODEC_FLAG_GLOBAL_HEADER</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which tells the encoder that he can use global headers, and finally open the output file for writing and save the headers:</font></font><br>
<br>
<pre><code class="cpp hljs">avformat_alloc_output_context2(&amp;encoder_avfc, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, out_filename);<font></font>
<font></font>
AVStream *avs = avformat_new_stream(encoder_avfc, <span class="hljs-literal">NULL</span>);<font></font>
avcodec_parameters_copy(avs-&gt;codecpar, decoder_avs-&gt;codecpar);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (encoder_avfc-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)<font></font>
  encoder_avfc-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;<font></font>
<font></font>
avio_open(&amp;encoder_avfc-&gt;pb, encoder-&gt;filename, AVIO_FLAG_WRITE);<font></font>
avformat_write_header(encoder-&gt;avfc, &amp;muxer_opts);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get AVPacket</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the decoder, adjust the timestamps and write the packet correctly to the output file. </font><font style="vertical-align: inherit;">Despite the fact that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">reports “ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write frame</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”, we save the package. </font><font style="vertical-align: inherit;">We complete the permutation process by writing the stream trailer to a file.</font></font><br>
<br>
<pre><code class="cpp hljs">AVFrame *input_frame = av_frame_alloc();<font></font>
AVPacket *input_packet = av_packet_alloc();<font></font>
<font></font>
<span class="hljs-keyword">while</span>(av_read_frame(decoder_avfc, input_packet) &gt;= <span class="hljs-number">0</span>) {<font></font>
  av_packet_rescale_ts(input_packet, decoder_video_avs-&gt;time_base, encoder_video_avs-&gt;time_base);<font></font>
  av_interleaved_write_frame(*avfc, input_packet) &lt; <span class="hljs-number">0</span>));<font></font>
}<font></font>
<font></font>
av_write_trailer(encoder_avfc);</code></pre><br>
<a name="cahpter_3_transcoding"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transcoding </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">↑</font></font></a></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the previous section, there was a simple program for conversion, now we will add the ability to encode files, in particular, transcoding video from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the decoder is prepared, but before organizing the output media file, configure the encoder.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a video </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVStream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the encoder </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avformat_new_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the name </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libx265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_find_encoder_by_name</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVCodecContext</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> based on the created </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_alloc_context3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> codec </font><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set the basic attributes for a transcoding session and ...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... open the codec and copy the parameters from the context to the stream ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_open2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_parameters_from_context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ul><br>
<pre><code class="cpp hljs">AVRational input_framerate = av_guess_frame_rate(decoder_avfc, decoder_video_avs, <span class="hljs-literal">NULL</span>);<font></font>
AVStream *video_avs = avformat_new_stream(encoder_avfc, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
<span class="hljs-keyword">char</span> *codec_name = <span class="hljs-string">"libx265"</span>;
<span class="hljs-keyword">char</span> *codec_priv_key = <span class="hljs-string">"x265-params"</span>;
<span class="hljs-comment">// we're going to use internal options for the x265</span>
<span class="hljs-comment">// it disables the scene change detection and fix then</span>
<span class="hljs-comment">// GOP on 60 frames.</span>
<span class="hljs-keyword">char</span> *codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0"</span>;<font></font>
<font></font>
AVCodec *video_avc = avcodec_find_encoder_by_name(codec_name);<font></font>
AVCodecContext *video_avcc = avcodec_alloc_context3(video_avc);<font></font>
<span class="hljs-comment">// encoder codec params</span>
av_opt_set(sc-&gt;video_avcc-&gt;priv_data, codec_priv_key, codec_priv_value, <span class="hljs-number">0</span>);<font></font>
video_avcc-&gt;height = decoder_ctx-&gt;height;<font></font>
video_avcc-&gt;width = decoder_ctx-&gt;width;<font></font>
video_avcc-&gt;pix_fmt = video_avc-&gt;pix_fmts[<span class="hljs-number">0</span>];
<span class="hljs-comment">// control rate</span>
video_avcc-&gt;bit_rate = <span class="hljs-number">2</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_buffer_size = <span class="hljs-number">4</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_max_rate = <span class="hljs-number">2</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;<font></font>
video_avcc-&gt;rc_min_rate = <span class="hljs-number">2.5</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>;
<span class="hljs-comment">// time base</span><font></font>
video_avcc-&gt;time_base = av_inv_q(input_framerate);<font></font>
video_avs-&gt;time_base = sc-&gt;video_avcc-&gt;time_base;<font></font>
<font></font>
avcodec_open2(sc-&gt;video_avcc, sc-&gt;video_avc, <span class="hljs-literal">NULL</span>);<font></font>
avcodec_parameters_from_context(sc-&gt;video_avs-&gt;codecpar, sc-&gt;video_avcc);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is necessary to expand the decoding cycle for transcoding a video stream:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We send an empty </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVPacket to the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decoder ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uncompressed </font><b><font style="vertical-align: inherit;">AVFrame</font></b><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We begin recoding the raw frame.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We send the raw frame ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_send_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compression based on our </font><b><font style="vertical-align: inherit;">AVPacket</font></b><font style="vertical-align: inherit;"> codec </font><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avcodec_receive_packet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set the timestamp ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_packet_rescale_ts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We write to the output file ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">av_interleaved_write_frame</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ul><br>
<pre><code class="cpp hljs">AVFrame *input_frame = av_frame_alloc();<font></font>
AVPacket *input_packet = av_packet_alloc();<font></font>
<font></font>
<span class="hljs-keyword">while</span> (av_read_frame(decoder_avfc, input_packet) &gt;= <span class="hljs-number">0</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">int</span> response = avcodec_send_packet(decoder_video_avcc, input_packet);
  <span class="hljs-keyword">while</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
    response = avcodec_receive_frame(decoder_video_avcc, input_frame);<font></font>
    <span class="hljs-keyword">if</span> (response == AVERROR(EAGAIN) || response == AVERROR_EOF) {
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> response;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
      encode(encoder_avfc, decoder_video_avs, encoder_video_avs, decoder_video_avcc, input_packet-&gt;stream_index);<font></font>
    }<font></font>
    av_frame_unref(input_frame);<font></font>
  }<font></font>
  av_packet_unref(input_packet);<font></font>
}<font></font>
av_write_trailer(encoder_avfc);<font></font>
<font></font>
<span class="hljs-comment">// used function</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">encode</span><span class="hljs-params">(AVFormatContext *avfc, AVStream *dec_video_avs, AVStream *enc_video_avs, AVCodecContext video_avcc <span class="hljs-keyword">int</span> index)</span> </span>{<font></font>
  AVPacket *output_packet = av_packet_alloc();<font></font>
  <span class="hljs-keyword">int</span> response = avcodec_send_frame(video_avcc, input_frame);<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (response &gt;= <span class="hljs-number">0</span>) {<font></font>
    response = avcodec_receive_packet(video_avcc, output_packet);<font></font>
    <span class="hljs-keyword">if</span> (response == AVERROR(EAGAIN) || response == AVERROR_EOF) {
      <span class="hljs-keyword">break</span>;<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
<font></font>
    output_packet-&gt;stream_index = index;<font></font>
    output_packet-&gt;duration = enc_video_avs-&gt;time_base.den / enc_video_avs-&gt;time_base.num / dec_video_avs-&gt;avg_frame_rate.num * dec_video_avs-&gt;avg_frame_rate.den;<font></font>
<font></font>
    av_packet_rescale_ts(output_packet, dec_video_avs-&gt;time_base, enc_video_avs-&gt;time_base);<font></font>
    response = av_interleaved_write_frame(avfc, output_packet);<font></font>
  }<font></font>
  av_packet_unref(output_packet);<font></font>
  av_packet_free(&amp;output_packet);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We converted the media stream from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h265</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">As expected, the version of the h265 media file is smaller than the h264, while the program has ample opportunities:</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">/*
   * H264 -&gt; H265
   * Audio -&gt; remuxed (untouched)
   * MP4 - MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx265"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x265-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; remuxed (untouched)
   * MP4 - MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; remuxed (untouched)
   * MP4 - fragmented MP4
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">1</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
  sp.muxer_opt_key = <span class="hljs-string">"movflags"</span>;<font></font>
  sp.muxer_opt_value = <span class="hljs-string">"frag_keyframe+empty_moov+default_base_moof"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/*
   * H264 -&gt; H264 (fixed gop)
   * Audio -&gt; AAC
   * MP4 - MPEG-TS
   */</span>
  StreamingParams sp = {<span class="hljs-number">0</span>};<font></font>
  sp.copy_audio = <span class="hljs-number">0</span>;<font></font>
  sp.copy_video = <span class="hljs-number">0</span>;<font></font>
  sp.video_codec = <span class="hljs-string">"libx264"</span>;<font></font>
  sp.codec_priv_key = <span class="hljs-string">"x264-params"</span>;<font></font>
  sp.codec_priv_value = <span class="hljs-string">"keyint=60:min-keyint=60:scenecut=0:force-cfr=1"</span>;<font></font>
  sp.audio_codec = <span class="hljs-string">"aac"</span>;<font></font>
  sp.output_extension = <span class="hljs-string">".ts"</span>;<font></font>
<font></font>
  <span class="hljs-comment">/* WIP :P  -&gt; it's not playing on VLC, the final bit rate is huge
   * H264 -&gt; VP9
   * Audio -&gt; Vorbis
   * MP4 - WebM
   */</span>
  <span class="hljs-comment">//StreamingParams sp = {0};</span>
  <span class="hljs-comment">//sp.copy_audio = 0;</span>
  <span class="hljs-comment">//sp.copy_video = 0;</span>
  <span class="hljs-comment">//sp.video_codec = "libvpx-vp9";</span>
  <span class="hljs-comment">//sp.audio_codec = "libvorbis";</span>
  <span class="hljs-comment">//sp.output_extension = ".webm";</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hand on heart, I confess that it was a little more complicated than it seemed at the beginning. </font><font style="vertical-align: inherit;">I had to pick the FFmpeg command-line source code and test a lot. </font><font style="vertical-align: inherit;">Probably I missed something somewhere, because I had to use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">force-cfr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">h264</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and some warning messages still pop up, for example, that the frame type (5) was forcibly changed to the frame type (3).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translations on the Edison Blog:</font></font></h3><div class="scrollable-table"><table>
<tbody><tr>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/fr/yz/q7/fryzq72v0ik0irt2q4orchflxvs.jpeg"></a></td>
<td align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img width="360" height="180" src="https://habrastorage.org/webt/jv/3k/-f/jv3k-f5vi9drztohsh-e0t-puru.jpeg"></a></td>
</tr>
<tr>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Top 50 gaming franchises </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
with over a billion revenue</font></font></a></th>
<th align="center"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  Airbnb ?<br>
[: ]</a></th>
</tr>
</tbody></table></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495604/index.html">Temporary localization on Symfony 4 + Twig</a></li>
<li><a href="../en495606/index.html">"Social monitoring." Score 1: 0 in our favor</a></li>
<li><a href="../en495608/index.html">[Infographic] Visualization of pandemics in the history of mankind</a></li>
<li><a href="../en495610/index.html">Why the future is not for Python</a></li>
<li><a href="../en495612/index.html">Will Airbnb survive the coronavirus? [spoiler: yes]</a></li>
<li><a href="../en495618/index.html">Quarantine leads to losses. How to live without quarantine?</a></li>
<li><a href="../en495620/index.html">Assembled a video conferencing harvester at Jabra Panacast, pluses and minuses for office and home</a></li>
<li><a href="../en495622/index.html">Digital twin air conditioning system (SLE) aircraft</a></li>
<li><a href="../en495624/index.html">Why the Xbox Series X will be the main purchase of 2020</a></li>
<li><a href="../en495634/index.html">Everyone does it: why employees are the main threat to corporate information security and how to deal with it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>