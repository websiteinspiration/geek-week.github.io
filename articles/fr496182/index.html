<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë©‚Äçüëß‚Äçüëß üë¥üèº üë®üèª‚Äçüåæ Apache Kafka for Dummies üï¥üèΩ üè∞ üë©‚Äçüëß‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article sera utile √† ceux qui viennent de se familiariser avec l'architecture des microservices et le service Apache Kafka. Le mat√©riel ne pr√©tend...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Apache Kafka for Dummies</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496182/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cet article sera utile √† ceux qui viennent de se familiariser avec l'architecture des microservices et le service Apache Kafka. </font><font style="vertical-align: inherit;">Le mat√©riel ne pr√©tend pas √™tre un tutoriel d√©taill√©, mais vous aidera √† d√©marrer rapidement avec cette technologie. </font><font style="vertical-align: inherit;">Je vais vous expliquer comment installer et configurer Kafka sur Windows 10. Nous allons √©galement cr√©er un projet en utilisant Intellij IDEA et Spring Boot.</font></font><a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les difficult√©s √† comprendre divers outils sont souvent associ√©es au fait que le d√©veloppeur n'a jamais rencontr√© de situations dans lesquelles ces outils peuvent √™tre n√©cessaires. Avec Kafka, c'est exactement la m√™me chose. Nous d√©crivons la situation dans laquelle cette technologie sera utile. Si vous avez une architecture d'application monolithique, vous n'avez bien s√ªr pas besoin de Kafka. Tout change avec le passage aux microservices. En fait, chaque microservice est un programme distinct qui remplit l'une ou l'autre fonction et qui peut √™tre lanc√© ind√©pendamment des autres microservices. Les microservices peuvent √™tre compar√©s aux employ√©s du bureau, qui sont assis √† des bureaux s√©par√©s et r√©solvent ind√©pendamment leur probl√®me. Le travail d'une telle √©quipe r√©partie est impensable sans coordination centrale.Les employ√©s devraient pouvoir √©changer des messages et les r√©sultats de leur travail. Apache Kafka pour microservices est con√ßu pour r√©soudre ce probl√®me.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka est un courtier de messages. Avec lui, les microservices peuvent interagir les uns avec les autres, envoyant et recevant des informations importantes. La question se pose, pourquoi ne pas utiliser le POST-reqest r√©gulier √† ces fins, dans le corps duquel vous pouvez transf√©rer les donn√©es n√©cessaires et obtenir la r√©ponse de la m√™me mani√®re? Cette approche pr√©sente un certain nombre d'inconv√©nients √©vidents. Par exemple, un producteur (un service qui envoie un message) ne peut envoyer des donn√©es que sous la forme d'une r√©ponse en r√©ponse √† une demande d'un consommateur (un service qui re√ßoit des donn√©es). Supposons qu'un consommateur envoie une demande POST et que le producteur y r√©ponde. Pour le moment, pour une raison quelconque, le consommateur ne peut accepter la r√©ponse. Qu'adviendra-t-il des donn√©es? Ils seront perdus. Le consommateur devra √† nouveau envoyer une demande et esp√©rer que les donn√©es qu'il souhaite recevoir n'ont pas chang√© pendant cette p√©riode,et le producteur est toujours pr√™t √† accepter la demande.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka r√©sout ce probl√®me et bien d'autres qui surviennent lors de l'√©change de messages entre microservices. </font><font style="vertical-align: inherit;">Il ne sera pas inutile de rappeler que l'√©change de donn√©es ininterrompu et pratique est l'un des probl√®mes cl√©s qui doivent √™tre r√©solus pour assurer le fonctionnement stable de l'architecture de microservice.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer et configurer ZooKeeper et Apache Kafka sur Windows 10</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re chose que vous devez savoir pour commencer est qu'Apache Kafka s'ex√©cute en plus du service ZooKeeper. ZooKeeper est un service de configuration et de synchronisation distribu√©, et c'est tout ce que nous devons savoir √† ce sujet dans ce contexte. Nous devons le t√©l√©charger, le configurer et l'ex√©cuter avant de commencer avec Kafka. Avant de commencer √† travailler avec ZooKeeper, assurez-vous que JRE est install√© et configur√©. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez t√©l√©charger la derni√®re version de ZooKeeper sur le site officiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous extrayons les fichiers de l'archive ZooKeeper t√©l√©charg√©e dans un dossier sur le disque. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le dossier zookeeper avec le num√©ro de version, nous trouvons le dossier conf et le fichier ¬´zoo_sample.cfg¬ª.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/ke/pz/hokepzidcuiupzigc3i3wtlxi6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copiez-le et changez le nom de la copie en ¬´zoo.cfg¬ª. Ouvrez le fichier de copie et recherchez-y la ligne dataDir = / tmp / zookeeper. Dans cette ligne, nous √©crivons le chemin complet de notre dossier zookeeper-x.x.x. Cela ressemble √† ceci pour moi: dataDir = C: \\ ZooKeeper \\ zookeeper-3.6.0 </font></font><br>
<img src="https://habrastorage.org/webt/ri/sk/2h/risk2h-3u771fpod5vvxodydrhy.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous ajoutons la variable d'environnement syst√®me: ZOOKEEPER_HOME = C: \ ZooKeeper \ zookeeper-3.4.9 et √† la fin de la variable syst√®me Path, ajoutez l'entr√©e:;% ZOOKEEPER_HOME % \ poubelle; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez la ligne de commande et √©crivez la commande:</font></font><br>
<br>
<pre><code class="cs hljs">zkserver</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Si tout est fait correctement, vous verrez quelque chose comme ce qui suit. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b-/rs/i6/b-rsi6uqc40e77tchqnimmhsgo8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que ZooKeeper a d√©marr√© normalement. Nous proc√©dons directement √† l'installation et √† la configuration du serveur Apache Kafka. T√©l√©chargez la derni√®re version sur le site officiel et extrayez le contenu de l'archive: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kafka.apache.org/downloads</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dans le dossier avec Kafka, nous trouvons le dossier config, nous y trouvons le fichier server.properties et l'ouvrons. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/o5/m0/pxo5m032s0lvvmjqbhmfaazfnog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous trouvons la ligne log.dirs = / tmp / kafka-logs et y indiquons le chemin o√π Kafka enregistrera les journaux: log.dirs = c: / kafka / kafka-logs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/bi/mg/ghbimgkxct-2ox1a8s8klpackco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le m√™me dossier, modifiez le fichier zookeeper.properties. Nous changeons la ligne dataDir = / tmp / zookeeper en dataDir = c: / kafka / zookeeper-data, sans oublier d'indiquer le chemin vers votre dossier Kafka apr√®s le nom du disque. Si vous avez tout fait correctement, vous pouvez ex√©cuter ZooKeeper et Kafka.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/nd/mr/ydndmrfkovlk4z75mc99lbs3clk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour certains, il peut √™tre d√©sagr√©able de constater qu'il n'y a pas d'interface graphique pour contr√¥ler Kafka. </font><font style="vertical-align: inherit;">C'est peut-√™tre parce que le service est con√ßu pour les nerds durs travaillant exclusivement avec la console. </font><font style="vertical-align: inherit;">D'une mani√®re ou d'une autre, pour ex√©cuter Kafka, nous avons besoin d'une ligne de commande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez d'abord d√©marrer ZooKeeper. </font><font style="vertical-align: inherit;">Dans le dossier avec le kafka, nous trouvons le dossier bin / windows, dans celui-ci, nous trouvons le fichier pour d√©marrer le service zookeeper-server-start.bat, cliquez dessus. </font><font style="vertical-align: inherit;">Rien ne se passe? </font><font style="vertical-align: inherit;">Il devrait en √™tre ainsi. </font><font style="vertical-align: inherit;">Ouvrez la console dans ce dossier et √©crivez:</font></font><br>
<br>
<pre><code class="cs hljs"> start zookeeper-server-start.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 √áa ne marche plus? </font><font style="vertical-align: inherit;">C‚Äôest la norme. </font><font style="vertical-align: inherit;">En effet, zookeeper-server-start.bat n√©cessite les param√®tres sp√©cifi√©s dans le fichier zookeeper.properties, qui, nous le rappelons, se trouve dans le dossier config pour son travail. </font><font style="vertical-align: inherit;">Nous √©crivons √† la console:</font></font><br>
<br>
<pre><code class="cs hljs">start zookeeper-server-start.bat c:\kafka\config\zookeeper.properties </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, tout devrait commencer normalement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wn/q1/hr/wnq1hrvtfit6o_mgsqkdkrzcjiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encore une fois, ouvrez la console dans ce dossier (ne fermez pas ZooKeeper!) Et ex√©cutez kafka:</font></font><br>
<br>
<pre><code class="cs hljs">start kafka-server-start.bat c:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de ne pas √©crire de commandes √† chaque fois sur la ligne de commande, vous pouvez utiliser l'ancienne m√©thode √©prouv√©e et cr√©er un fichier de commandes avec le contenu suivant:</font></font><br>
<br>
<pre><code class="cs hljs">start C:\kafka\bin\windows\zookeeper-server-start.bat C:\kafka\config\zookeeper.properties<font></font>
timeout <span class="hljs-number">10</span>
start C:\kafka\bin\windows\kafka-server-start.bat C:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La ligne de timeout 10 est n√©cessaire pour d√©finir une pause entre le d√©marrage de zookeeper et kafka. </font><font style="vertical-align: inherit;">Si vous avez tout fait correctement, lorsque vous cliquez sur le fichier de commandes, deux consoles devraient s'ouvrir avec zookeeper et kafka en cours d'ex√©cution. Nous pouvons maintenant cr√©er un producteur de messages et un consommateur avec les param√®tres n√©cessaires directement √† partir de la ligne de commande. </font><font style="vertical-align: inherit;">Mais, en pratique, il peut √™tre n√©cessaire, sauf pour tester le service. </font><font style="vertical-align: inherit;">Nous serons beaucoup plus int√©ress√©s par la fa√ßon de travailler avec kafka d'IDEA.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travailler avec Kafka d'IDEA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous √©crirons l'application la plus simple possible, qui sera √† la fois le producteur et le consommateur du message, puis lui ajouterons des fonctionnalit√©s utiles. </font><font style="vertical-align: inherit;">Cr√©ez un nouveau projet de printemps. </font><font style="vertical-align: inherit;">Cela est plus pratique √† l'aide d'un initialiseur √† ressort. </font><font style="vertical-align: inherit;">Ajoutez les d√©pendances org.springframework.kafka et spring-boot-starter-web </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n8/tv/vd/n8tvvda_h1eedp1j7iodblqnv3u.png"><br>
<br>
<img src="https://habrastorage.org/webt/so/kb/pw/sokbpw-hvkzn8ihnzsokhqn0-yo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, le fichier pom.xml devrait ressembler √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/oc/ub/gwocubssaaqvggzlya-mgdwso24.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour envoyer des messages, nous avons besoin de l'objet KafkaTemplate &lt;K, V&gt;. </font><font style="vertical-align: inherit;">Comme nous le voyons, l'objet est tap√©. </font><font style="vertical-align: inherit;">Le premier param√®tre est le type de cl√©, le second est le message lui-m√™me. </font><font style="vertical-align: inherit;">Pour l'instant, nous indiquerons les deux param√®tres sous forme de cha√Æne. </font><font style="vertical-align: inherit;">Nous allons cr√©er l'objet dans le contr√¥leur de classe. </font><font style="vertical-align: inherit;">D√©clarez KafkaTemplate et demandez √† Spring de l'initialiser en annotant</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autowired</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principe, notre producteur est pr√™t. Il ne reste plus qu'√† y appeler la m√©thode send (). Il existe plusieurs versions surcharg√©es de cette m√©thode. Nous utilisons dans notre projet une option avec 3 param√®tres - envoyer (sujet String, cl√© K, donn√©es V). √âtant donn√© que KafkaTemplate est tap√© par String, la cl√© et les donn√©es dans la m√©thode d'envoi seront une cha√Æne. Le premier param√®tre indique la rubrique, c'est-√†-dire la rubrique √† laquelle les messages seront envoy√©s et √† laquelle les consommateurs peuvent s'abonner pour les recevoir. Si le sujet sp√©cifi√© dans la m√©thode d'envoi n'existe pas, il sera cr√©√© automatiquement. Le texte complet de la classe ressemble √† ceci.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("msg")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgController</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;<font></font>
<font></font>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
        kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le contr√¥leur est mapp√© sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / msg, la cl√© et le message lui-m√™me sont transmis dans le corps de la demande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exp√©diteur du message est pr√™t, cr√©ez maintenant un √©couteur. </font><font style="vertical-align: inherit;">Le printemps vous permet √©galement de le faire sans trop d'effort. </font><font style="vertical-align: inherit;">Il suffit de cr√©er une m√©thode et de la marquer avec l'annotation @KafkaListener, dans les param√®tres dont vous ne pouvez sp√©cifier que le sujet √† √©couter. </font><font style="vertical-align: inherit;">Dans notre cas, cela ressemble √† ceci.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode elle-m√™me, marqu√©e d'annotations, peut sp√©cifier un param√®tre accept√©, qui a le type de message transmis par le producteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe dans laquelle le consommateur sera cr√©√© doit √™tre marqu√©e avec l'annotation @EnableKafka.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@EnableKafka</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleKafkaExampleApplication</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@KafkaListener(topics="msg")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">msgListener</span><span class="hljs-params">(String msg)</span></span>{<font></font>
        System.out.println(msg);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        SpringApplication.run(SimpleKafkaExampleApplication.class, args);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, dans le fichier de param√®tres application.property, vous devez sp√©cifier le param√®tre concierge groupe-id. </font><font style="vertical-align: inherit;">Si cela n'est pas fait, l'application ne d√©marre pas. </font><font style="vertical-align: inherit;">Le param√®tre est de type String et peut √™tre n'importe quoi.</font></font><br>
<br>
<pre><code class="cs hljs">spring.kafka.consumer.<span class="hljs-keyword">group</span>-id=app<span class="hljs-number">.1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre projet de kafka le plus simple est pr√™t. </font><font style="vertical-align: inherit;">Nous avons un exp√©diteur et un destinataire des messages. </font><font style="vertical-align: inherit;">Il ne reste plus qu'√† courir. </font><font style="vertical-align: inherit;">Tout d'abord, lancez ZooKeeper et Kafka en utilisant le fichier batch que nous avons √©crit pr√©c√©demment, puis lancez notre application. </font><font style="vertical-align: inherit;">Il est plus pratique d'envoyer une demande √† l'aide de Postman. </font><font style="vertical-align: inherit;">Dans le corps de la requ√™te, n'oubliez pas de sp√©cifier les param√®tres msgId et msg. </font></font><br>
<img src="https://habrastorage.org/webt/_o/og/jt/_oogjtlzajgbbnpsf8sjg8k0num.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous voyons une telle image dans IDEA, alors tout fonctionne: le producteur a envoy√© un message, le consommateur l'a re√ßu et l'affiche sur la console.</font></font><br>
<img src="https://habrastorage.org/webt/kg/zq/j3/kgzqj38qw5q67mmr0fa2ijucflw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous compliquons le projet</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les vrais projets utilisant Kafka sont certainement plus compliqu√©s que celui que nous avons cr√©√©. Maintenant que nous avons compris les fonctions de base du service, r√©fl√©chissez aux fonctionnalit√©s suppl√©mentaires qu'il offre. Pour commencer, nous am√©liorerons le producteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez ouvert la m√©thode send (), vous remarquerez peut-√™tre que toutes ses variantes ont une valeur de retour de ListenableFuture &lt;SendResult &lt;K, V &gt;&gt;. Maintenant, nous ne consid√©rerons pas en d√©tail les capacit√©s de cette interface. Ici, il suffira de dire qu'il est n√©cessaire de visualiser le r√©sultat de l'envoi d'un message.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@PostMapping</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
    ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    future.addCallback(System.out::println, System.err::println);<font></font>
    kafkaTemplate.flush();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode addCallback () accepte deux param√®tres - SuccessCallback et FailureCallback. </font><font style="vertical-align: inherit;">Les deux sont des interfaces fonctionnelles. </font><font style="vertical-align: inherit;">D'apr√®s le nom, vous pouvez comprendre que la m√©thode de la premi√®re sera appel√©e √† la suite de l'envoi r√©ussi du message, la seconde - √† la suite d'une erreur. Maintenant, si nous ex√©cutons le projet, nous verrons quelque chose comme ceci sur la console:</font></font><br>
<br>
<pre><code class="cs hljs">SendResult [producerRecord=ProducerRecord(topic=msg, partition=<span class="hljs-literal">null</span>, headers=RecordHeaders(headers = [], isReadOnly = <span class="hljs-literal">true</span>), key=<span class="hljs-number">1</span>, <span class="hljs-keyword">value</span>=Hello, world!, timestamp=<span class="hljs-literal">null</span>), recordMetadata=msg<span class="hljs-number">-0</span>@<span class="hljs-number">6</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons √† nouveau attentivement notre producteur. </font><font style="vertical-align: inherit;">Fait int√©ressant, que se passe-t-il si la cl√© n'est pas String, mais, disons, Long, mais comme le message transmis, pire encore - une sorte de DTO compliqu√©? </font><font style="vertical-align: inherit;">Tout d'abord, essayons de changer la cl√© en une valeur num√©rique ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/3m/81/hl3m81wnp81kngs_abmdx9wemlm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous sp√©cifions Long comme cl√© dans le producteur, l'application d√©marrera normalement, mais lorsque vous essayez d'envoyer un message, une ClassCastException sera lev√©e et il sera signal√© que la classe Long ne peut pas √™tre convertie en classe String.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/ti/tz/fetitzsqvkjsetoigt8lwodxcbk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous essayons de cr√©er manuellement l'objet KafkaTemplate, nous verrons que l'objet d'interface ProducerFactory &lt;K, V&gt;, par exemple DefaultKafkaProducerFactory &lt;&gt;, est transmis au constructeur en tant que param√®tre. Afin de cr√©er un DefaultKafkaProducerFactory, nous devons transmettre une carte contenant ses param√®tres de producteur √† son constructeur. Tout le code de configuration et de cr√©ation du producteur sera plac√© dans une classe distincte. Pour ce faire, cr√©ez le package de configuration et la classe KafkaProducerConfig.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                StringSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, String&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, String&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la m√©thode producteurConfigs (), cr√©ez une carte avec les configurations et sp√©cifiez LongSerializer.class comme s√©rialiseur pour la cl√©. </font><font style="vertical-align: inherit;">Nous commen√ßons, envoyons une demande √† Postman et constatons que maintenant tout fonctionne comme il se doit: le producteur envoie un message et le consommateur le re√ßoit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifions maintenant le type de la valeur transmise. </font><font style="vertical-align: inherit;">Et si nous n'avons pas de classe standard de la biblioth√®que Java, mais une sorte de DTO personnalis√©. </font><font style="vertical-align: inherit;">Disons ceci.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDto</span> </span>{
    <span class="hljs-keyword">private</span> Long age;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Address address;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> </span>{
    <span class="hljs-keyword">private</span> String country;
    <span class="hljs-keyword">private</span> String city;
    <span class="hljs-keyword">private</span> String street;
    <span class="hljs-keyword">private</span> Long homeNumber;
    <span class="hljs-keyword">private</span> Long flatNumber;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour envoyer DTO en tant que message, vous devez apporter quelques modifications √† la configuration du producteur. </font><font style="vertical-align: inherit;">Sp√©cifiez JsonSerializer.class comme s√©rialiseur de la valeur du message et n'oubliez pas de changer le type de cha√Æne en UserDto partout.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                JsonSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, UserDto&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, UserDto&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Envoyer un message. La ligne suivante sera affich√©e dans la console: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e8/2f/xu/e82fxufwzg_yai2rs5vx5athbts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous allons compliquer le consommateur. Avant cela, notre m√©thode public void msgListener (String msg), marqu√©e avec l'annotation @KafkaListener (topics = "msg") a pris String comme param√®tre et l'affichait sur la console. Et si nous voulons obtenir d'autres param√®tres du message transmis, par exemple une cl√© ou une partition? Dans ce cas, le type de la valeur transmise doit √™tre modifi√©.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderListener</span><span class="hljs-params">(ConsumerRecord&lt;Long, UserDto&gt; record)</span></span>{<font></font>
    System.out.println(record.partition());<font></font>
    System.out.println(record.key());<font></font>
    System.out.println(record.value());<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä partir de l'objet ConsumerRecord, nous pouvons obtenir tous les param√®tres qui nous int√©ressent. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/ml/pw/zqmlpw7o5xzb0fxxzq7rez5qjpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons qu'au lieu de la cl√© sur la console, une sorte d'escrocs sont affich√©s. Cela est d√ª au fait que StringDeserializer est utilis√© par d√©faut pour d√©s√©rialiser la cl√©, et si nous voulons que la cl√© au format entier s'affiche correctement, nous devons la changer en LongDeserializer. Pour configurer le consommateur dans le package de configuration, cr√©ez la classe KafkaConsumerConfig.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaConsumerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.bootstrap-servers}")</span>
    <span class="hljs-keyword">private</span> String kafkaServer;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.consumer.group-id}")</span>
    <span class="hljs-keyword">private</span> String kafkaGroupId;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">consumerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaServer);<font></font>
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, LongDeserializer.class);<font></font>
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);<font></font>
        props.put(ConsumerConfig.GROUP_ID_CONFIG, kafkaGroupId);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KafkaListenerContainerFactory&lt;?&gt; kafkaListenerContainerFactory() {<font></font>
        ConcurrentKafkaListenerContainerFactory&lt;Long, UserDto&gt; factory =<font></font>
                <span class="hljs-keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();<font></font>
        factory.setConsumerFactory(consumerFactory());<font></font>
        <span class="hljs-keyword">return</span> factory;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ConsumerFactory&lt;Long, UserDto&gt; <span class="hljs-title">consumerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(consumerConfigs());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe KafkaConsumerConfig est tr√®s similaire √† la KafkaProducerConfig que nous avons cr√©√©e pr√©c√©demment. Il existe √©galement une carte qui contient les configurations n√©cessaires, par exemple, comme un d√©s√©rialiseur pour la cl√© et la valeur. La carte cr√©√©e est utilis√©e pour cr√©er la ConsumerFactory &lt;&gt;, qui, √† son tour, est n√©cessaire pour cr√©er la KafkaListenerContainerFactory &lt;?&gt;. Un d√©tail important: la m√©thode renvoyant KafkaListenerContainerFactory &lt;?&gt; Doit √™tre appel√©e kafkaListenerContainerFactory (), sinon Spring ne pourra pas trouver le bean souhait√© et le projet ne compilera pas. Nous commen√ßons.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/mb/t9/6xmbt9zj5i6uzdx95a7ck4hjjxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons que maintenant la cl√© est affich√©e comme il se doit, ce qui signifie que tout fonctionne. </font><font style="vertical-align: inherit;">Bien s√ªr, les capacit√©s d'Apache Kafka vont bien au-del√† de celles d√©crites dans cet article, cependant, j'esp√®re qu'apr√®s l'avoir lu, vous aurez une id√©e de ce service et, surtout, vous pourrez commencer √† travailler avec lui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lavez-vous les mains plus souvent, portez des masques, ne sortez pas sans besoin et soyez en bonne sant√©.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496170/index.html">Nous sommes condamn√©s # 1 // Udalenka en crise et mort d'originalit√©</a></li>
<li><a href="../fr496174/index.html">Augmentation de la demande d'analyses, d'√©quipes de produits, d'Amazon, d'Isra√´l, de Singapour, du travail √† distance, etc. - beaucoup discut√©.</a></li>
<li><a href="../fr496176/index.html">Grande conf√©rence virtuelle: exp√©rience du monde r√©el dans la protection des donn√©es des entreprises num√©riques modernes</a></li>
<li><a href="../fr496178/index.html">Swift 5.2. Aper√ßu de toutes les modifications</a></li>
<li><a href="../fr496180/index.html">Prenez soin de l'ombre des jeunes</a></li>
<li><a href="../fr496184/index.html">Technologie d'affichage LED: Micro-LED vs Mini LED</a></li>
<li><a href="../fr496186/index.html">Algorithme de propagation de retour d'erreur utilisant Word2Vec comme exemple</a></li>
<li><a href="../fr496188/index.html">Comment arr√™ter la fr√©n√©sie de regarder des √©missions de t√©l√©vision et commencer √† vivre</a></li>
<li><a href="../fr496190/index.html">√Ä propos des verbes Phrasal-2</a></li>
<li><a href="../fr496192/index.html">Appeler les fonctions Rust depuis Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>