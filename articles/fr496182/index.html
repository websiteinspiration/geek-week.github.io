<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍👩‍👧‍👧 👴🏼 👨🏻‍🌾 Apache Kafka for Dummies 🕴🏽 🏰 👩‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article sera utile à ceux qui viennent de se familiariser avec l'architecture des microservices et le service Apache Kafka. Le matériel ne prétend...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Apache Kafka for Dummies</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496182/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cet article sera utile à ceux qui viennent de se familiariser avec l'architecture des microservices et le service Apache Kafka. </font><font style="vertical-align: inherit;">Le matériel ne prétend pas être un tutoriel détaillé, mais vous aidera à démarrer rapidement avec cette technologie. </font><font style="vertical-align: inherit;">Je vais vous expliquer comment installer et configurer Kafka sur Windows 10. Nous allons également créer un projet en utilisant Intellij IDEA et Spring Boot.</font></font><a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les difficultés à comprendre divers outils sont souvent associées au fait que le développeur n'a jamais rencontré de situations dans lesquelles ces outils peuvent être nécessaires. Avec Kafka, c'est exactement la même chose. Nous décrivons la situation dans laquelle cette technologie sera utile. Si vous avez une architecture d'application monolithique, vous n'avez bien sûr pas besoin de Kafka. Tout change avec le passage aux microservices. En fait, chaque microservice est un programme distinct qui remplit l'une ou l'autre fonction et qui peut être lancé indépendamment des autres microservices. Les microservices peuvent être comparés aux employés du bureau, qui sont assis à des bureaux séparés et résolvent indépendamment leur problème. Le travail d'une telle équipe répartie est impensable sans coordination centrale.Les employés devraient pouvoir échanger des messages et les résultats de leur travail. Apache Kafka pour microservices est conçu pour résoudre ce problème.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka est un courtier de messages. Avec lui, les microservices peuvent interagir les uns avec les autres, envoyant et recevant des informations importantes. La question se pose, pourquoi ne pas utiliser le POST-reqest régulier à ces fins, dans le corps duquel vous pouvez transférer les données nécessaires et obtenir la réponse de la même manière? Cette approche présente un certain nombre d'inconvénients évidents. Par exemple, un producteur (un service qui envoie un message) ne peut envoyer des données que sous la forme d'une réponse en réponse à une demande d'un consommateur (un service qui reçoit des données). Supposons qu'un consommateur envoie une demande POST et que le producteur y réponde. Pour le moment, pour une raison quelconque, le consommateur ne peut accepter la réponse. Qu'adviendra-t-il des données? Ils seront perdus. Le consommateur devra à nouveau envoyer une demande et espérer que les données qu'il souhaite recevoir n'ont pas changé pendant cette période,et le producteur est toujours prêt à accepter la demande.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apache Kafka résout ce problème et bien d'autres qui surviennent lors de l'échange de messages entre microservices. </font><font style="vertical-align: inherit;">Il ne sera pas inutile de rappeler que l'échange de données ininterrompu et pratique est l'un des problèmes clés qui doivent être résolus pour assurer le fonctionnement stable de l'architecture de microservice.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer et configurer ZooKeeper et Apache Kafka sur Windows 10</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première chose que vous devez savoir pour commencer est qu'Apache Kafka s'exécute en plus du service ZooKeeper. ZooKeeper est un service de configuration et de synchronisation distribué, et c'est tout ce que nous devons savoir à ce sujet dans ce contexte. Nous devons le télécharger, le configurer et l'exécuter avant de commencer avec Kafka. Avant de commencer à travailler avec ZooKeeper, assurez-vous que JRE est installé et configuré. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez télécharger la dernière version de ZooKeeper sur le site officiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous extrayons les fichiers de l'archive ZooKeeper téléchargée dans un dossier sur le disque. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le dossier zookeeper avec le numéro de version, nous trouvons le dossier conf et le fichier «zoo_sample.cfg».</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/ke/pz/hokepzidcuiupzigc3i3wtlxi6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copiez-le et changez le nom de la copie en «zoo.cfg». Ouvrez le fichier de copie et recherchez-y la ligne dataDir = / tmp / zookeeper. Dans cette ligne, nous écrivons le chemin complet de notre dossier zookeeper-x.x.x. Cela ressemble à ceci pour moi: dataDir = C: \\ ZooKeeper \\ zookeeper-3.6.0 </font></font><br>
<img src="https://habrastorage.org/webt/ri/sk/2h/risk2h-3u771fpod5vvxodydrhy.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous ajoutons la variable d'environnement système: ZOOKEEPER_HOME = C: \ ZooKeeper \ zookeeper-3.4.9 et à la fin de la variable système Path, ajoutez l'entrée:;% ZOOKEEPER_HOME % \ poubelle; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutez la ligne de commande et écrivez la commande:</font></font><br>
<br>
<pre><code class="cs hljs">zkserver</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Si tout est fait correctement, vous verrez quelque chose comme ce qui suit. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b-/rs/i6/b-rsi6uqc40e77tchqnimmhsgo8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que ZooKeeper a démarré normalement. Nous procédons directement à l'installation et à la configuration du serveur Apache Kafka. Téléchargez la dernière version sur le site officiel et extrayez le contenu de l'archive: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kafka.apache.org/downloads</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dans le dossier avec Kafka, nous trouvons le dossier config, nous y trouvons le fichier server.properties et l'ouvrons. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/o5/m0/pxo5m032s0lvvmjqbhmfaazfnog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous trouvons la ligne log.dirs = / tmp / kafka-logs et y indiquons le chemin où Kafka enregistrera les journaux: log.dirs = c: / kafka / kafka-logs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/bi/mg/ghbimgkxct-2ox1a8s8klpackco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même dossier, modifiez le fichier zookeeper.properties. Nous changeons la ligne dataDir = / tmp / zookeeper en dataDir = c: / kafka / zookeeper-data, sans oublier d'indiquer le chemin vers votre dossier Kafka après le nom du disque. Si vous avez tout fait correctement, vous pouvez exécuter ZooKeeper et Kafka.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/nd/mr/ydndmrfkovlk4z75mc99lbs3clk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour certains, il peut être désagréable de constater qu'il n'y a pas d'interface graphique pour contrôler Kafka. </font><font style="vertical-align: inherit;">C'est peut-être parce que le service est conçu pour les nerds durs travaillant exclusivement avec la console. </font><font style="vertical-align: inherit;">D'une manière ou d'une autre, pour exécuter Kafka, nous avons besoin d'une ligne de commande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez d'abord démarrer ZooKeeper. </font><font style="vertical-align: inherit;">Dans le dossier avec le kafka, nous trouvons le dossier bin / windows, dans celui-ci, nous trouvons le fichier pour démarrer le service zookeeper-server-start.bat, cliquez dessus. </font><font style="vertical-align: inherit;">Rien ne se passe? </font><font style="vertical-align: inherit;">Il devrait en être ainsi. </font><font style="vertical-align: inherit;">Ouvrez la console dans ce dossier et écrivez:</font></font><br>
<br>
<pre><code class="cs hljs"> start zookeeper-server-start.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Ça ne marche plus? </font><font style="vertical-align: inherit;">C’est la norme. </font><font style="vertical-align: inherit;">En effet, zookeeper-server-start.bat nécessite les paramètres spécifiés dans le fichier zookeeper.properties, qui, nous le rappelons, se trouve dans le dossier config pour son travail. </font><font style="vertical-align: inherit;">Nous écrivons à la console:</font></font><br>
<br>
<pre><code class="cs hljs">start zookeeper-server-start.bat c:\kafka\config\zookeeper.properties </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, tout devrait commencer normalement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wn/q1/hr/wnq1hrvtfit6o_mgsqkdkrzcjiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encore une fois, ouvrez la console dans ce dossier (ne fermez pas ZooKeeper!) Et exécutez kafka:</font></font><br>
<br>
<pre><code class="cs hljs">start kafka-server-start.bat c:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de ne pas écrire de commandes à chaque fois sur la ligne de commande, vous pouvez utiliser l'ancienne méthode éprouvée et créer un fichier de commandes avec le contenu suivant:</font></font><br>
<br>
<pre><code class="cs hljs">start C:\kafka\bin\windows\zookeeper-server-start.bat C:\kafka\config\zookeeper.properties<font></font>
timeout <span class="hljs-number">10</span>
start C:\kafka\bin\windows\kafka-server-start.bat C:\kafka\config\server.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La ligne de timeout 10 est nécessaire pour définir une pause entre le démarrage de zookeeper et kafka. </font><font style="vertical-align: inherit;">Si vous avez tout fait correctement, lorsque vous cliquez sur le fichier de commandes, deux consoles devraient s'ouvrir avec zookeeper et kafka en cours d'exécution. Nous pouvons maintenant créer un producteur de messages et un consommateur avec les paramètres nécessaires directement à partir de la ligne de commande. </font><font style="vertical-align: inherit;">Mais, en pratique, il peut être nécessaire, sauf pour tester le service. </font><font style="vertical-align: inherit;">Nous serons beaucoup plus intéressés par la façon de travailler avec kafka d'IDEA.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travailler avec Kafka d'IDEA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous écrirons l'application la plus simple possible, qui sera à la fois le producteur et le consommateur du message, puis lui ajouterons des fonctionnalités utiles. </font><font style="vertical-align: inherit;">Créez un nouveau projet de printemps. </font><font style="vertical-align: inherit;">Cela est plus pratique à l'aide d'un initialiseur à ressort. </font><font style="vertical-align: inherit;">Ajoutez les dépendances org.springframework.kafka et spring-boot-starter-web </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n8/tv/vd/n8tvvda_h1eedp1j7iodblqnv3u.png"><br>
<br>
<img src="https://habrastorage.org/webt/so/kb/pw/sokbpw-hvkzn8ihnzsokhqn0-yo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, le fichier pom.xml devrait ressembler à ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/oc/ub/gwocubssaaqvggzlya-mgdwso24.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour envoyer des messages, nous avons besoin de l'objet KafkaTemplate &lt;K, V&gt;. </font><font style="vertical-align: inherit;">Comme nous le voyons, l'objet est tapé. </font><font style="vertical-align: inherit;">Le premier paramètre est le type de clé, le second est le message lui-même. </font><font style="vertical-align: inherit;">Pour l'instant, nous indiquerons les deux paramètres sous forme de chaîne. </font><font style="vertical-align: inherit;">Nous allons créer l'objet dans le contrôleur de classe. </font><font style="vertical-align: inherit;">Déclarez KafkaTemplate et demandez à Spring de l'initialiser en annotant</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autowired</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principe, notre producteur est prêt. Il ne reste plus qu'à y appeler la méthode send (). Il existe plusieurs versions surchargées de cette méthode. Nous utilisons dans notre projet une option avec 3 paramètres - envoyer (sujet String, clé K, données V). Étant donné que KafkaTemplate est tapé par String, la clé et les données dans la méthode d'envoi seront une chaîne. Le premier paramètre indique la rubrique, c'est-à-dire la rubrique à laquelle les messages seront envoyés et à laquelle les consommateurs peuvent s'abonner pour les recevoir. Si le sujet spécifié dans la méthode d'envoi n'existe pas, il sera créé automatiquement. Le texte complet de la classe ressemble à ceci.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("msg")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MsgController</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;<font></font>
<font></font>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendOrder</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
        kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le contrôleur est mappé sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / msg, la clé et le message lui-même sont transmis dans le corps de la demande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'expéditeur du message est prêt, créez maintenant un écouteur. </font><font style="vertical-align: inherit;">Le printemps vous permet également de le faire sans trop d'effort. </font><font style="vertical-align: inherit;">Il suffit de créer une méthode et de la marquer avec l'annotation @KafkaListener, dans les paramètres dont vous ne pouvez spécifier que le sujet à écouter. </font><font style="vertical-align: inherit;">Dans notre cas, cela ressemble à ceci.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode elle-même, marquée d'annotations, peut spécifier un paramètre accepté, qui a le type de message transmis par le producteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe dans laquelle le consommateur sera créé doit être marquée avec l'annotation @EnableKafka.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@EnableKafka</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleKafkaExampleApplication</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@KafkaListener(topics="msg")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">msgListener</span><span class="hljs-params">(String msg)</span></span>{<font></font>
        System.out.println(msg);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<font></font>
        SpringApplication.run(SimpleKafkaExampleApplication.class, args);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, dans le fichier de paramètres application.property, vous devez spécifier le paramètre concierge groupe-id. </font><font style="vertical-align: inherit;">Si cela n'est pas fait, l'application ne démarre pas. </font><font style="vertical-align: inherit;">Le paramètre est de type String et peut être n'importe quoi.</font></font><br>
<br>
<pre><code class="cs hljs">spring.kafka.consumer.<span class="hljs-keyword">group</span>-id=app<span class="hljs-number">.1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre projet de kafka le plus simple est prêt. </font><font style="vertical-align: inherit;">Nous avons un expéditeur et un destinataire des messages. </font><font style="vertical-align: inherit;">Il ne reste plus qu'à courir. </font><font style="vertical-align: inherit;">Tout d'abord, lancez ZooKeeper et Kafka en utilisant le fichier batch que nous avons écrit précédemment, puis lancez notre application. </font><font style="vertical-align: inherit;">Il est plus pratique d'envoyer une demande à l'aide de Postman. </font><font style="vertical-align: inherit;">Dans le corps de la requête, n'oubliez pas de spécifier les paramètres msgId et msg. </font></font><br>
<img src="https://habrastorage.org/webt/_o/og/jt/_oogjtlzajgbbnpsf8sjg8k0num.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous voyons une telle image dans IDEA, alors tout fonctionne: le producteur a envoyé un message, le consommateur l'a reçu et l'affiche sur la console.</font></font><br>
<img src="https://habrastorage.org/webt/kg/zq/j3/kgzqj38qw5q67mmr0fa2ijucflw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous compliquons le projet</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les vrais projets utilisant Kafka sont certainement plus compliqués que celui que nous avons créé. Maintenant que nous avons compris les fonctions de base du service, réfléchissez aux fonctionnalités supplémentaires qu'il offre. Pour commencer, nous améliorerons le producteur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez ouvert la méthode send (), vous remarquerez peut-être que toutes ses variantes ont une valeur de retour de ListenableFuture &lt;SendResult &lt;K, V &gt;&gt;. Maintenant, nous ne considérerons pas en détail les capacités de cette interface. Ici, il suffira de dire qu'il est nécessaire de visualiser le résultat de l'envoi d'un message.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@PostMapping</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(String msgId, String msg)</span></span>{<font></font>
    ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(<span class="hljs-string">"msg"</span>, msgId, msg);<font></font>
    future.addCallback(System.out::println, System.err::println);<font></font>
    kafkaTemplate.flush();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode addCallback () accepte deux paramètres - SuccessCallback et FailureCallback. </font><font style="vertical-align: inherit;">Les deux sont des interfaces fonctionnelles. </font><font style="vertical-align: inherit;">D'après le nom, vous pouvez comprendre que la méthode de la première sera appelée à la suite de l'envoi réussi du message, la seconde - à la suite d'une erreur. Maintenant, si nous exécutons le projet, nous verrons quelque chose comme ceci sur la console:</font></font><br>
<br>
<pre><code class="cs hljs">SendResult [producerRecord=ProducerRecord(topic=msg, partition=<span class="hljs-literal">null</span>, headers=RecordHeaders(headers = [], isReadOnly = <span class="hljs-literal">true</span>), key=<span class="hljs-number">1</span>, <span class="hljs-keyword">value</span>=Hello, world!, timestamp=<span class="hljs-literal">null</span>), recordMetadata=msg<span class="hljs-number">-0</span>@<span class="hljs-number">6</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons à nouveau attentivement notre producteur. </font><font style="vertical-align: inherit;">Fait intéressant, que se passe-t-il si la clé n'est pas String, mais, disons, Long, mais comme le message transmis, pire encore - une sorte de DTO compliqué? </font><font style="vertical-align: inherit;">Tout d'abord, essayons de changer la clé en une valeur numérique ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/3m/81/hl3m81wnp81kngs_abmdx9wemlm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous spécifions Long comme clé dans le producteur, l'application démarrera normalement, mais lorsque vous essayez d'envoyer un message, une ClassCastException sera levée et il sera signalé que la classe Long ne peut pas être convertie en classe String.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/ti/tz/fetitzsqvkjsetoigt8lwodxcbk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous essayons de créer manuellement l'objet KafkaTemplate, nous verrons que l'objet d'interface ProducerFactory &lt;K, V&gt;, par exemple DefaultKafkaProducerFactory &lt;&gt;, est transmis au constructeur en tant que paramètre. Afin de créer un DefaultKafkaProducerFactory, nous devons transmettre une carte contenant ses paramètres de producteur à son constructeur. Tout le code de configuration et de création du producteur sera placé dans une classe distincte. Pour ce faire, créez le package de configuration et la classe KafkaProducerConfig.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                StringSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, String&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, String&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la méthode producteurConfigs (), créez une carte avec les configurations et spécifiez LongSerializer.class comme sérialiseur pour la clé. </font><font style="vertical-align: inherit;">Nous commençons, envoyons une demande à Postman et constatons que maintenant tout fonctionne comme il se doit: le producteur envoie un message et le consommateur le reçoit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifions maintenant le type de la valeur transmise. </font><font style="vertical-align: inherit;">Et si nous n'avons pas de classe standard de la bibliothèque Java, mais une sorte de DTO personnalisé. </font><font style="vertical-align: inherit;">Disons ceci.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDto</span> </span>{
    <span class="hljs-keyword">private</span> Long age;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Address address;<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> </span>{
    <span class="hljs-keyword">private</span> String country;
    <span class="hljs-keyword">private</span> String city;
    <span class="hljs-keyword">private</span> String street;
    <span class="hljs-keyword">private</span> Long homeNumber;
    <span class="hljs-keyword">private</span> Long flatNumber;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour envoyer DTO en tant que message, vous devez apporter quelques modifications à la configuration du producteur. </font><font style="vertical-align: inherit;">Spécifiez JsonSerializer.class comme sérialiseur de la valeur du message et n'oubliez pas de changer le type de chaîne en UserDto partout.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaProducerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> String kafkaServer=<span class="hljs-string">"localhost:9092"</span>;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">producerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<font></font>
                kafkaServer);<font></font>
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<font></font>
                LongSerializer.class);<font></font>
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<font></font>
                JsonSerializer.class);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ProducerFactory&lt;Long, UserDto&gt; <span class="hljs-title">producerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(producerConfigs());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaTemplate&lt;Long, UserDto&gt; <span class="hljs-title">kafkaTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Envoyer un message. La ligne suivante sera affichée dans la console: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e8/2f/xu/e82fxufwzg_yai2rs5vx5athbts.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous allons compliquer le consommateur. Avant cela, notre méthode public void msgListener (String msg), marquée avec l'annotation @KafkaListener (topics = "msg") a pris String comme paramètre et l'affichait sur la console. Et si nous voulons obtenir d'autres paramètres du message transmis, par exemple une clé ou une partition? Dans ce cas, le type de la valeur transmise doit être modifié.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@KafkaListener(topics="msg")</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderListener</span><span class="hljs-params">(ConsumerRecord&lt;Long, UserDto&gt; record)</span></span>{<font></font>
    System.out.println(record.partition());<font></font>
    System.out.println(record.key());<font></font>
    System.out.println(record.value());<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À partir de l'objet ConsumerRecord, nous pouvons obtenir tous les paramètres qui nous intéressent. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/ml/pw/zqmlpw7o5xzb0fxxzq7rez5qjpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons qu'au lieu de la clé sur la console, une sorte d'escrocs sont affichés. Cela est dû au fait que StringDeserializer est utilisé par défaut pour désérialiser la clé, et si nous voulons que la clé au format entier s'affiche correctement, nous devons la changer en LongDeserializer. Pour configurer le consommateur dans le package de configuration, créez la classe KafkaConsumerConfig.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaConsumerConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.bootstrap-servers}")</span>
    <span class="hljs-keyword">private</span> String kafkaServer;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.kafka.consumer.group-id}")</span>
    <span class="hljs-keyword">private</span> String kafkaGroupId;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">consumerConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaServer);<font></font>
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, LongDeserializer.class);<font></font>
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);<font></font>
        props.put(ConsumerConfig.GROUP_ID_CONFIG, kafkaGroupId);<font></font>
        <span class="hljs-keyword">return</span> props;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KafkaListenerContainerFactory&lt;?&gt; kafkaListenerContainerFactory() {<font></font>
        ConcurrentKafkaListenerContainerFactory&lt;Long, UserDto&gt; factory =<font></font>
                <span class="hljs-keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();<font></font>
        factory.setConsumerFactory(consumerFactory());<font></font>
        <span class="hljs-keyword">return</span> factory;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ConsumerFactory&lt;Long, UserDto&gt; <span class="hljs-title">consumerFactory</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(consumerConfigs());<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe KafkaConsumerConfig est très similaire à la KafkaProducerConfig que nous avons créée précédemment. Il existe également une carte qui contient les configurations nécessaires, par exemple, comme un désérialiseur pour la clé et la valeur. La carte créée est utilisée pour créer la ConsumerFactory &lt;&gt;, qui, à son tour, est nécessaire pour créer la KafkaListenerContainerFactory &lt;?&gt;. Un détail important: la méthode renvoyant KafkaListenerContainerFactory &lt;?&gt; Doit être appelée kafkaListenerContainerFactory (), sinon Spring ne pourra pas trouver le bean souhaité et le projet ne compilera pas. Nous commençons.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/mb/t9/6xmbt9zj5i6uzdx95a7ck4hjjxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons que maintenant la clé est affichée comme il se doit, ce qui signifie que tout fonctionne. </font><font style="vertical-align: inherit;">Bien sûr, les capacités d'Apache Kafka vont bien au-delà de celles décrites dans cet article, cependant, j'espère qu'après l'avoir lu, vous aurez une idée de ce service et, surtout, vous pourrez commencer à travailler avec lui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lavez-vous les mains plus souvent, portez des masques, ne sortez pas sans besoin et soyez en bonne santé.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496170/index.html">Nous sommes condamnés # 1 // Udalenka en crise et mort d'originalité</a></li>
<li><a href="../fr496174/index.html">Augmentation de la demande d'analyses, d'équipes de produits, d'Amazon, d'Israël, de Singapour, du travail à distance, etc. - beaucoup discuté.</a></li>
<li><a href="../fr496176/index.html">Grande conférence virtuelle: expérience du monde réel dans la protection des données des entreprises numériques modernes</a></li>
<li><a href="../fr496178/index.html">Swift 5.2. Aperçu de toutes les modifications</a></li>
<li><a href="../fr496180/index.html">Prenez soin de l'ombre des jeunes</a></li>
<li><a href="../fr496184/index.html">Technologie d'affichage LED: Micro-LED vs Mini LED</a></li>
<li><a href="../fr496186/index.html">Algorithme de propagation de retour d'erreur utilisant Word2Vec comme exemple</a></li>
<li><a href="../fr496188/index.html">Comment arrêter la frénésie de regarder des émissions de télévision et commencer à vivre</a></li>
<li><a href="../fr496190/index.html">À propos des verbes Phrasal-2</a></li>
<li><a href="../fr496192/index.html">Appeler les fonctions Rust depuis Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>