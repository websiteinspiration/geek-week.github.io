<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîÆ üï¥üèº üò≥ Trio - Programaci√≥n asincr√≥nica para personas üÜò üö¶ üë¥üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Python tiene una biblioteca Trio , una biblioteca de programaci√≥n asincr√≥nica. 
 Conocer a Trio ser√° principalmente interesante para quienes trabajan ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Trio - Programaci√≥n asincr√≥nica para personas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/barsgroup/blog/490872/"><img src="https://habrastorage.org/webt/m7/0o/ye/m70oyejwkcwdk32csx1mq2wprao.jpeg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python tiene una </font><font style="vertical-align: inherit;">biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , una biblioteca de programaci√≥n asincr√≥nica. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conocer a Trio ser√° principalmente interesante para quienes trabajan en Asyncio, porque es una buena alternativa que le permite resolver algunos de los problemas que Asyncio no puede manejar. </font><font style="vertical-align: inherit;">En esta revisi√≥n, consideraremos qu√© es Trio y qu√© caracter√≠sticas nos brinda.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para aquellos que reci√©n comienzan a trabajar en programaci√≥n asincr√≥nica, les propongo leer una peque√±a introducci√≥n sobre qu√© son la asincron√≠a y el sincronismo. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sincronismo y asincron√≠a </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la programaci√≥n sincr√≥nica,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todas las operaciones se realizan de forma secuencial, y puede comenzar una nueva tarea solo despu√©s de completar la anterior. </font><font style="vertical-align: inherit;">Sin embargo, uno de sus puntos de "dolor" es que si uno de los hilos ha estado trabajando en una tarea durante mucho tiempo, todo el programa puede congelarse. </font><font style="vertical-align: inherit;">Hay tareas que no requieren potencia inform√°tica, pero que requieren tiempo de procesador, que pueden usarse de manera m√°s racional al dar el control a otro subproceso. </font><font style="vertical-align: inherit;">En la programaci√≥n s√≠ncrona, no hay forma de pausar la tarea actual para completar lo siguiente en su espacio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPara qu√© sirve la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asincron√≠a?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Es necesario distinguir entre asincron√≠a verdadera y asincron√≠a de entrada-salida. En nuestro caso, estamos hablando de entrada-salida as√≠ncrona. A nivel mundial, para ahorrar tiempo y utilizar de manera m√°s eficiente las instalaciones de producci√≥n. Asynchrony le permite omitir las √°reas problem√°ticas de los hilos. En la entrada-salida as√≠ncrona, el hilo actual no esperar√° la ejecuci√≥n de alg√∫n evento externo, pero dar√° el control a otro hilo. Por lo tanto, de hecho, solo se ejecuta un hilo a la vez. El hilo que ha dado el control entra en la cola y espera a que el control regrese a √©l. Quiz√°s, para ese momento, ocurrir√° el evento externo esperado y ser√° posible continuar trabajando. Esto le permitir√° cambiar entre tareas para minimizar la p√©rdida de tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora podemos volver a lo que es</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La operaci√≥n de este </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucle de eventos de la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> biblioteca </font><font style="vertical-align: inherit;">( </font><b><font style="vertical-align: inherit;">bucle de</font></b><font style="vertical-align: inherit;"> eventos), que incluye la cola de tareas y el bucle en s√≠. El ciclo controla la ejecuci√≥n de tareas, es decir, extrae tareas de la cola y determina lo que le suceder√°. Por ejemplo, podr√≠a estar manejando tareas de E / S. Es decir, el bucle de eventos selecciona la tarea, registra y en el momento adecuado comienza su procesamiento. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las rutinas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son funciones especiales que devuelven el control de esta tarea al bucle de eventos, es decir, las devuelven a la cola. Es necesario que estas corutinas se lancen precisamente a trav√©s de una serie de eventos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n hay </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">futuros</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- objetos en los que se almacena el resultado actual de la ejecuci√≥n de una tarea. </font><font style="vertical-align: inherit;">Esto puede ser informaci√≥n de que la tarea a√∫n no se ha procesado o que el resultado ya se ha obtenido; </font><font style="vertical-align: inherit;">o puede haber una excepci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, la biblioteca Asyncio es bien conocida, sin embargo, tiene una serie de inconvenientes que Trio es capaz de cerrar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tr√≠o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n el autor de la biblioteca, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nathaniel Smith</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cuando desarroll√≥ Trio, trat√≥ de crear una herramienta ligera y f√°cil de usar para el desarrollador, que proporcionara la entrada / salida asincr√≥nica m√°s simple y el manejo de errores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una caracter√≠stica importante de Trio es la gesti√≥n de contexto as√≠ncrono, que Asyncio no tiene. </font><font style="vertical-align: inherit;">Para hacer esto, el autor cre√≥ en Trio la llamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"guarder√≠a"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(vivero): un √°rea de cancelaci√≥n que se responsabiliza de la atomicidad (continuidad) de un grupo de hilos. La idea clave es que si en el ‚Äúvivero‚Äù falla una de las corutinas, todos los flujos en el ‚Äúvivero‚Äù se completar√°n o cancelar√°n con √©xito. En cualquier caso, el resultado ser√° correcto. Y solo cuando se completan todas las rutinas, despu√©s de salir de la funci√≥n, el desarrollador mismo decide c√≥mo proceder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, "childs" le permite evitar la continuaci√≥n del procesamiento de errores, lo que puede llevar al hecho de que todo se "caer√°" o que la salida ser√° incorrecta.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es exactamente lo que puede pasar con Asyncio, porque en Asyncio el proceso no se detiene, a pesar de que ocurri√≥ un error. </font><font style="vertical-align: inherit;">Y en este caso, en primer lugar, el desarrollador no sabr√° qu√© sucedi√≥ exactamente en el momento del error y, en segundo lugar, el procesamiento continuar√°.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere el ejemplo m√°s simple de dos caracter√≠sticas en competencia: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncio</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
loop = asyncio.get_event_loop()<font></font>
bundle = asyncio.wait([<font></font>
    loop.create_task(foo1()),<font></font>
    loop.create_task(foo2()),<font></font>
])<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    loop.run_until_complete(bundle)<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    loop.close()</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tr√≠o</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:<font></font>
        nursery.start_soon(foo1)<font></font>
        nursery.start_soon(foo2)<font></font>
<font></font>
trio.run(root)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
en ambos casos el resultado ser√° el mismo:</font></font><br>
<br>
<pre><code class="python hljs">foo1: <font></font>
foo2: <font></font>
foo2: <font></font>
foo1: </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estructuralmente, el c√≥digo Asyncio y Trio en este ejemplo es similar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diferencia obvia es que Trio no requiere la finalizaci√≥n expl√≠cita del bucle de eventos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere un ejemplo un poco m√°s vivo. </font><font style="vertical-align: inherit;">Hagamos una llamada al servicio web para obtener una marca de tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para Asyncio usaremos adicionalmente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session, i))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS)<font></font>
        ]<font></font>
        <span class="hljs-keyword">await</span> asyncio.wait(tasks)<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para Trio usamos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preguntas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
            nursery.start_soon(foo, i)<font></font>
<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
trio.run(root)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ambos casos, obtenemos algo como</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">0</span> | <span class="hljs-number">1543837647522</span> (  <span class="hljs-number">0.11855053901672363</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543837647535</span> (  <span class="hljs-number">0.1389765739440918</span>)
<span class="hljs-number">3</span> | <span class="hljs-number">1543837647527</span> (  <span class="hljs-number">0.13904547691345215</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543837647557</span> (  <span class="hljs-number">0.1591191291809082</span>)
<span class="hljs-number">1</span> | <span class="hljs-number">1543837647607</span> (  <span class="hljs-number">0.2100353240966797</span>)<font></font>
  <span class="hljs-number">0.2102828025817871</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno. </font><font style="vertical-align: inherit;">Imagine que durante la ejecuci√≥n de una de las corutinas, ocurri√≥ un error </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para Asyncio.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-number">1</span> | <span class="hljs-number">1543839060815</span> (  <span class="hljs-number">0.10857725143432617</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839060844</span> (  <span class="hljs-number">0.10372781753540039</span>)
<span class="hljs-number">5</span> | <span class="hljs-number">1543839060843</span> (  <span class="hljs-number">0.10734415054321289</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543839060874</span> (  <span class="hljs-number">0.13985681533813477</span>)<font></font>
  <span class="hljs-number">0.15044045448303223</span><font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para trio</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-number">4</span> | <span class="hljs-number">1543839223372</span> (  <span class="hljs-number">0.13524699211120605</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839223379</span> (  <span class="hljs-number">0.13848185539245605</span>)<font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">28</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<font></font>
    trio.run(root)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">1337</span>, <span class="hljs-keyword">in</span> run
    <span class="hljs-keyword">raise</span> runner.main_task_outcome.error<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">23</span>, <span class="hljs-keyword">in</span> root<font></font>
    nursery.start_soon(foo, i)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">397</span>, <span class="hljs-keyword">in</span> __aexit__
    <span class="hljs-keyword">raise</span> combined_error_from_nursery<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">15</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se ve claramente que en Trio, inmediatamente despu√©s de la ocurrencia del error, el "√°rea de cancelaci√≥n" funcion√≥, y dos de las cuatro tareas que no conten√≠an errores se terminaron anormalmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Asyncio, todas las tareas se completaron, y solo entonces apareci√≥ el trackback. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el ejemplo dado, esto no es importante, pero imaginemos que las tareas de una forma u otra dependen unas de otras, y el conjunto de tareas debe tener la propiedad de atomicidad. En este caso, la respuesta oportuna a un error se vuelve mucho m√°s importante. Por supuesto, puede usar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">await asyncio.wait (tareas, return_when = FIRST_EXCEPTION)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero debe recordar completar correctamente las tareas abiertas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay otro ejemplo: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
suponga que las rutinas acceden simult√°neamente a varios servicios web similares, y la primera respuesta recibida es importante.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> FIRST_COMPLETED
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()
        <span class="hljs-keyword">return</span> content.get(<span class="hljs-string">"time"</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, MAX_CLIENTS + <span class="hljs-number">1</span>)<font></font>
        ]<font></font>
        done, pending = <span class="hljs-keyword">await</span> asyncio.wait(tasks, return_when=FIRST_COMPLETED)<font></font>
        print(done.pop().result())<font></font>
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> pending:<font></font>
            future.cancel()<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">except</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo es bastante simple. </font><font style="vertical-align: inherit;">El √∫nico requisito es recordar completar las tareas que no se han completado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Trio, hacer una maniobra similar es un poco m√°s dif√≠cil, pero es casi imposible dejar las "colas" invisibles de inmediato:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, send_channel, nursery</span>):</span>
    response = <span class="hljs-keyword">await</span> session.request(<span class="hljs-string">'GET'</span>, url=URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel:<font></font>
        send_channel.send_nowait(content.get(<span class="hljs-string">"time"</span>))<font></font>
    nursery.cancel_scope.cancel()<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    send_channel, receive_channel = trio.open_memory_channel(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel, receive_channel:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asks.Session() <span class="hljs-keyword">as</span> session:
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
                    nursery.start_soon(foo, session, send_channel.clone(), nursery)<font></font>
<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> receive_channel:<font></font>
            x = <span class="hljs-keyword">await</span> receive_channel.receive()<font></font>
            print(x)<font></font>
<font></font>
trio.run(root)</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nursery.cancel_scope.cancel ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la primera rutina que se completa llamar√° a una funci√≥n en el √°rea de deshacer que cancelar√° todas las dem√°s tareas, por lo que no hay necesidad de preocuparse por separado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es cierto que para transferir el resultado de la ejecuci√≥n de rutina a la funci√≥n que lo caus√≥, deber√° iniciar un canal de comunicaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esperemos que esta revisi√≥n comparativa haya proporcionado una comprensi√≥n de las caracter√≠sticas principales de Trio. </font><font style="vertical-align: inherit;">¬°Gracias a todos!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490850/index.html">Ayuda al compilador a ayudarte</a></li>
<li><a href="../es490852/index.html">En detalle sobre SpinLaunch: el secreto m√°s celosamente guardado en la industria espacial</a></li>
<li><a href="../es490854/index.html">Los robots de almac√©n que usan IA para clasificar art√≠culos est√°n listos para funcionar</a></li>
<li><a href="../es490856/index.html">Auto Dungeon Master</a></li>
<li><a href="../es490862/index.html">LetsEncrypt planea revocar sus certificados debido a un error de software</a></li>
<li><a href="../es490874/index.html">Implementaci√≥n deliberada de trabajo remoto: c√≥mo duplicar sus resultados sin contratar a nadie</a></li>
<li><a href="../es490876/index.html">¬øPor qu√© nos quemamos?</a></li>
<li><a href="../es490878/index.html">Ecuaciones diferenciales no lineales, discreci√≥n de espacio-tiempo y producto √©psilon.</a></li>
<li><a href="../es490882/index.html">Solucione problemas en Docker. Parecer√≠a, ¬øqu√© tiene que ver GIT con eso?</a></li>
<li><a href="../es490884/index.html">Conferencia 27 de DEFCON. Tu auto es mi auto. Parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>