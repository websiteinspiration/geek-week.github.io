<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜï ü•ó üçá –í—ã–∑–æ–≤ —Ä–∞–∑–¥–µ–ª—è–µ–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏–∑ Similink ü¶ï üë®üèΩ‚Äçüé§ üåπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=", !
 , Simulink. ? , -, ¬´ Simulink? DLL?¬ª - .
 Simulink. 
 
 , .
 
 
 , Simulink.
 , Simulink exlib. exlib.c exlib.h. , :
 void exlib_init(void) ‚Äì .
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>–í—ã–∑–æ–≤ —Ä–∞–∑–¥–µ–ª—è–µ–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏–∑ Similink</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503908/">, !<br>
       ,       Simulink.     ?   ,        -,          ¬´      Simulink?       DLL?¬ª -     .<br>
          Simulink. <br>
<br>
         ,     .<br>
<br>
<a name="habracut"></a><br>
   ,         Simulink.<br>
,     Simulink  exlib.      <i>exlib.c</i>  <i>exlib.h</i>.    ,   :<br>
<b>void exlib_init(void)</b> ‚Äì    .<br>
<b>void exlib_print(float data)</b> ‚Äì    .<br>
<b>void exlib_term(void)</b> ‚Äì  .<br>
<br>
<h2> </h2><br>
   .<br>
   ,          .         3,   ,         .dll ( .so  Linux)     (.h)   .  Windows    .lib,      ,     .       .<br>
,    MATLAB mex,           (exlib.dll  Windows  exlib.so  Linux).  ,     <br>
<pre><code class="matlab hljs">mex -setup
</code></pre><br>
<br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a>.<br>
  mex   :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">   </b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">mingw = strfind(mex.getCompilerConfigurations(<span class="hljs-string">'C'</span>,<span class="hljs-string">'Selected'</span>).Name,<span class="hljs-string">'MinGW64 Compiler'</span>);
<span class="hljs-keyword">if</span> isunix
    <span class="hljs-comment">% GCC</span>
    mex(<span class="hljs-string">'LDEXT=.so'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">elseif</span> mingw
    <span class="hljs-comment">% MinGW builds static shared library, so dll and lib files are the same</span>
    <span class="hljs-comment">% loadlibrary uses the dll file, while legacy code tool looks for the lib file</span>
    mex(<span class="hljs-string">'LDEXT=.lib'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">else</span>
    <span class="hljs-comment">% Visual</span>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'CMDLINE300="del exlib.exp exlib.dll.manifest"'</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.
MEX completed successfully.</code></pre><br>
</div>
                    </div><br>
<br>
<h2>  </h2><br>
     ,          MATLAB:<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">   </b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-comment">% Load the library</span>
[~,~] = loadlibrary([<span class="hljs-string">'exlib'</span>,system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>)],<span class="hljs-string">'exlib.h'</span>);
<span class="hljs-comment">% Display functions available in the library</span>
libfunctionsview(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Initialize</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_init'</span>);
<span class="hljs-comment">% Step</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">i</span> = <span class="hljs-number">1</span>:<span class="hljs-number">10</span>
    calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_print'</span>,single(<span class="hljs-built_in">i</span>));
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Terminate</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-comment">% Unload the library</span>
unloadlibrary(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Show contents of generated file</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span>
</code></pre><br>
</div>
                    </div><br>
,   ,   ,    Simulink!<br>
<br>
<h2>     S-</h2><br>
S-   C-  Simulink.         C,        . ,      ,   Simulink     .     S-.  Simulink      S-.      S-  Simulink.<br>
<br>
<h3> Legacy Code Tool</h3><br>
    <b>Legacy Code Tool</b>, ,     S-  ,    MATLAB.    S-     ( Windows     * .lib)     .     .<br>
,     Legacy Code Tool<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    Legacy Code Tool</b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">specs = legacy_code(<span class="hljs-string">'initialize'</span>);
<span class="hljs-comment">% Prototype for the initialization function</span>
specs.StartFcnSpec = <span class="hljs-string">'exlib_init()'</span>;
<span class="hljs-comment">% Prototype for the step function</span>
specs.OutputFcnSpec = <span class="hljs-string">'exlib_print(single u1)'</span>;
<span class="hljs-comment">% Prototype for the terminate function</span>
specs.TerminateFcnSpec = <span class="hljs-string">'exlib_term()'</span>;
<span class="hljs-comment">% Shared library to link with (.so on Linux and .dll on Windows)</span>
specs.HostLibFiles = {[<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]};
<span class="hljs-comment">% We must supply header file when linking with shared library, otherwise</span>
<span class="hljs-comment">% compiler might make wrong assumptions about function's prototype.</span>
specs.HeaderFiles = {<span class="hljs-string">'exlib.h'</span>};
specs.SFunctionName = <span class="hljs-string">'sfun_exlib'</span>;
</code></pre><br>
</div>
                    </div><br>
<br>
 S-,    :<br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'generate_for_sim'</span>,specs);
### Start Compiling sfun_exlib
    mex(<span class="hljs-string">'sfun_exlib.c'</span>, <span class="hljs-string">'-I/tmp/simulink_shrlib_fex'</span>, <span class="hljs-string">'/tmp/simulink_shrlib_fex/exlib.so'</span>)
Building with <span class="hljs-string">'gcc'</span>.
MEX completed successfully.
### Finish Compiling sfun_exlib
### Exit
</code></pre><br>
<br>
,   Simulink:<br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'slblock_generate'</span>,specs);
</code></pre><br>
<br>
 :<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test'</span>);
snapnow;
sim(<span class="hljs-string">'simlib_test'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3> S- </h3><br>
       S-          .       ,      .      S-,    Legacy Code Tool.      <i>mdlStart</i>, <i>mdlOutputs</i>  <i>mdlTerminate</i>.<br>
      :<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> </b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlStart</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Load the dynamic library
   */</span>

  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_init_ptr)(<span class="hljs-keyword">void</span>);
    dllHandle = dlopen(<span class="hljs-string">"./exlib.so"</span>,RTLD_LAZY);
    exlib_init_ptr = dlsym(dllHandle, <span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_init_type exlib_init_ptr = <span class="hljs-literal">NULL</span>;
    dllHandle = LoadLibrary(<span class="hljs-string">"exlib.dll"</span>);
    exlib_init_ptr = (exlib_init_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

  exlib_init_ptr();
}
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlOutputs</span><span class="hljs-params">(SimStruct *S, int_T tid)</span>
</span>{
  real32_T *u1 = <span class="hljs-number">0</span>;

  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_print_ptr)(<span class="hljs-keyword">float</span>);
    exlib_print_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_print_type exlib_print_ptr = <span class="hljs-literal">NULL</span>;
    exlib_print_ptr = (exlib_print_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

  <span class="hljs-comment">/*
   * Get access to Parameter/Input/Output/DWork/size information
   */</span>
  u1 = (real32_T *) ssGetInputPortSignal(S, <span class="hljs-number">0</span>);

  <span class="hljs-comment">/*
   * Call the function from library
   */</span>
  exlib_print_ptr( *u1);
}
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlTerminate</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Unload the dynamic library
   */</span>

  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_term_ptr)(<span class="hljs-keyword">void</span>);
    exlib_term_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_term"</span>);
    exlib_term_ptr();
    dlclose(dllHandle);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_term_type exlib_term_ptr = <span class="hljs-literal">NULL</span>;
    exlib_term_ptr = (exlib_term_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_term"</span>);
    exlib_term_ptr();
    FreeLibrary(dllHandle);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
}
</code></pre><br>
</div>
                    </div><br>
<br>
  S-:<br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>,<span class="hljs-string">'-ldl'</span>);
<span class="hljs-keyword">else</span>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.
MEX completed successfully.</code></pre><br>
<br>
  :<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_dyn'</span>);
sim(<span class="hljs-string">'simlib_test_dyn'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3> S-Function Builder</h3><br>
       <b>S-Function Builder</b>.   ,        Legacy Code Tool    S-    . S-Function Builder   ,      S-,  S-  .<br>
  S-Function Builder       .          S-.    C function,     R2020   .<br>
<br>
<h2>     MATLAB Function </h2><br>
 <b>MATLAB Function</b>    MATLAB      Simulink.<br>
      MATLAB   <i>coder.ceval</i>,       MATLAB Function (  MATLAB).   coder.ceval    MATLAB Coder.<br>
   MATLAB Function,   :<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> </b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fcn</span><span class="hljs-params">(u)</span></span>
<span class="hljs-comment">%#codegen</span>

<span class="hljs-comment">% Keep track of initialization and runtime count</span>
<span class="hljs-keyword">persistent</span> runTimeCnt

<span class="hljs-comment">% Generate library path on the fly (current directory in this case)</span>
coder.extrinsic(<span class="hljs-string">'pwd'</span>,<span class="hljs-string">'system_dependent'</span>);
libpath = coder.const(pwd);
<span class="hljs-comment">% Shared library to link with</span>
libname = coder.const([<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]);
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);
coder.cinclude(<span class="hljs-string">'exlib.h'</span>);

<span class="hljs-keyword">if</span> <span class="hljs-built_in">isempty</span>(runTimeCnt)
    <span class="hljs-comment">% Initialize</span>
    coder.ceval(<span class="hljs-string">'exlib_init'</span>);
    runTimeCnt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Step</span>
coder.ceval(<span class="hljs-string">'exlib_print'</span>,single(u));
runTimeCnt = runTimeCnt+<span class="hljs-number">1</span>;
<span class="hljs-comment">% Terminate on the 10th step</span>
<span class="hljs-keyword">if</span> (runTimeCnt == <span class="hljs-number">11</span>)
    coder.ceval(<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-keyword">end</span>
</code></pre><br>
</div>
                    </div><br>
<br>
     ‚Äì          (    MATLAB System).<br>
     ,  exlib_term ();      <b><i>Simulation Target -&gt; Custom Code -&gt; Terminate function</i></b>.<br>
<br>
<i><b></b>.       ¬´Import custom code¬ª,         ¬´Simulation Target¬ª (  <b>coder.cinclude</b>  <b>coder.updateBuildInfo</b>).     ,      Simulation Target, coder.cinclude  coder.updateBuildInfo.<br>
</i><br>
<br>
  ‚Äî  ,  <i>coder.cinclude</i>  <i>coder.updateBuildInfo</i>,   <i>exlib_term()</i>  ,     .<br>
 :<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mlf'</span>);
sim(<span class="hljs-string">'simlib_test_mlf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2>    Stateflow </h2><br>
        <b>Stateflow</b>,        Stateflow.   Stateflow  ,  ,   .<br>
    Stateflow   ‚Äì       Stateflow:<br>
<img src="https://habrastorage.org/webt/_f/3m/z7/_f3mz7djr11eebq8egiisjpk9ru.png"><br>
<br>
,    ,  Stateflow ,     .   <b><i>Simulation Target -&gt; Custom Code -&gt; Libraries</i></b>   <i>exlib.lib ( exlib.so  Linux)</i>.  <b><i>Simulation Target -&gt; Custom Code -&gt; Header File</i></b>   <i>#include ¬´exlib.h¬ª</i>.        .  <b><i>Simulation Target -&gt; Custom Code -&gt; Terminate function</i></b>   <i>exlib_term() ;</i>.<br>
 :<br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix
    set_param(<span class="hljs-string">'simlib_test_sf'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_sf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
 ,         Stateflow,  <b>  C</b>.   ,   Stateflow  <b>  MATLAB</b>,    <i>coder.ceval</i>,    MATLAB Function.<br>
<br>
<h2>      MATLAB System </h2> <br>
<b> MATLAB System</b>      Simulink.          .<br>
     Simulink   R2013b.     ,       ,    .        MATLAB    ‚Äî ,  -      ‚Äî        C.<br>
    ,    MATLAB System:<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">  </b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-keyword">classdef</span> exlib &lt; matlab.System
    <span class="hljs-comment">% Call exlib shared library</span>
    <span class="hljs-comment">%</span>
    <span class="hljs-comment">% This example shows how to call shared library from Simulink using</span>
    <span class="hljs-comment">% MATLAB System block.</span>
    <span class="hljs-keyword">properties</span> (Nontunable,Access=private)
        libName = exlib.getLibName;
        libPath = pwd;
        libHeader = <span class="hljs-string">'exlib.h'</span>;
    <span class="hljs-keyword">end</span>
    
    <span class="hljs-keyword">methods</span> (Static)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">libName</span> = <span class="hljs-title">getLibName</span></span>
            <span class="hljs-keyword">if</span> isunix
                libName = <span class="hljs-string">'exlib.so'</span>;
            <span class="hljs-keyword">else</span>
                libName = <span class="hljs-string">'exlib.lib'</span>;
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    
    <span class="hljs-keyword">methods</span> (Access=protected)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupImpl</span><span class="hljs-params">(obj, ~)</span></span>
            <span class="hljs-comment">% Initialize.</span>
            coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,obj.libName,obj.libPath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);
            coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,obj.libPath);
            coder.cinclude(obj.libHeader);
            coder.ceval(<span class="hljs-string">'exlib_init'</span>);
        <span class="hljs-keyword">end</span>
        
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stepImpl</span><span class="hljs-params">(~, u)</span></span>
            <span class="hljs-comment">% Step.</span>
            coder.ceval(<span class="hljs-string">'exlib_print'</span>,u);
        <span class="hljs-keyword">end</span>
        
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">releaseImpl</span><span class="hljs-params">(~)</span></span>
            <span class="hljs-comment">% Terminate.</span>
            coder.ceval(<span class="hljs-string">'exlib_term'</span>);
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><br>
</div>
                    </div><br>
<br>
 :<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mls'</span>);
sim(<span class="hljs-string">'simlib_test_mls'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2>      C Caller </h2> <br>
 <b>C Caller</b>    C   Simulink.          .<br>
   ,     MATLAB R2018b.    ‚Äî   Simulink      C  .     ,          .<br>
 ,  <i>exlib.so/exlib.lib</i>    <b><i>Simulation Target -&gt; Libraries </i></b>  <i>#include ¬´exlib.h¬ª</i>  <b><i>Simulation Target -&gt; Header</i></b>   ,    ¬´Refresh custom code¬ª   C Caller,    ,   .<br>
   <i>exlib_print</i>,     :<br>
<img src="https://habrastorage.org/webt/4s/sz/bd/4sszbddxgbpffb3urxzbw2dv-ua.png"><br>
 ,     <i>exlib_init</i>  <i>exlib_term</i>,  Simulation Target.       C Caller       .   C Caller     Initialize Function  Terminate Function.        Stateflow: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">Schedule Subsystems to Execute at Specific Times</a><br>
 :<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-keyword">if</span> isunix
    set_param(<span class="hljs-string">'simlib_test_ccaller'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2>      C Function</h2> <br>
       Simulink  <b> C Function</b>.    R2020a.<br>
   C Caller     ,    - C    ( ,    S-Function Builder). ,  ,     C Function       C,         C,      . ,          .<br>
   <i>exlib.so/exlib.lib</i>   <b><i>¬´Simulation Target -&gt; Libraries¬ª</i></b>  <i>#include ¬´exlib.h¬ª</i>   <b><i>¬´Simulation Target -&gt; Header file¬ª</i></b>   .<br>
     C Function          single    ,   :<br>
<img src="https://habrastorage.org/webt/pm/ek/uz/pmekuz8kkzafgxf8ky1v8coqqla.png"><br>
<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-keyword">if</span> isunix
    set_param(<span class="hljs-string">'simlib_test_cfunction'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2>      Embedded Coder </h2><br>
    Embedded Coder    C-   Simulink       .     ,  ,           ,   C.<br>
 ,            C      Simulink,    S- Simulink Coder     <i>¬´--¬ª (Software-in-the-Loop)</i>. ,     Embedded Coder  ,    ,           ,          .<br>
   ,  Embedded Coder,        ,     .   ,       :<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ert'</span>);
snapnow;
</code></pre><br>
<img src="https://habrastorage.org/webt/wt/vo/wu/wtvowu3jc24ttsqd1qfgok9jxpc.png"><br>
<br>
      .dll (.so  Linux),  .lib (   .dll)   .exp (     .dll).<br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix
    set_param(<span class="hljs-string">'simlib_test_ert'</span>,<span class="hljs-string">'CustomHeaderCode'</span>,<span class="hljs-string">'#include &lt;stddef.h&gt;'</span>);
<span class="hljs-keyword">end</span>
rtwbuild(<span class="hljs-string">'simlib_test_ert'</span>);
### Starting build procedure <span class="hljs-keyword">for</span>: simlib_test_ert
### Successful completion of build procedure <span class="hljs-keyword">for</span>: simlib_test_ert</code></pre><br>
<br>
     :<br>
<pre><code class="cpp hljs"><span class="hljs-function">ex_init
<span class="hljs-keyword">double</span> <span class="hljs-title">ex_step</span><span class="hljs-params">(<span class="hljs-keyword">double</span>, <span class="hljs-keyword">double</span>)</span>
simlib_test_ert_terminate</span></code></pre><br>
<br>
        ,   ,        .      ,     (       ).          <i>Out1 = ex_step (In1, In2)</i>.<br>
          . ,   MATLAB Function (     ):<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> </b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">y</span> = <span class="hljs-title">fcn</span><span class="hljs-params">(u1, u2)</span></span>
<span class="hljs-comment">%#codegen</span>

<span class="hljs-comment">% Generate library path on the fly</span>
coder.extrinsic(<span class="hljs-string">'RTW.getBuildDir'</span>,<span class="hljs-string">'fullfile'</span>);
buildDir = coder.const(RTW.getBuildDir(<span class="hljs-string">'simlib_test_ert'</span>));
libpath = coder.const(buildDir.CodeGenFolder);
incpath = coder.const(fullfile(buildDir.BuildDirectory,<span class="hljs-string">'simlib_test_ert.h'</span>));
<span class="hljs-comment">% Shared library to link with</span>
<span class="hljs-keyword">if</span> isunix
    ext = <span class="hljs-string">'.so'</span>;
    libname = [<span class="hljs-string">'simlib_test_ert'</span>,ext];
<span class="hljs-keyword">else</span>
    ext = <span class="hljs-string">'.lib'</span>;
    libname = [<span class="hljs-string">'simlib_test_ert_'</span>,computer(<span class="hljs-string">'arch'</span>),ext];
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);
coder.cinclude(incpath);

<span class="hljs-comment">% Initialize output</span>
y = <span class="hljs-number">0</span>;
<span class="hljs-comment">% Step</span>
y = coder.ceval(<span class="hljs-string">'ex_step'</span>,u1,u2);</code></pre><br>
</div>
                    </div><br>
<br>
      :<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_callert'</span>);
sim(<span class="hljs-string">'simlib_test_callert'</span>);
snapnow;
</code></pre><br>
<img src="https://habrastorage.org/webt/ga/qw/vt/gaqwvt2gg4g87wrtxufr78pezxa.png"><br>
<br>
<h2></h2><br>
            Simulink.    ,    .       ,        ,   .<br>
 <b>Legacy Code Tool</b>          ,            ,      . <br>
<b> MATLAB System</b> ‚Äî    ,    :<br>
<ul>
<li>    ,   ,        ,     <br>
</li>
<li>       <br>
</li>
<li>    MATLAB     MATLAB<br>
</li>
<li> MATLAB System           (,    S-)<br>
</li>
</ul><br>
   MATLAB Function  ,            .  , Legacy Code Tool  S- -      .<br>
  S-          .       ,  <i>LoadLibrary/dlopen</i>, <i>GetProcAddress/dlsym</i>, <i>FreeLibrary/dlclose</i>,     .<br>
<b> C Caller</b>,   R2018b, ,      C,     .         <b>C Function</b>,      R2020a.<br>
<br>
     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar503894/index.html">ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿπŸÜ ÿßŸÑÿßÿ¨ÿ™ŸÖÿßÿπ ÿπÿ®ÿ± ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ NskTechTalks # 12: ÿ£ŸäŸÜ ŸäŸÖŸÉŸÜ ÿ£ŸÜ ŸäŸÜŸÖŸà ŸÖÿ∑Ÿàÿ± ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ŸÖÿßŸÖŸäÿ© ŸàŸÖÿßÿ∞ÿß ŸÑŸà ŸÑŸÖ Ÿäÿ£ÿ™ ÿ¥Ÿäÿ° ŸÖŸÜŸáÿü</a></li>
<li><a href="../ar503898/index.html">ŸäŸàŸÖ Ÿàÿßÿ≠ÿØ ÿ£ŸÖÿßŸÖŸä ÿ®ÿπŸäÿØ</a></li>
<li><a href="../ar503902/index.html">ŸÉŸäŸÅŸäÿ© ÿ¨ÿπŸÑ ÿßŸÑÿ¨Ÿäÿ±ÿßŸÜ ŸäÿπŸÖŸÑŸàŸÜ ÿπŸÑŸâ ŸÖÿ¥ÿ±ŸàÿπŸáŸÖ ÿå ÿ£Ÿà InnerSource ŸÑÿ£ÿ≠ÿØ ÿßŸÑÿ®ŸÜŸàŸÉ</a></li>
<li><a href="../ar503904/index.html">ÿßŸÑÿπÿßŸÑŸÖ ŸàÿßŸÑÿπŸàÿßŸÑŸÖ ÿå ÿ£Ÿà ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ ŸÑŸÑÿ•ŸÜÿ≥ÿßŸÜŸäÿßÿ™</a></li>
<li><a href="../ar503906/index.html">LabVIEW NXG - ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®ÿ≥Ÿäÿ∑ÿ© ŸàŸÜŸàÿπ ÿßŸÑÿ•ŸÉÿ±ÿßŸá</a></li>
<li><a href="../ar503910/index.html">ÿ™ÿ¨ÿßÿ±ÿ® ÿπŸÑŸâ ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ ÿßŸÑÿ∞ŸäŸÜ ÿ∞Ÿáÿ®Ÿàÿß ÿ•ŸÑŸâ "udalenka"</a></li>
<li><a href="../ar503916/index.html">ÿ™ÿπŸÑŸÖ ÿßŸÑÿ™ÿØÿßŸàŸÑ ŸÅŸä ÿßŸÑÿ®Ÿàÿ±ÿµÿ©. ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ£ŸàŸÑ: ÿ•ÿπÿØÿßÿØ ÿ®Ÿäÿ¶ÿ© ÿßÿÆÿ™ÿ®ÿßÿ±</a></li>
<li><a href="../ar503918/index.html">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≠ÿ≤ŸÖ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿàÿ≠ÿØÿßÿ™ Go: ÿØŸÑŸäŸÑ ÿπŸÖŸÑŸä</a></li>
<li><a href="../ar503920/index.html">ŸÉŸäŸÅ ŸÜÿÆÿ™ÿ®ÿ± ÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ ÿπŸÑŸâ STM32: ÿ™ÿ¨ÿ±ÿ®ÿ© ŸÖÿ∑Ÿàÿ±Ÿä ÿ£ÿ¨Ÿáÿ≤ÿ© Yandex</a></li>
<li><a href="../ar503922/index.html">ŸÑŸÖÿßÿ∞ÿß ŸäŸÇÿ∂Ÿä ÿßŸÑÿßÿ™ÿ≠ÿßÿØ ÿßŸÑÿ£Ÿàÿ±Ÿàÿ®Ÿä ÿπŸÑŸâ ÿ¨ÿØÿ±ÿßŸÜ ŸÖŸÑŸÅÿßÿ™ ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑÿßÿ±ÿ™ÿ®ÿßÿ∑</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>