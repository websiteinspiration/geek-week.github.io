<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧜🏿 🤶🏼 🌎 How to transfer a shader from a game engine to Substance Painter 👨🏼‍💼 👨🏻‍🚀 🧚🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My name is Taras Uleisky, I am a Technical Artist at Plarium Kharkiv. To optimize the graphics of our Survival RPG on mobile devices, we used our cust...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to transfer a shader from a game engine to Substance Painter</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/plarium/blog/501982/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My name is Taras Uleisky, I am a Technical Artist at Plarium Kharkiv. </font><font style="vertical-align: inherit;">To optimize the graphics of our Survival RPG on mobile devices, we used our custom shaders. </font><font style="vertical-align: inherit;">They involve the use of unique textures and maps that are not similar to textures and maps in other popular shading methods. </font><font style="vertical-align: inherit;">As a result, it’s not entirely clear to 3D artists how to create these textures for assets in the game. </font><font style="vertical-align: inherit;">To immediately see how the 3D model will look in the game engine at the texturing stage, I moved the shader to Substance Painter. </font><font style="vertical-align: inherit;">There are practically no API materials in Substance Painter at the moment, I studied this topic myself, so I decided to share my own ideas.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tt/hi/z2/tthiz2dpzs2v-tdmzga9nskoeao.png"><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unity shader</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The game uses matcap shading. In addition to the usual diff texture, two pre-created Matcap textures are also transferred to the shader. They are interpolated and blurred using two masks, respectively. As a result, the Matcap texture is multiplied by diffuse and fake glare and reflections can be seen on the material. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wd/mt/fr/wdmtfrjwwe6gach03sv2-u31cya.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The example below shows how Matcap is implemented in a shader graph. In this case, two Matcap textures are packed into one and divided into channels. That is, metal and non-metal in the channels R and G, respectively. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/tn/x1/gttnx1bhczfa3fuqiwmgrqegdvk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two Matcaps are interpolated for an example by checker. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oj/go/ro/ojgorowglvxcnfsbqns551jwz3e.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result is a certain analogy with metal and non-metal as in PBR shading. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We wanted to add roughness and dirt to the materials, to create some kind of roughness analog in PBR shading. To do this, we used the texturing method.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mip-mapping</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A sequence of textures creates the so-called MIP pyramid with a resolution of maximum to 1x1. </font><font style="vertical-align: inherit;">For example: 1 × 1, 2 × 2, 4 × 4, 8 × 8, 16 × 16, 32 × 32, 64 × 64, 128 × 128. </font><font style="vertical-align: inherit;">Each of these textures is called a MIP level. </font><font style="vertical-align: inherit;">To implement scuffs in the shader pixel by pixel, based on the mask, you need to select the required MIP level. </font><font style="vertical-align: inherit;">It turns out this way: where the pixel on the mask is black, the maximum MIP level is selected on Matcap, and where the pixel color is white, the MIP level is 0. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r9/33/bw/r933bw4z7ja0uwi4o8uwoomrthe.gif"><br>
<br>
<img src="https://habrastorage.org/webt/7o/k7/n9/7ok7n9zj0oxq3ouidw_kwt9ezww.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the shader makes it possible to simulate reflections and highlights, add light roughness and scuffs. </font><font style="vertical-align: inherit;">And all this without the use of Cubemap, without complex lighting calculations and other techniques that significantly reduce the performance of mobile devices.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/yr/ur/gayrur5ty9hr3xdfl56duhlcgqi.gif"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up Substance Painter to create a shader</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All available shaders in Substance Painter are written in GLSL. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Specifically, to write a shader for Substance Painter, I use the free VS Code. For syntax highlighting, it is better to use the Shader languages ​​support for VS Code extension. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fz/xo/iw/fzxoiwxrllvqgwvfammn5uuq7b8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is very little material about the API in Substance Painter, so the standard documentation found in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Help / Documentation / Shader API</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is priceless. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2t/rw/yx/2trwyxswqga9eozdwbk4mmc1ztk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second thing that will help in writing the shader is the standard shaders in Substance Painter. To find them, go to ... </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Allegorithmic / SubstancePainter / resources / shelf / allegorithmic / shaders.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to write the simplest unlit shader that will show Base color. First, create a text file with the extension .glsl and write such a simple shader. Perhaps, while nothing is clear, I will tell in more detail about the structure of the shader in Substance Painter further. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mk/ck/rv/mkckrvh6j8r7fz7zh72sjfhylgg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a new project and drag the shader onto your shell. In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Import your resources to</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> drop-down list, </font><font style="vertical-align: inherit;">select </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">project </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'project_name'</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a0/us/24/a0us24ykiapgfc-ioeuxt7mpckc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is necessary so that all changes can be updated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now go to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Window / Views / Shader Settings</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and select your new shader in the window that appears. You can use the search.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9u/bt/6p/9ubt6padacui5ccb77bgpbywfcg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you see that the whole model is white and you can draw Base color on it, then you did everything right. </font><font style="vertical-align: inherit;">Now you can save the project and go to the next section. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jz/ig/wt/jzigwtwpb73uz6s8paesepkcqao.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the model is pink, then most likely there is an error in the shader - a notification about this will be in the console.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Building a shader in Substance Painter</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the structure of a shader using the previously described unlit shader as an example. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mk/ck/rv/mkckrvh6j8r7fz7zh72sjfhylgg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The shade method is the basic part of the shader; it will not work without it. Everything that will be described inside can be displayed on a 3D model. All final calculations are output through the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diffuseShadingOutput ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lines 3 and 4 create a parameter and a variable, respectively. The parameter associates the Base color channel with the variable in which the painted texture will be stored. All parameters are spelled out in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">help</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , in the case of Base color everything should be spelled out as in the example. Line 8 lays out the texture in the uv-coordinates of the 3D model. I note that for the texture with Base color, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sparse Virtual Textures</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> system is used </font><font style="vertical-align: inherit;">, because the library is connected with the first line</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lib-sparce.glsl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can find many implementations of Matcap, but its main point is that the normals of the model are directed towards the camera and the texture is rotated along the x and y axes. To rotate the normal toward the camera we need view matrix, or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the matrix type</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . You can find one in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">certificate</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mentioned above. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b5/94/ox/b594oxz6c9doiz0sdm2jbzxt6ow.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, these are the same declared names as in the case of Base color. Now we need to get the normals of the 3D model. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wg/os/4b/wgos4bygzxftd_sbadht0lqznhy.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zero as the fourth element of the vector is required.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Multiplying a view matrix with a normal vector will expand the normal to the camera. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ty/bt/c0/tybtc0ibyb9ybigfr5x-tse61ne.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget that when multiplying matrices, the order of the factors is important. If you change the order of multiplication, the results will be different.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can </font><font style="vertical-align: inherit;">create uv coordinates </font><font style="vertical-align: inherit;">from </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewNormal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/94/ef/jn/94efjnpw9ingufg9ocbgfdxxnwq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's time to hook up the matcap texture. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ed/k3/k8/edk3k848a9wdmfa06dunpn8zrni.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, the parameter will create a texture field in the shader interface, and if the project has a texture with the name "Matcap_mip", then Substance Painter will automatically tighten it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yl/q5/e0/ylq5e0hbag9jh4bpgj2ro2vot4e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's check what happened. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/zb/iy/rezbiydl_fat8ornozz67bwjbs0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here Matcap's texture is expanded in new coordinates and multiplied with Base color at the output. I want to pay attention to the fact that the Matcap texture is expanded through the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">texture ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, and Base color - through the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">textureSparse ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. This is because the textures specified through the shader interface cannot be of type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SamplerSparse</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result should look something like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/l7/v1/rq/l7v1rqhspgrp92iuffebw2-jmua.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now add a mask that will mix two Matcap's. For convenience, add two Matcap'a in one texture, breaking them into channels. As a result, two Matcap-textures will be in the channels R and G, respectively. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It will turn out something like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a-/nr/ih/a-nrih00ttqwnk6ewdv-pbhq9yo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start adding a mask to the shader. The principle is similar to the addition of Base color. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tt/lv/jf/ttlvjfnodtzhu_qp_mpq-oqfpga.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is enough to replace the basecolor value with user0 in the parameter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now get the mask value in the pixel shader and mix the matcap textures. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pa/42/sr/pa42srwn-29afh50di07sepap_w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, only R channel is used in the mask, because it will be black and white. The two matcap channels are mixed using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mix ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">, an analogue of lerp in Unity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's update the shader and add custom channels in the interface. To do this, go to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Window / Views / Texture Set Settings</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in the window near the Channels heading, click on the plus and select user0 from the large list. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0t/v0/mo/0tv0mo6ovcvfztcawlrhbzrhzbs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The channel can be called anything you like. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, drawing on this channel, you can see how the two Matcap textures are mixed. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/jq/nu/rijqnu1-0utez7t0babbdv11--s.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The shader for Unity also used normal maps for Matcap, which were baked from a high-poly model. Let's try to do the same in Substance Painter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To use all operations on normals, you need to connect the appropriate </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6f/zz/z3/6fzzz36x9epa7a34gew0hcq-fro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we connect the normal maps. There are two of them in Substance Painter: one is obtained by baking, and the second can be drawn. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hw/7q/86/hw7q86rpk52sdkyygjo32vufv5s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the parameters, you can guess that </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">channel_normal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a normal map by which you can draw, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">texture_normal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- baked normal map. I also note that the variable name </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">texture_normal is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> embedded in the API and you cannot name it at your discretion. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, unpack the cards in the pixel shader: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yq/wx/sv/yqwxsvn2ohvouv-rwzui9blzp6q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we mix the normal maps and normals that are on the vertexes of the model. To do this, in the library connected above, there is a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">normalBlend ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2y/r0/zs/2yr0zsobknqtlz7ooj_6xd4onsg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First we mix the two normal maps, and then the normal normals. Although it doesn’t really matter in which order to mix them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The rotation of the normals in the direction of the camera's gaze will look like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yc/bl/mt/ycblmti7x5nhbfhdlx6yyrqyl4o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then you can not change anything, everything will remain the same. It should be something like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gm/ny/za/gmnyza2j-simray-86frype0usa.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mip-mapping, as mentioned above, in this case is needed to simulate scuffs, something like a roughness card in PBR shading. But the main problem is that a pyramid from mip-cards is not generated for a texture that is transferred from the shader interface, and accordingly the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">textureLod ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">from glsl will not work. One could go the other way and load the Matcap texture through the user channel, as was done for mixing Matcap's. But then the quality of the texture will greatly decrease and strange artifacts will appear. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An alternative solution is to create a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyramid of MIP cards</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manually, in Adobe Photoshop or another similar editor, and then select the MIP level. The pyramid is built quite simply. It is necessary to proceed from the size of the original texture - in my case it is 256x256. We create a file with a size of 384x256 (384, because 256 + 256/2) and now reduce the original texture by half until it is one pixel in size. All versions of reduced textures are placed to the right of the original texture in ascending order. It should turn out like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/h-/qw/sgh-qwq1kmwq_gh7hgkg1l8fnxq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can start writing a function that will find the coordinates of each texture in the pyramid depending on the color of each pixel on the mask. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest way is to store the uv coordinates that will be calculated for each texture in an array. The size of the array will be determined as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log2 (height)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We need the original </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uv</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so we add them to the function argument. To determine which array element to use on a particular pixel, add </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">level</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the function argument. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hq/ox/um/hqoxumpnar903hkoghv3hgtfzr4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now calculate uv for the original texture, that is, crop those extra 128 pixels in width. To do this, multiply the x coordinate by ⅔. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/or/nh/hoornhxxr9w2yj_bgr8ckt9rdw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To use the rest of the texture from the pyramid, you need to find patterns. When we created the pyramid from the textures, we could notice that each time the texture is reduced by half from the previous size. That is, how many times the texture size decreases, you can determine by raising 2 to the power of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIP level</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9i/yk/6k/9iyk6k9udtbo2gyundt8erj8a0q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out, if you select level, for example, 4, then the texture will decrease by 16 times. As</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uv</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> coordinates are determined from 0 to 1, then the size needs to be normalized, that is, 1 divided by how many times the texture has decreased, for example, 1 divided by 16. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the obtained value of the size variable, you can calculate the coordinates for a specific </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIP level</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/we/cv/kh/wecvkhragapkffyxyussvrbgkes.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The size of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uv is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reduced in the same way as the size of the texture. At the x coordinate, the texture always shifts by ⅔. The y coordinate shift can be defined as the sum of all values ​​of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">size</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">for each </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">level</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> value </font><font style="vertical-align: inherit;">. That is, if the value is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">level = 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then uv in the y coordinate will shift by 0 pixels, and if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">level = 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then the shift will be half the height of the texture - 128 pixels. If </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">level = 3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then the shift will turn out as 128 + 64 pixels and so on. The sum of all shifts can be obtained using the cycle. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/fl/wi/njflwi83bfg42lecjugixw2xrr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, each iteration, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">will add up and shift the texture along the y axis by the desired number of pixels. The step-by-step algorithm looks something like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jc/cd/ll/jccdllnuvqh288742jsx21jtbme.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last step is to display a channel that will select the desired </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">level</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at each pixel. We have already done this, nothing new. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/no/sh/4d/nosh4drvum-rq3fif1mh2qdif_0.png"><br>
<br>
<img src="https://habrastorage.org/webt/vg/-5/w0/vg-5w0rym_gpaygfgzhtkubfxly.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To select the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIP level</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as a texture, just multiply the length of the array by the texture. Now you can connect new uv-coordinates through the method just written. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/-h/1a/af-h1agpkidgfd7153wgsfgltaa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget to translate the texture into int type, since this is now an index for the array.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to add a custom channel in Substance Painter, as we did before. It should turn out like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qc/4p/h4/qc4ph4jzivfdrtqd5w4dqtn0ojw.gif"><br>
<br>
<img src="https://habrastorage.org/webt/mp/s4/1c/mps41cvu0dlu_kqkkv7qkrtmb5m.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only thing missing for the shader is the light source and the ability to rotate it by pressing shift. First of all, for this we need a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parameter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that will produce the rotation angle by pressing shift, and the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rotation matrix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/g_/y1/xyg_y1vvg_rhtoxwuepokzrp9x0.png"><br>
<br>
<img src="https://habrastorage.org/webt/ny/17/df/ny17dfcnyibmvgvfx8pbphsxkom.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We randomly place the light source and multiply the position by the rotation matrix. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bo/gi/fp/bogifpq90um2ygho-bgv0zdvy7a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the light source will rotate around the y axis by pressing shift, but so far this is just a vector in which the position of the light source is stored. There is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">good stuff</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how to implement directional light in a shader. </font><font style="vertical-align: inherit;">We will focus on him. </font><font style="vertical-align: inherit;">It remains for us to determine the direction of light and the illumination of our model. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ok/a4/df/oka4dfn33tv1t2meohooiu9fz2k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The color of the shadow and the color of the light source will be set by the parameters: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mr/zs/km/mrzskmiirmqmddlhwwg59ab_mpm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The color parameters are interpolated according to the illumination calculated above. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c4/ci/8h/c4ci8hm54ul19f-lg92oox2t7li.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It will turn out like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dp/rx/s9/dprxs9gy7_jaw4p3lu_ux7a9xbi.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using these parameters, you can adjust the color of the shadow and the color of the light source through the Substance Painter interface.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ws/o8/e3/wso8e3nnmdky15efibtajhj0rya.gif"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create and configure a preset</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the shader is ready, you need to import the Matcap texture and the shader with the shelf setting. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hg/w2/wh/hgw2wh4tdzd6i1l4hgcpi8iebpk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We remove all unused channels and add user channels: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/qs/xe/hlqsxepohrs1j0hbrlkeghgch5g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
preset for exporting textures will look like any other, except that it will use our custom channels. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zp/xf/7o/zpxf7oje5map2cl0gurvpustk7u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We’ll create a template for all the settings so that when you create the project, the desired shader is immediately assigned and all the texture channels are configured. </font><font style="vertical-align: inherit;">To do this, go to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File / SaveAsTemplate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and save the template. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pb/xn/aq/pbxnaqjvwraborjnospf8rglc10.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now when creating a new project, you don’t need to configure anything - just select the desired template.</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/hh/xw/by/hhxwbyfzcemnynsqglcabzbgzto.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What did you get</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A technical artist can create special effects, customize scenes, and optimize rendering processes. </font><font style="vertical-align: inherit;">I also wanted the armor and weapon models in Stormfall: Saga of Survival to be exactly what 3D artists intended. </font><font style="vertical-align: inherit;">As a result, the 3D model in Substance Painter looks the same as in the game engine. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x_/ic/qr/x_icqrlq2s3_osfrps5c-0qttwo.gif"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3D model in Substance Painter with custom shading. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/7e/79/sg/7e79sgwszeyazecwzi18j2fhv4s.gif"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3D model in Unity with custom shading. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope the article was useful and inspired you to new achievements!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501968/index.html">MVI Architectural Template in Kotlin Multiplatform, Part 1</a></li>
<li><a href="../en501970/index.html">What do you need to create a good dungeon in RPG?</a></li>
<li><a href="../en501976/index.html">How to learn to test software</a></li>
<li><a href="../en501978/index.html">How does the Prometheus histogram work?</a></li>
<li><a href="../en501980/index.html">The history of one project or how I created 7 years PBX based on Asterisk and Php</a></li>
<li><a href="../en501984/index.html">What to see in quarantine? A selection of materials from Technostream (part 4)</a></li>
<li><a href="../en501986/index.html">Secrets of the incredible success of Apple AirPods</a></li>
<li><a href="../en501988/index.html">How does the VK message screen render?</a></li>
<li><a href="../en501990/index.html">Useful post: 4 events to solve the problems of the second day in OpenShift and create operators</a></li>
<li><a href="../en501992/index.html">How to organize testing in order to accelerate and stabilize product releases. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>