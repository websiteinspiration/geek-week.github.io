<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📴 🎯 🆖 微服务中的代码组织以及我使用六角形体系结构和DDD的方法 ❗️ 🐿️ 🖕🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="哈Ha！在Monolith中，所有代码应采用相同的样式，并且在不同的微服务中可以使用不同的方法，编程语言和框架。对于具有1到2个控制器和1到10个动作的简单微服务，阻塞抽象层没有特别的意义。相反，对于具有不同状态以及它们之间转换逻辑的复杂微服务，最好不要一开始就懒惰。我想谈谈我在两种情况下组织代码以...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>微服务中的代码组织以及我使用六角形体系结构和DDD的方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493426/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ak/h6/c_/akh6c_safonprea6vtagzdaoy58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
哈Ha！在Monolith中，所有代码应采用相同的样式，并且在不同的微服务中可以使用不同的方法，编程语言和框架。对于具有1到2个控制器和1到10个动作的简单微服务，阻塞抽象层没有特别的意义。相反，对于具有不同状态以及它们之间转换逻辑的复杂微服务，最好不要一开始就懒惰。我想谈谈我在两种情况下组织代码以及使用DDD，Ports和Adapters方法的经验。该文章有一个简短摘要：June-在控制器中编写代码。中-写一堆抽象。高级-知道何时在控制器中编写代码，以及何时需要抽象。</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里，您需要立即结束I-C＃中的端口是接口或抽象，而适配器是具体的实现（类，结构）。</font><font style="vertical-align: inherit;">作为参考，我建议阅读</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDD，六角形，洋葱形，清洁，CQRS的翻译……我如何将它们综合在一起，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及这篇有关</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">清洁建筑的误解</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这里，请记住，该方法是针对大型且复杂的整体描述的。</font><font style="vertical-align: inherit;">我想谈谈这种方法在微服务中的变化，其中80％是简单的，而20种是中复杂的。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">术语</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1）主适配器 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
介绍用于外部</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼叫</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统</font><font style="vertical-align: inherit;">的用户友好界面</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">调用并使用SecondaryApdapters和Logic。</font><font style="vertical-align: inherit;">他们告诉应用程序做某事。</font><font style="vertical-align: inherit;">入口指向您的代码。</font><font style="vertical-align: inherit;">典型代表：ItemsService，CreateItemCommandHandler。</font><font style="vertical-align: inherit;">使用Logic和SecondaryAdapters进行工作。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2）SecondaryAdapters </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
提供与外部</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统</font><font style="vertical-align: inherit;">的接口，</font><font style="vertical-align: inherit;">方便我们的系统使用。</font><font style="vertical-align: inherit;">他从应用程序接收命令。</font><font style="vertical-align: inherit;">典型代表：ItemsRepository，EmailSender，Logger，DistributedCache。</font><font style="vertical-align: inherit;">他们使用诸如EntityFramework之类的库和框架进行工作。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3）逻辑</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1）实体</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结合数据和逻辑。</font><font style="vertical-align: inherit;">典型的OOP对象。</font><font style="vertical-align: inherit;">项目，金钱，用户。</font><font style="vertical-align: inherit;">也有ValueObjects和Events。</font><font style="vertical-align: inherit;">仅使用“实体”层中的其他对象。</font><font style="vertical-align: inherit;">从理论上讲，该层是不依赖任何人的应用程序的核心。</font><font style="vertical-align: inherit;">一切都取决于他。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2）DomainServices</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
裸计算。</font><font style="vertical-align: inherit;">它们是无法附加到一个特定实体的逻辑所必需的。</font><font style="vertical-align: inherit;">使用实体或其他DomainServices。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不要</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用PrimaryAdapters（它们总是自己使用）和SecondaryAdapters。</font><font style="vertical-align: inherit;">通常，这是各种AmountCalculator，Validator等。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
代码调用流应始终沿一个方向设置PrimaryAdapters-&gt; Logic和SecondaryAdapters。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">域</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是系统正在开发的主题领域。</font><font style="vertical-align: inherit;">例如对于域在线商店，这是电子商务。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有界上下文</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BoundedContext用于将系统划分为具有一定责任的隔离部分。在系统设计中成功的方法之一是在其中找到并突出显示其所有BoundedContext。在微服务架构中，1个微服务= 1 BoundedContext。例如：在线商店可能有一个BoundedContext购物车和BoundedContext处理订单，BoundedContext处理文件。一个大的BoundedContext可以分解成小块。例如，对于一篮子商品的BoundedContext，您可以将添加商品到购物篮的上下文和从篮子中删除商品的上下文进行划分。在整体1中，大的BoundedContext是一个模块。在这里有必要说明所有实体都生活在特定的上下文中，即从购物篮中的物品和从陈列柜中的物品来看，这些物品可以是具有不同字段和方法的不同类别。在整体中，它们简单地相互映射，并使用EF传递给数据库使用的一些ItemDto来使用，并且该字段具有所有人共同的字段，也就是说，如果来自购物篮上下文（模块）的Item具有属性Property1，而来自店面上下文的Item的商品具有属性Property2，则ItemDto将同时具有Property1和Property2。在每个上下文中，将有其自己的存储库，该存储库将从数据库中提取该上下文已具有的Item。在微服务中，这很容易。每个都有自己的数据库和本质。每个世界服务都有自己的类。只是在整体中，它们简单地相互映射，并使用EF传递给数据库工作的ItemDto，该ItemD具有所有人都通用的字段，即，如果Basket的上下文（模块）中的Item具有属性Property1，而店面的上下文中的Item的商品具有属性Property2，则ItemDto将同时具有Property1和Property2。在每个上下文中，将有其自己的存储库，该存储库将从数据库中提取该上下文已具有的Item。在微服务中，这很容易。每个都有自己的数据库和本质。每个世界服务都有自己的类。只是在整体中，它们简单地相互映射，并使用EF传递给数据库使用的一些ItemDto来使用，并且该字段具有所有人共同的字段，也就是说，如果来自购物篮上下文（模块）的Item具有属性Property1，而来自店面上下文的Item的商品具有属性Property2，则ItemDto将同时具有Property1和Property2。在每个上下文中，将有其自己的存储库，该存储库将从数据库中提取该上下文已具有的Item。在微服务中，这很容易。每个都有自己的数据库和本质。每个世界服务都有自己的类。只是在每个上下文中，将有其自己的存储库，该存储库将从数据库中提取该上下文已具有的Item。在微服务中，这很容易。每个都有自己的数据库和本质。每个世界服务都有自己的类。只是在每个上下文中，将有其自己的存储库，该存储库将从数据库中提取该上下文已具有的Item。在微服务中，这很容易。每个都有自己的数据库和本质。每个世界服务都有自己的类。只是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请记住</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，来自不同BoundedContext的Item和ItemsRepository可以是具有不同方法和属性的不同对象。</font><font style="vertical-align: inherit;">通常，微服务中的BoundedContext被引入一些常见的库而被违反。</font><font style="vertical-align: inherit;">结果是一个类具有数十种方法或属性，并且每个微服务仅使用所需的1-2，因此您在使用微服务中的共享库时要格外小心。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">层之间的依赖性</font></font></h3><br>
<img src="https://habrastorage.org/webt/8g/kb/4y/8gkb4yjeoduvybjcxsyo77apjre.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帕累托法则80％的简单微服务选项</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
丢弃层PrimaryAdatapters和SecondaryAdapters。仅保留逻辑层。更确切地说，在典型的ASP.NET应用程序中，我们使用-PimaryAdater是Controller，而SecondaryAdapter是EF中的DbContext。如果Controller突然变得太大，则可以使用局部将其切成碎片。这比繁殖不必要的抽象并花一些时间来更好。例如，Microsoft在docker容器上的EShop应用程序示例中针对BasketMicrotservice做到了这一点。是的，只需将代码写入控制器即可。只是不要写意粉代码。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请记住，逻辑层仍然存在，我们仍然将实体与它们的逻辑结合使用，并将DomainServices与它们的计算结合使用，而不仅仅是在控制器中编写意大利面条式代码墙。</font><font style="vertical-align: inherit;">我们只是丢弃了典型的ItemService和ItemRepository。</font><font style="vertical-align: inherit;">本着这种精神，好的旧的ItemValidator，ItemMapper，AmountCalculator等仍然存在。</font><font style="vertical-align: inherit;">由于我们仍然具有逻辑层，因此可以随时通过使用ItemsService，ItemsRepository包装其他抽象来切换到更复杂的选项。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以折扣价计算产品最终价格的服务。</font><font style="vertical-align: inherit;">从理论上讲，它是Domain Online Store的一部分，代表其BoundedContext产品目录。</font><font style="vertical-align: inherit;">为简单起见，我跳过了所有验证逻辑。</font><font style="vertical-align: inherit;">可以用某种ItemValidator和DiscountValidator来描述。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）逻辑文件夹：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.1）实体文件夹：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
折扣：</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Discount</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Value { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
钱：</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">Owned</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Money</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Amount { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">Apply</span>(<span class="hljs-params">Discount discount</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> amount = Amount * (<span class="hljs-number">1</span> - discount.Value);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Money()<font></font>
            {<font></font>
                Amount = amount<font></font>
            };<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
产品：</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Item</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Money Price { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span> Money();<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.2）DomainServices文件夹产品</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
价格计算器，包括折扣：</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function">Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span>;<font></font>
    }<font></font>
<font></font>
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PriceCalculator</span>:<span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> discounts.Aggregate(item.Price, (m, d) =&gt; m.Apply(d));<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）DbContext </font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsDbContext</span>(<span class="hljs-params">DbContextOptions&lt;ItemsDbContext&gt; options</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span><font></font>
        {<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Item&gt; Items { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Discount&gt; Discounts { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3）控制器</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">ItemsDbContext context, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _context.Discounts.ToListAsync();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">面向20％的复杂微服务以及大多数整体的选项</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，我们使用一种标准方法，将各层之间的隔离程度最大化。</font><font style="vertical-align: inherit;">为PrimaryAdapter（ItemService）和SecondaryAdapter（ItemRepository）添加一个类。</font><font style="vertical-align: inherit;">在Logic文件夹中，所有内容均保持不变。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）SecondaryAdapters文件夹</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsRepository</span> : <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">return</span> item;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        Task&lt;List&lt;Discount&gt;&gt; Get();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DiscountsRepository</span> : <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DiscountsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Task&lt;List&lt;Discount&gt;&gt; Get()<font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> _context.Discounts.ToListAsync();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）PrimaryAdapters文件夹</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemService</span> : <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemsRepository _items;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IDiscountsRepository _discounts;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemService</span>(<span class="hljs-params">IItemsRepository items, IDiscountsRepository discounts, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _items = items;<font></font>
            _discounts = discounts;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _items.Get(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _discounts.Get();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的控制器现在使用IItemService</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemService _service;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">IItemService service</span>)</span><font></font>
        {<font></font>
            _service = service;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _service.GetPriceWithDiscount(id);
            <span class="hljs-keyword">return</span> result;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
添加了很多其他代码。相反，增加了系统灵活性。现在，将Contoller（通常是ASP.NET Core）更改为其他名称，或将DbContext和EntityFramework Core更改为其他名称，或将缓存添加到Redis变得更加容易。第一种方法在简单的微服务以及非常简单和小的整体中获胜。在所有其他情况下，第二个则需要您添加并完成此代码一年以上。好吧，在第二种方法中，除了实体项目和折扣之外，制作将使用DbContex EF的单独的DTO和ASP.NET Controller将使用的单独的DTO（模型）也很有用。 ItemDto和ItemModel。这将使域模型更加独立。最后，是我使用第二次</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">TestRuvds</font></a><font style="vertical-align: inherit;">方法编写的一个简单应用程序的示例</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">实际上，他在这里是多余的，所有这些抽象都在此处作为示例。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实施实例</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">虚拟服务器模块</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">致谢</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
谢谢 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canxes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 和 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安德鲁·登布</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 对于发现的语法错误。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN493412/index.html">在ESP32上使用Wifi玩游戏</a></li>
<li><a href="../zh-CN493416/index.html">IDA Pro和逆向工程技术</a></li>
<li><a href="../zh-CN493418/index.html">为什么机器学习使用“合成”数据</a></li>
<li><a href="../zh-CN493420/index.html">向初中生介绍Python的方式</a></li>
<li><a href="../zh-CN493424/index.html">我们实现Python代码转换</a></li>
<li><a href="../zh-CN493428/index.html">“我们不会产生阴谋论。” 与来自科学和IT公司的人讨论ML会议</a></li>
<li><a href="../zh-CN493430/index.html">Web应用程序的网络体系结构</a></li>
<li><a href="../zh-CN493432/index.html">为什么不在小型非IT公司中开始职业</a></li>
<li><a href="../zh-CN493436/index.html">用于在Bash上更改访问权限和注册文件/目录名称的程序</a></li>
<li><a href="../zh-CN493438/index.html">显示搜索结果和性能问题</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>