<!doctype html>
<html class="no-js" lang="hi">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯТЫ ЁЯеС ЁЯРо рд╕реА рдкрд░ рдЬреАрдд рдХреА рдЦреБрд╢реА рдФрд░ рджреБрдЦ: рд╣рдо рд╣рд╕реНрдХреЗрд▓ рдкрд░ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдбрдмреНрд▓реНрдпреВрд╕реА рд╕реЗ рдХреИрдВрдбреА рдмрдирд╛рддреЗ рд╣реИрдВ ЁЯПА ЁЯСйЁЯП╗ ЁЯНЧ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╣реЗрд▓реЛ, рд╣реИрдмрд░ред
 

рдЗрд╕рд▓рд┐рдП, рдкрд┐рдЫрд▓реА рдмрд╛рд░ рд╣рдордиреЗ рдЕрдиреБрднрд╡рдЬрдиреНрдп рд░реВрдк рд╕реЗ рд╕рд╛рдмрд┐рдд рдХрд┐рдпрд╛ рдерд╛ рдХрд┐ рдЖрдк рд╣рд╛рд╕реНрдХреЗрд▓ рдкрд░ рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЦрд┐рд▓реМрдирд╛ wc рдЖрд╕рд╛рдиреА рд╕реЗ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдХрд┐ GNU Coreutils...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>рд╕реА рдкрд░ рдЬреАрдд рдХреА рдЦреБрд╢реА рдФрд░ рджреБрдЦ: рд╣рдо рд╣рд╕реНрдХреЗрд▓ рдкрд░ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдбрдмреНрд▓реНрдпреВрд╕реА рд╕реЗ рдХреИрдВрдбреА рдмрдирд╛рддреЗ рд╣реИрдВ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496370/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣реЗрд▓реЛ, рд╣реИрдмрд░ред</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрд╕рд▓рд┐рдП, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд┐рдЫрд▓реА рдмрд╛рд░</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╣рдордиреЗ рдЕрдиреБрднрд╡рдЬрдиреНрдп рд░реВрдк рд╕реЗ рд╕рд╛рдмрд┐рдд рдХрд┐рдпрд╛ рдерд╛ рдХрд┐ рдЖрдк рд╣рд╛рд╕реНрдХреЗрд▓ рдкрд░ рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЦрд┐рд▓реМрдирд╛ wc рдЖрд╕рд╛рдиреА рд╕реЗ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдХрд┐ GNU Coreutils wc рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХрд╛рдлреА рддреЗрдЬ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдпрд╣ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдИрдорд╛рдирджрд╛рд░ рддреБрд▓рдирд╛ рдирд╣реАрдВ рд╣реИ: рд╣рдорд╛рд░рд╛ рдХрд╛рд░реНрдпрдХреНрд░рдо рдмрд╛рдЗрдЯреНрд╕, рд╕реНрдЯреНрд░рд┐рдВрдЧреНрд╕ рдФрд░ рд╢рдмреНрджреЛрдВ рдХреЛ рдЧрд┐рдирдиреЗ рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХреБрдЫ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬрдмрдХрд┐ рдЕрд╕рд▓реА wc рдЕрдзрд┐рдХ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рд╣реИ: рдЗрд╕рдореЗрдВ рдХрдИ рдФрд░ рдЖрдВрдХрдбрд╝реЗ рд╣реИрдВ, рд╡рд┐рдХрд▓реНрдкреЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рд╕реНрдЯрдб рд╕реЗ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ ... рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рд╣рдо рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдпрд╣ рд╕рд┐рд░реНрдл рдПрдХ рдЦрд┐рд▓реМрдирд╛ рдирд┐рдХрд▓рд╛ред</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрдЬ рд╣рдо рдЗрд╕реЗ рдареАрдХ рдХрд░ рджреЗрдВрдЧреЗред </font><font style="vertical-align: inherit;">рд╣рдорд╛рд░рд╛ рдореБрдЦреНрдп рд▓рдХреНрд╖реНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдЧрдгрдирд╛ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЖрдВрдХрдбрд╝реЛрдВ рдХрд╛ рдЪрдпрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛ рд╣реИ, рдЬрдмрдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдЗрд╕рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдЧрд┐рдирд╛ рдЬрд╛рдПред </font><font style="vertical-align: inherit;">рдФрд░ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд╛рдд - рд╣рдо рдкреНрд░рддрд┐рд░реВрдкрдХрддрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВрдЧреЗ, рдкреНрд░рддреНрдпреЗрдХ рд╕рд╛рдВрдЦреНрдпрд┐рдХреАрдп рдХреЛ рдПрдХ рдЕрд▓рдЧ-рдерд▓рдЧ рдЗрдХрд╛рдИ рдореЗрдВ рдЙрдЬрд╛рдЧрд░ рдХрд░реЗрдВрдЧреЗред</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдЕрдЧрд░ рд╣рдо </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реА-рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рджреЗрдЦрддреЗ рд╣реИрдВ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ, рд╡реНрдпрдХреНрддрд┐рдЧрдд рд░реВрдк рд╕реЗ, рдореИрдВ рдЗрд╕реЗ рдкрдардиреАрдп рдФрд░ рд╕рдорд░реНрдерд┐рдд рдХреЛрдб рдХрд╛ рдирдореВрдирд╛ рдирд╣реАрдВ рдХрд╣реВрдВрдЧрд╛, рдХреНрдпреЛрдВрдХрд┐ 370 рд▓рд╛рдЗрдиреЛрдВ рдкрд░ рдПрдХ рдмрдбрд╝реЗ рд╕рдорд╛рд░реЛрд╣ рдореЗрдВ рд╡рд╣рд╛рдВ рд╕рдм рдХреБрдЫ рд╣реЛрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╣рдо рдЗрд╕рд╕реЗ рдмрдЪрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВрдЧреЗред</font></font></p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rm/rk/d0/rmrkd0k9gjyumqz6fmjbxsooovi.png"></div><br>
<p><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реА-рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдореБрдЦреНрдп рдХрд╛рд░реНрдп 4 рдХреЗ рдлреЙрдиреНрдЯ рдХреЗ рд╕рд╛рде рдкреЛрд░реНрдЯреНрд░реЗрдЯ рдУрд░рд┐рдПрдВрдЯреЗрд╢рди рдореЗрдВ 4k рд╕реНрдХреНрд░реАрди рдкрд░ рдлрд┐рдЯ рдирд╣реАрдВ рд╣реБрдЖред</font></font></em></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрд╕ рд╕рдВрд╢реЛрдзрди рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╣рдо, рдЕрдиреНрдп рдмрд╛рддреЛрдВ рдХреЗ рдЕрд▓рд╛рд╡рд╛:</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрдЗрдП рдЗрд╕ рд╡рд┐рдЪрд╛рд░ рдХреЛ рд╡реНрдпрдХреНрдд рдХрд░реЗрдВ рдХрд┐ рдХреБрдЫ рдЖрдВрдХрдбрд╝реЗ рдЬреИрд╕реЗ рдмрд╛рдЗрдЯ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреА рдЧрдгрдирд╛ рдкреВрд░реЗ рдЗрдирдкреБрдЯ рдкрд░ рдЕрдзрд┐рдХ рдХреБрд╢рд▓рддрд╛ рд╕реЗ рдХрд╛рдо рдХрд░ рд╕рдХрддреА рд╣реИ, рдЬрдмрдХрд┐ рдЕрдиреНрдп рдХреЛ рдкреНрд░рддреНрдпреЗрдХ рдмрд╛рдЗрдЯ рдХреЛ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рд┐рдП;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдФрд░ рднреА рдЕрдзрд┐рдХ рдЖрдБрдХрдбрд╝реЗ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ, рдЙрдирдореЗрдВ рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╡реНрдпрдХреНрддрд┐рдЧрдд рд░реВрдк рд╕реЗ рдмрд╛рдд рдХрд░рдиреЗ рдХреЗ рдЕрд╡рд╕рд░ рдХрд╛ рдЖрдирдВрдж рд▓реЗрддреЗ рд╣реБрдП (рдЬрд┐рд╕реЗ рд╕реНрдерд╛рдиреАрдп рддрд░реНрдХ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдХреБрдЫ рдкрд░реАрдХреНрд╖рдг рд▓рд┐рдЦреЗрдВрдЧреЗ, рдПрдХ рдмрд╛рд░ рдлрд┐рд░ рд╕реЗ рд╕реНрдерд╛рдиреАрдп рддрд░реНрдХ рдХрд╛ рдЖрдирдВрдж рд▓реЗрдВрдЧреЗ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдХреБрдЫ рд▓рдЧрднрдЧ рдирд┐рд░реНрднрд░рддрд╛ рд╕реЗ рдЯрд╛рдЗрдк рдХреА рдЧрдИ рддрдХрдиреАрдХреЛрдВ рдХреЛ рдЖрдЬрд╝рдорд╛рдПрдБрдЧреЗ, рдЬреЛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХрд╛рдо рдХрд░ рд░рд╣реА рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХрд░рд╛рдорд╛рддреА рдмреНрд░реЗрдХрд┐рдВрдЧ рдХреЛрдб;</font></font></li>
<li>  Template Haskell;</li>
<li> ()  ()   .</li>
</ul><a name="habracut"></a><br>
<p>   ,     :</p><br>
<pre><code class="haskell hljs"><span class="hljs-meta">{-# LANGUAGE Strict #-}</span>
<span class="hljs-meta">{-# LANGUAGE RecordWildCards #-}</span><font></font>
<font></font>
<span class="hljs-keyword">module</span> Data.WordCount <span class="hljs-keyword">where</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.ByteString.Lazy <span class="hljs-keyword">as</span> BS<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">State</span> = <span class="hljs-type">State</span></span>
  { bs :: <span class="hljs-type">Int</span>
  , ws :: <span class="hljs-type">Int</span>
  , ls :: <span class="hljs-type">Int</span>
  , wasSpace :: <span class="hljs-type">Int</span><font></font>
  }<font></font>
<font></font>
<span class="hljs-title">wc</span> :: <span class="hljs-type">BS</span>.<span class="hljs-type">ByteString</span> -&gt; (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>)
<span class="hljs-title">wc</span> s = (bs, ws + <span class="hljs-number">1</span> - wasSpace, ls)
  <span class="hljs-keyword">where</span>
    <span class="hljs-type">State</span> { .. } = <span class="hljs-type">BS</span>.foldl' go (<span class="hljs-type">State</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>) s<font></font>
<font></font>
    go <span class="hljs-type">State</span> { .. } c = <span class="hljs-type">State</span> (bs + <span class="hljs-number">1</span>) (ws + addWord) (ls + addLine) isSp
      <span class="hljs-keyword">where</span>
        isSp | c == <span class="hljs-number">32</span> || c - <span class="hljs-number">9</span> &lt;= <span class="hljs-number">4</span> = <span class="hljs-number">1</span>
             | otherwise = <span class="hljs-number">0</span>
        addLine | c == <span class="hljs-number">10</span> = <span class="hljs-number">1</span>
                | otherwise = <span class="hljs-number">0</span>
        addWord = (<span class="hljs-number">1</span> - wasSpace) * isSp
<span class="hljs-meta">{-# INLINE wc #-}</span></code></pre><br>
<p>       ,    ,   .    ?</p><br>
<h1 id="kompozabelnye-levye-svyortki">  </h1><br>
<p>   ,        .   ,       <code>BS.foldl'</code>!</p><br>
<p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">foldl</a>,   ┬л,     ┬╗.   ,   !  ,  ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"></a>    <code>ByteString</code>.  ,          :       ( , <code>length</code>   ),         <code>count</code> ( <code>count 10</code>). ,      ,    !</p><br>
<p> ,    ,            .      :</p><br>
<pre><code class="haskell hljs"><span class="hljs-meta">{-# LANGUAGE Strict #-}</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Control.Foldl <span class="hljs-keyword">as</span> L
<span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.ByteString <span class="hljs-keyword">as</span> BS<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">WordState</span> = <span class="hljs-type">WordState</span> { <span class="hljs-title">ws</span> :: <span class="hljs-type">Int</span>, <span class="hljs-title">wasSpace</span> :: <span class="hljs-type">Int</span> }</span><font></font>
<font></font>
<span class="hljs-title">wordsCount</span> :: <span class="hljs-type">L</span>.<span class="hljs-type">Fold</span> <span class="hljs-type">BS</span>.<span class="hljs-type">ByteString</span> <span class="hljs-type">Int</span>
<span class="hljs-title">wordsCount</span> = <span class="hljs-type">L</span>.<span class="hljs-type">Fold</span> (<span class="hljs-type">BS</span>.foldl' go) (<span class="hljs-type">WordState</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>) (\<span class="hljs-type">WordState</span> { .. } -&gt; ws + <span class="hljs-number">1</span> - wasSpace)
  <span class="hljs-keyword">where</span>
    go <span class="hljs-type">WordState</span> { .. } c = <span class="hljs-type">WordState</span> (ws + addWord) isSp
      <span class="hljs-keyword">where</span>
        isSp | c == <span class="hljs-number">32</span> || c - <span class="hljs-number">9</span> &lt;= <span class="hljs-number">4</span> = <span class="hljs-number">1</span>
             | otherwise = <span class="hljs-number">0</span>
        addWord = (<span class="hljs-number">1</span> - wasSpace) * isSp</code></pre><br>
<p>  ,      :</p><br>
<pre><code class="haskell hljs"><span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Control.Foldl.ByteString <span class="hljs-keyword">as</span> BL
<span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.ByteString.Lazy <span class="hljs-keyword">as</span> BSL<font></font>
<font></font>
<span class="hljs-title">main</span> :: <span class="hljs-type">IO</span> ()
<span class="hljs-title">main</span> = <span class="hljs-keyword">do</span><font></font>
  [path] &lt;- getArgs<font></font>
  contents &lt;- unsafeMMapFile path<font></font>
  <span class="hljs-keyword">let</span> res = <span class="hljs-type">BL</span>.fold ((,,) &lt;$&gt; <span class="hljs-type">BL</span>.length &lt;*&gt; <span class="hljs-type">BL</span>.count <span class="hljs-number">10</span> &lt;*&gt; wordsCount) (<span class="hljs-type">BSL</span>.fromStrict contents) :: (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>)<font></font>
  print res</code></pre><br>
<p>!   ?</p><br>
<p>   ,      (    1.8- ,   <code>tmpfs</code>-   IO,    ),        2.5 . ,    ,      ,      (     <code>wc</code>,          ),            IDE,              .</p><br>
<p>, 2.5 .   ,   .</p><br>
<p>,         ?</p><br>
<pre><code class="haskell hljs">  <span class="hljs-keyword">let</span> res = <span class="hljs-type">BL</span>.fold ((,) &lt;$&gt; <span class="hljs-type">BL</span>.length &lt;*&gt; wordsCount) contents :: (<span class="hljs-type">Int</span>, <span class="hljs-type">Int</span>)<font></font>
  print res</code></pre><br>
<p>1.55 . .    ?</p><br>
<pre><code class="haskell hljs">  <span class="hljs-keyword">let</span> res = <span class="hljs-type">BL</span>.fold (<span class="hljs-type">BL</span>.count <span class="hljs-number">10</span>) contents :: <span class="hljs-type">Int</span>
  print res</code></pre><br>
<p>1.05 .</p><br>
<p>.   .   <em> </em>  ! ,    (    <code>'\n'</code>)         ,     .</p><br>
<p>.  ,  ,        <code>foldl</code>.</p><br>
<p><code>foldl</code>   .             .    <code>foldl</code>    <code>ByteString</code>',      <code>ByteString</code>',      .       тАФ 256 ,     L1-,          L2  L1 (     L1  ).</p><br>
<p>, ,       16-32 ,     L1,     <em></em>.</p><br>
<p>,   , , ,     :   <code>BL.fold ((,) &lt;$&gt; wordsCount &lt;*&gt; wordsCount) contents</code> ( ,   ) <em></em>   <code>BL.fold wordsCount contents</code>.        .</p><br>
<p> , ,    ┬л ┬╗, ,     .</p><br>
<p>   ...</p><br>
<h1 id="nashi-sobstvennye-svyortki">  </h1><br>
<p> ,     ,     .          - .    ?</p><br>
<p>    -  ┬л┬╗  ( , ) <code>f1</code>, <code>f2</code>, <code>f3</code>,     <code>f1</code>  <code>f3</code>. ,          ,  ,   </p><br>
<pre><code class="haskell hljs">  <span class="hljs-comment">-- options тАФ   ,   </span><font></font>
  options &lt;- parseCliOptions<font></font>
<font></font>
  <span class="hljs-comment">-- theFold тАФ  </span>
  <span class="hljs-keyword">let</span> theFold = foldl' f (zip options [f1, f2, f3]) emptyFold
  <span class="hljs-keyword">where</span>
    f acc (<span class="hljs-type">True</span>, stat) = acc `compose` stat<font></font>
    f acc (<span class="hljs-type">False</span>, _) = acc</code></pre><br>
<p>,       ,    .</p><br>
<p>   ,      тАФ      .         ,    ,   ,   .</p><br>
<h2 id="tipy-na-pomosch">  </h2><br>
<p>    ?</p><br>
<p>     тАФ  .   ,   ,         ,      :</p><br>
<pre><code class="haskell hljs"><span class="hljs-meta">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<span class="hljs-meta">{-# LANGUAGE MultiParamTypeClasses, UndecidableInstances, FlexibleInstances #-}</span>
<span class="hljs-meta">{-# LANGUAGE TypeFamilyDependencies, FunctionalDependencies, PolyKinds, DataKinds, GADTs, TypeOperators #-}</span>
<span class="hljs-meta">{-# LANGUAGE ScopedTypeVariables #-}</span></code></pre><br>
<p>     -   ?   :</p><br>
<ul>
<li> ,</li>
<li>-,     ,</li>
<li>      -,</li>
<li>   .</li>
</ul><br>
<p>  :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Statistic</span> s res st | res -&gt; s, st -&gt; s
                         , s -&gt; res, s -&gt; st
                         <span class="hljs-keyword">where</span></span><font></font>
  initState :: st<font></font>
  extractState :: st -&gt; res<font></font>
  step :: st -&gt; <span class="hljs-type">Word8</span> -&gt; st</code></pre><br>
<p> <code>s</code>    (      <code>DataKinds</code>),        ,         ,  .  ,        -    :     </p><br>
<pre><code class="haskell hljs">  initState :: proxy1 s -&gt; proxy2 res -&gt; st<font></font>
  extractState :: proxy s -&gt; st -&gt; res<font></font>
  step :: proxy1 s -&gt; proxy2 res -&gt; st -&gt; <span class="hljs-type">Word8</span> -&gt; st</code></pre><br>
<p> ,        ,       ,         .</p><br>
<p>, ,             ,        ,                  .</p><br>
<h3 id="statistiki-po-chankam">  </h3><br>
<p>    ,  -  .  ,     , ,   .      ,         ,     .             ,     <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mi>n</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.977ex" height="2.634ex" viewBox="0 -809.3 2143 1134.2" role="img" focusable="false" style="vertical-align: -0.755ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMATHI-6E" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-29" x="1753" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-1">O(n)</script>  <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.634ex" viewBox="0 -809.3 2043 1134.2" role="img" focusable="false" style="vertical-align: -0.755ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-29" x="1653" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-2">O(1)</script>.   ,   (,   ,    )      ┬л┬╗  (     SIMD-,       ).  ,      .        ,      ,       .</p><br>
<p>    ,      ,    ,      ?    GADT!   -   <em> </em> ,     GADT    ,      .   :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">StatCompTyOf</span> = <span class="hljs-type">Chunked</span> | <span class="hljs-type">ByteOnly</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">StatComputation</span> st compTy where</span>
  <span class="hljs-type">ChunkedComputation</span> :: (st -&gt; <span class="hljs-type">Word8</span> -&gt; st)<font></font>
                     -&gt; (st -&gt; <span class="hljs-type">BS</span>.<span class="hljs-type">ByteString</span> -&gt; st)<font></font>
                     -&gt; <span class="hljs-type">StatComputation</span> st '<span class="hljs-type">Chunked</span>
  <span class="hljs-type">ByteOnlyComputation</span> :: (st -&gt; <span class="hljs-type">Word8</span> -&gt; st)<font></font>
                      -&gt; <span class="hljs-type">StatComputation</span> st '<span class="hljs-type">ByteOnly</span></code></pre><br>
<p> (   ) <code>BS</code> тАФ ,    .</p><br>
<p>     <code>Statistic</code>,      <code>comp</code>    <code>step</code>    <code>computation</code>:</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Statistic</span> s res st comp | res -&gt; s, st -&gt; s
                              , s -&gt; res, s -&gt; st, s -&gt; comp
                              <span class="hljs-keyword">where</span></span><font></font>
  initState :: st<font></font>
  extractState :: st -&gt; res<font></font>
  computation :: <span class="hljs-type">StatComputation</span> st comp</code></pre><br>
<p>      .     <code>s</code>,  <code>res</code>,  <code>st</code>,      .</p><br>
<p> ,  ,           . ,    SIMD- ,   16-32   .          .</p><br>
<h2 id="realizaciya-statistik"> </h2><br>
<p>    ?   :</p><br>
<ul>
<li> ,</li>
<li> (UTF-8)-,</li>
<li> ,</li>
<li>  ,</li>
<li> .</li>
</ul><br>
<p>  :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Statistics</span> = <span class="hljs-type">Bytes</span> | <span class="hljs-type">Chars</span> | <span class="hljs-type">Words</span> | <span class="hljs-type">MaxLL</span> | <span class="hljs-type">Lines</span> <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Eq</span>, <span class="hljs-type">Ord</span>)</span></code></pre><br>
<p>        ,   <code>wc</code>     .</p><br>
<p>   тАФ      <code>Statistic</code>. ,      тАФ  ,      :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">Tagged</span> a = <span class="hljs-type">Tagged</span> <span class="hljs-type">Word64</span> <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Eq</span>, <span class="hljs-type">Show</span>, <span class="hljs-type">Num</span>)</span></code></pre><br>
<p> <code>a</code>    ,   <code>Tagged 'Bytes</code>  <code>Tagged 'Chars</code>.</p><br>
<p>      :   :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">Statistic</span> '<span class="hljs-type">Bytes</span> (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Bytes</span>) (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Bytes</span>) '<span class="hljs-type">Chunked</span> <span class="hljs-keyword">where</span></span>
  initState = <span class="hljs-number">0</span><font></font>
  extractState = id<font></font>
  computation = <span class="hljs-type">ChunkedComputation</span> (\st _ -&gt; st + <span class="hljs-number">1</span>) (\st str -&gt; st + fromIntegral (<span class="hljs-type">BS</span>.length str))</code></pre><br>
<p>, ,   :</p><br>
<ol>
<li> ,  <code>Bytes</code>  ,   <code>Tagged 'Bytes</code>    ,   .  ,     .</li>
<li>  ( ,  )  0.</li>
<li> ,     ,      тАФ    .</li>
<li><code>computation</code>     ,     <code>'Chunked</code>   .         ,         .</li>
</ol><br>
<p>      .</p><br>
<p>   ,    ,       ,    </p><br>
<div class="spoiler"><b class="spoiler_title">.</b><div class="spoiler_text"><p>    ,       ,    :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">Statistic</span> '<span class="hljs-type">Lines</span> (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Lines</span>) (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Lines</span>) '<span class="hljs-type">Chunked</span> <span class="hljs-keyword">where</span></span>
  initState = <span class="hljs-number">0</span><font></font>
  extractState = id<font></font>
  computation = <span class="hljs-type">ChunkedComputation</span> (\st c -&gt; st + <span class="hljs-keyword">if</span> c == <span class="hljs-number">10</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>) (\st str -&gt; st + fromIntegral (<span class="hljs-type">BS</span>.count <span class="hljs-number">10</span> str))</code></pre><br>
<p>   ?            :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">WordsState</span> = <span class="hljs-type">WordsState</span> { <span class="hljs-title">ws</span> :: <span class="hljs-type">Word64</span>, <span class="hljs-title">wasSpace</span> :: <span class="hljs-type">Word64</span> }</span>
<span class="hljs-class">
<span class="hljs-keyword">instance</span> <span class="hljs-type">Statistic</span> '<span class="hljs-type">Words</span> (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Words</span>) <span class="hljs-type">WordsState</span> '<span class="hljs-type">ByteOnly</span> <span class="hljs-keyword">where</span></span>
  initState = <span class="hljs-type">WordsState</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
  extractState <span class="hljs-type">WordsState</span> { .. } = <span class="hljs-type">Tagged</span> (ws + <span class="hljs-number">1</span> - wasSpace)<font></font>
  computation = <span class="hljs-type">ByteOnlyComputation</span> step
    <span class="hljs-keyword">where</span>
      step <span class="hljs-type">WordsState</span> { .. } c = <span class="hljs-type">WordsState</span> (ws + (<span class="hljs-number">1</span> - wasSpace) * isSp) isSp
        <span class="hljs-keyword">where</span>
          isSp | c == <span class="hljs-number">32</span> || c - <span class="hljs-number">9</span> &lt;= <span class="hljs-number">4</span> = <span class="hljs-number">1</span>
               | otherwise = <span class="hljs-number">0</span></code></pre><br>
<p> ,           .</p><br>
<p>,    ,     .    тАФ  UTF-8-    ?</p><br>
<p>        :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">Statistic</span> '<span class="hljs-type">Chars</span> (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Chars</span>) (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Chars</span>) '<span class="hljs-type">ByteOnly</span> <span class="hljs-keyword">where</span></span>
  initState = <span class="hljs-number">0</span><font></font>
  extractState = id<font></font>
  computation = <span class="hljs-type">ByteOnlyComputation</span> $ \cnt c -&gt;<font></font>
        cnt + <span class="hljs-number">1</span> - fromIntegral (   ((c .&amp;. <span class="hljs-number">0</span>b10000000) `shiftR` <span class="hljs-number">7</span>)<font></font>
                               .&amp;. (<span class="hljs-number">1</span> - ((c .&amp;. <span class="hljs-number">0</span>b01000000) `shiftR` <span class="hljs-number">6</span>))<font></font>
                               )</code></pre><br>
<p>       UTF-8:        ,     <code>10xxxxxx</code>.  ,      UTF-8   ,    .</p><br>
<p>    ?              (, ,        ,   ASCII):</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">Statistic</span> '<span class="hljs-type">MaxLL</span> (<span class="hljs-type">Tagged</span> '<span class="hljs-type">MaxLL</span>) <span class="hljs-type">MaxLLState</span> '<span class="hljs-type">ByteOnly</span> <span class="hljs-keyword">where</span></span>
  initState = <span class="hljs-type">MaxLLState</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>
  extractState <span class="hljs-type">MaxLLState</span> { .. } = <span class="hljs-type">Tagged</span> $ max maxLen curLen<font></font>
  computation = <span class="hljs-type">ByteOnlyComputation</span> step
    <span class="hljs-keyword">where</span>
      step <span class="hljs-type">MaxLLState</span> { .. } <span class="hljs-number">9</span> = <span class="hljs-type">MaxLLState</span> maxLen $ curLen + <span class="hljs-number">8</span> - (curLen `rem` <span class="hljs-number">8</span>)<font></font>
      step <span class="hljs-type">MaxLLState</span> { .. } <span class="hljs-number">8</span> = <span class="hljs-type">MaxLLState</span> maxLen $ max <span class="hljs-number">0</span> (curLen - <span class="hljs-number">1</span>)<font></font>
      step <span class="hljs-type">MaxLLState</span> { .. } c | c == <span class="hljs-number">10</span>
                              || c == <span class="hljs-number">12</span>
                              || c == <span class="hljs-number">13</span> = <span class="hljs-type">MaxLLState</span> (max maxLen curLen) <span class="hljs-number">0</span>
                               | c &lt; <span class="hljs-number">32</span> = <span class="hljs-type">MaxLLState</span> maxLen curLen<font></font>
      step <span class="hljs-type">MaxLLState</span> { .. } _ = <span class="hljs-type">MaxLLState</span> maxLen (curLen + <span class="hljs-number">1</span>)</code></pre><br>
<p>,      backspace,    <code>wc</code>!</p></div></div><br>
<p>,      .      :  .</p><br>
<h2 id="kombinirovanie-statistik"> </h2><br>
<p> <code>a</code> тАФ ,  <code>b</code> тАФ ,    тАФ  ,     .        :</p><br>
<pre><code class="haskell hljs"><span class="hljs-keyword">infixr</span> <span class="hljs-number">5</span> :::
<span class="hljs-class"><span class="hljs-keyword">data</span> a ::: b = a ::: b <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Show</span>)</span></code></pre><br>
<p>      <code>(,)</code>,        ,       ,  ,   ,           .</p><br>
<p> ,   .</p><br>
<p>-,       ?     ,     ,     .       :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-keyword">family</span> <span class="hljs-type">CombineCompTy</span> a b where</span>
  <span class="hljs-type">CombineCompTy</span> '<span class="hljs-type">Chunked</span> '<span class="hljs-type">Chunked</span> = '<span class="hljs-type">Chunked</span>
  <span class="hljs-type">CombineCompTy</span> _ _ = '<span class="hljs-type">ByteOnly</span></code></pre><br>
<p>   <code>Statistic</code>    ?   - :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">instance</span> (<span class="hljs-type">Statistic</span> <span class="hljs-title">sa</span> <span class="hljs-title">resa</span> <span class="hljs-title">sta</span> <span class="hljs-title">compa</span>, <span class="hljs-type">Statistic</span> <span class="hljs-title">sb</span> <span class="hljs-title">resb</span> <span class="hljs-title">stb</span> <span class="hljs-title">compb</span>)
       =&gt; <span class="hljs-type">Statistic</span> (<span class="hljs-title">sa</span> '::: <span class="hljs-title">sb</span>) (<span class="hljs-title">resa</span> ::: <span class="hljs-title">resb</span>) (<span class="hljs-title">sta</span> ::: <span class="hljs-title">stb</span>) (<span class="hljs-type">CombineCompTy</span> <span class="hljs-title">compa</span> <span class="hljs-title">compb</span>) <span class="hljs-keyword">where</span></span><font></font>
  initState = initState ::: initState<font></font>
  extractState (a ::: b) = extractState a ::: extractState b<font></font>
  computation =<font></font>
    <span class="hljs-keyword">case</span> (computation :: <span class="hljs-type">StatComputation</span> sta compa, computation :: <span class="hljs-type">StatComputation</span> stb compb) <span class="hljs-keyword">of</span>
         (<span class="hljs-type">ByteOnlyComputation</span> a, <span class="hljs-type">ChunkedComputation</span> b _)<font></font>
            -&gt; <span class="hljs-type">ByteOnlyComputation</span> $ combine a b<font></font>
         (<span class="hljs-type">ChunkedComputation</span> a _, <span class="hljs-type">ByteOnlyComputation</span> b)<font></font>
            -&gt; <span class="hljs-type">ByteOnlyComputation</span> $ combine a b<font></font>
         (<span class="hljs-type">ByteOnlyComputation</span> a, <span class="hljs-type">ByteOnlyComputation</span> b) <font></font>
            -&gt; <span class="hljs-type">ByteOnlyComputation</span> $ combine a b<font></font>
         (<span class="hljs-type">ChunkedComputation</span> stepA chunkA, <span class="hljs-type">ChunkedComputation</span> stepB chunkB)<font></font>
            -&gt; <span class="hljs-type">ChunkedComputation</span> (combine stepA stepB) (combine chunkA chunkB)
    <span class="hljs-keyword">where</span>
      combine fa fb = \(a ::: b) w -&gt; fa a w ::: fb b w</code></pre><br>
<p> ,  <code>sa</code> тАФ     <code>resa</code>,   <code>sta</code>    <code>compa</code>,    <code>sb</code>/<code>resb</code>/<code>stb</code>/<code>compb</code>,   <code>sa ::: sb</code> тАФ  ,     тАФ  <code>resa ::: resb</code>,   тАФ  <code>sta ::: stb</code>,    тАФ  <del>   </del> <code>CombineCompTy compa compb</code>.</p><br>
<p>   ( , ) <code>:::</code>---  ( , ) <code>:::</code>---   . <code>sa</code>  <code>sb</code> тАФ <em></em>,    ,       ()  <em></em>,     тАФ <em></em>,        ()  <em></em>.</p><br>
<p>  ,  тАж      .          .  ,       <code>comp</code>   ,          :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">instance</span> (<span class="hljs-type">Statistic</span> <span class="hljs-title">sa</span> <span class="hljs-title">resa</span> <span class="hljs-title">sta</span> <span class="hljs-title">compa</span>,
          <span class="hljs-type">Statistic</span> <span class="hljs-title">sb</span> <span class="hljs-title">resb</span> <span class="hljs-title">stb</span> <span class="hljs-title">compb</span>,
          <span class="hljs-title">comp</span> ~ <span class="hljs-type">CombineCompTy</span> <span class="hljs-title">compa</span> <span class="hljs-title">compb</span>)
       =&gt; <span class="hljs-type">Statistic</span> (<span class="hljs-title">sa</span> '::: <span class="hljs-title">sb</span>) (<span class="hljs-title">resa</span> ::: <span class="hljs-title">resb</span>) (<span class="hljs-title">sta</span> ::: <span class="hljs-title">stb</span>) comp <span class="hljs-keyword">where</span></span></code></pre><br>
<p>     .</p><br>
<p>   .    :</p><br>
<ol>
<li>          .</li>
<li>       ,       -     .</li>
</ol><br>
<p>,         тАФ     ,    !</p><br>
<p>       ,         <code>CombineCompTy</code> (      ).  ,      ,       (  ),       .</p><br>
<p>       -      , ,   ,   ,    ,      <code>case</code>   .</p><br>
<p>   ?   ,  <code>StatComputation st comp</code>, ,   , <code>comp ~ CombineCompTy compa compb</code>.  ,   <em></em>   <code>compa</code>  <code>compb</code>.    <code>CombineCompTy</code>,   ,   <code>Chunked</code>  <code>compa</code>,  <code>compb</code>,  .</p><br>
<p>    <code>compa</code>  <code>compb</code>?        . ,       <code>computation</code>,      GADT. ,       <code>StatComputation</code>.          <code>ChunkedComputation</code>,   <code>comp</code>     <code>Chunked</code>.     <code>ByteOnlyComputation</code>,     <code>ByteOnly</code>.</p><br>
<p>,     <code>CombineCompTy</code>   <code>_</code>-,      ,        <em></em> <code>compa</code>, <em></em> <code>compb</code>.</p><br>
<p>  ,      : <code>Words '::: Words</code>   ,    . тКд     ,       ,  ,         .</p><br>
<h1 id="ispolzovanie-statistik"> </h1><br>
<p>,    .   ?</p><br>
<p>   ,   <code>Statistic</code>,  <code>ByteString</code>,     .     GADT,   <code>computation</code>.   <code>ChunkedComputation</code>,       .   <code>ByteOnlyComputation</code>,    <code>BS.foldl'</code>.   :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">wc</span> :: <span class="hljs-keyword">forall</span> s res st comp. <span class="hljs-type">Statistic</span> s res st comp =&gt; <span class="hljs-type">BS</span>.<span class="hljs-type">ByteString</span> -&gt; res
<span class="hljs-title">wc</span> s = extractState $! runCompute computation
  <span class="hljs-keyword">where</span>
    runCompute :: <span class="hljs-type">StatComputation</span> st comp -&gt; st<font></font>
    runCompute (<span class="hljs-type">ByteOnlyComputation</span> step) = <span class="hljs-type">BS</span>.foldl' step initState s<font></font>
    runCompute (<span class="hljs-type">ChunkedComputation</span> _ chunker) = chunker initState s</code></pre><br>
<p>    ,         (<code>s</code>, <code>st</code>, <code>comp</code>)       <code>res</code>.   , ,      <code>runCompute</code>,       .    <code>st</code>  <code>comp</code>          <code>wc</code>,    (<em> </em>)  <code>forall</code>   <code>ScopedTypeVariables</code>.</p><br>
<p>            :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">let</span> result = wc someBS :: <span class="hljs-type">Tagged</span> '<span class="hljs-type">Words</span> ::: <span class="hljs-type">Tagged</span> '<span class="hljs-type">Lines</span></code></pre><br>
<p>    <code>TypeApplications</code>      <code>s</code>   :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">let</span> result = wc @('<span class="hljs-type">Words</span> '::: '<span class="hljs-type">Lines</span>) someBS</code></pre><br>
<p>   , ,   ,     ,         .</p><br>
<h2 id="predvaritelnaya-ocenka-proizvoditelnosti">  </h2><br>
<p>   ,        ?</p><br>
<p> ,    <code>wc @'Words</code>,     .    тАФ 1.51 ,  ,     ,      .  ,     .</p><br>
<p>      ?   <code>wc @('Words '::: 'Words)</code>!</p><br>
<p>        .   , ,    ,   тАФ  , тАж   <em></em>: 1.34 .    <code>wc @('Words '::: 'Words '::: 'Words)</code>? 1.30 . ,   <code>'Words</code>  .</p><br>
<p>    тАФ      .        <code>#haskell</code> тАФ      .                .</p><br>
<p>     .    GHC Core тАФ ,   .      ,       ,  ,   - .  ,        тАж -.   ,     ,    ,    .</p><br>
<p>,  ,   .     ,     ?  <code>wc @('Bytes '::: 'Words '::: 'Lines)</code>!      тАФ 1.53 .    1.45 ,     , ,   ,  .</p><br>
<p>,   ,        .   ,      .</p><br>
<h1 id="testirovanie"></h1><br>
<p>   тАФ  !             ,       .</p><br>
<p>,   ,         ,    <code>words</code>,        <code>127</code>.  ,     <em> </em>    ,       .</p><br>
<p>      QuickCheck-,    ASCII,   UTF-8-:</p><br>
<pre><code class="haskell hljs"><span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.ByteString.Char8 <span class="hljs-keyword">as</span> BS
<span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.Text <span class="hljs-keyword">as</span> T
<span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.Text.Encoding <span class="hljs-keyword">as</span> T
<span class="hljs-comment">--   </span><font></font>
<font></font>
<span class="hljs-keyword">import</span> Data.WordCount<font></font>
<font></font>
<span class="hljs-title">wrapUnicode</span> :: <span class="hljs-type">UnicodeString</span> -&gt; (<span class="hljs-type">BS</span>.<span class="hljs-type">ByteString</span>, <span class="hljs-type">T</span>.<span class="hljs-type">Text</span>)
<span class="hljs-title">wrapUnicode</span> ustr = (<span class="hljs-type">T</span>.encodeUtf8 txt, txt)
  <span class="hljs-keyword">where</span>
    txt = <span class="hljs-type">T</span>.pack $ getUnicodeString ustr<font></font>
<font></font>
<span class="hljs-title">replaceNonAsciiSpaces</span> :: <span class="hljs-type">Char</span> -&gt; <span class="hljs-type">Char</span>
<span class="hljs-title">replaceNonAsciiSpaces</span> ch | ch &gt;= chr <span class="hljs-number">127</span> &amp;&amp; isSpace ch = '_'<font></font>
                         | otherwise = ch<font></font>
<font></font>
<span class="hljs-title">main</span> :: <span class="hljs-type">IO</span> ()
<span class="hljs-title">main</span> = hspec $ parallel $ modifyMaxSuccess (const <span class="hljs-number">10000</span>) $ modifyMaxSize (const <span class="hljs-number">1000</span>) $ <span class="hljs-keyword">do</span>
  describe <span class="hljs-string">"ASCII support"</span> $ <span class="hljs-keyword">do</span>
    it <span class="hljs-string">"Counts bytes correctly"</span> $ property $<font></font>
      \(getASCIIString -&gt; str) -&gt; wc @'<span class="hljs-type">Bytes</span> (<span class="hljs-type">BS</span>.pack str) `shouldBe` genericLength str<font></font>
    it <span class="hljs-string">"Counts chars correctly"</span> $ property $<font></font>
      \(getASCIIString -&gt; str) -&gt; wc @'<span class="hljs-type">Chars</span> (<span class="hljs-type">BS</span>.pack str) `shouldBe` genericLength str<font></font>
    it <span class="hljs-string">"Counts words correctly"</span> $ property $<font></font>
      \(getASCIIString -&gt; str) -&gt; wc @'<span class="hljs-type">Words</span> (<span class="hljs-type">BS</span>.pack str) `shouldBe` genericLength (words str)<font></font>
    it <span class="hljs-string">"Counts lines correctly"</span> $ property $<font></font>
      \(getASCIIString -&gt; str) -&gt; wc @'<span class="hljs-type">Lines</span> (<span class="hljs-type">BS</span>.pack str) `shouldBe` genericLength (filter (== '\n') str)<font></font>
  describe <span class="hljs-string">"UTF8 support"</span> $ <span class="hljs-keyword">do</span>
    it <span class="hljs-string">"Counts bytes correctly"</span> $ property $<font></font>
      \(wrapUnicode -&gt; (bs, _))   -&gt; wc @'<span class="hljs-type">Bytes</span> bs `shouldBe` fromIntegral (<span class="hljs-type">BS</span>.length bs)<font></font>
    it <span class="hljs-string">"Counts chars correctly"</span> $ property $<font></font>
      \(wrapUnicode -&gt; (bs, txt)) -&gt; wc @'<span class="hljs-type">Chars</span> bs `shouldBe` fromIntegral (<span class="hljs-type">T</span>.length txt)<font></font>
    it <span class="hljs-string">"Counts words correctly"</span> $ property $<font></font>
      \(wrapUnicode -&gt; (bs, txt)) -&gt; wc @'<span class="hljs-type">Words</span> bs `shouldBe` genericLength (<span class="hljs-type">T</span>.words $ <span class="hljs-type">T</span>.map replaceNonAsciiSpaces txt)<font></font>
    it <span class="hljs-string">"Counts lines correctly"</span> $ property $<font></font>
      \(wrapUnicode -&gt; (bs, txt)) -&gt; wc @'<span class="hljs-type">Lines</span> bs `shouldBe` fromIntegral (<span class="hljs-type">T</span>.count <span class="hljs-string">"\n"</span> txt)</code></pre><br>
<p> !</p><br>
<p>  :</p><br>
<ul>
<li>                    ,       ,      .   , -       UTF-8-            .</li>
<li>            ,   тАж .</li>
<li>   :     10   (  )      3-5     (    ).</li>
</ul><br>
<p>  ,    -     C  GNU Coreutils.</p><br>
<h1 id="obrabotka-opciy-komandnoy-stroki">   </h1><br>
<p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">optparse-applicative</a>.  ,    ,    :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Options</span> = <span class="hljs-type">Options</span></span>
  { countBytes :: <span class="hljs-type">Bool</span>
  , countChars :: <span class="hljs-type">Bool</span>
  , countLines :: <span class="hljs-type">Bool</span>
  , countMaxLineLength :: <span class="hljs-type">Bool</span>
  , countWords :: <span class="hljs-type">Bool</span>
  , files :: [<span class="hljs-type">FilePath</span>]<font></font>
  }<font></font>
<font></font>
<span class="hljs-title">options</span> :: <span class="hljs-type">Parser</span> <span class="hljs-type">Options</span>
<span class="hljs-title">options</span> = <span class="hljs-type">Options</span>
  &lt;$&gt; switch (long <span class="hljs-string">"bytes"</span> &lt;&gt; short 'c' &lt;&gt; help <span class="hljs-string">"print the byte counts"</span>)<font></font>
  &lt;*&gt; switch (long <span class="hljs-string">"chars"</span> &lt;&gt; short 'm' &lt;&gt; help <span class="hljs-string">"print the character counts"</span>)<font></font>
  &lt;*&gt; switch (long <span class="hljs-string">"lines"</span> &lt;&gt; short 'l' &lt;&gt; help <span class="hljs-string">"print the newline counts"</span>)<font></font>
  &lt;*&gt; switch (long <span class="hljs-string">"max-line-length"</span> &lt;&gt; short '<span class="hljs-type">L'</span> &lt;&gt; help <span class="hljs-string">"print the maximum display width"</span>)<font></font>
  &lt;*&gt; switch (long <span class="hljs-string">"words"</span> &lt;&gt; short 'w' &lt;&gt; help <span class="hljs-string">"print the word counts"</span>)<font></font>
  &lt;*&gt; some (argument str (metavar <span class="hljs-string">"FILES..."</span>))</code></pre><br>
<p>  <code>main</code>,           <code>Statistics</code>,  ,     :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">main</span> :: <span class="hljs-type">IO</span> ()
<span class="hljs-title">main</span> = <span class="hljs-keyword">do</span>
  <span class="hljs-type">Options</span> { .. } &lt;- execParser $ info (options &lt;**&gt; helper) (fullDesc &lt;&gt; progDesc <span class="hljs-string">"Print newline, word, and byte counts for each file"</span>)
  <span class="hljs-keyword">let</span> selectedStats = map snd $ filter fst [ (countBytes, <span class="hljs-type">Bytes</span>), (countChars, <span class="hljs-type">Chars</span>)<font></font>
                                           , (countWords, <span class="hljs-type">Words</span>), (countMaxLineLength, <span class="hljs-type">MaxLL</span>)<font></font>
                                           , (countLines, <span class="hljs-type">Lines</span>)<font></font>
                                           ]<font></font>
  <span class="hljs-keyword">let</span> stats | null selectedStats = [<span class="hljs-type">Bytes</span>, <span class="hljs-type">Words</span>, <span class="hljs-type">Lines</span>]<font></font>
            | otherwise = selectedStats</code></pre><br>
<p>      ,         ,       -   .</p><br>
<p>,    .    ?       <em></em>,     <code>wc</code>.  ,    ,       .     !</p><br>
<h2 id="pochti-zavisimye-tipy">  </h2><br>
<p>        ,    ,      ,     ,   -    ,    тАФ  !</p><br>
<p>       ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"></a>,   ,         .</p><br>
<p>  ,        ,       :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">SomeStats</span> where</span>
  <span class="hljs-type">MkSomeStats</span> :: <span class="hljs-type">Statistic</span> s res st comp =&gt; proxy s -&gt; <span class="hljs-type">SomeStats</span></code></pre><br>
<p> <code>proxy s</code> тАФ    <code>Statistic</code>.    тАФ     .</p><br>
<p>        .     ?   - :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">wc'</span> :: <span class="hljs-type">SomeStats</span> -&gt; <span class="hljs-type">BS</span>.<span class="hljs-type">ByteString</span> -&gt; ?
<span class="hljs-title">wc'</span> (<span class="hljs-type">MkSomeStats</span> (_ :: proxy s)) input = wc @s input</code></pre><br>
<p>тАж      <code>?</code>?     ? ,   <code>res</code>    <code>Statistic</code>,      .</p><br>
<p>,   - ?</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">SomeStats</span> where</span>
  <span class="hljs-type">MkSomeStats</span> :: <span class="hljs-type">Statistic</span> s res st comp =&gt; proxy1 s -&gt; proxy2 res -&gt; <span class="hljs-type">SomeStats</span><font></font>
<font></font>
<span class="hljs-title">wc'</span> :: <span class="hljs-type">SomeStats</span> -&gt; <span class="hljs-type">BS</span>.<span class="hljs-type">ByteString</span> -&gt; res
<span class="hljs-title">wc'</span> (<span class="hljs-type">MkSomeStats</span> (_ :: proxy1 s) (_ :: proxy2 res)) input = wc @s input</code></pre><br>
<p>    ,     :     <code>wc'</code>    <code>res</code>,   <code>SomeStats</code>,  .</p><br>
<p>  ?</p><br>
<p>     .        <code>wc</code>,      !  ,     .  ,    ,   , ,       <code>show</code>,     ,  <code>res</code>  <code>Show</code>:</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">SomeStats</span> where</span>
  <span class="hljs-type">MkSomeStats</span> :: (<span class="hljs-type">Statistic</span> s res st comp, <span class="hljs-type">Show</span> res) =&gt; proxy s -&gt; <span class="hljs-type">SomeStats</span></code></pre><br>
<p> <code>wc</code>    :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">wc'</span> :: <span class="hljs-type">SomeStats</span> -&gt; <span class="hljs-type">BS</span>.<span class="hljs-type">ByteString</span> -&gt; <span class="hljs-type">String</span>
<span class="hljs-title">wc'</span> (<span class="hljs-type">MkSomeStats</span> (_ :: proxy s)) input = show $ wc @s input</code></pre><br>
<p>    .</p><br>
<p>,       <code>stats</code>  <code>SomeStats</code>?      :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">promoteStat</span> :: <span class="hljs-type">Statistics</span> -&gt; <span class="hljs-type">SomeStats</span>
<span class="hljs-title">promoteStat</span> <span class="hljs-type">Bytes</span> = <span class="hljs-type">MkSomeStats</span> (<span class="hljs-type">Proxy</span> :: <span class="hljs-type">Proxy</span> '<span class="hljs-type">Bytes</span>)
<span class="hljs-title">promoteStat</span> <span class="hljs-type">Chars</span> = <span class="hljs-type">MkSomeStats</span> (<span class="hljs-type">Proxy</span> :: <span class="hljs-type">Proxy</span> '<span class="hljs-type">Chars</span>)
<span class="hljs-title">promoteStat</span> <span class="hljs-type">Words</span> = <span class="hljs-type">MkSomeStats</span> (<span class="hljs-type">Proxy</span> :: <span class="hljs-type">Proxy</span> '<span class="hljs-type">Words</span>)
<span class="hljs-title">promoteStat</span> <span class="hljs-type">MaxLL</span> = <span class="hljs-type">MkSomeStats</span> (<span class="hljs-type">Proxy</span> :: <span class="hljs-type">Proxy</span> '<span class="hljs-type">MaxLL</span>)
<span class="hljs-title">promoteStat</span> <span class="hljs-type">Lines</span> = <span class="hljs-type">MkSomeStats</span> (<span class="hljs-type">Proxy</span> :: <span class="hljs-type">Proxy</span> '<span class="hljs-type">Lines</span>)</code></pre><br>
<p> ,   ,        <code>Statistics</code>,      .    - :   ,  <em></em> <code>Bytes</code>  () <em></em> <code>'Bytes</code>  ,           ,       .</p><br>
<p>  ,    <code>promoteStat</code>        :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">promoteStats</span> :: [<span class="hljs-type">Statistics</span>] -&gt; <span class="hljs-type">SomeStats</span>
<span class="hljs-title">promoteStats</span> [s] = promoteStat s
<span class="hljs-title">promoteStats</span> (s:ss) =
  <span class="hljs-keyword">case</span> (promoteStat s, promoteStats ss) <span class="hljs-keyword">of</span>
       (<span class="hljs-type">MkSomeStats</span> (_ :: proxy1 st), <span class="hljs-type">MkSomeStats</span> (_ :: proxy2 sst))<font></font>
                                   -&gt; <span class="hljs-type">MkSomeStats</span> (<span class="hljs-type">Proxy</span> :: <span class="hljs-type">Proxy</span> (st '::: sst))</code></pre><br>
<p> ,    ,     <code>promoteStat</code>.</p><br>
<p>        ,    .       :        <code>promoteStat</code>,      <code>promoteStats</code>.    - ,     .      <code>promoteStat</code>  <code>promoteStats</code>,   <em></em> <code>st</code>  ,   ,  <code>sst</code> тАФ  ,  .</p><br>
<p>        ,     <code>Statistic</code> (         ).     <code>Statistic</code>,   <code>st ::: sst</code>  <code>Statistic</code>   -  ,    !  ,  ,  <code>rest</code>  <code>resst</code> (    ,    <code>st</code>  <code>sst</code>)  <code>Show</code>.   ,  <code>rest ::: resst</code>   <code>Show</code>,        <code>st ::: sst</code>!</p><br>
<p>,   ,   <code>MkSomeStats (Proxy :: Proxy (st '::: sst))</code>   .   ,       !</p><br>
<p>,    :       .   ,       ,     <code>NonEmpty</code>      .</p><br>
<p>    ,    :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">main</span> :: <span class="hljs-type">IO</span> ()
<span class="hljs-title">main</span> = <span class="hljs-keyword">do</span>
  <span class="hljs-comment">-- obtaining `stats` as before</span>
  forM_ files $ \path -&gt; <span class="hljs-keyword">do</span><font></font>
    contents &lt;- unsafeMMapFile path<font></font>
    putStrLn $ wc' (promoteStats stats) contents</code></pre><br>
<h3 id="chudesa-proizvoditelnosti"> </h3><br>
<p> ()  ?</p><br>
<p>   ,     1.05  тАФ   ,   <code>BS.count 10</code>.</p><br>
<p>   ,     .    , ,  ? , тАж 14   .</p><br>
<p>, <strong>14 </strong>.</p><br>
<p>, ,     :</p><br>
<pre><code class="plaintext hljs">  74,873,139,008 bytes allocated in the heap</code></pre><br>
<p>        ,       . ,       <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>O</mi><mo stretchy=&quot;false&quot;>(</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.634ex" viewBox="0 -809.3 2043 1134.2" role="img" focusable="false" style="vertical-align: -0.755ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMATHI-4F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-28" x="763" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-31" x="1153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-29" x="1653" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-3">O(1)</script>   тАФ         GC (<code>60,512 bytes maximum residency</code>).</p><br>
<p>. ,     ,  ? <strong>27 </strong>, 120  .</p><br>
<p>  ,   ?  ?</p><br>
<p>   ┬л42 ┬╗,    :   41    194 . , <em></em>    RTS       60 .</p><br>
<p>   ?</p><br>
<p>,     :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">wc'</span> (<span class="hljs-type">MkSomeStats</span> (_ :: proxy s)) input = show $ wc @s input</code></pre><br>
<p> <em></em>    ,  <code>computation</code>     <code>s</code> тАФ   -,    ,     .      ,           <code>Statistic</code>              .</p><br>
<p>    ?</p><br>
<p> <code>wc'</code>     <code>computation</code>,      <code>SomeStats</code>       <code>wc</code>,       <em>   </em>.  ,     ,   ,         .  ,   1.8   тАФ     !</p><br>
<p>                <code>promoteStats</code>.     ?</p><br>
<p>,  <code>stats</code>    ,   </p><br>
<pre><code class="haskell hljs"><span class="hljs-title">promoteStats</span> [s] = promoteStat s</code></pre><br>
<p>  <code>s</code> , , <code>Words</code>,  <code>promoteStat</code>   </p><br>
<pre><code class="haskell hljs"><span class="hljs-title">promoteStat</span> <span class="hljs-type">Words</span> = <span class="hljs-type">MkSomeStats</span> (<span class="hljs-type">Proxy</span> :: <span class="hljs-type">Proxy</span> '<span class="hljs-type">Words</span>)</code></pre><br>
<p>  <code>promoteStats</code>   <code>SomeStats</code>   ,   <code>Statistic</code>  <code>Words</code>.</p><br>
<p>   .  ,      ?</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">promoteStats</span> (s:ss) =
  <span class="hljs-keyword">case</span> (promoteStat s, promoteStats ss) <span class="hljs-keyword">of</span>
         (<span class="hljs-type">MkSomeStats</span> (_ :: proxy1 st), <span class="hljs-type">MkSomeStats</span> (_ :: proxy2 sst)) -&gt; <span class="hljs-type">MkSomeStats</span> (<span class="hljs-type">Proxy</span> :: <span class="hljs-type">Proxy</span> (st '::: sst))</code></pre><br>
<p>    <code>computation</code>    : <code>case</code>        ,   <code>promoteStat</code>    <code>promoteStats</code>, ,  ,    <code>computation</code>  <code>Statistic</code>  ┬л┬╗  <code>sa ::: sb</code>, ,   ,        .</p><br>
<p>       ,     13-14  ,         28  тАФ     .        ,      65-70 .</p><br>
<p>   ,     (    )        .</p><br>
<p>,       .   13  (14     1   -)  1.8   тАФ  ,  7   .  .</p><br>
<h2 id="urodlivyy-podhod"> </h2><br>
<p>           :   ,     ()  <code>wc</code>    .       - </p><br>
<pre><code class="haskell hljs"><span class="hljs-title">main</span> = <span class="hljs-keyword">do</span>
  <span class="hljs-comment">-- ..</span>
  <span class="hljs-keyword">case</span> stats <span class="hljs-keyword">of</span>
       [<span class="hljs-type">Words</span>] -&gt; print $ wc @'<span class="hljs-type">Words</span> contents<font></font>
       [<span class="hljs-type">Bytes</span>] -&gt; print $ wc @'<span class="hljs-type">Bytes</span> contents<font></font>
       [<span class="hljs-type">Lines</span>] -&gt; print $ wc @'<span class="hljs-type">Lines</span> contents<font></font>
       [<span class="hljs-type">Words</span>, <span class="hljs-type">Bytes</span>] -&gt; print $ wc @('<span class="hljs-type">Words</span> '::: '<span class="hljs-type">Bytes</span>) contents<font></font>
       [<span class="hljs-type">Lines</span>, <span class="hljs-type">Bytes</span>] -&gt; print $ wc @('<span class="hljs-type">Lines</span> '::: '<span class="hljs-type">Bytes</span>) contents
       <span class="hljs-comment">-- ...</span></code></pre><br>
<p>  .          ,     ,     <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mn>5</mn></msup><mo>&amp;#x2212;</mo><mn>1</mn><mo>=</mo><mn>31</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.643ex" height="2.634ex" viewBox="0 -970.7 5012.9 1134.2" role="img" focusable="false" style="vertical-align: -0.38ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-32" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-35" x="707" y="557"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-2212" x="1176" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-31" x="2177" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-3D" x="2955" y="0"></use><g transform="translate(4011,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-33"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://habr.com/ru/post/496370/&amp;usg=ALkJrhjBRyztr8XaPZcxzvGbv_zPqjqXXQ#MJMAIN-31" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mn>5</mn></msup><mo>тИТ</mo><mn>1</mn><mo>=</mo><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></mn></math></span></span><script type="math/tex" id="MathJax-Element-4">2^5 - 1 = 31</script>   <code>case</code>. ,     тАФ  .</p><br>
<p>       ,       Template Haskell.   (-) <code>dispatch</code>,    :</p><br>
<pre><code class="haskell hljs">  contents &lt;- unsafeMMapFile path<font></font>
  putStrLn $ $(dispatch 'wc 'contents) stats</code></pre><br>
<p> <code>$(dispatch 'wc 'contents)</code>  ,   <code>case</code>- <code>stats</code>   ,     .</p><br>
<p> <code>dispatch</code> тАФ     Template Haskell,    ,    :</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">dispatch</span> :: <span class="hljs-type">Name</span> -&gt; <span class="hljs-type">Name</span> -&gt; <span class="hljs-type">Q</span> <span class="hljs-type">Exp</span>
<span class="hljs-title">dispatch</span> fun bs = reify ''<span class="hljs-type">Statistics</span> &gt;&gt;= \<span class="hljs-keyword">case</span>
  <span class="hljs-type">TyConI</span> (<span class="hljs-type">DataD</span> _ _ _ _ cons _) -&gt; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">let</span> consNames = [ name | <span class="hljs-type">NormalC</span> name _ &lt;- cons ]
    <span class="hljs-keyword">let</span> powerset = filterM (const [<span class="hljs-type">True</span>, <span class="hljs-type">False</span>]) consNames
    <span class="hljs-keyword">let</span> matches = buildMatch fun bs &lt;$&gt; filter (not . null) powerset<font></font>
    fallbackMatch &lt;- (\body -&gt; <span class="hljs-type">Match</span> <span class="hljs-type">WildP</span> (<span class="hljs-type">NormalB</span> body) []) &lt;$&gt; [e| error <span class="hljs-string">"Unexpected input"</span> |]<font></font>
    pure $ <span class="hljs-type">LamCaseE</span> $ matches &lt;&gt; [fallbackMatch]<font></font>
  _ -&gt; fail <span class="hljs-string">"unsupported type"</span><font></font>
<font></font>
<span class="hljs-title">buildMatch</span> :: <span class="hljs-type">Name</span> -&gt; <span class="hljs-type">Name</span> -&gt; [<span class="hljs-type">Name</span>] -&gt; <span class="hljs-type">Match</span>
<span class="hljs-title">buildMatch</span> fun bs consNames = <span class="hljs-type">Match</span> (<span class="hljs-type">ListP</span> $ (`<span class="hljs-type">ConP</span>` []) &lt;$&gt; consNames) (<span class="hljs-type">NormalB</span> $ <span class="hljs-type">VarE</span> 'show `<span class="hljs-type">AppE</span>` (wcCall `<span class="hljs-type">AppE</span>` <span class="hljs-type">VarE</span> bs)) []
  <span class="hljs-keyword">where</span>
    wcCall = <span class="hljs-type">VarE</span> fun `<span class="hljs-type">AppTypeE</span>` foldr1 f (<span class="hljs-type">PromotedT</span> &lt;$&gt; consNames)<font></font>
    f accTy promotedTy = <span class="hljs-type">PromotedT</span> '(:::) `<span class="hljs-type">AppT</span>` accTy `<span class="hljs-type">AppT</span>` promotedTy</code></pre><br>
<p>  ,       <code>Statistics</code> (, ,      ),        ( ,      <code>powerset</code>)    <code>case</code>-   <code>buildMatch</code>.         -<code>case</code> (  <code>{-# LANGUAGE LambdaCase #-}</code>).</p><br>
<p>,  ,             ,           ,       .</p><br>
<p> ,     (,   TH) тАФ   ,   <code>stats</code>  .      .   ,        </p><br>
<pre><code class="plaintext hljs">  let selectedStats = map snd $ filter fst [ (countBytes, Bytes), (countChars, Chars)<font></font>
                                           , (countWords, Words), (countMaxLineLength, MaxLL)<font></font>
                                           , (countLines, Lines)<font></font>
                                           ]</code></pre><br>
<p> ,     <code>Ord</code>.   ,       <code>stats</code>.    ,      ,     -  <code>stats</code>, ,  .</p><br>
<p>     !</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">main</span> :: <span class="hljs-type">IO</span> ()
<span class="hljs-title">main</span> = <span class="hljs-keyword">do</span>
  <span class="hljs-type">Options</span> { .. } &lt;- execParser $ info (options &lt;**&gt; helper) (fullDesc &lt;&gt; progDesc <span class="hljs-string">"Print newline, word, and byte counts for each file"</span>)
  <span class="hljs-keyword">let</span> selectedStats = map snd $ filter fst [ (countBytes, <span class="hljs-type">Bytes</span>), (countChars, <span class="hljs-type">Chars</span>)<font></font>
                                           , (countWords, <span class="hljs-type">Words</span>), (countMaxLineLength, <span class="hljs-type">MaxLL</span>)<font></font>
                                           , (countLines, <span class="hljs-type">Lines</span>)<font></font>
                                           ]<font></font>
  <span class="hljs-keyword">let</span> stats | null selectedStats = [<span class="hljs-type">Bytes</span>, <span class="hljs-type">Words</span>, <span class="hljs-type">Lines</span>]<font></font>
            | otherwise = selectedStats<font></font>
  forM_ files $ \path -&gt; <span class="hljs-keyword">do</span><font></font>
    contents &lt;- unsafeMMapFile path<font></font>
    putStrLn $ $(dispatch 'wc 'contents) stats</code></pre><br>
<h3 id="okonchatelnaya-proizvoditelnost"> </h3><br>
<p>    ?        (31  тАФ  ),   -   .  ,       <code>wc</code>  GNU Coreutils     ,       -.    ,   :    5      1.8 ,      . <code>wc</code>  Coreutils     <code>LC_ALL=C LANG=C</code>,    .</p><br>
<p> :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
<th> </th>
<th>Haskell <code>wc</code>, </th>
<th>Coreutils <code>wc</code>, </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>тЬУ</td>
<td></td>
<td></td>
<td></td>
<td>0.00 ┬╣</td>
<td>0.00 ┬╣</td>
</tr>
<tr>
<td>тЬУ</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>1.54</td>
<td>12.5</td>
</tr>
<tr>
<td>тЬУ</td>
<td>тЬУ</td>
<td></td>
<td></td>
<td></td>
<td>1.20</td>
<td>12.5</td>
</tr>
<tr>
<td></td>
<td></td>
<td>тЬУ</td>
<td></td>
<td></td>
<td>1.06 / 0.24 ┬▓</td>
<td>0.26</td>
</tr>
<tr>
<td>тЬУ</td>
<td>тЬУ</td>
<td>тЬУ</td>
<td></td>
<td></td>
<td>1.52</td>
<td>12.5</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>тЬУ</td>
<td></td>
<td>1.42</td>
<td>8.45 ┬│</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>тЬУ</td>
<td>2.21</td>
<td>12.5</td>
</tr>
<tr>
<td>тЬУ</td>
<td></td>
<td></td>
<td></td>
<td>тЬУ</td>
<td>2.92</td>
<td>12.5</td>
</tr>
</tbody>
</table></div><br>
<p>   :</p><br>
<ul>
<li>    ,    <em></em>  ,     .</li>
<li>,    C       (, ,     )     ,    .   .</li>
<li>┬╣ , <code>time</code>   <code>0.00user</code>       .</li>
<li>┬▓        (1.06 ) тАФ     <code>bytestring</code>.   тАФ   <code>bytestring</code>,       (<code>count</code>)    SIMD-.     <code>count</code>   C, ,   ,       ,          (    ,      SIMD),         .</li>
<li>┬│  <code>wc</code>   UTF-8-,     ,      ,     ,        UTF-8-.</li>
</ul><br>
<p>  ,    .</p><br>
<h1 id="vsyakie-melochi"> </h1><br>
<p>      ,     ,   <code>wc</code>,     .    ?</p><br>
<h2 id="parallelizm"></h2><br>
<p> :    <code>forM_</code>  <code>forConcurrently_</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">async</a>:</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">main</span> :: <span class="hljs-type">IO</span> ()
<span class="hljs-title">main</span> = <span class="hljs-keyword">do</span>
  <span class="hljs-type">Options</span> { .. } &lt;- execParser $ info (options &lt;**&gt; helper) (fullDesc &lt;&gt; progDesc <span class="hljs-string">"Print newline, word, and byte counts for each file"</span>)
  <span class="hljs-keyword">let</span> selectedStats = map snd $ filter fst [ (countBytes, <span class="hljs-type">Bytes</span>), (countChars, <span class="hljs-type">Chars</span>)<font></font>
                                           , (countWords, <span class="hljs-type">Words</span>), (countMaxLineLength, <span class="hljs-type">MaxLL</span>)<font></font>
                                           , (countLines, <span class="hljs-type">Lines</span>)<font></font>
                                           ]<font></font>
  <span class="hljs-keyword">let</span> stats | null selectedStats = [<span class="hljs-type">Bytes</span>, <span class="hljs-type">Words</span>, <span class="hljs-type">Lines</span>]<font></font>
            | otherwise = selectedStats<font></font>
  forConcurrently_ files $ \path -&gt; <span class="hljs-keyword">do</span><font></font>
    contents &lt;- unsafeMMapFile path<font></font>
    putStrLn $ $(dispatch 'wc 'contents) stats</code></pre><br>
<p>       ,      (,      RTS,       ).      ,          <code>-j</code>,            .</p><br>
<p>   ?</p><br>
<p>         1.22  тАФ    ,         .</p><br>
<p>     ,        (      ),      1.47 ,      . ,         .</p><br>
<h2 id="krasivaya-pechat"> </h2><br>
<p>     ,      </p><br>
<pre><code class="haskell hljs"><span class="hljs-type">Tagged</span> <span class="hljs-number">123</span> ::: (<span class="hljs-type">Tagged</span> <span class="hljs-number">456</span> ::: <span class="hljs-type">Tagged</span> <span class="hljs-number">789</span>)</code></pre><br>
<p>     ,     !        <code>Statistic</code>:</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Statistic</span> s res st comp | res -&gt; s, st -&gt; s
                              , s -&gt; res, s -&gt; st, s -&gt; comp <span class="hljs-keyword">where</span></span>
  <span class="hljs-comment">-- ...</span>
  prettyPrint :: res -&gt; <span class="hljs-type">String</span></code></pre><br>
<p>     , :</p><br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">Statistic</span> '<span class="hljs-type">Bytes</span> (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Bytes</span>) (<span class="hljs-type">Tagged</span> '<span class="hljs-type">Bytes</span>) '<span class="hljs-type">Chunked</span> <span class="hljs-keyword">where</span></span>
  <span class="hljs-comment">-- ...</span>
  prettyPrint (<span class="hljs-type">Tagged</span> n) = show n &lt;&gt; <span class="hljs-string">" bytes"</span></code></pre><br>
<p>     ,    :</p><br>
<pre><code class="haskell hljs">  prettyPrint (a ::: b) = prettyPrint a &lt;&gt; <span class="hljs-string">"\n"</span> &lt;&gt; prettyPrint b</code></pre><br>
<p>      <code>buildMatch</code>,    <code>prettyPrint</code>  <code>show</code>:</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">buildMatch</span> fun bs consNames = <span class="hljs-type">Match</span> (<span class="hljs-type">ListP</span> $ (`<span class="hljs-type">ConP</span>` []) &lt;$&gt; consNames) (<span class="hljs-type">NormalB</span> $ <span class="hljs-type">VarE</span> 'prettyPrint `<span class="hljs-type">AppE</span>` (wcCall `<span class="hljs-type">AppE</span>` <span class="hljs-type">VarE</span> bs)) []</code></pre><br>
<p> !</p><br>
<h2 id="bolshe-vidov-vhodnyh-dannyh">   </h2><br>
<p>    ,      <code>mmap</code>. ,    : ,      <code>hwc &lt;(cat foo | grep bar)</code>.</p><br>
<p>  , ,         тАФ - <code>mmap</code> .         <code>mmap</code>    .        <em></em> <code>ByteString</code>,       .   <code>ByteString</code> тАФ     ,            :</p><br>
<pre><code class="haskell hljs"><span class="hljs-keyword">import</span> <span class="hljs-keyword">qualified</span> Data.ByteString.Lazy <span class="hljs-keyword">as</span> BSL<font></font>
<font></font>
<span class="hljs-title">wcLazy</span> :: <span class="hljs-keyword">forall</span> s res st comp. <span class="hljs-type">Statistic</span> s res st comp =&gt; <span class="hljs-type">BSL</span>.<span class="hljs-type">ByteString</span> -&gt; res
<span class="hljs-title">wcLazy</span> s = extractState $! runCompute computation
  <span class="hljs-keyword">where</span>
    runCompute :: <span class="hljs-type">StatComputation</span> st comp -&gt; st<font></font>
    runCompute (<span class="hljs-type">ByteOnlyComputation</span> step) = <span class="hljs-type">BSL</span>.foldl' step initState s<font></font>
    runCompute (<span class="hljs-type">ChunkedComputation</span> _ chunker) = <span class="hljs-type">BSL</span>.foldlChunks chunker initState s</code></pre><br>
<p>     <code>main</code>:</p><br>
<pre><code class="haskell hljs">  forConcurrently_ files $ \path -&gt; <span class="hljs-keyword">do</span><font></font>
    stat &lt;- getFileStatus path<font></font>
    <span class="hljs-keyword">if</span> isRegularFile stat || isSymbolicLink stat
      <span class="hljs-keyword">then</span> countStrict stats $ unsafeMMapFile path
      <span class="hljs-keyword">else</span> countLazy stats $ <span class="hljs-type">BSL</span>.readFile path</code></pre><br>
<p>      :</p><br>
<pre><code class="haskell hljs">  <span class="hljs-keyword">where</span>
    countStrict stats act = <span class="hljs-keyword">do</span><font></font>
      contents &lt;- act<font></font>
      putStrLn $ $(dispatch 'wc 'contents) stats<font></font>
    countLazy stats act = <span class="hljs-keyword">do</span><font></font>
      contents &lt;- act<font></font>
      putStrLn $ $(dispatch 'wcLazy 'contents) stats</code></pre><br>
<p> !</p><br>
<p>,        <code>wcLazy</code>       ,    ,           ,     .</p><br>
<h2 id="podderzhka-stdin"> stdin</h2><br>
<p>  ,   Coreutils <code>wc</code>,      тАФ  <code>stdin</code>.   ,     <code>main</code>:</p><br>
<pre><code class="haskell hljs"><span class="hljs-title">main</span> = <span class="hljs-keyword">do</span>
  <span class="hljs-comment">-- ... as before ...</span><font></font>
<font></font>
  when (null files) $ countLazy stats <span class="hljs-type">BSL</span>.getContents</code></pre><br>
<p>   - </p><br>
<pre><code class="plaintext hljs">cat testfile.txt | /usr/bin/time hwc-exe -cw</code></pre><br>
<p>       ? , ,     1.40  тАФ  ,   1.22     .</p><br>
<h2 id="vremya-kompilyacii-i-raspuhanie-koda">    </h2><br>
<p>   ,       - :     ?       ,     ,       !</p><br>
<p>    ┬л ┬╗  (   -     ),  <code>stack build</code>  7.9    ,       2.24  ( <code>strip</code>).</p><br>
<p>  Template Haskell    : 23 .   ,      (  31   ):    2.34 ,  тАФ 4.3%.</p><br>
<p>тАж        <code>stack build</code> (     ). <code>stack build --fast</code>    .</p><br>
<p>┬л ┬╗    5.6   <code>--fast</code>,     TH  тАж 7.8 .        .    .</p><br>
<p>  ,        ,              C.   ,    :    <code>wc</code>  GNU Coreutils   0.06 ,     тАФ 21 .  <code>wc</code>    24 .  100  ,  !</p><br>
<p>,         ,        .</p><br>
<h1 id="zaklyuchenie"></h1><br>
<p>   ?  ,       <code>wc</code>  ,      Unix-,    -<code>wc</code>   ,    GNU Coreutils <code>wc</code>.   тАФ     (   !),  ,     ,       ,       . ,   -           ┬л   ,   ┬╗,      C  C++,      C.</p><br>
<p>  ,  :</p><br>
<ol>
<li>    <code>wc</code>   , ,    ,    ;</li>
<li>    ;</li>
<li>     ,  ,            ;</li>
<li>   ,   ,  ,   ,  ,              ;</li>
<li>           Template Haskell;</li>
<li>,            ,           ;</li>
<li>    ,        .</li>
</ol><br>
<p> .</p><br>
<p>,       :</p><br>
<ol>
<li>       .   , ,       ,    16-32  (   L1).  ,       7 ,          1.8       0.4 ,  0.04%.         Template Haskell!</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдорд╛рд░рд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЕрднреА рднреА рдкреВрд░реНрдг рд╕рдордХрдХреНрд╖ рдирд╣реАрдВ рд╣реИ </font></font><code>wc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рдпрд╣ рдХреБрдЫ рдЕрд▓рдЧ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╡рд░реНрдг рдЧрдгрдирд╛ рдЖрдБрдХрдбрд╝реЗ UTF-8 рдпрд╛ ASCII рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдЕрдиреНрдп рдПрдиреНрдХреЛрдбрд┐рдВрдЧ рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рдЬрдмрдХрд┐ рдпрд╣ </font></font><code>wc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рдордирдорд╛рдиреЗ рд╕реНрдерд╛рди рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдЬреЛ glibc рд╡рд░реНрдгреЛрдВ рдХреЗ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рднреА рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд▓реЗрдХрд┐рди рдЪреВрдВрдХрд┐ рд╣рдорд╛рд░рд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдирдП рдЖрдБрдХрдбрд╝реЛрдВ рдХреЛ рдЬреЛрдбрд╝рдирд╛ рдмрд╣реБрдд рдЖрд╕рд╛рди рдмрдирд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕ рддрд░рд╣ рдХреА рдЪреАрдЬрд╝реЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдерди рдЬреЛрдбрд╝рдирд╛ рдХрд╛рдлреА рд╕рд░рд▓ рд╣реИ, рдФрд░ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐, рдпрд╣, рд▓рд╛рдЗрдиреЛрдВ рдпрд╛ рд╢рдмреНрджреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреА рдЧрдгрдирд╛ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ред </font><font style="vertical-align: inherit;">рд▓реЗрдХрд┐рди "рдЖрдк рдЬреЛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ рдЙрд╕рдХреЗ рд▓рд┐рдП рднреБрдЧрддрд╛рди рди рдХрд░реЗрдВ" рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ, рдореИрдВрдиреЗ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдереЛрдбрд╝рд╛ рдЕрдзрд┐рдХ рд▓рд┐рдЦрд╛ рдерд╛ред</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi496358/index.html">рдХреЙрд╕реНрдореЛрдиреЙрдЯрд┐рдХреНрд╕ рдбреЗ рдХреЛ рдСрдирд▓рд╛рдЗрди рдордирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реЛрдирд╛ (рд╕реВрдЪреА рдЕрдкрдбреЗрдЯ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ)</a></li>
<li><a href="../hi496360/index.html">BFCache, рдпрд╛ рд╡рд╣рд╛рдБ рдФрд░ рд╡рд╛рдкрд╕ред рдпреИрдВрдбреЗрдХреНрд╕ рд░рд┐рдкреЛрд░реНрдЯ</a></li>
<li><a href="../hi496362/index.html">рдорд╛рд╕реНрдХ рд░реАрд╕реЗрдЯ</a></li>
<li><a href="../hi496366/index.html">рдорд┐рдиреАрд╕рд░реАрдЬ: рдбреВ-рдЗрдЯ-рдпреЛрд░ рдЯрд░реНрдиреЗрд░реА рдХрдВрдкреНрдпреВрдЯрд░</a></li>
<li><a href="../hi496368/index.html">рдСрд╕реНрдЯреНрд░реЗрд▓рд┐рдпрд╛рдИ рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдЗрд▓реЗрдХреНрдЯреНрд░реЙрдирд┐рдХ рдФрд░ рдЬреИрд╡рд┐рдХ рдШрдЯрдХреЛрдВ рд╕реЗ рд╣рд╛рдЗрдмреНрд░рд┐рдб рдкреАрд╕реА рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддрд╛ рд╣реИ</a></li>
<li><a href="../hi496372/index.html">рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдЕрд▓рд░реНрдЯ (), рдкреБрд╖реНрдЯрд┐рдХрд░рдг () рдФрд░ рд╢реАрдШреНрд░ () рдХреЗ рд▓рд┐рдП рдПрдХ рдХрд╕реНрдЯрдо рджреГрд╢реНрдп рдХреИрд╕реЗ рдмрдирд╛рдПрдВ</a></li>
<li><a href="../hi496376/index.html">рдЪреМрдХрдбрд╝реА 9: рдПрд▓реЗрдЧреНрд░реЛ | рд╕рд╛рджрдЧреА рдФрд░ рд╕рд░рд▓рддрд╛</a></li>
<li><a href="../hi496380/index.html">VMware vCloud рдЙрдкрд▓рдмреНрдзрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрд┐рдЬрд╛рд╕реНрдЯрд░ рд░рд┐рдХрд╡рд░реА рдФрд░ рдорд╛рдЗрдЧреНрд░реЗрд╢рдиред рднрд╛рдЧ 2</a></li>
<li><a href="../hi496384/index.html">рд╕рдВрдЧреГрд╣реАрдд рдЖрдИрдЯреА рд▓реЛрдЧ: рд╡рд┐рднрд┐рдиреНрди рджреЗрд╢реЛрдВ рдХреЗ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдЕрдиреБрднрд╡</a></li>
<li><a href="../hi496386/index.html">рд╕реНрдкреНрд░рд┐рдВрдЧ, рд░реЗрд╕реНрдЯ рдПрдкреАрдЖрдИ рдХреЗ рдкрд╣рд▓реЗ рдЪрд░рдг, рдкреАрдпреВрдЯреА рдкрд░ рдлреНрд░рдВрдЯрдПрдВрдб рдХреЗ рд╕рд╛рде рд╕рдВрдпреЛрдЬрди рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>