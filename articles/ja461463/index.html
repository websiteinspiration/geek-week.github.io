<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛑 🤒 🛩️ 企業のビジネスプロセス：憶測と現実。Rで光を当てる 📛 🏸 🐉</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="「デジタルツイン」の概念への関心が高まっている状況でのビジネスプロセスマイニングに関する簡単な記事。このトピックは定期的に出現するため、ソリューションへのアプローチを共有することが適切だと思います。
 問題の定式化
 

状況は非常に単純です。 
 

- X社（Y、Z、...）があります。 
- ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>企業のビジネスプロセス：憶測と現実。Rで光を当てる</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461463/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「デジタルツイン」の概念への関心が高まっている状況でのビジネスプロセスマイニングに関する簡単な記事。</font><font style="vertical-align: inherit;">このトピックは定期的に出現するため、ソリューションへのアプローチを共有することが適切だと思います。</font></font></p><br>
<h1 id="postanovka-zadachi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題の定式化</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状況は非常に単純です。 </font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X社（Y、Z、...）があります。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同社には、さまざまなITシステムによって自動化されたビジネスプロセスがあります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらのプロセスのbpmn図を描いたビジネスアナリストがいます。</font><font style="vertical-align: inherit;">より具体的には、これらのプロセスがどのように見えるべきかについての彼ら自身の「bpmnアイデア」。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスユーザーは、これらのプロセスに関する何らかのプレゼンテーション（KPI）を望んでいます。</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">真実に到達し、これらのメトリックを数える方法は？</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">までの刊行物の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">続きです</font><font style="vertical-align: inherit;">。</font></font><a name="habracut"></a></p><br>
<h1 id="formuliruem-zadachu-v-ponyatnyh-dlya-kompyutera-trebovaniyah"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンピュータにやさしい要件でタスクを定式化します</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本的な仮定：</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">純度、完全性、整合性の程度が異なる一時的なイベントログ（ITシステムのさまざまなログ、cdr \ xdr、データベース内のイベントのレコードのみ）があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ITシステムはステートマシンとして機能し、ユーザーのアクションとプログラマーが定めたビジネスロジックに従って、さまざまな状態の間を「ウォーク」します。</font></font></li>
<li>     .</li>
</ul><br>
<p>  :</p><br>
<ul>
<li>      ,  bpmn  -       .</li>
<li>     (,  ).</li>
<li>""   .      ,         .</li>
<li>     <strong>--  </strong>.</li>
</ul><br>
<h1 id="reshenie-postavil-poschital"> "-"</h1><br>
<p>    :</p><br>
<ul>
<li> ;</li>
<li>  -;</li>
<li> ;</li>
<li>   human-readable .</li>
</ul><br>
<p>       .        R.       .   .</p><br>
<p>     R      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">bupaR</a>.        .            (  —  ).<br>
      .</p><br>
<h1 id="dobavlyaem-skorosti"> !</h1><br>
<h2 id="emuliruem-vhodnoy-nabor-dannyh">   </h2><br>
<p>        .      .    ,     .         , -,  ,   ..</p><br>
<ul>
<li>    (,   ).</li>
<li>    (pos ).</li>
<li>    ,   — .</li>
<li>       -     .</li>
<li> pos              .</li>
<li>  , ,    ( , ).</li>
<li>  .</li>
</ul><br>
<p>    -:</p><br>
<pre><code class="plaintext hljs">  "INIT-REQUEST-RESPONSE-SUCCESS"<font></font>
  "INIT-REQUEST-RESPONSE-ERROR"<font></font>
  "INIT-REQUEST-RESPONSE-DEFFERED"<font></font>
  "INIT-REQUEST"<font></font>
  "INIT"</code></pre><br>
<p>     ,          (      <strong>     </strong>      ).</p><br>
<p>    :</p><br>
<ul>
<li>    <code>tidyverse</code>     ;</li>
<li>        .</li>
</ul><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="plaintext hljs">library(tidyverse)<font></font>
library(datapasta)<font></font>
library(tictoc)<font></font>
library(data.table)<font></font>
library(stringi)<font></font>
library(anytime)<font></font>
library(rTRNG)<font></font>
<font></font>
data.table::setDTthreads(0) #      data.table<font></font>
data.table::getDTthreads() #    <font></font>
<font></font>
set.seed(46572)<font></font>
RcppParallel::setThreadOptions(numThreads = parallel::detectCores() - 1)<font></font>
<font></font>
#   --   -,    <font></font>
#  5   -, 2  --  <font></font>
bo_pattern &lt;- tibble::tribble(<font></font>
  #  ,    ,   <font></font>
  ~pattern, ~prob, ~mean_duration,<font></font>
  "INIT-REQUEST-RESPONSE-SUCCESS", 0.7, 5,<font></font>
  "INIT-REQUEST-RESPONSE-ERROR", 0.15, 5,<font></font>
  "INIT-REQUEST-RESPONSE-DEFFERED", 0.07, 8,<font></font>
  "INIT-REQUEST", 0.05, 2,<font></font>
  "INIT", 0.03, 0.5<font></font>
)<font></font>
<font></font>
#    +    <font></font>
checkmate::assertTRUE(sum(bo_pattern$prob) == 1)<font></font>
df &lt;- bo_pattern %&gt;%<font></font>
  separate_rows(pattern) %&gt;%<font></font>
  #  <font></font>
  mutate(coeff = sum(prob)) %&gt;%<font></font>
  group_by(pattern) %&gt;%<font></font>
  #   <font></font>
  summarise(event_prob = sum(prob/coeff)*100) %&gt;%<font></font>
  ungroup()<font></font>
checkmate::assertTRUE(sum(df$event_prob) == 100)<font></font>
<font></font>
#   3  :  (4 ),  (12 ),  (30 )<font></font>
df1 &lt;- tribble(<font></font>
  ~type, ~n_pos, ~n_store,<font></font>
  "small", 4, 10,<font></font>
  "medium", 12, 5,<font></font>
  "large", 30, 2<font></font>
) %&gt;%<font></font>
  #      <font></font>
  mutate(store = map2(row_number(), n_store, <font></font>
                       ~sample(x =  .x * 1000 + 1:.y, size = .y, replace = FALSE))) %&gt;%<font></font>
  unnest(store) %&gt;%<font></font>
  #      <font></font>
  mutate(pos = map(n_pos, ~sample(x = .x, size = .x, replace = FALSE))) %&gt;%<font></font>
  unnest(pos) %&gt;%<font></font>
  mutate(pattern = sample(bo_pattern$pattern, n(), replace = TRUE, prob = bo_pattern$prob))<font></font>
<font></font>
tic("Generate transactions")<font></font>
#     ,     <font></font>
#         ,      <font></font>
df2 &lt;- df1 %&gt;%<font></font>
  #        <font></font>
  select(-matches("duration")) %&gt;%<font></font>
  left_join(bo_pattern, by = "pattern") %&gt;%<font></font>
  #  <font></font>
  sample_frac(size = 200, replace = TRUE) %&gt;%<font></font>
  mutate(duration = rnorm(n(), mean = mean_duration, sd = mean_duration * .25)) %&gt;%<font></font>
  select(-prob, -mean_duration) %&gt;%<font></font>
  #   ,      &gt; <font></font>
  #    30 <font></font>
  filter(duration &gt; 0.5 &amp; duration &lt; 30) %&gt;%<font></font>
  #    POS      <font></font>
  mutate(session_id = row_number()) %&gt;%<font></font>
  #     ,      <font></font>
  separate_rows(pattern) %&gt;%<font></font>
  rename(event = pattern)<font></font>
toc()  <font></font>
<font></font>
tic("Generate time markers, data.table way")  <font></font>
samples_tbl &lt;- data.table::as.data.table(df2) %&gt;%<font></font>
  # setkey(session_id, duration, physical = FALSE) %&gt;%  <font></font>
  #          <font></font>
  # 1-       , ,      5 <font></font>
  # .[, ticks := base::sort(runif(.N, 5, 5 + duration)), by = .(session_id, duration)] %&gt;%<font></font>
  #          match.arg   base::order!!<font></font>
  #    <font></font>
  #       0  1     <font></font>
  #    <font></font>
  # .[, tshift := runif(.N, 0, 1)] %&gt;%<font></font>
  #    trng     (    )<font></font>
  # ,          <font></font>
  .[, trand := runif_trng(.N, 0, 1, parallelGrain = 100L) * duration] %&gt;%<font></font>
  #      ,     <font></font>
  # .[, ticks := sort(tshift), by = .(session_id)] %&gt;%<font></font>
  #  ,     session_id,   ,    <font></font>
  .[, t_idx := session_id + trand / max(trand)/10] %&gt;%<font></font>
  #        <font></font>
  # session_id            . <font></font>
  .[, tshift := (sort(t_idx) - session_id) * 10 * max(trand)] %&gt;%<font></font>
  #   ,     POS     (60 )<font></font>
  .[event == "INIT", tshift := tshift + runif_trng(.N, 0, 60, parallelGrain = 100L)] %&gt;%<font></font>
  #    <font></font>
  .[, `:=`(duration = NULL, trand = NULL, t_idx = NULL,<font></font>
           n_store = NULL, n_pos = NULL,<font></font>
           timestamp = as.numeric(anytime("2019-03-11 08:00:00 MSK")))] %&gt;%<font></font>
  #     ,   01.03.2019    <font></font>
  .[, timestamp := timestamp + cumsum(tshift), by = .(store, pos)] %&gt;%<font></font>
  #     <font></font>
  .[timestamp &lt;= as.numeric(anytime("2019-04-11 23:00:00 MSK")), ] %&gt;%<font></font>
  #          <font></font>
  .[, timestamp := anytime(timestamp, tz = "Europe/Moscow")] %&gt;%<font></font>
  as_tibble() %&gt;%<font></font>
  select(store, pos, event, timestamp, session_id)<font></font>
toc()</code></pre></div></div><br>
<p>         .           (   ),       .</p><br>
<pre><code class="plaintext hljs">#  <font></font>
log_tbl &lt;- samples_tbl %&gt;%<font></font>
  select(store, pos, state = event, timestamp_msk = timestamp) %&gt;%<font></font>
  sample_n(n())<font></font>
<font></font>
#  <font></font>
log_tbl %&gt;%<font></font>
  mutate(timegroup = lubridate::ceiling_date(timestamp_msk, unit = "10 mins")) %&gt;%<font></font>
  ggplot(aes(timegroup)) +<font></font>
  # geom_bar(width = 0.7*600) +<font></font>
  geom_bar(colour = "white", size = 1.3) +<font></font>
  theme_bw()</code></pre><br>
<p><img src="https://habrastorage.org/webt/lu/ik/kz/luikkzek29sujmfr3ggbbiabuh8.png"></p><br>
<p>   </p><br>
<p><img src="https://habrastorage.org/webt/3g/i1/j3/3gi1j3yiclbsbu-knj8vuv7cas4.png" alt="オリジナルの `data.frame`での計算"></p><br>
<p>   <br>
<img src="https://habrastorage.org/webt/5h/rw/uu/5hrwuuvmrqcgbsretr65g98epyy.png" alt="`bupaR`を使用した視覚化"></p><br>
<p>   ,     (   ),  <code>bupaR::process_map</code>   ,     ,     ,    .</p><br>
<h2 id="rekonstrukciya-tranzakciy"> </h2><br>
<p>,   ,   \\  ,     .     100    ,    — .           ( ,     )      . </p><br>
<p>        .</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="plaintext hljs">clean_dt &lt;- as.data.table(log_tbl) %&gt;%<font></font>
  #     INIT<font></font>
  .[, start := (state == "INIT")] %&gt;%<font></font>
  #  session_id      , <font></font>
  #            <font></font>
  .[, event_date := lubridate::as_date(timestamp_msk)] %&gt;%<font></font>
  .[, date_str := format(.BY[[1]], "%y%m%d"), by = event_date] %&gt;%<font></font>
  #           <font></font>
  # timestamp_msk   <font></font>
  setorder(store, pos, timestamp_msk) %&gt;%<font></font>
  #     --             <font></font>
  .[, session_id := paste(date_str, store, pos, cumsum(start), sep = "_")] %&gt;%<font></font>
  #        ( 30 )<font></font>
  # .[, time_shift := timestamp_msk - shift(timestamp_msk), by = .(store, pos)] %&gt;%<font></font>
  #        ,   INIT<font></font>
  .[, time_locf := cummax(as.numeric(timestamp_msk) * as.numeric(start)), by = .(store, pos)] %&gt;%<font></font>
  .[, time_shift := as.numeric(timestamp_msk) - time_locf] %&gt;%<font></font>
  #   ,       30 <font></font>
  .[, lost_chain := time_shift &gt; 30] %&gt;%<font></font>
  # .[, time_shift := as.numeric(!start) * as.numeric(timestamp_msk - shift(timestamp_msk, fill = 0))] %&gt;%<font></font>
  # INIT   <font></font>
  # .[, time_accu := cumsum(time_shift)] %&gt;%<font></font>
  .[, date_str := NULL]<font></font>
<font></font>
#         <font></font>
#    tidyverse  ,     <font></font>
dt &lt;- as.data.table(clean_dt) %&gt;%<font></font>
  #     !!!<font></font>
  .[lost_chain != TRUE] %&gt;%<font></font>
  #        1-   <font></font>
  .[order(timestamp_msk, store, pos)] %&gt;%<font></font>
  .[, bp_pattern := stri_join(state, collapse = "-"), by = session_id]<font></font>
<font></font>
#    <font></font>
as_tibble(dt) %&gt;%<font></font>
  distinct(session_id, bp_pattern) %&gt;%<font></font>
  count(session_id, sort = TRUE)</code></pre></div></div><br>
<p>      -.</p><br>
<p> (   !!!)   ,      -     (   ),    -.    " "     .</p><br>
<h1 id="aktivno-primenyaem-tryuki">  </h1><br>
<p>          .      .     ,      .</p><br>
<p> ,      :</p><br>
<ol>
<li>    <code>data.table</code> (,   ), +    .</li>
<li><code>POSIXct</code>    (    ,      <code>options(digits.secs=X)</code>),   ,     .</li>
<li>    !          .</li>
<li>   .   ,      ( ,     ).</li>
<li>   ,     .</li>
<li> locf (Last Observation Carried Forward)  .        <code>cumsum</code>, <code>cummax</code>.</li>
<li> ,    POSIX -&gt; ,     ..   ,   .          .</li>
<li>   ( .. ).</li>
<li>  . , <code>stri_c</code>     <code>paste0</code>.</li>
</ol><br>
<pre><code class="plaintext hljs">#  1<font></font>
log &lt;- getLog(fileName)<font></font>
<font></font>
bench::mark(<font></font>
  paste0 = paste0(log$value, collapse = "\n"),<font></font>
  stringi = stri_c(log$value, collapse = "\n")<font></font>
)<font></font>
# # A tibble: 2 x 13<font></font>
#   expression    min median `itr/sec` mem_alloc `gc/sec` n_itr  n_gc total_time<font></font>
#   &lt;bch:expr&gt; &lt;bch:&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt;   &lt;bch:tm&gt;<font></font>
# 1 paste0       58ms 59.1ms      16.9     496KB        0     9     0      533ms<font></font>
# 2 stringi    16.9ms 17.5ms      57.1        0B        0    29     0      508ms</code></pre><br>
<p>  — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    json</a>.</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461453/index.html">バイコヌールの冒険：ロケット、宇宙飛行士、ユニオンMS-13の打ち上げ、宇宙インターネット</a></li>
<li><a href="../ja461455/index.html">Habr Weekly＃11 /なぜ今大学が必要なのか、「本当の」仕事とは何か、Galaxy Foldが確定</a></li>
<li><a href="../ja461457/index.html">Steamでのゲームの成功を予測できる要因は何ですか？</a></li>
<li><a href="../ja461459/index.html">幸せなシステム管理者の日</a></li>
<li><a href="../ja461461/index.html">バックアップはクラウド時代に成功していますが、テープリールを忘れることはありません。Veeamとの会話</a></li>
<li><a href="../ja461465/index.html">測定ガイド</a></li>
<li><a href="../ja461467/index.html">Goアプリケーション用のMakefileの作成例</a></li>
<li><a href="../ja461469/index.html">1000ワード/分でコードを聞くのはどうですか</a></li>
<li><a href="../ja461473/index.html">グラフのアルゴリズムのデバッグ-写真付き</a></li>
<li><a href="../ja461475/index.html">Habr。1011によるAMA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>