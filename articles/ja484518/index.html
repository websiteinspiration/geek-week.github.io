<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤳 🐪 🚼 PHPを使用してDVRIP経由でカメラからビデオを取得します 💆🏾 👩🏿‍🤝‍👩🏻 👵🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="では前の記事、私はカメラからの映像を引っ張るスクリプトを表示することを約束して、一定の時間が経ったが、約束が成就する必要があります。だから私はそれをやっています。
 
 偶然にも、サーバーWebの世界では非同期ですべてが関連付けられていますが、PHPは関連付けられていません。
 
 ええと、あなたが...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PHPを使用してDVRIP経由でカメラからビデオを取得します</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484518/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の記事、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私はカメラからの映像を引っ張るスクリプトを表示することを約束して、一定の時間が経ったが、約束が成就する必要があります。だから私はそれをやっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
偶然にも、サーバーWebの世界では非同期ですべてが関連付けられていますが、PHPは関連付けられていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ええと、あなたが知っているので、この死にかけているモデル、メモリリーク、そして実際、PHPには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stream_select（）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stream_set_blocking（）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以外は何もありません</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どこかに、PECLには</font><font style="vertical-align: inherit;">、原則として元のライブラリの元の関数の単なるラッパー</font><font style="vertical-align: inherit;">である</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libuv</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があるので、そのまま使用するといくつかの課題があります。とにかく、彼らの正しい心の中でこれを行うのは誰ですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、PHP4の世界での生活をやめて現代の現実に少し戻ると、ここ数年で状況が多少変化していることがわかります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AmPHP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの興味深いツールが</font><font style="vertical-align: inherit;">あり</font><font style="vertical-align: inherit;">、それらのコンポーネントはNode.js機能を適切にカバーします。ジェネレーターの存在により、非同期コードを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async / await</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの便利なスタイルで記述し、</font><font style="vertical-align: inherit;">コールバックやキロ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メーター</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェーンでこれらの無限のコールバックを回避できます。</font><i><font style="vertical-align: inherit;">）.then（）。then（）</font></i><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、今、私には、PHPが解決できなかったNode.jsの世界からのタスクは事実上ないようです。しかし、まだいくつかある場合、すべてはいくつかの個別のライブラリの存在にのみ依存し、そのような機会の欠如には依存しません。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP標準ライブラリには、イベント駆動型の非ブロッキングアプリケーションを作成するために必要なものがすべて揃っていることを知って、人々を驚かせるかもしれません。</font><font style="vertical-align: inherit;">この領域でネイティブPHPの機能の制限に達するのは、同時に何千ものファイル記述子をポーリングしてIOアクティビティを調べるように依頼したときだけです。</font><font style="vertical-align: inherit;">ただし、この場合でも、障害はPHPではなく、基になるシステムのselect（）呼び出しにあります。これは、負荷の増加に伴うパフォーマンスの低下に線形です。</font></font><br>
<br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">amphp.org/amp/event-loop</font></font></a></i></blockquote><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、これをすべて本番環境で使用するという問題はまだ完全には解決されていませんが、他の非同期ランタイム環境が許さないことを故意に間違えない限り、すべてが問題ありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DVRIP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソフトウェアを監視カメラと通信するために使用される、おそらく中国によって発明されたプロトコルを検討します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それはすべてDVRIP（時々ソフィア）と呼ばれるTCPの上で動作し、私がそれを必要としたときまでに、私はたった2つだけのまともなライブラリを見つけました。パッケージヘッダーの説明は、とても役に立ちました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のものは少し遅れて見つかりましたが、私の症候群の悪化時にここでは発明されていませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に、スニファーとパッケージヘッダーの説明を武器に、サーバーのどこかで1つの形式で実行される特定のスクリプトを簡単にスケッチし、この記事の特定の概念実証で紹介します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロトコル自体は複雑ではなく、パッケージは次のようになります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20バイトのヘッダー。PHPでは次のように指定できます。 </font></font><br>
<br>
<pre><code class="php hljs">unpack(<span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span>, $buffer)</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘッダーの後には長いlenメッセージが続き、2バイトの\ x0a \ x00で補足されたjsonまたはバイナリデータを含めることができます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
jsonのみを送信し、両方を受信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回答（jsonを含むパッケージの場合）には通常</font><font style="vertical-align: inherit;">、リクエストの成功を示す</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ret</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドが含まれてい</font><font style="vertical-align: inherit;">ます。</font><b><font style="vertical-align: inherit;">100</font></b><font style="vertical-align: inherit;">または</font><b><font style="vertical-align: inherit;">515に</font></b><font style="vertical-align: inherit;">等しくない</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ret</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを含む応答は、</font><font style="vertical-align: inherit;">意図的に誤っていると見なされます。</font><font style="vertical-align: inherit;">
この基本的な知識を身につけて、カメラに接続して理解しましょう。</font><font style="vertical-align: inherit;">
2つのライブラリが必要です</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">。amphp/ socket</font></a><font style="vertical-align: inherit;">は必要なほぼすべてを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">プル</font></a><font style="vertical-align: inherit;">アップします</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">。evenement/ evenementは</font></a><font style="vertical-align: inherit;">、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">packagist</font></a><font style="vertical-align: inherit;">で使用でき、拡張機能を必要としません。</font><font style="vertical-align: inherit;">
AmpでのTCPの操作は次のようになります。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<font></font>
    $socket = <span class="hljs-keyword">yield</span> connect(<span class="hljs-string">"tcp://{$addr}:{$port}"</span>);<font></font>
    <font></font>
    <span class="hljs-keyword">yield</span> $socket-&gt;write(<span class="hljs-string">'Hello'</span>);<font></font>
    <font></font>
    <span class="hljs-keyword">while</span> ($chunk = <span class="hljs-keyword">yield</span> $socket-&gt;read()) {
        <span class="hljs-keyword">echo</span> $chunk;<font></font>
    }<font></font>
    <font></font>
    $socket-&gt;close();<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DVRIPは通常、ポート34567で実行されるため、この場合は次のようになります。 </font></font><br>
<br>
<pre><code class="php hljs">$socket = <span class="hljs-keyword">yield</span> connect(<span class="hljs-string">'tcp://192.168.0.200:34567'</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、カメラにユーザー名とパスワードのハッシュを送信してログインします。ハッシュは次のように計算されます。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sofiaHash</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $password</span>) : <span class="hljs-title">string</span>
</span>{<font></font>
    $md5 = md5($password, <span class="hljs-literal">true</span>);    
    <span class="hljs-keyword">return</span> implode(<span class="hljs-string">''</span>, array_map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$i</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$md5</span>) </span>{<font></font>
        $c = (ord($md5[<span class="hljs-number">2</span> * $i]) + ord($md5[<span class="hljs-number">2</span> * $i + <span class="hljs-number">1</span>])) % <span class="hljs-number">62</span>;<font></font>
        $c += $c &gt; <span class="hljs-number">9</span> ? ($c &gt; <span class="hljs-number">35</span> ? <span class="hljs-number">61</span> : <span class="hljs-number">55</span>) : <span class="hljs-number">48</span>;
        <span class="hljs-keyword">return</span> chr($c);<font></font>
    }, range(<span class="hljs-number">0</span>, <span class="hljs-number">7</span>)));<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
承認が成功した場合は、動画をリクエストし、カメラがそれを提供できる場合は、送信を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッケージのタイプごとに独自のmsgIdがあるため、どのようなリクエストを受け取ったかを理解できます。</font><font style="vertical-align: inherit;">一般的に、ほこりっぽい仕事ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
便宜上、まずパッケージのクラスについて説明しましょう。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Packet</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> SUCCESS_CODES = [<span class="hljs-number">100</span>, <span class="hljs-number">515</span>];    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> MESSAGE_CODES = [
        <span class="hljs-string">'packet.request.login'</span>      =&gt; <span class="hljs-number">1000</span>,
        <span class="hljs-string">'packet.request.keepAlive'</span>  =&gt; <span class="hljs-number">1006</span>,
        <span class="hljs-string">'packet.request.claim'</span>      =&gt; <span class="hljs-number">1413</span>,<font></font>
        <font></font>
        <span class="hljs-string">'packet.response.login'</span>     =&gt; <span class="hljs-number">1001</span>,
        <span class="hljs-string">'packet.response.keepAlive'</span> =&gt; <span class="hljs-number">1007</span>,
        <span class="hljs-string">'packet.response.claim'</span>     =&gt; <span class="hljs-number">1414</span>,<font></font>
        <font></font>
        <span class="hljs-string">'packet.videoControl'</span>       =&gt; <span class="hljs-number">1410</span>,
        <span class="hljs-string">'packet.binary'</span>             =&gt; <span class="hljs-number">1412</span>,<font></font>
    ];<font></font>
<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $head = <span class="hljs-number">255</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $version = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $sessionId;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $sequence;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $msgId;<font></font>
    <font></font>
    <span class="hljs-keyword">protected</span> ?<span class="hljs-keyword">string</span> $rawData;
    <span class="hljs-keyword">protected</span> ?<span class="hljs-keyword">array</span> $data;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $msgId, ?<span class="hljs-keyword">array</span> $data = <span class="hljs-literal">null</span>, <span class="hljs-keyword">int</span> $sequence = <span class="hljs-number">0</span>, <span class="hljs-keyword">int</span> $sessionId = <span class="hljs-number">0</span></span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;msgId = $msgId;
        <span class="hljs-keyword">$this</span>-&gt;data = $data;
        <span class="hljs-keyword">$this</span>-&gt;sequence = $sequence;
        <span class="hljs-keyword">$this</span>-&gt;sessionId = $sessionId;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>) : <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;data !== <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">$this</span>-&gt;rawData = json_encode(<span class="hljs-keyword">$this</span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string">"\x0a\x00"</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> pack(<span class="hljs-string">'CCx2IIx2SI'</span>, <span class="hljs-keyword">$this</span>-&gt;head, <span class="hljs-keyword">$this</span>-&gt;version, <span class="hljs-keyword">$this</span>-&gt;sessionId, <span class="hljs-keyword">$this</span>-&gt;sequence, <span class="hljs-keyword">$this</span>-&gt;msgId, strlen(<span class="hljs-keyword">$this</span>-&gt;rawData))<font></font>
            . <span class="hljs-keyword">$this</span>-&gt;rawData;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getData</span>(<span class="hljs-params"></span>) : ?<span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;data;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRawData</span>(<span class="hljs-params"></span>) : ?<span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;rawData;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSession</span>(<span class="hljs-params"></span>) : <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;sessionId;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSequence</span>(<span class="hljs-params"></span>) : <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;sequence;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMessageType</span>(<span class="hljs-params"></span>) : <span class="hljs-title">string</span>
    </span>{<font></font>
        $types = array_flip(<span class="hljs-built_in">static</span>::MESSAGE_CODES);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($types[<span class="hljs-keyword">$this</span>-&gt;msgId])) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Unknown message type: '</span> . <span class="hljs-keyword">$this</span>-&gt;msgId);<font></font>
        }<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> $types[<span class="hljs-keyword">$this</span>-&gt;msgId];<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
承認リクエストを送信してみてください</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.request.login'</span>], [
    <span class="hljs-string">'EncryptType'</span> =&gt; <span class="hljs-string">'MD5'</span>,
    <span class="hljs-string">'LoginType'</span>   =&gt; <span class="hljs-string">'DVRIP-Web'</span>,
    <span class="hljs-string">'PassWord'</span>    =&gt; sofiaHash(<span class="hljs-string">'admin'</span>),
    <span class="hljs-string">'UserName'</span>    =&gt; <span class="hljs-string">'admin'</span>,<font></font>
]));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ええ素晴らしいです。</font><font style="vertical-align: inherit;">接続してメッセージを送信しましたが、カメラが正しいかどうか、少なくとも何らかの形でカメラが反応したかどうかもわかりません。</font><font style="vertical-align: inherit;">どういうわけか答えを読んで（非同期でやりましょう）、その中の特定のパケットを選択してデコードする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何らかの形で応答パケットの処理ロジックを分離するために、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリを使用することに決め</font><font style="vertical-align: inherit;">、それに基づいて、すでにデコードされたパケットを破棄するクラスをスケッチしました</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Reader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span>
</span>{
    <span class="hljs-keyword">protected</span> InputStream $socket;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">InputStream $socket</span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;socket = $socket;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span>(<span class="hljs-params"></span>) : \<span class="hljs-title">Generator</span>
    </span>{<font></font>
        $buffer = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">while</span> (!<span class="hljs-keyword">$this</span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword">yield</span> Packet::read(<span class="hljs-keyword">$this</span>-&gt;socket, $buffer)) {<font></font>
            [$packet, $chunk] = $result;<font></font>
            $buffer = $chunk;<font></font>
            $chunk = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">$this</span>-&gt;emit(<span class="hljs-string">'packet'</span>, [$packet]);
            <span class="hljs-keyword">$this</span>-&gt;emit($packet-&gt;getMessageType(), [$packet]);<font></font>
        }<font></font>
        <font></font>
        $buffer = <span class="hljs-literal">null</span>;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、Packetクラスにいくつかの静的メソッドを追加しました。実際には、データストリームからパケットを抽出してデコードします。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params">InputStream $socket, <span class="hljs-keyword">string</span> $buffer = <span class="hljs-string">''</span></span>) : <span class="hljs-title">Promise</span>
</span>{
    <span class="hljs-keyword">return</span> call(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket, $buffer</span>) </span>{<font></font>
        $header = <span class="hljs-literal">null</span>;<font></font>
        <font></font>
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> ($header === <span class="hljs-literal">null</span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number">20</span>) {<font></font>
                $header = unpack(<span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span>, substr($buffer, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>));<font></font>
                $buffer = substr($buffer, <span class="hljs-number">20</span>);<font></font>
            }<font></font>
            <font></font>
            <span class="hljs-keyword">if</span> ($header !== <span class="hljs-literal">null</span> &amp;&amp; strlen($buffer) &gt;= (<span class="hljs-keyword">int</span>) $header[<span class="hljs-string">'len'</span>]) {
                <span class="hljs-keyword">return</span> [
                    <span class="hljs-built_in">static</span>::fromRaw($header, (<span class="hljs-keyword">int</span>) $header[<span class="hljs-string">'len'</span>] &gt; <span class="hljs-number">0</span> ? substr($buffer, <span class="hljs-number">0</span>, (<span class="hljs-keyword">int</span>) $header[<span class="hljs-string">'len'</span>]) : <span class="hljs-literal">null</span>),<font></font>
                    substr($buffer, (<span class="hljs-keyword">int</span>) $header[<span class="hljs-string">'len'</span>])<font></font>
                ];<font></font>
            }<font></font>
            <font></font>
            $buffer .= <span class="hljs-keyword">yield</span> $socket-&gt;read();                <font></font>
        } <span class="hljs-keyword">while</span> (!$socket-&gt;isClosed());<font></font>
    });<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">protected</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fromRaw</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> $header, ?<span class="hljs-keyword">string</span> $rawData</span>) : <span class="hljs-title">self</span>
</span>{<font></font>
    $packet = <span class="hljs-keyword">new</span> <span class="hljs-built_in">static</span>($header[<span class="hljs-string">'msgId'</span>], <span class="hljs-literal">null</span>, $header[<span class="hljs-string">'sequence'</span>], $header[<span class="hljs-string">'sessionId'</span>]);<font></font>
    $packet-&gt;rawData = $rawData;<font></font>
    <font></font>
    $packet-&gt;data = (<span class="hljs-keyword">int</span>) $packet-&gt;msgId === <span class="hljs-built_in">static</span>::MESSAGE_CODES[<span class="hljs-string">'packet.binary'</span>] || $rawData === <span class="hljs-literal">null</span>
        ? <span class="hljs-literal">null</span>
        : json_decode(substr($rawData, <span class="hljs-number">0</span>, <span class="hljs-number">-2</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> $packet;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evenementを</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用して、</font><font style="vertical-align: inherit;">ロジックを次の形式で説明できます。</font></font><br>
<br>
<pre><code class="php hljs">$reader-&gt;on($packetType, $handler);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私はこのチェーンを手に入れました、そこで私は別のキープアライブとSIGINT / SIGTERM処理を追加しました：</font></font><br>
<br>
<pre><code class="php hljs">$reader = <span class="hljs-keyword">new</span> Reader($socket = <span class="hljs-keyword">yield</span> connect(<span class="hljs-string">'tcp://10.0.5.100:49152'</span>)); <font></font>
<font></font>
$reader-&gt;on(<span class="hljs-string">'packet.response.login'</span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Packet $packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($packet-&gt;getData()[<span class="hljs-string">'Ret'</span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string">'Ret'</span>], Packet::SUCCESS_CODES)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Wrong login data'</span>);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.request.claim'</span>], [
        <span class="hljs-string">'Name'</span> =&gt; <span class="hljs-string">'OPMonitor'</span>,
        <span class="hljs-string">'OPMonitor'</span> =&gt; [<span class="hljs-string">'Action'</span> =&gt; <span class="hljs-string">'Claim'</span>, <span class="hljs-string">'Parameter'</span> =&gt; [<span class="hljs-string">'Channel'</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">'CombinMode'</span> =&gt; <span class="hljs-string">'NONE'</span>, <span class="hljs-string">'StreamType'</span> =&gt; <span class="hljs-string">'Main'</span>, <span class="hljs-string">'TransMode'</span>  =&gt; <span class="hljs-string">'TCP'</span>]],<font></font>
    ], <span class="hljs-number">1</span>, $packet-&gt;getSession()));<font></font>
}));<font></font>
<font></font>
$reader-&gt;once(<span class="hljs-string">'packet.response.login'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Packet $packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket</span>) </span>{<font></font>
    Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string">'AliveInterval'</span>] * <span class="hljs-number">1000</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$watcherId</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket, $packet</span>) </span>{
        <span class="hljs-keyword">if</span> ($socket-&gt;getResource() === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> Loop::cancel($watcherId);   <font></font>
        }<font></font>
        <font></font>
        <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.request.keepAlive'</span>], [
            <span class="hljs-string">'Name'</span> =&gt; <span class="hljs-string">'KeepAlive'</span>, <span class="hljs-string">'SessionID'</span> =&gt; $packet-&gt;getData()[<span class="hljs-string">'SessionID'</span>]<font></font>
        ], <span class="hljs-number">0</span>, $packet-&gt;getSession()));<font></font>
    }));<font></font>
});<font></font>
<font></font>
$reader-&gt;on(<span class="hljs-string">'packet.response.claim'</span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Packet $packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket</span>) </span>{
    <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.videoControl'</span>], [
        <span class="hljs-string">'Name'</span> =&gt; <span class="hljs-string">'OPMonitor'</span>,
        <span class="hljs-string">'OPMonitor'</span> =&gt; [<span class="hljs-string">'Action'</span> =&gt; <span class="hljs-string">'Start'</span>, <span class="hljs-string">'Parameter'</span> =&gt; [<span class="hljs-string">'Channel'</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">'CombinMode'</span> =&gt; <span class="hljs-string">'NONE'</span>, <span class="hljs-string">'StreamType'</span> =&gt; <span class="hljs-string">'Main'</span>, <span class="hljs-string">'TransMode'</span>  =&gt; <span class="hljs-string">'TCP'</span>]],<font></font>
    ], $packet-&gt;getSequence() + <span class="hljs-number">1</span>, $packet-&gt;getSession()));<font></font>
}));<font></font>
<font></font>
$emitter = <span class="hljs-keyword">new</span> Emitter();    <font></font>
$reader-&gt;on(<span class="hljs-string">'packet.binary'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$emitter</span>) </span>{<font></font>
    $emitter-&gt;emit($packet-&gt;getRawData());<font></font>
});<font></font>
<font></font>
$reader-&gt;once(<span class="hljs-string">'packet.binary'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Packet $packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket</span>) </span>{<font></font>
    $signalHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket, $packet</span>) </span>{
        <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.videoControl'</span>], [
            <span class="hljs-string">'Name'</span> =&gt; <span class="hljs-string">'OPMonitor'</span>,
            <span class="hljs-string">'OPMonitor'</span> =&gt; [<span class="hljs-string">'Action'</span> =&gt; <span class="hljs-string">'Stop'</span>, <span class="hljs-string">'Parameter'</span> =&gt; [<span class="hljs-string">'Channel'</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">'CombinMode'</span> =&gt; <span class="hljs-string">'NONE'</span>, <span class="hljs-string">'StreamType'</span> =&gt; <span class="hljs-string">'Main'</span>, <span class="hljs-string">'TransMode'</span>  =&gt; <span class="hljs-string">'TCP'</span>]],<font></font>
        ], <span class="hljs-number">0</span>, $packet-&gt;getSession()));<font></font>
        <font></font>
        $socket-&gt;close();<font></font>
    };<font></font>
    Loop::unreference(Loop::onSignal(defined(<span class="hljs-string">'SIGINT'</span>)  ? SIGINT  : <span class="hljs-number">2</span>,  $signalHandler, <span class="hljs-string">'SIGINT'</span>));<font></font>
    Loop::unreference(Loop::onSignal(defined(<span class="hljs-string">'SIGTERM'</span>) ? SIGTERM : <span class="hljs-number">15</span>, $signalHandler, <span class="hljs-string">'SIGTERM'</span>));<font></font>
});<font></font>
<font></font>
asyncCall([$reader, <span class="hljs-string">'start'</span>]);<font></font>
<font></font>
<span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.request.login'</span>], [
    <span class="hljs-string">'EncryptType'</span> =&gt; <span class="hljs-string">'MD5'</span>,
    <span class="hljs-string">'LoginType'</span>   =&gt; <span class="hljs-string">'DVRIP-Web'</span>,
    <span class="hljs-string">'PassWord'</span>    =&gt; sofiaHash(<span class="hljs-string">'123qwea'</span>),
    <span class="hljs-string">'UserName'</span>    =&gt; <span class="hljs-string">'admin'</span>,<font></font>
]));<font></font>
<font></font>
<span class="hljs-keyword">yield</span> pipe(<span class="hljs-keyword">new</span> IteratorStream($emitter-&gt;iterate()), getStdout());</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
言うまでもなく、標準出力の代わりに、ビデオストリームをどこにでもリダイレクトできます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終スクリプト</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
ini_set(<span class="hljs-string">'display_errors'</span>, <span class="hljs-string">'stderr'</span>);<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Emitter</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Loop</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Promise</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">ByteStream</span>\<span class="hljs-title">InputStream</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">ByteStream</span>\<span class="hljs-title">IteratorStream</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Evenement</span>\<span class="hljs-title">EventEmitter</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">call</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">asyncCall</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">asyncCoroutine</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">ByteStream</span>\<span class="hljs-title">getStderr</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">ByteStream</span>\<span class="hljs-title">getStdout</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">ByteStream</span>\<span class="hljs-title">pipe</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">function</span> <span class="hljs-title">Amp</span>\<span class="hljs-title">Socket</span>\<span class="hljs-title">connect</span>;<font></font>
<font></font>
<span class="hljs-keyword">require</span> <span class="hljs-string">'vendor/autoload.php'</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sofiaHash</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $password</span>) : <span class="hljs-title">string</span>
</span>{<font></font>
    $md5 = md5($password, <span class="hljs-literal">true</span>);    
    <span class="hljs-keyword">return</span> implode(<span class="hljs-string">''</span>, array_map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$i</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$md5</span>) </span>{<font></font>
        $c = (ord($md5[<span class="hljs-number">2</span> * $i]) + ord($md5[<span class="hljs-number">2</span> * $i + <span class="hljs-number">1</span>])) % <span class="hljs-number">62</span>;<font></font>
        $c += $c &gt; <span class="hljs-number">9</span> ? ($c &gt; <span class="hljs-number">35</span> ? <span class="hljs-number">61</span> : <span class="hljs-number">55</span>) : <span class="hljs-number">48</span>;
        <span class="hljs-keyword">return</span> chr($c);<font></font>
    }, range(<span class="hljs-number">0</span>, <span class="hljs-number">7</span>)));<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Reader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span>
</span>{
    <span class="hljs-keyword">protected</span> InputStream $socket;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">InputStream $socket</span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;socket = $socket;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span>(<span class="hljs-params"></span>) : \<span class="hljs-title">Generator</span>
    </span>{<font></font>
        $buffer = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">while</span> (!<span class="hljs-keyword">$this</span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword">yield</span> Packet::read(<span class="hljs-keyword">$this</span>-&gt;socket, $buffer)) {<font></font>
            [$packet, $chunk] = $result;<font></font>
            $buffer = $chunk;<font></font>
            $chunk = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">$this</span>-&gt;emit(<span class="hljs-string">'packet'</span>, [$packet]);
            <span class="hljs-keyword">$this</span>-&gt;emit($packet-&gt;getMessageType(), [$packet]);<font></font>
        }<font></font>
        <font></font>
        $buffer = <span class="hljs-literal">null</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Packet</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> SUCCESS_CODES = [<span class="hljs-number">100</span>, <span class="hljs-number">515</span>];    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> MESSAGE_CODES = [
        <span class="hljs-string">'packet.request.login'</span>      =&gt; <span class="hljs-number">1000</span>,
        <span class="hljs-string">'packet.request.keepAlive'</span>  =&gt; <span class="hljs-number">1006</span>,
        <span class="hljs-string">'packet.request.claim'</span>      =&gt; <span class="hljs-number">1413</span>,<font></font>
        <font></font>
        <span class="hljs-string">'packet.response.login'</span>     =&gt; <span class="hljs-number">1001</span>,
        <span class="hljs-string">'packet.response.keepAlive'</span> =&gt; <span class="hljs-number">1007</span>,
        <span class="hljs-string">'packet.response.claim'</span>     =&gt; <span class="hljs-number">1414</span>,<font></font>
        <font></font>
        <span class="hljs-string">'packet.videoControl'</span>       =&gt; <span class="hljs-number">1410</span>,
        <span class="hljs-string">'packet.binary'</span>             =&gt; <span class="hljs-number">1412</span>,<font></font>
    ];<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params">InputStream $socket, <span class="hljs-keyword">string</span> $buffer = <span class="hljs-string">''</span></span>) : <span class="hljs-title">Promise</span>
    </span>{
        <span class="hljs-keyword">return</span> call(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket, $buffer</span>) </span>{<font></font>
            $header = <span class="hljs-literal">null</span>;<font></font>
            <font></font>
            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">if</span> ($header === <span class="hljs-literal">null</span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number">20</span>) {<font></font>
                    $header = unpack(<span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span>, substr($buffer, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>));<font></font>
                    $buffer = substr($buffer, <span class="hljs-number">20</span>);<font></font>
                }<font></font>
                <font></font>
                <span class="hljs-keyword">if</span> ($header !== <span class="hljs-literal">null</span> &amp;&amp; strlen($buffer) &gt;= (<span class="hljs-keyword">int</span>) $header[<span class="hljs-string">'len'</span>]) {
                    <span class="hljs-keyword">return</span> [
                        <span class="hljs-built_in">static</span>::fromRaw($header, (<span class="hljs-keyword">int</span>) $header[<span class="hljs-string">'len'</span>] &gt; <span class="hljs-number">0</span> ? substr($buffer, <span class="hljs-number">0</span>, (<span class="hljs-keyword">int</span>) $header[<span class="hljs-string">'len'</span>]) : <span class="hljs-literal">null</span>),<font></font>
                        substr($buffer, (<span class="hljs-keyword">int</span>) $header[<span class="hljs-string">'len'</span>])<font></font>
                    ];<font></font>
                }<font></font>
                <font></font>
                $buffer .= <span class="hljs-keyword">yield</span> $socket-&gt;read();                <font></font>
            } <span class="hljs-keyword">while</span> (!$socket-&gt;isClosed());<font></font>
        });<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fromRaw</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> $header, ?<span class="hljs-keyword">string</span> $rawData</span>) : <span class="hljs-title">self</span>
    </span>{<font></font>
        $packet = <span class="hljs-keyword">new</span> <span class="hljs-built_in">static</span>($header[<span class="hljs-string">'msgId'</span>], <span class="hljs-literal">null</span>, $header[<span class="hljs-string">'sequence'</span>], $header[<span class="hljs-string">'sessionId'</span>]);<font></font>
        $packet-&gt;rawData = $rawData;<font></font>
        <font></font>
        $packet-&gt;data = (<span class="hljs-keyword">int</span>) $packet-&gt;msgId === <span class="hljs-built_in">static</span>::MESSAGE_CODES[<span class="hljs-string">'packet.binary'</span>] || $rawData === <span class="hljs-literal">null</span>
            ? <span class="hljs-literal">null</span>
            : json_decode(substr($rawData, <span class="hljs-number">0</span>, <span class="hljs-number">-2</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">512</span>, JSON_THROW_ON_ERROR);<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> $packet;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $head = <span class="hljs-number">255</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $version = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $sessionId;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $sequence;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> $msgId;<font></font>
    <font></font>
    <span class="hljs-keyword">protected</span> ?<span class="hljs-keyword">string</span> $rawData;
    <span class="hljs-keyword">protected</span> ?<span class="hljs-keyword">array</span> $data;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $msgId, ?<span class="hljs-keyword">array</span> $data = <span class="hljs-literal">null</span>, <span class="hljs-keyword">int</span> $sequence = <span class="hljs-number">0</span>, <span class="hljs-keyword">int</span> $sessionId = <span class="hljs-number">0</span></span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;msgId = $msgId;
        <span class="hljs-keyword">$this</span>-&gt;data = $data;
        <span class="hljs-keyword">$this</span>-&gt;sequence = $sequence;
        <span class="hljs-keyword">$this</span>-&gt;sessionId = $sessionId;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>) : <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;data !== <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">$this</span>-&gt;rawData = json_encode(<span class="hljs-keyword">$this</span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string">"\x0a\x00"</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> pack(<span class="hljs-string">'CCx2IIx2SI'</span>, <span class="hljs-keyword">$this</span>-&gt;head, <span class="hljs-keyword">$this</span>-&gt;version, <span class="hljs-keyword">$this</span>-&gt;sessionId, <span class="hljs-keyword">$this</span>-&gt;sequence, <span class="hljs-keyword">$this</span>-&gt;msgId, strlen(<span class="hljs-keyword">$this</span>-&gt;rawData))<font></font>
            . <span class="hljs-keyword">$this</span>-&gt;rawData;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getData</span>(<span class="hljs-params"></span>) : ?<span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;data;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRawData</span>(<span class="hljs-params"></span>) : ?<span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;rawData;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSession</span>(<span class="hljs-params"></span>) : <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;sessionId;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSequence</span>(<span class="hljs-params"></span>) : <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;sequence;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMessageType</span>(<span class="hljs-params"></span>) : <span class="hljs-title">string</span>
    </span>{<font></font>
        $types = array_flip(<span class="hljs-built_in">static</span>::MESSAGE_CODES);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($types[<span class="hljs-keyword">$this</span>-&gt;msgId])) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Unknown message type: '</span> . <span class="hljs-keyword">$this</span>-&gt;msgId);<font></font>
        }<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> $types[<span class="hljs-keyword">$this</span>-&gt;msgId];<font></font>
    }<font></font>
}<font></font>
<font></font>
Loop::run(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) : \<span class="hljs-title">Generator</span> </span>{<font></font>
    $reader = <span class="hljs-keyword">new</span> Reader($socket = <span class="hljs-keyword">yield</span> connect(<span class="hljs-string">'tcp://10.0.5.100:49152'</span>)); <font></font>
    <font></font>
    $reader-&gt;on(<span class="hljs-string">'packet.response.login'</span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Packet $packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($packet-&gt;getData()[<span class="hljs-string">'Ret'</span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string">'Ret'</span>], Packet::SUCCESS_CODES)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Wrong login data'</span>);<font></font>
        }<font></font>
        <font></font>
        <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.request.claim'</span>], [
            <span class="hljs-string">'Name'</span> =&gt; <span class="hljs-string">'OPMonitor'</span>,
            <span class="hljs-string">'OPMonitor'</span> =&gt; [<span class="hljs-string">'Action'</span> =&gt; <span class="hljs-string">'Claim'</span>, <span class="hljs-string">'Parameter'</span> =&gt; [<span class="hljs-string">'Channel'</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">'CombinMode'</span> =&gt; <span class="hljs-string">'NONE'</span>, <span class="hljs-string">'StreamType'</span> =&gt; <span class="hljs-string">'Main'</span>, <span class="hljs-string">'TransMode'</span>  =&gt; <span class="hljs-string">'TCP'</span>]],<font></font>
        ], <span class="hljs-number">1</span>, $packet-&gt;getSession()));<font></font>
    }));<font></font>
    <font></font>
    $reader-&gt;once(<span class="hljs-string">'packet.response.login'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Packet $packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket</span>) </span>{<font></font>
        Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string">'AliveInterval'</span>] * <span class="hljs-number">1000</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$watcherId</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket, $packet</span>) </span>{
            <span class="hljs-keyword">if</span> ($socket-&gt;getResource() === <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> Loop::cancel($watcherId);   <font></font>
            }<font></font>
            <font></font>
            <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.request.keepAlive'</span>], [
                <span class="hljs-string">'Name'</span> =&gt; <span class="hljs-string">'KeepAlive'</span>, <span class="hljs-string">'SessionID'</span> =&gt; $packet-&gt;getData()[<span class="hljs-string">'SessionID'</span>]<font></font>
            ], <span class="hljs-number">0</span>, $packet-&gt;getSession()));<font></font>
        }));<font></font>
    });<font></font>
    <font></font>
    $reader-&gt;on(<span class="hljs-string">'packet.response.claim'</span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Packet $packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket</span>) </span>{
        <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.videoControl'</span>], [
            <span class="hljs-string">'Name'</span> =&gt; <span class="hljs-string">'OPMonitor'</span>,
            <span class="hljs-string">'OPMonitor'</span> =&gt; [<span class="hljs-string">'Action'</span> =&gt; <span class="hljs-string">'Start'</span>, <span class="hljs-string">'Parameter'</span> =&gt; [<span class="hljs-string">'Channel'</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">'CombinMode'</span> =&gt; <span class="hljs-string">'NONE'</span>, <span class="hljs-string">'StreamType'</span> =&gt; <span class="hljs-string">'Main'</span>, <span class="hljs-string">'TransMode'</span>  =&gt; <span class="hljs-string">'TCP'</span>]],<font></font>
        ], $packet-&gt;getSequence() + <span class="hljs-number">1</span>, $packet-&gt;getSession()));<font></font>
    }));<font></font>
    <font></font>
    $emitter = <span class="hljs-keyword">new</span> Emitter();    <font></font>
    $reader-&gt;on(<span class="hljs-string">'packet.binary'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$emitter</span>) </span>{<font></font>
        $emitter-&gt;emit($packet-&gt;getRawData());<font></font>
    });<font></font>
    <font></font>
    $reader-&gt;once(<span class="hljs-string">'packet.binary'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Packet $packet</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket</span>) </span>{<font></font>
        $signalHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) <span class="hljs-title">use</span> (<span class="hljs-params">$socket, $packet</span>) </span>{
            <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.videoControl'</span>], [
                <span class="hljs-string">'Name'</span> =&gt; <span class="hljs-string">'OPMonitor'</span>,
                <span class="hljs-string">'OPMonitor'</span> =&gt; [<span class="hljs-string">'Action'</span> =&gt; <span class="hljs-string">'Stop'</span>, <span class="hljs-string">'Parameter'</span> =&gt; [<span class="hljs-string">'Channel'</span> =&gt; <span class="hljs-number">0</span>, <span class="hljs-string">'CombinMode'</span> =&gt; <span class="hljs-string">'NONE'</span>, <span class="hljs-string">'StreamType'</span> =&gt; <span class="hljs-string">'Main'</span>, <span class="hljs-string">'TransMode'</span>  =&gt; <span class="hljs-string">'TCP'</span>]],<font></font>
            ], <span class="hljs-number">0</span>, $packet-&gt;getSession()));<font></font>
            <font></font>
            $socket-&gt;close();<font></font>
        };<font></font>
        Loop::unreference(Loop::onSignal(defined(<span class="hljs-string">'SIGINT'</span>)  ? SIGINT  : <span class="hljs-number">2</span>,  $signalHandler, <span class="hljs-string">'SIGINT'</span>));<font></font>
        Loop::unreference(Loop::onSignal(defined(<span class="hljs-string">'SIGTERM'</span>) ? SIGTERM : <span class="hljs-number">15</span>, $signalHandler, <span class="hljs-string">'SIGTERM'</span>));<font></font>
    });<font></font>
    <font></font>
    asyncCall([$reader, <span class="hljs-string">'start'</span>]);<font></font>
    <font></font>
    <span class="hljs-keyword">yield</span> $socket-&gt;write((<span class="hljs-keyword">string</span>) <span class="hljs-keyword">new</span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string">'packet.request.login'</span>], [
        <span class="hljs-string">'EncryptType'</span> =&gt; <span class="hljs-string">'MD5'</span>,
        <span class="hljs-string">'LoginType'</span>   =&gt; <span class="hljs-string">'DVRIP-Web'</span>,
        <span class="hljs-string">'PassWord'</span>    =&gt; sofiaHash(<span class="hljs-string">'123qwea'</span>),
        <span class="hljs-string">'UserName'</span>    =&gt; <span class="hljs-string">'admin'</span>,<font></font>
    ]));<font></font>
    <font></font>
    <span class="hljs-keyword">yield</span> pipe(<span class="hljs-keyword">new</span> IteratorStream($emitter-&gt;iterate()), getStdout());<font></font>
});</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、この方法でビデオを録画することができます</font></font><br>
<br>
<pre><code class="bash hljs">$ php recorder.php &gt; output.h264</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SIGINTハンドラーを追加したので、飽きたらCtrl + Cを押すだけで、スクリプトはビデオの送信を停止し、接続を正常に閉じます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、ストリームをffmpegにリダイレクトし、その場でトランスコードすることができます。</font></font><br>
<br>
<pre><code class="bash hljs">$ php recorder.php | ffmpeg -nostdin -y -hide_banner -loglevel verbose -f h264 -i pipe:0 -pix_fmt yuv420p -c copy -movflags +frag_keyframe+empty_moov+default_base_moof -reset_timestamps 1 -f mpegts output.mpegts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、あなたはのような必死の鎖を作ることができます </font></font><br>
<br>
<pre><code class="bash hljs">$ php recorder.php | ffmpeg ... | curl -d @- ... </code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1時間ごとに再起動するある種のスクリプトを使用して、これらすべてを起動します。これにより、必要に応じて、オンザフライで1時間持続するスムーズなピースを取得できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何のために？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はこの記事が「なぜ」という疑問を多くの人に提起すると信じる傾向があります。カメラからの登録には既製のソリューションがあり、一般的にカメラは多くのことを自分で行うことができます。前の記事へのコメントで正当に反対しており、一般的にははるかに簡単になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どこかでやらなくてはいけなかった時間、自分の道を作ってみたいという欲望、そして実験に対する飽くなき欲望だっただけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてそれは機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、この記事で紹介するスクリプトにはいくつかの変更が必要なので、この形式では使用しないでください。繰り返しますが、これは概念実証です。そして、一般的に、私はあなたの家の安全を確保するために膝の高さの自家製の製品を使用することを強く警告します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の場合、信頼性はそれほど重要ではないので、このオプションは機能します。</font><font style="vertical-align: inherit;">スクリプトウォッチャーがこのスクリプトを回転させ、ストリームをffmpegに転送し、時間単位でピースを記録してVKにアップロードし、切断や予期しないイベントが発生した場合にスクリプトを再起動します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、前の記事の最後で提案したように、RTSP over TCPを介してビデオを単に引き出すことで、これらすべてを回避することができましたが、ffmpegは、ランダムな瞬間に愚かにストールし、SIGKILLにのみ応答することを好みました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはすべて、親のスクリプトウォッチが王冠によって開始され、優先度が低いためであると疑い始めましたが、優先度を上げると問題の頻度が減っただけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のスクリプトの場合、すべてがはるかに安定して機能し、まだ不満はありません。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja484502/index.html">Facebookはモデレーターに労働時間を秒単位で記録することを強制します-トイレに行くことさえ</a></li>
<li><a href="../ja484504/index.html">10ドル未満で空気イオナイザーを作る</a></li>
<li><a href="../ja484506/index.html">私は写真家であり、自分自身を作業ツールにします</a></li>
<li><a href="../ja484512/index.html">TOP 25の最大のICO：現在の問題は何ですか？</a></li>
<li><a href="../ja484514/index.html">Reactアプリケーションのユニバーサルルーティング</a></li>
<li><a href="../ja484520/index.html">zipアーカイブはどのように見え、それで何ができるか。パート3-実用的なアプリケーション</a></li>
<li><a href="../ja484522/index.html">DEFCON会議27.警察をハッキングする。パート2</a></li>
<li><a href="../ja484526/index.html">Androidで実行するSDL2プロジェクトの準備</a></li>
<li><a href="../ja484528/index.html">趣味のプロジェクトをk8sに転送した方法</a></li>
<li><a href="../ja484530/index.html">プラズマ処理/高分子材料の変更のためのCNCマシン</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>