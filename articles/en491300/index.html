<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧙🏻 🧑🏾‍🤝‍🧑🏽 👩🏽‍🤝‍👨🏻 STM32 Part 2: Initialization 👨🏽‍⚕️ 🏬 💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Programming is breaking up something big and impossible into something small and very real.
 
 Hello everyone, to begin with, I would like to thank th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Part 2: Initialization</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491300/"><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Programming is breaking up something big and impossible into something small and very real.</font></font></blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello everyone, to begin with, I would like to thank the moderators for missing my first (disgusting) post, and to say hello to mom! And also I would like to thank all the readers and people who pointed out my mistakes and helped to fix them. I immediately make a reservation that in Russian I did not write from grade 6, in general, do not be angry. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32 Part 1: The Basics</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
So let's get started. In a previous article, I quickly ran through the very first points. This was our startup.c file, which was responsible for 2 vectors (stack, Reset_Handler) and a little bit about the linker script. Today we will supplement our initialization code, analyze the linker for spare parts and find out how everything works.</font></font><br>
<a name="habracut"></a><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If this code is not clear to anyone, then you can read about it </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (the article is not a fountain, but tried to explain). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's figure out what is missing here and how to add it. Obviously, microns have other vectors. For example, the Hard_Fault vector is a vector that is called upon improper actions with μ, for example, if he tries to execute an instruction that the processor does not understand, he will jump to the address of the Hard_Fault vector. There are a lot of such vectors and it’s not a fact that in our program we will use everything. Also, interrupt vectors are in the same table. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(For those who still don’t know what a vector is, this is a pointer to an address, aka “pointer”). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We supplement our code, and then I will explain what I did.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Default_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">NMI_Handler</span><span class="hljs-params">()</span>   __<span class="hljs-title">attribute__</span><span class="hljs-params">((weak, alias(<span class="hljs-string">"Default_Handler"</span>)))</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HardFault_Handler</span><span class="hljs-params">()</span>   __<span class="hljs-title">attribute__</span><span class="hljs-params">((weak, alias(<span class="hljs-string">"Default_Handler"</span>)))</span></span>;
<span class="hljs-comment">//     </span><font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
    &amp;NMI_Handler,<font></font>
    &amp;HardFault_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Default_Handler(){
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here I added a new function Default_Handler (); which will handle all interrupts, absolutely. But also with the help, </font></font><code>__attribute__((weak, alias("Default_Handler")));</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I noted that if a function with the same name is declared, then it will be the handler of this interrupt. In other words, right now it's just a nickname for Default_Handler. So we can add all the vectors in the list from your Reference manual. This is done so that if you suddenly decided to use an interrupt, but forgot to create a function handler, then the usual Default_Handler is called. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think at this point with vectors you can finish and go to the initialization of sectors and to the linker. To begin, let's update our startup.c again by adding the initialization of the data and bss sectors to the Reset_Handler body as well as several external variables.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_sidata, *_sdata, *_edata, *_sbss, *_ebss;<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
<font></font>
<font></font>
	<span class="hljs-keyword">void</span> **pSource, **pDest;
	<span class="hljs-keyword">for</span> (pSource = &amp;_sidata, pDest = &amp;_sdata; pDest != &amp;_edata; pSource++, pDest++)<font></font>
		*pDest = *pSource;<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (pDest = &amp;_sbss; pDest != &amp;_ebss; pDest++)<font></font>
		*pDest = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, new variables, and again they were declared in our linker script. </font><font style="vertical-align: inherit;">Recall the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous script</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">And also compare it with a new one.</font></font><br>
<br>
<pre><code class="markdown hljs">MEMORY{
<span class="hljs-code">	ROM(rx) : ORIGIN = 0x08000000, LENGTH = 1M
	SRAM (rwx):     ORIGIN = 0x20010000, LENGTH = 240K
}
</span>
<span class="hljs-emphasis">_estack = LENGTH(SRAM) + ORIGIN(SRAM);

SECTIONS{
	.isr_</span>vector : {
<span class="hljs-code">	KEEP(*(.isr_vector))
	} &gt;ROM
	
	.text : {
        . = ALIGN(4);
        *(.text)
    } &gt;ROM
	
	_sidata = LOADADDR(.data);
        .data : {
		. = ALIGN(4);
		_sdata = .;
		*(.data)
		. = ALIGN(4);
		_edata = .;
	} &gt;SRAM AT&gt;ROM
	
	.bss : {
		. = ALIGN(4);
		_sbss = .;
		*(.bss)
		. = ALIGN(4);
		_ebss = .;
	} &gt;SRAM
}</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two new sections have been added, these are .data and .bss. </font><font style="vertical-align: inherit;">Why do we need them? </font><font style="vertical-align: inherit;">well .data will leave global variables and static will go to bss. </font><font style="vertical-align: inherit;">Both of these sections are in RAM, and if everything is simple with the bss section (these are just zeros), then there are some difficulties with the data section. </font><font style="vertical-align: inherit;">First, data is already initialized data that is known at compile time. </font><font style="vertical-align: inherit;">Thus, initially the data section will lie somewhere in the flash memory. </font><font style="vertical-align: inherit;">Secondly, we need to somehow indicate to the linker the script that it is in flash memory, but it will be transferred to RAM during program execution. </font><font style="vertical-align: inherit;">Let's take a look at a piece of the script where we describe the data section.</font></font><br>
<br>
<pre><code class="markdown hljs">
<span class="hljs-code">        _sidata = LOADADDR(.data);
        .data : {
		. = ALIGN(4);
		_sdata = .;
		*(.data)
		. = ALIGN(4);
		_edata = .;
	} &gt;SRAM AT&gt;ROM</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It begins with the declaration of _sidata and the assignment, at the moment, of a meaning that is not clear to us. Next, a description of the section itself begins. I advise you to read about the ALIGN function </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but in a nutshell, we assign to our point (current address) a value that is more easily accepted by our processor when it tries to load data or instructions from there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also included are _sdata, _edata, and the end of the section. But at the end of the section there is just what we need.</font></font><code>SRAM AT&gt;ROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This line tells our linker that the section is in SRAM but this section is loaded into ROM or flash memory. Now back to our _sidata variable and the LOADADDR function. This function will return us a value that will be equal to the address of the loading section. That is, we indicated that the section was loaded in flash memory, but we use it in RAM, and in order to transfer this section, we need to know its address in flash memory, which is what the LOADADDR function returns. Meanwhile, the variables _sdata and _edata indicate the location of the section in RAM, thereby giving us the opportunity to load the data section into the correct piece of memory. Let me remind you that this is what the initialization code that we supplemented above deals with.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why do we need this linker and such difficulties with the distribution of sections of our application? The Data section is just a small example of why we need to be able to place and shift sections in memory. Below is an example of the text section that I use.</font></font><br>
<br>
<pre><code class="markdown hljs">.text (ORIGIN(ROM<span class="hljs-emphasis">_ITCM) + SIZEOF(.isr_</span>vector)): {
<span class="hljs-code">        . = ALIGN(4);
        *(.text)
    } AT&gt;ROM_AXIM</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The essence of this block is that I load the text section into flash memory as well, but use a different bus to access instructions and an ART accelerator (sort of like a regular cache). </font><font style="vertical-align: inherit;">And in order for everything to work, I indicated the load address and address during code execution, but it would not work if I did not indicate that the section should be offset. </font><font style="vertical-align: inherit;">There are many more such inventions, I will not show them all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, sections are loaded where necessary and initialized. </font><font style="vertical-align: inherit;">we have a working base for further code writing. </font><font style="vertical-align: inherit;">In the next article, we will write our first driver and blink an LED. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you all for your attention, and success in your endeavors.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491286/index.html">IPv6 only networks in US government</a></li>
<li><a href="../en491288/index.html">Polygraphists go crazy one by one</a></li>
<li><a href="../en491294/index.html">Distributed transactions for heterogeneous databases in MS .NET</a></li>
<li><a href="../en491296/index.html">Dagaz: A Persistence Story</a></li>
<li><a href="../en491298/index.html">How to find malware (no) with WinDbg</a></li>
<li><a href="../en491302/index.html">OVPN client on Grandstream phones</a></li>
<li><a href="../en491304/index.html">Helsinki: a city of happiness and comfort</a></li>
<li><a href="../en491308/index.html">ClickHouse - visually fast and intuitive data analysis in Tabix. Igor Strykhar</a></li>
<li><a href="../en491310/index.html">How to crack a password archive yourself</a></li>
<li><a href="../en491312/index.html">How we took a sieve from a man and helped the mill</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>