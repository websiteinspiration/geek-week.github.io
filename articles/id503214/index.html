<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤟🏿 ⬇️ 🐴 Memuat pengoptimalan pada proyek Highload dengan ElasticSearch 👩🏼‍🚒 👼🏼 🔺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! Nama saya Maxim Vasiliev, saya bekerja sebagai analis dan manajer proyek di FINCH. Hari ini saya ingin memberi tahu Anda caranya, mengguna...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Memuat pengoptimalan pada proyek Highload dengan ElasticSearch</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503214/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo, Habr! </font><font style="vertical-align: inherit;">Nama saya Maxim Vasiliev, saya bekerja sebagai analis dan manajer proyek di FINCH. </font><font style="vertical-align: inherit;">Hari ini saya ingin memberi tahu Anda caranya, menggunakan ElasticSearch, kami dapat memproses 15 juta kueri dalam 6 menit dan mengoptimalkan beban harian di situs salah satu klien kami. </font><font style="vertical-align: inherit;">Sayangnya, kami harus melakukannya tanpa nama, karena kami memiliki NDA, kami berharap bahwa isi artikel tidak akan terpengaruh. </font><font style="vertical-align: inherit;">Ayo pergi.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana proyek ini diatur</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di backend kami, kami menciptakan layanan yang memastikan kinerja situs dan aplikasi seluler klien kami. </font><font style="vertical-align: inherit;">Struktur umum dapat dilihat pada diagram: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sv/yw/mx/svywmxdiqxb59mwxobsses8vrc8.png" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam proses, kami memproses sejumlah besar transaksi: pembelian, pembayaran, operasi dengan saldo pengguna, di mana kami menyimpan banyak log, dan juga mengimpor dan mengekspor data ini ke sistem eksternal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada juga proses terbalik ketika kami menerima data dari klien dan mengirimkannya ke pengguna. </font><font style="vertical-align: inherit;">Selain itu, masih ada proses untuk bekerja dengan pembayaran dan program bonus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Latar belakang pendek</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Awalnya, kami menggunakan PostgreSQL sebagai satu-satunya gudang data. Keuntungan standar untuk DBMS: ketersediaan transaksi, bahasa yang dikembangkan dari pengambilan sampel data, alat yang luas untuk integrasi; ditambah dengan kinerja yang baik, orang yang puas telah lama memenuhi kebutuhan kita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami benar-benar menyimpan semua data di Postgres: dari transaksi hingga berita. Tetapi jumlah pengguna meningkat, dan dengan itu jumlah permintaan. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk memahami, jumlah sesi tahunan pada 2017 di situs desktop saja adalah 131 juta. Pada 2018, 125 juta 2019 lagi 130 juta. Tambahkan 100-200 juta lagi dari versi seluler situs dan aplikasi seluler, dan Anda akan mendapatkan sejumlah besar permintaan.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan pertumbuhan proyek, Postgres berhenti untuk mengatasi beban, kami tidak punya waktu - sejumlah besar berbagai pertanyaan muncul, di mana kami tidak dapat membuat sejumlah indeks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menyadari bahwa ada kebutuhan untuk gudang data lain yang akan menyediakan kebutuhan kami dan mengambil beban PostgreSQL. </font><font style="vertical-align: inherit;">Elasticsearch dan MongoDB dianggap sebagai opsi yang memungkinkan. </font><font style="vertical-align: inherit;">Yang terakhir hilang pada poin-poin berikut:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kecepatan pengindeksan lambat dengan peningkatan volume data dalam indeks. </font><font style="vertical-align: inherit;">Kecepatan elastis tidak tergantung pada jumlah data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak ada pencarian teks lengkap</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi kami memilih Elastis untuk diri kami sendiri dan bersiap untuk transisi. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beralih ke Elastis</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Kami memulai transisi dengan layanan pencarian titik penjualan. </font><font style="vertical-align: inherit;">Klien kami memiliki total sekitar 70.000 poin penjualan, dan memerlukan beberapa jenis pencarian di situs dan dalam aplikasi:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pencarian teks dengan nama kota</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pencarian geografis dalam radius tertentu dari beberapa titik. </font><font style="vertical-align: inherit;">Misalnya, jika pengguna ingin melihat titik penjualan mana yang paling dekat dengan rumahnya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cari berdasarkan kotak yang diberikan - pengguna menggambar kotak di peta, dan dia ditunjukkan semua titik dalam radius ini. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cari filter tambahan. </font><font style="vertical-align: inherit;">Poin penjualan berbeda satu sama lain dalam bermacam-macam</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berbicara tentang organisasi, maka di Postgres kami memiliki sumber data baik di peta dan di berita, dan di Snapshots elastis dibuat dari data asli. Faktanya adalah bahwa awalnya Postgres tidak dapat mengatasi pencarian dengan semua kriteria. Tidak hanya ada banyak indeks, mereka juga bisa berpotongan, sehingga penjadwal Postgres tersesat dan tidak mengerti indeks mana yang akan digunakan untuk itu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Baris berikutnya adalah bagian berita. Setiap hari, publikasi muncul di situs sehingga pengguna tidak tersesat dalam arus informasi, data harus diurutkan sebelum dikeluarkan. Untuk ini, Anda perlu pencarian: di situs Anda dapat mencari berdasarkan teks, dan pada saat yang sama menghubungkan filter tambahan, karena mereka juga dibuat melalui Elastis.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Kemudian kami memindahkan pemrosesan transaksi. </font><font style="vertical-align: inherit;">Pengguna dapat membeli produk tertentu di situs dan berpartisipasi dalam pengundian hadiah. </font><font style="vertical-align: inherit;">Setelah pembelian seperti itu, kami memproses sejumlah besar data, terutama pada akhir pekan dan hari libur. </font><font style="vertical-align: inherit;">Sebagai perbandingan, jika pada hari-hari biasa jumlah pembelian berkisar antara 1,5-2 juta, maka pada hari libur angkanya dapat mencapai 53 juta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat yang sama, data perlu diproses dalam waktu minimum - pengguna tidak suka menunggu hasil selama beberapa hari. </font><font style="vertical-align: inherit;">Anda tidak akan mencapai tenggat waktu tersebut melalui Postgres - kami sering mendapatkan kunci, dan sementara kami memproses semua permintaan, pengguna tidak dapat memeriksa apakah mereka menerima hadiah atau tidak. </font><font style="vertical-align: inherit;">Ini tidak terlalu menyenangkan untuk bisnis, jadi kami memindahkan pemrosesan ke Elasticsearch.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periodisitas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang pembaruan dikonfigurasikan berdasarkan peristiwa, dengan ketentuan berikut:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Titik penjualan. </font><font style="vertical-align: inherit;">Segera setelah data dari sumber eksternal datang kepada kami, kami segera memulai pembaruan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berita. </font><font style="vertical-align: inherit;">Segera setelah ada berita yang diedit di situs, itu secara otomatis dikirim ke Elastis.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini sekali lagi, perlu disebutkan kelebihan dari Elastis. </font><font style="vertical-align: inherit;">Di Postgres, saat mengirim permintaan, Anda harus menunggu sampai semua catatan diproses dengan jujur. </font><font style="vertical-align: inherit;">Anda dapat mengirim 10 ribu catatan ke Elastik, dan segera mulai bekerja, tanpa menunggu hingga catatan didistribusikan di semua Shard. </font><font style="vertical-align: inherit;">Tentu saja, beberapa Shard atau Replika mungkin tidak melihat data segera, tetapi segera semuanya akan tersedia.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metode Integrasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada 2 cara untuk berintegrasi dengan Elastis:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melalui klien asli melalui TCP. </font><font style="vertical-align: inherit;">Pengemudi asli secara bertahap sekarat: tidak lagi didukung, ia memiliki sintaks yang sangat tidak nyaman. </font><font style="vertical-align: inherit;">Karenanya, kami praktis tidak menggunakannya dan mencoba untuk sepenuhnya mengabaikannya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melalui antarmuka HTTP tempat Anda dapat menggunakan permintaan JSON dan sintaks Lucene. </font><font style="vertical-align: inherit;">Yang terakhir adalah mesin teks yang menggunakan Elastis. </font><font style="vertical-align: inherit;">Dalam opsi ini, kami mendapatkan kemampuan untuk Batch melalui permintaan JSON melalui HTTP. </font><font style="vertical-align: inherit;">Ini adalah opsi yang kami coba gunakan.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berkat antarmuka HTTP, kami dapat menggunakan perpustakaan yang menyediakan implementasi asinkron dari klien HTTP. </font><font style="vertical-align: inherit;">Kita dapat mengambil keuntungan dari Batch dan API asinkron, yang pada akhirnya memberikan kinerja tinggi, yang banyak membantu di hari-hari aksi besar (lebih lanjut di bawah ini) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beberapa angka untuk dibandingkan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyimpan pengguna yang menerima hadiah di Postgres dalam 20 aliran tanpa pengelompokan: 460.713 entri dalam 42 detik</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klien elastis + reaktif untuk 10 utas + kumpulan untuk 1000 elemen: 596749 mencatat dalam 11 detik</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klien elastis + reaktif untuk 10 utas + kumpulan untuk 1000 elemen: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23801684 catatan dalam 4 menit</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kami telah menulis manajer permintaan HTTP yang membangun JSON sebagai Batch / bukan Batch dan mengirimkannya melalui klien HTTP apa pun, terlepas dari pustaka. </font><font style="vertical-align: inherit;">Anda juga dapat memilih untuk mengirim permintaan secara sinkron atau asinkron. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam beberapa integrasi, kami masih menggunakan klien transportasi resmi, tetapi ini hanya masalah refactoring yang akan datang. </font><font style="vertical-align: inherit;">Pada saat yang sama, klien khusus yang dibangun berdasarkan Spring WebClient digunakan untuk diproses.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x2/sx/qg/x2sxqgijaic0-ldqbrjlwse_tp0.jpeg" alt="gambar"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promosi besar</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setahun sekali, kampanye besar untuk pengguna dilakukan di proyek - ini adalah Highload yang sama, karena saat ini kami bekerja dengan puluhan juta pengguna pada saat yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biasanya beban puncak terjadi selama liburan, tetapi tingkat promosi ini sangat berbeda. Tahun sebelumnya, pada hari promosi, kami menjual 27.580.890 unit barang. Data diproses selama lebih dari setengah jam, yang menyebabkan ketidaknyamanan bagi pengguna. Pengguna menerima hadiah untuk berpartisipasi, tetapi menjadi jelas bahwa proses tersebut perlu dipercepat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada awal 2019, kami memutuskan bahwa kami membutuhkan ElasticSearch. Selama satu tahun penuh, kami mengatur pemrosesan data yang diterima dalam Elastis dan hasilnya dalam api aplikasi dan situs seluler. Akibatnya, tahun berikutnya selama kampanye kami memproses </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15 131 783 catatan dalam 6 menit.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena kami memiliki banyak orang yang ingin membeli barang dan berpartisipasi dalam pengundian hadiah dalam promosi, ini adalah tindakan sementara. </font><font style="vertical-align: inherit;">Sekarang kami mengirim informasi yang relevan ke Elastic, tetapi di masa depan kami berencana untuk mentransfer informasi arsip dari bulan-bulan terakhir ke Postgres sebagai repositori permanen. </font><font style="vertical-align: inherit;">Agar tidak menyumbat indeks elastis, yang juga memiliki keterbatasan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan / Kesimpulan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat ini, kami telah mentransfer ke Elastic semua layanan yang kami inginkan dan telah dihentikan sementara untuk saat ini. </font><font style="vertical-align: inherit;">Sekarang kami sedang membangun indeks di Elastic di atas penyimpanan persisten utama di Postgres, yang mengambil beban pengguna. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di masa mendatang, kami berencana untuk mentransfer layanan jika kami memahami bahwa permintaan data menjadi terlalu beragam dan dicari dengan jumlah kolom yang tidak terbatas. </font><font style="vertical-align: inherit;">Ini bukan lagi tugas untuk Postgres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita memerlukan pencarian teks lengkap di fungsional, atau jika kita memiliki banyak kriteria pencarian yang berbeda, maka kita sudah tahu bahwa ini perlu diterjemahkan ke dalam Elastis.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">⌘⌘⌘</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terima kasih sudah membaca. </font><font style="vertical-align: inherit;">Jika perusahaan Anda juga menggunakan ElasticSearch dan memiliki kasus implementasi sendiri, beri tahu kami. </font><font style="vertical-align: inherit;">Akan menarik mengetahui apa yang dimiliki orang lain :-)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id503200/index.html">YOLOv4 - jaringan saraf real-time paling akurat pada dataset COCO Microsoft</a></li>
<li><a href="../id503204/index.html">Cara mem-flash Xiaomi Redmi 4 Prime / Pro / Premium di Android 10</a></li>
<li><a href="../id503208/index.html">Kapan waktu terbaik untuk berinvestasi?</a></li>
<li><a href="../id503210/index.html">Apakah situs phishing dapat diberantas?</a></li>
<li><a href="../id503212/index.html">30 hacks kehidupan untuk menyelesaikan kursus online</a></li>
<li><a href="../id503218/index.html">GlobalSign Memperkenalkan Atlas - Platform PKI Generasi Selanjutnya</a></li>
<li><a href="../id503226/index.html">Apa yang menghentikan bisnis dari pindah ke "angka" dan apa hubungannya dengan reputasi</a></li>
<li><a href="../id503228/index.html">Kontrol detak jantung saat jogging melalui umpan balik musik - atau "penguji yang suka berlari sedang mencari"</a></li>
<li><a href="../id503230/index.html">Sistem kelas Platform Respons Insiden: aplikasi dan fungsi utama</a></li>
<li><a href="../id503232/index.html">Bagaimana menjadi insinyur DevOps dalam enam bulan atau bahkan lebih cepat. Bagian 6. Meluncurkan aplikasi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>