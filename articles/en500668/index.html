<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë£ üßùüèΩ üë©üèø‚Äçüéì Wireless motor control from Lego using Steam Controller üöÜ ‚ù§Ô∏è üìú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I was young, I always wanted to have Lego Technics kits to collect all sorts of cool stuff from them. Autonomous tanks with rotating turrets firi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wireless motor control from Lego using Steam Controller</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500668/"><img src="https://habrastorage.org/webt/to/-q/fh/to-qfh-f6as72siykacsf0u_8du.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When I was young, I always wanted to have Lego Technics kits to collect all sorts of cool stuff from them. Autonomous tanks with rotating turrets firing Lego bricks. But then I didn‚Äôt have such a set. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And even the usual bricks from Lego were not. I had only a friend whose brother had all these expensive toys. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now I have a son of his own age. And he builds tanks that ... stupidly stick forward until they hit the wall :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now, the time has come for ESP32 and the magic of the soldering iron - we will assemble the right remote control for them!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, of course, I know about the existence of such remotes. </font><font style="vertical-align: inherit;">But not one of them suits me completely. </font><font style="vertical-align: inherit;">They are either infrared, with technology of the 80s, or too large. </font><font style="vertical-align: inherit;">Or expensive. </font><font style="vertical-align: inherit;">And most importantly - I can‚Äôt say to my son about any of them: ‚ÄúI did it especially for you!‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So let's make a new, improved remote to rule everyone!</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/getpro/habr/post_images/ffa/c72/7fd/ffac727fd7f9547d36657745fe7ea3a1.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ingredients:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP32-WROOM-32D | </font><font style="vertical-align: inherit;">WiFi, BLE and a processor with I / O - enough to control two </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">motors</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DRV8833 | </font><font style="vertical-align: inherit;">double H-bridge with enough power for motors.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPS62162 | </font><font style="vertical-align: inherit;">lowering voltage to 17 V, as well as for entertainment when soldering the case WSON-8 2 √ó 2 mm</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CP2104 | </font><font style="vertical-align: inherit;">for programming ESP32</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>     .      ,   Lego  .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All this will be placed on a rather small board - here is its appearance in the EasyEDA editor: The </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/3c8/4af/b81/3c84afb81433206ebf31adbfde2b8700.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
wire that is visible in the header photo is not needed to fix any errors, but to supply power from USB. It may not be enough for the motor, but, unfortunately, contacts from China still have not come to me. Therefore, I first check the operation of the LEDs. For the beauty in the photo, I just put the connector from the motor on the board. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On version 1.1 of my board (unlike version 1.2, which is already on EasyEDA), there were no LEDs, so I soldered two anti-parallel diodes to the output so that what was happening was visible. If you look closely, the video shows the alternate inclusion of a pair of 0603 diodes, indicating forward / backward movement.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/UX0iBoP1utU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As for the control panel, at first I just wanted to collect an additional board with buttons and another ESP32 - a classic remote control. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, then I remembered that Steam Controllers have a Bluetooth Low Energy Mode (BLE). I decided to tackle this issue, and after a few hours I learned how to receive packets from the controller. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, simply search for the HID device that calls itself SteamController and connect to it. And then use Valve's undocumented service and a few </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">undocumented commands</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that allow packet transfers. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2f7/fb5/877/2f7fb5877ff2dae71c57c405b3e4c5d4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And I also came across an undocumented report format, which I parsed manually.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/22c/8ab/3db/22c8ab3db50e5ac2a0fb6c0c48a2701e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After about an hour, the meaning of the flags and values ‚Äã‚Äãbecame clear to me, and I managed to blink the LED using the Steam controller and ESP32. </font><font style="vertical-align: inherit;">¬Ø \ _ („ÉÑ) _ / ¬Ø</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Files</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EasyEDA circuit board and board </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">easyeda.com/EFS-GH/legoremote</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources for Arduino: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/g3gg0/LegoRemote</font></font></a></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v1.0:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äútrial approach‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - the first option for which I chose the wrong voltage regulator. TPS62291 raises the voltage only to 6 V. I developed several projects in parallel, and I forgot that the device needs to work with 9 V. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v1.1:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äúgood enough‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - this option is visible in the commercials, and everything works </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v1.2:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äúfinal‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - added indicator LEDs to the output and optimized the size and layout of the board. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next short video shows the connection phase (1-3 seconds after turning on the power) and control of the motor outputs. The Lego connector is not yet connected. It will go to an empty space next to the other connectors, marked with a white rectangle.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-2-QGO-eoNQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My son now regularly uses this controller to control the devices he has assembled. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the stress test, I encountered only one problem: I thought that the ‚Äúfast decay‚Äù mode of the motor driver would work best, but because of it, after a few seconds of operation, the motor speed would drop very much. </font><font style="vertical-align: inherit;">So I changed the code so that it used ‚Äúslow decay‚Äù. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c1e/e09/921/c1ee09921222a6c99fa4dce4395ca4a7.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far I‚Äôm not sure how the DRV works and why the motor first rotates quickly, and then after 10 seconds it starts to slow down gradually. </font><font style="vertical-align: inherit;">Perhaps the MOSFETs are warming up and their resistance rises too much.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/aIFafodKasQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope this example of using Arduino effortlessly inspires other people and allows them to introduce their children to electronics.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500648/index.html">What is an architectural model of company maturity?</a></li>
<li><a href="../en500654/index.html">WebRTC on Android: how to enable hardware encoding on multiple devices</a></li>
<li><a href="../en500656/index.html">Hierarchical logging of the application to the database</a></li>
<li><a href="../en500660/index.html">A simplified and very short history of the development of "clouds"</a></li>
<li><a href="../en500666/index.html">Microsoft online certification - you, your space, and your computer</a></li>
<li><a href="../en500670/index.html">How we create our product. Part One, Research</a></li>
<li><a href="../en500672/index.html">Continuation of the stream for testers and not only</a></li>
<li><a href="../en500676/index.html">Announcement of an online workshop on test automation</a></li>
<li><a href="../en500678/index.html">ClickHouse for Advanced Users in Questions and Answers</a></li>
<li><a href="../en500688/index.html">Working with a database in Flask: from June to June</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>