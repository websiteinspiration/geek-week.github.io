<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® üôéüèº üëÜüèª T√°ticas da equipe vermelha: t√©cnicas avan√ßadas de monitoramento de processos em opera√ß√µes ofensivas üë©üèª‚Äçüî¨ üö£üèΩ üòÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° de novo. Na v√©spera do Pentest. Pr√°tica de teste de penetra√ß√£o ‚Äù traduziu outro material interessante para voc√™.
 
 
 
 Neste artigo, entenderemos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>T√°ticas da equipe vermelha: t√©cnicas avan√ßadas de monitoramento de processos em opera√ß√µes ofensivas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/498544/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° de novo. </font><font style="vertical-align: inherit;">Na v√©spera do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pentest. </font><font style="vertical-align: inherit;">Pr√°tica de teste de penetra√ß√£o ‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traduziu outro material interessante para voc√™.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/av/qe/wo/avqewourhsmerqakgy0q9hqbk-e.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, entenderemos os recursos dos conhecidos utilit√°rios de monitoramento de processos e demonstraremos como usar a tecnologia subjacente a essas ferramentas nas opera√ß√µes ofensivas da Red Team. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um bom entendimento t√©cnico do sistema em que confiamos √© um crit√©rio-chave para tomar decis√µes sobre qual ser√° o pr√≥ximo passo da opera√ß√£o. A coleta e an√°lise de dados sobre processos em execu√ß√£o em sistemas comprometidos nos fornece uma riqueza de informa√ß√µes e nos ajuda a entender como a infraestrutura de TI da organiza√ß√£o de destino funciona. Al√©m disso, os dados do processo solicitados periodicamente nos ajudam a responder √†s mudan√ßas ambientais e a receber sinais de gatilho quando uma investiga√ß√£o come√ßa.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para poder coletar dados detalhados sobre processos em terminais comprometidos, criamos um conjunto de ferramentas que reuniam o poder de utilit√°rios de processos avan√ßados e estruturas C2 (como o Cobalt Strike). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ferramentas (e seu c√≥digo fonte) podem ser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encontradas aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilit√°rios de sistema interno do Windows</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar, descobriremos quais utilit√°rios podem ser usados ‚Äã‚Äãpara coletar informa√ß√µes sobre os processos do computador no Windows. </font><font style="vertical-align: inherit;">Em seguida, aprendemos como esses utilit√°rios coletam informa√ß√µes para que possam ser usadas posteriormente nos kits de ferramentas do Red Team.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sistema operacional Windows est√° equipado com muitos utilit√°rios prontos para administrar o sistema. Embora a maioria das ferramentas fornecidas seja adequada para fins b√°sicos de administra√ß√£o do sistema, algumas delas n√£o possuem as fun√ß√µes necess√°rias para solu√ß√£o de problemas e monitoramento avan√ßados. Por exemplo, o gerenciador de tarefas do Windows fornece informa√ß√µes b√°sicas sobre todos os processos em execu√ß√£o no sistema, mas e se precisarmos de informa√ß√µes mais detalhadas, como descritores de objetos, conex√µes de rede ou m√≥dulos carregados como parte de um processo espec√≠fico? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para coletar essas informa√ß√µes, existe uma ferramenta mais avan√ßada. Por exemplo, utilit√°rios de sistema do pacote </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sysinternals</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Como membro da equipe vermelha, com vasta experi√™ncia em administra√ß√£o de redes e sistemas, sempre fui um grande f√£ da Sysinternals. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao solucionar problemas de um sistema de servidor de execu√ß√£o lenta ou de um computador cliente infectado, geralmente comecei a solucionar problemas usando ferramentas como Process Explorer ou Procmon. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do ponto de vista da ci√™ncia forense digital, essas ferramentas tamb√©m parecem ser muito √∫teis para realizar an√°lises din√¢micas b√°sicas de amostras de malware e procurar artefatos em sistemas infectados. Ent√£o, por que essas ferramentas s√£o t√£o populares entre os administradores de sistema e profissionais de seguran√ßa? Vamos descobrir isso, investigando algumas informa√ß√µes do processo que podemos obter usando a ferramenta Process Explorer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando o Process Explorer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira coisa que vemos ao iniciar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process Explorer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma lista / √°rvore de todos os processos em execu√ß√£o do sistema. </font><font style="vertical-align: inherit;">Isso nos fornece informa√ß√µes sobre os nomes dos processos, seus identificadores, o contexto do usu√°rio e o n√≠vel de integridade das informa√ß√µes do processo e da vers√£o. </font><font style="vertical-align: inherit;">Informa√ß√µes adicionais tamb√©m podem ser refletidas ajustando as colunas de acordo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9d/9s/fk/9d9sfkhmwl222wp8vlzcuhcw85y.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se usarmos o painel inferior, podemos visualizar todos os m√≥dulos carregados por um processo espec√≠fico ou alternar para exibir descritores para familiarizar-nos com todos os objetos descritores nomeados que s√£o usados ‚Äã‚Äãpelo processo:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ba/ss/ei/bassei2hnk4jg_kuyl2xd3maihg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A navega√ß√£o nos m√≥dulos pode ser √∫til ao procurar bibliotecas maliciosas carregadas no processo ou, para o Red Team, √© um produto de seguran√ßa ativo (por exemplo, EDR) que implementou um m√≥dulo de conex√£o API no modo de usu√°rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ly/f0/sn/lyf0snflh_begeau_5pjbtwhtis.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 A mudan√ßa para a exibi√ß√£o de descritores permite que voc√™ se familiarize com o tipo e o nome de todos os objetos nomeados usados ‚Äã‚Äãno processo. Isso pode ser √∫til para descobrir quais arquivos e chaves do registro est√£o abertos, quais pipes nomeados s√£o usados ‚Äã‚Äãpara comunica√ß√£o entre processos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Se voc√™ clicar duas vezes no nome do processo, uma janela com informa√ß√µes mais detalhadas ser√° exibida. Vejamos algumas guias para aprender sobre as propriedades adicionais do objeto: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mx/cr/k-/mxcrk-tik-hny6ailuno3pksvs4.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exibe informa√ß√µes sobre o caminho bin√°rio, diret√≥rio de trabalho e op√ß√µes de linha de comando. Al√©m disso, exibe informa√ß√µes sobre o contexto do usu√°rio, o processo pai, o tipo de imagem (x86 ou x64) e muito mais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-i/_o/bu/-i_obubvbxw47snh32g2ysmp7yg.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 A guia </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Threads</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cont√©m informa√ß√µes sobre a execu√ß√£o de threads no processo. Quando voc√™ seleciona um fluxo e clica nele, o bot√£o de pilha reflete a pilha de chamadas para esse fluxo espec√≠fico. Para visualizar os threads / chamadas iniciados no modo kernel, o Process Explorer usa o driver do kernel, instalado quando se trabalha no modo elevado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do ponto de vista do DFIR, as informa√ß√µes do encadeamento s√£o √∫teis para detectar inje√ß√µes na mem√≥ria, por exemplo, quando h√° uma amea√ßa de v√≠rus sem arquivos. </font><font style="vertical-align: inherit;">Assim, os fluxos que n√£o s√£o apoiados por arquivos no disco podem sinalizar comportamento suspeito. </font><font style="vertical-align: inherit;">Para obter mais informa√ß√µes sobre threads e mem√≥ria, recomendo prestar aten√ß√£o √† ferramenta </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process Hacker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3w/_s/0s/3w_s0sra5w6xq4_jf56lbg7czu4.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Outra guia interessante no Process Explorer √© a guia TCP / IP. </font><font style="vertical-align: inherit;">Nele, voc√™ ver√° todas as conex√µes de rede associadas a esse processo. </font><font style="vertical-align: inherit;">Do ponto de vista do ataque, isso pode ser √∫til para entender quando uma conex√£o √© feita a partir de um sistema comprometido. </font><font style="vertical-align: inherit;">Uma sess√£o remota do PowerShell ou uma sess√£o RDP de entrada pode sinalizar que uma investiga√ß√£o j√° foi iniciada.</font></font><br>
 <br>
 <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando os m√©todos discutidos para ataque</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Agora que aprendemos algumas coisas interessantes sobre processos e sobre as informa√ß√µes que podemos coletar sobre eles usando o Process Explorer, voc√™ pode se perguntar como acessar essas informa√ß√µes em nossas estruturas C2 favoritas. Obviamente, poder√≠amos usar o PowerShell, pois isso nos daria a oportunidade de usar uma linguagem de script poderosa e a API do Windows. No entanto, hoje o PowerShell est√° sob a supervis√£o constante do servi√ßo de seguran√ßa, por isso tentamos evitar esse m√©todo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cobalt Strike,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podemos usar o comando ps no contexto de beacons. Este comando exibe informa√ß√µes b√°sicas sobre o processo com base em todos os processos em execu√ß√£o no sistema. Em combina√ß√£o com um script </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@r3dQu1nn ProcessColor</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, √© prov√°vel que este m√©todo seja o melhor para obter dados do processo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A sa√≠da do comando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ps</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><font style="vertical-align: inherit;">√∫til para classificar rapidamente os processos em execu√ß√£o, mas eles n√£o cont√™m informa√ß√µes detalhadas que ajudar√£o voc√™ a entender melhor o sistema. </font><font style="vertical-align: inherit;">Para coletar informa√ß√µes mais detalhadas, criamos nossos pr√≥prios utilit√°rios para obter informa√ß√µes sobre processos. </font><font style="vertical-align: inherit;">Com a ajuda deles, podemos coletar e enriquecer informa√ß√µes obtidas de sistemas comprometidos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ps Tools </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 N√£o √© f√°cil replicar a funcionalidade e as informa√ß√µes fornecidas por uma ferramenta como o Process Explorer. Primeiro, precisamos descobrir como essas ferramentas funcionam sob o cap√¥ (e no modo de usu√°rio); depois, precisamos entender como refletir melhor essas informa√ß√µes no console, e n√£o na interface gr√°fica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s analisar o c√≥digo-fonte, ficou claro que muitas ferramentas de baixo n√≠vel para fornecer informa√ß√µes do sistema se baseiam amplamente na API </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtQuerySystemInformation</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nativa </font><font style="vertical-align: inherit;">. Embora a API e suas estruturas associadas n√£o estejam totalmente documentadas, essa API permite coletar muitas informa√ß√µes sobre o sistema Windows. Ent√£o, usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtQuerySystemInformation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como ponto de partida para coletar informa√ß√µes sobre os processos em execu√ß√£o no sistema, usaremos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PEB de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processos individuais para coletar informa√ß√µes detalhadas sobre cada um deles. </font><font style="vertical-align: inherit;">Usando a API </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtQueryInformationProcess,</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podemos ler a estrutura </font></font><code>PROCESS_BASIC_INFORMATION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usando o descritor de processo e localiz√°-la </font></font><code>PebBaseAddress</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Em seguida, usamos a </font></font><code>NtReadVirtualMemory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API para ler a estrutura </font></font><code>RTL_USER_PROCESS_PARAMETERS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o que nos permitir√° descobrir os par√¢metros </font></font><code>ImagePathName</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e o </font></font><code>CommandLine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando essas APIs como base do nosso c√≥digo, escrevemos as seguintes ferramentas para obter informa√ß√µes sobre processos:</font></font><br>
<br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : mostra uma lista detalhada de todos os processos em execu√ß√£o no sistema.</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psk</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : exibe informa√ß√µes do kernel, incluindo drivers carregados.</font></font></li>
<li><i>Psc</i>:        TCP-.</li>
<li><i>Psm</i>:          (    , ).</li>
<li><i>Psh</i>:         (,  ,  ).</li>
<li><i>Psw</i>:        .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Todas essas ferramentas s√£o escritas em C como DLLs reflexivas e podem ser incorporadas reflexivamente a um processo gerado usando uma estrutura C2 como o Cobalt Strike (ou qualquer outra estrutura que suporte inje√ß√µes reflexivas de DLL). </font><font style="vertical-align: inherit;">Para o Cobalt Strike, adicionamos um script agressor que pode ser usado para carregar ferramentas usando o gerenciador de scripts do Cobalt Strike. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vejamos cada ferramenta espec√≠fica lan√ßada no Cobalt Strike para demonstrar a funcionalidade e mostrar quais informa√ß√µes podem ser coletadas usando-a:</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psx</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Essa ferramenta mostra uma lista detalhada de todos os processos em execu√ß√£o no sistema. A sa√≠da pode ser comparada com as informa√ß√µes na tela principal do Process Explorer. Psx exibe o nome do processo, sua identifica√ß√£o, PID pai, hor√°rio de cria√ß√£o e informa√ß√µes relacionadas aos arquivos bin√°rios do processo (arquitetura, nome da empresa, vers√£o etc.). Como voc√™ pode ver, ele tamb√©m exibe algumas informa√ß√µes interessantes sobre o kernel ativo do sistema, por exemplo, o endere√ßo base do kernel, que √© √∫til ao operar o kernel (por exemplo, para calcular as compensa√ß√µes dos dispositivos ROP). Todas essas informa√ß√µes podem ser coletadas de um contexto normal do usu√°rio (sem eleva√ß√£o de privil√©gios).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ni/jt/be/nijtbefsyhpct-kkpkxpwdp4pvc.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Se tivermos permiss√µes suficientes para abrir o descritor de processo, voc√™ poder√° ler informa√ß√µes adicionais, como o contexto do usu√°rio e o n√≠vel de integridade de seu token. </font><font style="vertical-align: inherit;">A enumera√ß√£o de PEB e estruturas relacionadas permite obter informa√ß√µes sobre o caminho da imagem e os par√¢metros da linha de comando: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-d/hu/bm/-dhubmeevabpdhf1_-f_wpq8q9c.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Como voc√™ deve ter notado, lemos e exibimos informa√ß√µes de vers√£o de imagens de processos bin√°rios, por exemplo, nome e descri√ß√£o da empresa. </font><font style="vertical-align: inherit;">Conhecendo o nome da empresa, voc√™ pode listar facilmente todos os produtos de seguran√ßa ativos no sistema. </font><font style="vertical-align: inherit;">Usando esta ferramenta, comparamos os nomes das empresas de todos os processos ativos com uma lista de fornecedores conhecidos de produtos de seguran√ßa e exibimos os resultados:</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/xv/c4/nf/xvc4nflmu_fzxkgjq8wuq5zkd0m.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psk</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Essa ferramenta reflete informa√ß√µes sobre o kernel em execu√ß√£o, incluindo todos os m√≥dulos de driver carregados. </font><font style="vertical-align: inherit;">Como a ferramenta Psx, ela tamb√©m fornece um resumo de todos os m√≥dulos do kernel carregados de produtos de seguran√ßa conhecidos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oe/mr/ii/oemrii004bpzkatpi1solktzfvq.png"><br>
 <br>
 <h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psc</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Essa ferramenta usa os mesmos m√©todos para exibir informa√ß√µes sobre processos ativos que o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , exceto que exibe apenas processos com uma conex√£o de rede ativa (IPv4, IPv6 TCP, RDP, ICA):</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/m9/gf/su/m9gfsulxhhfcacdvaofmpmxvdpy.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Voc√™ pode usar esta ferramenta para obter informa√ß√µes detalhadas sobre um processo espec√≠fico. </font><font style="vertical-align: inherit;">Ele exibir√° uma lista de todos os m√≥dulos (DLLs) usados ‚Äã‚Äãpelo processo e pela conex√£o de rede:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yu/5x/wc/yu5xwczhban43kmlv5kjjg7o8v8.png"><br>
 <br>
 <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psh</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 O mesmo que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psm</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas em vez de m√≥dulos carregados, ele mostra uma lista de descritores de processo:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-q/ok/nt/-qokntyj-1pdgaetariouoyi15a.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psw</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 A √∫ltima, mas n√£o menos importante, ferramenta de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Psw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Essa ferramenta mostra uma lista de processos com identificadores de janela ativos, aqueles que s√£o abertos na √°rea de trabalho do usu√°rio, incluindo t√≠tulos de janela. </font><font style="vertical-align: inherit;">Isso √© √∫til para determinar qual aplicativo gr√°fico faz a interface que o usu√°rio abre sem ter que tirar capturas de tela da √°rea de trabalho:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tj/ah/zg/tjahzg3ck9ed8-9of7hvv0krrl4.png"><br>
 <br>
 <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Casos de uso</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Voc√™ pode se perguntar: "E como tudo isso nos ajuda em opera√ß√µes ofensivas?" </font><font style="vertical-align: inherit;">Depois de obter acesso a um ativo comprometido, geralmente usamos essas informa√ß√µes para os seguintes fins:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecte ferramentas de seguran√ßa em um ativo comprometido. </font><font style="vertical-align: inherit;">N√£o apenas pelas informa√ß√µes do processo, mas tamb√©m pelos m√≥dulos carregados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detectando mecanismos de gancho personalizados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procure oportunidades de manobras (atrav√©s de sess√µes de rede) e escalada de privil√©gios.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s o primeiro compromisso, voc√™ pode solicitar periodicamente informa√ß√µes semelhantes sobre os processos e come√ßar a criar acionadores. </font><font style="vertical-align: inherit;">Por exemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inserimos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> automaticamente essas informa√ß√µes no </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">RedELK</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Em seguida, voc√™ pode criar alertas sobre altera√ß√µes suspeitas nas informa√ß√µes do processo, como:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicie uma ferramenta de auditoria de seguran√ßa ou instale um novo produto de seguran√ßa de terminal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conex√µes de rede de entrada do departamento de seguran√ßa por meio de uma sess√£o RDP ou do PowerShell remoto.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abrir um identificador por outro processo em um de nossos artefatos maliciosos (por exemplo, um arquivo usado para preservar a presen√ßa).</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, mostramos como ferramentas como o Sysinternals Process Explorer podem ser usadas para obter informa√ß√µes detalhadas sobre os processos em execu√ß√£o no sistema e como essas informa√ß√µes podem ajudar administradores e profissionais de seguran√ßa a solucionar problemas e verificar o sistema quanto a problemas de seguran√ßa ou desempenho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A mesma informa√ß√£o tamb√©m √© relevante e √∫til para o Red Team, que tem acesso a sistemas comprometidos durante a opera√ß√£o. Isso ajuda a entender melhor o sistema e a infraestrutura de TI de seu objetivo, e a pesquisa peri√≥dica de um sistema desse tipo permite que a Equipe Vermelha responda a poss√≠veis altera√ß√µes no ambiente (por exemplo, um gatilho de investiga√ß√£o).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Replicamos algumas das funcionalidades fornecidas por ferramentas como o Process Explorer, para que possamos usar as mesmas informa√ß√µes em opera√ß√µes ofensivas. </font><font style="vertical-align: inherit;">Para isso, foram criadas v√°rias ferramentas de monitoramento de processo que podem ser usadas como parte da estrutura C2, por exemplo, Cobalt Strike. </font><font style="vertical-align: inherit;">Mostramos como usar essas ferramentas e quais informa√ß√µes voc√™ pode usar para colet√°-las. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essas ferramentas est√£o dispon√≠veis na nossa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p√°gina do GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e est√£o prontas para serem usadas como parte do Cobalt Strike.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saiba mais sobre o curso.</font></font><br>
</a><br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt498534/index.html">Reconhecimento de documentos e pessoas: uma uni√£o em nome da liberdade ou um passo em dire√ß√£o a uma ditadura digital?</a></li>
<li><a href="../pt498536/index.html">Como reutilizar c√≥digo com pacotes symfony 5? Parte 2. Retiramos o c√≥digo no pacote</a></li>
<li><a href="../pt498538/index.html">Meu sapo lindo</a></li>
<li><a href="../pt498540/index.html">Infogr√°ficos usando Excel e PowerPoint. Parte 2</a></li>
<li><a href="../pt498542/index.html">Aula pr√°tica "Pesquisando malware na IoT"</a></li>
<li><a href="../pt498548/index.html">Criando seu pr√≥prio pacote para o Laravel Nova: OptimalImage</a></li>
<li><a href="../pt498552/index.html">Quais erros os gerentes em um site remoto</a></li>
<li><a href="../pt498556/index.html">Hans Peter Lun e o nascimento do algoritmo de hash</a></li>
<li><a href="../pt498560/index.html">Componentes da Web em um projeto real</a></li>
<li><a href="../pt498562/index.html">Ao contr√°rio da quarentena: como transferimos nossos est√°gios para um formato remoto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>