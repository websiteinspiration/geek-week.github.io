<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙉 👨🏽‍✈️ 🌹 初心者向け3Dゲームシェーダー 🙎🏻 🏧 👉🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="テクスチャ、ライティング、シャドウ、法線マップ、光るオブジェクト、アンビエントオクルージョン、その他のエフェクトを3Dゲームに追加する方法を学びたいですか？いいね！この記事では、ゲームのグラフィックスのレベルを新たな高さに上げることができる一連のシェーディングテクニックを紹介します。Godot、Un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>初心者向け3Dゲームシェーダー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453300/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ba2/494/983/ba2494983fe869e14d259f717aa8fc19.gif" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テクスチャ、ライティング、シャドウ、法線マップ、光るオブジェクト、アンビエントオクルージョン、その他のエフェクトを3Dゲームに追加する方法を学びたいですか？</font><font style="vertical-align: inherit;">いいね！</font><font style="vertical-align: inherit;">この記事では、ゲームのグラフィックスのレベルを新たな高さに上げることができる一連のシェーディングテクニックを紹介します。</font><font style="vertical-align: inherit;">Godot、Unity、その他のツールスタックにこの情報を適用/移植できるように、各手法を説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シェーダー間の「接着剤」として、私は素晴らしいゲームエンジンであるPanda3DとOpenGLシェーディング言語（GLSL）を使用することにしました。</font><font style="vertical-align: inherit;">同じスタックを使用すると、さらに利点が得られます-特にPanda3DとOpenGLでシェーディングテクニックを使用する方法を学習します。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、サンプルコードの開発とテストに使用したシステムです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">水曜日</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サンプルコードは、次の環境で開発およびテストされました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linuxマンジャロ4.9.135-1-MANJARO</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenGLレンダラー文字列：GeForce GTX 970 / PCIe / SSE2</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenGLバージョン文字列：4.6.0 NVIDIA 410.73</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">g ++（GCC）8.2.1 20180831</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panda3D 1.10.1-1</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">材料</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">使用される</font><font style="vertical-align: inherit;">
各</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blender</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マテリアル</font></font><code>mill-scene.egg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">には2つのテクスチャがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のテクスチャは法線マップ、2番目は拡散マップです。</font><font style="vertical-align: inherit;">オブジェクトが頂点の法線を使用する場合、「プレーンブルー」の法線マップが使用されます。</font><font style="vertical-align: inherit;">すべてのモデルの同じ位置に同じカードがあるため、シェーダーを一般化してシーングラフのルートノードに適用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シーングラフは</font><font style="vertical-align: inherit;">Panda3Dエンジン</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装の機能で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある</font><font style="vertical-align: inherit;">ことに注意してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/19f/9c0/14f/19f9c014f06aee0e2204aa95f87c6306.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、colorのみを含む1色の法線マップ</font></font><code>[red = 128, green = 128, blue = 255]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この色は単位法線を示し、z軸の正の方向を示します</font></font><code>[0, 0, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs">[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>] =<font></font>
  [ round((<span class="hljs-number">0</span> * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>) * <span class="hljs-number">255</span>)<font></font>
  , round((<span class="hljs-number">0</span> * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>) * <span class="hljs-number">255</span>)<font></font>
  , round((<span class="hljs-number">1</span> * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>) * <span class="hljs-number">255</span>)<font></font>
  ] =<font></font>
    [<span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">255</span>] =<font></font>
      [ round(<span class="hljs-number">128</span> / <span class="hljs-number">255</span> * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>)<font></font>
      , round(<span class="hljs-number">128</span> / <span class="hljs-number">255</span> * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>)<font></font>
      , round(<span class="hljs-number">255</span> / <span class="hljs-number">255</span> * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>)<font></font>
      ] =<font></font>
        [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、単位法線</font></font><code>[0, 0, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が無地の青色に変換され、青一色</font></font><code>[128, 128, 255]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が単位法線に変換されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これについては、法線マップマッピングテクニックのセクションで詳しく説明します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panda3d</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコード例で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、シェーダー間の「接着剤」として</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Panda3Dが</font></a><font style="vertical-align: inherit;">使用されています</font><font style="vertical-align: inherit;">。これは、以下で説明する手法には影響しません。つまり、ここで検討した情報を、選択したスタックまたはゲームエンジンで使用できます。 Panda3Dは特定のアメニティを提供します。私がそれらについて話した記事では、スタックで対応するものを見つけるか、スタックにない場合は自分で再作成することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは検討する価値が</font></font><code>gl-coordinate-system default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり</font></font><code>textures-power-2 down</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>textures-auto-power-2 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に追加されました</font></font><code>config.prc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これらは、標準の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panda3D構成に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は含まれていません</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、Panda3Dはz軸が上向きの右手座標系を使用し、OpenGLはy軸が上向きの右手座標系を使用します。</font></font><br>
<br>
<code>gl-coordinate-system default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェーダー内の2つの座標系間の変換を取り除くことができます。</font></font><br>
<br>
<code>textures-auto-power-2 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムでサポートされている場合、2の累乗ではないテクスチャサイズを使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画面/ウィンドウのサイズは通常2の累乗ではないため、これはSSAOを実行したり、画面/ウィンドウ内に他の技術を実装したりする場合に便利です。</font></font><br>
<br>
<code>textures-power-2 down</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムが2の累乗に等しいサイズのテクスチャのみをサポートしている場合、テクスチャのサイズを2の累乗に縮小します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サンプルコードのビルド</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サンプルコードを実行する場合は、まずそれをビルドする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Panda3DはLinux、Mac、Windowsで動作します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
で起動し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インストール</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panda3D SDKを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配布するために。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Panda3Dのヘッダーとライブラリの場所を見つけます。</font><font style="vertical-align: inherit;">ほとんどの場合、それらはそれぞれ</font></font><code>/usr/include/panda3d/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とにあり</font></font><code>/usr/lib/panda3d/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、このリポジトリのクローンを作成して、そのディレクトリに移動します。</font><font style="vertical-align: inherit;">
次に、ソースコードを出力ファイルにコンパイルします。</font><font style="vertical-align: inherit;">
出力ファイルを作成したら、出力ファイルとその依存関係を関連付けて、実行可能ファイルを作成します。</font><font style="vertical-align: inherit;">
詳細については、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Panda3Dのマニュアルを</font></a><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<code>git clone https://github.com/lettier/3d-game-shaders-for-beginners.git<br>
cd 3d-game-shaders-for-beginners</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>g++ \<br>
 -c main.cxx \<br>
 -o 3d-game-shaders-for-beginners.o \<br>
 -std=gnu++11 \<br>
 -O2 \<br>
 -I/usr/include/python2.7/ \<br>
 -I/usr/include/panda3d/</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>g++ \<br>
 3d-game-shaders-for-beginners.o \<br>
 -o 3d-game-shaders-for-beginners \<br>
 -L/usr/lib/panda3d \<br>
 -lp3framework \<br>
 -lpanda \<br>
 -lpandafx \<br>
 -lpandaexpress \<br>
 -lp3dtoolconfig \<br>
 -lp3dtool \<br>
 -lp3pystub \<br>
 -lp3direct \<br>
 -lpthread</code><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マック</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mac用</font><font style="vertical-align: inherit;">
の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panda3D SDK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">インストールすることから</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">始めます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Panda3Dのヘッダーとライブラリの場所を見つけます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、リポジトリのクローンを作成し、そのディレクトリに移動します。</font><font style="vertical-align: inherit;">
次に、ソースコードを出力ファイルにコンパイルします。</font><font style="vertical-align: inherit;">インクルードディレクトリがPython 2.7とPanda3Dのどこにあるかを見つける必要があります。</font><font style="vertical-align: inherit;">
出力ファイルを作成したら、出力ファイルとその依存関係を関連付けて、実行可能ファイルを作成します。</font><font style="vertical-align: inherit;">
Panda3Dライブラリの場所を見つける必要があります。</font><font style="vertical-align: inherit;">
詳細については、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Panda3Dのマニュアルを</font></a><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<code>git clone https://github.com/lettier/3d-game-shaders-for-beginners.git<br>
cd 3d-game-shaders-for-beginners</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>clang++ \<br>
 -c main.cxx \<br>
 -o 3d-game-shaders-for-beginners.o \<br>
 -std=gnu++11 \<br>
 -g \<br>
 -O2 \<br>
 -I/usr/include/python2.7/ \<br>
 -I/Developer/Panda3D/include/</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>clang++ \<br>
 3d-game-shaders-for-beginners.o \<br>
 -o 3d-game-shaders-for-beginners \<br>
 -L/Developer/Panda3D/lib \<br>
 -lp3framework \<br>
 -lpanda \<br>
 -lpandafx \<br>
 -lpandaexpress \<br>
 -lp3dtoolconfig \<br>
 -lp3dtool \<br>
 -lp3pystub \<br>
 -lp3direct \<br>
 -lpthread</code><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィンドウズ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
で起動し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インストール</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panda3D SDKを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Windows用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Panda3Dのヘッダーとライブラリの場所を見つけます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリポジトリのクローンを作成し、そのディレクトリに移動します。</font><font style="vertical-align: inherit;">
詳細については、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Panda3Dのマニュアルを</font></a><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<code>git clone https://github.com/lettier/3d-game-shaders-for-beginners.git<br>
cd 3d-game-shaders-for-beginners</code><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモを起動</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サンプルコードをビルドしたら、実行可能ファイルまたはデモを実行できます。</font><font style="vertical-align: inherit;">これは、LinuxまたはMacでの実行方法です。</font></font><br>
<br>
<code>./3d-game-shaders-for-beginners</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、Windows上で実行されます。</font></font><br>
<br>
<code>3d-game-shaders-for-beginners.exe</code><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーボード制御</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デモには、カメラを移動してさまざまな効果の状態を切り替えることができるキーボードコントロールがあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トラフィック</font></font></h3><br>
<ul>
<li><code>w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -シーンの奥深くに移動します。</font></font></li>
<li><code>a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -シーンを時計回りに回転します。</font></font></li>
<li><code>s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -シーンから離れてください。</font></font></li>
<li><code>d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -シーンを反時計回りに回転します。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">切り替え可能なエフェクト</font></font></h3><br>
<ul>
<li><code>y</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -SSAOを有効にします。</font></font></li>
<li><code>Shift</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ </font></font><code>y</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-SSAOを無効にします。</font></font></li>
<li><code>u</code> —  .</li>
<li><code>Shift</code>+<code>u</code> —  .</li>
<li><code>i</code> —  bloom.</li>
<li><code>Shift</code>+<code>i</code> —  bloom.</li>
<li><code>o</code> —   .</li>
<li><code>Shift</code>+<code>o</code> —   .</li>
<li><code>p</code> —  .</li>
<li><code>Shift</code>+<code>p</code> —  .</li>
<li><code>h</code> —   .</li>
<li><code>Shift</code>+<code>h</code> —   .</li>
<li><code>j</code> —  .</li>
<li><code>Shift</code>+<code>j</code> —  </li>
<li><code>k</code> —  .</li>
<li><code>Shift</code>+<code>k</code> —  .</li>
<li><code>l</code> —  .</li>
<li><code>Shift</code>+<code>l</code> —  .</li>
<li><code>n</code>   .</li>
<li><code>Shift</code>+<code>n</code> —   .</li>
</ul><br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シェーダーの作成を開始する前に、次の参照システムまたは座標系を理解する必要があります。</font><font style="vertical-align: inherit;">それらのすべては、参照の原点の現在の座標がを基準にして取得されたものになり</font></font><code>(0, 0, 0)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">見つけたらすぐに、ある種の行列または他のベクトル空間を使用して変換できます。</font><font style="vertical-align: inherit;">通常、シェーダーの出力が正しく表示されない場合、原因は座標系の混乱です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">型番</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e06/9ce/863/e069ce863ffc7bd3b94394dc20b25687.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モデルまたはオブジェクトの座標系は、モデルの原点を基準にしています。</font><font style="vertical-align: inherit;">Blenderなどの3次元モデリングプログラムでは、通常、モデルの中心に配置されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平和</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d0a/9de/1f7/d0a9de1f741bb90174efd93d174ef1f9.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ワールドスペースは、作成したシーン/レベル/ユニバースの原点を基準にしています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概観</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bd2/15b/b6e/bd215bb6ee79a6904eba3f6ad4ff56d3.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビューの座標空間は、アクティブなカメラの位置を基準にしています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリッピング</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d77/505/a34/d77505a349f37a695f77625400857d58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カメラフレームの中心を基準にしたクリッピングスペース。</font><font style="vertical-align: inherit;">その中のすべての座標は均一であり、間隔内にあります</font></font><code>(-1, 1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Xとyはカメラフィルムに平行で、z座標は深度です。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc7/0be/d7c/dc70bed7ca78c39cc9f538b127d7176e.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可視性のピラミッドまたはカメラの可視性のボリュームの境界内にないすべての頂点は、切り取られるか破棄されます。</font><font style="vertical-align: inherit;">これは、カメラの遠い面の後ろで切り取られた立方体と、側面に配置された立方体でどのように発生するかを確認します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画面</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e5b/47d/336/e5b47d33660b9c1744faa12fec8ef256.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画面スペースは、（通常）画面の左下隅を基準にしています。</font><font style="vertical-align: inherit;">Xはゼロから画面の幅に変わります。</font><font style="vertical-align: inherit;">Yはゼロから画面の高さに変わります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLSL</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
固定機能のパイプラインを使用する代わりに、プログラム可能なGPUレンダリングパイプラインを使用します。</font><font style="vertical-align: inherit;">プログラム可能であるため、プログラムコードをシェーダーの形で渡す必要があります。</font><font style="vertical-align: inherit;">シェーダーは、C言語に似た構文で作成された（通常は小さな）プログラムです。プログラム可能なGPUレンダリングパイプラインは、シェーダーを使用してプログラムできるさまざまなステップで構成されています。</font><font style="vertical-align: inherit;">さまざまな種類のシェーダーには、頂点シェーダー、テッセレーションシェーダー、ジオメトリックシェーダー、フラグメントシェーダー、計算シェーダーがあります。</font><font style="vertical-align: inherit;">この記事で説明されている手法を使用するには、頂点</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ステージ</font><font style="vertical-align: inherit;">とフラグメント</font><font style="vertical-align: inherit;">ステージ</font><font style="vertical-align: inherit;">を使用するだけで十分です</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#version 140</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、GLSLバージョン番号とメイン関数で構成される最小のGLSLシェーダーです。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#version 140</span><font></font>
<font></font>
uniform mat4 p3d_ModelViewProjectionMatrix;<font></font>
<font></font>
in vec4 p3d_Vertex;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  gl_Position = p3d_ModelViewProjectionMatrix * p3d_Vertex;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、入力頂点をクリッピングスペースに変換し、この新しい位置を均一な頂点位置として表示する、切り詰められた頂点シェーダーGLSLです。</font><font style="vertical-align: inherit;">なので、</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロシージャ</font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は何も返しません</font><font style="vertical-align: inherit;">。</font></font><code>void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数</font></font><code>gl_Position</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は組み込み出力です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
言及する価値のある2つのキーワードは</font></font><code>uniform</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および</font></font><code>in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーワード</font></font><code>uniform</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、このグローバル変数がすべての頂点で同じであることを意味します。 Panda3Dはそれ自体</font></font><code>p3d_ModelViewProjectionMatrix</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">設定</font><font style="vertical-align: inherit;">し、各頂点は同じ行列です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーワード</font></font><code>in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、このグローバル変数がシェーダーに渡されることを意味します。頂点シェーダーは、ジオメトリを構成する各頂点を取得します。頂点シェーダーはそれに接続されます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#version 140</span><font></font>
<font></font>
out vec4 fragColor;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<font></font>
  fragColor = vec4(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはトリミングされたGLSLフラグメントシェーダーで、フラグメントの色として不透明な緑色を表示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フラグメントは1つの画面ピクセルにのみ影響を与えることを忘れないでください。ただし、複数のフラグメントが1つのピクセルに影響を与える可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーワードに注意してください</font></font><code>out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーワード</font></font><code>out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、このグローバル変数がシェーダーによって設定されることを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前は</font></font><code>fragColor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプションなので、他</font><font style="vertical-align: inherit;">の名前を</font><font style="vertical-align: inherit;">選択できます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8b4/276/b2d/8b4276b2d7e735cc05484e80e0c046e8.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の2つのシェーダーの出力を次に示します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テクスチャレンダリング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画面に直接レンダリング/描画する代わりに、サンプルコードは</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「テクスチャーへのレンダリング」と呼ばれる</font><font style="vertical-align: inherit;">手法を使用してい</font><font style="vertical-align: inherit;">ます。テクスチャにレンダリングするには、フレームバッファを構成し、それにテクスチャをバインドする必要があります。複数のテクスチャを単一のフレームバッファーにバインドできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フレームバッファーにバインドされたテクスチャは、フラグメントシェーダーによって返されるベクトルを格納します。通常、これらのベクトルはカラーベクトル</font></font><code>(r, g, b, a)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ですが、位置または法線ベクトルのいずれか</font></font><code>(x, y, z, w)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。バインドされたテクスチャごとに、フラグメントシェーダーは個別のベクトルを出力できます。たとえば、1つのパスで頂点の位置と法線を推定できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Panda3Dで動作するサンプルコードの大部分は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">、フレームバッファーテクスチャの</font></a><font style="vertical-align: inherit;">設定に関するものです</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">簡単にするために、サンプルコードの各フラグメントシェーダーの出力は1つだけです。</font><font style="vertical-align: inherit;">ただし、高いフレームレート（FPS）を確保するには、各レンダリングパスでできるだけ多くの情報を出力する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、サンプルコードのフレームバッファの2つのテクスチャ構造です。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac9/d2b/d50/ac9d2bd50cd1c0bc991ffe7569bf5432.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の構造は、複数の頂点シェーダーとフラグメントシェーダーを使用して、水車小屋シーンをフレームバッファーテクスチャにレンダリングします。</font><font style="vertical-align: inherit;">この構造は、ミルのあるステージの各頂点を通過し、対応するフラグメントに沿っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この構造では、サンプルコードは次のように機能します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将来使用するために、ジオメトリデータ（位置や頂点法線など）を保存します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将来の使用に備えて、マテリアルデータ（拡散色など）を保存します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまなテクスチャ（拡散、法線マップ、シャドウマップなど）のUVバインディングを作成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">周囲光、拡散光、反射光、放射光を計算します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォグをレンダリングします。</font></font></li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e5/554/0c2/7e55540c20fe190246f3180b3f06a731.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の構造は、画面の形をした長方形を対象とする直交カメラです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この構造は、4つのピークとそれらに対応するフラグメントのみを通過します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の構造では、サンプルコードは次のアクションを実行します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のフレームバッファーテクスチャの出力を処理します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">異なるフレームバッファテクスチャを1つに結合します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コード例では、1つのフレームバッファーテクスチャの出力を確認して、対応するフレームをtrueに設定し、他のすべてのフレームをfalseに設定しています。</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  <span class="hljs-keyword">bool</span> showPositionBuffer        = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showNormalBuffer          = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showSsaoBuffer            = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showSsaoBlurBuffer        = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showMaterialDiffuseBuffer = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showOutlineBuffer         = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showBaseBuffer            = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showSharpenBuffer         = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showBloomBuffer           = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showCombineBuffer         = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showCombineBlurBuffer     = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showDepthOfFieldBuffer    = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showPosterizeBuffer       = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showPixelizeBuffer        = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">bool</span> showFilmGrainBuffer       = <span class="hljs-literal">true</span>;<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テクスチャリング</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d1c/0eb/1c6/d1c0eb1c650b9b05e2372b33259ed8a6.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テクスチャリングとは、UV座標を使用して、色または他のベクトルをフラグメントにバインドすることです。</font><font style="vertical-align: inherit;">UとVの値は、0から1までの範囲で変化します。</font><font style="vertical-align: inherit;">各頂点はUV座標を受け取り、頂点シェーダーに表示されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/519/487/fee/519487fee2bb16357b225ce32649fb91.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フラグメントシェーダーは、補間されたUV座標を取得します。</font><font style="vertical-align: inherit;">補間とは、フラグメントのUV座標が、三角形の面を構成する頂点のUV座標の間のどこかにあることを意味します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">頂点シェーダー</font></font></h3><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#version 140</span><font></font>
<font></font>
uniform mat4 p3d_ModelViewProjectionMatrix;<font></font>
<font></font>
in vec2 p3d_MultiTexCoord0;<font></font>
<font></font>
in vec4 p3d_Vertex;<font></font>
<font></font>
out vec2 texCoord;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  texCoord = p3d_MultiTexCoord0;<font></font>
<font></font>
  gl_Position = p3d_ModelViewProjectionMatrix * p3d_Vertex;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、頂点シェーダーがテクスチャの座標をフラグメントシェーダーに出力していることがわかります。</font><font style="vertical-align: inherit;">これは2次元ベクトルであることに注意してください。Uの値とVの値の1つです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントシェーダー</font></font></h3><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#version 140</span><font></font>
<font></font>
uniform sampler2D p3d_Texture0;<font></font>
<font></font>
in vec2 texCoord;<font></font>
<font></font>
out vec2 fragColor;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  texColor = texture(p3d_Texture0, texCoord);<font></font>
<font></font>
  fragColor = texColor;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、フラグメントシェーダーがUV座標で色を検索し、フラグメントの色として表示していることがわかります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画面塗りつぶしテクスチャ</font></font></h4><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#version 140</span><font></font>
<font></font>
uniform sampler2D screenSizedTexture;<font></font>
<font></font>
out vec2 fragColor;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  vec2 texSize  = textureSize(texture, <span class="hljs-number">0</span>).xy;<font></font>
  vec2 texCoord = gl_FragCoord.xy / texSize;<font></font>
<font></font>
  texColor = texture(screenSizedTexture, texCoord);<font></font>
<font></font>
  fragColor = texColor;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テクスチャにレンダリングする場合、メッシュは画面と同じアスペクト比の平らな長方形です。</font><font style="vertical-align: inherit;">したがって、</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A）UV座標を使用して画面のサイズを長方形に重ね合わせたテクスチャの幅と高さ、および</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B）フラグメントのx座標とy座標</font><font style="vertical-align: inherit;">のみを知って、UV座標を計算できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
xをUにバインドするには、xを入力テクスチャの幅で割ります。</font><font style="vertical-align: inherit;">同様に、yをVにバインドするには、yを入力テクスチャの高さで除算する必要があります。</font><font style="vertical-align: inherit;">この手法がサンプルコードで使用されていることがわかります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">点灯</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f98/05e/0ca/f9805e0ca9717c961dd9618f49475381.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
照明を決定するには、周囲、拡散、反射、および放出された照明の側面を計算して組み合わせる必要があります。</font><font style="vertical-align: inherit;">サンプルコードはPhongライティングを使用しています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">頂点シェーダー</font></font></h3><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// ...</span><font></font>
<font></font>
uniform <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">p3d_LightSourceParameters</span>
  {</span> vec4 color<font></font>
<font></font>
  ; vec4 ambient<font></font>
  ; vec4 diffuse<font></font>
  ; vec4 specular<font></font>
<font></font>
  ; vec4 position<font></font>
<font></font>
  ; vec3  spotDirection<font></font>
  ; <span class="hljs-keyword">float</span> spotExponent<font></font>
  ; <span class="hljs-keyword">float</span> spotCutoff<font></font>
  ; <span class="hljs-keyword">float</span> spotCosCutoff<font></font>
<font></font>
  ; <span class="hljs-keyword">float</span> constantAttenuation<font></font>
  ; <span class="hljs-keyword">float</span> linearAttenuation<font></font>
  ; <span class="hljs-keyword">float</span> quadraticAttenuation<font></font>
<font></font>
  ; vec3 attenuation<font></font>
<font></font>
  ; sampler2DShadow shadowMap<font></font>
<font></font>
  ; mat4 shadowViewMatrix<font></font>
  ;<font></font>
  } p3d_LightSource[NUMBER_OF_LIGHTS];<font></font>
<font></font>
<span class="hljs-comment">// ...</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アンビエントライトを除いて、光源ごとに、Panda3Dは頂点シェーダーとフラグメントシェーダーの両方で使用できる便利な構造を提供します。</font><font style="vertical-align: inherit;">最も便利なのは、頂点をシャドウまたはライティングスペースに変換するためのシャドウマップとシャドウ調査行列です。</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  vertexPosition = p3d_ModelViewMatrix * p3d_Vertex;<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; p3d_LightSource.length(); ++i) {<font></font>
    vertexInShadowSpaces[i] = p3d_LightSource[i].shadowViewMatrix * vertexPosition;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頂点シェーダーから始めて、頂点をビューイングスペースからシーンの各光源のシャドウまたはライティングスペースに変換して削除する必要があります。</font><font style="vertical-align: inherit;">これは、将来、フラグメントシェーダーがシャドウをレンダリングするのに役立ちます。</font><font style="vertical-align: inherit;">シャドウまたはライティングスペースは、各座標が光源の位置を基準にした空間です（原点は光源です）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントシェーダー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フラグメントシェーダーは、照明計算の大部分を行います。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素材</font></font></h4><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// ...</span><font></font>
<font></font>
uniform <span class="hljs-class"><span class="hljs-keyword">struct</span>
  {</span> vec4 ambient<font></font>
  ; vec4 diffuse<font></font>
  ; vec4 emission<font></font>
  ; vec3 specular<font></font>
  ; <span class="hljs-keyword">float</span> shininess<font></font>
  ;<font></font>
  } p3d_Material;<font></font>
<font></font>
<span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Panda3Dは、現在レンダリングしているメッシュまたはモデルのマテリアル（構造体の形式）を提供します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数の光源</font></font></h4><br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  vec4 diffuseSpecular = vec4(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>);<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シーンのイルミネーションのソースを検討する前に、拡散カラーと反射カラーの両方を含むドライブを作成します。</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; p3d_LightSource.length(); ++i) {
    <span class="hljs-comment">// ...</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、光源の周りを回って、それぞれの拡散色と反射色を計算できます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">照明関連ベクトル</font></font></h4><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/307/035/ce7/307035ce7bf5a52b8f25c7aeb862b9d4.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、各光源によって導入される拡散色と反射色を計算するために必要な4つの基本ベクトルです。</font><font style="vertical-align: inherit;">照明方向ベクトルは、光源を指す青い矢印です。</font><font style="vertical-align: inherit;">法線ベクトルは、垂直に上向きの緑の矢印です。</font><font style="vertical-align: inherit;">反射ベクトルは、照明の方向ベクトルを反映する青い矢印です。</font><font style="vertical-align: inherit;">目またはビューのベクトルは、カメラに向かっているオレンジ色の矢印です。</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-comment">// ...</span><font></font>
<font></font>
    vec3 lightDirection =<font></font>
        p3d_LightSource[i].position.xyz<font></font>
      - vertexPosition.xyz<font></font>
      * p3d_LightSource[i].position.w;<font></font>
<font></font>
    <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
照明の方向は、頂点の位置から光源の位置へのベクトルです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが指向性照明の場合、Panda3D </font></font><code>p3d_LightSource[i].position.w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はゼロの値を</font><font style="vertical-align: inherit;">割り当て</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ディレクショナルライティングには位置はなく、方向のみがあります。</font><font style="vertical-align: inherit;">したがって、ディレクショナルライティングの場合、Panda3Dが</font></font><code>p3d_LightSource[i].position.xyz</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値を</font><font style="vertical-align: inherit;">割り当てるので、イルミネーションの方向はソースに対して負または反対の方向になり</font><font style="vertical-align: inherit;">ます</font></font><code>-direction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  normal = normalize(vertexNormal);<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頂点の法線は単位ベクトルでなければなりません。</font><font style="vertical-align: inherit;">単位ベクトルの値は1です。</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-comment">// ...</span><font></font>
<font></font>
    vec3 unitLightDirection = normalize(lightDirection);<font></font>
    vec3 eyeDirection       = normalize(-vertexPosition.xyz);<font></font>
    vec3 reflectedDirection = normalize(-reflect(unitLightDirection, normal));<font></font>
<font></font>
    <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、さらに3つのベクトルが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライティング方向が関与するスカラー製品が必要なので、正規化することをお勧めします。これにより、1（単位ベクトル）に等しい距離または大きさが得られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頂点/フラグメントの位置はカメラの位置を基準にしているため、ビューの方向は頂点/フラグメントの位置と反対です。頂点/フラグメントの位置が表示スペースにあることを忘れないでください。したがって、カメラ（目）から頂点/フラグメントに移動する代わりに、上部/フラグメントからカメラ（目）に移動します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">反射ベクトル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-これは、表面に垂直な照明の方向の反射です。</font><font style="vertical-align: inherit;">光の「光線」が表面に接触すると、落下したときと同じ角度で反射されます。</font><font style="vertical-align: inherit;">光の方向ベクトルと法線の間の角度は、「入射角」と呼ばれます。</font><font style="vertical-align: inherit;">反射ベクトルと法線の間の角度は「反射角度」と呼ばれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
反射光ベクトルは目のベクトルと同じ方向を指す必要があるため、反射光ベクトルの符号を変更する必要があります。</font><font style="vertical-align: inherit;">目の方向は上/フラグメントからカメラの位置に向かうことを忘れないでください。</font><font style="vertical-align: inherit;">反射ベクトルを使用して、反射光の明るさを計算します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">拡散照明</font></font></h4><br>
<pre><code class="cpp hljs">    <span class="hljs-comment">// ...</span><font></font>
<font></font>
    <span class="hljs-keyword">float</span> diffuseIntensity  = max(dot(normal, unitLightDirection), <span class="hljs-number">0.0</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (diffuseIntensity &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// ...</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
拡散照明の明るさは、表面の法線と単一ベクトルの照明方向のスカラー積です。</font><font style="vertical-align: inherit;">スカラー積の範囲はマイナス1から1です。</font><font style="vertical-align: inherit;">両方のベクトルが同じ方向を指している場合、明るさは1つです。</font><font style="vertical-align: inherit;">それ以外の場合はすべて、1未満になります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/168/5bc/5e7/1685bc5e759e638b5c2bcc4a6c56bbd3.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イルミネーションベクトルが通常と同じ方向に近づくと、拡散イルミネーションの明るさが1になる傾向があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
拡散照明の明るさがゼロ以下の場合は、次の光源に移動する必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs">      <span class="hljs-comment">// ...</span><font></font>
<font></font>
      vec4 diffuse =<font></font>
        vec4<font></font>
          ( clamp<font></font>
              (   diffuseTex.rgb<font></font>
                * p3d_LightSource[i].diffuse.rgb<font></font>
                * diffuseIntensity<font></font>
              , <span class="hljs-number">0</span>
              , <span class="hljs-number">1</span><font></font>
              )<font></font>
          , <span class="hljs-number">1</span><font></font>
          );<font></font>
<font></font>
      diffuse.r = clamp(diffuse.r, <span class="hljs-number">0</span>, diffuseTex.r);<font></font>
      diffuse.g = clamp(diffuse.g, <span class="hljs-number">0</span>, diffuseTex.g);<font></font>
      diffuse.b = clamp(diffuse.b, <span class="hljs-number">0</span>, diffuseTex.b);<font></font>
<font></font>
      <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、このソースによって導入された拡散色を計算できます。</font><font style="vertical-align: inherit;">拡散照明の明るさが1の場合、拡散色は拡散テクスチャの色と照明の色の混合になります。</font><font style="vertical-align: inherit;">他の明るさでは、拡散色は暗くなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
拡散反射光カラーを制限して、拡散反射光テクスチャの色よりも明るくならないようにします。</font><font style="vertical-align: inherit;">これにより、シーンの露出オーバーを防ぐことができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">間接照明</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
拡散照明の後、反射が計算されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/989/ade/77c/989ade77c01b7137f437f97fe83ccd17.gif"></div><br>
<pre><code class="cpp hljs">      <span class="hljs-comment">// ...</span><font></font>
<font></font>
      vec4 specular =<font></font>
        clamp<font></font>
          (   vec4(p3d_Material.specular, <span class="hljs-number">1</span>)<font></font>
            * p3d_LightSource[i].specular<font></font>
            * <span class="hljs-built_in">pow</span>
                ( max(dot(reflectedDirection, eyeDirection), <span class="hljs-number">0</span>)<font></font>
                , p3d_Material.shininess<font></font>
                )<font></font>
          , <span class="hljs-number">0</span>
          , <span class="hljs-number">1</span><font></font>
          );<font></font>
<font></font>
      <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
反射光の明るさは、目のベクトルと反射ベクトルの間のスカラー積です。</font><font style="vertical-align: inherit;">拡散照明の明るさの場合と同様に、2つのベクトルが同じ方向を指している場合、反射照明の明るさは1に等しくなります。</font><font style="vertical-align: inherit;">他の明るさは、この光源によって導入される反射色の量を減らします。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c2e/046/570/c2e046570e770e1804544d6ae67ae2f8.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
材料の光沢は、反射光の照明がどの程度散乱されるかを決定します。</font><font style="vertical-align: inherit;">通常、Blenderなどのシミュレーションプログラムで設定されます。</font><font style="vertical-align: inherit;">ブレンダーでは、鏡面硬度と呼ばれます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スポットライト</font></font></h4><br>
<pre><code class="cpp hljs">      <span class="hljs-comment">// ...</span><font></font>
<font></font>
      <span class="hljs-keyword">float</span> unitLightDirectionDelta =<font></font>
        dot<font></font>
          ( normalize(p3d_LightSource[i].spotDirection)<font></font>
          , -unitLightDirection<font></font>
          );<font></font>
<font></font>
      <span class="hljs-keyword">if</span> (unitLightDirectionDelta &gt;= p3d_LightSource[i].spotCosCutoff) {
        <span class="hljs-comment">// ...</span><font></font>
      }<font></font>
<font></font>
      <span class="hljs-comment">// ...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードでは、スポットライトコーンまたはピラミッドの外側のフラグメントに照明が影響することはありません。</font><font style="vertical-align: inherit;">幸いなことに、Panda3Dは</font><font style="vertical-align: inherit;">、指向性ライトとスポットライトを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定義</font></font></a> <code>spotDirection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font></font><code>spotCosCutoff</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て</font><font style="vertical-align: inherit;">操作でき</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">スポットライトには、位置と方向の両方があります。</font><font style="vertical-align: inherit;">ただし、指向性照明には方向しかなく、点光源には位置しかありません。</font><font style="vertical-align: inherit;">ただし、このコードは、ifステートメントを混乱させることなく、3種類の照明すべてで機能します。</font></font><br>
<br>
<pre><code class="cpp hljs">spotCosCutoff = cosine(<span class="hljs-number">0.5</span> * spotlightLensFovAngle);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
投影照明の場合、ベクトル「照明のフラグメントソース」とサーチライトの方向ベクトルのスカラー積がサーチライトの視野角の半分のコサインよりも小さい場合</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、シェーダーはこのソースの影響を考慮しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記号を変更する必要があることに注意してください</font></font><code>unitLightDirection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><code>unitLightDirection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントからサーチライトに移動し、サーチライト</font></font><code>spotDirection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の位置から特定の距離にあるサーチライトのピラミッドの中心に直接</font><font style="vertical-align: inherit;">移動するため、サーチライトからフラグメントに移動する必要があり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指向性およびスポット照明の場合、Panda3Dは</font></font><code>spotCosCutoff</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値を-1に</font><font style="vertical-align: inherit;">設定し</font><font style="vertical-align: inherit;">ます。スカラー積は-1から1の範囲で変化することを思い出してください。したがって、スカラー積</font></font><code>unitLightDirectionDelta</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は常に-1以上である</font><font style="vertical-align: inherit;">ため、それが何であるかは問題ではありません</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs">        <span class="hljs-comment">// ...</span><font></font>
<font></font>
        diffuse *= <span class="hljs-built_in">pow</span>(unitLightDirectionDelta, p3d_LightSource[i].spotExponent);<font></font>
<font></font>
        <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードと同様に</font></font><code>unitLightDirectionDelta</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、このコードも3種類の光源すべてで機能します。</font><font style="vertical-align: inherit;">スポットライトの場合、フラグメントがスポットライトピラミッドの中心に近づくにつれて、フラグメントが明るくなります。</font><font style="vertical-align: inherit;">指向性光源と点光源の</font></font><code>spotExponent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合はゼロです。</font><font style="vertical-align: inherit;">ゼロの累乗の値はすべて1に等しいことを思い出してください。そのため、拡散反射光カラーはそれ自体に1を掛けたものに等しく、つまり変化しません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影</font></font></h4><br>
<pre><code class="cpp hljs">        <span class="hljs-comment">// ...</span><font></font>
<font></font>
        <span class="hljs-keyword">float</span> shadow =<font></font>
          textureProj<font></font>
            ( p3d_LightSource[i].shadowMap<font></font>
            , vertexInShadowSpaces[i]<font></font>
            );<font></font>
<font></font>
        diffuse.rgb  *= shadow;<font></font>
        specular.rgb *= shadow;<font></font>
<font></font>
        <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Panda3Dは、シーン内の各光源に対してシャドウマップとシャドウ変換行列を作成するため、シャドウの使用を簡素化します。変換マトリックスを自分で作成するには、表示スペースの座標を照明スペースに変換するマトリックスを収集する必要があります（座標は光源の位置に相対的です）。シャドウマップを自分で作成するには、光源の視点からシーンをフレームバッファーテクスチャにレンダリングする必要があります。フレームバッファーテクスチャには、光源からフラグメントまでの距離が含まれている必要があります。これは「深度マップ」と呼ばれます。最後に、自家製の深度マップをとして</font></font><code>uniform sampler2DShadow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、シャドウ変換行列をとして</font><font style="vertical-align: inherit;">シェーダーに手動で転送する必要があります</font></font><code>uniform mat4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。したがって、Panda3Dが自動的に行う処理を再作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
示されているコードスニペットは</font></font><code>textureProj</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上記の機能とは異なり</font></font><code>texture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><code>textureProj</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初にで除算</font></font><code>vertexInShadowSpaces[i].xyz</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font></font><code>vertexInShadowSpaces[i].w</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">彼女はそれを使用し</font></font><code>vertexInShadowSpaces[i].xy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て、シャドウマップに格納されている深度を見つけます。</font><font style="vertical-align: inherit;">次に、を使用</font></font><code>vertexInShadowSpaces[i].z</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して上部の奥行きとのシャドウマップの奥行きを比較し</font></font><code>vertexInShadowSpaces[i].xy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">比較が成功すると、</font></font><code>textureProj</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1が返されます。</font><font style="vertical-align: inherit;">それ以外の場合は、ゼロを返します。</font><font style="vertical-align: inherit;">ゼロはこの頂点/フラグメントが影にあることを意味し、1つは頂点/フラグメントが影にないことを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ことに注意してください</font></font><code>textureProj</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、それはまた、シャドウマップが設定されている方法に応じて、0から1までの値を返すことができます。</font><font style="vertical-align: inherit;">この例では</font></font><code>textureProj</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">隣接する深度に基づいて複数の深度テストを実行し、加重平均を返します。</font><font style="vertical-align: inherit;">この加重平均により、シャドウが滑らかになります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">減衰</font></font></h4><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/381/e8d/bfb/381e8dbfb118dac85b139d0c1ec41bad.png"></div><br>
<pre><code class="cpp hljs">        <span class="hljs-comment">// ...</span><font></font>
<font></font>
        <span class="hljs-keyword">float</span> lightDistance = length(lightDirection);<font></font>
<font></font>
        <span class="hljs-keyword">float</span> attenuation =
            <span class="hljs-number">1</span><font></font>
          / ( p3d_LightSource[i].constantAttenuation<font></font>
            + p3d_LightSource[i].linearAttenuation<font></font>
            * lightDistance<font></font>
            + p3d_LightSource[i].quadraticAttenuation<font></font>
            * (lightDistance * lightDistance)<font></font>
            );<font></font>
<font></font>
        diffuse.rgb  *= attenuation;<font></font>
        specular.rgb *= attenuation;<font></font>
<font></font>
        <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
光源までの距離は、単に照明の方向ベクトルの大きさまたは長さです。</font><font style="vertical-align: inherit;">このような距離は1に等しいため、照明の正規化された方向は使用しないことに注意してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
減衰を計算するには、光源までの距離が必要です。</font><font style="vertical-align: inherit;">減衰は、光源からの光の影響が減少することを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメータ</font></font><code>constantAttenuation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>linearAttenuation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><code>quadraticAttenuation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任意の値を設定できます。</font><font style="vertical-align: inherit;">から始める価値</font></font><code>constantAttenuation = 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><code>linearAttenuation = 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり</font></font><code>quadraticAttenuation = 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これらのパラメータを使用すると、光源の位置では1に等しく、光源から離れるとゼロになる傾向があります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終的なカラー照明</font></font></h4><br>
<pre><code class="cpp hljs">        <span class="hljs-comment">// ...</span><font></font>
<font></font>
        diffuseSpecular += (diffuse + specular);<font></font>
<font></font>
        <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
照明の最終的な色を計算するには、拡散色と反射色を追加する必要があります。</font><font style="vertical-align: inherit;">シーン内の光源をバイパスするサイクルでこれをドライブに追加する必要があります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アンビエント</font></font></h4><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// ...</span><font></font>
<font></font>
uniform sampler2D p3d_Texture1;<font></font>
<font></font>
<span class="hljs-comment">// ...</span><font></font>
<font></font>
uniform <span class="hljs-class"><span class="hljs-keyword">struct</span>
  {</span> vec4 ambient<font></font>
  ;<font></font>
  } p3d_LightModel;<font></font>
<font></font>
<span class="hljs-comment">// ...</span><font></font>
<font></font>
in vec2 diffuseCoord;<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  vec4 diffuseTex  = texture(p3d_Texture1, diffuseCoord);<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  vec4 ambient = p3d_Material.ambient * p3d_LightModel.ambient * diffuseTex;<font></font>
<font></font>
<span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライティングモデルのアンビエントライティングコンポーネントは、マテリアルのアンビエントカラー、アンビエントライティングのカラー、拡散反射光テクスチャのカラーに基づいています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各光源に対して累積された拡散色と反射色の計算とは対照的に、周囲光の光源は複数あるべきではないため、この計算は1回だけ実行する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SSAOを実行するときは、周辺光の色が重宝しますのでご注意ください。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてを一緒に入れて</font></font></h4><br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  vec4 outputColor = ambient + diffuseSpecular + p3d_Material.emission;<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最終的な色は、アンビエントカラー、拡散反射光カラー、反射カラー、および放出カラーの合計です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースコード</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cxx</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base.vert</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base.frag</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">法線マップ</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6d1/6bb/9de/6d16bb9deae1520429083896b7492a3f.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
法線マップを使用すると、追加のジオメトリなしでサーフェスに新しいパーツを追加できます。</font><font style="vertical-align: inherit;">通常、3Dモデリングプログラムで作業すると、メッシュの高ポリゴンバージョンと低ポリゴンバージョンが作成されます。</font><font style="vertical-align: inherit;">次に、ハイポリメッシュから頂点の法線が取得され、テクスチャにベイク処理されます。</font><font style="vertical-align: inherit;">このテクスチャは法線マップです。</font><font style="vertical-align: inherit;">次に、フラグメントシェーダー内で、低ポリゴンメッシュの頂点の法線を、法線マップにベイク処理された高ポリゴンメッシュの法線に置き換えます。</font><font style="vertical-align: inherit;">このため、メッシュをライティングすると、実際よりも多くのポリゴンがあるように見えます。</font><font style="vertical-align: inherit;">これにより、高FPSを維持しながら、高ポリゴンバージョンから詳細のほとんどを送信できます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e1/92b/4ae/8e192b4ae48d96a65b92456ba640c7d0.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、高ポリゴンモデルから低ポリゴンモデルへの遷移と、法線マップを重ね合わせた低ポリゴンモデルへの遷移を示しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/987/20d/ee1/98720dee1f77246721e1905abf2ebea4.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、法線マップのオーバーレイは単なる幻想であることを忘れないでください。</font><font style="vertical-align: inherit;">ある角度で、表面は再び平らに見え始めます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">頂点シェーダー</font></font></h3><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// ...</span><font></font>
<font></font>
uniform mat3 p3d_NormalMatrix;<font></font>
<font></font>
<span class="hljs-comment">// ...</span><font></font>
<font></font>
in vec3 p3d_Normal;<font></font>
<font></font>
<span class="hljs-comment">// ...</span><font></font>
<font></font>
in vec3 p3d_Binormal;<font></font>
in vec3 p3d_Tangent;<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  vertexNormal = normalize(p3d_NormalMatrix * p3d_Normal);<font></font>
  binormal     = normalize(p3d_NormalMatrix * p3d_Binormal);<font></font>
  tangent      = normalize(p3d_NormalMatrix * p3d_Tangent);<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頂点シェーダーから始めて、法線ベクトル、従法線ベクトル、接線ベクトルをフラグメントシェーダーに出力する必要があります。</font><font style="vertical-align: inherit;">これらのベクトルは、フラグメントシェーダーで使用され、法線マップの法線を接線空間から表示空間に変換します。</font></font><br>
<br>
<code>p3d_NormalMatrix</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">頂点、従法線、および接線ベクトルの法線ベクトルを表示スペースに変換します。</font><font style="vertical-align: inherit;">表示スペースでは、すべての座標がカメラの位置を基準にしていることを忘れないでください。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[p3d_NormalMatrix]は、ModelViewMatrixの上位3x3逆転置要素です。</font><font style="vertical-align: inherit;">この構造は、法線ベクトルを表示スペースの座標に変換するために使用されます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース</font></font></a></blockquote><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// ...</span><font></font>
<font></font>
in vec2 p3d_MultiTexCoord0;<font></font>
<font></font>
<span class="hljs-comment">// ...</span><font></font>
<font></font>
out vec2 normalCoord;<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  normalCoord   = p3d_MultiTexCoord0;<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b40/f21/575/b40f21575482aa633de61643a1c497aa.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、法線マップのUV座標をフラグメントシェーダーに出力する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントシェーダー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頂点法線が照明の計算に使用されたことを思い出してください。</font><font style="vertical-align: inherit;">ただし、ライティングを計算するために、法線マップは他の法線を提供します。</font><font style="vertical-align: inherit;">フラグメントシェーダーでは、頂点の法線を法線マップにある法線に置き換える必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// ...</span><font></font>
<font></font>
uniform sampler2D p3d_Texture0;<font></font>
<font></font>
<span class="hljs-comment">// ...</span><font></font>
<font></font>
in vec2 normalCoord;<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  <span class="hljs-comment">/* Find */</span><font></font>
  vec4 normalTex   = texture(p3d_Texture0, normalCoord);<font></font>
<font></font>
  <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頂点シェーダーによって転送された法線マップの座標を使用して、マップから対応する法線を抽出します。</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ...</span><font></font>
<font></font>
  vec3 normal;<font></font>
<font></font>
    <span class="hljs-comment">// ...</span><font></font>
<font></font>
    <span class="hljs-comment">/* Unpack */</span><font></font>
    normal =<font></font>
      normalize<font></font>
        ( normalTex.rgb<font></font>
        * <span class="hljs-number">2.0</span>
        - <span class="hljs-number">1.0</span><font></font>
        );<font></font>
<font></font>
    <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記では、法線を色に変換して法線マップを作成する方法を示しました。</font><font style="vertical-align: inherit;">次に、このプロセスを逆にして、元の法線をマップにベイク処理できるようにする必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs">[ r, g, b] =<font></font>
  [ r * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>, g * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>, b * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>] =<font></font>
    [ x, y, z]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
法線マップから法線をアンパックするプロセスは次のとおりです。</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-comment">// ...</span><font></font>
<font></font>
    <span class="hljs-comment">/* Transform */</span><font></font>
    normal =<font></font>
      normalize<font></font>
        ( mat3<font></font>
            ( tangent<font></font>
            , binormal<font></font>
            , vertexNormal<font></font>
            )<font></font>
        * normal<font></font>
        );<font></font>
<font></font>
    <span class="hljs-comment">// ...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
法線マップから取得した法線は通常、接線空間にあります。</font><font style="vertical-align: inherit;">ただし、別のスペースに配置することもできます。</font><font style="vertical-align: inherit;">たとえば、Blenderでは、接線空間、オブジェクト空間、ワールド空間、カメラ空間で法線をベイクできます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/009/cfc/62c/009cfc62c03b455a1e22b68e8636e735.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
法線マップの法線を接線空間から表示空間に転送するには、接線ベクトル、従法線ベクトル、および頂点法線に基づいて3x3行列を作成します。</font><font style="vertical-align: inherit;">法線にこの行列を乗算して正規化します。</font><font style="vertical-align: inherit;">これは私たちが法線に終わったところです。</font><font style="vertical-align: inherit;">他のすべての照明計算は引き続き実行されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースコード</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cxx</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base.vert</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base.frag</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453290/index.html">データサイエンスダイジェスト（2019年5月）</a></li>
<li><a href="../ja453292/index.html">「ブラックホールについての小さな本」</a></li>
<li><a href="../ja453294/index.html">反応する 遅延読み込み</a></li>
<li><a href="../ja453296/index.html">PHPの非同期性を制御します：約束からコルーチンまで</a></li>
<li><a href="../ja453298/index.html">夏：アップグレード時間...自分</a></li>
<li><a href="../ja453302/index.html">Yandex.Moduleの最初の1時間</a></li>
<li><a href="../ja453304/index.html">Zextras PowerStoreの主な利点</a></li>
<li><a href="../ja453306/index.html">Kubernetesが世界を引き継ぎます。いつ、どのように？</a></li>
<li><a href="../ja453310/index.html">RxJSライブラリを使用してReactコンポーネント間でデータを交換する</a></li>
<li><a href="../ja453312/index.html">XMLデータに基づくPDFビジネスメールジェネレーター</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>