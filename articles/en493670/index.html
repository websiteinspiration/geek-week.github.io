<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè∞ üéÆ üí≠ Media System for Toyota Prius (Part 2) üë©üèº‚Äçüîß üéß ü§¶üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuation of the project to replace the Toyota Prius media system. 
 
 In this article - PHY, Transport, and packet delivery to the host device, wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Media System for Toyota Prius (Part 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493670/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuation of the project to replace the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toyota Prius media system. </font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article - PHY, Transport, and packet delivery to the host device, which finally managed to be verified on the real native head of the Prius. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quickly the fairy tale affects, but not quickly the thing is done. </font><font style="vertical-align: inherit;">Today I continue the protracted project on redesigning the media system in Prius, which began 2 years ago.</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Historical Offtopic</font></font></b>
                        <div class="spoiler_text">   ‚Äî  USB-AVC    ,        .           ,     , ..       ++ ‚Äî     ,  . <br>
<br>
  ,    ,        ,     ,           . <br>
<br>
,      ,     ,   PHY- . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, from the very beginning. </font><font style="vertical-align: inherit;">Digging around on the Internet for adapters to AVC-LAN, I very often saw solutions similar to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">And in the discussion, such comments often slip through:</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Honestly, it doesn‚Äôt work very well, or rather it doesn‚Äôt work well with all heads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
While the tire is perfectly readable on some old radio with a 99 year old Spacio.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I was initially fundamentally opposed to doing something, and solutions with structurally instability do not suit me. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will repeat the path of reverse engineering of the tire. Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we connect to the bus on a live car, and remove the waveform: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cc/cz/uf/ccczuftggnmbqqtebaewgwcx_3e.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The beginning of the pack. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/ac/v-/wu/acv-wuwaaoywpav08fjqekdyaq8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bits are somewhere in the middle, larger. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/l3/cy/ba/l3cyba6lailk2fcxp9274-eltlk.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Something very similar to ACK.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A little more about this strange step - below. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I already made screenshots of the waveforms from the stored data, while taking it, I did not immediately pay attention to the voltage range in which I took the data. And when he drew it, he had to get down into the car again to make sure that he had not survived from the mind. Yes, the span of the differential bus is only 200mV (!!!).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next we go to the datasheet used by colleagues ST485, and we see the following there:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/ui/n8/dmuin85kauk3hwji9d6w4d2dx5w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, in fact, the root of all the troubles was found, because of which we have to play with resistors, and pray to the rosin gods so that the converter works on a specific machine. Work near thresholds is evil. But even more interesting is that for AVC-LAN, which in its physics is a clone of some IE-Bus from NEC, according to its specification (the link will be a bit further), the active state is voltage above 120mV, while ST485 has the right to consider anything less than 200mV is zero. Well, that is, if, due to manufacturing deviations, the ST485 has a threshold level slightly lower, and appears on the bus for margin slightly above the norm (up to 6 volts is allowed), then, of course, ST485 will be able to receive such a signal. And these manufacturing inaccuracies are the only thing that forces devices with ST485 in the composition </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sometimes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work. Of course, we will not lay such happiness in development. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second available solution based on the same ST485 and an operational amplifier, I did not like the abundance of components. Well, in the 21st century we live, after all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solution: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are special converters for AVC-LAN. But I was not able to get them at an affordable price for this device. Brotherly China again came to the rescue, where the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HA12240FP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was discovered </font><font style="vertical-align: inherit;">, which has a voltage difference for perceiving a log. ‚Äú1‚Äù by datasheet is 80..110 mV. This will allow our tire to set an active level with an almost double margin. Arranges. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We give birth to the scheme on the STM32F103 mentioned in the first part: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ds/mj/ey/dsmjeylhhd1tldlydzj7kdf8yky.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The scheme was born in a hurry, it contains an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Bus drivers must be powered from 5V. If so, as in the diagram, their differential rises. threshold, and not all packets are accepted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is simple to primitivism, I think, does not need a description. Except, perhaps, the fact that the choice of legs for RX1 / 2 is not accidental, and the first version of the circuit required ‚Äúfile refinement‚Äù in order to get signals to the capture / comparison inputs, because I want to use it to measure the pulse length. Alternative solutions - polling and interrupt on state change lose in accuracy and complexity of software implementation. Plus - I would like to receive at least two lines in parallel (there are three in the head), and if the fronts coincide on two, you can say goodbye to the idea of ‚Äã‚Äãany acceptable accuracy if you do not use capture / comparison.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further analysis of the data in the package is well-written </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But, given that links are inconsistent, I will briefly repeat here:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The differential bus, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here they</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> write about the interpretation of the levels of the log. </font><font style="vertical-align: inherit;">"1" at &lt;20mV, log. </font><font style="vertical-align: inherit;">"0" -&gt; 110mV.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The bit length is 40 ¬µs, the first 20 ¬µs is always ‚Äú0‚Äù, the last 7 ¬µs is always ‚Äú1‚Äù, in the middle is the bit value. </font></font><br>
<img src="https://habrastorage.org/webt/vv/6_/_8/vv6__8pbidlx43eqnvjbupnee3g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, the traffic light:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i1/u2/k-/i1u2k-ji3f5mckou9r7mut6nzkm.png"><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start bit - longer than 180 Œºs </font></font></li>
<li>        (ACK).    ¬´¬ª,    - :<br>
<br>
<img src="https://habrastorage.org/webt/pg/sl/hq/pgslhqq84ha2ytwegw9njtlq6we.png"><br>
<br>
  ACK-    ,    Dallas 1-wire,      ,  , , .    ,   . 1     ,      ¬´0¬ª ( ,    ),     .2  ,      ,    ,   .  .3 ,        (1),     ,           ,    7  ,    . ¬´1¬ª. <br>
 </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well ... we figured out the physical level, drew the circuit, and got the board apart. It turned out something like this: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_d/4y/gj/_d4ygj2rf315jb9yqodcdfh7dda.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/om/rm/fuomrmmvbepdwmvpiqrmh1efezm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
printed circuit board came out somewhat unsuccessfully, and not because the QR code did not work in silk-screen printing. There is an error in the circuit in it (in the diagram above I already corrected it) regarding the selection of legs for the RX, and three line drivers are divorced. In the process of writing and debugging the program, I realized that it‚Äôs good if you can run at least two steadily. Yes, and more is not necessary. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well ... the device turned out to be simple and effective, while the constructive problem with the mismatch of levels has been resolved. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further in the program:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> </a>   .   ,        .  : *         USB ‚Äî     ,    ,     ¬´¬ª  .    . *      ,             8,  6-    ,   4.4   .       ,    ,       . </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android monitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for complete reverse of the bus logic. </font><font style="vertical-align: inherit;">If someone is strong in Android and Kotlin, I will be grateful for the opportunity to consult. </font><font style="vertical-align: inherit;">These are timid attempts to master everything at once, therefore do not enter the repository by reference without a new pass :)</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: fixed temporal </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e data instead microseconds were ms.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493660/index.html">CSS: full calc () function guide</a></li>
<li><a href="../en493662/index.html">Space power</a></li>
<li><a href="../en493664/index.html">COVID-19 propagation rate analysis and publication of the results on dstack.ai</a></li>
<li><a href="../en493666/index.html">How we taught artificial intelligence to answer support questions. Experience Yandex.Taxi</a></li>
<li><a href="../en493668/index.html">How I created the next site builder</a></li>
<li><a href="../en493674/index.html">Video player overview for the web</a></li>
<li><a href="../en493678/index.html">Boston Dynamics: From US Army Orders to Spot Commercial Robot</a></li>
<li><a href="../en493680/index.html">10 tricks how not to merge online konfu</a></li>
<li><a href="../en493682/index.html">How to choose long-term investments: 6 shares from the portfolio of Warren Buffett</a></li>
<li><a href="../en493686/index.html">The mysterious origin of the board game about hacking codes Mastermind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>