<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå≥ üëü ‚ñ´Ô∏è Acesso seguro a uma casa inteligente na aus√™ncia de um IP p√∫blico (parte 2) ‚ÜñÔ∏è ‚ò¶Ô∏è ü¶É</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introdu√ß√£o
 Na primeira parte, escrevi sobre a declara√ß√£o do problema e como o Wishlist foi transformado. No final, decidi usar o OpenVPN, mas, devido...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acesso seguro a uma casa inteligente na aus√™ncia de um IP p√∫blico (parte 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505412/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na primeira parte,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> escrevi sobre a declara√ß√£o do problema e como o Wishlist foi transformado. </font><font style="vertical-align: inherit;">No final, decidi usar o OpenVPN, mas, devido ao fato de ter decidido executar tudo nos cont√™ineres do Docker, acabou n√£o sendo t√£o simples. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devo dizer imediatamente que depois refiz tudo tudo, como resultado, recusei um VPS externo. </font><font style="vertical-align: inherit;">No entanto, como tudo est√° em cont√™ineres, no processo me deparei com v√°rios recursos interessantes, que ser√£o discutidos.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instala√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou descrever apenas pontos-chave.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker</font></font></h3><br>
<pre><code class="plaintext hljs">docker run -d --name iobhost  --net=host -v /opt/iobroker/:/opt/iobroker/ --device=/dev/ttyACM0 --env-file /opt/ioBroker_env.list --restart=always buanet/iobroker:latest
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como eu tenho um MiHome Gateway, os sensores est√£o conectados a ele, at√© v√°rios cen√°rios s√£o configurados, os quais eu n√£o quero quebrar ainda, conectei o ioBroker a ele. Ele viu os sensores, n√£o precisou reconect√°-los ao bast√£o Zigbee (embora existam tamb√©m e alguns bot√µes estejam conectados a ele). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, para que o ioBroker entre em contato com o MiHome Gateway e inicie-o com o par√¢metro --net = host. Essa. ele usa a interface do host; voc√™ n√£o precisa especificar quais portas encaminhar para o cont√™iner. Sem isso, ele n√£o podia ver o gateway, porque ele trabalha com multicast.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O par√¢metro --device = / dev / ttyACM0 √© necess√°rio para encaminhar o pendrive Zigbee USB para o cont√™iner. </font><font style="vertical-align: inherit;">Tamb√©m em /opt/ioBroker_env.list, tive que adicionar a linha USBDEVICES = "/ dev / ttyACM0". </font><font style="vertical-align: inherit;">√â importante que essa linha esteja presente no momento do primeiro in√≠cio do cont√™iner, quando ele vir um diret√≥rio vazio e iniciar sua configura√ß√£o inicial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode configur√°-lo mais tarde, √© claro, mas ter√° que fazer movimentos corporais adicionais.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor MQTT</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um VPS externo, lan√ßou o mosquito eclipse. </font><font style="vertical-align: inherit;">Primeiro, configurei o TLS para ele emitindo um certificado Vamos criptografar. </font><font style="vertical-align: inherit;">Depois, ele decidiu que os clientes deveriam apresentar o certificado e, somente ent√£o, o nome e a senha (prote√ß√£o contra bruteforce). </font><font style="vertical-align: inherit;">Ent√£o, refizi-o para autoassinado, para que os clientes escrevessem certificados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openvpn</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilizou imagens populares com o Docker Hub. </font><font style="vertical-align: inherit;">Para servidor (VPS) kylemanna / openvpn. </font><font style="vertical-align: inherit;">Para o cliente (o servidor dom√©stico em que o ioBroker est√° instalado) - ekristen / openvpn-client.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Costumiza√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui eu tive que mexer. </font><font style="vertical-align: inherit;">No processo, senti bem os aspectos de rede do docker, trabalhando com o iptables, descobri um novo, incluindo </font><font style="vertical-align: inherit;">netplan com o qual eu n√£o tinha neg√≥cios antes. </font><font style="vertical-align: inherit;">Na verdade, decidi escrever este artigo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor VPS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com a instala√ß√£o do OpenVPN e a configura√ß√£o, tudo √© padr√£o, como </font><font style="vertical-align: inherit;">est√° escrito </font><font style="vertical-align: inherit;">em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://hub.docker.com/r/kylemanna/openvpn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que fiz adicionalmente foi aumentar os loopbacks adicionais no VPS e no servidor dom√©stico. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/netplan/01-netcfg.yaml</font></font></i><br>
<br>
<pre><code class="plaintext hljs">	# This file describes the network interfaces available on your system<font></font>
	# For more information, see netplan(5).<font></font>
	network:<font></font>
	  version: 2<font></font>
	  renderer: networkd<font></font>
	  &lt;b&gt;ethernets:<font></font>
	    lo:<font></font>
	      renderer: networkd<font></font>
	      match:<font></font>
	        name: lo<font></font>
	      addresses:<font></font>
        - 192.168.16.1/32&lt;/b&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Negrito destacou o "aditivo". Os espa√ßos n√£o parecem ser exibidos, embora sejam muito importantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os endere√ßos nos exemplos usar√£o 192.168.6.0 para a rede dom√©stica e 192.168.16.0 para loopback. Vou tentar n√£o cometer nenhum erro em lugar nenhum. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openvpn.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adicionado</font></font><br>
<br>
<pre><code class="plaintext hljs">server 192.168.16.192 255.255.255.192<font></font>
push "dhcp-option DNS 192.168.16.6"<font></font>
push "route 192.168.16.0 255.255.255.128"<font></font>
client-to-client<font></font>
client-config-dir       /etc/openvpn/ccd/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu fiz um loopback especialmente a partir de 192.168.16.0/25 e dou endere√ßos aos clientes de 192.168.16.128/25, para que, posteriormente, as regras de resolu√ß√£o no iptables possam ser configuradas com uma √∫nica grade 192.168.16.0/24. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o VPS tem um loopback de 192.168.16.1, com mqtt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O servidor dom√©stico possui 192.168.16.6. Existe o iobroker, tamb√©m conhecido como dns para clientes dom√©sticos, e redefine v√°rios nomes de dom√≠nio para se conectar a partir de uma rede dom√©stica ou atrav√©s de uma VPN. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Havia uma id√©ia em todos os lugares para registrar seu IP "real" da rede. Digite ccd / iobroker para especificar o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
iroute 192.168.6.6 255.255.255.255</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, aparentemente, pelo fato de esse ser o endere√ßo da rede na interface WiFi do laptop em casa e, em muitos casos, ser o gateway padr√£o, houve falhas. Incluindo com um smartphone. E eu queria que a rede dom√©stica trabalhasse com um cliente ativo e sem ele. E n√£o precisei desconectar freneticamente o cliente, voltando para casa para obter acesso a outros recursos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, configurei este servidor e seus cont√™ineres para sempre interagir com o loopback, independentemente de a VPN estar ativa. E o mesmo endere√ßo estava sendo endere√ßado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ccd / iobroker</font></font></i><br>
<br>
<pre><code class="plaintext hljs">iroute 192.168.16.6 255.255.255.255</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, todos os clientes VPN sabem que a rede 192.168.16.0/24 √© acess√≠vel atrav√©s de uma VPN. Se eles enviam pacotes para 192.168.16.1 (loopback VPS), o pacote √© criptografado, entra no cont√™iner openvpn, descriptografado, a rota padr√£o vai para 172.17.0.1 (gateway padr√£o nos cont√™ineres padr√£o), fica tudo bem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas como posso ‚Äúexecutar ping‚Äù no cliente VPN do host VPS ou acessar o servidor dom√©stico com o endere√ßo 192.168.16.6 (e n√£o o IP tempor√°rio no t√∫nel VPN dentro do cont√™iner OpenVPN)? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, a malha 192.168.16.0 deve ser roteada para o cont√™iner OpenVPN. Claro, posso ver que √© 172.17.0.3. Mas um dia isso pode mudar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o OpenVPN fosse implantado diretamente no servidor, e n√£o no cont√™iner, tudo funcionaria por si s√≥. </font><font style="vertical-align: inherit;">E ent√£o eu tive que fazer isso astuciosamente. </font><font style="vertical-align: inherit;">Eu crio um script elaborado pela √∫ltima vers√£o do sistema e o coloco nele:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipaddr=$(docker inspect -f '{{.NetworkSettings.IPAddress}}' vpn-client)<font></font>
route add -net 192.168.16.0/24 gw $ipaddr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa. </font><font style="vertical-align: inherit;">atrav√©s do docker inspecionar, descubro o endere√ßo IP do cont√™iner em execu√ß√£o e, em seguida, direciono a grade para ele da maneira usual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao contr√°rio do rc.local usual, eu tinha que pesquisar no google, mas como, de fato, criar um script que fosse executado por √∫ltimo. </font><font style="vertical-align: inherit;">Aqui est√° uma breve instru√ß√£o: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crie o arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/custom.target</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit] <font></font>
Description=My Custom Target<font></font>
Requires=multi-user.target<font></font>
After=multi-user.target<font></font>
AllowIsolate=yes<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crie o arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/last_command.service</font></font></i> <br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=My custom command<font></font>
After=multi-user.target<font></font>
[Service]<font></font>
Type=simple<font></font>
ExecStart=/usr/local/bin/my_last_command.sh<font></font>
[Install]<font></font>
WantedBy=custom.target<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crie o diret√≥rio </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/system/custom.target.wants</font></font></i><br>
<br>
<pre><code class="plaintext hljs">ln -s /etc/systemd/system/last_command.service \   /etc/systemd/system/custom.target.wants/last_command.service<font></font>
systemctl daemon-reload<font></font>
systemctl set-default custom.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ deseja iniciar imediatamente, sem aguardar uma reinicializa√ß√£o: systemctl isole custom.target </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, ap√≥s a reinicializa√ß√£o </font><font style="vertical-align: inherit;">, o </font><font style="vertical-align: inherit;">arquivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/my_last_command.sh</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descrito em ExecStart </font><font style="vertical-align: inherit;">ser√° o √∫ltimo a ser iniciado </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iptables</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No servidor mqtt, tenho duas portas levantadas: 8883 com TLS e autentica√ß√£o, acess√≠veis na Internet para sensores remotos. Sim, e de alguma forma posso conectar-me ao MQTT Explorer e verificar o que e como. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1883 j√° sem TLS, requer apenas um nome de usu√°rio e senha. Necess√°rio para casa Sonoff rfBridge, que TLS n√£o sabe como. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso n√£o √© assustador, porque o tr√°fego dom√©stico vai para o servidor com iobroker, que √© o gateway padr√£o para 192.168.16.0, encaminhar√° o pacote para um cont√™iner com OpenVPN etc. No entanto, voc√™ s√≥ deve permitir o acesso √† porta 1883 a partir do interior. Essa. iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A abordagem padr√£o √© negar o acesso a essa porta de qualquer lugar e seguir a regra que permite o acesso a partir de redes internas.</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -I INPUT -p tcp -m tcp --dport 1883 -j DROP<font></font>
iptables -I INPUT -s 172.17.0.0/24 -p tcp -m tcp --dport 1883 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A grade √© indicada aqui 172.17.0.0, porque do OpenVPN eu vou para os "vizinhos" como resultado, vou para ocultar o NAT (que √© um cont√™iner iobroker que o rfBridge √© de uma rede WiFi), e n√£o dos originais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim funciona. </font><font style="vertical-align: inherit;">Mas h√° uma nuance. </font><font style="vertical-align: inherit;">Minha porta 1883 √© encaminhada para o cont√™iner mqtt. </font><font style="vertical-align: inherit;">E, como se viu, o iptables preenche primeiro a cadeia DOCKER-USER. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, com esta regra, o acesso √† porta 1883 foi permitido √† regra de bloqueio. </font><font style="vertical-align: inherit;">E da Internet, voc√™ tamb√©m pode se conectar facilmente a ela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma regra de bloqueio deve ser criada na cadeia DOCKER-USER!</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -I DOCKR-USER -p tcp -m tcp --dport 1883 -j DROP<font></font>
iptables -I INPUT -s 172.17.0.0/24 -p tcp -m tcp --dport 1883 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas a mais baixa, permitindo acesso a partir de redes internas, por algum motivo, requer INPUT.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor dom√©stico</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A parte principal √© a mesma. </font><font style="vertical-align: inherit;">No entanto, embora ele fosse um cliente, ele teve que rotear o tr√°fego de uma rede WiFi (rfBridge) para o mqtt no VPS. </font><font style="vertical-align: inherit;">Essa. </font><font style="vertical-align: inherit;">movimento de tr√°fego: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
rfBridge (192.168.6.8) -&gt; iobroker host (192.168.6.6) -&gt; cont√™iner vpn-client (172.17.0.?) -&gt; cont√™iner opevpn no VPS -&gt; loopback VPS (192.168.16.1) -&gt; cont√™iner mqtt (porta 1883) Permitimos </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pacotes "encaminhados" para a grade com clientes e loopbacks:</font></font><br>
<br>
<pre><code class="plaintext hljs">iptables -A FORWARD -d 192.168.16.0/24 -j ACCEPT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e v√° para detalhes espec√≠ficos do cont√™iner.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarefa 1</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ se lembra, a intera√ß√£o entre os subsistemas que configurei por meio de loopback. </font><font style="vertical-align: inherit;">Essa. </font><font style="vertical-align: inherit;">√© necess√°rio que os pacotes em 192.168.16.6 do vpn-client v√£o para o host (172.17.0.1) e n√£o para o t√∫nel da VPN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ executar este comando em um cont√™iner em execu√ß√£o, tudo funcionar√°. </font><font style="vertical-align: inherit;">Ap√≥s a reinicializa√ß√£o, isso ser√° esquecido, mas voc√™ pode especificar no arquivo de configura√ß√£o iobroker.ovpn </font></font><br>
<code>route 192.168.16.6 255.255.255.255 172.17.0.1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o openvpn instalar√° essa rota quando o cont√™iner for iniciado. </font><font style="vertical-align: inherit;">Isso √© resolvido facilmente de maneira padr√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarefa 2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pacotes da rede dom√©stica 192.168.6.0 (por exemplo, do rfBridge) v√£o para o host do iobroker e s√£o encaminhados para o cont√™iner vpn-client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, intencionalmente n√£o incluo a rede 192.168.6.0 no dom√≠nio de criptografia, o cont√™iner OpenVPN no VPS n√£o sabe o que fazer com essa rede. A solu√ß√£o √≥bvia √© tornar o NAT dentro do vpn-client para que o pacote no VPS venha do seu endere√ßo. Mas h√° uma nuance. Como salvar os comandos necess√°rios do iptables ap√≥s reiniciar o cont√™iner? Iptables-persistent n√£o √© t√£o f√°cil de colocar l√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, voc√™ pode montar um novo cont√™iner com aditivos. Mas eu n√£o quero, porque o procedimento de atualiza√ß√£o se tornar√° mais complicado. Em vez de "matar e lan√ßar mais recentemente, e ele retirou a configura√ß√£o da pasta montada", ser√° necess√°rio iniciar a montagem ... N√£o √© por isso que estou me comunicando com os cont√™ineres.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, decidi "ap√≥s o in√≠cio do cont√™iner, executar √† for√ßa comandos nele que instruem o iptables a executar o NAT". </font><font style="vertical-align: inherit;">Eu usei a equipe para isso </font></font><br>
<code>docker events --filter "container=vpn-client" --filter "event=start"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ela trava e aguarda o evento especificado nos filtros. </font><font style="vertical-align: inherit;">No meu caso, inicie o cont√™iner. </font><font style="vertical-align: inherit;">Depois disso, atrav√©s do docker exec, eu executo os comandos necess√°rios do host nele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, por analogia com o VPS, eu configuro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/my_last_command.sh</font></font></i><br>
<br>
<pre><code class="plaintext hljs">#!/bin/bash<font></font>
cont="vpn-client"<font></font>
ipaddr=$(docker inspect -f '{{.NetworkSettings.IPAddress}}' $cont)<font></font>
route add -net 192.168.16.0/24 gw $ipaddr<font></font>
for (( ; ; ))<font></font>
do<font></font>
  docker events --filter "container=$cont" --filter "event=start"<font></font>
  docker exec -it $cont iptables -t nat -I POSTROUTING -s 192.168.16.0/255.255.255.0 -j MASQUERADE<font></font>
  docker exec -it $cont iptables -t nat -I POSTROUTING -s 192.168.6.0/255.255.255.0 -j MASQUERADE<font></font>
done<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem exemplos em que a sa√≠da dos eventos do docker √© passada para a entrada awk, que executa os comandos. </font><font style="vertical-align: inherit;">Mas pareceu-me mais f√°cil "travar" antes do evento, executar comandos e aguardar novamente pelo evento.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Honestamente, eu n√£o queria escrever este post. Ganhei uma experi√™ncia interessante, mas ficou "n√£o linda", √© muito dif√≠cil, n√£o gosto muito. Ent√£o, novamente, refiz tudo, recusou o VPS em geral. Mas desde que prometi a segunda parte ... Al√©m disso, fiquei impressionado com a abordagem dos eventos do docker, queria compartilh√°-lo. Eu acho que ser√° √∫til. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final, eu decidi que sim. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como n√£o pude publicar o vis atrav√©s do proxy reverso e posso facilmente usar o mqtt de fora como um servi√ßo, n√£o preciso do VPS para esta tarefa. Tamb√©m posso fazer upload de firmware para atualiza√ß√µes do OTA na hospedagem, pois h√° um benef√≠cio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mqtt assumiu wqtt.ru. </font><font style="vertical-align: inherit;">TLS √© (as senhas s√£o enviadas em um formul√°rio seguro). </font><font style="vertical-align: inherit;">A velocidade √© excelente (10 ms versus 80 ms para mymqtthub). </font><font style="vertical-align: inherit;">Os t√≥picos a serem reescritos para '$ device / &lt;ID louco&gt; / events' (como Yandex) n√£o s√£o necess√°rios. </font><font style="vertical-align: inherit;">Essa. </font><font style="vertical-align: inherit;">Nesse caso, voc√™ pode pular para algum lugar facilmente. </font><font style="vertical-align: inherit;">O pre√ßo √© barato (300 rublos por ano). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Postei o firmware do OTA no existente para hospedagem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O acesso ao vis ainda √© feito por Zerotier. </font><font style="vertical-align: inherit;">√â muito simples e conveniente. </font><font style="vertical-align: inherit;">E mesmo que estejam quebrados, √© improv√°vel que voc√™ veja o n√≠vel de CO2 em minha casa. </font><font style="vertical-align: inherit;">E mesmo que isso aconte√ßa, logo ficar√° famoso do que se eles me quebrarem pessoalmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© lindo, funciona sem falhas, √© f√°cil fazer altera√ß√µes, se necess√°rio, n√£o h√° servidores desnecess√°rios que precisam de manuten√ß√£o, estou satisfeito.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt505394/index.html">Antiguidades: Nokia E90, o mais recente comunicador</a></li>
<li><a href="../pt505398/index.html">Os lados escuros e claros do trabalho na Yandex</a></li>
<li><a href="../pt505400/index.html">Como devem ser os modelos?</a></li>
<li><a href="../pt505402/index.html">Sobrepondo uma textura 2D em um objeto 3D usando p5.js (parte 2 - aplicando um padr√£o a um cubo)</a></li>
<li><a href="../pt505404/index.html">A maneira mais f√°cil de aprender ingl√™s com v√≠deos TED</a></li>
<li><a href="../pt505416/index.html">MikroTik no modo repetidor - assim como Um-Dois-Tr√™s</a></li>
<li><a href="../pt505418/index.html">[Pergunta] Voc√™ j√° viu pessoas que usam assinaturas de conte√∫do para celular?</a></li>
<li><a href="../zh-CN486176/index.html">‰ºÅ‰∏öÁîµÂ≠êÈÇÆ‰ª∂ÈÄöËÆØÂ§áÂøòÂΩï</a></li>
<li><a href="../zh-CN486178/index.html">FOSSÊñ∞Èóª1-2020Âπ¥1Êúà27Êó•Ëá≥2Êúà2Êó•ÂÖçË¥πÂíåÂºÄÊ∫êÊñ∞ÈóªÁöÑÂõûÈ°æ</a></li>
<li><a href="../zh-CN486180/index.html">ÂàõÂª∫Êó†ÊúçÂä°Âô®Â∫îÁî®Á®ãÂ∫èÁöÑÊèêÁ§∫ÂíåËµÑÊ∫ê</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>