<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤓 👨🏽‍🔬 🈲 Bluetooth LEはそれほど怖くない、またはそれほど努力せずにユーザーエクスペリエンスを向上させる方法 ✋🏿 👩🏻‍🚒 🚋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近、私たちはチームとして、Bluetooth LEテクノロジーを使用して空中送金の機能を考え出し、実装しました。私たちがそれをどのように行ったか、そしてAppleがツールから私たちに何を提供しているかをお話ししたいと思います。Bluetoothはかなり低レベルのプロトコルであり、専門家があまりいな...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bluetooth LEはそれほど怖くない、またはそれほど努力せずにユーザーエクスペリエンスを向上させる方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/452278/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最近、私たちはチームとして、Bluetooth LEテクノロジーを使用して空中送金の機能を考え出し、実装しました。</font><font style="vertical-align: inherit;">私たちがそれをどのように行ったか、そしてAppleがツールから私たちに何を提供しているかをお話ししたいと思います。</font><font style="vertical-align: inherit;">Bluetoothはかなり低レベルのプロトコルであり、専門家があまりいないため、多くの開発者はBluetoothは難しいと考えています。</font><font style="vertical-align: inherit;">しかし、すべてがそれほど怖いわけではなく、実際、この関数の使用は非常に簡単です。</font><font style="vertical-align: inherit;">そして、Bluetooth LEを使用して実装できるこれらの機能は確かに興味深いものであり、その後、競合他社の間でアプリケーションを際立たせるでしょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/97/vu/bb/97vubbbho3z3z4dx_fwnztumh9u.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、それがどのようなテクノロジーであり、従来のBluetoothとの違いを理解しましょう。</font></font><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bluetooth LEとは何ですか？</font></font></h3></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bluetooth開発者がなぜこのテクノロジーをLow Energyと名付けたのですか？</font><font style="vertical-align: inherit;">結局のところ、新しいバージョンのBluetoothを使用するたびに、消費電力はすでに何倍も低くなっています。</font><font style="vertical-align: inherit;">答えはこのバッテリーにあります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ce/qb/65/ceqb65oxhimqzgzovufqysqvsqk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その直径はわずか2 cmで、容量は約220 mA * hです。</font><font style="vertical-align: inherit;">エンジニアがBluetooth LEを開発したとき、そのようなバッテリーを搭載したデバイスが数年間機能することを望んでいました。</font><font style="vertical-align: inherit;">そして彼らはそれをやった！</font><font style="vertical-align: inherit;">このようなバッテリーを搭載したBluetooth LEデバイスは、1年間使用できます。</font><font style="vertical-align: inherit;">2000年のように、エネルギーを節約するために昔ながらの方法でスマートフォンのBluetoothをオフにしている人はまだ何人いますか？</font><font style="vertical-align: inherit;">無駄にあなたはこれを行います-節約は1日あたりの電話の10秒未満になります。</font><font style="vertical-align: inherit;">また、Handoff、AirDropなどの非常に大きな機能を無効にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エンジニアはBluetooth LEを開発して何を達成しましたか？彼らは古典的なプロトコルを改良しましたか？エネルギー効率を高めましたか？すべてのプロセスを最適化しただけですか？番号。彼らはBluetoothスタックのアーキテクチャを完全に再設計し、他のすべてのデバイスから見えるようにするために、放送中やチャネルを占有するために必要な時間を短縮できるという事実を実現しました。これにより、エネルギー消費を大幅に節約できました。また、新しいアーキテクチャにより、あらゆる新しいデバイスを標準化できるようになりました。これにより、世界中の開発者がデバイスと通信できるため、新しいアプリケーションを簡単に作成して管理できます。さらに、自己検出の原則はアーキテクチャに組み込まれています。デバイスに接続するときにPINコードを入力する必要はありません。アプリケーションがこのデバイスと通信できる場合は、接続には数ミリ秒かかります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オンエア時間の短縮。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消費電力が少ない。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいアーキテクチャ。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続時間の短縮。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンジニアはどのようにしてエネルギー効率をこのように大きく飛躍させましたか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
周波数は同じままです：2.4 GHz、認証されておらず、多くの国で無料で使用できます。</font><font style="vertical-align: inherit;">しかし、接続遅延は少なくなりました。従来のBluetoothでは100ミリ秒ではなく、15〜30ミリ秒です。</font><font style="vertical-align: inherit;">作動距離は変わりませんでした-100 m。送信間隔は強くありませんでしたが、変更されました-0.625 msの代わりに、3 msになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、このため、エネルギー消費を10分の1に削減することはできませんでした。</font><font style="vertical-align: inherit;">もちろん、何かが苦しむことになっていた。</font><font style="vertical-align: inherit;">これが速度です。24Mbpsではなく、0.27 Mbpsになりました。</font><font style="vertical-align: inherit;">これは、2018年にはとんでもないスピードだと言えるでしょう。</font></font><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bluetooth LEはどこで使用されますか？</font></font></h3></b><br>
<img src="https://habrastorage.org/webt/bz/0r/ca/bz0rcanj9nvdu_gijz0f6ip3h18.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このテクノロジーは新しいものではなく、iPhone 4sで最初に登場しました。そして、すでに多くの領域を征服することに成功しました。 Bluetooth LEは、すべてのスマートホームデバイスおよびウェアラブルエレクトロニクスで使用されています。今ではコーヒー豆のサイズのチップさえあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ex/0c/go/ex0cgowkyn9nhzx_c5vnwvn7v3g.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、このテクノロジーはソフトウェアでどのように使用されていますか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bluetoothをデバイスに統合して使用し始めたのはAppleが最初だったので、現在までに順調な進歩を遂げ、テクノロジーをエコシステムに統合しています。そして、AirDrop、デバイスのクイックスタート、パスワードの共有、ハンドオフなどのサービスでこのテクノロジーに対応できるようになりました。時計の通知もBluetooth LE経由で行われます。さらに、Appleは、すべてのアプリケーションからの通知を自分のデバイスに送信する方法に関する公開ドキュメントを公開しています。 Bluetooth LEデバイスの役割は何ですか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vd/gk/85/vdgk85ww_wcqq_jykxexwqidgcw.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brodcaster。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">近くにいる全員にメッセージを送信します。このデバイスに接続できません。これがiBeaconsと屋内ナビゲーションの仕組みです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">観察者。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">周りで起こっていることを聞いて、公開メッセージからのみデータを受け取ります。接続は作成されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セントラル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペリフェラルの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方が興味深いです。なぜ単にサーバークライアントと呼ばれなかったのですか？論理的には、名前で判断すると。しかし、違います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
周辺機器は実際にはサーバーとして機能するためです。これは、消費電力が少なく、より強力なCentralに接続する周辺機器です。周辺機器は、それが近くにあり、どのようなサービスがあるかを通知できます。接続できるデバイスは1つだけで、Peripheralにはいくつかのデータがあります。また、Centralはデバイスを検索して空中をスキャンし、接続要求を送信し、任意の数のデバイスに接続し、周辺機器からのデータの読み取り、書き込み、サブスクライブを行うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者はAppleエコシステムで何にアクセスできますか？ </font></font><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何が利用できますか？</font></font></h3></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iOS / Mac OS：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">周辺および中央。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックグラウンドモード。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状態の回復。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続間隔15ミリ秒。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">watchOS / tvOS：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">watchOS 4+ / tvOS 9+。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中央のみ。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大2つの接続。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apple Watchシリーズ2+ / AppleTv 4+。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">背景に入るときに無効にします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続間隔30ミリ秒。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も重要な違いは、接続間隔です。</font><font style="vertical-align: inherit;">それは何に影響しますか？</font><font style="vertical-align: inherit;">この質問に答えるには、まずBluetooth LEプロトコルがどのように機能するか、そして絶対値のこのような小さな違いが非常に重要である理由を理解する必要があります。</font></font><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルのしくみ</font></font></h3></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
検索と接続のプロセスはどうですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペリフェラルは、その存在をアドバタイズメント間隔の頻度でアナウンスします。パッケージは非常に小さく、デバイスが提供するいくつかのサービス識別子とデバイスの名前のみが含まれています。間隔は非常に長くなる可能性があり、デバイスの現在のステータス、省電力モード、およびその他の設定によって異なる場合があります。 Appleは、外部デバイスの開発者に、間隔の長さを加速度センサーにバインドするようにアドバイスしています。デバイスが使用されていない場合は間隔を広げ、アクティブな場合は短くしてデバイスをすばやく見つけます。アドバタイズメント間隔は、接続間隔とは相関関係がなく、電力消費とその設定に応じて、デバイス自体によって決定されます。 Appleエコシステムではアクセスできず、私たちには不明です。システムによって完全に制御されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/na/_v/66/na_v662ojn9_xtvkdfma2wxyfaa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デバイスが見つかったら、接続要求を送信します。ここで、接続間隔がシーンに入ります。この時間の後に、2番目のデバイスが要求に応答できるようになります。しかし、これは接続時ですが、読み取り/書き込み時にはどうなりますか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iq/mv/hg/iqmvhgecmnlikziagjsbda4vxe0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続間隔は、データの読み取り時にも表示されます。これを2倍に減らすと、データ転送速度が向上します。ただし、両方のデバイスが同じ間隔をサポートしていない場合は、それらの最大値が選択されることを理解する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
周辺機器が渡す情報のパッケージが何で構成されているかを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなパッケージのMTU（最大転送単位）は、接続プロセス中に決定され、デバイスごとに、およびオペレーティングシステムによって異なります。プロトコルバージョン4.0では、MTUは約30で、ペイロードのサイズは20バイトを超えませんでした。バージョン4.2ではすべてが変更され、約520バイトを転送できるようになりました。ただし、残念ながら、このバージョンのプロトコルをサポートしているのは、iPhone 5sより新しいデバイスだけです。 MTUのサイズに関係なく、オーバーヘッドのサイズは7バイトです。これには、ATTおよびL2CAPヘッダーが含まれます。記録では、一般的に、同様の状況。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gp/zi/ho/gpzihocxxa6po-lfmmlqyl5e7wu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回答ありと回答なしの2つのモードしかありません。無応答モードでは、次の記録までの待機間隔がないため、データ転送が大幅に高速化されます。ただし、このモードは常に使用できるわけではなく、すべてのデバイスやすべてのシステムで使用できるわけではありません。この記録モードは、エネルギー効率が低いと見なされているため、システム自体によってアクセスが制限される場合があります。 iOSでは、このモードが利用可能かどうかを記録する前に確認できる方法があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、プロトコルの構成を見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/mh/um/ummhumgo7y_x3aeeu03wcv9shiy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロトコルは5つのレベルで構成されます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーション層</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はロジックであり、CoreBluetoothの上に記述されています。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GATT（Generic Attributes Layer）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、デバイス上にあるサービスと特性を交換するために使用されます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATT（属性レイヤー）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特性の管理とデータの転送に使用されます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2CAP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、低レベルのデータ交換プロトコルです。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コントローラー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はBTチップそのものです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたはおそらくGATTとは何か、そしてどのようにそれを扱うことができるのかと尋ねます。</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
GATTは機能とサービスで構成されています。特性は、変数のように、データが格納されるオブジェクトです。また、サービスは、名前空間など、特性が配置されるグループです。サービスには名前があります-UUID、あなたはそれを自分で選択します。サービスには、補助サービスが含まれる場合があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/cr/8k/qscr8kzsigratdfk7boemuqz_ri.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特性には独自の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UUID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（実際には名前）もあります。</font><font style="vertical-align: inherit;">特性</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の値</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はNSDataです。ここでは、データを記録および保存できます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記述子</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は特性の説明であり、この特性に期待するデータ、またはそれらの意味を説明できます。</font><font style="vertical-align: inherit;">Bluetoothプロトコルには多くの記述子がありますが、これまでのところAppleシステムで使用できるのは人間の記述とデータ形式の2つだけです。</font><font style="vertical-align: inherit;">また、持っている</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクセスレベル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたの仕様に（権限を）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xz/zh/kz/xzzhkzptblzhshwvso6kiiygtwe.png"><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自分でやってみよう</font></font></h3></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受取人の手を借りずに、空輸で送金できるようにするという発想でした。</font><font style="vertical-align: inherit;">想像してください。あなたは非常に興味深いタスクに戸惑っていて、完璧なコードを書いています。ここで、同僚がコーヒーに行くことを提案しています。</font><font style="vertical-align: inherit;">そして、あなたはあなたが離れることができない仕事にとても情熱的であり、おいしいカプチーノを一杯買うように彼に頼みます。</font><font style="vertical-align: inherit;">彼はあなたにコーヒーをもたらし、あなたは彼にお金を返す必要があります。</font><font style="vertical-align: inherit;">あなたは電話番号で翻訳することができます、それはうまくいきます。</font><font style="vertical-align: inherit;">しかし、これは厄介な状況です-あなたは彼の番号を知りません。</font><font style="vertical-align: inherit;">ええと、このように3年間働い</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
て</font><font style="vertical-align: inherit;">い</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">が、番号を交換していません:) </font><font style="vertical-align: inherit;">したがって、ユーザーデータを入力せずに、近くにいる人に送金できるようにすることにしました。</font><font style="vertical-align: inherit;">AirDropのように。</font><font style="vertical-align: inherit;">ユーザーを選択して、必要な金額を送信するだけです。</font><font style="vertical-align: inherit;">これに何が必要か見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kp/tc/vs/kptcvsdcwhwapavwoxyq7h20nq4.png"><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プッシュマッピング </font></font></h3></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
送信者が必要です： </font></font><br>
<br>
<ol>
<li>   ,       . </li>
<li>  .</li>
<li>      ,     .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、受信者は、必要なデータを含むサービスがあることを周囲の送信者に通知でき、送信者からメッセージを受信できる必要があります。私たちの銀行で詳細によって送金するプロセスがどのように行われるかを説明する価値はないと思います。これを実装してみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、サービスの名前と特徴を考え出す必要があります。私が言ったように、これはUUIDです。生成してペリフェラルとセントラルに保存するだけで、両方のデバイスで同じになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/bd/xi/xpbdxioazo7xd4wbnnluhmncbk4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のように終わるものを除いて、任意のUUIDを自由に使用できます：XXXXXXXX- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0000-1000-8000-00805F9B34FB-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらは別の会社のために予約されています。あなた自身がそのような数を買うことができ、誰もそれを使用しません。それは</font><font style="vertical-align: inherit;">2500ドル</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">かかり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、マネージャーを作成する必要があります。1つは送金、もう1つは受け取りです。デリゲートを指定するだけです。セントラルを送信し、ペリフェラルを受信します。送信者と受信者の両方が異なるときに1人になることができるため、両方を作成します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m3/vl/ta/m3vltagqi_tzwe8r6ayu70j3wyg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、受信者を検出し、受信者の詳細を特性に書き留めることを可能にする必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ui/nf/hb/uinfhboh_hqspuyugii1xkukh1a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、サービスを作成します。 UUIDを登録し、それがプライマリであることを示します-つまり、サービスがこのデバイスのメインサービスです。良い例：心拍数モニター。メインサービスは心拍数の現在の状態であり、バッテリーステータスは二次情報です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、2つの特性を作成します。1つは受取人の詳細を読み取るための特性、もう1つは書き込むための特性です。これにより、受取人は送金について学習できます。それらをサービスに登録してからマネージャーに追加し、検出を開始して、サービスのUUIDを指定し、近くにあるすべてのデバイスがサービスに接続する前にサービスについて学習できるようにします。このデータは、Centralがブロードキャスト中に送信するパケットに入れられます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受信者は準備ができています。送信者に進みます。検索を実行して接続します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/d6/6j/zqd66jsw2k8gyb-chlj778dx_u8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マネージャをオンにすると、サービスでデバイスの検索が開始されます。それらを見つけると、デリゲートメソッドで取得し、すぐに接続します。重要：使用するすべてのペリフェラルへの強力なリンクを維持する必要があります。そうしないと、リークが発生します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ll/ce/nf/llcenfrfgkrgdgxxy0wh2usf9-q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続が成功したら、このデバイスを使用するデリゲートを構成し、デバイスから必要なサービスを取得します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j3/f0/lh/j3f0lh82sza1lncds8ujfd4yoac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受信者との接続に成功しました。詳細を読む必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続後、デバイスにすべてのサービスを要求しました。そして、それらを受け取った後、delegateメソッドが呼び出され、このデバイスで使用可能なすべてのサービスがリストされます。適切なものを見つけ、その特性を要求します。結果は、変換用のデータを格納するデリゲートメソッドのUUIDによって見つけることができます。それらを読み取ろうとすると、デリゲートメソッドで再び希望を取得します。すべてのサービス、特性、およびそれらの値はシステムによってキャッシュされるため、後で毎回要求する必要はありません。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/cn/e8/qh/cne8qh7dtbbir7q76abbpil4ywk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それだけです、私たちはコーヒーにお金を送りました、それは彼が彼の口座のルーブルを待つように受信者に美しい通知を見せるべき時です。これを行うには、メッセージを送信するプロセスを実装する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要な特性を送信者から取得します。この場合は、格納されている値から取得します。ただし、その前に、以前と同じようにデバイスから取得する必要があります。そして、必要な特性にデータを書き込みます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、他のデバイスで、デリゲートメソッドに書き込みリクエストを取得します。ここでは、送信されたデータを読み取り、アクセスがない、またはこの特性が存在しないなどのエラーに応答できます。すべてが機能しますが、両方のデバイスがオンになっていて、アプリケーションがアクティブな場合のみです。そして、私たちはバックグラウンドで作業する必要があります！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3n/3x/4n/3n3x4no4wu9c95ej5nlmxrfc5g8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アップルでは、​​バックグラウンドでBluetoothを使用できます。</font><font style="vertical-align: inherit;">これを行うには、PeripheralまたはCentralで、使用するモードのキーをinfo.plistで指定する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e8/sk/ns/e8skns2rwruttrhvy1wagrcoppq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、マネージャーで、回復キーを指定し、デリゲートメソッドを作成する必要があります。</font><font style="vertical-align: inherit;">これで、バックグラウンドモードを使用できるようになりました。</font><font style="vertical-align: inherit;">アプリケーションがスリープ状態になるか、メモリからアンロードされると、目的のペリフェラルが見つかったとき、またはCentralが接続されたときにアプリケーションがウェイクアップし、マネージャーがキーで復元されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7y/lz/xd/7ylzxdqlziqkiiqyby2ppkbcfws.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが問題なく、リリースの準備ができています。</font><font style="vertical-align: inherit;">しかし、ここでデザイナーは私たちのところに駆け寄ってきて、こう言います。「ユーザーの写真を挿入して、お互いを見つけやすくします。」</font><font style="vertical-align: inherit;">何をすべきか？</font><font style="vertical-align: inherit;">私たちの仕様では、わずか500バイトを書き込むことができますが、一部のデバイスでは一般的に20 :(</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/dd/_l/cudd_lekcmzrpsmf-mz-9w7is0m.png"><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">深く行く</font></font></h3></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を解決するために、私たちはより深く行く必要がありました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rt/bf/8h/rtbf8hlexfy42goqfvxs8mojyig.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、GATT / ATTレベルのデバイスと話しました。しかし、iOS 11では、L2CAPプロトコルにアクセスできます。ただし、この場合は、自分でデータ転送を行う必要があります。パケットは2 Kb MTUで送信され、何も再エンコードする必要はありません。通常のNSStreamが適用されます。 Appleによると、最大394 Kbpsのデータレート。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスのデータをペリフェラルからセントラルに通常の特性の形で転送するとします。そして、チャンネルを開くのに私はかかりました。 Peripheralで開くと、PSMが返されます。これは接続できるチャネルの番号であり、同じ特性を使用してCentralに転送する必要があります。番号は動的であり、システム自体が現時点で開くPSMを選択します。転送後、Centralのペリフェラルに接続し、都合のよい形式でデータを交換できます。これを行う方法を見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、Peripheralの暗号化されたポートを開きます。暗号化せずにそれを行うことができ、これにより転送が少しスピードアップします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ov/yd/ku/ovydkugm5hgyddaroucpcdjmaq0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、デリゲートメソッドで、PSMを取得して別のデバイスに送信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tm/5g/bv/tm5gbvpsr1dbn8_x3jhg1btpth4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のデバイスを接続した後、チャネルからの送信に必要なNSStreamを取得できるメソッドが呼び出されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nf/ec/kw/nfeckwjotne6tgzochcost5dr5g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Centralを使用すると、さらに簡単です</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oi/tm/hg/oitmhgdbpty9nmathmdnbhsisok.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。</font><font style="vertical-align: inherit;">希望する番号のチャネルに接続するだけです</font><font style="vertical-align: inherit;">... ...その後、必要なストリームを取得します。</font><font style="vertical-align: inherit;">それらでは、あらゆるサイズのあらゆるデータを完全に転送し、L2CAPの上にプロトコルを構築できます。</font><font style="vertical-align: inherit;">それで、受信者の写真の転送を実現しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fq/hq/ha/fqhqha7vfucpkksx4whppmay_du.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、落とし穴があります。落とし穴はありません。</font></font><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">水中の岩</font></font></h3></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バックグラウンドで作業するときの落とし穴を見てみましょう。 PeripheralとCentralの役割が利用できるので、あなたは考えるかもしれません。バックグラウンドで、バックグラウンドで近くにあるデバイスとアクティブなデバイスを判別できます。理論的にはそうだったはずですが、Appleは制限を導入しました。セントラルかペリフェラルかにかかわらず、バックグラウンドにある電話は、バックグラウンドにある他の電話では使用できません。また、バックグラウンドにある電話は、iOS以外のデバイスからは見えません。これが起こる理由を見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デバイスがアクティブになると、デバイス名とサービスのリストが含まれる可能性がある通常のブロードキャストパケットが送信されます。このデバイスが提供すること。そして、オーバーフローデータは適合しなかったすべてです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/ca/ri/sicarigcdlr017kg1zpesa15psc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デバイスがバックグラウンドになると、デバイスは名前を送信せず、サポートされているサービスのリストがオーバーフローデータに転送されます。</font><font style="vertical-align: inherit;">アプリケーションがアクティブな場合、iOSデバイスからスキャンするときにこのデータを読み取り、バックグラウンドに切り替えるときに無視します。</font><font style="vertical-align: inherit;">したがって、バックグラウンドに切り替えると、バックグラウンドにあるアプリケーションを表示できなくなります。</font><font style="vertical-align: inherit;">他のAppleオペレーティングシステムは常にオーバーフローデータを無視するため、サービスをサポートするデバイスを探すと、空の配列が取得されます。</font><font style="vertical-align: inherit;">また、近くにある各デバイスに接続し、サポートされているサービスを要求すると、リストにサービスが含まれる可能性があり、それを操作できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/qc/s5/njqcs5ytnn4czeiumbsvwiqb3cu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、テストのための提出準備を整え、小さなバグを修正し、最適化に取り組みました。</font><font style="vertical-align: inherit;">そして突然、ある時点で、コンソールでこのエラーが発生し始めました。</font></font><br>
<br>
<pre><code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number">124</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最悪なのは、デリゲートメソッドが呼び出されなかったことです。このエラーをユーザーが解決することすらできませんでした。ログへの単なるメッセージ-そして沈黙、すべてが凍結した。大きな変更は行われなかったため、コミットのロールバックを開始しました。そして、彼らはかつてコードを最適化し、データの書き込み方法をやり直したことを発見しました。問題は、すべてのクライアントが更新されたわけではないため、このエラーが発生したことです。</font></font><br>
<br>
<pre><code class="javascript hljs">.write != .writeWithoutResponse</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてを修正し、テストに合格するために実行したことをうれしく思い、彼らはほとんどすぐに私たちに戻ってきました。「あなたのファッション写真は機能しません。それらはすべて過負荷状態になります。」私たちは試み始めましたが、時々、異なるデバイスでは、壊れた写真が異なる時間に来ることは事実です。彼らは理由を探し始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして再び彼らは前のエラーを見ました。すぐに違うバージョンだと思った。しかし、すべてのテストデバイスから古いバージョンを完全に削除した後も、エラーは再現しました。悲しかった...</font></font><br>
<br>
<pre><code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number">722</span>
CoreBluetooth[WARNING] Unknown error: <span class="hljs-number">249</span>
CoreBluetooth[WARNING] Unknown error: <span class="hljs-number">312</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはデバッグツールを探し始めました。最初に遭遇したのはApple Bluetooth Explorerでした。強力なプログラムであり、多くのことを実行できますが、Bluetooth LEプロトコルのデバッグ用に、デバイスの検索と特性の取得を行う小さなタブが1つあります。そして、L2CAPを分析する必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それから彼らはLightBlue Explorerを見つけました。 iOS 7のデザインではかなりまともなプログラムであることが判明しました。これはBluetooth Explorerと同じことを行うことができ、仕様をサブスクライブする方法も知っています。そして、それはより安定して動作します。すべて問題ありませんが、L2CAPはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、有名なWireSharkスニファーを思い出しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼はBluetooth LEに慣れていることがわかりました。彼はL2CAPを読むことができますが、それはWindowsでのみです。 Windowsか何かが見つからないことは怖くないですが。最大のマイナス-プログラムは特定のデバイスでのみ機能します。つまり、公式ストアのどこかでデバイスを見つける必要がありました。また、大企業が理解できないデバイスのフリーマーケットでの購入を承認する可能性は低いこともご存じでしょう。海外のオンラインストアも閲覧し始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ここでは、追加のXcodeツールでPacketLoggerプログラムを見つけました。 OS Xデバイスに送信されるトラフィックを監視できます。 OS XでMoneyDropを書き直してみませんか？すでに別のライブラリがありました。 UIImageをNSImageに置き換えたところ、すべてが10分後に起動しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vm/tn/z3/vmtnz3yw28-g7zsb8-cf6nldt6o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、デバイス間で交換されたパケットを読み取ることができました。</font><font style="vertical-align: inherit;">L2CAPを介したデータ送信時に、特性の1つが記録されていることがすぐにわかりました。</font><font style="vertical-align: inherit;">そして、チャンネルが写真の転送で完全に占有されているという事実のために、iOSは録音を無視し、無視した後の送信者はチャンネルを壊しました。</font><font style="vertical-align: inherit;">写真の転送に関する問題を修正した後ではありませんでした。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ig/gw/sn/iggwsno_4bqfunmdzy0pigsn77i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
読んでくれてありがとう:)</font></font><br>
<br>
<b><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">役立つリンク</font></font></h3></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WWDC / CoreBluetooth：</font></font></b><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://developer.apple.com/videos/play/wwdc2017/712/</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WWDC 2012セッション703コアBluetooth 101</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WWDC 2012セッション705アドバンストコアBluetooth</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブルートゥース</font></font></b><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.bluetooth.com/specifications/gatt</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bluetooth Low Energy O'Reillyを使い始める</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YouTube</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arrow Electronics→Bluetooth Low Energyシリーズ</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452266/index.html">サーバーレスラック</a></li>
<li><a href="../ja452268/index.html">C＃WPFアナログWindow.ShowDialog（）またはDispatcherFrameを処理する</a></li>
<li><a href="../ja452270/index.html">Xamarin APIドキュメントが公開されました</a></li>
<li><a href="../ja452272/index.html">滝の下の女の子</a></li>
<li><a href="../ja452276/index.html">Dropboxクライアントリバースエンジニアリング</a></li>
<li><a href="../ja452280/index.html">PostgreSQL 11：Postgres 9.6からPostgres 11へのパーティショニングの進化</a></li>
<li><a href="../ja452282/index.html">Elementary、Watson：Voximplantと統合します</a></li>
<li><a href="../ja452284/index.html">eo-learnを使用した土地被覆の分類。パート1</a></li>
<li><a href="../ja452288/index.html">状況：サブスクライバージオデータの違法取引で告発された米国の携帯電話会社</a></li>
<li><a href="../ja452290/index.html">PHDaysで銀行を破るときにハッカーが見逃すもの</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>