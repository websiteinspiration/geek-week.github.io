<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé¨ üõ©Ô∏è üöø Postgres: bloat, pg_repack e restri√ß√µes adiadas ü§∏üèæ üëã üèè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O efeito de inchar tabelas e √≠ndices (incha√ßo) √© amplamente conhecido e est√° presente n√£o apenas no Postgres. Existem maneiras de lidar com isso imedi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Postgres: bloat, pg_repack e restri√ß√µes adiadas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/499444/"><img src="https://habrastorage.org/webt/vf/eu/y5/vfeuy53s9e1md_jhdwxbkkmr-8e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O efeito de inchar tabelas e √≠ndices (incha√ßo) √© amplamente conhecido e est√° presente n√£o apenas no Postgres. </font><font style="vertical-align: inherit;">Existem maneiras de lidar com isso imediatamente, como VACUUM FULL ou CLUSTER, mas elas bloqueiam as tabelas durante a opera√ß√£o e, portanto, nem sempre podem ser usadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O artigo ter√° um pouco de teoria sobre como ocorre o incha√ßo, como lidar com ele, sobre restri√ß√µes adiadas e sobre os problemas que eles trazem para o uso da extens√£o pg_repack.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este artigo √© baseado na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">minha apresenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no PgConf.Russia 2020.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8vaVeCKuz6M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que incha√ßo ocorre</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Postgres √© baseado no modelo multi-vers√£o ( </font></font><abbr title="Controle de simultaneidade com v√°rias vers√µes"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MVCC</font></font></a></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Sua ess√™ncia √© que cada linha da tabela pode ter v√°rias vers√µes, enquanto as transa√ß√µes n√£o veem mais que uma dessas vers√µes, mas n√£o necessariamente a mesma. Isso permite que v√°rias transa√ß√µes funcionem simultaneamente e praticamente n√£o afetam uma a outra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, todas essas vers√µes precisam ser armazenadas. O Postgres trabalha com mem√≥ria p√°gina por p√°gina e a p√°gina √© a quantidade m√≠nima de dados que podem ser lidos a partir do disco ou gravados. Vejamos um pequeno exemplo para entender como isso acontece.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que tenhamos uma tabela na qual adicionamos v√°rios registros. Na primeira p√°gina do arquivo em que a tabela est√° armazenada, novos dados apareceram. Essas s√£o vers√µes ativas de strings que est√£o dispon√≠veis para outras transa√ß√µes ap√≥s uma confirma√ß√£o (por simplicidade, assumiremos que o n√≠vel de isolamento Read Committed). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pb/ep/av/pbepavyhm5_alpqup33j8vfcocm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, atualizamos uma das entradas e, assim, marcamos a vers√£o antiga como irrelevante. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/na/tr/tg/natrtgitck2f7ymtdalnr_coecu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passo a passo, atualizando e excluindo a vers√£o das linhas, obtivemos uma p√°gina na qual cerca da metade dos dados √© "lixo". Esses dados n√£o s√£o vis√≠veis para nenhuma transa√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/8d/ji/_j8djifah3idpuohxwseop01xcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Postgres possui um mecanismo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que limpa vers√µes irrelevantes e libera espa√ßo para novos dados. Mas se ele n√£o estiver configurado de forma agressiva o suficiente ou estiver ocupado trabalhando em outras tabelas, os ‚Äúdados indesejados‚Äù permanecer√£o e precisamos usar p√°ginas adicionais para novos dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, em nosso exemplo, em algum momento, a tabela consistir√° em quatro p√°ginas, mas haver√° apenas metade dos dados ativos. Como resultado, ao acessar a tabela, leremos muito mais dados do que o necess√°rio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nz/ni/rn/nznirnw2kenpvkn7kv7hqwi1k08.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo que o VACUUM agora exclua todas as vers√µes irrelevantes de cadeias, a situa√ß√£o n√£o melhorar√° drasticamente. Teremos espa√ßo livre nas p√°ginas ou at√© p√°ginas inteiras para novas linhas, mas continuaremos a ler mais dados do que o necess√°rio.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, se uma p√°gina completamente em branco (a segunda em nosso exemplo) estivesse no final do arquivo, o VACUUM poderia cort√°-la. </font><font style="vertical-align: inherit;">Mas agora ela est√° no meio, ent√£o nada pode ser feito com ela. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fy/ix/rq/fyixrqdxzpivbooplfjoqpeyc-q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o n√∫mero de p√°ginas em branco ou muito planas se torna grande, chamado incha√ßo, ele come√ßa a afetar o desempenho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo descrito acima √© a mec√¢nica da ocorr√™ncia de incha√ßo nas tabelas. </font><font style="vertical-align: inherit;">Nos √≠ndices, isso acontece da mesma maneira.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu tenho um incha√ßo?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem v√°rias maneiras de determinar se voc√™ tem um incha√ßo. A id√©ia do primeiro √© usar estat√≠sticas internas do Postgres, que cont√™m informa√ß√µes aproximadas sobre o n√∫mero de linhas nas tabelas, o n√∫mero de linhas "ativas" etc. Na Internet, voc√™ pode encontrar muitas varia√ß√µes de scripts prontos. Tomamos como base um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do PostgreSQL Experts, que pode avaliar as tabelas bloat junto com os √≠ndices toast e bloat btree. Em nossa experi√™ncia, seu erro √© de 10 a 20%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra maneira √© usar a extens√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgstattuple</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que permite que voc√™ olhe dentro das p√°ginas e obtenha valores de incha√ßo estimados e precisos. Mas no segundo caso, voc√™ precisa digitalizar a tabela inteira.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um pequeno valor de incha√ßo, at√© 20%, consideramos aceit√°vel. </font><font style="vertical-align: inherit;">Pode ser considerado como um an√°logo do fator de preenchimento para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabelas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√≠ndices</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Em 50% e acima, problemas de desempenho podem come√ßar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maneiras de lidar com o incha√ßo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem v√°rias maneiras de lidar com o incha√ßo imediato no Postgres, mas elas est√£o longe de ser sempre adequadas para todos. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina AUTOVACUUM para que o incha√ßo n√£o ocorra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . E, mais precisamente, para mant√™-lo em um n√≠vel aceit√°vel para voc√™. Este parece ser o conselho do "capit√£o", mas, na realidade, isso nem sempre √© f√°cil de conseguir. Por exemplo, voc√™ est√° desenvolvendo ativamente com altera√ß√µes regulares no esquema de dados ou algum tipo de migra√ß√£o de dados est√° ocorrendo. Como resultado, seu perfil de carregamento pode mudar com frequ√™ncia e, como regra, pode ser diferente para tabelas diferentes. Isso significa que voc√™ precisa trabalhar constantemente um pouco √† frente da curva e ajustar AUTOVACUUM ao perfil de mudan√ßa de cada tabela. Mas √© √≥bvio que isso n√£o √© f√°cil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro motivo comum para o AUTOVACUUM n√£o ter tempo para processar tabelas √© a presen√ßa de transa√ß√µes demoradas que impedem a limpeza de dados devido ao fato de estar dispon√≠vel para essas transa√ß√µes. A recomenda√ß√£o aqui tamb√©m √© √≥bvia - elimine as transa√ß√µes suspensas e minimize o tempo das transa√ß√µes ativas. Mas se a carga no seu aplicativo for um h√≠brido de OLAP e OLTP, ao mesmo tempo, voc√™ poder√° ter muitas atualiza√ß√µes frequentes e solicita√ß√µes curtas, al√©m de opera√ß√µes demoradas - por exemplo, criando um relat√≥rio. Em tal situa√ß√£o, vale a pena pensar em espalhar a carga em diferentes bases, o que permitir√° um ajuste mais preciso de cada uma delas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro exemplo - mesmo que o perfil seja uniforme, mas o banco de dados esteja com uma carga muito alta, mesmo o AUTOVACUUM mais agressivo pode n√£o aguentar, e ocorrer√° um incha√ßo. A escala (vertical ou horizontal) √© a √∫nica solu√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas e a situa√ß√£o quando voc√™ configurou o AUTOVACUUM, mas o incha√ßo continua a crescer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√ÅCUO CHEIO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reconstr√≥i o conte√∫do de tabelas e √≠ndices e deixa apenas dados relevantes neles. Para eliminar o incha√ßo, ele funciona perfeitamente, mas durante sua execu√ß√£o, um bloqueio exclusivo na tabela (AccessExclusiveLock) √© capturado, o que n√£o permitir√° consultas a essa tabela, nem mesmo as seleciona. Se voc√™ puder interromper seu servi√ßo ou parte dele por um tempo (de dezenas de minutos a v√°rias horas, dependendo do tamanho do banco de dados e do seu hardware), essa op√ß√£o √© a melhor. Infelizmente, n√£o temos tempo para executar o VACUUM FULL durante a manuten√ß√£o agendada, portanto esse m√©todo n√£o √© adequado para n√≥s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CLUSTER</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele tamb√©m reconstr√≥i o conte√∫do das tabelas, assim como o VACUUM FULL, ao mesmo tempo em que permite especificar o √≠ndice de acordo com o qual os dados ser√£o ordenados fisicamente no disco (mas no futuro o pedido n√£o ser√° garantido). Em certas situa√ß√µes, essa √© uma boa otimiza√ß√£o para v√°rias consultas - com a leitura de v√°rios registros por √≠ndice. A desvantagem do comando √© a mesma do VACUUM FULL - ele bloqueia a tabela durante a opera√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REINDEX √©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> semelhante aos dois anteriores, mas reconstr√≥i um √≠ndice espec√≠fico ou todos os √≠ndices na tabela. Os bloqueios s√£o um pouco mais fracos: o ShareLock na tabela (impede modifica√ß√µes, mas permite a sele√ß√£o) e o AccessExclusiveLock no √≠ndice reconstru√≠vel (bloqueia solicita√ß√µes usando esse √≠ndice). No entanto, na vers√£o 12 do Postgres, o par√¢metro </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CONCURRENTLY</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que permite recriar o √≠ndice sem bloquear a adi√ß√£o, modifica√ß√£o ou exclus√£o paralela de registros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nas vers√µes anteriores do Postgres, √© poss√≠vel obter um resultado semelhante ao REINDEX CONCURRENTLY com </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE INDEX CONCURRENTLY</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ele permite que voc√™ crie um √≠ndice sem bloqueio estrito (ShareUpdateExclusiveLock, que n√£o interfere nas consultas paralelas), substitua o √≠ndice antigo por um novo e exclua o √≠ndice antigo. Isso elimina os √≠ndices de incha√ßo sem interferir no seu aplicativo. √â importante considerar que, ao recriar √≠ndices, haver√° uma carga adicional no subsistema de disco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, se existem maneiras de os √≠ndices eliminarem o incha√ßo ‚Äúquente‚Äù, ent√£o para as tabelas n√£o h√°. Aqui v√°rias extens√µes externas entram em </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">jogo</font></a><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_repack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(anteriormente pg_reorg), </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgcompact</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgcompacttable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e outros. </font><font style="vertical-align: inherit;">Na estrutura deste artigo, n√£o os compararei e falarei apenas sobre pg_repack, que, ap√≥s algum refinamento, usamos em casa.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como o pg_repack funciona</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5j/bp/ng/5jbpng5ietzdlekjqc32gdf_5cs.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que tenhamos uma tabela muito normal para n√≥s mesmos - com √≠ndices, restri√ß√µes e, infelizmente, com incha√ßo. A primeira etapa √© pg_repack cria uma tabela de log para armazenar dados sobre todas as altera√ß√µes durante a opera√ß√£o. O gatilho replicar√° essas altera√ß√µes para cada inser√ß√£o, atualiza√ß√£o e exclus√£o. Em seguida, √© criada uma tabela semelhante √† estrutura original, mas sem √≠ndices e restri√ß√µes, para n√£o retardar o processo de inser√ß√£o de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, pg_repack transfere dados da tabela antiga para a nova, filtrando automaticamente todas as linhas irrelevantes e, em seguida, cria √≠ndices para a nova tabela. Durante a execu√ß√£o de todas essas opera√ß√µes, as altera√ß√µes s√£o acumuladas na tabela de log.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥ximo passo √© transferir as altera√ß√µes para a nova tabela. </font><font style="vertical-align: inherit;">A migra√ß√£o √© realizada em v√°rias itera√ß√µes e, quando menos de 20 entradas permanecem na tabela de log, o pg_repack captura um bloqueio estrito, transfere os dados mais recentes e substitui a tabela antiga pela nova nas tabelas do sistema Postgres. </font><font style="vertical-align: inherit;">Este √© o √∫nico e muito curto momento em que voc√™ n√£o pode trabalhar com a tabela. </font><font style="vertical-align: inherit;">Depois disso, a tabela antiga e a tabela com os logs s√£o exclu√≠das e o espa√ßo √© liberado no sistema de arquivos. </font><font style="vertical-align: inherit;">O processo est√° conclu√≠do. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em teoria, tudo parece √≥timo, o que na pr√°tica? </font><font style="vertical-align: inherit;">Testamos o pg_repack sem carga e sob carga, verificamos sua opera√ß√£o em caso de parada prematura (em outras palavras, Ctrl + C). </font><font style="vertical-align: inherit;">Todos os testes foram positivos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fomos ao prod - e ent√£o tudo deu errado como esper√°vamos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira panqueca em prod</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No primeiro cluster, recebemos um erro por violar uma restri√ß√£o exclusiva:</font></font><br>
<br>
<pre><code class="bash hljs">$ ./pg_repack -t tablename -o id<font></font>
INFO: repacking table <span class="hljs-string">"tablename"</span><font></font>
ERROR: query failed: <font></font>
    ERROR: duplicate key value violates unique constraint <span class="hljs-string">"index_16508"</span><font></font>
DETAIL:  Key (id, index)=(100500, 42) already exists.<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa restri√ß√£o tinha o nome gerado automaticamente index_16508 - foi criada por pg_repack. </font><font style="vertical-align: inherit;">Pelos atributos inclu√≠dos em sua composi√ß√£o, determinamos a "nossa" restri√ß√£o, que corresponde a ela. </font><font style="vertical-align: inherit;">O problema acabou sendo que essa n√£o √© uma restri√ß√£o comum, mas uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restri√ß√£o adiada</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou seja, </font><font style="vertical-align: inherit;">sua verifica√ß√£o √© realizada depois do comando sql, o que leva a consequ√™ncias inesperadas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restri√ß√µes adiadas: por que elas s√£o necess√°rias e como funcionam</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um pouco de teoria sobre restri√ß√µes adiadas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere um exemplo simples: temos uma tabela de refer√™ncia de carro com dois atributos - o nome e a ordem do carro no diret√≥rio</font></font><br>
<img src="https://habrastorage.org/webt/n8/1s/td/n81stdw9kie5wll03ylnel18aie.png" align="right"><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cars<font></font>
(<font></font>
  <span class="hljs-type">name</span> <span class="hljs-type">text</span> <span class="hljs-keyword">constraint</span> pk_cars <span class="hljs-keyword">primary key</span>,<font></font>
  ord <span class="hljs-type">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">constraint</span> uk_cars <span class="hljs-keyword">unique</span><font></font>
);<font></font>
</code></pre><br>
<br clear="all"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Digamos que precis√°ssemos trocar o primeiro e o segundo carros. </font><font style="vertical-align: inherit;">A solu√ß√£o "na testa" √© atualizar o primeiro valor para o segundo e o segundo para o primeiro:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">begin</span>;
  <span class="hljs-keyword">update</span> cars <span class="hljs-keyword">set</span> ord = <span class="hljs-number">2</span> <span class="hljs-keyword">where</span> <span class="hljs-type">name</span> = <span class="hljs-string">'audi'</span>;
  <span class="hljs-keyword">update</span> cars <span class="hljs-keyword">set</span> ord = <span class="hljs-number">1</span> <span class="hljs-keyword">where</span> <span class="hljs-type">name</span> = <span class="hljs-string">'bmw'</span>;
<span class="hljs-keyword">commit</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, ao executar esse c√≥digo, esperamos obter uma viola√ß√£o da restri√ß√£o, porque a ordem dos valores na tabela √© √∫nica:</font></font><br>
<br>
<pre><code class="bash hljs">[23305] ERROR: duplicate key value violates unique constraint ‚Äúuk_cars‚Äù<font></font>
Detail: Key (ord)=(2) already exists.<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como fazer diferente? Op√ß√£o um: adicione uma substitui√ß√£o adicional do valor por um pedido que n√£o existe na tabela, por exemplo, "-1". Na programa√ß√£o, isso √© chamado de "troca dos valores de duas vari√°veis ‚Äã‚Äãpela terceira". A √∫nica desvantagem desse m√©todo √© a atualiza√ß√£o adicional. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Op√ß√£o 2: redesenhe a tabela para usar um tipo de dados de ponto flutuante para o valor do pedido em vez de n√∫meros inteiros. Ent√£o, ao atualizar o valor de 1, por exemplo, para 2,5, o primeiro registro ser√° automaticamente "levantado" entre o segundo e o terceiro. Esta solu√ß√£o funciona, mas existem duas limita√ß√µes. Em primeiro lugar, n√£o funcionar√° para voc√™ se o valor for usado em algum lugar da interface. Em segundo lugar, dependendo da precis√£o do tipo de dados, voc√™ ter√° um n√∫mero limitado de inser√ß√µes poss√≠veis antes de recalcular os valores de todos os registros.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Op√ß√£o tr√™s: torne a restri√ß√£o adiada para que seja verificada apenas no momento da confirma√ß√£o:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cars<font></font>
(<font></font>
  <span class="hljs-type">name</span> <span class="hljs-type">text</span> <span class="hljs-keyword">constraint</span> pk_cars <span class="hljs-keyword">primary key</span>,<font></font>
  ord <span class="hljs-type">integer</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">constraint</span> uk_cars <span class="hljs-keyword">unique</span> <span class="hljs-keyword">deferrable</span> <span class="hljs-keyword">initially</span> <span class="hljs-keyword">deferred</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como a l√≥gica de nossa solicita√ß√£o inicial garante que todos os valores sejam √∫nicos no momento da confirma√ß√£o, ela ser√° bem-sucedida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O exemplo acima √©, obviamente, muito sint√©tico, mas revela a ideia. </font><font style="vertical-align: inherit;">Em nosso aplicativo, usamos restri√ß√µes adiadas para implementar a l√≥gica respons√°vel pela resolu√ß√£o de conflitos enquanto trabalhamos simultaneamente com objetos de widget comuns no quadro. </font><font style="vertical-align: inherit;">O uso de tais restri√ß√µes nos permite facilitar um pouco o c√≥digo do aplicativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, dependendo do tipo de restri√ß√£o no Postgres, h√° tr√™s n√≠veis de granularidade para verific√°-las: n√≠vel de linha, transa√ß√£o e express√£o. </font></font><br>
<img src="https://habrastorage.org/webt/vn/bw/qq/vnbwqqmhgjpnd7kb8dtxpixb8xi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fonte: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">begriffs</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CHECK e NOT NULL s√£o sempre verificados no n√≠vel da linha. Para outras restri√ß√µes, como pode ser visto na tabela, existem op√ß√µes diferentes. </font><font style="vertical-align: inherit;">Leia mais </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resumir brevemente, as restri√ß√µes pendentes em algumas situa√ß√µes fornecem c√≥digo mais leg√≠vel e menos comandos. </font><font style="vertical-align: inherit;">No entanto, voc√™ precisa pagar por isso, complicando o processo de depura√ß√£o, pois o momento em que o erro ocorreu e o momento em que voc√™ descobriu sobre ele s√£o separados no tempo. </font><font style="vertical-align: inherit;">Outro poss√≠vel problema √© que o planejador nem sempre pode criar o plano ideal se uma restri√ß√£o atrasada estiver envolvida na solicita√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refinamento pg_repack</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descobrimos o que s√£o restri√ß√µes pendentes, mas como elas est√£o relacionadas ao nosso problema? </font><font style="vertical-align: inherit;">Lembre-se do erro que recebemos anteriormente:</font></font><br>
<br>
<pre><code class="bash hljs">$ ./pg_repack -t tablename -o id<font></font>
INFO: repacking table <span class="hljs-string">"tablename"</span><font></font>
ERROR: query failed: <font></font>
    ERROR: duplicate key value violates unique constraint <span class="hljs-string">"index_16508"</span>
DETAIL:  Key (id, index)=(100500, 42) already exists.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ocorre no momento da c√≥pia dos dados da tabela de log para a nova tabela. Parece estranho porque os dados na tabela de log s√£o confirmados junto com os dados na tabela original. Se eles satisfazem as restri√ß√µes da tabela original, como podem violar as mesmas restri√ß√µes na nova? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se viu, a raiz do problema est√° na etapa anterior do pg_repack, na qual apenas √≠ndices s√£o criados, mas n√£o restri√ß√µes: a tabela antiga tinha uma restri√ß√£o exclusiva e a nova criou um √≠ndice exclusivo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_y/da/fc/_ydafcxizllawi1jo3o5ai-x-kg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante observar aqui que, se a restri√ß√£o for normal e n√£o adiada, o √≠ndice exclusivo criado em vez dele ser√° equivalente a essa restri√ß√£o, porque </font><font style="vertical-align: inherit;">As restri√ß√µes exclusivas do Postgres s√£o implementadas criando um √≠ndice exclusivo. </font><font style="vertical-align: inherit;">Mas, no caso de uma restri√ß√£o adiada, o comportamento n√£o √© o mesmo, porque o √≠ndice n√£o pode ser adiado e √© sempre verificado no momento em que o comando sql √© executado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, a ess√™ncia do problema est√° no "adiamento" da verifica√ß√£o: na tabela original, ela ocorre no momento do commit e no novo - no momento da execu√ß√£o do comando sql. </font><font style="vertical-align: inherit;">Portanto, precisamos garantir que as verifica√ß√µes sejam executadas da mesma maneira nos dois casos: sempre adiadas ou sempre imediatamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, que id√©ias tivemos?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie um √≠ndice semelhante ao adiado</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira id√©ia √© realizar as duas verifica√ß√µes no modo imediato. Isso pode dar origem a v√°rios gatilhos falsos positivos da restri√ß√£o, mas se houver poucos deles, isso n√£o deve afetar o trabalho dos usu√°rios, pois para eles esses conflitos s√£o uma situa√ß√£o normal. Eles ocorrem, por exemplo, quando dois usu√°rios come√ßam a editar simultaneamente o mesmo widget e o cliente do segundo usu√°rio n√£o tem tempo para obter informa√ß√µes de que o widget j√° est√° bloqueado para edi√ß√£o pelo primeiro usu√°rio. Nessa situa√ß√£o, o servidor recusa o segundo usu√°rio e seu cliente reverte as altera√ß√µes e bloqueia o widget. Um pouco mais tarde, quando o primeiro usu√°rio concluir a edi√ß√£o, o segundo receber√° informa√ß√µes de que o widget n√£o est√° mais bloqueado e poder√° repetir sua a√ß√£o.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dw/oq/jw/dwoqjwhuqva3veavihajfcd5t4c.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantir que as verifica√ß√µes estejam sempre no modo de emerg√™ncia, criamos um novo √≠ndice semelhante √† restri√ß√£o adiada original:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">CONCURRENTLY</span> uk_tablename__immediate <span class="hljs-keyword">ON</span> tablename (id, <span class="hljs-keyword">index</span>);
<span class="hljs-comment">-- run pg_repack</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">CONCURRENTLY</span> uk_tablename__immediate;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No ambiente de teste, recebemos apenas alguns erros esperados. Sucesso! Novamente lan√ßamos o pg_repack no prod e obtivemos 5 erros no primeiro cluster em uma hora de trabalho. Este √© um resultado aceit√°vel. No entanto, j√° no segundo cluster, o n√∫mero de erros aumentou muitas vezes e tivemos que parar o pg_repack. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que isso aconteceu? A probabilidade de um erro depende de quantos usu√°rios trabalham simultaneamente com os mesmos widgets. Aparentemente, naquele momento com os dados armazenados no primeiro cluster, havia muito menos mudan√ßas competitivas do que no restante, ou seja, n√≥s tivemos apenas "sorte". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ideia n√£o deu certo. Nesse momento, vimos duas outras op√ß√µes de solu√ß√£o: reescrever nosso c√≥digo de aplicativo para abandonar as restri√ß√µes pendentes ou "ensinar" o pg_repack para trabalhar com eles. N√≥s escolhemos o segundo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Substituir √≠ndices na nova tabela por restri√ß√µes adiadas da tabela de origem</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O objetivo da revis√£o era √≥bvio - se a tabela original tiver uma restri√ß√£o adiada, para a nova voc√™ precisar√° criar essa restri√ß√£o, n√£o um √≠ndice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testar nossas altera√ß√µes, escrevemos um teste simples:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabela com restri√ß√£o diferida e um registro;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">insira dados no loop que entrem em conflito com o registro existente;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make update - os dados n√£o conflitam mais;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">confirmar a altera√ß√£o.</font></font></li>
</ul><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> test_table<font></font>
(<font></font>
  id <span class="hljs-type">serial</span>,<font></font>
  val <span class="hljs-type">int</span>,
  <span class="hljs-keyword">constraint</span> uk_test_table__val <span class="hljs-keyword">unique</span> (val) <span class="hljs-keyword">deferrable</span> <span class="hljs-keyword">initially</span> <span class="hljs-keyword">deferred</span> <font></font>
);<font></font>
</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_table (val) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">0</span>);
<span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">1.</span><span class="hljs-number">.10000</span> <span class="hljs-keyword">LOOP</span>
  <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_table <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">0</span>) <span class="hljs-keyword">RETURNING</span> id <span class="hljs-keyword">INTO</span> v_id;
    <span class="hljs-keyword">UPDATE</span> test_table <span class="hljs-keyword">set</span> val = i <span class="hljs-keyword">where</span> id = v_id;
    <span class="hljs-keyword">COMMIT</span>;
  <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A vers√£o original do pg_repack sempre falhava na primeira inser√ß√£o, a vers√£o revisada funcionava sem erros. </font><font style="vertical-align: inherit;">Bem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ao produto e, novamente, obtemos um erro na mesma fase de c√≥pia de dados da tabela de log para a nova:</font></font><br>
<br>
<pre><code class="bash hljs">$ ./pg_repack -t tablename -o id<font></font>
INFO: repacking table <span class="hljs-string">"tablename"</span><font></font>
ERROR: query failed: <font></font>
    ERROR: duplicate key value violates unique constraint <span class="hljs-string">"index_16508"</span>
DETAIL:  Key (id, index)=(100500, 42) already exists.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Situa√ß√£o cl√°ssica: tudo funciona em ambientes de teste, mas n√£o em prod ?!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APPLY_COUNT e a jun√ß√£o de dois lotes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßamos a analisar o c√≥digo literalmente linha por linha e descobrimos um ponto importante: os dados s√£o transferidos da tabela de logs para a nova com lotes, a constante APPLY_COUNT indica o tamanho do lote:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">for</span> (;;)<font></font>
{<font></font>
num = apply_log(connection, table, APPLY_COUNT);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (num &gt; MIN_TUPLES_BEFORE_SWITCH)
     <span class="hljs-keyword">continue</span>;  <span class="hljs-comment">/* there might be still some tuples, repeat. */</span><font></font>
...<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema √© que os dados da transa√ß√£o original, na qual v√°rias opera√ß√µes podem violar a restri√ß√£o, podem ser transferidos para a jun√ß√£o de dois lotes durante a transfer√™ncia - metade das equipes ser√° confirmada na primeira partida e a outra metade na segunda. E aqui est√° a sorte: se as equipes do primeiro lote n√£o violarem nada, tudo estar√° bem, mas se violarem - ocorrer√° um erro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APPLY_COUNT √© igual a 1000 entradas, o que explica por que nossos testes foram bem-sucedidos - eles n√£o cobriram o caso de "jun√ß√£o de lotes". Usamos dois comandos - inserir e atualizar, para que exatamente 500 transa√ß√µes de duas equipes fossem sempre colocadas no lote e n√£o tivemos problemas. Depois de adicionar a segunda atualiza√ß√£o, nossa edi√ß√£o parou de funcionar:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">1.</span><span class="hljs-number">.10000</span> <span class="hljs-keyword">LOOP</span>
  <span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_table <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>) <span class="hljs-keyword">RETURNING</span> id <span class="hljs-keyword">INTO</span> v_id;
    <span class="hljs-keyword">UPDATE</span> test_table <span class="hljs-keyword">set</span> val = i <span class="hljs-keyword">where</span> id = v_id;
    <span class="hljs-keyword">UPDATE</span> test_table <span class="hljs-keyword">set</span> val = i <span class="hljs-keyword">where</span> id = v_id; <span class="hljs-comment">-- one more update</span>
    <span class="hljs-keyword">COMMIT</span>;
  <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a pr√≥xima tarefa √© garantir que os dados da tabela de origem que foram alterados em uma transa√ß√£o caiam na nova tabela tamb√©m dentro da mesma transa√ß√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recusa de Butching</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, novamente, tivemos duas solu√ß√µes. </font><font style="vertical-align: inherit;">Primeiro: vamos abandonar completamente o lote e fazer a transfer√™ncia de dados em uma transa√ß√£o. </font><font style="vertical-align: inherit;">A favor desta solu√ß√£o estava a sua simplicidade - as altera√ß√µes de c√≥digo necess√°rias eram m√≠nimas (a prop√≥sito, em vers√µes mais antigas, o pg_reorg funcionava dessa maneira). </font><font style="vertical-align: inherit;">Mas h√° um problema - estamos criando uma transa√ß√£o longa, e isso, como foi dito anteriormente, √© uma amea√ßa ao surgimento de um novo incha√ßo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda solu√ß√£o √© mais complicada, mas provavelmente mais correta: crie uma coluna na tabela de log com o identificador da transa√ß√£o que adicionou os dados √† tabela. Em seguida, ao copiar dados, poderemos agrup√°-los por esse atributo e garantir que as altera√ß√µes relacionadas sejam transferidas juntas. Um lote ser√° formado a partir de v√°rias transa√ß√µes (ou uma grande) e seu tamanho variar√° dependendo da quantidade de dados alterados nessas transa√ß√µes. √â importante observar que, como os dados de diferentes transa√ß√µes caem na tabela de logs em ordem aleat√≥ria, n√£o ser√° poss√≠vel l√™-los sequencialmente, como antes. o seqscan para cada solicita√ß√£o filtrada por tx_id √© muito caro, voc√™ precisa de um √≠ndice, mas ele atrasar√° o m√©todo devido √† sobrecarga de atualiz√°-lo. Em geral, como sempre, voc√™ precisa sacrificar alguma coisa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, decidimos come√ßar com a primeira op√ß√£o, como uma mais simples. Primeiro, era necess√°rio entender se uma transa√ß√£o longa seria um problema real. Como a principal transfer√™ncia de dados da tabela antiga para a nova tamb√©m ocorre em uma transa√ß√£o longa, a pergunta se transformou em "quanto aumentaremos essa transa√ß√£o?" A dura√ß√£o da primeira transa√ß√£o depende principalmente do tamanho da tabela. A dura√ß√£o do novo depende de quantas altera√ß√µes se acumulam na tabela durante a transfer√™ncia de dados, ou seja, a partir da intensidade da carga. A execu√ß√£o do pg_repack ocorreu durante a carga m√≠nima no servi√ßo e a quantidade de altera√ß√µes foi incomparavelmente pequena em compara√ß√£o com o tamanho da tabela original. Decidimos que podemos negligenciar o tempo da nova transa√ß√£o (para compara√ß√£o, isso √© uma m√©dia de 1 hora e 2-3 minutos).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As experi√™ncias foram positivas. Correndo no prod tamb√©m. Para maior clareza, uma imagem com o tamanho de uma das bases ap√≥s a execu√ß√£o: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z4/ps/gu/z4psgu_s8jsbhwnxst2pogfcsfa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como essa solu√ß√£o nos serviu completamente, n√£o tentamos implementar a segunda, mas estamos pensando em discuti-la com os desenvolvedores da extens√£o. Infelizmente, nossa revis√£o atual ainda n√£o est√° pronta para publica√ß√£o, pois resolvemos o problema apenas com restri√ß√µes pendentes exclusivas e, para um patch de pleno direito, √© necess√°rio dar suporte a outros tipos. Esperamos poder fazer isso no futuro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez voc√™ tenha uma pergunta, por que nos envolvemos nessa hist√≥ria com a conclus√£o de pg_repack e, por exemplo, n√£o usamos seus an√°logos? </font><font style="vertical-align: inherit;">Em algum momento, tamb√©m pensamos nisso, mas a experi√™ncia positiva de us√°-lo anteriormente, em tabelas sem restri√ß√µes pendentes, nos motivou a tentar entender a ess√™ncia do problema e corrigi-lo. </font><font style="vertical-align: inherit;">Al√©m disso, para usar outras solu√ß√µes, tamb√©m leva tempo para a realiza√ß√£o de testes, por isso decidimos que primeiro tentar√≠amos resolver o problema e, se percebermos que n√£o poder√≠amos faz√™-lo em um per√≠odo de tempo razo√°vel, come√ßar√≠amos a considerar an√°logos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">achados</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que podemos recomendar com base em nossa pr√≥pria experi√™ncia:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitore seu incha√ßo. </font><font style="vertical-align: inherit;">Com base nos dados de monitoramento, voc√™ pode entender como o v√°cuo autom√°tico est√° configurado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Defina AUTOVACUUM para manter o incha√ßo em um n√≠vel razo√°vel.</font></font></li>
<li>   bloat           ‚Äú ‚Äù,     .  ‚Äì   .</li>
<li>        ‚Äì        ,     .</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499434/index.html">Como implementar a gest√£o do conhecimento: beneficie ‚Äúmalotes‚Äù, ‚Äúmultas de papagaio‚Äù e pensamento de clipe</a></li>
<li><a href="../pt499436/index.html">Enzima controlada remotamente acelerar√° o tratamento de derrames e les√µes na coluna vertebral</a></li>
<li><a href="../pt499438/index.html">Transmita para testadores e n√£o apenas</a></li>
<li><a href="../pt499440/index.html">Como escrevemos o piloto autom√°tico mais legal do mundo para uma locomotiva de manobra</a></li>
<li><a href="../pt499442/index.html">Criando um jogo de corrida pseudo-3D: implementando as colinas e finalizando o jogo</a></li>
<li><a href="../pt499446/index.html">Testando gerenciadores de inicializa√ß√£o no formato STEP para VR</a></li>
<li><a href="../pt499448/index.html">Implementando o SOLID e a arquitetura em camadas no Node.js com TypeScript e InversifyJS</a></li>
<li><a href="../pt499450/index.html">Escolhendo o equipamento para um jogo persa usando gen√©tica / evolu√ß√£o em Python</a></li>
<li><a href="../pt499452/index.html">Cotidiano de um oftalmologista na cl√≠nica: quando os m√©dicos n√£o s√£o suficientes</a></li>
<li><a href="../pt499454/index.html">Video Live! Badoo Localization Meetup 21 de abril</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>