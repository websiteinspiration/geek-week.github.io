<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🔬 🎚️ 📴 マクロの魔法の力、またはAVRアセンブラープログラマーの生活を楽にする方法 🕥 ⚠️ 🐠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="アセンブラーのマクロについてはたくさん書かれています。そして、ドキュメントやさまざまな記事で。しかし、ほとんどの場合、機能の簡単な説明を含むディレクティブの簡単なリスト、または既製のマクロのさまざまな例のセットのいずれかになります。
 この記事の目的は、マクロを使用して最も単純で読みやすいコードを生...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>マクロの魔法の力、またはAVRアセンブラープログラマーの生活を楽にする方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465261/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブラーのマクロについてはたくさん書かれています。そして、ドキュメントやさまざまな記事で。しかし、ほとんどの場合、機能の簡単な説明を含むディレクティブの簡単なリスト、または既製のマクロのさまざまな例のセットのいずれかになります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事の目的は、マクロを使用して最も単純で読みやすいコードを生成するためのアセンブリ言語プログラミングへの特定のアプローチを説明することです。この記事では、個々のコマンドとディレクティブの構文については説明しません。詳細な説明は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メーカー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">により既に提供されています</font><font style="vertical-align: inherit;">。これらの機会を使用して特定の問題を解決する方法に焦点を当てます。</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATMELはかつて、非常に高品質のアーキテクチャとシンプルでありながら非常に強力なコマンドシステムを備えた8ビットマイクロコントローラーのラインを試し開発しました。</font><font style="vertical-align: inherit;">しかし、ご存じのとおり、完璧に制限はなく、頻繁に使用される指示の一部では不十分です。</font><font style="vertical-align: inherit;">幸いなことに、マクロアセンブラは、製造元から提供された親切かつ完全に無料で、ディレクティブを使用することでコードを大幅に簡略化できます。</font><font style="vertical-align: inherit;">マクロに直接進む前に、いくつかの予備ステップを実行します</font></font></p><br>
<h3 id="opredelenie-konstant"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定数の定義</font></font></h3><br>
<pre><code class="plaintext hljs">.EQU    FOSC = 16000000<font></font>
.EQU CLK8 = 0</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらの2つの定義により、マクロの「マジックナンバー」を取り除くことができます。レジスターの値は、プロセッサーの周波数とペリフェラルディバイダーのヒューズの状態に基づいて計算されます。</font><font style="vertical-align: inherit;">1つ目の定義はヘルツ単位のプロセッサクリスタルの周波数で、2つ目の定義は周辺周波数分割器の状態です。</font></font></p><br>
<h3 id="imenovanie-registrov"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">登録名</font></font></h3><br>
<pre><code class="plaintext hljs">.DEF TempL = r16<font></font>
.DEF TempH = r17<font></font>
.DEF TempQL = r18<font></font>
.DEF TempQH = r19<font></font>
.DEF AL = r0<font></font>
.DEF AH = r1<font></font>
.DEF AQL = r2<font></font>
.DEF AQH = r3</code></pre><br>
<p>      ,      .     <em>Temp</em> ,       32-   (,     16-  ).   ,           ,  <em>TempQL</em>  <em>TempQH</em>   .   <em>A</em>   ,   .   <em>AQ</em> ,         32-  .</p><br>
<h3 id="makrosy-dlya-realizacii-prostyh-komand">    </h3><br>
<p>,      ,    ,       ,    .  AVR    .      64    <em>in/out</em>,    <em>lds/sts</em>.  ,              ,    ,      .</p><br>
<pre><code class="plaintext hljs">.MACRO XOUT<font></font>
.IF @0&lt;64<font></font>
out      @0,@1<font></font>
.ELSE<font></font>
sts     @0,@1<font></font>
.ENDIF<font></font>
.ENDMACRO<font></font>
<font></font>
.MACRO XIN<font></font>
.IF @1&lt;64<font></font>
in      @0,@1<font></font>
.ELSE<font></font>
lds     @0,@1<font></font>
.ENDIF<font></font>
.ENDMACRO</code></pre><br>
<p> ,    ,     .  ,     64,    ,    — .           -,    ,           <em>X</em>.<br>
    ,    ,   ,        .         </p><br>
<pre><code class="plaintext hljs">.MACRO OUTI<font></font>
ldi      TempL,@1    <font></font>
.IF @0&lt;64<font></font>
out      @0, TempL                   <font></font>
.ELSE<font></font>
sts @0, TempL<font></font>
.ENDIF<font></font>
.ENDMACRO</code></pre><br>
<p>     ,      ,      <em>I</em>,        .             <em>TempL</em>.<br>
       ,   ,  16- .       16-     -</p><br>
<pre><code class="plaintext hljs">.MACRO OUTIW<font></font>
ldi      TempL,HIGH(@1)    <font></font>
.IF @0&lt;64<font></font>
out      @0H, TempL                   <font></font>
.ELSE<font></font>
sts @0H, TempL<font></font>
.ENDIF<font></font>
ldi      TempL,LOW(@1)    <font></font>
.IF @0&lt;64<font></font>
out      @0L, TempL                   <font></font>
.ELSE<font></font>
sts @0L, TempL<font></font>
.ENDIF<font></font>
.ENDMACRO</code></pre><br>
<p>       <em>LOW</em>  <em>HIGH</em>        16-  .        <em>I</em>  <em>W</em>   ,        16   ().<br>
        ,      .    </p><br>
<pre><code class="plaintext hljs">.MACRO ldiw<font></font>
ldi    @0L, LOW(@1)<font></font>
ldi    @0H, HIGH(@1)<font></font>
.ENDMACRO</code></pre><br>
<p>      ,           <em>L</em>     <em>H</em>     .        ,           .      ,     ,    ,    ,   ,    ,   . </p><br>
<h3 id="makrosy-dlya-realizacii-slozhnyh-komand">    .</h3><br>
<p>      , ,  ,  ,  .              .          .       :<br>
       ,  , , <strong>Library.inc</strong>.         </p><br>
<pre><code class="plaintext hljs">_sub0:<font></font>
.IFDEF __sub0<font></font>
; -----    -----<font></font>
ret     <font></font>
.ENDIF</code></pre><br>
<p>     __sub0 ,        .     .<br>
    <strong>Macro.inc</strong>   </p><br>
<pre><code class="plaintext hljs">.MACRO SUB0<font></font>
.IFNDEF __sub0<font></font>
.DEF __sub0<font></font>
.ENDIF<font></font>
; ---         <font></font>
call _sub0<font></font>
.ENDMACRO</code></pre><br>
<p>        __sub0 ,    ,  .  ,         .            </p><br>
<pre><code class="plaintext hljs">.INCLUDE “Macro.inc”<font></font>
;----    ----<font></font>
.INCLUDE “Library.inc”</code></pre><br>
<p>  ,      8-    .        <em>AL (r0)</em>,      <em>AH(r1)</em>.     </p><br>
<pre><code class="plaintext hljs">_div8u:<font></font>
.IFDEF __ div8u<font></font>
;AH - <font></font>
;AL <font></font>
;TempL - <font></font>
;TempH - <font></font>
;TempQL -  <font></font>
clr AL;<font></font>
clr AH; <font></font>
ldi TempQL,9 <font></font>
d8u_1:  rol TempL <font></font>
dec TempQL<font></font>
brne d8u_2<font></font>
ret<font></font>
d8u_2: rol A <font></font>
sub  AH, TempH <font></font>
brcc  d8u_3<font></font>
add  AH,TempH<font></font>
clc <font></font>
rjmp d8u_1 <font></font>
d8u_3: sec<font></font>
rjmp d8u_1 <font></font>
.ENDIF</code></pre><br>
<p>      </p><br>
<pre><code class="plaintext hljs">.MACRO DIV8U<font></font>
.IFNDEF __div8u<font></font>
.DEF __div8u<font></font>
.ENDIF<font></font>
mov TempL, @0<font></font>
mov     TempH, @1<font></font>
call    _div8u<font></font>
.ENDMACRO</code></pre><br>
<p>         </p><br>
<pre><code class="plaintext hljs">.MACRO DIV8UI<font></font>
.IFNDEF __div8u<font></font>
.DEF __div8u<font></font>
.ENDIF<font></font>
mov TempL, @0<font></font>
ldi     TempH, @1<font></font>
call    _div8u<font></font>
.ENDMACRO</code></pre><br>
<p>         </p><br>
<pre><code class="plaintext hljs">DIV8U r10, r11 ; r0 = r10/r11 r1 = r10 % r11<font></font>
DIV8UI r10, 35 ; r0 = r10/35  r1 = r10 % 35 </code></pre><br>
<p>       <strong>Library.inc</strong>  ,     .          ,     .      .        .       ,     .       ,           . </p><br>
<h3 id="makrosy-dlya-raboty-s-periferiey">    </h3><br>
<p>  ,       ,    .             ,        ,  ,         .        <em>USART</em>.<br>
     .</p><br>
<pre><code class="plaintext hljs">.MACRO USART_INIT ; speed, bytes, parity, stop-bits <font></font>
  .IF CLK8 == 0<font></font>
 .SET DIVIDER = FOSC/16/@0-1<font></font>
  .ELSE<font></font>
  .SET DIVIDER = FOSC/128/@0-1<font></font>
  .ENDIF<font></font>
  ; Set baud rate to UBRR0   <font></font>
  outi    UBRR0H, HIGH(DIVIDER)   <font></font>
  outi    UBRR0L, LOW(DIVIDER)<font></font>
<font></font>
  ; Enable receiver and transmitter   <font></font>
  .SET UCSR0B_ = (1&lt;&lt;RXEN0)|(1&lt;&lt;TXEN0) <font></font>
  outi    UCSR0B, UCSR0B_<font></font>
<font></font>
  .SET UCSR0C_  = 0<font></font>
  .IF @2 == 'E'<font></font>
  .SET UCSR0C_ |= (1&lt;&lt;UPM01)<font></font>
  .ENDIF<font></font>
 .IF @2 == 'O'<font></font>
  .SET UCSR0C_ |= (1&lt;&lt;UPM00)<font></font>
  .ENDIF<font></font>
  .IF @3== 2<font></font>
  .SET UCSR0C_ |= (1&lt;&lt;USBS0)<font></font>
  .ENDIF<font></font>
  .IF @1== 6<font></font>
  .SET UCSR0C_ |= (1&lt;&lt;UCSZ00)<font></font>
  .ENDIF<font></font>
  .IF @1== 7<font></font>
  .SET UCSR0C_ |= (1&lt;&lt;UCSZ01)<font></font>
  .ENDIF<font></font>
  .IF @1== 8<font></font>
  .SET UCSR0C_ = UCSR0C_ |(1&lt;&lt;UCSZ01)|(1&lt;&lt;UCSZ00)<font></font>
  .ENDIF<font></font>
  .IF @1== 9<font></font>
  .SET UCSR0C_ |= (1&lt;&lt;UCSZ02)|(1&lt;&lt;UCSZ01)|(1&lt;&lt;UCSZ00)<font></font>
  .ENDIF<font></font>
  ; Set frame format<font></font>
  outi    UCSR0C,UCSR0C_<font></font>
 .ENDMACRO</code></pre><br>
<p>        <em>USART</em>       ,      ,      .                .    ,       ,      ,        .<br>
   <em>USART</em>     </p><br>
<pre><code class="plaintext hljs"> .MACRO USART_SEND_ASYNC<font></font>
  outi  UDR0, @0<font></font>
 .ENDMACRO</code></pre><br>
<p>   ,       ,        <em>USART</em>.          ,   <em>USART_SEND_ASYNC</em>   ,  </p><br>
<pre><code class="plaintext hljs">  .MACRO USART_SEND<font></font>
USART_Transmit:<font></font>
xin TempL, UCSR0A <font></font>
sbrs TempL, UDRE0 <font></font>
rjmp USART_Transmit <font></font>
outi    UDR0, @0<font></font>
 .ENDMACRO</code></pre><br>
<p>            ,   . ,             ,     <em>USART</em>.</p><br>
<h3 id="sravnenie-programm-bez-i-s-ispolzovaniem-makrosov">      .</h3><br>
<p>      ,      ,   .       <strong>«Hello world!»</strong>     <em>UART</em>. </p><br>
<pre><code class="plaintext hljs"> RESET: ldi r16, high(RAMEND) <font></font>
out SPH,r16 <font></font>
ldi r16, low(RAMEND)<font></font>
out SPL,r16 <font></font>
USART_Init: <font></font>
out UBRR0H, r17 <font></font>
out UBRR0L, r16 <font></font>
ldi r16, (1&lt;&lt;RXEN0)|(1&lt;&lt;TXEN0) <font></font>
out UCSRnB,r16<font></font>
ldi r16, (1&lt;&lt;USBS0)|(3&lt;&lt;UCSZ00) <font></font>
out UCSR0C,r16 <font></font>
ldi ZL, LOW(STR&lt;&lt;1)<font></font>
ldi ZH, HIGH(STR&lt;&lt;1)<font></font>
LOOP: lpm   r16, Z+<font></font>
or  r16,r16<font></font>
breq    END<font></font>
USART_Transmit: <font></font>
in r17, UCSR0A <font></font>
sbrs r17, UDRE0 <font></font>
rjmp USART_Transmit <font></font>
out UDR0,r16 <font></font>
rjmp    LOOP<font></font>
END: rjmp END<font></font>
STR: .DB  “Hello world!”,0</code></pre><br>
<p>      ,     </p><br>
<pre><code class="plaintext hljs">.INCLUDE “macro.inc”<font></font>
.EQU    FOSC = 16000000<font></font>
.EQU   CLK8 = 0<font></font>
RESET: ldiw SP, RAMEND; <font></font>
USART_INIT 19200, 8, "N", 1<font></font>
ldiw Z, STR&lt;&lt;1<font></font>
LOOP: lpm TempL, Z+<font></font>
test    TempL<font></font>
breq    END<font></font>
USART_SEND TempL <font></font>
rjmp    LOOP<font></font>
END: rjmp END<font></font>
STR: .DB  “Hello world!”,0</code></pre><br>
<p>       ,           .          .</p><br>
<h3 id="vyvod"></h3><br>
<p>       ,      .              .                    «».    ,  ,         <em>jmp/rjmp</em>          .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja465249/index.html">モスクワ工科大学でのリチャードストールマンによる講義。2019年8月</a></li>
<li><a href="../ja465251/index.html">夏がもうすぐ終わります。データ漏洩はほとんどありません</a></li>
<li><a href="../ja465255/index.html">HttpClientFactoryを使用した.Net CoreのWCF接続プールの実装</a></li>
<li><a href="../ja465257/index.html">「注意、FAS！」：マクドナルドのトリック、神のシャワルマ、偽のクルーニーといくつかのストリートマジック</a></li>
<li><a href="../ja465259/index.html">ValueTask <TResult>-理由、理由、方法</a></li>
<li><a href="../ja465263/index.html">PostgreSQLのロック：3.他のオブジェクトをロックします</a></li>
<li><a href="../ja465267/index.html">TypeScript 表現の魔法</a></li>
<li><a href="../ja465269/index.html">Cisco 200-125 CCNA v3.0のトレーニング。26日目。DNSとDHCP</a></li>
<li><a href="../ja465271/index.html">ハッカーは、食べ物の配達やホテルの予約サービスを通じてお金を盗んだり、洗濯したりします。</a></li>
<li><a href="../ja465275/index.html">アリスはスキルを得る</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>