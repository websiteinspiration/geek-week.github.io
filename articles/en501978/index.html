<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçù üëü ‚ÄºÔ∏è How does the Prometheus histogram work? üèÇüèø üÜï üëßüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A translation of the article was prepared ahead of the start of the course ‚ÄúMonitoring and Logging: Zabbix, Prometheus, ELK‚Äù .
 
 
 
 Earlier we looke...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How does the Prometheus histogram work?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501978/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A translation of the article was prepared ahead of the start of the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúMonitoring and Logging: Zabbix, Prometheus, ELK‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/bb/b2/rl/bbb2rlroxgbryy_noc1mg9urkos.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Earlier we looked at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a counter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a gauge,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a summary</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Now let's talk about how the histogram works in Prometheus.</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The histogram has some similarities with the summary. </font><font style="vertical-align: inherit;">A histogram is a combination of various counters. </font><font style="vertical-align: inherit;">Like summary metrics, histogram metrics are used to track dimensional indicators of events, often their duration, using the method </font></font><code>observe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Timekeeping tools are usually the same as bulletins. </font><font style="vertical-align: inherit;">What they differ in is the processing of quantiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following is an example of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prometheus tagged </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">exposure format</font></a></font><code>handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="xml hljs"># HELP prometheus_http_request_duration_seconds Histogram of latencies for HTTP requests.<font></font>
# TYPE prometheus_http_request_duration_seconds histogram<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.1"} 25547<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.2"} 26688<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.4"} 27760<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="1"} 28641<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="3"} 28782<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="8"} 28844<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="20"} 28855<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="60"} 28860<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="120"} 28860<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="+Inf"} 28860<font></font>
prometheus_http_request_duration_seconds_sum{handler="/"} 1863.80491025699<font></font>
prometheus_http_request_duration_seconds_count{handler="/"} 28860</code></pre><br>
<code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and they </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work in exactly the same way as for the summary, and can be used to get the average execution time over the past five minutes:</font></font><br>
<br>
<pre><code class="xml hljs"> rate(prometheus_http_request_duration_seconds_sum[5m]<font></font>
/<font></font>
  rate(prometheus_http_request_duration_seconds_count[5m])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, there are very rare cases where it is </font></font><code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">absent, for example, in some metrics from the MySQLd exporter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A notable part of the histogram is the time series </font></font><code>_bucket</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which are actually the histogram part of the metric. More specifically, these are counters that form a cumulative histogram. </font></font><code>le</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">denote less than or equal to. Thus, 26688 requests took less than or equal to 200ms, 27760 requests took less than or equal to 400ms, and there were 28860 requests in total. The values ‚Äã‚Äãin the bucket will be monotonically non-decreasing, and the </font></font><code>+Inf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucket will have the greatest value. </font></font><code>+Inf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucket must always be present and match the value </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To calculate, say, a quantile of 0.9 (the 90th percentile), you should use:</font></font><br>
<br>
<pre><code class="xml hljs">histogram_quantile(0.9, <font></font>
  rate(prometheus_http_request_duration_seconds_bucket[5m])<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One big advantage of histograms over summaries is that you can aggregate buckets before calculating the quantile - taking care not to lose the label </font></font><code>le</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">histogram_quantile(0.9, <font></font>
  sum without (handler)(<font></font>
    rate(prometheus_http_request_duration_seconds_bucket[5m])<font></font>
  )<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to aggregation, histograms are cheaper on the client, as the counters are quickly incremented. </font><font style="vertical-align: inherit;">So why not use histograms always? </font><font style="vertical-align: inherit;">There is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">long answer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but the short version is that with the histograms you must first select your bucket, and the costs are transferred from the client to Prometheus itself due to the number of bucket elements. Ten buckets by default cover a typical web service with a delay ranging from milliseconds to a second, and in some cases you may need to change this. Here, for example, they were redefined to better track PromQL queries, which by default have a two-minute timeout. Having more than a dozen bucket-s will give more accurate results, but can also produce many time series. Especially in combination with other tags.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When using a real-time monitoring system such as Prometheus, the goal should be to provide analytical value sufficient to make engineering decisions based on it. For example, to know that the delay of the 90th percentile has increased by 50 ms is more important than to know if it is now 562 ms or 563 ms, and usually ten bucket-s are enough for this. If you need an exact answer, you can always calculate it later from your logs. If there are too many bucket-s, they can be discarded during data processing, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as was shown earlier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In more extreme cases, you can completely ignore the series of </font></font><code>_bucket</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s and rely on the average of </font></font><code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In conclusion, histograms allow the aggregate calculation of quantiles, although the number of elements must be taken into account. </font><font style="vertical-align: inherit;">Remember that a summary without quantiles is a cheaper option if you do not need a histogram.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More about the course</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501960/index.html">Search scaling. Elasticsearch Its advantages and basic requirements for installation</a></li>
<li><a href="../en501964/index.html">What are industrial computers for?</a></li>
<li><a href="../en501968/index.html">MVI Architectural Template in Kotlin Multiplatform, Part 1</a></li>
<li><a href="../en501970/index.html">What do you need to create a good dungeon in RPG?</a></li>
<li><a href="../en501976/index.html">How to learn to test software</a></li>
<li><a href="../en501980/index.html">The history of one project or how I created 7 years PBX based on Asterisk and Php</a></li>
<li><a href="../en501982/index.html">How to transfer a shader from a game engine to Substance Painter</a></li>
<li><a href="../en501984/index.html">What to see in quarantine? A selection of materials from Technostream (part 4)</a></li>
<li><a href="../en501986/index.html">Secrets of the incredible success of Apple AirPods</a></li>
<li><a href="../en501988/index.html">How does the VK message screen render?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>