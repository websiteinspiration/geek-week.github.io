<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßÄ üôáüèª üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® En bref: Async / Await Best Practices in .NET üçã ‚öôÔ∏è üï∫üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En pr√©vision du d√©but du cours, "C # Developer" a pr√©par√© une traduction de mat√©riel int√©ressant.
 
 
 
 Async / Await - Introduction
 La construction...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>En bref: Async / Await Best Practices in .NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/488082/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En pr√©vision du d√©but du cours, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"C # Developer" a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pr√©par√© une traduction de mat√©riel int√©ressant.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/6f/io/l8/6fiol8vwkg-r8ja-3zurutnz-ci.png"><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Async / Await - Introduction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La construction du langage Async / Await existe depuis C # version 5.0 (2012) et est rapidement devenue l'un des piliers de la programmation .NET moderne - tout d√©veloppeur C # qui se respecte devrait l'utiliser pour am√©liorer les performances des applications, la r√©activit√© globale et la lisibilit√© du code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Async / Await rend l'introduction du code asynchrone d'une simplicit√© trompeuse et √©limine la n√©cessit√© pour le programmeur de comprendre les d√©tails de son traitement, mais combien d'entre nous savent vraiment comment cela fonctionne et quels sont les avantages et les inconv√©nients de cette m√©thode? </font><font style="vertical-align: inherit;">Il y a beaucoup d'informations utiles, mais elles sont fragment√©es, j'ai donc d√©cid√© d'√©crire cet article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, approfondissons le sujet.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machine d'√©tat (IAsyncStateMachine)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re chose √† savoir est que sous le capot, chaque fois que vous avez une m√©thode ou une fonction avec Async / Await, le compilateur transforme r√©ellement votre m√©thode en une classe g√©n√©r√©e qui impl√©mente l'interface IAsyncStateMachine. Cette classe est charg√©e de maintenir l'√©tat de votre m√©thode pendant le cycle de vie d'une op√©ration asynchrone - elle encapsule toutes les variables de votre m√©thode sous forme de champs et divise votre code en sections qui sont ex√©cut√©es pendant les transitions de la machine d'√©tat entre les √©tats, afin que le thread puisse quitter la m√©thode et quand il reviendra, l'√©tat ne changera pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä titre d'exemple, voici une d√©finition de classe tr√®s simple avec deux m√©thodes asynchrones: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
using System.Threading.Tasks;</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System.Diagnostics;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">AsyncAwait</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncAwait</span><font></font>
    {<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncAwaitExample</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">int</span> myVariable = <span class="hljs-number">0</span>;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> DummyAsyncMethod();<font></font>
            Debug.WriteLine(<span class="hljs-string">"Continuation - After First Await"</span>);<font></font>
            myVariable = <span class="hljs-number">1</span>;<font></font>
<font></font>
            <span class="hljs-keyword">await</span> DummyAsyncMethod();<font></font>
            Debug.WriteLine(<span class="hljs-string">"Continuation - After Second Await"</span>);<font></font>
            myVariable = <span class="hljs-number">2</span>;<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">DummyAsyncMethod</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-comment">// </span><font></font>
        }<font></font>
<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une classe avec deux m√©thodes asynchrones</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Si nous regardons le code g√©n√©r√© pendant l'assemblage, nous verrons quelque chose comme ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/xe/63/qoxe63foidhmllsdwfi78tdhrsm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que nous avons 2 nouvelles classes internes g√©n√©r√©es pour nous, une pour chaque m√©thode asynchrone. Ces classes contiennent une machine √† √©tats pour chacune de nos m√©thodes asynchrones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, apr√®s avoir √©tudi√© le code d√©compil√© pour </font></font><code><code>&lt;AsyncAwaitExample&gt;</code></code><code> d__0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous remarquerons que notre variable interne est </font></font><code>¬´myVariable¬ª</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenant un champ de classe: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gd/_m/qj/gd_mqjxvsjfw9-_zfd7740n42ua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nous pouvons √©galement voir d'autres champs de classe utilis√©s en interne pour maintenir l'√©tat </font></font><code>IAsyncStateMachine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La machine d'√©tat passe par des √©tats en utilisant la m√©thode</font></font><code>MoveNext()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en fait, un gros interrupteur. </font><font style="vertical-align: inherit;">Remarquez comment la m√©thode se poursuit dans diff√©rentes sections apr√®s chacun des appels asynchrones (avec l'√©tiquette de continuation pr√©c√©dente). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/li/ea/kmlieahswg0ebqn3db5nctfzsti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela signifie que l'√©l√©gance asynchrone / attente a un prix. </font><font style="vertical-align: inherit;">L'utilisation de async / wait ajoute en fait une certaine complexit√© (que vous ne connaissez peut-√™tre pas). </font><font style="vertical-align: inherit;">Dans la logique c√¥t√© serveur, cela peut ne pas √™tre critique, mais en particulier lors de la programmation d'applications mobiles qui prennent en compte chaque cycle de m√©moire CPU et Ko, vous devez garder cela √† l'esprit, car la quantit√© de surcharge peut rapidement augmenter. </font><font style="vertical-align: inherit;">Plus loin dans cet article, nous discuterons des meilleures pratiques pour utiliser Async / Await uniquement lorsque cela est n√©cessaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une explication assez instructive de la machine d'√©tat, regardez cette </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vid√©o sur YouTube</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand utiliser Async / Await</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe g√©n√©ralement deux sc√©narios o√π Async / Await est la bonne solution.</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travail li√© aux E / S</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : votre code attendra quelque chose, comme des donn√©es d'une base de donn√©es, la lecture d'un fichier, l'appel d'un service Web. </font><font style="vertical-align: inherit;">Dans ce cas, vous devez utiliser Async / Await, pas la biblioth√®que parall√®le de t√¢ches.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travail li√© au CPU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : votre code effectuera des calculs complexes. </font><font style="vertical-align: inherit;">Dans ce cas, vous devez utiliser Async / Await, mais vous devez commencer √† travailler dans un autre thread √† l'aide de Task.Run. </font><font style="vertical-align: inherit;">Vous pouvez √©galement envisager d'utiliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la biblioth√®que parall√®le de t√¢ches</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Async compl√®tement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous commencez √† travailler avec des m√©thodes asynchrones, vous remarquerez rapidement que la nature asynchrone du code commence √† se propager de haut en bas dans votre hi√©rarchie d'appels - cela signifie que vous devez √©galement rendre votre code appelant asynchrone, etc. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pourriez √™tre tent√© d '¬´arr√™ter¬ª cela en bloquant le code √† l'aide de Task.Result ou Task.Wait, en convertissant une petite partie de l'application et en l'enveloppant dans une API synchrone afin que le reste de l'application soit isol√© des modifications. Malheureusement, c'est une recette pour cr√©er des blocages difficiles √† suivre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La meilleure solution √† ce probl√®me est de permettre au code asynchrone de se d√©velopper naturellement dans la base de code. </font><font style="vertical-align: inherit;">Si vous suivez cette d√©cision, vous verrez l'extension du code asynchrone √† son point d'entr√©e, g√©n√©ralement un gestionnaire d'√©v√©nements ou une action de contr√¥leur. </font><font style="vertical-align: inherit;">Abandonnez-vous √† l'asynchronie sans laisser de trace! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus d'informations dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cet article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSDN.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la m√©thode est d√©clar√©e asynchrone, assurez-vous qu'elle est en attente!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous l'avons vu, lorsque le compilateur trouve une m√©thode asynchrone, il transforme cette m√©thode en une machine √† √©tats. </font><font style="vertical-align: inherit;">Si votre code n'a pas attendu dans son corps, le compilateur g√©n√©rera un avertissement, mais la machine d'√©tat sera n√©anmoins cr√©√©e, ajoutant une surcharge inutile pour une op√©ration qui ne se terminera jamais r√©ellement.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âvitez l'async void</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le vide asynchrone est quelque chose qui devrait vraiment √™tre √©vit√©. </font><font style="vertical-align: inherit;">Faites-en une r√®gle pour utiliser la t√¢che asynchrone au lieu de l'async void.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AsyncVoidMethod</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//!</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncTaskMethod</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//!</span>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les m√©thodes async void et async Task</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Il y a plusieurs raisons √† cela, notamment:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les exceptions lev√©es dans la m√©thode async void ne peuvent pas √™tre intercept√©es en dehors de cette m√©thode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></li>
</ul><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lorsqu'une exception est lev√©e √† partir de la </font><font style="vertical-align: inherit;">m√©thode </font><font style="vertical-align: inherit;">async Task ou async Task </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cette exception est intercept√©e et plac√©e dans l'objet Task. </font><font style="vertical-align: inherit;">Lorsque vous utilisez des m√©thodes async void, il n'y a pas d'objet Task, donc toutes les exceptions lev√©es √† partir de la m√©thode async void seront appel√©es directement dans SynchronizationContext, qui √©tait actif lorsque la m√©thode async void a √©t√© ex√©cut√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rez l'exemple ci-dessous. </font><font style="vertical-align: inherit;">Le bloc de capture ne sera jamais atteint.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AsyncVoidMethodThrowsException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Hmmm, something went wrong!"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ThisWillNotCatchTheException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        AsyncVoidMethodThrowsException();<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span>(Exception ex)<font></font>
    {<font></font>
        <span class="hljs-comment">//     </span><font></font>
        Debug.WriteLine(ex.Message);<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les exceptions lev√©es dans la m√©thode async void ne peuvent pas √™tre intercept√©es en dehors de cette m√©thode.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Comparez avec ce code, o√π au lieu de async void nous avons async Task. </font><font style="vertical-align: inherit;">Dans ce cas, la capture sera accessible.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncTaskMethodThrowsException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"Hmmm, something went wrong!"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ThisWillCatchTheException</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-keyword">await</span> AsyncTaskMethodThrowsException();<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
    {<font></font>
        <span class="hljs-comment">//    </span><font></font>
        Debug.WriteLine(ex.Message);<font></font>
    }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'exception est intercept√©e et plac√©e dans l'objet Task.</font></font></i><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les m√©thodes asynchrones vides peuvent provoquer des effets secondaires ind√©sirables si l'appelant ne s'attend pas √† ce qu'elles soient asynchrones</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : si votre m√©thode asynchrone ne renvoie rien, utilisez async Task (sans ¬´ </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬ª pour Task) comme type de retour.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les m√©thodes async void sont tr√®s difficiles √† tester</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : en raison des diff√©rences de gestion des erreurs et de disposition, il est difficile d'√©crire des tests unitaires qui appellent des m√©thodes async void. </font><font style="vertical-align: inherit;">Test Asynchronous MSTest ne fonctionne que pour les </font><font style="vertical-align: inherit;">m√©thodes asynchrones qui renvoient une t√¢che ou la </font><font style="vertical-align: inherit;">t√¢che </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les gestionnaires d'√©v√©nements asynchrones font exception √† cette pratique. </font><font style="vertical-align: inherit;">Mais m√™me dans ce cas, il est recommand√© de minimiser le code √©crit dans le gestionnaire lui-m√™me - attendez-vous √† une m√©thode de t√¢che asynchrone qui contient la logique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus d'informations dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cet article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSDN.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©f√©rer la t√¢che de retour au lieu du retour attendre</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme d√©j√† expliqu√©, chaque fois que vous d√©clarez une m√©thode asynchrone, le compilateur cr√©e une classe de machine √† √©tats qui encapsule r√©ellement la logique de votre m√©thode. Cela ajoute certains frais g√©n√©raux qui peuvent s'accumuler, en particulier pour les appareils mobiles, o√π nous avons des limites de ressources plus strictes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, une m√©thode n'a pas √† √™tre asynchrone, mais elle renvoie la t√¢che </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et permet √† l'autre c√¥t√© de la g√©rer en cons√©quence. Si la derni√®re phrase de votre code est un retour d'attente, vous devez envisager de le refactoriser afin que le type de retour de la m√©thode soit la t√¢che </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(au lieu de async T). </font><font style="vertical-align: inherit;">Pour cette raison, vous √©vitez de g√©n√©rer une machine d'√©tat, ce qui rend votre code plus flexible. </font><font style="vertical-align: inherit;">Le seul cas o√π nous voulons vraiment attendre est lorsque nous faisons quelque chose avec le r√©sultat de la t√¢che asynchrone dans la poursuite de la m√©thode.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">AsyncTask</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//  !</span>
   <span class="hljs-comment">//...  -  </span>
   <span class="hljs-comment">//await -   ,  await  </span><font></font>
<font></font>
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> GetData();<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">JustTask</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//!</span>
   <span class="hljs-comment">//...  -  </span>
   <span class="hljs-comment">// Task</span><font></font>
<font></font>
   <span class="hljs-keyword">return</span> GetData();<font></font>
<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©f√©rer la t√¢che de retour plut√¥t que le retour d'attente</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Notez que si nous n'avons pas d'attente et que nous renvoyons plut√¥t la t√¢che </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le retour se produit imm√©diatement, donc si le code est dans un bloc try / catch, l'exception ne sera pas intercept√©e. </font><font style="vertical-align: inherit;">De m√™me, si le code est √† l'int√©rieur du bloc using, il supprimera imm√©diatement l'objet. </font><font style="vertical-align: inherit;">Voir l'astuce suivante.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'encapsulez pas la t√¢che de retour dans try..catch {} ou en utilisant des blocs {}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La t√¢che de retour peut provoquer un comportement non d√©fini lorsqu'elle est utilis√©e dans un bloc try..catch (une exception lev√©e par la m√©thode asynchrone ne sera jamais intercept√©e) ou dans un bloc using, car la t√¢che sera retourn√©e imm√©diatement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous devez encapsuler votre code asynchrone dans un try..catch ou √† l'aide d'un bloc, utilisez plut√¥t return attend.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">ReturnTaskExceptionNotCaught</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-keyword">try</span><font></font>
   {<font></font>
       <span class="hljs-comment">// ...</span><font></font>
<font></font>
       <span class="hljs-keyword">return</span> GetData();<font></font>
<font></font>
   }<font></font>
   <span class="hljs-keyword">catch</span> (Exception ex)<font></font>
<font></font>
   {<font></font>
       <span class="hljs-comment">//     </span><font></font>
<font></font>
       Debug.WriteLine(ex.Message);<font></font>
       <span class="hljs-keyword">throw</span>;<font></font>
   }<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">ReturnTaskUsingProblem</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> resource = GetResource())<font></font>
   {<font></font>
<font></font>
       <span class="hljs-comment">// ...  ,     , ,    </span><font></font>
<font></font>
       <span class="hljs-keyword">return</span> GetData(resource);<font></font>
   }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'encapsulez pas la t√¢che de retour dans des blocs </font></font><code>try..catch{}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou</font></font><code>using{}</code></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus d'informations dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fil sur le d√©bordement de pile.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âvitez d'utiliser </font></font><code>.Wait()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>.Result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- utilisez plut√¥t</font></font><code>GetAwaiter().GetResult()</code></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devez bloquer l'</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attente de la fin de la t√¢che asynchrone, utilisez </font></font><code>GetAwaiter().GetResult().</code> <code>Wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>Result</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoyez toutes les exceptions </font></font><code>AggregateException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ce qui complique la gestion des erreurs. </font><font style="vertical-align: inherit;">L'avantage </font></font><code>GetAwaiter().GetResult()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est qu'il renvoie √† la place l'exception habituelle </font></font><code>AggregateException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetAwaiterGetResultExample</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">// ,    ,     AggregateException  </span><font></font>
<font></font>
   <span class="hljs-keyword">string</span> data = GetData().Result;<font></font>
<font></font>
   <span class="hljs-comment">// ,   ,      </span><font></font>
<font></font>
   data = GetData().GetAwaiter().GetResult();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous devez bloquer l'attente de la fin de la t√¢che Async, utilisez le </font></font><code>GetAwaiter().GetResult().</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus d'informations sur ce </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la m√©thode est asynchrone, ajoutez le suffixe Async √† son nom</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit de la convention utilis√©e dans .NET pour distinguer plus facilement les m√©thodes synchrones et asynchrones (√† l'exception des gestionnaires d'√©v√©nements ou des m√©thodes de contr√¥leur Web, mais elles ne doivent toujours pas √™tre explicitement appel√©es par votre code).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les m√©thodes de biblioth√®que asynchrones doivent utiliser Task.ConfigureAwait (false) pour am√©liorer les performances</font></font></h3><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le .NET Framework a le concept d'un ¬´contexte de synchronisation¬ª, qui est un moyen de ¬´revenir l√† o√π vous √©tiez auparavant¬ª. Chaque fois qu'une t√¢che est en attente, elle capture le contexte de synchronisation actuel avant d'attendre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois la t√¢che termin√©e </font></font><code>.Post()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la </font><font style="vertical-align: inherit;">m√©thode de </font><font style="vertical-align: inherit;">contexte de synchronisation </font><font style="vertical-align: inherit;">est appel√©e </font><font style="vertical-align: inherit;">, ce qui reprend le travail √† partir de son emplacement pr√©c√©dent. Ceci est utile pour revenir au thread d'interface utilisateur ou pour revenir au m√™me contexte ASP.NET, etc.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous √©crivez du code de biblioth√®que, vous avez rarement besoin de revenir au contexte dans lequel vous vous trouviez auparavant. Lorsque Task.ConfigureAwait (false) est utilis√©, le code n'essaie plus de reprendre d'o√π il √©tait auparavant, mais, si possible, le code se termine dans le thread qui a termin√© la t√¢che, ce qui √©vite le changement de contexte. Cela am√©liore l√©g√®rement les performances et peut aider √† √©viter les blocages.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ConfigureAwaitExample</span>(<span class="hljs-params"></span>)</span><font></font>
<font></font>
{<font></font>
   <span class="hljs-comment">//   ConfigureAwait(false)   .</span><font></font>
<font></font>
   <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">await</span> GetData().ConfigureAwait(<span class="hljs-literal">false</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, utilisez ConfigureAwait (false) pour les processus serveur et le code de biblioth√®que. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceci est particuli√®rement important lorsque la m√©thode de biblioth√®que est appel√©e un grand nombre de fois, pour une meilleure r√©activit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, utilisez ConfigureAwait (false) pour les processus serveur en g√©n√©ral. Peu nous importe quel thread est utilis√© pour continuer, contrairement aux applications dans lesquelles nous devons revenir au thread de l'interface utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant ... Dans ASP.NET Core, Microsoft a supprim√© SynchronizationContext, donc th√©oriquement vous n'en avez pas besoin. Mais si vous √©crivez du code de biblioth√®que qui pourrait potentiellement √™tre r√©utilis√© dans d'autres applications (par exemple, UI App, Legacy ASP.NET, Xamarin Forms), cela </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reste la meilleure pratique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une bonne explication de ce concept, regardez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cette vid√©o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rapport d'avancement des t√¢ches asynchrones</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un cas d'utilisation assez courant pour les m√©thodes asynchrones est de travailler en arri√®re-plan, de lib√©rer le thread d'interface utilisateur pour d'autres t√¢ches et de maintenir la r√©activit√©. Dans ce sc√©nario, vous souhaiterez peut-√™tre signaler la progression √† l'interface utilisateur afin que l'utilisateur puisse surveiller la progression du processus et interagir avec l'op√©ration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©soudre ce probl√®me courant, .NET fournit l'interface IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui fournit la m√©thode Report </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui est invoqu√©e par une t√¢che asynchrone pour signaler la progression √† l'appelant. Cette interface est accept√©e comme param√®tre de la m√©thode asynchrone - l'appelant doit fournir un objet qui impl√©mente cette interface.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.NET fournit Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, l'impl√©mentation par d√©faut d'IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui est en fait recommand√©e, car il g√®re toute la logique de bas niveau associ√©e √† l'enregistrement et √† la restauration du contexte de synchronisation. Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournit √©galement un √©v√©nement Action </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font><font style="vertical-align: inherit;">et un rappel </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- tous deux appel√©s lorsqu'une t√¢che signale la progression. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensemble, IProgress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et Progress </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offrent un moyen simple de transf√©rer les informations de progression d'une t√¢che d'arri√®re-plan vers un thread d'interface utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter que </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il peut s'agir d'une valeur simple, telle qu'un entier, ou d'un objet qui fournit des informations contextuelles sur la progression, telles que le pourcentage d'ach√®vement, une description de cha√Æne de l'op√©ration en cours, ETA, etc. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rez la fr√©quence √† laquelle vous signalez les progr√®s. </font><font style="vertical-align: inherit;">Selon l'op√©ration que vous effectuez, vous pouvez constater que vos rapports de code progressent plusieurs fois par seconde, ce qui peut rendre l'interface utilisateur moins r√©active. </font><font style="vertical-align: inherit;">Dans un tel sc√©nario, il est recommand√© de signaler les progr√®s √† des intervalles plus longs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus d'informations dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cet article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le blog officiel Microsoft .NET.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Annuler les t√¢ches asynchrones</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre cas d'utilisation courant pour les t√¢ches en arri√®re-plan est la possibilit√© d'annuler l'ex√©cution. </font><font style="vertical-align: inherit;">.NET fournit la classe CancellationToken. </font><font style="vertical-align: inherit;">La m√©thode asynchrone re√ßoit l'objet CancellationToken, qui est ensuite partag√© par le code de l'appelant et la m√©thode asynchrone, fournissant ainsi un m√©canisme pour signaler l'annulation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas le plus courant, l'annulation se produit comme suit:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'appelant cr√©e un objet CancellationTokenSource.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'appelant appelle l'API asynchrone annul√©e et transmet le CancellationToken √† partir du CancellationTokenSource (CancellationTokenSource.Token).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'appelant demande une annulation √† l'aide de l'objet CancellationTokenSource (CancellationTokenSource.Cancel ()).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La t√¢che confirme l'annulation et s'annule elle-m√™me, g√©n√©ralement √† l'aide de la m√©thode CancellationToken.ThrowIfCancellationRequested.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que pour que ce m√©canisme fonctionne, vous devrez √©crire du code pour v√©rifier les annulations demand√©es √† intervalles r√©guliers (c'est-√†-dire √† chaque it√©ration de votre code ou √† un point d'arr√™t naturel dans la logique). </font><font style="vertical-align: inherit;">Id√©alement, apr√®s une demande d'annulation, la t√¢che asynchrone doit √™tre annul√©e le plus rapidement possible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez envisager d'utiliser l'annulation pour toutes les m√©thodes qui peuvent prendre beaucoup de temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus d'informations dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cet article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le blog officiel Microsoft .NET.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rapport d'√©tape et d'annulation - Exemple</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> System.Windows.Forms;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">namespace</span> <span class="hljs-title">TestAsyncAwait</span><font></font>
{<font></font>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AsyncProgressCancelExampleForm</span> : <span class="hljs-title">Form</span><font></font>
   {<font></font>
       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AsyncProgressCancelExampleForm</span>(<span class="hljs-params"></span>)</span><font></font>
       {<font></font>
           InitializeComponent();<font></font>
       }<font></font>
<font></font>
       CancellationTokenSource _cts = <span class="hljs-keyword">new</span> CancellationTokenSource();<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">btnRunAsync_Click</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span><font></font>
<font></font>
       {<font></font>
<font></font>
           <span class="hljs-comment">//   .</span><font></font>
<font></font>
            &lt;<span class="hljs-keyword">int</span>&gt;   ,          ,   ,    , ETA  . .<font></font>
<font></font>
           <span class="hljs-keyword">var</span> progressIndicator = <span class="hljs-keyword">new</span> Progress&lt;<span class="hljs-keyword">int</span>&gt;(ReportProgress);<font></font>
<font></font>
           <span class="hljs-keyword">try</span><font></font>
<font></font>
           {<font></font>
               <span class="hljs-comment">//   ,         </span><font></font>
<font></font>
               <span class="hljs-keyword">await</span> AsyncMethod(progressIndicator, _cts.Token);<font></font>
<font></font>
           }<font></font>
<font></font>
           <span class="hljs-keyword">catch</span> (OperationCanceledException ex)<font></font>
<font></font>
           {<font></font>
               <span class="hljs-comment">// </span><font></font>
<font></font>
               lblProgress.Text = <span class="hljs-string">"Cancelled"</span>;<font></font>
           }<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">btnCancel_Click</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span><font></font>
<font></font>
       {<font></font>
          <span class="hljs-comment">// </span><font></font>
           _cts.Cancel();<font></font>
<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReportProgress</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-keyword">value</span></span>)</span><font></font>
<font></font>
       {<font></font>
           <span class="hljs-comment">//    </span><font></font>
<font></font>
           lblProgress.Text = <span class="hljs-keyword">value</span>.ToString();<font></font>
<font></font>
       }<font></font>
<font></font>
       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AsyncMethod</span>(<span class="hljs-params">IProgress&lt;<span class="hljs-keyword">int</span>&gt; progress, CancellationToken ct</span>)</span><font></font>
<font></font>
       {<font></font>
<font></font>
           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<font></font>
<font></font>
           {<font></font>
              <span class="hljs-comment">//   ,     </span><font></font>
<font></font>
               <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);<font></font>
<font></font>
               <span class="hljs-comment">//   </span><font></font>
<font></font>
               <span class="hljs-keyword">if</span> (ct != <span class="hljs-literal">null</span>)<font></font>
<font></font>
               {<font></font>
<font></font>
                   ct.ThrowIfCancellationRequested();<font></font>
<font></font>
               }<font></font>
<font></font>
               <span class="hljs-comment">//   </span><font></font>
<font></font>
               <span class="hljs-keyword">if</span> (progress != <span class="hljs-literal">null</span>)<font></font>
<font></font>
               {<font></font>
<font></font>
                   progress.Report(i);<font></font>
               }<font></font>
           }<font></font>
       }<font></font>
   }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attendre un certain temps</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous devez attendre un certain temps (par exemple, essayez √† nouveau de v√©rifier la disponibilit√© de la ressource), assurez-vous d'utiliser Task.Delay - n'utilisez jamais Thread.Sleep dans ce sc√©nario.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attente de la fin de plusieurs t√¢ches asynchrones</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisez Task.WaitAny pour attendre la fin d'une t√¢che. </font><font style="vertical-align: inherit;">Utilisez Task.WaitAll pour attendre la fin de toutes les t√¢ches. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dois-je me pr√©cipiter pour passer en C # 7 ou 8? </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inscrivez-vous √† un webinaire gratuit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour discuter de ce sujet.</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488058/index.html">Repr√©sentation graphique des mannequins: un guide √©tape par √©tape</a></li>
<li><a href="../fr488060/index.html">Backblaze - Statistiques du disque dur 2019</a></li>
<li><a href="../fr488062/index.html">Meetup Dynamics 365 & Power Platform chez Lamoda - Rapport</a></li>
<li><a href="../fr488072/index.html">'Est-ce que l'injection de d√©pendance Koin ou le localisateur de service?</a></li>
<li><a href="../fr488078/index.html">Mon bot pour la Russian AI Cup 2019</a></li>
<li><a href="../fr488088/index.html">Comment Habr interagit avec les organes de l'√âtat et les autres candidats. Rapport de transparence pour toutes les ann√©es</a></li>
<li><a href="../fr488092/index.html">Hackathons. Comment tirer le meilleur parti et survivre</a></li>
<li><a href="../fr488096/index.html">400g. Vue depuis le c√¥t√© de la transmission. ZR / ZR +</a></li>
<li><a href="../fr488098/index.html">Comment cr√©er un projet Django √† partir d'un mod√®le</a></li>
<li><a href="../fr488102/index.html">La relation entre C # et C #: REST, gRPC et tout le reste</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>