<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✉️ 🥐 🤠 How to configure Elasticsearch so that there are no leaks 📟 🏇🏽 🍯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the past year, there have been many leaks from Elasticsearch databases ( here , here and there ). In many cases, personal data was stored in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to configure Elasticsearch so that there are no leaks</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/487210/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Over the past year, there have been many leaks from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elasticsearch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> databases </font><font style="vertical-align: inherit;">( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">In many cases, personal data was stored in the database. </font><font style="vertical-align: inherit;">These leaks could be avoided if, after deploying the database, administrators took the trouble to check out a few simple settings. </font><font style="vertical-align: inherit;">Today we’ll talk about them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We’ll immediately make a reservation that in our practice we use Elasticsearch to store logs and analyze logs of information protection tools, OS and software in our IaaS platform that meets the requirements of 152-, Cloud-152.&nbsp;</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/_g/_r/ej_g_r23bt2k_22t7is7rg7l6ys.jpeg"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check if the database is “sticking”</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In most of the known cases of leaks ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), the attacker gained access to the data simply and unpretentiously: the database was published on the Internet, and it was possible to connect to it without authentication.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we’ll deal with publishing on the Internet. </font><font style="vertical-align: inherit;">Why is this so? </font><font style="vertical-align: inherit;">The fact is that for more flexible operation of Elasticsearch, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is recommended to</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> create a cluster of three servers. </font><font style="vertical-align: inherit;">In order for the databases to communicate with each other, you need to open the ports. </font><font style="vertical-align: inherit;">As a result, administrators do not restrict access to the database, and you can connect to the database from anywhere. </font><font style="vertical-align: inherit;">Checking if there is external access to the database is easy. </font><font style="vertical-align: inherit;">Just enter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: // [IP / Elasticsearch Name]: 9200 / _cat / nodes?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the browser </font><b><font style="vertical-align: inherit;">? V</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If you manage to log in, then run to close.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We protect the connection to the database</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we will make it impossible to connect to the database without authentication. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elasticsearch has an authentication module that restricts access to the database, but it is only in the paid set of X-Pack plugins (1 month of free use). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The good news is that in the fall of 2019, Amazon opened its groundwork that intersects with the X-Pack. </font><font style="vertical-align: inherit;">The authentication function when connecting to the database has become available under a free license for version Elasticsearch 7.3.2., And a new release for Elasticsearch 7.4.0 is already in operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installing this plugin is easy. </font><font style="vertical-align: inherit;">We go into the server console and connect the repository: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RPM Based:</font></font><br>
<br>
<b><pre><code class="plaintext hljs">curl https://d3g5vo6xdbdb9a.cloudfront.net/yum/opendistroforelasticsearch-artifacts.repo -o /etc/yum.repos.d/opendistroforelasticsearch-artifacts.repo<font></font>
<font></font>
yum update<font></font>
<font></font>
yum install opendistro-security</code></pre></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DEB Based:</font></font><br>
<br>
<b><pre><code class="plaintext hljs">wget -qO ‐ https://d3g5vo6xdbdb9a.cloudfront.net/GPG-KEY-opendistroforelasticsearch | sudo apt-key add -</code></pre></b><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We configure interaction between servers through SSL</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When installing the plugin, the configuration of the database connection port changes. </font><font style="vertical-align: inherit;">It includes SSL encryption. </font><font style="vertical-align: inherit;">In order for the cluster servers to continue working with each other, you need to configure the interaction between them using SSL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trust between hosts can be established with or without your own certification authority. </font><font style="vertical-align: inherit;">With the first method, everything is clear: you just need to contact a specialist in CA. </font><font style="vertical-align: inherit;">We proceed immediately to the second.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a variable with the fully qualified domain name:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">export DOMAIN_CN="example.com"</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a private key:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">openssl genrsa -out root-ca-key.pem 4096</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We sign the root certificate. </font><font style="vertical-align: inherit;">Keep it as the apple of your eye: if it is lost or compromised, the trust between all hosts will need to be reconfigured.</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">openssl req -new -x509 -sha256 \-subj "/C=RU/ST=Moscow/O=Moscow, Inc./CN=${DOMAIN_CN}" \<font></font>
-key root-ca-key.pem -out root-ca.pem</code></pre></b> </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Create an admin key:</font></font><br>
<br>
<b><pre><code class="plaintext hljs">openssl genrsa -out admin-key-temp.pem 4096<font></font>
openssl pkcs8 -inform PEM -outform PEM -in admin-key-temp.pem -topk8 -nocrypt \<font></font>
-v1 PBE-SHA1-3DES -out admin-key.pem</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Create a request for signing a certificate:</font></font><br>
<br>
<b><pre><code class="plaintext hljs">openssl req -new -subj "/C=RU/ST=Moscow/O=Moscow Inc./CN=${DOMAIN_CN}/CN=admin " \<font></font>
-key admin-key.pem -out admin.csr</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create an administrator certificate:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">openssl x509 -req -extensions usr_cert -in admin.csr -CA root-ca.pem \<font></font>
-CAkey root-ca-key.pem -CAcreateserial -sha256 -out admin.pem</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create certificates for the Elasticsearch node:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">export NODENAME="node-01"<font></font>
openssl genrsa -out ${NODENAME}-key-temp.pem 4096<font></font>
openssl pkcs8 -inform PEM -outform PEM -in ${NODENAME}-key-temp.pem -topk8 -nocrypt \<font></font>
-v1 PBE-SHA1-3DES -out ${NODENAME}-key.pem</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Create a request for signature:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">openssl req -new -subj "/C=RU/ST=Moscow/O=Moscow Inc./CN=${NODENAME}.${DOMAIN_CN}" \ <font></font>
-addext"subjectAltName=DNS:${NODENAME}.${DOMAIN_CN},DNS:www.${NODENAME}.${DOMAIN_CN}" \<font></font>
-key ${NODENAME}-key.pem -out ${NODENAME}.csr</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We sign the certificate:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">openssl x509 -req -in node.csr -CA root-ca.pem -CAkey root-ca-key.pem -CAcreateserial \<font></font>
-sha256 -out node.pem</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We decompose the certificate between Elasticsearch nodes into the folder:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">/etc/elasticsearch/</code></pre></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
we need the files:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">        node-01-key.pem<font></font>
	node-01.pem<font></font>
	admin-key.pem<font></font>
	admin.pem<font></font>
	root-ca.pem</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set up </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/elasticsearch/elasticsearch.yml</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - change the name of the certificate files to the ones generated by us:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">opendistro_security.ssl.transport.pemcert_filepath: node-01.pem                                                                                                                                                                                    <font></font>
	opendistro_security.ssl.transport.pemkey_filepath: node-01-key.pem                                                                                                                                                                                 <font></font>
	opendistro_security.ssl.transport.pemtrustedcas_filepath: root-ca.pem                                                                                                                                                                              <font></font>
	opendistro_security.ssl.transport.enforce_hostname_verification: false                                                                                                                                                                             <font></font>
	opendistro_security.ssl.http.enabled: true                                                                                                                                                                                                         <font></font>
	opendistro_security.ssl.http.pemcert_filepath: node-01.pem                                                                                                                                                                                         <font></font>
	opendistro_security.ssl.http.pemkey_filepath: node-01-key.pem                                                                                                                                                                                      <font></font>
	opendistro_security.ssl.http.pemtrustedcas_filepath: root-ca.pem                                                                                                                                                                                   <font></font>
	opendistro_security.allow_unsafe_democertificates: false                                                                                                                                                                                           <font></font>
	opendistro_security.allow_default_init_securityindex: true                                                                                                                                                                                         <font></font>
	opendistro_security.authcz.admin_dn:                                                                                                                                                                                                               <font></font>
	&nbsp;&nbsp;− CN=admin,CN=example.com,O=Moscow Inc.,ST=Moscow,C=RU                                                                                                                                                                                                  <font></font>
	opendistro_security.nodes_dn:                                                                                                                                                                                                                      <font></font>
	&nbsp;&nbsp;− CN=node-01.example.com,O=Moscow Inc.,ST=Moscow,C=RU</code></pre></b></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We change passwords of internal users</font></font></h3><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the command below, we display the password hash in the console:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">sh ${OD_SEC}/tools/hash.sh -p []</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change the hash in the file to the one received: </font></font><br>
<br>
<b><pre><code class="plaintext hljs">/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml</code></pre></b></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure the firewall in OS</font></font></h3><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Allow the launch of the firewall:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">systemctl enable firewalld</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run it:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">systemctl start firewalld</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We allow connection to Elasticsearch:</font></font><br>
 <br>
 <b><pre><code class="plaintext hljs">firewall-cmd --set-default-zone work<font></font>
firewall-cmd --zone=work --add-port=9200/TCP --permanent</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rebooting firewall rules:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">firewall-cmd --reload</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We derive the working rules:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">firewall-cmd --list-all</code></pre></b></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apply all our changes to Elasticsearch</font></font></h3><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a variable with the full path to the folder with the plugin:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">export  OD_SEC="/usr/share/elasticsearch/plugins/opendistro_security/"</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run a script that will update passwords and check settings:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">${OD_SEC}/tools/securityadmin.sh -cd ${OD_SEC}/securityconfig/ \<font></font>
-icl -nhnv -cacert /etc/elasticsearch/root-ca.pem \<font></font>
-cert /etc/elasticsearch/admin.pem \ <font></font>
-key /etc/elasticsearch/admin-key.pem</code></pre></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check if the changes applied:</font></font><br>
 <br>
<b><pre><code class="plaintext hljs">curl -XGET https://[IP/ Elasticsearch]:9200/_cat/nodes?v -u admin:[] --insecure</code></pre></b></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all, these are the minimum settings that block Elasticsearch from an unauthorized connection.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en487210/">https://habr.com/ru/post/en487210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487196/index.html">OS Sivelkiriya: mission and launch form</a></li>
<li><a href="../en487198/index.html">Attention! Homo Consciousness. I</a></li>
<li><a href="../en487200/index.html">6 reasons to hate a radar detector</a></li>
<li><a href="../en487206/index.html">How developers make games honest</a></li>
<li><a href="../en487208/index.html">Analytics for Telegram bots written in Python</a></li>
<li><a href="../en487214/index.html">Dark Launch at Istio: Secret Services</a></li>
<li><a href="../en487216/index.html">Kim Dotcom: Caught, the most wanted person online. Part 2</a></li>
<li><a href="../en487218/index.html">Botzees - a robot designer for the smallest with augmented reality and kind eyes</a></li>
<li><a href="../en487220/index.html">Review of Remez E27 and E14 LED bulbs on new generation Korean LEDs</a></li>
<li><a href="../en487224/index.html">How long can a long-term construction, which is destined to become a masterpiece</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>