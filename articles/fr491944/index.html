<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘‰ğŸ» ğŸ² ğŸ‘¶ğŸ¿ Comment combiner deux plates-formes en une seule et ne pas offenser les utilisateurs. ExpÃ©rience des dÃ©veloppeurs Yandex.Kew âœŠğŸ¿ ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘©ğŸ½ â›</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'annÃ©e derniÃ¨re, le service TheQuestion a rejoint Yandex. Ã€ cette Ã©poque, il y avait dÃ©jÃ  un service similaire de questions et rÃ©ponses - Yandex.Znat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment combiner deux plates-formes en une seule et ne pas offenser les utilisateurs. ExpÃ©rience des dÃ©veloppeurs Yandex.Kew</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/491944/"><img src="https://habrastorage.org/webt/je/qm/jf/jeqmjfqycb2lqolmutp76tgjrem.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'annÃ©e derniÃ¨re, le service TheQuestion a rejoint Yandex. Ã€ cette Ã©poque, il y avait dÃ©jÃ  un service similaire de questions et rÃ©ponses - Yandex.Znatoki. Les connaisseurs avaient un large public et beaucoup de questions intÃ©ressantes, mais il n'y avait pas assez d'experts pour donner des rÃ©ponses de haute qualitÃ© Ã  ces questions. La Question, au contraire, avait une forte communautÃ© d'experts, mais elle manquait de questions intÃ©ressantes. L'Ã©tape logique a Ã©tÃ© de combiner les deux services afin de tirer le meilleur parti de chacun d'eux. Mais comment faire si chaque service a sa propre base technologique, son propre contenu et ses propres utilisateurs?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, je vais vous expliquer comment notre Ã©quipe a rÃ©solu ce problÃ¨me d'un point de vue technologique. Vous dÃ©couvrirez quelles options de combinaison nous avons envisagÃ©es et lesquelles ont finalement choisi. Je vais vous parler de l 'Â«API d'Ã©changeÂ», de la migration de la base de donnÃ©es, de la mise en commun des profils et des tests backend. Et pourtant - Ã  propos de la nuit du dÃ©mÃ©nagement sans le droit de faire une erreur. Vous verrez que nous ne devions pas nous ennuyer.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tÃ¢che de fusionner deux services en un seul n'est pas nouvelle, mais cela ne facilite pas la tÃ¢che. L'histoire connaÃ®t de nombreux exemples rÃ©ussis (et pas si) d'intÃ©gration, mais, malheureusement, il n'y a pas de Â«solution miracleÂ» et une instruction claire Â«faites cela et tout ira bienÂ». Tout dÃ©pend beaucoup des spÃ©cificitÃ©s des services combinÃ©s et du rÃ©sultat souhaitÃ©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre cas, l'objectif Ã©tait le suivant: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que tout le contenu jamais Ã©crit sur chacun des sites soit disponible sur un service unifiÃ©, et que ses auteurs puissent le gÃ©rer.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Alors, comment combinez-vous les deux services de questions et rÃ©ponses, qui semblent si similaires, mais si diffÃ©rents par essence? Le transfert de contenu et d'utilisateurs d'un service Ã  un autre est trÃ¨s similaire au transfert d'un ancien appartement Ã  un nouveau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seulement dans notre cas, l'utilisateur peut vivre simultanÃ©ment dans deux appartements (Connoisseurs et TheQuestion), et vous devez le transporter soigneusement dans le troisiÃ¨me. Vous devez dÃ©placer tous les meubles, les plantes, un chat et mÃªme du papier peint dans un nouvel appartement (c'est-Ã -dire des questions, des rÃ©ponses, des commentaires, des likes), puis l'inviter Ã  dÃ©mÃ©nager. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment faire Ã§a? Plusieurs options viennent immÃ©diatement Ã  l'esprit. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 1. TrÃ¨s mauvais.</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Prenons simplement l'un des services, transfÃ©rons tout le contenu Ã  un autre (mÃªme si ce n'est plus facile) et fermons le service d'origine.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette option est trÃ¨s mauvaise du point de vue de l'utilisateur du premier service. Nous venons de dÃ©molir son ancienne maison et l'avons forcÃ© Ã  dÃ©mÃ©nager dans une nouvelle. N'importe qui n'aimera pas cette attitude, et au lieu de bouger, il peut simplement aller au coucher du soleil. Pour nous, la principale valeur est la communautÃ© des utilisateurs, nous n'avons donc pas prÃ©vu d'offenser qui que ce soit. Et hardiment passÃ© Ã  d'autres options. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 2. Mauvais</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ne changeons aucun des services, au lieu de cela, lancez-en un nouveau et intÃ©grÃ© et ajoutez-y pÃ©riodiquement le contenu des deux autres (par exemple, une fois par jour).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous ne semblons pas aggraver l'utilisateur, mais nous ne faisons pas mieux non plus. Son ancien appartement reste inchangÃ©, mais il ne sert Ã  rien de dÃ©mÃ©nager dans un nouvel appartement. Tous les voisins vivent Ã©galement dans une vieille maison, une fleur qui vient d'Ãªtre achetÃ©e ne sera transportÃ©e dans un nouvel appartement qu'aprÃ¨s une journÃ©e. Un tel service unifiÃ© n'a aucune chance de devenir un nouveau foyer. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option 3. Bon, mais complexe</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ne fermons aucun des services, nous dupliquerons instantanÃ©ment le contenu et les profils sur le service intÃ©grÃ©, et les gens Ã©volueront avec le temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les voisins de l'utilisateur (et mÃªme le chat) vivent simultanÃ©ment dans l'ancienne et dans la nouvelle maison. Une fleur que vous venez d'acheter apparaÃ®t instantanÃ©ment dans un nouvel appartement. Exactement ce qui est nÃ©cessaire! Cette option est la plus confortable du point de vue de l'utilisateur. Par consÃ©quent, nous l'avons choisi.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commencez Ã  bouger</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce que nous avons finalement fait peut Ãªtre dÃ©crit en plusieurs phrases. </font><font style="vertical-align: inherit;">Nous avons complÃ¨tement rÃ©pÃ©tÃ© l'intÃ©gralitÃ© du backend de l'API TheQuestion sur la base du backend Connoisseurs, obtenant ainsi un seul backend qui peut fonctionner avec deux (et mÃªme trois) sites Ã  la fois. </font><font style="vertical-align: inherit;">Dans le mÃªme temps, le frontend TheQuestion est restÃ© pratiquement inchangÃ©, ce qui signifie que du point de vue des utilisateurs, le site lui-mÃªme n'a pratiquement pas changÃ©. </font><font style="vertical-align: inherit;">Ce projet a reÃ§u le nom interne "swap API". </font><font style="vertical-align: inherit;">Mais tout d'abord.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce que nous avions Ã  l'entrÃ©e: deux sites complÃ¨tement indÃ©pendants. </font><font style="vertical-align: inherit;">Les connaisseurs vivent dans les nuages â€‹â€‹intÃ©rieurs de Yandex. </font><font style="vertical-align: inherit;">Le backend Connoisseurs est Ã©crit en Python. </font><font style="vertical-align: inherit;">TheQuestion vit dans les nuages â€‹â€‹de Microsoft Azure, le backend TheQuestion est Ã©crit en Go. </font><font style="vertical-align: inherit;">Les services ont un schÃ©ma de stockage des donnÃ©es complÃ¨tement diffÃ©rent dans les bases de donnÃ©es. </font><font style="vertical-align: inherit;">De plus, TheQuestion a deux applications mobiles (pour Android et iOS), qui devaient Ã©galement Ãªtre prises en charge. </font><font style="vertical-align: inherit;">En gÃ©nÃ©ral, l'ennemi ne veut pas unir un tel zoo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wh/i0/8z/whi08z8r9v_7vhg13ana4ku_nvu.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ã‰tape 0. Entrez dans le cloud Yandex</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ã€ strictement parler, cette Ã©tape n'est pas nÃ©cessaire pour l 'Â«API de pluginÂ», mais elle simplifie considÃ©rablement les Ã©tapes suivantes. </font><font style="vertical-align: inherit;">Ã€ ce stade, nous avons complÃ¨tement abandonnÃ© le stockage et les installations externes. </font><font style="vertical-align: inherit;">TheQuestion a commencÃ© Ã  utiliser les serveurs DNS Yandex. </font><font style="vertical-align: inherit;">Les services rentme ont Ã©tÃ© dÃ©placÃ©s vers Yandex.Cloud. </font><font style="vertical-align: inherit;">La base de donnÃ©es a Ã©tÃ© transfÃ©rÃ©e aux bases de donnÃ©es gÃ©rÃ©es Yandex. </font><font style="vertical-align: inherit;">Pendant le dÃ©mÃ©nagement, nous avons Ã©galement pu trouver et corriger plusieurs erreurs dans TheQuestion, par exemple, des connexions non fermÃ©es Ã  Redis dans le code 2015. </font><font style="vertical-align: inherit;">En bonus, nous avons Ã©galement reÃ§u une puissance supplÃ©mentaire pour TheQuestion.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ã‰tape 1. Migration des donnÃ©es</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelle que soit l'option que vous souhaitez combiner, nous devons dans tous les cas combiner les donnÃ©es. Pour une seule base de donnÃ©es, ils ont dÃ©cidÃ© de prendre PostgreSQL - ce SGBD a dÃ©jÃ  Ã©tÃ© utilisÃ© Ã  la fois par Experts et TheQuestion. Afin de ne pas compliquer le projet, ils n'ont pas commencÃ© Ã  crÃ©er une troisiÃ¨me base pour le service intÃ©grÃ©, mais ont simplement pris la base de donnÃ©es Znatokov et l'ont dÃ©veloppÃ©e afin qu'elle puisse accepter toutes les donnÃ©es de TheQuestion. Ce fut le premier dÃ©fi technologique majeur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque entrÃ©e de chaque table de la base de donnÃ©es TheQuestion devait Ãªtre convertie et placÃ©e dans la base de donnÃ©es Expert. Ensuite - corrÃ©ler chaque colonne de l'une et de l'autre base. De nombreux champs ont dÃ» Ãªtre convertis de maniÃ¨re non triviale d'un format Ã  un autre. Ainsi, une grande sous-tÃ¢che distincte Ã©tait la conversion du format de stockage de texte (le format rÃ©el du stockage de questions ou de rÃ©ponses) de QML (TheQuestion) en Markdown (Experts).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons mis en place un processus rÃ©gulier (plusieurs fois par jour) de transfert de nouvelles donnÃ©es d'une base de donnÃ©es Ã  une autre, mais en mÃªme temps nous nous sommes assurÃ©s que les donnÃ©es de TheQuestion n'Ã©taient affichÃ©es nulle part avant la fin de l'Ã©tape suivante. </font><font style="vertical-align: inherit;">Parce que "plusieurs fois par jour" est loin d'Ãªtre promis "instantanÃ©ment", et les donnÃ©es pourraient Ãªtre dans un Ã©tat incohÃ©rent avec les mÃªmes donnÃ©es sur TheQuestion, ce qui induirait les utilisateurs en erreur. </font><font style="vertical-align: inherit;">Alors, pourquoi avons-nous commencÃ© avec la migration des donnÃ©es si le backend n'Ã©tait pas encore prÃªt? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PremiÃ¨rement, nous avons ainsi stabilisÃ© le processus. </font><font style="vertical-align: inherit;">DeuxiÃ¨mement, ils ont rÃ©duit la quantitÃ© de nouvelles donnÃ©es qui devront Ãªtre transfÃ©rÃ©es Ã  l'avenir, ce qui est important, car tout le contenu importÃ© devait passer par le balisage pour la qualitÃ©, le contenu inappropriÃ©, le spam, la fraude.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gc/jp/ld/gcjpldkw8v-mv2fg_umevbosowo.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ã‰tape 2. "Swapping API"</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc rÃ©solu le premier des problÃ¨mes - nous avons appris Ã  prendre le contenu de la base de donnÃ©es TheQuestion et mÃªme Ã  l'afficher si vous le souhaitez. Maintenant, il Ã©tait nÃ©cessaire de faire entrer ce contenu dans la base de donnÃ©es intÃ©grÃ©e instantanÃ©ment, et pas plusieurs fois par jour. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, il a fallu rÃ©Ã©crire l'ensemble du backend TheQuestion avec toute la logique nÃ©cessaire. Le nom du projet, "Swap API", Ã  proprement parler, ne reflÃ¨te pas entiÃ¨rement l'essence. Il serait plus correct de l'appeler "Swap backend". Le fait est que, outre la mise en Å“uvre directe de tous les Â«stylosÂ» nÃ©cessaires au fonctionnement du front-end TheQuestion, d'autres possibilitÃ©s ont dÃ» Ãªtre rÃ©alisÃ©es. Nous avons Ã©tÃ© confrontÃ©s Ã  plusieurs tÃ¢ches majeures. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autorisation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex dispose d'un systÃ¨me d'autorisation utilisateur centralisÃ© - Yandex.Passport. Et les connaisseurs, bien sÃ»r, ont utilisÃ© le passeport. Pour vous y connecter, vous devez avoir un compte dans Yandex. C'Ã©tait Ã§a le problÃ¨me. Tous les utilisateurs de TheQuestion ne se sont pas connectÃ©s au site via Yandex (bien qu'il y ait eu une telle opportunitÃ©). De nombreux utilisateurs n'avaient pas du tout de connexion Yandex et sont passÃ©s par les rÃ©seaux sociaux (VKontakte, Facebook ...). Naturellement, nous devions conserver cette fonctionnalitÃ© lors du dÃ©placement. Par consÃ©quent, nous avons mis en place une autorisation Â«sans passeportÂ». </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherche du site.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TheQuestion a implÃ©mentÃ© une recherche sur les questions, les rÃ©ponses, les utilisateurs et les sujets. Pour la recherche, une solution tierce Sphinx a Ã©tÃ© utilisÃ©e. Ã‰videmment, si nous parlons d'un seul service, la recherche doit Ãªtre la mÃªme, c'est-Ã -dire qu'elle ne peut pas fonctionner sur deux systÃ¨mes Ã  la fois. Ainsi, Sphinx a Ã©tÃ© abandonnÃ© au profit d'un moteur de recherche interne prenant en charge les fonctionnalitÃ©s nÃ©cessaires et l'indexation de tout le contenu de TheQuestion. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de pages en Zen et Turbo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Au moment de l'adhÃ©sion, TheQuestion utilisait dÃ©jÃ  les technologies Yandex. Les pages Turbo Ã©taient prises en charge, un contenu intÃ©ressant tombait dans le flux Zen. Tout cela devait Ã©galement Ãªtre pris en charge dans "l'API de remplacement". </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifications dans le service et les applications, listes de diffusion.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout ce qui concerne la notification des utilisateurs: abonnements, newsletters avec un contenu intÃ©ressant, push sur les likes et les commentaires, bien plus. Tout cela devait Ãªtre soigneusement transfÃ©rÃ© et non oubliÃ©. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SystÃ¨me d'administration du site</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ce paragraphe fait rÃ©fÃ©rence Ã  tout ce qui concerne la gestion interne du service: modÃ©ration, analyse, etc. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SystÃ¨me d'Ã©valuation unifiÃ© des utilisateurs.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette tÃ¢che n'Ã©tait pas technique mais logique. Formellement, il n'est pas nÃ©cessaire de dÃ©velopper un systÃ¨me de notation unifiÃ© pour une Â«API de swapÂ», mais ce systÃ¨me est toujours nÃ©cessaire pour le futur service intÃ©grÃ©. Sur les deux sites, les utilisateurs ont Ã©tÃ© Ã©valuÃ©s pour la quantitÃ© et la qualitÃ© du contenu crÃ©Ã©. Les dÃ©tails de l'Ã©valuation n'ont pas Ã©tÃ© divulguÃ©s, mais plus vous rÃ©pondez souvent et mieux aux questions, plus votre Ã©valuation est Ã©levÃ©e. Les principes de notation Ã©taient les mÃªmes pour les deux services, mais la formule elle-mÃªme et les facteurs Ã©taient trÃ¨s diffÃ©rents. Il fallait non seulement comparer correctement et honnÃªtement les utilisateurs de Znatokov et TheQuestion entre eux, mais aussi apprendre Ã  considÃ©rer une seule note pour les experts qui ont Ã©crit sur deux services Ã  la fois. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et rÃ©Ã©crivez toutes les API.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'on le veuille ou non, cette tÃ¢che Ã©tait la plus importante et la plus difficile. De nombreux processus sur les services Ã©taient similaires, nous les avons donc pris aux connaisseurs et nous n'avons pas Ã©crit Ã  partir de zÃ©ro. Mais il y avait aussi beaucoup de nouvelles choses, par exemple, des lignes droites d'utilisateurs ou des Ã©bauches de rÃ©ponses. En consÃ©quence, nous avons rÃ©Ã©crit plus de 100 Â«plumesÂ» dans la Â«swap APIÂ» et implÃ©mentÃ© plus de 50 ressources REST. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AprÃ¨s avoir implÃ©mentÃ© toutes les fonctionnalitÃ©s dÃ©crites ci-dessus, il a Ã©tÃ© possible de commencer Ã  bouger. Mais avant, nous avons fait un tour.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est clair qu'avant de commuter et de dÃ©ployer l 'Â«API de swapÂ» en production, elle devait Ãªtre trÃ¨s bien testÃ©e. Tout d'abord, il fallait le tester fonctionnellement, c'est-Ã -dire vÃ©rifier directement les performances de l'ensemble du site sur la nouvelle API. DeuxiÃ¨mement, c'est stressant. Nous voulions Ãªtre sÃ»rs Ã  100% que notre conception ne Â«mentiraitÂ» pas sous la charge. Naturellement, nous avons rÃ©guliÃ¨rement effectuÃ© des Â«tir de chargeÂ», ce qui a montrÃ© que nous avons une bonne offre de performances. Mais en matiÃ¨re de performances de service, il est toujours prÃ©fÃ©rable de jouer en toute sÃ©curitÃ©. Tous les tests de charge synthÃ©tique, mÃªme les meilleurs, sont en quelque sorte diffÃ©rents de la charge de production. Par consÃ©quent, nous avons dÃ©cidÃ©, avant de changer l'API, de remplir la charge de production sur notre stand.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, chez TheQuestion frontend, nous avons implÃ©mentÃ© la duplication de toutes les requÃªtes GET (c'est-Ã -dire les requÃªtes de donnÃ©es, pas les modifications) dans deux API Ã  la fois: la Â«vieille APIÂ» TheQuestion, qui Ã©tait Ã  l'Ã©poque la principale, et la secondaire Â«swap APIÂ». </font><font style="vertical-align: inherit;">Dans le mÃªme temps, le frontend n'a pas attendu de rÃ©ponse API mineure et n'a pas gÃ©rÃ© les erreurs, mais de cette faÃ§on, nous avons pu tester le backend sur de vrais utilisateurs.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/xk/bu/xhxkbuuaimvplykay5--cdqbl30.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ã‰tape 3. Et puis nous nous sommes souvenus des applications</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Non, bien sÃ»r, nous nous sommes souvenus d'eux tout ce temps, mais nous avons Ã©tÃ© confrontÃ©s Ã  un problÃ¨me. Ceux qui ont travaillÃ© avec des applications mobiles savent que les tracas avec eux sont bien plus qu'avec le site. Cela est dÃ» principalement Ã  la distribution de nouvelles versions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, vous devez travailler avec des services externes de l'App Store et de Google Play et attendre que les nouvelles versions passent la vÃ©rification (et parfois la vÃ©rification peut prendre un temps considÃ©rable). DeuxiÃ¨mement, mÃªme si votre application a dÃ©jÃ  rÃ©ussi le test et est apparue dans le magasin, cela ne signifie pas que les utilisateurs effectueront une mise Ã  jour.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas de l'interface du site, les dÃ©veloppeurs contrÃ´lent eux-mÃªmes quand une nouvelle version est publiÃ©e, et ils savent avec certitude qu'aprÃ¨s cela, tous les utilisateurs recevront une version mise Ã  jour du site. Dans le cas des applications, il n'y a pas de telle garantie. Pour obtenir une telle garantie, ils utilisent souvent la Â«mise Ã  jour forcÃ©eÂ» de l'application. Peu de gens aiment cette mÃ©thode et, bien sÃ»r, toujours, si possible, vous devez maintenir une compatibilitÃ© descendante entre l'application et le backend. Par consÃ©quent, nous avons choisi de faire des changements prÃ©cisÃ©ment du cÃ´tÃ© du backend avec un minimum de changements du front dans les applications. Mais, comme cela arrive souvent, le plan est confrontÃ© Ã  une dure rÃ©alitÃ©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certaines modifications ont Ã©tÃ© beaucoup plus faciles Ã  faire du cÃ´tÃ© frontal que du serveur principal, par consÃ©quent, dans le processus de dÃ©veloppement d'une Â«API de plug-inÂ», le frontal Ã©tait lÃ©gÃ¨rement, mais a changÃ©. En particulier, l'ancienne base de donnÃ©es TheQuestion utilisait des ID numÃ©riques 64 bits. La base de donnÃ©es Connoisseurs et, par consÃ©quent, la base de donnÃ©es combinÃ©e et la nouvelle API pour TheQuestion utilisaient des ID de chaÃ®ne 128 bits. En gÃ©nÃ©ral, pour un frontend Ã©crit en Node.js, cette diffÃ©rence n'est pas significative. Mais pour les applications fortement typÃ©es, cela s'est avÃ©rÃ© fatal. Nous avons perdu la compatibilitÃ© descendante et les anciennes applications ne pouvaient pas fonctionner avec l '"API de plug-in".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ã€ un moment donnÃ©, mÃªme un projet appelÃ© Â«API de plugin pour API de pluginÂ» est apparu, dont l'essence Ã©tait d'Ã©crire une petite couche entre le nouveau backend et les applications qui convertiraient toutes les donnÃ©es dans l'ancien format. Cependant, nous avons rapidement abandonnÃ© cette idÃ©e. Cette couche se rÃ©vÃ©lerait Ãªtre une Â«bÃ©quilleÂ» trÃ¨s rigide, ce qui, Ã  l'avenir, nous poserait certainement de nombreux problÃ¨mes. Par exemple, vous ne pouvez pas simplement prendre et traduire des ID 128 bits en ID 64 bits. Je devrais traduire avec une perte d'informations et, par consÃ©quent, des collisions possibles par ID, ou maintenir une table intermÃ©diaire avec la correspondance des ID anciens et nouveaux (pour tous les Ã©lÃ©ments de la base de donnÃ©es). Ã€ la fois cela et un autre - pas la meilleure solution architecturale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de l'ID, il y avait un certain nombre d'autres changements qui Ã©taient Ã©galement beaucoup plus faciles Ã  prendre en charge du cÃ´tÃ© frontal et de l'application. </font><font style="vertical-align: inherit;">En consÃ©quence, nous avons dÃ©cidÃ© de mettre en Å“uvre des changements dans les applications et d'utiliser toujours la mise Ã  jour forcÃ©e. </font><font style="vertical-align: inherit;">En peu de temps, nous avons dÃ©veloppÃ© de nouvelles versions d'applications compatibles avec la Â«swap APIÂ», car il n'y avait pas tellement de changements par rapport au frontal et ils n'Ã©taient pas trÃ¨s sÃ©rieux. </font><font style="vertical-align: inherit;">EnvoyÃ© sur l'App Store et Google Play, modÃ©rÃ© avec succÃ¨s et a commencÃ© Ã  attendre.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ã‰tape X. Allons-y!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, tout le code est Ã©crit. </font><font style="vertical-align: inherit;">Le support avec "l'API de remplacement" est testÃ© et dÃ©clenchÃ©. </font><font style="vertical-align: inherit;">De nouvelles versions de l'application ont Ã©tÃ© testÃ©es en magasin et sont prÃªtes Ã  Ãªtre publiÃ©es. </font><font style="vertical-align: inherit;">Maintenant, tout cela devait Ãªtre dÃ©ployÃ© en production. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ã‰tant donnÃ© que la copie de nouvelles donnÃ©es de l'ancienne base de donnÃ©es vers la nouvelle s'effectue de maniÃ¨re asynchrone et prend un certain temps, vous ne pouvez pas basculer le backend (et la base de donnÃ©es en dessous) sur un site de travail. </font><font style="vertical-align: inherit;">Cela peut entraÃ®ner la perte ou l'incohÃ©rence des donnÃ©es utilisateur. </font><font style="vertical-align: inherit;">Par consÃ©quent, nous avons choisi une date, averti les utilisateurs et prÃ©parÃ© une plaque Â«Travaux techniques en coursÂ». </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis l'heure est venue, ou plutÃ´t la nuit X. Le plan de dÃ©ploiement ressemblait Ã  ceci:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur le site TheQuestion nous accrochons un talon "Le travail est en cours". </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous transfÃ©rons les applications en mode lecture seule. </font><font style="vertical-align: inherit;">Les utilisateurs peuvent lire le contenu de l'ancienne base de donnÃ©es, mais ne peuvent pas en crÃ©er de nouveau.</font></font></li>
<li>  TheQuestion   Readonly.    :           .   ,  ,      . </li>
<li>        .            ,     .</li>
<li>       .</li>
<li> ,      ,    API.</li>
<li> API  .  â€”     ,    API   .</li>
<li>,   ,   . </li>
<li>  Â« Â»,        API.</li>
<li>    .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, Ã§a n'a pas l'air si effrayant. En rÃ©alitÃ©, tout s'est bien passÃ©. Parmi les surprises que nous avons rencontrÃ©es, la publication de l'application dans l'App Store n'a peut-Ãªtre Ã©tÃ© que trop longue (l'application a Ã©tÃ© vÃ©rifiÃ©e Ã  l'avance, il s'agissait uniquement d'apparaÃ®tre dans la boutique). Au final, cela a pris plusieurs heures, c'est pourquoi toute l'opÃ©ration a Ã©tÃ© un peu retardÃ©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, dans le processus de changement, il y avait une caractÃ©ristique clÃ© qui compliquait tout Ã  plusieurs reprises et augmentait les responsabilitÃ©s. Le fait est que le processus de commutation n'a pas pu Ãªtre inversÃ©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que le processus de copie et de conversion des donnÃ©es de l'ancienne base de donnÃ©es TheQuestion vers la nouvelle base de donnÃ©es intÃ©grÃ©e ait Ã©tÃ© mis en place et dÃ©boguÃ© pour nous, il n'y a pas eu de processus de copie inverse (de la nouvelle base de donnÃ©es Ã  l'ancienne). Cela signifie que dÃ¨s que nous ouvrons le site sur Â«swap APIÂ» et que nous dÃ©marrons le trafic utilisateur, toutes les questions, rÃ©ponses, commentaires et likes nouvellement crÃ©Ã©s ne peuvent plus facilement accÃ©der Ã  l'ancienne base de donnÃ©es TheQuestion. Si quelque chose se passe mal aprÃ¨s l'ouverture, par exemple, une seule base de donnÃ©es ne peut pas faire face Ã  la charge, il ne sera pas possible de tout restaurer rapidement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, bien sÃ»r, j'exagÃ¨re. Dans tous les cas, nous ne perdrions pas de donnÃ©es utilisateur. Nous avions un plan B et un moyen de sauvegarder manuellement les donnÃ©es d'une nouvelle base de donnÃ©es sur une ancienne. Mais cela prendrait encore un certain temps, et la restauration n'aurait pas eu lieu sans douleur pour les utilisateurs.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, le plan A a fonctionnÃ© et rien n'a dÃ» Ãªtre annulÃ©.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mj/wy/7g/mjwy7gbw8fyxtqvt0fp0cetrn_4.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ã‰tape finale</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le backend a Ã©tÃ© changÃ©, la base de donnÃ©es a Ã©tÃ© combinÃ©e, les applications mobiles n'ont pas Ã©tÃ© oubliÃ©es. </font><font style="vertical-align: inherit;">Pour les utilisateurs, rien n'a changÃ©, car le site Yandex.Ku, qui Ã©tait censÃ© combiner les donnÃ©es des deux sites, n'Ã©tait pas encore lancÃ© Ã  l'Ã©poque. </font><font style="vertical-align: inherit;">Et pour son lancement, nous devions rÃ©soudre un problÃ¨me de plus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au tout dÃ©but, j'ai Ã©crit que nous devions combiner non seulement les questions et rÃ©ponses de deux services en un nouveau, mais aussi les utilisateurs. </font><font style="vertical-align: inherit;">Les utilisateurs auraient dÃ» non seulement voir leur contenu sur Kew, mais aussi le gÃ©rer sur Kew. </font><font style="vertical-align: inherit;">Techniquement, combiner des donnÃ©es et transfÃ©rer des droits de gestion n'est pas difficile. </font><font style="vertical-align: inherit;">Il est beaucoup plus difficile de s'assurer que les droits sont transfÃ©rÃ©s Ã  celui Ã  qui ils doivent Ãªtre transfÃ©rÃ©s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors du passage de Znatokov Ã  Kew, tout est simple: dans les deux cas, le mÃªme compte Yandex est utilisÃ©. </font><font style="vertical-align: inherit;">Mais TheQuestion a son propre compte, qui ne peut pas Ãªtre autorisÃ© sur Kew. </font><font style="vertical-align: inherit;">Heureusement, nous y avons pensÃ© au prÃ©alable. </font><font style="vertical-align: inherit;">Bien avant les actions dÃ©crites ci-dessus, nous avons permis aux utilisateurs de TheQuestion de lier leurs profils Yandex. </font><font style="vertical-align: inherit;">Et au moment de la consolidation physique des services, plus de 90% des utilisateurs actifs l'avaient fait. </font><font style="vertical-align: inherit;">Cela nous a permis de dÃ©marrer sans peine la migration du contenu et des utilisateurs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous avons dÃ©mÃ©nagÃ©, nous voulions sauver chaque utilisateur, nous avons donc consciemment optÃ© pour l'option la plus longue et la plus risquÃ©e de combiner les plateformes. </font><font style="vertical-align: inherit;">Nous avons crÃ©Ã© une base technologique unifiÃ©e, appris Ã  transporter instantanÃ©ment du contenu et des profils. </font><font style="vertical-align: inherit;">Au lieu d'une fermeture inattendue et d'une relocalisation forcÃ©e, ils ont conservÃ© la fonctionnalitÃ© des anciens services, en ont lancÃ© un nouveau et ont expliquÃ© ses avantages. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dq/1o/e9/dq1oe9ihp4u8tknser_ew3oxx2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons lancÃ© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Kew</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> l'annÃ©e derniÃ¨re. </font><font style="vertical-align: inherit;">Aujourd'hui, plus de 80% des auteurs actifs de TheQuestion et Znatokov ont dÃ©mÃ©nagÃ© volontairement dans une nouvelle maison.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491926/index.html">DÃ©veloppement d'applications mobiles multiplateformes en 2020</a></li>
<li><a href="../fr491934/index.html">Profils psychologiques des investisseurs boursiers: comment cela fonctionne</a></li>
<li><a href="../fr491936/index.html">Ã€ propos de la faÃ§on dont les bactÃ©ries se nourrissent de fer et Ã©liminent les pigments de haute qualitÃ© des dÃ©charges artificielles</a></li>
<li><a href="../fr491938/index.html">5 outils de conception de jeux pour aider votre jeu</a></li>
<li><a href="../fr491942/index.html">Comment nous utilisons item2vec pour recommander des produits similaires</a></li>
<li><a href="../fr491946/index.html">Lois de programmation</a></li>
<li><a href="../fr491948/index.html">Les jetons de conception peuvent faire plus: crÃ©er une source unique d'informations sur les composants de l'interface utilisateur</a></li>
<li><a href="../fr491956/index.html">Version Rust 1.42.0: modÃ¨les de tranche et messages de panique plus pratiques</a></li>
<li><a href="../fr491958/index.html">Guide de compression d'animation squelette</a></li>
<li><a href="../fr491960/index.html">Era quand il est difficile de se perdre</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>