<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë´ üë©‚Äçüë©‚Äçüë¶ ‚úãüèº Un cycle sans fin qui n'√©tait pas: l'histoire du bug du Saint Graal üö© üë®üèæ‚Äçüè≠ üòä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il √©tait une fois un jeu pour GBA appel√© Hello Kitty Collection: Miracle Fashion Maker. C'√©tait un jeu mignon bas√© sur la c√©l√®bre franchise Sanrio Hel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Un cycle sans fin qui n'√©tait pas: l'histoire du bug du Saint Graal</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488240/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il √©tait une fois un jeu pour GBA appel√© Hello Kitty Collection: Miracle Fashion Maker. C'√©tait un jeu mignon bas√© sur la c√©l√®bre franchise Sanrio Hello Kitty et d√©velopp√© par Imagineer. Mais sous le couvert d'un nom apparemment innocent √©tait un probl√®me insidieux. Pour une raison quelconque, ce jeu simple ne fonctionnait sur aucun √©mulateur GBA. Mais cela ne suffirait pas √† lui seul √† qualifier le probl√®me d'insecte du Saint Graal. Comme tous les bogues du Saint Graal, ce bogue lui-m√™me √©tait compl√®tement d√©routant. L'explication √©tait simple: √† un moment donn√© de la s√©quence de lancement du jeu, il est tomb√© dans un cycle dont il n'est jamais </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sorti</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , en attendant qu'une certaine valeur soit lue dans une m√©moire qui </font><em><font style="vertical-align: inherit;">n'existe pas</font></em><font style="vertical-align: inherit;"> . Bien qu'il existe des bogues similaires dans de nombreux jeux, par exemple, dans l'intro populaire</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Legend of Zelda: The Minish Cap</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ils s'appuient sur un comportement sp√©cial caus√© par la lecture d'adresses m√©moire non valides. </font><font style="vertical-align: inherit;">Mais ce cycle semblait violer un tel comportement. </font><font style="vertical-align: inherit;">N√©anmoins, le jeu a fonctionn√© sur un √©quipement r√©el. </font><font style="vertical-align: inherit;">De plus, le m√™me bug s'est produit lors du chargement d'une sauvegarde dans Sonic Pinball Party apr√®s un red√©marrage √† froid. </font><font style="vertical-align: inherit;">L'attente de ces adresses de m√©moire invalides pourrait-elle √™tre en quelque sorte erron√©e? </font><font style="vertical-align: inherit;">Mais si oui, comment?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1b0/c85/547/1b0c8554787a8e54e1ac5c21c78d639c.png"></div><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais c'est ill√©gal, non?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Attendez une minute - si vous essayez d'acc√©der √† une m√©moire invalide, alors le jeu a juste besoin de planter, non? Une op√©ration non r√©solue, </font><font style="vertical-align: inherit;">une erreur de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segmentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou une autre erreur </font><font style="vertical-align: inherit;">devrait se produire </font><font style="vertical-align: inherit;">. Droite? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, c'est plus comme Oui. Mais pas vraiment. Du moins pas sur la GBA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'architecture des processeurs ARM utilis√©s dans GBA, cet √©tat erron√© est appel√© abandon de donn√©es et se produit uniquement lorsque vous essayez d'acc√©der √† la m√©moire pour laquelle le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gestionnaire de m√©moire n'a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas attribu√© l'autorisation de lecture </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Lorsque l'abandon des donn√©es se produit, le processeur termine ce qu'il faisait et passe au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vecteur d'exception</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">affect√© aux exceptions d'abandon des donn√©es. Ensuite, le syst√®me d'exploitation peut choisir l'une des solutions: tuer le processus en cours, affecter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√©moire de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">d√©fauts de page</font></a><font style="vertical-align: inherit;"> , laisser le processus g√©rer la situation, comme certains √©mulateurs JIT le font avec ¬´fastmem¬ª, ou effectuer d'autres actions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment la GBA g√®re-t-elle les abandons de donn√©es? L'entr√©e du vecteur d'exception pour l'abandon des donn√©es se trouve dans la ROM de d√©marrage de la console GBA (ou, comme on l'appelle √©galement, dans le BIOS). Si le GBA rencontre des donn√©es abandonn√©es, il essaie alors d'aller au gestionnaire DACS </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s'il existe, sinon le blocage se produit. </font><font style="vertical-align: inherit;">Aucun jeu commercial ne dispose de gestionnaires DACS. </font><font style="vertical-align: inherit;">Alors pourquoi ce jeu ne g√®le-t-il pas? </font><font style="vertical-align: inherit;">Tout est tr√®s simple - GBA ne g√©n√®re jamais d'abandon de donn√©es. </font><font style="vertical-align: inherit;">Il ne dispose pas d'un gestionnaire de m√©moire (MMU) (ni m√™me d'une unit√© de protection de la m√©moire, comme dans DS), il continue donc de fonctionner et lit la m√©moire invalide.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bus m√©moire entre en sc√®ne.</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f75/dd9/55f/f75dd955f33d3a974b417f401fe054a6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-ce que la m√©moire invalide en g√©n√©ral? Elle ressemble √† quoi? C'est le principal probl√®me. C'est une situation difficile: ce que le code lit d√©pend fortement de ce que le CPU a fait r√©cemment, ou, plus pr√©cis√©ment, de ce que le </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bus m√©moire a</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fait r√©cemment </font><font style="vertical-align: inherit;">. En bref, lors de l'acc√®s √† une m√©moire invalide, le CPU lit ce qui √©tait le dernier sur le bus m√©moire. Pour comprendre ce qui en d√©coule, vous devez en apprendre un peu plus sur le bus m√©moire et son fonctionnement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un bus m√©moire fait partie d'un circuit √©lectronique qui connecte le CPU √† tous les composants m√©moire de la plateforme. Sur la GBA, plusieurs p√©riph√©riques sont connect√©s au bus m√©moire: RAM de travail, m√©moire vid√©o et bus de cartouches. Lorsque le CPU essaie d'acc√©der √† la m√©moire, il indique au bus m√©moire √† quelle adresse il doit acc√©der, puis le composant correspondant √† cette adresse est activ√©. Ensuite, le composant place la valeur √† cette adresse sur le bus, ce qui peut prendre plusieurs </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cycles </font><font style="vertical-align: inherit;">, puis la CPU peut enfin lire la valeur sur le bus. Dans le cas de la GBA, si aucun √©quipement n'est associ√© √† l'adresse, aucune valeur n'est √©crite sur le bus et la CPU lit toute valeur plac√©e en </font><em><font style="vertical-align: inherit;">dernier</font></em><font style="vertical-align: inherit;"> sur le bus</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La situation peut varier de diff√©rentes mani√®res, par exemple, si la lecture √©tait de 16 bits et que le CPU essaie d'effectuer une lecture de 32 bits, mais en g√©n√©ral, ce sera toujours une valeur provenant du bus. </font><font style="vertical-align: inherit;">Les d√©veloppeurs appellent cette fonctionnalit√© ¬´bus ouvert¬ª. </font><font style="vertical-align: inherit;">Plus t√¥t, j'ai √©crit comment cela affecte les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autres jeux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eh bien, il semble que tout ne soit pas si mal ... non?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez donc simplement mettre en cache le dernier acc√®s √† la m√©moire? Et puis le ramener √† nouveau? Dans le cas g√©n√©ral, cette approche fonctionnera, mais il y a certaines difficult√©s. Tout d'abord, vous devez vous assurer que toutes les op√©rations d'acc√®s √† la m√©moire sont dans le bon ordre. C'est plus compliqu√© qu'il n'y para√Æt, car le CPU acc√®de √† la m√©moire avec chaque instruction pour obtenir l'instruction suivante dans le pipeline. Et en fait, dans le cas g√©n√©ral *, la m√©moire coinc√©e dans le bus est la derni√®re instruction re√ßue. Cela simplifie le processus, car vous devez obtenir uniquement cette derni√®re valeur pr√©s√©lectionn√©e. Mais puisque la derni√®re valeur pr√©s√©lectionn√©e ne d√©pend que de l'endroit o√π nous ex√©cutons actuellement √† partir de la m√©moire, elle devrait toujours √™tre la m√™me. M√™me si l'adresse re√ßue change alors qu'elle n'est pas valide,vous obtiendrez toujours la m√™me m√©moire.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Euh ... Arr√™te. </font><font style="vertical-align: inherit;">Mais ce cycle existe et il ne peut pas √™tre quitt√© si cette valeur est pr√©s√©lectionn√©e. </font><font style="vertical-align: inherit;">Alors, quoi de neuf? </font><font style="vertical-align: inherit;">S'il re√ßoit constamment l'instruction suivante, que se passe-t-il entre ces op√©rations? </font><font style="vertical-align: inherit;">J'ai essay√© d'ex√©cuter de telles boucles sans fin sur des ROM de test pour v√©rifier si, par exemple, la valeur pouvait mal tourner. </font><font style="vertical-align: inherit;">Cela peut certainement se produire si la valeur n'a pas √©t√© mise √† jour r√©cemment, mais la valeur est mise √† jour dans chaque instruction, de sorte qu'elle n'a pas le temps d'√™tre corrompue. </font><font style="vertical-align: inherit;">Mes tests n'ont jamais quitt√© la boucle. </font><font style="vertical-align: inherit;">J'ai fait quelque chose de diff√©rent que dans ces jeux, m√™me si j'ai recr√©√© le cycle exactement. </font><font style="vertical-align: inherit;">Qu'ai-je fait de mal?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pok√©mon Emerald et ACE, apparaissant uniquement sur le fer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avance rapide dans le temps, en janvier 2020. Le rapport de bogue √† la Sonic Pinball Party √† l'√©poque avait environ trois ans et demi. Dans d'autres √©mulateurs, il √©tait connu depuis de nombreuses ann√©es. Je n'ai plus de th√©ories de travail. A la fin de ce mois, un utilisateur avec le pseudo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">merrp</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a rejoint la communaut√© Discord de l'√©mulateur mGBA et a d√©clar√© que Pok√©mon Emerald a un nouveau probl√®me d'ex√©cution de code arbitraire (ACE) qui ne fonctionne que sur le mat√©riel. De plus, ce probl√®me sera tr√®s probablement utilis√© par les speedrunners, qui voudront peut-√™tre pratiquer l'√©mulateur. De toute √©vidence, ce bogue est devenu une cible attrayante pour corriger l'erreur, mais il serait pr√©f√©rable que je le d√©couvre avant la version 0.8.0. J'ai commenc√© √† rechercher le probl√®me et confirm√© l'observation de merrp qu'il ne fonctionne que sur le mat√©riel. Dans tous les √©mulateurs que j'ai essay√©s, le jeu √©tait suspendu √† un √©cran noir. Mais merrp m'a inform√© qu'il se bloque sur la lecture de la m√©moire invalide dans une boucle, et j'ai r√©alis√© que je ne pourrais probablement pas corriger l'erreur dans un proche avenir. C'est encore </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le m√™me</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bug.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette fois, l'apprentissage des fonctions de bouclage m'a donn√© un avantage. Gr√¢ce au </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projet de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©compilation </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">pokeemerald,</font></a><font style="vertical-align: inherit;"> j'ai pu facilement apporter des modifications cibl√©es √† la fonction pour essayer de comprendre comment elle a r√©ussi √† sortir de la boucle. Une version simplifi√©e de cette boucle ressemble √† ceci:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">uint16_t</span> type = <span class="hljs-comment">/* ... */</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; table[type][i] != <span class="hljs-number">0xFFFF</span>; ++i) {
	<span class="hljs-keyword">uint16_t</span> value = table[type][i] &amp; <span class="hljs-number">0xFE00</span>;
	<span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0x7E00</span>) {
		<span class="hljs-keyword">break</span>;<font></font>
	}<font></font>
	<span class="hljs-comment">/* ... */</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La boucle effectue une t√¢che assez simple. Il existe un tableau de valeurs bidimensionnel. Sur chaque ligne de cette table de colonnes, la </font></font><code>type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boucle essaie d'abord de d√©terminer si la valeur est une certaine valeur sentinelle. Si c'est le cas, la boucle se termine. Sinon, il applique un masque √† la valeur et v√©rifie si elle est sup√©rieure √† la valeur v√©rifi√©e. Sinon, √ßa descend le cycle. Dans un cas particulier de probl√®me, la valeur </font></font><code>type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©passe les limites du tableau, ce qui entra√Æne l'apparition d'un pointeur non valide. Cela signifie que lorsque vous essayez d'acc√©der √†</font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour cet √©l√©ment de cette colonne inexistante, nous acc√®derons toujours √† la m√©moire invalide. Bien que le d√©calage de la table augmente √† chaque it√©ration de la boucle avant de revenir √† la m√©moire r√©elle, il peut n√©cessiter des centaines de millions de r√©p√©titions. Par cons√©quent, il est √©vident qu'il ne le fait pas. Alors, comment un programme sort-il d'une boucle?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour enqu√™ter sur cela, j'ai chang√© le cycle et regard√© ce qui se passerait si je sortais instantan√©ment du cycle. </font><font style="vertical-align: inherit;">Tout s'est av√©r√© assez simple: √† ce moment, ACE a travaill√© √† la fois sur le mat√©riel et l'√©mulateur, et rien ne s'est arr√™t√©. </font><font style="vertical-align: inherit;">Au lieu de cela, j'ai essay√© de d√©finir la couleur de l'√©cran √† la valeur que le programme lit lorsqu'il quitte la boucle et se fige afin que la couleur ne change pas. </font><font style="vertical-align: inherit;">J'ai recompil√© le code et l'ai ex√©cut√© sur un vrai GBA. </font><font style="vertical-align: inherit;">Apr√®s quelques secondes de gel sur un √©cran noir, il est devenu une magnifique teinte bleue.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eq/e_/md/eqe_md60cly8igmztq2_kd2yigc.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TR√àS BLEU</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mais l'√©mulateur √©tait toujours accroch√© sur un √©cran noir. </font><font style="vertical-align: inherit;">Quelle valeur lira-t-il s'il lit la valeur re√ßue pr√©c√©demment? </font><font style="vertical-align: inherit;">Au lieu de cela, il est devenu une turquoise sombre.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sh/hf/6j/shhf6jyqkem0ulhbpzjuhc9hmi4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fu.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
C'est, le programme, avant qu'il a </font><font style="vertical-align: inherit;">r√©ussi √† sortir du cycle, certainement pass√© au moins une fois. </font><font style="vertical-align: inherit;">Il s'est √©galement av√©r√© que le temps n√©cessaire pour s'√©chapper du cycle sur le fer varie. </font><font style="vertical-align: inherit;">Cela prenait g√©n√©ralement de 2 √† 30 secondes. </font><font style="vertical-align: inherit;">Que se passe-t-il?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nouvelle th√©orie de travail</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai remarqu√© la diff√©rence entre ma ROM de test et le Pok√©mon Emerald lorsqu'elle √©tait suspendue. Pok√©mon jouait de la musique. Sonic Pinball Party a √©galement jou√© de la musique. Bonjour Kitty n'a pas jou√© de musique, mais √ßa m'a donn√© une id√©e. Que se passe-t-il si une interruption se produit entre la pr√©lecture et le chargement des donn√©es? Le programme commence-t-il √† extraire le vecteur d'interruption avant d'acc√©der √† la m√©moire invalide? J'ai rapidement cr√©√© une disposition pour cette situation dans mGBA, activ√© les interruptions dans la ROM de test et bien s√ªr, il est sorti de la boucle. Ensuite, j'ai essay√© le m√™me ROM de test sur le mat√©riel et ... il n'est pas sorti de la boucle. Et donc la th√©orie est venue. Finalement, j'ai r√©alis√© quelque chose. Je suis s√ªr que vous avez remarqu√© un ast√©risque ci-dessus, donc oui, il peut y avoir un √©v√©nement entre la pr√©lecture et l'acc√®s √† la m√©moire,mais seulement si, entre la pr√©lecture et l'acc√®s √† la m√©moire invalide, le bus m√©moire envoie une requ√™te non pas au CPU, mais √† autre chose.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai dit que le bus m√©moire est contr√¥l√© par le CPU. Pour la plupart, cela est vrai, mais il existe d'autres √©quipements importants qui ont √©galement acc√®s au bus m√©moire contournant le processeur. Ce processus est appel√© </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acc√®s direct √† la m√©moire</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . J'ai parl√© de DMA dans un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article pr√©c√©dent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , alors maintenant je ne vais pas entrer dans les principes de son travail. Si vous relisez l'article, vous remarquerez peut-√™tre que j'ai dit que le processeur principal se met en pause pendant l'ex√©cution de DMA. Cela signifie que lorsque DMA est en cours d'ex√©cution, la valeur sur le bus sera d√©sormais le dernier acc√®s √† la m√©moire DMA. Ceci est principalement important si le DMA va au-del√† de la m√©moire r√©elle vers une r√©gion invalide; cependant, il duplique la derni√®re bonne valeur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On sait depuis longtemps que si vous chargez une m√©moire invalide dans DMA, vous obtiendrez la derni√®re valeur DMA, mais je l'ai impl√©ment√©e depuis longtemps dans mGBA et je l'ai d√©j√† oubli√©e. Quand j'ai vu cela dans le code d'acc√®s pour une m√©moire invalide lors de l'√©tude du bug, quelque chose a cliqu√© dans ma t√™te. Que faire si la valeur DMA persiste sur le bus pour une instruction? Si la premi√®re instruction apr√®s que DMA a fini de charger la m√©moire invalide avant qu'elle n'obtienne la valeur suivante, alors en th√©orie, cela devrait conduire √† recharger la valeur DMA. De plus, la lecture de musique en GBA utilise g√©n√©ralement le DMA pour transmettre la sortie audio. Pour une impl√©mentation correcte de cela, un √©mulateur tact-pr√©cis est n√©cessaire qui peut bloquer le CPU au milieu de l'ex√©cution de l'instruction, entre le d√©but de l'instruction et l'acc√®s √† la m√©moire, et l'√©mulation de la console GBA dans l'√©mulateur mGBA n'est pas pr√©cise.Et c'est quelque chose pour moi.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rappelle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Heureusement, j'ai r√©ussi √† contourner ce probl√®me. </font><font style="vertical-align: inherit;">La solution est imparfaite, mais je peux maintenant comparer l'adresse CPU attendue pour l'instruction apr√®s DMA avec l'adresse CPU actuelle pour une charge non valide et utiliser une seule adresse au lieu de la valeur pr√©s√©lectionn√©e pour cette valeur DMA.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La d√©cision tant attendue</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai activ√© les op√©rations DMA pour H-blank dans la ROM de test et les ai synchronis√©es avec V-blank afin que les synchronisations soient stables, l'ai ex√©cut√© sur le mat√©riel, et ... cette fois cela a fonctionn√©! La ROM de test quitte constamment la boucle apr√®s le m√™me nombre d'it√©rations lorsque la valeur DMA est lue sur le bus. J'avais raison! Pour une impl√©mentation correcte de ceci dans mGBA, plusieurs tentatives ont √©t√© n√©cessaires, mais maintenant le programme quitte le cycle avec les m√™mes r√©sultats que sur le mat√©riel. J'ai finalement obtenu une nuance de bleu sur mGBA. Hello Kitty a d√©marr√©. Enregistrer √† la Sonic Pinball Party a gagn√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je l'ai fait.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce fut probablement le plus long temps que j'ai pass√© sur un seul bug. En trois ans, j'ai investi tellement de temps dans le d√©bogage que j'ai perdu le compte, et je suis s√ªr que d'autres d√©veloppeurs ont √©galement fait face √† des situations similaires dans leurs √©mulateurs. Sans cette perspicacit√©, cela aurait pu me prendre une autre ann√©e, voire plus, mais l'√©cran noir, sur lequel rien ne s'est pass√©, sauf pour jouer de la musique, est devenu cette tuile domino qui a conduit √† l'effondrement de tout le probl√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que la solution est trouv√©e, elle peut √™tre impl√©ment√©e dans d'autres √©mulateurs GBA, mettant fin √† ce bogue. Le bogue sera corrig√© dans mGBA 0.9.0, qui, je l'esp√®re, sortira cette ann√©e et a d√©j√† √©t√© corrig√© dans les versions de test. Vous pouvez enfin jouer √† Hello Kitty Collection: Miracle Fashion Maker. A moins, bien s√ªr, que vous ne le souhaitiez, il ne m'appartient pas de vous juger.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34c/74c/fce/34c74cfce5ebbb092c5a55c9293ec0cb.png" alt="image"></div><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous essayez d'ex√©cuter de la m√©moire qui n'a pas d'autorisations d'ex√©cution, cela s'appelle abandon de la pr√©-lecture.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DACS (abr√©viation de Debugging and Communication System) fait partie du kit de d√©veloppement GBA.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ces cycles inactifs lors de la lecture du bus sont parfois appel√©s √©tats d'attente.</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488224/index.html">Ancien r√©dacteur en chef de TJ √† propos des lettres du FSB: il y aura une histoire de "Durov 2.0", mais Habr deviendra la t√™te d'affiche</a></li>
<li><a href="../fr488228/index.html">TOP 10 des lieux et des id√©es pour un rendez-vous geek le 14 f√©vrier</a></li>
<li><a href="../fr488230/index.html">Introduction au SSD. Partie 3. Facteur de forme</a></li>
<li><a href="../fr488232/index.html">technologie approximative: QATOK # 2</a></li>
<li><a href="../fr488234/index.html">Utilisation de QubesOS pour Windows 7</a></li>
<li><a href="../fr488242/index.html">Int√©gration du projet VueJS + TS avec SonarQube</a></li>
<li><a href="../fr488244/index.html">Comment r√©duire la surcharge lors de la gestion des exceptions en C ++</a></li>
<li><a href="../fr488246/index.html">VoiceOver sur iOS: chaque contr√¥le se comporte diff√©remment</a></li>
<li><a href="../fr488250/index.html">√Ä la question de Linux (L)</a></li>
<li><a href="../fr488252/index.html">Comment r√©duire le co√ªt de d√©veloppement de nouveaux produits √† l'aide de SLS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>