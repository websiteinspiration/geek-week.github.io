<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òùüèø üíà üë®üèø‚Äçü§ù‚Äçüë®üèæ CRUD API on Deno and PostegreSQL: working with a dinosaur üêû üè© üôçüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. In anticipation of the start of the ‚ÄúFullstack JavaScript Developer‚Äù course , we want to share some interesting material sent by our f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CRUD API on Deno and PostegreSQL: working with a dinosaur</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/505476/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font><font style="vertical-align: inherit;">In anticipation of the start of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúFullstack JavaScript Developer‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> course </font><font style="vertical-align: inherit;">, we want to share some interesting material sent by our freelance writer. </font><font style="vertical-align: inherit;">This article is not related to the course program, but it will certainly be interesting as a short review on Deno.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/1a/5g/sq/1a5gsqglaelsf8jja4zdr0jslbw.png"><br>
<br>
<hr><br>
<blockquote>"-,    CLI   Deno .    secure runtime ?"<br>
"-"<br>
"-,     ,   ,    -  .   ?"<br>
"-"</blockquote><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello everyone. </font><font style="vertical-align: inherit;">Deno is becoming more and more famous and popular, there are a huge number of new videos and text guides on this subject, but mainly in English. </font><font style="vertical-align: inherit;">Several articles on Deno were also published on Habr√©, for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but mainly articles talk about Deno in theoretical terms. </font><font style="vertical-align: inherit;">Today we will try to create a small CRUD Api, which can serve, for example, a todo application on the frontend, and I will share with you my impressions of this dinosaur in real coding.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Theoretical introduction </font></font></h1><br>
<img src="https://habrastorage.org/webt/ou/cz/_q/oucz_qc3vym7u2ftdzkcgnt65pi.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For those who are in the tank, I will tell you what Deno is, if you have not read, for example, one of the articles above. Deno is a runtime runtime that runs on JavaScript and TypeScript (TypeScript is supported out of the box, the TypeScript compiler version is hardwired to the Deno version, you can only change it if you change the Deno version), which is based on the V8 engine and Rust programming language. Deno was created by Ryan Dahl, the creator of Node.js, and Deno's main qualities are performance and security. Deno was announced in 2018, and what many sources forget to mention - was greatly influenced by Golang (and indeed it was originally written in Golang, but later had to be rewritten in Rust).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The standard library was created on the model of the Go standard library, and many tools or their implementations switched from Golang to Deno, for example, the lack of an ecosystem like npm and pumping libraries directly from web resources at the initial build stage (which causes some kind of stupor in Node. js of developers who, quite naturally, were not familiar with a similar system with Go). </font><font style="vertical-align: inherit;">So for whom is Deno now? </font><font style="vertical-align: inherit;">If you like typed languages, like Golang ideas and tools, but want to write backing on something simpler - it's time to try Deno in reality. </font><font style="vertical-align: inherit;">However, if you want to wait until the platform ‚Äúripens‚Äù, more libraries and answers to StackOverflow will appear, maybe you should wait a bit.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Start to create </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the youth of Deno, some kind of ecosystem managed to form around it (which, of course, cannot yet be compared with the Node.js ecosystem), which allows you to cover the basic needs for creating your own API. </font><font style="vertical-align: inherit;">Let's decide what we are creating: I want to create a simple CRUD Api using Deno and TypeScript on the backend (since there is TypeScript support, why not use it), PostgreSQL as a database (in general, I wanted to use MySQL, but accidentally broke my access on localhost and couldn‚Äôt fix it. A curious fact is that on the external ip, the built-in PHP 7.4 server was able to connect to my MySQL database, and Deno showed packets out of order), and our requests will look like this:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Method </font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Routes </font></font></b></td>
<td> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Execution result </font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get </font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / api / todos / get</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Getting all todo </font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Post </font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / api / todos / post</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Creating a new business </font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH </font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / api / todos /: id</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Updating a specific case </font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DELETE </font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / api / todos /: id</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Delete case by id </font></font></td>
</tr>
</tbody></table></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, we decided on the query scheme, we launched the PostgreSQL server (if you can download it </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it‚Äôs a very nice </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postico</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GUI client </font><font style="vertical-align: inherit;">), we created the crud_api database. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 What's next? </font><font style="vertical-align: inherit;">You can create a table with your hands using sql queries or a client, of course, but I want to see how it is with Deno's migrations. </font><font style="vertical-align: inherit;">In this case </font><font style="vertical-align: inherit;">, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nessia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library is </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">useful</font></a><font style="vertical-align: inherit;"> , which allows you to create migrations similar to migrations in Laravel. </font><font style="vertical-align: inherit;">But before we go into migration, let's talk about organizing a development environment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just the other day, the official JetBrains Deno development plugin was released. </font><font style="vertical-align: inherit;">You can find it </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">On Visual Studio, you need to install the Deno plugin, and in the project folder create the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.vscode</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> settings </font><i><font style="vertical-align: inherit;">folder</font></i><font style="vertical-align: inherit;"> , where in settings.json you turn on deno support (but it seemed to work for me without it):</font></font><br>
<br>
<pre><code class="json hljs">    <span class="hljs-string">"deno.enable"</span>:<span class="hljs-literal">true</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all with the preparatory stage, we can return to migrations. </font><font style="vertical-align: inherit;">First we need to enter the initialization command, taking it from their library documentation:</font></font><br>
<br>
<pre><code class="bash hljs">deno run --allow-net --allow-read --allow-write https://deno.land/x/nessie/cli.ts init
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We create a configuration file for our library, with the help of which we can determine which DBMS and database you are going to connect to. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, three templates are created in the file - for PostgreSQL, MySQL and Sqlite (by default, settings for PostegreSQL are exported). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, our </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nessie.config.ts</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">will look like this:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { ClientPostgreSQL} <span class="hljs-keyword">from</span> <span class="hljs-string">"https://deno.land/x/nessie/mod.ts"</span>; <font></font>
<font></font>
<span class="hljs-keyword">const</span> migrationFolder = <span class="hljs-string">"./migrations"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> configPg = {
  <span class="hljs-attr">client</span>: <span class="hljs-keyword">new</span> ClientPostgreSQL(migrationFolder, {
    <span class="hljs-attr">database</span>: <span class="hljs-string">"deno_crud"</span>,
    <span class="hljs-attr">hostname</span>: <span class="hljs-string">"localhost"</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">5432</span>,
    <span class="hljs-attr">user</span>: <span class="hljs-string">"isakura313"</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">""</span>,<font></font>
  }),<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> configPg;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, now you can create a migration file so that you can edit it by specifying which table and what data we are going to create. </font><font style="vertical-align: inherit;">To do this, enter the following command:</font></font><br>
<br>
<pre><code class="bash hljs">deno run --allow-net --allow-read --allow-write https://deno.land/x/nessie/cli.ts make create_todo
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps the inexperienced reader has already had questions about why so many flags. </font><font style="vertical-align: inherit;">This is secure in Deno - to execute the command, you need to specify what level of access you give it ( </font></font><strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this is the ingenious security system that we were waiting for</font></font></strike><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">These flags cause quite sharp burning in many - do they need to be printed? </font><font style="vertical-align: inherit;">Append bash scripts in which you always invoke them with full rights? </font><font style="vertical-align: inherit;">I think at some point this system will change, but for now, as it is. </font><font style="vertical-align: inherit;">Thus, </font></font><code>.migrations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a migration file should appear </font><font style="vertical-align: inherit;">in our folder </font><font style="vertical-align: inherit;">, which you can edit it as you go. </font><font style="vertical-align: inherit;">I edited it as follows:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> up = (): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"CREATE TABLE todo (id serial, text text, done boolean)"</span>;<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> down = (): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"DROP TABLE todo"</span><font></font>
};<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, we can migrate to the database using the following command:</font></font><br>
<br>
<pre><code class="bash hljs">deno run --allow-net --allow-read https://deno.land/x/nessie/cli.ts migrate
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a more advanced migration option in nessia, but I decided to make things a little easier. </font><font style="vertical-align: inherit;">Further we can proceed to create our own model.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We work with the Model</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 We create a folder </font></font><code>models</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in which we will have the requests themselves. </font><font style="vertical-align: inherit;">First you need to create a file </font></font><code>config.ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in which the settings for connecting to the database will be added (yes, we have already mentioned them in </font></font><code>nessie.config.ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but that file was used for migration). </font><font style="vertical-align: inherit;">For the connection in the file </font></font><code>config.ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we will use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deno-posgres library</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">As a result, the config file will look like this:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { Client } <span class="hljs-keyword">from</span> <span class="hljs-string">"https://deno.land/x/postgres/mod.ts"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> Client({
  <span class="hljs-attr">user</span>: <span class="hljs-string">"isakura313"</span>,
  <span class="hljs-attr">database</span>: <span class="hljs-string">"deno_crud"</span>,
  <span class="hljs-attr">hostname</span>: <span class="hljs-string">"localhost"</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-number">5432</span>,<font></font>
});<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> client;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fine! </font><font style="vertical-align: inherit;">Now we pass directly to the model. </font><font style="vertical-align: inherit;">To build sql queries I'm going to use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">, the port of the Knex library on Deno. </font><font style="vertical-align: inherit;">It will allow me to programmatically determine which sql query I'm going to execute. </font><font style="vertical-align: inherit;">Let's start by defining which dialect Dex will have to work with this time, and defining the interface of our todo:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> dex = Dex({ <span class="hljs-attr">client</span>: <span class="hljs-string">"postgres"</span> });<font></font>
<font></font>
interface Todo {<font></font>
  id?: number;   <span class="hljs-comment">//? -     TypeScript</span><font></font>
  text: string;<font></font>
  done: boolean;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, now we can proceed to the pulp itself. </font><font style="vertical-align: inherit;">First, define a get request that will receive all todo. </font><font style="vertical-align: inherit;">I will use asynchronous function execution to connect to the database via await and get the result of the query:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAllTodo</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">await</span> client.connect();
  <span class="hljs-keyword">const</span> getQuery = dex.queryBuilder().select(<span class="hljs-string">"*"</span>).from(<span class="hljs-string">"todo"</span>).toString();
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> client.query(getQuery);
  <span class="hljs-keyword">return</span> result;<font></font>
}<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are even a little familiar with TypeScript and c async / await, you won‚Äôt have any questions here. </font><font style="vertical-align: inherit;">But further more - we need to write a post-request that will add the case to the database.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addTodo</span>(<span class="hljs-params">todo: Todo</span>) </span>{
  <span class="hljs-keyword">await</span> client.connect();
  <span class="hljs-keyword">const</span> insertQuery = dex.queryBuilder().insert([todo]).into(<span class="hljs-string">"todo"</span>).toString();
  <span class="hljs-keyword">return</span> client.query(insertQuery).then(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> getQuery = dex.queryBuilder().select(<span class="hljs-string">"*"</span>).from(<span class="hljs-string">"todo"</span>).where(<font></font>
      { <span class="hljs-attr">text</span>: todo.text },<font></font>
    ).toString();<font></font>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> client.query(getQuery);
    <span class="hljs-keyword">const</span> result_data = result.rows ? result.rows[<span class="hljs-number">0</span>] : {};
    <span class="hljs-keyword">return</span> result_data;<font></font>
  });<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The above code can be shortened, however, I tried to make it as simple and expressive as possible, even to the detriment of the number of lines. </font><font style="vertical-align: inherit;">In general terms, the following happens there - inside the function, we create a connection to the database, insert is built in - the request, a request occurs, inside which a new request is created, which returns the newly created case or an empty object. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other functions - editing and deleting, I will give together. </font><font style="vertical-align: inherit;">In editing, the same thing happens for us as in adding a case, except that we have an update in editTodo. </font><font style="vertical-align: inherit;">In delete, we simply delete the case and return nothing:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">editTodo</span>(<span class="hljs-params">id: number, todo: Todo</span>) </span>{
  <span class="hljs-keyword">await</span> client.connect();
  <span class="hljs-keyword">const</span> editQuery = dex.queryBuilder().from(<span class="hljs-string">"todo"</span>).update(todo).where({ id })<font></font>
    .toString();<font></font>
  <span class="hljs-keyword">return</span> client.query(editQuery).then(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> getQuery = dex.queryBuilder().select(<span class="hljs-string">"*"</span>).from(<span class="hljs-string">"todo"</span>).where(<font></font>
      { <span class="hljs-attr">text</span>: todo.text },<font></font>
    ).toString();<font></font>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> client.query(getQuery);
    <span class="hljs-keyword">const</span> result_data = result.rows ? result.rows[<span class="hljs-number">0</span>] : {};
    <span class="hljs-keyword">return</span> result_data;<font></font>
  });<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deleteTodo</span>(<span class="hljs-params">id: number</span>) </span>{
  <span class="hljs-keyword">await</span> client.connect();
  <span class="hljs-keyword">const</span> deleteQuery = dex.queryBuilder().from(<span class="hljs-string">"todo"</span>).delete().where({ id })<font></font>
    .toString();<font></font>
  <span class="hljs-keyword">return</span> client.query(deleteQuery);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wow. </font><font style="vertical-align: inherit;">It remains only to export our functions, and you can begin to configure the server and routing:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> {<font></font>
  addTodo,<font></font>
  getAllTodo,<font></font>
  editTodo,<font></font>
  deleteTodo,<font></font>
};<font></font>
<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Routing and server operation </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create the routes folder in which we will have routes.ts. </font><font style="vertical-align: inherit;">To work our routes, we will use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">denotrain</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a library that was inspired by expressJS and is allowed to work with url requests, configure routing and a lot of useful stuff. </font><font style="vertical-align: inherit;">We import our functions and Router:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { Router } <span class="hljs-keyword">from</span> <span class="hljs-string">"https://deno.land/x/denotrain@v0.5.0/mod.ts"</span>;
<span class="hljs-keyword">import</span> { addTodo, getAllTodo, editTodo, deleteTodo } <span class="hljs-keyword">from</span> <span class="hljs-string">"../models/models.ts"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> api = <span class="hljs-keyword">new</span> Router();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the get and post methods:</font></font><br>
<br>
<pre><code class="javascript hljs">api.get(<span class="hljs-string">"/"</span>, (ctx) =&gt; {
  <span class="hljs-keyword">return</span> getAllTodo().then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> result.rows;
    <span class="hljs-comment">// </span><font></font>
  });<font></font>
});<font></font>
<font></font>
api.post(<span class="hljs-string">"/"</span>, (ctx) =&gt; {
  <span class="hljs-keyword">const</span> body = {
  <span class="hljs-comment">//  </span>
    <span class="hljs-attr">text</span>: ctx.req.body.text,
    <span class="hljs-attr">done</span>: ctx.req.body.done,<font></font>
  };<font></font>
<font></font>
  <span class="hljs-keyword">return</span> addTodo(body).then(<span class="hljs-function">(<span class="hljs-params">newTodo</span>) =&gt;</span> {<font></font>
    ctx.res.setStatus(<span class="hljs-number">201</span>); <span class="hljs-comment">//   "Created"</span>
    <span class="hljs-keyword">return</span> newTodo;<font></font>
  });<font></font>
});<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ctx is the variable that is responsible for the response context. </font><font style="vertical-align: inherit;">I don‚Äôt know what to add to the comments, in my opinion, everything is already so obvious. </font><font style="vertical-align: inherit;">It remains only to add the patch and delete methods and export our api:</font></font><br>
<br>
<pre><code class="javascript hljs">api.patch(<span class="hljs-string">"/:id"</span>, (ctx) =&gt; {
  <span class="hljs-keyword">const</span> todo = {
    <span class="hljs-attr">text</span>: ctx.req.body.text,
    <span class="hljs-attr">done</span>: ctx.req.body.done,<font></font>
  };<font></font>
<font></font>
  <span class="hljs-keyword">return</span> editTodo(ctx.req.params.id <span class="hljs-keyword">as</span> number, todo).then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> result;<font></font>
  });<font></font>
});<font></font>
<font></font>
api.delete(<span class="hljs-string">"/:id"</span>, (ctx) =&gt; {
  <span class="hljs-keyword">return</span> deleteTodo(ctx.req.params.id <span class="hljs-keyword">as</span> number).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    ctx.res.setStatus(<span class="hljs-number">204</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  });<font></font>
});<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api;<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains only to raise our server. </font><font style="vertical-align: inherit;">In the root folder, create a file </font></font><code>server.ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in which we also import Application from denotrain to raise our server:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Application} <span class="hljs-keyword">from</span> <span class="hljs-string">"https://deno.land/x/denotrain@v0.5.0/mod.ts"</span>;
<span class="hljs-keyword">import</span> api <span class="hljs-keyword">from</span> <span class="hljs-string">"./routes/routes.ts"</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Application({<span class="hljs-attr">port</span>: <span class="hljs-number">1337</span>}) <span class="hljs-comment">//      1337</span><font></font>
<font></font>
app.use(<span class="hljs-string">"/api/todos"</span>, api) <span class="hljs-comment">//  ,      </span>
app.run() <span class="hljs-comment">//  </span>
 </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 It is possible that you will have problems in the application. </font><font style="vertical-align: inherit;">I do not want to restart the compiled server manually each time, so I use the analogue of nodemon - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Denomon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which will faithfully recompile your code and restart the server. </font><font style="vertical-align: inherit;">In our case, the following command is suitable:</font></font><br>
<br>
<pre><code class="bash hljs">denomon --allow net,<span class="hljs-built_in">read</span> server.ts
 </code></pre><br>
 <h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My impressions </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 I really enjoyed writing on Deno. Despite some skepticism in his direction, with the help of TypeScript and a well-built development environment, you can achieve great results in writing a highly reliable service that will work as predictable as possible. There is still room to grow (for example, in the speed of recompiling the project) and it‚Äôs too early to try to use Deno for serious production, but I hope the dinosaur will be able to adopt the best from Node.js, slightly change the oddities of architecture, and continue its development. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all in the creation of our API. You can find the whole project </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . You can open Postman and verify that everything is working correctly. By tradition, some useful links: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REST microframework for Deno without dependencies </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejs-engine for Deno</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Deno</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> Deno  Discord</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  Chat App  Deno + React</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Deno  </a><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   </a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en505460/index.html">Pay for training in coding: Russian bachelors can win a scholarship to study for a master's degree in Switzerland</a></li>
<li><a href="../en505462/index.html">Micro data center: why do we need miniature data centers?</a></li>
<li><a href="../en505468/index.html">Email Archiving in Zimbra Collaboration Suite Open-Source Edition</a></li>
<li><a href="../en505470/index.html">Notes of the knowledge manager. How Exness Knowledge Management Works</a></li>
<li><a href="../en505472/index.html">Useful post: Install OpenShift, learn Kafka, use Ansible on Google Cloud Platform</a></li>
<li><a href="../en505478/index.html">Replacing a CRM system with a CRM system</a></li>
<li><a href="../en505488/index.html">12 tips for implementing TypeScript in React applications</a></li>
<li><a href="../en505494/index.html">Developer Framing</a></li>
<li><a href="../en505496/index.html">Flutter Dev Podcast with CTO Meduza Boris Goryachev: the main thing about the Meduz application and media development</a></li>
<li><a href="../en505498/index.html">How we solve the problem of uninitialized stack memory in Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>