<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💗 🦀 📚 PostgreSQL版本升级实践。安德烈·萨尔尼科夫（Andrey Salnikov） 🏠 🔁 🥅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我建议您熟悉安德烈·萨尔尼科夫（Andrei Salnikov）对2018年报告的解码，“更新PostgreSQL版本的实践”
 

在大多数情况下，系统管理员和DBA担心会对数据库版本（RDBMS）进行重大更新，尤其是在该数据库正在运行且负载很高的情况下。造成这种情况的主要原因是某些数据库停机，这...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL版本升级实践。安德烈·萨尔尼科夫（Andrey Salnikov）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495262/"><p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我建议您熟悉安德烈·萨尔尼科夫（Andrei Salnikov）对2018年报告的解码，“更新PostgreSQL版本的实践”</font></font></strong></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在大多数情况下，系统管理员和DBA担心会对数据库版本（RDBMS）进行重大更新，尤其是在该数据库正在运行且负载很高的情况下。</font><font style="vertical-align: inherit;">造成这种情况的主要原因是某些数据库停机，这通常在此类工作的计划中隐含着。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实际上，这种升级需要相当长的时间，并且由于在准备阶段可以避免的琐碎错误，对此类操作经验很少的管理员通常不得不回滚到旧版本的数据库。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Data Egret中，我们在没有错误余地的项目中进行大型PostgreSQL升级方面积累了丰富的经验。我将分享我的经验，并讨论该过程的后续步骤：如何为PostgreSQL升级做准备？在准备阶段需要做什么？如何计划升级本身的行动顺序？如何成功执行升级过程，而又不返回数据库的先前版本？如何最大程度地减少甚至避免整个升级过程中的停机时间？成功升级PostgreSQL后，我需要完成哪些步骤？我还将讨论两种最受欢迎​​的PostgreSQL升级过程pg_upgrade和pg_dump / pg_restore，每种方法的优缺点，并介绍该过程各个阶段的所有典型问题，以及如何避免它们。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于初学者和长期使用PostgreSQL的DBA而言，该报告都将很有趣，但是他们想了解更多有关如何正确计划和尽可能轻松地进行升级的信息。</font></font></p><br>
<p><img src="https://habrastorage.org/webt/qh/px/xd/qhpxxdul2aseoxu2_ohgojxftpu.png"></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">你好！</font><font style="vertical-align: inherit;">我在Data Egret工作。</font><font style="vertical-align: inherit;">我们致力于支持PostgreSQL服务器并提供PostgreSQL咨询服务。</font><font style="vertical-align: inherit;">实践表明，很少有人更新数据库。</font><font style="vertical-align: inherit;">他们启动了该项目，当时安装了当前版本，并且仍在工作。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该报告将包括三个部分。</font><font style="vertical-align: inherit;">第一个是介绍性的术语，目的是为了达成一个通用术语。</font><font style="vertical-align: inherit;">第二个是关于次要更新。</font><font style="vertical-align: inherit;">第三个将涉及专业。</font></font></p><br>
<p><img src="https://habrastorage.org/webt/yb/wk/bv/ybwkbvbiywdppdk19sky8vxd_vk.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该报告的目的是回答问题。</font></font></p><br>
<ul>
<li>  ?   ,  Postgres    .     ,  - .            ,  .       ,    .    .</li>
<li>,       . </li>
<li> ,             ,   .</li>
<li>  ,   : «         ?».   . </li>
<li>       ,          .     ,     production   .</li>
</ul><br>
<p>     ,         Postgres.</p><br>
<p><img src="https://habrastorage.org/webt/9n/6v/uo/9n6vuovta77udhortpo17qcbhqw.png"></p><br>
<p>    ,   ,    .  10        .   ,  ,    ,   –   .</p><br>
<p><img src="https://habrastorage.org/webt/zz/ua/ku/zzuakuky0bgkb0_8pnyuxv56f3q.png"></p><br>
<p>  10-      .     ,  .   –    ,   –   . </p><br>
<p><img src="https://habrastorage.org/webt/o9/rg/d6/o9rgd6cwxfxj2ysv6rrnskysrt8.png"></p><br>
<p>    ?</p><br>
<p> .   ,    –       .      9.6      ,  ,  ,    .    .   . </p><br>
<p> 10-     .   ,      .</p><br>
<p> .    .                ,   . </p><br>
<p>        .             . </p><br>
<p>     –  ,     .  6.    .     ,        . . .    9.2.    ,   ,  9.2  .     9.2,     .</p><br>
<p>       :     .</p><br>
<p><img src="https://habrastorage.org/webt/mk/mj/fo/mkmjfozpligyczlzq19b4u7pudw.png"></p><br>
<p>  .   ,         ,       production :</p><br>
<ul>
<li>    release notes.     ? ,     release notes,   release notes    ,      .   ,    .   - .      ,              ,          .  ,         10- ,     -.   ,  ,   .</li>
<li>       ?  .  ,          .     release notes,      . ,      -  .  , Postgres      ,  ,  .         ,       Postgres,   .</li>
<li>    - ,        ,     ,        ,       production .</li>
<li> ,             –  ,      .    —  ,     ,          ,    .      .</li>
</ul><br>
<p> ,   ,  , .</p><br>
<p><img src="https://habrastorage.org/webt/ft/wd/sx/ftwdsxjongoxcwtzmofeol4flxs.png"></p><br>
<p>    .            .</p><br>
<p>   ,        .         ,      Postgres.     Postgres.</p><br>
<p>  :</p><br>
<ul>
<li>     PostgreSQL.    ,     -  ,   ,  , Postgres   .      .             .         ,   .  Ubuntu, ,       ,  .   start.conf.          .      .</li>
<li>    PostgreSQL  .      ,           ,  common-       .   .</li>
<li> – checkpoint.    checkpoint?      ,        .         ,      ,    ,   .      ,  ,       , , 250 GB,         .         checkpoint,                 Postgres.</li>
<li>  ?    pgbouncer,             ,          .    pgbouncer,  pgbouncer    .  pgbouncer’    –    ,      -       .       latency   . . .     ,      pgbouncer,     .     checkpoint,   pgbouncer,                .</li>
<li>   ,      .            .     ,      .</li>
<li> ,     extensions,    -  extensions.    –          extensions    .   .       .     .      .     . </li>
<li>    (  ,     release notes)      release notes.         –    -  . ,     9.6.1  9.6.6,   ,     release notes  9.6.2 – 9.6.6.      - ,    ,       ,       .</li>
<li>    standby ,   ,          .     ,      14-  ,    2.3     .     .       ,     .    .</li>
</ul><br>
<p>   ,    release notes.</p><br>
<p><img src="https://habrastorage.org/webt/r7/po/fw/r7pofwu2d6pd3sfzov_zbnw-lsq.png"></p><br>
<p>      Postgres.org.    9.6.2.      ,         .</p><br>
<p>    ?        ,                 ,              .           ,                   .         .</p><br>
<p>         .       .  . , , release notes.   .</p><br>
<p><img src="https://habrastorage.org/webt/tp/fm/y4/tpfmy4cemzde9czdxxsr0pljldm.png"></p><br>
<p>    ,      .       . ,  ,     9.6.5.         9.6.1.     ,      .    -   .      ,   –    .     –   .</p><br>
<p>  ,     . . .    bash- ,         .     alter extension, update     .</p><br>
<p><img src="https://habrastorage.org/webt/r0/r8/ek/r0r8ekgtztzazijacgoii-0qpss.png"></p><br>
<p>   ?</p><br>
<ul>
<li> .     .   ,           ,           . </li>
<li>      . ,        ,        ,   release notes.</li>
<li>      . ,     - ,     .    .   .       . </li>
<li>   , . .        .   ,     checkpoint,         30   . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ga/ph/cc/gaphcci6ovprvx85tkdq4ahzvve.png"></p><br>
<p>      –   .</p><br>
<p>    .   ,    .       .</p><br>
<ul>
<li>Pg_dump  restore –      .       ,      .     -    .</li>
<li>Pg_upgrade –    ,   , ,  95 % ,      .      . </li>
<li>     .</li>
</ul><br>
<p>       .</p><br>
<p><img src="https://habrastorage.org/webt/nv/6c/6t/nv6c6tqljcr8ergpes79hmwrjrg.png"></p><br>
<p>   pg_dump      ?</p><br>
<ul>
<li>     .     ,     .   9.5,  ,   10.  Ubuntu   ,  RedHat     –   Postgres.  ,        .</li>
<li>      locale,       .</li>
<li>   Postgres,  ,    ,  ,  ,         .</li>
<li>    ,            pg_dumop.       PostgreSQL.     ?   pg_dump    ,      ,   ,           .    ,             ,       .       .    PostgreSQL, . .  ,  .    ,    .</li>
<li>     .     pg_dump,         .         .    ,       .</li>
<li>        .               .</li>
<li>  ,       ,   ,        PostgreSQL.</li>
</ul><br>
<p>   ,   ,      ,  .</p><br>
<p><img src="https://habrastorage.org/webt/yg/wy/_z/ygwy_zlxpezpbldwtlfbzkfb_ce.png"></p><br>
<p>  pg_dump:</p><br>
<ul>
<li>      .   – .      .</li>
<li>  .    .</li>
<li>   .   :   ,   ,   .    ,    .</li>
<li>      ,      ,              .     .</li>
<li>     .     ,      .       .    SSD-,  SSD-  .                ,     ,  .       .</li>
<li>    .    ,              .        ,   . ,   ,  .     ,          ,       .     .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/0_/qe/9o/0_qe9onjahbwmv3gajs4i5gdbus.png"></p><br>
<p>     ,  pg_upgrade.</p><br>
<ul>
<li>Pg_upgrade        .       , . . ,    .   .</li>
<li>        .       , ,     .</li>
<li>     PostgreSQL.         -,        .</li>
<li>    .      .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/j_/wo/jc/j_wojcl1m25krfsyc4qkq_fjmdo.png"></p><br>
<p> ,   pg_upgrade.        : ,         ,   .</p><br>
<p>,    pg_upgrade,       ,             ,            .    ,     ,         .      .</p><br>
<p>   ,     – pg_upgrade  dump  restore ,   pg_dump, restore     ,       ,      ,      .   .</p><br>
<p>       .      ,       ,           8.4.  Postgres        .</p><br>
<p>    ,            (, 9.0  10)      -.       ,       ,       .      .      ,     .</p><br>
<p><img src="https://habrastorage.org/webt/7l/9t/6a/7l9t6aqjizxpby0hca5onk0d4ci.png"></p><br>
<p>    ,         production. . .      ,    –      .</p><br>
<ul>
<li>     PostgreSQL.</li>
<li>     locace.   .</li>
<li> pg_upgrade.    «check». Check   ,      .   ,     -    ,      ,   , ,                .       ,     .      ,         .</li>
<li>Pg_dumpall — schema-only.     check   .       pg_dumpall – schema-only,     .     ,       .    ,    ,  check      ,  dump .</li>
<li>   extensions   .    –  PostGIS,   PostGIS    Postgres.  extension      Postgres,    Postgres.   changelog   –      ,  pg_upgrade ,         .    dump restore .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/3g/4x/f7/3g4xf7lyqcnvv3hi-bs0fra4wj4.png"></p><br>
<p>  ,  ,   ,  .</p><br>
<ul>
<li><p>    locale,    pg_dumpall only, restore.</p><br>
</li>
<li><p>   .      ,  pgbouncer       , . .    ,   .</p><br>
</li>
<li><p>   checkpoints,          ,     .</p><br>
</li>
<li><p>     pg_upgrade.     ,      .               .      45 .       ,    45 ,    .        15 ,     .         .</p><br>
<p><img src="https://habrastorage.org/webt/et/sy/er/etsyeryqtvdimdjivvq0jx_lrjw.png"></p><br>
</li>
<li><p>   ,       .    hard links.        .</p><br>
<p><img src="https://habrastorage.org/webt/cs/eo/sc/cseoscbeymrk5pjlzwbj9grk_rm.png"></p><br>
</li>
<li><p>    PostgreSQL.        .          PostgreSQL?     .  , pg_upgrade    .</p><br>
</li>
<li><p>     .</p><br>
</li>
<li><p>        .            10 .      ,    .</p><br>
</li>
</ul><br>
<p>     :</p><br>
<ul>
<li><p> pg_upgrade     .    ,          :   ,  10     .</p><br>
</li>
<li><p>         ,       ,   .</p><br>
</li>
<li><p>   9.5     .    ,                .</p><br>
<p><img src="https://habrastorage.org/webt/gi/dm/uk/gidmuk_tnbcrxet3qoghxfvpkd4.png"></p><br>
</li>
<li><p>    .    .        ,    ,     .   ,    vacuumdb    1, 10 .         ,      .  -      .  - .    ,     ,     .</p><br>
</li>
<li><p>    .         ,     .      - .     ,     ,  .         ,  ,         .</p><br>
</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/kr/dh/y9/krdhy9toj4rsxvmlbokhhjaahno.png"></p><br>
<p>     .</p><br>
<p><img src="https://habrastorage.org/webt/o0/-v/_-/o0-v_-tammgsfm23g7spto9w080.png"></p><br>
<ul>
<li>Pg_upgrade   extensions.    ,   .</li>
<li>   release notes  .</li>
<li> ,   ,      extensions      – alter extension EXTENSION_NAME update.  .    pg_stat_statements,   -     .    pg_upgrade,         pg_stat_statements.      .     .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ri/50/6n/ri506n_tl93nkyy_m1-9gtrdtt4.png"></p><br>
<p>    –   ?   :</p><br>
<ul>
<li>  -  - .</li>
<li>  ,     ,    ,    ,  ,  .      .  ,   ,           .</li>
<li>   ?     Postgres.       .     . ,  , , 10  .</li>
<li>          PostgreSQL.</li>
<li> pg_basebackup        .      .</li>
<li>     PostgreSQL.</li>
<li>   ,       rsync,       .   , ,  ,            .   rsync   ,   .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/fe/s_/_i/fes__isx8gdxhkejzomqabxytxc.png"></p><br>
<p>    .   :</p><br>
<ul>
<li>-,        PostgreSQL.</li>
<li>    .   .</li>
</ul><br>
<p>  9.4    .     .   ,    10   11        .</p><br>
<p>   ,   .  Slony-l, Londiste, Bucardo  . .   .</p><br>
<p><img src="https://habrastorage.org/webt/uy/yn/rd/uyynrdnjuv8_go1ttq3rsmsn2ns.png"></p><br>
<p>       ?</p><br>
<ul>
<li>    PostgreSQL.</li>
<li>-         Postgres    Postgres.</li>
<li>  ,  ,        .       .</li>
<li> ,        .    .    ,         Postgres.   ,     , . .     .    ,    .</li>
<li>      Postgres, ,     .</li>
<li>         Postgres,    . ,  ,    .     -  .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/8g/tv/of/8gtvofu-acouuounr5zfnjozen4.png"></p><br>
<p>     ?</p><br>
<ul>
<li>        ,      .  -  .</li>
<li> ,    .     . . . ,    .</li>
<li>     sequences,       -.</li>
<li>    DDL,    .   DDL  ,  ,  .          ,  .</li>
<li>     ,         ,  .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/2a/db/rv/2adbrv0193cxs8sglbod0f8jfnu.png"></p><br>
<p>   ,            .     pg_upgrade      ,      .</p><br>
<p>   ?  ,     3 TB,       2 SSD RAID  3 TB.    .         .</p><br>
<p>         .    .</p><br>
<p> ,    ,      99  - 9-  .    15 .       15    .  .        - .</p><br>
<p><img src="https://habrastorage.org/webt/bq/sl/ie/bqsliego7mt3nyx__tfzyrrlwb8.png"></p><br>
<p>     ,       pg_upgrade.      .         .</p><br>
<p>    .</p><br>
<p></p><br>
<p><em> !    pgbouncer     ,       , , ,    ,   .      ?</em></p><br>
<p>       ,        SSD  .         SSD   , . .     .       . , , ,  ,    .  ,     ,      .    ,      Postgres.      ,   .</p><br>
<p><em>   pg_worm  pg_hibernate,    ?</em></p><br>
<p> ,       ,      .</p><br>
<p><em>  !        pg_upgrade?</em></p><br>
<p> , .        ,   .       ,    .    ,     ,  -  ,    .        ,     ,    .        ,    .</p><br>
<p><em>  rsync -?</em></p><br>
<p>  rsync? Rsync     .  ,       ,   , , .    ?      pg_upgrate   .  ,  .     – pg_start_backup.     rsync    .     -  ,    rsync   ,   .   ,          , ,  tablespace  HDD,  rsync  ,      .     –  ,  .    ,         .  –  pg_basebackup.</p><br>
<p><em>  !   ,     …</em></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这适用于次要更新。</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN495248/index.html">自我隔离和洗手的作用</a></li>
<li><a href="../zh-CN495250/index.html">游戏手柄有未来吗？</a></li>
<li><a href="../zh-CN495254/index.html">模拟目标网络攻击，红队，Pentest和漏洞扫描。各种方法的利弊</a></li>
<li><a href="../zh-CN495256/index.html">关于邮件服务器中的端口和加密</a></li>
<li><a href="../zh-CN495258/index.html">Zoom如何成为冠状病毒时代最重要的公司</a></li>
<li><a href="../zh-CN495266/index.html">文艺复兴时期的在线学习。为什么2020年将显示远程学习的所有优势</a></li>
<li><a href="../zh-CN495268/index.html">UI / UX案例：机场停车自动化</a></li>
<li><a href="../zh-CN495272/index.html">SNES模拟器离绝对完美只有几个像素</a></li>
<li><a href="../zh-CN495274/index.html">如何修复路线泄漏</a></li>
<li><a href="../zh-CN495276/index.html">并演示或证明我们如何通过Uptime Institute的运营可持续性审核</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>