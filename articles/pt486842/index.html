<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüíª üôÜüèº üòó Consul + iptables =: 3 ü§µüèø üïó ‚ùóÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em 2010, a Wargaming tinha 50 servidores e um modelo de rede simples: back-end, front-end e firewall. O n√∫mero de servidores aumentou, o modelo ficou ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Consul + iptables =: 3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486842/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em 2010, a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wargaming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tinha 50 servidores e um modelo de rede simples: back-end, front-end e firewall. O n√∫mero de servidores aumentou, o modelo ficou mais complicado: VLANs tempor√°rias e isoladas com ACLs, depois VPNs com VRF, VLANs com ACLs para L2, VRFs de ACLs para L3. Cabe√ßa est√° girando? Mais ser√° mais divertido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando os servidores come√ßaram a trabalhar 16.000 sem l√°grimas com tantos segmentos heterog√™neos, tornou-se imposs√≠vel. Portanto, eles criaram uma solu√ß√£o diferente. Pegamos a pilha do Netfilter, adicionamos o Consul como fonte de dados e obtivemos um firewall distribu√≠do rapidamente. Eles substitu√≠ram a ACL nos roteadores e usados ‚Äã‚Äãcomo um firewall externo e interno. Para o gerenciamento din√¢mico de ferramentas, desenvolvemos o sistema BEFW, que era usado em todos os lugares: desde o controle do acesso do usu√°rio √† rede de supermercados at√© o isolamento dos segmentos de rede.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/wg/bd/odwgbdlxcjww7ln1u_btv23hyvq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como tudo funciona e por que voc√™ deve examinar mais de perto esse sistema, diz </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ivan Agarkov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">annmuor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - o chefe do grupo de seguran√ßa de infraestrutura da unidade de Manuten√ß√£o no centro de desenvolvimento da empresa de Minsk. </font><font style="vertical-align: inherit;">Ivan √© um f√£ do SELinux, ama Perl, escreve c√≥digo. </font><font style="vertical-align: inherit;">Como chefe do grupo IB, ele trabalha regularmente com logs, backups e P&amp;D para proteger a Wargaming de hackers e garantir a opera√ß√£o de todos os servidores de jogos da empresa.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4zP67uYnsR4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncia hist√≥rica</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de contar como fizemos, vou contar como chegamos a isso e por que era necess√°rio. Para fazer isso, transferimos 9 anos atr√°s: 2010, apenas o World of Tanks apareceu. A Wargaming tinha aproximadamente 50 servidores. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e6/qf/6h/e6qf6hugl_efcmn73qn16mcyeoc.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√°fico de crescimento dos servidores da empresa.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tivemos um modelo de rede. Durante esse tempo, foi √≥timo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/zw/vj/bizwvjhrfphzbrhme6v1avzjxag.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O modelo de rede em 2010.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
No front-end, existem bandidos que querem nos quebrar, mas h√° um firewall nele. N√£o h√° firewall no back-end, mas existem 50 servidores l√°, todos n√≥s os conhecemos. Tudo funciona bem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao longo de 4 anos, a frota de servidores cresceu 100 vezes, at√© 5000. As primeiras redes isoladas apareceram - parando: elas n√£o podem entrar em produ√ß√£o e, muitas vezes, coisas perigosas estavam girando l√°. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z0/6e/ba/z06ebavv-r6yu7fuhy2zvvhsnw0.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo de rede em 2014.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por in√©rcia, todas as mesmas pe√ßas de ferro foram usadas e todo o trabalho foi realizado em VLANs isoladas: as ACLs s√£o gravadas na VLAN que permitem ou pro√≠bem qualquer conex√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em 2016, o n√∫mero de servidores chegou a 8000. A Wargaming absorveu outros est√∫dios, surgiram redes afiliadas adicionais. Eles parecem ser nossos, mas n√£o exatamente: a VLAN geralmente n√£o funciona para parceiros, voc√™ precisa usar uma VPN com VRF, o isolamento se torna mais complicado. Uma mistura de isolados de LCA cresceu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w-/zj/ej/w-zjej3fr8frinvbg4z1thbwdre.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O modelo de rede em 2016.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
No in√≠cio de 2018, a frota de carros cresceu para 16.000. Havia 6 segmentos e o restante n√£o contabilizamos, incluindo os fechados, nos quais os dados financeiros eram armazenados. Existem redes de cont√™iner (Kubernetes), DevOps, redes em nuvem conectadas via VPN, por exemplo, a partir do IVS. Havia muitas regras - do√≠a. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/zf/cd/ivzfcdz9lzxsiugegpfthzwubik.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo de rede e m√©todos de isolamento em 2018.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para isolamento, usamos: VLAN com ACL em L2, VRF com ACL em L3, VPN e muito mais. </font><font style="vertical-align: inherit;">Demais.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo mundo vive com ACLs e VLANs. </font><font style="vertical-align: inherit;">O que geralmente est√° errado? </font><font style="vertical-align: inherit;">Harold, escondendo a dor, responder√° a essa pergunta. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y2/hi/tl/y2hitlbrqlvcbm6rjg59tzaaqxw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Havia muitos problemas, mas havia cinco grandes.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aumentos de pre√ßos geom√©tricos para as novas regras</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cada nova regra foi adicionada por mais tempo que a anterior, porque era necess√°rio primeiro verificar se j√° havia essa regra.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o h√° firewall dentro dos segmentos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Os segmentos foram de alguma forma separados um do outro, por dentro j√° n√£o h√° recursos suficientes.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As regras s√£o aplicadas h√° muito tempo. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√£os que um operador de regra local pode escrever em uma hora. </font><font style="vertical-align: inherit;">Global levou v√°rios dias.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dificuldades com a auditoria das regras</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais precisamente, n√£o foi poss√≠vel. </font><font style="vertical-align: inherit;">As primeiras regras foram escritas em 2010 e a maioria de seus autores n√£o trabalhava mais para a empresa.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baixo n√≠vel de controle sobre a infraestrutura</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esse √© o principal problema - n√£o sab√≠amos bem o que estava acontecendo conosco.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que o engenheiro de rede era em 2018 quando ouviu: "Precisamos de mais ACLs".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/rl/_i/hhrl_ig_xefe7lps5yrz_liioam.png" width="350"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solu√ß√µes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No in√≠cio de 2018, foi decidido fazer algo a respeito. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O pre√ßo da integra√ß√£o est√° em constante crescimento.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O ponto de partida foi que grandes centros de dados n√£o eram mais compat√≠veis com VLANs e ACLs isoladas, porque a mem√≥ria dos dispositivos acabou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solu√ß√£o: removeu o fator humano e automatizou a provis√£o de acesso ao m√°ximo. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Novas regras se aplicam por um longo tempo.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solu√ß√£o: agilize a aplica√ß√£o das regras, torne-a distribu√≠da e paralela. Para fazer isso, voc√™ precisa de um sistema distribu√≠do para que as regras sejam entregues por conta pr√≥pria, sem rsync ou SFTP por mil sistemas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A falta de um firewall dentro dos segmentos.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O firewall dentro dos segmentos come√ßou a voar para n√≥s quando diferentes servi√ßos apareceram na mesma rede. Solu√ß√£o: use um firewall baseado em host. Em quase todos os lugares onde temos Linux, e o iptables est√° em todo lugar, isso n√£o √© um problema. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dificuldades com a auditoria das regras.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solu√ß√£o: mantenha todas as regras em um √∫nico local para revis√£o e gerenciamento, para que possamos auditar tudo. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baixo n√≠vel de controle sobre a infraestrutura.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solu√ß√£o: fa√ßa um invent√°rio de todos os servi√ßos e acessos entre eles.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© mais um processo administrativo do que t√©cnico. </font><font style="vertical-align: inherit;">√Äs vezes, temos de 200 a 300 novos lan√ßamentos por semana, especialmente durante promo√ß√µes e feriados. </font><font style="vertical-align: inherit;">No entanto, isso √© apenas para uma equipe de nossos DevOps. </font><font style="vertical-align: inherit;">Com tantas vers√µes, √© imposs√≠vel ver que tipo de portas, IP e integra√ß√£o s√£o necess√°rias. </font><font style="vertical-align: inherit;">Portanto, precis√°vamos de gerentes de servi√ßo especialmente treinados que entrevistaram as equipes: "O que h√° e por que voc√™ o criou?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de tudo o que lan√ßamos, o engenheiro de rede em 2019 come√ßou a ficar assim.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/fx/qi/yvfxqisjbogjxfy6czj0p6xmvuw.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√¥nsul</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidimos que colocar√≠amos tudo o que encontr√°ssemos com a ajuda de gerentes de servi√ßo no Consul e, a partir da√≠, escrever√≠amos regras do iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como decidimos fazer isso?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coletamos todos os servi√ßos, redes e usu√°rios.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos criar regras do iptables baseadas nelas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatize o controle.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LUCRO.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Consul n√£o √© uma API remota; pode trabalhar em todos os n√≥s e gravar no iptables. </font><font style="vertical-align: inherit;">Resta apenas criar controles autom√°ticos que limpem o excesso e a maioria dos problemas ser√° resolvida! </font><font style="vertical-align: inherit;">Finalizaremos o restante do processo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que c√¥nsul?</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem estabelecido.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Em 2014-15, usamos como back-end para o Vault, no qual armazenamos senhas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o perde dados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Durante o uso, o Consul n√£o perdeu dados em nenhum acidente. Esta √© uma enorme vantagem para o sistema de gerenciamento de firewall. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As comunica√ß√µes P2P aceleram a propaga√ß√£o da mudan√ßa</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Com o P2P, todas as altera√ß√µes s√£o r√°pidas, sem a necessidade de esperar horas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API REST conveniente.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tamb√©m consideramos o Apache ZooKeeper, mas ele n√£o possui uma API REST, voc√™ precisar√° colocar muletas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funciona como um keystore (KV) e como um diret√≥rio (Service Discovery)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Voc√™ pode armazenar imediatamente servi√ßos, cat√°logos, data centers. Isso √© conveniente n√£o apenas para n√≥s, mas tamb√©m para as equipes vizinhas, porque ao criar um servi√ßo global, pensamos grande.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escrito em Go, que faz parte da pilha Wargaming. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adoramos esse idioma, temos muitos desenvolvedores do Go. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poderoso sistema ACL. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No Consul, voc√™ pode usar ACLs para gerenciar quem e o que escrever. </font><font style="vertical-align: inherit;">Garantimos que as regras do firewall n√£o se sobrep√µem a mais nada e n√£o teremos problemas com isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas a Consul tem suas desvantagens.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o √© escal√°vel no data center, se voc√™ n√£o tiver uma vers√£o comercial. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â dimensionado apenas pela federa√ß√£o.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muito dependente da qualidade da rede e da carga do servidor. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Consul n√£o funcionar√° normalmente como um servidor em um servidor ocupado se houver atrasos na rede, por exemplo, velocidade irregular. </font><font style="vertical-align: inherit;">Isso ocorre devido √†s conex√µes P2P e aos modelos de distribui√ß√£o de atualiza√ß√£o.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dificuldades com o monitoramento da acessibilidade</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No status de c√¥nsul pode dizer que est√° tudo bem, mas ele morreu h√° muito tempo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resolvemos a maioria desses problemas durante a opera√ß√£o do Consul, ent√£o escolhemos. </font><font style="vertical-align: inherit;">A empresa tem planos para um back-end alternativo, mas aprendemos a lidar com problemas e ainda moramos com a Consul.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como funciona o c√¥nsul</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No data center condicional, instalamos servidores - de tr√™s a cinco. </font><font style="vertical-align: inherit;">Um ou dois servidores n√£o funcionar√£o: eles n√£o poder√£o organizar um quorum e decidir quem est√° certo, quem est√° errado, quando os dados n√£o coincidem. </font><font style="vertical-align: inherit;">Mais de cinco n√£o faz sentido, o desempenho cair√°. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/bb/ms/ljbbms9ipssmvl-pooll-judvgs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os clientes se conectam em qualquer ordem aos servidores: os mesmos agentes, apenas com um sinalizador </font></font><code>server = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jx/ku/ub/jxkuubjet3kolzk07yqq0qkak8m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, os clientes recebem uma lista de conex√µes P2P e constroem conex√µes entre si. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/st/ca/owstcacfv-iuaz42vdlyk1cmes8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No n√≠vel global, estamos interconectando v√°rios data centers. </font><font style="vertical-align: inherit;">Eles tamb√©m conectam P2P e se comunicam. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gx/5r/s5/gx5rs5yetwzbe63odrgx6ppfnm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando queremos coletar dados de outro data center, a solicita√ß√£o passa de servidor para servidor. </font><font style="vertical-align: inherit;">Esse esquema √© chamado de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">protocolo Serv</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O protocolo Serf, como o Consul, √© desenvolvido pela HashiCorp.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alguns fatos importantes sobre o Consul</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√¥nsul tem documenta√ß√£o descrevendo seu trabalho. </font><font style="vertical-align: inherit;">Darei apenas fatos selecionados que valem a pena conhecer. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os servidores do Consul selecionam mestres entre os eleitores</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O Consul seleciona o assistente na lista de servidores para cada datacenter e todas as solicita√ß√µes s√£o direcionadas apenas a ele, independentemente do n√∫mero de servidores. </font><font style="vertical-align: inherit;">Pendurar o mago n√£o leva √† reelei√ß√£o. </font><font style="vertical-align: inherit;">Se o assistente n√£o estiver selecionado, as solicita√ß√µes n√£o ser√£o atendidas por ningu√©m.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deseja escala horizontal? </font><font style="vertical-align: inherit;">Lamento mas n√£o.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma solicita√ß√£o para outro data center passa de mestre para mestre, independentemente de qual servidor ele veio. </font><font style="vertical-align: inherit;">O mestre selecionado recebe 100% da carga, exceto a carga nas solicita√ß√µes de encaminhamento. </font><font style="vertical-align: inherit;">Todos os servidores do datacenter t√™m uma c√≥pia atualizada dos dados, mas apenas uma responde.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A √∫nica maneira de escalar √© ativar o modo obsoleto no cliente.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No modo obsoleto, voc√™ pode responder sem quorum. Esse √© um modo no qual recusamos a consist√™ncia dos dados, mas lemos um pouco mais r√°pido que o normal e qualquer servidor responde. Naturalmente, a grava√ß√£o √© apenas atrav√©s do mestre. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Consul n√£o copia dados entre data centers</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ao coletar federa√ß√£o, cada servidor ter√° apenas seus pr√≥prios dados. Para outros, ele sempre se volta para outra pessoa. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A atomicidade das opera√ß√µes n√£o √© garantida fora da transa√ß√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Lembre-se de que n√£o apenas voc√™ pode mudar alguma coisa. Se voc√™ desejar de maneira diferente, realize uma transa√ß√£o com um bloqueio. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As opera√ß√µes de bloqueio n√£o garantem o bloqueio</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A solicita√ß√£o vai de mestre para mestre, e n√£o diretamente, portanto, n√£o h√° garantia de que o bloqueio funcione quando voc√™ bloquear, por exemplo, em outro datacenter.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As ACLs tamb√©m n√£o garantem o acesso (em muitos casos)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A ACL pode n√£o funcionar porque est√° armazenada em um datacenter da federa√ß√£o - no datacenter da ACL (DC Prim√°rio). Se o controlador de dom√≠nio n√£o responder, a ACL n√£o funcionar√°. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um assistente pairando congelar√° toda a federa√ß√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por exemplo, na federa√ß√£o h√° 10 data centers, e em um h√° uma rede ruim e um mestre cai. Todo mundo que se comunica com ele fica preso em um c√≠rculo: um pedido est√° sendo feito, n√£o h√° resposta, o fio trava. N√£o ser√° poss√≠vel descobrir quando isso acontecer√°, em apenas uma ou duas horas a federa√ß√£o inteira cair√°. Voc√™ n√£o pode fazer nada sobre isso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Status, quorum e elei√ß√µes s√£o processados ‚Äã‚Äãem um thread separado. </font><font style="vertical-align: inherit;">A re-sele√ß√£o n√£o ocorrer√°, o status n√£o mostrar√° nada. </font><font style="vertical-align: inherit;">Voc√™ acha que tem um c√¥nsul ativo, voc√™ pergunta, e nada acontece - n√£o h√° resposta. </font><font style="vertical-align: inherit;">Al√©m disso, o status mostra que est√° tudo bem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfrentamos esse problema, tivemos que reconstruir partes espec√≠ficas dos data centers para evit√°-lo. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A vers√£o comercial do Consul Enterprise n√£o possui alguns dos inconvenientes acima</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tem muitas fun√ß√µes √∫teis: vota√ß√£o, distribui√ß√£o, dimensionamento. </font><font style="vertical-align: inherit;">Existe apenas um "mas" - um sistema de licenciamento para um sistema distribu√≠do √© muito caro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Life hack: </font></font><code>rm -rf /var/lib/consul</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- uma cura para todas as doen√ßas do agente. </font><font style="vertical-align: inherit;">Se algo n√£o funcionar para voc√™, basta excluir seus dados e fazer o download dos dados da c√≥pia. </font><font style="vertical-align: inherit;">Provavelmente, o Consul funcionar√°.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Befw</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos falar sobre o que adicionamos ao Consul. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BEFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - um acr√¥nimo para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bed and</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ack </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nd </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a F</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a ira de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o W</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> todos. </font><font style="vertical-align: inherit;">Era necess√°rio, de alguma forma, nomear o produto quando eu criei o reposit√≥rio para colocar o primeiro teste confirmado nele. </font><font style="vertical-align: inherit;">Este nome permanece.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelos de regras</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As regras s√£o escritas na sintaxe do iptables.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-N BEFW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-P INPUT DROP</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A INPUT -m state - state RELACIONADO, ESTABELECIDO -j ACEITA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A ENTRADA -i lo -j ACEITA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A ENTRADA -j BEFW</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos n√≥s vamos para a cadeia BEFW, exceto </font></font><code>ESTABLISHED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RELATED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e localhost. </font><font style="vertical-align: inherit;">O modelo pode ser qualquer coisa, este √© apenas um exemplo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que serve o BEFW?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servi√ßos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos um servi√ßo, ele sempre tem uma porta, o n√≥ no qual trabalha. </font><font style="vertical-align: inherit;">No nosso n√≥, podemos solicitar localmente ao agente e descobrir que temos algum tipo de servi√ßo. </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode colocar tags. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/lc/7n/fmlc7n4h4rmyqbeemb7lcn6lzco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qualquer servi√ßo que esteja sendo executado e registrado no Consul se tornar√° uma regra do iptables. </font><font style="vertical-align: inherit;">Temos SSH - porta aberta 22. O script bash √© simples: curl e iptables, nada mais √© necess√°rio.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clientes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como abrir o acesso n√£o a todos, mas seletivamente? </font><font style="vertical-align: inherit;">Pelo nome do servi√ßo, adicione listas de IPs ao reposit√≥rio KV. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pg/y4/nu/pgy4nufltcqaimdqv7ncfpntix0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, queremos que todos da d√©cima rede possam acessar o servi√ßo SSH_TCP_22. </font><font style="vertical-align: inherit;">Adicionar um pequeno campo TTL? </font><font style="vertical-align: inherit;">e agora temos permiss√µes tempor√°rias, por exemplo, por um dia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acessos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectamos servi√ßos e clientes: temos um servi√ßo, pois cada armazenamento KV est√° pronto. </font><font style="vertical-align: inherit;">Agora, damos acesso n√£o a todos, mas de forma seletiva.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/yo/vn/f1yovnkwz7qddj1sw267obg3gvk.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grupos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se toda vez que escrevermos milhares de IPs para acessos, ficaremos cansados. </font><font style="vertical-align: inherit;">Vamos criar agrupamentos - um subconjunto separado em KV. </font><font style="vertical-align: inherit;">Vamos cham√°-lo de Alias ‚Äã‚Äã(ou grupos) e armazenaremos grupos l√° de acordo com o mesmo princ√≠pio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/un/um/vzunum6qz9s9fs8odlwiwlz6vsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectar: ‚Äã‚Äãagora podemos abrir o SSH n√£o especificamente no P2P, mas em um grupo inteiro ou em v√°rios grupos. </font><font style="vertical-align: inherit;">Da mesma forma, existe TTL - voc√™ pode adicionar e remover temporariamente do grupo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/2w/as/ao2was0eioehjrwnn1ypgh4zj5w.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integra√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso problema √© o fator humano e a automa√ß√£o. At√© agora, resolvemos assim. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/pv/j0/8gpvj0liyxy64mamjpwr8nbn4xc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabalhamos com o Puppet e transferimos tudo relacionado ao sistema (c√≥digo do aplicativo) para ele. O Puppetdb (PostgreSQL regular) armazena uma lista de servi√ßos que est√£o sendo executados l√°, voc√™ pode encontr√°-los por tipo de recurso. L√° voc√™ pode encontrar quem vai aonde. Tamb√©m temos um sistema de solicita√ß√£o pull e de mesclagem para isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escrevemos befw-sync, a solu√ß√£o mais simples que ajuda a transferir dados. Primeiro, os cookies de sincroniza√ß√£o v√£o para puppetdb. A API HTTP est√° configurada l√°: perguntamos quais servi√ßos temos, o que precisa ser feito. Ent√£o eles fazem um pedido ao c√¥nsul.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe integra√ß√£o? </font><font style="vertical-align: inherit;">Sim: eles escreveram as regras, com permiss√£o para aceitar a solicita√ß√£o de recebimento. </font><font style="vertical-align: inherit;">Precisa de alguma porta ou adicionar um host a algum grupo? </font><font style="vertical-align: inherit;">Solicite, analise - n√£o mais "Encontre 200 outras ACLs e tente fazer algo a respeito."</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otimiza√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ping do host local com uma cadeia de regras vazia leva 0,075 ms. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/6p/ce/_j6pceeghhejvrabuazobzgbfmw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicione 10.000 tabelas de ip a essa cadeia. </font><font style="vertical-align: inherit;">Como resultado, o ping aumentar√° 5 vezes: o iptables √© completamente linear, o processamento de cada endere√ßo leva algum tempo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/v9/ic/erv9ic34w6oqhoy7aekpfimpys4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o firewall, para o qual migramos milhares de ACLs, temos muitas regras, e isso introduz um atraso. </font><font style="vertical-align: inherit;">Para protocolos de jogos, isso √© ruim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas se colocarmos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.000 endere√ßos no ipset, o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ping diminuir√° ainda mais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_l/zb/qs/_lzbqsckkctv-01v3vu-irjhvcq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ponto √© que o "O" (complexidade do algoritmo) para o ipset √© sempre 1, n√£o importa quantas regras existam. </font><font style="vertical-align: inherit;">√â verdade que h√° uma limita√ß√£o - n√£o pode haver mais de 65535 regras. Por enquanto, vivemos com isso: voc√™ pode combin√°-las, expandi-las e criar dois ipsets em um.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Armazenamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continua√ß√£o l√≥gica do processo de itera√ß√£o √© o armazenamento de informa√ß√µes do cliente para o servi√ßo no ipset. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/up/dv/x0updv72n35faryycb_ntjmpqik.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora temos o mesmo SSH e n√£o escrevemos imediatamente 100 IP, mas definimos o nome do ipset para se comunicar e a regra a seguir </font></font><code>DROP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Voc√™ pode refazer a regra "Quem n√£o est√° aqui, isso √© DROP", mas com mais clareza. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora temos regras e conjuntos. </font><font style="vertical-align: inherit;">A principal tarefa √© fazer um conjunto antes de escrever a regra, porque, caso contr√°rio, o iptables n√£o gravar√° a regra.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema geral</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na forma de um diagrama, tudo o que eu disse se parece com isso. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/qa/i-/9wqai-52aq3i3onq1dovwbfzpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comprometa-se com o Puppet, tudo √© enviado para o host, os servi√ßos est√£o aqui, o ipset est√° l√° e quem n√£o est√° registrado l√° n√£o √© permitido.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permitem negar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para salvar rapidamente o mundo ou desligar rapidamente algu√©m, no in√≠cio de todas as correntes, fizemos dois ipset: </font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>rules_deny</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como funciona? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, algu√©m com bots cria uma carga em nossa Web. </font><font style="vertical-align: inherit;">Anteriormente, era necess√°rio encontrar seu IP pelos logs, encaminh√°-lo aos engenheiros de rede para que eles pudessem encontrar a fonte do tr√°fego e bani-lo. </font><font style="vertical-align: inherit;">Agora parece diferente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a6/so/xq/a6soxqdkwf8qokucl-ztjs6xdde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s enviamos para o Consul, espere 2,5 s e pronto. </font><font style="vertical-align: inherit;">Como o Consul distribui rapidamente por meio do P2P, ele funciona em qualquer lugar e em qualquer lugar do mundo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma vez parei completamente o WOT, cometendo um erro com o firewall. </font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Este √© o nosso seguro contra esses casos. </font><font style="vertical-align: inherit;">Se cometemos um erro com o firewall em algum lugar, algo est√° bloqueado em algum lugar, sempre podemos enviar um condicional </font></font><code>0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para aumentar tudo rapidamente. </font><font style="vertical-align: inherit;">Ent√£o vamos consertar tudo com as m√£os.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outros conjuntos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode adicionar outros conjuntos no espa√ßo </font></font><code>$IPSETS$</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/md/hv/jf/mdhvjfb8t36heje-udbnw5fly0m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pelo que? </font><font style="vertical-align: inherit;">√Äs vezes, algu√©m precisa de um ipset, por exemplo, para emular a desconex√£o de alguma parte do cluster. </font><font style="vertical-align: inherit;">Todos podem trazer quaisquer conjuntos, ligar para eles e eles ser√£o retirados do Consul. </font><font style="vertical-align: inherit;">Ao mesmo tempo, os conjuntos podem participar das regras do iptables e ser como uma equipe </font></font><code>NOOP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: a consist√™ncia ser√° suportada pelo daemon.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comercial</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Costumava ser assim: um usu√°rio conectado a uma rede e recebido par√¢metros atrav√©s de um dom√≠nio. </font><font style="vertical-align: inherit;">At√© a pr√≥xima gera√ß√£o de firewalls, a Cisco n√£o conseguia entender onde o usu√°rio est√° e onde est√° o IP. </font><font style="vertical-align: inherit;">Portanto, o acesso foi concedido apenas atrav√©s de m√°quinas de nome de host. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que nos fizemos? </font><font style="vertical-align: inherit;">Casado no momento de receber o endere√ßo. </font><font style="vertical-align: inherit;">Geralmente √© dot1x, Wi-Fi ou VPN - tudo passa pelo RADIUS. </font><font style="vertical-align: inherit;">Para cada usu√°rio, crie um grupo por nome de usu√°rio e insira um IP com TTL, que √© igual ao dhcp.lease - assim que expirar, a regra desaparecer√°. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/ps/ad/tfpsad3jh-egdfn_uehr3yvmcao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora podemos abrir o acesso aos servi√ßos, bem como a outros grupos, por nome de usu√°rio. </font><font style="vertical-align: inherit;">N√≥s nos livramos da dor com o nome do host quando eles mudam e tiramos a carga dos engenheiros de rede porque eles n√£o precisavam mais da Cisco. </font><font style="vertical-align: inherit;">Agora, os pr√≥prios engenheiros prescrevem o acesso aos seus servidores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isolamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paralelamente, come√ßamos a desmontar o isolamento. </font><font style="vertical-align: inherit;">Os gerentes de servi√ßo fizeram um invent√°rio e analisamos todas as nossas redes. </font><font style="vertical-align: inherit;">N√≥s os decompomos nos mesmos grupos e, nos servidores necess√°rios, os grupos foram adicionados, por exemplo, para negar. </font><font style="vertical-align: inherit;">Agora, o mesmo isolamento de prepara√ß√£o entra em regras_deny na produ√ß√£o, mas n√£o na produ√ß√£o em si. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fd/9g/ed/fd9gedlbs2_9gyyg-5lwm_fp75m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O esquema funciona de maneira r√°pida e simples: remova todas as ACLs dos servidores, descarregue o hardware, reduza o n√∫mero de VLANs isoladas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controle de integridade</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, um gatilho especial funcionava para n√≥s, informando quando algu√©m alterava a regra do firewall com as m√£os. </font><font style="vertical-align: inherit;">Eu escrevi um enorme verificador de regras de firewall, foi dif√≠cil. </font><font style="vertical-align: inherit;">Agora a integridade controla o BEFW. </font><font style="vertical-align: inherit;">Ele zelosamente garante que as regras que ele faz n√£o mudem. </font><font style="vertical-align: inherit;">Se algu√©m alterar as regras do firewall, ele retornar√° tudo de volta. </font><font style="vertical-align: inherit;">"Eu rapidamente criei um proxy aqui para trabalhar em casa" - n√£o existem mais essas op√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O BEFW controla o ipset dos servi√ßos e lista em befw.conf, as regras de servi√ßo na cadeia do BEFW. </font><font style="vertical-align: inherit;">Mas n√£o segue outras cadeias e regras e outro ipset.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prote√ß√£o contra acidentes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O BEFW sempre salva o √∫ltimo estado de sucesso diretamente na estrutura bin√°ria de state.bin. Se algo desse errado, ele sempre volta a esse estado.bin. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2z/fe/ru/2zferuy2qiohwpa6odt1s0d642g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© o seguro inst√°vel do c√¥nsul quando ele n√£o enviou dados ou algu√©m cometeu um erro e usou regras que n√£o podiam ser aplicadas. Para que n√£o fiquemos sem um firewall, o BEFW retornar√° ao √∫ltimo estado se ocorrer um erro em algum momento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em situa√ß√µes cr√≠ticas, √© uma garantia de que permaneceremos com um firewall em funcionamento. Abrimos todas as redes cinzentas na esperan√ßa de que o administrador venha e corrija-o. Algum dia eu o retirarei nas configura√ß√µes, mas agora temos apenas tr√™s redes cinzentas: 10/8, 172/12 e 192.168 / 16. Como parte do nosso c√¥nsul, esse √© um recurso importante que ajuda a se desenvolver ainda mais.</font></font><br>
<br>
<em>:      -  BEFW.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> GitHub</a>.</em><br>
<br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou falar sobre os bugs que encontramos. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset add set 0.0.0.0/0.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O que acontece se voc√™ adicionar ao ipset 0.0.0.0/0? Todos os IPs ser√£o adicionados? O acesso √† Internet ser√° aberto? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o, temos um bug que nos custa duas horas de inatividade. Al√©m disso, o bug n√£o funciona desde 2016, est√° no RedHat Bugzilla sob o n√∫mero # 1297092, mas o encontramos por acidente - a partir do relat√≥rio do desenvolvedor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, o BEFW possui uma regra estrita, que se </font></font><code>0.0.0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transforma em dois endere√ßos: </font></font><code>0.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>128.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conjunto de restaura√ß√£o ipset &lt;arquivo.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O que o ipset faz quando voc√™ conta </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Voc√™ acha que funciona como o iptables? Recuperar dados? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nada disso - ele faz uma mesclagem e os endere√ßos antigos n√£o desaparecem, voc√™ n√£o fecha o acesso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encontramos um bug quando testamos o isolamento. Agora existe um sistema bastante complicado - em vez de ser </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">executado </font></font><code>create temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ent√£o </font></font><code>restore flush temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>restore temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. No final da troca: por atomicidade, porque se voc√™ executar pela primeira vez </font></font><code>flush</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e nesse momento algum pacote chegar, ele ser√° descartado e algo dar√° errado. Portanto, h√° um pouco de magia negra. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consul kv get -datacenter = outro.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como eu disse, pensamos que estamos solicitando alguns dados, mas obteremos dados ou um erro. Podemos fazer isso atrav√©s do Consul localmente, mas, neste caso, um e outro ir√£o travar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O cliente Consul local √© um inv√≥lucro sobre a API HTTP. Mas ele simplesmente trava e n√£o responde Ctrl + C ou Ctrl + Z, n√£o importa o qu√™, apenas</font></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no console adjacente. </font><font style="vertical-align: inherit;">Nos deparamos com isso quando est√°vamos construindo um grande cluster. </font><font style="vertical-align: inherit;">Mas ainda n√£o temos solu√ß√£o, estamos nos preparando para corrigir esse erro no Consul. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O l√≠der do c√¥nsul n√£o est√° respondendo. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nosso mestre no data center n√£o responde, pensamos: "Provavelmente, o algoritmo de re-sele√ß√£o funcionar√° agora?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o, n√£o funcionar√° e o monitoramento n√£o mostrar√° nada: a Consul ir√° dizer que existe um √≠ndice de comprometimento, um l√≠der foi encontrado, est√° tudo bem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como estamos lutando contra isso? </font></font><code>service consul restart</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no cron a cada hora. </font><font style="vertical-align: inherit;">Se voc√™ tem 50 servidores - n√£o √© grande coisa. </font><font style="vertical-align: inherit;">Quando houver 16.000, voc√™ entender√° como isso funciona.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtivemos as seguintes vantagens:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100% de cobertura de todas as m√°quinas Linux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rapidez.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automa√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Engenheiros de ferro e rede libertados da escravid√£o.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Existem oportunidades de integra√ß√£o quase infinitas: mesmo com o Kubernetes, mesmo com o Ansible, mesmo com o Python.</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contras</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Consul, com quem agora vivemos, e um pre√ßo muito alto de erro. </font><font style="vertical-align: inherit;">Como exemplo, uma vez √†s 18 horas (hor√°rio nobre na R√∫ssia), eu decidi algo nas listas de redes. </font><font style="vertical-align: inherit;">Est√°vamos construindo isolamento no BEFW naquele momento. </font><font style="vertical-align: inherit;">Parece que eu estava enganado em algum lugar, indiquei a m√°scara errada, mas tudo caiu em dois segundos. </font><font style="vertical-align: inherit;">O monitoramento acende, o oficial de servi√ßo entra: ‚ÄúTudo est√° conosco!‚Äù </font><font style="vertical-align: inherit;">O chefe do departamento ficou cinzento quando explicou aos neg√≥cios por que isso aconteceu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pre√ßo do erro √© t√£o alto que criamos nosso pr√≥prio e complicado procedimento de profilaxia. </font><font style="vertical-align: inherit;">Se voc√™ implement√°-lo em uma grande produ√ß√£o, n√£o precisar√° fornecer um token mestre sobre o Consul a todos. </font><font style="vertical-align: inherit;">Isso terminar√° mal. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custo.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu escrevi o c√≥digo por 400 horas sozinho. </font><font style="vertical-align: inherit;">Apoiar minha equipe de 4 pessoas passa 10 horas por m√™s. </font><font style="vertical-align: inherit;">Comparado ao pre√ßo de qualquer firewall de nova gera√ß√£o, √© gr√°tis. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planos. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O plano de longo prazo √© a busca de transporte alternativo em troca ou al√©m do Consul. </font><font style="vertical-align: inherit;">Talvez seja Kafka ou algo assim. </font><font style="vertical-align: inherit;">Mas nos pr√≥ximos anos viveremos no Consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Planos imediatos: integra√ß√£o com o Fail2ban, com monitoramento, com nftables, possivelmente com outras distribui√ß√µes, m√©tricas, monitoramento avan√ßado, otimiza√ß√£o. </font><font style="vertical-align: inherit;">O suporte ao Kubernetes tamb√©m est√° em algum lugar nos planos, porque agora temos v√°rios grupos e desejo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro dos planos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">procure anomalias de tr√°fego;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gerenciamento de mapa de rede;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suporte ao Kubernetes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">montagem de pacotes para todos os sistemas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UI da Web</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos constantemente trabalhando para expandir a configura√ß√£o, aumentando as m√©tricas e otimizando. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Participe do projeto. </font><font style="vertical-align: inherit;">O projeto acabou sendo legal, mas, infelizmente, ainda √© um projeto de uma pessoa. </font><font style="vertical-align: inherit;">Venha ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e tente fazer algo: comprometa, teste, ofere√ßa algo, fa√ßa sua avalia√ß√£o.</font></font></i><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enquanto isso, estamos nos preparando para o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saint HighLoad ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que ser√° realizado nos dias 6 e 7 de abril em S√£o Petersburgo, e convidamos os desenvolvedores de sistemas de alta carga </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a solicitar um relat√≥rio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Oradores experientes j√° sabem o que fazer, e recomendamos que os novatos nos discursos, pelo menos, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tentem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Participar da confer√™ncia como palestrante tem v√°rias vantagens. </font><font style="vertical-align: inherit;">Voc√™ pode ler, por exemplo, no final </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deste artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt486822/index.html">[Pelas docas] Flutter. Parte 4. Para desenvolvedores web</a></li>
<li><a href="../pt486824/index.html">Maus conselhos ao trabalhar com a ANTLR</a></li>
<li><a href="../pt486826/index.html">Criando um Viberbot completo no Django 2 e na API Riber do Viber. Parte Um - Webhook</a></li>
<li><a href="../pt486828/index.html">Food Design Digest, janeiro 2020</a></li>
<li><a href="../pt486832/index.html">Quantos anos taiga vai - n√£o entendo</a></li>
<li><a href="../pt486844/index.html">A evolu√ß√£o do processamento de webhook no Facebook: de zero a 25.000 por segundo</a></li>
<li><a href="../pt486850/index.html">Novo assento reservado - como um hotel c√°psula</a></li>
<li><a href="../pt486858/index.html">Criando um Viberbot completo. Parte dois - primeiro contato ou "conversion_started"</a></li>
<li><a href="../pt486860/index.html">ATX12VO - Comer uma nova maneira</a></li>
<li><a href="../pt486862/index.html">5 raz√µes pelas quais o design de movimento ajuda voc√™ a se conectar com as pessoas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>