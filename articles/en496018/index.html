<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è™ üçª üßíüèΩ DNS records for mail servers üìâ ‚õ±Ô∏è ü§æüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine that in real life you received an envelope where the name of your old friend is written in the ‚ÄúSender‚Äù field. Can you, without opening and re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DNS records for mail servers</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496018/"><img src="https://habrastorage.org/webt/v6/wj/gf/v6wjgfpwlhnr8zbi2la8rwpysqg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine that in real life you received an envelope where the name of your old friend is written in the ‚ÄúSender‚Äù field. </font><font style="vertical-align: inherit;">Can you, without opening and reading the letter, say for sure - this is an envelope from your old friend or some intruder? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the task facing mail servers - just looking at the envelope to determine if the sender is lying. </font><font style="vertical-align: inherit;">To do this, the mail server refers to the mechanism that the Internet serves to confirm domain ownership - the DNS server.</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/PhNrgjSIThg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Previous &lt; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About ports and encryption in mail servers</font></font></a><br>
<br>
<img src="https://habrastorage.org/webt/ce/h4/my/ceh4myowiqubtsfxgd0si889zpo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Immediately make a reservation that by the "sender" field I do not mean the "from" field in the message itself, but the address of the sender server. </font></font><br>
<img src="https://habrastorage.org/webt/ij/dr/s-/ijdrs-ma55pt0wavpzrap4tgq9i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The mail server is very dependent on DNS. The only case when the mail server does not need a DNS server is when it is a local mail server that does not send or receive letters from other servers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b9/q1/1v/b9q11v0y2tha8xkrc_koptaeeds.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, let's decide on all the necessary DNS records for mail servers. Let's start with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúA‚Äù record</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which translates the name into an IP address. By the way, A - from the word address. Common examples of names for mail servers are mx.example.org, mail.example.org, smtp.example.org. Several A records with the same name and different IP addresses will allow balancing traffic to different mail servers provided that round robin DNS is configured. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lr/jn/lg/lrjnlgvyy2xjbxdzwxzx1mwflwg.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MX record</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- from the word e-mail messenger - it is necessary so that other mail servers can find out to which address the mail should be sent to the specified recipient domain. If you plan to use subdomains, for example, user@support.example.org, then for the subdomain you will need a separate MX record. Also, you can specify several MX records for one domain, pointing to different addresses and choosing priority. Say you want all mail to be sent to the mx1.example.org server by default, then give it priority closer to zero. The lower the priority of the server, the higher the number you assign to it. The maximum value is 65535, but usually priorities are set to 10, 20, 30, etc. Priorities can match, then either DNS balances these records, if configured on the DNS server, or the sender will use the first available server.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tn/j-/av/tnj-avwsfxi9kannqpiccugpi2u.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTR record</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a reverse DNS record that translates an IP address into a name. The main objective of this entry for the mail server is to filter out most of the spam. This record allows you to determine the host name from which mail arrives. When receiving mail, the mail server makes two requests - to obtain a name by IP address and to obtain an IP address by the name of the sender. If the results match, then the sender server is who it claims to be. Unlike other records, such a record can only be created if you own or rent an IP address.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qj/8q/4p/qj8q4prb5da6zd7jfngukag2qde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a rule, services where you buy a domain name do not allow you to create a PTR record. If you rent VPS from cloud providers, some of them create PTR records for you. If you have your own local mail server, but the DNS provider acts as the DNS provider, then you can contact your Internet provider, which will give you an IP address so that the provider writes a PTR record for you. Without this entry, your outgoing messages are more likely to get spam on other mail servers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uc/un/mg/ucunmg8a0_tp--rklyoxa352m7g.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPF</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- A record that allows certain addresses to send a message from the specified domain, and says what to do if the message came from a different address. Suppose you, as a sender, declare that you only allow mail.example.org to send mail from the example.org domain. And if the message does not come from this address, but the example.org domain is specified in the sender field, then it is safe to reject this message as untrusted. In principle, the server recipients should check your SPF record and act according to what you set, but the recipient can ignore your ‚Äúinstructions‚Äù at will. An SPF record is needed to protect against spoofing attacks when an attacker pretends to be one of the sender's users.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">###   SPF </span><font></font>
<font></font>
<span class="hljs-comment"># C     </span><font></font>
v=spf1 -all<font></font>
<font></font>
<span class="hljs-comment">#        ,   MX </span><font></font>
v=spf1 mx -all<font></font>
<font></font>
<span class="hljs-comment">#        mail.example.org,      </span><font></font>
v=spf1 a:mail.example.org ~all<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When setting up an SPF record, you specify the version of SPF, and so far it is one - the first. Next, specify the addresses that are allowed to send messages from this domain. The addresses can be just an ‚Äúmx‚Äù record - that is, those servers that you have listed in MX records. You can also register additional addresses using the options a - by A record, by ipv4 and ipv6 addresses, etc. After the allowed addresses, the all option is indicated for everything that did not fit your rule. You can advise the recipient to allow all messages from any addresses on your domain, prohibit, mark as inappropriate, but skip, or at the discretion of the recipient. The full syntax and all SPF options will be given as a link at the end.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And although the SPF points to the addresses to whom it is allowed to send messages, there is a possibility of substitution of the message by someone in the middle. To prevent such attacks, there is another DNS entry. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c2/zg/ew/c2zgewwl77ybzt6gmljzns8lv84.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DKIM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a record that is used to confirm the sender using signatures that are added to each message. In short, your server adds a unique hash to outgoing messages, which can be decrypted using the public key from the corresponding DNS record. Even if someone substitutes a message, he will not be able to fake your digital signature. Thus, DKIM is also needed to protect against spoofing.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But for DKIM, adding a DNS record is not enough; you also need to generate keys and configure your mail server to work with DKIM. To do this, the DKIM service rises on the mail server, and the mail service itself, before sending the message, sends messages through this service, which adds a digital signature. How to install and configure this I will consider another time, but this is full of material on the Internet. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/nf/hu/l_/nfhul_7mbr9njf3w0y8lo5uq56a.png"><br>
<img src="https://habrastorage.org/webt/cs/9r/66/cs9r66clngtsuoiks-chldqq3eq.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMARC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a record that allows you to set policies based on SPF and DKIM checks. These policies, again, are needed by the recipient to know what to do with your letters.</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment">###   DMARC </span><font></font>
<font></font>
<span class="hljs-comment">#          </span><font></font>
v=DMARC1; p=reject; pct=100; rua=mailto:admin@example.org<font></font>
<font></font>
<span class="hljs-comment">#    50% ,    ,  ,    </span><font></font>
v=DMARC1; p=quarantine; pct=50; rua=mailto:admin@example.org<font></font>
<font></font>
<span class="hljs-comment">#       </span><font></font>
v=DMARC1; p=none; rua=mailto:admin@example.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can configure the recording so that the recipient ignores errors, quarantines failed messages, or rejects these messages altogether. Also, in the DMARC record, you specify the mailing address where the recipient servers will send statistics on messages from your mail servers, which will allow you to understand what is happening with outgoing messages, and also tighten the nuts slowly to prevent spoofing. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ld/r8/3z/ldr83zahmj8jw3vhpq9wc1oliu0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some services, say Gmail, also offer to add certain DNS records to confirm you as a domain administrator, which will allow you to better understand what is happening with messages from your domain for Gmail users. But these are special cases and vary depending on the service. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w5/uz/ud/w5uzudtzliofwde7al06ff55uyg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Forgot to mention. There are a couple of important tools online to check your settings.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the most convenient tools is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mail-tester</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It's simple: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Go to the site, copy the mailing address that the service gave you. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Send a message to this address from your domain from any mailbox. It is desirable that the message is not empty, but contains some kind of text. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Return to the site, click "Then check the rating." </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Check the result. The portal will check all possible settings, like DNS - the same SPF, DKIM and DMARC records, and will show if your server is blacklisted, etc. He will also give a recommendation if you have errors in the settings.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. If there were errors - correct and then send the message again and check the result again. If the problems were related to DNS records, make sure that your changes to the DNS are applied (for example, with the same dig command) before trying again. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BUT! The service gives you only 3 free attempts per day, therefore, it is advisable to fix all the errors, and then re-check. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/ws/5h/chws5hf_3nwdt8kjns4eqeerhvy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another tool - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mxtoolbox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Here, basically, checking for the presence of DNS records and getting into spam lists. Also on this portal you can find many different tools for checking and there is no such restriction as in mail-tester. Although among the tools there is a check for the presence of a DKIM key, without a message from your domain mxtoolbox will not be able to confirm the correctness of the mail server settings for working with DKIM. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dd/qz/yd/ddqzydln8mbff8plzyom5zm71vm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have configured DKIM and want to make sure that you are correct, you can send a message to the same gmail account, and then open the message in its original form and try to find the line DKIM = pass. Or use the ready-made service - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dkimvalidator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The principle of operation is the same as that of mail-tester - send a message to the generated address and see the result.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, by setting up these DNS records, messages from your mail servers will not fall into spam (provided that you yourself do not spam), and you will help your recipients to avoid spam and spoofing attacks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Useful links: </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is SPF </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Riddles and Myths SPF </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What Is DKIM? </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HowTo: DMARC</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496004/index.html">New models of data search and analysis. WSDM 2020 through the eyes of the Yandex.Tolki team</a></li>
<li><a href="../en496006/index.html">Outgrowing reverse proxy - technology for remote protection and site optimization without changing DNS A-records</a></li>
<li><a href="../en496010/index.html">What happens to transport during the crisis (first week of April)</a></li>
<li><a href="../en496014/index.html">IBM Weekly Seminars - April 2020</a></li>
<li><a href="../en496016/index.html">Search for bugs as a way of life: a review No. 3</a></li>
<li><a href="../en496020/index.html">Summer MVP. How flexible is Kotlin?</a></li>
<li><a href="../en496022/index.html">Extreme bacteria: how to survive below the bottom of the ocean</a></li>
<li><a href="../en496024/index.html">The heading "Read articles for you." March 2020. Part 1</a></li>
<li><a href="../en496026/index.html">It is not only with you. Internet is slowing down worldwide due to increased traffic</a></li>
<li><a href="../en496028/index.html">Coronavirus, Crisis, and IT Implications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>