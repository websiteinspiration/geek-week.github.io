<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👊🏾 🙎🏾 👯 Smart Home: Erstellen Sie Wasser- und Stromdiagramme in Home Assistant 🔱 👨‍👩‍👧‍👧 🧚🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jedes Mal, wenn ich eine Rechnung für Strom und Wasser erhalte, frage ich mich - verbraucht meine Familie wirklich so viel? Ja, das Badezimmer hat ein...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Smart Home: Erstellen Sie Wasser- und Stromdiagramme in Home Assistant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492314/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wj/lf/i3/wjlfi38qar57vvhqgpwuzdalerw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jedes Mal, wenn ich eine Rechnung für Strom und Wasser erhalte, frage ich mich - verbraucht meine Familie wirklich so viel? Ja, das Badezimmer hat eine Fußbodenheizung und einen Heizkessel, aber sie heizen nicht ständig. Wir scheinen auch Wasser zu sparen (obwohl wir es auch lieben, im Badezimmer zu planschen). Vor ein paar Jahren habe ich bereits </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wasser-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stromzähler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> an ein Smart Home angeschlossen, aber das blieb hängen. Erst jetzt ging es um die Analyse des Verbrauchs, um die es in diesem Artikel tatsächlich geht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe kürzlich als Smart-Home-System zu Home Assistant gewechselt. Einer der Gründe war nur die Möglichkeit, die Erfassung einer großen Datenmenge mit der Möglichkeit zu organisieren, verschiedene Arten von Diagrammen bequem zu erstellen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die in diesem Artikel beschriebenen Informationen sind nicht neu, all diese Dinge mit unterschiedlichen Saucen wurden bereits im Internet beschrieben. </font><font style="vertical-align: inherit;">Jeder Artikel beschreibt jedoch in der Regel nur einen Ansatz oder Aspekt. </font><font style="vertical-align: inherit;">Ich musste all diese Ansätze vergleichen und selbst den am besten geeigneten auswählen. </font><font style="vertical-align: inherit;">Der Artikel enthält immer noch keine umfassenden Informationen zur Datenerfassung, ist jedoch eine Art Zusammenfassung meiner Vorgehensweise. </font><font style="vertical-align: inherit;">Konstruktive Kritik und Verbesserungsvorschläge sind daher willkommen.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulierung des Problems</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ziel der heutigen Übung ist es also, schöne Diagramme des Wasser- und Stromverbrauchs zu erhalten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stündlich für 2 Tage</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Täglich für 2 Wochen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(optional) wöchentlich und monatlich</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier erwarten uns einige Schwierigkeiten:</font></font><br>
<br>
<ul>
<li>  ,  ,  .         . <br>
<br>
  ,     ,     .  home assistant,  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">mini-graph-card</a>,     :<br>
<br>
<ul>
<li>        (     ,         )</li>
<li>       (   ,      )</li>
</ul></li>
<li> ,  home assistant        SQLite <s>( , ,    MySQL  Postgres)</s>,        . , ,               json   <br>
<br>
<pre><code class="json hljs">{<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"old_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"3"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:05:06.897604+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"aafc8ca305ba4e49ad4c97f0eddd8893"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}, <span class="hljs-attr">"new_state"</span>: {<span class="hljs-attr">"entity_id"</span>: <span class="hljs-string">"sensor.water_cold_hourly"</span>, <span class="hljs-attr">"state"</span>: <span class="hljs-string">"4"</span>, <span class="hljs-attr">"attributes"</span>: {<span class="hljs-attr">"source"</span>: <span class="hljs-string">"sensor.water_meter_cold"</span>, <span class="hljs-attr">"status"</span>: <span class="hljs-string">"collecting"</span>, <span class="hljs-attr">"last_period"</span>: <span class="hljs-string">"29"</span>, <span class="hljs-attr">"last_reset"</span>: <span class="hljs-string">"2020-02-23T21:00:00.022246+02:00"</span>, <span class="hljs-attr">"meter_period"</span>: <span class="hljs-string">"hourly"</span>, <span class="hljs-attr">"unit_of_measurement"</span>: <span class="hljs-string">"l"</span>, <span class="hljs-attr">"friendly_name"</span>: <span class="hljs-string">"water_cold_hourly"</span>, <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"mdi:counter"</span>}, <span class="hljs-attr">"last_changed"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2020-02-23T19:11:11.251545+00:00"</span>, <span class="hljs-attr">"context"</span>: {<span class="hljs-attr">"id"</span>: <span class="hljs-string">"0de64b8af6f14bb9a419dcf3b200ef56"</span>, <span class="hljs-attr">"parent_id"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"user_id"</span>: <span class="hljs-literal">null</span>}}}</code></pre><br>
     (    ,    ),         .      SDM220      10-15 ,         8.      ,      . ..         100-200  .      ,      (    home assistant  raspberry PI),            .</li>
<li>  ,      .           <s> </s>   .           (RS232/RS485/Modbus/Zigbee)   .<br>
<br>
         (    ),      X -  .            .         ,        . , ,        home assistant,          ,             (  home assistant).</li>
</ul><br>
<h2> 1</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns zunächst sehen, was der Heimassistent sofort bereitstellt. Die Messung des Verbrauchs über einen bestimmten Zeitraum ist eine sehr gefragte Funktion. Natürlich wurde es vor langer Zeit in Form einer speziellen Komponente realisiert - Utility_meter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Wesentliche der Komponente ist, dass darin die Variable current_accumulated_value gestartet und nach einem bestimmten Zeitraum (Stunde / Woche / Monat) zurückgesetzt wird. Die Komponente selbst überwacht die eingehende Variable (den Wert einer Art Sensor), abonniert Änderungen des Werts selbst - Sie erhalten nur das Endergebnis. Diese Sache wird in der Konfigurationsdatei in wenigen Zeilen beschrieben.</font></font><br>
<br>
<pre><code class="python hljs">utility_meter:<font></font>
  water_cold_hour_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: hourly<font></font>
  water_cold_day_um:<font></font>
    source: sensor.water_meter_cold<font></font>
    cycle: daily<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist sensor.water_meter_cold der aktuelle Wert des Zählers in Litern, den ich </font><font style="vertical-align: inherit;">per mqtt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">direkt vom Eisenstück</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bekomme. Das Design erstellt zwei neue Sensoren water_cold_hour_um und water_cold_day_um, die stündliche und tägliche Messwerte sammeln und diese nach einer gewissen Zeit zurücksetzen. Hier ist eine halbstündige Batterietabelle. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/u3/fk/leu3fkbgddojjis_lmcawt6gcv4.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Stunden- und Tages-Chartcode für die Lovelace-Benutzeroberfläche sieht folgendermaßen aus:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsächlich liegt das Problem dieses Ansatzes in diesem Algorithmus. Wie bereits erwähnt, wird für jeden Eingabewert (der aktuelle Zählerstand für jeden nächsten Liter) 1 KB Datensatz in der Datenbank generiert. Jeder Stromzähler generiert außerdem einen neuen Wert, der sich ebenfalls zur Datenbank summiert. Wenn ich stündliche / tägliche / wöchentliche / monatliche Messwerte und für mehrere Wasseraufsteiger erfassen und sogar ein paar Stromzähler hinzufügen möchte, sind dies viele Daten. Genauer gesagt, es gibt nicht viele Daten, aber da der Heimassistent eine Reihe unnötiger Informationen in die Datenbank schreibt, wird die Größe der Datenbank sprunghaft zunehmen. Ich habe sogar Angst, die Größe der Basis für wöchentliche und monatliche Charts zu schätzen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus löst der Stromzähler allein die Aufgabe nicht. </font><font style="vertical-align: inherit;">Das Diagramm der Werte, das der Betriebszähler anzeigt, ist eine monoton ansteigende Funktion, die stündlich auf 0 zurückgesetzt wird. </font><font style="vertical-align: inherit;">Wir brauchen eine benutzerfreundliche Verbrauchstabelle, wie viele Liter während des Zeitraums gegessen wurden. </font><font style="vertical-align: inherit;">Die Standard-Verlaufsgraphenkomponente weiß nicht, wie das geht, aber die externe Mini-Grafikkartenkomponente kann uns helfen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist der Kartencode für die Liebes-Benutzeroberfläche:</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_hour_um<font></font>
        group_by: hour<font></font>
        hours_to_show: <span class="hljs-number">48</span>
        name: <span class="hljs-string">"Hourly water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">1</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zusätzlich zu den Standardeinstellungen wie dem Namen des Sensors, der Art des Diagramms und der Farbe (mir hat das Standardorange nicht gefallen) ist es wichtig, 3 Einstellungen zu beachten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">group_by: hour - Das Diagramm wird mit den am Anfang der Stunde ausgerichteten Spalten erstellt</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">points_per_hour: 1 - ein Balken pro Stunde</font></font></li>
<li>  , aggregate_func: max —       .         </li>
</ul><br>
<img src="https://habrastorage.org/webt/yj/du/c7/yjduc7nhxnq18qvcityd_ul91y0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Achten Sie nicht auf eine Reihe von Spalten auf der linken Seite - dies ist das Standardverhalten einer Komponente, wenn keine Daten vorhanden sind. Und es gab keine Daten - ich habe die Datenerfassung für Versorgungszähler erst vor ein paar Stunden nur wegen dieses Artikels aktiviert (ich werde etwas später auf meinen aktuellen Ansatz eingehen). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Bild wollte ich zeigen, dass die Datenanzeige manchmal sogar funktioniert und die Balken wirklich die richtigen Werte widerspiegeln. Aber das ist nicht alles. Die ausgewählte Spalte für das Intervall von 11 bis 12 Uhr morgens zeigt aus irgendeinem Grund 19 Liter an, obwohl auf der Zahnkarte für denselben Zeitraum ein etwas höherer Verbrauch von 62 Litern vom selben Sensor angezeigt wird. Entweder ein Käfer oder Hände sind schief. Aber ich verstehe nicht, warum die Daten auf der rechten Seite abgebrochen sind - der Verbrauch dort war normal, was auch auf dem Zahnplan sichtbar ist.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen habe ich es nicht geschafft, die Glaubwürdigkeit dieses Ansatzes zu erreichen - die Grafik zeigt fast immer eine Art Häresie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der gleiche Code für den Tagessensor.</font></font><br>
<br>
<pre><code class="python hljs">      - aggregate_func: max<font></font>
        entities:<font></font>
          - color: var(--primary-color)<font></font>
            entity: sensor.water_cold_day_um<font></font>
        group_by: interval<font></font>
        hours_to_show: <span class="hljs-number">360</span>
        name: <span class="hljs-string">"Daily water consumption aggregated by utility meter"</span>
        points_per_hour: <span class="hljs-number">0.0416666666</span><font></font>
        show:<font></font>
          graph: bar<font></font>
        type: <span class="hljs-string">'custom:mini-graph-card'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beachten Sie, dass der Parameter group_by auf Intervall festgelegt ist und der Parameter points_per_hour alles regelt. </font><font style="vertical-align: inherit;">Und dies ist ein weiteres Problem dieser Komponente - points_per_hour funktioniert gut für Diagramme in einer Stunde oder weniger, ist aber in großen Intervallen widerlich. </font><font style="vertical-align: inherit;">Um eine Spalte an einem Tag zu erhalten, musste ich den Wert 1/24 = 0,04166666 eingeben. </font><font style="vertical-align: inherit;">Ich spreche nicht von Wochen- und Monats-Charts.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansatz 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als ich gerade den Heimassistenten herausgefunden habe, bin ich hier auf dieses Video gestoßen:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-0HrYFCRH0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Freund sammelt Verbrauchsdaten von verschiedenen Arten von Xiaomi-Verkaufsstellen. Seine Aufgabe ist etwas einfacher - zeigen Sie einfach den Wert des Verbrauchs für heute, gestern und für den Monat an. Es sind keine Zeitpläne erforderlich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen wir die Diskussion über die manuelle Integration von Momentanleistungswerten beiseite - ich habe bereits über die „Genauigkeit“ dieses Ansatzes geschrieben. Es ist nicht klar, warum er die kumulierten Verbrauchswerte, die bereits von derselben Verkaufsstelle gesammelt wurden, nicht verwendet hat. Meiner Meinung nach funktioniert die Integration in das Stück Eisen besser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus dem Video nehmen wir die Idee, den Verbrauch für den Zeitraum manuell zu berechnen. Der Bauer zählt nur die Werte für heute und gestern, aber wir werden weiter gehen und versuchen, eine Grafik zu zeichnen. Das Wesentliche der vorgeschlagenen Methode ist in meinem Fall wie folgt.</font></font><br>
<br>
<ul>
<li>  ___,      </li>
<li>     (   )          .         —    ,         . </li>
<li>  “”  ___     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All dies kann getan werden , </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">w ... durch</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mittel des Hauses Assistent selbst. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie müssen mehr Code schreiben als im vorherigen Ansatz. </font><font style="vertical-align: inherit;">Lassen Sie uns zunächst genau diese „Variablen“ abrufen. </font><font style="vertical-align: inherit;">Standardmäßig haben wir keine "variable" Entität, aber Sie können die Dienste des mqtt-Brokers nutzen. </font><font style="vertical-align: inherit;">Wir senden dort Werte mit dem Flag keep = true - dies speichert den Wert im Broker und Sie können ihn jederzeit abrufen, auch wenn der Home Assistant neu startet. </font><font style="vertical-align: inherit;">Ich habe sofort Stunden- und Tagzähler gemacht.</font></font><br>
<br>
<pre><code class="python hljs">- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour"</span><font></font>
  name: water_hour<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
  name: water_hour_begin<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day"</span><font></font>
  name: water_day<font></font>
  unit_of_measurement: l<font></font>
<font></font>
- platform: mqtt<font></font>
  state_topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
  name: water_day_begin<font></font>
  unit_of_measurement: l</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Magie geschieht in der Automatisierung, die jede Stunde bzw. jede Nacht ausgeführt wird.</font></font><br>
<br>
<pre><code class="python hljs">- id: water_new_hour<font></font>
  alias: water_new_hour<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time_pattern<font></font>
      minutes: <span class="hljs-number">0</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_hour_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/hour_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true<font></font>
<font></font>
- id: water_new_day<font></font>
  alias: water_new_day<font></font>
  initial_state: true<font></font>
  trigger:<font></font>
    - platform: time<font></font>
      at: <span class="hljs-string">"00:00:00"</span><font></font>
  action:<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day"</span><font></font>
        payload_template: &gt;<font></font>
          {{ (states.sensor.water_meter_cold.state|int) - (states.sensor.water_day_begin.state|int) }}<font></font>
        retain: true<font></font>
    - service: mqtt.publish<font></font>
      data:<font></font>
        topic: <span class="hljs-string">"test/water/day_begin"</span><font></font>
        payload_template: &gt;<font></font>
          {{ states.sensor.water_meter_cold.state }}<font></font>
        retain: true</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beide Automatisierungen führen zwei Aktionen aus:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Wert für das Intervall wird als Differenz zwischen Start- und Endwert berechnet</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktualisieren Sie den Basiswert für das nächste Intervall</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die grafische Darstellung wird in diesem Fall durch das übliche Verlaufsdiagramm gelöst:</font></font><br>
<br>
<pre><code class="python hljs">      - type: history-graph<font></font>
        title: <span class="hljs-string">'Hourly water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">48</span><font></font>
        entities:<font></font>
          - sensor.water_hour<font></font>
<font></font>
      - type: history-graph<font></font>
        title: <span class="hljs-string">'Daily water consumption using vars'</span>
        hours_to_show: <span class="hljs-number">360</span><font></font>
        entities:<font></font>
          - sensor.water_day</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sieht so aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rp/nn/ah/rpnnahsspezbcydtjmhlu6kb53w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Prinzip ist dies bereits das, was Sie brauchen. </font><font style="vertical-align: inherit;">Der Vorteil dieser Methode ist, dass die Daten einmal pro Intervall generiert werden. </font><font style="vertical-align: inherit;">Jene. </font><font style="vertical-align: inherit;">Nur 24 Einträge pro Tag für das Stunden-Chart. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider löst dies immer noch nicht das allgemeine Problem einer wachsenden Basis. </font><font style="vertical-align: inherit;">Wenn ich einen monatlichen Verbrauchsplan haben möchte, muss ich die Daten mindestens ein Jahr lang speichern. </font><font style="vertical-align: inherit;">Und da der Heimassistent nur eine Einstellung für die Speicherdauer der gesamten Datenbank bereitstellt, müssen ALLE Daten im System ein ganzes Jahr lang gespeichert werden. </font><font style="vertical-align: inherit;">Zum Beispiel verbrauche ich ein Jahr lang 200 Kubikmeter Wasser, was bedeutet, dass es 200.000 Datensätze in der Datenbank sind. </font><font style="vertical-align: inherit;">Und wenn Sie andere Sensoren berücksichtigen, wird die Zahl überhaupt unanständig.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansatz 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Glücklicherweise haben kluge Köpfe dieses Problem bereits durch das Schreiben der InfluxDB-Datenbank gelöst. Diese Datenbank ist speziell für die Speicherung zeitbasierter Daten optimiert und eignet sich ideal zum Speichern von Werten verschiedener Sensoren. Das System bietet auch eine SQL-ähnliche Abfragesprache, mit der Sie Werte aus der Datenbank auswählen und dann auf verschiedene Arten aggregieren können. Schließlich können unterschiedliche Daten zu unterschiedlichen Zeiten gespeichert werden. Beispielsweise können häufig wechselnde Messwerte wie Temperatur oder Luftfeuchtigkeit nur einige Wochen gespeichert werden, während tägliche Messwerte des Wasserverbrauchs ein ganzes Jahr lang gespeichert werden können.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben InfluxDB haben Smart People auch Grafana erfunden, ein Diagrammsystem, das auf Daten von InfluxDB basiert. </font><font style="vertical-align: inherit;">Grafana kann verschiedene Arten von Diagrammen zeichnen, sie detailliert anpassen und vor allem können diese Diagramme auf dem Home-Assistenten der Lovelace-Benutzeroberfläche „hängen bleiben“. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie sich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inspirieren </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In den Artikeln wird detailliert beschrieben, wie InfluxDB und Grafana installiert und mit dem Heimassistenten verbunden werden. </font><font style="vertical-align: inherit;">Ich werde mich auf die Lösung meines spezifischen Problems konzentrieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir also zunächst damit, den Zählerwert in influxDB zu addieren. </font><font style="vertical-align: inherit;">Ein Teil der Home Assistant-Konfiguration (in diesem Beispiel werde ich nicht nur mit kaltem, sondern auch mit heißem Wasser Spaß haben):</font></font><br>
<br>
<pre><code class="python hljs">influxdb:<font></font>
  host: localhost<font></font>
  max_retries: <span class="hljs-number">3</span><font></font>
  default_measurement: state<font></font>
  database: homeassistant<font></font>
  include:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deaktivieren Sie das Speichern derselben Daten in der internen Datenbank des Heimassistenten, um sie nicht erneut aufzublasen:</font></font><br>
<br>
<pre><code class="python hljs">recorder:<font></font>
  purge_keep_days: <span class="hljs-number">10</span>
  purge_interval: <span class="hljs-number">1</span><font></font>
  exclude:<font></font>
    entities:<font></font>
      - sensor.water_meter_hot<font></font>
      - sensor.water_meter_cold</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir gehen jetzt zur InfluxDB-Konsole und richten unsere Datenbank ein. Insbesondere müssen Sie konfigurieren, wie lange diese oder jene Daten gespeichert werden. Dies wird durch die sogenannten geregelt Aufbewahrungsrichtlinie - Dies ähnelt den Datenbanken in der Hauptdatenbank, wobei jede interne Datenbank ihre eigenen Einstellungen hat. Standardmäßig werden alle Daten in einer Aufbewahrungsrichtlinie namens autogen gespeichert. Diese Daten werden eine Woche lang gespeichert. Ich möchte, dass die stündlichen Daten für einen Monat, die wöchentlichen für ein Jahr und die monatlichen Daten niemals gelöscht werden. Erstellen Sie eine entsprechende Aufbewahrungsrichtlinie</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"month"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">30</span>d <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"year"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> <span class="hljs-number">52</span>w <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">RETENTION</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"infinite"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"homeassistant"</span> <span class="hljs-keyword">DURATION</span> INF <span class="hljs-keyword">REPLICATION</span> <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsächlich ist der Haupttrick die Datenaggregation mithilfe einer kontinuierlichen Abfrage. </font><font style="vertical-align: inherit;">Dies ist ein Mechanismus, der automatisch eine Abfrage in bestimmten Intervallen startet, Daten für diese Abfrage aggregiert und das Ergebnis einem neuen Wert hinzufügt. </font><font style="vertical-align: inherit;">Schauen wir uns ein Beispiel an (ich schreibe zur besseren Lesbarkeit in eine Spalte, musste diesen Befehl jedoch in einer Zeile eingeben).</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> CONTINUOUS <span class="hljs-keyword">QUERY</span> cq_water_hourly <span class="hljs-keyword">ON</span> homeassistant 
<span class="hljs-keyword">BEGIN</span> 
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">value</span> 
  <span class="hljs-keyword">INTO</span> homeassistant.month.water_meter_hour 
  <span class="hljs-keyword">FROM</span> homeassistant.autogen.l 
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id fill(previous) 
<span class="hljs-keyword">END</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Befehl:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellt eine fortlaufende Abfrage mit dem Namen cq_water_cold_hourly in der homeassistanten Datenbank</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Anfrage wird stündlich ausgeführt (Zeit (1h))</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bei der Anforderung werden alle Daten aus der Messung "homeassistant.autogen.l" (Liter) abgerufen, einschließlich der Messwerte für kaltes und heißes Wasser</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aggregierte Daten werden nach entity_id gruppiert, wodurch separate Werte für kaltes und heißes Wasser erstellt werden.</font></font></li>
<li>               ,      max(value) </li>
<li>     homeassistant.month.water_meter_hour,  month   retention policy     .               entity_id     value</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachts oder wenn niemand zu Hause ist, gibt es keinen Wasserverbrauch und dementsprechend gibt es auch keine neuen Einträge in homeassistant.autogen.l. Um zu vermeiden, dass Werte in regulären Abfragen fehlen, können Sie fill (vorherige) verwenden. Dadurch wird InfluxDB gezwungen, den Wert für die letzte Stunde zu verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider hat die kontinuierliche Abfrage eine Besonderheit: Der Fülltrick (vorheriger Trick) funktioniert nicht und Datensätze werden einfach nicht erstellt. Darüber hinaus ist dies ein unüberwindbares Problem, das seit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mehr als einem Jahr diskutiert wird</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wir werden uns später mit diesem Problem befassen und die fortlaufende Abfrage ausfüllen (vorher) - es stört nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns überprüfen, was passiert ist (natürlich müssen Sie ein paar Stunden warten):</font></font><br>
<br>
<pre><code class="python hljs">&gt; select * <span class="hljs-keyword">from</span> homeassistant.month.water_meter_hour group by entity_id<font></font>
...<font></font>
name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 value<font></font>
----                 -----<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T01:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370511</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370513</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370527</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370605</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370635</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370699</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370761</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370767</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370810</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370818</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370827</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370849</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">370921</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bitte beachten Sie, dass die Werte in der Datenbank in UTC gespeichert sind. Daher unterscheiden sie sich in dieser Liste um 3 Stunden. Die Werte für 7 Uhr in der InfluxDB-Ausgabe entsprechen den Werten für 10 Uhr in den obigen Grafiken. </font><font style="vertical-align: inherit;">Beachten Sie auch, dass zwischen 2 und 5 Uhr morgens einfach keine Datensätze vorhanden sind - dies ist das gleiche Merkmal der kontinuierlichen Abfrage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen können, ist der aggregierte Wert auch eine monoton ansteigende Sequenz, nur Datensätze sind weniger häufig - einmal pro Stunde. </font><font style="vertical-align: inherit;">Dies ist jedoch kein Problem. Wir können eine weitere Abfrage schreiben, die die richtigen Daten für das Diagramm liefert.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">difference</span>(<span class="hljs-keyword">max</span>(<span class="hljs-keyword">value</span>)) 
<span class="hljs-keyword">FROM</span> homeassistant.month.water_meter_hour 
<span class="hljs-keyword">WHERE</span> entity_id=<span class="hljs-string">'water_meter_cold'</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">time</span> &gt;= <span class="hljs-keyword">now</span>() <span class="hljs-number">-24</span>h 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-built_in">time</span>(<span class="hljs-number">1</span>h), entity_id <font></font>
fill(previous)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde entschlüsseln:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aus der Datenbank homeassistant.month.water_meter_hour extrahieren wir die Daten für entity_id = 'water_meter_cold' für den letzten Tag (time&gt; = now () -24h). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie ich in der Sequenz homeassistant.month.water_meter_hour erwähnt habe, fehlen möglicherweise einige Einträge. </font><font style="vertical-align: inherit;">Wir werden diese Daten neu generieren, indem wir eine Abfrage mit der GROUP BY-Zeit (1 Stunde) ausführen. </font><font style="vertical-align: inherit;">Diese Zeitfüllung (vorherige) funktioniert nach Bedarf und generiert die fehlenden Daten (die Funktion übernimmt den vorherigen Wert).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Wichtigste bei dieser Anforderung ist die Differenzfunktion, mit der die Differenz zwischen den Stundenmarkierungen berechnet wird. </font><font style="vertical-align: inherit;">An sich funktioniert es nicht und erfordert eine Aggregatfunktion. </font><font style="vertical-align: inherit;">Es sei das zuvor verwendete max ().</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis der Ausführung sieht so aus</font></font><br>
<br>
<pre><code class="python hljs">name: water_meter_hour<font></font>
tags: entity_id=water_meter_cold<font></font>
time                 difference<font></font>
----                 ----------<font></font>
...<font></font>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T02:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">2</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T03:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T04:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">0</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T05:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">14</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T06:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">78</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T07:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">30</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T08:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">64</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T09:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">62</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T10:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">6</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">43</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T12:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">8</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T13:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">9</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T14:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">22</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span>T15:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>Z <span class="hljs-number">72</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Von 2 bis 5 Uhr morgens (UTC) gab es keinen Verbrauch. </font><font style="vertical-align: inherit;">Trotzdem gibt die Abfrage aufgrund der Füllung (vorherige) denselben Verbrauchswert zurück, und die Differenzfunktion subtrahiert diesen Wert von sich selbst und wir erhalten 0 an der Ausgabe, was tatsächlich erforderlich ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie müssen nur noch einen Zeitplan erstellen. </font><font style="vertical-align: inherit;">Öffnen Sie dazu Grafana, öffnen Sie ein vorhandenes (oder erstellen Sie ein neues) Dashboard und erstellen Sie ein neues Bedienfeld. </font><font style="vertical-align: inherit;">Die Diagrammeinstellungen werden so aussehen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ux/q0/c8/uxq0c834j1eq4h7ey4qazk4cc7q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde Daten zu kaltem und heißem Wasser auf einer Karte anzeigen. </font><font style="vertical-align: inherit;">Die Anfrage ist genau die gleiche wie oben beschrieben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Anzeigeparameter werden wie folgt eingestellt. </font><font style="vertical-align: inherit;">Ich werde eine Grafik mit Linien haben, die über Treppen führt. </font><font style="vertical-align: inherit;">Ich werde den Stack-Parameter unten erläutern. </font><font style="vertical-align: inherit;">Es gibt unten ein paar weitere Anzeigeoptionen, die jedoch nicht so interessant sind.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/rd/5x/bird5xpaysckqtigczjerbp5mti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den empfangenen Zeitplan zum Heimassistenten hinzuzufügen, benötigen Sie:</font></font><br>
<br>
<ul>
<li>    . -         </li>
<li>     ,    share</li>
<li>      embed</li>
<li>  current time range —       URL </li>
<li>  .     light</li>
<li>  URL    lovelace-UI</li>
</ul><br>
<pre><code class="python hljs">      - type: iframe<font></font>
        id: graf_water_hourly<font></font>
        url: <span class="hljs-string">"http://192.168.10.200:3000/d-solo/rZARemQWk/water?orgId=1&amp;panelId=2&amp;from=now-2d&amp;to=now&amp;theme=light"</span>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bitte beachten Sie, dass der Zeitbereich (die letzten 2 Tage) hier und nicht in den Dashboard-Einstellungen festgelegt wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Diagramm sieht so aus. Ich habe in den letzten 2 Tagen kein heißes Wasser verwendet, daher wird nur eine Grafik mit kaltem Wasser gezeichnet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ms/e7/hk/mse7hkckiwjjm_b5ppli9dakd2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mich nicht entschieden, welchen Zeitplan ich am liebsten mag, eine Step-Line oder echte Bars. Daher werde ich nur ein Beispiel für ein tägliches Verbrauchsdiagramm geben, diesmal jedoch in Spalten. Anfragen werden auf die gleiche Weise wie oben beschrieben erstellt. Die Anzeigeparameter lauten wie folgt: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ns/se/jt/nssejtoburugxcldedjuj0cvywm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Grafik sieht </font><font style="vertical-align: inherit;">folgendermaßen </font><font style="vertical-align: inherit;">aus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zd/yl/hj/zdylhjfnrdonlnkezr3n4dlwdwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also über den Stapelparameter. In diesem Diagramm wird eine Kaltwassersäule auf eine Heißwassersäule gezogen. Die Gesamthöhe entspricht dem Gesamtverbrauch an kaltem und heißem Wasser für den Zeitraum.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle gezeigten Grafiken sind dynamisch. Sie können mit der Maus über einen Punkt von Interesse fahren und die Details und den Wert an einem bestimmten Punkt anzeigen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider konnten ein paar Löffel Teer nicht. Im Balkendiagramm (im Gegensatz zum Diagramm mit Schrittlinien) befindet sich die Mitte des Balkens nicht in der Mitte des Tages, sondern um 00:00 Uhr. Jene. Die linke Hälfte der Spalte wird anstelle des vorherigen Tages gezeichnet. Die Karten für Samstag und Sonntag sind also etwas links als die bläuliche Zone gezeichnet. Bis ich herausgefunden habe, wie ich es gewinnen kann.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiteres Problem ist die Unfähigkeit, in monatlichen Abständen korrekt zu arbeiten. </font><font style="vertical-align: inherit;">Tatsache ist, dass die Länge der Stunde / des Tages / der Woche festgelegt ist, die Länge des Monats jedoch jedes Mal anders ist. </font><font style="vertical-align: inherit;">InfluxDB kann nur in regelmäßigen Abständen arbeiten. </font><font style="vertical-align: inherit;">Bisher reichte mein Gehirn aus, um ein festes Intervall von 30 Tagen festzulegen. </font><font style="vertical-align: inherit;">Ja, die Grafik schwebt im Laufe des Jahres ein wenig und die Spalten entsprechen nicht genau den Monaten. </font><font style="vertical-align: inherit;">Aber da dieses Ding für mich einfach als Anzeigegerät interessant ist, bin ich damit einverstanden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich sehe mindestens zwei Lösungen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Punktzahl nach monatlichen Zeitplänen und Beschränkung auf wöchentlich. </font><font style="vertical-align: inherit;">52 wöchentliche Bars für das Jahr sehen ziemlich gut aus</font></font></li>
<li>     №2,       .     .          —    .</li>
</ul><br>
<br>
<h2></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich weiß nicht warum, aber ich trete auf solche Charts. Sie zeigen, dass das Leben in vollem Gange ist und sich alles verändert. Gestern war viel, heute ist nicht genug, morgen wird etwas anderes sein. Es bleibt die Arbeit mit den Haushalten zum Thema Konsum. Aber selbst bei aktuellem Appetit verwandelt sich bereits eine große und unverständliche Zahl in der Zahlung in ein ziemlich klares Bild des Konsums. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz der fast 20-jährigen Karriere als Programmierer habe ich mich praktisch nicht mit Datenbanken überschnitten. Daher schien die Installation einer externen Datenbank etwas so Abstruses und Unverständliches zu sein. Durch den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oben genannten Artikel wurde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alles geändert </font><font style="vertical-align: inherit;">- es stellte sich heraus, dass das Verschrauben eines geeigneten Werkzeugs mit wenigen Klicks erledigt werden kann und mit einem speziellen Werkzeug die grafische Darstellung etwas einfacher wird.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Überschrift habe ich den Stromverbrauch erwähnt. </font><font style="vertical-align: inherit;">Leider kann ich im Moment kein einziges Diagramm geben. </font><font style="vertical-align: inherit;">Ein SDM120-Zähler ist tot und der andere ist fehlerhaft, wenn über Modbus zugegriffen wird. </font><font style="vertical-align: inherit;">Dies hat jedoch keine Auswirkungen auf das Thema dieses Artikels - die Grafiken werden auf die gleiche Weise wie für Wasser erstellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Artikel habe ich die Ansätze zitiert, die ich selbst ausprobiert habe. </font><font style="vertical-align: inherit;">Sicher gibt es einige andere Möglichkeiten, die Erfassung und Visualisierung von Daten zu organisieren, die ich nicht kenne. </font><font style="vertical-align: inherit;">Erzähl mir davon in den Kommentaren, es wird sehr interessant für mich sein. </font><font style="vertical-align: inherit;">Ich freue mich über konstruktive Kritik und neue Ideen. </font><font style="vertical-align: inherit;">Ich hoffe, dass das präsentierte Material auch jemandem hilft.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de492298/index.html">Polygone Eine andere Welt: IBM PC</a></li>
<li><a href="../de492302/index.html">Smart Stand mit Smartphones für Tester - ein Startup-Projekt des Accelerators der ITMO University</a></li>
<li><a href="../de492306/index.html">Lidare auf der CES</a></li>
<li><a href="../de492308/index.html">Neuronen und ihre Modellierung</a></li>
<li><a href="../de492312/index.html">Avro-Serialisierung bei Kafka</a></li>
<li><a href="../de492318/index.html">Wie sich Coronavirus auf die IT-Branche auswirkt</a></li>
<li><a href="../de492320/index.html">Covid-19, Ihre Gesellschaft und Sie in Bezug auf Datenwissenschaft</a></li>
<li><a href="../de492322/index.html">Raspberry Pi + Fedora (aarch64) = WLAN-Hotspot (oder ein Himbeer-Router mit blauem Hut)</a></li>
<li><a href="../de492324/index.html">Wir diskutieren den EARN IT Act - eine neue US-Gesetzesvorlage, die zu einem Verbot der E2E-Verschlüsselung führen könnte</a></li>
<li><a href="../de492326/index.html">Analyse der Popularität von YouTube-Videos von Eurovision 2020-Teilnehmern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>