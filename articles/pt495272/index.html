<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôçÔ∏è üôÇ üëÉüèæ Emuladores SNES a apenas alguns pixels da perfei√ß√£o absoluta üëä üè© üôãüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Estamos t√£o perto de criar um emulador que possa recriar perfeitamente todas as fun√ß√µes de hardware real e software SNES. 
 
 Nos √∫ltimos 15 anos, com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Emuladores SNES a apenas alguns pixels da perfei√ß√£o absoluta</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495272/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44b/f3b/e14/44bf3be14304180044d2e7deb216f07d.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estamos t√£o perto de criar um emulador que possa recriar perfeitamente todas as fun√ß√µes de hardware real e software SNES. </font></font></i><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos √∫ltimos 15 anos,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como codificador do emulador de </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bsnes,</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tentei aperfei√ßoar a emula√ß√£o de Super Nintendo, mas agora estamos diante do √∫ltimo problema: o tempo preciso dos ciclos de clock dos processadores de v√≠deo SNES. </font><font style="vertical-align: inherit;">Para alcan√ßar esse est√°gio final de precis√£o da emula√ß√£o, √© necess√°ria a ajuda de toda a comunidade, e espero seu apoio. </font><font style="vertical-align: inherit;">Mas, primeiro, vou contar o que j√° alcan√ßamos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estado atual</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, a situa√ß√£o com emula√ß√£o de SNES √© muito boa. Al√©m dos perif√©ricos incomuns que resistem √† emula√ß√£o (por exemplo, um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taco de golfe com sensor de luz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simulador de bicicleta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e modem dial-up, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no Jap√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">para apostas em corridas de cavalos no</font></a><font style="vertical-align: inherit;"> Jap√£o), todos os jogos SNES oficialmente licenciados s√£o totalmente jog√°veis, e nenhum jogo tem problemas √≥bvios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A emula√ß√£o SNES tornou-se t√£o precisa que at√© tive que dividir o emulador em duas vers√µes: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">higan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que busca precis√£o e consist√™ncia absolutas com a documenta√ß√£o do hardware, e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bsnes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que busca velocidade, amplos recursos e facilidade de uso.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recentemente, no campo da emula√ß√£o SNES, muitas conquistas interessantes foram recebidas, incluindo:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emula√ß√£o de baixo n√≠vel de todos os coprocessadores SNES</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suporte para o modo HD 7</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remo√ß√£o do freio</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suporte de tela ampla</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSU1 para CD-√°udio e FMV</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Execu√ß√£o preliminar para reduzir atrasos</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controle din√¢mico de taxa de dados para perfeita sincroniza√ß√£o de √°udio e v√≠deo</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¶ e muito mais! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, est√° feito? Todos trabalharam bem, tchau, e obrigado pelo peixe? Bem, n√£o exatamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, alcan√ßamos precis√£o no n√≠vel de batida de quase todos os componentes do SNES. As √∫nicas exce√ß√µes foram a PPU (unidade de processamento de imagem, m√≥dulos de processamento de imagem) usada para gerar quadros de v√≠deo transmitidos para a tela. Sabemos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principalmente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como as PPUs funcionam, mas, para algumas fun√ß√µes, precisamos adivinhar, o que leva √† precis√£o imperfeita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em uma escala geral, os problemas restantes s√£o bem menores. Se voc√™ n√£o se esfor√ßa pela idealidade absolutamente perfeita da emula√ß√£o pelo amor √† arte, n√£o posso convenc√™-lo da necessidade de melhorar ainda mais a emula√ß√£o de PPU. Como em qualquer campo, quanto mais pr√≥ximos estivermos do ideal, menor ser√° o retorno.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas posso dizer por que isso √© importante para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mim</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : esse √© o trabalho de toda a minha vida e n√£o quero que diga que cheguei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> perto da conclus√£o sem dar o √∫ltimo passo. </font><font style="vertical-align: inherit;">Estou envelhecendo e n√£o sou eterna. </font><font style="vertical-align: inherit;">Quero que a √∫ltima pe√ßa do quebra-cabe√ßa seja resolvida, para que, depois de me aposentar, tenha certeza de que o legado do SNES seja confi√°vel e totalmente preservado, gra√ßas √† emula√ß√£o. </font><font style="vertical-align: inherit;">Eu quero dizer que o problema est√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resolvido</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ ainda estiver intrigado, continue lendo para se familiarizar com o hist√≥rico de um problema e as solu√ß√µes oferecidas por mim.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelagem da arquitetura SNES</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos come√ßar listando os componentes que comp√µem o SNES:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c3c/f4f/e25/c3cf4fe250fbbed2b897e46ef58628bd.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagrama do sistema Super NES. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As setas indicam as dire√ß√µes nas quais v√°rios processadores SNES podem trocar dados entre si e as linhas pontilhadas indicam as conex√µes com os chips de mem√≥ria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mais importante para n√≥s agora √© notar que a sa√≠da de v√≠deo e som √© transmitida diretamente do PPU e DSP. </font><font style="vertical-align: inherit;">Isso significa que eles agem como "caixas pretas" e n√£o podemos ver o que est√° acontecendo dentro delas. </font><font style="vertical-align: inherit;">Mais tarde, isso se tornar√° importante para n√≥s.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corre√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que emulamos o comando da CPU ‚Äúmultiplicar‚Äù, que pega dois registradores (vari√°veis), multiplica-os, recebe o resultado e v√°rios sinalizadores indicando o estado do resultado (por exemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estouro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos escrever um programa que multiplique qualquer valor poss√≠vel de 0 a 255 como um fator e um multiplicador. Em seguida, podemos derivar os resultados de multiplica√ß√£o num√©rica e de sinaliza√ß√£o. Assim, obtemos duas tabelas de 65 536 elementos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao analisar essas tabelas, podemos determinar com precis√£o como e onde os resultados dos c√°lculos da CPU s√£o definidos de uma certa maneira. Em seguida, podemos modificar os emuladores para que, ao executar o mesmo teste, obtenhamos exatamente as mesmas tabelas ao mesmo tempo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, digamos que a CPU possa fazer a multiplica√ß√£o de 16 bits x 16 bits. Ao testar todos os valores poss√≠veis, ser√£o gerados 4 bilh√µes de resultados, quase imposs√≠veis de serem testados em um per√≠odo de tempo razo√°vel. Se a CPU tiver multiplica√ß√µes de 32 bits x 32 bits, na pr√°tica, n√£o ser√° poss√≠vel testar todas as combina√ß√µes de valores de entrada antes da morte t√©rmica do Universo (pelo menos no n√≠vel atual de tecnologia). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesses casos, agimos de maneira mais seletiva nos testes e tentamos determinar quando os sinalizadores podem mudar exatamente, quando os resultados podem transbordar e assim por diante. Caso contr√°rio, ter√≠amos que executar testes que nunca terminariam.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A multiplica√ß√£o √© uma opera√ß√£o bastante trivial, mas o mesmo princ√≠pio pode ser estendido a todo o processo de engenharia reversa, incluindo opera√ß√µes mais complexas, por exemplo, transmiss√£o de dados via DMA (acesso direto √† mem√≥ria) durante o retorno horizontal do feixe. </font><font style="vertical-align: inherit;">Criamos testes que tentam determinar o que acontece em casos lim√≠trofes e, em seguida, verificamos se nossa emula√ß√£o se comporta de maneira id√™ntica ao comportamento do SNES real.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geradores de sinais e batidas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O SNES possui dois geradores de sinal (osciladores): um oscilador de cristal operando a uma frequ√™ncia de aproximadamente 21 MHz (controla os m√≥dulos CPU e PPU) e um ressonador de cer√¢mica operando a uma frequ√™ncia de aproximadamente 24 MHz, que controla SMP e DSP. </font><font style="vertical-align: inherit;">Nos coprocessadores de cartucho, √†s vezes √© usado um oscilador de cristal de 21 MHz e, √†s vezes, seus pr√≥prios geradores de sinal trabalhando com outras frequ√™ncias.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/97d/ecb/bc1/97decbbc1161fcf170f063d2fd42795d.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recriar esta placa de circuito Super Famicom no c√≥digo √© mais dif√≠cil do que parece.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
O rel√≥gio √© o elemento b√°sico do tempo de qualquer sistema, e o SNES foi projetado para executar v√°rias tarefas com determinadas frequ√™ncias e intervalos de tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ imaginar um rel√≥gio de 100 hertz, ser√° um dispositivo com uma sa√≠da bin√°ria alternando para um estado l√≥gico alto do sinal (por exemplo, +5 V) e depois para um estado baixo do sinal (0 V ou terra) 100 vezes por segundo. Ou seja, a cada segundo a tens√£o na sa√≠da flutua 200 vezes: aumentando 100 vezes e 100 vezes diminuindo a frente do sinal do rel√≥gio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um ciclo de clock √© geralmente considerado uma transi√ß√£o completa, ou seja, um ciclo de 100 Hz gera 100 ciclos de clock por segundo. </font><font style="vertical-align: inherit;">Alguns sistemas exigem uma distin√ß√£o entre arestas ascendentes e descendentes e, para eles, dividimos o ciclo em semiciclos para indicar cada fase (alta ou baixa) do sinal do rel√≥gio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa mais importante de um emulador preciso √© concluir as tarefas exatamente da mesma maneira e exatamente ao mesmo tempo que em equipamentos reais. </font><font style="vertical-align: inherit;">No entanto, n√£o √© muito importante </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tarefas s√£o executadas. </font><font style="vertical-align: inherit;">A √∫nica coisa importante √© que o emulador, recebendo os mesmos sinais de entrada, gere os mesmos sinais de sa√≠da ao mesmo tempo que no hardware real.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hor√°rios</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, as opera√ß√µes levam tempo. Tomemos, por exemplo, multiplica√ß√£o na CPU do SNES. Em vez de pausar e aguardar a conclus√£o da multiplica√ß√£o, a CPU do SNES calcula o resultado da multiplica√ß√£o um bit por vez em segundo plano para oito ciclos de clock dos c√≥digos de opera√ß√£o da CPU. Isso potencialmente permite que o c√≥digo execute outras tarefas enquanto aguarda a conclus√£o da multiplica√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Provavelmente, qualquer software comercial aguardar√° esses oito ciclos, porque se voc√™ tentar ler o resultado antes que esteja pronto, obteremos um resultado parcialmente conclu√≠do. No entanto, antes dos emuladores SNES fornecerem resultados corretos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instantaneamente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sem esperar por esses ciclos adicionais de clock.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando os f√£s de consoles come√ßaram a criar e testar software auto-escrito em emuladores, essa discrep√¢ncia come√ßou a causar certos problemas. Parte do software, por exemplo, muitos dos primeiros hacks da ROM </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do Super Mario World</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , funcionavam corretamente apenas nesses emuladores antigos, mas n√£o no hardware SNES real. Isso aconteceu porque eles foram desenvolvidos levando em considera√ß√£o a obten√ß√£o instant√¢nea (n√£o confi√°vel do ponto de vista do equipamento real) dos resultados da multiplica√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No processo de aprimoramento dos emuladores, a compatibilidade do software antigo foi interrompida e, portanto, tivemos que adicionar op√ß√µes de compatibilidade aos novos emuladores para n√£o perder esses programas. Sim, por mais surreal que pare√ßa, mas hoje os emuladores devem emular outros emuladores!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A conveni√™ncia desse atraso de multiplica√ß√£o na CPU reside no fato de ser muito previs√≠vel: oito ciclos de c√°lculo de rel√≥gio come√ßam imediatamente ap√≥s a solicita√ß√£o da opera√ß√£o de multiplica√ß√£o. </font><font style="vertical-align: inherit;">Ao escrever o c√≥digo que l√™ os resultados ap√≥s cada ciclo, conseguimos verificar se a CPU do SNES usa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o algoritmo Booth</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para multiplica√ß√£o </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sincroniza√ß√£o de rel√≥gio</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outras opera√ß√µes n√£o s√£o f√°ceis de modelar porque s√£o executadas de forma ass√≠ncrona em segundo plano. Um desses casos √© a atualiza√ß√£o DRAM do processador SNES central. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante a renderiza√ß√£o de cada linha de varredura, toda a CPU do SNES em um determinado est√°gio suspende sua opera√ß√£o por um curto per√≠odo de tempo enquanto o conte√∫do do chip de RAM √© atualizado. Isso √© necess√°rio porque, para reduzir o custo no SNES, a RAM din√¢mica (em vez de est√°tica) foi usada como a mem√≥ria principal da CPU. Para salvar o conte√∫do da RAM din√¢mica, ela deve ser atualizada periodicamente.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d61/cb1/ab9/d61cb1ab914186314069b09f88218fcf.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Criar um emulador verdadeiramente perfeito n√£o √© suficiente para garantir a jogabilidade de todos os tr√™s mil e meio de jogos SNES. Tamb√©m √© necess√°rio obter a simula√ß√£o de cada fun√ß√£o do sistema com perfeita precis√£o de tato.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
O fator chave na an√°lise dos tempos exatos dessas opera√ß√µes foi a possibilidade de usar contadores de PPU horizontais e verticais. Esses contadores realizam incrementos e s√£o redefinidos ap√≥s cada deslocamento horizontal e vertical inverso do feixe. No entanto, sua precis√£o √© apenas um quarto da frequ√™ncia do gerador de sinal da CPU SNES; em outras palavras, o contador horizontal aumenta a cada quatro ciclos de clock.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lendo v√°rias vezes os valores dos contadores, consegui determinar com qual trimestre do ciclo do rel√≥gio o contador est√° alinhado. Combinando esse conhecimento com fun√ß√µes especialmente criadas que podem dar um passo em dire√ß√£o ao n√∫mero exato de ciclos de clock indicado pelo usu√°rio, consegui combinar perfeitamente a CPU do SNES com qualquer posi√ß√£o exata do ciclo de clock de que preciso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gra√ßas a uma passagem iterativa de muitos ciclos de clock, pude determinar quando certas opera√ß√µes est√£o acontecendo exatamente (por exemplo, atualiza√ß√£o de DRAM, transmiss√£o de HDMA, interrup√ß√£o de sondagem etc.) Depois disso, eu pude recriar exatamente tudo isso em emula√ß√£o. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chip SMP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O console do SNES tamb√©m possui seus pr√≥prios temporizadores, e a engenharia reversa bem-sucedida tamb√©m foi realizada para esse processador. </font><font style="vertical-align: inherit;">Posso dedicar um artigo inteiro apenas ao registro SMP TEST, que permite aos programadores controlar o divisor de frequ√™ncia SMP e seu timer, sem mencionar outras coisas terr√≠veis. </font><font style="vertical-align: inherit;">Basta dizer que n√£o foi um processo f√°cil e r√°pido, mas no final vencemos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coletamos coprocessadores</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ce/8ec/80c/1ce8ec80c157a980c0222eb7462679e9.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O chip SuperFX √© apenas um dos muitos coprocessadores de cartucho que o emulador SNES pode suportar.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
H√° v√°rios coprocessadores SNES usados ‚Äã‚Äãem v√°rios cartuchos de jogos que tamb√©m precisamos domar. De CPUs individuais de uso geral como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SuperFX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SA-1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , processadores de sinais digitais como DSP-1 e Cx4 a aceleradores de descompress√£o como S-DD1 e SPC7110 ou rel√≥gios em tempo real da Sharp e Epson e muito mais ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso significa que o emulador SNES deve lidar com instru√ß√µes SuperFX e caches de pixels; com o esquema de resolu√ß√£o de conflitos do barramento de mem√≥ria SA-1 (permitindo que as CPUs SNES e SA-1 usem os mesmos chips de ROM e RAM simultaneamente); com firmware integrado DSP-1 e Cx4; com codificadores aritm√©ticos baseados em previs√£o S-DD1 e SPC7110; bem como com casos √≠mpares lim√≠trofes de BCD (decimal com c√≥digo bin√°rio) em geradores em tempo real. Lenta mas seguramente, usando todas as t√©cnicas para determinar a corre√ß√£o e os tempos descritos acima, conseguimos aprender a emular todos esses chips quase perfeitamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foram necess√°rios muito esfor√ßo e milhares de d√≥lares para remover as tampas dos chips e remover o firmware dos processadores de sinais digitais usados ‚Äã‚Äãem jogos diferentes. Em um caso, a emula√ß√£o NEC uPD772x permitiu</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use o c√≥digo de higan para salvar a voz do falecido Stephen Hawking! </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em outro caso, precis√°vamos fazer engenharia reversa de todo um conjunto de instru√ß√µes para a arquitetura Hitachi HG51B, porque ningu√©m havia publicado a documenta√ß√£o dessa arquitetura. </font><font style="vertical-align: inherit;">Em outro caso, descobriu-se que um jogo ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hayazashi Nidan Morita Shougi 2</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) possui um poderoso CPU ARM6 de 32 bits com uma frequ√™ncia de 21 MHz, o que acelera o jogo de shogi japon√™s! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apenas salvar todos os coprocessadores SNES acabou sendo um processo de longo prazo, cheio de dificuldades e surpresas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processamento de sinal digital</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O chip Sony S-DSP (Processador de sinal digital), que n√£o deve ser confundido com o coprocessador de cartucho DSP-1, gerou um som SNES exclusivo. Nesse chip, oito canais de √°udio com codifica√ß√£o ADPCM de 4 bits foram conectados, o que garantiu a cria√ß√£o de um sinal est√©reo de 16 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Externamente, e a partir do diagrama do sistema apresentado acima, a princ√≠pio parece que o DSP √© uma "caixa preta": ajustamos os canais de som e os par√¢metros do mixer, ap√≥s o que o chip gera som transmitido aos alto-falantes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas uma fun√ß√£o importante permitiu que o desenvolvedor, sob o apelido blargg, realizasse uma engenharia reversa completa desse chip: era um buffer de eco. </font><font style="vertical-align: inherit;">O SNES DSP possui uma fun√ß√£o que combina a sa√≠da de amostras anteriores para criar um efeito de eco. </font><font style="vertical-align: inherit;">Isso acontece no final do processo de gera√ß√£o de som (al√©m do √∫ltimo sinalizador de bloqueio de som, que pode ser usado para desativar toda a sa√≠da de som.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao escrever c√≥digo com o tempo correto das medidas e rastrear o eco resultante, conseguimos determinar a ordem exata das opera√ß√µes executadas pelo DSP para gerar de cada amostra e criando som perfeito e precis√£o de batida.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salvando PPU</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo isso nos levou √† √∫ltima parte do esquema arquitetural do SNES: chips PPU-1 e PPU-2. </font><font style="vertical-align: inherit;">Gra√ßas a John McMaster, temos varreduras dos chips S-PPU1 (revis√£o 1) e S-PPU2 (revis√£o 3) com um aumento de vinte vezes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/678/641/68e/67864168e9f383375b8e081ffff1606f.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Digitaliza√ß√£o vinte vezes do cristal do primeiro SNES PPU ...</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fad/524/a23/fad524a235729831ae880c3edf1bb4b8.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... e o segundo PPU</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ambas as varreduras de cristal nos permitem saber que os chips obviamente n√£o s√£o CPUs de uso geral, nem arquiteturas especializadas que executam c√≥digos de opera√ß√£o a partir da ROM interna do programa de firmware. Estes s√£o circuitos l√≥gicos separados com l√≥gica codificada que recebem sinais de entrada de diferentes registros e mem√≥ria e criam um sinal de v√≠deo para o monitor, uma linha de varredura por vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As PPUs continuam sendo o √∫ltimo obst√°culo √† emula√ß√£o do SNES porque, diferentemente de todos os componentes descritos acima, as PPUs </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√£o na verdade</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uma caixa preta. Podemos configur√°-los para qualquer estado, mas a CPU do SNES n√£o pode monitorar diretamente o que eles geram.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se usarmos o exemplo anterior com multiplica√ß√£o como analogia, imagine que voc√™ solicitou o resultado 3 * 7, mas, em vez da resposta bin√°ria, voc√™ obt√©m uma imagem anal√≥gica difusa dos n√∫meros "21" na tela. Qualquer pessoa que execute seu software poder√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ver</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 21, mas voc√™ n√£o pode escrever um programa de teste para verificar automaticamente se ele v√™ a resposta correta. A verifica√ß√£o manual de uma pessoa desses resultados n√£o pode ser escalada para mais de v√°rios milhares de testes, e milh√µes ser√£o necess√°rios para maximizar o comportamento da PPU. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sei o que voc√™ pensou: ‚ÄúMas √© mais f√°cil usar uma placa de captura, executar o processamento de imagens, compar√°-las aproximadamente com a imagem na tela digital do emulador e realizar testes com base nisso?‚Äù</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, sim, √© poss√≠vel! </font><font style="vertical-align: inherit;">Especialmente se o teste for verificar dois n√∫meros enormes que ocupam a tela inteira. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas e se o teste tiver muitas nuances, e estamos tentando reconhecer a diferen√ßa de cores da reticula√ß√£o de um pixel? </font><font style="vertical-align: inherit;">E se queremos executar um milh√£o de testes em ordem e nem sempre sabemos o que vamos gerar, mas ainda queremos comparar o resultado com a sa√≠da da nossa emula√ß√£o? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nada supera a conveni√™ncia e a precis√£o dos dados digitais - um fluxo preciso de bits que podem apenas corresponder ou n√£o. </font><font style="vertical-align: inherit;">A natureza anal√≥gica de um sinal CRT n√£o pode nos fornecer isso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que isso √© importante?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com exce√ß√£o de um jogo ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), todos os softwares SNES licenciados oficialmente (deveriam ter sido) baseados em strings de varredura. Esses jogos n√£o tentam alterar o estado da renderiza√ß√£o de PPU no meio da linha raster atual renderizada (esse truque dos programadores √© chamado de "efeito raster"). Isso significa que o tempo de execu√ß√£o da grande maioria dos jogos n√£o precisa ser particularmente preciso; se voc√™ tiver tempo para a pr√≥xima linha completa de varredura, tudo estar√° em ordem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas isso √© importante para um √∫nico jogo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/349/c75/08c/349c7508c9724e946a687c60881e77fc.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a4/7ee/5b2/3a47ee5b2b9ceacabcf2c4f1c34a1fe3.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/149/23c/77e14923ce342dc49287fa908aea5b93.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta s√©rie de imagens mostra um efeito de emula√ß√£o complexo usado na mensagem de ‚ÄúBoa Sorte‚Äù do </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nas imagens acima, voc√™ v√™ o texto quadro a quadro "Boa sorte" do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O jogo o implementa, alterando a posi√ß√£o de rolagem vertical da camada de fundo 3 (BG3). No entanto, a tela do painel √† esquerda (onde voc√™ pode ver que o jogador tem 39 m√≠sseis) tamb√©m est√° na mesma camada de fundo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O jogo consegue realizar essa separa√ß√£o alterando a posi√ß√£o do pergaminho BG3 em cada linha de varredura ap√≥s renderizar o painel esquerdo, mas antes que o texto "Boa sorte" comece a ser renderizado. Isso pode ser feito porque fora do painel e do texto, o BG3 √© transparente e n√£o h√° nada para desenhar entre esses dois pontos, independentemente do valor do registro de rolagem vertical. Esse comportamento nos mostra que os registros de rolagem </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">podem ser</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alterados em qualquer est√°gio da renderiza√ß√£o.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/880/658/047/8806580479dcbbaf6671fc971c12ba8b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa pequena sombra sob o avi√£o causou muitas dores de cabe√ßa ao desenvolvedor de emuladores obcecados pela precis√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A imagem acima mostra a sombra infame de um avi√£o. Esse efeito √© renderizado alterando o registro de brilho da tela com pequenas ondula√ß√µes em cinco linhas de varredura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante o jogo, voc√™ pode ver que essa sombra √© bastante ca√≥tica. Na imagem acima, ela se parece um pouco com a letra "c", mas sua forma em cada linha de varredura muda de comprimento e ponto de partida para cada quadro. Os desenvolvedores do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> esbo√ßaram aproximadamente onde a sombra deveria aparecer e resolveram esse problema diretamente. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na maioria dos casos,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> isso funciona.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A emula√ß√£o correta de tal comportamento requer um timing perfeito, o que √© absolutamente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">extremamente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dif√≠cil de </font><font style="vertical-align: inherit;">obter no emulador </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c5/b7f/fa2/1c5b7ffa2601b6480209321b60a131a1.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na tela de pausa do </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , s√£o utilizados efeitos de varredura que n√£o foram intencionalmente usados ‚Äã‚Äãem nenhum outro jogo SNES.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Agora vamos falar sobre a tela de pausa. Ele liga o BG3 enquanto desenha uma borda amarela-preta √† esquerda e a desliga novamente durante a mesma borda √† direita para desenhar linhas cinza na tela. Ele tamb√©m alternadamente, atrav√©s do quadro, alterna as linhas de varredura nas quais essas linhas cinza s√£o exibidas para criar o efeito de uma tremula√ß√£o de sobreposi√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ ampliar a imagem emulada mostrada acima, notar√° que durante o par de linhas rasterizadas no canto esquerdo dessas linhas cinzas, existem v√°rios pixels ausentes. Isso aconteceu porque minha emula√ß√£o de PPU √© 100% imperfeita nos ciclos de clock. Nesse caso, causa o efeito de ativar o BG3 um pouco mais tarde do que deveria.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu posso muito facilmente mudar os tempos para que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esta</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> imagem seja renderizada corretamente. Mas essa mudan√ßa provavelmente afetar√° adversamente </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outros</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jogos que alteram os registros de exibi√ß√£o da PPU no meio da linha de varredura. Embora o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seja o √∫nico jogo que faz isso de prop√≥sito, h√° pelo menos uma d√∫zia de jogos nos quais isso acontece por acaso (talvez o IRQ seja acionado muito cedo ou mais tarde). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, isso causa um breve dano percept√≠vel na imagem, que n√£o √© prestada aten√ß√£o durante o desenvolvimento (por exemplo, em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full Throttle Racing</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">durante a transi√ß√£o entre a loja e o jogo). √Äs vezes, a grava√ß√£o √© executada enquanto a tela √© transparente e, portanto, n√£o causa anomalias visuais (por exemplo, no caso de exibi√ß√£o do status da HP no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dai Kaijuu Monogatari II</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). que s√£o usados ‚Äã‚Äãnos emuladores mais produtivos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo que voc√™ ignore o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , todos esses efeitos aleat√≥rios (mas v√°lidos) de varredura no software SNES n√£o permitem projetar funcionalmente um renderizador de PPU que gera toda a linha de varredura com precis√£o perfeita do rel√≥gio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso de bsnes ao longo dos anos de tentativa e erro, criamos uma lista desses jogos com "efeitos raster". </font><font style="vertical-align: inherit;">Tamb√©m criamos posi√ß√µes de renderiza√ß√£o individuais que permitem renderiza√ß√µes muito mais r√°pidas com base em linhas raster para exibir corretamente todos esses jogos (exceto o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , √© claro). </font><font style="vertical-align: inherit;">Mas, em ess√™ncia, este √© um monte de hacks desagrad√°veis ‚Äã‚Äãpara n√≥s, projetados para jogos espec√≠ficos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m tenho um renderizador PPU baseado em rel√≥gio que n√£o precisa de todos esses hacks, mas, de tempos em tempos, cria pequenas diferen√ßas (de um a quatro pixels) com a renderiza√ß√£o deste equipamento, como na captura de tela acima do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Air Strike Patrol</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registros de trava interna</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A raz√£o para todas essas pequenas falhas se resume a intervalos de tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Digamos que o SNES renderize seu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">famoso modo 7</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que √© uma transforma√ß√£o de textura afim com altera√ß√µes de par√¢metros em cada linha de varredura. </font><font style="vertical-align: inherit;">Para determinar qualquer pixel da tela, √© necess√°rio executar c√°lculos semelhantes:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">px = a * clipe (hoffset - hcenter) + b * clipe (voffset - vcenter) +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
b * y + (hcenter &lt;&lt; 8)</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
py = c * clipe (hoffset - hcenter) + d * clipe (voffset - vcenter) +</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
d * y + (vcenter &lt;&lt; 8)</font></font></pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O SNES real n√£o poder√° concluir todas essas seis multiplica√ß√µes com rapidez suficiente para cada pixel que √© renderizado no quadro. </font><font style="vertical-align: inherit;">Mas nenhum desses valores muda para cada pixel (ou, pelo menos, n√£o deve mudar), portanto, apenas precisamos calcular px e py uma vez no in√≠cio de cada linha raster. </font><font style="vertical-align: inherit;">Ou seja, o PPU armazena em cache os resultados est√°ticos em travas, que s√£o essencialmente c√≥pias dos registros PPU. </font><font style="vertical-align: inherit;">No futuro, eles podem ser transformados ou permanecer inalterados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, as coordenadas x, y s√£o transformadas pelo modo 7 da seguinte maneira:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ox = (px + a * x) &gt;&gt; 8</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
oy = (py + c * x) &gt;&gt; 8</font></font></pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora x varie para cada pixel, sabemos que o incremento √© realizado um por vez. Gra√ßas ao armazenamento de unidades internas, podemos simplesmente adicionar valores constantes a e c a ox e oy para cada pixel, em vez de realizar duas multiplica√ß√µes para cada pixel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o surge a quest√£o diante de n√≥s: em que posi√ß√£o espec√≠fica do ciclo do rel√≥gio a PPU l√™ os valores de a e c nos registros externos da PPU aos quais a CPU tem acesso? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se os levarmos muito cedo, isso pode quebrar alguns jogos. Se demorarmos muito, pode quebrar outros jogos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maneira mais f√°cil √© esperar pelos relat√≥rios de bugs e ajustar essas posi√ß√µes para corrigir problemas em cada jogo espec√≠fico. Mas, neste caso, nunca encontraremos as </font><font style="vertical-align: inherit;">posi√ß√µes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exatas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , apenas suas aproxima√ß√µes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E toda vez que alteramos uma dessas vari√°veis, √© irrealista testar novamente todos os tr√™s mil e quinhentos jogos da biblioteca SNES para detectar a deteriora√ß√£o que nossas altera√ß√µes podem causar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fora da frigideira para o fogo</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c0a/741/b84/c0a741b84071dd0252021ae422277c1a.jpg"></div> <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interpreta√ß√£o art√≠stica do processo de elimina√ß√£o de erros de emula√ß√£o.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Um estilo semelhante de metodologia de teste, "apenas criaremos o jogo em que estamos interessados ‚Äã‚Äãem trabalhar a qualquer custo" levou a um fen√¥meno que chamo de emula√ß√£o "do fogo para o fogo". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo do desenvolvimento da emula√ß√£o SNES, quando surgiam problemas no jogo, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qualquer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corre√ß√£o nesse jogo que permitia que ele funcionasse era aceita e adicionada ao emulador. Essa corre√ß√£o necessariamente quebrou outro jogo. E ent√£o eles corrigiram </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jogo, ap√≥s o qual o terceiro quebrou. Consertar o terceiro jogo novamente quebrou o primeiro. Isso continuou por muitos anos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O erro aqui foi que os desenvolvedores tentaram levar em considera√ß√£o apenas uma vari√°vel de cada vez. Suponha que tenhamos um jogo e, para que funcione, os eventos devem ocorrer entre as medidas 20 e 120. N√£o sabemos a medida exata, ent√£o escolha 70, exatamente no meio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Posteriormente, obtemos um relat√≥rio de bug em outro jogo e determinamos que, para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esse</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jogo </font><font style="vertical-align: inherit;">funcionar </font><font style="vertical-align: inherit;">, o valor da medida deve estar entre 10 e 60. Agora, alteramos para 40, o que funciona para os dois jogos. Parece l√≥gico! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas ent√£o o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terceiro</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jogo </font><font style="vertical-align: inherit;">aparece </font><font style="vertical-align: inherit;">, no qual o evento deve funcionar entre as medidas 80 e 160! Agora n√£o podemos fazer com que os tr√™s jogos funcionem ao mesmo tempo com o mesmo valor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso for√ßou os desenvolvedores de emuladores a criar hacks para jogos espec√≠ficos. </font><font style="vertical-align: inherit;">Os codificadores n√£o desejam lan√ßar um emulador no qual voc√™ n√£o pode executar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mario</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zelda</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metroid</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, para o caso geral, o ciclo do rel√≥gio 40 √© usado, mas ao carregar o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metroid,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for√ßamos o valor de tempo para 100. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como isso √© poss√≠vel, por que dois jogos precisam de valores diferentes? </font><font style="vertical-align: inherit;">Isso acontece porque n√£o apenas uma vari√°vel est√° envolvida aqui. </font><font style="vertical-align: inherit;">O tempo que voc√™ usou anteriormente para acionar outro evento pode afetar o valor de tempo necess√°rio para o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√≥ximo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> evento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine isso na forma de uma simples express√£o alg√©brica:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2x + y = 120</font></font></pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode resolv√™-lo usando x = 10, y = 100. Ou x = 20, y = 80. Ou x = 30, y = 60. Se pensarmos apenas no valor de x, que permite executar simultaneamente um conjunto de jogos, perderemos o fato de que, de fato, o problema pode estar no y errado! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As primeiras vers√µes dos emuladores para aumentar a compatibilidade simplesmente redefiniram o valor de x, dependendo do jogo em execu√ß√£o. Esses hacks de jogos individuais persistiram, mesmo que o valor √∫nico e correto de x fosse descoberto posteriormente. Portanto, o problema </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nunca seria resolvido!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, no caso do SNES, nenhuma ou duas vari√°veis ‚Äã‚Äãest√£o envolvidas simultaneamente. Somente a PPU do console SNES possui 52 registros externos, que s√£o aproximadamente 130 par√¢metros. No processo de renderiza√ß√£o de uma √∫nica linha de varredura, todos os 130 desses par√¢metros e um n√∫mero desconhecido de registros e travas internos est√£o envolvidos. Isso √© muita informa√ß√£o para algu√©m de fora ser capaz de perceber o estado completo da PPU em um determinado momento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse aspecto da emula√ß√£o n√£o √© √≥bvio para os n√£o iniciados, mas √© muito justo: </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precis√£o</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o </font><em><font style="vertical-align: inherit;">√©</font></em><font style="vertical-align: inherit;"> igual √† </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compatibilidade</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Podemos criar um emulador com 99% de precis√£o, capaz de executar 10% dos jogos. </font><font style="vertical-align: inherit;">E voc√™ pode escrever um emulador de 80% de precis√£o que executa 98% dos jogos. </font><font style="vertical-align: inherit;">√Äs vezes, uma implementa√ß√£o correta no curto prazo quebra os jogos populares. </font><font style="vertical-align: inherit;">Este √© um sacrif√≠cio necess√°rio se voc√™ estiver tentando alcan√ßar 100% de precis√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 100% de compatibilidade.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resolva o problema</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chegamos ao est√°gio atual de emula√ß√£o de PPU, gra√ßas ao racioc√≠nio dedutivo e aos resultados no mundo real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sabemos que duas PPUs t√™m acesso a dois chips VRAM. </font><font style="vertical-align: inherit;">Sabemos que eles podem ler de cada chip um n√∫mero conhecido de bytes de dados por linha raster. </font><font style="vertical-align: inherit;">Conhecemos os detalhes aproximados de como cada um dos modos de v√≠deo do SNES funciona. </font><font style="vertical-align: inherit;">E com base nisso, podemos esbo√ßar um padr√£o generalizado de como a arquitetura pode parecer. </font><font style="vertical-align: inherit;">Por exemplo, aqui est√° um breve exemplo de como os tr√™s primeiros modos de v√≠deo SNES podem funcionar:</font></font><br>
<br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (io.bgMode == 0) {</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg4.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg3.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg4.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg3.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (io.bgMode == 1) {</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg3.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg3.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchCharacter (1);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchCharacter (0);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchCharacter (1);</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
}</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (io.bgMode == 2) {</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg2.fetchNameTable ();</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bg1.fetchNameTable ();</font></font><font></font>
<font></font>
bg3.fetchOffset(0);<font></font>
<font></font>
bg3.fetchOffset(8);<font></font>
<font></font>
bg2.fetchCharacter(0);<font></font>
<font></font>
bg2.fetchCharacter(1);<font></font>
<font></font>
bg1.fetchCharacter(0);<font></font>
<font></font>
bg1.fetchCharacter(1);<font></font>
<font></font>
}</pre></blockquote><br>
<h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A PPU revela a um observador de terceiros apenas uma pequena parte de seu estado: sinalizadores horizontais e verticais para tr√°s (apagamento horizontal / vertical), contagens de pixels horizontais e verticais e sinalizadores de sobreposi√ß√£o de ladrilhos no intervalo para sprites. Isso n√£o √© tanto, mas repito - todo pequeno elemento do estado acess√≠vel ao observador nos ajuda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A VRAM (RAM de v√≠deo, mem√≥ria de v√≠deo) do chip PPU durante a renderiza√ß√£o √© fechada para as CPUs SNES, mesmo para leitura. Mas, como se viu, OAM (mem√≥ria de sprite) e CGRAM (mem√≥ria de paleta) est√£o abertos. O truque √© que, neste momento, a PPU controla o barramento de endere√ßos. Portanto, lendo o OAM e o CGRAM durante a renderiza√ß√£o da tela, posso observar o que a PPU obt√©m desses dois blocos de mem√≥ria em um momento t√£o cr√≠tico.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essas n√£o s√£o todas as pe√ßas do quebra-cabe√ßa, mas s√£o suficientes para eu poder implementar os padr√µes praticamente corretos para obter sprites. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando padr√µes de acesso para OAM e CGRAM abertos, sinalizadores de PPU, observa√ß√µes gerais (ou seja, suposi√ß√µes) de relat√≥rios de erros para diferentes jogos e racioc√≠nio dedutivo, fomos capazes de criar renderizadores de PPU baseados em rel√≥gio que poderiam </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quase</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> perfeitamente </font><font style="vertical-align: inherit;">iniciar todos os jogos lan√ßados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas a situa√ß√£o ainda √© prec√°ria: se algu√©m come√ßar a criar jogos de homebrew usando o tempo preciso de ticks e efeitos raster, todos os nossos emuladores modernos n√£o ser√£o capazes de lidar com isso. Incluindo implementa√ß√µes de software e hardware baseadas em FPGA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devo dizer claramente: hoje </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tudo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eles conhecem apenas a ordem interna das opera√ß√µes e o comportamento do snap nos chips PPU do console SNES. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ningu√©m</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sabe como imit√°-los perfeitamente. </font><font style="vertical-align: inherit;">Pelo menos por enquanto.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solu√ß√µes poss√≠veis</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que devemos fazer com isso? </font><font style="vertical-align: inherit;">Como determinar a ordem exata das opera√ß√µes em uma PPU se, do ponto de vista da CPU do SNES, √© uma "caixa preta"? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vejo quatro op√ß√µes poss√≠veis: analisadores l√≥gicos, sa√≠da de v√≠deo digital em modo de teste, risers e remo√ß√£o de tampas dos chips.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analisadores l√≥gicos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ observar as varreduras de cristais de PPU mostradas acima, notar√° √°reas pretas nas bordas do chip. Estas s√£o as plataformas que se conectam aos contatos dos chips. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses pinos armazenam o estado dos chips PPU durante cada ciclo de clock. Aqui voc√™ encontra o endere√ßo atual para o qual os chips acessam o chip de mem√≥ria de v√≠deo, os valores dos dados transferidos de uma PPU para a segunda e muito mais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta informa√ß√£o n√£o est√° dispon√≠vel para c√≥digo em execu√ß√£o na CPU SNES, mas fornece observa√ß√µes valiosas sobre a ordem interna das opera√ß√µes de PPU.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2c8/157/c0d/2c8157c0df8caaebd7e24f620bf2c60f.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conectar as PPUs do console Super NES a um analisador l√≥gico semelhante pode ser a chave para a caixa preta. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema cr√≠tico dos analisadores l√≥gicos √© que eles n√£o s√£o muito convenientes de gerenciar: se voc√™ tentar amostrar dados ao vivo de um sistema em funcionamento, obteremos um fluxo de resultados bastante dif√≠cil de decifrar. </font><font style="vertical-align: inherit;">Voc√™ encontrar√° o mesmo problema se tentar analisar a sa√≠da RGB anal√≥gica do sistema: para capturar esses dados, voc√™ dever√° executar manualmente cada um dos testes. </font><font style="vertical-align: inherit;">Esse sistema n√£o √© muito bom para criar testes de regress√£o automatizados reproduz√≠veis.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sa√≠da de v√≠deo digital no modo de teste</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recentemente, atrav√©s de uma varredura de fatias de cristal com uma amplia√ß√£o de 20x, um modo de teste secreto foi descoberto nos chips PPU do console do SNES. Se voc√™ fizer uma pequena modifica√ß√£o no hardware, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a PPU come√ßar√° a emitir um sinal RGB digital de 15 bits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© quase o que precisamos! No entanto, este modo apresenta problemas, porque o famoso modo 7 n√£o pode exibir a imagem correta. Parece que esta fun√ß√£o n√£o foi totalmente conclu√≠da.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, para implementar esse m√©todo, a modifica√ß√£o manual dos consoles SNES e um mecanismo apropriado para capturar e analisar a sa√≠da no modo de teste ainda s√£o necess√°rios. </font><font style="vertical-align: inherit;">No entanto, diferentemente de uma solu√ß√£o com a captura de um sinal RGB anal√≥gico, esse sinal digital pode ser testado automaticamente, o que nos permite concluir rapidamente uma grande quantidade de trabalho em engenharia reversa de PPU.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Risers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como as PPUs s√£o est√°ticas, podemos remover os chips PPU de um console SNES em funcionamento e conect√°-los a uma placa de prototipagem ou a uma placa de circuito personalizada juntamente com dois chips VRAM. </font><font style="vertical-align: inherit;">Depois disso, voc√™ pode colocar um microcontrolador entre a PPU e a interface USB e conectar a interface ao PC, o que permitir√° ao codificador programar todos os registros de mem√≥ria de v√≠deo externos e PPUs. </font><font style="vertical-align: inherit;">Al√©m disso, o codificador poder√° controlar manualmente os ciclos do rel√≥gio da PPU e ler os sinais resultantes nos conectores de E / S, registradores e na mem√≥ria da PPU em cada ciclo do rel√≥gio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao modificar o emulador de software para gerar os mesmos valores internos dos conectores de E / S, podemos comparar diretamente o hardware real com a emula√ß√£o, mesmo em tempo real. </font><font style="vertical-align: inherit;">No entanto, isso ser√° um trabalho muito dif√≠cil, porque ainda n√£o podemos ver as opera√ß√µes internas da PPU.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remo√ß√£o da tampa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por fim, a solu√ß√£o mais extrema √© estudar mais o cristal removendo a tampa do chip. </font><font style="vertical-align: inherit;">J√° temos varreduras de cristal com uma amplia√ß√£o de 20x, mas sua resolu√ß√£o n√£o √© suficiente para analisar e recriar circuitos l√≥gicos individuais, como foi feito no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projeto Visual 6502</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se conseguirmos obter as varreduras de cristal das duas PPUs com uma amplia√ß√£o de 100x, podemos come√ßar o trabalho duro de compilar circuitos PPU e convert√™-los em tabelas de conex√£o ou c√≥digo VHDL. </font><font style="vertical-align: inherit;">Em seguida, eles podem ser usados ‚Äã‚Äãdiretamente no FPGA, bem como portados para C ++ ou outra linguagem de programa√ß√£o, aplic√°vel para a cria√ß√£o de emuladores de software.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um especialista que havia feito isso antes me deu uma estimativa aproximada: levaria cerca de 600 horas para mapear as duas PPUs. </font><font style="vertical-align: inherit;">Essa tarefa √© muito mais alta do que o n√≠vel de "vamos coletar dinheiro atrav√©s da capta√ß√£o de recursos e pagar algu√©m" e, idealmente, se enquadra na categoria "esperamos que algu√©m muito talentoso, com um conjunto √∫nico de habilidades, queira nos ajudar voluntariamente". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, isso n√£o significa que eu n√£o ficaria feliz em recompensar algu√©m financeiramente por sua ajuda; posso pagar pelos detalhes e pelo trabalho necess√°rios.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pe√ßa ajuda</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resumir: fui o mais longe poss√≠vel no meu projeto de emulador SNES e preciso de ajuda para concluir esta tarefa final. </font><font style="vertical-align: inherit;">Se voc√™ leu at√© o fim, pode querer ajudar! </font><font style="vertical-align: inherit;">Qualquer suporte, incluindo a participa√ß√£o no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projeto bsnes no GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou qualquer documenta√ß√£o de pesquisa sobre a opera√ß√£o interna de chips PPU, ser√° inestim√°vel para n√≥s! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obrigado pela leitura e pelo seu apoio! </font><font style="vertical-align: inherit;">Foi uma honra para mim, durante quinze anos, ser membro da comunidade de emula√ß√£o do SNES.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495256/index.html">Sobre portas e criptografia em servidores de correio</a></li>
<li><a href="../pt495258/index.html">Como o Zoom se tornou a empresa mais importante na era do coronav√≠rus</a></li>
<li><a href="../pt495262/index.html">Pr√°tica de atualiza√ß√£o da vers√£o do PostgreSQL. Andrey Salnikov</a></li>
<li><a href="../pt495266/index.html">E-learning renascentista. Por que 2020 mostrar√° todas as vantagens do ensino a dist√¢ncia</a></li>
<li><a href="../pt495268/index.html">Caso UI / UX: automa√ß√£o de estacionamento no aeroporto</a></li>
<li><a href="../pt495274/index.html">Como corrigir vazamentos de rota</a></li>
<li><a href="../pt495276/index.html">E demonstrar, ou como passamos na auditoria de sustentabilidade operacional no Uptime Institute</a></li>
<li><a href="../pt495278/index.html">Bancos de dados, cart√µes, listas de verifica√ß√£o ou Por que um gerente de conhecimento comercial</a></li>
<li><a href="../pt495280/index.html">Patrulha m√°xima SIEM. Vis√£o geral do sistema de gerenciamento de eventos de seguran√ßa da informa√ß√£o</a></li>
<li><a href="../pt495282/index.html">Valida√ß√£o de XML usando XSD, JAXB e Spring Framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>