<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🔧 #⃣ 🌡️ We deal with the wave function collapse algorithm 🤘🏼 📫 👩🏽‍⚖️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since the advent of DeBroglie and Tessera, I have been asked many times to explain how they work. Generating might look like magic, but the rules behi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We deal with the wave function collapse algorithm</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/497590/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/0p/3h/m9/0p3hm9jziz_gbzi9tajbo2p_s3a.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the advent of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeBroglie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tessera,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I have been asked many times to explain how they work. </font><font style="vertical-align: inherit;">Generating might look like magic, but the rules behind it are actually simple.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So what is the Wave Function Collapse (WFC) algorithm? </font><font style="vertical-align: inherit;">It was developed by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maxim Gumin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to create “tiled” images based on a simple configuration or image samples. </font><font style="vertical-align: inherit;">The algorithm can do a lot: look through the examples provided by Maxim and Twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#wavefunctioncollapse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , watch </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The variety is amazing.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Your browser does not support HTML5 video.</font></font><source src="https://www.boristhebrave.com/wp-content/uploads/2020/04/platformer.webm" type="video/webm"></video></div></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maxim in README briefly explained the work of WFC, but it seems to me that this issue requires a more detailed disclosure, from the very basics. Since the algorithm is related to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">programming in constraints</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , most of the article is devoted to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">explaining the concept of programming in constraints, and in the end we will return to WFC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Restricted programming is a way of instructing computers. Unlike imperative programming, when you specify a list of explicit functions, or functional programming, when you specify mathematical functions, here you provide the computer with a strict description of the problem, and it uses the built-in algorithms to find a solution. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This guide describes various concepts, not methods and code. </font><font style="vertical-align: inherit;">If you are more interested in the implementation, then you can use my WFC opensource library ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Although it is better to start the study with the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementation of Maxim</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If you use Unity, you can buy </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tessera</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , this is my tool for applying WFC in this engine.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mini sudoku</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an illustrative task, I took a mini </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sudoku</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is a puzzle that looks like a 4 × 4 grid with numbers in some cells.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d2/079/ce5/2d2079ce585502dbe9329e0a34cfbed8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The goal is to fill each empty cell with a number from 1 to 4 in accordance with the rules:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each number from 1 to 4 must be present in each row in a single copy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each number from 1 to 4 must be present in each column in a single copy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each number from 1 to 4 must be present in each 2 × 2 corner square in a single copy. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to these rules, the solution will be as follows:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9e/ebf/927/d9eebf92740912d10aaaf6e63db189f3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You may have easily solved this puzzle. </font><font style="vertical-align: inherit;">But we are interested in how a computer can do this. </font><font style="vertical-align: inherit;">The problem can be divided into two parts: a description of the conditions for the computer, and then a solution using the algorithm.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description of conditions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually, a programming language in restrictions is used for this. There are several such languages, and their principles of action are similar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First we define the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">variables</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Here they are not the same as in conventional programming. In the context of a problem solver, a variable is an unknown value that must be solved to solve a problem. In our Sudoku example, we will create variables for all empty cells. For convenience, you can also create variables for filled cells. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then for each variable we define a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">domain</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : a set of possible values. In our sudoku, for each empty cell, the domain will be {1, 2, 3, 4}. And for a cell in which 1 is already entered, the domain will be {1}. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, we set the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">constraints</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: rules binding our variables. </font><font style="vertical-align: inherit;">In most programming languages, there is already a function with restrictions </font></font><code>all_distinct(..)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that needs to pass unique values. </font><font style="vertical-align: inherit;">So Sudoku rules can be translated into 12 constraints </font></font><code>all_distinct</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- one for each row and column, as well as for 2 × 2 corner squares. </font><font style="vertical-align: inherit;">We need only one type of constraint to solve this problem, however, problem solvers for satisfying the constraints usually come with a large library of different kinds of constraints to describe your problem. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : in practice, programming languages ​​support arrays in constraints, so there are more accurate ways of formulating this task. </font><font style="vertical-align: inherit;">There are many articles on the net about solving sudoku.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithms for solving constraint satisfaction problems</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are several different solution techniques. </font><font style="vertical-align: inherit;">But I will consider the simplest of them to demonstrate to you the principle of their work. </font><font style="vertical-align: inherit;">Domains for each cell are shown here:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/192/dd5/6d7/192dd56d7c6fad65e9d0ff0cd672b8b8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are all possible values ​​in variable domains. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now take the first limitation. </font><font style="vertical-align: inherit;">It requires that all values ​​in the top row are unique. </font><font style="vertical-align: inherit;">In one cell, the value 4 is already inscribed, therefore, in other cells of the series this value can </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not be</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We remove it from the domains of these cells.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ea5/f37/ab8/ea5f37ab81c6fe4e923999a01d9c5b81.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Repeat this process with all 12 restrictions. </font><font style="vertical-align: inherit;">This is called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propagation of restrictions</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , because information is distributed from a variable to another through restrictions.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c06/08e/1fa/c0608e1fa9d933b28269217ae9678831.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And look, we have variables, in the domains of which there is one value left. </font><font style="vertical-align: inherit;">These </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">should</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> be the correct solutions for these variables.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/02e/074/d2c/02e074d2cdcde1220efade75f26d7234.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that we can get even more benefit from the distribution of restrictions: the new red units indicate that we will have even more variables with a single domain, and this will also contribute to the distribution. </font><font style="vertical-align: inherit;">Repeat the procedure until the puzzle is solved.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f78/94d/b63/f7894db63f3238fab4cf689941bd9d69.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We complicate the task</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, not all logic puzzles can be solved so quickly. </font><font style="vertical-align: inherit;">Here is a big sudoku, it works the same way, except that now we have 9 different values, 9 rows, 9 columns and 9 3 × 3 squares.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fd2/97d/434/fd297d4345a2593633a88bbf0bf26764.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we try to apply the above technique, then we’ll get stuck:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/481/f68/a82/481f68a826b65b43441ddae08821f1ba.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now all the restrictions are common, but there are still undefined variables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A person will decide this, but a computer algorithm will not be able to. The manuals for people say that now we need to look for more and more complicated logical conclusions. But we do not need a computer algorithm to do this, because it is difficult, but we need a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">universal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> algorithm that can work with any set of restrictions, and not just according to sudoku rules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, computers do the most stupid thing: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">they assume</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . First, we record the current state of the puzzle. Then we select an arbitrary variable and set it to one of the possible values. Let's say we assign the value 1 to the central cell.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can spread the restrictions a bit more. </font><font style="vertical-align: inherit;">Here's what I got for the center column:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f8b/176/f83/f8b176f83864aad8a4907714b7d0b790.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The blue values ​​are the conclusions we made after the assumption. </font><font style="vertical-align: inherit;">As you can see, something happened. </font><font style="vertical-align: inherit;">We put down a few more variables, but take a look at the middle upper cell. </font><font style="vertical-align: inherit;">It is empty: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in its domain there are no possible values</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> satisfying the restrictions (there cannot be 5, because this value already exists in the same 3 × 3 square, and all other numbers are already in this column). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we get a variable with an empty domain, this means that we cannot assign it any value. </font><font style="vertical-align: inherit;">That is, the puzzle cannot be solved. </font><font style="vertical-align: inherit;">It turns out that </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">our assumption was erroneous</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faced with such a contradiction, we perform the </font><strong><font style="vertical-align: inherit;">return search</font></strong><font style="vertical-align: inherit;"> process</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(backtracking). First, we restore the state that was before our assumption. Then we remove from the domain the value that we used as an assumption - it can no longer be the correct answer.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b1f/6b5/684/b1f6b5684064aab0ed2c355774b3d7aa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lot of work has been done, but they have moved forward. However, even after exclusion of 1 from the central cell, we are still at a dead center. It's time to make an assumption again, and again, and again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are not many algorithmic actions here. Every time we can’t distribute restrictions, we make an assumption and move on. And since you can get stuck several times before encountering a contradiction, then you will accumulate several saved states and assumptions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With each iteration with a return, you reduce the domain by at least one variable, so that, despite numerous rollbacks, the algorithm </font><font style="vertical-align: inherit;">will </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eventually</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> complete the work.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This topic is much more extensive than I describe. </font><font style="vertical-align: inherit;">In practice, optimizations such as the choice of assumptions, understanding when to distribute, and when to make more complex logical conclusions can have a huge impact on program execution. </font><font style="vertical-align: inherit;">And since problems with constraints, as a rule, grow exponentially, you can get an answer tomorrow, or after 5000 years.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We return to the collapse of the wave function</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The collapse of the wave function is a tricky task with a limitation: there are thousands of possible solutions. If we make assumptions randomly, then instead of a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solver,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we get a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generator</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . At the same time, it will still comply with all the given restrictions, that is, it will be much more manageable than most other procedural generators. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task of the WFC algorithm is to fill cells with tiles so that the images on the tiles are combined with each other. Within the terminology used above, each tile is a value, each cell is a variable, and the rules for placing tiles are constraints.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maxim, the author of WFC, found that with a reasonable choice of tiles and appropriate randomization, you rarely have to use backtracking, so this procedure can not be implemented. </font><font style="vertical-align: inherit;">Thus, the essence of WFC is as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A boolean array is created for each cell, which represents the domain of this variable. </font><font style="vertical-align: inherit;">Domains contain one record per tile, and all of them are initialized with a value </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A tile enters a domain if its value is equal </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the same time, there are cells in which domains contain several elements:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selection of a random cell using the heuristic method of "least entropy".</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Select a random tile from the cell domain and remove all other tiles from there.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Updating the domains of other cells based on this new information is the spread of cell restriction. </font><font style="vertical-align: inherit;">This must be done repeatedly, as changes in the cells can have further consequences.</font></font></li>
</ul></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : my terms are different from the terms of Maxim. </font><font style="vertical-align: inherit;">He calls the array of domains a wave, and choosing a random tile is an observation. </font><font style="vertical-align: inherit;">That is, an analogy is drawn with quantum mechanics. </font><font style="vertical-align: inherit;">But the comparison is superficial, so we will ignore it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are many additions to the above principles that add grace and performance to the algorithm. </font><font style="vertical-align: inherit;">But let's first look at the steps described.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's say we need to fill a 3 by 3 grid with four types of tiles:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/749/647/d6b/749647d6ba27126a9e7769a479cd79a5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The limitations are: the colors of adjacent tiles must match each other. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As in the Sudoku example, I will illustrate the contents of domains with monochrome images. </font><font style="vertical-align: inherit;">When there is only one element left in the domain, I will increase it in size and show it in color. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, in each cell, tiles of any kind can be located:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/780/406/ba9/780406ba92fd3d6cd89234b1aa2b8431.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the main WFC loop. </font><font style="vertical-align: inherit;">Randomly select a cell, for example, the upper left. </font><font style="vertical-align: inherit;">Now select a tile in the domain and delete all the others.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6b/053/8a4/c6b0538a47c9355d22fe75fada7252cc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Distribute the restrictions. </font><font style="vertical-align: inherit;">The only rule applies to adjacent tiles, so we need to update two cells:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/90e/a7f/440/90ea7f440d0b3805b324a4bbaef6a7e3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Can we update other tiles given the shrinking domains? </font><font style="vertical-align: inherit;">Yes! </font><font style="vertical-align: inherit;">Although we are not sure about the choice of the first tile, we see that the remaining options lead to the right. </font><font style="vertical-align: inherit;">That is, some types of tiles can not be put in the upper right corner. </font><font style="vertical-align: inherit;">Same thing with the bottom left corner.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4dc/4f3/d07/4dc4f3d070fe3268639e9fc3e2877661.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can no longer distribute the restrictions, so we repeat the main cycle: cell selection, tile selection and distribution. </font><font style="vertical-align: inherit;">This time we take the upper middle cell:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b58/44c/01a/b5844c01a98770f203587dd46d02a3df.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another cycle: take the left middle cell. </font><font style="vertical-align: inherit;">After the proliferation of restrictions for the central cell, one possible value remains.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/066/f76/a13/066f76a13cda6b5e275a371b3561c02a.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, you understand the idea. </font><font style="vertical-align: inherit;">You can fill in the rest of the cells yourself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to experiment with a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">more complex interactive example</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I recommend </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this one</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Smallest entropy</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When choosing the next cell to fill in, some options will be preferable. </font><font style="vertical-align: inherit;">If you randomly choose from anywhere in the grid, a situation may arise when at the same time you will have different areas of the grid filled. </font><font style="vertical-align: inherit;">This can lead to problems: depending on the tiles available, the filled areas cannot be joined. </font><font style="vertical-align: inherit;">So it’s better to choose cells that are less likely to lead to such problems in the future. </font><font style="vertical-align: inherit;">In other words, you need to take cells with the least number of possible values ​​in the domain (but not less than two values):</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Most likely, they will be next to the already filled cells.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If we leave them for the future, then difficulties may arise, because the available values ​​are already few.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The smallest domain approach works well if all tiles are equally likely. </font><font style="vertical-align: inherit;">But if you choose from a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weighted random distribution</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then you need to consider something else. </font><font style="vertical-align: inherit;">Maxima recommends “minimal entropy”, that is, choose a cell that minimizes:</font></font><br>
<br>
<p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>e</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>y</mi><mo>=</mo><mo>&amp;#x2014;</mo><mo>&amp;#x2211;</mo><msub><mi>p</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi></mrow></msub><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msub><mi>p</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi></mrow></msub><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="25.41ex" height="3.634ex" viewBox="0 -1024.6 10940.2 1564.8" role="img" focusable="false" style="vertical-align: -1.255ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-65" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-6E" x="466" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-74" x="1067" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-72" x="1428" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-6F" x="1880" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-70" x="2365" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-79" x="2869" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMAIN-3D" x="3644" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMAIN-2014" x="4422" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJSZ2-2211" x="5589" y="0"></use><g transform="translate(7201,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-69" x="712" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-6C" x="8048" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-6F" x="8347" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-67" x="8832" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMAIN-28" x="9313" y="0"></use><g transform="translate(9702,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-69" x="712" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMAIN-29" x="10550" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>e</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>y</mi><mo>=</mo><mo>—</mo><mo>∑</mo><msub><mi>p</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msub><mi>p</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1">entropy = — \sum p_{i}log(p_{i})</script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a summation of tiles in the domain where </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi></mrow></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.059ex" height="1.884ex" viewBox="-38.5 -540.2 886.3 811.3" role="img" focusable="false" style="vertical-align: -0.63ex; margin-left: -0.089ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/mailru/blog/497590/&amp;usg=ALkJrhjYUeP2Ebrbo9W2tELV-Wrk7_l7PQ#MJMATHI-69" x="712" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>p</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-2">p_{i}</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - probability for this tile.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Efficient computing</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although I do not want to go into details, however, there are two optimizations that allow me to increase the speed so much that they cannot be ignored. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since our only rule is related to adjacent tiles, we can only check those restrictions that can give results that differ from the previous ones. That is, when updating a cell, we add it to the queue of cells awaiting a decision. Then we remove one cell from the queue, each time checking its adjacent cells. If such checks lead to the renewal of other cells, they also fall into the queue. Repeating this procedure until the queue is empty, we make sure that we check all the restrictions. But we do not check them until the domain of at least one cell associated with these restrictions changes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, to check the adjacency constraint, we need to answer the question: “Given the tiles in the domain of cell A, what tiles are possible in the domain of cell B if the cells are adjacent?” </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes this question is called the “support” of cell A. For a given tile “b” in domain B, it is easy to calculate the cycles for tiles in domain A. If A has at least one tile that can be placed next to “b”, then “b” still suitable, at least for the pair of tiles in question. If in A there is no such tile, then you cannot put tile “b” from domain B, and we can discard it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Loops make it easy to implement this in code, but will work extremely slowly. </font><font style="vertical-align: inherit;">And if we store information in an additional data structure, we can quickly answer the question as necessary. </font><font style="vertical-align: inherit;">The new data is a large array with entries for each side of each cell and each tile. </font><font style="vertical-align: inherit;">In our example, there are 9 cells, each with 4 sides, and 4 types of tiles. </font><font style="vertical-align: inherit;">So we need 9 * 4 * 4 records. </font><font style="vertical-align: inherit;">We will save support counters in the array: for each cell / tile / side, we count the number of tiles in the adjacent cell domain that can be placed next to the tile in question. </font><font style="vertical-align: inherit;">If the counter drops to zero, then this tile cannot be put, because no one can be adjacent to it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algorithm Extensions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Because WFC is based on a more general understanding of constrained problems, there are many ways to extend the algorithm by changing the constraints used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the obvious changes is that no one forces us to use square cells. WFC works great on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hexagonal cells, in three dimensions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or even more </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unusual surfaces</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98f/35a/0b9/98f35a0b9ccd9fd4fce689cd7f911d64.png" width="300"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/848/881/d32/848881d3216ac003a312c1fc8cfd56ea.png" width="300"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/497/0d2/706/4970d270636d7203d3e8e1e4bcb4befd.png" width="300"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can introduce additional restrictions: fix certain tiles, or create “modules” from several cells. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The introduction of additional restrictions can play a very important role from a practical point of view. </font><font style="vertical-align: inherit;">Since WFC limits only adjacent tiles, it rarely generates large structures that provide a high level of homogeneity and look unusual. </font><font style="vertical-align: inherit;">This algorithm works best when choosing tiles, but to work with some large structures, it is better to use a different technique or introduce other restrictions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">another article,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I talked about how you can achieve the best results from WFC.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overlapping WFC</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the interesting extensions to the algorithm is the “overlapping” WFC. In the above examples, the main limitation was related to pairs of adjacent tiles. This is enough to ensure the connection of lines and create simple structures like caves, rooms, etc. But at the same time a lot of information is lost. If we need, say, that red tiles are always located next to the blue, but never were adjacent to them, then it will be difficult to express in terms of only adjacency. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maxim proposed the concept of overlapping WFC: we replace the adjacency constraint with a new constraint that affects several tiles at once. For example, so that at the output each group of 3 × 3 cells corresponds to a 3 × 3 group from a grid sample. The patterns present in the sample will be repeated over and over again in different variations at the output:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/42d/72b/b76/42d72bb7631b24f33858756ade67fa55.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This restriction is much more sensitive than “simple” adjacency restrictions. </font><font style="vertical-align: inherit;">And since it depends on a given sample, it is very suitable for solving some kind of artistic tasks. </font><font style="vertical-align: inherit;">So far, I have not come across anything as interesting. </font><font style="vertical-align: inherit;">Perhaps the reason is that such an algorithm is more difficult to implement, or it works more slowly, or sometimes it reproduces the original sample too well, which causes some kind of naturalness and naturalness to be lost.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What's next?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solving problems with restrictions is a large and actively developing field of computer science, and I only touched on it. </font><font style="vertical-align: inherit;">WFC - just like any other procedural generation algorithm for solving constrained problems - is still new. </font><font style="vertical-align: inherit;">I recommend reading </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r / proceduralgeneration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#wavefunctioncollapse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@exutumno</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@osksta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to get an idea of ​​recent use cases. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also read my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article about WFC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , experiment with my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opensource library</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unity tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Do not forget about my other articles on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">procedural generation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497578/index.html">AMD is committed to gaining a significant share of the market for data centers</a></li>
<li><a href="../en497580/index.html">Hard quarantine is very very bad</a></li>
<li><a href="../en497582/index.html">Habr takes first place in the ranking of digital rights of users</a></li>
<li><a href="../en497584/index.html">Quantified self: how Madrobots brought Picooc smart scales to Russia</a></li>
<li><a href="../en497588/index.html">Spring Security - An OAuth2 Authorization Web Application Example Through BitBucket</a></li>
<li><a href="../en497594/index.html">External data storage: from the time of IBM 1311 to the present day. Part 1</a></li>
<li><a href="../en497596/index.html">Long live PHP</a></li>
<li><a href="../en497602/index.html">Do you consider yourself a signor? Who are you kidding</a></li>
<li><a href="../en497606/index.html">Automatic garden watering system for Home Assistant, ESP8266 and MiFlora</a></li>
<li><a href="../en497608/index.html">How Traffic Analysis Systems Detect Hacker Tactics by MITER ATT & CK, Part 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>