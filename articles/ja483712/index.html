<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐂 🥒 📬 HighLoad ++、Yuri Nasretdinov（VK）：VKが数万台のサーバーからClickHouseにデータを挿入する方法 👮 🐠 👐🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HighLoad ++モスクワ2018、議会ホール。11月9日15:00 
 
 要約とプレゼンテーション：http : 
 
 //www.highload.ru/moscow/2018/abstracts/4066 Yuri Nasretdinov（VK）：レポートでは、当社でClickHous...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++、Yuri Nasretdinov（VK）：VKが数万台のサーバーからClickHouseにデータを挿入する方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/483712/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++モスクワ2018、議会ホール。</font><font style="vertical-align: inherit;">11月9日15:00 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要約とプレゼンテーション：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
//www.highload.ru/moscow/2018/abstracts/4066 Yuri Nasretdinov（VK）：レポートでは、当社でClickHouseを実装した経験について話します-なぜそれが必要なのですか保存するデータの量、データの書き込み方法など。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/82/hn/hb/82hnhbxzvzseq8_viregjypt_ms.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
追加リソース：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickhouseをELK、Big Query、TimescaleDBの代替として使用する</font></font></a><a name="habracut"></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yuri Nasretdinov：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -みなさん、こんにちは！</font><font style="vertical-align: inherit;">彼らはすでに私を紹介してくれたので、私の名前はユリ・ナスレディノフです。</font><font style="vertical-align: inherit;">私はVKontakteで働いています。</font><font style="vertical-align: inherit;">サーバー群（数万台）から「ClickHouse」にデータを挿入する方法について説明します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログとは何ですか。なぜログを収集するのですか。</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
話する内容：何をしたか、なぜ「ClickHouse」が必要だったのか-なぜそれを選んだのか、意図的に何も設定しなくても、どのようなパフォーマンスが得られるか。バッファテーブル、バッファテーブルで発生した問題、オープンソースから開発したKittenHouseとLighthouseのソリューションについて詳しく説明します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j8/gj/qv/j8gjqvhcihgkbedpsmonpxznjto.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜ何もしなくてはならなかったのはなぜですか（VKontakteではすべてが常に問題ありませんよね？）。デバッグログを収集したかった（そして数百テラバイトのデータがそこにあった）、おそらく、どういうわけか、統計を読む方が便利です。そして、私たちは何万ものサーバーを所有しており、そこからこれらすべてを実行する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pc/og/3w/pcog3wkh42pnfsdpwshhnu-1xqa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうして決めたの？ログを保存するためのソリューションはおそらくありました。ここに-そのような公開「バックエンドVK」があります。私はそれに加入することを強くお勧めします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/15/xd/b3/15xdb3ma4wv43trpduxyujyo1w0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログとは何ですか？</font><font style="vertical-align: inherit;">これは空の配列を返すエンジンです。</font><font style="vertical-align: inherit;">「VK」のエンジンは、他の人がマイクロサービスと呼ぶものと呼ばれます。</font><font style="vertical-align: inherit;">そして、そのようなステッカーは笑っています（かなりたくさんのいいね）。</font><font style="vertical-align: inherit;">どうして？</font><font style="vertical-align: inherit;">まあ、聞いてください！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xm/xr/rf/xmxrrfccutg7p6ylcy9-zoyi8ba.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログを保存するために一般的に使用できるものは何ですか？</font><font style="vertical-align: inherit;">「Khadup」は言うまでもありません。</font><font style="vertical-align: inherit;">次に、たとえば、Rsyslog（これらのログのファイル内のストレージ）。</font><font style="vertical-align: inherit;">LSD </font><font style="vertical-align: inherit;">LSDが何であるか誰が知っていますか？</font><font style="vertical-align: inherit;">いいえ、このLSDではありません。</font><font style="vertical-align: inherit;">ファイルもそれぞれ保存されます。</font><font style="vertical-align: inherit;">まあ、ClickHouseはある種の奇妙なバージョンです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリックハウスと競合他社：要件と機会</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私達何が欲しいの？特別なスチームバスを使用する必要がないようにしたいので、箱から出して、最小限の設定で動作するようにします。たくさん書いて、速く書いてみたいです。そして、それを数か月、数年、つまり長期間保持したいと考えています。彼らが私たちに来たある種の問題を整理したいかもしれません-彼らは「何かが私たちにとってここではうまくいかない」と言いましたが、これは3か月前でした）、そして私たちは3か月前にそれを見ることができるようにしたいです」データ圧縮-それがプラスになる理由は理解できます-占有されるスペースの量が削減されるためです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/f7/bs/hof7bsmyf40jzgxireygut6jpks.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私たちは非常に興味深い要件を持っています。いくつかのコマンド（たとえば、ログ）の出力をときどき書き込みます。それは、非常に穏やかに4キロバイトを超えることがあります。そして、これがUDPで機能する場合は、費やす必要はありません。接続に「オーバーヘッド」はありません。多数のサーバーの場合、これはプラスになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/pj/3i/jhpj3iedzogld0galjmia2npwe4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オープンソースが私たちに提供するものを見てみましょう。まず、Logs Engineがあります-これが私たちのエンジンです。彼は基本的にすべてを知っています、長い行でも書くことができます。まあ、それはデータを透過的に圧縮しません-必要な場合は自分で大きな列を圧縮することができます...もちろん、したくない場合は（可能な場合）。唯一の問題は、彼は自分の記憶にあるものだけを与えることができるということです。残りの部分を読むには、このエンジンのバイナリログを取得する必要があるため、かなり時間がかかります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ps/uk/f5/psukf5cng6yokwi5cbtvvrfry30.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のオプションは何ですか？たとえば、Khadupです。使いやすさ... Hadoupは設定が簡単だと誰が信じていますか？もちろん録音も問題ありません。読書では、質問が時々発生します。原則として、特にログについては、そうではない可能性が最も高いと言えます。長期保存-もちろん、データ圧縮-はい、長い行-書き込みできることは明らかです。しかし、多数のサーバーから録音するには...とにかく、私たちは自分で何かをしなければなりません！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rsyslog。実際、私たちはそれをフォールバックとして使用したため、ダンプなしでbinlogを読み取ることは可能ですが、長い行に書き込むことはできず、原則として4キロバイトを超えて書き込むことはできませんでした。データ圧縮も同じ方法で行う必要があります。読み取りはファイルから行われます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/xo/k3/ntxok3kz6sqyggmdlctpxrokprs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、LSDの「悪い」開発があります。本質的には「Rsyslog」と同じです。長い行をサポートしますが、UDPの使用方法がわかりません。実際、これが原因で、残念ながら、そこに書き直すことがたくさんあります。数万台のサーバーから記録できるように、LSDをやり直す必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2s/xr/fw/2sxrfwyzgj72wfqblvhlu8fphf0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてここ！面白いオプションはElasticSearchです。どのように言って？読むことはすべてうまくいきます。つまり、彼はすばやく読みますが、書くことはあまり上手ではありません。まず、データを圧縮すると、非常に脆弱になります。ほとんどの場合、本格的な検索には、元のボリュームよりも大量のデータ構造が必要です。悪用するのは難しく、しばしば問題が発生します。そして、再び、「Elastic」のエントリー-私たちはすべて自分でやらなければなりません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wb/uv/ik/wbuvikg6tm42r0pjhkrtdrcye08.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここClickHouse-もちろん理想的なオプションです。</font><font style="vertical-align: inherit;">唯一のことは、何万ものサーバーからの録音が問題です。</font><font style="vertical-align: inherit;">しかし、彼女は少なくとも1人です。私たちはそれを何とか解決しようとすることができます。</font><font style="vertical-align: inherit;">そしてレポートの残りはこの問題についてです。</font><font style="vertical-align: inherit;">ClickHouseの全体的なパフォーマンスはどの程度期待できますか？</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのように埋め込みますか？</font><font style="vertical-align: inherit;">MergeTree</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClickHouseについて聞いたことがない人はどれくらいいますか？言う必要はありませんか？とても早い。挿入は1〜2ギガビット/秒であり、最大10ギガビット/秒のバーストは実際にそのような構成に耐えることができます。2つの6コアXeon（つまり、最も強力なものでもありません）、256ギガバイトのRAM、20テラバイト/秒です。 RAID（誰も設定されていない、デフォルト設定）。 ClickHouseの開発者であるAlexey Milovidovは、おそらく何も設定しなかったと（おそらくすべてがうまくいきました）と叫んでいます。したがって、データが十分に圧縮されている場合、たとえば毎秒約60億行のスキャン速度が得られます。あなたがテキスト行の％が好きなら-1秒あたり1億行、つまり、それは非常に迅速に思えます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mu/m0/ih/mum0ihdgejlxldsd9id8ijjytx8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どのように埋め込みますか？まあ、あなたはそれを "VK"-PHPで知っています。各PHPワーカーから、HTTP経由で「ClickHouse」、各エントリのMergeTreeプレートに貼り付けます。誰がこの回路の問題を理解していますか？何らかの理由で、全員が手を挙げたわけではありません。教えましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、多くのサーバーがあります-したがって、多くの接続があります（悪い）。その後、MergeTreeでは、1秒に1回だけデータを挿入することをお勧めします。そして、誰がその理由を知っていますか？いいですねこれについてもう少しお話します。もう1つの興味深い質問は、分析を行わない場合でも、データを充実させる必要がないか、中間サーバーを必要としないか、「ClickHouse」に直接埋め込むことをお勧めします（できれば-直線的であるほど優れています）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2r/im/hz/2rimhzqo0cxkonc8paf7pi2qae0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、MergeTreeで挿入はどのように実装されますか？ 1秒に1回以下で挿入する方が良いのはなぜですか？ 「ClickHouse」は列データベースであり、主キーの昇順でデータを並べ替えます。挿入すると、少なくとも主キーの昇順でデータが並べ替えられる列の数によってファイルの数が作成されます（別のディレクトリが作成され、挿入ごとにディスク上のファイルのセット）。次に、次の挿入が行われ、バックグラウンドで、より大きな「パーティション」にマージされます。データはソートされているため、メモリを大量に消費することなく、2つのソートされたファイルを「ジャグリング」できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ご想像のとおり、各挿入に10個のファイルを書き込むと、「ClickHouse」はすぐに終了します（またはサーバー）。そのため、大きなバッチで挿入することをお勧めします。</font><font style="vertical-align: inherit;">したがって、本番環境で最初のスキームを立ち上げることはありませんでした。</font><font style="vertical-align: inherit;">ここで2 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7z/0d/yt/7z0dytuytercg92yrt1nu3tpczw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
番目のサーバー</font><font style="vertical-align: inherit;">をすぐに起動しました。起動した</font><font style="vertical-align: inherit;">サーバーは約1,000台あり、それは単なるPHPだと想像してください。</font><font style="vertical-align: inherit;">また、各サーバーには「Kittenhouse」と呼ばれるローカルエージェントがあり、「ClickHouse」への接続を1つ保持し、数秒ごとにデータを挿入します。</font><font style="vertical-align: inherit;">MergeTreeにデータを挿入するのではなく、MergeTreeに直接挿入しないようにするスプーラーテーブルにデータを挿入します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zu/ok/g1/zuokg1unbbwdege3mpsckf8npme.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファテーブルを操作する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは何ですか？バッファテーブルは、シャッフルされたメモリの一部です（つまり、多くの場合、テーブルを挿入できます）。それらはいくつかのピースで構成され、各ピースは独立したバッファーとして機能し、独立してフラッシュします（バッファーに多数のピースがある場合、1秒あたりの挿入数が多くなります）。これらのテーブルから読み取ることができます-次に、バッファーの内容と親テーブルの和集合を読み取りますが、その時点ではレコードがブロックされているため、そこから読み取らないようにすることをお勧めします。そして、非常に優れたQPSがバッファーテーブルによって示されます。つまり、最大3000 QPSの場合、挿入にまったく問題はありません。サーバーで電源が失われた場合、データはメモリにのみ保存されていたため、データが失われる可能性があることは明らかです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4p/rg/l1/4prgl1wcijnrxs6zcgz2gmybvec.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、古いスキームで古いバッファテーブルを最初に削除する必要があるため、ALTERによってバッファを使用するスキームは複雑になります（テーブルが削除される前にフラッシュされるため、データはこの場合失われません）。</font><font style="vertical-align: inherit;">次に、必要なテーブルを「変更」して、バッファテーブルを再度作成します。</font><font style="vertical-align: inherit;">したがって、バッファテーブルはありませんが、データはどこにも注がれていませんが、少なくともディスク上でローカルにできます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nv/vx/ek/nvvxekkpy2bcezjpuylifhcworq.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kittenhouseとは何ですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
子猫ハウスとは？</font><font style="vertical-align: inherit;">これはプロキシです。</font><font style="vertical-align: inherit;">どの言語を推測しますか？</font><font style="vertical-align: inherit;">私はレポートで最も誇大広告のトピックを収集しました-これは「Clickhouse」です、Go、おそらく私は何か他のものを思い出すことができます。</font><font style="vertical-align: inherit;">はい、それはGoで書かれています。Cで書く方法が本当にわからないので、したくありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6r/1w/th/6r1wthqhe4flw_7t7ww01s5arug.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、各サーバーとの接続を維持し、メモリに書き込むことができます。たとえば、「Clickhouse」にエラーログを書き込んだ場合、「Clickhouse」にデータを挿入する時間がない場合（結局、書き込みが多すぎる場合）、メモリが膨らむことはなく、残りを捨てるだけです。というのも、毎秒数ギガビットのエラーを書き込むと、おそらくエラーになる可能性があるからです。 Kittenhouseはその方法を知っています。さらに、確実に配信する方法を知っています。つまり、ローカルマシンのディスクに書き込み、ときどき（数秒に1回）このファイルからデータを配信しようとします。そして最初は、通常の値形式を使用しました-一部のバイナリ形式ではなく、テキスト形式（通常のSQLのように）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rj/2q/z3/rj2qz3hcwcur_lvha_tc2mxjpwq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは起こりました。</font><font style="vertical-align: inherit;">私たちは信頼できる配信を使用し、ログを書き、それを決定しました（これは条件付きのテストクラスターでした）...彼らは数時間それを出し、それを持ち上げ、数千のサーバーから挿入を開始しました-Klickhouseにはまだ「スレッド接続」-したがって、1,000接続では、アクティブな挿入により、サーバーの平均負荷が約1.5になります。</font><font style="vertical-align: inherit;">驚いたことに、サーバーは要求を受け入れましたが、それでもそのようなデータはしばらくして挿入されました。</font><font style="vertical-align: inherit;">しかし、サーバーがサービスを提供するのは非常に困難でした...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginxを追加</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続ごとのスレッドモデルのこのようなソリューションはnginxです。 Clickhouseの前にnginxを配置し、同時に2つのレプリカにバランシングを設定し（挿入速度を2倍にしましたが、そうする必要があるわけではありません）、Clickhouseへの接続数をアップストリームに制限しました。接続数が50を超えると、挿入しても意味がないようです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7i/ib/9b/7iib9bduvmhr6taouopwj20zzsu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ここにはnginxが1つあるため、一般的にこのスキームには欠点があることに気付きました。したがって、このnginxが横になると、レプリカが存在するにもかかわらず、データが失われるか、少なくともどこにも書き込みが行われません。したがって、負荷分散を行いました。また、「Clickhouse」はまだログに適していることもわかりました。また、「デーモン」も「Clickhouse」に独自のログを書き込むようになりました。正直に言うと、とても便利です。これまでは、他の「悪魔」にも使用しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/o4/v3/pxo4v3tnrrxwye_tjavgb2p3kgu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それから彼らはそのような興味深い問題を発見しました：SQLモードで挿入するのにかなり標準的ではない方法を使用すると、本格的なAST SQLベースのパーサーが強制されますが、これはかなり低速です。</font><font style="vertical-align: inherit;">そのため、これが発生しないように設定を追加しました。</font><font style="vertical-align: inherit;">負荷分散とヘルスチェックを行ったので、1つが死んだ場合でもデータを残しています。</font><font style="vertical-align: inherit;">十分な数のテーブルを取得したので、異なる「Clickhouse」クラスターを用意する必要があります。</font><font style="vertical-align: inherit;">それでも、他の用途について考え始めました。たとえば、nginxモジュールからログを書き込みたいのですが、RPCを使用して通信できません。</font><font style="vertical-align: inherit;">まあ、私はどういうわけか彼らに送信する方法を教えたいと思います-たとえば、ローカルホストでイベントを受信するためにUDPを介して、それからそれらを「クリックハウス」に送信します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">決定から一歩</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最終的なスキームは次のようになりました（このスキームの4番目のバージョン）：Clickhouseの前の各サーバーにはnginx（同じサーバー上にある）があり、接続の数を50個に制限してローカルホストへのリクエストを単にプロキシします。そして今、このスキームはすでに機能しており、かなりうまくいきました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/co/ea/sw/coeaswk1ttzg--hk_nz-exq19l0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こんな感じで一ヶ月ほど住んでいました。</font><font style="vertical-align: inherit;">テーブルの追加、追加、追加など、誰もが満足しています。一般的に、バッファテーブルを追加する方法はあまり最適ではないことがわかりました（そうしましょう）。</font><font style="vertical-align: inherit;">各テーブルで16個のピース​​を作成し、数秒間のフラッシュ間隔を設定しました。</font><font style="vertical-align: inherit;">20のテーブルがあり、1秒あたり8つの挿入が各テーブルに行きました。そして、その瞬間にクリックハウスが始まりました...レコードは空白になり始めました。</font><font style="vertical-align: inherit;">Nginxにはデフォルトで非常に興味深い機能があり、接続がアップストリームで終了した場合、すべての新しいリクエストに「502」が与えられます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wd/b-/ih/wdb-ihhsype-ykkjymstxzlq27q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ここ（私が見たまさに「クリックハウス」のログを見たところ）では、リクエストの約半分が失敗しています。</font><font style="vertical-align: inherit;">したがって、ディスク使用率が高く、マージが多かった。</font><font style="vertical-align: inherit;">さて、私は何をしましたか？</font><font style="vertical-align: inherit;">当然、接続とアップストリームエンドが正確になぜなのか理解し始めませんでした。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginxをリバースプロキシで置き換える</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はこれを自分で管理する必要があると判断し、nginxに渡さないでください。nginxは「Clickhouse」内のテーブルがわからないため、nginxをリバースプロキシに置き換えました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7u/pv/ve/7upvvezqfizgs73uazcnuqz8edm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼は何をしているの？</font><font style="vertical-align: inherit;">これはfasthttpライブラリ「goosh」に基づいて動作します。つまり、nginxとほぼ同じくらい高速です。</font><font style="vertical-align: inherit;">申し訳ありませんが、イゴール、ここにいる場合（注：イゴールSysoevはnginx Webサーバーを作成したロシアのプログラマーです）。</font><font style="vertical-align: inherit;">彼はそれがどのような種類のクエリであるか（INSERTまたはSELECT）をそれぞれ理解でき、クエリの種類ごとに異なる接続プールを保持しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ub/q1/43/ubq143ugu8fsrxicwobmwn8veni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、リクエストを完了する時間がない場合でも、「選択」は成功し、逆も同様です。そして、それはデータをバッファテーブルにグループ化します-小さなバッファ：エラー、構文エラーなどがあった場合-それらが残りのデータにわずかに影響するようにしました。なぜなら、バッファテーブルに単に挿入したとき、私たちは小さな「 bachi "、そして構文エラーのすべてのエラーはこの小さな部分にのみ影響しました。そしてここで、それらはすでに大きなバッファに影響を与えます。小は1メガバイトです。つまり、それほど小さくありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/16/zx/hh/16zxhh_8qun8kzdyjd3i3ysnxzs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同期を挿入し、本質的にnginxを置き換えると、本質的にnginxと同じことを行います-これのために子猫ハウスをローカルで変更する必要はありません。</font><font style="vertical-align: inherit;">また、fasthttpを使用しているため、非常に高速です。リバースプロキシを介して、1秒あたり10万件以上の単一挿入をリクエストできます。</font><font style="vertical-align: inherit;">理論的には、キティハウスのリバースプロキシに1行挿入できますが、実際には挿入しません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dv/u5/w8/dvu5w8totg6sa3wexahrky4xcsu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキームは次のようになりました。リバースプロキシであるKittenhouseは、多くのリクエストをテーブルにグループ化し、バッファテーブルがそれらをメインのリクエストに挿入します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キラー-一時的な解決策、子猫-永久</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような興味深い問題がありました... fasthttpを使用した人はいますか？ POSTリクエストでfasthttpを使用したのは誰ですか？おそらく、これはデフォルトでリクエスト本文をバッファリングするため、実際にこれを行う価値はありませんでした。また、バッファサイズを16メガバイトに設定しました。挿入はある時点で間に合わなくなり、数万のサーバーすべてから16メガバイトのチャンクが受信され始め、それらはすべてClickhouseに送信される前にメモリにバッファーされました。したがって、メモリが不足し、メモリ不足キラーが発生し、リバースプロキシ（または理論的にはリバースプロキシよりも「食べる」ことができる「クリックハウス」）を殺しました。このサイクルが繰り返されました。それほど問題ではありません。数か月の運用の後でしかこれに出くわしませんでしたが。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は何をしましたか？</font><font style="vertical-align: inherit;">繰り返しになりますが、私は実際に何が起こったのかを理解するのは本当に好きではありません。</font><font style="vertical-align: inherit;">メモリにバッファリングする必要がないことは、私にはかなり明白なようです。</font><font style="vertical-align: inherit;">試しましたが、fasthttpにパッチを適用できませんでした。</font><font style="vertical-align: inherit;">しかし、何もパッチを適用する必要がないようにそれを作成する方法を見つけ、HTTPで独自のメソッド（KITTENと呼ばれる）を思い付きました。</font><font style="vertical-align: inherit;">まあ、それは論理的です-「VK」、「子猫」...他にどのように？..</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/r5/cu/o9r5cugeck0dm4gc_macqqzymgg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストがKittenメソッドでサーバーに届いた場合、サーバーは「ニャー」と論理的に答えます。</font><font style="vertical-align: inherit;">彼がこれに答えた場合、彼はこのプロトコルを理解していると考えられ、接続をインターセプトし（fasthttpにはそのようなメソッドがあります）、接続は「raw」モードになります。</font><font style="vertical-align: inherit;">なぜ必要なのですか？</font><font style="vertical-align: inherit;">TCP接続からの読み取りが発生する方法を制御したい。</font><font style="vertical-align: inherit;">TCPにはすばらしい特性があります。その側から誰も読み取らない場合、レコードは待機を開始し、メモリは特にこれに費やされません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私は一度に50のクライアントから一度にどこかを読みました（別のDCから来たとしても50で十分であるため、50からです）...このアプローチで消費量は少なくとも20回減少しましたが、正直に言って、それはすでに無意味であるため（正確に測定することはできませんでした）（すでにエラーのレベルになっています）。</font><font style="vertical-align: inherit;">プロトコルはバイナリです。つまり、テーブル名とデータがあります。</font><font style="vertical-align: inherit;">httpヘッダーがないため、Webソケットを使用しませんでした（ブラウザーと通信する必要はありません。私たちのニーズに合ったプロトコルを作成しました）。</font><font style="vertical-align: inherit;">そして彼と一緒にすべてが大丈夫だった。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファテーブルが悲しい</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、バッファテーブルのさらに興味深い機能に出会いました。そして、この問題は他の問題よりもはるかに苦痛です。この状況を想像してみてください。「Clickhouse」をすでにアクティブに使用していて、数十の「Clickhouse」サーバーがあり、非常に長い時間（たとえば60秒以上）を読み取るリクエストがあるとします。そして、この時点で変更を実行します...そして、「変更」の前に開始した「選択」がこの表に含まれないまで、「変更」は開始しません-「クリックハウス」の仕組みのいくつかの機能この場所。多分これは修正できますか？か否か？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8w/zp/su/8wzpsufzkqmzafrt9vom83joq2i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、これは実際にはそれほど大きな問題ではないことは明らかですが、バッファテーブルを使用する場合は、さらに困難になります。たとえば、「Alter」がタイムアウトになった場合（さらに、別のホストでは暗くなっている可能性があります（たとえば、ホストではなくレプリカ））、そのようなバッファーテーブル、Alter（またはいくつかのその後、Alterエラーが発生しました）-すべて同じデータが引き続き書き込まれる必要があります。バッファーテーブルを（親テーブルと同じスキームに従って）作成し直し、その後、Alterがパスし、まだ完了し、バッファーテーブルは、スキームが親とは異なり始めています。 Alterの内容によっては、挿入がこのバッファーテーブルに移動しない場合があります。これは非常に悲しいことです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/po/om/z0/poomz0as89k3aqxh3pa9xpvrr-4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Clickhouseの新しいバージョンでは、query_thread_logと呼ばれるプレート（おそらくそれに気付いた人）がまだいます。</font><font style="vertical-align: inherit;">デフォルトでは、一部のバージョンでは1つありました。</font><font style="vertical-align: inherit;">ここでは、数か月で8億4,000万件のレコード（100ギガバイト）が蓄積されました。</font><font style="vertical-align: inherit;">これは、そこに「挿入」が書き込まれたという事実によるものです（たぶん、今のところ、それらは書かれていません）。</font><font style="vertical-align: inherit;">先ほどお伝えしたように、小さな「挿入」があります。バッファテーブルにはたくさんの「挿入」があります。</font><font style="vertical-align: inherit;">これがオフになっているのは明らかです-私が私たちのサーバーで見たものをあなたに話しているだけです。</font><font style="vertical-align: inherit;">どうして？</font><font style="vertical-align: inherit;">これは、バッファテーブルの使用に対するもう1つの議論です。</font><font style="vertical-align: inherit;">むらはとても悲しいです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vg/gm/fl/vggmfl00f3pku7iix3k7dfj_-am.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、この同志の名前がSpottyであることを誰が知っていましたか？</font><font style="vertical-align: inherit;">VKの従業員は手を挙げました。</font><font style="vertical-align: inherit;">はい。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KitttenHouseプランについて</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、彼らは計画を共有しませんよね？突然、あなたはそれらを実行しなくなり、他の人の目にはとてもよく見えなくなります。でもチャンスをとります！次のことを実行したいと思います。バッファテーブルは、私には思えますが、まだ松葉杖であり、挿入をバッファリングする必要があります。しかし、それをディスクにバッファリングしたくないので、挿入をメモリにバッファリングします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pd/e0/rd/pde0rdcd8h4mquk684qhfkvmpvq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、「挿入」が行われると、同期は行われなくなります。これはすでにバッファテーブルとして機能し、親テーブルに挿入され（しばらくすると後で）、別のチャネルを介して、通過した挿入とそうでない挿入が通知されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k_/f3/ev/k_f3ev78dpgabrqjogevuzmykvw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同期挿入を終了できないのはなぜですか？彼女ははるかに便利です。実際には、1万のホストから挿入した場合、すべてが問題ありません。各ホストから少しずつ注ぎ、1秒に1回挿入すると、すべて問題ありません。しかし、たとえば2台のマシンからこのスキームを動作させて、高速で注ぐことができるようにします。クリックハウスから最大値を絞り出さずに、リバースプロキシを介して1台のマシンから少なくとも1秒あたり100メガバイトを書き込みます。回路は大きな数と小さな数の両方でスケーリングする必要があるため、1秒ごとに挿入を待つことができないため、非同期である必要があります。そして、非同期の確認は挿入が完了した後に来るはずです。合格したかどうかがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も重要なこととして、このスキームでは、挿入が成功したかどうかが確実にわかります。</font><font style="vertical-align: inherit;">この状況を想像してみてください：バッファテーブルがあり、そこに何かを書き込んだ後、テーブルが読み取り専用になり、バッファをフラッシュしようとしたとします。</font><font style="vertical-align: inherit;">データはどこに行きますか？</font><font style="vertical-align: inherit;">バッファに残ります。</font><font style="vertical-align: inherit;">しかし、これは確信が持てません-突然他のエラーが発生し、データがバッファに残っていないためです...（Alexey Milovidov、Yandex、ClickHouse開発者が対処）またはそれらは残りますか？</font><font style="vertical-align: inherit;">いつも？</font><font style="vertical-align: inherit;">アレクセイはすべてがうまくいくと私たちに納得させます。</font><font style="vertical-align: inherit;">彼を信じない理由はない。</font><font style="vertical-align: inherit;">ただし、バッファテーブルを使用しない場合は、問題はありません。</font><font style="vertical-align: inherit;">原則として大きな問題はありませんが、2倍の数のテーブルを作成することも不便です。</font><font style="vertical-align: inherit;">これが計画です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読書について話す</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、読書について話しましょう。ここでは、独自の楽器も作成しました。まあ、なぜここにあなたの楽器を書くのですか？..そして誰がTavixを使用しましたか？どういうわけか、手を挙げた人はほとんどいません...そして、Tavixのパフォーマンスに満足しているのは誰ですかさて、私たちは満足しておらず、データを表示するのにあまり便利ではありません。分析の場合は問題なく機能しますが、表示するだけの場合は明らかに最適化されていません。したがって、私は自分のインターフェースを作成しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/ko/ud/qykoudjbl76cbexrko1zcmr_wmy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは非常にシンプルです-データを読み取ることしかできません。彼はグラフィックスを表示する方法を知りません、彼は方法を知りません。しかし、それは私たちが必要なものを示す方法を知っています：たとえば、テーブル内の行数、それが取るスペース（列ごとの内訳なし）の量、つまり、非常に基本的なインターフェースが必要です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gp/xa/1f/gpxa1fqutqdl4zr_ngqko2yjpom.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、Sequel Proと非常によく似ていますが、Twitterの「Bootstrap」と2番目のバージョンでのみ作成されています。あなたは尋ねる：「ユリ、それならなぜ第2版に？」何年？ 2018？一般に、私はマッスル（MySQL）に対してこれをかなり前に行い、そこでクエリの数行を変更しただけで、彼はClickhouseで働き始めました。パーサーは「マッスル」のものと非常に似ており、リクエストは非常に似ているため、特に最初は非常に便利です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bj/ei/vf/bjeivfj1rem72hvgi50jemwlwkc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、彼はテーブルをフィルタリングする方法、構造、テーブルの内容を表示する方法、ソートを許可する方法、列でフィルタリングする方法、最後に判明したクエリ、影響を受ける行（結果としていくつ）を表示するか、つまりデータを表示するための基本的なことを知っています。かなり速い。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gu/qb/d7/guqbd74jb1bppis3vv_nbokkiaq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エディターもいます。</font><font style="vertical-align: inherit;">私は正直にTabixからエディター全体を盗もうとしましたが、できませんでした。</font><font style="vertical-align: inherit;">しかし、どういうわけかそれは機能します。</font><font style="vertical-align: inherit;">基本的にはそれだけです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clickhouseはログに適しています</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「Clickhouse」は、説明されているすべての問題にもかかわらず、ログに非常に適していることをお伝えします。それは、最も重要なことに、私たちの問題を解決します-それは非常に高速であり、列でログをフィルタリングすることができます。原則として、バッファテーブルはうまく機能しませんでしたが、通常は誰もその理由を知りません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ty/tn/97/tytn97odgbvky_khyj7abanlhqg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TCP？一般に、VKではUDPを使用するのが慣例です。そして私がTCPを使用したとき...もちろん、誰も私に言わなかった：「ゆり、あなたは何をしているのですか！いいえ、UDPが必要です。」 TCPはそれほど怖くないことがわかりました。唯一のことは、作成するアクティブな接続が数万にも及ぶ場合は、もう少し慎重に準備する必要があることです。可能ですが、とても簡単です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰もが私たちのパブリックVKバックエンドにサブスクライブする場合は、HighLoad Siberiaに「Kittenhouse」と「Lighthouse」を配置することを約束しました...そして、誰もがサインアップしているわけではありません...私はすでにあなたと一緒にいるので、もちろん、私たちのパブリックにサブスクライブする必要はありません。それでも、あなたが多すぎて、誰かが気分を害することさえあるかもしれませんが、とにかくサインアップしてください（そして私は猫のような目をしなければなりません）。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ちなみに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちら</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">へ</font></a><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">リンク</font></a><font style="vertical-align: inherit;">です。どうもありがとう！私たちのgithub </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 「クリックハウス」を使用すると、髪は柔らかく、シルキーになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ai/nd/eu/aindeupigrlmumartzyvealbyj4.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンター：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -友達、そして今の質問。感謝状とあなたのVHSに関する報告書を提出した直後。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yuri Nasretdinov（以下、国連と呼び</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font><b><font style="vertical-align: inherit;">）：</font></b><font style="vertical-align: inherit;"> -VHSの報告が終わったばかりなら、どのように記録できますか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/w0/b6/zx/w0b6zxe9lcu_9gtaoimopvg8eyy.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リーディング：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「あなたも、Clickhouseがどのように機能するか、または機能しないかを完全に決定することはできません！」</font><font style="vertical-align: inherit;">友達、質問は5分です！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご質問</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聴衆からの質問（以下-H）：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -こんにちは。報告ありがとうございます。 2つの質問があります。私はつまらないものから始めましょう：スキーム（3、4、7など）の「Kittenhouse」という名前の文字tの数は猫の満足度に影響しますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -何の量？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -文字t。 3トンあり、どこかに3トンあります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -私はこれを本当に修正しましたか？もちろんそうです！これらは異なる製品です-私はいつもあなたに嘘をついただけです。冗談です-そうではありませんあ、ここ！いいえ、それは同じことです。封印したのは私です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/4c/ju/fm4cju6vnwwqvpm2o0exqllhsra.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ありがとう。 2番目の質問は深刻です。私が理解している限り、「Clickhouse」のバッファテーブルはメモリにのみ存在し、ディスクにバッファリングされないため、永続的ではありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -はい。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-同時に、クライアントでディスクへのバッファリングが実行されます。これは、これらの同じログの配信が保証されることを意味します。しかし、「Clickhouse」では、これは保証されていません。何が原因で保証がどのように実装されるかを説明してください。..このメカニズムは</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">によって詳細に説明されてい</font><font style="vertical-align: inherit;">ます。-はい、理論的には矛盾はありません。 「Clickhouse」がクラッシュした場合（正しく完了していない場合）、おおまかに言って、少し書き留めたログを巻き戻して、すべてが正常であった瞬間から開始できます。 1分前に巻き戻しましょう。つまり、1分ですべてが点滅したと考えられています。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -つまり、キッテンハウスは窓をより長く保ち、落下の場合はそれを認識して巻き戻すことができますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「しかし、それは理論上です。」実際にはこれを行わず、信頼性の高い配信はゼロから無限時間までです。しかし、平均して1つ。 「Clickhouse」がなんらかの理由でクラッシュしたり、サーバーが「再起動」したりすると、多少の損失が生じることに満足しています。それ以外の場合は、何も起こりません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -こんにちは。最初から、レポートの最初から実際にUDPを使用するように思えました。あなたはhttpをすべて持っています...そして、あなたが説明した問題のほとんどは、私が理解しているように、この特定のソリューションによって引き起こされました... </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UN：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -TCPは何を使用していますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -実際、そうです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UN：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -いいえ。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-あなたが問題を抱えていたのはfasthttpでした、あなたは問題を抱えていた接続で。 UDPを使用しただけの場合は、時間を節約できます。まあ、長いメッセージや何か他の問題があるでしょう... </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -何を使って？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zl/pe/qj/zlpeqjirfmjnmnfkz-tmzmpnbia.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -長いメッセージの場合、MTUに適合しない可能性があるため、他の何か...まあ、そこにあなたの問題が発生する可能性があります。問題は、UDPではないのはなぜですか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-TCP / IPを開発した作者は私よりもはるかに賢く、パケットをよりよくシリアライズする方法を知っていると思います（そうすることで）、同時に送信ウィンドウを調整し、ネットワークに過負荷をかけず、読んでいないものについてフィードバックを提供します。その側を除いて...私の意見では、これらすべての問題はUDPにあったでしょう、同じことを自分で実装するために私がすでに書いたよりも多くのコードを書く必要があるだけで、おそらくそれは悪いでしょう。そこだけでなく、Cで書くのも好きではありません... </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><font style="vertical-align: inherit;">とても</font><font style="vertical-align: inherit;">便利です！ [ok]を送信し、何も期待しないでください-完全に非同期です。すべてが良好であるという通知が返ってきました。来なかった-それは悪いことを意味します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-その両方が必要です-配達保証ありと配達保証なしの両方で送信できる必要があります。これらは2つの異なるシナリオです。一部のログは、理性の範囲内で失う必要はありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -時間はかかりません。これはもっと長く議論されるべきです。感謝。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンター：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -質問がある人-空のペン！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ip/mz/l7/ipmzl72i77pluuukxeyuxpqeob0.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -こんにちは、私はサーシャです。レポートの途中のどこかで、TCPのほかに、既成のソリューション（ある種のカフカ）を使用することが可能であるという印象がありました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-まあ、どのように...私は中間サーバーを使いたくないと言った、なぜなら...カフカへ-それは私たちが1万のホストを持っていることが判明した。実際、数万のホストがあります。 Kafkaを使用すると、プロキシがなければ、害を及ぼす可能性もあります。さらに、最も重要なことに、それでも「レイテンシ」が提供され、必要な追加のホストが提供されます。そして、私はそれらを持ちたくありません-私はしたいです... </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -しかし結局のところ、それはすべてとにかく起こりました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -いいえ、ホストはありません！すべてClickhouseホストで動作します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -しかし、その逆である子猫の家はどうですか-彼はどこに住んでいますか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bn/ew/lk/bnewlk0ozew0rhhlgtdwhkhjfcu.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UN：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Klickhouseのホストでは、ディスクに何も書き込みません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ええと、言いましょう。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンター：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -満足していますか？給料はもらえますか？</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-はい、できます。実際、同じことをするために多くの松葉杖があります、そして今-TCPの矛盾のトピックに関する以前の答えは、私の意見では、この状況です。膝の上ですべてのことをより短い時間で行うことができるように感じます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -そして、「カフカ」からのメッセージが失われたなど、テレグラムの「クリックハウス」電報にかなりの不満があったため、「カフカ」を使用したくなかったのはなぜですか。 Kafka自体からではなく、KafkaとKlikhausの統合によるものです。または何かが接続されていません。大まかに言えば、そのときクライアントはカフカのために書く必要があるでしょう。よりシンプルで信頼性の高いソリューションが得られるとは思いません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-教えてください、なぜあなたはいくつかの路線やそのような一般的なバスを試してみませんでしたか？あなたが非同期であなたがキューを介してドライブし、それに応じてキューを通して非同期に取得することは可能だったと言ったので？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/4q/sz/pn4qszihp9ejs5aoua8swthjrqk.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -使用できるキューを提案してください。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -順調に進んでいるという保証がなくても、誰でも。 Redis、RMQ ... </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UN：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-私は、RedisがClickhouseを引き出す1つのホスト（複数のサーバーでの意味で）でも、そのような挿入ボリュームを引き出すことができない可能性が最も高いと感じています。</font><font style="vertical-align: inherit;">これを証拠で確認することはできませんが（ベンチマークしませんでした）、Redisがここでの最良のソリューションではないようです。</font><font style="vertical-align: inherit;">原則として、このシステムは即席のメッセージキューと見なすことができますが、「クリックハウス」</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モデレーター</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">専用に調整されています。- </font><font style="vertical-align: inherit;">ユリ、ありがとうございました。</font><font style="vertical-align: inherit;">私はこれに関する質疑応答を終わらせ、質問をした人の誰が私たちに本をくれるかを言うことを提案します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">国連：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -最初に質問した人に本を贈りたい。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンター：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -すばらしい！</font><font style="vertical-align: inherit;">いいね！</font><font style="vertical-align: inherit;">豪華に！</font><font style="vertical-align: inherit;">どうもありがとうございました！</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/pbbcMcrQoXw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">広告のビット:)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いつもご利用いただきありがとうございます。私たちの記事は好きですか？もっと面白い資料を見たいですか？私たちが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発した</font></font></a><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エントリーレベルサーバーのユニークなアナログで</font></font></b> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">$ 4.99から</font></a><font style="vertical-align: inherit;">、注文またはお友達</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">への開発者向けクラウドベースVPSの開発者</font></a><font style="vertical-align: inherit;">への推奨によって私たちをサポートして</font><b><font style="vertical-align: inherit;">ください：</font></b></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS（KVM）E5-2697 v3（6コア）10GB DDR4 480GB SSD 1Gbpsの真実19ドルから、またはサーバーを分割する方法？</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（オプションは、RAID1およびRAID10、最大24コア、最大40GB DDR4で利用可能です）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xdは、アムステルダムのEquinix Tier IVデータセンターで2倍安いですか？</font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">オランダでは</font></b><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">199ドルのIntel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV</font></a></b><font style="vertical-align: inherit;">が</font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">2つ</font></a></b><font style="vertical-align: inherit;">だけあり</font><b><font style="vertical-align: inherit;">ます！</font></b></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デルR420-2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB-$ 99から！</font></font></b></b><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">インフラストラクチャビルディングの構築方法</font></a><font style="vertical-align: inherit;">について</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">お</font></a><font style="vertical-align: inherit;">読みください</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Dell R730xd E5-2650 v4サーバーを使用するクラスcは、1ペニーで9,000ユーロかかりますか？</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja483688/index.html">Node.jsの同時実行性が約30倍に増加</a></li>
<li><a href="../ja483698/index.html">LoRaWANが現代のモノのインターネットの構築にどのように役立つか</a></li>
<li><a href="../ja483700/index.html">今年の物理的な結果-2019</a></li>
<li><a href="../ja483704/index.html">1月13日から19日までのモスクワでのデジタルイベント</a></li>
<li><a href="../ja483708/index.html">ドップラー効果、または交通警察レーダーによる速度決定の正確さの問題</a></li>
<li><a href="../ja483714/index.html">革新的なプロジェクトの賞品とコンテスト。世界のベンダー体験</a></li>
<li><a href="../ja483716/index.html">GitlabCIで使用される依存関係チェックライブラリでの脆弱性スキャナーの使用</a></li>
<li><a href="../ja483718/index.html">VDIがオフィス環境をどのように変革するか</a></li>
<li><a href="../ja483720/index.html">私たちにパンダ1.0をもたらしたもの</a></li>
<li><a href="../ja483722/index.html">小売業のジオアナリティクス、パート1：ビジネスの場所を選択するプロセスを自動化します。2GIS + MS Azure + ML</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>