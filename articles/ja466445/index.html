<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☺️ 🌿 🧗🏻 ドメイン間の信頼間の攻撃 🤷🏻 🚊 🥑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="遅かれ早かれ、ペンテスト中に、フォレスト全体を危険にさらすタスクが発生します-ドメインの1つに何らかの権利がある場合。そのような瞬間に、信頼、その特性、および攻撃自体について多くの疑問が生じます。それをすべて理解してみましょう。
 
 ドメイン間の信頼は、あるドメインのユーザーを別のドメインのコント...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ドメイン間の信頼間の攻撃</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jetinfosystems/blog/466445/"><img src="https://habrastorage.org/webt/ki/6u/o8/ki6uo88vz8xcqbapiyvfwn4sc-s.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
遅かれ早かれ、ペンテスト中に、フォレスト全体を危険にさらすタスクが発生します-ドメインの1つに何らかの権利がある場合。</font><font style="vertical-align: inherit;">そのような瞬間に、信頼、その特性、および攻撃自体について多くの疑問が生じます。</font><font style="vertical-align: inherit;">それをすべて理解してみましょう。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドメイン間の信頼は、あるドメインのユーザーを別のドメインのコントローラーで認証するために使用されます。</font><font style="vertical-align: inherit;">つまり、ドメインAのユーザーがドメインBのリソースにアクセスできるようにします。ドメイン構造には次の2つのタイプがあります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドメインツリー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドメインフォレスト。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/5w/zx/4c/5wzx4cfoai1nwiwk6rissbhy4cu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドメイン間にドメインのツリーを作成すると、デフォルトで推移的な信頼が確立されます。</font><font style="vertical-align: inherit;">すべてのコンピュータに共通があります：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバルカタログ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名前空間</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキーム。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドメインツリーは、フォレストに組み合わせることができます。</font><font style="vertical-align: inherit;">ドメインフォレストを作成すると、推移的な信頼が確立され、フォレスト内のすべてのコンピューターが以下を共有します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバルカタログ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキーム。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の表は、ドメイン間の信頼の種類とそのプロパティを示しています。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">番号。</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信頼タイプ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推移性</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方向</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">認証メカニズム</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非推移的</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一方向または双方向</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTLMのみ</font></font></td>
<td>  ,    ,  c  Windows NT 4.0. </td>
</tr>
<tr>
<td>2</td>
<td>Realm</td>
<td>Transitive or non-transitive</td>
<td>One-way or two-way</td>
<td>Kerberos Only</td>
<td>  Windows   Windows ,   Kerberos.            Windows  UNIX-.</td>
</tr>
<tr>
<td>3</td>
<td>Forest</td>
<td>Transitive</td>
<td>One-way or two-way</td>
<td>Kerberos or NTLM</td>
<td>  .     ,    —   .</td>
</tr>
<tr>
<td>4</td>
<td>Shortcut</td>
<td>Transitive</td>
<td>One-way or two-way</td>
<td>Kerberos or NTLM</td>
<td>    ,    .     ,        .</td>
</tr>
<tr>
<td>5</td>
<td>Parent-Child</td>
<td>Transitive</td>
<td>Two-way</td>
<td>Kerberos or NTLM</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツリーに新しいドメインが作成されると、自動的にインストールされます。</font><font style="vertical-align: inherit;">ドメインツリー内では、関係は親子スキーマによって記述されます。</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツリールートの信頼</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推移的</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">双方向</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KerberosまたはNTLM</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既存のフォレストに新しいドメインツリーが作成されると自動的にインストールされます。</font><font style="vertical-align: inherit;">実際、信頼は、フォレストのルートドメインと、新しいツリーのルートになる作成されたドメインとの間で確立されます。</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より明確に、ドメイン間の信頼の種類は下の画像に示されています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jp/mc/eo/jpmceokjm7kwra_mhgfrw3n8tc0.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">推移性</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
推移性は、それが形成された2つのドメイン外の信頼を定義するために必要であり、他のドメインとの信頼関係を拡大するために使用されます。</font><font style="vertical-align: inherit;">子ドメインをドメインに追加すると、親ドメインと子ドメインの間に双方向の信頼関係が確立されます。</font><font style="vertical-align: inherit;">これらの関係は推移的です。</font><font style="vertical-align: inherit;">ドメインAがドメインDを信頼し、ドメインDがドメインEを信頼する場合、ドメインAもドメインEを信頼します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xv/wb/wf/xvwbwfp8-uopt2k_bmlk5y0onci.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非推移的信頼を使用して、他のドメインとの信頼を拒否できます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方向</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
信頼関係パスは、認証要求を受信する必要があるドメイン間の一連の信頼関係です。</font><font style="vertical-align: inherit;">つまり、ユーザーを認証する前に、ドメイン間の信頼が決定されます。</font><font style="vertical-align: inherit;">ドメインAのユーザーがドメインDのリソースにアクセスできるようにするには、ドメインDがドメインAを信頼する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
信頼の方向には次の2種類</font><font style="vertical-align: inherit;">があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">片側;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">二国間。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方向の信頼は、2つのドメイン間で作成される一方向の認証パスです。</font><font style="vertical-align: inherit;">ドメインAとドメインBの間の一方向の信頼では、ドメインBのユーザーはドメインAのリソースにアクセスできます。ただし、ドメインAのユーザーはドメインBのリソースにアクセスできません。このタイプの信頼は推移的ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
双方向の信頼は、2つの単方向の信頼関係の組み合わせです。</font><font style="vertical-align: inherit;">ドメインAとBの間の双方向の信頼では、ユーザーは両方のドメインのリソースにアクセスできます。</font><font style="vertical-align: inherit;">このタイプの信頼は推移的です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
信頼の方向は常にアクセスの方向と反対です。</font><font style="vertical-align: inherit;">以下のMicrosoftデモチャート：</font></font><br>
<img src="https://habrastorage.org/webt/r2/d6/jo/r2d6jope8ji-ivoblptob-s5y94.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より詳細な信頼タイプのリンク：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部の信頼</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レルム</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">森林</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ショートカット</font></font></a></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信頼できるドメイン間のKerberos</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例を考えてみましょう。</font><font style="vertical-align: inherit;">クライアントがサーバーにアクセスしようとしています。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポイント1〜3から、Kerberosプロトコルを使用するときに標準のアクションが発生します。</font></font></b><div class="spoiler_text"><ul>
<li>   NTLM-,        KDC      TGT- (AS-REQ).   (KDC)      TGT-.</li>
<li>TGT- ,     (AS-REP).   Kerberos (KRBTGT)       TGT-.</li>
<li>  TGT-     TGS- (TGS-REQ).    TGT-     PAC.</li>
</ul> <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更はポイント4から始まります。領域間TGTチケットが表示されます。これは、信頼されたパスワードから作成された領域間キーで暗号化/署名された、いわゆる参照チケットです。</font><font style="vertical-align: inherit;">信頼できるパスワードは、信頼が確立されたときに設定され、両方のドメインコントローラに認識されます。</font><font style="vertical-align: inherit;">ドメイン1ユーザーは、領域間TGTチケットを使用して、ドメイン2リソースにアクセスするためのTGSチケッ​​トを要求できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s4/3v/hj/s43vhjcgbdqvzebpjmra7d2cr_g.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信頼されたドメイン間のNTLM</font></font></h4><br>
<img src="https://habrastorage.org/webt/v2/2c/x4/v22cx4pt6iw7mlgxrlus2t3xdqs.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントは、アクセスしたい別のドメインにあるリソース自体に認証要求を直接送信します。</font></font></li>
<li>         CHALLENGE_MESSAGE,       8 .   Server Challenge.</li>
<li>,     Server Challenge,        ,     ,   24 .</li>
<li>         B.</li>
<li>       :<br>
<br>
<ul>
<li> Direction Trust Relationships (  ). <br>
 <ul>
<li>   A       .</li>
<li>   ,   Transitivity ()   A.</li>
</ul><br>
 </li>
<li> Transitivity ()  <br>
 <ul>
<li>    ,         .     ,           .</li>
<li>  ,       .</li>
</ul><br>
 </li>
</ul><br>
6-8.      .<br>
<br>
<h1>    </h1><br>
,            . <br>
<br>
<h4> </h4><br>
 3       :<br>
<br>
<ol>
<li> Win32 API;</li>
<li> .NET ;</li>
<li> LDAP.</li>
</ol><br>
<b><i>Win32 API</i></b><br>
<br>
      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">DsEnumerateDomainTrusts</a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">DS_DOMAIN_TRUSTSA</a>.      SID  GUID  , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,      . <br>
<br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><div class="scrollable-table"><table>
<tbody><tr>
<td>DS_DOMAIN_DIRECT_INBOUND</td>
<td>Enumerate domains that directly trust the domain which has ServerName as a member.</td>
</tr>
<tr>
<td>DS_DOMAIN_DIRECT_OUTBOUND</td>
<td>Enumerate domains directly trusted by the domain which has ServerName as a member.</td>
</tr>
<tr>
<td>DS_DOMAIN_IN_FOREST</td>
<td>Enumerate domains that are a member of the same forest which has ServerName as a member.</td>
</tr>
<tr>
<td>DS_DOMAIN_NATIVE_MODE</td>
<td>Enumerate domains where the primary domain is running in Windows 2000 native mode.</td>
</tr>
<tr>
<td>DS_DOMAIN_PRIMARY</td>
<td>Enumerate domains that are the primary domain of the domain which has ServerName as a member.</td>
</tr>
<tr>
<td>DS_DOMAIN_TREE_ROOT</td>
<td>Enumerate domains that are at the root of the forest which has ServerName as a member.</td>
</tr>
</tbody></table></div><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td>TRUST_ATTRIBUTE_NON_TRANSITIVE</td>
<td>Disallow transitivity.</td>
</tr>
<tr>
<td>TRUST_ATTRIBUTE_UPLEVEL_ONLY</td>
<td>The trust link is not valid for client operating systems earlier than Windows 2000.</td>
</tr>
<tr>
<td>TRUST_ATTRIBUTE_FILTER_SIDS</td>
<td>Quarantine domains.</td>
</tr>
<tr>
<td>TRUST_ATTRIBUTE_FOREST_TRANSITIVE</td>
<td>The trust link may contain forest trust information.</td>
</tr>
<tr>
<td>TRUST_ATTRIBUTE_CROSS_ORGANIZATION</td>
<td>This trust is to a domain/forest that is not part of this enterprise.</td>
</tr>
<tr>
<td>TRUST_ATTRIBUTE_TREAT_AS_EXTERNAL</td>
<td>Trust is treated as external for trust boundary purposes.</td>
</tr>
<tr>
<td>TRUST_ATTRIBUTE_WITHIN_FOREST</td>
<td>Trust is internal to this forest.</td>
</tr>
</tbody></table></div><br>
</div></div><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">BloodHound</a>      Win32 API.<br>
<br>
<img src="https://habrastorage.org/webt/d4/hq/df/d4hqdf50vvyi6k4b2bv6dbcnekw.png"><br>
<br>
<b><i>.Net</i></b><br>
<br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">GetCurrentDomain</a>   [System.DirectoryServices.ActiveDirectory.Domain],     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">System.DirectoryServices.ActiveDirectory.Domain</a>.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">GetAllTrustRelationships</a>,        . <br>
<br>
<pre><code class="bash hljs">([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
</code></pre><br>
      Get-DomainTrust  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PowerView</a>.<br>
<br>
<img src="https://habrastorage.org/webt/bv/px/vf/bvpxvf6de-v4o3f04sp5mtrgdd0.png"><br>
<br>
       .     ,     ,      . <br>
<br>
<b><i>LDAP</i></b><br>
<br>
       Active Directory  objectClass  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">trustedDomain</a>.<br>
<br>
 :<br>
<br>
<pre><code class="bash hljs">dsquery * -filter <span class="hljs-string">"(objectClass=trustedDomain)"</span> -attr *</code></pre><br>
<img src="https://habrastorage.org/webt/oa/xc/2x/oaxc2xunppmfjl7vpjztuudgm5e.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PowerView</a>     .<br>
<br>
<img src="https://habrastorage.org/webt/cx/p1/_w/cxp1_w24rxlh7-naqk5swez6vc4.png"><br>
<br>
      ,      .  2 :<br>
<br>
<ol>
<li>   ,      .</li>
<li>     .</li>
</ol><br>
<h2>     </h2><br>
   ,   ,     :<br>
<br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td>№</td>
<td> .  </td>
<td> </td>
<td> </td>
<td> </td>
</tr>
<tr>
<td>1</td>
<td>Root</td>
<td>Child</td>
<td>Golden Ticket + Enterprise Admin Group</td>
<td>Inter-realm (2-way)</td>
</tr>
<tr>
<td>2</td>
<td>Child</td>
<td>Child</td>
<td> SID History</td>
<td>Inter-realm Parent-Child (2-way)</td>
</tr>
<tr>
<td>3</td>
<td>Child</td>
<td>Root</td>
<td> SID History<br>
   </td>
<td>Inter-realm Tree-Root(2-way)</td>
</tr>
<tr>
<td>4</td>
<td>Forest 1</td>
<td>Forest 2</td>
<td>Printer Bug</td>
<td>Inter-realm Forest or External trust (2-way)</td>
</tr>
</tbody></table></div><br>
 ,           .<br>
<br>
<h4><i>1.  SID History</i></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">SID History</a>           .  c    SID .  ,        ,   SID,   objectSID.  SID    sIDHistory.<br>
<br>
      Enterprise Admins,     root-          Child- .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Sean Metcalf </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">BlackHat USA 2015</a>.    ,    Golden-    SID  Enterprise Admins.     ExtraSids   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">KERB_SID_AND_ATTRIBUTES</a>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">KERB_VALIDATION_INFO</a>.<br>
<br>
<img src="https://habrastorage.org/webt/kl/hy/fj/klhyfjzath65qptysuylgzft-fk.png"><br>
<br>
 :<br>
<br>
<img src="https://habrastorage.org/webt/v6/ia/1g/v6ia1gvjk-sxs7x8plq6uvwojjk.gif"><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">impacket</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,    .<br>
<br>
<h4><i>2. Golden Ticket + Enterprise Admin Group</i></h4><br>
    Root-,    Golden Ticket      Enterprise Admins (519).<br>
<br>
<pre><code class="bash hljs">Kerberos::golden /domain:&lt;domain&gt; /sid:&lt;domain_SID&gt; /krbtgt:&lt;ntlm_hash_krbtgt_user&gt; /user:&lt;user&gt; /groups:500,501,513,512,520,518,519 /ptt</code></pre><br>
   , Enterprise Admin      DC Child-.         Child-. <br>
<br>
<h4><i>3.   </i></h4><br>
   -    Kerberos,  TGS-,   NTLM-    .         , ,            ,  inter-realm key.       ,           .    (NTDS.dit)         $  .       inter-realm .   inter-realm TGT-       . <br>
<br>
<pre><code class="bash hljs">Kerberos::golden /user:&lt;user&gt; /domain:&lt;domain&gt; /sid:&lt;sid_domain&gt; /sids:&lt;extra_sid_entrprice_admin_group_from _another_domain&gt; /aes256:&lt;aes256_trust_user_password&gt; /service:krbtgt /target:&lt;target_domain&gt; /ptt</code></pre><br>
 :<br>
<br>
<img src="https://habrastorage.org/webt/fk/cv/ji/fkcvjizxaup946gngi9zsk6xqm8.gif"><br>
<br>
  ,         krbtgt 2 .       golden-,     .<br>
<br>
<h4><i>4. Printer Bug</i></h4><br>
 Windows Print System Remote Protocol (MS-RPRN)   RpcRemoteFindFirstPrinterChangeNotification(Ex),   ,            Spooler      Kerberos  NTLM.   c NTLM    NTLM-relay,      (  ).    Kerberos      .     TGT-   . <br>
<br>
 :<br>
<br>
<img src="https://habrastorage.org/webt/3g/h9/gf/3gh9gfnx0b6k8hucav8zy964ap0.gif"><br>
<br>
   ,   .<br>
<br>
<img src="https://habrastorage.org/webt/cu/e0/0l/cue00l2_x_fdpsxj0vyalrvjscs.png"><br>
<br>
<h2>     </h2><br>
 . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Carlos Garsia</a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>   ,      .<br>
<br>
<img src="https://habrastorage.org/webt/jz/5x/jc/jz5xjcruevdpcv_jnz1knoyh1oi.png"><br>
<br>
   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">      AD Domain Local  AD Global    ,    AD Universal    .</a><br>
<blockquote>Because of the way that groups are enumerated by the Global Catalog, the results of a back-link [i.e. memb search can vary, depending on whether you search the Global Catalog (port 3268) or the domain (port 389), the kind of groups the user belongs to (global groups vs. domain local groups).</blockquote>  ,       ,   .  :<br>
<ol>
<li>  ,          .</li>
<li>   ,     . ,     .</li>
<li>Foreign ACL Principals.</li>
</ol><br>
<h4><i>1.   ,          </i></h4><br>
    ,          BloodHound:<br>
<br>
<pre><code class="bash hljs"><font></font>
MATCH (c:Computer)  <font></font>
OPTIONAL MATCH p1 = (u1)-[:AdminTo]-&gt;(c)  <font></font>
WHERE NOT u1.domain = c.domain  <font></font>
WITH p1,c OPTIONAL MATCH p2 = (u2)-[:MemberOf*1..]-&gt;(:Group)-[:AdminTo]-&gt;(c)  <font></font>
WHERE NOT u2.domain = c.domain  <font></font>
RETURN p1,p2<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/07/2y/92/072y92dgtftil5yz9uvrgv8ui3a.png"><br>
<br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PowerView</a>:<br>
<br>
<pre><code class="bash hljs">Get-NetLocalGroupMember &lt;server&gt;</code></pre><br>
<h4><i> 2.    ,     . ,     </i></h4><br>
   ,     ,      Universal.          ,        ldap-   .<br>
<br>
<pre><code class="bash hljs">Get-DomainGroup -Properties name, grouptype, member, DistinguishedName -LDAPFilter <span class="hljs-string">'(member=*)'</span> -SearchBase <span class="hljs-string">"GC://jet.lab"</span></code></pre><br>
<img src="https://habrastorage.org/webt/vr/zv/sd/vrzvsdj1pez6rn-ndb4_zcklpdu.png"><br>
<br>
     ,      Universal Group c  AD Universal   one.jet.lab.<br>
<br>
    LDAP-   one.jet.lab,       AD Domain local  AD Global. <br>
<br>
<img src="https://habrastorage.org/webt/jf/3n/ku/jf3nkumv72dhsoyhb8kpqntq9ba.png"><br>
<br>
        .<br>
<br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PowerView</a>:<br>
<br>
<pre><code class="bash hljs">Get-DomainForeignUser -Domain &lt;Domain&gt;<font></font>
Get-DomainForeignGroupMember -Domain &lt;Domain&gt;</code></pre><br>
<img src="https://habrastorage.org/webt/ia/no/24/iano24rfj4ldithcbqhapwts4uk.png"><br>
<br>
<img src="https://habrastorage.org/webt/zf/2n/f-/zf2nf-tutgsxrzz99pdp6199fw0.png"><br>
<br>
<h4><i>3. Foreign ACL Principals</i></h4><br>
  ntSecurityDescriptor (https://docs.microsoft.com/en-us/windows/win32/adschema/a-ntsecuritydescriptor)            .       DACL            .<br>
<br>
<pre><code class="bash hljs">Get-DomainObjectAcl -Domain jet.lab -ResolveGuids | ?{<span class="hljs-variable">$_</span>.SecurityIdentifier -like ‘SID_Domain*’}</code></pre><br>
<img src="https://habrastorage.org/webt/fw/kn/si/fwknsimcsrubz0tputfddzosgr0.png"><br>
<br>
,     Mike   forestc.lab,      Global Group   jet.lab.<br>
<br>
P.S.      SID Filtering  Selective Authentication.      SID Filtering  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">dirkjan</a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.  9   Microsoft  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>,   TGT-    .  ,              Kerberos   .</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja466435/index.html">Cisco 200-125 CCNA v3.0のトレーニング。42日目。VLAN間ルーティングとSVI</a></li>
<li><a href="../ja466437/index.html">Cisco 200-125 CCNA v3.0のトレーニング。43日目。ルーティングプロトコルの距離ベクトルとリンク状態</a></li>
<li><a href="../ja466439/index.html">自分で確認してください。ChGKに回答できる質問はいくつですか。</a></li>
<li><a href="../ja466441/index.html">Pythonバギーコード：開発者が犯す最も一般的な10の間違い</a></li>
<li><a href="../ja466443/index.html">ShIoTinyと世界：最小のアナログセンサーまたはADC</a></li>
<li><a href="../ja466447/index.html">何のためにCDNを構築する必要がありますか？</a></li>
<li><a href="../ja466449/index.html">Cisco 200-125 CCNA v3.0のトレーニング。44日目。OSPFの概要</a></li>
<li><a href="../ja466451/index.html">Read_You cannot_throw</a></li>
<li><a href="../ja466453/index.html">Cisco 200-125 CCNA v3.0のトレーニング。45日目。OSPFの構成</a></li>
<li><a href="../ja466455/index.html">サービス、マイクロサービス、バッチ指向プログラミング</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>