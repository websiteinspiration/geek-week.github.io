<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤙🏼 🧓 🛁 pgbackrestによるPostgresqlの増分バックアップ-開発者による若いファイターコース 📞 👨🏽‍🏫 👶🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="免責事項
 
 私は開発者です。私はコードを書き、ユーザーとしてのみデータベースと対話します。システム管理者、特にdbaを装うことは決してありません。しかし... 
 
 偶然、postgresqlデータベースのバックアップを整理する必要がありました。クラウドなし-SSHを維持し、すべてを機能させ、...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>pgbackrestによるPostgresqlの増分バックアップ-開発者による若いファイターコース</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476206/"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免責事項</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
私は開発者です。私はコードを書き、ユーザーとしてのみデータベースと対話します。システム管理者、特にdbaを装うことは決してありません。しかし... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
偶然、postgresqlデータベースのバックアップを整理する必要がありました。クラウドなし-SSHを維持し、すべてを機能させ、お金を要求しないでください。そのような場合、私たちは何をしますか？そうです、pgdumpをcronにプッシュし、毎日すべてをアーカイブにバックアップします。完全に分散している場合は、このアーカイブをどこかに送ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回の難点は、計画によると、ベースが1日あたり約+-100 MB増加すると想定されていたことです。もちろん、数週間後、pgdumpですべてをバックアップしたいという欲求はなくなります。ここで増分バックアップが役に立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
面白い？猫へようこそ。</font></font><br>
<a name="habracut"></a><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">増分バックアップは、すべてのソースファイルがバックアップされるわけではなく、新規で、前回のバックアップが作成されてから変更された場合のバックアップの一種です。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他の開発者と同様に、Postgresの複雑さを（当時は）完全に理解したくないので、緑色のボタンを見つけたかったのです。 AWSの場合と同様に、DigitalOcean：1つのボタンをクリック-レプリケーションを取得、2番目をクリック-バックアップを設定、3番目-数時間前にロールバックしました。ボタンと私が見つけていない美しいGUIツール。あなたがこれを知っているなら（無料か安いか）-コメントでそれについて書いてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
グーグル、私は2つのツール</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbarman</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbackrest</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を見つけました</font><font style="vertical-align: inherit;">。私は最初の1つには問題がなかっただけです（非常に貧弱なドキュメント、古いマニュアルに従ってすべてを上げようとしました）、2つ目のレベルはレベルにあることが判明しましたが、欠陥がないわけではありませんでした。同様のタスクとこの記事に直面している人のために作業を簡素化するためにこの記事が書かれました。</font></font><br>
<blockquote>       ,      (  )             .</blockquote> <h2></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マニュアルを再生するには、2つのVPSが必要です。</font><font style="vertical-align: inherit;">1つ目はリポジトリ（バックアップが置かれるリポジトリ）で、2つ目は、実際にはpostgresがインストールされたサーバー自体（私の場合、バージョン11のpostgres）です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
postgresがインストールされたサーバーにroot、sudoユーザー、postgresユーザー、postgres自体がインストールされ（postgresqlのインストール時にpostgresユーザーが自動的に作成される）、リポジトリサーバーにrootとsudoユーザーが存在することが前提です（ユーザー名pgbackrestはマニュアルで使用されます） 。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指示を再現するときの問題が少なくなるように、イタリック体で</font><font style="vertical-align: inherit;">、記事を書いて確認しながら</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドを実行</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">した</font><i><font style="vertical-align: inherit;">場所、ユーザー、権限を</font></i><font style="vertical-align: inherit;">書き留めます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbackrestをインストールする</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（ユーザーpgbackrest）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1. pgbackrestからアーカイブをダウンロードし、その内容を/ビルドフォルダーに転送します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /build<font></font>
sudo wget -q -O - \<font></font>
       https://github.com/pgbackrest/pgbackrest/archive/release/2.18.tar.gz | \<font></font>
       sudo tar zx -C /build</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.アセンブリに必要な依存関係をインストールします。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update<font></font>
sudo apt-get install build-essential libssl-dev libxml2-dev libperl-dev zlib1g-dev \<font></font>
       libpq-dev</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. pgbackrestを収集します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /build/pgbackrest-release-2.18/src &amp;&amp; sudo ./configure<font></font>
sudo make -s -C /build/pgbackrest-release-2.18/src</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.実行可能ファイルを/ usr / binディレクトリにコピーします。</font></font><br>
<br>
<pre><code class="bash hljs">sudo cp /build/pgbackrest-release-2.18/src/pgbackrest /usr/bin<font></font>
sudo chmod 755 /usr/bin/pgbackrest</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Pgbackrestにはperlが必要です。</font><font style="vertical-align: inherit;">インストール：</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install perl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6.ログ用のディレクトリを作成し、特定の権限を付与します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir -p -m 770 /var/<span class="hljs-built_in">log</span>/pgbackrest<font></font>
sudo chown pgbackrest:pgbackrest /var/<span class="hljs-built_in">log</span>/pgbackrest<font></font>
sudo mkdir -p /etc/pgbackrest<font></font>
sudo mkdir -p /etc/pgbackrest/conf.d<font></font>
sudo touch /etc/pgbackrest/pgbackrest.conf<font></font>
sudo chmod 640 /etc/pgbackrest/pgbackrest.conf<font></font>
sudo chown pgbackrest:pgbackrest /etc/pgbackrest/pgbackrest.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7.チェック：</font></font><br>
<br>
<pre><code class="bash hljs">pgbackrest version</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresサーバー（sudoユーザーまたはroot）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
postgresを使用してサーバーにpgbackrestをインストールするプロセスは、リポジトリにインストールするプロセスと似ています（そう、pgbackrestは両方のサーバーにある必要があります）</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></b><br>
<br>
<pre><code class="bash hljs">sudo chown pgbackrest:pgbackrest /var/<span class="hljs-built_in">log</span>/pgbackrest<font></font>
sudo chown pgbackrest:pgbackrest /etc/pgbackrest/pgbackrest.conf</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と置換する：</font></font></b><br>
<br>
<pre><code class="bash hljs">sudo chown postgres:postgres /var/<span class="hljs-built_in">log</span>/pgbackrest<font></font>
sudo chown postgres:postgres /etc/pgbackrest/pgbackrest.conf</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パスワードなしのSSHを介したサーバー間の通信の構成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pgbackrestが正しく機能するためには、キーファイルを使用してpostgresサーバーとリポジトリ間の相互作用を設定する必要があります。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（ユーザーpgbackrest）：</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
鍵ペアを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -m 750 /home/pgbackrest/.ssh<font></font>
ssh-keygen -f /home/pgbackrest/.ssh/id_rsa \<font></font>
       -t rsa -b 4096 -N <span class="hljs-string">""</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上記のコマンドをsudoなしで実行します。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresサーバー（sudoユーザーまたはroot）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
鍵ペアを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo -u postgres mkdir -m 750 -p /var/lib/postgresql/.ssh<font></font>
sudo -u postgres ssh-keygen -f /var/lib/postgresql/.ssh/id_rsa \<font></font>
       -t rsa -b 4096 -N <span class="hljs-string">""</span></code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（sudoユーザー）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
postgresサーバーの公開鍵をリポジトリサーバーにコピーします。</font></font><br>
<br>
<pre><code class="bash hljs">(<span class="hljs-built_in">echo</span> -n <span class="hljs-string">'no-agent-forwarding,no-X11-forwarding,no-port-forwarding,'</span> &amp;&amp; \
       <span class="hljs-built_in">echo</span> -n <span class="hljs-string">'command="/usr/bin/pgbackrest ${SSH_ORIGINAL_COMMAND#* }" '</span> &amp;&amp; \<font></font>
       sudo ssh root@&lt;postgres_server_ip&gt; cat /var/lib/postgresql/.ssh/id_rsa.pub) | \<font></font>
       sudo -u pgbackrest tee -a /home/pgbackrest/.ssh/authorized_keys</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このステップでは、rootユーザーにパスワードを要求します。</font><font style="vertical-align: inherit;">postgresサーバーユーザーのrootパスワードを入力してください！</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresサーバー（sudoユーザー）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
リポジトリの公開鍵をpostgresを使用してサーバーにコピーします。</font></font><br>
<br>
<pre><code class="bash hljs">(<span class="hljs-built_in">echo</span> -n <span class="hljs-string">'no-agent-forwarding,no-X11-forwarding,no-port-forwarding,'</span> &amp;&amp; \
       <span class="hljs-built_in">echo</span> -n <span class="hljs-string">'command="/usr/bin/pgbackrest ${SSH_ORIGINAL_COMMAND#* }" '</span> &amp;&amp; \<font></font>
       sudo ssh root@&lt;repository_server_ip&gt; cat /home/pgbackrest/.ssh/id_rsa.pub) | \<font></font>
       sudo -u postgres tee -a /var/lib/postgresql/.ssh/authorized_keys<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このステップでは、rootユーザーにパスワードを要求します。</font><font style="vertical-align: inherit;">リポジトリユーザーのrootパスワードを入力する必要があります！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェック：</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（rootユーザー、実験の純粋さ）：</font></font></i><br>
<br>
<pre><code class="bash hljs">sudo -u pgbackrest ssh postgres@&lt;postgres_server_ip&gt;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresサーバー（rootユーザー、実験の純粋さのために）：</font></font></i><br>
<br>
<pre><code class="bash hljs">sudo -u postgres ssh pgbackrest@&lt;repository_server_ip&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題なくアクセスできることを確認します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresサーバーのセットアップ</font></font></h3><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresサーバー（sudoユーザーまたはroot）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1.外部IPからのpostgresサーバーの「ノッキング」を許可しましょう。</font><font style="vertical-align: inherit;">これを行うには、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.conf</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">（/ etc / postgresql / 11 / mainフォルダーにあります）を</font><font style="vertical-align: inherit;">編集して</font><font style="vertical-align: inherit;">、次の行を追加します。</font></font><br>
<br>
<pre><code class="bash hljs">listen_addresses = <span class="hljs-string">'*'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような行が既に存在する場合は、コメントを外すか、パラメーター値を「*」に設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
で</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_hba.confファイル</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（またに位置</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の/ etc /のPostgreSQL / 11 /メイン</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォルダ</font><font style="vertical-align: inherit;">）次の行を追加します。</font></font><br>
<br>
<pre><code class="bash hljs">hostssl  all  all  0.0.0.0/0  md5<font></font>
host  all  all  0.0.0.0/0  md5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どこ：</font></font><br>
<br>
<pre><code class="bash hljs">hostssl/host -   SSL ( )<font></font>
all -     <font></font>
all -  ,    ()<font></font>
0.0.0.0/0 -      <font></font>
md5 -   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. </font><font style="vertical-align: inherit;">pgbackrestを機能させるために</font><font style="vertical-align: inherit;">、</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.conf</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（フォルダ</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / postgresql / 11 / mainに</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あります）に必要な設定を</font><font style="vertical-align: inherit;">行います</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">archive_command = <span class="hljs-string">'pgbackrest --stanza=main archive-push %p'</span> <span class="hljs-comment">#  main -  .   postgres    main.</span><font></font>
archive_mode = on<font></font>
max_wal_senders = 3<font></font>
wal_level = replica</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. pgbackrest構成ファイル（/etc/pgbackrest/pgbackrest.conf）で必要な設定を行います。</font></font><br>
<br>
<pre><code class="bash hljs">[main]<font></font>
pg1-path=/var/lib/postgresql/11/main<font></font>
<font></font>
[global]<font></font>
<span class="hljs-built_in">log</span>-level-file=detail<font></font>
repo1-host=&lt;repository_server_ip&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. postgresqlを再起動します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo service postgresql restart</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリサーバーの構成</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（pgbackrestユーザー）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
必要な設定を</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbackrest</font></font></u> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成</font><u><font style="vertical-align: inherit;">ファイル</font></u></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
（</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/pgbackrest/pgbackrest.conf</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）で</font><u><font style="vertical-align: inherit;">行い</font></u><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">[main]<font></font>
pg1-host=&lt;postgres_server_ip&gt;<font></font>
pg1-path=/var/lib/postgresql/11/main<font></font>
<font></font>
[global]<font></font>
repo1-path=/var/lib/pgbackrest<font></font>
repo1-retention-full=2 <span class="hljs-comment"># ,     . ..           ,      .    "    " -     .  @Aytuar   .</span>
start-fast=y <span class="hljs-comment">#    ,       https://postgrespro.ru/docs/postgrespro/9.5/continuous-archiving</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストレージの作成</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（pgbackrestユーザー）：</font></font></i><font style="vertical-align: inherit;"><u><font style="vertical-align: inherit;">メイン</font></u></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
クラスタの新しいリポジトリを作成します</font><font style="vertical-align: inherit;">。</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir -m 770 /var/lib/pgbackrest<font></font>
sudo chown -R pgbackrest /var/lib/pgbackrest/<font></font>
sudo -u pgbackrest pgbackrest --stanza=main stanza-create<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小切手</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresサーバー（sudoユーザーまたはroot）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
postgresサーバーを確認します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo -u postgres pgbackrest --stanza=main --<span class="hljs-built_in">log</span>-level-console=info check</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（pgbackrestユーザー）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
リポジトリサーバーで確認します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo -u pgbackrest pgbackrest --stanza=main --<span class="hljs-built_in">log</span>-level-console=info check</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力に「check command end：completed completed」という行があることを確認します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">疲れましたか？</font><font style="vertical-align: inherit;">私たちは最も興味深いものに合格します。</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップを作成</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（pgbackrestユーザー）：</font></font><br>
</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1.バックアップ：</font></font><br>
<br>
<pre><code class="bash hljs">sudo -u pgbackrest pgbackrest --stanza=main backup
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.バックアップが作成されたことを確認します。</font></font><br>
<br>
<pre><code class="bash hljs">ls /var/lib/pgbackrest/backup/main/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pgbackrestは最初の完全バックアップを作成します。</font><font style="vertical-align: inherit;">必要に応じて、backupコマンドを再度実行して、システムが増分バックアップを作成することを確認できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度完全バックアップを作成する場合は、追加のフラグを指定します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo -u pgbackrest pgbackrest --stanza=main --<span class="hljs-built_in">type</span>=full backup</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールへの詳細な出力が必要な場合は、次も指定します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo -u pgbackrest pgbackrest --stanza=main --<span class="hljs-built_in">type</span>=full --<span class="hljs-built_in">log</span>-level-console=info backup</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップを復元</font></font></h3><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresサーバー（sudoユーザーまたはroot）：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1.稼働中のクラスターを停止します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo pg_ctlcluster 11 main stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.バックアップから回復します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo -u postgres pgbackrest --stanza=main --delta restore</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.クラスターを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo pg_ctlcluster 11 main start</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バックアップを復元した後、2番目のバックアップを実行する必要があり</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">：</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ（pgbackrestユーザー）：</font></font></i><br>
<br>
<pre><code class="bash hljs">sudo pgbackrest --stanza=main backup</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで全部です。</font><font style="vertical-align: inherit;">結論として、私が自分で上級dbaを構築しようとしているのではなく、少しの機会に雲を使用することを思い出させてください。</font><font style="vertical-align: inherit;">現在、私自身、バックアップ、レプリケーション、モニタリングなど、さまざまなトピックについて研究を始めています。</font><font style="vertical-align: inherit;">そして、コミュニティに小さな貢献をし、小さなベビーベッドを自分のために残すために、結果について小さなレポートを書きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の記事では、追加機能について説明します。クリーンクラスターでのデータリカバリ、バックアップの暗号化とS3での公開、rsyncによるバックアップ。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja476186/index.html">開発者がPKIを実装するのを助ける</a></li>
<li><a href="../ja476188/index.html">嫌悪を定義するためのニューラルネットワーク-「いいえ、禁止です」</a></li>
<li><a href="../ja476192/index.html">重要な延命ツイート</a></li>
<li><a href="../ja476194/index.html">Habr Weekly＃27 / Chromebook対Macbook、クールな履歴書の書き方、給与、3500ドルのARポイント</a></li>
<li><a href="../ja476198/index.html">私が最初のウェブサイトを作成した方法とそれから生まれたもの</a></li>
<li><a href="../ja476208/index.html">Web Almanac 2019：可用性</a></li>
<li><a href="../ja476210/index.html">公開鍵標準に基づく暗号ワークステーション。PKCS＃11トークンの構成</a></li>
<li><a href="../ja476212/index.html">実際に実証済み：磁気テープを操作するためのVeeam Backup＆Replication 9.5 Update 4機能</a></li>
<li><a href="../ja476214/index.html">マスコットスラムの誕生</a></li>
<li><a href="../ja476216/index.html">ウェブ r0ot-miによる問題解決。パート2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>