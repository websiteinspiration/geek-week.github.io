<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>◽️ 👲🏻 🍨 Redd複合施設のカスタムタイヤの取り扱いの練習 🎎 🌃 📆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="では前回の記事、私たちはReddの複合体で千ささいなことを管理するための理論を調べたが、ボリュームを膨らませないために、我々は実際に次の時間を延期しました。実用的な実験を行う時が来ました。Reddコンプレックスを使用しないユーザーも、この記事で有用な知識、つまりLinuxからUSBドライブにベンダー...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Redd複合施設のカスタムタイヤの取り扱いの練習</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484706/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回の記事、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはReddの複合体で千ささいなことを管理するための理論を調べたが、ボリュームを膨らませないために、我々は実際に次の時間を延期しました。</font><font style="vertical-align: inherit;">実用的な実験を行う時が来ました。</font><font style="vertical-align: inherit;">Reddコンプレックスを使用しないユーザーも、この記事で有用な知識、つまりLinuxからUSBドライブにベンダーコマンドを送信する方法を見つけることができます。これは、すでに述べたように、コンプレックス内のSTM32コントローラーがSDリーダーの機能を実行するためです。ドライブ。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_e/hh/5n/_ehh5nw2j8tiw7myjovthvvc_va.png"><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前のサイクル記事</font></font></b><div class="spoiler_text"><ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  «»  ,   Redd,      .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  «»  ,   Redd.  2.  .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">          .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">     Redd     .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">              Redd.</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> ,       .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    Redd.  1:  .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    Redd.  2:      .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  :        .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    Redd,    FTDI</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">     Redd</a></li>
</ol><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドシステムによる分類の推進</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドライブを操作するときは、物理インターフェイスとコマンドシステムを区別する必要があります。特に、CD / DVD / BDドライブおよびその他の光学系。従来、これらはSATAケーブル（以前のIDE）に接続します。しかし、特にこのワイヤでは、操作中に実行されるPACKETコマンドのみが、まったく異なる原理に従ってエンコードされたコマンドが配置されたデータブロックに配置されます（すぐにいずれかによってわかります）。したがって、ここでは、ワイヤーについてではなく、ワイヤーを実行するチームについて説明します。ドライブを操作するための3つの一般的なコマンドシステムを知っています。</font></font><br>
 <br>
<ul>
<li>MMC.   SD-.  ,       .   , , ,    ,     ,    , —   .  ,     ,        SD-,       STM32   « ».</li>
<li>ATA.       IDE,  —  SATA.   ,      ,   .</li>
<li>SCSI.        .     .   SCSI- ,   ,    SAS (,      SSD   SAS).   ,  ,     SATA,    SCSI-.   USB     Mass Storage Device,      SCSI.  STM32    Redd   USB,  ,   ,     :<br>
<br>
<img src="https://habrastorage.org/webt/hy/iy/f4/hyiyf4m9sjgr8etz8ily8joxsrc.png"> <br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PCからコントローラーへ、USB経由で、コマンドはSCSI形式です。</font><font style="vertical-align: inherit;">コントローラは、MMCルールに従ってコマンドをトランスコードし、SDIOバス経由で送信します。</font><font style="vertical-align: inherit;">しかし、PC用のプログラムを作成する必要があるため、チームはSCSI形式のままにします。</font><font style="vertical-align: inherit;">それらは、ファイルシステムドライバーを介して通信する大容量記憶装置デバイスドライバーによって準備されます。</font><font style="vertical-align: inherit;">これらのリクエストについて、リクエストを他のデバイスと混在させることはできますか？</font><font style="vertical-align: inherit;">それを正しくしましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCSIコマンドシステムの詳細</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題に正式に取り組む場合、SCSI規格の説明はt10.orgにありますが、現実的です。誰も自発的にそれを読むことはありません。より正確には、彼ではなく、彼らのものです。開いているドキュメントの山全体と閉じたドキュメントの山があります。極端に必要なのは、標準が記述されている複雑な言語に没頭することだけです（これは、t13.orgのATA標準に適用されます）。実際のドライブのドキュメントを読む方がはるかに簡単です。それはより生きた言語で書かれており、仮定ではあるが実際には使用されていない部分がそれから切り取られています。この記事の準備中に</font><font style="vertical-align: inherit;">、Seagate </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCSIコマンドリファレンスマニュアル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（直接リンク</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">www.seagate.com/files/staticfiles/support/docs/manual/Interface%20manuals/100293068j.pdf</font></a><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">から</font><font style="vertical-align: inherit;">かなり新しい（2016）ドキュメント</font><font style="vertical-align: inherit;">を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">見つけました。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、いつものように、私は彼女がいつまで生きるかわからない）。誰かがこのコマンドシステムをマスターしたい場合は、このドキュメントから始めるのが良いと思います。 SDリーダーは、その説明にあるコマンドのさらに小さなサブセットを実装していることだけを覚えています。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単に言えば、6〜16バイトの長さのコマンドユニットがドライブに送信されます。データブロックは、PCからドライブへ、またはドライブからPCへのいずれかでコマンドブロックに接続できます（SCSI規格では双方向の交換も可能ですが、USBを介した大容量記憶装置の場合、1つのブロックしか許可されません。つまり、方向は1つだけです）。命令ブロックでは、最初のバイトは常にコマンドコードです。残りのバイトはその引数です。引数を入力するためのルールは、コマンドの実装の詳細によってのみ説明されています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xt/1l/eb/xt1lebwoznye5dag98pwbtiuxfm.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初めはたくさんの例を記事に挿入しましたが、読みづらいことに気づきました。</font><font style="vertical-align: inherit;">したがって、Seigate文書の表119にあるREAD CAPACITY（10）コマンドのフィールドと、同じ文書の表97にあるREAD（10）コマンドのフィールドを比較することをお勧めします（上記のリンクを参照）。</font><font style="vertical-align: inherit;">接続を見つけられなかった人-心配しないでください。</font><font style="vertical-align: inherit;">それが私が見せたかったものです。</font><font style="vertical-align: inherit;">ゼロバイトのコマンドフィールドに加えて、すべてのフィールドの目的は、特定のコマンドの仕様にのみ依存します。</font><font style="vertical-align: inherit;">常にドキュメントを開いて、残りのフィールドの目的を検討する必要があります。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そう：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドライブと通信するには、6〜16バイトの長さのコマンドブロックを形成する必要があります（コマンドの形式に応じて、正確な数はそのドキュメントに示されています）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最も重要なのは、ブロックのゼロバイトです。コマンドコードを設定するのは彼です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">残りのブロックバイトには明確な目的がありません。</font><font style="vertical-align: inherit;">それらに記入する方法を理解するには、特定のチームのドキュメントを開く必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドライブとの間で転送できるデータのブロックは、コマンドに添付できます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、それだけです。</font><font style="vertical-align: inherit;">SCSIコマンドの発行規則を学びました。</font><font style="vertical-align: inherit;">それらを提出できるようになったので、それらについてのドキュメントがあります。</font><font style="vertical-align: inherit;">しかし、オペレーティングシステムレベルでそれを行う方法は？</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux SCSIコマンド</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ターゲットデバイスを検索</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドを発行するには、ディスクデバイスを開きます。彼の名前を見つけましょう。これを行うには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリアルポートに関する記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とまったく同じ方法を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ devディレクトリ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の「ファイル」のリストを見てみましょう</font><font style="vertical-align: inherit;">（Linuxデバイスではファイルとしても表示され、同じ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lsコマンド</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でそのリストが表示されることに</font><b><font style="vertical-align: inherit;">注意してください</font></b><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日は、仮想ディレクトリに注意を払う</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスク</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/t_/py/kj/t_pykjsq2_2gdno-u0oc9wdpltm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、その内容を見て：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cp/yp/n_/cpypn_cslhfibis7ixhbez64q4y.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネストされたディレクトリのおなじみのセットを！</font><b><font style="vertical-align: inherit;">lsコマンドの</font></b><b><font style="vertical-align: inherit;">–l</font></b><font style="vertical-align: inherit;">スイッチ</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">して、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">by-id</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディレクトリを検討しようとしています</font><font style="vertical-align: inherit;">。これは、シリアルポートに関する記事ですでに知っています</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/jq/8s/zn/jq8sznkl6pimg5oxevbdp8m7l4w.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
強調表示された言葉はそれ自体を物語っています。</font><font style="vertical-align: inherit;">これは、Reddコンプレックスの内部SDカードを含むドライブです。</font><font style="vertical-align: inherit;">いいね！</font><font style="vertical-align: inherit;">これで、デバイス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIR_Redd_Internal_SD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がデバイス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / sdbおよび/ dev / sdb1に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">対応することが</font><b><font style="vertical-align: inherit;">わかり</font></b><font style="vertical-align: inherit;">ました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">番号が付いていないのはドライブ自体です。ドライブで作業します。番号が付いているのは、挿入されたメディアにあるファイルシステムです。</font><font style="vertical-align: inherit;">SDカードの操作に関しては、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / sdb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はリーダーであり、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / sdb1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はカードに挿入されたカード上のファイルシステムです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドを発行するためのオペレーティングシステムの機能</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、どのOSでも、デバイスに関するすべての非標準的なことは、ドライバーへの直接要求を通じて行われます。 Linuxでは、このようなリクエストを送信するために</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を使用できます</font><font style="vertical-align: inherit;">。私たちのケースも例外ではありません。引数peredaom要求</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SG_IO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘッダファイルに記述さ、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sg.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リクエストパラメータを含む</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sg_io_hdr_t</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造体もそこに記述されてい</font><font style="vertical-align: inherit;">ます。すべてのフィールドが入力されるわけではないため、完全な構造は示しません。そのうち最も重要なものだけをあげます。</font></font><br>
<br>
<pre><code class="plaintext hljs">typedef struct sg_io_hdr<font></font>
{<font></font>
  int interface_id;           /* [i] 'S' for SCSI generic (required) */<font></font>
  int dxfer_direction;        /* [i] data transfer direction  */<font></font>
  unsigned char cmd_len;      /* [i] SCSI command length ( &lt;= 16 bytes) */<font></font>
  unsigned char mx_sb_len;    /* [i] max length to write to sbp */<font></font>
  unsigned short int iovec_count; /* [i] 0 implies no scatter gather */<font></font>
  unsigned int dxfer_len;     /* [i] byte count of data transfer */<font></font>
  void * dxferp;              /* [i], [*io] points to data transfer memory<font></font>
				 or scatter gather list */<font></font>
  unsigned char * cmdp;       /* [i], [*i] points to command to perform */<font></font>
  unsigned char * sbp;        /* [i], [*o] points to sense_buffer memory */<font></font>
  unsigned int timeout;       /* [i] MAX_UINT-&gt;no timeout (unit: millisec) */<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コメント（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface_id、dxfer_direction、timeout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）で</font><font style="vertical-align: inherit;">十分に文書化されているフィールド</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">説明し</font><font style="vertical-align: inherit;">ても意味がありません。記事はすでに成長しています。</font><b><font style="vertical-align: inherit;">cmd_len</font></b></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
フィールド</font><font style="vertical-align: inherit;">にはコマンドブロックのバイト数が含まれ、</font><b><font style="vertical-align: inherit;">cmdp</font></b><font style="vertical-align: inherit;">はこのブロックへのポインターです。コマンドなしでは実行できないため、バイト数はゼロ以外（6〜16）でなければなりません。</font><font style="vertical-align: inherit;">
データはオプションです。これらがある場合、割り当てられたバッファの長さは、フィールドに指定され</font><b><font style="vertical-align: inherit;">dxfer_len</font></b><font style="vertical-align: inherit;">、それへのポインタ-フィールドに</font><b><font style="vertical-align: inherit;">dxferp</font></b><font style="vertical-align: inherit;">。ドライブは、指定されたバッファーサイズよりも物理的に少ないデータを転送できます。送信の方向は、</font><b><font style="vertical-align: inherit;">dxfer_direction</font></b><font style="vertical-align: inherit;">フィールドで指定されます</font><font style="vertical-align: inherit;">。 USB大容量記憶装置の有効な値は次のとおりです。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SG_DXFER_NONE、SG_DXFER_TO_DEV、SG_DXFER_FROM_DEV</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ヘッダーファイルにはもう1つありますが、マスストレージデバイス標準では、物理的に実装することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
拡張エラーコード（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SENSE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">の返却を要求することもできます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">それはSegate文書のセクション2.4にあります。</font><font style="vertical-align: inherit;">割り当てられたバッファの長さは、フィールド</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mx_sb_len</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sbp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内のバッファへのポインタで</font><font style="vertical-align: inherit;">指定されます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、上記で説明したすべての内容がこの構造に入力されています（さらに、エラーに関する詳細情報を取得できます）。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SG_IO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストの</font><b><font style="vertical-align: inherit;">操作</font></b><font style="vertical-align: inherit;">について詳しくは、</font><b><font style="vertical-align: inherit;">sg.danny.cz</font></b><font style="vertical-align: inherit;"> / </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">sg</font></a><font style="vertical-align: inherit;"> / </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">sg_io.htmlをご覧</font></a><font style="vertical-align: inherit;">ください。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドライブに標準コマンドを送信します</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、コマンドの形式を理解し、送信先のデバイスを見つけ、これを呼び出す関数を見つけました。いくつかの標準コマンドをデバイスに送信してみましょう。これをドライブ名を取得するコマンドとします。これがSeagateドキュメントでの記述方法です</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/qk/ca/njqkcamj1tnhjznoczjnrdfni60.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。SCSIイデオロギーによれば、標準コマンドのすべてのフィールドはビッグエンディアン表記、つまり最上位バイト転送で埋められることに注意してください。したがって、「0x80、0x00」の形式ではなく、逆に「0x00、0x80」の形式で、バッファー長をフィールドに入力します。しかし、これは標準コマンドです。非標準ではすべてが可能です。常に説明を参照してください。実際には、コマンドコード（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）と入力する必要がある長さ。</font><font style="vertical-align: inherit;">ページ0を要求します。残りのフィールドは予約されているか、古いか、またはデフォルトで0になっています。</font><font style="vertical-align: inherit;">だから、それらをすべてゼロで埋めます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のコマンドを実行するプログラムを作成します。</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#include &lt;cstdio&gt;<font></font>
#include &lt;stdint.h&gt;<font></font>
#include &lt;string.h&gt;<font></font>
#include &lt;fcntl.h&gt;		// open<font></font>
#include &lt;unistd.h&gt;		// close<font></font>
#include &lt;sys/ioctl.h&gt;<font></font>
#include &lt;scsi/scsi.h&gt;<font></font>
#include &lt;scsi/sg.h&gt;<font></font>
<font></font>
int main()<font></font>
{<font></font>
    printf("hello from SdAccessTest!\n");<font></font>
<font></font>
    int s_fd = open("/dev/sdb", O_NONBLOCK | O_RDWR);<font></font>
    if (s_fd &lt; 0)<font></font>
    {<font></font>
        printf("Cannot open file\n");<font></font>
        return -1;<font></font>
    }<font></font>
<font></font>
<font></font>
    sg_io_hdr_t header;<font></font>
    memset(&amp;header;, 0, sizeof(header));<font></font>
    uint8_t cmd12h[] = { 0x12,0x00,0x00,0x00,0x80,0x00};<font></font>
    uint8_t data[0x80];<font></font>
    uint8_t sense[0x80];<font></font>
<font></font>
    header.interface_id = 'S';	//  'S'<font></font>
    // <font></font>
    header.cmd_len = sizeof(cmd12h);<font></font>
    header.cmdp = cmd12h;<font></font>
    // <font></font>
    header.dxfer_len = sizeof(data);<font></font>
    header.dxferp = data;<font></font>
    header.dxfer_direction = SG_DXFER_TO_FROM_DEV;<font></font>
    //    <font></font>
    header.mx_sb_len = sizeof(sense);<font></font>
    header.sbp = sense;<font></font>
    //<font></font>
    header.timeout = 100;	// 100 <font></font>
<font></font>
<font></font>
    int res = ioctl(s_fd, SG_IO, &amp;header;);<font></font>
<font></font>
<font></font>
    close(s_fd);<font></font>
    return 0;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなプログラムをリモートのReddデバイスで実行する方法については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で既に説明してい</font><font style="vertical-align: inherit;">ます。確かに、それを初めて起動したとき、私はすぐに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を呼び出すエラーを受け取りました</font><font style="vertical-align: inherit;">。デフォルトでは、ユーザーにはディスクデバイスを開くための十分な権限がないことが判明しました。私はどれがLinuxスペシャリストで、何度も書いていますが、ネットワーク上でこの問題を解決するために次のコマンドを発行して、デバイスへのアクセス権を変更できることがわかりました：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sudo chmod 666 / dev / sdb</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ただし、私のボス（しかし、彼は大きいこのOSのスペシャリスト）は、このソリューションはオペレーティングシステムを再起動するまで有効であると後で述べました。確実に権限を取得するには、ユーザーを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスク</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グループに追加する必要があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これら2つのパスのどちらを使用しても、すべてが機能した後、行</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブレークポイントを設定します</font><b><font style="vertical-align: inherit;">（s_fd）。</font></b><font style="vertical-align: inherit;">そして、開発環境での達成時間ごとに結果を検証します（プログラムは1日でもないため、開発環境ですべてを表示できるのであれば、マッパーの挿入に時間と労力を費やす時間がないためです）。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">res</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の値</font><font style="vertical-align: inherit;">はゼロです。したがって、チームはエラーなしで作業しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ih/2o/40/ih2o40ujbpv2p0qk9m_qiwdw9do.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何がバッファーに来ましたか？ダンプのアドレスに「</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">という単語を入力</font><font style="vertical-align: inherit;">すると、値を計算できないと言われ、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＆データ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を入力する</font><b><font style="vertical-align: inherit;">必要がありました。</font></b><font style="vertical-align: inherit;">。奇妙なのは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-これはポインタであり、Windowsでのデバッグではすべてが機能しますが、この事実に注意すると、次のように機能します。このようにして得られた結果を見てください。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bj/tk/ae/bjtkaehd8ucyzdufbdsn1392tgm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうです、ドライブの名前とリビジョンが返されました。</font><font style="vertical-align: inherit;">結果の構造の形式に関する詳細情報は、Segateドキュメント（セクション3.6.2、表59）にあります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">センス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファー</font><font style="vertical-align: inherit;">はいっぱいになりませんでしたが、要求のIOCTL記述は、このバッファーに何かを返すエラーが発生した場合にのみ満たされることを示しています。</font><font style="vertical-align: inherit;">文字通り：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">センスデータ（ 'status'がCHECK CONDITIONまたは（driver_status＆DRIVER_SENSE）がtrueの場合にのみ使用）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redd内蔵SDドライブのカスタムコマンド形式</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、標準のドライな説明を調査しただけでなく、実際にすべてを試し、コマンドブロックとは何かを経験したので、複雑なボード上のSTM32コントローラーに「フラッシュ」される非標準関数を呼び出すことができるコマンド形式をすでに示すことができます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベンダー固有</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">範囲の最初からコマンドコードを選択しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは0xC0と同じです。</font><font style="vertical-align: inherit;">従来、SCSIコマンドの説明では、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C0h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と記述してい</font><b><font style="vertical-align: inherit;">ました</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">コマンドの長さは常に10バイトです。</font><font style="vertical-align: inherit;">チームのフォーマットは統一されており、以下の表に示されています。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイト</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任命</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドコードC0h</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブコマンドコード</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td rowspan="4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引数arg1。</font><font style="vertical-align: inherit;">リトルエンディアン表記で設定（下位バイト転送）</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">３</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></td>
<td rowspan="4"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引数arg2。</font><font style="vertical-align: inherit;">リトルエンディアン表記で設定（下位バイト転送）</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、引数はリトルエンディアン表記で与えられています。</font><font style="vertical-align: inherit;">これにより、バイト置換関数に頼ることなく、コマンドを構造体の形式で記述し、そのフィールドに直接アクセスできます。</font><font style="vertical-align: inherit;">x86およびx64アーキテクチャーでのアライメントの問題（構造内のダブルワードには4の倍数ではないオフセットがあります）は、それだけの価値はありません。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サブコマンドのコードは、次の列挙で説明されています。</font></font><br>
<pre><code class="plaintext hljs">enum vendorSubCommands<font></font>
{<font></font>
    subCmdSdEnable = 0,			// 00 Switch SD card to PC or Outside<font></font>
    subCmdSdPower,					// 01 Switch Power of SD card On/Off<font></font>
    subCmdSdReinit,					// 02 Reinitialize SD card (for example, after Power Cycle)<font></font>
    subCmdSpiFlashEnable,		// 03 Switch SPI Flash to PC or Outside<font></font>
    subCmdSpiFlashWritePage, // 04 Write Page to SPI Flash<font></font>
    subCmdSpiFlashReadPage, // 05 Read Page from SPI Flash<font></font>
    subCmdSpiFlashErasePage,// 06 Erase Pages on SPI Flash (4K block)<font></font>
    subCmdRelaysOn,         // 07 Switch relays On by mask<font></font>
    subCmdRelaysOff,        // 08 Switch relays off by mask<font></font>
    subCmdRelaysSet,        // 09 Set state of all relays by data<font></font>
    subCmdFT4222_1_Reset,   // 0A Activate Reset State or switch chip to normal mode<font></font>
    subCmdFT4222_2_Reset,   // 0B Activate Reset State or switch chip to normal mode<font></font>
    subCmdFT4222_3_Reset,   // 0C Activate Reset State or switch chip to normal mode<font></font>
    subCmdFT4232_Reset,  // 0D Activate Reset State or switch chip to normal mode<font></font>
    subCmdFT2232_Reset,     // 0E Activate Reset State or switch chip to normal mode<font></font>
    subCmdMAX3421_Reset,    // 0F Activate Reset State or switch chip to normal mode<font></font>
    subCmdFT4222_1_Cfg,     // 10 Write to CFG pins of FT4222_1<font></font>
    subCmdFT4222_2_Cfg,     // 11 Write to CFG pins of FT4222_2<font></font>
    subCmdFT4222_3_Cfg,     // 12 Write to CFG pins of FT4222_3<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それらはグループに分けることができます。</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバイスを内部モードと外部モードに切り替える</font></font></h3><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdSdEnable</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdSpiFlashEnableコマンドは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、それぞれ、SDカードやSPIフラッシュを切り替えます。</font><font style="vertical-align: inherit;">パラメータ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、次のいずれかの値を渡します。</font></font><br>
<br>
<pre><code class="plaintext hljs">enum enableMode<font></font>
{	<font></font>
	enableModeToPC = 0,<font></font>
	enableModeOutside<font></font>
};</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、両方のデバイスがPCに接続されています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パワースイッチング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDIOプロトコルは、初期化中にかなり多くの操作を必要とします。</font><font style="vertical-align: inherit;">SDカードを初期状態にリセットすると便利な場合があります（たとえば、ラインを外部コネクタに切り替える場合など）。</font><font style="vertical-align: inherit;">これを行うには、いったん電源をオフにしてからオンにします。</font><font style="vertical-align: inherit;">これは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdSdPowerコマンド</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して</font><b><font style="vertical-align: inherit;">実行</font></b><font style="vertical-align: inherit;">できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">引数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg1では</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次のいずれかの値が渡されます：0-電源オフ、1-電源オン。</font><font style="vertical-align: inherit;">電源ラインのコンデンサを放電する時間を忘れないでください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電源を入れた後、PCに接続されているカードは再初期化する必要があります。</font><font style="vertical-align: inherit;">これを行うには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdSdReinit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドを使用します</font><font style="vertical-align: inherit;">（引数はありません）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPIフラッシュドライブの操作</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDカードがフルドライブとしてシステムに接続されている場合、現在のバージョンのアクセスチップは非常に制限されています。個々のページ（256バイト）のみにアクセスでき、一度に1つしかアクセスできません。マイクロ回路内のメモリの量は、ページ上で作業している場合でも、プロセスにそれほど時間はかからない程度ですが、このアプローチにより、マイクロコントローラーの「ファームウェア」が大幅に簡素化されます。</font><b><font style="vertical-align: inherit;">subCmdSpiFlashReadPage</font></b></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
コマンド</font><font style="vertical-align: inherit;">は、ページを読み取ります。アドレスはarg1パラメーターで指定され、送信するページ数はarg2パラメーターで指定されます。しかし、現在のバージョンでは、ページ数は1に等しいはずです。コマンドは256バイトのデータを返します。</font><font style="vertical-align: inherit;">
彼女のためにミラーリング</font><b><font style="vertical-align: inherit;">-subCmdSpiFlashWritePage</font></b><font style="vertical-align: inherit;">コマンド</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">彼女の議論は同じ原則に従って記入されます。</font><font style="vertical-align: inherit;">データ転送の方向はデバイスです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フラッシュメモリの特徴は、記録中にシングルビットのみをゼロビットに置き換えることができることです。</font><font style="vertical-align: inherit;">それらを単一の値に戻すには、ページを消去する必要があります。</font><font style="vertical-align: inherit;">これには</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdSpiFlashErasePage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドがあり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">確かに、適用されたマイクロ回路の機能により、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータでアドレスが指定されている単一のページは消去されません</font><font style="vertical-align: inherit;">が、それを含む4キロバイトのブロックが</font><font style="vertical-align: inherit;">消去されます</font><font style="vertical-align: inherit;">。</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソリッドステートリレー管理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンプレックスには6つのソリッドステートリレーがあります。それらを管理する3つのチームがあります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdRelaysSet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -6つすべてのリレーの値を同時に設定します。パラメータ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg1に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値が渡されます。各ビットはそれ自体のリレーに対応します（ゼロビット-インデックス0のリレー、インデックス1の最初のビットなど）。単一ビット値はリレーを閉じ、ゼロ値はリレーを開きます。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この操作方法は、すべてのリレーが1つのグループとして機能する場合に適しています。それらが互いに独立して動作する場合、このアプローチでは、すべてのリレーの状態値を格納するバッファ変数を開始する必要があります。異なるリレーが異なるプログラムによって制御されている場合、集計値を保存する問題は非常に深刻になります。この場合、他の2つのコマンドを使用できます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdRelaysOn-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">選択したマスクリレーを有効にします。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引数の単位ビットに対応するリレーは</font><font style="vertical-align: inherit;">有効になります。</font><font style="vertical-align: inherit;">マスクのゼロに対応するリレーは、現在の状態を保持します。</font><b><font style="vertical-align: inherit;">subCmdRelaysOff</font></b></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
コマンドを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ミラーリングする</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、選択したリレーがマスクによってオフになります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引数の単一ビットに対応するリレー</font><font style="vertical-align: inherit;">はオフになります。</font><font style="vertical-align: inherit;">マスクのゼロに対応するリレーは、現在の状態を保持します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FTDIおよびMaximコントローラーのリセット</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リセット信号をFTDIおよびマキシムのマイクロ回路に送信するには、コマンドのグループ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdFT4222_1_Reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdFT4222_2_Reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdFT4222_3_Reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdFT4232_Reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdFT2232_Reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdMAX3421_が使用され</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。それらの名前から、リセット信号によって制御するチップを確認できます。先に検討したように、FT4222ブリッジは回路内に2つあり（インデックスは1と2です）、別のFT4222ブリッジがデータをMAX3421チップに転送します。これについては、次の記事で検討します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメータ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、次のいずれかの値を渡します。</font></font><br>
<br>
<pre><code class="plaintext hljs">enum ResetState<font></font>
{<font></font>
	resetStateActive =0,<font></font>
	resetStateNormalOperation<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、すべてのブリッジは通常の動作状態です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">すでに述べたように、</font><font style="vertical-align: inherit;">この機能が必要かどうかは私たち自身ではわかりませんが、デバイスに直接アクセスできない場合は、すべてをリモートでリセットできるようにすることをお勧めします。</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FT4222チップの設定ラインの切り替え</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FT4222チップには4つのモードがあります。</font><font style="vertical-align: inherit;">誰かが「00」以外のモードを必要とする可能性は低いですが、突然必要になった場合</font><font style="vertical-align: inherit;">は、1番目、2番目、3番目のマイクロ回路の</font><b><font style="vertical-align: inherit;">切り替え</font></b><font style="vertical-align: inherit;">に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdFT4222_1_Cfg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdFT4222_2_Cfg、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdFT4222_3_Cfgコマンド</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ラインCFG0およびCFG1の値は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arg1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータの下位2ビットに設定されます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32コントローラにコマンドを送信する実務経験</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際に取得した理論的な資料をテストするために、SDカードを切り替えてみます。</font><font style="vertical-align: inherit;">これを行うに</font><font style="vertical-align: inherit;">は、コード0x01を</font><font style="vertical-align: inherit;">引数に</font><b><font style="vertical-align: inherit;">enableModeOutside</font></b><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">指定したコード0x00を指定し</font><font style="vertical-align: inherit;">て</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subCmdSdEnable</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">発行し</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">完璧に。</font><font style="vertical-align: inherit;">プログラムを過去の経験から次のように書き直します。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">書き換えられたプログラム：</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#include &lt;cstdio&gt;<font></font>
#include &lt;stdint.h&gt;<font></font>
#include &lt;string.h&gt;<font></font>
#include &lt;fcntl.h&gt;		// open<font></font>
#include &lt;unistd.h&gt;		// close<font></font>
#include &lt;sys/ioctl.h&gt;<font></font>
#include &lt;scsi/scsi.h&gt;<font></font>
#include &lt;scsi/sg.h&gt;<font></font>
<font></font>
int main()<font></font>
{<font></font>
    printf("hello from SdAccessTest!\n");<font></font>
<font></font>
    int s_fd = open("/dev/sdb", O_NONBLOCK | O_RDWR);<font></font>
    if (s_fd &lt; 0)<font></font>
    {<font></font>
        printf("Cannot open file\n");<font></font>
        return -1;<font></font>
    }<font></font>
<font></font>
<font></font>
    sg_io_hdr_t header;<font></font>
    memset(&amp;header;, 0, sizeof(header));<font></font>
<font></font>
    uint8_t cmdSdToOutside[] = { 0xC0,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00 };<font></font>
    uint8_t cmdSdToPC[] = { 0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 };<font></font>
<font></font>
    uint8_t sense[32];<font></font>
    memset(sense, 0, sizeof(sense));<font></font>
<font></font>
    header.interface_id = 'S';	//  'S'<font></font>
<font></font>
    // <font></font>
    header.cmd_len = sizeof(cmdSdToOutside);<font></font>
    header.cmdp = cmdSdToOutside;<font></font>
    //  ( )<font></font>
    header.dxfer_len = 0;<font></font>
    header.dxferp = 0;<font></font>
    header.dxfer_direction = SG_DXFER_NONE;<font></font>
    //    <font></font>
    header.mx_sb_len = sizeof(sense);<font></font>
    header.sbp = sense;<font></font>
    //<font></font>
    header.timeout = 100;	// 100 <font></font>
<font></font>
    int res = ioctl(s_fd, SG_IO, &amp;header;);<font></font>
<font></font>
    //  <font></font>
    header.cmdp = cmdSdToPC;<font></font>
    res = ioctl(s_fd, SG_IO, &amp;header;);<font></font>
<font></font>
    close(s_fd);<font></font>
    return 0;<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンド長を10バイトに変更し、データブロックを削除しました。</font><font style="vertical-align: inherit;">まあ、彼らは必要に応じて、引数付きのコマンドコードを書き留めました。</font><font style="vertical-align: inherit;">そうでなければ、すべてが同じままです。</font><font style="vertical-align: inherit;">開始します...そして...何も機能しません。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">はエラーを返します。</font><font style="vertical-align: inherit;">理由は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SG_IO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font><b><font style="vertical-align: inherit;">ドキュメントに</font></b><font style="vertical-align: inherit;">記載されてい</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">実際には、ベンダー固有のコマンド</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C0hを指定し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、それらについて文字通り次のように述べています。</font></font><br>
<blockquote>Any other SCSI command (opcode) not mentioned for the sg driver needs O_RDWR. Any other SCSI command (opcode) not mentioned for the block layer SG_IO ioctl needs a user with CAP_SYS_RAWIO capability.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボスが私に説明したように（私はただ彼の言葉を言っているだけです）、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font><font style="vertical-align: inherit;">が実行可能ファイルに割り当てられます。このため、開発環境から</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">としてログインしてトレースする必要がありました</font><font style="vertical-align: inherit;">。最善の解決策ではないが、少なくとも何か。実際、Windowsでは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IOCTL_SCSI_PASS_THROUGH_DIRECT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要求に</font><font style="vertical-align: inherit;">も管理者権限が必要です。おそらくコメントで、誰かがそのような大胆な手順なしでトレース問題を解決する方法についてアドバイスを与えるでしょうが、</font><font style="vertical-align: inherit;">正しい</font><b><font style="vertical-align: inherit;">機能を</font></b><font style="vertical-align: inherit;">登録すれば</font><font style="vertical-align: inherit;">、すでに作成したプログラムを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なしで実行することもできます</font><font style="vertical-align: inherit;">。それまでの間、開発環境でユーザー名を変更し、次の行にブレークポイントを設定します。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="plaintext hljs">int res = ioctl(s_fd, SG_IO, &amp;header;);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして呼び出す前</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のioctl（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を、</font><font style="vertical-align: inherit;">私たちはストレージデバイスのリストを見て：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ys/ef/ls/yseflsambpnn83pbywoqfuazoqi.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、</font><font style="vertical-align: inherit;">呼び出し</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（IOCTL）を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して、もう一度リストを見て：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ro/2g/33/ro2g331krziu9uslxuzo28hylxa.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デバイス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は/ dev / sdbとの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遺跡（約いえば、これはSDカードリーダー自体である）、および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は/ dev / sdb1が</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消えてしまいました。このデバイスは、メディア上のファイルシステムに対応しています。キャリアはコンピュータから切断されました-見えなくなりました。追跡を続けます。 2番目の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioctl（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を呼び出した後</font><font style="vertical-align: inherit;">、再びデバイスのリストを確認します</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rd/wi/zx/rdwizxqu4amrqeuhzghnrptvkly.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。SDカードはシステムに再度接続されているため、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / sdb1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再び適所に。</font><font style="vertical-align: inherit;">実際、Reddコンプレックス内のSTM32マイクロコントローラーに基づいて、ベンダー固有のコマンドを与え、デバイスを制御する方法を学びました。</font><font style="vertical-align: inherit;">他のコマンドは、独立した研究のために読者に任されます。</font><font style="vertical-align: inherit;">それらのいくつかの操作を同様の方法で制御することが可能です。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ftdi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チップ</font><b><font style="vertical-align: inherit;">が</font></b><font style="vertical-align: inherit;">リセット状態になると、対応するデバイスがシステムから消えます。</font><font style="vertical-align: inherit;">リレーの動作と構成のレッグの制御は、測定機器によって制御する必要があります。</font><font style="vertical-align: inherit;">さて、あなたはその後の読み取り制御でページを書き込むことにより、フラッシュドライブでの作業を確認することができます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reddコンプレックス内のFPGAに関連しない2つの大きなトピックを検討しました。</font><font style="vertical-align: inherit;">3番目は残りました-USB 2.0 FSデバイスの実装を可能にするMAX3421チップとの連携。</font><font style="vertical-align: inherit;">実際、ホストもありますが、マザーボードにはたくさんのホストがあります。</font><font style="vertical-align: inherit;">デバイスの機能により、複合体は、USBフラッシュドライブ（「ファームウェア」のアップデートを送信するため）、USBキーボード（外部ユニットを制御するため）などのふりをすることができます。</font><font style="vertical-align: inherit;">このトピックについては、次の記事で取り上げます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja484688/index.html">計算能力の限界に近づいています-新しいプログラマが必要です</a></li>
<li><a href="../ja484690/index.html">セミナー、会議、mitap：18,000イベントの統計の研究</a></li>
<li><a href="../ja484692/index.html">ビタミンC-サプリメントを服用する必要がありますか、それとも商業的な動きですか？</a></li>
<li><a href="../ja484696/index.html">BI市場の変化と、ビジネスインテリジェンスプラットフォームを作成することにした理由</a></li>
<li><a href="../ja484700/index.html">Java 14：レコードのプレビュー</a></li>
<li><a href="../ja484708/index.html">リチャードハミング 「存在しない章」：知っているとおり（完全版）</a></li>
<li><a href="../ja484712/index.html">Reaktiveバイナリ互換性：提供方法</a></li>
<li><a href="../ja484714/index.html">フロントエンド向けのモダンビルド2020。Gulp4</a></li>
<li><a href="../ja484716/index.html">すべてをAIと呼ぶのをやめる</a></li>
<li><a href="../ja484718/index.html">Современные принтеры HP отказываются работать без подписки на чернила</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>