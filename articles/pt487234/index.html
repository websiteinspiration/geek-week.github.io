<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♀️ 👩🏾‍🏭 🎣 Ferro ou otimização? Badoo, Avito e Mamba - sobre desempenho em PHP 👵🏽 ⏫ 🎅🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O problema de desempenho do PHP no Badoo é um dos mais importantes. A qualidade do back-end do PHP depende diretamente da quantidade de recursos que g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ferro ou otimização? Badoo, Avito e Mamba - sobre desempenho em PHP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/487234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema de desempenho do PHP no Badoo é um dos mais importantes. A qualidade do back-end do PHP depende diretamente da quantidade de recursos que gastamos no desenvolvimento e operação, na velocidade do serviço e na impressão que ele causa nos usuários. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o tópico da terceira reunião da comunidade de desenvolvedores de PHP em nosso escritório, fizemos o desempenho de back-end e convidamos colegas de Avito e Mamba para discutir. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t-/p7/se/t-p7sef1pbww8vboigkup6ditzu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leia a transcrição da cena da discussão, na qual tive a sorte de ser um moderador: como a infraestrutura das três empresas é organizada, como medimos a produtividade e em que métricas nos concentramos, quais ferramentas usamos, como fazemos uma escolha entre hardware e otimização. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E em 15 de fevereiro, participe do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">próximo Meetup do Badoo PHP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : discuta o Legacy.</font></font><br>
<a name="habracut"></a><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/kWBm0C9A8oo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deciframos apenas a parte da discussão que nos pareceu mais interessante. </font><font style="vertical-align: inherit;">A versão completa está disponível em vídeo. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Especialistas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Chefe da Unidade de Desenvolvimento da Core Services Avito</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pmurzakov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, PHP Timlid no Badoo </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mipxtx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Diretor de TI da Mamba</font></font></li>
</ul><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conte uma história sobre otimização a partir de sua prática: grande sucesso ou grande fracasso é algo interessante de se compartilhar. </font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tenho uma parábola </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma vez a cada seis meses, analisamos as métricas e procuramos o que diminui, não funciona bem, o que precisa ser otimizado. </font><font style="vertical-align: inherit;">Uma vez notamos nosso contêiner de dependência do symfony, que cresceu para 52.000 linhas. </font><font style="vertical-align: inherit;">Decidimos que ele, o canalha, era o culpado por tudo: 20 ms de sobrecarga para cada solicitação. </font><font style="vertical-align: inherit;">Nós serramos. </font><font style="vertical-align: inherit;">Nós reduzimos isso. </font><font style="vertical-align: inherit;">De alguma forma, tentamos separá-lo, mas nada ajudou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E então descobrimos que temos anti-spam que precisa acessar 20 bancos de dados para atender a todas as solicitações necessárias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soluções que vêm em primeiro lugar nem sempre são as corretas. </font><font style="vertical-align: inherit;">Observe melhor os rastreamentos, logs e referências de suas solicitações e não quebre diretamente. </font><font style="vertical-align: inherit;">Aqui está uma história.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como temos um ecossistema bastante grande em PHP, fazemos otimizações periodicamente. </font><font style="vertical-align: inherit;">Estamos crescendo, estamos atingindo algum nível na CPU, entendemos que precisamos comprar hardware ou otimizar. </font><font style="vertical-align: inherit;">Pese os argumentos a favor e contra cada opção e decida. </font><font style="vertical-align: inherit;">Na maioria das vezes - a favor da otimização, porque o ferro precisa muito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um desses pontos, identificamos um grupo inteiro que estava envolvido na busca de várias coisas não ideais nos scripts PHP e na otimização. </font><font style="vertical-align: inherit;">Isso aconteceu literalmente “gota a gota”: aqui eles encontraram uma porcentagem, lá encontraram uma porcentagem - várias pessoas encontraram uma porcentagem dentro de um mês. </font><font style="vertical-align: inherit;">Em algum momento, nosso sishnik estava próximo</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einstein_man</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ele decidiu ver o que poderia fazer: saiu à noite, lançou o Perf, encontrou alguns problemas nas extensões PHP - e acelerou tudo em algumas noites em 13%!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tenho duas histórias. Um sobre o arquivo, o outro sobre o super desenvolvedor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre a falha. Temos muitos microsserviços, incluindo PHP. Todo mundo trabalha na Kubernetes. Eu trabalhei em um desses microsserviços. Houve uma utilização significativa da CPU: eles passaram uma semana otimizando e encontrando problemas. Aconteceu que um dos desenvolvedores adicionou o Xdebug às imagens base para calcular os testes de cobertura de código em seu (outro) serviço, após o qual todos os microsserviços em produção trabalhados com o Xdebug foram ativados por um quarto inteiro! Depois de um quarto, descobrimos isso, corrigimos imagens básicas - e começamos a receber presentes inesperados: relançei meu serviço e ele começou a funcionar mais rápido. Em cada implantação, nossa imagem de serviço é reconstruída e agora sem o Xdebug.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
História de sucesso. Temos muitos microsserviços, e eles se tornaram cada vez mais. Nessa situação, o número de chamadas RPC se torna um problema. Por exemplo, em um cartão de anúncio - e esta é uma das páginas mais frequentes no Avito - cerca de 30 microsserviços estão envolvidos na renderização de uma página. Além disso, tudo isso não foi feito de maneira muito explícita: parece que você está chamando algum tipo de abstração e, sob ela, cinco chamadas RPC para outros serviços são executadas seqüencialmente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao longo dos anos, o cartão do anúncio foi bastante degradado. </font><font style="vertical-align: inherit;">Um desenvolvedor forte lutou por um quarto, otimizou e trouxe todas as chamadas de RPC. </font><font style="vertical-align: inherit;">Quando ele conseguiu fazer isso, ele os paralelizou por meio da solicitação múltipla do Guzzle - e, em vez de 30 solicitações síncronas consecutivas, ele recebeu as mesmas 30 solicitações, mas paralelas, o que acelerou bastante o trabalho. </font><font style="vertical-align: inherit;">Após essa refatoração, o tempo de resposta do cartão é igual ao tempo máximo de resposta de qualquer um dos serviços. </font><font style="vertical-align: inherit;">Mas ele precisava de um quarto inteiro para otimizar / reescrever o código de exibição do cartão de anúncio.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diga-nos, qual é o tamanho do seu cluster PHP, como ele está configurado - pelo menos PHP-FPM, ou talvez em algum lugar que o Apache tenha problemas?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos cerca de 15.000 RPS. </font><font style="vertical-align: inherit;">Um cluster de 80 servidores FPM adquiridos há vários anos. </font><font style="vertical-align: inherit;">Em cada cluster, o FPM (máximo de 50 filhos) é lançado na estática. </font><font style="vertical-align: inherit;">Carregou cerca de dez no pico no horário nobre. </font><font style="vertical-align: inherit;">O tempo médio de resposta é de 100 ms e tentamos mantê-lo (quando excede 100 ms, iniciamos a busca por peças de freio). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nós temos nosso próprio sistema de monitoramento de desempenho. </font><font style="vertical-align: inherit;">Distribuímos muitos contadores no código, cerca de 120 por solicitação. </font><font style="vertical-align: inherit;">Monitoramos muitos eventos que ocorrem dentro do código em PHP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo é padrão conosco: nginx, PHP-FPM. Aproximadamente 600 servidores com FPM. Se quisermos falar sobre PHP, provavelmente existem mais 300 servidores para vários propósitos, como script, back-office e outros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dos recursos de configuração, existem dois. Em primeiro lugar, temos um proxy BMA - este é um proxy para dispositivos móveis. Ou seja, antes que uma solicitação chegue ao nginx, ele chega a um proxy especial que mantém uma conexão persistente e envia solicitações ao nginx. O segundo recurso - às vezes você precisa desativar o opcache da CLI (nós o ativamos em máquinas de script). Uma vez que não o desligamos, perdemos 30% da CPU nisso. Depois que perceberam o erro, ficaram surpresos com o quanto você pode economizar com uma configuração. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos patches PHP, mas eles quase não estão relacionados ao desempenho.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Há um ponto no bloqueio competitivo do APCu - quando você precisa escrever muito na mesma chave. </font><font style="vertical-align: inherit;">A arquitetura interna do APCu é construída de tal maneira que existe um bloqueio de chave global e, durante a gravação intensiva, os freios são iniciados. </font><font style="vertical-align: inherit;">Portanto, temos uma extensão personalizada lá que resolve esse problema. </font><font style="vertical-align: inherit;">Isso se refere apenas parcialmente ao desempenho, pois afeta o tempo de resposta, mas não o consumo da CPU.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos cerca de 2 milhões de solicitações por minuto (~ 33 kRPS). </font><font style="vertical-align: inherit;">Um aplicativo monolítico escrito em PHP é escrito há mais de 11 anos. </font><font style="vertical-align: inherit;">Está em uma fase de rápido crescimento. </font><font style="vertical-align: inherit;">Quando a empresa começou, havia 65 LXCs em 65 servidores físicos. </font><font style="vertical-align: inherit;">Em cada contêiner com o aplicativo, o PHP-FPM, nginx e o software auxiliar para métricas e log estão em execução. </font><font style="vertical-align: inherit;">Nada especial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao longo dos anos, nunca adicionamos ferro para um monólito. </font><font style="vertical-align: inherit;">Estamos aumentando a participação, o número de anúncios, o número de transações de usuários e estamos constantemente otimizando, melhorando o código, otimizando o software. </font><font style="vertical-align: inherit;">O consumo de CPU e memória vem caindo nos últimos anos: 65 contêineres para um monólito agora são suficientes para nós.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como você mede o desempenho? </font><font style="vertical-align: inherit;">Qual ferramenta você mede o tempo de resposta do cliente?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos um sistema de coleta de logs. </font><font style="vertical-align: inherit;">Ele registra dois indicadores - o tempo desde o início do FPM até a função de desligamento e até o final do script. </font><font style="vertical-align: inherit;">A segunda métrica é necessária para ver o que acontece após a função de desligamento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nós medimos JS. </font><font style="vertical-align: inherit;">Na verdade, essa é uma métrica mais ou menos: os canais de rede são frequentemente violados. </font><font style="vertical-align: inherit;">Como resultado, carregar em algum lugar no interior da Rússia começa a ficar embotado. </font><font style="vertical-align: inherit;">Portanto, ficamos assim: "Oh, pulou - isso significa que em algum lugar algo caiu". </font><font style="vertical-align: inherit;">Além disso, a publicidade de terceiros distorce muito a métrica. </font><font style="vertical-align: inherit;">E, mais importante, os spammers vêm, e isso geralmente é algum tipo de aleatoriedade.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A propósito, costumávamos usar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinba</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do Badoo </font><font style="vertical-align: inherit;">muito ativamente </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eu gosto dela agora. </font><font style="vertical-align: inherit;">A maioria das métricas foram coletadas por ele, mas depois mudadas para o protocolo StatsD. </font><font style="vertical-align: inherit;">Agora estamos fazendo medições de diferentes pontos: de frente, dos servidores em frente ao aplicativo, do nginx e do próprio aplicativo PHP. </font><font style="vertical-align: inherit;">Temos uma equipe de desempenho dedicada. </font><font style="vertical-align: inherit;">Ela começou com o desempenho da frente, mas depois mudou para o apoio. </font><font style="vertical-align: inherit;">De frente, ele coleta não apenas JS, CSS e outras estáticas, mas também o tempo de resposta do servidor. </font><font style="vertical-align: inherit;">Antes de tudo, nos concentramos no tempo de resposta do aplicativo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo é semelhante ao que os caras nos disseram. </font><font style="vertical-align: inherit;">Usando o Pinba clássico para PHP, medimos o tempo de execução de um script PHP em termos de PHP. </font><font style="vertical-align: inherit;">Mas também temos, por exemplo, Pinba para o nginx, que mede o tempo de resposta do ponto de vista do nginx. </font><font style="vertical-align: inherit;">Também coletamos métricas no cliente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que estamos olhando? </font><font style="vertical-align: inherit;">Por um lado, o tempo de resposta. </font><font style="vertical-align: inherit;">Não está relacionado ao planejamento de recursos. </font><font style="vertical-align: inherit;">Se é ruim, precisa ser aprimorado, porque é, de fato, a qualidade do serviço. </font><font style="vertical-align: inherit;">Outra coisa é que você precisa planejar o ferro de alguma forma. </font><font style="vertical-align: inherit;">Nossas ITOps e equipes de monitoramento monitoram todo o hardware. </font><font style="vertical-align: inherit;">Existem algumas barras na rede, no disco. </font><font style="vertical-align: inherit;">Existem alguns valores após os quais o alerta ocorre - e estamos fazendo algo. </font><font style="vertical-align: inherit;">Como a prática demonstrou, geralmente otimizamos a CPU: nos deparamos com ela.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nós, o aplicativo PHP mede a si próprio e em register_shutdown_function () lança métricas. </font><font style="vertical-align: inherit;">Cada LXC possui um servidor StatsD, que coleta essas métricas e as envia pelos coletores para o cluster Graphite (incluindo ClickHouse), onde os dados são armazenados. </font><font style="vertical-align: inherit;">Este é um autodiagnóstico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Também em cada contêiner está o nginx, ou seja, nginx + PHP-FPM. </font><font style="vertical-align: inherit;">Com o nginx, coletamos métricas externas relacionadas ao tempo de execução de um aplicativo PHP. </font><font style="vertical-align: inherit;">Eles também estão enfrentando servidores separados (os chamamos de avi-http) nginx, que executa roteamento básico, que também coleta métricas de nível superior, como tempo de resposta, número de 500 códigos de resposta e outros.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quais ferramentas você possui para uma faixa de desempenho? </font><font style="vertical-align: inherit;">O que você usa com mais frequência?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nós escrevemos nossa própria ferramenta. Quando o Pinba acabou de ser lançado - em 2012, há muito tempo -, era um módulo para o MySQL que recebia algo assim pelo UDP. Foi difícil tirar os gráficos; não foi muito otimizado para o desempenho. E não criamos nada melhor do que escrever uma coisa chamada Better Than Pinba. É apenas um servidor de contador que os aceita de um cliente PHP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espalhamos muitos cronômetros no código: toda vez que queremos medir algo, definimos o início e a parada do cronômetro no código. O próprio módulo calculará o tempo de execução do contador, agregará os contadores acumulados em um pacote e os enviará para o daemon. A própria interface extrairá tudo o que você precisa e criará gráficos conectados no contador desejado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos problemas de Pinba era a falta de sua própria interface - era necessário transferir dados para o RRD (então havia tanta escuridão). </font><font style="vertical-align: inherit;">Portanto, nós escrevemos nossa própria interface. </font><font style="vertical-align: inherit;">Toda vez que vemos o que pulou, podemos instalar o script. </font><font style="vertical-align: inherit;">No script, todos os contadores agregados são enviados para nós, que são enviados para nós. </font><font style="vertical-align: inherit;">Podemos ver onde o contador aumentou, o tempo de resposta no contador aumentou ou o número de contadores aumentou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode ser visto quando o desempenho cai. </font><font style="vertical-align: inherit;">Estamos começando a cavar dessa maneira. </font><font style="vertical-align: inherit;">Antes do PHP 7, usamos o XHProf, então ele parou de construir conosco. </font><font style="vertical-align: inherit;">Portanto, mudamos para o Xdebug. </font><font style="vertical-align: inherit;">Xdebug nós cutucamos apenas quando o problema é visível.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
É uma crença comum de que o XHProf não será construído no PHP 7. </font><font style="vertical-align: inherit;">Isso é verdade, mas apenas em parte. </font><font style="vertical-align: inherit;">Se você usar o XHProf no assistente, ele realmente não será. </font><font style="vertical-align: inherit;">Mas se no GitHub você alternar para um ramo chamado Experimental (ou algo parecido), tudo funcionará bem para o PHP 7, pronto para produção. </font><font style="vertical-align: inherit;">Verificado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não, eu troquei. </font><font style="vertical-align: inherit;">Não funcionou para mim.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quero adicionar sobre Pinba. </font><font style="vertical-align: inherit;">Você se tornou profeta até certo ponto. </font><font style="vertical-align: inherit;">Também, em algum momento, perdemos a produtividade. </font><font style="vertical-align: inherit;">Criamos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinba2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que é muito rápido. </font><font style="vertical-align: inherit;">Pode ser usado como um substituto para o Pinba.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo é modesto conosco. </font><font style="vertical-align: inherit;">Acabamos de levar a direção do desempenho para o trabalho: coletamos métricas, como tempo de resposta. </font><font style="vertical-align: inherit;">Nós usamos StatsD. </font><font style="vertical-align: inherit;">Ainda não usamos perfis regularmente, mas tenho certeza de que algumas equipes os usam em seus microsserviços escritos em PHP. </font><font style="vertical-align: inherit;">Na minha opinião, até alguém retransmite a New Relic. </font><font style="vertical-align: inherit;">Mas, no contexto da principal aplicação monolítica, até agora estamos apenas abordando isso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A história do ferro é monitorada em Grafana, Zabbix. </font><font style="vertical-align: inherit;">Quanto à parte do PHP, temos Pinba, temos um monte de temporizadores; </font><font style="vertical-align: inherit;">Construímos gráficos convenientes sobre eles. </font><font style="vertical-align: inherit;">Usamos o XHProf, na produção, dirigimos para uma parte das solicitações. </font><font style="vertical-align: inherit;">Sempre temos novos perfis XHProf disponíveis. </font><font style="vertical-align: inherit;">Temos liveprof: esta é a nossa ferramenta, você pode ler sobre isso, inclusive </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no meu artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tudo acontece automaticamente, você só precisa assistir. </font><font style="vertical-align: inherit;">Nós usamos o phpspy. </font><font style="vertical-align: inherit;">Nem sempre começa conosco: quando alguém quer ver alguma coisa, entra no carro, tira o perfil. </font><font style="vertical-align: inherit;">Em princípio, como é o caso do Perf.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
XHProf tem a mesma história. </font><font style="vertical-align: inherit;">Nós o usamos uma vez há muito tempo: era uma iniciativa pessoal de alguns desenvolvedores e, de fato, não decolou. </font><font style="vertical-align: inherit;">Ele parou de colecionar. </font><font style="vertical-align: inherit;">Coletamos várias métricas de chamadas de roteadores, controladores e vários modelos. </font><font style="vertical-align: inherit;">Cerca de 60 a 70% da rede interna do datacenter é ocupada por pacotes UDP com métricas. </font><font style="vertical-align: inherit;">No momento, isso é suficiente para nós. </font><font style="vertical-align: inherit;">Agora vamos procurar novos locais para otimização.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desde que chegamos ao ponto do ferro: alguém está envolvido sistematicamente no planejamento da capacidade da sua empresa? </font><font style="vertical-align: inherit;">Como esse processo é construído?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um aplicativo monolítico executa pelo menos 65 LXC por pelo menos cinco anos. </font><font style="vertical-align: inherit;">Otimizamos o código, melhoramos: ele possui recursos suficientes. </font><font style="vertical-align: inherit;">Nosso planejamento de capacidade principal vai para o Kubernetes, onde cerca de 400 microsserviços vivos são escritos em PHP / Go. </font><font style="vertical-align: inherit;">Estamos lentamente cortando pedaços do monólito, mas ele ainda está crescendo. </font><font style="vertical-align: inherit;">Não podemos detê-lo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o PHP é uma linguagem interessante. </font><font style="vertical-align: inherit;">Ele implementa rapidamente a lógica de negócios.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, as ITOps e as equipes de monitoramento garantem a disponibilidade de recursos suficientes. </font><font style="vertical-align: inherit;">Se começarmos a nos aproximar do valor limite, os colegas perceberão isso. </font><font style="vertical-align: inherit;">Eles provavelmente são os principais responsáveis ​​pelo planejamento da capacidade global. </font><font style="vertical-align: inherit;">A parte do PHP tem o principal recurso da CPU, por isso nós o seguimos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nós estabelecemos o padrão: não devemos "comer" mais de 60% do cluster. </font><font style="vertical-align: inherit;">60%, e não 95%, porque temos hypertreading, que extrai mais do processador do que você pode extrair sem ele. </font><font style="vertical-align: inherit;">Por isso, pagamos pelo fato de que, após 50% de nosso consumo de CPU, podemos crescer de uma maneira imprevisível, porque os kernels com hiper-leitura não são totalmente honestos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fazemos uma implantação e vemos que algo falhou conosco - esse planejamento de capacidade. </font><font style="vertical-align: inherit;">A olho! </font><font style="vertical-align: inherit;">Temos uma certa margem de produtividade que nos permite fazer isso. </font><font style="vertical-align: inherit;">Tentamos cumpri-lo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, postamos otimização factum. </font><font style="vertical-align: inherit;">Quando vemos que algo caiu, revertemos se tudo estiver completamente ruim. </font><font style="vertical-align: inherit;">Mas isso praticamente não acontece. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou apenas vemos que "aqui não é o ideal, agora vamos corrigir rapidamente tudo e tudo funcionará como deveria". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não nos preocupamos particularmente: é muito difícil e o escapamento não será muito grande.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Você está falando sobre microsserviços. </font><font style="vertical-align: inherit;">Como eles interagem? </font><font style="vertical-align: inherit;">É REST ou você está usando protocolos binários?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kafka é usado para enviar eventos entre serviços, JSON-RPC é usado para garantir a interação entre serviços, mas não completa, mas sua versão simplificada, da qual não podemos nos livrar. </font><font style="vertical-align: inherit;">Existem implementações mais rápidas: o mesmo protobuf, gRPC. </font><font style="vertical-align: inherit;">Isso está nos nossos planos, mas certamente não é uma prioridade. </font><font style="vertical-align: inherit;">Com mais de 400 microsserviços, é difícil transportar todos eles para o novo protocolo. </font><font style="vertical-align: inherit;">Existem muitos outros lugares para otimizar. </font><font style="vertical-align: inherit;">Definitivamente, não estamos preparados para isso agora.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nós, como tal, não temos microsserviços. </font><font style="vertical-align: inherit;">Existem serviços, também existe o Kafka, seu próprio protocolo em cima do protobuf do Google. </font><font style="vertical-align: inherit;">Provavelmente, usaríamos o gRPC, porque é legal, tem suporte para todos os idiomas, a capacidade de vincular facilmente peças diferentes. </font><font style="vertical-align: inherit;">Mas quando precisávamos, o gRPC ainda não estava lá. </font><font style="vertical-align: inherit;">Mas havia um protobuf e nós o pegamos. </font><font style="vertical-align: inherit;">Além disso, coisas diferentes foram adicionadas para que não fosse apenas serialização, mas um protocolo completo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Também não temos microsserviços. </font><font style="vertical-align: inherit;">Existem serviços escritos principalmente em C. Usamos JSON-RPC porque é conveniente. </font><font style="vertical-align: inherit;">Você acabou de abrir o soquete ao depurar seu código e rapidamente escreveu o que queria. </font><font style="vertical-align: inherit;">Algo voltou para você. </font><font style="vertical-align: inherit;">Protobuf é mais difícil porque você precisa usar algumas ferramentas adicionais. </font><font style="vertical-align: inherit;">Há uma pequena sobrecarga, mas acreditamos que você precisa pagar por conveniência, e esse não é um preço alto.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Você tem bancos de dados enormes. </font><font style="vertical-align: inherit;">Quando você precisa mudar o circuito em um deles, como você faz isso? </font><font style="vertical-align: inherit;">Algum tipo de migração? </font><font style="vertical-align: inherit;">Se essas migrações demorarem vários dias, como isso afeta o desempenho?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos mesas grandes, monolíticas. </font><font style="vertical-align: inherit;">Há um fragmento. </font><font style="vertical-align: inherit;">O fragmento altera-se rapidamente, porque existem muitos alteradores paralelos ao mesmo tempo. </font><font style="vertical-align: inherit;">Uma mesa grande com perfis alterou cerca de três horas. </font><font style="vertical-align: inherit;">Usamos ferramentas Perkonovskie que não possuem leitura e gravação. </font><font style="vertical-align: inherit;">Além disso, implementamos a alteração para que o código suporte os dois estados. </font><font style="vertical-align: inherit;">Após a alteração, também implantamos: a implantação é mais rápida do que a aplicação de qualquer esquema.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos o maior armazenamento (chamamos de "pontos") - este é um enorme banco de dados fragmentado. </font><font style="vertical-align: inherit;">Se pegarmos a tabela "Usuário", ela terá muitos fragmentos. </font><font style="vertical-align: inherit;">Não vou dizer exatamente quantas tabelas estarão em um servidor: a idéia é que existem muitas pequenas. </font><font style="vertical-align: inherit;">Quando mudamos o circuito, de fato, fazemos apenas uma alteração. </font><font style="vertical-align: inherit;">Em todas as mesas pequenas, isso acontece rapidamente. </font><font style="vertical-align: inherit;">Existem outros repositórios - já existem outras abordagens. </font><font style="vertical-align: inherit;">Se houver uma base enorme, existem ferramentas Perconian. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, usamos coisas diferentes de acordo com as necessidades. </font><font style="vertical-align: inherit;">A mudança mais frequente é uma mudança nessa enorme base de pontos fragmentados, na qual já construímos um processo. </font><font style="vertical-align: inherit;">Tudo funciona de maneira muito simples.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mesmo aplicativo monolítico que atende à maior parte do tráfego é implantado cinco a seis vezes por dia. </font><font style="vertical-align: inherit;">Quase a cada duas horas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em termos de trabalho com o banco de dados, esse é um problema separado. </font><font style="vertical-align: inherit;">Existem migrações, elas rolam automaticamente. </font><font style="vertical-align: inherit;">Esta é uma revisão do DBA. </font><font style="vertical-align: inherit;">Há uma opção para pular a migração e rolar manualmente. </font><font style="vertical-align: inherit;">A migração passará automaticamente para a preparação ao testar o código. </font><font style="vertical-align: inherit;">Mas na produção, se houver algum tipo de migração duvidosa que utilize muitos recursos, o DBA iniciará manualmente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O código deve ser tal que funcione com as estruturas de banco de dados antigas e novas. </font><font style="vertical-align: inherit;">Muitas vezes fazemos várias viagens para implantar recursos. </font><font style="vertical-align: inherit;">Para duas ou três implementações, é possível obter o estado desejado. </font><font style="vertical-align: inherit;">Da mesma forma, existem enormes bancos de dados, bancos de dados fragmentados. </font><font style="vertical-align: inherit;">Se contarmos para todos os microsserviços, definitivamente existem 100 a 150 implantações por dia.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gostaria de saber qual é o tempo de resposta padrão de back-end que você está seguindo? </font><font style="vertical-align: inherit;">Quando você entende o que precisa otimizar ainda mais ou qual é a hora de terminar? </font><font style="vertical-align: inherit;">Existe um valor de "média hospitalar"?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não. </font><font style="vertical-align: inherit;">Depende do ponto final. </font><font style="vertical-align: inherit;">Nós olhamos para tudo separadamente. </font><font style="vertical-align: inherit;">Tentando entender como isso é crítico. </font><font style="vertical-align: inherit;">Alguns pontos de extremidade geralmente são solicitados em segundo plano. </font><font style="vertical-align: inherit;">Isso não afeta o usuário de forma alguma, mesmo que o tempo de resposta seja de 20 s. </font><font style="vertical-align: inherit;">Isso vai acontecer em segundo plano, não há diferença. </font><font style="vertical-align: inherit;">O principal é que algumas coisas importantes sejam feitas rapidamente. </font><font style="vertical-align: inherit;">Talvez 200 ms ainda estejam ok, mas um pequeno aumento já é importante.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos mudando da renderização HTML para solicitações de API. </font><font style="vertical-align: inherit;">Aqui, de fato, a API responde muito mais rápido que a resposta HTML grande e pesada. </font><font style="vertical-align: inherit;">Portanto, é difícil distinguir, por exemplo, um valor de 100 ms. </font><font style="vertical-align: inherit;">Focamos em 200 ms. </font><font style="vertical-align: inherit;">Então aconteceu o PHP 7 - e começamos a focar em 100 ms. </font><font style="vertical-align: inherit;">Essa é a "média do hospital". </font><font style="vertical-align: inherit;">Essa é uma métrica muito vaga, o que sugere que é hora de pelo menos olhar para lá. </font><font style="vertical-align: inherit;">Por isso, focamos na implantação e aumentamos o tempo de resposta após ela.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fizemos um esboço de uma das equipes de desempenho. Os colegas mediram quanto mais uma empresa ganha, acelerando o carregamento de páginas em vários cenários. Calculamos quanto mais compradores, transações, chamadas, transições etc. estão acontecendo. De acordo com esses dados, pode-se entender que, em algum momento, a aceleração deixa de fazer sentido. Por exemplo, se o tempo de resposta de uma das páginas de 90 ms for acelerado para 70 ms, isso dará + 2% dos compradores. E se você acelerar de 70 ms para 60 ms, já haverá mais 0,1% de compradores, o que geralmente está incluído no erro. Assim como os caras, tudo depende muito da página com a qual estamos trabalhando. Em geral, Avito percentil 75 - cerca de 75 ms. Na minha opinião, isso é lento. Agora estamos procurando lugares para otimizar. Antes da transição para os microsserviços, tudo acontecia muito mais rápido para nós, e estamos tentando otimizar o desempenho.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5j/tw/ig/5jtwigxel1bcp3pbmmvhdxdslhu.jpeg"><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E a eterna pergunta: ferro ou otimização? </font><font style="vertical-align: inherit;">Como entender se vale a pena comprar hardware ou é melhor investir em otimização? </font><font style="vertical-align: inherit;">Onde fica a fronteira?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Minha opinião: um verdadeiro programador é otimização. </font><font style="vertical-align: inherit;">Parece-me que em grandes empresas como o Badoo, a minha, a Yandex, existem muitos desenvolvedores de diferentes níveis. </font><font style="vertical-align: inherit;">Existem desenvolvedores juniores / estagiários e desenvolvedores líderes. </font><font style="vertical-align: inherit;">Parece-me que o número de locais para otimização / revisão é sempre adicionado lá. </font><font style="vertical-align: inherit;">O ferro é o último passo. </font><font style="vertical-align: inherit;">Para um monólito em 65 LXC, não adicionamos ferro por muito tempo. </font><font style="vertical-align: inherit;">Utilização da CPU - 20%. </font><font style="vertical-align: inherit;">Já estamos pensando em transferi-los para o cluster Kubernetes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu realmente gosto da posição de Semyon. Mas tenho um ponto de vista completamente oposto. Primeiro de tudo, eu olhava para o ferro. É possível deixar cair o ferro e será mais barato? Nesse caso, é mais fácil resolver o problema com ferro. O desenvolvedor pode fazer outra coisa útil neste momento. O tempo do desenvolvedor custa dinheiro. Ferro também custa dinheiro, então você precisa comparar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qual destes é mais importante não está claro. Se os dois custam o mesmo, o hardware vence, porque o desenvolvedor poderá fazer algo no momento. Especificamente, em termos de back-end do PHP, não podemos fazer isso. A otimização nos custa muito mais barato do que comprar ferro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prestes a parar. </font><font style="vertical-align: inherit;">Em termos de planejamento, temos algum tipo de bar. </font><font style="vertical-align: inherit;">Se reduzirmos o consumo da CPU abaixo dela, paramos. </font><font style="vertical-align: inherit;">Por outro lado, há também a qualidade do serviço. </font><font style="vertical-align: inherit;">Se percebermos que o tempo de resposta não nos convém em algum lugar, precisamos otimizar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece-me que tudo depende do tamanho da equipe e do projeto. </font><font style="vertical-align: inherit;">Quanto menor o projeto, mais fácil é comprar o hardware, porque o salário do desenvolvedor é constante e o código que funciona, os usuários que trabalham com ele, são muito diferentes. </font><font style="vertical-align: inherit;">Se houver poucos usuários, será mais fácil comprar hardware e confiar ao desenvolvedor trabalho para desenvolver o projeto. </font><font style="vertical-align: inherit;">Se houver muitos usuários, um desenvolvedor poderá compensar a maior parte do custo dos servidores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo realmente depende da escala. </font><font style="vertical-align: inherit;">Se você possui mil servidores e a otimização leva ao fato de não precisar de outros mil servidores, é claramente melhor otimizar. </font><font style="vertical-align: inherit;">Se você tiver um servidor, poderá comprar com segurança mais dois ou três servidores e pontuar na otimização. </font><font style="vertical-align: inherit;">Se o comando for pequeno, inicie os servidores adquiridos. </font><font style="vertical-align: inherit;">Se a equipe for grande e você tiver dois ou três datacenters, a compra de seis datacenters já não é tão barata, nem tão rápida.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como temos um mitap do PHP, esta frase deve soar: por que precisamos do PHP, pois temos esses problemas o tempo todo? </font><font style="vertical-align: inherit;">Vamos reescrever Go, C, C #, Rust, Node.js! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Você acha que a abordagem de reescrita é geralmente justificada? </font><font style="vertical-align: inherit;">Existem problemas cuja solução vale a pena fazer e investir neste momento?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o PHP é uma linguagem muito boa. Realmente permite que você resolva problemas de negócios. Ele é rápido o suficiente. Todos os problemas de desempenho são problemas de erros, bugs, código legado (algum tipo de código insuficiente, coisas abaixo do ideal que seriam disparadas em outro idioma da mesma maneira). Ao transportá-los brutos para Golang, Java, Python, você obtém o mesmo desempenho. O problema é que há muito legado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A introdução de um novo idioma, na minha opinião, faz sentido para expandir a pilha e as oportunidades de emprego. Agora é difícil o suficiente encontrar bons desenvolvedores de PHP. Se introduzirmos Golang no techradar, podemos contratar esquilos. Existem poucos shniks PHP e poucos esquilos no mercado, e juntos já existem muitos deles. Por exemplo, tivemos um experimento. Adotamos desenvolvedores de C # que estão prontos para aprender novos idiomas - simplesmente expandimos a pilha de contratação. Se dissermos às pessoas que vamos ensiná-las a escrever em PHP, elas dizem que é melhor não. E se lhes oferecermos que aprendam a escrever em PHP, Go e ainda prometam a oportunidade de escrever em Python, as pessoas estarão mais dispostas a responder. Para mim, esta é uma extensão das oportunidades de emprego. Em outras linguagens, existem algumas coisas que realmente faltam no PHP. Mas, em geral, o PHP é super suficiente para resolver problemas de negócios e implementar grandes projetos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu provavelmente concordo completamente com Semyon. </font><font style="vertical-align: inherit;">Reescrever simplesmente não faz sentido. </font><font style="vertical-align: inherit;">PHP é uma linguagem bastante produtiva. </font><font style="vertical-align: inherit;">Se você compará-lo com outras linguagens não-compiladas com script, provavelmente será quase o mais rápido. </font><font style="vertical-align: inherit;">Reescrever em alguns idiomas como Go e outros? </font><font style="vertical-align: inherit;">Estes são outros idiomas, eles têm outros problemas. </font><font style="vertical-align: inherit;">Ainda é mais difícil escrever sobre eles: não tão rápido e há muitas nuances.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, existem coisas difíceis ou inconvenientes de se escrever em PHP. </font><font style="vertical-align: inherit;">Algumas coisas com vários processos e com vários threads são melhores para escrever em outro idioma. </font><font style="vertical-align: inherit;">Um exemplo de tarefa em que o não uso do PHP é justificado é, em princípio, qualquer armazenamento. </font><font style="vertical-align: inherit;">Se este é um serviço que armazena muita memória, provavelmente o PHP não é a melhor linguagem, porque possui uma sobrecarga de memória muito grande devido à digitação dinâmica. </font><font style="vertical-align: inherit;">Acontece que você salva um int de 4 bytes e 50 bytes são consumidos. </font><font style="vertical-align: inherit;">Claro, eu exagerei, mas ainda assim essa sobrecarga é muito grande. </font><font style="vertical-align: inherit;">Se você tiver algum tipo de armazenamento, é melhor escrevê-lo em outro idioma compilado com digitação estática. </font><font style="vertical-align: inherit;">Assim como algumas coisas que exigem execução multiencadeada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que o PHP não é considerado muito rápido? Porque é dinâmico. Ir tradução é uma solução para o problema de traduzir código de digitação dinâmica para estática. Devido a isso, tudo está acontecendo mais rápido. Especificamente para o Go, no meu plano há tarefas de um fluxo de dados específico. Por exemplo, se houver algum tipo de fluxo de dados que precise ser convertido em formatos mais convenientes, isso é ideal. Gerado por um daemon, ele recebe um fluxo de dados na entrada e emite outro. Pouca memória come. O PHP consome muita memória neste caso: você precisa garantir cuidadosamente que ele esteja limpo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Transfer to Go é uma transferência para microsserviços, porque você não cortou todo o código. </font><font style="vertical-align: inherit;">Você não aceita e reescreve na íntegra. </font><font style="vertical-align: inherit;">A tradução para microsserviços é uma tarefa mais profunda que a tradução de um idioma para outro. </font><font style="vertical-align: inherit;">É necessário resolvê-lo primeiro e depois pensar em qual idioma escrever. </font><font style="vertical-align: inherit;">A parte mais difícil é aprender a microsserviços.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não é necessário usar o Go em microsserviços. Muitos serviços são escritos em PHP e têm um tempo de resposta aceitável. A equipe que os apoia decidiu por eles mesmos que eles precisavam escrever lógica de negócios muito rapidamente e introduzir recursos. Na verdade, às vezes eles são mais rápidos que os esquilos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos a tendência de contratar Gopher, traduzir para Go. Mas ainda temos a maior parte do código escrito em PHP, e assim será por pelo menos mais alguns anos. Não existe uma corrida real, não decidimos que o Go é melhor ou pior. Seis lançamentos são lançados no monólito diariamente. Nosso bate-papo "Avito Deploy" possui uma lista de tarefas implantadas. Pelo menos 20 tarefas são lançadas por dia em cada release: pelo menos cinco ou seis releases por dia, aproximadamente 80 tarefas que as pessoas executaram nessas tarefas. Tudo isso é feito em PHP.</font></font><br>
<br>
<blockquote>      ?       -,    ?</blockquote><br>
<h3> , </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
É muito difícil. Há um momento psicológico: lancei um novo recurso - você está pronto. Lançou um novo recurso gigantesco - você é super jovem! Quando um gerente ou desenvolvedor diz que removeu um recurso (desativado), ele não recebe esse reconhecimento. Seu trabalho não é visível. Por exemplo, uma equipe pode receber um bônus pela implementação bem-sucedida de novos recursos, mas eu não vi nenhum prêmio pela funcionalidade morta ou experimental. E o resultado disso pode ser realmente colossal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um monte de recursos herdados que ninguém já está usando realmente diminui o desenvolvimento. Existem centenas de casos em que uma nova pessoa entra em uma empresa e refatora um código morto que nunca é chamado porque ele não sabe que é um código morto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos tentando, de alguma forma, negociar com os gerentes, descobrir pela golog que tipo de recurso era, com os analistas consideramos quanto dinheiro ele traz, quem precisa dele e somente depois disso tentamos cortá-lo. </font><font style="vertical-align: inherit;">Este é um processo complicado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cortamos o código morto quando chegamos a ele. </font><font style="vertical-align: inherit;">E está longe de ser sempre possível cortá-lo rapidamente. </font><font style="vertical-align: inherit;">Primeiro, você escreve um código, depois outro, em cima de um terceiro e, por baixo, tudo indica que esse recurso não é necessário. </font><font style="vertical-align: inherit;">Ela puxa um grande número de dependências, que também precisam ser corrigidas. </font><font style="vertical-align: inherit;">Isso nem sempre é possível, e os gerentes precisam denunciá-lo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O gerente define a tarefa, você a avalia. </font><font style="vertical-align: inherit;">Você diz: "Sabe, cara, vou fazer isso por seis meses. </font><font style="vertical-align: inherit;">Você está pronto para tolerar meio ano? </font><font style="vertical-align: inherit;">Ele diz: "Não, vamos pensar o que precisa ser cortado, o que pode ser deixado. </font><font style="vertical-align: inherit;">O que é fundamentalmente necessário e o que é necessário para brincar. ” </font><font style="vertical-align: inherit;">É assim que é.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando um desenvolvedor recebe um recurso, ele avalia como é difícil em termos de desenvolvimento, como é difícil em termos de desempenho. Se ele vê que um ou outro, ele esclarece com o gerente de produto se isso é realmente necessário, se podemos remover algo em algum lugar. Às vezes acontece que as mudanças não são críticas, e os gerentes fazem concessões rapidamente quando descobrem que isso é complicado ou está consumindo recursos. Apenas acontece: você diz "Vamos removê-lo" - e é isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acontece que um recurso sai e, depois disso, percebemos que ele não funcionará tão bem quanto gostaríamos. E então, novamente, você pode conversar com o gerente. Muitas vezes, tudo termina com sucesso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não há processo interno para remover recursos. Isso é feito esporadicamente. Vemos que há algum recurso, que surgimos e nos oferecemos para desativá-lo. Nós desligamos, observamos o que dá e cortamos. Outra coisa é código morto. Temos uma extensão especial, mesmo uma infraestrutura inteira, para detecção de código morto. Vemos esse código morto. Estamos tentando cortá-lo lentamente. Outra pergunta é se ele está realmente morto e a solicitação nunca entra, então não afeta o desempenho de nenhuma maneira. Isso afeta a capacidade de suporte. As pessoas leem constantemente, embora possam não lê-lo. Não há uma conexão específica com o desempenho.</font></font><br>
<br>
<blockquote><i>15      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Badoo PHP Meetup</a>. ,      : SuperJob, ManyChat, , Badoo  FunCorp    . <br>
<br>
,   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">YouTube-</a>. ,       - .<br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>,     .</i><br>
</blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt487224/index.html">Quanto tempo pode uma construção de longo prazo, destinada a se tornar uma obra-prima</a></li>
<li><a href="../pt487226/index.html">Crie seu crachá: O complemento de merda não se importa com OFFZONE</a></li>
<li><a href="../pt487228/index.html">Frontend mitap Facebook e AvitoTech</a></li>
<li><a href="../pt487230/index.html">Notas de vida nos EUA</a></li>
<li><a href="../pt487232/index.html">Impressão imune na infância: a origem da proteção contra vírus</a></li>
<li><a href="../pt487238/index.html">Como projetar equipamentos de proteção da rede elétrica</a></li>
<li><a href="../pt487242/index.html">Fevereiro IT Events Digest</a></li>
<li><a href="../pt487246/index.html">A Autoridade de Certificação Tensor pode comprometer as chaves privadas do cliente</a></li>
<li><a href="../pt487248/index.html">Um pouco mais sobre testes impróprios</a></li>
<li><a href="../pt487250/index.html">Mistura alfa atrasada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>