<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôÄÔ∏è üë©üèæ‚Äçüè≠ üé£ Ferro ou otimiza√ß√£o? Badoo, Avito e Mamba - sobre desempenho em PHP üëµüèΩ ‚è´ üéÖüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O problema de desempenho do PHP no Badoo √© um dos mais importantes. A qualidade do back-end do PHP depende diretamente da quantidade de recursos que g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ferro ou otimiza√ß√£o? Badoo, Avito e Mamba - sobre desempenho em PHP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/487234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema de desempenho do PHP no Badoo √© um dos mais importantes. A qualidade do back-end do PHP depende diretamente da quantidade de recursos que gastamos no desenvolvimento e opera√ß√£o, na velocidade do servi√ßo e na impress√£o que ele causa nos usu√°rios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o t√≥pico da terceira reuni√£o da comunidade de desenvolvedores de PHP em nosso escrit√≥rio, fizemos o desempenho de back-end e convidamos colegas de Avito e Mamba para discutir. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t-/p7/se/t-p7sef1pbww8vboigkup6ditzu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leia a transcri√ß√£o da cena da discuss√£o, na qual tive a sorte de ser um moderador: como a infraestrutura das tr√™s empresas √© organizada, como medimos a produtividade e em que m√©tricas nos concentramos, quais ferramentas usamos, como fazemos uma escolha entre hardware e otimiza√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E em 15 de fevereiro, participe do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√≥ximo Meetup do Badoo PHP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : discuta o Legacy.</font></font><br>
<a name="habracut"></a><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/kWBm0C9A8oo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deciframos apenas a parte da discuss√£o que nos pareceu mais interessante. </font><font style="vertical-align: inherit;">A vers√£o completa est√° dispon√≠vel em v√≠deo. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Especialistas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Chefe da Unidade de Desenvolvimento da Core Services Avito</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pmurzakov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, PHP Timlid no Badoo </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mipxtx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Diretor de TI da Mamba</font></font></li>
</ul><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conte uma hist√≥ria sobre otimiza√ß√£o a partir de sua pr√°tica: grande sucesso ou grande fracasso √© algo interessante de se compartilhar. </font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tenho uma par√°bola </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma vez a cada seis meses, analisamos as m√©tricas e procuramos o que diminui, n√£o funciona bem, o que precisa ser otimizado. </font><font style="vertical-align: inherit;">Uma vez notamos nosso cont√™iner de depend√™ncia do symfony, que cresceu para 52.000 linhas. </font><font style="vertical-align: inherit;">Decidimos que ele, o canalha, era o culpado por tudo: 20 ms de sobrecarga para cada solicita√ß√£o. </font><font style="vertical-align: inherit;">N√≥s serramos. </font><font style="vertical-align: inherit;">N√≥s reduzimos isso. </font><font style="vertical-align: inherit;">De alguma forma, tentamos separ√°-lo, mas nada ajudou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o descobrimos que temos anti-spam que precisa acessar 20 bancos de dados para atender a todas as solicita√ß√µes necess√°rias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As solu√ß√µes que v√™m em primeiro lugar nem sempre s√£o as corretas. </font><font style="vertical-align: inherit;">Observe melhor os rastreamentos, logs e refer√™ncias de suas solicita√ß√µes e n√£o quebre diretamente. </font><font style="vertical-align: inherit;">Aqui est√° uma hist√≥ria.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como temos um ecossistema bastante grande em PHP, fazemos otimiza√ß√µes periodicamente. </font><font style="vertical-align: inherit;">Estamos crescendo, estamos atingindo algum n√≠vel na CPU, entendemos que precisamos comprar hardware ou otimizar. </font><font style="vertical-align: inherit;">Pese os argumentos a favor e contra cada op√ß√£o e decida. </font><font style="vertical-align: inherit;">Na maioria das vezes - a favor da otimiza√ß√£o, porque o ferro precisa muito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um desses pontos, identificamos um grupo inteiro que estava envolvido na busca de v√°rias coisas n√£o ideais nos scripts PHP e na otimiza√ß√£o. </font><font style="vertical-align: inherit;">Isso aconteceu literalmente ‚Äúgota a gota‚Äù: aqui eles encontraram uma porcentagem, l√° encontraram uma porcentagem - v√°rias pessoas encontraram uma porcentagem dentro de um m√™s. </font><font style="vertical-align: inherit;">Em algum momento, nosso sishnik estava pr√≥ximo</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einstein_man</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ele decidiu ver o que poderia fazer: saiu √† noite, lan√ßou o Perf, encontrou alguns problemas nas extens√µes PHP - e acelerou tudo em algumas noites em 13%!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tenho duas hist√≥rias. Um sobre o arquivo, o outro sobre o super desenvolvedor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre a falha. Temos muitos microsservi√ßos, incluindo PHP. Todo mundo trabalha na Kubernetes. Eu trabalhei em um desses microsservi√ßos. Houve uma utiliza√ß√£o significativa da CPU: eles passaram uma semana otimizando e encontrando problemas. Aconteceu que um dos desenvolvedores adicionou o Xdebug √†s imagens base para calcular os testes de cobertura de c√≥digo em seu (outro) servi√ßo, ap√≥s o qual todos os microsservi√ßos em produ√ß√£o trabalhados com o Xdebug foram ativados por um quarto inteiro! Depois de um quarto, descobrimos isso, corrigimos imagens b√°sicas - e come√ßamos a receber presentes inesperados: relan√ßei meu servi√ßo e ele come√ßou a funcionar mais r√°pido. Em cada implanta√ß√£o, nossa imagem de servi√ßo √© reconstru√≠da e agora sem o Xdebug.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hist√≥ria de sucesso. Temos muitos microsservi√ßos, e eles se tornaram cada vez mais. Nessa situa√ß√£o, o n√∫mero de chamadas RPC se torna um problema. Por exemplo, em um cart√£o de an√∫ncio - e esta √© uma das p√°ginas mais frequentes no Avito - cerca de 30 microsservi√ßos est√£o envolvidos na renderiza√ß√£o de uma p√°gina. Al√©m disso, tudo isso n√£o foi feito de maneira muito expl√≠cita: parece que voc√™ est√° chamando algum tipo de abstra√ß√£o e, sob ela, cinco chamadas RPC para outros servi√ßos s√£o executadas seq√ºencialmente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao longo dos anos, o cart√£o do an√∫ncio foi bastante degradado. </font><font style="vertical-align: inherit;">Um desenvolvedor forte lutou por um quarto, otimizou e trouxe todas as chamadas de RPC. </font><font style="vertical-align: inherit;">Quando ele conseguiu fazer isso, ele os paralelizou por meio da solicita√ß√£o m√∫ltipla do Guzzle - e, em vez de 30 solicita√ß√µes s√≠ncronas consecutivas, ele recebeu as mesmas 30 solicita√ß√µes, mas paralelas, o que acelerou bastante o trabalho. </font><font style="vertical-align: inherit;">Ap√≥s essa refatora√ß√£o, o tempo de resposta do cart√£o √© igual ao tempo m√°ximo de resposta de qualquer um dos servi√ßos. </font><font style="vertical-align: inherit;">Mas ele precisava de um quarto inteiro para otimizar / reescrever o c√≥digo de exibi√ß√£o do cart√£o de an√∫ncio.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diga-nos, qual √© o tamanho do seu cluster PHP, como ele est√° configurado - pelo menos PHP-FPM, ou talvez em algum lugar que o Apache tenha problemas?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos cerca de 15.000 RPS. </font><font style="vertical-align: inherit;">Um cluster de 80 servidores FPM adquiridos h√° v√°rios anos. </font><font style="vertical-align: inherit;">Em cada cluster, o FPM (m√°ximo de 50 filhos) √© lan√ßado na est√°tica. </font><font style="vertical-align: inherit;">Carregou cerca de dez no pico no hor√°rio nobre. </font><font style="vertical-align: inherit;">O tempo m√©dio de resposta √© de 100 ms e tentamos mant√™-lo (quando excede 100 ms, iniciamos a busca por pe√ßas de freio). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s temos nosso pr√≥prio sistema de monitoramento de desempenho. </font><font style="vertical-align: inherit;">Distribu√≠mos muitos contadores no c√≥digo, cerca de 120 por solicita√ß√£o. </font><font style="vertical-align: inherit;">Monitoramos muitos eventos que ocorrem dentro do c√≥digo em PHP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© padr√£o conosco: nginx, PHP-FPM. Aproximadamente 600 servidores com FPM. Se quisermos falar sobre PHP, provavelmente existem mais 300 servidores para v√°rios prop√≥sitos, como script, back-office e outros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dos recursos de configura√ß√£o, existem dois. Em primeiro lugar, temos um proxy BMA - este √© um proxy para dispositivos m√≥veis. Ou seja, antes que uma solicita√ß√£o chegue ao nginx, ele chega a um proxy especial que mant√©m uma conex√£o persistente e envia solicita√ß√µes ao nginx. O segundo recurso - √†s vezes voc√™ precisa desativar o opcache da CLI (n√≥s o ativamos em m√°quinas de script). Uma vez que n√£o o desligamos, perdemos 30% da CPU nisso. Depois que perceberam o erro, ficaram surpresos com o quanto voc√™ pode economizar com uma configura√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos patches PHP, mas eles quase n√£o est√£o relacionados ao desempenho.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° um ponto no bloqueio competitivo do APCu - quando voc√™ precisa escrever muito na mesma chave. </font><font style="vertical-align: inherit;">A arquitetura interna do APCu √© constru√≠da de tal maneira que existe um bloqueio de chave global e, durante a grava√ß√£o intensiva, os freios s√£o iniciados. </font><font style="vertical-align: inherit;">Portanto, temos uma extens√£o personalizada l√° que resolve esse problema. </font><font style="vertical-align: inherit;">Isso se refere apenas parcialmente ao desempenho, pois afeta o tempo de resposta, mas n√£o o consumo da CPU.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos cerca de 2 milh√µes de solicita√ß√µes por minuto (~ 33 kRPS). </font><font style="vertical-align: inherit;">Um aplicativo monol√≠tico escrito em PHP √© escrito h√° mais de 11 anos. </font><font style="vertical-align: inherit;">Est√° em uma fase de r√°pido crescimento. </font><font style="vertical-align: inherit;">Quando a empresa come√ßou, havia 65 LXCs em 65 servidores f√≠sicos. </font><font style="vertical-align: inherit;">Em cada cont√™iner com o aplicativo, o PHP-FPM, nginx e o software auxiliar para m√©tricas e log est√£o em execu√ß√£o. </font><font style="vertical-align: inherit;">Nada especial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao longo dos anos, nunca adicionamos ferro para um mon√≥lito. </font><font style="vertical-align: inherit;">Estamos aumentando a participa√ß√£o, o n√∫mero de an√∫ncios, o n√∫mero de transa√ß√µes de usu√°rios e estamos constantemente otimizando, melhorando o c√≥digo, otimizando o software. </font><font style="vertical-align: inherit;">O consumo de CPU e mem√≥ria vem caindo nos √∫ltimos anos: 65 cont√™ineres para um mon√≥lito agora s√£o suficientes para n√≥s.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como voc√™ mede o desempenho? </font><font style="vertical-align: inherit;">Qual ferramenta voc√™ mede o tempo de resposta do cliente?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos um sistema de coleta de logs. </font><font style="vertical-align: inherit;">Ele registra dois indicadores - o tempo desde o in√≠cio do FPM at√© a fun√ß√£o de desligamento e at√© o final do script. </font><font style="vertical-align: inherit;">A segunda m√©trica √© necess√°ria para ver o que acontece ap√≥s a fun√ß√£o de desligamento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s medimos JS. </font><font style="vertical-align: inherit;">Na verdade, essa √© uma m√©trica mais ou menos: os canais de rede s√£o frequentemente violados. </font><font style="vertical-align: inherit;">Como resultado, carregar em algum lugar no interior da R√∫ssia come√ßa a ficar embotado. </font><font style="vertical-align: inherit;">Portanto, ficamos assim: "Oh, pulou - isso significa que em algum lugar algo caiu". </font><font style="vertical-align: inherit;">Al√©m disso, a publicidade de terceiros distorce muito a m√©trica. </font><font style="vertical-align: inherit;">E, mais importante, os spammers v√™m, e isso geralmente √© algum tipo de aleatoriedade.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, costum√°vamos usar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinba</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do Badoo </font><font style="vertical-align: inherit;">muito ativamente </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eu gosto dela agora. </font><font style="vertical-align: inherit;">A maioria das m√©tricas foram coletadas por ele, mas depois mudadas para o protocolo StatsD. </font><font style="vertical-align: inherit;">Agora estamos fazendo medi√ß√µes de diferentes pontos: de frente, dos servidores em frente ao aplicativo, do nginx e do pr√≥prio aplicativo PHP. </font><font style="vertical-align: inherit;">Temos uma equipe de desempenho dedicada. </font><font style="vertical-align: inherit;">Ela come√ßou com o desempenho da frente, mas depois mudou para o apoio. </font><font style="vertical-align: inherit;">De frente, ele coleta n√£o apenas JS, CSS e outras est√°ticas, mas tamb√©m o tempo de resposta do servidor. </font><font style="vertical-align: inherit;">Antes de tudo, nos concentramos no tempo de resposta do aplicativo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© semelhante ao que os caras nos disseram. </font><font style="vertical-align: inherit;">Usando o Pinba cl√°ssico para PHP, medimos o tempo de execu√ß√£o de um script PHP em termos de PHP. </font><font style="vertical-align: inherit;">Mas tamb√©m temos, por exemplo, Pinba para o nginx, que mede o tempo de resposta do ponto de vista do nginx. </font><font style="vertical-align: inherit;">Tamb√©m coletamos m√©tricas no cliente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que estamos olhando? </font><font style="vertical-align: inherit;">Por um lado, o tempo de resposta. </font><font style="vertical-align: inherit;">N√£o est√° relacionado ao planejamento de recursos. </font><font style="vertical-align: inherit;">Se √© ruim, precisa ser aprimorado, porque √©, de fato, a qualidade do servi√ßo. </font><font style="vertical-align: inherit;">Outra coisa √© que voc√™ precisa planejar o ferro de alguma forma. </font><font style="vertical-align: inherit;">Nossas ITOps e equipes de monitoramento monitoram todo o hardware. </font><font style="vertical-align: inherit;">Existem algumas barras na rede, no disco. </font><font style="vertical-align: inherit;">Existem alguns valores ap√≥s os quais o alerta ocorre - e estamos fazendo algo. </font><font style="vertical-align: inherit;">Como a pr√°tica demonstrou, geralmente otimizamos a CPU: nos deparamos com ela.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em n√≥s, o aplicativo PHP mede a si pr√≥prio e em register_shutdown_function () lan√ßa m√©tricas. </font><font style="vertical-align: inherit;">Cada LXC possui um servidor StatsD, que coleta essas m√©tricas e as envia pelos coletores para o cluster Graphite (incluindo ClickHouse), onde os dados s√£o armazenados. </font><font style="vertical-align: inherit;">Este √© um autodiagn√≥stico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m em cada cont√™iner est√° o nginx, ou seja, nginx + PHP-FPM. </font><font style="vertical-align: inherit;">Com o nginx, coletamos m√©tricas externas relacionadas ao tempo de execu√ß√£o de um aplicativo PHP. </font><font style="vertical-align: inherit;">Eles tamb√©m est√£o enfrentando servidores separados (os chamamos de avi-http) nginx, que executa roteamento b√°sico, que tamb√©m coleta m√©tricas de n√≠vel superior, como tempo de resposta, n√∫mero de 500 c√≥digos de resposta e outros.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quais ferramentas voc√™ possui para uma faixa de desempenho? </font><font style="vertical-align: inherit;">O que voc√™ usa com mais frequ√™ncia?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s escrevemos nossa pr√≥pria ferramenta. Quando o Pinba acabou de ser lan√ßado - em 2012, h√° muito tempo -, era um m√≥dulo para o MySQL que recebia algo assim pelo UDP. Foi dif√≠cil tirar os gr√°ficos; n√£o foi muito otimizado para o desempenho. E n√£o criamos nada melhor do que escrever uma coisa chamada Better Than Pinba. √â apenas um servidor de contador que os aceita de um cliente PHP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espalhamos muitos cron√¥metros no c√≥digo: toda vez que queremos medir algo, definimos o in√≠cio e a parada do cron√¥metro no c√≥digo. O pr√≥prio m√≥dulo calcular√° o tempo de execu√ß√£o do contador, agregar√° os contadores acumulados em um pacote e os enviar√° para o daemon. A pr√≥pria interface extrair√° tudo o que voc√™ precisa e criar√° gr√°ficos conectados no contador desejado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos problemas de Pinba era a falta de sua pr√≥pria interface - era necess√°rio transferir dados para o RRD (ent√£o havia tanta escurid√£o). </font><font style="vertical-align: inherit;">Portanto, n√≥s escrevemos nossa pr√≥pria interface. </font><font style="vertical-align: inherit;">Toda vez que vemos o que pulou, podemos instalar o script. </font><font style="vertical-align: inherit;">No script, todos os contadores agregados s√£o enviados para n√≥s, que s√£o enviados para n√≥s. </font><font style="vertical-align: inherit;">Podemos ver onde o contador aumentou, o tempo de resposta no contador aumentou ou o n√∫mero de contadores aumentou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode ser visto quando o desempenho cai. </font><font style="vertical-align: inherit;">Estamos come√ßando a cavar dessa maneira. </font><font style="vertical-align: inherit;">Antes do PHP 7, usamos o XHProf, ent√£o ele parou de construir conosco. </font><font style="vertical-align: inherit;">Portanto, mudamos para o Xdebug. </font><font style="vertical-align: inherit;">Xdebug n√≥s cutucamos apenas quando o problema √© vis√≠vel.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â uma cren√ßa comum de que o XHProf n√£o ser√° constru√≠do no PHP 7. </font><font style="vertical-align: inherit;">Isso √© verdade, mas apenas em parte. </font><font style="vertical-align: inherit;">Se voc√™ usar o XHProf no assistente, ele realmente n√£o ser√°. </font><font style="vertical-align: inherit;">Mas se no GitHub voc√™ alternar para um ramo chamado Experimental (ou algo parecido), tudo funcionar√° bem para o PHP 7, pronto para produ√ß√£o. </font><font style="vertical-align: inherit;">Verificado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o, eu troquei. </font><font style="vertical-align: inherit;">N√£o funcionou para mim.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quero adicionar sobre Pinba. </font><font style="vertical-align: inherit;">Voc√™ se tornou profeta at√© certo ponto. </font><font style="vertical-align: inherit;">Tamb√©m, em algum momento, perdemos a produtividade. </font><font style="vertical-align: inherit;">Criamos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinba2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que √© muito r√°pido. </font><font style="vertical-align: inherit;">Pode ser usado como um substituto para o Pinba.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© modesto conosco. </font><font style="vertical-align: inherit;">Acabamos de levar a dire√ß√£o do desempenho para o trabalho: coletamos m√©tricas, como tempo de resposta. </font><font style="vertical-align: inherit;">N√≥s usamos StatsD. </font><font style="vertical-align: inherit;">Ainda n√£o usamos perfis regularmente, mas tenho certeza de que algumas equipes os usam em seus microsservi√ßos escritos em PHP. </font><font style="vertical-align: inherit;">Na minha opini√£o, at√© algu√©m retransmite a New Relic. </font><font style="vertical-align: inherit;">Mas, no contexto da principal aplica√ß√£o monol√≠tica, at√© agora estamos apenas abordando isso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A hist√≥ria do ferro √© monitorada em Grafana, Zabbix. </font><font style="vertical-align: inherit;">Quanto √† parte do PHP, temos Pinba, temos um monte de temporizadores; </font><font style="vertical-align: inherit;">Constru√≠mos gr√°ficos convenientes sobre eles. </font><font style="vertical-align: inherit;">Usamos o XHProf, na produ√ß√£o, dirigimos para uma parte das solicita√ß√µes. </font><font style="vertical-align: inherit;">Sempre temos novos perfis XHProf dispon√≠veis. </font><font style="vertical-align: inherit;">Temos liveprof: esta √© a nossa ferramenta, voc√™ pode ler sobre isso, inclusive </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no meu artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tudo acontece automaticamente, voc√™ s√≥ precisa assistir. </font><font style="vertical-align: inherit;">N√≥s usamos o phpspy. </font><font style="vertical-align: inherit;">Nem sempre come√ßa conosco: quando algu√©m quer ver alguma coisa, entra no carro, tira o perfil. </font><font style="vertical-align: inherit;">Em princ√≠pio, como √© o caso do Perf.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
XHProf tem a mesma hist√≥ria. </font><font style="vertical-align: inherit;">N√≥s o usamos uma vez h√° muito tempo: era uma iniciativa pessoal de alguns desenvolvedores e, de fato, n√£o decolou. </font><font style="vertical-align: inherit;">Ele parou de colecionar. </font><font style="vertical-align: inherit;">Coletamos v√°rias m√©tricas de chamadas de roteadores, controladores e v√°rios modelos. </font><font style="vertical-align: inherit;">Cerca de 60 a 70% da rede interna do datacenter √© ocupada por pacotes UDP com m√©tricas. </font><font style="vertical-align: inherit;">No momento, isso √© suficiente para n√≥s. </font><font style="vertical-align: inherit;">Agora vamos procurar novos locais para otimiza√ß√£o.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desde que chegamos ao ponto do ferro: algu√©m est√° envolvido sistematicamente no planejamento da capacidade da sua empresa? </font><font style="vertical-align: inherit;">Como esse processo √© constru√≠do?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um aplicativo monol√≠tico executa pelo menos 65 LXC por pelo menos cinco anos. </font><font style="vertical-align: inherit;">Otimizamos o c√≥digo, melhoramos: ele possui recursos suficientes. </font><font style="vertical-align: inherit;">Nosso planejamento de capacidade principal vai para o Kubernetes, onde cerca de 400 microsservi√ßos vivos s√£o escritos em PHP / Go. </font><font style="vertical-align: inherit;">Estamos lentamente cortando peda√ßos do mon√≥lito, mas ele ainda est√° crescendo. </font><font style="vertical-align: inherit;">N√£o podemos det√™-lo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o PHP √© uma linguagem interessante. </font><font style="vertical-align: inherit;">Ele implementa rapidamente a l√≥gica de neg√≥cios.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, as ITOps e as equipes de monitoramento garantem a disponibilidade de recursos suficientes. </font><font style="vertical-align: inherit;">Se come√ßarmos a nos aproximar do valor limite, os colegas perceber√£o isso. </font><font style="vertical-align: inherit;">Eles provavelmente s√£o os principais respons√°veis ‚Äã‚Äãpelo planejamento da capacidade global. </font><font style="vertical-align: inherit;">A parte do PHP tem o principal recurso da CPU, por isso n√≥s o seguimos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s estabelecemos o padr√£o: n√£o devemos "comer" mais de 60% do cluster. </font><font style="vertical-align: inherit;">60%, e n√£o 95%, porque temos hypertreading, que extrai mais do processador do que voc√™ pode extrair sem ele. </font><font style="vertical-align: inherit;">Por isso, pagamos pelo fato de que, ap√≥s 50% de nosso consumo de CPU, podemos crescer de uma maneira imprevis√≠vel, porque os kernels com hiper-leitura n√£o s√£o totalmente honestos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fazemos uma implanta√ß√£o e vemos que algo falhou conosco - esse planejamento de capacidade. </font><font style="vertical-align: inherit;">A olho! </font><font style="vertical-align: inherit;">Temos uma certa margem de produtividade que nos permite fazer isso. </font><font style="vertical-align: inherit;">Tentamos cumpri-lo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, postamos otimiza√ß√£o factum. </font><font style="vertical-align: inherit;">Quando vemos que algo caiu, revertemos se tudo estiver completamente ruim. </font><font style="vertical-align: inherit;">Mas isso praticamente n√£o acontece. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou apenas vemos que "aqui n√£o √© o ideal, agora vamos corrigir rapidamente tudo e tudo funcionar√° como deveria". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o nos preocupamos particularmente: √© muito dif√≠cil e o escapamento n√£o ser√° muito grande.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ est√° falando sobre microsservi√ßos. </font><font style="vertical-align: inherit;">Como eles interagem? </font><font style="vertical-align: inherit;">√â REST ou voc√™ est√° usando protocolos bin√°rios?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kafka √© usado para enviar eventos entre servi√ßos, JSON-RPC √© usado para garantir a intera√ß√£o entre servi√ßos, mas n√£o completa, mas sua vers√£o simplificada, da qual n√£o podemos nos livrar. </font><font style="vertical-align: inherit;">Existem implementa√ß√µes mais r√°pidas: o mesmo protobuf, gRPC. </font><font style="vertical-align: inherit;">Isso est√° nos nossos planos, mas certamente n√£o √© uma prioridade. </font><font style="vertical-align: inherit;">Com mais de 400 microsservi√ßos, √© dif√≠cil transportar todos eles para o novo protocolo. </font><font style="vertical-align: inherit;">Existem muitos outros lugares para otimizar. </font><font style="vertical-align: inherit;">Definitivamente, n√£o estamos preparados para isso agora.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s, como tal, n√£o temos microsservi√ßos. </font><font style="vertical-align: inherit;">Existem servi√ßos, tamb√©m existe o Kafka, seu pr√≥prio protocolo em cima do protobuf do Google. </font><font style="vertical-align: inherit;">Provavelmente, usar√≠amos o gRPC, porque √© legal, tem suporte para todos os idiomas, a capacidade de vincular facilmente pe√ßas diferentes. </font><font style="vertical-align: inherit;">Mas quando precis√°vamos, o gRPC ainda n√£o estava l√°. </font><font style="vertical-align: inherit;">Mas havia um protobuf e n√≥s o pegamos. </font><font style="vertical-align: inherit;">Al√©m disso, coisas diferentes foram adicionadas para que n√£o fosse apenas serializa√ß√£o, mas um protocolo completo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m n√£o temos microsservi√ßos. </font><font style="vertical-align: inherit;">Existem servi√ßos escritos principalmente em C. Usamos JSON-RPC porque √© conveniente. </font><font style="vertical-align: inherit;">Voc√™ acabou de abrir o soquete ao depurar seu c√≥digo e rapidamente escreveu o que queria. </font><font style="vertical-align: inherit;">Algo voltou para voc√™. </font><font style="vertical-align: inherit;">Protobuf √© mais dif√≠cil porque voc√™ precisa usar algumas ferramentas adicionais. </font><font style="vertical-align: inherit;">H√° uma pequena sobrecarga, mas acreditamos que voc√™ precisa pagar por conveni√™ncia, e esse n√£o √© um pre√ßo alto.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ tem bancos de dados enormes. </font><font style="vertical-align: inherit;">Quando voc√™ precisa mudar o circuito em um deles, como voc√™ faz isso? </font><font style="vertical-align: inherit;">Algum tipo de migra√ß√£o? </font><font style="vertical-align: inherit;">Se essas migra√ß√µes demorarem v√°rios dias, como isso afeta o desempenho?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos mesas grandes, monol√≠ticas. </font><font style="vertical-align: inherit;">H√° um fragmento. </font><font style="vertical-align: inherit;">O fragmento altera-se rapidamente, porque existem muitos alteradores paralelos ao mesmo tempo. </font><font style="vertical-align: inherit;">Uma mesa grande com perfis alterou cerca de tr√™s horas. </font><font style="vertical-align: inherit;">Usamos ferramentas Perkonovskie que n√£o possuem leitura e grava√ß√£o. </font><font style="vertical-align: inherit;">Al√©m disso, implementamos a altera√ß√£o para que o c√≥digo suporte os dois estados. </font><font style="vertical-align: inherit;">Ap√≥s a altera√ß√£o, tamb√©m implantamos: a implanta√ß√£o √© mais r√°pida do que a aplica√ß√£o de qualquer esquema.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos o maior armazenamento (chamamos de "pontos") - este √© um enorme banco de dados fragmentado. </font><font style="vertical-align: inherit;">Se pegarmos a tabela "Usu√°rio", ela ter√° muitos fragmentos. </font><font style="vertical-align: inherit;">N√£o vou dizer exatamente quantas tabelas estar√£o em um servidor: a id√©ia √© que existem muitas pequenas. </font><font style="vertical-align: inherit;">Quando mudamos o circuito, de fato, fazemos apenas uma altera√ß√£o. </font><font style="vertical-align: inherit;">Em todas as mesas pequenas, isso acontece rapidamente. </font><font style="vertical-align: inherit;">Existem outros reposit√≥rios - j√° existem outras abordagens. </font><font style="vertical-align: inherit;">Se houver uma base enorme, existem ferramentas Perconian. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, usamos coisas diferentes de acordo com as necessidades. </font><font style="vertical-align: inherit;">A mudan√ßa mais frequente √© uma mudan√ßa nessa enorme base de pontos fragmentados, na qual j√° constru√≠mos um processo. </font><font style="vertical-align: inherit;">Tudo funciona de maneira muito simples.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mesmo aplicativo monol√≠tico que atende √† maior parte do tr√°fego √© implantado cinco a seis vezes por dia. </font><font style="vertical-align: inherit;">Quase a cada duas horas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em termos de trabalho com o banco de dados, esse √© um problema separado. </font><font style="vertical-align: inherit;">Existem migra√ß√µes, elas rolam automaticamente. </font><font style="vertical-align: inherit;">Esta √© uma revis√£o do DBA. </font><font style="vertical-align: inherit;">H√° uma op√ß√£o para pular a migra√ß√£o e rolar manualmente. </font><font style="vertical-align: inherit;">A migra√ß√£o passar√° automaticamente para a prepara√ß√£o ao testar o c√≥digo. </font><font style="vertical-align: inherit;">Mas na produ√ß√£o, se houver algum tipo de migra√ß√£o duvidosa que utilize muitos recursos, o DBA iniciar√° manualmente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo deve ser tal que funcione com as estruturas de banco de dados antigas e novas. </font><font style="vertical-align: inherit;">Muitas vezes fazemos v√°rias viagens para implantar recursos. </font><font style="vertical-align: inherit;">Para duas ou tr√™s implementa√ß√µes, √© poss√≠vel obter o estado desejado. </font><font style="vertical-align: inherit;">Da mesma forma, existem enormes bancos de dados, bancos de dados fragmentados. </font><font style="vertical-align: inherit;">Se contarmos para todos os microsservi√ßos, definitivamente existem 100 a 150 implanta√ß√µes por dia.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gostaria de saber qual √© o tempo de resposta padr√£o de back-end que voc√™ est√° seguindo? </font><font style="vertical-align: inherit;">Quando voc√™ entende o que precisa otimizar ainda mais ou qual √© a hora de terminar? </font><font style="vertical-align: inherit;">Existe um valor de "m√©dia hospitalar"?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o. </font><font style="vertical-align: inherit;">Depende do ponto final. </font><font style="vertical-align: inherit;">N√≥s olhamos para tudo separadamente. </font><font style="vertical-align: inherit;">Tentando entender como isso √© cr√≠tico. </font><font style="vertical-align: inherit;">Alguns pontos de extremidade geralmente s√£o solicitados em segundo plano. </font><font style="vertical-align: inherit;">Isso n√£o afeta o usu√°rio de forma alguma, mesmo que o tempo de resposta seja de 20 s. </font><font style="vertical-align: inherit;">Isso vai acontecer em segundo plano, n√£o h√° diferen√ßa. </font><font style="vertical-align: inherit;">O principal √© que algumas coisas importantes sejam feitas rapidamente. </font><font style="vertical-align: inherit;">Talvez 200 ms ainda estejam ok, mas um pequeno aumento j√° √© importante.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos mudando da renderiza√ß√£o HTML para solicita√ß√µes de API. </font><font style="vertical-align: inherit;">Aqui, de fato, a API responde muito mais r√°pido que a resposta HTML grande e pesada. </font><font style="vertical-align: inherit;">Portanto, √© dif√≠cil distinguir, por exemplo, um valor de 100 ms. </font><font style="vertical-align: inherit;">Focamos em 200 ms. </font><font style="vertical-align: inherit;">Ent√£o aconteceu o PHP 7 - e come√ßamos a focar em 100 ms. </font><font style="vertical-align: inherit;">Essa √© a "m√©dia do hospital". </font><font style="vertical-align: inherit;">Essa √© uma m√©trica muito vaga, o que sugere que √© hora de pelo menos olhar para l√°. </font><font style="vertical-align: inherit;">Por isso, focamos na implanta√ß√£o e aumentamos o tempo de resposta ap√≥s ela.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fizemos um esbo√ßo de uma das equipes de desempenho. Os colegas mediram quanto mais uma empresa ganha, acelerando o carregamento de p√°ginas em v√°rios cen√°rios. Calculamos quanto mais compradores, transa√ß√µes, chamadas, transi√ß√µes etc. est√£o acontecendo. De acordo com esses dados, pode-se entender que, em algum momento, a acelera√ß√£o deixa de fazer sentido. Por exemplo, se o tempo de resposta de uma das p√°ginas de 90 ms for acelerado para 70 ms, isso dar√° + 2% dos compradores. E se voc√™ acelerar de 70 ms para 60 ms, j√° haver√° mais 0,1% de compradores, o que geralmente est√° inclu√≠do no erro. Assim como os caras, tudo depende muito da p√°gina com a qual estamos trabalhando. Em geral, Avito percentil 75 - cerca de 75 ms. Na minha opini√£o, isso √© lento. Agora estamos procurando lugares para otimizar. Antes da transi√ß√£o para os microsservi√ßos, tudo acontecia muito mais r√°pido para n√≥s, e estamos tentando otimizar o desempenho.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5j/tw/ig/5jtwigxel1bcp3pbmmvhdxdslhu.jpeg"><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E a eterna pergunta: ferro ou otimiza√ß√£o? </font><font style="vertical-align: inherit;">Como entender se vale a pena comprar hardware ou √© melhor investir em otimiza√ß√£o? </font><font style="vertical-align: inherit;">Onde fica a fronteira?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Minha opini√£o: um verdadeiro programador √© otimiza√ß√£o. </font><font style="vertical-align: inherit;">Parece-me que em grandes empresas como o Badoo, a minha, a Yandex, existem muitos desenvolvedores de diferentes n√≠veis. </font><font style="vertical-align: inherit;">Existem desenvolvedores juniores / estagi√°rios e desenvolvedores l√≠deres. </font><font style="vertical-align: inherit;">Parece-me que o n√∫mero de locais para otimiza√ß√£o / revis√£o √© sempre adicionado l√°. </font><font style="vertical-align: inherit;">O ferro √© o √∫ltimo passo. </font><font style="vertical-align: inherit;">Para um mon√≥lito em 65 LXC, n√£o adicionamos ferro por muito tempo. </font><font style="vertical-align: inherit;">Utiliza√ß√£o da CPU - 20%. </font><font style="vertical-align: inherit;">J√° estamos pensando em transferi-los para o cluster Kubernetes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu realmente gosto da posi√ß√£o de Semyon. Mas tenho um ponto de vista completamente oposto. Primeiro de tudo, eu olhava para o ferro. √â poss√≠vel deixar cair o ferro e ser√° mais barato? Nesse caso, √© mais f√°cil resolver o problema com ferro. O desenvolvedor pode fazer outra coisa √∫til neste momento. O tempo do desenvolvedor custa dinheiro. Ferro tamb√©m custa dinheiro, ent√£o voc√™ precisa comparar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qual destes √© mais importante n√£o est√° claro. Se os dois custam o mesmo, o hardware vence, porque o desenvolvedor poder√° fazer algo no momento. Especificamente, em termos de back-end do PHP, n√£o podemos fazer isso. A otimiza√ß√£o nos custa muito mais barato do que comprar ferro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prestes a parar. </font><font style="vertical-align: inherit;">Em termos de planejamento, temos algum tipo de bar. </font><font style="vertical-align: inherit;">Se reduzirmos o consumo da CPU abaixo dela, paramos. </font><font style="vertical-align: inherit;">Por outro lado, h√° tamb√©m a qualidade do servi√ßo. </font><font style="vertical-align: inherit;">Se percebermos que o tempo de resposta n√£o nos conv√©m em algum lugar, precisamos otimizar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece-me que tudo depende do tamanho da equipe e do projeto. </font><font style="vertical-align: inherit;">Quanto menor o projeto, mais f√°cil √© comprar o hardware, porque o sal√°rio do desenvolvedor √© constante e o c√≥digo que funciona, os usu√°rios que trabalham com ele, s√£o muito diferentes. </font><font style="vertical-align: inherit;">Se houver poucos usu√°rios, ser√° mais f√°cil comprar hardware e confiar ao desenvolvedor trabalho para desenvolver o projeto. </font><font style="vertical-align: inherit;">Se houver muitos usu√°rios, um desenvolvedor poder√° compensar a maior parte do custo dos servidores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo realmente depende da escala. </font><font style="vertical-align: inherit;">Se voc√™ possui mil servidores e a otimiza√ß√£o leva ao fato de n√£o precisar de outros mil servidores, √© claramente melhor otimizar. </font><font style="vertical-align: inherit;">Se voc√™ tiver um servidor, poder√° comprar com seguran√ßa mais dois ou tr√™s servidores e pontuar na otimiza√ß√£o. </font><font style="vertical-align: inherit;">Se o comando for pequeno, inicie os servidores adquiridos. </font><font style="vertical-align: inherit;">Se a equipe for grande e voc√™ tiver dois ou tr√™s datacenters, a compra de seis datacenters j√° n√£o √© t√£o barata, nem t√£o r√°pida.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como temos um mitap do PHP, esta frase deve soar: por que precisamos do PHP, pois temos esses problemas o tempo todo? </font><font style="vertical-align: inherit;">Vamos reescrever Go, C, C #, Rust, Node.js! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ acha que a abordagem de reescrita √© geralmente justificada? </font><font style="vertical-align: inherit;">Existem problemas cuja solu√ß√£o vale a pena fazer e investir neste momento?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o PHP √© uma linguagem muito boa. Realmente permite que voc√™ resolva problemas de neg√≥cios. Ele √© r√°pido o suficiente. Todos os problemas de desempenho s√£o problemas de erros, bugs, c√≥digo legado (algum tipo de c√≥digo insuficiente, coisas abaixo do ideal que seriam disparadas em outro idioma da mesma maneira). Ao transport√°-los brutos para Golang, Java, Python, voc√™ obt√©m o mesmo desempenho. O problema √© que h√° muito legado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A introdu√ß√£o de um novo idioma, na minha opini√£o, faz sentido para expandir a pilha e as oportunidades de emprego. Agora √© dif√≠cil o suficiente encontrar bons desenvolvedores de PHP. Se introduzirmos Golang no techradar, podemos contratar esquilos. Existem poucos shniks PHP e poucos esquilos no mercado, e juntos j√° existem muitos deles. Por exemplo, tivemos um experimento. Adotamos desenvolvedores de C # que est√£o prontos para aprender novos idiomas - simplesmente expandimos a pilha de contrata√ß√£o. Se dissermos √†s pessoas que vamos ensin√°-las a escrever em PHP, elas dizem que √© melhor n√£o. E se lhes oferecermos que aprendam a escrever em PHP, Go e ainda prometam a oportunidade de escrever em Python, as pessoas estar√£o mais dispostas a responder. Para mim, esta √© uma extens√£o das oportunidades de emprego. Em outras linguagens, existem algumas coisas que realmente faltam no PHP. Mas, em geral, o PHP √© super suficiente para resolver problemas de neg√≥cios e implementar grandes projetos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu provavelmente concordo completamente com Semyon. </font><font style="vertical-align: inherit;">Reescrever simplesmente n√£o faz sentido. </font><font style="vertical-align: inherit;">PHP √© uma linguagem bastante produtiva. </font><font style="vertical-align: inherit;">Se voc√™ compar√°-lo com outras linguagens n√£o-compiladas com script, provavelmente ser√° quase o mais r√°pido. </font><font style="vertical-align: inherit;">Reescrever em alguns idiomas como Go e outros? </font><font style="vertical-align: inherit;">Estes s√£o outros idiomas, eles t√™m outros problemas. </font><font style="vertical-align: inherit;">Ainda √© mais dif√≠cil escrever sobre eles: n√£o t√£o r√°pido e h√° muitas nuances.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, existem coisas dif√≠ceis ou inconvenientes de se escrever em PHP. </font><font style="vertical-align: inherit;">Algumas coisas com v√°rios processos e com v√°rios threads s√£o melhores para escrever em outro idioma. </font><font style="vertical-align: inherit;">Um exemplo de tarefa em que o n√£o uso do PHP √© justificado √©, em princ√≠pio, qualquer armazenamento. </font><font style="vertical-align: inherit;">Se este √© um servi√ßo que armazena muita mem√≥ria, provavelmente o PHP n√£o √© a melhor linguagem, porque possui uma sobrecarga de mem√≥ria muito grande devido √† digita√ß√£o din√¢mica. </font><font style="vertical-align: inherit;">Acontece que voc√™ salva um int de 4 bytes e 50 bytes s√£o consumidos. </font><font style="vertical-align: inherit;">Claro, eu exagerei, mas ainda assim essa sobrecarga √© muito grande. </font><font style="vertical-align: inherit;">Se voc√™ tiver algum tipo de armazenamento, √© melhor escrev√™-lo em outro idioma compilado com digita√ß√£o est√°tica. </font><font style="vertical-align: inherit;">Assim como algumas coisas que exigem execu√ß√£o multiencadeada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que o PHP n√£o √© considerado muito r√°pido? Porque √© din√¢mico. Ir tradu√ß√£o √© uma solu√ß√£o para o problema de traduzir c√≥digo de digita√ß√£o din√¢mica para est√°tica. Devido a isso, tudo est√° acontecendo mais r√°pido. Especificamente para o Go, no meu plano h√° tarefas de um fluxo de dados espec√≠fico. Por exemplo, se houver algum tipo de fluxo de dados que precise ser convertido em formatos mais convenientes, isso √© ideal. Gerado por um daemon, ele recebe um fluxo de dados na entrada e emite outro. Pouca mem√≥ria come. O PHP consome muita mem√≥ria neste caso: voc√™ precisa garantir cuidadosamente que ele esteja limpo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Transfer to Go √© uma transfer√™ncia para microsservi√ßos, porque voc√™ n√£o cortou todo o c√≥digo. </font><font style="vertical-align: inherit;">Voc√™ n√£o aceita e reescreve na √≠ntegra. </font><font style="vertical-align: inherit;">A tradu√ß√£o para microsservi√ßos √© uma tarefa mais profunda que a tradu√ß√£o de um idioma para outro. </font><font style="vertical-align: inherit;">√â necess√°rio resolv√™-lo primeiro e depois pensar em qual idioma escrever. </font><font style="vertical-align: inherit;">A parte mais dif√≠cil √© aprender a microsservi√ßos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o √© necess√°rio usar o Go em microsservi√ßos. Muitos servi√ßos s√£o escritos em PHP e t√™m um tempo de resposta aceit√°vel. A equipe que os apoia decidiu por eles mesmos que eles precisavam escrever l√≥gica de neg√≥cios muito rapidamente e introduzir recursos. Na verdade, √†s vezes eles s√£o mais r√°pidos que os esquilos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos a tend√™ncia de contratar Gopher, traduzir para Go. Mas ainda temos a maior parte do c√≥digo escrito em PHP, e assim ser√° por pelo menos mais alguns anos. N√£o existe uma corrida real, n√£o decidimos que o Go √© melhor ou pior. Seis lan√ßamentos s√£o lan√ßados no mon√≥lito diariamente. Nosso bate-papo "Avito Deploy" possui uma lista de tarefas implantadas. Pelo menos 20 tarefas s√£o lan√ßadas por dia em cada release: pelo menos cinco ou seis releases por dia, aproximadamente 80 tarefas que as pessoas executaram nessas tarefas. Tudo isso √© feito em PHP.</font></font><br>
<br>
<blockquote>      ?       -,    ?</blockquote><br>
<h3> , </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â muito dif√≠cil. H√° um momento psicol√≥gico: lancei um novo recurso - voc√™ est√° pronto. Lan√ßou um novo recurso gigantesco - voc√™ √© super jovem! Quando um gerente ou desenvolvedor diz que removeu um recurso (desativado), ele n√£o recebe esse reconhecimento. Seu trabalho n√£o √© vis√≠vel. Por exemplo, uma equipe pode receber um b√¥nus pela implementa√ß√£o bem-sucedida de novos recursos, mas eu n√£o vi nenhum pr√™mio pela funcionalidade morta ou experimental. E o resultado disso pode ser realmente colossal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um monte de recursos herdados que ningu√©m j√° est√° usando realmente diminui o desenvolvimento. Existem centenas de casos em que uma nova pessoa entra em uma empresa e refatora um c√≥digo morto que nunca √© chamado porque ele n√£o sabe que √© um c√≥digo morto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos tentando, de alguma forma, negociar com os gerentes, descobrir pela golog que tipo de recurso era, com os analistas consideramos quanto dinheiro ele traz, quem precisa dele e somente depois disso tentamos cort√°-lo. </font><font style="vertical-align: inherit;">Este √© um processo complicado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Mamba Buylov </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cortamos o c√≥digo morto quando chegamos a ele. </font><font style="vertical-align: inherit;">E est√° longe de ser sempre poss√≠vel cort√°-lo rapidamente. </font><font style="vertical-align: inherit;">Primeiro, voc√™ escreve um c√≥digo, depois outro, em cima de um terceiro e, por baixo, tudo indica que esse recurso n√£o √© necess√°rio. </font><font style="vertical-align: inherit;">Ela puxa um grande n√∫mero de depend√™ncias, que tamb√©m precisam ser corrigidas. </font><font style="vertical-align: inherit;">Isso nem sempre √© poss√≠vel, e os gerentes precisam denunci√°-lo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O gerente define a tarefa, voc√™ a avalia. </font><font style="vertical-align: inherit;">Voc√™ diz: "Sabe, cara, vou fazer isso por seis meses. </font><font style="vertical-align: inherit;">Voc√™ est√° pronto para tolerar meio ano? </font><font style="vertical-align: inherit;">Ele diz: "N√£o, vamos pensar o que precisa ser cortado, o que pode ser deixado. </font><font style="vertical-align: inherit;">O que √© fundamentalmente necess√°rio e o que √© necess√°rio para brincar. ‚Äù </font><font style="vertical-align: inherit;">√â assim que √©.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando um desenvolvedor recebe um recurso, ele avalia como √© dif√≠cil em termos de desenvolvimento, como √© dif√≠cil em termos de desempenho. Se ele v√™ que um ou outro, ele esclarece com o gerente de produto se isso √© realmente necess√°rio, se podemos remover algo em algum lugar. √Äs vezes acontece que as mudan√ßas n√£o s√£o cr√≠ticas, e os gerentes fazem concess√µes rapidamente quando descobrem que isso √© complicado ou est√° consumindo recursos. Apenas acontece: voc√™ diz "Vamos remov√™-lo" - e √© isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acontece que um recurso sai e, depois disso, percebemos que ele n√£o funcionar√° t√£o bem quanto gostar√≠amos. E ent√£o, novamente, voc√™ pode conversar com o gerente. Muitas vezes, tudo termina com sucesso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o h√° processo interno para remover recursos. Isso √© feito esporadicamente. Vemos que h√° algum recurso, que surgimos e nos oferecemos para desativ√°-lo. N√≥s desligamos, observamos o que d√° e cortamos. Outra coisa √© c√≥digo morto. Temos uma extens√£o especial, mesmo uma infraestrutura inteira, para detec√ß√£o de c√≥digo morto. Vemos esse c√≥digo morto. Estamos tentando cort√°-lo lentamente. Outra pergunta √© se ele est√° realmente morto e a solicita√ß√£o nunca entra, ent√£o n√£o afeta o desempenho de nenhuma maneira. Isso afeta a capacidade de suporte. As pessoas leem constantemente, embora possam n√£o l√™-lo. N√£o h√° uma conex√£o espec√≠fica com o desempenho.</font></font><br>
<br>
<blockquote><i>15      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Badoo PHP Meetup</a>. ,      : SuperJob, ManyChat, , Badoo  FunCorp    . <br>
<br>
,   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">YouTube-</a>. ,       - .<br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>,     .</i><br>
</blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt487224/index.html">Quanto tempo pode uma constru√ß√£o de longo prazo, destinada a se tornar uma obra-prima</a></li>
<li><a href="../pt487226/index.html">Crie seu crach√°: O complemento de merda n√£o se importa com OFFZONE</a></li>
<li><a href="../pt487228/index.html">Frontend mitap Facebook e AvitoTech</a></li>
<li><a href="../pt487230/index.html">Notas de vida nos EUA</a></li>
<li><a href="../pt487232/index.html">Impress√£o imune na inf√¢ncia: a origem da prote√ß√£o contra v√≠rus</a></li>
<li><a href="../pt487238/index.html">Como projetar equipamentos de prote√ß√£o da rede el√©trica</a></li>
<li><a href="../pt487242/index.html">Fevereiro IT Events Digest</a></li>
<li><a href="../pt487246/index.html">A Autoridade de Certifica√ß√£o Tensor pode comprometer as chaves privadas do cliente</a></li>
<li><a href="../pt487248/index.html">Um pouco mais sobre testes impr√≥prios</a></li>
<li><a href="../pt487250/index.html">Mistura alfa atrasada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>