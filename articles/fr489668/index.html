<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè£ üõåüèΩ üôÑ Limites du processeur et limitation agressive dans Kubernetes üë©üèº‚Äçüíº ‚§¥Ô∏è üõ†Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque perev. : Ce r√©cit √©difiant d'Omio, l'agr√©gateur de voyages europ√©en, emm√®ne les lecteurs de la th√©orie de base aux subtilit√©s pratiques capti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Limites du processeur et limitation agressive dans Kubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/489668/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque perev.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Ce r√©cit √©difiant d'Omio, l'agr√©gateur de voyages europ√©en, emm√®ne les lecteurs de la th√©orie de base aux subtilit√©s pratiques captivantes de la configuration de Kubernetes. La connaissance de ces cas aide non seulement √† √©largir ses horizons, mais aussi √† √©viter des probl√®mes non triviaux.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/bw/jr/on/bwjronw-hyhosv46aa1d6pqldie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Avez-vous d√©j√† rencontr√© le fait que l'application "bloqu√©e" en place, a cess√© de r√©pondre aux demandes de v√©rification de l'√©tat et que vous ne compreniez pas la raison de ce comportement? Une explication possible est la limite de quota pour les ressources CPU. Il sera discut√© dans cet article.</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TL; DR: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous vous recommandons fortement de d√©sactiver les limites du processeur dans Kubernetes (ou de d√©sactiver les quotas CFS dans Kubelet) si vous utilisez une version du noyau Linux avec une erreur de quota CFS. Au c≈ìur, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un </font><font style="vertical-align: inherit;">bogue </font><font style="vertical-align: inherit;">grave et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bien connu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui entra√Æne une limitation excessive et des retards</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chez Omio, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toute l'infrastructure est g√©r√©e par Kubernetes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Toutes nos charges avec √©tat et sans √©tat fonctionnent exclusivement sur Kubernetes (nous utilisons le moteur Google Kubernetes). </font><font style="vertical-align: inherit;">Au cours des six derniers mois, nous avons commenc√© √† observer des ralentissements al√©atoires. </font><font style="vertical-align: inherit;">Les applications g√®lent ou cessent de r√©pondre aux v√©rifications de l'√©tat, perdent leur connexion au r√©seau, etc. </font><font style="vertical-align: inherit;">Un tel comportement nous a longtemps perplexes et, finalement, nous avons d√©cid√© de nous attaquer de pr√®s au probl√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©sum√© de l'article:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quelques mots sur les conteneurs et Kubernetes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comment les demandes et les limites du processeur sont mises en ≈ìuvre</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fonctionnement de la limite CPU dans les environnements multic≈ìurs;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comment suivre la limitation du processeur;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> R√©soudre le probl√®me et les nuances.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelques mots sur les conteneurs et Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes, en fait, est la norme moderne dans le monde des infrastructures. </font><font style="vertical-align: inherit;">Sa t√¢che principale est l'orchestration des conteneurs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conteneurs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auparavant, nous devions cr√©er des artefacts tels que des fichiers JAR / WAR Java, des ≈ìufs Python ou des ex√©cutables pour un lancement ult√©rieur sur des serveurs. </font><font style="vertical-align: inherit;">Cependant, pour les faire fonctionner, ils devaient faire un travail suppl√©mentaire: installer le runtime (Java / Python), placer les fichiers n√©cessaires aux bons endroits, assurer la compatibilit√© avec une version sp√©cifique du syst√®me d'exploitation, etc. </font><font style="vertical-align: inherit;">En d'autres termes, vous deviez porter une attention particuli√®re √† la gestion de la configuration (ce qui provoquait souvent des conflits entre les d√©veloppeurs et les administrateurs syst√®me). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les conteneurs ont tout chang√©.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, l'image du conteneur agit comme un artefact. </font><font style="vertical-align: inherit;">Il peut √™tre repr√©sent√© comme une sorte de fichier ex√©cutable √©tendu contenant non seulement un programme, mais aussi un runtime √† part enti√®re (Java / Python / ...), ainsi que les fichiers / packages n√©cessaires pr√©install√©s et pr√™ts √† fonctionner. </font><font style="vertical-align: inherit;">Les conteneurs peuvent √™tre d√©ploy√©s et ex√©cut√©s sur diff√©rents serveurs sans √©tapes suppl√©mentaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les conteneurs fonctionnent dans leur propre environnement sandbox. </font><font style="vertical-align: inherit;">Ils ont leur propre adaptateur r√©seau virtuel, leur propre syst√®me de fichiers avec un acc√®s limit√©, leur propre hi√©rarchie de processus, leurs limitations sur le CPU et la m√©moire, etc. Tout cela est r√©alis√© gr√¢ce √† un sous-syst√®me sp√©cial du noyau Linux - les espaces de noms (espace de noms).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme indiqu√© pr√©c√©demment, Kubernetes est un orchestre de conteneurs. </font><font style="vertical-align: inherit;">Cela fonctionne comme suit: vous lui fournissez un pool de machines, puis vous dites: "H√© Kubernetes, lancez dix instances de mon conteneur avec 2 processeurs et 3 Go de m√©moire chacun, et gardez-les op√©rationnels!" </font><font style="vertical-align: inherit;">Kubernetes s'occupe du reste. </font><font style="vertical-align: inherit;">Il trouvera des capacit√©s libres, lancera des conteneurs et les red√©marrera si n√©cessaire, d√©ploiera une mise √† jour lors du changement de version, etc. </font><font style="vertical-align: inherit;">En fait, Kubernetes vous permet d'abstraire du composant mat√©riel et rend toute la vari√©t√© des syst√®mes adapt√©e au d√©ploiement et au fonctionnement des applications. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hs/ux/tu/hsuxtucqvih716edmdtgac_btxa.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes du point de vue d'un simple profane</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelles sont la demande et la limite dans Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, nous avons trouv√© les conteneurs et Kubernetes. Nous savons √©galement que plusieurs conteneurs peuvent se trouver sur la m√™me machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez faire une analogie avec un appartement communal. Une chambre spacieuse est prise (voitures / n≈ìuds) et lou√©e √† plusieurs locataires (conteneurs). Kubernetes agit comme un agent immobilier. La question se pose, comment √©viter que les locataires n'entrent en conflit les uns avec les autres? Et si l'un d'entre eux, par exemple, d√©cide d'occuper la salle de bain pendant une demi-journ√©e? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est l√† que la demande et la limite entrent en jeu. La </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demande de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU </font><b><font style="vertical-align: inherit;">est</font></b><font style="vertical-align: inherit;"> uniquement √† des fins de planification. Cela ressemble √† la ¬´liste de souhaits¬ª d'un conteneur, et il est utilis√© pour s√©lectionner le n≈ìud le plus appropri√©. Dans le m√™me temps, CPU </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut √™tre compar√© √† un bail - d√®s que nous prenons un n≈ìud pour le conteneur,</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne pourra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas d√©passer les limites √©tablies. </font><font style="vertical-align: inherit;">Et ici un probl√®me se pose ...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment les demandes et les limites sont impl√©ment√©es dans Kubernetes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes utilise le m√©canisme de limitation du noyau (skipping clock) pour impl√©menter les limites du processeur. </font><font style="vertical-align: inherit;">Si l'application d√©passe la limite, la limitation est activ√©e (c'est-√†-dire qu'elle re√ßoit moins de cycles CPU). </font><font style="vertical-align: inherit;">Les demandes et les limites de m√©moire sont organis√©es diff√©remment, de sorte qu'elles sont plus faciles √† d√©tecter. </font><font style="vertical-align: inherit;">Pour ce faire, il suffit de v√©rifier l'√©tat du dernier red√©marrage du pod: s'il s'agit de ¬´OOMKilled¬ª. </font><font style="vertical-align: inherit;">Avec la limitation du processeur, tout n'est pas si simple, car K8s ne met √† disposition que des m√©triques √† utiliser, et pas pour les groupes de contr√¥le.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demande CPU</font></font></h4><br>
<img src="https://habrastorage.org/webt/hh/fk/qn/hhfkqnuy5oe4tq_ubi57aeblvqe.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment la demande de CPU est impl√©ment√©e</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pour plus de simplicit√©, regardons un processus utilisant un exemple de machine avec un CPU √† 4 c≈ìurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K8s utilise le m√©canisme cgroups pour contr√¥ler l'allocation des ressources (m√©moire et processeur). Un mod√®le hi√©rarchique lui est disponible: un descendant h√©rite des limites du groupe parent. Les d√©tails de la distribution sont stock√©s dans le syst√®me de fichiers virtuel ( </font></font><code>/sys/fs/cgroup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Dans le cas du processeur, cela </font></font><code>/sys/fs/cgroup/cpu,cpuacct/*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K8s utilise le fichier </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour allouer les ressources du processeur. Dans notre cas, le groupe de contr√¥le racine re√ßoit 4096 parts de ressources CPU - 100% de la puissance de processeur disponible (1 c≈ìur = 1024; il s'agit d'une valeur fixe). Le groupe racine distribue les ressources proportionnellement en fonction des parts de descendants prescrites dans</font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et ceux-ci, √† leur tour, font de m√™me avec leurs descendants, etc. Typiquement Kubernetes groupe t√©moin n≈ìud racine a trois enfants: </font></font><code>system.slice</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>user.slice</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>kubepods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Les deux premiers sous-groupes sont utilis√©s pour r√©partir les ressources entre les charges syst√®me critiques et les programmes utilisateur en dehors des K8. Le dernier - - </font></font><code>kubepods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est cr√©√© par Kubernetes pour r√©partir les ressources entre les pods. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le diagramme ci-dessus montre que les premier et deuxi√®me sous-groupes ont re√ßu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1024</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> partages, avec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4096</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> partages </font><font style="vertical-align: inherit;">attribu√©s au sous-groupe kuberpod </font><font style="vertical-align: inherit;">. Comment est-ce possible: apr√®s tout, le groupe racine ne dispose que de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4096</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> actions, et la somme des actions de ses descendants d√©passe consid√©rablement ce nombre ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6144</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)? Le fait est que la valeur est logique, donc le Planificateur Linux (CFS) l'utilise pour allouer proportionnellement les ressources CPU. Dans notre cas, les deux premiers groupes re√ßoivent </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">680</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> actions r√©elles (16,6% de 4096) et kubepod re√ßoit les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2736</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> actions </font><font style="vertical-align: inherit;">restantes </font><font style="vertical-align: inherit;">. En cas d'indisponibilit√©, les deux premiers groupes n'utiliseront pas les ressources allou√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, le planificateur dispose d'un m√©canisme pour √©viter la perte de ressources CPU inutilis√©es. Il transf√®re les capacit√©s ¬´inactives¬ª au pool global, √† partir duquel elles sont r√©parties en groupes qui n√©cessitent des capacit√©s de processeur suppl√©mentaires (le transfert a lieu par lots pour √©viter les pertes d'arrondi). Une m√©thode similaire s'applique √† tous les descendants de descendants.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce m√©canisme garantit une r√©partition √©quitable de la puissance du processeur et garantit qu'aucun processus ne ¬´vole¬ª les ressources des autres.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite CPU</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgr√© le fait que les configurations des limites et des demandes dans les K8 se ressemblent, leur mise en ≈ìuvre est fondamentalement diff√©rente: c'est la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la </font><b><font style="vertical-align: inherit;">plus trompeuse</font></b><font style="vertical-align: inherit;"> et la moins document√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K8s utilise </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le m√©canisme de quota CFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour appliquer les limites. Leurs param√®tres sont sp√©cifi√©s dans les fichiers </font></font><code>cfs_period_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>cfs_quota_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le r√©pertoire cgroup (le fichier s'y trouve √©galement </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En revanche </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le quota est bas√© sur une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p√©riode de temps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et non sur la puissance de processeur disponible. </font></font><code>cfs_period_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©finit la dur√©e de la p√©riode (√®re) - elle est toujours de 100 000 Œºs (100 ms). K8s a la possibilit√© de modifier cette valeur, mais elle n'est actuellement disponible que dans la version alpha. Le planificateur utilise l'√®re pour red√©marrer les quotas utilis√©s. Deuxi√®me dossier</font></font><code>cfs_quota_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, d√©finit le temps disponible (quota) √† chaque √©poque. Veuillez noter qu'il est √©galement indiqu√© en microsecondes. Le quota peut d√©passer la dur√©e de l'√®re; en d'autres termes, elle peut √™tre sup√©rieure √† 100 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons deux sc√©narios sur des machines √† 16 c≈ìurs (le type d'ordinateurs le plus courant que nous avons dans Omio): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pt/wr/dm/ptwrdmpxueuy4p1mn7mb8vfdhyg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sc√©nario 1: 2 threads et une limite de 200 ms. Sans √©tranglement </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/7f/no/i9/7fnoi9e7kz6ib6jksx2mkqmc-zo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sc√©nario 2: 10 flux et une limite de 200 ms. La limitation commence apr√®s 20 ms, l'acc√®s aux ressources du processeur reprend apr√®s 80 ms suppl√©mentaires.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Supposons que vous d√©finissez la limite du processeur sur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c≈ìurs; Kubernetes traduira cette valeur √† 200 ms. Cela signifie que le conteneur peut utiliser un temps processeur maximum de 200 ms sans limitation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ici, le plaisir commence. </font><font style="vertical-align: inherit;">Comme mentionn√© ci-dessus, le quota disponible est de 200 ms. </font><font style="vertical-align: inherit;">Si vous avez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dix</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> threads </font><font style="vertical-align: inherit;">ex√©cut√©s en parall√®le </font><font style="vertical-align: inherit;">sur une machine √† 12 c≈ìurs (voir l'illustration du sc√©nario 2), alors que tous les autres pods sont inactifs, le quota sera √©puis√© en seulement 20 ms (puisque 10 * 20 ms = 200 ms), et tous les threads de ce pod est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acc√©l√©rateur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour les 80 ms suivantes. </font><font style="vertical-align: inherit;">Le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bogue du planificateur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©j√† mentionn√© aggrave la situation </font><font style="vertical-align: inherit;">, en raison de laquelle une limitation excessive se produit et le conteneur ne peut m√™me pas d√©terminer le quota existant.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment √©valuer la limitation dans les pods?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Allez simplement au pod et courez </font></font><code>cat /sys/fs/cgroup/cpu/cpu.stat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<ul>
<li> <code>nr_periods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le nombre total de p√©riodes de l'ordonnanceur;</font></font></li>
<li> <code>nr_throttled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le nombre de p√©riodes √©trangl√©es dans la composition </font></font><code>nr_periods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>throttled_time</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - temps d'√©tranglement cumul√© en nanosecondes.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/fb/kp/tp/fbkptpvc9e6c1yua63aawbropk8.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qui se passe r√©ellement?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous obtenons un √©tranglement √©lev√© dans toutes les applications. </font><font style="vertical-align: inherit;">Parfois, il est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une fois et demie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plus fort que le calcul√©! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela conduit √† diverses erreurs - √©checs de v√©rification de l'√©tat de pr√©paration, blocages de conteneurs, coupures de connexion r√©seau, d√©lais d'attente dans les appels de service. </font><font style="vertical-align: inherit;">En fin de compte, cela se traduit par une latence accrue et des erreurs accrues.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©cision et cons√©quences</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, tout est simple. </font><font style="vertical-align: inherit;">Nous avons abandonn√© les limites du processeur et commenc√© √† mettre √† jour le noyau du syst√®me d'exploitation dans les clusters vers la derni√®re version dans laquelle le bogue a √©t√© corrig√©. </font><font style="vertical-align: inherit;">Le nombre d'erreurs (HTTP 5xx) dans nos services a imm√©diatement chut√© de mani√®re significative:</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erreurs HTTP 5xx</font></font></h3><br>
<img src="https://habrastorage.org/webt/rg/t4/wt/rgt4wttq-x7-0dz8-5pfybrk_d8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erreurs HTTP 5xx d'un service critique</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temps de r√©ponse P95</font></font></h3><br>
<img src="https://habrastorage.org/webt/xc/ds/er/xcdservm7jabpev6yly59uq_u3i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©lai de demande de service critique, 95e centile</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les co√ªts d'exploitation</font></font></h3><br>
<img src="https://habrastorage.org/webt/zb/ym/nc/zbymnckdg75bfpktepdi8ex4byg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nombre d'heures pass√©es</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quel est le pi√®ge?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme indiqu√© au d√©but de l'article:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez faire une analogie avec un appartement communal ... Kubernetes agit comme un agent immobilier. </font><font style="vertical-align: inherit;">Mais comment √©viter que les locataires n'entrent en conflit? </font><font style="vertical-align: inherit;">Et si l'un d'entre eux, par exemple, d√©cide d'occuper la salle de bain pendant une demi-journ√©e?</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C‚Äôest le hic. </font><font style="vertical-align: inherit;">Un conteneur n√©gligent peut absorber toutes les ressources processeur disponibles sur la machine. </font><font style="vertical-align: inherit;">Si vous avez une pile d'applications intelligente (par exemple, JVM, Go, Node VM sont correctement configur√©s), ce n'est pas un probl√®me: vous pouvez travailler dans de telles conditions pendant longtemps. </font><font style="vertical-align: inherit;">Mais si les applications sont mal optimis√©es ou pas du tout optimis√©es ( </font></font><code>FROM java:latest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), la situation peut devenir incontr√¥lable. </font><font style="vertical-align: inherit;">Chez Omio, nous avons automatis√© les Dockerfiles de base avec des param√®tres par d√©faut ad√©quats pour la pile des langues principales, donc il n'y avait pas un tel probl√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous vous recommandons de surveiller les m√©triques </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (utilisation, saturation et erreurs), les retards API et les taux d'erreur. </font><font style="vertical-align: inherit;">Assurez-vous que les r√©sultats sont comme pr√©vu.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©f√©rences</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Telle est notre histoire. </font><font style="vertical-align: inherit;">Les documents suivants ont grandement aid√© √† comprendre ce qui se passe:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel.org ‚Üí Planificateur CFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel.org ‚Üí CFS Bandwidth Control</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprendre la planification des conteneurs Linux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout ce que vous devez savoir sur les conteneurs Linux, premi√®re partie: groupes de contr√¥le Linux et isolation des processus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Histoires d'√©checs de Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Recherchez</font></a><font style="vertical-align: inherit;"> ¬´√©tranglement du processeur¬ª.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rapport d'erreurs Kubernetes:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 51135: Evitez de d√©finir des limites CPU pour les pods garantis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 67577: Les quotas CFS peuvent entra√Æner une limitation inutile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CFS trop agressif</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avez-vous rencontr√© des probl√®mes similaires dans votre pratique ou avez-vous l'exp√©rience de la limitation dans des environnements de production conteneuris√©s? </font><font style="vertical-align: inherit;">Partagez votre histoire dans les commentaires!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS du traducteur</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez aussi dans notre blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auto-scaling et gestion des ressources dans Kubernetes (revue et rapport vid√©o)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment fonctionne le CPU Manager dans Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que se passe-t-il dans Kubernetes lorsque l'ex√©cution de kubectl d√©marre? </font><font style="vertical-align: inherit;">Partie 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489642/index.html">Brevets dr√¥les de l'industrie automobile</a></li>
<li><a href="../fr489650/index.html">Automatisation d'un journaliste. Partie 1: t√¢ches et calendriers</a></li>
<li><a href="../fr489662/index.html">PHP Digest n ¬∞ 174 (10-24 f√©vrier 2020)</a></li>
<li><a href="../fr489664/index.html">NPS, convoyeur, calcul automatique et encore ... coroutines</a></li>
<li><a href="../fr489666/index.html">Surcharge en C ++. Partie II Surcharge de l'op√©rateur</a></li>
<li><a href="../fr489672/index.html">Nous ressuscitons l'hexapode. Deuxi√®me partie</a></li>
<li><a href="../fr489674/index.html">Angular: une introduction claire √† NGRX</a></li>
<li><a href="../fr489676/index.html">Nous faisons un clone du service de livraison de nourriture en utilisant Nuxt.js, GraphQL, Strapi et Stripe. Partie 1/7</a></li>
<li><a href="../fr489678/index.html">M√©moire indestructible, processus indestructibles</a></li>
<li><a href="../fr489682/index.html">CORB (Cross-Origin Read Blocking) dans les extensions Chrome</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>