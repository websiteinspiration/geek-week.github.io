<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♿️ 🧕🏽 ➗ サーバーが互いにネゴシエートする方法：Raft分散コンセンサスアルゴリズム ❄️ 🦐 🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="クラスターが数百、場合によっては数千のマシンに到達すると、サーバーの状態の相互の一貫性に疑問が生じます。Raft分散コンセンサスアルゴリズムは、可能な限り最も厳しい一貫性保証を提供します。この記事では、エンジニアの観点からRaftを検討し、「どうやって？」という質問に答えます。なぜ？" できます。
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>サーバーが互いにネゴシエートする方法：Raft分散コンセンサスアルゴリズム</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dodopizzadev/blog/469999/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスターが数百、場合によっては数千のマシンに到達すると、サーバーの状態の相互の一貫性に疑問が生じます。</font><font style="vertical-align: inherit;">Raft分散コンセンサスアルゴリズムは、可能な限り最も厳しい一貫性保証を提供します。</font><font style="vertical-align: inherit;">この記事では、エンジニアの観点からRaftを検討し、「どうやって？」という質問に答えます。</font><font style="vertical-align: inherit;">なぜ？" </font><font style="vertical-align: inherit;">できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e7/yf/fs/e7yffsk5gyqcjqxclgt9oqvnyrs.png"><br>
<br>
<a name="habracut"></a><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事の著者：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dmitry Pavlushin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（開発者Dodo Pizza Engineering）。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Raftは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数の参加者が共同でイベントが発生したかどうか、およびその後の状況を判断できるようにするために必要な</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">分散コンセンサスアルゴリズム</font></a><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Raftクラスターによって提供されるデータは、レコードで構成されるログです。ユーザーがクラスターに保存されているデータを変更する場合、次のコマンドを使用して新しいレコードをログに追加しようとし</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vo/wu/sl/vowusleov4a4bpnob0koux_7vns.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これらのコマンドは、分散状態マシンによって実行されます。簡潔かつ明確にするために、この記事のフレームワークでは、発生したイベントに基づいてシステムの現在の状態を復元するクライアントにこれらのレコードを読み取るときに、これらのレコードが単に与えられると想定します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（イベントソースを参照）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Raftでの合意を確実にするために、最初に、分散ログを管理する責任を負うリーダーを選択します。</font><font style="vertical-align: inherit;">リーダーはクライアントからの要求を受け入れ、それらをクラスター内の他のサーバーに複製します。</font><font style="vertical-align: inherit;">リーダーに障害が発生すると、クラスター内で新しいリーダーが選択されます。</font><font style="vertical-align: inherit;">これは、しばらくの間、3つの文で表示されます。</font><font style="vertical-align: inherit;">詳細は以下の通りです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本概念</font></font></h2><br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーの状態 </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raftクラスターでは、各サーバーは常に次の3つの状態のいずれかになります。</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leader（リーダー）-すべてのクライアント要求を処理し、ログ内のすべてのデータの真のソースであり、フォロワーログをサポートします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォロワー（フォロワー）は、リーダーからの新しいログエントリのみを「リッスン」し、クライアントからのすべての着信要求をリーダーにリダイレクトするパッシブサーバーです。</font><font style="vertical-align: inherit;">実際、これはリーダーのホットスタンバイレプリカです。</font></font></li>
<li>Candidate () –   ,       . </li>
</ul><br>
           ,   –  .<br>
<br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text">  ,   –  . - ,    ,               .<br>
 </div></div></li>
<li><b>Raft      ,  </b>.      .     ,       .  ,     ,       .    ,          ,  ,    .          .    split vote.        :<br>
<br>
<img src="https://habrastorage.org/webt/uw/uj/cr/uwujcro7y3jflbpmc1y2iek_wlg.png"><br>
      timestamp   Raft.    ,       . <br>
<br>
<div class="spoiler"><b class="spoiler_title">    </b><div class="spoiler_text"><ul>
<li>      .</li>
<li>         .</li>
<li>        ,   ,     .</li>
<li>      ́  ,   ,      ,    .</li>
<li>        ́  ,   ,   ,       ,     .         «»     .</li>
</ul></div></div><br>
</li>
<li><b> .</b>   Raft      .    -   : <br>
<br>
<ul>
<li><b>RequestVote</b>     .          ,    .         «true»,     ; «false»,     .</li>
<li> <b>AppendEntries</b>     ,     heartbeat.     ,  ,      (     heartbeat),     ,    .        «true»,        ; «false»,       .</li>
</ul></li>
</ol><br>
<h2> </h2><br>
<h4>1.  </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Raftは、新しい選挙をいつ開始するかを判断するために、ハートビートを利用しています。現在のリーダーまたは候補者からメッセージを受信する限り、フォロワーはフォロワーのままです。リーダーは他のすべてのハートビートサーバーを定期的に送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォロワーがしばらくの間メッセージを受け取らない場合、リーダーは死んでいると自然に想定します。つまり、主導権を握るときです。この時点で、元フォロワーが選挙を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
選挙を開始するために、フォロワーは期間番号をインクリメントし、「候補」状態に切り替えて、それ自体に投票し、「RequestVote」要求を他のすべてのサーバーに送信します。その後、候補者は次の3つのイベントのいずれかを待ちます。</font></font><br>
<br>
<ol>
<li><b>    ( )    . </b>       ,     (  ,  ),           .    ,   heartbeat      .</li>
<li><b>               </b>.     ,  ,    ,   .    ,     /      .</li>
<li><b>       .</b>     ,     ,      ,      .       ,          .</li>
</ol><br>
<h4>2.  </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リーダーが選択されると、彼は分散ログの管理を担当します。リーダーは、いくつかのチームを含むクライアントからリクエストを受け取ります。リーダーはコマンドを含む新しいレコードをログに入れ、新しいレコードでレコードを複製するためにすべてのフォロワーに「AppendEntries」を送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのサーバーでレコードが正常に複製されると、リーダーはレコードが閉じていると見なし始め、クライアントに応答します。リーダーは、最後のレコードを追跡します。彼はこのレコードの数をAppendEntries（ハートビートを含む）に送信して、フォロワーがレコードを自分自身にコミットできるようにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リーダーが一部のフォロワーに連絡できない場合は、AppendEntriesを無限に遡ります。次の図は、Raftクラスターでのログの構成を示しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s3/2l/-z/s32l-zuwjn3u0eoz83j8pysn_uc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各ボックスはログの1つのエントリです。</font><font style="vertical-align: inherit;">各レコードには1つのコマンドが格納されます。たとえば、x←3はキーxに値3を割り当てます。</font><font style="vertical-align: inherit;">レコードには、それが生成された用語の番号も格納されます。</font><font style="vertical-align: inherit;">写真では、これは正方形の上部にある数字で示されています。</font><font style="vertical-align: inherit;">正方形の色表示は、用語番号も意味します。</font><font style="vertical-align: inherit;">各レコードにはシリアル番号（ログインデックス）があります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.アルゴリズムの信頼性を保証します</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これまでのところ、私たちが検討したことから、Raftが少なくともいくつかの保証を与えることができるかどうかは明らかではありません。</font><font style="vertical-align: inherit;">ただし、アルゴリズムは、実行の信頼性を一緒に保証する一連のプロパティを提供します。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">選挙の安全</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：単一の任期内に選択できるリーダーは1人だけです。</font><font style="vertical-align: inherit;">この特性は、各サーバーが各期内に1回だけ投票し、リーダーの結成には過半数の投票が必要であるという事実に基づいています</font></font></li>
<li><b>Leader Append-Only</b>:       ,      ,    .        –  ,        –    .  .</li>
<li><b>Log Matching:</b>            ,         . <br>
<br>
<div class="spoiler"><b class="spoiler_title">      </b><div class="spoiler_text">  –   ,          .          X.   ,        X+1.          .<br>
<br>
     –  .  ,     .<br>
<br>
  ,     - ,   .  Raft  ,         .    <b>Consistency check</b>.    .<br>
<br>
<b> </b>.  , , 4- ,  .        .<br>
<br>
<img src="https://habrastorage.org/webt/ob/kl/qj/obklqjfsspdfwyxwmpodpyvc-ia.png"><br>
<br>
     ,      .<br>
<br>
<img src="https://habrastorage.org/webt/e9/d0/_x/e9d0_xsxyddboyfr9yjjdfake8m.png"><br>
<br>
  «AppendEntries» . ,    ,     ,       4,    3,  ,      2.<br>
<br>
<img src="https://habrastorage.org/webt/eo/7l/x0/eo7lx0m8xul1tmtzqfkk4cgjdic.png"><br>
<br>
     3        ,           . .<br>
<br>
<img src="https://habrastorage.org/webt/ef/e8/kg/efe8kg2uspvnflbnx6mnkx5-1ko.png"><br>
<br>
<b>  ,    .</b>        .<br>
<br>
<img src="https://habrastorage.org/webt/t8/5d/ae/t85daek6x0n9spztxu-jeu5qee8.png"><br>
<br>
        ,     AppendEntries,     .<br>
<br>
<img src="https://habrastorage.org/webt/ka/q5/gw/kaq5gw5c0ezpdflgrdinqmpbmmk.png"><br>
<br>
   ,       ,   .<br>
<br>
<img src="https://habrastorage.org/webt/41/wk/zf/41wkzfixq1dr2x8artbwph2s3jw.png"><br>
<br>
     ?           ,        3.       .<br>
<br>
<img src="https://habrastorage.org/webt/y_/gw/br/y_gwbrjzohvl83zh-e2hploan5m.png"><br>
<br>
         ,    3.<br>
<br>
<img src="https://habrastorage.org/webt/8l/oa/wp/8loawpe9iqskomaw0p7zbwek9f8.png"><br>
<br>
        .      ,      .   , consistency check ,           .<br>
</div></div><br>
</li>
<li><b>Leader Completeness</b>:        ,          .      durability. <br>
<br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text">  :    .  S1 —    .        .<br>
<br>
<img src="https://habrastorage.org/webt/g6/c9/zb/g6c9zbx5fsewp_4nn0komxcnikm.png"><br>
<br>
 S1           ,  AppendEntries   S2  S3.<br>
<br>
<img src="https://habrastorage.org/webt/rz/ki/gf/rzkigfvgmygzxg4qbwy9tfgf914.png"><br>
<br>
 S2   ,    S1  S3 ,   .  S1 ,        ,   ,   ,    . <br>
<br>
S1       S3   ,     .   ,   S1     ?  ,  ,  S3   ,    ? S2   , S3    ,       , S3    ? <br>
<br>
<img src="https://habrastorage.org/webt/_g/ij/l3/_gijl3pklfn6g5xme0ta7-svaus.png"><br>
<br>
           Raft.    ,  S2      S3. ?     S3     ,    S2.    <b>Election restriction</b> –      ,       ,   .<br>
<br>
Raft      :<br>
<br>
<ul>
<li>   </li>
<li> </li>
</ul><br>
       «RequestVote»,          .<br>
<br>
«»  ,      .<br>
<br>
<img src="https://habrastorage.org/webt/7o/2a/-v/7o2a-vpncoa6z4qwmn-xdgckh1m.png"><br>
<br>
      ,  «»  ,  .<br>
<br>
<img src="https://habrastorage.org/webt/qf/kx/nk/qfkxnk-qv4py6t6lvw3i8wuphu4.png"><br>
<br>
     ,    ,  ,     ,  .<br>
<br>
<img src="https://habrastorage.org/webt/hp/ej/x8/hpejx8hkcwkm-fjs7qs98gzn8pc.png"><br>
<br>
   ,     ,   ,  ,    .  ,     ,     ,    .        ,             ,        .<br>
</div></div><br>
</li>
<li><b>State Machine Safety</b>:          ,          –       ,           .<br>
<br>
    .        N,         N . Leader completeness property  ,    ,         N,   ,        N,      .<br>
</li>
</ul><br>
<h2>     </h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">The Raft Consensus Algorithm</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">In Search of an Understandable Consensus Algorithm</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Consensus: Bridging Theory and Practice</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   :     </a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja469985/index.html">Redd合成プロセッサのプログラムを最適化せずに高速化：クロックを置き換える</a></li>
<li><a href="../ja469989/index.html">C＃例の正規表現</a></li>
<li><a href="../ja469991/index.html">RabbitMQとTypeScriptを使用してオンラインストアからの注文を処理します</a></li>
<li><a href="../ja469995/index.html">Python SAXパーサーとPython DOMパーサー。Parsim FIAS-houses</a></li>
<li><a href="../ja469997/index.html">注意を引く可能性が最も高い見出しまたはHabraHabr</a></li>
<li><a href="../ja470001/index.html">Linuxのヒントとコツ：サーバー、オープン</a></li>
<li><a href="../ja470005/index.html">ブラウザを介したリモートコンピュータ制御</a></li>
<li><a href="../ja470009/index.html">EXIF + PHPからのデータで写真を並べ替え</a></li>
<li><a href="../ja470011/index.html">シミュレーション訓練の効果的な手段としての熱力学のインタラクティブな実験室</a></li>
<li><a href="../ja470013/index.html">宇宙人を探しているロシアの億万長者が宇宙の最大の謎の1つを明らかにするのにどのように役立つか</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>