<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦅 🧤 😇 Depth of rabbit hole or C ++ interview at PVS-Studio 🤹🏾 🧜 🥫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Authors: Andrey Karpov, khandeliantsPhilip Handelyants. 
 
 I would like to share an interesting situation when the question that we used at the inter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Depth of rabbit hole or C ++ interview at PVS-Studio</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/495570/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9c8/090/606/9c80906065d1212a18f358f97ebbd11f.png" alt="Interview on C ++ at PVS-Studio"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Authors: Andrey Karpov, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">khandeliants</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Philip Handelyants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would like to share an interesting situation when the question that we used at the interview turned out to be more complicated than the author intended. </font><font style="vertical-align: inherit;">With the C ++ language and compilers, you should always be on the lookout. </font><font style="vertical-align: inherit;">Do not get bored.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As in any other programming company, we have sets of questions for interviewing for vacancies of developers in C ++, C # and Java. We have many questions with double or triple bottom. For questions on C # and Java, we can’t say for sure, since they have other authors. But many of the questions compiled by Andrei Karpov for interviews in C ++ were immediately conceived to probe the depth of knowledge of the language features. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These questions can be given a simple correct answer. You can go deeper and deeper. Depending on this, during the interview, we determine how much a person is familiar with the nuances of the language. This is important for us, since we are developing a code analyzer and should very well understand the language subtleties and “jokes”.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we’ll tell a short story about how one of the first questions asked at the interview turned out to be even deeper than we planned. So, we show this code:</font></font><br>
<br>
<pre><code class="cpp">void F1()<font></font>
{<font></font>
  int i = 1;<font></font>
  printf("%d, %d\n", i++, i++);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and ask: "What will be printed?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Good question. Immediately can say a lot about knowledge. Cases when a person cannot answer him at all will not be considered. These are eliminated by preliminary testing on the HeadHunter website (hh.ru). Although, no, it’s a lie. In our memory, there were a couple of unique personalities who answered something in the spirit: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code will print at the beginning a percentage, then d, then another percentage, d, then a wand, n, and then two units.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Clearly, in such cases, the interview ends quickly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, now back to the normal interview :). Often they answer like this: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 and 2 will print.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This is the answer of the intern level. Yes, such values ​​can, of course, be printed, but we are waiting for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">approximately the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> following answer:</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is not to say what </font></font></i><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exactly</font></font></i></b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> this code will print. This is unspecified (or undefined) behavior. The order in which the arguments are calculated is not defined. All arguments must be evaluated before the body of the called function is executed, but the order in which this will happen is left to the discretion of the compiler. Therefore, the code may very well print both “1, 2” and vice versa “2, 1”. In general, writing such code is </font></font></i><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">highly</font></font></i></b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> undesirable, if it is going to be built by at least two compilers, it is possible to “shoot in the foot”. And many compilers will give a warning here.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Indeed, if you use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you can get "1, 2". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if you use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you can get "2, 1".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once upon a time we tried the MSVC compiler, and it also produced "2, 1". No signs of trouble. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recently, for a general third-party purpose, it was again necessary to compile this code using modern Visual C ++ and run it. Assembled under Release configuration with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimization enabled </font><font style="vertical-align: inherit;">. And, as they say, they found adventure on their own head :). What do you think happened? Ha! Here's what: “1, 1”. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So think what you want. It turns out that the question is even deeper and more confusing. We ourselves did not expect this to happen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the C ++ standard does not regulate the calculation of arguments in any way, the compiler interprets this type of unspecified behavior in a very peculiar way. </font><font style="vertical-align: inherit;">Let's take a look at the assembler code generated by the MSVC 19.25 compiler (Microsoft Visual Studio Community 2019, Version 16.5.1), the flag version of the language standard is '/ std: c ++ 14':</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e42/26e/b7c/e4226eb7c1a4ab93f734807976c269bc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Formally, the optimizer turned the code above into the following:</font></font><br>
<br>
<pre><code class="cpp">void F1()<font></font>
{<font></font>
  int i = 1;<font></font>
  int tmp = i;<font></font>
  i += 2;<font></font>
  printf("%d, %d\n", tmp, tmp);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the point of view of the compiler, such optimization does not change the observed behavior of the program. </font><font style="vertical-align: inherit;">Looking at this, you begin to understand that, for good reason, the C ++ 11 standard, in addition to smart pointers, also added the “magic” function </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make_shared</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (and C ++ 14 also added </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make_unique</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Such a harmless example, and also can "break firewood":</font></font><br>
<br>
<pre><code class="cpp">void foo(std::unique_ptr&lt;int&gt;, std::unique_ptr&lt;double&gt;);<font></font>
<font></font>
int main()<font></font>
{<font></font>
  foo(std::unique_ptr&lt;int&gt; { new int { 0 } },<font></font>
      std::unique_ptr&lt;double&gt; { new double { 0.0 } });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A cunning compiler can turn this into the following order of calculations (the same </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSVC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , for example):</font></font><br>
<br>
<pre><code class="cpp">new int { .... };<font></font>
new double { .... };<font></font>
std::unique_ptr&lt;int&gt;::unique_ptr<font></font>
std::unique_ptr&lt;double&gt;::unique_ptr<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the second call to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">throws an exception, then we get a memory leak. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But back to the original topic. </font><font style="vertical-align: inherit;">Despite the fact that everything was fine from the point of view of the compiler, we were still sure that the output “1, 1” was incorrectly considered the behavior expected by the developer. </font><font style="vertical-align: inherit;">And then we tried to compile the source code with the MSVC compiler with the standard version flag '/ std: c ++ 17'. </font><font style="vertical-align: inherit;">And everything starts to work as expected, and "2, 1" is printed. </font><font style="vertical-align: inherit;">Take a look at the assembler code:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f44/a37/a88/f44a37a8836d786f6dda5b11b165b944.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is fair, the compiler passed values ​​2 and 1 as arguments. But why has everything changed so dramatically? It turns out that the following was added to the C ++ 17 standard: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The postfix-expression is sequenced before each expression in the expression-list and any default argument. The initialization of a parameter, including every associated value computation and side effect, is indeterminately sequenced with respect to that of any other parameter.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The compiler still has the right to calculate arguments in an arbitrary order, but now, starting from the C ++ 17 standard, it has the right to start calculating the next argument and its side effects only from the moment all calculations and side effects of the previous argument are completed.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, if you compile the same example with smart pointers with the '/ std: c ++ 17' flag, then everything becomes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">good</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">too</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - using </font><i><font style="vertical-align: inherit;">std :: make_unique is</font></i><font style="vertical-align: inherit;"> now optional. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is another measurement of depth in the question it turned out. There is a theory, but there is practice in the form of a specific compiler or a different interpretation of the standard :). The world of C ++ is always more complex and unexpected than it seems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If someone can more accurately explain what is happening, then please tell us in the comments. We must finally understand the question in order to at least ourselves know the answer to it at the interview! :)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is such an informative story. </font><font style="vertical-align: inherit;">We hope it was interesting, and you share your opinion on this topic. </font><font style="vertical-align: inherit;">And we recommend using the most modern language standard as much as possible, so as to be less surprised that current optimizing compilers can. </font><font style="vertical-align: inherit;">Better yet, don’t write this code at all :). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS We can say that we “lit up the question”, and now it will have to be removed from the questionnaire. </font><font style="vertical-align: inherit;">We do not see the point in this. </font><font style="vertical-align: inherit;">If a person is not too lazy to study our publications before an interview, reads this material and then uses it, then he is well done and deservedly will receive a plus sign :).</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/898/3b6/5a7/8983b65a74adb29a2113eba12fbec3f1.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov, Phillip Khandeliants. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How Deep the Rabbit Hole Goes, or C ++ Job Interviews at PVS-Studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495550/index.html">The Most Wonderful Unix Programs</a></li>
<li><a href="../en495552/index.html">Моя попытка задержать COVID-19 (автономный дыхательный аппарат)</a></li>
<li><a href="../en495554/index.html">Program for searching like-minded VKontakte [Open source]</a></li>
<li><a href="../en495556/index.html">Fortinet - a selection of useful materials</a></li>
<li><a href="../en495560/index.html">Internet of Things Trends: AI Answers Calls, Clouds and 5G Tame Big Data, Housing and Utilities - Leader in Innovation</a></li>
<li><a href="../en495572/index.html">Hardware Ecosystem Community Launches Podcast for Everyone in the Electronics Industry</a></li>
<li><a href="../en495574/index.html">Visitor Detection and Counting: Cloud vs. camera counter</a></li>
<li><a href="../en495576/index.html">Self-propelled platform on the esp8266 MK with micropython</a></li>
<li><a href="../en495580/index.html">Cucumber JVM - Not Just BDD</a></li>
<li><a href="../en495588/index.html">Creating roguelike in Unity from scratch: dungeon generator</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>