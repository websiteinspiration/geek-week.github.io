<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëø üëàüèø üòª DEVOXX Reino Unido. Kubernetes en producci√≥n: implementaci√≥n azul / verde, autoescalado y automatizaci√≥n de implementaci√≥n. Parte 2 ‚¨áÔ∏è üèüÔ∏è üëßüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes es una gran herramienta para ejecutar contenedores Docker en un entorno de producci√≥n en cl√∫ster. Sin embargo, hay tareas que Kubernetes no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DEVOXX Reino Unido. Kubernetes en producci√≥n: implementaci√≥n azul / verde, autoescalado y automatizaci√≥n de implementaci√≥n. Parte 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/504672/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes es una gran herramienta para ejecutar contenedores Docker en un entorno de producci√≥n en cl√∫ster. Sin embargo, hay tareas que Kubernetes no puede resolver. Con implementaciones frecuentes en un entorno de producci√≥n, necesitamos una implementaci√≥n Azul / Verde totalmente automatizada para evitar el tiempo de inactividad en este proceso, que tambi√©n requiere solicitudes HTTP externas y carga SSL. Esto requiere integraci√≥n con un equilibrador de carga como ha-proxy. Otra tarea es el escalado semiautom√°tico del cl√∫ster Kubernetes en s√≠ mismo cuando se trabaja en la nube, por ejemplo, la reducci√≥n parcial de la escala del cl√∫ster por la noche.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aunque Kubernetes no tiene estas caracter√≠sticas listas para usar, proporciona una API que puede usarse para resolver tales problemas. Las herramientas de escala y despliegue automatizado azul / verde de Kubernetes se desarrollaron como parte del proyecto de c√≥digo abierto Cloud RTI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta transcripci√≥n del video describe c√≥mo configurar Kubernetes junto con otros componentes de c√≥digo abierto para obtener un entorno listo para la producci√≥n que acepte el c√≥digo del git commit change commit sin tiempo de inactividad en la producci√≥n.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/4y/jm/cy4yjm9zwmpfpvtfwhwfigavpkw.jpeg"><a name="habracut"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEVOXX Reino Unido. Kubernetes en producci√≥n: implementaci√≥n azul / verde, autoescalado y automatizaci√≥n de implementaci√≥n. Parte 1</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Entonces, despu√©s de haber accedido a sus aplicaciones desde el mundo exterior, puede comenzar a configurar completamente la automatizaci√≥n, es decir, llevarla al escenario donde puede ejecutar git commit y asegurarse de que este git commit termine en producci√≥n. Naturalmente, en la implementaci√≥n de estos pasos, en la implementaci√≥n de la implementaci√≥n, no queremos enfrentar el tiempo de inactividad. Entonces, cualquier automatizaci√≥n en Kubernetes comienza con una API.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5q/w4/ng/5qw4ngl2hrnecjzk4sfvhhepx_k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes no es una herramienta que se pueda usar "fuera de la caja" productivamente. Por supuesto, puede hacer esto, usar kubectl, etc., pero a√∫n as√≠ la API es lo m√°s interesante y √∫til de esta plataforma. Usando la API como un conjunto de caracter√≠sticas, puede acceder a casi todo lo que quiera hacer en Kubernetes. Kubectl tambi√©n usa la API REST.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es REST, por lo que puede usar cualquier idioma y herramientas para trabajar con esta API, pero las bibliotecas de usuario le facilitar√°n enormemente la vida. Mi equipo escribi√≥ 2 bibliotecas de este tipo: una para Java / OSGi y otra para Go. El segundo no se usa con frecuencia, pero en cualquier caso, estas cosas √∫tiles est√°n a su disposici√≥n. Son un proyecto de c√≥digo abierto con licencia parcial. Existen muchas bibliotecas de este tipo para diferentes idiomas, por lo que puede elegir la m√°s adecuada.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/bj/ey/ejbjeyepppr2tet3aupem789num.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, antes de embarcarse en la automatizaci√≥n de la implementaci√≥n, debe asegurarse de que este proceso no est√© sujeto a ning√∫n tiempo de inactividad. Por ejemplo, nuestro equipo lleva a cabo la implementaci√≥n de producci√≥n en la mitad del d√≠a, cuando las personas aprovechan al m√°ximo sus aplicaciones, por lo que es muy importante evitar retrasos en este proceso. Para evitar el tiempo de inactividad, se utilizan 2 m√©todos: implementaci√≥n azul / verde o actualizaci√≥n continua actualizaci√≥n continua. En el √∫ltimo caso, si tiene 5 r√©plicas de la aplicaci√≥n en ejecuci√≥n, se actualizan secuencialmente una tras otra. Este m√©todo funciona muy bien, pero no funciona si est√° ejecutando diferentes versiones de la aplicaci√≥n al mismo tiempo durante el proceso de implementaci√≥n. En este caso, puede actualizar la interfaz de usuario mientras el backend funcionar√° con la versi√≥n anterior y la aplicaci√≥n dejar√° de funcionar.Por lo tanto, desde el punto de vista de la programaci√≥n, trabajar en tales condiciones es bastante dif√≠cil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es una de las razones por las que preferimos utilizar la implementaci√≥n azul / verde para automatizar la implementaci√≥n de nuestras aplicaciones. Con este m√©todo, debe asegurarse de que en un momento determinado solo est√© activa una versi√≥n de la aplicaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El mecanismo de despliegue azul / verde es el siguiente. Obtenemos tr√°fico para nuestras aplicaciones a trav√©s de ha-proxy, que lo dirige a ejecutar r√©plicas de aplicaciones de la misma versi√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se lleva a cabo una nueva implementaci√≥n, utilizamos Deployer, que se proporciona con nuevos componentes, e implementa la nueva versi√≥n. La implementaci√≥n de una nueva versi√≥n de una aplicaci√≥n significa que un nuevo conjunto de r√©plicas est√° "en aumento", despu√©s de lo cual estas r√©plicas de la nueva versi√≥n se lanzan en un nuevo pod separado. Sin embargo, ha-proxy no sabe nada sobre ellos y hasta ahora no les ha enviado ninguna carga de trabajo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, en primer lugar, es necesario verificar el estado de las nuevas versiones del chequeo de estado para asegurarse de que las r√©plicas est√©n listas para servir la carga.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dx/qk/vd/dxqkvdwkbon86_g0l0plg-dqezu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los componentes de implementaci√≥n deben admitir alguna forma de revisi√≥n de salud. Esta puede ser una verificaci√≥n HTTP muy simple con una llamada cuando recibe un c√≥digo con un estado de 200, o una verificaci√≥n m√°s profunda en la que verifica la conexi√≥n de r√©plicas con la base de datos y otros servicios, la estabilidad de las conexiones del entorno din√°mico, si todo comienza y funciona correctamente. Este proceso puede ser bastante complicado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lr/9t/o4/lr9to4uiafxnxpjfbuyzd3ubtgo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que el sistema haya verificado que todas las r√©plicas actualizadas est√©n operativas, Deployer actualizar√° la configuraci√≥n y pasar√° la confd correcta, que reconfigurar√° el proxy ha. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kw/q1/s7/kwq1s7fkzffaby-ajt6jyrg2vra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo despu√©s de eso, el tr√°fico se dirigir√° hacia abajo con r√©plicas de la nueva versi√≥n, y la anterior desaparecer√°.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/q5/c6/waq5c6mmixf0j3twtrhetjjdvx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este mecanismo no es una caracter√≠stica de Kubernetes. El concepto de implementaci√≥n azul / verde ha existido durante bastante tiempo y siempre ha utilizado un equilibrador de carga. Primero, dirige todo el tr√°fico a la versi√≥n anterior de la aplicaci√≥n, y despu√©s de la actualizaci√≥n, transfi√©ralo completamente a la nueva versi√≥n. Este principio se usa no solo en Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora le presentar√© un nuevo componente de implementaci√≥n: Deployer, que realiza una comprobaci√≥n de estado, reconfigura los proxies, etc. Este es un concepto que no se aplica al mundo exterior y existe dentro de Kubernetes. Le mostrar√© c√≥mo puede crear su propio concepto de Deployer utilizando herramientas de c√≥digo abierto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, lo primero que hace Deployer es crear un controlador de replicaci√≥n RC utilizando la API de Kubernetes. Esta API crea pods y servicios para una mayor implementaci√≥n, es decir, crea un cl√∫ster completamente nuevo para nuestras aplicaciones. Una vez que el RC verifica que las r√©plicas han comenzado, verificar√° su comprobaci√≥n de estado. Para hacer esto, Deployer usa el comando GET / health. Lanza los componentes de verificaci√≥n correspondientes y verifica todos los elementos que aseguran el funcionamiento del cl√∫ster.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/lr/8u/kmlr8uloqusoeejhd-7dquyzu7q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que todos los pods hayan informado de su "estado", Deployer crea un nuevo elemento de configuraci√≥n: el almacenamiento distribuido, etc., que se usa dentro de Kubernetes, incluso para almacenar la configuraci√≥n del equilibrador de carga. Escribimos datos en etcd, y una peque√±a herramienta, confd, monitorea etcd para obtener nuevos datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si encuentra alg√∫n cambio en la configuraci√≥n inicial, genera un nuevo archivo de configuraci√≥n y lo pasa a ha-proxy. En este caso, ha-proxy se reinicia sin perder ninguna conexi√≥n y aborda la carga con nuevos servicios que proporcionan la nueva versi√≥n de nuestras aplicaciones.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h2/1k/os/h21kosweevmblkultqa8kspeuri.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, a pesar de la abundancia de componentes, no hay nada complicado. </font><font style="vertical-align: inherit;">Solo necesita prestar m√°s atenci√≥n a la API y etcd. </font><font style="vertical-align: inherit;">Quiero contarles sobre el implementador de c√≥digo abierto que nosotros mismos utilizamos: este es el Implementador de Amdatu Kubernetes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ir/oj/vt/irojvt6tjy6vgckfsizgnycysdm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es una herramienta de organizaci√≥n de implementaci√≥n de Kubernetes con las siguientes caracter√≠sticas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despliegue azul / verde</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configurar un equilibrador de carga externo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesti√≥n del descriptor de despliegue</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesti√≥n de despliegue real</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprobaciones de estado durante el despliegue</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementaci√≥n de variables de entorno en pods.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creado sobre la API de Kubernetes, este Implementador proporciona una API REST para administrar descriptores e implementaciones, as√≠ como una API Websocket para registros de flujo durante la implementaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pone los datos de configuraci√≥n del equilibrador de carga en etcd, por lo que no puede usar ha-proxy con soporte "listo para usar", pero es f√°cil usar su propio archivo de configuraci√≥n del equilibrador. Amdatu Deployer est√° escrito en Go, al igual que Kubernetes, y con licencia de Apache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de usar esta versi√≥n del desplegador, utilic√© el siguiente descriptor de despliegue, que especifica los par√°metros que necesito.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_p/fr/ht/_pfrhtrtusrz0ua6480jo3acqvo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno de los par√°metros importantes de este c√≥digo es habilitar el indicador "useHealthCheck". Necesitamos indicar que se requiere una comprobaci√≥n de estado durante el proceso de implementaci√≥n. Esta opci√≥n se puede desactivar cuando la implementaci√≥n utiliza contenedores de terceros que no es necesario verificar. Este descriptor tambi√©n indica el n√∫mero de r√©plicas y la URL de interfaz que ha-proxy necesita. Al final est√° el indicador de especificaci√≥n para el podspec pod, que llama a Kubernetes para obtener informaci√≥n sobre la configuraci√≥n del puerto, la imagen, etc. Este es un descriptor bastante simple en formato JSON.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otra herramienta que forma parte del proyecto de c√≥digo abierto Amdatu es Deploymentctl. Tiene una interfaz de usuario de interfaz de usuario para configurar la implementaci√≥n, almacena el historial de implementaci√≥n y contiene webhooks para devoluciones de llamada por parte de terceros usuarios y desarrolladores. No puede usar la interfaz de usuario, ya que Amdatu Deployer es una API REST, pero esta interfaz puede facilitarle la implementaci√≥n sin involucrar ninguna API. Deploymentctl est√° escrito en OSGi / Vertx usando Angular 2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora demostrar√© lo anterior en la pantalla usando una grabaci√≥n prefabricada, para que no tenga que esperar. Implementaremos una aplicaci√≥n simple en Go. No se preocupe, si no se ha encontrado con Go antes, esta es una aplicaci√≥n muy simple, por lo que debe entenderlo todo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/rq/ih/adrqihjjsirswywycn8zcm_ypsy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ creamos un servidor HTTP que responde solo a / health, por lo que esta aplicaci√≥n solo verifica el chequeo de salud y nada m√°s. Si se aprueba el cheque, se invoca la estructura JSON que se muestra a continuaci√≥n. Contiene la versi√≥n de la aplicaci√≥n que implementar√° el implementador, el mensaje que ver√° en la parte superior del archivo y el tipo de datos l√≥gicos booleanos, ya sea que nuestra aplicaci√≥n funcione o no. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hice un poco de trampa con la √∫ltima l√≠nea, porque puse un valor booleano fijo en la parte superior del archivo, que en el futuro me ayudar√° a implementar incluso una aplicaci√≥n "poco saludable". Nos ocuparemos de esto m√°s tarde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces empecemos. Primero, verificamos si hay pods en ejecuci√≥n usando el comando ~ kubectl get pods, y si no hay respuesta de la URL de la interfaz, nos aseguramos de que no se est√©n realizando implementaciones. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/vs/kx/qavskxpsjbdy93vis6wd4xp6tas.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, en la pantalla, ver√° la interfaz Deploymentctl que mencion√©, en la que se establecen los par√°metros de implementaci√≥n: espacio de nombres, nombre de la aplicaci√≥n, versi√≥n de implementaci√≥n, n√∫mero de r√©plicas, URL de la interfaz, nombre del contenedor, imagen, l√≠mites de recursos, n√∫mero de puerto para verificar el estado, etc. . Los l√≠mites de recursos son muy importantes, ya que le permiten utilizar la m√°xima cantidad posible de "hierro". Tambi√©n puede ver el registro de implementaci√≥n registro de implementaci√≥n aqu√≠.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g_/fk/wb/g_fkwbqrgrbuaii4xmoqhmds3lu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si repite el comando ~ kubectl get pods ahora, puede ver que el sistema se "congela" durante 20 segundos, durante los cuales se produce la reconfiguraci√≥n del proxy ha. Despu√©s de eso, comienza bajo, y nuestra r√©plica se puede ver en el registro de implementaci√≥n. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vm/eb/kb/vmebkbw-zpzs2yjjex70jyiz2gg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cort√© una espera de 20 segundos del video, y ahora ves en la pantalla que la primera versi√≥n de la aplicaci√≥n est√° implementada. Todo esto se hizo solo con la ayuda de la interfaz de usuario. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/nw/dq/btnwdq4bpxvs3xloqvdfo01nwla.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora intentemos la segunda versi√≥n. Para hacer esto, cambio el mensaje de la aplicaci√≥n con "¬°Hola, Kubernetes!" a "¬°Hola, Implementador!", el sistema crea esta imagen y la coloca en el registro de Docker, despu√©s de lo cual simplemente hacemos clic en el bot√≥n "Implementar" en la ventana Deploymentctl nuevamente. En este caso, el registro de implementaci√≥n se inicia autom√°ticamente de la misma manera que cuando se implement√≥ la primera versi√≥n de la aplicaci√≥n.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7f/fb/hx/7ffbhx4jbq_bwxyxskyfbhqg0cy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El comando ~ kubectl get pods muestra que 2 versiones de la aplicaci√≥n se est√°n ejecutando actualmente, pero el front-end muestra que todav√≠a estamos ejecutando la versi√≥n 1. El </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gu/xz/xg/guxzxgf4t6g8xxruexeuptcebze.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
equilibrador de carga espera hasta que se realice la comprobaci√≥n de estado y luego redirige el tr√°fico a la nueva versi√≥n. Despu√©s de 20 segundos, cambiamos a curl y vemos que ahora hemos implementado la versi√≥n 2 de la aplicaci√≥n, y la primera se elimina. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cq/jp/0k/cqjp0kwmkhlufezt-hzs-80fezq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fue el despliegue de una aplicaci√≥n "saludable" - saludable. Veamos qu√© sucede si para la nueva versi√≥n de la aplicaci√≥n cambio el valor del par√°metro Saludable de verdadero a falso, es decir, tratar√© de implementar una aplicaci√≥n poco saludable que no haya pasado la comprobaci√≥n de estado. Esto puede suceder si en la etapa de desarrollo se cometieron algunos errores de configuraci√≥n en la aplicaci√≥n, y entr√≥ en producci√≥n de esta forma.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, la implementaci√≥n pasa por todos los pasos anteriores, y ~ kubectl get pods muestra que ambos pods se est√°n ejecutando. Pero a diferencia de la implementaci√≥n anterior, el registro muestra el estado del tiempo de espera. Es decir, debido a que no se aprob√≥ la comprobaci√≥n de estado, la nueva versi√≥n de la aplicaci√≥n no se puede implementar. Como resultado, ver√° que el sistema volvi√≥ a usar la versi√≥n anterior de la aplicaci√≥n, y la nueva versi√≥n simplemente se elimin√≥.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/iv/qz/kqivqzsf3ghxznqksadtfobhzfm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo bueno de esto es que, incluso si tiene una gran cantidad de solicitudes simult√°neas en la aplicaci√≥n, ni siquiera notar√°n el tiempo de inactividad durante la implementaci√≥n del procedimiento de implementaci√≥n. Si prueba esta aplicaci√≥n utilizando el marco de Gatling, que le env√≠a la mayor cantidad posible de solicitudes, entonces ninguna de estas solicitudes se descartar√°. Esto significa que nuestros usuarios ni siquiera notar√°n actualizaciones de versiones en tiempo real. Si falla, el trabajo continuar√° en la versi√≥n anterior; si tiene √©xito, los usuarios cambiar√°n a la nueva versi√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo hay una cosa que puede conducir a una falla: si la comprobaci√≥n de estado fue exitosa y la aplicaci√≥n se bloque√≥ tan pronto como recibi√≥ la carga de trabajo, es decir, el colapso ocurrir√° solo despu√©s de que se complete la implementaci√≥n. En este caso, deber√° retroceder manualmente a la versi√≥n anterior. Entonces, vimos c√≥mo usar Kubernetes con sus herramientas de c√≥digo abierto. El proceso de implementaci√≥n ser√° mucho m√°s simple si incrusta estas herramientas en la creaci√≥n / implementaci√≥n de tuber√≠as de creaci√≥n / implementaci√≥n. Al mismo tiempo, para comenzar la implementaci√≥n, puede usar la interfaz de usuario y automatizar completamente este proceso, aplicando, por ejemplo, commit to master.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/4w/s6/xp4ws6tpk0katzykjamtvd1tuz8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro servidor de compilaci√≥n Build Server crear√° una imagen de Docker, la pegar√° en Docker Hub o en cualquier otro registro que utilice. El Docker Hub admite webhook, por lo que podemos comenzar la implementaci√≥n remota a trav√©s de Deployer como se muestra arriba. Por lo tanto, puede automatizar completamente la implementaci√≥n de la aplicaci√≥n en producci√≥n potencial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasemos al siguiente tema: escalar el cl√∫ster de Kubernetes. Observo que el comando kubectl es un comando de escala. Con la ayuda de otro, puede aumentar f√°cilmente el n√∫mero de r√©plicas en nuestro cl√∫ster. Sin embargo, en la pr√°ctica, generalmente queremos aumentar el n√∫mero de nodos, no nodos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/za/t9/ghzat9sqpdai1jdgg3wabhrfeka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, durante las horas de trabajo, es posible que deba aumentar, y por la noche, para reducir el costo de los servicios de Amazon, disminuir el n√∫mero de instancias en ejecuci√≥n de la aplicaci√≥n. Esto no significa que solo el n√∫mero de pods se escalar√° lo suficiente, porque incluso si uno de los nodos no est√° ocupado, a√∫n tiene que pagarle a Amazon por ello. Es decir, junto con escalar los hogares, necesita escalar el n√∫mero de m√°quinas utilizadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto puede ser complicado porque, independientemente de si usamos Amazon u otro servicio en la nube, Kubernetes no sabe nada sobre la cantidad de m√°quinas utilizadas. Carece de una herramienta que le permita escalar el sistema a nivel de nodos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h8/6d/js/h86djs8fjx9qwpqos9lwpoknxno.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ que tendremos que cuidar los nodos y las vainas. Podemos escalar f√°cilmente el lanzamiento de nuevos nodos utilizando la API de AWS y las m√°quinas del grupo Scaling para configurar el n√∫mero de nodos de trabajo de Kubernetes. Tambi√©n puede usar cloud-init o un script similar para registrar nodos en un cl√∫ster de Kubernetes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La nueva m√°quina comienza en el grupo Scaling, se inicia como un nodo, se registra en el registro del asistente y comienza a funcionar. Despu√©s de eso, puede aumentar el n√∫mero de r√©plicas para usar en los nodos resultantes. Reducir la escala requiere m√°s esfuerzo, ya que debe asegurarse de que tal paso no conduzca a la destrucci√≥n de las aplicaciones que ya se est√°n ejecutando despu√©s de apagar las m√°quinas "innecesarias". Para evitar este escenario, debe llevar los nodos al estado "no programable". Esto significa que el planificador predeterminado al programar los pods DaemonSet ignorar√° estos nodos. El programador no eliminar√° nada de estos servidores, pero tampoco lanzar√° nuevos contenedores all√≠. El siguiente paso es desplazar el nodo de drenaje, es decir, transferir los hogares de trabajo a otra m√°quina u otros nodos que tengan la capacidad suficiente para esto.Despu√©s de verificar que no hay m√°s contenedores en estos nodos, puede eliminarlos de Kubernetes. Despu√©s de eso, para Kubernetes, simplemente dejan de existir. A continuaci√≥n, debe usar la API de AWS para deshabilitar nodos o m√°quinas innecesarios.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede usar Amdatu Scalerd, otra herramienta de escalado de c√≥digo abierto similar a la API de AWS. Proporciona una CLI para agregar o eliminar nodos en un cl√∫ster. Su caracter√≠stica interesante es la capacidad de configurar el planificador utilizando el siguiente archivo json. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/0b/8z/e1/0b8ze13eeahulvu7j2cbuu2m8fe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo que se muestra reduce a la mitad la capacidad del grupo por la noche. Se configura como la cantidad de r√©plicas disponibles y la capacidad deseada del cl√∫ster de Amazon. El uso de este programador reducir√° autom√°ticamente el n√∫mero de nodos por la noche y los aumentar√° por la ma√±ana, ahorrando as√≠ el costo de usar nodos de un servicio en la nube como Amazon. Esta caracter√≠stica no est√° integrada en Kubernetes, pero el uso de Scalerd le permitir√° escalar esta plataforma a su gusto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiero llamar su atenci√≥n sobre el hecho de que muchas personas me dicen: "Todo esto es bueno, pero ¬øqu√© pasa con mi base de datos, que generalmente est√° en un estado est√°tico?" ¬øC√≥mo puedo ejecutar algo como esto en un entorno din√°mico como Kubernetes? En mi opini√≥n, no debe hacer esto, no debe intentar organizar el funcionamiento del almac√©n de datos en Kubernetes. T√©cnicamente, esto es posible, y hay manuales en Internet sobre este tema, pero complicar√° seriamente su vida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√≠, el concepto de almacenamiento persistente existe en Kubernetes, y puede intentar ejecutar almacenes de datos como Mongo o MySQL, pero esta es una tarea que requiere mucho tiempo. Esto se debe al hecho de que los almacenes de datos no son totalmente compatibles con la interacci√≥n con un entorno din√°mico. La mayor√≠a de las bases de datos requieren un ajuste significativo, incluida la configuraci√≥n manual del cl√∫ster, no les gusta la escala autom√°tica y otras cosas similares. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, no te compliques la vida al intentar iniciar un almac√©n de datos en Kubernetes. Organice su trabajo de la manera tradicional utilizando servicios familiares y solo brinde a Kubernetes la oportunidad de usarlos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/ae/w4/jtaew4lftz8i845qgy8pa6bculm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final del tema, quiero presentarles la plataforma Cloud RTI basada en Kubernetes, en la que est√° trabajando mi equipo. Proporciona registros centralizados, aplicaciones de monitoreo y cl√∫steres, y tiene muchas otras caracter√≠sticas √∫tiles que son √∫tiles para usted. Utiliza varias herramientas de c√≥digo abierto como Grafana para mostrar el monitoreo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oo/uj/mz/ooujmzx3ukdhlcqyxxwqszgelts.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/ec/cd/5j/eccd5j4rch3uhdrqey516jdxnva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se plante√≥ la pregunta, ¬øpor qu√© usar el equilibrador de carga ha-proxy con Kubernetes? Buena pregunta, porque actualmente hay 2 niveles de equilibrio de carga. Los servicios de Kubernetes todav√≠a se encuentran en direcciones IP virtuales. No puede usarlos para puertos host externos, porque si Amazon reinicia su host en la nube, la direcci√≥n cambiar√°. Es por eso que colocamos los servicios de proxy de ha delante de los servicios, para crear una estructura m√°s est√°tica para una interacci√≥n de tr√°fico perfecta con Kubernetes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otra buena pregunta es ¬øc√≥mo puedo cuidar de cambiar el esquema de la base de datos durante la implementaci√≥n azul / verde? </font><font style="vertical-align: inherit;">El hecho es que, independientemente del uso de Kubernetes, cambiar el esquema de la base de datos es una tarea compleja. </font><font style="vertical-align: inherit;">Debe garantizar la compatibilidad del esquema antiguo y el nuevo, despu√©s de lo cual puede actualizar la base de datos y luego actualizar las aplicaciones. </font><font style="vertical-align: inherit;">Puede intercambiar en caliente la base de datos y luego actualizar las aplicaciones. </font><font style="vertical-align: inherit;">Conozco personas que descargaron un cl√∫ster de base de datos completamente nuevo con un nuevo esquema, esta es una opci√≥n si tiene una base de datos sin esquema como Mongo, pero en cualquier caso, esta no es una tarea f√°cil. </font><font style="vertical-align: inherit;">Si no hay m√°s preguntas, ¬°gracias por su atenci√≥n!</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-Ci4vd4rh4M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un poco de publicidad :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias por estar con nosotros. ¬øTe gustan nuestros art√≠culos? ¬øQuieres ver m√°s materiales interesantes? Ap√≥yenos haciendo un pedido o recomendando a sus amigos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS basado en la nube para desarrolladores desde $ 4.99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an√°logo √∫nico de servidores de nivel b√°sico que inventamos para usted: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toda la verdad sobre VPS (KVM) E5-2697 v3 (6 n√∫cleos) 10GB DDR4 480GB SSD 1Gbps desde $ 19 o c√≥mo dividir el servidor?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (las opciones est√°n disponibles con RAID1 y RAID10, hasta 24 n√∫cleos y hasta 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 veces m√°s barato en el centro de datos Equinix Tier IV en Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solo tenemos </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV desde $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en los Pa√≠ses Bajos.</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - ¬°desde $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lea sobre</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C√≥mo construir un edificio de infraestructura. </font><font style="vertical-align: inherit;">clase c con servidores Dell R730xd E5-2650 v4 que cuestan 9,000 euros por un centavo?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es504662/index.html">Dibujar m√∫sica: baile de ata√∫d en Pure Data</a></li>
<li><a href="../es504664/index.html">Adici√≥n inteligente de grupos musicales a Google Sheets a trav√©s de VK API, Tampermonkey y Telegram bot</a></li>
<li><a href="../es504666/index.html">DEVOXX Reino Unido. Kubernetes en producci√≥n: implementaci√≥n azul / verde, autoescalado y automatizaci√≥n de implementaci√≥n. Parte 1</a></li>
<li><a href="../es504668/index.html">El resumen de materiales interesantes para el desarrollador m√≥vil # 346 (25 al 31 de mayo)</a></li>
<li><a href="../es504670/index.html">–ï–ì–≠ –ø–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–µ –∏–ª–∏ —Å—Ç—Ä–∞–¥–∞–Ω–∏—è –¥–ª–∏–Ω–æ—é –≤ –≥–æ–¥–∞</a></li>
<li><a href="../es504674/index.html">Base para un gran SPA modular en Laravel + Vue + ElementUI con generador CRUD</a></li>
<li><a href="../es504676/index.html">Agrega una pizca de aleatoriedad a tu juego</a></li>
<li><a href="../es504678/index.html">ITMO Research_ podcast: c√≥mo abordar la sincronizaci√≥n del contenido AR con el espect√°culo a escala de todo el estadio</a></li>
<li><a href="../es504680/index.html">Descripci√≥n general de la biblioteca NLP de SpaL</a></li>
<li><a href="../es504682/index.html">Mensaje de Nostalgia: j2me, Gravity Defied, 64kb</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>