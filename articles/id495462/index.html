<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏿 🚣🏿 🐎 .NET Core: x86_64 Intrinsics di Mesin Virtual 💪 🛄 🕜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kita hidup di era dominasi arsitektur x86. Semua prosesor yang kompatibel dengan x86 serupa, tetapi semuanya sedikit berbeda. Dan bukan hanya pabrikan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>.NET Core: x86_64 Intrinsics di Mesin Virtual</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495462/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kita hidup di era dominasi arsitektur x86. Semua prosesor yang kompatibel dengan x86 serupa, tetapi semuanya sedikit berbeda. Dan bukan hanya pabrikan, frekuensi dan jumlah core. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arsitektur x86 selama keberadaannya (dan popularitas) telah mengalami banyak pembaruan besar (misalnya, ekstensi ke 64 bit - x86_64) dan penambahan "set instruksi diperluas". Compiler, yang secara default menghasilkan kode yang umum untuk semua prosesor, juga harus beradaptasi dengan ini. Namun di antara petunjuk yang diperluas, ada banyak yang menarik dan bermanfaat. Misalnya, dalam program catur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instruksi untuk bekerja dengan bit </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">sering digunakan</font></a><font style="vertical-align: inherit;"> : POPCNT, BSF / BSR (atau analog </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TZCNT / LZCNT yang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lebih baru </font><font style="vertical-align: inherit;">), PDEP, BSWAP, dll.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kompiler C dan C ++, akses eksplisit ke instruksi tersebut diimplementasikan melalui "fungsi intrinsik prosesor ini". </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example1 </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example2</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tidak ada akses yang mudah untuk .NET dan C #, jadi </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">suatu</font></a><font style="vertical-align: inherit;"> kali saya membuat pembungkus saya sendiri, yang menyediakan emulasi dari fungsi-fungsi tersebut, tetapi jika CPU mendukungnya, saya mengganti panggilan mereka langsung dalam kode panggilan. Untungnya, sebagian besar intrinsik yang saya butuhkan ditempatkan dalam 5 byte dari CALL opcode. Detail dapat dibaca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di hub di tautan ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bertahun-tahun telah berlalu sejak itu, dalam. NET intrinsik normal tidak pernah muncul. Tapi .NET Core keluar, di mana situasinya diperbaiki. Pertama datang instruksi vektor, kemudian hampir seluruh set * </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Runtime.Intrinsics.X86</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* - tidak ada BSF dan BSR yang "ketinggalan jaman."</font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dan semuanya tampak bagus dan nyaman. Kecuali bahwa definisi dukungan untuk setiap set instruksi selalu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">membingungkan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (beberapa termasuk segera oleh set, untuk beberapa ada tanda yang terpisah). Jadi .NET Core lebih membingungkan kita dengan fakta bahwa ada juga beberapa dependensi antara set "yang diizinkan".</font></font><br>
 <a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini muncul ketika saya mencoba menjalankan kode pada mesin virtual dengan hypervisor KVM: kesalahan jatuh </font></font><code>System.PlatformNotSupportedException: Operation is not supported on this platform at System.Runtime.Intrinsics.X86.Bmi1.X64.TrailingZeroCount(UInt64 value)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Demikian pula untuk System.Runtime.Intrinsics.X86.Popcnt.X64.PopCount. Tetapi jika untuk POPCNT dimungkinkan untuk menempatkan flag yang cukup jelas dalam parameter virtualisasi, maka TZCNT membawa saya ke jalan buntu. Pada gambar berikut, output dari alat yang memeriksa ketersediaan intrinsik di netcore (kode dan biner di akhir artikel) dan CPU-Z yang terkenal: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nq/ag/hf/nqaghfegcpctyxd2v5ajx-j1uqo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan di sini adalah output dari alat yang diambil dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">halaman MSDN tentang CPUID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ft/c3/40/ftc340p3u_wetlxem38ekx2adji.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terlepas dari kenyataan bahwa prosesor melaporkan dukungan untuk semuanya diperlukan, instruksi </font></font><code>Intrinsics.X86.Bmi1.X64.TrailingZeroCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">masih terus jatuh dengan eksekusi </font></font><code>System.PlatformNotSupportedException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengetahuinya, kita perlu melihat prosesor melalui mata NETCore. Sumber mana yang ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mari kita mencari dewa asmara di sana dan pergi ke metode.Ada </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">EEJitManager::SetCpuInfo</a>()</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
banyak kondisi yang berbeda di dalamnya, dan beberapa dari mereka bersarang. Saya mengambil metode ini dan menyalinnya ke proyek kosong. Selain itu, saya harus mengambil beberapa metode lain dan seluruh file assembler ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cara menambahkan ASM ke studio baru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Hasil eksekusi: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/el/ef/yj/elefyj0jemau4g5xysaupsusymo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang Anda lihat, bendera </font></font><code>InstructionSet_BMI1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">masih disetel (walaupun beberapa lainnya tidak disetel). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda mencari bendera ini di repositori, Anda dapat menemukan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kode ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">if</span> (resultflags.HasInstructionSet(InstructionSet_BMI1) &amp;&amp; !resultflags.HasInstructionSet(InstructionSet_AVX))<font></font>
    resultflags.RemoveInstructionSet(InstructionSet_BMI1);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, dia adalah kecanduan kita! </font><font style="vertical-align: inherit;">Jika AVX tidak didefinisikan, maka BMI1 (dan beberapa set lainnya) dinonaktifkan. </font><font style="vertical-align: inherit;">Apa logikanya, belum jelas bagi saya, tapi kami harap itu masih ada. </font><font style="vertical-align: inherit;">Sekarang masih mengerti mengapa cpu-z dan alat-alat lain melihat AVX, tetapi netcore tidak. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat bagaimana output alat kami pada prosesor yang berbeda berbeda:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;diff a b<font></font>
7c7,8<font></font>
&lt; Test ((buffer[8] &amp; 0x02) != 0) -&gt; 0<font></font>
---<font></font>
&gt; Test ((buffer[8] &amp; 0x02) != 0) -&gt; 1<font></font>
&gt; ==&gt; Set InstructionSet_PCLMULQDQ<font></font>
18c19,32<font></font>
&lt; Test ((buffer[11] &amp; 0x18) == 0x18) -&gt; 0<font></font>
---<font></font>
&gt; Test ((buffer[11] &amp; 0x18) == 0x18) -&gt; 1<font></font>
&gt; Test (hMod == NULL) -&gt; 0<font></font>
&gt; Test (pfnGetEnabledXStateFeatures == NULL) -&gt; 0<font></font>
&gt; Test ((FeatureMask &amp; XSTATE_MASK_AVX) == 0) -&gt; 0<font></font>
&gt; Test (DoesOSSupportAVX() &amp;&amp; (xmmYmmStateSupport() == 1)) -&gt; 1<font></font>
&gt; Test (hMod == NULL) -&gt; 0<font></font>
&gt; Test (pfnGetEnabledXStateFeatures == NULL) -&gt; 0<font></font>
&gt; Test ((FeatureMask &amp; XSTATE_MASK_AVX) == 0) -&gt; 0<font></font>
&gt; ==&gt; Set InstructionSet_AVX<font></font>
&gt; Test ((buffer[9] &amp; 0x10) != 0) -&gt; 1<font></font>
&gt; ==&gt; Set InstructionSet_FMA<font></font>
&gt; Test (maxCpuId &gt;= 0x07) -&gt; 1<font></font>
&gt; Test ((buffer[4] &amp; 0x20) != 0) -&gt; 1<font></font>
&gt; ==&gt; Set InstructionSet_AVX2</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buffer cek [8] &amp; 0x02 gagal, ini PCLMULQDQ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buffer [11] &amp; 0x18 gagal, itu adalah AVX &amp; OSXSAVE, AVX sudah diatur (CPU-Z melihat ini), OSXSAVE diperlukan</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan di belakangnya ada cek lain yang mengarah ke flag InstructionSet_AVX</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lalu apa yang harus dilakukan dengan virus? </font><font style="vertical-align: inherit;">Jika memungkinkan, yang terbaik adalah menempatkan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libvirt.cpu_mode di host-passthrough atau host-model</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi jika ini tidak memungkinkan, maka Anda harus menambahkan semua sup dari instruksi, khususnya </font></font><code>ssse3, sse4.1, sse4.2, sse4a, popcnt, abm, bmi1, bmi2, avx, avx2, osxsave, xsave, pclmulqdq</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Di sini saya mengucapkan salam dan terima kasih</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vdsina_m</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan Anda dapat memeriksa host atau mesin virtual Anda untuk dukungan instruksi dan bagaimana .NET Core melihatnya dengan bantuan alat ini: (untuk saat ini, zip, saya akan mempostingnya ke github nanti).</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Binari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">core_intrin_check.bin.win64.zip</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sumber </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">core_intrin_check.source.zip</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id495452/index.html">Cara menyiapkan situs untuk pertumbuhan beban</a></li>
<li><a href="../id495454/index.html">Pengantar singkat tentang BPF dan eBPF</a></li>
<li><a href="../id495456/index.html">Tinjau 14 plugin baru untuk Figma yang akan membantu meningkatkan produktivitas sementara kita semua</a></li>
<li><a href="../id495458/index.html">Cara menulis kode ketika anak-anak berlarian di sekitar Anda dan bertanya: "Untuk apa Anda bekerja?"</a></li>
<li><a href="../id495460/index.html">Gelembung gas 22.000 kali ukuran Bumi meledak di Uranus</a></li>
<li><a href="../id495464/index.html">Pesan informasi 404 - tidak hanya kesalahan, tetapi juga hari libur</a></li>
<li><a href="../id495466/index.html">Perangkap hacker. Mendeteksi peretasan dini dengan Canarytokens</a></li>
<li><a href="../id495468/index.html">Algoritma pengenalan tag harga yang bekerja bahkan pada terminal pengumpulan data</a></li>
<li><a href="../id495472/index.html">Beralih ke vegetarian tidak akan mencegah orang terinfeksi dari penyakit seperti COVID-19</a></li>
<li><a href="../id495474/index.html">DataGrip 2020.1: Luncurkan konfigurasi, ekspor ke Excel, hasil dalam editor dan banyak lagi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>