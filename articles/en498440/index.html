<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ôüèæ ü§∏üèø ‚ùî Threat Spotlight: Neshta File Virus üõ§Ô∏è üôÖüèΩ üë®üèæ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salute, Khabrovites! In anticipation of the start of the course "Reverse Engineering 2.0" we want to share with you another interesting translation.
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Threat Spotlight: Neshta File Virus</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/498440/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salute, Khabrovites! </font><font style="vertical-align: inherit;">In anticipation of the start of the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Reverse Engineering 2.0"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we want to share with you another interesting translation.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/4o/rr/vj/4orrvjo2adqibw_f95jjzcd-s2w.png"><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Short review</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neshta is a fairly old file virus that is still widespread. It was originally discovered in 2003 and was previously associated with BlackPOS malware. It adds malicious code to infected files. Basically, this threat enters the environment through unintentional downloads or other malicious programs. It infects Windows executable files and can attack network resources and removable media.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2018, Neshta focused primarily on manufacturing, but also attacked the financial, consumer and energy sectors. </font><font style="vertical-align: inherit;">For stability reasons, Neshta renames itself to svchost.com, and then modifies the registry so that it starts every time the .exe file is launched. </font><font style="vertical-align: inherit;">It is known that this threat collects system information and uses POST requests to exfiltrate data on servers controlled by attackers. </font><font style="vertical-align: inherit;">The Neshta binaries used in our analysis did not demonstrate data exfiltration behavior or functionality.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Technical analysis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This section describes the symptoms of Neshta infection. </font><font style="vertical-align: inherit;">We took virus samples uploaded to VirusTotal in 2007, 2008 and 2019. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We analyzed files with the following SHA-256 hashes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">29fd307edb4cfa4400a586d38116a90ce91233a3fc277de1cab7890e681c409a</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">980bac6c9afe8efc9c6fe459a5f77213b0d8524eb00de82437288eb96138b9a2</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">539452719c057f59238e123c80a0a10a0b577c4d8af7a5447903955e6cf7aa3d</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a4d0865565180988c3d9dbf5ce35b7c17bac6458ef234cfed82b4664116851f2</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">46200c11811058e6d1173a2279213d0b7ccde611590e427b3b28c0f684192d00</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c965f9503353ecd6971466d32c1ad2083a5475ce64aadc0b99ac13e2d2c31b75</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Static file analysis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neshta code compiled with Borland Delphi 4.0. </font><font style="vertical-align: inherit;">The file size is usually 41,472 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Like any Delphi binary, Neshta has four writable (DATA, BSS, .idata and .tls) and three shared sections (.rdata, .reloc and .rsrc): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ba/hw/dv/bahwdvmmkawtkraqe7nqrfza54w.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 1. Features of the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section headers </font><i><font style="vertical-align: inherit;">. </font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, the Neshta code shows interesting lines - see Figure 2 below:</font></font><br>
 <br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúDelphi-the best. </font><font style="vertical-align: inherit;">F *** off all the rest. </font><font style="vertical-align: inherit;">Neshta 1.0 Made in Belarus. </font><font style="vertical-align: inherit;">We are holding the ~ Tsikav ~ Belarus_kim jiauchatam. </font><font style="vertical-align: inherit;">Alyaksandr Rygoravich, you are a taxama :) Vosen-kepsky couple ... Alivarya - make beer! </font><font style="vertical-align: inherit;">Best regards 2 Tommy Salo. </font><font style="vertical-align: inherit;">[Nov-2005] yours [Dziadulja Apanas] ‚Äù </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(‚Äú Delphi is the best. The rest go to ***. Neshta 1.0 Made in Belarus. Hello to all ~ interesting ~ Belarusian girls. Alyaksandr Grigoryevich, you too :) Autumn is a bad couple ... Alivaria is the best beer! </font><font style="vertical-align: inherit;">Best wishes for Tommy Salo. </font><font style="vertical-align: inherit;">[November 2005] your [Grandpa Apanas]) "</font></font></i></blockquote><br>
<br>
<img src="https://habrastorage.org/webt/2y/kb/nk/2ykbnkxk71ap_flvne4kbodpdau.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2: Interesting lines in the body of the virus</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File infection</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main feature of Neshta is a file intruder that searches for .exe files on local drives. </font><font style="vertical-align: inherit;">Neshta targets ".exe" files, excluding only those that contain any of the following lines in their shortcut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% Temp%</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% SystemRoot% (usually C: \ Windows)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ PROGRA ~ 1 \</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A summary of the infection process is described below and in Figure 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neshta:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reads 41,472 (0xA200) bytes from the beginning of the target source file.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creates two partitions and allocates memory with the PAGE_READWRITE attribute at the beginning and end of the source file.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puts its malicious header and code at the beginning of the source file. </font><font style="vertical-align: inherit;">The recorded data is 41,472 bytes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writes the encoded source header and code to a file that is 41.472 bytes in size.</font></font></li>
</ol><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These actions allow you to run malicious code immediately after launching the infected file: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cq/ti/0p/cqti0pu9yx7cgae1unwrkbg5zcm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 3: File infection</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When the infected file is launched, the source program is placed in </font></font><code><code>%Temp%\3582-490\&lt;filename&gt;</code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and launched using the WinExec API.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sustainability</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neshta puts itself in </font></font><code>C:\Windows\svchost.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and installs itself in the registry using the following parameters: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Registry key: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HKLM \ SOFTWARE \ Classes \ exefile \ shell \ open \ command</font></font></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Registry value: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Default)</font></font></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Value: </font></font><code>%SystemRoot%\svchost.com "%1" %*</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This registry change tells the system to start Neshta every time .exe is run. file. </font><font style="vertical-align: inherit;">"% 1"% * indicates the running .exe file. </font><font style="vertical-align: inherit;">In addition, Neshta creates a named mutex to check for the existence of another working instance: </font></font><br>
<br>
<code>MutexPolesskayaGlush*.*&lt;0x90&gt;svchost.com&lt;0x90&gt;exefile\shell\open\command‚Äπ√Ä "%1" %*≈ì‚Äò@</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another injected file is ‚Äúdirectx.sys‚Äù, which is sent to% SystemRoot%. </font><font style="vertical-align: inherit;">This is a text file (not a kernel driver) that contains the path to the last infected file to run. </font><font style="vertical-align: inherit;">It is updated every time an infected file is executed.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BlackBerry Cylance stops Neshta</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BlackBerry Cylance uses AI-based agents trained to detect threats on millions of both safe and insecure files. </font><font style="vertical-align: inherit;">Our automated security agents block Neshta based on a variety of file attributes and malicious behavior, rather than relying on a specific file signature. </font><font style="vertical-align: inherit;">BlackBerry Cylance, which offers a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">predictive advantage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> over zero-day threats, is trained and effective against new and known cyber attacks. </font><font style="vertical-align: inherit;">For more information, visit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.cylance.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application</font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compromise Indicators (IOCs)</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hashes</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
29fd307edb4cfa4400a586d38116a90ce91233a3fc277de1cab7890e681c409a o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o 980bac6c9afe8efc9c6fe459a5f77213b0d8524eb00de82437288eb96138b9a2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o 539452719c057f59238e123c80a0a10a0b577c4d8af7a5447903955e6cf7aa3d </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o a4d0865565180988c3d9dbf5ce35b7c17bac6458ef234cfed82b4664116851f2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o 46200c11811058e6d1173a2279213d0b7ccde611590e427b3b28c0f684192d00 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o c965f9503353ecd6971466d32c1ad2083a5475ce64aadc0b99ac13e2d2c31b75</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File names</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o% SystemRoot% \ svchost.com </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o% SystemRoot% \ directx.sys </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o% Temp% \ tmp5023.tmp</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C2s / IPs</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mutexes</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o MutexPolesskayaGlush *. * &lt;0x90&gt; svchost.com &lt;0x90&gt; exefile \ shell \ open \ command ‚Äπ√Ä"% 1 "% * ≈ì '@</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interesting lines</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o Delphi-the best. </font><font style="vertical-align: inherit;">F ** k off all the rest. </font><font style="vertical-align: inherit;">Neshta 1.0 Made in Belarus. </font><font style="vertical-align: inherit;">We are holding the ~ Tsikav ~ Belarus_kim jiauchatam. </font><font style="vertical-align: inherit;">Alyaksandr Rygoravich, you are a taxama :) Vosen-kepsky couple ... Alivarya - make beer! </font><font style="vertical-align: inherit;">Best regards 2 Tommy Salo. </font><font style="vertical-align: inherit;">[Nov-2005] yours [Dziadulja Apanas]</font></font><br>
 <br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sha256</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">29fd307edb4cfa4400a586d38116a90ce91233a3fc277de1cab7890e681c409a</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a type</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pe32 executable (gui) intel 80386, for ms windows</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the size</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41472</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">timestamp</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1992: 06: 20 07: 22: 17 + 09: 00</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">itw</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">svchost [.] com</font></font></td>
</tr>
</tbody></table></div><br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn more about the course.</font></font></a><br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498426/index.html">How we evacuated the duty shift of Yandex</a></li>
<li><a href="../en498428/index.html">WAL-G: new features and community expansion. Georgy Rylov</a></li>
<li><a href="../en498430/index.html">What happens to transport on April 22</a></li>
<li><a href="../en498436/index.html">GitLab CI / CD Guide for the (almost) Absolute Beginner</a></li>
<li><a href="../en498438/index.html">8 easy questions for internship mentors</a></li>
<li><a href="../en498442/index.html">Comprehensive Static Analysis Using Polyspace Products</a></li>
<li><a href="../en498444/index.html">Monitoring in the data center: how we changed the old BMS to a new one. Part 2</a></li>
<li><a href="../en498446/index.html">Job Questions: Imaginary Stability, False Devotion and Positioning</a></li>
<li><a href="../en498450/index.html">MultiSim redundancy - what it is and how it works</a></li>
<li><a href="../en498452/index.html">Django: A Quick Guide to Internationalization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>