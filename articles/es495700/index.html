<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿 👨‍👨‍👧‍👦 😖 Doom Boy ESP32 👨🏿‍⚕️ ♋️ 👩🏼‍🎤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Doom prefijo para ESP32 hágalo usted mismo en el controlador MCP23017 para botones de UncleRus
 
 
 
 En previsión de las horas de Doom , llegó la jun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Doom Boy ESP32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495700/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doom prefijo para ESP32 hágalo usted mismo en el controlador MCP23017 para botones de UncleRus</font></font><br>
<br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/e_/br/13/e_br13t_nva7dv5lrbr8b9-8rpo.jpeg"></div><br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/it/_4/wj/it_4wjuhc9m8api63gzolghcwlq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En previsión de las </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">horas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Doom</font></a><font style="vertical-align: inherit;"> , llegó la junta de un proyecto de larga data. </font><font style="vertical-align: inherit;">El MCP23017 externo y el CS4344 y muchas otras cosas están divorciados en la placa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para los botones, se utiliza el expansor de puerto MCP23017 conectado a través de I2C. </font><font style="vertical-align: inherit;">Para él hay un controlador que puede obtener de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UncleRus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se intentó lanzar un ADC CS4344 externo.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doom de Espressif</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de descargar el puerto, Doom tuvo que jugar un poco para recogerlo. </font><font style="vertical-align: inherit;">Al final, todo se unió y se inundó en ESP32 pero ... me sorprendí al principio. </font><font style="vertical-align: inherit;">En el tema de githab del proyecto, vi una discusión similar sobre el problema: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vy/cp/kj/vycpkjmc1qkwolkxdlxsvcutgqu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
el autor del puerto sugirió hacer</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablemente necesite usar la opción malloc (), así como reservar algo de memoria para DMA. </font><font style="vertical-align: inherit;">Veré si puedo obtener esta compilación en master y actualizar el sdkconfig cuando tenga tiempo.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En general, "sin pensarlo dos veces" reemplacé todas las funciones de asignación de memoria portadas con malloc (). La </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
demostración comenzó. </font><font style="vertical-align: inherit;">Delante de mí estaba conectando botones</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extensor GPIO MCP23017</font></font></h3><br>
<img src="https://habrastorage.org/webt/a8/e0/zx/a8e0zxgbcoljjm4vgecqqft5pxm.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCP23017</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Con grandes planes para expandir la funcionalidad a través de los puertos del controlador, decidí ahorrar un poco en los puertos de entrada / salida del microcontrolador instalando MCP23017. </font><font style="vertical-align: inherit;">Es un expansor simple con acceso a señales de entrada / salida a través de la interfaz I2C. </font><font style="vertical-align: inherit;">No inventé el controlador, sino que simplemente lo tomé de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UncleRus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cinco botones usan el joystick para navegar. </font><font style="vertical-align: inherit;">Un par de botones en la toma y selección de menú. </font><font style="vertical-align: inherit;">De hecho, esto no es suficiente, aún tiene que abrir las puertas y moverse hacia la izquierda y hacia la derecha sin girar, es decir, como un cangrejo. </font><font style="vertical-align: inherit;">Los hallazgos se extraen dentro del MCP23017 a VDD. </font><font style="vertical-align: inherit;">El contacto se cierra a tierra. </font><font style="vertical-align: inherit;">Es genial que haya resistencias pull-up dentro del microcircuito. </font><font style="vertical-align: inherit;">Todavía se puede confundir con las interrupciones del MCP23017. </font><font style="vertical-align: inherit;">Tiene dos pines para cada puerto, INTA e INTB, pero de alguna manera en otro momento.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lista completa de equipos</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> JsKeyMap keymap[]={<font></font>
	{<span class="hljs-number">0x10</span>, &amp;key_up},<font></font>
	{<span class="hljs-number">0x40</span>, &amp;key_down},<font></font>
	{<span class="hljs-number">0x80</span>, &amp;key_left},<font></font>
	{<span class="hljs-number">0x20</span>, &amp;key_right},<font></font>
	<font></font>
	{<span class="hljs-number">0x4000</span>, &amp;key_use},				<span class="hljs-comment">//cross</span>
	{<span class="hljs-number">0x2000</span>, &amp;key_fire},			<span class="hljs-comment">//circle</span>
	{<span class="hljs-number">0x2000</span>, &amp;key_menu_enter},		<span class="hljs-comment">//circle</span>
	{<span class="hljs-number">0x8000</span>, &amp;key_pause},			<span class="hljs-comment">//square</span>
	{<span class="hljs-number">0x1000</span>, &amp;key_weapontoggle},	<span class="hljs-comment">//triangle</span><font></font>
<font></font>
	{<span class="hljs-number">0x8</span>, &amp;key_escape},				<span class="hljs-comment">//start</span>
	{<span class="hljs-number">0x1</span>, &amp;key_map},				<span class="hljs-comment">//select</span><font></font>
	<font></font>
	{<span class="hljs-number">0x400</span>, &amp;key_strafeleft},		<span class="hljs-comment">//L1</span>
	{<span class="hljs-number">0x100</span>, &amp;key_speed},			<span class="hljs-comment">//L2</span>
	{<span class="hljs-number">0x800</span>, &amp;key_straferight},		<span class="hljs-comment">//R1</span>
	{<span class="hljs-number">0x200</span>, &amp;key_strafe},			<span class="hljs-comment">//R2</span><font></font>
<font></font>
	{<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>},<font></font>
};</code></pre><br>
</div>
                    </div><br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> más fácil </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">cortar el procesamiento de botones</font></a><font style="vertical-align: inherit;"> de lo que pensaba. </font><font style="vertical-align: inherit;">Bajé la frecuencia de I2C para mejorar la estabilidad. </font><font style="vertical-align: inherit;">En cualquier caso, el 1MHz declarado no fue. </font><font style="vertical-align: inherit;">La frecuencia de 100 kHz fue suficiente para sondear en un ciclo con un retraso de 20 ms.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perdí mucho tiempo agregando CMakeList.txt para componentes. </font><font style="vertical-align: inherit;">Algo no funcionó con make. </font><font style="vertical-align: inherit;">Y quería tomar un SDK más fresco. </font><font style="vertical-align: inherit;">El puerto original ni siquiera iba a 3.2.x. </font><font style="vertical-align: inherit;">Tomó esp-idf-v3.3.1 probablemente funcionará en esp-idf-4.0</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sonido a través del DAC</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En realidad hay otro </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tenedor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cuenta con una tarjeta SD conectada y sonido a través del DAC incorporado. El puerto original de Espressif le permite cargar un archivo wad solo en la memoria Flash interna de los programas, ¡y luego necesita usar un archivo cortado en el que no hay sonido! </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El esquema aquí</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
La idea de conectar un DAC externo en lugar del DAC incorporado me capturó. Al menos el centavo de Cirrus Logic. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ni/wl/cw/niwlcwgsprqestpufw2qfwjousq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego configuré el DAC en CS4344 y luego me decepcionó. El sonido funcionó con interrupciones. Cuando vi el archivo </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">i_sound.c</font></a><font style="vertical-align: inherit;"> en mi proyecto</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noté que no se usa un archivo dma.h. Como si hubiera un vínculo con él, y él mismo lo es, pero todo está comentado. Tal vez vi sin prestar atención? Pero creo que el autor también notó que algo estaba mal con el sonido y trató de eliminarlo. Quizás eliminado y no publicó el último commit. O tal vez todo funciona como debería en el DAC interno. Sin embargo, puede descuidar las interrupciones de distorsión para emitir sonido a través del DAC incorporado y a un pequeño altavoz. Jugué con bitrate y cambio de código general. No trajo nada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y sí, con respecto a la conexión de SD-CARD. Inicialmente, lo colgué en paralelo con la pantalla del bus SPI, separando por separado la señal de selección del chip CS. La idea falló. Al ventilar la pregunta </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, admite el uso compartido del bus SD-SPI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llegué a la conclusión de que no todas las tarjetas SD están hechas de la misma manera o que mis manos no son tan rectas. </font><font style="vertical-align: inherit;">Tuve que soldarlo a través del adaptador a la placa en lugar del micrófono. </font><font style="vertical-align: inherit;">Fue enrollado sin pull-ups por resistencias externas a VDD.</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resistencias internas manejadas</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><font></font>
    gpio_set_pull_mode(PIN_NUM_MOSI, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_MISO, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_CLK, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_CS, GPIO_PULLUP_ONLY);</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esto dejé esta lección y publiqué el código fuente en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sería necesario hacer otra edición de la placa de circuito impreso. </font><font style="vertical-align: inherit;">Este no es bueno!</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/TFE2ri2Zgu4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No hay sonido en el video. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y también tuve un contacto de joystick para girar cuando soldaba. </font><font style="vertical-align: inherit;">En general, el primer panqueque tiene bultos </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. </font><font style="vertical-align: inherit;">Logré </font><font style="vertical-align: inherit;">establecer un sonido. </font><font style="vertical-align: inherit;">Los idiotas están presentes, pero no son críticos. </font><font style="vertical-align: inherit;">Cambios de código: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
spi_lcd.c </font></font><br>
<code>dmamem[x]=heap_caps_malloc(MEM_PER_TRANS*2, MALLOC_CAP_DMA);</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
i_sound.c</font></font><br>
<code>void IRAM_ATTR updateTask(void *arg)<br>
{<br>
 // size_t bytesWritten;<br>
 while(1)<br>
 {<br>
 I_UpdateSound();<br>
 i2s_write(I2S_NUM_0, mixbuffer, SAMPLECOUNT*SAMPLESIZE, &amp;bytesWritten, portMAX_DELAY);<br>
 }<br>
}</code><br>
<br>
<code>.dma_buf_count = 2,<br>
 .dma_buf_len = 512,</code><br>
<br>
<code>xTaskCreatePinnedToCore(&amp;updateTask, "updateTask", 1000, NULL, 7, NULL, 0);</code></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495690/index.html">Conceptos de API de audio web</a></li>
<li><a href="../es495692/index.html">Bricolaje y código abierto para ayudar a los médicos</a></li>
<li><a href="../es495694/index.html">Servicio de referencia de aplicaciones móviles</a></li>
<li><a href="../es495696/index.html">Cómo Prince of Persia Creator supera los límites de memoria de Apple II</a></li>
<li><a href="../es495698/index.html">Arquitectura cliente-servidor en imágenes</a></li>
<li><a href="../es495702/index.html">Estudiamos el motor VoIP Mediastreamer2. Parte 1</a></li>
<li><a href="../es495704/index.html">Monitoreo de equipos de red a través de SNMPv3 en Zabbix</a></li>
<li><a href="../es495706/index.html">Noticias del mundo de OpenStreetMap No. 505 (03.17.2020-23.03.2020)</a></li>
<li><a href="../es495708/index.html">Servidor VPN de emergencia Openconnect con autorización de dos factores en Centos 8</a></li>
<li><a href="../es495712/index.html">Establecemos objetivos de desarrollo (en una empresa sangrienta y no solo)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>