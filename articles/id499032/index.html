<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🎓 🎤 🐇 Cara menggunakan Prometheus untuk mendeteksi anomali di GitLab 👨🏻‍🔬 📵 ☦️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salah satu fitur dasar dari bahasa permintaan Prometheus adalah agregasi waktu-nyata dari rangkaian waktu . Anda juga dapat menggunakan bahasa permint...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cara menggunakan Prometheus untuk mendeteksi anomali di GitLab</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salah satu fitur dasar dari bahasa permintaan Prometheus adalah agregasi </font><font style="vertical-align: inherit;">waktu-nyata </font><font style="vertical-align: inherit;">dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rangkaian waktu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Anda juga dapat menggunakan bahasa permintaan Prometheus untuk mendeteksi anomali dalam data deret waktu.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tim </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloud Solutions Mail.ru </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">telah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menerjemahkan </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">sebuah artikel oleh insinyur tim infrastruktur GitLab</font></a><font style="vertical-align: inherit;"> , di mana Anda akan menemukan contoh kode yang dapat Anda coba pada sistem Anda.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk apa deteksi anomali?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada empat alasan utama yang menentukan pentingnya deteksi anomali untuk GitLab:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagnostik Insiden</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : kami dapat mendeteksi layanan mana yang telah melampaui ruang lingkup normalnya dengan mengurangi waktu deteksi insiden (MTTD) dan, karenanya, menawarkan solusi yang lebih cepat untuk masalah tersebut.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deteksi penurunan kinerja</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : misalnya, jika regresi diperkenalkan ke layanan yang terlalu sering mengakses layanan lain, kami dapat dengan cepat mendeteksi dan memperbaiki masalah ini.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deteksi dan penghapusan pelanggaran</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : GitLab menyediakan mekanisme pengiriman dan integrasi ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) dan hosting (Halaman GitLab) dan sejumlah pengguna yang dapat menggunakan mekanisme ini.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keselamatan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Deteksi anomali penting untuk mendeteksi tren yang tidak biasa dalam seri waktu GitLab.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk alasan ini dan lainnya, penulis artikel memutuskan untuk mencari cara mengkonfigurasi definisi anomali dalam seri waktu GitLab menggunakan kueri dan aturan Prometheus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa tingkat agregasi yang benar?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, deret waktu harus dikumpulkan dengan benar. </font><font style="vertical-align: inherit;">Dalam contoh di bawah ini, kami menggunakan penghitung http_requests_total standar untuk mengambil data, meskipun banyak metrik lainnya juga akan melakukannya.</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metrik pengujian ini memiliki beberapa parameter: metode, pengontrol, kode status (status_code), lingkungan, ditambah parameter yang ditambahkan oleh Prometheus sendiri, misalnya, pekerjaan dan instance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang Anda harus memilih tingkat agregasi data yang tepat. </font><font style="vertical-align: inherit;">Terlalu banyak, terlalu sedikit - semua ini penting untuk mendeteksi anomali. </font><font style="vertical-align: inherit;">Jika data terlalu teragregasi, ada dua masalah potensial:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat melewati anomali karena agregasi menyembunyikan masalah yang terjadi pada himpunan bagian data Anda.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika Anda menemukan anomali, sulit untuk menghubungkannya dengan bagian yang terpisah dari sistem Anda tanpa upaya tambahan.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika data tidak cukup dikumpulkan, ini dapat menyebabkan peningkatan jumlah positif palsu, serta interpretasi yang salah dari data yang valid sebagai salah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berdasarkan pengalaman kami, tingkat agregasi yang paling benar adalah tingkat layanan, yaitu, kami menyertakan label pekerjaan (pekerjaan) dan lingkungan (lingkungan), dan membuang semua label lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agregasi, yang akan kita bahas di seluruh artikel, meliputi: job - http_request, agregasi - lima menit, yang dihitung berdasarkan pekerjaan dan lingkungan dalam lima menit.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari contoh di atas, jelas bahwa dari himpunan himpunan seri http_requests_total dipilih dalam konteks pekerjaan dan lingkungan, maka jumlah mereka dianggap selama lima menit.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan Z-score untuk mendeteksi anomali</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prinsip dasar statistik dapat diterapkan untuk mendeteksi anomali. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda mengetahui rata-rata dan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">standar deviasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari seri Prometheus, maka Anda dapat menggunakan sampel apa pun dalam seri untuk menghitung skor-z.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skor-Z adalah ukuran penyebaran relatif dari nilai yang diamati atau diukur, yang menunjukkan berapa banyak </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">standar deviasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> penyebarannya relatif terhadap nilai </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rata</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">rata</font></a><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yaitu, skor-z = 0 berarti skor-z identik dengan nilai rata-rata dalam dataset dengan distribusi standar, dan skor-z = 1 berarti bahwa standar deviasi = 1,0 dari rata-rata.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami berasumsi bahwa data dasar memiliki distribusi normal, yang berarti bahwa 99,7% sampel memiliki skor-z dari 0 hingga 3. Semakin jauh skor-z dari nol, semakin kecil kemungkinannya untuk ada.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menerapkan properti ini untuk mendeteksi anomali dalam seri data Prometheus:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menghitung mean dan standar deviasi untuk metrik menggunakan data dengan ukuran sampel yang besar. </font><font style="vertical-align: inherit;">Untuk contoh ini, kami menggunakan data mingguan. </font><font style="vertical-align: inherit;">Jika kita menganggap bahwa catatan dievaluasi satu menit sekali, maka dalam seminggu kita akan memiliki lebih dari 10.000 sampel.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kita dapat menghitung skor-z untuk kueri Prometheus segera setelah kita mendapatkan mean dan standar deviasi untuk agregasi.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berdasarkan prinsip statistik distribusi normal, anggaplah bahwa nilai apa pun di luar kisaran +3 hingga -3 akan menjadi anomali. </font><font style="vertical-align: inherit;">Dengan demikian, kita dapat membuat peringatan tentang anomali semacam itu. </font><font style="vertical-align: inherit;">Misalnya, kami akan menerima peringatan ketika agregasi kami melampaui rentang ini selama lebih dari lima menit.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafik jumlah permintaan per detik ke layanan Halaman GitLab selama 48 jam. </font><font style="vertical-align: inherit;">Skor-Z dalam kisaran dari +3 hingga -3 disorot dalam warna</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
hijau.Z-skor dapat menjadi sulit untuk ditafsirkan pada grafik, karena nilai ini tidak memiliki unit pengukuran. </font><font style="vertical-align: inherit;">Tetapi anomali dalam grafik ini sangat sederhana untuk ditentukan. </font><font style="vertical-align: inherit;">Segala sesuatu yang melampaui zona hijau, yang menunjukkan koridor nilai dengan skor-z dari -3 hingga +3, akan menjadi nilai anomali.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang harus dilakukan jika distribusi data tidak normal</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami berasumsi bahwa distribusi data adalah normal. </font><font style="vertical-align: inherit;">Kalau tidak, skor-z kami akan salah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada banyak trik statistik untuk menentukan normalitas distribusi data, tetapi cara terbaik adalah memeriksa bahwa data Anda z-skor terletak di kisaran -4,0 hingga +4,0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dua kueri Prometheus yang menunjukkan skor-z minimum dan maksimum:</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika hasil Anda berada dalam kisaran -20 hingga +20, ini berarti bahwa terlalu banyak data telah digunakan dan hasilnya terdistorsi. </font><font style="vertical-align: inherit;">Ingat juga bahwa Anda harus bekerja dengan baris teragregasi. </font><font style="vertical-align: inherit;">Metrik yang tidak memiliki distribusi normal mencakup parameter seperti tingkat kesalahan, penundaan, panjang antrian, dan sebagainya. </font><font style="vertical-align: inherit;">Tetapi banyak dari metrik ini akan bekerja lebih baik dengan ambang waspada tetap.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deteksi anomali musiman berdasarkan statistik</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meskipun penghitungan skor-z berfungsi baik dengan distribusi normal data deret waktu, ada metode kedua yang dapat memberikan hasil deteksi anomali yang lebih akurat. </font><font style="vertical-align: inherit;">Ini adalah penggunaan musiman statistik.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Musiman adalah karakteristik dari metrik seri waktu ketika metrik ini mengalami perubahan reguler dan dapat diprediksi yang diulang dalam setiap siklus.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagan permintaan per detik (RPS) dari Senin hingga Minggu selama empat minggu berturut-turut</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Bagan di atas menggambarkan RPS (jumlah permintaan per detik) selama tujuh hari - dari Senin hingga Minggu, selama empat minggu berturut-turut. </font><font style="vertical-align: inherit;">Rentang tujuh hari ini disebut "offset", yaitu pola yang akan digunakan untuk pengukuran. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap minggu pada tabel adalah warna yang berbeda. </font><font style="vertical-align: inherit;">Musiman data ditunjukkan oleh urutan tren yang ditunjukkan pada grafik - setiap Senin pagi kami mengamati peningkatan RPS yang serupa, dan pada malam hari Jumat kami selalu mengamati penurunan RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan menggunakan musiman dalam data deret waktu kami, kami dapat lebih akurat memprediksi terjadinya anomali dan deteksi mereka.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara menggunakan musiman</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometheus menggunakan beberapa mekanisme statistik yang berbeda untuk menghitung musiman. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami membuat perhitungan, menambahkan tren pertumbuhan untuk minggu ke hasil minggu sebelumnya. Tren pertumbuhan dihitung sebagai berikut: kurangi rata-rata bergerak untuk minggu terakhir dari rata-rata bergerak selama seminggu terakhir.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; — job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Iterasi pertama ternyata agak "sempit" - kami menggunakan jendela lima menit minggu ini dan minggu sebelumnya untuk mendapatkan perkiraan kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada iterasi kedua, kami memperluas cakupan kami dengan mengambil rata-rata periode empat jam untuk minggu sebelumnya dan membandingkannya dengan minggu ini.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, jika kami mencoba memprediksi nilai metrik pada pukul delapan pagi pada hari Senin, alih-alih jendela lima menit yang sama pada minggu sebelumnya, kami mengambil nilai rata-rata metrik dari enam menjadi sepuluh pada pagi hari Senin sebelumnya.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permintaan menunjukkan 166 jam, yaitu dua jam kurang dari seminggu penuh (7 * 24 = 168), karena kami ingin menggunakan periode empat jam berdasarkan waktu saat ini, jadi kami perlu offset menjadi dua jam kurang dari seminggu penuh.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPS nyata (kuning) dan diprediksi (biru) dalam dua minggu</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
. Perbandingan RPS aktual dengan perkiraan kami menunjukkan bahwa perhitungan kami cukup akurat. Namun, metode ini memiliki kelemahan. </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, 1 Mei, GitLab digunakan kurang dari biasanya pada hari Rabu, karena hari ini adalah hari libur. Karena tren pertumbuhan yang diperkirakan tergantung pada bagaimana sistem itu digunakan pada minggu sebelumnya, perkiraan kami untuk minggu berikutnya, yaitu, pada hari Rabu, 8 Mei, memberikan RPS yang lebih rendah daripada yang sebenarnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kesalahan ini dapat diperbaiki dengan membuat tiga perkiraan selama tiga minggu berturut-turut sebelum Rabu, 1 Mei, yaitu tiga hari Rabu sebelumnya. Permintaannya tetap sama, tetapi offsetnya disesuaikan.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada tiga perkiraan pada grafik selama tiga minggu sebelum 8 Mei, dibandingkan dengan RPS yang sebenarnya untuk Rabu, 8 Mei. Anda dapat melihat bahwa kedua ramalan itu sangat akurat, tetapi ramalan untuk minggu 1 Mei tetap tidak akurat.Selain</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
itu, kita tidak memerlukan tiga ramalan, kita memerlukan satu ramalan. Nilai rata-rata bukan pilihan, karena akan dikaburkan oleh data RPS kami yang terdistorsi mulai 1 Mei. Sebagai gantinya, Anda perlu menghitung median. Prometheus tidak memiliki kueri median, tetapi kita bisa menggunakan agregasi kuantil alih-alih median. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Satu-satunya masalah adalah bahwa kami mencoba untuk memasukkan tiga seri dalam agregasi, dan tiga seri ini sebenarnya seri yang sama dalam tiga minggu. Dengan kata lain, mereka memiliki label yang sama, jadi sulit untuk menyatukannya.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menghindari kebingungan, kami membuat label yang disebut offset dan menggunakan fungsi ganti label untuk menambahkan offset pada masing-masing tiga minggu. </font><font style="vertical-align: inherit;">Kemudian dalam agregasi kuantil kita membuang label-label ini, dan ini memberi kita rata-rata tiga.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang perkiraan kami dengan median tiga agregasi telah menjadi lebih akurat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perkiraan median versus RPS aktual</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara mengetahui bahwa perkiraan kami benar-benar akurat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memeriksa keakuratan ramalan, kita dapat kembali ke skor-z. </font><font style="vertical-align: inherit;">Ini digunakan untuk mengukur perbedaan sampel dengan perkiraan dalam standar deviasi. </font><font style="vertical-align: inherit;">Semakin besar standar deviasi dari perkiraan, semakin tinggi kemungkinan bahwa nilai tertentu adalah outlier.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kisaran deviasi yang diproyeksikan adalah dari +1.5 ke -1.5.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Anda dapat mengubah grafik Grafana kami untuk menggunakan perkiraan musiman, daripada rata-rata bergerak mingguan. </font><font style="vertical-align: inherit;">Kisaran nilai normal untuk waktu tertentu dalam sehari diarsir dalam warna hijau. </font><font style="vertical-align: inherit;">Segala sesuatu yang melampaui zona hijau dianggap sebagai pencilan. </font><font style="vertical-align: inherit;">Dalam hal ini, pencilan terjadi pada hari Minggu sore, ketika penyedia cloud kami mengalami beberapa masalah jaringan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merupakan praktik yang baik untuk menggunakan skor ± 2 z untuk prakiraan musiman.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara mengatur peringatan dengan Prometheus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda ingin mengatur peringatan untuk kejadian abnormal, Anda dapat menerapkan aturan Prometheus yang cukup sederhana, yang memeriksa apakah skor-z indikator berada dalam kisaran antara +2 dan -2.</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di GitLab, kami menggunakan aturan perutean kustom yang mengirimkan peringatan melalui Slack ketika mendeteksi anomali, tetapi tidak menghubungi tim dukungan kami.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara mendeteksi anomali di GitLab menggunakan Prometheus</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus dapat digunakan untuk mendeteksi beberapa kelainan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregasi yang tepat adalah kunci untuk menemukan anomali.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skor Z efektif jika data Anda memiliki distribusi normal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statistik musiman adalah mekanisme yang kuat untuk mendeteksi anomali.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diterjemahkan dengan dukungan dari </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masih bermanfaat</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metode Caching Sederhana di GitLab CI: Panduan Gambar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alat GitLab CE yang dibuat dan dikustomisasi di pasar MCS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saluran Telegram kami tentang transformasi digital</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id499014/index.html">23 pertanyaan sulit untuk wawancara JavaScript</a></li>
<li><a href="../id499016/index.html">Integrasi dengan ESIA untuk .Net: lebih mudah daripada yang terdengar</a></li>
<li><a href="../id499018/index.html">6 aplikasi olahraga rumah</a></li>
<li><a href="../id499020/index.html">Sebuah studi tentang satu perilaku yang tidak jelas</a></li>
<li><a href="../id499030/index.html">Memantau kinerja MySQL untuk Grafana pada isic dalam 20 menit</a></li>
<li><a href="../id499034/index.html">Bagaimana cara meluncurkan refactoring berbahaya ke prod dengan sejuta pengguna?</a></li>
<li><a href="../id499036/index.html">Pekerjaan penyedia: pilihan bahan pada protokol, TI dan infrastruktur jaringan</a></li>
<li><a href="../id499038/index.html">Pengalaman saya menggunakan monitor vertikal</a></li>
<li><a href="../id499040/index.html">Baca di akhir pekan: pilihan materi tentang sejarah DNS, regulasi TI, dan perangkat keras 1cloud.ru</a></li>
<li><a href="../id499044/index.html">Berita dari dunia OpenStreetMap No. 508 (04/07/2020/13/04/2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>