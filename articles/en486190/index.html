<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>❤️ 🔟 👋🏻 Our experience in developing a CSI driver in Kubernetes for Yandex.Cloud 🏐 💪🏿 🆚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are pleased to announce that Flant is replenishing its contribution to the Open Source tools for Kubernetes by releasing an alpha version of the CS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Our experience in developing a CSI driver in Kubernetes for Yandex.Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/486190/"><img src="https://habrastorage.org/webt/1y/to/tn/1ytotnf73zepbwfalhzoropf9qa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are pleased to announce that Flant is replenishing its contribution to the Open Source tools for Kubernetes by releasing an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alpha version of the CSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Container Storage Interface) </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">driver</font></a><font style="vertical-align: inherit;"> for Yandex.Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But before moving on to the implementation details, we’ll answer the question of why this is needed at all when Yandex already has the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Managed Service for Kubernetes service</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why is this?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inside our company, from the very beginning of the operation of Kubernetes in production (i.e. for several years), our own tool (deckhouse) is developing, which, by the way, we also plan to make available as an Open Source project in the near future. With its help, we uniformly configure and configure all our clusters, and at the moment there are more than 100 of them, moreover, on the most various configurations of iron and in all available cloud services.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Clusters using deckhouse have all the necessary components for work: balancers, monitoring with convenient charts, metrics and alerts, user authentication through external providers to access all dashboards, and so on. </font><font style="vertical-align: inherit;">It makes no sense to put such a “pumped-up” cluster into a managed solution, as it is often either impossible or will lead to the need to disable half of the components. </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : This is our experience, and it is quite specific. </font><font style="vertical-align: inherit;">By no means do we claim that everyone should independently engage in Kubernetes cluster deployment instead of using ready-made solutions. </font><font style="vertical-align: inherit;">By the way, we have no real experience in operating Kubernetes from Yandex and we will not give any assessment of this service in this article.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is it and for whom?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we already talked about the modern approach to storage in Kubernetes: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how CSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> works </font><font style="vertical-align: inherit;">and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how the community came</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to this approach. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Currently, many large cloud service providers have developed drivers for using their cloud drives as a Persistent Volume in Kubernetes. If the supplier does not have such a driver, but at the same time all the necessary functions are provided through the API, then nothing prevents you from implementing the driver on your own. And so it happened with Yandex.Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a basis for development, we took the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSI driver for the DigitalOcean cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and a couple of ideas from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">driver for GCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since the interaction with the API of these clouds (Google and Yandex) has a number of similarities. In particular, the API and</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> return an object </font></font><code>Operation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to track the status of lengthy operations (for example, creating a new disk). </font><font style="vertical-align: inherit;">To interact with the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> API, the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Yandex.Cloud Go SDK is used</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result of the work done is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">published on GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and may be useful to those who for some reason use their own installation of Kubernetes on Yandex.Cloud virtual machines (but not a ready-made managed cluster) and would like to use (order) disks via CSI.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementation</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Key features</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Currently, the driver supports the following functions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ordering disks in all zones of the cluster according to the topology of nodes in the cluster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Removing previously ordered disks;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Offline resize for disks (Yandex. Cloud </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not support the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> increase in disks that are mounted on a virtual machine). </font><font style="vertical-align: inherit;">About how to modify the driver in order to resize as painlessly as possible, see below.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the future, it is planned to implement support for the creation and removal of snapshot disks.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The main difficulty and its overcoming</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The lack of the ability to expand disks in real time in the Yandex.Cloud API is a limitation that complicates the resize operation for PV (Persistent Volume): in this case, it is necessary that the pod of the application that uses the disk be stopped, and this can cause a simple applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the CSI specification</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , if the CSI controller reports that it can only resize disks “offline” ( </font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), then the process of increasing the disk should go like this:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the plugin has only </font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expansion capability and volume is currently published or available on a node then </font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MUST be called ONLY after either:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The plugin has controller </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capability and </font></font><code>ControllerUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has been invoked successfully.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OR ELSE</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The plugin does NOT have controller </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capability, the plugin has node </font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capability, and </font></font><code>NodeUnstageVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has been completed successfully.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OR ELSE</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The plugin does NOT have controller </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capability, nor node </font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capability, and </font></font><code>NodeUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has completed successfully.</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In essence, this means the need to disconnect the disk from the virtual machine before increasing it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, unfortunately, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementation of</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the CSI specification through sidecar does not meet these requirements:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the sidecar-container </font></font><code>csi-attacher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which should be responsible for the presence of the necessary gap between mounts, this functionality is simply not implemented with offline-resize. </font><font style="vertical-align: inherit;">A discussion about this was initiated </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a sidecar container in this context? </font><font style="vertical-align: inherit;">The CSI plugin itself does not interact with the Kubernetes API, but only responds to gRPC calls that sidecar containers send to it. </font><font style="vertical-align: inherit;">The latter are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">being developed by</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the Kubernetes community.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case (CSI plugin), the operation to increase the disk is as follows:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We receive a gRPC call </font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We are trying to increase the disk in the API, but we get an error about the impossibility of performing the operation, since the disk is mounted;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We save the disk identifier in map containing the disks for which you need to perform an increase operation. </font><font style="vertical-align: inherit;">Further for brevity we will call this map as </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manually delete the pod that uses the disk. </font><font style="vertical-align: inherit;">Kubernetes will restart it. </font><font style="vertical-align: inherit;">So that the disk does not have time to mount ( </font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) before the completion of the increase operation when trying to mount, we check that this disk is still in </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and return an error;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The CSI driver is trying to re-execute the resize operation. </font><font style="vertical-align: inherit;">If the operation was successful, then delete the disk from </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because </font><font style="vertical-align: inherit;">the disk identifier is missing in </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it </font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is successful, the disk is mounted, pod starts.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything looks simple enough, but as always there are pitfalls. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">External-resizer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is involved in disk </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">expansion</font></a><font style="vertical-align: inherit;"> , which, in case of an error during the operation, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses a queue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with an exponential increase in timeout time up to 1000 seconds:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DefaultControllerRateLimiter</span><span class="hljs-params">()</span> <span class="hljs-title">RateLimiter</span></span> {
  <span class="hljs-keyword">return</span> NewMaxOfRateLimiter(<font></font>
  NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">1000</span>*time.Second),
  <span class="hljs-comment">// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)</span>
  &amp;BucketRateLimiter{Limiter: rate.NewLimiter(rate.Limit(<span class="hljs-number">10</span>), <span class="hljs-number">100</span>)},<font></font>
  )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This can periodically lead to the fact that the operation of increasing the disk is stretched for 15+ minutes and, thus, the inaccessibility of the corresponding pod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only option that allowed us to reduce the potential downtime quite easily and painlessly was to use our version of external-resizer with a maximum timeout limit of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 seconds</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
 <br>
<pre><code class="go hljs">workqueue.NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">5</span>*time.Second)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We did not consider it necessary to urgently initiate a discussion and patch external-resizer, because offline resize disks is an atavism that will soon disappear from all cloud providers.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to start using?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The driver is supported in Kubernetes version 1.15 and higher. </font><font style="vertical-align: inherit;">For the driver to work, the following requirements must be met:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The flag is </font></font><code>--allow-privileged</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set to the value </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the API server and kubelet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Included </font></font><code>--feature-gates=VolumeSnapshotDataSource=true,KubeletPluginsWatcher=true,CSINodeInfo=true,CSIDriverRegistry=true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for API server and kubelet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propagation mount ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mount propagation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) should be included in the cluster. </font><font style="vertical-align: inherit;">When using Docker, the daemon must be configured so that shared mounts are allowed.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All necessary steps for the installation itself are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">described in README</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Installation is the creation of objects in Kubernetes from manifests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the driver to work, you will need the following:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indicate the identifier of the Yandex.Cloud catalog directory ( </font></font><code>folder-id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">in the manifest </font><font style="vertical-align: inherit;">( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">see the documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To interact with the Yandex.Cloud API in the CSI driver, a service account is used. </font><font style="vertical-align: inherit;">In the Secret manifest, you must pass the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">authorized keys</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the service account. </font><font style="vertical-align: inherit;">The documentation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">describes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> how to create a service account and get the keys.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try it</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and we will be glad to receive feedback and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new issues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> if you encounter any problems!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further support</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we would like to note that we implemented this CSI driver not from a great desire to have fun writing applications on Go, but because of the urgent need inside the company. </font><font style="vertical-align: inherit;">It does not seem advisable to support our own implementation, therefore, if Yandex shows interest and decides to continue supporting the driver, we will gladly transfer the repository to their disposal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, probably, Yandex in the Kubernetes managed cluster has its own implementation of the CSI driver, which can be released in Open Source. </font><font style="vertical-align: inherit;">We also see this development option as favorable - the community will be able to use the proven driver from the service provider, and not from a third-party company.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read also in our blog:</font></font><br>
<br>
<ul>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> Kubernetes CCM (Cloud Controller Manager)  .</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">     Kubernetes:  Flexvolume  CSI</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> Container Storage Interface ( Kubernetes   )</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> Kubernetes-   ?  addon-operator</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   Kubernetes (   )</a>».</li>
</ul></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486178/index.html">FOSS News No. 1 - review of free and open source news for January 27 - February 2, 2020</a></li>
<li><a href="../en486180/index.html">Tips and sources for creating serverless applications</a></li>
<li><a href="../en486184/index.html">How to use search effectively</a></li>
<li><a href="../en486186/index.html">Catastrophic Cloud: How It Works</a></li>
<li><a href="../en486188/index.html">Introducing PostgreSQL wal-g backup system</a></li>
<li><a href="../en486192/index.html">Cyber ​​fraudsters hack mobile operators to get to phone numbers of subscribers</a></li>
<li><a href="../en486194/index.html">About backups in Proxmox VE</a></li>
<li><a href="../en486198/index.html">Talking is hard. Essays on Communicating with Non-Programmers</a></li>
<li><a href="../en486200/index.html">Docker Tips: Clean Your Machine From Junk</a></li>
<li><a href="../en486202/index.html">Alpine collects Docker builds under Python 50 times slower, and images 2 times heavier</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>