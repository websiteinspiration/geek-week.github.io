<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛡️ 👗 👨🏽‍💼 Memcachedプラグイン：MySQLのNoSQL 💏 🍴 🧑🏽‍🤝‍🧑🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは！私の名前はマキシムマチュキンです。私はBadooの PHPプログラマーです。私たちの仕事では、MySQLを積極的に使用しています。しかし、時にはパフォーマンスに欠けるため、作業をスピードアップする方法を常に模索しています。
 
 2010年に、松延良典はHandlerSocketと呼ばれ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Memcachedプラグイン：MySQLのNoSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/453742/"><img src="https://habrastorage.org/webt/1v/q0/h5/1vq0h5tev1qw1ivnheyxg7jfiqm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こんにちは！私の名前はマキシムマチュキンです</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Badooの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PHPプログラマーです</font><font style="vertical-align: inherit;">。私たちの仕事では、MySQLを積極的に使用しています。しかし、時にはパフォーマンスに欠けるため、作業をスピードアップする方法を常に模索しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2010年に、松延良典はHandlerSocketと呼ばれるNoSQL MySQLプラグインを導入しました。このプラグインを使用すると、毎秒750,000を超えるリクエストを実行できると主張されています。私たちは気になったので、ほぼすぐにこのソリューションを使い始めました。結果が非常に気に入ったので、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンテーションを行い</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">HandlerSocketを宣伝する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">書き</font><font style="vertical-align: inherit;">始めました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうやら、私たちはこのプラグインの数少ないユーザーの1人でした-MySQL 5.7以降は動作しなくなりました。しかし、このバージョンでは、Oracleの別のプラグインが登場しました-InnoDB memcachedプラグインは、同様の機能を約束しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
memcachedプラグインが2013年にMySQL 5.6に登場したという事実にもかかわらず、そのプラグインに関する記事はそれほど多くなく、ほとんどの場合、ドキュメントを繰り返します。単純なラベルが作成され、memcachedクライアントを介してリクエストが作成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはMemcachedに関する豊富な経験を持ち、Memcachedとのやり取りを簡単にすることに慣れています。</font><font style="vertical-align: inherit;">InnoDB memcachedプラグインから、同じ単純さを期待しました。</font><font style="vertical-align: inherit;">しかし、実際には、プラグインを使用するためのパターンが、ドキュメントや記事で説明されているものと少なくとも少し異なる場合、多くのニュアンスと制限がポップアップします。これらは、プラグインを使用するかどうかを検討する価値があります。</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL HandlerSocket</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、新しいmemcachedプラグインを古いHandlerSocketと何らかの方法で比較します。</font><font style="vertical-align: inherit;">そのため、後者だったことを思い出します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HandlerSocketプラグインをインストールした後、MySQLは2つの追加ポートのリスニングを開始しました。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のポートは、データを読み取るためのクライアント要求を受信しました。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番目のポートは、データ記録のクライアント要求を受信しました。</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントはこれらのポートの1つで通常のTCP接続を確立する必要があり（認証はサポートされていません）、その後、「open index」コマンド（クライアントがどのフィールドのどのテーブルのどのテーブルを通知するかを通知する特別なコマンド）を送信する必要がありました。読み取り（または書き込み））。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「open index」コマンドが正常に機能した場合、接続が確立されたポートに応じて、GETまたはINSERT / UPDATE / DELETEコマンドを送信できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HandlerSocketでは、主キーでGETを実行できるだけでなく、一意でないインデックスからの単純なサンプル、範囲のサンプル、サポートされているマルチゲットとLIMITも実行できます。同時に、通常のSQLとプラグインの両方からテーブルを操作することができました。これにより、たとえば、SQLを介してトランザクションに変更を加え、HandlerSocketを介してこのデータを読み取ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HandlerSocketがepollを介してスレッドの限られたプールですべての接続を処理することが重要です。そのため、MySQL自体では接続ごとにスレッドが作成され、その数は非常に制限されていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、それはまだ普通のMySQLサーバーです-私たちがよく知っている技術です。</font><font style="vertical-align: inherit;">私たちはそれを複製して監視する方法を知っています。</font><font style="vertical-align: inherit;">HandlerSocketは特定のメトリックを提供しないため、監視が困難です。</font><font style="vertical-align: inherit;">ただし、標準のMySQLおよびInnoDBメトリックの一部は役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、不便な点もありました。特に、このプラグインはタイムスタンプタイプの操作をサポートしていませんでした。</font><font style="vertical-align: inherit;">まあ、HandlerSocketプロトコルは読みにくく、したがってデバッグが困難です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HandlerSocketの詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ください</font></a><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレゼンテーション</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もご覧いただけ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InnoDB memcachedプラグイン</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいmemcachedプラグインは何を提供していますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その名前が示すように、彼のアイデアは、memcachedクライアントを使用してMySQLを操作し、memcachedコマンドを介してデータを受信および保存することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プラグインの主な利点については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらをご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは以下に最も興味があります：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">低CPU消費。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データはInnoDBに保存され、特定の保証が与えられます。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MemcachedとSQLの両方を使用してデータを操作できます。</font><font style="vertical-align: inherit;">MySQLの組み込みツールを使用して複製できます。</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなプラスは、次のようにこのリストに追加できます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速で安価な接続。</font><font style="vertical-align: inherit;">通常のMySQL接続は1つのスレッドによって処理され、スレッドの数は制限されています。また、memcachedプラグインでは、1つのスレッドがイベントループ内のすべての接続を処理します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つのGETリクエストで複数のキーをリクエストする機能。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL HandlerSocketと比較した場合、memcachedプラグインでは、「テーブルを開く」コマンドを使用する必要がなく、すべての読み取りおよび書き込み操作が同じポートで行われます。</font></font><br>
</li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プラグインの詳細については、公式</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧ください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私たちにとって、最も有用なページは次のとおりです。</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InnoDB memcachedアーキテクチャ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InnoDB memcachedプラグイン内部</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プラグインをインストールした後、MySQLはポート11211（標準のmemcachedポート）で接続の受け入れを開始します。</font><font style="vertical-align: inherit;">テーブルへのアクセスを構成する特別なデータベース（スキーマ）innodb_memcacheも表示されます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">簡単な例 </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
memcachedプロトコルを介して操作するテーブルがすでにあるとします。</font></font><br>
<br>
<pre><code class="plaintext hljs">CREATE TABLE `auth` (<font></font>
 &nbsp;`email` varchar(96) NOT NULL,<font></font>
 &nbsp;`password` varchar(64) NOT NULL,<font></font>
 &nbsp;`type` varchar(32) NOT NULL DEFAULT '',<font></font>
 &nbsp;PRIMARY KEY (`email`)<font></font>
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、主キーのデータを受け取って変更したいとします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、menocachedキーとSQLテーブルの対応をinnodb_memcache.containersテーブルに記述する必要があります。</font><font style="vertical-align: inherit;">この表は次のようになります（読みやすくするために、エンコーディングの説明を削除しました）。</font></font><br>
<br>
<pre><code class="plaintext hljs">CREATE TABLE `containers` (<font></font>
 &nbsp;`name` varchar(50) NOT NULL,<font></font>
 &nbsp;`db_schema` varchar(250) NOT NULL,<font></font>
 &nbsp;`db_table` varchar(250) NOT NULL,<font></font>
 &nbsp;`key_columns` varchar(250) NOT NULL,<font></font>
 &nbsp;`value_columns` varchar(250) DEFAULT NULL,<font></font>
 &nbsp;`flags` varchar(250) NOT NULL DEFAULT '0',<font></font>
 &nbsp;`cas_column` varchar(250) DEFAULT NULL,<font></font>
 &nbsp;`expire_time_column` varchar(250) DEFAULT NULL,<font></font>
 &nbsp;`unique_idx_name_on_key` varchar(250) NOT NULL,<font></font>
 &nbsp;PRIMARY KEY (`name`)<font></font>
) ENGINE=InnoDB DEFAULT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も重要なフィールド：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">name-Memcachedキーのプレフィックス。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">db_schema-ベース（回路）の名前。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">db_tableはテーブルです。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">key_columns-検索するテーブルのフィールドの名前（通常、これは主キーです）。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value_columns-memcachedプラグインで使用できるテーブルのフィールドのリスト。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique_idx_name_on_keyは検索するインデックスです（key_columnsはすでに指定されていますが、それらは異なるインデックスにある可能性があり、インデックスを明示的に指定する必要があります）。</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残りのフィールドは、最初はあまり重要ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルの説明をinnodb_memcache.containersに追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">INSERT INTO innodb_memcache.containers SET <font></font>
 &nbsp;&nbsp;&nbsp;name='auth', <font></font>
 &nbsp;&nbsp;&nbsp;db_schema='test', <font></font>
 &nbsp;&nbsp;&nbsp;db_table='auth', <font></font>
 &nbsp;&nbsp;&nbsp;key_columns='email', <font></font>
 &nbsp;&nbsp;&nbsp;value_columns='password|type', <font></font>
 &nbsp;&nbsp;&nbsp;flags='0', <font></font>
 &nbsp;&nbsp;&nbsp;cas_column='0',<font></font>
 &nbsp;&nbsp;&nbsp;expire_time_column='0',<font></font>
 &nbsp;&nbsp;&nbsp;unique_idx_name_on_key='PRIMARY';</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、name = 'auth'はmemcachedキーのプレフィックスです。</font><font style="vertical-align: inherit;">ドキュメントではしばしばtable_idと呼ばれ、記事の後半ではこの用語を使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TELNETがmemcachedプラグインに接続し、データの保存と受信を試みます。</font></font><br>
<br>
<pre><code class="plaintext hljs">[21:26:22] maxm@localhost: ~&gt; telnet memchached-mysql.dev 11211<font></font>
Trying 127.0.0.1...<font></font>
Connected to memchached-mysql.dev.<font></font>
Escape character is '^]'.<font></font>
get @@auth.max@example.com<font></font>
END<font></font>
<font></font>
set @@auth.max@example.com 0 0 10<font></font>
1234567|89<font></font>
STORED<font></font>
<font></font>
get @@auth.max@example.com<font></font>
VALUE @@auth.max@example.com 0 10<font></font>
1234567|89<font></font>
END</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初にGETリクエストを送信しましたが、何も返されませんでした。</font><font style="vertical-align: inherit;">次に、SETリクエストでデータを保存し、その後GETでデータを取得しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GETは次の行を返しました：1234567 | 89。</font><font style="vertical-align: inherit;">これらは、「|」記号で区切られた「パスワード」および「タイプ」フィールドの値です。</font><font style="vertical-align: inherit;">フィールドは、innodb_memcache.containers.value_columnsに記述された順序で返されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらくあなたは今疑問に思っています：「記号「|」が「パスワード」に出会った場合はどうなりますか？」</font><font style="vertical-align: inherit;">これについては以下で説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLを通じて、このデータも利用できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">MySQL [(none)]&gt; select * from auth where email='max@example.com';<font></font>
+-----------------+----------+------+<font></font>
| email &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	<font></font>
| password | type |<font></font>
+-----------------+----------+------+<font></font>
| max@example.com | 1234567 &nbsp;| 89   |<font></font>
+-----------------+----------+------+<font></font>
1 row in set (0.00 sec)</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デフォルトのtable_id</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような操作モードもあります。</font></font><br>
<br>
<pre><code class="plaintext hljs">get @@auth<font></font>
VALUE @@auth 0 21<font></font>
test/auth<font></font>
END<font></font>
<font></font>
get max@example.com<font></font>
VALUE max@example.com 0 10<font></font>
1234567|99<font></font>
END<font></font>
<font></font>
set ivan@example.com 0 0 10<font></font>
qwerty|xxx<font></font>
STORED<font></font>
<font></font>
get ivan@example.com<font></font>
VALUE ivan@example.com 0 10<font></font>
qwerty|xxx<font></font>
END</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、get @@ authを使用して、table_id authをこの接続のデフォルトのプレフィックスにします。</font><font style="vertical-align: inherit;">その後、table_idを指定せずに、以降のすべてのクエリを実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これまでのところ、すべてがシンプルで論理的です。</font><font style="vertical-align: inherit;">しかし、理解し始めると、多くのニュアンスがあります。</font><font style="vertical-align: inherit;">私たちが見つけたものをお話しします。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニュアンス</font></font></h1><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">innodb_memcache.containersテーブルのキャッシュ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
memcachedプラグインは、起動時にinnodb_memcache.containersテーブルを1回読み取ります。</font><font style="vertical-align: inherit;">さらに、Memcachedプロトコルを介して不明なtable_idが到着した場合、プラグインはテーブル内でそれを検索します。</font><font style="vertical-align: inherit;">したがって、新しいキー（table_id）を簡単に追加できますが、既存のtable_idの設定を変更する場合は、memcachedプラグインを再起動する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">mysql&gt; UNINSTALL PLUGIN daemon_memcached;<font></font>
mysql&gt; INSTALL PLUGIN daemon_memcached soname "libmemcached.so";</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの2つの要求の間では、Memcachedインターフェースは機能しません。</font><font style="vertical-align: inherit;">このため、多くの場合、既存のtable_idを変更してプラグインを再起動するよりも、新しいtable_idを作成する方が簡単です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プラグイン操作のそのような重要なニュアンスが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InnoDB memcachedプラグイン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">へのmemcachedアプリケーション</font></a><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">適応で</font></a><font style="vertical-align: inherit;">説明されていることは、私たちにとって驚きでした。これは、そのよう</font><font style="vertical-align: inherit;">な情報にとってあまり論理的な場所ではありません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグ、cas_column、expire_time_column </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのフィールドは、Memcachedの一部の機能をシミュレートするために必要です。それらのドキュメントには一貫性がありません。その中のほとんどの例は、これらのフィールドが含まれているテーブルでの作業を示しています。それらをテーブルに追加する必要があるかもしれません（これらは少なくとも3つのINTフィールドです）。しかし、違います。テーブルにそのようなフィールドがなく、CAS、有効期限、フラグなどのMemcached機能を使用しない場合は、これらのフィールドをテーブルに追加する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
innodb_memcache.containersでテーブルを構成する場合、これらのフィールドに「0」を入力する必要があります。正確にゼロの行を作成してください。</font></font><br>
<br>
<pre><code class="plaintext hljs">INSERT INTO innodb_memcache.containers SET <font></font>
 &nbsp;&nbsp;&nbsp;name='auth', <font></font>
 &nbsp;&nbsp;&nbsp;db_schema='test', <font></font>
 &nbsp;&nbsp;&nbsp;db_table='auth', <font></font>
 &nbsp;&nbsp;&nbsp;key_columns='email', <font></font>
 &nbsp;&nbsp;&nbsp;value_columns='password|type', <font></font>
 &nbsp;&nbsp;&nbsp;flags='0', <font></font>
 &nbsp;&nbsp;&nbsp;cas_column='0',<font></font>
 &nbsp;&nbsp;&nbsp;expire_time_column='0',<font></font>
 &nbsp;&nbsp;&nbsp;unique_idx_name_on_key='PRIMARY';</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cas_columnとexpire_time_columnのデフォルト値がNULLであることは不愉快です。これらのフィールドに値「0」を指定せずにINSERT INTO innodb_memcache.containersを実行すると、NULLがそれらのフィールドに格納され、このmemcacheプレフィックスは単に機能しません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ型</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドキュメントからは、プラグインを操作するときにどのデータ型を使用できるかはあまり明確ではありません。</font><font style="vertical-align: inherit;">いくつかの場所では、プラグインはテキストフィールド（CHAR、VARCHAR、BLOB）でしか機能しないと言われています。</font><font style="vertical-align: inherit;">ここでは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、既存のMySQLスキーマをInnoDB memcachedプラグインに適合させることで、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数値を文字列フィールドに格納し、SQLからこれらの数値フィールドを操作する必要がある場合は、数値を含むVARCHARフィールドがINTEGERフィールドに変換されるVIEWを作成します。 ：</font></font><br>
<br>
<pre><code class="plaintext hljs">CREATE VIEW numbers AS SELECT c1 KEY, CAST(c2 AS UNSIGNED INTEGER) val<font></font>
 &nbsp;FROM demo_test WHERE c2 BETWEEN '0' and '9999999999';</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ドキュメントの一部の場所では、数値を操作できると書かれています。</font><font style="vertical-align: inherit;">これまでのところ、テキストフィールドを使用した実際の制作経験しかありませんが、実験結果は、プラグインが数値でも機能することを示しています。</font></font><br>
<br>
<pre><code class="plaintext hljs">CREATE TABLE `numbers` (<font></font>
 &nbsp;`id` int(10) unsigned NOT NULL AUTO_INCREMENT,<font></font>
 &nbsp;`counter` int(10) unsigned NOT NULL DEFAULT '0',<font></font>
 &nbsp;PRIMARY KEY (`id`)<font></font>
) ENGINE=InnoDB<font></font>
<font></font>
INSERT INTO innodb_memcache.containers SET name='numbers', db_schema='test', db_table='numbers', key_columns='id', value_columns='counter', flags='0', cas_column='0',expire_time_column='0',unique_idx_name_on_key='PRIMARY';</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、Memcachedプロトコルを通じて：</font></font><br>
<br>
<pre><code class="plaintext hljs">get @@numbers.1<font></font>
END<font></font>
set @@numbers.1 0 0 2<font></font>
12<font></font>
STORED<font></font>
get @@numbers.1<font></font>
VALUE @@numbers.1 0 2<font></font>
12<font></font>
END</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
memcachedプラグインが任意のタイプのデータを返すことができることがわかります。</font><font style="vertical-align: inherit;">しかし、彼はそれらをInnoDBにある形式で返します。たとえば、タイムスタンプ/日時/浮動小数点/ 10進数/ JSONの場合、バイナリ文字列が返されます。</font><font style="vertical-align: inherit;">しかし、SQLで見ると整数が返されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチゲット</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
memcachedプロトコルを使用すると、1回のリクエストで複数のキーをリクエストできます。</font></font><br>
<br>
<pre><code class="plaintext hljs">get @@numbers.2 @@numbers.1<font></font>
VALUE @@numbers.2 0 2<font></font>
12<font></font>
VALUE @@numbers.1 0 2<font></font>
13<font></font>
END</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
multigetが機能するという事実は、すでに良好です。</font><font style="vertical-align: inherit;">ただし、1つのtable_idのフレームワーク内で機能します。</font></font><br>
<br>
<pre><code class="plaintext hljs">get @@auth.ivan@example.com @@numbers.2<font></font>
VALUE @@auth.ivan@example.com 0 10<font></font>
qwerty|xxx<font></font>
END</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この点については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">//dev.mysql.com/doc/refman/8.0/en/innodb-memcached-multiple-get-range-query.html</font></a><font style="vertical-align: inherit;">のドキュメントで説明されてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。 multigetでは、他のすべてのキーがデフォルトのtable_id（ドキュメントの例）から取得されている場合、最初のキーに対してのみtable_idを指定できることがわかります。</font></font><br>
<br>
<pre><code class="plaintext hljs">get @@aaa.AA BB<font></font>
VALUE @@aaa.AA 8 12<font></font>
HELLO, HELLO<font></font>
VALUE BB 10 16<font></font>
GOODBYE, GOODBYE<font></font>
END</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、2番目のキーはデフォルトのtable_idから取得されます。</font><font style="vertical-align: inherit;">デフォルトのtable_idからさらに多くのキーを指定でき、最初のキーには別のtable_idを指定しましたが、これは最初のキーの場合にのみ可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
multigetは1つのテーブルのフレームワーク内で機能すると言えます。これは、本番コードではそのようなロジックに依存したくないためです。明確ではなく、忘れがちで、ミスを犯しやすいのです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HandlerSocketと比較すると、multigetも同じテーブルで機能します。</font><font style="vertical-align: inherit;">しかし、この制限は自然に見えました：クライアントはテーブルのインデックスを開き、それに1つ以上の値を要求します。</font><font style="vertical-align: inherit;">しかし、異なるプレフィックスを持ついくつかのキーでmultiget memcachedプラグインを操作する場合、これは通常の方法です。</font><font style="vertical-align: inherit;">また、MySQL memcachedプラグインにも同じことが期待されます。</font><font style="vertical-align: inherit;">しかし:(</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INCR、DEL</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GET / SETリクエストの例はすでに示しました。</font><font style="vertical-align: inherit;">INCRおよびDELクエリには機能があります。</font><font style="vertical-align: inherit;">これは、デフォルトのtable_idを使用する場合にのみ機能するという事実にあります。</font></font><br>
<br>
<pre><code class="plaintext hljs">DELETE @@numbers.1<font></font>
ERROR<font></font>
<font></font>
get @@numbers<font></font>
VALUE @@numbers 0 24<font></font>
test/numbers<font></font>
END<font></font>
<font></font>
delete 1<font></font>
DELETED</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memcachedプロトコルの制限</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Memcachedにはテキストプロトコルがあり、いくつかの制限があります。</font><font style="vertical-align: inherit;">たとえば、memcachedキーには空白文字（スペース、改行）を含めないでください。</font><font style="vertical-align: inherit;">例の表の説明をもう一度見ると、次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">CREATE TABLE `auth` (<font></font>
 &nbsp;`email` varchar(96) NOT NULL,<font></font>
 &nbsp;`password` varchar(64) NOT NULL,<font></font>
 &nbsp;`type` varchar(32) NOT NULL DEFAULT '',<font></font>
 &nbsp;PRIMARY KEY (`email`)<font></font>
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、「電子メール」フィールドにそのような文字があってはならないことを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、memcachedキーの長さは250バイト（バイトではなく文字）未満である必要があります。</font><font style="vertical-align: inherit;">さらに送信すると、エラーが発生します。</font></font><br>
 <br>
<pre><code class="plaintext hljs">"CLIENT_ERROR bad command line format"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、memcachedプラグインがmemcachedプロトコルに独自の構文を追加するという事実を考慮する必要があります。</font><font style="vertical-align: inherit;">たとえば、「|」という文字を使用しています </font><font style="vertical-align: inherit;">レスポンスのフィールドセパレータとして。</font><font style="vertical-align: inherit;">この記号がテーブルで使用されていないことを確認する必要があります。</font><font style="vertical-align: inherit;">セパレーターは設定できますが、設定はMySQLサーバー全体のすべてのテーブルに適用されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールド区切り文字value_columns</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の例のように、memcachedプロトコルを介して複数の列を返す必要がある場合：</font></font><br>
<br>
<pre><code class="plaintext hljs">get @@auth.max@example.com<font></font>
VALUE @@auth.max@example.com 0 10<font></font>
1234567|89<font></font>
END</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、列の値は標準のセパレーター「|」で区切られます。</font><font style="vertical-align: inherit;">「たとえば、記号「|」が行の最初のフィールドにある場合はどうなりますか？」</font><font style="vertical-align: inherit;">この場合のmemcachedプラグインは、1234 | 567 | 89のような文字列をそのまま返します。</font><font style="vertical-align: inherit;">一般的なケースでは、どのフィールドがどこにあるかを理解することは不可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、正しいセパレータをすぐに選択することが重要です。</font><font style="vertical-align: inherit;">そして、それはすべてのテーブルのすべてのキーに使用されるため、memcachedプロトコルを介して作業するどのフィールドにも見られないユニバーサルシンボルである必要があります。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはmemcachedプラグインが悪いと言っているのではありません。しかし、特定の作業スキーム用に作成されたという印象を受けます。memcachedプロトコルを使用してアクセスできる1つのテーブルを備えたMySQLサーバーで、このtable_idがデフォルトになっています。クライアントはMemcachedプラグインとの永続的な接続を確立し、デフォルトのtable_idにリクエストを送信します。おそらく、そのようなスキームでは、すべてが完璧に機能します。それから離れると、様々な不便に出くわします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プラグインのパフォーマンスレポートが表示されることを期待していたかもしれません。ただし、負荷の高い場所での使用はまだ決定していません。あまり負荷の少ないいくつかのシステムでのみ使用し、HandlerSocketとほぼ同じ速度で動作しましたが、正直なベンチマークは作成しませんでした。しかし、それにもかかわらず、プラグインはプログラマーが簡単に間違いを犯す可能性があるようなインターフェースを提供します-多くのニュアンスを覚えておく必要があります。したがって、このプラグインを一括で使用する準備はまだ整っていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MySQLバグトラッカーでいくつかの機能リクエストを行いました：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">https: </font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//bugs.mysql.com/bug.php </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">id </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">= </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">95091 </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">https://bugs.mysql.com/bug.php?id=95092 </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">https：//バグ.mysql.com / bug.php？id = 95093 </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://bugs.mysql.com/bug.php?id=95094</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
うまくいけば、memcachedプラグイン開発チームが製品を改善することを期待しています。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453722/index.html">非定常プロセスの研究について</a></li>
<li><a href="../ja453728/index.html">ハイパースターの戦い</a></li>
<li><a href="../ja453730/index.html">現代の歯科：テクニカルディレクターの目を通して同時に行われる歯の移植と顎骨の拡張</a></li>
<li><a href="../ja453732/index.html">私はモレニスから来ました。斜めの見方や尊敬？</a></li>
<li><a href="../ja453734/index.html">Helm 3の紹介</a></li>
<li><a href="../ja453744/index.html">疑似クラスの原則を研究します。「純粋なCSSでテーブルのアクティブな行を強調表示する」タスクの例を使用して（）</a></li>
<li><a href="../ja453748/index.html">モバイルゲームのプロトタイピング、どこから始め、どのように行うか。パート3（最終）</a></li>
<li><a href="../ja453750/index.html">最近のボルチモアのサイバー攻撃について</a></li>
<li><a href="../ja453756/index.html">FSTECからの現在の脅威を特定するための現在の方法論の問題</a></li>
<li><a href="../ja453760/index.html">戦車とプロセッサのサーキットトレーニングキャンプ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>