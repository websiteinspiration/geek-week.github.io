<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏘️ 🤱🏽 👩🏾‍🤝‍👨🏽 影の中のライト 👩🏼‍🔬 🛵 🤷🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="これは、11月末に開催されたCTFZone予選ステージのために準備したタスクの1つについてのストーリーです。資格認定の準備プロセスについては、こちらをご覧ください。
 
 まず、decrypt_flag.pyとntfs_volume.rawの2つのファイルから始めます。スクリプトを見てみましょう。彼...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>影の中のライト</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/bizone/blog/486390/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、</font><font style="vertical-align: inherit;">11月末に開催</font><font style="vertical-align: inherit;">された</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTFZone</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">予選ステージのために準備したタスクの1つについてのストーリー</font><font style="vertical-align: inherit;">です。資格認定の準備プロセスについては、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらをご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、decrypt_flag.pyとntfs_volume.rawの2つのファイルから始めます。スクリプトを見てみましょう。彼はkey.binという名前のファイルを開き、ループを使用して、ファイル内の各オフセットから34バイトのバイナリ文字列を取得しようとします。これは、PBKDF2関数の入力として使用されます。返された各キーは、コードに組み込まれた暗号化された文字列を復号化するXORキーとして使用されます。復号化されたMD5ハッシュが、復号化された形式の所定の値と一致する場合、スクリプトは受信したデータを使用してフラグを生成および出力します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、key.binファイルを見つける必要があります。</font><font style="vertical-align: inherit;">キーを見つけるプロセスが遅すぎるため、イメージファイル（ntfs_volume.raw）内のすべてのオフセットを単純に並べ替えることは不可能です。</font><font style="vertical-align: inherit;">これは規則で禁止されていませんが、CTFの終了までに時間がないことは確かです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イメージファイルには、単一パーティションのMBRパーティションテーブルが含まれています。</font><font style="vertical-align: inherit;">そのオフセットは2048の512バイトセクターで、NTFSファイルシステムが含まれていますが、key.binファイルはそこにありません。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ fls -o 2048 -r -p ntfs_volume.raw | grep -F key.bin | wc –l<font></font>
0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NTFSは、UTF-16LEでエンコードされたファイル名を格納します。</font><font style="vertical-align: inherit;">探してみよう！</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/c4/9n/5g/c49n5g_kmk7j-ga2zo5nzthtad0.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルレコードの検索結果検索結果</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を調査したので、FILE署名[1]で始まるファイルレコードに焦点を当てます。</font><font style="vertical-align: inherit;">これが唯一のそのようなエントリです：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wv/-x/id/wv-xid-sp4valyl_kmqxj9e2o5s.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発見された記録</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
目標はすでに近いです！ファイルレコードがありますが、データが必要です。 NTFSでは、それらは$ DATA属性に格納されます。これは、常駐または非常駐にすることができます[2]。見つかったレコードの場合、この属性はオフセット0×3AADD00から始まり、非常駐データを示します（つまり、情報はファイルレコードの外部に格納されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
では、目的のファイルのデータはどこにあるのでしょうか。この質問に答えるには、いわゆるマッピングペアまたはデータラン（ペア「ブロック長-ブロックオフセット」）をデコードする必要があります[3]。目的のファイルのデータ実行は次のとおりです（オフセット0×3AADD40に注意）：22 53 01 A0 4E 21 05 31 C1 11 38 3000。または、それらを再配置する場合：</font></font><br>
<br>
<pre><code class="plaintext hljs">1.	22 53 01 A0 4E<font></font>
2.	21 05 31 C1<font></font>
3.	11 38 30 00</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルは3つのフラグメントで構成され、最初のサイズは339クラスターで、クラスター＃20128で始まります。 PBKDF2を使用するコードでは、このスニペットは大きくなります。ファイルシステムヘッダーに示されているように、1つのクラスターのサイズは4096バイトです。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ fsstat -o 2048 ntfs_volume.raw | grep 'Cluster Size'<font></font>
Cluster Size: 4096</code></pre><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2048 * 512 + 20128 * 4096 = 83492864の</font><font style="vertical-align: inherit;">
オフセット（バイト単位）でデータを見てみましょう。</font><font style="vertical-align: inherit;">大量の情報（128バイトなど）を抽出し、それを新しいファイルに挿入します。これをkey.binと呼び、スクリプトを実行します...何も成功しませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく、ファイルは現在のバージョンではなく、以前のバージョンのファイルシステム（以前のフォーマット）に保存されていました。同じ名前の削除されたファイルに関するレコードが表示されなかったことを忘れないでください。以前のクラスターサイズはどれくらいでしたか？ NTFS署名のあるファイルシステムヘッダーを探しましょう[4]。たぶん私たちは幸運で、本当に前のフォーマットのヘッダーを見つけました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s3/mp/na/s3mpnalay_jhx-yvaytbqgp4qta.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルシステムヘッダー</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の</font><i><font style="vertical-align: inherit;">検索結果結果</font></i><font style="vertical-align: inherit;">の最初と最後の位置は現在のファイルシステムを参照していますが、それらの間にあるファイルシステムヘッダーは以前のフォーマットに属しているようです。そして、それらは異なるクラスターサイズを持っています！</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/co/hb/locohbcqzrc6_etzqfxfnb1tusk.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前のバージョンのファイルシステムヘッダー。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
このようなセクターサイズは0×4554800Bのオフセットで書き込まれます：00 02、または512。ただし、このようなクラスターサイズは0×0x4554800Dのオフセットで記録されます：F7、または247。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、クラスターサイズ（バイト単位）がわかります512 * 247 =126464。ある種のナンセンス！ NTFSパーサー[5]と思われる場合、そのような値には符号を付けて特別な方法で処理する必要があるため、実際のクラスターサイズ（セクター単位）は1 &lt;&lt;-（-9）= 512です。または、バイト単位の場合、512 * 512 = 262144今はもっと信じられそうに聞こえます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、データはこのオフセット（バイト単位）で始まります：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2048 * 512 + 20128 * 262144 =5277483008。そこに格納されている情報を使用して同じトリックをもう一度実行してみましょう...もう一度、失敗します！なにが問題ですか？ここにCTFがあります。これは、「そうではない」ということを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが戦っているタスクは、In the Shadowsと呼ばれています。</font><font style="vertical-align: inherit;">ボリュームのシャドウコピーと関係がある可能性があります。</font><font style="vertical-align: inherit;">したがって、このボリュームに以前存在していたファイルシステムのファイルがあります。</font><font style="vertical-align: inherit;">残念ながら、そのシャドウコピーを取得してマウントすることはできませんが、データが始まる正確なオフセットはわかっています。</font><font style="vertical-align: inherit;">これは5277483008、またはセクション内で5277483008-2048 * 512 = 5276434432です。VSS </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
形式[6]の仕様に従って、リダイレクトされたデータブロックは、元のオフセット（ボリューム内）が格納される64ビットフィールドを含むブロック記述子構造で記述されます。また、（ボリューム内の）ターゲットブロックオフセットを説明する64ビットフィールド。</font><font style="vertical-align: inherit;">5276434432を64ビットのリトルエンディアン番号として探しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果には2つの結果しかなく、そのうちの1つだけが偶数オフセットに配置されています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y6/bo/dm/y6bodmvczyemr2uu-2m7giaukqw.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">見つかったブロック記述子</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ターゲット</font><i><font style="vertical-align: inherit;">ブロック</font></i><font style="vertical-align: inherit;">オフセット：00 00 9B 03 00 00 00 00、または単に60489728。最終オフセット：60489728 + 2048 * 512 =61538304。ここから、key.binという新しいファイルにある量のデータをエクスポートし、...</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ./decrypt_flag.py<font></font>
ctfzone{my_c0ngr4t5_t0_u,w311_d0n3_31337}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
できた！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/concepts/file_record.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/attributes/data.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/concepts/data_runs.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/files/boot.html</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/msuhanov/dfir_ntfs/blob/94bb46d6600153071b0c3c507ef37c42ad62110d/dfir_ntfs/BootSector.py#L58</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/libyal/libvshadow/blob/master/documentation/Volume%20Shadow%20Snapshot%20(VSS)%20format.asciidoc#431-block-descriptor</font></font></a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja486376/index.html">レベルデザイナーがアーキテクチャ理論を使用してゲームレベルを作成する方法</a></li>
<li><a href="../ja486378/index.html">太陽光発電のホームサーバーは15か月間稼働しました：稼働時間95.26％</a></li>
<li><a href="../ja486380/index.html">プロダクトマネージャーが実際に行うべきこと</a></li>
<li><a href="../ja486382/index.html">シールとスクラム</a></li>
<li><a href="../ja486388/index.html">MyVPNオープンソース非営利プロジェクトの概要</a></li>
<li><a href="../ja486392/index.html">SDSアーキテクチャの簡単な比較、または適切なストレージプラットフォームの検索（GlusterVsCephVsVirtuozzoStorage）</a></li>
<li><a href="../ja486394/index.html">ブックマーク-制限はありますか？</a></li>
<li><a href="../ja486396/index.html">React Native：Shopifyモバイル開発の新たなマイルストーン</a></li>
<li><a href="../ja486400/index.html">個人データを取得するには、さらに多くの個人データを提供する必要があります</a></li>
<li><a href="../ja486402/index.html">バックアップの死：グローバルサイバーサミット2020の新しい脅威と新しい保護</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>