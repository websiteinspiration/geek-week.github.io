<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍💻 🍃 🤶 Bitrix24でビジネスプロセスの移行を設定する方法 👸🏼 ⚾️ 👇🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="業務を自動化するために、企業では多くの場合Bitrix24を使用しています。この記事では、ビジネスプロセスを変更するときに発生する可能性のある問題のいくつかと、その解決方法について説明します。
 
 
 
 Bitrix24は、一般的なCRMシステムの1つです。ビジネスプロセス図を構築するためのビジ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bitrix24でビジネスプロセスの移行を設定する方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/466823/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">業務を自動化するために、企業では多くの場合Bitrix24を使用しています。</font><font style="vertical-align: inherit;">この記事では、ビジネスプロセスを変更するときに発生する可能性のある問題のいくつかと、その解決方法について説明します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fx/-p/sj/fx-psjbms29rlcnbbytsumkgw0y.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bitrix24は、一般的なCRMシステムの1つです。ビジネスプロセス図を構築するためのビジュアルデザイナー（デザイナー）が含まれています。これらのプロセスを編集する場合、特にローカルサーバーとテストサーバーで変更が最初にチェックされる大規模な既存のプロジェクトでは、問題が発生する可能性があることに注意してください。このような場合、本番環境への移行時には、ビジネスプロセス移行メカニズム（以下、BP）を使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
中小企業は、原則として、移行なしで実行でき、特定のビジネスプロセスを2〜3日間停止するだけです。大企業は通常それを買う余裕がないため、テストサーバーと展開を使用します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bc/-9/2z/bc-92zo3_pb_lszqvilcyr8ifvc.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのようにBitrix24 </font><font style="vertical-align: inherit;">ビジネス・プロセス・テンプレートが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能します</font></font></a><font style="vertical-align: inherit;"></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
移行の処理には独自の特性があります。</font><font style="vertical-align: inherit;">特に、関連するオブジェクトとIDの数が多いため、複雑になります。</font><font style="vertical-align: inherit;">さらに、Bitrix24は、ビジネスプロセス自体の移行も提供していません。この問題は、インポートとエクスポートによって解決されることが多く、さまざまな不整合がある可能性があります。</font><font style="vertical-align: inherit;">同時に起こりうる問題を、開発の観点から考えてみましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスプロセステンプレートの検索に関する問題</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスプロセスを作成する場合、一意のコードではなく、テンプレートに名前を割り当てることができます。この場合、ビジネスプロセスを更新するときは、データベースから名前で取得する必要があります。システムは起動時にプロセスのリストに表示するためにそれらを使用するため、名前が変わる場合があります。そのため、更新中にテンプレートが見つからない場合があります。一般に、名前で検索するのはあまり良い考えではありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解決策：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
システムで作成されたすべてのビジネスプロセステンプレートは、b_bp_workflow_templateテーブルに格納されます。テーブルを開くと、SYSTEM_CODEが表示されるフィールドの中にあります。コードのフィールドがあり、インターフェースに出力されないだけです。テンプレートIDを使用して自分でコードを設定できます。プロセス編集ページのURLで確認できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4j/x2/re/4jx2redv2qt5vecw6aulrikvvmc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンプレートのIDとコードを取得するための関数を作成し、重複するテンプレートと変更するテンプレートのフィールドの完全性を確認し、そのコードを設定する必要があります。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">use</span> <span class="hljs-title">Bitrix</span>\<span class="hljs-title">Main</span>\<span class="hljs-title">Loader</span>;<font></font>
Loader::includeModule(<span class="hljs-string">"bizproc"</span>);<font></font>
$BPloader = CBPWorkflowTemplateLoader::GetLoader();<font></font>
<font></font>
<span class="hljs-comment">// set template CODE field</span>
setTemplateCode ($BPloader, <span class="hljs-string">'TEST'</span>, <span class="hljs-string">'94'</span> );<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTemplateCode</span>(<span class="hljs-params">$BPloader, $code, $tempalteId</span>) </span>{<font></font>
<font></font>
   <span class="hljs-keyword">if</span> (isCodeExists($BPloader, $code)) {<font></font>
<font></font>
      <span class="hljs-keyword">die</span>(<span class="hljs-string">'   '</span>);<font></font>
   }<font></font>
<font></font>
   <span class="hljs-keyword">if</span> (!isCodeEmpty($BPloader, $tempalteId)) {<font></font>
<font></font>
      <span class="hljs-keyword">die</span>(<span class="hljs-string">'     '</span>)<font></font>
   }<font></font>
<font></font>
   $BPloader-&gt;UpdateTemplate($tempalteId, [<span class="hljs-string">'SYSTEM_CODE'</span> =&gt; $code]);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// check if $code exists in DB</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isCodeExists</span>(<span class="hljs-params">$BPloader, <span class="hljs-keyword">string</span> $code</span>) </span>{<font></font>
<font></font>
   $dbRes =  $BPloader-&gt;GetTemplatesList(<font></font>
      $arOrder = [<span class="hljs-string">'ID'</span> =&gt; <span class="hljs-string">'DESC'</span>],<font></font>
      $arFilter = [<span class="hljs-string">'CODE'</span> =&gt; $code],<font></font>
      $arGroupBy = <span class="hljs-literal">false</span>,<font></font>
      $arNavStartParams = <span class="hljs-literal">false</span>,<font></font>
      $arSelectFields = [<span class="hljs-string">'ID'</span>]<font></font>
   );<font></font>
<font></font>
   <span class="hljs-keyword">if</span> (intval($dbRes-&gt;SelectedRowsCount()) &gt; <span class="hljs-number">0</span>) {<font></font>
<font></font>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
   }<font></font>
<font></font>
   <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// check if the template code is not empty</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isCodeEmpty</span>(<span class="hljs-params">$BPloader, $tempalteId</span>) </span>{<font></font>
<font></font>
   $dbRes =  $BPloader-&gt;GetTemplatesList(<font></font>
      $arOrder = [<span class="hljs-string">'ID'</span> =&gt; <span class="hljs-string">'DESC'</span>],<font></font>
      $arFilter = [<span class="hljs-string">'CODE'</span> =&gt; <span class="hljs-string">''</span>, <span class="hljs-string">'ID'</span> =&gt; $tempalteId],<font></font>
      $arGroupBy = <span class="hljs-literal">false</span>,<font></font>
      $arNavStartParams = <span class="hljs-literal">false</span>,<font></font>
      $arSelectFields = [<span class="hljs-string">'ID'</span>]<font></font>
   );<font></font>
<font></font>
   <span class="hljs-keyword">if</span> (intval($dbRes-&gt;SelectedRowsCount()) &gt; <span class="hljs-number">0</span>) {<font></font>
<font></font>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
   }<font></font>
<font></font>
   <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
}<font></font>
<font></font>
<font></font>
   <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
進め。</font><font style="vertical-align: inherit;">たとえば、リスト上にテストビジネスプロセスを作成してみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k4/z-/qc/k4z-qcs92cs5g7xcoiyf4dozfs0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルで開発されたプロセスをテストサーバーに（次に本番環境に）転送するには、移行メカニズムを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bitrix24を使用すると、ビジネスプロセスをエクスポートできます。</font><font style="vertical-align: inherit;">この機会を利用します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0x/ew/1c/0xew1cwrivumtl94pxwpfqvycoy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
転送スキームは次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスプロセスのエクスポート</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイグレーションを記述し、ファイルを添付します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいスタンドでは、古いプロセスをバックアップします</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移行を適用</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、このプロセスがどのように発生するかを検討します。 </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移行を作成する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マーケットプレイスからの移行モジュールを使用します：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">//marketplace.1c-bitrix.ru/solutions/ws.migrations/</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトのマイグレーションファイルは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカル/マイグレーション/シナリオにあります。</font></font><br>
</b><br>
<br>
<img src="https://habrastorage.org/webt/dp/pr/g1/dpprg1qs2z8qe_3i03xq87oo1xs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
プロセステンプレートページを開いてエクスポートします。</font><font style="vertical-align: inherit;">migrationディレクトリ内にfilesディレクトリを作成し、そこにエクスポートされたファイルを置きます。</font><font style="vertical-align: inherit;">次のようになります：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカル/マイグレーション/シナリオ/ファイル/ bp-94.bpt</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
マイグレーションスクリプトを作成します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ws_m_1565783124_approve_task</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">WS</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">ScriptScenario</span> </span>{</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスプロセステンプレートのパラメータを定義します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ws_m_1565783124_approve_task</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">WS</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">ScriptScenario</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">private</span> $arBPFields = [
       <span class="hljs-string">'DOCUMENT_TYPE'</span> =&gt; [
           <span class="hljs-string">'lists'</span>,
           <span class="hljs-string">'BizprocDocument'</span>,
           <span class="hljs-string">'iblock_'</span><font></font>
       ],<font></font>
       <span class="hljs-string">'AUTO_EXECUTE'</span> =&gt; <span class="hljs-number">0</span>,
       <span class="hljs-string">'NAME'</span> =&gt; <span class="hljs-string">' '</span>,
       <span class="hljs-string">'CODE'</span> =&gt; <span class="hljs-string">'TEST'</span>,<font></font>
   ];</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスプロセスのインポート機能を実装します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">importBP</span>(<span class="hljs-params">$path</span>)
</span>{<font></font>
   CModule::IncludeModule(<span class="hljs-string">'bizproc'</span>);<font></font>
   CModule::IncludeModule(<span class="hljs-string">'iblock'</span>);<font></font>
<font></font>
   <span class="hljs-comment">//Get iBlock id for which BP is created</span>
   <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'DOCUMENT_TYPE'</span>][<span class="hljs-number">2</span>] .= <span class="hljs-keyword">$this</span>-&gt;getIblockId();<font></font>
<font></font>
   <span class="hljs-comment">// Get BP id by the CODE</span><font></font>
   $result = \CBPWorkflowTemplateLoader::GetList(<font></font>
       [],<font></font>
       [<font></font>
           <span class="hljs-string">'CODE'</span>      =&gt; <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'CODE'</span>],
           <span class="hljs-string">'MODULE_ID'</span> =&gt; <span class="hljs-string">'lists'</span><font></font>
       ]<font></font>
   );<font></font>
  <font></font>
   <span class="hljs-keyword">if</span> ($arFields = $result-&gt;GetNext()) {<font></font>
       $id = $arFields[<span class="hljs-string">'ID'</span>];<font></font>
   } <span class="hljs-keyword">else</span> {<font></font>
       $id = <span class="hljs-number">0</span>;<font></font>
   }<font></font>
<font></font>
   <span class="hljs-comment">//read file to a variable</span>
   $f = fopen($path, <span class="hljs-string">'rb'</span>);<font></font>
   $datum = fread($f, filesize($path));<font></font>
   fclose($f);<font></font>
<font></font>
   <span class="hljs-comment">//Update BP if id&gt;0, otherwise add BP</span><font></font>
   \CBPWorkflowTemplateLoader::ImportTemplate(<font></font>
       $id,<font></font>
       <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'DOCUMENT_TYPE'</span>],
       <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'AUTO_EXECUTE'</span>],
       <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'NAME'</span>],
       <span class="hljs-string">''</span>,<font></font>
       $datum,<font></font>
       <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'CODE'</span>]<font></font>
   );<font></font>
<font></font>
   <span class="hljs-keyword">return</span> $arFields[<span class="hljs-string">'ID'</span>];<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、最初にプロセスを適用する情報ブロックのIDを特定し、指定されたコードでプロセステンプレートのIDを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンプレートが見つかった場合、それを更新します。</font><font style="vertical-align: inherit;">見つからない場合-追加。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この関数は、作成または更新されたプロセスのIDと、それが必要なものを返します-詳細は後で説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスプロセスを追加/更新するコミット関数を定義します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commit</span>(<span class="hljs-params"></span>) </span>{<font></font>
<font></font>
$pathBPElement = <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/files/bp-94-approve-task.bpt'</span>;<font></font>
$id = <span class="hljs-keyword">$this</span>-&gt;importBP($pathBPElement);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、このステップでは、移行モジュールを使用して特定のビジネスプロセスを作成および更新することができます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テンプレートデータの更新に関する問題</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスプロセスに戻り、そこにアクション（ユーザー通知）を追加します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/m0/8k/tfm08kk36ju3xtaonop4vjpr3lo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
送信者として著者を選択します。</font><font style="vertical-align: inherit;">受信者は：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HRユーザーグループ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーSvetlana Kuznetsova</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ビジネスプロセスがデータベースにどのように記録されるかを確認します。これを行うには、管理パネルのPHPコンソールでテンプレートを取得して印刷します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yi/ug/nx/yiugnxm3nbaflnr1_syuq9_3ljm.png"><br>
<br>
<pre><code class="php hljs">$arFieldsTemplate = \CBPWorkflowTemplateLoader::GetList([], [<span class="hljs-string">'ID'</span> =&gt; <span class="hljs-number">94</span>])-&gt;GetNext();<font></font>
 <font></font>
 <span class="hljs-keyword">echo</span> <span class="hljs-string">'&lt;pre&gt;'</span>;<font></font>
 var_dump($arFieldsTemplate);</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスパラメータの配列には</font></font><br>
<br>
<img src="https://habrastorage.org/webt/w6/wm/wb/w6wmwbgunucvakqyk_1skuvqwqa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、次のようなものが表示されます。group_g15行を確認します。</font><font style="vertical-align: inherit;">ここで15はHRグループIDです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行user_579を調べます。</font><font style="vertical-align: inherit;">ここで579はユーザーIDです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、プロセスを別のサイトにインポートすると、一貫性が失われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
に。</font><font style="vertical-align: inherit;">これらのIDを、プロセスをインポートするサイトに関連するIDに移行した後、置き換えを行う必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
グループはシンボリックコードで識別され、ユーザーはログインで識別されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、プロセスが作成されたサイトで、グループシンボリックコードとユーザーログインを取得します。</font><font style="vertical-align: inherit;">シンボリックグループコードが設定されていない場合は、移行を記述して最初にインストールすることをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グループコード-HR</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーログイン-svetlana.kuznetsova</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、コードとログインによってグループとユーザーのIDを提供する移行関数を記述します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getUserId（$ログイン）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getGroupId（$コード）;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、テンプレートの適切な値を更新します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-comment">/**
  * Write action by apply scenario. Use method `setData` for save need rollback data
  **/</span>
 <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commit</span>(<span class="hljs-params"></span>) </span>{</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスプロセスをインポートします。</font></font><br>
<br>
<pre><code class="php hljs">$pathBPElement = <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/files/bp-94-approve-task.bpt'</span>;<font></font>
$id = <span class="hljs-keyword">$this</span>-&gt;importBP($pathBPElement);</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンプレートデータを取得します。</font></font><br>
<br>
<pre><code class="php hljs">$arFieldsTemplate = \CBPWorkflowTemplateLoader::GetList([], [<span class="hljs-string">'ID'</span> =&gt; $id])-&gt;GetNext();<font></font>
$template = $arFieldsTemplate[<span class="hljs-string">"TEMPLATE"</span>];</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスプロセス内のユーザーIDを置き換えます。</font></font><br>
<br>
<pre><code class="php hljs">$template[<span class="hljs-number">0</span>][<span class="hljs-string">'Children'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'Properties'</span>][<span class="hljs-string">"MessageUserTo"</span>][<span class="hljs-number">0</span>] = <span class="hljs-string">'group_g'</span> . <span class="hljs-keyword">$this</span>-&gt;getGroupId(<span class="hljs-string">'HR'</span>);<font></font>
$template[<span class="hljs-number">0</span>][<span class="hljs-string">'Children'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'Properties'</span>][<span class="hljs-string">"MessageUserTo"</span>][<span class="hljs-number">1</span>] = <span class="hljs-string">'user_'</span> . <span class="hljs-keyword">$this</span>-&gt;getUserId(<span class="hljs-string">'svetlana.kuznetsova'</span>);<font></font>
$arNewFields = [<font></font>
  “TEMPLATE” =&gt; $template,<font></font>
  “VARIABLES” =&gt; $arFieldsTemplate[<span class="hljs-string">"VARIABLES"</span>]<font></font>
];<font></font>
$arNewFields[<span class="hljs-string">"MODIFIER_USER"</span>] = <span class="hljs-keyword">new</span> \CBPWorkflowTemplateUser(CBPWorkflowTemplateUser::CurrentUser);<font></font>
<font></font>
\CBPWorkflowTemplateLoader::Update($id, $arNewFields);<font></font>
 }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、移行を開始するときに、ファイルをアップロードし、importBP関数を使用してプロセスを作成/更新します。</font><font style="vertical-align: inherit;">次に、ビジネスプロセステンプレートの構造を配列に入れ、IDを置き換えてテンプレートを更新します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要約する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、サイト間の転送中に不整合が発生する可能性のあるいくつかのケースのみに触れ、何を探すべきかを概説しました。</font><font style="vertical-align: inherit;">一般的に、私たちの実践では、次のIDバインディングに遭遇しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user_（ユーザーへのバインド）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">group_（ユーザーグループへのバインド）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iblock_（情報ブロックへのバインド）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SequentialWorkflowActivity（テンプレートからのビジネスプロセスの開始）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PROPERTY_（未定義の文字コードでドキュメントフィールドにバインド）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが正しく行われていれば、デバッグされたビジネスプロセスを本番環境に迅速かつスムーズに転送できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの経験があなたに役立つことを願っています！</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全な例を表示</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<span class="hljs-comment">/**
 * Updates migration scenario actions
 **/</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ws_m_1565783124_approve_task</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">WS</span>\<span class="hljs-title">Migrations</span>\<span class="hljs-title">ScriptScenario</span>
</span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> $arBPFields = [
        <span class="hljs-string">'DOCUMENT_TYPE'</span> =&gt; [
            <span class="hljs-string">'lists'</span>,
            <span class="hljs-string">'BizprocDocument'</span>,
            <span class="hljs-string">'iblock_'</span><font></font>
        ],<font></font>
        <span class="hljs-string">'AUTO_EXECUTE'</span> =&gt; <span class="hljs-number">0</span>,
        <span class="hljs-string">'NAME'</span> =&gt; <span class="hljs-string">' '</span>,
        <span class="hljs-string">'CODE'</span> =&gt; <span class="hljs-string">'TEST'</span>,<font></font>
    ];<font></font>
<font></font>
    <span class="hljs-keyword">private</span> $codeIBlock = <span class="hljs-string">'APPROVE_TASK'</span>;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Name of scenario
     * <span class="hljs-doctag">@return</span> string
     **/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'approve task process'</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Description of scenario
     * <span class="hljs-doctag">@return</span> string
     **/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">description</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">'process to approve task and set task deadline  +14 days after approving'</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@return</span> array First element is hash, second is owner name
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">version</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">return</span> [<span class="hljs-string">'13ebf9abe69204014459b80a7036b7a0'</span>, <span class="hljs-string">''</span>];<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Return IBlock ID
     * <span class="hljs-doctag">@return</span> int
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getIblockId</span>(<span class="hljs-params"></span>)
    </span>{<font></font>
        $result = CIBlock::GetList(<font></font>
            [],<font></font>
            [<font></font>
                <span class="hljs-string">'TYPE'</span>   =&gt; <span class="hljs-string">'bitrix_processes'</span>,
                <span class="hljs-string">'=CODE'</span>  =&gt; <span class="hljs-keyword">$this</span>-&gt;codeIBlock<font></font>
            ],<font></font>
            <span class="hljs-literal">false</span>,<font></font>
            [<span class="hljs-string">'nTopCount'</span> =&gt; <span class="hljs-number">1</span>]<font></font>
        );<font></font>
        <span class="hljs-keyword">if</span> ($arIBlock = $result-&gt;Fetch()) {
            <span class="hljs-keyword">return</span> $arIBlock[<span class="hljs-string">'ID'</span>];<font></font>
        }<font></font>
            <font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Start import BP
     * <span class="hljs-doctag">@param</span> $path
     * <span class="hljs-doctag">@return</span> mixed
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">importBP</span>(<span class="hljs-params">$path</span>)
    </span>{<font></font>
        CModule::IncludeModule(<span class="hljs-string">'bizproc'</span>);<font></font>
        CModule::IncludeModule(<span class="hljs-string">'iblock'</span>);<font></font>
<font></font>
        <span class="hljs-comment">//Get iBlock id for which BP is created</span>
        <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'DOCUMENT_TYPE'</span>][<span class="hljs-number">2</span>] .= <span class="hljs-keyword">$this</span>-&gt;getIblockId();<font></font>
<font></font>
        <span class="hljs-comment">// Get BP id by the CODE</span><font></font>
        $result = \CBPWorkflowTemplateLoader::GetList(<font></font>
            [],<font></font>
            [<font></font>
                <span class="hljs-string">'CODE'</span>      =&gt; <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'CODE'</span>],
                <span class="hljs-string">'MODULE_ID'</span> =&gt; <span class="hljs-string">'lists'</span><font></font>
            ]<font></font>
        );<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> ($arFields = $result-&gt;GetNext()) {<font></font>
            $id = $arFields[<span class="hljs-string">'ID'</span>];<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            $id = <span class="hljs-number">0</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//read file to a variable</span>
        $f = fopen($path, <span class="hljs-string">'rb'</span>);<font></font>
        $datum = fread($f, filesize($path));<font></font>
        fclose($f);<font></font>
<font></font>
        <span class="hljs-comment">//Update BP if id&gt;0, otherwise add BP</span><font></font>
        \CBPWorkflowTemplateLoader::ImportTemplate(<font></font>
            $id,<font></font>
            <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'DOCUMENT_TYPE'</span>],
            <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'AUTO_EXECUTE'</span>],
            <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'NAME'</span>],
            <span class="hljs-string">''</span>,<font></font>
            $datum,<font></font>
            <span class="hljs-keyword">$this</span>-&gt;arBPFields[<span class="hljs-string">'CODE'</span>]<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">return</span> $arFields[<span class="hljs-string">'ID'</span>];<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> $login
     * <span class="hljs-doctag">@return</span> mixed
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUserId</span>(<span class="hljs-params">$login</span>)
    </span>{<font></font>
        $rsUsers = Bitrix\Main\UserTable::getList([<font></font>
            <span class="hljs-string">"select"</span> =&gt;[<span class="hljs-string">'ID'</span>],
            <span class="hljs-string">"filter"</span> =&gt; [<span class="hljs-string">'LOGIN'</span> =&gt; $login],<font></font>
        ]);<font></font>
        $userFields = $rsUsers-&gt;fetch();<font></font>
<font></font>
        <span class="hljs-keyword">return</span> $userFields[<span class="hljs-string">'ID'</span>];<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> $code
     * <span class="hljs-doctag">@return</span> mixed
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGroupId</span>(<span class="hljs-params">$code</span>)
    </span>{<font></font>
        $rsGroups = \Bitrix\Main\GroupTable::getList(<font></font>
            [<font></font>
                <span class="hljs-string">'filter'</span> =&gt; [<span class="hljs-string">'STRING_ID'</span>=&gt; <span class="hljs-string">'HR'</span>],
                <span class="hljs-string">'select'</span> =&gt; [<span class="hljs-string">'ID'</span>]<font></font>
            ]);<font></font>
<font></font>
        $arFields = $rsGroups-&gt;fetch();<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> $arFields[<span class="hljs-string">'ID'</span>];<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Write action by apply scenario. Use method `setData` for save need rollback data
     **/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commit</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-comment">//make BP import</span>
        $pathBPElement = _DIR_ . <span class="hljs-string">'/files/bp-94-approve-task.bpt'</span>;<font></font>
        $id = <span class="hljs-keyword">$this</span>-&gt;importBP($pathBPElement);<font></font>
<font></font>
        <span class="hljs-comment">//get template data</span>
        $arFieldsTemplate = \CBPWorkflowTemplateLoader::GetList([], [<span class="hljs-string">'ID'</span> =&gt; $id])-&gt;GetNext();<font></font>
        $template = $arFieldsTemplate[<span class="hljs-string">'TEMPLATE'</span>];<font></font>
<font></font>
        <span class="hljs-comment">//replace id inside BP tempalte</span>
        $template[<span class="hljs-number">0</span>][<span class="hljs-string">'Children'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'Properties'</span>][<span class="hljs-string">'MessageUserTo'</span>][<span class="hljs-number">0</span>] = <span class="hljs-string">'group_g'</span> . <span class="hljs-keyword">$this</span>-&gt;getGroupId(<span class="hljs-string">'HR'</span>);<font></font>
        $template[<span class="hljs-number">0</span>][<span class="hljs-string">'Children'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'Properties'</span>][<span class="hljs-string">'MessageUserTo'</span>][<span class="hljs-number">1</span>] = <span class="hljs-string">'user_'</span> . <span class="hljs-keyword">$this</span>-&gt;getUserId(<span class="hljs-string">'svetlana.kuznetsova'</span>);<font></font>
        $arNewFields = [<font></font>
            <span class="hljs-string">'TEMPLATE'</span> =&gt; $template,
            <span class="hljs-string">'VARIABLES'</span> =&gt; $arFieldsTemplate[<span class="hljs-string">'VARIABLES'</span>]<font></font>
        ];<font></font>
        $arNewFields[<span class="hljs-string">'MODIFIER_USER'</span>] = <span class="hljs-keyword">new</span> CBPWorkflowTemplateUser(CBPWorkflowTemplateUser::CurrentUser);<font></font>
<font></font>
        \CBPWorkflowTemplateLoader::Update($id, $arNewFields);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Write action by rollback scenario. Use method `getData` for getting commit saved data
     **/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rollback</span>(<span class="hljs-params"></span>)
    </span>{<font></font>
        $pathBPElement = _DIR_ . <span class="hljs-string">'/files/bp-wt-old.bpt'</span>;<font></font>
        $id = <span class="hljs-keyword">$this</span>-&gt;importBP($pathBPElement);<font></font>
<font></font>
        $arFieldsTemplate = \CBPWorkflowTemplateLoader::GetList([], [<span class="hljs-string">'ID'</span> =&gt; $id])-&gt;GetNext();<font></font>
        $template = $arFieldsTemplate[<span class="hljs-string">'TEMPLATE'</span>];<font></font>
<font></font>
        $arNewFields = [<font></font>
            <span class="hljs-string">'TEMPLATE'</span> =&gt; $template,
            <span class="hljs-string">'VARIABLES'</span> =&gt; $arFieldsTemplate[<span class="hljs-string">'VARIABLES'</span>]<font></font>
        ];<font></font>
        $arNewFields[<span class="hljs-string">'MODIFIER_USER'</span>] = <span class="hljs-keyword">new</span> CBPWorkflowTemplateUser(CBPWorkflowTemplateUser::CurrentUser);<font></font>
        \CBPWorkflowTemplateLoader::Update($id, $arNewFields);<font></font>
    }<font></font>
}</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja466813/index.html">Posit-arithmetic：自分のフィールドで浮動小数点を打ち負かします。パート2</a></li>
<li><a href="../ja466815/index.html">NEC HYDRAstor HS8の技術概要など</a></li>
<li><a href="../ja466817/index.html">Varonisが暗号化マイニングウイルスを発見：私たちの調査</a></li>
<li><a href="../ja466819/index.html">iOSでのプロモーションオファーの実装。サブスクリプションでさらに稼ぐには？</a></li>
<li><a href="../ja466821/index.html">Amazon AWS Marketplaceから3CXをインストールする</a></li>
<li><a href="../ja466829/index.html">Rでのbigint IDの操作に関するいくつかのタッチ</a></li>
<li><a href="../ja466831/index.html">モノリシックなUnixライクなOSの開発-ヒープ（4）</a></li>
<li><a href="../ja466837/index.html">ガスジェネレーターを備えた電気自転車での週末</a></li>
<li><a href="../ja466839/index.html">ノートンコマンダーの歴史。パート1/3</a></li>
<li><a href="../ja466841/index.html">ラップトップがある場合、なぜ加熱パッド：原子レベルでの熱抵抗の研究</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>