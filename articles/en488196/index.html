<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎳 🅱️ 👩‍👧 Android insets: dealing with fears and getting ready for Android Q 👍🏻 🏕️ 👩🏻‍🎤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Android Q is the tenth version of Android with API level 29. One of the main ideas of the new version is the concept of edge-to-edge, when application...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Android insets: dealing with fears and getting ready for Android Q</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/488196/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android Q is the tenth version of Android with API level 29. </font><font style="vertical-align: inherit;">One of the main ideas of the new version is the concept of edge-to-edge, when applications occupy the entire screen, from the bottom to the top. </font><font style="vertical-align: inherit;">This means that the Status Bar and Navigation Bar must be transparent. </font><font style="vertical-align: inherit;">But, if they are transparent, then there is no system UI - it overlaps the interactive components of the application. </font><font style="vertical-align: inherit;">This problem is solved with insets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mobile developers avoid insets, they cause fear in them. </font><font style="vertical-align: inherit;">But in Android Q it will not be possible to get around insets - you will have to study and apply them. </font><font style="vertical-align: inherit;">In fact, there is nothing complicated about insets: they show which screen elements intersect with the system interface and suggest how to move the element so that it does not conflict with the system UI. </font><strong><font style="vertical-align: inherit;">Konstantin Tskhovrebov</font></strong><font style="vertical-align: inherit;"> will tell about how insets work and how they are useful</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/6Djql74drwk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konstantin Tskhovrebov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terrakok</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) works in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redmadrobot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Has been involved in Android for 10 years and has accumulated a lot of experience in various projects in which there was no place for insets, they always managed to get around somehow. </font><font style="vertical-align: inherit;">Konstantin will tell about a long history of avoiding the insets problem, about studying and fighting Android. </font><font style="vertical-align: inherit;">He will consider typical tasks from his experience in which insets could be applied, and show how to stop being afraid of the keyboard, recognize its size and respond to appearance. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note. </font><font style="vertical-align: inherit;">The article was written based on a report by Konstantin at </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saint AppsConf 2019</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The report used materials from several articles on insets. </font><font style="vertical-align: inherit;">Link to these materials at the end.</font></font></em><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typical tasks</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Color Status Bar. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In many projects, the designer draws a color Status Bar. </font><font style="vertical-align: inherit;">It became fashionable when Android 5 came along with the new Material Design. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9l/ii/76/9lii76jdfrbb5i0vq8-ecv2ikby.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to paint Status Bar? </font><font style="vertical-align: inherit;">Elementary - add </font></font><code>colorPrimaryDark</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the color is substituted.</font></font><br>
<br>
<pre><code class="kotlin hljs"> &lt;style name=<span class="hljs-string">"AppTheme"</span> parent=<span class="hljs-string">"Theme.AppCompat.Light.NoActionBar"</span>&gt;<font></font>
    ...<font></font>
    &lt;item name=<span class="hljs-string">"colorPrimaryDark"</span>&gt;<span class="hljs-meta">@color</span>/colorAccent&lt;/item&gt;<font></font>
    ...<font></font>
&lt;/style&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Android above the fifth version (API from 21 and above), you can set special parameters in the topic:</font></font><br>
<br>
<pre><code class="kotlin hljs">&lt;style name=<span class="hljs-string">"AppTheme"</span> parent=<span class="hljs-string">"Theme.AppCompat.Light.NoActionBar"</span>&gt;<font></font>
    ...<font></font>
    &lt;item name=<span class="hljs-string">"android:statusBarColor"</span>&gt;<span class="hljs-meta">@color</span>/colorAccent&lt;/item&gt;<font></font>
    ...<font></font>
&lt;/style&gt;</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multi-colored Status Bar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sometimes designers on different screens draw the Status Bar in different colors. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uo/ev/nl/uoevnldknz2rtfq5lcqpn1mpj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's okay, the easiest way that works is with </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">different topics in different activities</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The more interesting way is to change colors </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">directly in runtime</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(...)</span></span>: View {<font></font>
    requireActivity().window.statusBarColor = requireContext().getColor(R.color.colorPrimary)<font></font>
    ...<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The parameter is changed through a special flag. </font><font style="vertical-align: inherit;">But the main thing is not to forget to change the color back when the user exits the screen back. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transparent Status Bar. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is harder. </font><font style="vertical-align: inherit;">Most often, transparency is associated with maps, because it is on maps that transparency is best seen. </font><font style="vertical-align: inherit;">In this case, as before, we set a special parameter:</font></font><br>
<br>
<pre><code class="kotlin hljs">&lt;style name=<span class="hljs-string">"AppTheme"</span> parent=<span class="hljs-string">"Theme.AppCompat.Light.NoActionBar"</span>&gt;    <font></font>
    ...<font></font>
    &lt;item name=<span class="hljs-string">"android:windowTranslucentStatus"</span>&gt;<span class="hljs-literal">true</span>&lt;/item&gt;<font></font>
    ...<font></font>
&lt;/style&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, of course, there is a well-known trick - to indent higher, otherwise the Status Bar will be superimposed on the icon and it will be ugly.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/49/8f/c8/498fc8wuip6i-o4eutfnviumuio.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But on other screens everything breaks. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/if/-0/0q/if-00qq6b7zidoz-_nfyehlev7s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to solve the problem? The first method that comes to mind is different activities: we have different topics, different parameters, they work differently. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work with the keyboard.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We avoid insets not only with the Status Bar, but also when working with the keyboard. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s-/jk/mz/s-jkmzxzi-5xqr1ei0ku6pfubpy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nobody likes the option on the left, but to turn it into an option on the right, there is a simple solution.</font></font><br>
<br>
<pre><code class="kotlin hljs">&lt;activity<font></font>
    ...<font></font>
    android:windowSoftInputMode=<span class="hljs-string">"adjustResize"</span>&gt;<font></font>
    ...<font></font>
&lt;/activity&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Activity can now resize when the keyboard appears. It works simply and severely. But don't forget another trick - wrap everything in </font></font><code>ScrollView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Suddenly the keyboard will occupy the entire screen and there will be a small strip on top? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are times more difficult when we want to change the layout when the keyboard appears. For example, otherwise arrange the buttons or hide the logo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q3/ia/zl/q3iazltlnajt-cpvdzc0u2i8zcs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We trained so many crutches with a keyboard and a transparent Status Bar, now it's hard to stop us. Go to StackOverflow and copy the beautiful code.</font></font><br>
<br>
<pre><code class="kotlin hljs">boolean isOpened = <span class="hljs-literal">false</span>;<font></font>
<font></font>
<span class="hljs-keyword">public</span> void setListenerToRootView() {
    <span class="hljs-keyword">final</span> View activityRootView = getWindow().getDecorView().findViewById(android.R.id.content);<font></font>
    activityRootView.getViewTreeObserver().addOnGlobalLayoutListener(new OnGlobalLayoutListener() {<font></font>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> void onGlobalLayout() {<font></font>
    <font></font>
            int heightDiff = activityRootView.getRootView().getHeight() - activityRootView.getHeight();      <font></font>
            <span class="hljs-keyword">if</span> (heightDiff &gt; <span class="hljs-number">100</span>) { <span class="hljs-comment">// 99% of the time the height diff will be due to a keyboard.       </span>
                Toast.makeText(getApplicationContext(), <span class="hljs-string">"Gotcha!!! softKeyboardup"</span>, <span class="hljs-number">0</span>).show();<font></font>
<font></font>
                <span class="hljs-keyword">if</span> (isOpened == <span class="hljs-literal">false</span>) {
                   <span class="hljs-comment">//Do two things, make the view top visible and the editText smaller</span><font></font>
                }<font></font>
                isOpened = <span class="hljs-literal">true</span>;<font></font>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isOpened == <span class="hljs-literal">true</span>) {<font></font>
                Toast.makeText(getApplicationContext(), <span class="hljs-string">"softkeyborad Down!!!"</span>, <span class="hljs-number">0</span>).show();<font></font>
                isOpened = <span class="hljs-literal">false</span>;<font></font>
            }    <font></font>
        }<font></font>
    });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It even calculated the probability of a keyboard appearing. </font><font style="vertical-align: inherit;">The code works, in one of the projects we even used it, but for a long time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many crutches in the examples are associated with the use of different activities. </font><font style="vertical-align: inherit;">But they are bad not only because they are crutches, but also for other reasons: the problem of “cold start”, asynchrony. </font><font style="vertical-align: inherit;">I described the problems in more detail in the article “ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">License to drive a car, or why applications should be Single-Activity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”. </font><font style="vertical-align: inherit;">In addition, Google’s documentation indicates that the recommended approach is a Single Activity application.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What did we do before Android 10</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We (at Redmadrobot) are developing fairly high-quality applications, but have long avoided insets. How did we manage to avoid them without large crutches and in one activity? </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note. Screenshots and code taken from my pet project </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitFox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Imagine the application screen. When we developed our applications, we never thought that there could be a transparent Navigation Bar below. Is there a black bar below? So what, users are used to it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/ab/6v/ceab6v6m5dqnbl9zpotdi1vqmre.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the top, we initially set the parameter that the Status Bar is black with transparency. How does it look in terms of layout and code?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0g/tu/of/0gtuoffisoeudtgxlnmqd-jicnk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The abstraction in the figure: the red block is the activity of the application, the blue is the fragment with the navigation bot (with Tabs), and inside it the green fragments with the content are switched. It can be seen that the Toolbar is not under the Status Bar. How did we achieve this? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Android has a tricky flag </font></font><code>fitSystemWindow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If you set it to true, the container will add padding to itself so that nothing inside it falls under the Status Bar. I believe this flag is the official crutch from Google for those who are afraid of insets. Use everything will work relatively well without insets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The flag </font></font><code>FitSystemWindow=”true”</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adds padding to the container that you specified. But the hierarchy is important: if one of the parents set this flag to “true”, then its distribution will not be taken into account, because the container has already applied the indentation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The flag works, but another problem appears. </font><font style="vertical-align: inherit;">Imagine a screen with two tabs. </font><font style="vertical-align: inherit;">When switching, a transaction is launched, which causes a </font></font><code>replace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fragment one on another, and everything breaks. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lv/02/_u/lv02_ui9sepxlvi7djz_xpem2sy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second fragment also has a flag set </font></font><code>FitSystemWindow=”true”</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and this should not happen. </font><font style="vertical-align: inherit;">But what happened, why? </font><font style="vertical-align: inherit;">The answer is that this is a crutch, and sometimes it does not work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we found a solution on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stack Overflow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : use root for not fragments </font></font><code>FrameLayout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but </font></font><code>CoordinatorLayout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It was created for other purposes, but it works here.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why does it work?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see in the source what is happening in </font></font><code>CoordinatorLayout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> void onAttachedToWindow() {   
    <span class="hljs-keyword">super</span>.onAttachedToWindow();<font></font>
    ...    <font></font>
    <span class="hljs-keyword">if</span> (mLastInsets == <span class="hljs-literal">null</span> &amp;&amp; ViewCompat.getFitsSystemWindows(<span class="hljs-keyword">this</span>)) {         
        <span class="hljs-comment">// We're set to fitSystemWindows but we haven't had any insets yet...</span>
        <span class="hljs-comment">// We should request a new dispatch of window insets</span>
        ViewCompat.requestApplyInsets(<span class="hljs-keyword">this</span>);<font></font>
    }     <font></font>
    ...<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see a beautiful comment that insets are needed here, but they are not. </font><font style="vertical-align: inherit;">We need to re-ask them when we request a window. </font><font style="vertical-align: inherit;">We figured out that insets somehow work inside, but we don’t want to work with them and leave </font></font><code>Coordinator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the spring of 2019, we developed the application, at which time Google I / O just passed. </font><font style="vertical-align: inherit;">We have not figured everything out yet, so we continued to hold on to prejudice. </font><font style="vertical-align: inherit;">But we noticed that switching Tabs at the bottom is somehow slow, because we have a complex layout, loaded with UI. </font><font style="vertical-align: inherit;">We find a simple way to solve this - change </font></font><code>replace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>show/hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so that each time you do not re-create the layout.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hx/7l/vz/hx7lvzsl8-kfv3qqac2pbvllt8q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We change, and again nothing works - everything has broken! </font><font style="vertical-align: inherit;">Apparently it’s just not possible to scatter crutches, you need to understand why they worked. </font><font style="vertical-align: inherit;">We study the code and it turns out that any ViewGroup is also able to work with insets.</font></font><br>
<br>
<pre><code class="kotlin hljs">
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> WindowInsets dispatchApplyWindowInsets(WindowInsets insets) {    <font></font>
    insets = <span class="hljs-keyword">super</span>.dispatchApplyWindowInsets(insets);     
    <span class="hljs-keyword">if</span> (!insets.isConsumed()) {         
        <span class="hljs-keyword">final</span> int count = getChildCount();        
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; count; i++) {<font></font>
            insets = getChildAt(i).dispatchApplyWindowInsets(insets);             <font></font>
            <span class="hljs-keyword">if</span> (insets.isConsumed()) {          
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> insets;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is such a logic inside: if at least someone has already processed insets, then all subsequent Views inside the ViewGroup will not receive them. </font><font style="vertical-align: inherit;">What does this mean for us? </font><font style="vertical-align: inherit;">Let me show you an example of our FrameLayout, which switches Tabs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/h1/fo/nn/h1fonnc4qrqpmj_x-fc8m47ptci.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inside there is the first fragment that has the flag set </font></font><code>fitSystemWindow=”true”</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This means that the first fragment processes insets. </font><font style="vertical-align: inherit;">After that, we call the </font></font><code>HIDE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first fragment and the </font></font><code>SHOW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">second. </font><font style="vertical-align: inherit;">But the first one remains in the layout - his View is left, just hidden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The container goes through its View: it takes the first fragment, gives it insets, and from it </font></font><code>fitSystemWindow=”true”</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- he took them and processed them. </font><font style="vertical-align: inherit;">Perfectly, FrameLayout looked that the insets were processed, and did not give it to the second fragment. </font><font style="vertical-align: inherit;">Everything works as it should. </font><font style="vertical-align: inherit;">But this does not suit us, what should we do?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We write our own ViewGroup</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We came from Java, and there OOP in all its glory, so we decided to inherit. </font><font style="vertical-align: inherit;">We wrote our own ViewGroup, from which we redefined the method </font></font><code>dispatchApplyWindowInsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It works the way we need it: it always gives back to the children the insets that came, regardless of whether we processed them or not.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WindowInsetFrameLayout</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span></span>(<font></font>
    context: Context,      <font></font>
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,     <font></font>
    defStyleRes: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span><font></font>
) : FrameLayout(context, attrs, defStyleRes) {<font></font>
<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatchApplyWindowInsets</span><span class="hljs-params">(insets: <span class="hljs-type">WindowInsets</span>)</span></span>: WindowInsets { 
        <span class="hljs-keyword">for</span> (child <span class="hljs-keyword">in</span> (<span class="hljs-number">0</span> until childCount)) {<font></font>
            getChildAt(child).dispatchApplyWindowInsets(insets)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> insets.consumeSystemWindowInsets()<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Custom ViewGroup works, the project too is everything we need. </font><font style="vertical-align: inherit;">But he still does not reach a general solution. </font><font style="vertical-align: inherit;">When we figured out what they told us on Google IO, we realized that we won’t be able to act like that anymore.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android 10</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Android 10 showed us two important UI concepts that are strictly recommended to adhere to: edge-to-edge and Gestural Navigation. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Edge-to-edge.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">concept</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suggests that the content of the application should occupy </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all possible space</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the screen. For us, as developers, this means that applications should be placed </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">under the Status Bar and Navigation Bar system panels.</font></font></strong><br>
<br>
<img src="https://habrastorage.org/webt/cr/gl/nh/crglnh9iw__fu4lct0gavaibqey.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Previously, we could somehow ignore this or be placed only under the Status Bar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As for the lists, they should scroll not only to the last element, but also further </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so as not to remain under the Navigation Bar.</font></font></strong><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/tl/pl/it/tlplit1o65rn55edkixuuojxtha.png" width="350"></div><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestural Navigation. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This second important concept is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gesture navigation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It allows you to control the application with your fingers from the edge of the screen. </font><font style="vertical-align: inherit;">Gesture mode is non-standard, everything looks different, but now you can not switch between two different Navigation Bar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this moment, we realized that everything is not so simple. </font><font style="vertical-align: inherit;">It will not be possible to further avoid insets if we want to develop quality applications. </font><font style="vertical-align: inherit;">It's time to study the documentation and understand what insets are.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insets </font><font style="vertical-align: inherit;">What do you need to know about them?</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insets were created to scare developers.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They have been doing this perfectly since the moment it appeared in Android 5. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, everything is not so scary. The concept of insets is simple - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">they report a system UI overlay on the application screen.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It can be a Navigation Bar, Status Bar or a keyboard. The keyboard is also a regular system UI, which is superimposed on top of the application. It is not necessary to try to process it with any crutches, only insets. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The goal of insets is to resolve conflicts</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For example, if there is another element above our button, we can move the button so that the user can continue to use the application. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To handle inset,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> use </font></font><code>Windowlnsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for Android 10 and </font></font><code>WindowInsetsCompat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for other versions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are </font><strong><font style="vertical-align: inherit;">5 different types of insets</font></strong><font style="vertical-align: inherit;"> in Android 10</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and one "bonus", which is called not inset, but otherwise. </font><font style="vertical-align: inherit;">We’ll deal with all types, because most know only one thing - System Window Insets.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System window insets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduced in Android 5.0 (API 21). </font><font style="vertical-align: inherit;">Obtained by the method </font></font><code>getSystemWindowInsets()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the main type of insets that you need to learn how to work with, because the rest work the same way. </font><font style="vertical-align: inherit;">They are needed to process the Status Bar, first of all, and then the Navigation Bar and keyboard. </font><font style="vertical-align: inherit;">For example, they solve a problem when the Navigation Bar is above the application. </font><font style="vertical-align: inherit;">As in the picture: the button remained under the Navigation Bar, the user cannot click on it and is very unhappy.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nx/yj/tt/nxyjttdppbkrnrnqkspovzp4hko.png" width="350"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tappable element insets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Appeared only in Android 10. Obtained by the method </font></font><code>getTappableElementInsets()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These insets are </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> useful </font><strong><font style="vertical-align: inherit;">for handling various Navigation Bar modes</font></strong><font style="vertical-align: inherit;"> . As </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chris Bane</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> himself says </font><font style="vertical-align: inherit;">, you can forget about this type of insets and get around only System Window Insets. But if you want the application to be 100% cool, not 99.9% cool, you should use it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Look at the picture. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rl/yd/fk/rlydfkwy39pfrc7jfhizhqdkg0q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On top, the crimson color indicates System Window Insets, which will come in different modes of the Navigation Bar. It can be seen that on the right and on the left they are equal to the Navigation Bar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recall how gesture navigation works: in the right mode, we never click on a new panel, but always drag our fingers from bottom to top. </font><font style="vertical-align: inherit;">This means that the buttons can not be removed. </font><font style="vertical-align: inherit;">We can continue to press our FAB (Floating Action Button) button, no one will interfere. </font><font style="vertical-align: inherit;">Therefore, it </font></font><code>TappableElementInsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will come empty because FAB is not necessary to move. </font><font style="vertical-align: inherit;">But if we move a little higher, that's okay. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The difference appears only with gesture navigation and the transparent Navigation Bar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (color adaptation). </font><font style="vertical-align: inherit;">This is not a very pleasant situation. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zv/ei/qz/zveiqz33n9dc290ib9yhrrjl09u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything will work, but it looks unpleasant. </font><font style="vertical-align: inherit;">The user may be confused by the proximity of the elements. </font><font style="vertical-align: inherit;">It can be explained that one is for gestures and the other is for pressing, but still not beautiful. </font><font style="vertical-align: inherit;">Therefore, either raise the FAB higher or leave it on the right.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System gesture insets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Appeared only in Android 10. Obtained by the method </font></font><code>getSystemGestureInsets()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These insets are related to gesture navigation. Initially, it was assumed that the system UI is drawn on top of the application, but System Gesture Insets say that it is not the UI that is drawn, but the system itself handles the gestures. They describe where the system will handle gestures by default. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The areas of these insets are approximately those marked in yellow on the diagram. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/8d/jl/vv8djlgxe4cnjchozbllrysagd0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But I want to warn you - they will not always be like that. We will never know what new screens Samsung and other manufacturers will come up with. There are already devices in which the screen is on all sides. Perhaps the insets will not be where we expect at all. Therefore, you need to work with them as with some abstraction: there are such insets in System Gesture Insets in which the system itself processes gestures.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These insets can be overridden. </font><font style="vertical-align: inherit;">For example, you are developing a photo editor. </font><font style="vertical-align: inherit;">In some places, you yourself want to handle gestures, even if they are near the edge of the screen. </font><font style="vertical-align: inherit;">Indicate to the system that you will process the point on the screen in the corner of the photo yourself. </font><font style="vertical-align: inherit;">It can be redefined by telling the system: "I will always process the square around the point myself."</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mandatory system gesture insets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Appeared only in Android 10. This is a subtype of System Gesture Insets, but they cannot be overridden by the application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We use the method </font></font><code>getMandatorySystemGestureInsets()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to determine the area where they will not work. </font><font style="vertical-align: inherit;">This was done intentionally so that it was impossible to develop a “hopeless” application: redefine the navigation gesture from the bottom up, which allows you to exit the application to the main screen. </font><font style="vertical-align: inherit;">Here, the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">system always processes the gestures itself</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/89/gl/df/89gldfknoq8z9dje_naytwp0pti.png" width="450"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not necessarily it will be on the bottom of the device and not necessarily of this size. </font><font style="vertical-align: inherit;">Work with it as an abstraction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These were relatively new kinds of insets. </font><font style="vertical-align: inherit;">But there are those that appeared even before Android 5 and were called differently.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stable insets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduced with Android 5.0 (API 21). Obtained by the method </font></font><code>getStableInsets()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even experienced developers can not always say why they are needed. I’ll tell you a secret: these insets are only useful for full-screen applications: video players, games. For example, in the playback mode, any system UI is hidden, including the Status Bar, which moves beyond the edge of the screen. But it’s worth touching the screen, as the Status Bar will appear on top. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you put any BACK button at the top of the screen, while it correctly processes System Window Insets, then with each Tab a UI appears on the screen from above, and the button jumps down. If you do not touch the screen for a while, the Status Bar disappears, the button bounces up because System Window Insets have disappeared.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For such cases, Stable Insets are just right. </font><font style="vertical-align: inherit;">They say that now no element is drawn on your application, but can do it. </font><font style="vertical-align: inherit;">With these insets, you can know in advance the value of the Status Bar in this mode, for example, and position the button where you want. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note. </font><font style="vertical-align: inherit;">The method </font></font></em><code><em>getStableInsets()</em></code><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appeared only with API 21. Previously, there were several methods for each side of the screen.&nbsp;</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We examined 5 types of insets, but there is one more that does not apply to insets directly. </font><font style="vertical-align: inherit;">It helps deal with bangs and cutouts.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bangs and necklines</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Screens are no longer square. </font><font style="vertical-align: inherit;">They are oblong, with one or more cutouts for the camera and bangs on all sides. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ls/kv/sc/lskvscp_j-hy2gesyynicb346cq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Up to 28 APIs we could not process them. </font><font style="vertical-align: inherit;">I had to guess through insets what was happening there. </font><font style="vertical-align: inherit;">But with the 28 API and beyond (from the previous Android), the class officially appeared </font></font><code>DisplayCutout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is in the same insets from which you can get all the other types. </font><font style="vertical-align: inherit;">The class allows you to find out the location and size of artifacts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to location information, a set of y flags is provided for the developer </font></font><code>WindowManager.LayoutParams</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">They allow you to include different behaviors around cutouts. </font><font style="vertical-align: inherit;">Your content may be displayed around them, or may not be displayed: in landscape and portrait mode in different ways. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flags</font></font><code>window.attributes.layoutInDisplayCutoutMode =</code><br>
<br>
<ul>
<li><code>LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In portrait - there is, and in landscape - a black bar by default.</font></font></li>
<li><code>LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Not at all - a black stripe.</font></font></li>
<li><code>LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - always is.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The display can be controlled, but we work with them in the same way as with any other Insets.</font></font><br>
<br>
<pre><code class="kotlin hljs">insets.displayCutout<font></font>
    .boundingRects<font></font>
    .forEach { rect -&gt; ... }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Callback with insets with an array comes to us </font></font><code>displayCutout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Then we can run through it, process all the cutouts and bangs that are in the application. </font><font style="vertical-align: inherit;">You can learn more about how to work with them </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Understood with 6 kinds of insets. </font><font style="vertical-align: inherit;">Now let's talk about how it works.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it works</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Insets are needed, first of all, when something is drawn on top of the application, for example, the Navigation Bar. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ft/ct/_w/ftct_wh_dc64t9rw6ir_7zpqg8m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Without insets, the application will not have a transparent Navigation Bar and Status Bar. </font><font style="vertical-align: inherit;">Do not be surprised that you do not come </font></font><code>SystemWindowInsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, this happens.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spread insets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The entire UI hierarchy looks like a tree with a View at its ends. </font><font style="vertical-align: inherit;">Nodes are usually a ViewGroup. </font><font style="vertical-align: inherit;">They also inherit from View, so insets come to them in a special way </font></font><code>dispatchApplyWindowInsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Starting from the root View, the system sends insets throughout the tree. </font><font style="vertical-align: inherit;">Let's see how View works in this case.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jy/rw/hk/jyrwhkavrimytpqs4je0ltfn7-w.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system calls on it the method </font></font><code>dispatchApplyWindowInsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">into which the insets come. </font><font style="vertical-align: inherit;">Back this View should return something. </font><font style="vertical-align: inherit;">What to do to handle this behavior? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For simplicity, we only consider WindowInsets.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handling insets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, redefinition of the method </font></font><code>dispatchApplyWindowInsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and implementation inside its own logic </font><font style="vertical-align: inherit;">seem logical </font><font style="vertical-align: inherit;">: insets came, we implemented everything inside. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you open the View class and look at the Javadoc written on top of this method, you can see: “Do not override this method!”</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We handle Insets through delegation or inheritance.</font></font></blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use delegation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Google provided the opportunity to expose its own delegate, who is responsible for handling insets. </font><font style="vertical-align: inherit;">You can install it through the method </font></font><code>setOnApplyWindowInsetsListener(listener)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We set a callback that handles these insets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If for some reason this does not suit us, you can </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inherit from View and override another method</font></font></strong> <code>onApplyWindowInsets(WindowInsets insets)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We substitute our own insets into it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google did not choose between delegation and inheritance, but allowed to do everything together. </font><font style="vertical-align: inherit;">This is great because we don’t have to redefine all Toolbar or ListView to handle insets. </font><font style="vertical-align: inherit;">We can take any ready-made View, even a library one, and set the delegate there, which will handle insets without redefinition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What shall we return?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why return something?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, you need to understand how the distribution of insets, i.e., ViewGroup, works. </font><font style="vertical-align: inherit;">What is she doing inside herself. </font><font style="vertical-align: inherit;">Let's take a closer look at the default behavior using the example I showed earlier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
System insets came at the top and bottom, for example, 100 pixels each. </font><font style="vertical-align: inherit;">The ViewGroup sends them to the first View that it has. </font><font style="vertical-align: inherit;">This View handled them somehow and returns insets: on the top it decreases to 0, but on the bottom it leaves. </font><font style="vertical-align: inherit;">At the top, she added padding or margin, but at the bottom she did not touch and reported this. </font><font style="vertical-align: inherit;">Next, the ViewGroup passes insets to the second View. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tj/-a/rw/tj-arwxjkus-n6xnvl099lqbqqg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next View processes and renders insets. </font><font style="vertical-align: inherit;">Now the ViewGroup sees that the insets are processed both above and below - there is nothing left, all the parameters are zero. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The third View doesn’t even know that there were some insets and something was happening</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">ViewGroup will return insets back to the one who exposed them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we started to deal with this topic, we wrote down the idea for ourselves - always return the same insets that came. </font><font style="vertical-align: inherit;">We wanted to avoid such a situation when some View did not even recognize that there were insets. </font><font style="vertical-align: inherit;">The idea looked logical. </font><font style="vertical-align: inherit;">But it turned out that no. </font><font style="vertical-align: inherit;">Google has not in vain added behavior to insets, as in the example. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is necessary so that insets always reach the entire hierarchy of the View and you can always work with them. </font><font style="vertical-align: inherit;">In this case, there will be no situation when we switch two fragments, one has processed, and the second has not yet received. </font><font style="vertical-align: inherit;">In the practice section, we will return to this point.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Theory is done. </font><font style="vertical-align: inherit;">Let's see how it looks in the code, because in theory everything is always smooth. </font><font style="vertical-align: inherit;">We will use AndroidX. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note. </font><font style="vertical-align: inherit;">In </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitFox,</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> everything is already implemented in the code, full support for all the goodies from the new Android. </font><font style="vertical-align: inherit;">In order not to check Android versions and not to search for the required type of Insets, always use the </font></font></em><code><em>view.setOnApplyWindowInsetsListener { v, insets -&gt; ... }</em></code><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">version from AndroidX - </font></font></em><font style="vertical-align: inherit;"><em><font style="vertical-align: inherit;">instead </font></em></font><code><em>ViewCompat.setOnApplyWindowInsetsListener(view) { v, insets -&gt; ... }</em></code><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a screen with a dark Navigation Bar. </font><font style="vertical-align: inherit;">It does not overlap any element on top. </font><font style="vertical-align: inherit;">Everything is the way we are used to.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3r/wq/sp/3rwqspgcdlgie2m00lmedkwzgi8.png" width="350"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But it turns out that now we need to make it transparent. </font><font style="vertical-align: inherit;">How?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turn on transparency</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The simplest thing is to indicate in the subject that the Status Bar and Navigation Bar are transparent.</font></font><br>
<br>
<pre><code class="kotlin hljs">&lt;style name=<span class="hljs-string">"AppTheme"</span> parent=<span class="hljs-string">"Theme.MaterialComponents.Light"</span>&gt;<font></font>
    &lt;item name=<span class="hljs-string">"android:windowTranslucentStatus"</span>&gt;<span class="hljs-literal">true</span>&lt;/item&gt;<font></font>
    &lt;item name=<span class="hljs-string">"android:windowTranslucentNavigation"</span>&gt;<span class="hljs-literal">true</span>&lt;/item&gt;<font></font>
&lt;/style&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this moment, everything begins to overlap each other both from above and from below. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interestingly, there are two flags, and there are always three options. If you specify transparency for the Navigation Bar, the Status Bar will become transparent by itself - such a limitation. </font><font style="vertical-align: inherit;">You can not write the first line, but I always love clarity, so I write 2 lines so that followers can understand what is happening, and not dig inside. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you choose this method, the Navigation Bar and Status Bar will turn black with transparency. </font><font style="vertical-align: inherit;">If the application is white, then you can add colors only from the code. </font><font style="vertical-align: inherit;">How to do it?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turn on transparency with color</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's good that we have a Single Activity application, so we put two flags in one activity.</font></font><br>
<br>
<pre><code class="kotlin hljs">rootView.systemUiVisibility = View.SYSTEM_UI_FLAG_LAYOUT_STABLE or  <font></font>
    View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION<font></font>
<font></font>
&lt;style name=<span class="hljs-string">"AppTheme"</span> parent=<span class="hljs-string">"Theme.MaterialComponents.Light"</span>&gt;<font></font>
    &lt;!-- Set the navigation bar to <span class="hljs-number">50</span>% translucent white --&gt;<font></font>
    &lt;item name=<span class="hljs-string">"android:navigationBarColor"</span>&gt;#<span class="hljs-number">80F</span>FFFFF&lt;/item&gt; <font></font>
&lt;/style&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are a lot of flags there, but it is these two that will help to make transparency in the Navigation Bar and Status Bar. </font><font style="vertical-align: inherit;">Color can be specified through the theme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the strange behavior of Android: something through the theme, and something through the flags. </font><font style="vertical-align: inherit;">But we can specify parameters both in the code and in the subject. </font><font style="vertical-align: inherit;">This is not Android so bad, just on older versions of Android the flag specified in the topic will be ignored. </font></font><code>navigationBarColor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will highlight that on Android 5 this is not, but everything will come together. </font><font style="vertical-align: inherit;">In GitFox, it was from the code that I set the color of the Navigation Bar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We carried out frauds - indicated that the Navigation Bar is white with transparency. </font><font style="vertical-align: inherit;">Now the application looks like this.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eo/vs/mz/eovsmz1tczlc9vl_kg2yihxs0u0.png" width="350"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What could be easier than handling insets?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indeed, elementary.</font></font><br>
<br>
<pre><code class="kotlin hljs">ViewCompat<font></font>
    .setOnApplyWindowInsetsListener(bottomNav) { view, insets -&gt;  <font></font>
        view.updatePadding(bottom = insets.systemWindowInsetBottom) <font></font>
        insets<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We take the method </font></font><code>setOnApplyWindowInsetsListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and pass it into it </font></font><code>bottomNav</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We say that when insets come, install the bottom padding that came in </font></font><code>systemWindowInsetBottom</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We want it underneath, but all of our clickable elements are on top. </font><font style="vertical-align: inherit;">We return fully insets so that all other View in our hierarchy also receive them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything looks great.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zl/8e/ku/zl8ekuc_pvpc2wrmeop-khxmomg.png" width="350"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there is a catch. </font><font style="vertical-align: inherit;">If in the layout we indicated some kind of padding at the Navigation Bar below, then here it was deleted - set </font></font><code>updatePadding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">insets equal. </font><font style="vertical-align: inherit;">Our layout does not look as we would like. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To save the values ​​from the layout, you must first save what is in the lower padding. </font><font style="vertical-align: inherit;">Later, when insets arrive, add and set the resulting values.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> bottomNavBottomPadding = bottomNav.paddingBottom<font></font>
ViewCompat<font></font>
    .setOnApplyWindowInsetsListener(bottomNav) { view, insets -&gt;                 <font></font>
        view.updatePadding(<font></font>
        bottom = bottomNavBottomPadding + insets.systemWindowInsetBottom<font></font>
    )<font></font>
    Insets<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It’s inconvenient to write like this: everywhere in the code where you use insets, you need to save the value from the layout, then add them to the UI. </font><font style="vertical-align: inherit;">But there is Kotlin, and this is wonderful - you can write your own extension, which will do all this for us.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add Kotlin!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We remember </font></font><code>initialPadding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and give it to the handler when new insets come (along with them). </font><font style="vertical-align: inherit;">This will help them somehow add together or build some kind of logic from above.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">doOnApplyWindowInsets</span><span class="hljs-params">(block: (<span class="hljs-type">View</span>, <span class="hljs-type">WindowInsetsCompat</span>, <span class="hljs-type">Rect</span>) -&gt; <span class="hljs-type">WindowInsetsCompat</span>)</span></span> {    <font></font>
<font></font>
    <span class="hljs-keyword">val</span> initialPadding = recordInitialPaddingForView(<span class="hljs-keyword">this</span>)<font></font>
<font></font>
    ViewCompat.setOnApplyWindowInsetsListener(<span class="hljs-keyword">this</span>) { v, insets -&gt;        <font></font>
        block(v, insets, initialPadding)<font></font>
    }<font></font>
    <font></font>
    requestApplyInsetsWhenAttached()<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordInitialPaddingForView</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span> =<font></font>
   Rect(view.paddingLeft, view.paddingTop, view.paddingRight, view.paddingBottom)<font></font>
<font></font>
  .<font></font>
<font></font>
bottomNav.doOnApplyWindowInsets { view, insets, padding -&gt;   <font></font>
    view.updatePadding(<font></font>
        bottom = padding.bottom + insets.systemWindowInsetBottom<font></font>
    ) <font></font>
    insets<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have to redefine the lambda. </font><font style="vertical-align: inherit;">It has not only insets, but also paddings. </font><font style="vertical-align: inherit;">We can add them not only from below, but also from above, if it is a Toolbar that processes the Status Bar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Something forgotten!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a call to an incomprehensible method.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">doOnApplyWindowInsets</span><span class="hljs-params">(block: (<span class="hljs-type">View</span>, <span class="hljs-type">WindowInsetsCompat</span>, <span class="hljs-type">Rect</span>) -&gt; <span class="hljs-type">WindowInsetsCompat</span>)</span></span> {<font></font>
<font></font>
    <span class="hljs-keyword">val</span> initialPadding = recordInitialPaddingForView(<span class="hljs-keyword">this</span>)<font></font>
     <font></font>
    ViewCompat.setOnApplyWindowInsetsListener(<span class="hljs-keyword">this</span>) { v, insets -&gt;        <font></font>
        block(v, insets, initialPadding)<font></font>
    }<font></font>
      <font></font>
    requestApplyInsetsWhenAttached() <font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordInitialPaddingForView</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span> =<font></font>
      Rect(view.paddingLeft, view.paddingTop, view.paddingRight, view.paddingBottom)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is due to the fact that you can’t just hope that the system will send you insets. </font><font style="vertical-align: inherit;">If we create a View from the code or install a </font></font><code>InsetsListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">little later, the system itself may not pass the last value. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We must check that when the View is on the screen, we told the system: "Insets have arrived, we want to process them." </font><font style="vertical-align: inherit;">We set the Listener and must make a request </font></font><code>requestsApplyInsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. "</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">requestApplyInsetsWhenAttached</span><span class="hljs-params">()</span></span> {    
    <span class="hljs-keyword">if</span> (isAttachedToWindow) {        <font></font>
        requestApplyInsets()<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        addOnAttachStateChangeListener(<span class="hljs-keyword">object</span> : View.OnAttachStateChangeListener {            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewAttachedToWindow</span><span class="hljs-params">(v: <span class="hljs-type">View</span>)</span></span> {<font></font>
                v.removeOnAttachStateChangeListener(<span class="hljs-keyword">this</span>)<font></font>
                v.requestApplyInsets()           <font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewDetachedFromWindow</span><span class="hljs-params">(v: <span class="hljs-type">View</span>)</span></span> = <span class="hljs-built_in">Unit</span><font></font>
        })<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we created a View code and have not yet attached it to our layout, then we must subscribe to the time when we do it. </font><font style="vertical-align: inherit;">Only then we request insets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But then again, there is Kotlin: they wrote a simple extension and we don’t have to think about it anymore.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refining RecyclerView</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's talk about finalizing the RecyclerView. The last element falls under the Navigation Bar and remains below - ugly. It’s also inconvenient to click on it. If this is not a new panel, but the old one, a large one, then in general the entire element may disappear under it. What to do? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jc/qa/f7/jcqaf7okahkrhrrnols54exqhdu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first idea is to add an element below, and set the height to fit insets. But if we have an application with hundreds of lists, then somehow we will have to subscribe each list to insets, add a new element there and set the height. In addition, RecyclerView is asynchronous, it is not known when it will work. There are many problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there is another official hack. Surprisingly, it works efficiently.</font></font><br>
<br>
<pre><code class="kotlin hljs">&lt;androidx.recyclerview.widget.RecyclerView <font></font>
        android:id=<span class="hljs-string">"@+id/recyclerView"</span>        
    android:layout_width=<span class="hljs-string">"match_parent"</span>    
    android:layout_height=<span class="hljs-string">"match_parent"</span>             
    android:clipToPadding=<span class="hljs-string">"false"</span> /&gt;<font></font>
<font></font>
recyclerView.doOnApplyWindowInsets { view, insets, padding -&gt;    <font></font>
    view.updatePadding(<font></font>
        bottom = padding.bottom + insets.systemWindowInsetBottom<font></font>
    )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is such a flag in the layout </font></font><code>clipToPadding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. By default, it is always true. This suggests that you do not need to draw elements that appear where padding is exposed. But if set </font></font><code>clipToPadding="false"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then you can draw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, if you set padding at the bottom, in RecyclerView it will work like this: at the bottom, padding is set, and the element is drawn on top of it until we scroll. Once reached the end, RecyclerView will scroll the elements to the position that we need. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By setting one such flag, we can work with RecyclerView as with a normal View. Do not think that there are elements that scroll - just set the padding below, as, for example, in the Bottom Navigation Bar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we always returned insets as if they were not processed. </font><font style="vertical-align: inherit;">The whole insets came to us, we did something with them, set the paddings and returned again all the whole insets. </font><font style="vertical-align: inherit;">This is necessary so that any ViewGroup always passes these insets to all View. </font><font style="vertical-align: inherit;">It works.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application bug</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In many applications on Google Play that have already processed insets, I noticed a small bug. Now I’ll tell about him. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a screen with navigation in the basement. On the right is the same screen that shows the hierarchy. The green fragment displays the content on the screen, inside it has a RecyclerView. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/e6/jo/hle6jod0ws19fydq734lqnuaixu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Who handled the insets here? Toolbar: he applied padding on top so that his content moves under the Status Bar. Accordingly, the Bottom Navigation Bar applied insets from below and rose above the Navigation Bar. But RecyclerView does not handle insets in any way, it does not fall under them, it does not need to process insets - everything is done correctly.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r3/xc/qi/r3xcqipovgqu-zbbxruxsy-wqvk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But here it turns out that we want to use the green RecyclerView fragment in another place where the Bottom Navigation Bar is no longer there. At this point, RecyclerView is already starting to handle insets from below. We need to apply padding to it to properly scroll from under the Navigation Bar. Therefore, in RecyclerView, we also add insets processing. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ve/ws/m-/vewsm-_o80cw7mbn9tyk0bu_mfs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We go back to our screen, where everyone processes insets. Remember, no one reports that he processed them? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/vd/x8/umvdx8faxxk48r-inx-cxhkjqdm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see this situation: RecyclerView processed insets from below, although it does not reach the Navigation Bar - a space appeared at the bottom. I noticed this in applications, and quite large and popular.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i9/3_/ar/i93_arxauyvbitayfpyonkxnudy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If this is the case, we remember that we return all insets to process. So (it turns out!) It is necessary to report that the insets are processed: Navigation Bar should report that the insets processed. They should not get to RecyclerView. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jf/r2/vi/jfr2vi8jpsas_ptxjjqh_qhg1vk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, install the Bottom Navigation Bar </font></font><code>InsetsListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Subtract inside </font></font><code>bottom + insets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that they are not processed, return 0.</font></font><br>
<br>
<pre><code class="kotlin hljs">doOnApplyWindowInsets { view, insets, initialPadding -&gt;    <font></font>
    view.updatePadding(<font></font>
        bottom = initialPadding.bottom + insets.systemWindowInsetBottom<font></font>
    )<font></font>
    insets.replaceSystemWindowInsets(<font></font>
        Rect(<font></font>
            insets.systemWindowInsetLeft,            <font></font>
            insets.systemWindowInsetTop,            <font></font>
            insets.systemWindowInsetRight,<font></font>
            <span class="hljs-number">0</span><font></font>
        )<font></font>
    )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We return new insets, in which all the old parameters are equal, but </font></font><code>bottom + insets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equal to 0. It seems that everything is fine. </font><font style="vertical-align: inherit;">We start and again nonsense - RecyclerView still handles insets for some reason. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lp/yw/ut/lpywut3fvlk5w-nwbd3-wnrceaw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did not immediately understand that the problem is that the container for these three Views is LinearLayout. </font><font style="vertical-align: inherit;">Inside them is a Toolbar, a snippet with a RecyclerView and at the bottom of the Bottom Navigation Bar. </font><font style="vertical-align: inherit;">LinearLayout takes its children in order and applies insets to them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that the Bottom Navigation Bar will be the last. </font><font style="vertical-align: inherit;">He told someone that he processed all the insets, but it was too late. </font><font style="vertical-align: inherit;">All insets were processed from top to bottom, RecyclerView has already received them, and this does not save us. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uj/mm/jd/ujmmjdgumv0bl6e0ewydx7ueq5g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What to do? </font><font style="vertical-align: inherit;">LinearLayout does not work the way I want, it transfers them from top to bottom, and I need to get the bottom one first.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redefine All</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Java developer played in me - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">everything</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> needs to be </font><strong><font style="vertical-align: inherit;">redefined</font></strong><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Well, now </font></font><code>dispatchApplyWindowInsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redefine, set </font></font><code>yLinearLayout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which will always go from bottom to top. </font><font style="vertical-align: inherit;">He will first send insets Bottom Navigation Bar, and then to everyone else.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> WindowInsets dispatchApplyWindowInsets(WindowInsets insets) {     <font></font>
    insets = <span class="hljs-keyword">super</span>.dispatchApplyWindowInsets(insets);     
    <span class="hljs-keyword">if</span> (!insets.isConsumed()) {        
        <span class="hljs-keyword">final</span> int count = getChildCount();
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; count; i++) {<font></font>
            insets = getChildAt(i).dispatchApplyWindowInsets(insets);<font></font>
            <span class="hljs-keyword">if</span> (insets.isConsumed()) {
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> insets;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But I stopped in time, remembering the comment that there was no need to redefine this method. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, a little higher is the salvation: ViewGroup checks for a delegate that processes the insets, then calls the super method on View and includes its own processing. </font><font style="vertical-align: inherit;">In this code, we get insets, and if they have not been processed yet, we begin the standard logic for our children. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wrote a simple extension. </font><font style="vertical-align: inherit;">It allows, applying </font></font><code>InsetsListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to one View, to say to whom these insets pass.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">addSystemBottomPadding</span><span class="hljs-params">(    
    targetView: <span class="hljs-type">View</span> = this
)</span></span> {<font></font>
    doOnApplyWindowInsets { _, insets, initialPadding -&gt;           <font></font>
        targetView.updatePadding(<font></font>
            bottom = initialPadding.bottom + insets.systemWindowInsetBottom<font></font>
        )<font></font>
        insets.replaceSystemWindowInsets(<font></font>
            Rect(<font></font>
                insets.systemWindowInsetLeft,<font></font>
                insets.systemWindowInsetTop,     <font></font>
                insets.systemWindowInsetRight,<font></font>
                <span class="hljs-number">0</span><font></font>
            )<font></font>
        )<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here it </font></font><code>targetView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is equal by default to the same View on top of which we apply </font></font><code>addSystemBottomPadding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We can redefine it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On my LinearLayout I hung such a handler, passing as </font></font><code>targetView</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is my Bottom Navigation Bar.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First he will give insets Bottom Navigation Bar.&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That will process insets, will return zero bottom.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further, by default, they will go from top to bottom: Toolbar, fragment with RecyclerView.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then, perhaps, he will again send insets Bottom Navigation Bar. </font><font style="vertical-align: inherit;">But this is no longer important, everything will work so well.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I achieved exactly what I wanted: all insets are processed in the order in which they are needed.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s3/b0/nc/s3b0nc07bayude3nvrvevkxnwyc.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A few important things to keep in mind. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The keyboard is the system UI on top of your application.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No need to treat her in a special way. If you look at the Google keyboard, it’s not just a Layout with buttons that you can click on. There are hundreds of modes for this keyboard: searching for gifs and memes, voice input, resizing from 10 pixels in height to screen sizes. Do not think about the keyboard, but subscribe to insets. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Navigation Drawer still does not support gesture navigation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">At Google IO, they promised that everything would work out of the box. </font><font style="vertical-align: inherit;">But in Android 10, Navigation Drawer still does not support this. </font><font style="vertical-align: inherit;">If you upgrade to Android 10 and enable navigation with gestures, Navigation Drawer will fall off. </font><font style="vertical-align: inherit;">Now you need to click on the hamburger menu to make it appear, or a combination of random circumstances allows you to stretch it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the pre-alpha version of Android, Navigation Drawer works, but I did not dare to update - this is pre-alpha. </font><font style="vertical-align: inherit;">Therefore, even if you install the latest version of GitFox from the repository, there is a Navigation Drawer there, but it cannot be pulled. </font><font style="vertical-align: inherit;">As soon as official support comes out, I will update and everything will work fine.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android 10 Preparation Checklist</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set the transparency of the Navigation Bar and Status Bar from the beginning of the project</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Google strongly recommends maintaining a transparent Navigation Bar. For us, this is an important practical part. If the project works, but you didn’t turn it on, take the time to support Android 10. Turn on them first in the subject, like translucent, and correct the layout where it broke. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add extensions to Kotlin</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - it's easier with them. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add to all the Toolbar on top of the padding.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Toolbars are always at the top, and that's what you need to do. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For all RecyclerViews, add padding from the bottom</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the ability to scroll through </font></font><code>clipToPadding="false"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Think of all the buttons on the edges of the screen </font></font></strong><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(FAB)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . FABs will most likely not be where you expect.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not override or make your own implementations for all LinearLayout</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and other similar cases. Do the trick, as in GitFox, or take my ready-made extension to help. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check the gestures at the edges of the screen for custom View</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Navigation Drawer does not support this. But it’s not so difficult to support it with your hands, to redefine insets for gestures on the screen with Navigation Drawer. Perhaps you have picture editors where gestures work. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scrolling in ViewPager does not work from the edge, but only from the center to the right and left</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Google says this is normal. If you pull the ViewPager from the edge, then it is perceived as pressing the "Back" button. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a new project, immediately include all the transparency</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">You can tell designers that you do not have a Navigation Bar and a Status Bar. </font><font style="vertical-align: inherit;">The whole square is your application content. </font><font style="vertical-align: inherit;">And the developers will already figure out where and what to raise. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Useful links:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@rmr_spb in a telegram - records of internal mitaps of Redmadrobot SPb.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All source code in this article and even more in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitFox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There is a separate Android 10 branch, where you can see by commit how I got to all this and how I supported the new Android.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chris Bane's </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Insetter Library</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It contains 5-6 extensions that I showed. </font><font style="vertical-align: inherit;">To use in your project, contact the library, most likely it will move to Android Jetpack. </font><font style="vertical-align: inherit;">I developed them in my project and, it seems to me, they got better.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chris Bane's </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">article</font></a><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>   FunCorn,    ,      .</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Why would I want to fitsSystemWindows?</a>»  .</li>
</ul><br>
<blockquote>    AppConf,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">youtube-</a>      .            ,     - .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">AppsConf</a>     ,            .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>, stay tuned!</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488186/index.html">My QA Engineer Path: Through Burnout to High Testing</a></li>
<li><a href="../en488188/index.html">Reforestation after fires: How nanoparticles protect tree microclones</a></li>
<li><a href="../en488190/index.html">Once again about emotional burnout</a></li>
<li><a href="../en488192/index.html">Helm device and its pitfalls</a></li>
<li><a href="../en488194/index.html">Why are we writing programs of such poor quality?</a></li>
<li><a href="../en488198/index.html">What are the Timlids afraid of and why should they stop doing this</a></li>
<li><a href="../en488200/index.html">The debate about the first programming language: the final decision</a></li>
<li><a href="../en488202/index.html">PVS-Studio is now in Chocolatey: checking Chocolatey from Azure DevOps</a></li>
<li><a href="../en488208/index.html">Anniversary DUMP2020 - 4 days that you will not forget</a></li>
<li><a href="../en488210/index.html">Recognizing objects on android using TensorFlow: from data preparation to launch on the device</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>