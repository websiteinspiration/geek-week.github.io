<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💆🏿 🤙🏻 🎰 マルチプレイヤーゲームをC ++からWebにCheerp、WebRTC、Firebaseで移植します ♂️ 🌛 ✍️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 当社のLeaning Technologiesは、従来のデスクトップアプリケーションをWebに移植するためのソリューションを提供しています。当社のC ++ Cheerpコンパイラは、WebAssemblyとJavaScriptの組み合わせを生成します。これにより、簡単なブラウザ操作と高性能...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>マルチプレイヤーゲームをC ++からWebにCheerp、WebRTC、Firebaseで移植します</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468031/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当社の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leaning Technologies</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、従来のデスクトップアプリケーションをWebに移植するためのソリューションを提供しています。</font><font style="vertical-align: inherit;">当社のC ++ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cheerpコンパイラ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、WebAssemblyとJavaScriptの組み合わせを生成します。これにより、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">簡単なブラウザ操作</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と高性能の</font><font style="vertical-align: inherit;">両方が提供されます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのアプリケーションの例として、マルチプレイヤーゲームをWebに移植することを決定し、これに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teeworlds</font></font></strong></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を選択しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Teeworldsはマルチプレイヤーの2次元レトロゲームで、小さな（ただし私も含む）プレイヤーのコミュニティが存在します。</font><font style="vertical-align: inherit;">ダウンロード可能なリソースとCPUおよびGPU要件の両方の点で小さい-理想的な候補です。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8bb/70c/bb8/8bb70cbb863efd3e58cec7da962558a7.png" width="956" height="892"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teeworldsブラウザーで動作します</font></font></i><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロジェクトを使用</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して、ネットワークコードをWebに移植するための一般的なソリューション</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を試すことにし</font><strong><font style="vertical-align: inherit;">ました</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは通常、次の方法で行われます。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XMLHttpRequest / fetch（</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワーク部分がHTTPリクエストのみで構成されている場合）、または</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebSockets</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どちらのソリューションでも、サーバー側でサーバーコンポーネントをホストする必要があり、どのプロトコルでも</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UDP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をトランスポートプロトコルとして使用することはできません</font><font style="vertical-align: inherit;">。これは、ビデオ会議やゲームソフトウェアなどのリアルタイムアプリケーションにとって重要です。これは、配信の保証と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パケットの順序付け</font><font style="vertical-align: inherit;">が低遅延を妨げる可能性があるためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目の方法があります-ブラウザからネットワークを使用する：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC</font></font></strong></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTCDataChannel</font></font></strong></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、信頼性のある伝送と信頼性のない伝送の両方をサポートし（後者の場合、可能であれば、トランスポートプロトコルとしてUDPを使用しようとします）、リモートサーバーとブラウザーの両方で使用できます。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、サーバーコンポーネントを含むアプリケーション全体をブラウザーに移植できることを意味します。</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、これはさらに困難です。2つのWebRTCピアがデータを交換する前に、接続のために比較的複雑なハンドシェイク手順を実行する必要があります。これには、いくつかのサードパーティエンティティ（シグナルサーバーと1つ以上の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STUN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TURN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー</font><font style="vertical-align: inherit;">）が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理想的には、WebRTCを使用して内部的にネットワークAPIを作成したいのですが、接続を確立する必要のないUDPソケットインターフェースにできるだけ近いものにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、アプリケーションコードに複雑な詳細を開示する必要なく（プロジェクトで可能な限り変更を加えたくなかった）WebRTCを利用できるようになります。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小WebRTC</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebRTCは、ピアツーピアのオーディオ、ビデオ、および任意のデータ転送を提供するブラウザーで使用可能なAPIのセットです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ピア間の接続は、ICEと呼ばれるメカニズムを通じてSTUNサーバーまたはTURNサーバー、あるいはその両方を使用して確立されます（片側または両側にNATがある場合でも）。</font><font style="vertical-align: inherit;">ピアは、SDPオファーおよびアンサープロトコルを介してICE情報およびチャネルパラメータを交換します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
うわー！</font><font style="vertical-align: inherit;">一度にいくつの略語。</font><font style="vertical-align: inherit;">これらの概念の意味を簡単に説明しましょう。</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NATのセッショントラバーサルユーティリティ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STUN</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><strong><font style="vertical-align: inherit;">-NAT</font></strong></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をバイパスし、ホストと直接データを交換するためのペア（IP、ポート）を受信するためのプロトコル。</font><font style="vertical-align: inherit;">彼がなんとか自分のタスクを完了することができた場合、ピアは互いに独立してデータを交換できます。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><strong>Traversal Using Relays around NAT</strong> (<strong>TURN</strong>)</a>     NAT,    ,    ,   .        ,  STUN (       ),      .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><strong>Interactive Connectivity Establishment</strong> (<strong>ICE</strong>)</a>            ,     ,   ,     STUN  TURN.</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><strong>Session Description Protocol</strong> (<strong>SDP</strong>)</a> —      , ,  ICE,   (  /),  .…     SDP Offer («»),    SDP Answer («»).    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような接続を作成するには、ピアはSTUNサーバーとTURNサーバーから受信した情報を収集し、相互に交換する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は、データを直接交換する機能がまだないため、このデータを交換するためのアウトオブバンドメカニズム、つまりシグナルサーバーが必要であるということです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シグナルサーバーは非常に単純な場合があります。これは、「ハンドシェイク」段階でピア間でデータをリダイレクトすることだけが目的であるためです（下の図を参照）。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5ac/972/ba0/5ac972ba057357540ffd749081dbdd3b.png" width="783" height="710"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC簡易ハンドシェイクシーケンス</font></font></i><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teeworldsネットワークモデルの概要</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teeworldsのネットワークアーキテクチャは非常にシンプルです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントとサーバーのコンポーネントは、2つの異なるプログラムです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントは、複数のサーバーの1つに接続してゲームに参加します。各サーバーは、一度に1つのゲームのみをホストします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゲーム内のすべてのデータ転送はサーバーを通じて行われます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特別なマスターサーバーを使用して、ゲームクライアントに表示されるすべてのパブリックサーバーのリストを収集します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データ交換にWebRTCを使用したおかげで、ゲームのサーバーコンポーネントをクライアントが配置されているブラウザーに転送できます。</font><font style="vertical-align: inherit;">それは私たちに素晴らしい機会を与えてくれます...</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーを取り除く</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーロジックの欠如には大きな利点があります。GithubPagesまたはCloudflareの背後にある独自の機器に静的コンテンツとしてアプリケーション全体をデプロイできるため、高速ダウンロードと高いアップタイムを無料で保証できます。</font><font style="vertical-align: inherit;">実際、それらを忘れることは可能であり、幸運でゲームが人気になれば、インフラストラクチャを最新化する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、システムが機能するためには、外部アーキテクチャを使用する必要があります。</font></font><br>
<br>
<ul>
<li>    STUN:        .</li>
<li>     TURN:    ,      ,    .  ,          STUN (   p2p),  TURN    .</li>
<li> :      ,   . ,         ,  -   .           .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teeworldsマスターサーバー：他のサーバーがその存在を通知するために使用し、クライアントがパブリックサーバーを検索するために使用します。</font><font style="vertical-align: inherit;">必須ではありませんが（クライアントは常に手動で知っているサーバーに接続できます）、プレイヤーがランダムな人とゲームに参加できるようにすると便利です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはGoogleの無料のSTUNサーバーを使用することを決定し、1台のTURNサーバーを独自にデプロイしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の2つのポイントでは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firebase</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用しました</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ul>
<li>- Teeworlds   :   ,   (, IP, , , …)   .       ,         .         HTML,            .</li>
<li>      ,    .</li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d6/ae6/72d/3d6ae672db99216dabcf0a792d008f5e.png" width="1697" height="513"></div><br>
<i>       </i><br>
<br>
<h1> </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要な変更の数を最小限に抑えるために、Posix UDPソケットのできるだけ近くにAPIを作成したいと考えています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ネットワークを介した最も簡単なデータ交換に必要な最小限の機能も実装したいと考えています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、実際のルーティングは必要ありません。すべてのピアは、Firebaseデータベースの特定のインスタンスに関連付けられた同じ「仮想LAN」にあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、一意のIPアドレスは必要ありません。ピアを一意に識別するには、Firebaseキーの一意の値（ドメイン名と同様）を使用するだけで十分です。各ピアは、変換が必要な各キーに「偽の」IPアドレスをローカルに割り当てます。</font><font style="vertical-align: inherit;">これにより、重要なタスクであるグローバルIPアドレスの割り当てが不要になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実装する必要がある最小のAPIは次のとおりです。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Create and destroy a socket</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">socket</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">close</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;
<span class="hljs-comment">// Bind a socket to a port, and publish it on Firebase</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bind</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, AddrInfo* addr)</span></span>;
<span class="hljs-comment">// Send a packet. This lazily create a WebRTC connection to the </span>
<span class="hljs-comment">// peer when necessary</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sendto</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint8_t</span>* buf, <span class="hljs-keyword">int</span> len, <span class="hljs-keyword">const</span> AddrInfo* addr)</span></span>;
<span class="hljs-comment">// Receive the packets destined to this socket</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">recvfrom</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint8_t</span>* buf, <span class="hljs-keyword">int</span> len, AddrInfo* addr)</span></span>;
<span class="hljs-comment">// Be notified when new packets arrived</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">recvCallback</span><span class="hljs-params">(Callback cb)</span></span>;
<span class="hljs-comment">// Obtain a local ip address for this peer key</span>
<span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">resolve</span><span class="hljs-params">(client::String* key)</span></span>;
<span class="hljs-comment">// Get the peer key for this ip</span>
<span class="hljs-function">String* <span class="hljs-title">reverseResolve</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> addr)</span></span>;
<span class="hljs-comment">// Get the local peer key</span>
<span class="hljs-function">String* <span class="hljs-title">local_key</span><span class="hljs-params">()</span></span>;
<span class="hljs-comment">// Initialize the library with the given Firebase database and </span>
<span class="hljs-comment">// WebRTc connection options</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(client::FirebaseConfig* fb, client::RTCConfiguration* ice)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIはシンプルでPosix Sockets APIに似てい</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ますが、コールバックの登録、ローカルIPの割り当て、遅延接続など、</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかの重要な違いがあり</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コールバック登録</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースプログラムがノンブロッキングI / Oを使用している場合でも、Webブラウザーで実行するにはコードをリファクタリングする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この理由は、ブラウザーのイベントループがプログラムから隠されているためです（JavaScriptでもWebAssemblyでも）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネイティブ環境では、この方法でコードを書くことができます</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span>(running) {<font></font>
  select(...); <span class="hljs-comment">// wait for I/O events</span>
  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">int</span> r = readfrom(...); <span class="hljs-comment">// try to read</span>
    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span> &amp;&amp; errno == EWOULDBLOCK) <span class="hljs-comment">// no more data available</span>
      <span class="hljs-keyword">break</span>;<font></font>
    ...<font></font>
  }<font></font>
  ...<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントループが非表示になっている場合は、次のようにする必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">auto</span> cb = []() { <span class="hljs-comment">// this will be called when new data is available</span>
  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">int</span> r = readfrom(...); <span class="hljs-comment">// try to read</span>
    <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span> &amp;&amp; errno == EWOULDBLOCK) <span class="hljs-comment">// no more data available</span>
      <span class="hljs-keyword">break</span>;<font></font>
    ...<font></font>
  }<font></font>
  ...<font></font>
};<font></font>
recvCallback(cb); <span class="hljs-comment">// register the callback</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルIP割り当て</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「ネットワーク」内のノードの識別子はIPアドレスではなく、Firebaseキーです（これらは次のような行です）</font></font><code>-LmEC50PYZLCiCP-vqde</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、IPを割り当ててその一意性をチェックするためのメカニズム（およびクライアントを切断した後の廃棄）を必要としないため便利ですが、多くの場合、数値によってピアを識別する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが機能</font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と使用される</font><font style="vertical-align: inherit;">目的</font></font><code>reverseResolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。アプリケーションは何らかの方法でキーの文字列値を取得し（ユーザー入力またはマスターサーバーを介して）、内部使用のためにIPアドレスに変換できます。簡単にするために、APIの残りの部分も文字列ではなくこの値を受け取ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはDNSルックアップに似ており、クライアントでローカルにのみ実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、IPアドレスを異なるクライアント間で共有することはできません。ある種のグローバル識別子が必要な場合は、別の方法で生成する必要があります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レイジーミックス</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UDPは接続を必要としませんが、2つのピア間のデータ転送を開始する前に、WebRTCは長い接続プロセスを必要とします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じレベルの抽象化を提供する場合（</font></font><code>sendto</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>recvfrom</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初に接続せずに任意のピアを使用）、API内で「遅延」（遅延）接続を行う必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、UDPを使用する場合の「サーバー」と「クライアント」の間のデータの通常の交換中に発生することと、ライブラリが行うべきことです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーは</font></font><code>bind()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、指定されたポートでパケットを受信することをオペレーティングシステムに通知するために</font><font style="vertical-align: inherit;">呼び出し</font><font style="vertical-align: inherit;">ます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
代わりに、サーバーのキーの下でFirebaseのオープンポートを公開し、そのサブツリーでイベントをリッスンします。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーは</font></font><code>recvfrom()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、任意のホストからこのポートへのパケットを受け入れることによって</font><font style="vertical-align: inherit;">呼び出し</font><font style="vertical-align: inherit;">ます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、このポートに送信されたパケットの着信キューを確認する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各ポートには独自のキューがあり、送信元ポートと宛先ポートをWebRTCデータグラムの先頭に追加して、新しいパケットが到着したときにリダイレクトするキューを認識します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
呼び出しは非ブロッキングなので、パケットがない場合は、単に-1を返し、を設定し</font></font><code>errno=EWOULDBLOCK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントは、何らかの外部手段でサーバーのIPとポートを受信し、を呼び出します</font></font><code>sendto()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">また、内部呼び出しが行われる</font></font><code>bind()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、次の</font><font style="vertical-align: inherit;">呼び出しは</font></font><code>recvfrom()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明示的にバインドを実行せずに応答を受け取ります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの場合、クライアントは外部で文字列キーを受け取り、関数</font></font><code>resolve()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してIPアドレスを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、2つのピアがまだ相互に接続されていない場合は、WebRTCの「ハンドシェイク」を開始します。</font><font style="vertical-align: inherit;">同じピアの異なるポートへの接続は、同じDataRannel WebRTCを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また</font></font><code>bind()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、サーバーが</font></font><code>sendto()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何らかの理由で閉じた場合に</font><font style="vertical-align: inherit;">サーバーが次のサーバーに再接続できるように</font><font style="vertical-align: inherit;">、間接</font><font style="vertical-align: inherit;">サーバーを実行します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントがFirebaseのサーバーポート情報の下にSDPオファーを書き込むと、サーバーはクライアントに接続することを通知され、サーバーは独自の応答で応答します。</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の図は、ソケットスキームのメッセージの移動と、クライアントからサーバーへの最初のメッセージの送信の例を示しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b4e/03a/024/b4e03a0246a77f74034c3b823bc7a1a6.png" width="787" height="1656"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントとサーバー間の完全な接続ステップ図</font></font></i><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後まで読んだことがあるなら、おそらく理論を実際に見てみたいと思うでしょう。</font><font style="vertical-align: inherit;">ゲームは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">teeworlds.leaningtech.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">プレイできます</font><font style="vertical-align: inherit;">。お試しください！</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同僚同士の友好的なマッチング</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ネットワークライブラリのコードは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Githubから</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">無料で入手できます</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gitterの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チャンネルで</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="noopener"><font style="vertical-align: inherit;">チャット</font></a><font style="vertical-align: inherit;">に参加してください</font><font style="vertical-align: inherit;">！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja468019/index.html">NetCore 3とBlazorを使用したWebAssemblyでのWebサイト開発</a></li>
<li><a href="../ja468021/index.html">PHP、人々にとってどれだけ抽象化されているのですか？</a></li>
<li><a href="../ja468023/index.html">格闘ゲームShadow Fight 3の人工知能</a></li>
<li><a href="../ja468025/index.html">Zimbra OSEでSNIを構成する方法</a></li>
<li><a href="../ja468027/index.html">Reddのコード最適化メソッド。パート2：キャッシュ不可メモリとパラレルバス操作</a></li>
<li><a href="../ja468035/index.html">ゲームコントローラを使用してプレスをダウンロードするか、入力デバイスに関する8つの珍しい特許</a></li>
<li><a href="../ja468039/index.html">モスクワKubernetes Meetup＃6 at Acronis（Fiztehpark）2019/03/10</a></li>
<li><a href="../ja468041/index.html">Kubernetes Web Viewウェブインターフェースの発表（およびKubernetesの他のウェブUIの概要）</a></li>
<li><a href="../ja468043/index.html">販売中のUIキットの作成方法。商用設計システムの開発段階</a></li>
<li><a href="../ja468047/index.html">lsFusionでの階層の操作</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>