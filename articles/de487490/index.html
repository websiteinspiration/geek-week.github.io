<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💆🏿 💒 👨🏼 XSL-Transformation unter MS SQL ohne CLR 🧑🏿‍🤝‍🧑🏾 👆🏿 🧚🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Manchmal ist es sehr praktisch, Briefe direkt aus der Datenbank zu senden, z. B. Benachrichtigungen über den Erfolg / Misserfolg einiger Aktionen, Inf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>XSL-Transformation unter MS SQL ohne CLR</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487490/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manchmal ist es sehr praktisch, Briefe direkt aus der Datenbank zu senden, z. B. Benachrichtigungen über den Erfolg / Misserfolg einiger Aktionen, Informationen zum Systemstatus, Benutzeraktionsprotokolle usw. Es mag wie Wildheit erscheinen, ein monströses Fahrrad, eine krumme Lösung usw. - aber stellen Sie sich vor, es ist so. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Inhalt des Briefes mit dieser Methode muss im Klartext erstellt werden, und E-Mails werden entweder über xp_sendmail oder (flexibler) über ein COM-Mail-Objekt (z. B. CDO.Message) gesendet, um ihn über SQL-Wrapper zu instanziieren und zu verwalten, damit er mit OLE sp_OAxxxx funktioniert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beide funktionieren, solange Sie über genügend Ausdrucksmittel für Painttext verfügen, die Hierarchie Ihrer Daten nahe Null ist und der Bericht ausschließlich von einem technischen Diplom der alten Schule verwendet wird</font></font><br>
<br>
<code>+-----------+--------------+--------------+<br>
|  |    |    |<br>
|  |   |  &lt;EOT&gt; |<br>
+-----------+--------------+--------------+<br>
</code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was tun, wenn ein ähnliches Format anfängt, Ihre Komponenten zu belasten und auf dem Server zu registrieren, oder von der Datenbankebene zur Anwendungsebene "auftaucht", um etwas Schöneres zu senden? Ich möchte wirklich nicht:</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oft müssen Briefe noch formatiert werden (z. B. wenn ein Teil der Prüftabelle gesendet wird) und in HTML gesendet werden, zumindest in einem minimalen (Unternehmens-) Design - und hier beginnt bereits eine unangenehme Routine - es ist sehr mühsam, HTML Zeile für Zeile mit T-SQL zu generieren. Insbesondere wenn es mehrere verschiedene Arten von E-Mail-Berichten gibt, ist die Berichtsstruktur hierarchisch und das Design ist allgemein und das darin enthaltene CSS verbreitet sich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Welt der Anwendungsebene wurde vor 20 Jahren ein erstaunlicher XML / XSL-Dipol erfunden, der so kohärent ist, dass die Syntaxbeschreibung seiner letzten Komponente für die Zeit zwischen dem Lesen eines Beispiels aus MSDN und dem Schreiben eines Elements einer eigenen Vorlage kaum berücksichtigt wird.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun gut - letztendlich sind hierarchische Informationen auch viel bequemer in XML darzustellen, und MS SQL macht dies in den letzten 15 Jahren von Haus aus sehr gut. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schöne Buchstaben sind also nur einen Steinwurf entfernt - alles, was bleibt, ist einen Weg zu finden, um diesem Fahrrad die XSL-Transformation hinzuzufügen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider ist MS SQL nicht in der Lage, dies zu tun, und daher wird unser Fahrrad ein weiteres OLE-Rad enthalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir im Speicher und im Internet gestöbert haben, erinnern wir uns, dass wir Microsoft.XMLDOM haben, das den Igel und die Schlange durch Aufrufen der transformNode-Methode kreuzen kann, und es scheint, dass unsere Aufgabe darin besteht, alles korrekt zu installieren, das Ergebnis aufzunehmen, mögliche Fehler zu verarbeiten und alles zu beheben, um dies zu erreichen Speicher nicht fließen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sind auf dem richtigen Weg und sp_OACreate, sp_OAMethod, sp_OAGet / SetProperty und sp_OADestroy werden uns helfen, aber es gibt ein kleines Detail - wenn die Methode einen Zeiger zurückgibt, ist alles in Ordnung, aber wenn ein Skalar schlecht ist, weil Ein String-Skalar kann nicht länger als die Grundkonstante von 8 kB sein. Mit dieser Einschränkung wird unser Beispiel für immer lehrreich bleiben - da das resultierende Dokument mit 4 (8) tausend Zeichen in unserem Jahrhundert ein Lachen ist, und das ist alles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir gingen durch ein langes Labyrinth und einen Schritt vom Ausgang entfernt, sehen schon das Licht, aber bams! - Der Ausgang ist durch ein Gitter verschlossen. Es gibt keine Möglichkeit, einen String, der länger als 8 KB ist, von einem OLE-Wrapper zu erhalten. Der Versuch, den Typ von (n) varchar (MAX) als Empfangsparameter anzugeben, führt zu einem unhörbaren OLE-Fehler.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir verstehen, dass wir irgendwie etwas brauchen, das keinen Skalar zurückgibt, sondern einen Zeiger auf das Ergebnis (weil ein Zeiger auf SQL nur eine Zahl ist). Es ist jedoch nicht möglich, die transformNode-Methode zu zwingen, einen Zeiger zurückzugeben. Nachdem wir verzweifelt sind, steigen wir in MSDN (oder was auch immer online ist) ein und sehen, dass sich XMLDOM in den letzten 15 Jahren weiterentwickelt hat - MS bietet jetzt die transformNodeToObject-Methode an - BINGO !!! Die Methode nimmt einen Zeiger auf den Stream, in den sie den Inhalt des Dokuments gießt! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann ist es ganz einfach: Wir erstellen ein Stream-Objekt, übergeben es an die Methode und weisen es an, das Dokument in den Stream zu gießen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis - im Stream mit uns - ein Dokument. Wie zieht man es in einen Skalar? Es ist auch einfach </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, das Meer mit Kreisen in</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Stücken von nicht mehr als 8 KB zu schöpfen und das Ergebnis in Stücken in Varchar (MAX) zu kleben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie nicht, dass Sie, bevor Sie alles subtrahieren, Folgendes tun müssen: a) Lesen Sie die aktuelle Größe aus dem Stream - dies ist die Anzahl der Zeichen, die wir daraus abrufen müssen, und b) setzen Sie den Zeiger, um den Stream am Anfang zu lesen. </font><font style="vertical-align: inherit;">Andernfalls gibt es nichts zu lesen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, schließlich müssen Sie sorgfältig nach sich selbst aufräumen. </font><font style="vertical-align: inherit;">Es ist wünschenswert, dass alles, was geschaffen wurde, zerstört wird und ob es ein Fehler war oder nicht, und wenn ja, welche Phase ist dann passiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist das Ergebnis:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> [dbo].[f_Helper_XSLTransform]<font></font>
(<font></font>
	@XMLData	<span class="hljs-keyword">XML</span>,<font></font>
	@XSLTemplate	<span class="hljs-keyword">XML</span><font></font>
)<font></font>
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>)
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">BEGIN</span><font></font>
<font></font>
	<span class="hljs-keyword">IF</span> @XMLData <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">OR</span> @XSLTemplate <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>
		<span class="hljs-keyword">RETURN</span> <span class="hljs-string">'XML or XSL data is NULL'</span><font></font>
		 <font></font>
	<span class="hljs-keyword">DECLARE</span>	@OLEActionName	<span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">128</span>),<font></font>
		@PropOrMethodName	<span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">128</span>)<font></font>
<font></font>
	<span class="hljs-keyword">DECLARE</span> @hr				<span class="hljs-built_in">INT</span>, <font></font>
		@dummy			<span class="hljs-built_in">INT</span>,<font></font>
		@ObjXML			<span class="hljs-built_in">INT</span>, <font></font>
		@ObjXSL			<span class="hljs-built_in">INT</span>,<font></font>
		@ObjStream		<span class="hljs-built_in">INT</span>,<font></font>
		@BuffSize			<span class="hljs-built_in">INT</span><font></font>
<font></font>
	<span class="hljs-keyword">DECLARE</span> @<span class="hljs-keyword">Result</span>			<span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>) = N<span class="hljs-string">''</span>,<font></font>
		@<span class="hljs-keyword">Chunk</span>			<span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-number">4000</span>),		<span class="hljs-comment">-- VVVV should match VVVV</span>
		@ChunkCharSize	<span class="hljs-built_in">INT</span> = <span class="hljs-number">4000</span>,			<span class="hljs-comment">-- ^^^^^^^^^^^^^^^^^^^^^^</span>
		@ResultBuff		<span class="hljs-keyword">NVARCHAR</span>(<span class="hljs-keyword">MAX</span>) = N<span class="hljs-string">''</span>	<span class="hljs-comment">-- chunk concat buffer</span><font></font>
<font></font>
	<span class="hljs-comment">-- create XMLDOM object for @XMLData</span>
	<span class="hljs-keyword">SET</span> @OLEActionName 	= <span class="hljs-string">'sp_OACreate'</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'Microsoft.XMLDOM'</span><font></font>
	<font></font>
	EXEC @hr = sp_OACreate @PropOrMethodName, @ObjXML <span class="hljs-keyword">OUT</span>
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
	<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- create XMLDOM object for @XSLData</span>
	EXEC @hr = sp_OACreate @PropOrMethodName, @ObjXSL <span class="hljs-keyword">OUT</span>
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- create ADODB.Stream object as transformation buffer</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'ADODB.Stream'</span><font></font>
<font></font>
	EXEC @hr = sp_OACreate @PropOrMethodName, @ObjStream <span class="hljs-keyword">OUT</span>
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- load XML data</span>
	<span class="hljs-keyword">SET</span> @OLEActionName 	= <span class="hljs-string">'sp_OAMethod'</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'LoadXML'</span><font></font>
<font></font>
	EXEC @hr = sp_OAMethod @ObjXML, @PropOrMethodName, @dummy <span class="hljs-keyword">OUT</span>, @XMLData
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- load XSL data</span>
	EXEC @hr = sp_OAMethod @ObjXSL, @PropOrMethodName, @dummy <span class="hljs-keyword">OUT</span>, @XSLTemplate
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- open the stream</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'Open'</span><font></font>
	<font></font>
	EXEC @hr = sp_OAMethod @ObjStream, @PropOrMethodName, <span class="hljs-literal">NULL</span>
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- trying to do XSL transformation, using the stream as the receiver to work around 4/8K limitation</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'TransformNodeToObject'</span><font></font>
<font></font>
	EXEC @hr = sp_OAMethod @ObjXML, @PropOrMethodName, <span class="hljs-literal">NULL</span>, @ObjXSL, @ObjStream
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- get the size of the stream to read back</span>
	<span class="hljs-keyword">SET</span> @OLEActionName 	= <span class="hljs-string">'sp_OAGetProperty'</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'Size'</span><font></font>
	<font></font>
	EXEC @hr = sp_OAGetProperty @ObjStream, @PropOrMethodName, @BuffSize <span class="hljs-keyword">OUT</span>
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- re-position the stream to the head..</span>
	<span class="hljs-keyword">SET</span> @OLEActionName 	= <span class="hljs-string">'sp_OASetProperty'</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'Position'</span><font></font>
<font></font>
	EXEC @hr = sp_OASetProperty @ObjStream, <span class="hljs-string">'Position'</span>, <span class="hljs-number">0</span>	<span class="hljs-comment">-- offset = 0</span>
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- ..and then read chunk by chunk</span>
	<span class="hljs-keyword">SET</span> @OLEActionName 	= <span class="hljs-string">'sp_OAMethod'</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'ReadText'</span><font></font>
<font></font>
	<span class="hljs-keyword">WHILE</span> @BuffSize &gt; @ChunkCharSize
	<span class="hljs-keyword">BEGIN</span>
		<span class="hljs-comment">-- read chunk</span>
		EXEC @hr = sp_OAMethod @ObjStream, @PropOrMethodName, @<span class="hljs-keyword">Chunk</span> <span class="hljs-keyword">OUT</span>, @ChunkCharSize
		<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
			<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
	<font></font>
		<span class="hljs-comment">-- append it to the accumulated buffer contents..</span>
		<span class="hljs-keyword">SET</span> @ResultBuff += @<span class="hljs-keyword">Chunk</span>
		<span class="hljs-comment">-- ..and correct the char counter by the # of chars retrieved</span>
		<span class="hljs-keyword">SET</span> @BuffSize -= @ChunkCharSize
	<span class="hljs-keyword">END</span><font></font>
<font></font>
	<span class="hljs-comment">-- read the last chunk</span>
	EXEC @hr = sp_OAMethod @ObjStream, @PropOrMethodName, @<span class="hljs-keyword">Chunk</span> <span class="hljs-keyword">OUT</span>
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- append the last chunk to the buffer</span>
	<span class="hljs-keyword">SET</span> @ResultBuff += @<span class="hljs-keyword">Chunk</span><font></font>
<font></font>
	<span class="hljs-comment">-- close the stream</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName = <span class="hljs-string">'Close'</span>
	EXEC @hr = sp_OAMethod @ObjStream, @PropOrMethodName, <span class="hljs-literal">NULL</span>
	<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
		<span class="hljs-keyword">GOTO</span> FUN_ERROR<font></font>
<font></font>
	<span class="hljs-comment">-- everything is ok, copying buffer to result</span>
	<span class="hljs-keyword">SET</span> @<span class="hljs-keyword">Result</span> = @ResultBuff<font></font>
	<font></font>
	<span class="hljs-comment">-- resulting doc is in @Result, cleaning up and exiting..</span>
	<span class="hljs-keyword">GOTO</span> OLE_RELEASE<font></font>
<font></font>
FUN_ERROR:<font></font>
<font></font>
	<span class="hljs-keyword">SET</span> @<span class="hljs-keyword">Result</span> = <span class="hljs-string">'#### Error '</span> + <span class="hljs-keyword">CONVERT</span>(<span class="hljs-built_in">VARCHAR</span>, <span class="hljs-keyword">CONVERT</span>(VARBINARY(<span class="hljs-number">4</span>), @hr)) + <span class="hljs-string">', Action '</span> + @OLEActionName + <span class="hljs-string">', Method/Property '</span> + @PropOrMethodName + <span class="hljs-string">' ####'</span>
	<span class="hljs-comment">-- fall through OLE release</span><font></font>
<font></font>
OLE_RELEASE:<font></font>
<font></font>
	<span class="hljs-comment">-- destroying XML..</span>
	<span class="hljs-keyword">SET</span> @OLEActionName 	= <span class="hljs-string">'sp_OADestroy'</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'Microsoft.XMLDOM'</span>
	<span class="hljs-keyword">IF</span> <span class="hljs-keyword">ISNULL</span>(@ObjXML, <span class="hljs-number">0</span>) &lt;&gt; <span class="hljs-number">0</span>
	<span class="hljs-keyword">BEGIN</span><font></font>
		EXEC @hr = sp_OADestroy @ObjXML<font></font>
		<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
			<span class="hljs-keyword">GOTO</span> OLE_RELEASE_ERROR
	<span class="hljs-keyword">END</span><font></font>
<font></font>
	<span class="hljs-comment">-- ..and XSL objects</span>
	<span class="hljs-keyword">IF</span> <span class="hljs-keyword">ISNULL</span>(@ObjXSL, <span class="hljs-number">0</span>) &lt;&gt; <span class="hljs-number">0</span>
	<span class="hljs-keyword">BEGIN</span>	<font></font>
		EXEC @hr = sp_OADestroy @ObjXSL<font></font>
		<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
			<span class="hljs-keyword">GOTO</span> OLE_RELEASE_ERROR
	<span class="hljs-keyword">END</span>	 <font></font>
<font></font>
	<span class="hljs-comment">-- and the stream obj</span>
	<span class="hljs-keyword">SET</span> @PropOrMethodName 	= <span class="hljs-string">'ADODB.Stream'</span>
	<span class="hljs-keyword">IF</span> <span class="hljs-keyword">ISNULL</span>(@ObjStream, <span class="hljs-number">0</span>) &lt;&gt; <span class="hljs-number">0</span>
	<span class="hljs-keyword">BEGIN</span>	<font></font>
		EXEC @hr = sp_OADestroy @ObjStream<font></font>
		<span class="hljs-keyword">IF</span> @hr &lt;&gt; <span class="hljs-number">0</span> 
			<span class="hljs-keyword">GOTO</span> OLE_RELEASE_ERROR
	<span class="hljs-keyword">END</span>	 <font></font>
<font></font>
	<span class="hljs-comment">-- exiting with returning the resulting document</span>
	<span class="hljs-keyword">RETURN</span> @<span class="hljs-keyword">Result</span><font></font>
<font></font>
OLE_RELEASE_ERROR:<font></font>
<font></font>
	<span class="hljs-comment">-- OLE release error, exiting with error info</span>
	<span class="hljs-keyword">RETURN</span> <span class="hljs-string">'#### Error '</span> + <span class="hljs-keyword">CONVERT</span>(<span class="hljs-built_in">VARCHAR</span>, <span class="hljs-keyword">CONVERT</span>(VARBINARY(<span class="hljs-number">4</span>), @hr)) + <span class="hljs-string">', Action '</span> + @OLEActionName + <span class="hljs-string">', Method/Property '</span> + @PropOrMethodName + <span class="hljs-string">' ####'</span><font></font>
<font></font>
<span class="hljs-keyword">END</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Überprüfen Sie nun die gesamte Wurst: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Testdaten:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">declare</span> @<span class="hljs-keyword">xml</span> <span class="hljs-keyword">xml</span> = <span class="hljs-keyword">convert</span>(<span class="hljs-keyword">xml</span>, <span class="hljs-string">'&lt;root&gt;&lt;item id="1" name="john"/&gt;&lt;item id="2" name="bob"/&gt;&lt;/root&gt;'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primitives Muster:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">declare</span> @templatetext <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) = <span class="hljs-string">'&lt;?xml version=''1.0'' encoding=''UTF-8''?&gt;
						&lt;xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"&gt;
						&lt;xsl:template match = ''item''&gt;
						&lt;tr&gt;&lt;td&gt;&lt;xsl:value-of select = ''@id'' /&gt;&lt;/td&gt;&lt;td&gt;&lt;xsl:value-of select = ''@name'' /&gt;&lt;/td&gt;&lt;/tr&gt;
						&lt;/xsl:template&gt;
						&lt;xsl:template match = ''/''&gt;
							&lt;HTML&gt;
							  &lt;BODY&gt;
								&lt;TABLE&gt;
								  &lt;TR&gt;&lt;TD colspan=''2''&gt;Item List&lt;/TD&gt;&lt;/TR&gt;
								  &lt;xsl:apply-templates select = ''root'' /&gt;
								&lt;/TABLE&gt;
							  &lt;/BODY&gt;
							&lt;/HTML&gt;
						  &lt;/xsl:template&gt;
						&lt;/xsl:stylesheet&gt;'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schließlich konvertieren wir die Vorlage von Text in XML und rufen unsere Funktion auf:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">declare</span> @xsl <span class="hljs-keyword">xml</span> = <span class="hljs-keyword">convert</span>(<span class="hljs-keyword">xml</span>, @templatetext)<font></font>
<font></font>
<span class="hljs-keyword">select</span> dbo.f_Helper_XSLTransform(@<span class="hljs-keyword">xml</span>, @xsl)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und wir bekommen die Ausgabe:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">HTML</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">BODY</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">TABLE</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">TR</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">TD</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">"2"</span>&gt;</span>Item List<span class="hljs-tag">&lt;/<span class="hljs-name">TD</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">TR</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>john<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>bob<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">TABLE</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">BODY</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">HTML</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie man das alles per Post verschickt (und sogar mit Anhängen - und dem letzten - mit einem schmutzigen Hack), kann ich einen weiteren Beitrag schreiben, wenn es interessant ist</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de487490/">https://habr.com/ru/post/de487490/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de487460/index.html">Delta: Plattform für Datensynchronisation und -anreicherung</a></li>
<li><a href="../de487462/index.html">Webix JavaScript-Bibliothek mit den Augen eines Anfängers. Teil 4. Mit Daten arbeiten. CRUD</a></li>
<li><a href="../de487470/index.html">Calibry: 3D-Durchbruch Preisdurchbruch</a></li>
<li><a href="../de487486/index.html">Sega Dreamcast Anatomy: Konsole Second Life</a></li>
<li><a href="../de487488/index.html">Fälle für die Anwendung von Tools zur Analyse von Netzwerkanomalien: Erkennen der Verbreitung von Schadcode</a></li>
<li><a href="../de487498/index.html">Auswählen einer Datenbank für die Analyse</a></li>
<li><a href="../de487502/index.html">Abfragen von Druckgeräten mit SNMP, während der Drucker druckt</a></li>
<li><a href="../de487504/index.html">Bis zum Tag der russischen Wissenschaft werden die besten Leistungen der einheimischen Wissenschaftler von 2019 benannt</a></li>
<li><a href="../de487508/index.html">Messen der Entfernung zu Objekten mit RealSense D435</a></li>
<li><a href="../de487510/index.html">Radioaktive Produkte. Gammaspektrometer. Teil 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>