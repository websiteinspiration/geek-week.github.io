<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎅🏿 👇🏿 🌈 PostgreSQLのASHアナログを作成しようとしています 👨🏾‍🎓 🐶 🎡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="問題の定式化
 PostgreSQLクエリを最適化するには、アクティビティ履歴、特に期待値、ロック、テーブル統計を分析する機能が非常に必要です。 
 
 利用可能なオプション
 過去の負荷分析ツールまたは「Postgres用AWR」：非常に興味深いソリューションですが、pg_stat_activit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLのASHアナログを作成しようとしています</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467181/"><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題の定式化</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLクエリを最適化するには、アクティビティ履歴、特に期待値、ロック、テーブル統計を分析する機能が非常に必要です。 </font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利用可能なオプション</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">過去の負荷分析ツールまたは「Postgres用AWR」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：非常に興味深いソリューションですが、pg_stat_activityとpg_locksの履歴はありません。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pgsentinel拡張機能</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">蓄積されたすべての情報はRAMにのみ保存され、メモリの消費量は最後に保存されたレコードの数によって制御されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クエリIDフィールドが追加されます-pg_stat_statements拡張機能からの同じクエリID（事前インストールが必要です）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは確かに役立ちますが、問題は最初の段落「</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての累積情報はRAMにのみ保存されます</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」、つまりターゲットベースに影響を与えます。さらに、ロック履歴とテーブル統計はありません。それら。一般的に言えば、決定は不完全です。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インストール用の既製のパッケージはまだありません。</font><font style="vertical-align: inherit;">ソースをダウンロードしてライブラリを自分で構築することをお勧めします。</font><font style="vertical-align: inherit;">最初に、サーバー用の「devel」パッケージをインストールし、pg_configへのパスをPATH変数に書き込む必要があります。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に-多くの大騒ぎ、そして深刻な本番データベースの場合、サーバーで何かをする方法はないでしょう。</font><font style="vertical-align: inherit;">繰り返しますが、あなた自身の何かを思いつく必要があります。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トピックの新規性とテスト期間の不完全さのため、記事は要約および中間結果のセットとしてではなく、主に情報提供を目的としています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より詳細な資料は後で部分的に準備されます。</font></font></blockquote><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソリューション要件の概要</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
格納できるツールを開発する必要があります：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_activityビューの</font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">履歴pg_locksビューを使用したセッションロック</font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">の</font></b><b><font style="vertical-align: inherit;">履歴</font></b></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソリューションの要件は</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ターゲットデータベースへの影響</font><b><font style="vertical-align: inherit;">を</font></b><font style="vertical-align: inherit;">最小限に抑えることです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的な考え方</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、データ収集エージェントは、ターゲットデータベースではなく、systemdサービスとしてモニタリングデータベースで起動されるというものです。</font><font style="vertical-align: inherit;">はい、一部のデータが失われる可能性がありますが、これはレポートにとって重要ではありませんが、メモリとディスク領域からターゲットデータベースに影響はありません。</font><font style="vertical-align: inherit;">また、接続プールを使用する場合、ユーザープロセスへの影響は最小限です。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装段階</font></font></h1><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.サービステーブル</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用されるメインテーブルの分析が複雑にならないように、テーブルを格納するために別のスキームが使用されます。</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> activity_hist ;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SCHEMA</span> activity_hist <span class="hljs-keyword">AUTHORIZATION</span> monitor ;
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要：スキームはターゲットデータベースではなく監視データベースに作成されます。</font></font></b><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pg_stat_activityビューの履歴</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルを使用してpg_stat_activityビューの現在のスナップショットを保存します </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activity_hist.history_pg_stat_activity：</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-comment">--ACTIVITY_HIST.HISTORY_PG_STAT_ACTIVITY</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> activity_hist.history_pg_stat_activity;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> activity_hist.history_pg_stat_activity<font></font>
(<font></font>
  timepoint <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span> ,<font></font>
  datid             <span class="hljs-type">oid</span>  , <font></font>
  datname           <span class="hljs-type">name</span> ,<font></font>
  pid               <span class="hljs-type">integer</span>,<font></font>
  usesysid          <span class="hljs-type">oid</span>    ,<font></font>
  usename           <span class="hljs-type">name</span>   ,<font></font>
  application_name  <span class="hljs-type">text</span>   ,<font></font>
  client_addr       <span class="hljs-type">inet</span>   ,<font></font>
  client_hostname   <span class="hljs-type">text</span>   ,<font></font>
  client_port       <span class="hljs-type">integer</span>,<font></font>
  backend_start     <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,<font></font>
  xact_start        <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,<font></font>
  query_start       <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,<font></font>
  state_change      <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,<font></font>
  wait_event_type   <span class="hljs-type">text</span> ,                     <font></font>
  wait_event        <span class="hljs-type">text</span> ,                   <font></font>
  state             <span class="hljs-type">text</span> ,                  <font></font>
  backend_xid       xid  ,                 <font></font>
  backend_xmin      xid  ,                <font></font>
  query             <span class="hljs-type">text</span> ,               <font></font>
  backend_type      <span class="hljs-type">text</span> ,  <font></font>
  queryid           <span class="hljs-type">bigint</span>
);</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
挿入を高速化する-インデックスや制限なし。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
履歴を直接保存するには、パーティションテーブルを使用します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activity_hist.archive_pg_stat_activity：</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> activity_hist.archive_pg_stat_activity;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> activity_hist.archive_pg_stat_activity<font></font>
(<font></font>
  timepoint <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span> ,<font></font>
  datid             <span class="hljs-type">oid</span>  , <font></font>
  datname           <span class="hljs-type">name</span> ,<font></font>
  pid               <span class="hljs-type">integer</span>,<font></font>
  usesysid          <span class="hljs-type">oid</span>    ,<font></font>
  usename           <span class="hljs-type">name</span>   ,<font></font>
  application_name  <span class="hljs-type">text</span>   ,<font></font>
  client_addr       <span class="hljs-type">inet</span>   ,<font></font>
  client_hostname   <span class="hljs-type">text</span>   ,<font></font>
  client_port       <span class="hljs-type">integer</span>,<font></font>
  backend_start     <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,<font></font>
  xact_start        <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,<font></font>
  query_start       <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,<font></font>
  state_change      <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,<font></font>
  wait_event_type   <span class="hljs-type">text</span> ,                     <font></font>
  wait_event        <span class="hljs-type">text</span> ,                   <font></font>
  state             <span class="hljs-type">text</span> ,                  <font></font>
  backend_xid       xid  ,                 <font></font>
  backend_xmin      xid  ,                <font></font>
  query             <span class="hljs-type">text</span> ,               <font></font>
  backend_type      <span class="hljs-type">text</span> ,<font></font>
  queryid           <span class="hljs-type">bigint</span><font></font>
)<font></font>
<span class="hljs-keyword">PARTITION BY RANGE</span> (timepoint);</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、挿入速度の要件がないため、レポートを高速化するためにいくつかのインデックスが作成されています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セッションロック履歴</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セッションロックの現在のスナップショットを保存するには、次の表を使用します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activity_hist.history_locking：</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-comment">--ACTIVITY_HIST.HISTORY_LOCKING</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> activity_hist.history_locking;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> activity_hist.history_locking<font></font>
(<font></font>
	timepoint <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span> ,<font></font>
	locktype <span class="hljs-type">text</span> ,<font></font>
	relation <span class="hljs-type">oid</span> ,<font></font>
	mode <span class="hljs-type">text</span> ,<font></font>
	tid xid ,<font></font>
	vtid <span class="hljs-type">text</span> ,<font></font>
	pid <span class="hljs-type">integer</span> ,<font></font>
	blocking_pids <span class="hljs-type">integer</span>[] ,<font></font>
	granted <span class="hljs-type">boolean</span>
);</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、挿入を高速化する-インデックスや制限はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
履歴を直接保存するには、パーティションテーブルを使用します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activity_hist.archive_locking：</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> activity_hist.archive_locking;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> activity_hist.archive_locking<font></font>
(<font></font>
	timepoint <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span> ,<font></font>
	locktype <span class="hljs-type">text</span> ,<font></font>
	relation <span class="hljs-type">oid</span> ,<font></font>
	mode <span class="hljs-type">text</span> ,<font></font>
	tid xid ,<font></font>
	vtid <span class="hljs-type">text</span> ,<font></font>
	pid <span class="hljs-type">integer</span> ,<font></font>
	blocking_pids <span class="hljs-type">integer</span>[] ,<font></font>
	granted <span class="hljs-type">boolean</span>	<font></font>
)<font></font>
<span class="hljs-keyword">PARTITION BY RANGE</span> (timepoint);</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、挿入速度の要件がないため、レポートを高速化するためにいくつかのインデックスが作成されています。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.現在のストーリーを埋める</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビューのスナップショットを直接キャプチャするには、plpgsql関数を実行するbashスクリプトを使用します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_current_activity.sh</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">#########################################################</span>
<span class="hljs-comment">#get_current_activity.sh</span><font></font>
<font></font>
ERROR_FILE=<span class="hljs-string">'/home/demon/get_current_activity'</span>$(date +%Y%m%d-)<span class="hljs-string">'T'</span>$(date +%H)$(date +%M)$(date +%S)<font></font>
host=<span class="hljs-variable">$1</span>
s_name=<span class="hljs-variable">$2</span>
s_pass=<span class="hljs-variable">$3</span><font></font>
<font></font>
psql  -A -t -q -v ON_ERROR_STOP=1 -c <span class="hljs-string">"SELECT activity_hist.get_current_activity( '<span class="hljs-variable">$host</span>' , '<span class="hljs-variable">$s_name</span>' , '<span class="hljs-variable">$s_pass</span>' )"</span> &gt;/dev/null 2&gt;<span class="hljs-variable">$ERROR_FILE</span><font></font>
<font></font>
line_count=`cat <span class="hljs-variable">$ERROR_FILE</span> | wc -l`
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$line_count</span> != <span class="hljs-string">'0'</span> ]];
<span class="hljs-keyword">then</span><font></font>
    rm -f /home/demon/*.err &gt;/dev/null 2&gt;/dev/null<font></font>
	cp <span class="hljs-variable">$ERROR_FILE</span> <span class="hljs-variable">$ERROR_FILE</span><span class="hljs-string">'.err'</span> &gt;/dev/null 2&gt;/dev/null  
<span class="hljs-keyword">fi</span>
rm <span class="hljs-variable">$ERROR_FILE</span> &gt;/dev/null 2&gt;/dev/null
<span class="hljs-built_in">exit</span> 0</code></pre></div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plpgsql dblink</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数は、ターゲットデータベースのビューにアクセスし、監視データベースのサービステーブルに行を挿入します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_current_activity.sql</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> activity_hist.get_current_activity( current_host <span class="hljs-type">text</span> , current_s_name <span class="hljs-type">text</span> , current_s_pass <span class="hljs-type">text</span> ) <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">AS</span> $$<span class="pgsql">
<span class="hljs-keyword">DECLARE</span> 
  database_rec <span class="hljs-type">record</span>;
  dblink_str <span class="hljs-type">text</span> ;
<span class="hljs-keyword">BEGIN</span>   

	<span class="hljs-keyword">EXECUTE</span> <span class="hljs-string">'SELECT dblink_connect(''LINK1'',''host='</span>||current_host||<span class="hljs-string">' port=5432 dbname=postgres'</span>||
	                                         <span class="hljs-string">' user='</span>||current_s_name||<span class="hljs-string">' password='</span>||current_s_pass|| <span class="hljs-string">' '')'</span>;



<span class="hljs-comment">--------------------------------------------------------------------</span>
<span class="hljs-comment">--GET pg_stat_activity stats</span>
	<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> activity_hist.history_pg_stat_activity
	(
		<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> dblink(<span class="hljs-string">'LINK1'</span>,
			<span class="hljs-string">'SELECT 
			now() , 
			datid             , 
			datname           ,
			pid               ,
			usesysid              ,
			usename              ,
			application_name     ,
			client_addr          ,
			client_hostname      ,
			client_port       ,
			backend_start         ,
			xact_start            ,
			query_start           ,
			state_change          ,
			wait_event_type    ,                     
			wait_event         ,                   
			state              ,                  
			backend_xid         ,                 
			backend_xmin        ,                
			query              ,               
			backend_type   			
		FROM pg_stat_activity
		'</span>) 
		<span class="hljs-keyword">AS</span> t (
		    timepoint 		  <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span> ,			
			datid             <span class="hljs-type">oid</span>  , 
			datname           <span class="hljs-type">name</span> ,
			pid               <span class="hljs-type">integer</span>,
			usesysid          <span class="hljs-type">oid</span>    ,
			usename           <span class="hljs-type">name</span>   ,
			application_name  <span class="hljs-type">text</span>   ,
			client_addr       <span class="hljs-type">inet</span>   ,
			client_hostname   <span class="hljs-type">text</span>   ,
			client_port       <span class="hljs-type">integer</span>,
			backend_start     <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,
			xact_start        <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,
			query_start       <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,
			state_change      <span class="hljs-type">timestamp</span> <span class="hljs-type">with time zone</span> ,
			wait_event_type   <span class="hljs-type">text</span> ,                     
			wait_event        <span class="hljs-type">text</span> ,                   
			state             <span class="hljs-type">text</span> ,                  
			backend_xid       xid  ,                 
			backend_xmin      xid  ,                
			query             <span class="hljs-type">text</span> ,               
			backend_type      <span class="hljs-type">text</span> 			
		)
	);

<span class="hljs-comment">---------------------------------------	</span>
<span class="hljs-comment">--ACTIVITY_HIST.HISTORY_LOCKING	</span>
	<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> activity_hist.history_locking
	(
		<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> dblink(<span class="hljs-string">'LINK1'</span>,
			<span class="hljs-string">'SELECT 
			now() , 
			lock.locktype,
			lock.relation,
			lock.mode,
			lock.transactionid as tid,
			lock.virtualtransaction as vtid,
			lock.pid,
			pg_blocking_pids(lock.pid), 
			lock.granted
			FROM 	pg_catalog.pg_locks lock LEFT JOIN pg_catalog.pg_database db ON db.oid = lock.database
			WHERE NOT lock.pid = pg_backend_pid()	
		'</span>) 
		<span class="hljs-keyword">AS</span> t (
			timepoint <span class="hljs-type">timestamp</span> <span class="hljs-type">without time zone</span> ,
			locktype <span class="hljs-type">text</span> ,
			relation <span class="hljs-type">oid</span> , 
			mode <span class="hljs-type">text</span> ,
			tid xid ,
			vtid <span class="hljs-type">text</span> ,
			pid <span class="hljs-type">integer</span> ,
			blocking_pids <span class="hljs-type">integer</span>[] ,
			granted <span class="hljs-type">boolean</span>
		)
	);
	<span class="hljs-keyword">PERFORM</span> dblink_disconnect(<span class="hljs-string">'LINK1'</span>);
	
	<span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">TRUE</span> ;
<span class="hljs-keyword">END</span>
$$</span> <span class="hljs-keyword">LANGUAGE</span> plpgsql;</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビューのスナップショットを収集するには、systemdサービスと2つのスクリプトを使用します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_current_activity.service</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"># /etc/systemd/system/pg_current_activity.service</span><font></font>
[Unit]<font></font>
Description=Collect <span class="hljs-built_in">history</span> of pg_stat_activity , pg_locks <font></font>
Wants=pg_current_activity.timer<font></font>
<font></font>
[Service]<font></font>
Type=forking<font></font>
StartLimitIntervalSec=0<font></font>
ExecStart=/home/postgres/pgutils/demon/get_current_activity.sh X.X.X.X postgres postgres<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_current_activity.timer</font></font></b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"># /etc/systemd/system/pg_current_activity.timer</span><font></font>
[Unit]<font></font>
Description=Run pg_current_activity.sh every 1 second<font></font>
Requires=pg_current_activity.service<font></font>
<font></font>
[Timer]<font></font>
Unit=pg_current_activity.service<font></font>
OnCalendar=*:*:0/1<font></font>
AccuracySec=1<font></font>
<font></font>
[Install]<font></font>
WantedBy=timers.target</code></pre></div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
割り当てスクリプトへの権利：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃chmodの755 pg_current_activity.timer </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃chmodの755 pg_current_activity.service開始し</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たサービスを：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃systemctlデーモンリロード</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
＃はpg_current_activity.serviceを開始systemctl </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このように、表現の歴史は毎秒スナップショットの形で収集されます。</font><font style="vertical-align: inherit;">もちろん、すべてをそのままにしておくと、テーブルのサイズが急速に大きくなり、多かれ少なかれ生産的な作業が不可能になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データのアーカイブを整理する必要があります。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.アーカイブ履歴</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーカイブには、分割テーブル*が使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいセクションは1時間ごとに作成されますが、履歴テーブルの古いデータは削除されるため、履歴テーブルのサイズは大きく変化せず、時間の経過とともに挿入速度が低下しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいセクションの作成は、plpgsql関数activity_hist.archive_current_activityによって実行されます。</font><font style="vertical-align: inherit;">作業のアルゴリズムは非常に単純です（archive_pg_stat_activityテーブルのセクションの例について）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいセクションを作成して入力する</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">EXECUTE</span> format(
<span class="hljs-string">'CREATE TABLE '</span> || partition_name || 
<span class="hljs-string">' PARTITION OF activity_hist.archive_pg_stat_activity FOR VALUES FROM ( %L ) TO ( %L ) '</span> , <font></font>
to_char(date_trunc(<span class="hljs-string">'year'</span>, partition_min_range ),<span class="hljs-string">'YYYY'</span>)||<span class="hljs-string">'-'</span>||<font></font>
to_char(date_trunc(<span class="hljs-string">'month'</span>, partition_min_range ),<span class="hljs-string">'MM'</span>)||<span class="hljs-string">'-'</span>||<font></font>
to_char(date_trunc(<span class="hljs-string">'day'</span>, partition_min_range ),<span class="hljs-string">'DD'</span>)||<span class="hljs-string">' '</span>||<font></font>
to_char(date_trunc(<span class="hljs-string">'hour'</span>, partition_min_range ),<span class="hljs-string">'HH24'</span>)||<span class="hljs-string">':00'</span>, <font></font>
to_char(date_trunc(<span class="hljs-string">'year'</span>, partition_max_range ),<span class="hljs-string">'YYYY'</span>)||<span class="hljs-string">'-'</span>||<font></font>
to_char(date_trunc(<span class="hljs-string">'month'</span>, partition_max_range ),<span class="hljs-string">'MM'</span>)||<span class="hljs-string">'-'</span>||<font></font>
to_char(date_trunc(<span class="hljs-string">'day'</span>, partition_max_range ),<span class="hljs-string">'DD'</span>)||<span class="hljs-string">' '</span>||<font></font>
to_char(date_trunc(<span class="hljs-string">'hour'</span>, partition_max_range ),<span class="hljs-string">'HH24'</span>)||<span class="hljs-string">':00'</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> activity_hist.archive_pg_stat_activity<font></font>
(<font></font>
	<span class="hljs-keyword">SELECT</span> 	* 
	<span class="hljs-keyword">FROM</span> 	activity_hist.history_pg_stat_activity
	<span class="hljs-keyword">WHERE</span> 	timepoint <span class="hljs-keyword">BETWEEN</span> partition_min_range <span class="hljs-keyword">AND</span> partition_max_range 		<font></font>
);</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスを作成する</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">EXECUTE</span> format	(
<span class="hljs-string">'CREATE INDEX '</span>||index_name||
<span class="hljs-string">' ON '</span>||partition_name||<span class="hljs-string">' ( wait_event_type , backend_type , timepoint )'</span> <font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">EXECUTE</span> format	(<span class="hljs-string">'CREATE INDEX '</span>||index_name||
<span class="hljs-string">' ON '</span>||partition_name||<span class="hljs-string">' ( wait_event_type , backend_type , timepoint , queryid )'</span> 
);</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history_pg_stat_activityテーブルから古いデータを削除します</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">DELETE</span> 
<span class="hljs-keyword">FROM</span> 	activity_hist.history_pg_stat_activity
<span class="hljs-keyword">WHERE</span> 	timepoint &lt; partition_max_range;</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、定期的に、古いセクションは不要として削除されます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本レポート</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、なぜこれがすべて行われているのでしょうか。</font><font style="vertical-align: inherit;">非常にリモートでレポートを受信するには、おおよそOracle AWRを連想させます。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レポートを受け取るには、pg_stat_activityビューとpg_stat_statementsビューの間の関係を構築する必要があることを追加することが重要です。</font><font style="vertical-align: inherit;">テーブルは、 'queryid'列をテーブル 'history_pg_stat_activity'、 'archive_pg_stat_activity'に追加することでリンクされます。</font><font style="vertical-align: inherit;">列の値を追加する方法はこの記事の範囲外であり、ここで説明します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-pg_stat_statements + pg_stat_activity + loq_query = pg_ash？</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></blockquote><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリの合計CPU時間</font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お問い合わせ：</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">WITH</span> hist <span class="hljs-keyword">AS</span><font></font>
(<font></font>
<span class="hljs-keyword">SELECT</span> <font></font>
	aa.query ,aa.queryid ,			<font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">AS</span> duration 
<span class="hljs-keyword">FROM</span> 	activity_hist.archive_pg_stat_activity aa
<span class="hljs-keyword">WHERE</span> timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span>  pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>)  <span class="hljs-keyword">AND</span> backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> datname != <span class="hljs-string">'postgres'</span> <span class="hljs-keyword">AND</span>	( aa.wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>  ) ANDaa.state = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> aa.wait_event_type , aa.wait_event , aa.query ,aa.queryid		
<span class="hljs-keyword">UNION</span> 
<span class="hljs-keyword">SELECT</span> <font></font>
	ha.query ,ha.queryid,<font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">AS</span> duration 
<span class="hljs-keyword">FROM</span> 	activity_hist.history_pg_stat_activity_for_reports ha
<span class="hljs-keyword">WHERE</span> timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>)  <span class="hljs-keyword">AND</span> 	backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> datname != <span class="hljs-string">'postgres'</span> <span class="hljs-keyword">AND</span> ( ha.wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>  )<span class="hljs-keyword">AND</span> ha.state = <span class="hljs-string">'active'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> ha.wait_event_type , ha.wait_event , ha.query ,ha.queryid		<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span> 	query , queryid , SUM( duration ) <span class="hljs-keyword">as</span> duration 
<span class="hljs-keyword">FROM</span> hist
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>  query , queryid 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">3</span> <span class="hljs-keyword">DESC</span></code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例：</font></font><br>
<pre><code class="plaintext hljs">-------------------------------------------------------------------<font></font>
| TOTAL CPU TIME FOR QUERIES : 07:47:36<font></font>
+----+----------------------------------------+--------------------<font></font>
|   #|                                 queryid|            duration<font></font>
+----+----------------------------------------+--------------------<font></font>
|   1|                      389015618226997618|            04:28:58<font></font>
|   2|                                        |            01:07:29<font></font>
|   3|                     1237430309438971376|            00:59:38<font></font>
|   4|                     4710212362688288619|            00:50:48<font></font>
|   5|                       28942442626229688|            00:15:50<font></font>
|   6|                     9150846928388977274|            00:04:46<font></font>
|   7|                    -6572922443698419129|            00:00:06<font></font>
|   8|                                        |            00:00:01<font></font>
+----+----------------------------------------+--------------------<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリの合計待機時間 </font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お問い合わせ：</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">WITH</span> hist <span class="hljs-keyword">AS</span><font></font>
(<font></font>
<span class="hljs-keyword">SELECT</span> <font></font>
	aa.query ,aa.queryid ,			<font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">AS</span> duration 
<span class="hljs-keyword">FROM</span> 	activity_hist.archive_pg_stat_activity aa
<span class="hljs-keyword">WHERE</span> timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>)  <span class="hljs-keyword">AND</span> 
	backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> datname != <span class="hljs-string">'postgres'</span> <span class="hljs-keyword">AND</span>
	( aa.wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>  ) 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> aa.wait_event_type , aa.wait_event , aa.query ,aa.queryid		
<span class="hljs-keyword">UNION</span> 
<span class="hljs-keyword">SELECT</span> <font></font>
	ha.query ,ha.queryid,<font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">AS</span> duration 
<span class="hljs-keyword">FROM</span> 	activity_hist.history_pg_stat_activity_for_reports ha
<span class="hljs-keyword">WHERE</span> timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>)  <span class="hljs-keyword">AND</span> 
	backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> datname != <span class="hljs-string">'postgres'</span> <span class="hljs-keyword">AND</span>				
	( ha.wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>  )
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> ha.wait_event_type , ha.wait_event , ha.query ,ha.queryid		<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span> 	query , queryid , SUM( duration ) <span class="hljs-keyword">as</span> duration 
<span class="hljs-keyword">FROM</span> hist
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>  query , queryid 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">3</span> <span class="hljs-keyword">DESC</span> </code></pre></div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：</font></font></b><br>
<pre><code class="plaintext hljs">-------------------------------------------------------------------<font></font>
| TOTAL WAITINGS TIME FOR QUERIES : 21:55:04<font></font>
+----+----------------------------------------+--------------------<font></font>
|   #|                                 queryid|            duration<font></font>
+----+----------------------------------------+--------------------<font></font>
|   1|                      389015618226997618|            16:19:05<font></font>
|   2|                                        |            03:47:04<font></font>
|   3|                     8085340880788646241|            00:40:20<font></font>
|   4|                     4710212362688288619|            00:13:35<font></font>
|   5|                     9150846928388977274|            00:12:25<font></font>
|   6|                       28942442626229688|            00:11:32<font></font>
|   7|                     1237430309438971376|            00:09:45<font></font>
|   8|                     2649515222348904837|            00:09:37<font></font>
|   9|                                        |            00:03:45<font></font>
|  10|                     3167065002719415275|            00:02:20<font></font>
|  11|                     5731212217001535134|            00:02:13<font></font>
|  12|                     8304755792398128062|            00:01:31<font></font>
|  13|                     2649515222348904837|            00:00:59<font></font>
|  14|                     2649515222348904837|            00:00:22<font></font>
|  15|                                        |            00:00:12<font></font>
|  16|                     3422818749220588372|            00:00:08<font></font>
|  17|                    -5730801771815999400|            00:00:03<font></font>
|  18|                    -1473395109729441239|            00:00:02<font></font>
|  19|                     2404820632950544954|            00:00:02<font></font>
|  20|                    -6572922443698419129|            00:00:02<font></font>
|  21|                     2369289265278398647|            00:00:01<font></font>
|  22|                      180077086776069052|            00:00:01<font></font>
+----+----------------------------------------+--------------------<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリの待機</font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト：</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">WITH</span> hist <span class="hljs-keyword">AS</span><font></font>
(<font></font>
<span class="hljs-keyword">SELECT</span> <font></font>
	aa.wait_event_type , aa.wait_event <font></font>
<span class="hljs-keyword">FROM</span> 	activity_hist.archive_pg_stat_activity aa
<span class="hljs-keyword">WHERE</span> timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> 
	backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> datname != <span class="hljs-string">'postgres'</span> <span class="hljs-keyword">AND</span>
	aa.wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> aa.wait_event_type , aa.wait_event
<span class="hljs-keyword">UNION</span> 
<span class="hljs-keyword">SELECT</span> <font></font>
	ha.wait_event_type , ha.wait_event <font></font>
<span class="hljs-keyword">FROM</span> 	activity_hist.history_pg_stat_activity_for_reports ha
<span class="hljs-keyword">WHERE</span> timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> 
	backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> datname != <span class="hljs-string">'postgres'</span> <span class="hljs-keyword">AND</span>
	ha.wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> ha.wait_event_type , ha.wait_event		<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span> 	wait_event_type , wait_event 
<span class="hljs-keyword">FROM</span> hist
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> wait_event_type , wait_event
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ASC</span>,<span class="hljs-number">2</span> <span class="hljs-keyword">ASC</span><font></font>
<font></font>
<span class="hljs-comment">----------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">WITH</span> hist <span class="hljs-keyword">AS</span><font></font>
(<font></font>
<span class="hljs-keyword">SELECT</span> <font></font>
	aa.wait_event_type , aa.wait_event , aa.query ,aa.queryid ,			<font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">AS</span> duration 
<span class="hljs-keyword">FROM</span> 	activity_hist.archive_pg_stat_activity aa
<span class="hljs-keyword">WHERE</span> timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> 
	backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> datname != <span class="hljs-string">'postgres'</span> <span class="hljs-keyword">AND</span>
	( aa.wait_event_type = waitings_stat_rec.wait_event_type <span class="hljs-keyword">AND</span> aa.wait_event = waitings_stat_rec.wait_event )
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> aa.wait_event_type , aa.wait_event , aa.query ,aa.queryid		
<span class="hljs-keyword">UNION</span> 
<span class="hljs-keyword">SELECT</span> <font></font>
	ha.wait_event_type , ha.wait_event , ha.query ,ha.queryid,<font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">AS</span> duration 
<span class="hljs-keyword">FROM</span> 	activity_hist.history_pg_stat_activity_for_reports ha
<span class="hljs-keyword">WHERE</span> timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> 
	backend_type = <span class="hljs-string">'client backend'</span> <span class="hljs-keyword">AND</span> datname != <span class="hljs-string">'postgres'</span> <span class="hljs-keyword">AND</span>				
	( ha.wait_event_type = waitings_stat_rec.wait_event_type <span class="hljs-keyword">AND</span> ha.wait_event = waitings_stat_rec.wait_event )
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> ha.wait_event_type , ha.wait_event , ha.query ,ha.queryid		<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span> 	query , queryid , SUM( duration ) <span class="hljs-keyword">as</span> duration 
<span class="hljs-keyword">FROM</span> hist
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>  query , queryid 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">3</span> <span class="hljs-keyword">DESC</span></code></pre></div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：</font></font></b><br>
<pre><code class="plaintext hljs">------------------------------------------------<font></font>
| WAITINGS FOR QUERIES<font></font>
+-----------------------------------------------<font></font>
|                      wait_event_type = Client|<font></font>
|                       wait_event = ClientRead|<font></font>
|                        Total time  = 00:46:56|<font></font>
------------------------------------------------<font></font>
|    #|             queryid|            duration<font></font>
+-----+--------------------+--------------------<font></font>
|    1| 8085340880788646241|            00:40:20<font></font>
|    2|                    |            00:03:45<font></font>
|    3| 5731212217001535134|            00:01:53<font></font>
|    4|                    |            00:00:12<font></font>
|    5| 9150846928388977274|            00:00:09<font></font>
|    6| 3422818749220588372|            00:00:08<font></font>
|    7| 1237430309438971376|            00:00:06<font></font>
|    8|   28942442626229688|            00:00:05<font></font>
|    9| 4710212362688288619|            00:00:05<font></font>
|   10|-5730801771815999400|            00:00:03<font></font>
|   11| 8304755792398128062|            00:00:02<font></font>
|   12|-6572922443698419129|            00:00:02<font></font>
|   13|-1473395109729441239|            00:00:02<font></font>
|   14| 2404820632950544954|            00:00:02<font></font>
|   15|  180077086776069052|            00:00:01<font></font>
|   16| 2369289265278398647|            00:00:01<font></font>
<font></font>
+-----------------------------------------------<font></font>
|                          wait_event_type = IO|<font></font>
|                      wait_event = BufFileRead|<font></font>
|                        Total time  = 00:00:38|<font></font>
------------------------------------------------<font></font>
|    #|             queryid|            duration<font></font>
+-----+--------------------+--------------------<font></font>
|    1|   28942442626229688|            00:00:38<font></font>
<font></font>
+-----------------------------------------------<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックされたプロセスの履歴</font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問い合わせ：</font></font></b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> 
MIN(date_trunc(<span class="hljs-string">'second'</span>,timepoint)) <span class="hljs-keyword">AS</span> started , <font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">as</span> duration ,<font></font>
	pid , blocking_pids , relation , mode , locktype 	 <font></font>
<span class="hljs-keyword">FROM</span> <font></font>
	activity_hist.archive_locking al <font></font>
<span class="hljs-keyword">WHERE</span> 
	timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span>
	<span class="hljs-keyword">NOT</span> granted <span class="hljs-keyword">AND</span> 
	locktype = <span class="hljs-string">'relation'</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> pid , blocking_pids , relation , mode , locktype			
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> 
	MIN(date_trunc(<span class="hljs-string">'second'</span>,timepoint)) <span class="hljs-keyword">AS</span> started , <font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">as</span> duration ,<font></font>
	pid , blocking_pids , relation , mode , locktype<font></font>
<span class="hljs-keyword">FROM</span> <font></font>
	activity_hist.history_locking <font></font>
<span class="hljs-keyword">WHERE</span> 
	timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span>
	<span class="hljs-keyword">NOT</span> granted <span class="hljs-keyword">AND</span> 
	locktype = <span class="hljs-string">'relation'</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> pid , blocking_pids , relation , mode , locktype			
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span></code></pre></div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：</font></font></b><br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-------------------------------------------------- -------------------------------------------------- ---------------------------------</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">ロックされたプロセスの履歴</font></font><font></font>
+-----+----------+--------------------+----------+--------------------+--------------------+--------------------+--------------------<font></font>
|    #|       pid|             started|  duration|       blocking_pids|            relation|                mode|            locktype<font></font>
+-----+----------+--------------------+----------+--------------------+--------------------+--------------------+--------------------<font></font>
|    1|     26224| 2019-09-02 19:32:16|  00:01:45|             {26211}|               16541|     AccessShareLock|            relation<font></font>
|    2|     26390| 2019-09-02 19:34:03|  00:00:53|             {26211}|               16541|     AccessShareLock|            relation<font></font>
|    3|     26391| 2019-09-02 19:34:03|  00:00:53|             {26211}|               16541|     AccessShareLock|            relation<font></font>
|    4|     26531| 2019-09-02 19:35:27|  00:00:12|             {26211}|               16541|     AccessShareLock|            relation<font></font>
|    5|     27284| 2019-09-02 19:44:02|  00:00:19|             {27276}|               16541|     AccessShareLock|            relation<font></font>
|    6|     27283| 2019-09-02 19:44:02|  00:00:19|             {27276}|               16541|     AccessShareLock|            relation<font></font>
|    7|     27286| 2019-09-02 19:44:02|  00:00:19|             {27276}|               16541|     AccessShareLock|            relation<font></font>
|    8|     27423| 2019-09-02 19:45:24|  00:00:12|             {27394}|               16541|     AccessShareLock|            relation<font></font>
|    9|     27648| 2019-09-02 19:48:06|  00:00:20|             {27647}|               16541|     AccessShareLock|            relation<font></font>
|   10|     27650| 2019-09-02 19:48:06|  00:00:20|             {27647}|               16541|     AccessShareLock|            relation<font></font>
|   11|     27735| 2019-09-02 19:49:08|  00:00:06|             {27650}|               16541| AccessExclusiveLock|            relation<font></font>
|   12|     28380| 2019-09-02 19:56:03|  00:01:56|             {28379}|               16541|     AccessShareLock|            relation<font></font>
|   13|     28379| 2019-09-02 19:56:03|  00:00:01|               28377|               16541| AccessExclusiveLock|            relation<font></font>
|     |          |                    |          |               28376|                    | <font></font>
</pre><br>
<h2>BLOCKING PROCESSES HISTORY</h2><br>
<div class="spoiler"><b class="spoiler_title">:</b><div class="spoiler_text"><pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
blocking_pids <font></font>
<span class="hljs-keyword">FROM</span> <font></font>
	activity_hist.archive_locking al <font></font>
<span class="hljs-keyword">WHERE</span> 
	timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span>
	<span class="hljs-keyword">NOT</span> granted <span class="hljs-keyword">AND</span> 
	locktype = <span class="hljs-string">'relation'</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> blocking_pids 		
<span class="hljs-keyword">UNION</span>
<span class="hljs-keyword">SELECT</span> <font></font>
	blocking_pids <font></font>
<span class="hljs-keyword">FROM</span> <font></font>
	activity_hist.history_locking <font></font>
<span class="hljs-keyword">WHERE</span> 
	timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span>
	<span class="hljs-keyword">NOT</span> granted <span class="hljs-keyword">AND</span> 
	locktype = <span class="hljs-string">'relation'</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> blocking_pids 		
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-comment">---------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> <font></font>
	pid , usename , application_name , datname ,<font></font>
	MIN(date_trunc(<span class="hljs-string">'second'</span>,timepoint)) <span class="hljs-keyword">as</span> started , <font></font>
	count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">as</span> duration ,		 <font></font>
	state , <font></font>
	query<font></font>
				<span class="hljs-keyword">FROM</span>  	activity_hist.archive_pg_stat_activity
				<span class="hljs-keyword">WHERE</span> 	pid= current_pid <span class="hljs-keyword">AND</span> 
						timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) 						 
				<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> pid , usename , application_name , <font></font>
						datname , <font></font>
						state_change, <font></font>
						state , <font></font>
						query <font></font>
				<span class="hljs-keyword">UNION</span>
				<span class="hljs-keyword">SELECT</span> <font></font>
					pid , usename , application_name , datname ,<font></font>
					MIN(date_trunc(<span class="hljs-string">'second'</span>,timepoint)) <span class="hljs-keyword">as</span> started , <font></font>
					count(*) * <span class="hljs-type">interval</span> <span class="hljs-string">'1 second'</span> <span class="hljs-keyword">as</span> duration ,		 <font></font>
					state , <font></font>
					query<font></font>
				<span class="hljs-keyword">FROM</span>  	activity_hist.history_pg_stat_activity_for_reports
				<span class="hljs-keyword">WHERE</span> 	pid= current_pid <span class="hljs-keyword">AND</span> 
						timepoint <span class="hljs-keyword">BETWEEN</span> pg_stat_history_begin+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) <span class="hljs-keyword">AND</span> pg_stat_history_end+(current_hour_diff * <span class="hljs-type">interval</span> <span class="hljs-string">'1 hour'</span>) 						 
				<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> pid , usename , application_name , <font></font>
						datname , <font></font>
						state_change, <font></font>
						state , <font></font>
						query <font></font>
				<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">5</span> , <span class="hljs-number">1</span></code></pre></div></div><br>
<b>:</b><br>
<pre>-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------<font></font>
BLOCKING PROCESSES HISTORY<font></font>
+----+----------+----------+--------------------+----------+--------------------+--------------------+------------------------------+----------------------------------------<font></font>
|   #|       pid|   usename|    application_name|   datname|             started|            duration|                         state|                                   query<font></font>
+----+----------+----------+--------------------+----------+--------------------+--------------------+------------------------------+----------------------------------------<font></font>
|   1|     26211|     tuser|                psql|      tdb1| 2019-09-02 19:31:54|            00:00:04|                          idle|<font></font>
|   2|     26211|     tuser|                psql|      tdb1| 2019-09-02 19:31:58|            00:00:06|           idle in transaction|                                  begin;<font></font>
|   3|     26211|     tuser|                psql|      tdb1| 2019-09-02 19:32:16|            00:01:45|           idle in transaction|                  lock table wafer_data;<font></font>
|   4|     26211|     tuser|                psql|      tdb1| 2019-09-02 19:35:54|            00:01:23|                          idle|                                 commit;<font></font>
|   5|     26211|     tuser|                psql|      tdb1| 2019-09-02 19:38:46|            00:00:02|           idle in transaction|                                  begin;<font></font>
|   6|     26211|     tuser|                psql|      tdb1| 2019-09-02 19:38:54|            00:00:08|           idle in transaction|                  lock table wafer_data;<font></font>
|   7|     26211|     tuser|                psql|      tdb1| 2019-09-02 19:39:08|            00:42:42|                          idle|                                 commit;<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">8 | </font><font style="vertical-align: inherit;">26211 | </font><font style="vertical-align: inherit;">パンツ| </font><font style="vertical-align: inherit;">psql | </font><font style="vertical-align: inherit;">tdb1 | </font><font style="vertical-align: inherit;">2019-09-03 07：12：07 | </font><font style="vertical-align: inherit;">00：00：52 | </font><font style="vertical-align: inherit;">アクティブ| </font><font style="vertical-align: inherit;">test_del（）;を選択します。</font></font><font></font>
</pre><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発。</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
示されている基本的なクエリと受信したレポートは、パフォーマンスインシデントを分析するときに、すでに人生を大幅に簡略化しています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基本的なクエリに基づいて、Oracle AWRを思わせるレポートをリモートで取得できます。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要約レポートの例</font></font></b><div class="spoiler_text"><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ ------------------------------------------------- -----------------------------------</font></font><font></font>
| CONSOLIDATED REPORT FOR ACTIVITY AND WAITINGS . DATETIME : 03.09.2019 14:08<font></font>
|------------------------------------------------------------------------------------<font></font>
| HOST :X.X.X.X<font></font>
| BEGIN_SNAPSHOT :02.09.2019 14:08 END_SNAPSHOT : 03.09.2019 14:00<font></font>
|------------------------------------------------------------------------------------<font></font>
| CURRENT DATABASES SIZE  :<font></font>
| DATABASE :monitor<font></font>
| SIZE (MB) :1370.00<font></font>
|------------------------------------------------------------------------------------<font></font>
| CLUSTER CPU TIME : 19:44:22<font></font>
| CLUSTER WAITINGS TIME : 78:49:16<font></font>
|<font></font>
| SQL DBTIME : 65:53:09<font></font>
| SQL CPU TIME : 19:05:21<font></font>
| SQL WAITINGS TIME : 21:50:46<font></font>
| SQL IOTIME : 20:53:00<font></font>
| SQL READ TIME : 20:52:55<font></font>
| SQL WRITE TIME : 00:00:05<font></font>
|<font></font>
| SQL CALLS : 311293<font></font>
-------------------------------------------------------------<font></font>
| SQL SHARED BLOCKS READS : 13351563334<font></font>
| SQL SHARED BLOCKS HITS : 2775427045<font></font>
| SQL SHARED BLOCKS HITS/READS % : 20.79<font></font>
| SQL SHARED BLOCKS DIRTED : 21105<font></font>
| SQL SHARED BLOCKS WRITTEN : 3656<font></font>
|<font></font>
| SQL TEMPORARY BLOCKS READS : 7464932<font></font>
| SQL TEMPORARY BLOCKS WRITTEN : 10176024<font></font>
-------------------------------------------------------------<font></font>
|<font></font>
| WAITINGS STATICTICS<font></font>
|<font></font>
+------------------------------------------------------------------------------------<font></font>
| TOP 10 WAITINGS BY TOTAL WAIT TIME FOR SYSTEM PROCESSES<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
|    #|               wait_event_type|          wait_event|            duration<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
|    1|                      Activity| LogicalLauncherMain|            11:21:01<font></font>
|    2|                      Activity|    CheckpointerMain|            11:20:35<font></font>
|    3|                      Activity|      AutoVacuumMain|            11:20:31<font></font>
|    4|                      Activity|       WalWriterMain|            11:19:35<font></font>
|    5|                      Activity|        BgWriterMain|            10:14:19<font></font>
|    6|                      Activity|   BgWriterHibernate|            01:06:04<font></font>
|    7|                      Activity|       WalSenderMain|            00:04:05<font></font>
|    8|                        Client|         ClientWrite|            00:04:00<font></font>
|    9|                            IO|        BufFileWrite|            00:02:45<font></font>
|   10|                        LWLock|      buffer_mapping|            00:02:14<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
| TOP 10 WAITINGS BY TOTAL WAIT TIME FOR CLIENTS PROCESSES<font></font>
+-----+------------------------------+--------------------+--------------------+----------<font></font>
|    #|               wait_event_type|          wait_event|            duration|  % dbtime<font></font>
+-----+------------------------------+--------------------+--------------------+----------<font></font>
|    1|                          Lock|       transactionid|            11:55:37|      18.1<font></font>
|    2|                            IO|        DataFileRead|            07:19:43|     11.12<font></font>
|    3|                        Client|          ClientRead|            00:46:54|      1.19<font></font>
|    4|                          Lock|            relation|            00:40:37|      1.03<font></font>
|    5|                        LWLock|      buffer_mapping|            00:31:08|      0.79<font></font>
|    6|                        LWLock|           buffer_io|            00:22:12|      0.56<font></font>
|    7|                       Timeout|             PgSleep|            00:10:58|      0.28<font></font>
|    8|                          Lock|               tuple|            00:01:30|      0.04<font></font>
|    9|                            IO|        BufFileWrite|            00:01:16|      0.03<font></font>
|   10|                            IO|         BufFileRead|            00:00:37|      0.02<font></font>
+-----+------------------------------+--------------------+--------------------+----------<font></font>
| WAITINGS TYPES BY TOTAL WAIT TIME, FOR SYSTEM PROCESSES<font></font>
+-----+------------------------------+--------------------<font></font>
|    #|               wait_event_type|            duration<font></font>
+-----+------------------------------+--------------------<font></font>
|    1|                      Activity|            56:46:10<font></font>
|    2|                            IO|            00:05:13<font></font>
|    3|                        Client|            00:04:00<font></font>
|    4|                        LWLock|            00:03:07<font></font>
+-----+------------------------------+--------------------<font></font>
| WAITINGS TYPES BY TOTAL WAIT TIME, FOR CLIENTS PROCESSES<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
|    #|               wait_event_type|            duration|            % dbtime<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
|    1|                          Lock|            12:37:44|               19.17<font></font>
|    2|                            IO|            07:21:40|               11.17<font></font>
|    3|                        LWLock|            00:53:26|                1.35<font></font>
|    4|                        Client|            00:46:54|                1.19<font></font>
|    5|                       Timeout|            00:10:58|                0.28<font></font>
|    6|                           IPC|            00:00:04|                   0<font></font>
+-----+------------------------------+--------------------+--------------------<font></font>
| WAITINGS FOR SYSTEM PROCESSES<font></font>
+-----+-----------------------------+----------+--------------------+----------------------+--------------------<font></font>
|    #|                 backend_type|    dbname|     wait_event_type|            wait_event|            duration<font></font>
+-----+-----------------------------+----------+--------------------+----------------------+--------------------<font></font>
|    1| logical replication launcher|          |            Activity|   LogicalLauncherMain|            11:21:01<font></font>
|    2|                 checkpointer|          |            Activity|      CheckpointerMain|            11:20:35<font></font>
|    3|          autovacuum launcher|          |            Activity|        AutoVacuumMain|            11:20:31<font></font>
|    4|                    walwriter|          |            Activity|         WalWriterMain|            11:19:35<font></font>
|    5|            background writer|          |            Activity|          BgWriterMain|            10:14:19<font></font>
|    6|            background writer|          |            Activity|     BgWriterHibernate|            01:06:04<font></font>
|    7|                    walsender|          |            Activity|         WalSenderMain|            00:04:05<font></font>
|    8|                    walsender|          |              Client|           ClientWrite|            00:04:00<font></font>
|    9|              parallel worker|      tdb1|                  IO|          BufFileWrite|            00:02:45<font></font>
|   10|              parallel worker|      tdb1|              LWLock|        buffer_mapping|            00:02:05<font></font>
|   11|              parallel worker|      tdb1|                  IO|          DataFileRead|            00:01:10<font></font>
|   12|              parallel worker|      tdb1|                  IO|           BufFileRead|            00:01:05<font></font>
|   13|              parallel worker|      tdb1|              LWLock|             buffer_io|            00:00:45<font></font>
|   14|            autovacuum worker|      tdb1|              LWLock|        buffer_mapping|            00:00:09<font></font>
|   15|                    walwriter|          |                  IO|              WALWrite|            00:00:08<font></font>
|   16|                    walwriter|          |              LWLock|          WALWriteLock|            00:00:04<font></font>
|   17|            background writer|          |              LWLock|          WALWriteLock|            00:00:03<font></font>
|   18|            background writer|          |                  IO|              WALWrite|            00:00:02<font></font>
|   19|            background writer|          |                  IO|         DataFileWrite|            00:00:02<font></font>
|   20|                 checkpointer|          |                  IO| ControlFileSyncUpdate|            00:00:01<font></font>
|   21|            autovacuum worker|      tdb1|              LWLock|             buffer_io|            00:00:01<font></font>
+-----+-----------------------------+----------+--------------------+----------------------+--------------------<font></font>
| WAITINGS FOR SQL<font></font>
+-----+-------------------------+----------+--------------------+--------------------+--------------------+----------<font></font>
|    #|                  queryid|    dbname|     wait_event_type|          wait_event|            duration|  % dbtime<font></font>
+-----+-------------------------+----------+--------------------+--------------------+--------------------+----------<font></font>
|    1|       389015618226997618|      tdb1|                Lock|       transactionid|            09:47:43|     14.87<font></font>
|    2|       389015618226997618|      tdb1|                  IO|        DataFileRead|            05:47:07|      8.78<font></font>
|    3|                         |      tdb1|                Lock|       transactionid|            02:07:54|      3.24<font></font>
|    4|                         |      tdb1|                  IO|        DataFileRead|            01:30:24|      2.29<font></font>
|    5|      8085340880788646241|      tdb1|              Client|          ClientRead|            00:40:20|      1.02<font></font>
|    6|       389015618226997618|      tdb1|              LWLock|      buffer_mapping|            00:20:41|      0.52<font></font>
|    7|       389015618226997618|      tdb1|              LWLock|           buffer_io|            00:17:30|      0.44<font></font>
|    8|      2649515222348904837|      tdb1|             Timeout|             PgSleep|            00:10:58|      0.28<font></font>
|    9|      4710212362688288619|      tdb1|                Lock|            relation|            00:10:44|      0.27<font></font>
|   10|      9150846928388977274|      tdb1|                Lock|            relation|            00:10:24|      0.26<font></font>
|   11|        28942442626229688|      tdb1|                Lock|            relation|            00:07:48|       0.2<font></font>
|   12|      1237430309438971376|      tdb1|                Lock|            relation|            00:07:32|      0.19<font></font>
|   13|                         |      tdb1|              LWLock|      buffer_mapping|            00:04:32|      0.11<font></font>
|   14|                         |      tdb1|              LWLock|           buffer_io|            00:04:13|      0.11<font></font>
|   15|                         |      tdb1|              Client|          ClientRead|            00:03:57|       0.1<font></font>
|   16|      4710212362688288619|      tdb1|              LWLock|      buffer_mapping|            00:02:26|      0.06<font></font>
|   17|      3167065002719415275|      tdb1|                Lock|            relation|            00:02:20|      0.06<font></font>
|   18|      5731212217001535134|      tdb1|              Client|          ClientRead|            00:01:53|      0.05<font></font>
|   19|      1237430309438971376|      tdb1|              LWLock|      buffer_mapping|            00:01:42|      0.04<font></font>
|   20|       389015618226997618|      tdb1|                Lock|               tuple|            00:01:30|      0.04<font></font>
|   21|      8304755792398128062|      tdb1|                Lock|            relation|            00:01:29|      0.04<font></font>
|   22|        28942442626229688|      tdb1|                  IO|        BufFileWrite|            00:01:16|      0.03<font></font>
|   23|      9150846928388977274|      tdb1|                  IO|        DataFileRead|            00:01:07|      0.03<font></font>
|   24|        28942442626229688|      tdb1|              LWLock|      buffer_mapping|            00:01:03|      0.03<font></font>
|   25|      9150846928388977274|      tdb1|              LWLock|      buffer_mapping|            00:00:44|      0.02<font></font>
|   26|        28942442626229688|      tdb1|                  IO|         BufFileRead|            00:00:37|      0.02<font></font>
|   27|        28942442626229688|      tdb1|              LWLock|           buffer_io|            00:00:25|      0.01<font></font>
|   28|      1237430309438971376|      tdb1|                  IO|        DataFileRead|            00:00:24|      0.01<font></font>
|   29|        28942442626229688|      tdb1|                  IO|        DataFileRead|            00:00:22|      0.01<font></font>
|   30|      5731212217001535134|      tdb1|                Lock|            relation|            00:00:20|      0.01<font></font>
|   31|      4710212362688288619|      tdb1|                  IO|        DataFileRead|            00:00:19|      0.01<font></font>
|   32|      9150846928388977274|      tdb1|              Client|          ClientRead|            00:00:09|         0<font></font>
|   33|      3422818749220588372|      tdb1|              Client|          ClientRead|            00:00:08|         0<font></font>
|   34|      1237430309438971376|      tdb1|              Client|          ClientRead|            00:00:06|         0<font></font>
|   35|       389015618226997618|      tdb1|              LWLock|      buffer_content|            00:00:05|         0<font></font>
|   36|      4710212362688288619|      tdb1|              Client|          ClientRead|            00:00:05|         0<font></font>
|   37|      4710212362688288619|      tdb1|              LWLock|           buffer_io|            00:00:04|         0<font></font>
|   38|        28942442626229688|      tdb1|              Client|          ClientRead|            00:00:04|         0<font></font>
|   39|        28942442626229688|      tdb1|                 IPC|      ParallelFinish|            00:00:03|         0<font></font>
|   40|       389015618226997618|      tdb1|                  IO|       DataFileWrite|            00:00:02|         0<font></font>
|   41|     -5730801771815999400|      tdb1|              Client|          ClientRead|            00:00:02|         0<font></font>
|   42|      2404820632950544954|      tdb1|              Client|          ClientRead|            00:00:02|         0<font></font>
|   43|     -6572922443698419129|      tdb1|              Client|          ClientRead|            00:00:02|         0<font></font>
|   44|      8304755792398128062|      tdb1|              Client|          ClientRead|            00:00:02|         0<font></font>
|   45|     -1473395109729441239|      tdb1|              Client|          ClientRead|            00:00:02|         0<font></font>
|   46|                         |      tdb1|              LWLock|      buffer_content|            00:00:01|         0<font></font>
|   47|       180077086776069052|      tdb1|              Client|          ClientRead|            00:00:01|         0<font></font>
|   48|                         |      tdb1|                  IO|       DataFileWrite|            00:00:01|         0<font></font>
|   49|        28942442626229688|      tdb1|                 IPC| MessageQueueReceive|            00:00:01|         0<font></font>
|   50|      2369289265278398647|      tdb1|              Client|          ClientRead|            00:00:01|         0<font></font>
|   51|      9150846928388977274|      tdb1|                  IO|       DataFileWrite|            00:00:01|         0<font></font>
+-----+-------------------------+----------+--------------------+--------------------+--------------------+----------<font></font>
|<font></font>
| CLIENT SQL STATICTICS<font></font>
|<font></font>
+------------------------------------------------------------------------------------<font></font>
| CLIENT SQL ordered by Elapsed Time<font></font>
+--------------------+----------+----------+----------+----------+----------+--------------------<font></font>
|        elapsed time|     calls|  % dbtime|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+--------------------<font></font>
|            06:43:19|        36|      10.2|     85.09|     17.38|      tdb1|  389015618226997618<font></font>
|            02:06:53|       715|      3.21|      0.85|      0.06|      tdb1| 1237430309438971376<font></font>
|            01:52:07|       720|      2.84|      1.19|      0.08|      tdb1| 4710212362688288619<font></font>
|            00:39:03|       357|      0.99|      1.02|      0.33|      tdb1|   28942442626229688<font></font>
|            00:22:00|         8|      0.56|      0.96|         0|      tdb1| 2649515222348904837<font></font>
+--------------------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by CPU Time<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|            cpu time|     calls|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|            16:14:38|        36|      10.2|  06:43:19|     85.09|     17.38|      tdb1|  389015618226997618<font></font>
|            00:13:38|       720|      2.84|  01:52:07|      1.19|      0.08|      tdb1| 4710212362688288619<font></font>
|            00:11:39|       357|      0.99|  00:39:03|      1.02|      0.33|      tdb1|   28942442626229688<font></font>
|            00:10:58|         8|      0.56|  00:22:00|      0.96|         0|      tdb1| 2649515222348904837<font></font>
|            00:09:44|       715|      3.21|  02:06:53|      0.85|      0.06|      tdb1| 1237430309438971376<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by User I/O Wait Time<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|        io_wait time|     calls|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|            05:47:09|        36|      10.2|  06:43:19|     85.09|     17.38|      tdb1|  389015618226997618<font></font>
|            00:02:15|       357|      0.99|  00:39:03|      1.02|      0.33|      tdb1|   28942442626229688<font></font>
|            00:00:24|       715|      3.21|  02:06:53|      0.85|      0.06|      tdb1| 1237430309438971376<font></font>
|            00:00:19|       720|      2.84|  01:52:07|      1.19|      0.08|      tdb1| 4710212362688288619<font></font>
|            00:00:00|         8|      0.56|  00:22:00|      0.96|         0|      tdb1| 2649515222348904837<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by Shared Buffers Reads<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|       buffers reads|     calls|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|          2562353244|        36|      10.2|  06:43:19|     85.09|     17.38|      tdb1|  389015618226997618<font></font>
|            11041689|       357|      0.99|  00:39:03|      1.02|      0.33|      tdb1|   28942442626229688<font></font>
|             3303551|       715|      3.21|  02:06:53|      0.85|      0.06|      tdb1| 1237430309438971376<font></font>
|             3242892|       720|      2.84|  01:52:07|      1.19|      0.08|      tdb1| 4710212362688288619<font></font>
|                   0|         8|      0.56|  00:22:00|      0.96|         0|      tdb1| 2649515222348904837<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by Disk Reads Time<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|           read time|     calls|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|            03:37:46|        36|      10.2|  06:43:19|     85.09|     17.38|      tdb1|  389015618226997618<font></font>
|            00:04:07|       357|      0.99|  00:39:03|      1.02|      0.33|      tdb1|   28942442626229688<font></font>
|            00:00:59|       720|      2.84|  01:52:07|      1.19|      0.08|      tdb1| 4710212362688288619<font></font>
|            00:00:42|       715|      3.21|  02:06:53|      0.85|      0.06|      tdb1| 1237430309438971376<font></font>
|            00:00:00|         8|      0.56|  00:22:00|      0.96|         0|      tdb1| 2649515222348904837<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| CLIENT SQL ordered by Executions<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|               calls|      rows|  % dbtime|total_time|     % CPU|      % IO|    dbname|             queryid<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
|                 720|       720|      2.84|  01:52:07|      1.19|      0.08|      tdb1| 4710212362688288619<font></font>
|                 715|       715|      3.21|  02:06:53|      0.85|      0.06|      tdb1| 1237430309438971376<font></font>
|                 357|         0|      0.99|  00:39:03|      1.02|      0.33|      tdb1|   28942442626229688<font></font>
|                  36|        36|      10.2|  06:43:19|     85.09|     17.38|      tdb1|  389015618226997618<font></font>
|                   8|         8|      0.56|  00:22:00|      0.96|         0|      tdb1| 2649515222348904837<font></font>
+--------------------+----------+----------+----------+----------+----------+----------+--------------------<font></font>
| Complete List of SQL Text<font></font>
----------------------------------------------<font></font>
…<font></font>
</pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つづく。</font><font style="vertical-align: inherit;">次のステップは、テーブルを埋めるプロセスのより詳細な説明であるロック履歴（pg_stat_locks）の形成です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467165/index.html">ロシアのスカラ運動の足跡。パート2</a></li>
<li><a href="../ja467171/index.html">200,000行のインフラストラクチャコードをテストして学んだこと</a></li>
<li><a href="../ja467175/index.html">ゲームエンジンを使用する前によく考える</a></li>
<li><a href="../ja467177/index.html">タランティーノのマーケティングのヒント：どんな役割を果たし、なぜUma Thurmanの石鹸を作るのか</a></li>
<li><a href="../ja467179/index.html">Samsung Compiler Bootcamp：「プログラミングプログラム」の作成を指導</a></li>
<li><a href="../ja467183/index.html">2019年の上位50のチャットボットプラットフォームと仮想アシスタントの調査</a></li>
<li><a href="../ja467185/index.html">下り坂</a></li>
<li><a href="../ja467187/index.html">最新のテクノロジーライブラリを作成する</a></li>
<li><a href="../ja467189/index.html">温度サンプリング</a></li>
<li><a href="../ja467191/index.html">Vivaldi for Androidの作り方</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>