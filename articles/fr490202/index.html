<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♨️ 🏎️ 👨🏻‍🎨 Comptage de requêtes: test de base des performances Django 👩🏽‍🎓 👨🏾‍🤝‍👨🏼 👨🏼‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous. Nous avons préparé une traduction d'un autre matériel utile pour les étudiants du cours "Développeur Web en Python" , qui a commencé h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comptage de requêtes: test de base des performances Django</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/490202/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour à tous. </font><font style="vertical-align: inherit;">Nous avons préparé une traduction d'un autre matériel utile pour les étudiants du cours </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Développeur Web en Python"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui a commencé hier.</font></font><br>
</b></i><br>
<br>
<img src="https://habrastorage.org/webt/-i/l9/rg/-il9rgpfjconn-on4udsprg5vyi.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez souvent entendre parler des méthodes de test telles que TDD et comment tester la logique métier d'une application. Cependant, tester les performances des applications est une tâche complètement différente. Il existe de nombreuses façons différentes, mais l'approche la plus courante consiste à créer un environnement dans lequel vous pouvez mener une attaque DDoS sur votre application et observer son comportement. C'est un sujet très intéressant, mais ce n'est pas ce dont je veux parler aujourd'hui. Aujourd'hui, nous allons examiner un test plus simple, que vous pouvez faire en utilisant les tests unitaires Django par défaut: c'est-à-dire tester le nombre de fois où votre application accède à la base de données.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le test est très simple, et c'est exactement l'aspect qui peut nuire aux performances des applications dans les premiers stades. Cet aspect est le tout premier à être testé lorsque quelque chose commence à fonctionner lentement. La bonne nouvelle est qu'il n'y a qu'une seule chose que vous devez savoir pour écrire des tests de ce type: la méthode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assertNumQueries</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et elle est assez facile à utiliser. Voici un exemple:</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from django.test import TestCase, Client
from django.urls import reverse
from trucks.models import Truck

class TrucksTestCase(TestCase):
    def test_list_trucks_view_performance(self):
        client = Client()

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 1)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code ci-dessus affirme que pendant la visualisation, l' </font></font><code>"trucks:list_trucks"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application n'accèdera à la base de données que 6 fois. Mais il y a autre chose, notez qu'avant de commencer, nous créons d'abord un nouvel objet </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et ensuite nous disons qu'il </font></font><code>trucks_list</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y a au moins un objet </font><font style="vertical-align: inherit;">dans les données de contexte de la vue </font><font style="vertical-align: inherit;">. Dans ce type de tests, cela est important, car vous avez besoin d'une garantie que vous ne testez pas sur un ensemble de données vide. Il est important de comprendre qu'il </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne suffit pas d' </font><font style="vertical-align: inherit;">instancier une classe </font><font style="vertical-align: inherit;">. Vous devez vérifier s'il a été inclus dans le contexte. Peut-être que vous filtrez la liste des camions, il est donc probable que votre instance </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne sera pas incluse dans le résultat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir fait tout ce qui précède, nous avons déjà fait des progrès significatifs, mais il y a une autre étape importante qui est facile à oublier. Si nous voulons que nos vues évoluent, nous devons nous assurer que les performances ne diminuent pas à mesure que le nombre d'articles retournés augmente. En fin de compte, nous avons toujours un problème de performances si nous nous tournons vers la base de données non pas 6 fois pour obtenir un élément, mais 106 si nous avons 100 éléments. Nous avons besoin d'un nombre constant d'appels de base de données, qui ne dépendra pas du nombre d'articles retournés. Heureusement, ce problème est également résolu très simplement, nous devons ajouter un ou plusieurs éléments à la base de données et compter à nouveau le nombre de hits. Voici à quoi ressemblera le test dans la version finale:</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from django.test import TestCase, Client
from django.urls import reverse
from trucks.models import Truck

class TrucksTestCase(TestCase):
    def test_list_trucks_view_performance(self):
        client = Client()

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 1)

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 2)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que nous vérifions à nouveau le nombre d'articles retournés dans le contexte, mais lors de la deuxième manche, nous nous attendons à 2 camions ( </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">La raison de ce comportement est similaire au premier cas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assurer un nombre constant d'appels à la base de données lors de l'ajout de nouvelles données est plus prioritaire que d'assurer un petit nombre d'appels en général. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dernière chose à faire est de vous assurer que vos données sont aussi hydratées que possible. </font><font style="vertical-align: inherit;">Cela signifie que vous devez créer des données connexes qui seront utilisées lors du traitement de votre vue. </font><font style="vertical-align: inherit;">Si vous ne le faites pas, il y a un risque que votre application accède à la base de données plus souvent en production qu'en test (bien qu'elle puisse réussir). </font><font style="vertical-align: inherit;">Dans notre exemple, nous devions créer </font></font><code>TruckDriver</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une entreprise pour notre</font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from trucks.models import Truck, TruckDriver
...
        truck = Truck.objects.create(...)
        TruckDriver.objects.create(name="Alex", truck=truck)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le nombre d'appels de base de données n'est plus constant après avoir effectué les étapes décrites ci-dessus, recherchez plus d'informations sur les méthodes </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select_related</font></font></a> </i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prefetch_related</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout pour aujourd'hui, j'espère qu'à partir de ce moment vous commencerez à vérifier le nombre de requêtes de votre application pour la base de données au tout début du projet. </font><font style="vertical-align: inherit;">Cela ne prendra pas beaucoup de temps, mais évitera les problèmes pouvant survenir avec l'augmentation du nombre d'utilisateurs de votre application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au fait, vous pouvez toujours </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suivre le cours</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">À plus.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490186/index.html">De quoi nous avons fait JET BI. Architecture Business Intelligence System sans digression lyrique</a></li>
<li><a href="../fr490190/index.html">Je vais chercher: géo-positionnement de l'hôte par adresse IP sur Internet global en utilisant le crypto échange Binance comme exemple</a></li>
<li><a href="../fr490194/index.html">Utilisation de RabbitMQ avec MonsterMQ Partie 4</a></li>
<li><a href="../fr490196/index.html">[Flipper Zero] refusez le Raspberry Pi, faites notre propre planche à partir de zéro. Trouver la bonne puce WiFi</a></li>
<li><a href="../fr490198/index.html">Faites confiance mais vérifiez! Zone de démonstration avec projecteurs Epson pour home cinéma dans la salle de démonstration Pult.ru</a></li>
<li><a href="../fr490204/index.html">Le condensé des événements pour les recruteurs RH et IT en mars 2020</a></li>
<li><a href="../fr490208/index.html">Section backend sur DUMP2020: badinage, ventilateur, échec</a></li>
<li><a href="../fr490210/index.html">Accélérer le frontend. Quand beaucoup de demandes de serveur sont bonnes</a></li>
<li><a href="../fr490222/index.html">Bibliothèque standard du jour de la mort</a></li>
<li><a href="../fr490224/index.html">Furtivité à la mode</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>