<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂üèª üë©üèª‚ÄçüöÄ üèí C√≥mo proteger procesos y extensiones de kernel en macOS üë©üèº‚Äçü§ù‚Äçüë®üèø üèóÔ∏è ü§£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Hoy me gustar√≠a hablar sobre c√≥mo puede proteger los procesos contra intrusos en macOS. Por ejemplo, es √∫til para un sistema antivirus o de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C√≥mo proteger procesos y extensiones de kernel en macOS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acronis/blog/497714/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! </font><font style="vertical-align: inherit;">Hoy me gustar√≠a hablar sobre c√≥mo puede proteger los procesos contra intrusos en macOS. </font><font style="vertical-align: inherit;">Por ejemplo, es √∫til para un sistema antivirus o de respaldo, especialmente a la luz del hecho de que bajo macOS hay varias formas de "matar" el proceso. </font><font style="vertical-align: inherit;">Lea sobre esto y sobre los m√©todos de protecci√≥n bajo un gato.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/403/e5f/065/403e5f065b7426d384f3c71e8cb3c8a5.jpg" alt="imagen"></a><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La forma cl√°sica de matar un proceso</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La forma bien conocida de "matar" un proceso es enviar una se√±al sobre un proceso SIGKILL. </font><font style="vertical-align: inherit;">A trav√©s de bash, puede llamar al est√°ndar "kill -SIGKILL PID" o "pkill -9 NAME" para matar. </font><font style="vertical-align: inherit;">El comando kill se conoce desde UNIX y est√° disponible no solo en macOS, sino tambi√©n en otros sistemas similares a UNIX. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al igual que en sistemas similares a UNIX, macOS le permite interceptar cualquier se√±al al proceso, excepto dos: SIGKILL y SIGSTOP. </font><font style="vertical-align: inherit;">En este art√≠culo, la se√±al SIGKILL se considerar√° principalmente como una se√±al que da lugar al cierre de un proceso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOS espec√≠ficos</font></font><br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En macOS, la llamada al sistema kill en el n√∫cleo XNU llama a la funci√≥n psignal (SIGKILL, ...). Intentemos ver qu√© otras acciones de usuario en el espacio de usuario pueden llamar la funci√≥n psignal. Eliminamos las llamadas a la funci√≥n psignal en los mecanismos internos del kernel (aunque pueden no ser triviales, dej√©moslas para otro art√≠culo :): verificaci√≥n de firma, errores de memoria, procesamiento de salida / finalizaci√≥n, violaci√≥n de la protecci√≥n de archivos, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzamos la descripci√≥n general con la funci√≥n y la correspondiente llamada al sistema </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terminate_with_payload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Se puede ver que, adem√°s de la cl√°sica llamada kill, existe un enfoque alternativo que es espec√≠fico para el sistema operativo macOS y no se encuentra en BSD. </font><font style="vertical-align: inherit;">Los principios operativos de ambas llamadas al sistema tambi√©n est√°n cerca. </font><font style="vertical-align: inherit;">Son llamadas directas a la funci√≥n del n√∫cleo psignal. </font><font style="vertical-align: inherit;">Tambi√©n tenga en cuenta que antes de finalizar un proceso, se realiza una verificaci√≥n de ‚Äúse√±alizaci√≥n‚Äù: si el proceso puede enviar una se√±al a otro proceso, el sistema no permite que ninguna aplicaci√≥n elimine procesos del sistema, por ejemplo.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>
<span class="hljs-title">terminate_with_payload_internal</span><span class="hljs-params">(struct proc *cur_proc, <span class="hljs-keyword">int</span> target_pid, <span class="hljs-keyword">uint32_t</span> reason_namespace,
				<span class="hljs-keyword">uint64_t</span> reason_code, <span class="hljs-keyword">user_addr_t</span> payload, <span class="hljs-keyword">uint32_t</span> payload_size,
				<span class="hljs-keyword">user_addr_t</span> reason_string, <span class="hljs-keyword">uint64_t</span> reason_flags)</span>
</span>{<font></font>
...<font></font>
	target_proc = proc_find(target_pid);<font></font>
...<font></font>
	<span class="hljs-keyword">if</span> (!cansignal(cur_proc, cur_cred, target_proc, SIGKILL)) {<font></font>
		proc_rele(target_proc);<font></font>
		<span class="hljs-keyword">return</span> EPERM;<font></font>
	}<font></font>
...<font></font>
	<span class="hljs-keyword">if</span> (target_pid == cur_proc-&gt;p_pid) {
		<span class="hljs-comment">/*
		 * psignal_thread_with_reason() will pend a SIGKILL on the specified thread or
		 * return if the thread and/or task are already terminating. Either way, the
		 * current thread won't return to userspace.
		 */</span><font></font>
		psignal_thread_with_reason(target_proc, current_thread(), SIGKILL, signal_reason);<font></font>
	} <span class="hljs-keyword">else</span> {<font></font>
		psignal_with_reason(target_proc, SIGKILL, signal_reason);<font></font>
	}<font></font>
...<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lanzamiento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se inicia la forma est√°ndar de crear demonios al inicio del sistema y controlar su vida √∫til. </font><font style="vertical-align: inherit;">Llamar√© la atenci√≥n sobre el hecho de que el c√≥digo fuente es para la versi√≥n anterior de launchctl antes de macOS 10.10, los ejemplos de c√≥digo se dan a modo de ilustraci√≥n. </font><font style="vertical-align: inherit;">El launchctl moderno env√≠a se√±ales de launchd a trav√©s de XPC, la l√≥gica de launchctl se le transfiere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consideremos c√≥mo se detiene la aplicaci√≥n. </font><font style="vertical-align: inherit;">Antes de enviar una se√±al SIGTERM, intentan detener la aplicaci√≥n utilizando la llamada al sistema proc_terminate.</font></font><br>
<br>
<pre><code class="cpp hljs">&lt;launchctl src/core.c&gt;<font></font>
...<font></font>
	error = proc_terminate(j-&gt;p, &amp;sig);<font></font>
	<span class="hljs-keyword">if</span> (error) {<font></font>
		job_log(j, LOG_ERR | LOG_CONSOLE, <span class="hljs-string">"Could not terminate job: %d: %s"</span>, error, strerror(error));<font></font>
		job_log(j, LOG_NOTICE | LOG_CONSOLE, <span class="hljs-string">"Using fallback option to terminate job..."</span>);<font></font>
		error = kill2(j-&gt;p, SIGTERM);<font></font>
		<span class="hljs-keyword">if</span> (error) {<font></font>
			job_log(j, LOG_ERR, <span class="hljs-string">"Could not signal job: %d: %s"</span>, error, strerror(error));<font></font>
		} <font></font>
...<font></font>
&lt;&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bajo el cap√≥, proc_terminate, a pesar de su nombre, puede enviar no solo psignal con SIGTERM, sino tambi√©n SIGKILL.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matanza indirecta - l√≠mite de recursos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se puede ver un caso m√°s interesante en otra llamada al sistema </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process_policy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El uso est√°ndar de esta llamada al sistema son los l√≠mites de recursos de la aplicaci√≥n, por ejemplo, para el indexador, hay un l√≠mite en el tiempo del procesador y la cuota de memoria para que el sistema no disminuya significativamente las acciones de almacenamiento en cach√© de archivos. Si la aplicaci√≥n ha alcanzado el l√≠mite de recursos, como se puede ver en la funci√≥n proc_apply_resource_actions, la se√±al SIGKILL se env√≠a al proceso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aunque esta llamada al sistema podr√≠a potencialmente matar un proceso, el sistema no verific√≥ adecuadamente los derechos del proceso que caus√≥ la llamada al sistema. De hecho, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exist√≠a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> una comprobaci√≥n </font><font style="vertical-align: inherit;">, pero es suficiente usar el indicador alternativo PROC_POLICY_ACTION_SET para omitir esta condici√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, si "limita" la cuota de uso de la CPU por la aplicaci√≥n (por ejemplo, permite que solo se ejecute 1 ns), puede eliminar cualquier proceso en el sistema. </font><font style="vertical-align: inherit;">Entonces, el malware puede matar cualquier proceso en el sistema, incluido el proceso antivirus. </font><font style="vertical-align: inherit;">Tambi√©n es interesante el efecto que ocurre cuando se mata un proceso con pid 1 (launchctl) - kernel panic cuando se trata de procesar una se√±al SIGKILL :)</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/91e/fea/a49/91efeaa490ffd57580d2e5f4a59b4988.png" alt="imagen"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øComo resolver el problema?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La forma m√°s sencilla de evitar que se elimine un proceso es reemplazar el puntero de funci√≥n en la tabla de llamadas del sistema. Desafortunadamente, este m√©todo no es trivial por muchas razones </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
: en primer lugar, el s√≠mbolo responsable de la posici√≥n de sysent en la memoria no es solo un s√≠mbolo privado del n√∫cleo XNU, sino que tampoco se puede encontrar en los s√≠mbolos del n√∫cleo. Deber√° utilizar m√©todos de b√∫squeda heur√≠sticos, por ejemplo, desmontaje din√°mico de una funci√≥n y buscar un puntero en ella. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En segundo lugar, la estructura de las entradas en la tabla depende de los indicadores con los que se construy√≥ el n√∫cleo. Si se declara el indicador CONFIG_REQUIRES_U32_MUNGING, se cambiar√° el tama√±o de la estructura; se agregar√° un campo adicional </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sy_arg_munge32</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es necesario llevar a cabo una verificaci√≥n adicional en el indicador con el que se compil√≥ el n√∫cleo, como opci√≥n, comparar punteros con funciones conocidas.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysent</span> {</span>         <span class="hljs-comment">/* system call table */</span>
        <span class="hljs-keyword">sy_call_t</span>       *sy_call;       <span class="hljs-comment">/* implementing function */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> CONFIG_REQUIRES_U32_MUNGING || (__arm__ &amp;&amp; (__BIGGEST_ALIGNMENT__ &gt; 4))</span>
        <span class="hljs-keyword">sy_munge_t</span>      *sy_arg_munge32; <span class="hljs-comment">/* system call arguments munger for 32-bit process */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
        <span class="hljs-keyword">int32_t</span>         sy_return_type; <span class="hljs-comment">/* system call return types */</span>
        <span class="hljs-keyword">int16_t</span>         sy_narg;        <span class="hljs-comment">/* number of args */</span>
        <span class="hljs-keyword">uint16_t</span>        sy_arg_bytes;   <span class="hljs-comment">/* Total size of arguments in bytes for
                                         * 32-bit system calls
                                         */</span><font></font>
};<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afortunadamente, en las versiones modernas de macOS, Apple proporciona una nueva API para trabajar con procesos. </font><font style="vertical-align: inherit;">La API de Endpoint Security permite a los clientes autorizar muchas solicitudes a otros procesos. </font><font style="vertical-align: inherit;">Por lo tanto, puede bloquear cualquier se√±al a los procesos, incluida la se√±al SIGKILL utilizando la API mencionada anteriormente.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;bsm/libbsm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;EndpointSecurity/EndpointSecurity.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> * argv[])</span> </span>{
    <span class="hljs-keyword">es_client_t</span>* cli = <span class="hljs-literal">nullptr</span>;<font></font>
    {<font></font>
        <span class="hljs-keyword">auto</span> res = es_new_client(&amp;cli, ^(<span class="hljs-keyword">es_client_t</span> * client, <span class="hljs-keyword">const</span> <span class="hljs-keyword">es_message_t</span> * message) {
            <span class="hljs-keyword">switch</span> (message-&gt;event_type) {
                <span class="hljs-keyword">case</span> ES_EVENT_TYPE_AUTH_SIGNAL:<font></font>
                {<font></font>
                    <span class="hljs-keyword">auto</span>&amp; msg = message-&gt;event.signal;
                    <span class="hljs-keyword">auto</span> target = msg.target;
                    <span class="hljs-keyword">auto</span>&amp; token = target-&gt;audit_token;
                    <span class="hljs-keyword">auto</span> pid = audit_token_to_pid(token);
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"signal '%d' sent to pid '%d'\n"</span>, msg.sig, pid);<font></font>
                    es_respond_auth_result(client, message, pid == getpid() ? ES_AUTH_RESULT_DENY : ES_AUTH_RESULT_ALLOW, <span class="hljs-literal">false</span>);<font></font>
                }<font></font>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
        });<font></font>
    }<font></font>
<font></font>
    {<font></font>
        <span class="hljs-keyword">es_event_type_t</span> evs[] = { ES_EVENT_TYPE_AUTH_SIGNAL };<font></font>
        es_subscribe(cli, evs, <span class="hljs-keyword">sizeof</span>(evs) / <span class="hljs-keyword">sizeof</span>(*evs));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, getpid());<font></font>
    sleep(<span class="hljs-number">60</span>); <span class="hljs-comment">// could be replaced with other waiting primitive</span><font></font>
<font></font>
    es_unsubscribe_all(cli);<font></font>
    es_delete_client(cli);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Del mismo modo, puede registrar la Pol√≠tica MAC en el n√∫cleo, que proporciona un m√©todo de protecci√≥n de se√±al (pol√≠tica proc_check_signal), pero la API no es oficialmente compatible.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protecci√≥n de extensi√≥n de kernel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de proteger los procesos en el sistema, tambi√©n es necesaria la protecci√≥n de la extensi√≥n del n√∫cleo (kext). macOS proporciona un marco para que los desarrolladores desarrollen convenientemente los controladores de dispositivos IOKit. Adem√°s de proporcionar herramientas para trabajar con dispositivos, IOKit proporciona m√©todos de apilamiento de controladores utilizando instancias de clases C ++. Una aplicaci√≥n en el espacio de usuario podr√° "encontrar" una instancia registrada de la clase para establecer una conexi√≥n kernel-userspace. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para detectar el n√∫mero de instancias de clase en el sistema, existe la utilidad ioclasscount.</font></font><br>
<br>
<pre><code class="cpp hljs">my_kext_ioservice = <span class="hljs-number">1</span>
my_kext_iouserclient = <span class="hljs-number">1</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cualquier extensi√≥n de kernel que desee registrarse en la pila de controladores debe declarar una clase heredada de IOService, por ejemplo, my_kext_ioservice en este caso. La conexi√≥n de aplicaciones de usuario crear√° una nueva instancia de la clase que hereda de IOUserClient, en el ejemplo my_kext_iouserclient. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al intentar descargar el controlador del sistema (comando kextunload), se llama a la funci√≥n virtual "bool terminate (opciones de IOOptionBits)". </font><font style="vertical-align: inherit;">Es suficiente devolver falso en la llamada a la funci√≥n de terminaci√≥n al intentar descargar para desactivar kextunload.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Kext::terminate</span><span class="hljs-params">(IOOptionBits options)</span>
</span>{<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!IsUnloadAllowed)<font></font>
  {<font></font>
    <span class="hljs-comment">// Unload is not allowed, returning false</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> super::<span class="hljs-built_in">terminate</span>(options);<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IOUserClient puede establecer el indicador IsUnloadAllowed en el arranque. </font><font style="vertical-align: inherit;">Cuando la carga es limitada, el comando kextunload devolver√° el siguiente resultado:</font></font><br>
<br>
<pre><code class="cpp hljs">admin@admins-Mac drivermanager % sudo kextunload ./test.kext<font></font>
Password:<font></font>
(kernel) Can<span class="hljs-number">'</span>t remove kext my.kext.test; services failed to <span class="hljs-built_in">terminate</span> - <span class="hljs-number">0xe00002c7</span>.<font></font>
Failed to unload my.kext.test - (iokit/common) unsupported function.<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se debe hacer una protecci√≥n similar para IOUserClient. </font><font style="vertical-align: inherit;">Las instancias de clase se pueden descargar utilizando la funci√≥n de espacio de usuario IOKitLib "IOCatalogueTerminate (mach_port_t, uint32_t flag, io_name_t description);". </font><font style="vertical-align: inherit;">Puede devolver falso en una llamada al comando "terminar" hasta que el espacio de usuario muera la aplicaci√≥n, es decir, no hay llamada a la funci√≥n clientDied.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protecci√≥n de archivos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para proteger los archivos, es suficiente usar la API de Kauth, que le permite restringir el acceso a los archivos. Apple proporciona a los desarrolladores notificaciones sobre varios eventos en el √°mbito, las operaciones KAUTH_VNODE_DELETE, KAUTH_VNODE_WRITE_DATA y KAUTH_VNODE_DELETE_CHILD son importantes para nosotros. Restringir el acceso a los archivos es m√°s f√°cil en el camino: utilizamos la API "vn_getpath" para obtener la ruta al archivo y comparar el prefijo de la ruta. Tenga en cuenta que para optimizar el cambio de nombre de las rutas de las carpetas con archivos, el sistema no autoriza el acceso a cada archivo, sino solo a la carpeta en s√≠, que fue renombrada. Es necesario comparar la ruta principal y restringir KAUTH_VNODE_DELETE para ello.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/6e2/ab5/2fb/6e2ab52fb8c17ea8adfe8b63bcf8f611.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La desventaja de este enfoque puede ser un bajo rendimiento con un n√∫mero creciente de prefijos. Para que la comparaci√≥n no sea igual a O (prefijo * longitud), donde prefijo es el n√∫mero de prefijos, longitud es la longitud de la cadena, puede usar una m√°quina de estado finito determinista (DFA) construida por prefijos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere una forma de construir un DFA para un conjunto dado de prefijos. Inicializamos los cursores al comienzo de cada prefijo. Si todos los cursores apuntan al mismo car√°cter, entonces aumentamos cada cursor en un car√°cter y recordamos que la longitud de la misma l√≠nea es m√°s de uno en uno. Si hay dos cursores con diferentes s√≠mbolos debajo de ellos, dividimos los cursores en grupos por el s√≠mbolo al que apuntan y repetimos el algoritmo para cada grupo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el primer caso (todos los caracteres debajo de los cursores son iguales), obtenemos el estado DFA, que solo tiene una transici√≥n en la misma l√≠nea. </font><font style="vertical-align: inherit;">En el segundo caso, obtenemos una tabla de transici√≥n de tama√±o 256 (n√∫mero de caracteres y el n√∫mero m√°ximo de grupos) en los estados posteriores obtenidos al llamar recursivamente a la funci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considera un ejemplo. </font><font style="vertical-align: inherit;">Para un conjunto de prefijos ("/ foo / bar / tmp /", "/ var / db / foo /", "/ foo / bar / aba /", "foo / bar / aac /") puede obtener el siguiente DFA. </font><font style="vertical-align: inherit;">La figura muestra solo las transiciones que conducen a otros estados, otras transiciones no ser√°n finales. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/190/d0f/5ec/190d0f5ec1fdd8c03df23387d83db44a.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al pasar por los estados DKA, puede haber 3 casos.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se alcanz√≥ el estado final: la ruta est√° protegida, restringimos las operaciones KAUTH_VNODE_DELETE, KAUTH_VNODE_WRITE_DATA y KAUTH_VNODE_DELETE_CHILD</font></font></li>
<li>    ,   ‚Äú‚Äù (  -) ‚Äî   ,   KAUTH_VNODE_DELETE. ,   vnode  ,     ‚Äò/‚Äô,         ‚Äú/foor/bar/t‚Äù,  .</li>
<li>    ,   .       ,   .</li>
</ol><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El objetivo de las soluciones de seguridad desarrolladas es aumentar el nivel de seguridad del usuario y sus datos. Por un lado, este objetivo est√° garantizado por el desarrollo del producto de software Acronis que cubre las vulnerabilidades donde el sistema operativo en s√≠ es "d√©bil". Por otro lado, no debemos descuidar la mejora de aquellos aspectos de seguridad que pueden mejorarse en el lado del sistema operativo, especialmente porque el cierre de tales vulnerabilidades aumenta nuestra propia estabilidad como producto. La vulnerabilidad fue reportada por el equipo de seguridad de productos de Apple y se corrigi√≥ en macOS 10.14.5 (https://support.apple.com/en-gb/HT210119).</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e27/604/c24/e27604c248d5405276235cf613319754.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo esto solo se puede hacer si su utilidad se ha instalado oficialmente en el n√∫cleo. </font><font style="vertical-align: inherit;">Es decir, no existen tales lagunas para el software externo y no deseado. </font><font style="vertical-align: inherit;">Sin embargo, como puede ver, incluso para proteger programas leg√≠timos como los sistemas antivirus y de respaldo, debe trabajar duro. </font><font style="vertical-align: inherit;">Pero ahora, los nuevos productos Acronis para macOS tendr√°n protecci√≥n adicional contra la descarga del sistema.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es497688/index.html">C√≥mo funciona la escuela vespertina Kubernetes</a></li>
<li><a href="../es497696/index.html">¬øC√≥mo funciona Ryuk ransomware que ataca a las empresas?</a></li>
<li><a href="../es497700/index.html">Mitaps semanales en l√≠nea sobre respaldo y DevOps, seguridad y robots desde el 17 de abril</a></li>
<li><a href="../es497702/index.html">Cinco tendencias en el almacenamiento de datos a las que debe prestar atenci√≥n en 2020</a></li>
<li><a href="../es497708/index.html">Te invitamos a una serie de seminarios web de Fujitsu en abril y mayo.</a></li>
<li><a href="../es497724/index.html">Preparaci√≥n de un servidor para publicar una aplicaci√≥n web en Python</a></li>
<li><a href="../es497726/index.html">Escalando pruebas de Android en Odnoklassniki</a></li>
<li><a href="../es497728/index.html">Los peligros de "quemar" chips</a></li>
<li><a href="../es497730/index.html">BDD conveniente: SpecFlow + TFS</a></li>
<li><a href="../es497736/index.html">Revisi√≥n de 10 nuevos motores de combusti√≥n interna.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>