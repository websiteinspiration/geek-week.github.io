<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüç≥ üöµüèæ üìà How much water has leaked? We solve the problem by a moonwalk on Haskell ü§üüèΩ üçî üèê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An interesting task walks on the network, which was asked at an interview on Twitter.
 Imagine that you are looking at walls of various heights in pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How much water has leaked? We solve the problem by a moonwalk on Haskell</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497980/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An interesting task walks on the network, which was asked at an interview on Twitter.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagine that you are looking at walls of various heights in profile. </font><font style="vertical-align: inherit;">It is raining, somewhere the water remains, somewhere it flows over the edges of the wall due to the difference in height. </font><font style="vertical-align: inherit;">The challenge is to determine how much water remains between the walls.</font></font><br>
</blockquote><img src="https://habrastorage.org/webt/me/ek/la/meeklathdugj7yzgjzo09jq1qdw.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To represent the sequence of walls, we can use the list:</font></font><br>
<br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Height</span> = <span class="hljs-type">Int</span></span><font></font>
<font></font>
<span class="hljs-title">walls</span> :: [<span class="hljs-type">Height</span>]
<span class="hljs-title">walls</span> = [<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>]
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To find out the volume of water at the top of each wall, we need to know three things:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Current wall height</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The height of the highest left wall</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The height of the highest right wall</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We find out which wall below is right or left, subtract the height of the current wall from the highest and get the volume of water. </font><font style="vertical-align: inherit;">Let's take a closer look at an example: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vx/rv/2b/vxrv2bwv1_-pf7zswqf33gxerhi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine that we need to calculate the volume of water for wall b. </font><font style="vertical-align: inherit;">The height of the highest left wall - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The height of the highest right wall - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Due to the higher left wall, water will spill out to the right, so we count from the height of the right wall. </font><font style="vertical-align: inherit;">Therefore, the volume of water for the wall </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">height</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">height</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> b = 2 - 1 = 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve this problem in one pass of the list will not work, but it will turn out in two - the whole thing is to calculate the upper left and right walls. </font><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roman_kashitsyn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">showed how it is possible for one, only without obtaining information on the volume of accumulated water on each wall) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We begin by calculating the highest left wall for each wall using the state effect:</font></font><br>
<br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Volume</span> = <span class="hljs-type">Int</span></span><font></font>
<font></font>
<span class="hljs-comment">--|        </span>
<span class="hljs-title">themax</span> :: <span class="hljs-type">Height</span> -&gt; <span class="hljs-type">State</span> <span class="hljs-type">Height</span> <span class="hljs-type">Height</span>
<span class="hljs-title">themax</span> h = modify (max h) *&gt; get<font></font>
<font></font>
<span class="hljs-comment">-- |            </span>
<span class="hljs-title">highest_left</span> :: [<span class="hljs-type">Height</span>] -&gt; [<span class="hljs-type">Height</span>]
<span class="hljs-title">highest_left</span> walls = evalState (traverse themax walls) <span class="hljs-number">0</span>
</code></pre><br>
<img src="https://habrastorage.org/webt/qt/lp/ym/qtlpympmjtpnnrcdufjdiq7xumc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to calculate the highest right wall for each of the walls, but in this case we need to start the count not on the left, but on the right. </font><font style="vertical-align: inherit;">How to be in this case? </font><font style="vertical-align: inherit;">Turn over the list? </font><font style="vertical-align: inherit;">As you might have guessed from the title of this article, there is a more interesting method.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inverse Applicative Functors</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An </font><font style="vertical-align: inherit;">interesting type lives </font><font style="vertical-align: inherit;">in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transformers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">(in the literal and figurative sense of the word). </font><font style="vertical-align: inherit;">It allows you to run applicative effects in the reverse order:</font></font><br>
<br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">Backwards</span> f a = <span class="hljs-type">Backwards</span> { <span class="hljs-title">forwards</span> :: <span class="hljs-title">f</span> <span class="hljs-title">a</span> }</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How it works? </font><font style="vertical-align: inherit;">Let's take a closer look at the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Applicative</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class instance </font><font style="vertical-align: inherit;">for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backwards</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="haskell hljs"><span class="hljs-comment">-- |          liftA2  &lt;**&gt;</span>
<span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">Applicative</span> t =&gt; <span class="hljs-type">Applicative</span> (<span class="hljs-type">Backwards</span> <span class="hljs-title">t</span>) <span class="hljs-keyword">where</span></span>
        pure = <span class="hljs-type">Backwards</span> . pure
	<span class="hljs-type">Backwards</span> f &lt;*&gt; <span class="hljs-type">Backwards</span> x = <span class="hljs-type">Backwards</span> ((&amp;) &lt;$&gt; x &lt;*&gt; f)
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&amp;</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the same application of a function to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> argument </font><font style="vertical-align: inherit;">, but with a different order of arguments: first the argument, then the function:</font></font><br>
<br>
<pre><code class="haskell hljs"><span class="hljs-title">f</span> $ x = x &amp; f</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to laziness, we first compute the second component of the applicative calculation chain, and only then the first - hence the name for this type. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the same </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transformers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there is another interesting type - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reverse</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">Reverse</span> f a = <span class="hljs-type">Reverse</span> { <span class="hljs-title">getReverse</span> :: <span class="hljs-title">f</span> <span class="hljs-title">a</span> }</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It launches effects in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traversable</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in reverse using </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backwards</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now back to our original problem with this very type.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We master the moonwalk</font></font></h4><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúMoonwalk‚Äù (from the English moonwalk), or ‚Äúgliding backward‚Äù, is a dance technique when a dancer moves backward, while simulating leg movements as if walking forward. </font><font style="vertical-align: inherit;">(Wikipedia).</font></font><br>
</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To crank up such a trick, we take the same function with the state effect (as if we were going forward, from left to right), which we used to calculate the highest left wall:</font></font><br>
<br>
<pre><code class="haskell hljs"><span class="hljs-comment">-- |        </span>
<span class="hljs-title">themax</span> :: <span class="hljs-type">Height</span> -&gt; <span class="hljs-type">State</span> <span class="hljs-type">Height</span> <span class="hljs-type">Height</span>
<span class="hljs-title">themax</span> h = modify (max h) *&gt; get<font></font>
<font></font>
<span class="hljs-comment">-- |    ,    :</span>
<span class="hljs-title">highest_right</span> :: [<span class="hljs-type">Height</span>] -&gt; [<span class="hljs-type">Height</span>]
<span class="hljs-title">highest_right</span> walls = getReverse $ evalState (traverse themax $ <span class="hljs-type">Reverse</span> walls) 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have everything to calculate the total volume of accumulated water. </font><font style="vertical-align: inherit;">From the highest left and right walls we select the lowest and subtract the wall height from it - this will be the volume of accumulated water:</font></font><br>
<br>
<pre><code class="haskell hljs"><span class="hljs-title">walls</span> = [<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>]
<span class="hljs-title">let</span> hls = highest_left walls = [<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>]
<span class="hljs-title">let</span> hrs = highest_right walls = [<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>]
<span class="hljs-title">sum</span> $ zipWith3 (\l x r -&gt; min l r - x) hls walls hrs
</code></pre><br>
<img src="https://habrastorage.org/webt/ja/hc/ln/jahclnwidyxqnx6h6dlnmsq8s7u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, applicative functors helped us abstract from specific effects and data structures. </font><font style="vertical-align: inherit;">They have some more interesting uses - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grouping queries</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sorting</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The source code for this solution can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This puzzle has some more interesting approaches that can be viewed </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497956/index.html">Sars miraculous? Genealogy of Wuhan Coronavirus</a></li>
<li><a href="../en497958/index.html">They are among us: exploring vulnerabilities and malicious code in Zoom for Windows</a></li>
<li><a href="../en497960/index.html">Linux network installation</a></li>
<li><a href="../en497964/index.html">Telemedicine. Reverse Engineering Electronic Stethoscope</a></li>
<li><a href="../en497968/index.html">Web Developer Resources: APIs and UI Elements</a></li>
<li><a href="../en497982/index.html">Functional and process approach to management. How and what to manage?</a></li>
<li><a href="../en497984/index.html">Migrating from reCAPTCHA to hCaptcha in Cloudflare</a></li>
<li><a href="../en497986/index.html">Monitoring all memory used by a webpage: performance.measureMemory ()</a></li>
<li><a href="../en497988/index.html">React Application Performance Profiling</a></li>
<li><a href="../en497990/index.html">PostgreSQL: Development of extensions (functions) in C language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>