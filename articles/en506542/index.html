<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèõÔ∏è üë©‚Äçüè≠ üí™üèø DIY video recording to the cloud üçì üçØ üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You, dear reader, are walking along the street on a summer evening, don‚Äôt touch anyone, and then ... they come upon you (pah-pah-pah, as they say). Bu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DIY video recording to the cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506542/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You, dear reader, are walking along the street on a summer evening, don‚Äôt touch anyone, and then ... they come upon you (pah-pah-pah, as they say). </font><font style="vertical-align: inherit;">Bullies, just passers-by, special comrades (as they sang in one old song) - is not so important. </font><font style="vertical-align: inherit;">You take out your phone and start shooting what is happening on video. </font><font style="vertical-align: inherit;">It‚Äôs not very pleasant for those who drive it, and the phone is taken from you (or they are legally seized - underline the necessary). </font><font style="vertical-align: inherit;">There are no witnesses, there is no more video recording on the phone, and there is no evidence for the police and the court, respectively.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The way out of this situation is obvious: the video should not be recorded to a local file on your phone, but directly to a remote server. True, there are not so many ready-made software solutions for implementing this idea (for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): in most cases, the offered applications for a mobile phone are either paid or work very badly. I don‚Äôt consider exotic recommendations such as ‚Äúin case of an attack by hooligans start broadcasting on YouTube‚Äù, as in a real situation you simply won‚Äôt have time to start broadcasting. In addition, the video will be written to someone else's cloud, and very often this is not good.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can, of course, learn Java or Kotlin (and Swift at the same time) or, at worst, master PhoneGap and write your own application. </font><font style="vertical-align: inherit;">However, everything is much simpler: under the cut, a simple solution to this problem is through the HTML5 video / audio API.</font></font></p><a name="habracut"></a><br>
<h2 id="svyazyvatsya-li-s-webrtc"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contact WebRTC</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebRTC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;is a very cool thing, allowing you to broadcast to the cloud directly. </font><font style="vertical-align: inherit;">However, the implementation of such a translation is still hemorrhoids, so I chose the solution much easier. </font><font style="vertical-align: inherit;">The video is written to the phone‚Äôs RAM (note, not to the SD card, but only to the RAM) and every minute (for example), and also after recording is sent to the server. </font><font style="vertical-align: inherit;">That is, even if the hooligans began to take your phone from you - you have time to press the stop button and the last video file goes to the server.</font></font></p><br>
<p>      &nbsp;‚Äî     20&nbsp;.    ,  ,  &nbsp;‚Äî  ,  HTML  javascript.</p><br>
<h2 id="problema-krossbrauzernosti"> </h2><br>
<p>   ,   HTML5 video/audio API,    ,      .           ,    .  ,  ,          :      Mozilla Firefox 68 - Debian   Chrome 83 - Android 7;  Chromium 80 - Debian      Android     , ,   .</p><br>
<p>              ( ,  )  ,     video/audio API,   . ,   <code>navigator.mediaDevices.getUserMedia()</code> , ,   <code>navigator.getUserMedia()</code>    <code>navigator.webkitGetUserMedia</code>,   <code>navigator.mozGetUserMedia</code>. , ,    .  ,     <code>video.srcObject = stream</code>  <code>video.src = URL.createObjectURL(stream)</code>. ,    -   <code>MediaRecorder</code>  <code>fetch</code>; , ,   AJAX'.</p><br>
<h2 id="itak-pristupim-frontend">, ‚Ä¶ </h2><br>
<p>  , , ,    html-,       ( ,  ,   )          fetch-.</p><br>
<p>Html-  ,    :</p><br>
<pre><code class="html hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ru"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width,
      initial-scale=1.0, maximum-scale=1.0, user-scalable=no"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"robots"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"noindex, nofollow"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>VideoCamera<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">muted</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"go()"</span>&gt;</span><span class="hljs-symbol">&amp;#9210;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><br>
<p>, ,   : ,         ( ,     ;       , )   ¬´/¬ª.  ,        ,   ,   <code>style.css</code>:</p><br>
<pre><code class="css hljs"><span class="hljs-selector-tag">html</span> {
   <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;}
<span class="hljs-selector-tag">body</span> {
   <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">0px</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0px</span>; <span class="hljs-attribute">background</span>: black;
   <span class="hljs-attribute">text-align</span>: center;}
<span class="hljs-selector-tag">video</span> {
   <span class="hljs-attribute">display</span>: block; <span class="hljs-attribute">max-height</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">max-width</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">margin</span>: auto;}
<span class="hljs-selector-tag">button</span> {
   <span class="hljs-attribute">display</span>: inline-block; <span class="hljs-attribute">width</span>: <span class="hljs-number">2em</span>; <span class="hljs-attribute">margin-left</span>: -<span class="hljs-number">1em</span>;
   <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">bottom</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">background</span>: none;
   <span class="hljs-attribute">outline</span>: none; <span class="hljs-attribute">border</span>: none; <span class="hljs-attribute">font-size</span>: <span class="hljs-number">30px</span>;  <span class="hljs-attribute">text-align</span>: center;}</code></pre><br>
<p>, , <code>main.js</code>,      :</p><br>
<pre><code class="javascript hljs"><span class="hljs-meta">"use strict"</span>;<font></font>
<font></font>
<span class="hljs-comment">//      </span>
<span class="hljs-keyword">const</span> recTime = <span class="hljs-number">60</span>;<font></font>
<font></font>
<span class="hljs-comment">//    queryString</span>
<span class="hljs-keyword">let</span> pwd = location.search || <span class="hljs-string">'a'</span>; pwd = pwd.trim().replace(<span class="hljs-string">'?'</span>, <span class="hljs-string">''</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> video = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">"video"</span>),<font></font>
      butt  = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">"button"</span>);<font></font>
<font></font>
<span class="hljs-keyword">let</span> media, playFlag = <span class="hljs-literal">false</span>;<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> play = <span class="hljs-keyword">async</span> () =&gt; {
   <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">//     ,   </span>
      <span class="hljs-keyword">let</span> c = <span class="hljs-regexp">/Android|iPhone/i</span>.test(navigator.userAgent) ?<font></font>
         {<span class="hljs-attr">video</span>:{<span class="hljs-attr">facingMode</span>:{<span class="hljs-attr">exact</span>:<span class="hljs-string">"environment"</span>}}, <span class="hljs-attr">audio</span>:<span class="hljs-literal">true</span>} :<font></font>
         {<span class="hljs-attr">video</span>:<span class="hljs-literal">true</span>, <span class="hljs-attr">audio</span>:<span class="hljs-literal">true</span>};<font></font>
<font></font>
      <span class="hljs-comment">//        </span>
      <span class="hljs-keyword">let</span> stream = <span class="hljs-keyword">await</span> navigator.mediaDevices.getUserMedia(c);<font></font>
      video.srcObject = stream;<font></font>
      video.play();<font></font>
<font></font>
      <span class="hljs-comment">//      recTime </span>
      media = <span class="hljs-keyword">new</span> MediaRecorder(stream);<font></font>
      media.ondataavailable = <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> {<font></font>
         fetch(<span class="hljs-string">"api.php"</span>, {
            <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
            <span class="hljs-attr">headers</span>: {<span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"video/webm"</span>, <span class="hljs-string">"X-PWD"</span>: pwd},
            <span class="hljs-attr">body</span>: d.data<font></font>
         })<font></font>
      };<font></font>
      media.start(recTime * <span class="hljs-number">1000</span>);<font></font>
   }<font></font>
   <span class="hljs-keyword">catch</span>(err) {alert(err);}<font></font>
};<font></font>
<font></font>
<span class="hljs-comment">//    /</span>
<span class="hljs-keyword">const</span> go = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
   <span class="hljs-keyword">if</span> (!playFlag) {<font></font>
      butt.innerHTML = <span class="hljs-string">"&amp;#9209;"</span>;<font></font>
      play();<font></font>
   }<font></font>
   <span class="hljs-keyword">else</span> {<font></font>
      butt.innerHTML = <span class="hljs-string">"&amp;#9210;"</span>;<font></font>
      video.pause();<font></font>
      video.srcObject = <span class="hljs-literal">null</span>;<font></font>
      media.stop();      <font></font>
   }<font></font>
   playFlag = !playFlag;<font></font>
}</code></pre><br>
<p>     . ,     ,     ,  -    API   (   )       - . , ,     .</p><br>
<p>     (             <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">fingerprint</a> ),         :        <code>X-PWD</code> fetch-;       (           ),     query string.  ,       URL </p><br>
<pre><code class="plaintext hljs">https://my_domen/path/?abcde</code></pre><br>
<p> <code>abcde</code>   .         : ,      , , ,   ,      .  , ,  -  .</p><br>
<h2 id="a-teper-bekend">‚Ä¶   </h2><br>
<p>     https. , , ,          ,  html-   http. ,  .    ,  , :   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> </a> (  ,          ),      https.</p><br>
<p> ,      https,  .  , ,      ,    ;  , ,    ,      php,       .   ,   <code>api.php</code>    6 :</p><br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
$pwdTrue = <span class="hljs-string">"abcde"</span>;<font></font>
$pwd     = $_SERVER[<span class="hljs-string">"HTTP_X_PWD"</span>];
<span class="hljs-keyword">if</span> ($pwdTrue !== $pwd) <span class="hljs-keyword">exit</span>;<font></font>
<font></font>
@$data = file_get_contents(<span class="hljs-string">"php://input"</span>) <span class="hljs-keyword">or</span> $data = <span class="hljs-string">''</span>;<font></font>
$flName = date(<span class="hljs-string">"ymd-His"</span>).<span class="hljs-string">".webm"</span>;<font></font>
<font></font>
<span class="hljs-keyword">if</span> ($data) file_put_contents(<span class="hljs-string">"video/"</span>.$flName, $data);
<span class="hljs-meta">?&gt;</span></code></pre><br>
<p>    fetch-       <code>video</code>    <code>200613-190123.webm</code> ( 13.06.20&nbsp;‚Äî ,  19:01:23&nbsp;‚Äî ).    <code>video</code>     (  ,        );     ,       <code>.htaccess</code>   ,      ftp.</p><br>
<p>    .        , , 5   ,      6  (      ¬´¬ª).       ;  (   <code>MediaRecorder</code>)         .</p><br>
<p>, ,  ,   :    ,         (    ,       ).       ,     (   unix- ):</p><br>
<pre><code class="plaintext hljs">$ cd ____<font></font>
$ cat * &gt; _.webm</code></pre><br>
<h2 id="kak-polzovatsya"> </h2><br>
<p>    ,        - Android     Chrome ( ,   ). ,              ,  Chrome   ,      .</p><br>
<p>,               - URL,      query string.  ,  Chrome  Android    (   !) .   ,       (       )  .</p><br>
<p>  :        <code>alarm.html</code>:</p><br>
<pre><code class="html hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ru"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"refresh"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"0; url=https://domen/path?abcde"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a shortcut for this file on the phone‚Äôs desktop (directly on the main screen). </font><font style="vertical-align: inherit;">Now in an emergency you need to perform only three actions:</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">turn on the mobile Internet (if it is not turned on on your phone all the time);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">click on the shortcut </font></font><code>alarm.html</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">click on the ‚ÄúRecord‚Äù button on the loaded page.</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last action can be excluded if you slightly correct the front-end code so that the recording starts immediately when the page loads.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That‚Äôs all, in fact: a simple solution, accessible to everyone. </font><font style="vertical-align: inherit;">I sincerely wish you personally never came in handy ...</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en506520/index.html">Conference DEVOXX UK. Choose a framework: Docker Swarm, Kubernetes or Mesos. Part 1</a></li>
<li><a href="../en506524/index.html">HackTheBox. Walkthrough Monteverde. Brute SMB and LPE through Azure Admins</a></li>
<li><a href="../en506530/index.html">How to choose a UPS</a></li>
<li><a href="../en506532/index.html">Through thorns to the stars: make a device for pointing a laser pointer at any celestial object</a></li>
<li><a href="../en506538/index.html">How Wikipedia can reveal your personal data and how it actually uses it</a></li>
<li><a href="../en506548/index.html">Practical use of Kotlin in startups and enterprises</a></li>
<li><a href="../en506558/index.html">Apartment automation</a></li>
<li><a href="../en506560/index.html">What to listen to on the weekend: 5 selected issues of the Russian-language podcast on audio technology</a></li>
<li><a href="../en506562/index.html">Why is it better to compile TS in JS in advance</a></li>
<li><a href="../en506568/index.html">Project Evaluation Levels and Moments</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>