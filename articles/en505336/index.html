<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛈️ 👫 👿 How to: Manet or Monet? Neural network responds 👃🏾 👿 🧟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The artists Eduard Manet and Claude Monet were confused during their lifetime ( here is a very interesting article on Arzamas). Which is not surprisin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to: Manet or Monet? Neural network responds</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505336/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The artists Eduard Manet and Claude Monet were confused during their lifetime ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here is a very interesting article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Arzamas). </font><font style="vertical-align: inherit;">Which is not surprising, because they are both the founders of impressionism and wrote in a similar manner. </font><font style="vertical-align: inherit;">Listening to a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">course on Convolutional neural networks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at coursera </font><font style="vertical-align: inherit;">, I decided to try to </font><font style="vertical-align: inherit;">create </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">a</font></a><font style="vertical-align: inherit;"> model that determines which of the artists painted the picture.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before starting work, I only knew that Manet wrote the “scandalous” </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Olympia”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Breakfast on the Grass”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In the process of collecting data, it became clear that:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The writing style is really very similar</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manet painted more portraits, and Monet painted landscapes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monet has a whole series of similar paintings (for example, the same landscape, painted at different times of the day)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monet painted many more paintings than Manet. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examples of paintings: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manet </font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/o1/s1/d3/o1s1d3imbbm_ki733tjbcnkvtoq.png" alt="image"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monet</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/xt/ql/xf/xtqlxf_u7tly0xjzyr1ln6x9vie.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The code used for this article is available on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The complete data set turned out to be small for both image processing tasks: a little more than 100 images in one class (Manet) and a little more than 400 images in another class (Monet, although this is not all of his paintings). </font><font style="vertical-align: inherit;">Therefore, I did not expect the high accuracy of the classification that can usually be seen in such problems. </font><font style="vertical-align: inherit;">But it was interesting what level could be reached.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple model without additional data processing</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To begin with, we will use a simple CNN model, and we will not process data (except for reselling).</font></font><br>
<br>
<pre><code class="python hljs">model_simple_cnn_wo_augm = tf.keras.models.Sequential([<font></font>
    tf.keras.layers.Conv2D(<span class="hljs-number">16</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>, input_shape=(input_size, input_size, <span class="hljs-number">3</span>)),<font></font>
    tf.keras.layers.MaxPooling2D(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>),<font></font>
    tf.keras.layers.Conv2D(<span class="hljs-number">32</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>),<font></font>
    tf.keras.layers.MaxPooling2D(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>),<font></font>
    tf.keras.layers.Conv2D(<span class="hljs-number">64</span>, (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>),<font></font>
    tf.keras.layers.MaxPooling2D(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>),<font></font>
    tf.keras.layers.Flatten(),<font></font>
    tf.keras.layers.Dense(<span class="hljs-number">512</span>, activation=<span class="hljs-string">'relu'</span>),<font></font>
    tf.keras.layers.Dense(<span class="hljs-number">1</span>, activation=<span class="hljs-string">'sigmoid'</span>)<font></font>
])<font></font>
<font></font>
train_datagen_wo_augm = ImageDataGenerator(rescale=<span class="hljs-number">1.0</span>/<span class="hljs-number">255.</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the results of training, significant overfitting is noticeable: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/us/ys/pa/usyspahxs01dhnz5676runzx6fs.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The best result of validation AUC is 0.883, but the AUC in the training sample is 0.997. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To cope with overfitting, let's try to add data preprocessing.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple data preprocessing model</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For preprocessing, we use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">in keras. </font><font style="vertical-align: inherit;">We add rotation, vertical and horizontal shifts, “stretching” and scaling of the image, changes in brightness and color, as well as horizontal display.</font></font><br>
<br>
<pre><code class="python hljs">train_datagen_with_augm = ImageDataGenerator(rescale=<span class="hljs-number">1.0</span>/<span class="hljs-number">255.</span>,<font></font>
                                  rotation_range=<span class="hljs-number">40</span>,<font></font>
      width_shift_range=<span class="hljs-number">0.2</span>,<font></font>
      height_shift_range=<span class="hljs-number">0.2</span>,<font></font>
      shear_range=<span class="hljs-number">0.2</span>,<font></font>
      zoom_range=<span class="hljs-number">0.2</span>,<font></font>
      brightness_range = [<span class="hljs-number">0.5</span>, <span class="hljs-number">1.5</span>],<font></font>
      channel_shift_range = <span class="hljs-number">100</span>,<font></font>
      horizontal_flip=<span class="hljs-literal">True</span>,<font></font>
      fill_mode=<span class="hljs-string">'nearest'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We leave the model and all the training parameters the same. </font><font style="vertical-align: inherit;">According to the results of the training, it is clear that the metric values ​​(AUC) for the training and validation samples are quite close, that is, pre-processing helped eliminate overfitting. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/r_/pt/ydr_ptvn0hr_q1vckkiq0vqzrhc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the AUC on the test sample is 0.919, on the validation - 0.909. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Results for the first two models:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rw/u3/1y/rwu31yvitkeydbnbxtaiczepqkm.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A simple model with data preprocessing and weights</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adding preprocessing eliminated overfitting. </font><font style="vertical-align: inherit;">And although the AUC was not bad, the imbalance of the data motivated me to try to add more weight to the model. </font><font style="vertical-align: inherit;">I used the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">approach to calculating weights from the keras manual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs">weight_for_manet = (<span class="hljs-number">1</span> / manet_test_size)*(manet_test_size + monet_test_size)/<span class="hljs-number">2.0</span> 
weight_for_monet = (<span class="hljs-number">1</span> / monet_test_size)*(manet_test_size + monet_test_size)/<span class="hljs-number">2.0</span><font></font>
<font></font>
class_weight = {<span class="hljs-number">0</span>: weight_for_manet, <span class="hljs-number">1</span>: weight_for_monet}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result of such calculations, the weight for class 0 (Manet) 2.50, for class 1 (Monet) 0.62. The </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
variable class_weight is then added to model.fit (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, the training result does not differ significantly from the version without weights: AUC in the training set is 0.892, on validation - 0.915. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Results for the first three models:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sy/dz/r0/sydzr0c1x_kj_ndbs7gbumuzr84.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfer learning: using the Inception V3 model</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our data set is small for machine learning tasks, and even more so deep learning. </font><font style="vertical-align: inherit;">In such cases, the transfer learning approach may help. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea is to take a ready-to-use model that has been trained on a large dataset and, accordingly, had the opportunity to learn more patterns in the data. </font><font style="vertical-align: inherit;">After that, the last layer of the network is replaced with the one that suits our task, and the model trains on our data set. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I used the Inception V3 model ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article on "Habr"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">The result was good: AUC on the training sample 0.971, on the validation - 0.970. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Result for all models:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/ql/sm/zxqlsmwvrb4e-6z4s6pmdoppwzs.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test Model Estimation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what the result is on the test sample. </font><font style="vertical-align: inherit;">Compare two models - a simple CNN with data preprocessing and a model obtained during transfer learning using InceptionV3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The results confirm the superiority of the model trained using transfer learning:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u1/m6/ny/u1m6nyms-e4l4wfudhs36shdtbk.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confusion matrix &amp; misclassified examples</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Take the predictions made by the transfer learning model in the test sample and look at the confusion matrix. To do this, we select threshold so as to provide a true positive rate close to 0.95 (this is an arbitrary value). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result is this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s4/-g/wk/s4-gwkmhmsp2xutxq35ghh4y-lc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Total, 19 out of 20 (true negative rate 0.95) are correctly determined from Manet’s paintings, and 75 out of 80 (true positive rate 0.9375) are from Monet’s paintings. TPR and TNR are close, which we would like to achieve, because in this task, it was important to correctly identify both artists. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now look at the pictures that were classified incorrectly. This trick is recommended in his </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">book by</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Andrew Ng. The goal is to try to understand why the model is wrong, and whether it can be modified so as to eliminate the error.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is a picture of Manet, which was classified as Monet: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0b/1y/rm/0b1yrmzjsqaiityivl__cwjmftc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is a picture of Monet, which was defined as Manet: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tm/d7/34/tmd734laf0_aff3pdvzoogmuc2y.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only idea that I had was that portraits (2 paintings with women + a painting with a dog, also count as a portrait) are defined as paintings Mane, because </font><font style="vertical-align: inherit;">he often painted portraits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But this is inaccurate :) Although Monet really painted few portraits (much less than landscapes), on the same test sample there are portraits of his brush, which were correctly determined by the model:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pi/e5/qj/pie5qjdvp0vx2b8iulccqfvaolg.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Given the small dataset and the similarity of objects of different classes, I initially expected to get AUC around 0.8. </font><font style="vertical-align: inherit;">However, even with the help of a simple CNN model with data preprocessing, it was possible to obtain a result close to 0.9, and improve it to 0.97 using transfer learning using InceptionV3.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en505306/index.html">From games to e-commerce projects. Changing the two-year program of Technopark</a></li>
<li><a href="../en505310/index.html">What distinguishes technologically advanced companies and how techlide can help your team grow</a></li>
<li><a href="../en505314/index.html">Linux time synchronization: NTP, Chrony, and systemd-timesyncd</a></li>
<li><a href="../en505322/index.html">Dispatcher of the future: how will his role in the service company change?</a></li>
<li><a href="../en505330/index.html">How to not create a cryptocurrency from scratch in 3 years</a></li>
<li><a href="../en505340/index.html">Walmart employees try to prove that anti-theft AI doesn't work</a></li>
<li><a href="../en505342/index.html">Dependency injection and the dependency inversion principle are NOT ONE AND SAME</a></li>
<li><a href="../en505362/index.html">Vite - lead development without bundles on Vue</a></li>
<li><a href="../en505378/index.html">All this marketing: how to work with contact points in an IT company?</a></li>
<li><a href="../en505386/index.html">Installing Debian on Netgear Stora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>