<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì¥ üßùüèΩ ‚Ñ¢Ô∏è IPSec Todo-Poderoso üìú üëéüèΩ üêê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Boa tarde amigos. N√£o √© segredo que muitos de n√≥s temos pelo menos uma vez, mas tivemos que lidar com a necessidade de configurar uma VPN. Sendo um le...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec Todo-Poderoso</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boa tarde amigos. </font><font style="vertical-align: inherit;">N√£o √© segredo que muitos de n√≥s temos pelo menos uma vez, mas tivemos que lidar com a necessidade de configurar uma VPN. </font><font style="vertical-align: inherit;">Sendo um leitor ativo da Habr, notei que, apesar da abund√¢ncia de artigos sobre o IPSec, para muitos ainda parece ser algo complicado e sobrecarregado. </font><font style="vertical-align: inherit;">Neste artigo, tentarei dissipar esses mitos usando minha pr√≥pria configura√ß√£o totalmente funcional como exemplo. </font><font style="vertical-align: inherit;">Em quatro exemplos, analisaremos completamente a configura√ß√£o da solu√ß√£o Linux (Strongswan) mais popular, de um t√∫nel simples com autentica√ß√£o lateral com chaves PSK a uma conex√£o host a host com autentica√ß√£o de ambos os lados com base em certificados de Let's Encrypt. </font><font style="vertical-align: inherit;">Interessante? </font><font style="vertical-align: inherit;">Bem-vindo ao gato!</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, a VPN foi planejada apenas para a organiza√ß√£o do canal entre o mini-roteador dos pais e o servidor "de cabeceira" dom√©stico, que atua simultaneamente como roteador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s um curto per√≠odo de tempo, o Keenetic foi adicionado a esta empresa a partir de dois dispositivos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, uma vez iniciado, acabou sendo dif√≠cil parar, e logo telefones e laptops apareceram no diagrama, que queriam se esconder do olho publicit√°rio que tudo v√™ do MT_Free e de outras redes WiFi n√£o criptografadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, o amado ILV finalmente fortaleceu o Banhammer, por quem se apaixonou por balan√ßar publicamente em todas as dire√ß√µes e, a fim de neutralizar sua preocupa√ß√£o por meros mortais, ele teve que </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apoiar o setor de TI estrangeiro</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para adquirir VPS no exterior.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, um certo cidad√£o que se parece com Shapoklyak, circulando por toda parte com sua </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bolsa no</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pacote, e provavelmente acreditando que ‚ÄúQuem ajuda as pessoas, est√° perdendo tempo. </font><font style="vertical-align: inherit;">Voc√™ n√£o pode se tornar famoso por boas a√ß√µes - eu queria espiar secretamente o tr√°fego de outra pessoa e lev√°-lo a l√°pis. </font><font style="vertical-align: inherit;">Tamb√©m teremos que nos defender contra esse amor n√£o solicitado e VPN, neste caso, exatamente o que o m√©dico ordenou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resumir um breve resumo. </font><font style="vertical-align: inherit;">Era necess√°rio encontrar uma solu√ß√£o que idealmente pudesse fechar v√°rias tarefas ao mesmo tempo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interconex√£o entre roteadores Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Construa um t√∫nel entre o Linux e o Keenetic Household</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conceda acesso a recursos dom√©sticos e √† Internet a dispositivos vest√≠veis (telefones, laptops) de redes n√£o confi√°veis</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crie um t√∫nel criptografado com seguran√ßa para o VPS remoto</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o se esque√ßa do maravilhoso princ√≠pio KISS - Keep It Simple, Stupid. </font><font style="vertical-align: inherit;">Quanto menos componentes estiverem envolvidos e mais f√°cil √© configurar cada um deles - mais confi√°vel.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vis√£o geral das solu√ß√µes existentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resumir brevemente o que √© agora: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Av√¥ Lenin de todos os protocolos. </font><font style="vertical-align: inherit;">Morreu, "deteriorado em mofo e mel de t√≠lia". </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Algu√©m al√©m de um provedor usa isso? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
projeto </font><b><font style="vertical-align: inherit;">Wireguard</font></b><font style="vertical-align: inherit;"> est√° em desenvolvimento. </font><font style="vertical-align: inherit;">Ativamente serrado. </font><font style="vertical-align: inherit;">√â f√°cil criar um t√∫nel entre dois pares com um IP est√°tico. </font><font style="vertical-align: inherit;">Em outros casos, muletas, bicicletas com rodas quadradas e uma fita el√©trica azul est√£o sempre prontas para ajudar, mas esse n√£o √© o nosso caminho. </font><font style="vertical-align: inherit;">
Profissionais do </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Suporte para m√∫ltiplas plataformas - Windows, Linux, OpenWRT e seus derivados, Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Forte criptografia e suporte a certificados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Flexibilidade de personaliza√ß√£o.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 E contras:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Trabalhe inteiramente no espa√ßo do usu√°rio.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Suporte limitado de roteadores dom√©sticos - krenenko-kosenko no Mikrotik (sem prejudicar as outras vantagens das gl√¢ndulas) e normal no OpenWRT.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dificuldades na configura√ß√£o de clientes m√≥veis: voc√™ precisa baixar ou criar seu pr√≥prio instalador, copiar configura√ß√µes em algum lugar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se houver v√°rios t√∫neis, as dan√ßas aguardam com a edi√ß√£o das unidades do sistema no servidor.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect (implementa√ß√£o de c√≥digo aberto do protocolo Cisco Anyconnect)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Uma solu√ß√£o muito interessante sobre a qual, infelizmente, √© um pouco de informa√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pr√≥s:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O suporte relativamente amplo para v√°rias plataformas - Windows, Android, Mac baseado no aplicativo nativo Cisco Anyconnect da loja - √© uma op√ß√£o ideal para fornecer acesso √† rede interna de dispositivos vest√≠veis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Criptografia forte, suporte a certificado, conectividade 2FA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O protocolo em si √© totalmente baseado em TLS (ao contr√°rio do OpenVPN, que √© facilmente detectado na porta 443). </font><font style="vertical-align: inherit;">Al√©m do TLS, o DTLS tamb√©m √© suportado - durante a sess√£o estabelecida, o cliente pode mudar para a transmiss√£o de dados via UDP e vice-versa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Excelente coexist√™ncia em uma porta de uma VPN e um servidor Web completo usando sniproxy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> F√°cil configura√ß√£o do servidor e dos clientes.</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, tamb√©m, n√£o foram sem contras:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Trabalhe inteiramente no espa√ßo do usu√°rio.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP em cima do TCP √© uma m√° id√©ia.</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√£o h√° suporte de equipamentos de n√≠vel cliente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A complexidade de instalar t√∫neis entre dois Linux: teoricamente poss√≠vel, praticamente - √© melhor gastar tempo com algo mais √∫til.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se houver v√°rios t√∫neis, as dan√ßas com v√°rias configura√ß√µes e unidades de edi√ß√£o do sistema estar√£o aguardando.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece um beco sem sa√≠da, mas depois de olhar mais de perto e passar um tempo estudando, percebi que o IPSec baseado no IKEv2 √© capaz de substituir todo o resto. </font><font style="vertical-align: inherit;">
Pr√≥s </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IKEv2 IPSEC</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Com o advento do IKEv2, o pr√≥prio protocolo tornou-se mais f√°cil de configurar, em compara√ß√£o com a vers√£o anterior, mas com o custo de perder a compatibilidade com vers√µes anteriores.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gra√ßas √† padroniza√ß√£o, o trabalho √© fornecido em qualquer lugar e em qualquer lugar - a lista pode ser mantida indefinidamente. </font><font style="vertical-align: inherit;">Linux, Mikrotik (nas √∫ltimas vers√µes do RouterOS), OpenWRT, Android, iPhone. </font><font style="vertical-align: inherit;">O Windows tamb√©m possui suporte nativo a partir do Windows 7.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alta velocidade: tr√°fego processando completamente no espa√ßo do kernel. </font><font style="vertical-align: inherit;">A parte do espa√ßo do usu√°rio √© necess√°ria apenas para definir par√¢metros de conex√£o e monitorar a integridade do canal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A capacidade de usar v√°rios m√©todos de autentica√ß√£o: usando PSK e certificados e em qualquer combina√ß√£o.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√°rios modos de opera√ß√£o: t√∫nel e transporte. </font><font style="vertical-align: inherit;">Como eles diferem pode ser lido, inclusive em Habr√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√µes pouco exigentes para n√≥s intermedi√°rios: se na primeira vers√£o do IKE houve problemas causados ‚Äã‚Äãpelo NAT, o IKEv2 possui mecanismos internos para superar a NAT e a fragmenta√ß√£o nativa das mensagens IKE, o que permite estabelecer uma conex√£o nos canais com uma curva MTU. </font><font style="vertical-align: inherit;">Olhando para o futuro, direi que, na pr√°tica, nunca encontrei uma rede WiFi, onde quer que um cliente possa estabelecer uma conex√£o.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contras, no entanto, tamb√©m t√™m:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voc√™ precisa gastar algum tempo estudando e entendendo como funciona.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um recurso que pode confundir um novato: o IPSec, diferentemente das solu√ß√µes VPN convencionais, n√£o cria interfaces de rede. </font><font style="vertical-align: inherit;">Somente pol√≠ticas de processamento de tr√°fego s√£o definidas, tudo o mais √© resolvido por meio de firewall.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de prosseguir com a configura√ß√£o, assumimos que o leitor j√° esteja um pouco familiarizado com os conceitos e termos b√°sicos. </font><font style="vertical-align: inherit;">Para ajudar um iniciante, voc√™ pode recomendar um artigo da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e do pr√≥prio Habr, no qual j√° existem artigos bastante interessantes e √∫teis sobre esse t√≥pico.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o √† configura√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tendo decidido sobre a decis√£o, prosseguimos para a configura√ß√£o. </font><font style="vertical-align: inherit;">O diagrama de rede no meu caso tem o seguinte formato (removido sob o spoiler)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagrama de rede</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o servidor dom√©stico que √© o centro da rede. IP externo 1.1.1.1. Uma rede interna 10.0.0.0/23 e outro endere√ßo 10.255.255.1/30 para definir uma sess√£o BGP privada com VPS; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um roteador Linux baseado em um nettop pequeno e silencioso instalado pelos pais. O ISP emite um endere√ßo IP din√¢mico. Rede interna 10.0.3.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keenetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - roteador </font><b><font style="vertical-align: inherit;">Keenetic</font></b><font style="vertical-align: inherit;"> com o IPSec instalado. O ISP emite um endere√ßo IP din√¢mico. Rede interna 10.0.4.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guerreiros da estrada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - dispositivos port√°teis que se conectam a partir de redes n√£o confi√°veis. Os endere√ßos s√£o emitidos aos clientes dinamicamente quando conectados a partir do pool interno (10.1.1.0/24); </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.exemplo.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- VPS fora da jurisdi√ß√£o de um ILV respeitado. </font><font style="vertical-align: inherit;">IP externo - 5.5.5.5, endere√ßo interno 10.255.255.2/30 para definir uma sess√£o BGP privada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro passo. </font><font style="vertical-align: inherit;">Do simples ao complexo: t√∫neis usando chaves pr√©-compartilhadas (PSK)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nas duas caixas Linux, instalamos os pacotes necess√°rios:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos dois hosts, abra as portas 500 / udp, 4500 / udp e permita a passagem do protocolo ESP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite o arquivo /etc/strongswan/ipsec.secrects (no lado do host ipsecgw.example.com) e adicione a seguinte linha:</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No segundo lado, da mesma forma:</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, o ID √© um endere√ßo de email fict√≠cio. </font><font style="vertical-align: inherit;">Mais informa√ß√µes podem ser encontradas no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segredos salvos, seguindo em frente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No host ipsecgw.example.com, edite o arquivo /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da mesma forma, editamos no ponto remoto /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ comparar as configura√ß√µes, poder√° ver que elas s√£o quase espelhadas, apenas as defini√ß√µes de pares s√£o trocadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diretiva </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto = route</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> faz com que charon configure uma intercepta√ß√£o para o tr√°fego que cai nas diretivas left / rightsubnet (seletores de tr√°fego). </font><font style="vertical-align: inherit;">A coordena√ß√£o dos par√¢metros do t√∫nel e a troca de chaves ser√£o iniciadas imediatamente ap√≥s o aparecimento do tr√°fego que cai sob as condi√ß√µes especificadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No servidor ipsecgw.example.com nas configura√ß√µes de firewall, proibimos o mascaramento para uma rede 10.0.3.0/24. </font><font style="vertical-align: inherit;">Permita o encaminhamento de pacotes entre 10.0.0.0/23 e 10.0.3.0/24 e vice-versa. </font><font style="vertical-align: inherit;">No host remoto, realizamos configura√ß√µes semelhantes, desativando o mascaramento da rede 10.0.0.0/23 e configurando o encaminhamento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reiniciamos o strongswan nos dois servidores e tentamos executar ping no n√≥ central:</font></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verifique se tudo funciona:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m ser√° √∫til garantir que o par√¢metro make_before_break esteja definido como yes no arquivo /etc/strongswan/strongswan.d/charon.conf em todos os pares. </font><font style="vertical-align: inherit;">Nesse caso, o daemon charon que atende ao protocolo IKEv2 n√£o excluir√° a associa√ß√£o de seguran√ßa atual durante o procedimento de altera√ß√£o de chave, mas criar√° um novo primeiro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passo dois </font><font style="vertical-align: inherit;">O aparecimento de Keenetic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma surpresa agrad√°vel foi a VPN IPSec embutida no firmware oficial do Keenetic. </font><font style="vertical-align: inherit;">Para ativ√°-lo, basta acessar as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√µes do componente KeeneticOS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e adicionar o pacote </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN IPSec</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Preparamos as configura√ß√µes no n√≥ central, para isso: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite o /etc/strongswan/ipsec.secrects e adicione o PSK para o novo par:</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite /etc/strongswan/ipsec.conf e adicione outra conex√£o ao final:</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No lado do Keenetic, a configura√ß√£o √© feita na WebUI ao longo do caminho: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet -&gt; Conex√µes -&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outras conex√µes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">√â bem simples</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3 fotos)</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ planeja direcionar volumes significativos de tr√°fego atrav√©s do t√∫nel, pode tentar ativar a acelera√ß√£o de hardware, suportada por muitos modelos. </font><font style="vertical-align: inherit;">Ativado pelo comando de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hardware do mecanismo de criptografia</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na CLI. </font><font style="vertical-align: inherit;">Para desabilitar e processar processos de criptografia e hash usando instru√ß√µes gerais da CPU - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">software de mecanismo de criptografia</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Depois de salvar as configura√ß√µes, restauramos a troca forte e deixamos o Keenetic pensar por meio minuto. </font><font style="vertical-align: inherit;">Ent√£o, no terminal, vemos uma conex√£o bem-sucedida:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tudo est√° funcionando:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passo tr√™s </font><font style="vertical-align: inherit;">Protegendo dispositivos m√≥veis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de ler v√°rios manuais e v√°rios artigos, foi decidido parar com um certificado gratuito do Let's Encrypt para autenticar o servidor e a autoriza√ß√£o cl√°ssica por login e senha dos clientes. </font><font style="vertical-align: inherit;">Assim, eliminamos a necessidade de manter nossa pr√≥pria infraestrutura de PKI, monitorar a expira√ß√£o de chaves e realizar gestos desnecess√°rios com dispositivos m√≥veis instalando certificados autoassinados na lista confi√°vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instale os pacotes ausentes:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obtemos o certificado independente (n√£o esque√ßa de abrir 80 / tcp nas configura√ß√µes do iptables primeiro):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s o certbot concluir seu trabalho, devemos ensinar a Strongswan a ver nosso certificado:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no diret√≥rio /etc/strongswan/ipsec.d/cacerts, crie 2 links simb√≥licos: um para o armazenamento raiz de certificados confi√°veis ‚Äã‚Äãem / etc / pki / tls / certs; </font><font style="vertical-align: inherit;">e um segundo com o nome ca.pem apontando para /etc/letsencrypt/live/ipsecgw.example.com/chain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m s√£o criados dois links simb√≥licos no diret√≥rio /etc/strongswan/ipsec.d/certs: o primeiro, com o nome certificate.pem, refere-se ao arquivo /etc/letsencrypt/live/ipsecgw.example.com/cert.pem. </font><font style="vertical-align: inherit;">E o segundo, chamado fullchain.pem, com link para /etc/letsencrypt/live/ipsecgw.example.com/fullchain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No diret√≥rio /etc/strongswan/ipsec.d/private, coloque o link simb√≥lico key.pem apontando para a chave privada gerada pelo certbot e ao longo do caminho /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicione autentica√ß√£o via RSA ao ipsec.secrets e um monte de logins / senhas para novos usu√°rios:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reiniciamos o Strongswan e, ao chamar listadores de sudo strongswan, devemos ver as informa√ß√µes do certificado:</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, descrevemos a nova conex√£o no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o esque√ßa de editar o arquivo / etc / sysconfig / certbot, indicando que tamb√©m atualizaremos o certificado como aut√¥nomo, adicionando CERTBOT_ARGS = "- aut√¥nomo" a ele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, n√£o se esque√ßa de ativar o timer certbot-renew.timer e defina o gancho para reiniciar o Strongswan no caso de emitir um novo certificado. </font><font style="vertical-align: inherit;">Para fazer isso, coloque um script simples do bash em / etc / letsencrypt / renewal-hooks / deploy / ou edite o arquivo / etc / sysconfig / certbot novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reiniciamos o Strongswan, ativamos o mascaramento da rede 10.1.1.0/24 no iptables e configuramos os dispositivos m√≥veis.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instale o aplicativo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no Google Play </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lan√ßamos e criamos um novo</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perfil</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salvamos o perfil, conectamos e, ap√≥s um segundo, n√£o precisamos nos preocupar com algu√©m que possa nos espionar.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verificamos:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">janelas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows das vers√µes atuais foi agradavelmente surpreendido. </font><font style="vertical-align: inherit;">Toda a configura√ß√£o da nova VPN ocorre chamando dois cmdlets do PowerShell:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E mais uma coisa, se o Strongswan estiver configurado para emitir endere√ßos IPv6 para os clientes (sim, ele tamb√©m poder√° faz√™-lo):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte Quatro, Final. </font><font style="vertical-align: inherit;">Cortamos uma janela para a Europa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tendo visto os stubs dos provedores ‚ÄúO site foi bloqueado pela decis√£o do calcanhar esquerdo do quinto vice-promotor da vila Trudovye Mozoli, do condado de Bogozabyt‚Äù, um pequeno VPS discreto apareceu (com o nome de dom√≠nio bem conhecido rkn.example.com) a milhares de quil√¥metros de macacos que gostam de acenar com um banhammer e bloquear redes de tamanho / 16 de cada vez. E girar sobre esse pequeno VPS foi uma cria√ß√£o maravilhosa de colegas do NIC.CZ, chamados BIRD. O p√°ssaro da primeira vers√£o morria constantemente em p√¢nico pela atividade de macacos com cassetetes, que baniam quase 4% da Internet no auge de sua atividade laboral, deixando uma profunda reflex√£o durante a reconfigura√ß√£o; portanto, foi atualizada para a vers√£o 2.0.7. Se os leitores estiverem interessados, publicarei um artigo sobre a transi√ß√£o do BIRD para o BIRD2, no qual o formato de configura√ß√£o mudou drasticamente,mas a nova vers√£o se tornou muito mais r√°pida e n√£o h√° problemas com a reconfigura√ß√£o com um grande n√∫mero de rotas. E como usamos o protocolo de roteamento din√¢mico, √© necess√°rio que haja uma interface de rede atrav√©s da qual voc√™ precise rotear o tr√°fego. Por padr√£o, o IPSec n√£o cria interfaces, mas devido √† sua flexibilidade, podemos usar os t√∫neis GRE cl√°ssicos, que protegeremos no futuro. Como b√¥nus, os hosts ipsecgw.example.com e rkn.example.com se autenticar√£o usando certificados de renova√ß√£o autom√°tica do Lets Encrypt. Sem PSK, apenas certificados, apenas incondicional, n√£o h√° muita seguran√ßa.Por padr√£o, o IPSec n√£o cria interfaces, mas devido √† sua flexibilidade, podemos usar os t√∫neis GRE cl√°ssicos, que protegeremos no futuro. Como b√¥nus, os hosts ipsecgw.example.com e rkn.example.com se autenticar√£o usando certificados de renova√ß√£o autom√°tica do Lets Encrypt. Sem PSK, apenas certificados, apenas incondicional, n√£o h√° muita seguran√ßa.Por padr√£o, o IPSec n√£o cria interfaces, mas devido √† sua flexibilidade, podemos usar os t√∫neis GRE cl√°ssicos, que protegeremos no futuro. Como b√¥nus, os hosts ipsecgw.example.com e rkn.example.com se autenticar√£o usando certificados de renova√ß√£o autom√°tica do Lets Encrypt. Sem PSK, apenas certificados, apenas incondicional, n√£o h√° muita seguran√ßa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acreditamos que o VPS est√° preparado, o Strongswan e o Certbot j√° est√£o instalados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No host ipsecgw.example.com (seu IP √© 1.1.1.1), descrevemos a nova interface gif0:</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espelhado no host vps.example.com (seu IP √© 5.5.5.5):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s aumentamos as interfaces, mas como o iptables n√£o possui uma regra que permita o protocolo GRE, o tr√°fego n√£o passar√° (que √© o que precisamos, pois n√£o h√° prote√ß√£o dentro do GRE contra os f√£s de qualquer tipo de "pacote" legislativo).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cooking VPS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, obtemos outro certificado para o nome de dom√≠nio rkn.example.com. </font><font style="vertical-align: inherit;">Crie links simb√≥licos em /etc/strongswan/ipsec.d conforme descrito na se√ß√£o anterior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite o ipsec.secrets adicionando uma √∫nica linha a ele:</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No lado do host, ipsecgw.example.com tamb√©m √© adicionado ao ipsec.conf na se√ß√£o de configura√ß√£o, o par√¢metro strictcrlpolicy = yes, que inclui uma verifica√ß√£o estrita da CRL. </font><font style="vertical-align: inherit;">E descreva outra conex√£o:</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As configura√ß√µes s√£o quase espelhadas. </font><font style="vertical-align: inherit;">O leitor atento j√° podia prestar aten√ß√£o a alguns pontos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left / rightsubnet =% din√¢mico - instrui o Strongswan a aplicar pol√≠ticas a todos os tipos de tr√°fego entre pares</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o esque√ßa de configurar o firewall e renovar automaticamente os certificados. </font><font style="vertical-align: inherit;">Ap√≥s reiniciar o Strongswan nos dois servidores, inicie o ping no lado oposto do t√∫nel GRE e veja uma conex√£o bem-sucedida. </font><font style="vertical-align: inherit;">No VPS (rkn):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E no lado do host ipsecgw </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sob o spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O t√∫nel est√° instalado, pings v√£o, no tcpdump √© vis√≠vel que apenas o ESP fica entre os hosts. </font><font style="vertical-align: inherit;">Parece poss√≠vel se alegrar. </font><font style="vertical-align: inherit;">Mas voc√™ n√£o pode relaxar sem verificar tudo at√© o fim. </font><font style="vertical-align: inherit;">Estamos tentando reemitir o certificado para VPS e ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chef, est√° tudo quebrado</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßamos a entender e deparar com um recurso desagrad√°vel do Let's Encrypt, que √© bonito em todo o resto - com qualquer reemiss√£o do certificado, a chave privada associada a ele tamb√©m muda. A chave privada mudou - e o p√∫blico mudou. √Ä primeira vista, a situa√ß√£o √© desesperadora para n√≥s: mesmo que possamos extrair facilmente a chave p√∫blica durante a reemiss√£o do certificado usando o gancho no certbot e pass√°-la para o lado remoto via SSH, n√£o est√° claro como fazer o Strongswan remoto rel√™-lo. Mas a ajuda veio de onde eles n√£o esperaram - o systemd pode monitorar as altera√ß√µes no sistema de arquivos e executar os servi√ßos associados ao evento. √â isso que vamos usar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Criaremos um usu√°rio do servi√ßo de observador de chaves em cada um dos hosts com os direitos mais restritos, geraremos chaves SSH para cada um deles e as trocaremos entre os hosts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No host ipsecgw.example.com, crie o diret√≥rio / opt / ipsec-pubkey no qual colocamos 2 scripts.</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No VPS (o host rkn.example.com), criamos de maneira semelhante um diret√≥rio com o mesmo nome, no qual tamb√©m criamos scripts semelhantes, alterando apenas o nome da chave. </font><font style="vertical-align: inherit;">C√≥digo, para n√£o confundir o artigo, em</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b>
                        <div class="spoiler_text">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O script pubkey-copy.sh √© necess√°rio para extrair a parte p√∫blica da chave e copi√°-la para o host remoto ao emitir um novo certificado. </font><font style="vertical-align: inherit;">Para fazer isso, no diret√≥rio / etc / letsencrypt / renewal-hooks / deploy nos dois servidores, crie outro microscript:</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metade do problema foi resolvido, os certificados s√£o reemitidos, as chaves p√∫blicas s√£o extra√≠das e copiadas entre os servidores e chegou a hora do systemd com suas unidades de caminho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No servidor ipsecgw.example.com no diret√≥rio / etc / systemd / system, crie o arquivo keyupdater.path</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da mesma forma no host VPS:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, finalmente, em cada servidor, criamos um servi√ßo associado a esta unidade, que ser√° iniciado quando a condi√ß√£o (PathChanged) for atendida - alterando o arquivo e fechando-o ap√≥s a grava√ß√£o. </font><font style="vertical-align: inherit;">Criamos os arquivos /etc/systemd/system/keyupdater.service e escrevemos:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o se esque√ßa de reler as configura√ß√µes do systemd com o sudo systemctl daemon-reload e atribua a inicializa√ß√£o autom√°tica √†s unidades de caminho via sudo systemctl enable keyupdater.path &amp;&amp; sudo systemctl start keyupdater. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim que o host remoto gravar o arquivo que cont√©m a chave p√∫blica no diret√≥rio inicial do usu√°rio do keywatcher e o descritor de arquivos for fechado, o systemd iniciar√° automaticamente o servi√ßo correspondente, que copiar√° a chave no local desejado e reiniciar√° o Strongswan. </font><font style="vertical-align: inherit;">O t√∫nel ser√° instalado usando a chave p√∫blica correta do segundo lado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode expirar e apreciar o resultado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em vez de uma conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como acabamos de ver o </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inferno</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec n√£o √© t√£o assustador como ele √© pintado. </font><font style="vertical-align: inherit;">Tudo o que foi descrito √© uma configura√ß√£o totalmente operacional atualmente em uso. </font><font style="vertical-align: inherit;">Mesmo sem muito conhecimento, voc√™ pode configurar uma VPN e proteger seus dados com seguran√ßa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, os momentos da configura√ß√£o do iptables permaneceram fora do escopo do artigo, mas o artigo em si j√° era volumoso e muito foi escrito sobre o iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° pontos no artigo que podem ser aprimorados, seja a recusa de reiniciar o daemon Strongswan, a releitura de suas configura√ß√µes e certificados, mas n√£o consegui isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, as reinicializa√ß√µes do daemon n√£o foram assustadoras: um ou dois pings entre pares s√£o perdidos, os clientes m√≥veis restauram a conex√£o eles mesmos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que os colegas nos coment√°rios indiquem a solu√ß√£o correta.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt504464/index.html">Como criamos o TableAdapter e simplificamos o trabalho com o UITableView</a></li>
<li><a href="../pt504468/index.html">Desempenho do Raspberry Pi: adicione ZRAM e altere os par√¢metros do kernel</a></li>
<li><a href="../pt504472/index.html">Minhas principais ferramentas gratuitas para desenvolvedores</a></li>
<li><a href="../pt504480/index.html">Como encontrar um profissional de marketing com quem ser√° rent√°vel trabalhar?</a></li>
<li><a href="../pt504482/index.html">Pergunte-nos: DIT responder√° perguntas</a></li>
<li><a href="../pt504486/index.html">Processo: Criando o Vue 3</a></li>
<li><a href="../pt504488/index.html">Quais ind√∫strias e tecnologias come√ßar√£o a se desenvolver rapidamente ap√≥s resolver o problema do COVID-19</a></li>
<li><a href="../pt504490/index.html">Resumo dos eventos on-line de junho</a></li>
<li><a href="../pt504492/index.html">Pressione o bot√£o: teoria e pr√°tica da vota√ß√£o eletr√¥nica - mesa redonda em 30 de maio</a></li>
<li><a href="../pt504502/index.html">A vida curta e estranha do primeiro rob√¥ amig√°vel do mundo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>