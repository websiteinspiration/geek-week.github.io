<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸšŸ ğŸ¬ ğŸ‘¨ğŸ¾â€ğŸ’» Massive PostgreSQL-Abfrageoptimierung. Kirill Borovikov (Tensor) ğŸ“ ğŸ¦ ğŸ”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Bericht enthÃ¤lt einige AnsÃ¤tze, mit denen Sie die Leistung von SQL-Abfragen Ã¼berwachen kÃ¶nnen, wenn Millionen von Abfragen pro Tag und Hunderte vo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Massive PostgreSQL-Abfrageoptimierung. Kirill Borovikov (Tensor)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/487380/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Bericht enthÃ¤lt einige AnsÃ¤tze, mit denen Sie </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Leistung von SQL-Abfragen Ã¼berwachen kÃ¶nnen, wenn Millionen von Abfragen pro Tag</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und Hunderte von kontrollierten PostgreSQL-Servern vorhanden sind. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Welche technischen LÃ¶sungen ermÃ¶glichen es uns, ein solches Informationsvolumen effizient zu verarbeiten, und wie erleichtert es das Leben eines normalen Entwicklers?</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/5XKbFb-l5Do" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wer interessiert sich fÃ¼r die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyse spezifischer Probleme und verschiedener Techniken zur Optimierung von</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SQL-Abfragen und zur LÃ¶sung typischer DBA-Probleme in PostgreSQL </font><font style="vertical-align: inherit;">? Sie </font><font style="vertical-align: inherit;">kÃ¶nnen auch </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine Reihe von Artikeln</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu diesem Thema </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">lesen</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/rj/lq/ao/rjlqaolzkdl1dwerrz6q1f41exs.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mein Name ist Kirill Borovikov, ich vertrete die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firma "Tensor"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Insbesondere bin ich auf die Arbeit mit Datenbanken in unserem Unternehmen spezialisiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute werde ich Ihnen sagen, wie wir die Abfrageoptimierung durchfÃ¼hren, wenn Sie nicht die Leistung einer einzelnen Anforderung "erfassen" mÃ¼ssen, sondern das Problem massenhaft lÃ¶sen mÃ¼ssen. Wenn es Millionen von Anfragen gibt und Sie einige </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AnsÃ¤tze zur LÃ¶sung</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dieses groÃŸen Problems finden mÃ¼ssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen ist â€Tensorâ€œ fÃ¼r unsere Millionen Kunden </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VLSI - unsere Anwendung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ein soziales Unternehmensnetzwerk, VideokommunikationslÃ¶sungen fÃ¼r das interne und externe Dokumentenmanagement, Buchhaltungssysteme fÃ¼r die Buchhaltung und Speicherung ... Das heiÃŸt, ein solcher â€Mega-MÃ¤hdrescherâ€œ fÃ¼r die integrierte GeschÃ¤ftsfÃ¼hrung, Das sind mehr als 100 verschiedene interne Projekte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um sicherzustellen, dass alle normal funktionieren und sich normal entwickeln, haben wir 10 Entwicklungszentren im ganzen Land und mehr als </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000 Entwickler</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir arbeiten seit 2008 mit PostgreSQL zusammen und haben eine groÃŸe Menge von dem, was wir verarbeiten - dies sind </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kundendaten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , statistische, analytische Daten von externen Informationssystemen - </font><b><font style="vertical-align: inherit;">mehr als 400 TB gesammelt</font></b><font style="vertical-align: inherit;"> . Nur "in Produktion" gibt es ungefÃ¤hr 250 Server, und insgesamt sind die von uns Ã¼berwachten Datenbankserver ungefÃ¤hr 1000. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dx/sb/ej/dxsbejtgor4d4qc7u1cpkmxptx8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL ist eine deklarative Sprache. Sie beschreiben nicht, wie etwas funktionieren soll, sondern was Sie erhalten mÃ¶chten. DBMS weiÃŸ besser, wie man JOIN macht - wie man seine Tablets verbindet, welche Bedingungen auferlegt werden mÃ¼ssen, was nach Index geht, was nicht ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige DBMS akzeptieren Hinweise: "Nein, verbinden Sie diese beiden Tablets in der einen oder anderen Warteschlange", PostgreSQL jedoch nicht. Dies ist die bewusste Position der fÃ¼hrenden Entwickler: "Besser, wir beenden den Abfrageoptimierer, als die Entwickler einen Hinweis verwenden zu lassen." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz der Tatsache, dass PostgreSQL es nicht zulÃ¤sst, dass sich "auÃŸen" selbst kontrolliert, kÃ¶nnen Sie perfekt </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sehen, was "innen" passiert,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wenn Sie Ihre Abfrage ausfÃ¼hren und wo es Probleme gibt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k_/wc/q0/k_wcq0dayliwb4tturtbl3dmyre.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit welchen klassischen Problemen kommt der Entwickler normalerweise zu DBA? "Hier haben wir die Anfrage erfÃ¼llt, und </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alles ist langsam</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , alles hÃ¤ngt, etwas passiert ... irgendeine Art von Ã„rger!" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die GrÃ¼nde sind fast immer dieselben:</font></font><br>
<br>
<ul>
<li><b>  </b><br>
: Â«   SQL  10   JOIN...Â» â€”  ,       Â«Â»,     .    ,       (10    FROM)   - . [<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>]</li>
<li><b> </b><br>
     PostgreSQL,     Â«Â»  ,   â€”     Â«Â»  .       10 ,   10 ,  PostgreSQL      ,      . [<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>]</li>
<li><b>Â«Â»  </b><br>
          ,     , ,   .  â€¦ -   ,       .</li>
<li><b></b><br>
 ,         (INSERT, UPDATE, DELETE) â€”    .</li>
</ul><br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... und fÃ¼r alles andere </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brauchen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wir </font><b><font style="vertical-align: inherit;">einen Plan</font></b><font style="vertical-align: inherit;"> ! Wir mÃ¼ssen sehen, was im Server passiert. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c8/ni/rt/c8nirti-tkun1t6z4sxgpnwfwbw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der AbfrageausfÃ¼hrungsplan fÃ¼r PostgreSQL ist ein Baum des AbfrageausfÃ¼hrungsalgorithmus in einer Textdarstellung. Es ist der Algorithmus, der als Ergebnis der Analyse durch den Planer als der effektivste erkannt wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder Baumknoten ist eine Operation: Daten aus einer Tabelle oder einem Index extrahieren, eine Bitmap erstellen, zwei Tabellen verbinden, Stichproben verbinden, schneiden oder entfernen. Die ErfÃ¼llung der Anfrage ist eine Passage durch die Knoten dieses Baumes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um einen Abfrageplan zu erhalten, ist es am einfachsten, die Anweisung auszufÃ¼hren </font></font><code>EXPLAIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Um alle realen Attribute zu erhalten, fÃ¼hren Sie eine Abfrage aus, die auf - basiert </font></font><code>EXPLAIN (ANALYZE, BUFFERS) SELECT ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der schlechte Punkt: Wenn Sie es ausfÃ¼hren, geschieht es "hier und jetzt", daher ist es nur fÃ¼r das lokale Debuggen geeignet. Wenn Sie einen hoch geladenen Server nehmen, der einem starken Strom von DatenÃ¤nderungen ausgesetzt ist, und Sie sehen: â€Ay! Hier sind wir langsamer zu </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xia</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eine Anfrage. " Vor einer halben Stunde, einer Stunde - wÃ¤hrend Sie diese Anforderung ausgefÃ¼hrt und aus den Protokollen abgerufen und erneut auf den Server Ã¼bertragen haben, haben sich Ihr gesamter Datensatz und Ihre Statistiken geÃ¤ndert. Sie fÃ¼hren es zum Debuggen aus - und es lÃ¤uft schnell! Und Sie kÃ¶nnen nicht verstehen, warum, warum </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> langsam war. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/-t/fu/y9-tfu3qhvhayjt86xoy02qy4ju.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, was genau zu dem Zeitpunkt war, als die Anforderung auf dem Server ausgefÃ¼hrt wurde, haben intelligente Personen das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modul auto_explain geschrieben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Es ist in fast allen gÃ¤ngigen PostgreSQL-Distributionen vorhanden und kann einfach in der Konfigurationsdatei aktiviert werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn er versteht, dass eine Anfrage lÃ¤nger ausgefÃ¼hrt wird als die Grenze, die Sie ihm mitgeteilt haben, macht er einen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€Schnappschussâ€œ des Plans fÃ¼r diese Anfrage und schreibt sie zusammen in ein Protokoll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qh/cs/c1/qhcsc15sgsaruhdj6ghcjggfz7c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt scheint alles in Ordnung zu sein, wir gehen zum Protokoll und sehen dort ... [Textschritt]. Aber wir kÃ¶nnen nichts Ã¼ber ihn sagen, auÃŸer der Tatsache, dass dies ein ausgezeichneter Plan ist, da die Fertigstellung 11 ms gedauert hat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles scheint in Ordnung zu sein - aber nichts ist klar darÃ¼ber, was wirklich passiert ist. Neben der Gesamtzeit sehen wir nicht viel. Denn einen solchen "Latuha" Klartext anzuschauen ist im Allgemeinen beliebt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber selbst wenn es geliebt wird, wenn auch unangenehm, gibt es grÃ¶ÃŸere Probleme:</font></font><br>
<br>
<ul>
<li>   <b>    </b>  .     ,       Index Scan    â€” ,     -  .    ,    Â«Â»   , CTE â€”     Â« Â».</li>
<li> : ,    , â€”  <b>   </b>.      , ,    ,  ,      loops â€”   .         .    ,  ,        ,      â€” - Â« Â».</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verstehen Sie unter diesen UmstÃ¤nden "Wer ist das schwÃ¤chste Glied?" </font><font style="vertical-align: inherit;">fast unrealistisch. </font><font style="vertical-align: inherit;">Daher schreiben selbst die Entwickler im "Handbuch", dass </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Den Plan zu verstehen eine Kunst ist, die gelernt, erlebt ... werden muss"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber wir haben 1000 Entwickler, und jeder von ihnen wird diese Erfahrung nicht in seinen Kopf geben. </font><font style="vertical-align: inherit;">Ich, du, er - sie wissen, und jemand da drÃ¼ben - ist nicht mehr da. </font><font style="vertical-align: inherit;">Vielleicht lernt er oder vielleicht auch nicht, aber er muss jetzt arbeiten - und woher wÃ¼rde er diese Erfahrung machen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visualisierung planen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher haben wir erkannt, dass wir eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gute Visualisierung des Plans</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> benÃ¶tigen, um diese Probleme zu lÃ¶sen </font><font style="vertical-align: inherit;">. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Artikel]</font></font></a><br>
<br>
<img src="https://habrastorage.org/webt/ev/nz/3g/evnz3gitzrva603ckfpd42ilzas.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wir gingen zuerst â€um den Marktâ€œ - schauen wir uns im Internet an, was im Allgemeinen existiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellte sich jedoch heraus, dass es relativ wenige â€Liveâ€œ -LÃ¶sungen gibt, die sich mehr oder weniger entwickeln. Es gibt buchstÃ¤blich nur eines: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPLAIN.depesz.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> von Hubert Lubaczewski. </font><font style="vertical-align: inherit;">Am Eingang zum Feld "Feed" eine Textdarstellung des Plans, zeigt es Ihnen eine Platte mit den analysierten Daten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">richtige Knotenarbeitszeit</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesamtzeit Ã¼ber den gesamten Teilbaum</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Anzahl der DatensÃ¤tze, die abgerufen wurden und die statistisch erwartet wurden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der KnotenkÃ¶rper selbst</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Dienst kann auch das Archiv von Links freigeben. Du hast deinen Plan dorthin geworfen und gesagt: "Hey, Vasya, hier ist ein Link fÃ¼r dich, da stimmt etwas nicht." </font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/td/ik/odtdikeo22jwnlaxmizq2jodns0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt jedoch einige kleinere Probleme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstens eine groÃŸe Menge an Copy-Paste. Sie nehmen ein StÃ¼ck des Protokolls, legen es dort ab und immer wieder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweitens </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gibt es keine Analyse der gelesenen Datenmenge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - genau die Puffer, die angezeigt werden </font></font><code>EXPLAIN (ANALYZE, BUFFERS)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sehen wir hier nicht. Er weiÃŸ einfach nicht, wie er sie zerlegen, verstehen und damit arbeiten soll. Wenn Sie viele Daten lesen und verstehen, dass Sie auf einer Festplatte und einem Cache im Speicher falsch "zerlegen" kÃ¶nnen, sind diese Informationen sehr wichtig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der dritte negative Punkt ist die sehr schwache Entwicklung dieses Projekts. Die Commits sind sehr klein, es ist gut, wenn alle sechs Monate, und der Code in Perl.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d9/zu/o6/d9zuo6g5etaeqqdpfsozjtzv09c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber das sind alles "Texte", man kÃ¶nnte irgendwie damit leben, aber eines hat uns von diesem Service abgewandt. Dies sind Analysefehler der Common Table Expression (CTE) und verschiedene dynamische Knoten wie InitPlan / SubPlan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie diesem Bild glauben, ist die GesamtausfÃ¼hrungszeit jedes einzelnen Knotens grÃ¶ÃŸer als die GesamtausfÃ¼hrungszeit der gesamten Anforderung. Es ist ganz einfach: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Generierungszeit dieses CTE wurde nicht vom CTE-Scan-Knoten abgezogen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Daher wissen wir nicht mehr die richtige Antwort, wie viel der CTE-Scan selbst gekostet hat. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uj/gt/8a/ujgt8auhv331ek_visf6ew7jslq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann wurde uns klar, dass es Zeit war, unser eigenes zu schreiben - Hurra! Jeder Entwickler sagt: "Jetzt werden wir unsere eigenen schreiben, es wird einfach super!"</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie nahmen einen typischen Webdienst-Stack: den Kern auf Node.js + Express, zog Bootstrap und fÃ¼r schÃ¶ne Diagramme - D3.js. </font><font style="vertical-align: inherit;">Und unsere Erwartungen waren berechtigt - wir haben den ersten Prototyp seit 2 Wochen erhalten:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eigener Plan-Parser</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Das heiÃŸt, jetzt kÃ¶nnen wir im Allgemeinen jeden Plan aus den von PostgreSQL generierten PlÃ¤nen analysieren.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">korrekte Analyse dynamischer Knoten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - CTE Scan, InitPlan, SubPlan</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyse der Verteilung von Puffern</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - wo Seiten mit Daten aus dem Speicher gelesen werden, wo aus dem lokalen Cache, wo von der Festplatte</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sichtbarkeit erhalten</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Damit es nicht "im Protokoll" ist, dass es "grÃ¤bt", sondern dass Sie das "schwÃ¤chste Glied" sofort im Bild sehen.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/ou/gb/jf/ougbjf30wnktdmvhpqtjj6feqto.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben so etwas - sofort mit Syntaxhervorhebung. Normalerweise arbeiten unsere Entwickler jedoch nicht mehr mit einer vollstÃ¤ndigen PrÃ¤sentation des Plans, sondern mit einer kÃ¼rzeren. Immerhin haben wir bereits alle Ziffern analysiert und nach links und rechts geworfen, und in der Mitte haben wir nur die erste Zeile gelassen: Was fÃ¼r ein Knoten ist das: CTE-Scan, CTE- oder Seq-Scan-Generierung durch eine Art Etikett. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese abgekÃ¼rzte Ansicht nennen wir die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planvorlage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zg/do/j_/zgdoj_caxmbjnyiq_gkiy0cfniw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was wÃ¤re sonst noch bequem? Es wÃ¤re praktisch zu sehen, welcher Anteil von welchem â€‹â€‹Knoten der Gesamtzeit uns zugewiesen ist - und einfach das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kreisdiagramm</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf der Seite â€festzuhaltenâ€œ </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir zeigen auf den Knoten und sehen - bei uns hat sich herausgestellt, dass Seq Scan weniger als ein Viertel der gesamten Zeit in Anspruch genommen hat und die restlichen 3/4 CTE Scan. Grusel! Dies ist eine kleine Bemerkung zur â€Feuerrateâ€œ von CTE Scan, wenn Sie diese aktiv in Ihren Abfragen verwenden. Sie sind nicht sehr schnell - sie verlieren sogar gegenÃ¼ber dem Ã¼blichen Tabellenscan. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Artikel] </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Artikel]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aber normalerweise sind solche Diagramme interessanter und komplizierter, wenn wir sofort auf ein Segment zeigen, und wir sehen zum Beispiel, dass mehr als die HÃ¤lfte der Zeit ein Seq-Scan â€gegessenâ€œ hat. AuÃŸerdem war eine Art Filter drin, ein paar DatensÃ¤tze wurden darauf abgelegt ... Sie kÃ¶nnen dieses Bild direkt an den Entwickler werfen und sagen: â€Vasya, hier ist alles schlecht mit Ihnen! Verstehe, schau - etwas stimmt nicht! â€œ </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ul/4i/2q/ul4i2q_4iasvokxfdcwp7jd9tj0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NatÃ¼rlich gab es einen "Rechen".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das erste, worauf sie â€getretenâ€œ sind, ist das Problem der Rundung. Die Knotenzeit jedes Individuums im Plan wird mit einer Genauigkeit von 1 Î¼s angegeben. Und wenn die Anzahl der Knotenzyklen beispielsweise 1000 Ã¼berschreitet - nach der AusfÃ¼hrung hat PostgreSQL sie "bis zu" aufgeteilt, dann erhalten wir in der umgekehrten Berechnung die Gesamtzeit "irgendwo zwischen 0,95 ms und 1,05 ms". Wenn das Konto in Mikrosekunden ausgegeben wird - noch nichts, aber bereits fÃ¼r [Millisekunden] -, mÃ¼ssen diese Informationen berÃ¼cksichtigt werden, wenn Ressourcen auf den Knoten des "Wer hat wie viel verbraucht" "gelÃ¶st" werden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fp/ds/f9/fpdsf9qkt6t_0q810uqhmrivc-k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der zweite, komplexere Punkt ist die Verteilung von Ressourcen (dieselben Puffer) auf dynamische Knoten. Dies kostete uns die ersten 2 Wochen des Prototyps plus das Plus von Woche 4.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Problem zu lÃ¶sen ist ganz einfach - wir machen einen CTE und lesen angeblich etwas darin. TatsÃ¤chlich ist PostgreSQL intelligent und liest dort nichts. Dann nehmen wir die erste Aufzeichnung davon und die ersten hundert vom gleichen CTE dazu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s5/fv/rg/s5fvrgut9bky4uqjgmawpm97ks4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir schauen uns den Plan an und verstehen - seltsam, wir haben 3 Puffer (Datenseiten), die im Seq Scan "verbraucht" wurden, einen weiteren im CTE Scan und zwei weitere im zweiten CTE Scan. Das heiÃŸt, wenn alles einfach zusammengefasst wird, erhalten wir 6, aber von der Platte lesen wir nur 3! CTE Scan liest nichts von irgendwoher, sondern arbeitet direkt mit dem Prozessspeicher. Das heiÃŸt, hier stimmt eindeutig etwas nicht! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TatsÃ¤chlich stellt sich heraus, dass hier alle 3 Seiten mit Daten, die von Seq Scan angefordert wurden, zuerst 1 nach dem 1. CTE-Scan und dann nach dem 2. gefragt wurden und weitere 2 gelesen wurden. Das heiÃŸt, insgesamt wurden 3 Seiten gelesen Daten, nicht 6.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3q/5q/nh/3q5qnhygdtg3fh1os2fa-1kixhg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dieses Bild hat uns zu dem VerstÃ¤ndnis gefÃ¼hrt, dass die Umsetzung des Plans kein Baum mehr ist, sondern nur eine Art azyklischer Graph. </font><font style="vertical-align: inherit;">Und wir haben ein Diagramm wie dieses, damit wir verstehen, "woher es Ã¼berhaupt kam". </font><font style="vertical-align: inherit;">Das heiÃŸt, hier haben wir einen CTE aus pg_class erstellt und zweimal danach gefragt, und fast die ganze Zeit haben wir den Zweig in Anspruch genommen, als wir das zweite Mal danach gefragt haben. </font><font style="vertical-align: inherit;">Es ist klar, dass das Lesen der 101. Aufzeichnung viel teurer ist als nur die 1. des Tablets. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yg/kx/3o/ygkx3o3reytihnn6mkhyys3j7l8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir atmeten eine Weile aus. </font><font style="vertical-align: inherit;">Sie sagten: â€Nun, Neo, du kennst Kung Fu! </font><font style="vertical-align: inherit;">Jetzt ist unsere Erfahrung direkt auf Ihrem Bildschirm. </font><font style="vertical-align: inherit;">Jetzt kannst du es benutzen. â€œ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Artikel]</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protokollkonsolidierung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unsere 1000 Entwickler atmeten erleichtert auf. Wir haben jedoch verstanden, dass wir nur Hunderte von "Battle" -Servern haben, und all dieses "Copy-Paste" durch die Entwickler ist Ã¼berhaupt nicht bequem. Wir erkannten, dass wir es selbst sammeln mussten. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jl/1t/od/jl1todhk17wci0h_ekudinbrruw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen gibt es ein regulÃ¤res Modul, das Statistiken erfassen kann. Es muss jedoch auch in der Konfiguration aktiviert werden - dies </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist das Modul pg_stat_statements</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Aber er passte nicht zu uns. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstens weist es denselben Abfragen in verschiedenen Schemata innerhalb derselben Datenbank </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unterschiedliche QueryId</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu </font><font style="vertical-align: inherit;">. Das heiÃŸt, wenn Sie zuerst </font><font style="vertical-align: inherit;">dieselbe Anfrage </font><font style="vertical-align: inherit;">stellen </font></font><code>SET search_path = '01'; SELECT * FROM user LIMIT 1;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und dann </font></font><code>SET search_path = '02';</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dieselbe, haben die Statistiken dieses Moduls unterschiedliche EintrÃ¤ge, und ich kann keine allgemeinen Statistiken genau im Kontext dieses Anforderungsprofils erfassen, ohne die Schemata zu berÃ¼cksichtigen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der zweite Punkt, der uns daran gehindert hat, es zu benutzen, ist das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehlen von PlÃ¤nen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Das heiÃŸt, es gibt keinen Plan, es gibt nur die Anfrage selbst. Wir sehen, was sich verlangsamt hat, aber wir verstehen nicht warum. Und hier kehren wir zum Problem eines sich schnell Ã¤ndernden Datensatzes zurÃ¼ck. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und der letzte Punkt ist der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mangel an â€Fakten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">â€œ</font></b><font style="vertical-align: inherit;"> Das heiÃŸt, es ist unmÃ¶glich, eine bestimmte Instanz der AbfrageausfÃ¼hrung zu adressieren - sie ist nicht vorhanden, es gibt nur aggregierte Statistiken. Obwohl es mÃ¶glich ist, damit zu arbeiten, ist es nur sehr schwierig. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7x/sr/ij/7xsrijw56i20-dz5oiw0hurx9aq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus diesem Grund haben wir uns entschlossen, gegen das Kopieren und EinfÃ¼gen zu kÃ¤mpfen, und haben begonnen, einen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sammler</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu schreiben </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Kollektor ist Ã¼ber SSH verbunden, "zieht" eine sichere Verbindung zum Server mit der Datenbank unter Verwendung des Zertifikats und </font></font><code>tail -F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"klammert" sich an die Protokolldatei. Also in dieser Sitzung</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir erhalten einen vollstÃ¤ndigen "Spiegel" der gesamten Protokolldatei</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die der Server generiert. Die Belastung des Servers selbst ist minimal, da wir dort nichts analysieren, sondern lediglich den Datenverkehr spiegeln. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir bereits begonnen haben, die Schnittstelle auf Node.js zu schreiben, haben wir den Kollektor weiter darauf geschrieben. Diese Technologie hat sich ausgezahlt, da es sehr praktisch ist, JavaScript fÃ¼r die Arbeit mit schlecht formatierten Textdaten zu verwenden. Dies ist das Protokoll. Und die Node.js-Infrastruktur selbst als Backend-Plattform ermÃ¶glicht es Ihnen, einfach und bequem mit Netzwerkverbindungen und tatsÃ¤chlich mit DatenstrÃ¶men zu arbeiten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dementsprechend "ziehen" wir zwei Verbindungen: Die erste besteht darin, das Protokoll selbst "abzuhÃ¶ren" und es zu uns zu nehmen, und die zweite besteht darin, die Datenbank regelmÃ¤ÃŸig zu fragen. "Aber im Protokoll ist angekommen, dass die Platte mit OID 123 blockiert wurde", aber es sagt dem Entwickler nichts, und es wÃ¤re schÃ¶n, die Basis zu fragen: "Was ist OID = 123?" Deshalb fragen wir die Basis regelmÃ¤ÃŸig nach etwas, das wir zu Hause noch nicht kennen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/vi/ft/gtviftgv1xepi43a7dayhn5-kxy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Sie haben es einfach nicht berÃ¼cksichtigt, es gibt eine Art elefantenÃ¤hnliche Bienen!" Wir begannen mit der Entwicklung dieses Systems, als wir 10 Server Ã¼berwachen wollten. Das kritischste in unserem VerstÃ¤ndnis, bei dem es einige Probleme gab, die schwer zu lÃ¶sen waren. Aber im ersten Quartal haben wir hundert fÃ¼r die Ãœberwachung bekommen - weil das System â€reingegangenâ€œ ist, jeder es wollte, jeder sich wohl fÃ¼hlte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All dies muss hinzugefÃ¼gt werden, der Datenstrom ist groÃŸ, aktiv. Eigentlich Ã¼berwachen wir, was wir kÃ¶nnen - dann nutzen wir es. Wir verwenden PostgreSQL auch als Data Warehouse. Aber nichts ist schneller, um Daten darin zu "gieÃŸen", als </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es noch keinen </font><font style="vertical-align: inherit;">Operator gibt </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber nur die Daten zu â€gieÃŸenâ€œ, ist nicht wirklich unsere Technologie. Wenn Sie auf 100.000 Servern ungefÃ¤hr 50.000 Anfragen pro Sekunde haben, werden dadurch 100 bis 150 GB Protokolle pro Tag fÃ¼r Sie generiert. Deshalb mussten wir die Basis sorgfÃ¤ltig â€sÃ¤genâ€œ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstens haben wir die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partitionierung jeden Tag durchgefÃ¼hrt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da im GroÃŸen und Ganzen niemand an der Korrelation zwischen den Tagen interessiert ist. Was ist der Unterschied, den Sie gestern hatten, wenn Sie heute Abend eine neue Version der Anwendung herausgebracht haben - und bereits einige neue Statistiken.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweitens haben wir gelernt (waren gezwungen) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sehr, sehr schnell mit zu schreiben</font></font><code>COPY</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Das heiÃŸt, nicht nur, </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weil es schneller ist als </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sondern noch schneller. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rm/ik/nj/rmiknjdu2ydi-yrbk7v369qe8eu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der dritte Punkt - ich musste </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die AuslÃ¶ser bzw. die FremdschlÃ¼ssel aufgeben</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Das heiÃŸt, wir haben keine absolut referenzielle IntegritÃ¤t. Denn wenn Sie eine Tabelle haben, in der sich ein Paar von FK befindet, und Sie in der Datenbankstruktur sagen, dass "hier ein Protokolleintrag sich auf FK bezieht, zum Beispiel eine Gruppe von DatensÃ¤tzen", hat PostgreSQL beim EinfÃ¼gen nichts anderes zu tun, als wie man </font></font><code>SELECT 1 FROM master_fk1_table WHERE ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit der Kennung, die Sie einfÃ¼gen </font><font style="vertical-align: inherit;">mÃ¶chten, nimmt und ehrlich ausfÃ¼hrt </font><font style="vertical-align: inherit;">- nur um zu Ã¼berprÃ¼fen, ob dieser Eintrag vorhanden ist, dass Sie diesen FremdschlÃ¼ssel nicht mit Ihrer EinfÃ¼gung "abbrechen".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir erhalten anstelle eines Datensatzes in der Zieltabelle und ihrer Indizes ein weiteres Plus des Lesens aus allen Tabellen, auf die es verweist. Und wir brauchen es Ã¼berhaupt nicht - unsere Aufgabe ist es, so viel wie mÃ¶glich und so schnell wie mÃ¶glich mit der geringsten Belastung aufzuschreiben. Also FK - runter! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der nÃ¤chste Punkt ist Aggregation und Hashing. UrsprÃ¼nglich wurden sie bei uns in der Datenbank implementiert. SchlieÃŸlich ist es praktisch, sofort, wenn der Datensatz eintrifft, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"plus eins"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in einer Art Platte </font><b><font style="vertical-align: inherit;">direkt im Trigger einzugeben</font></b><font style="vertical-align: inherit;"> . Es ist gut, praktisch, aber das Gleiche ist schlecht - fÃ¼gen Sie einen Datensatz ein, aber Sie mÃ¼ssen etwas anderes aus einer anderen Tabelle lesen und schreiben. DarÃ¼ber hinaus nicht nur das, lesen und schreiben - und das jedes Mal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie sich nun vor, Sie haben ein Schild, auf dem Sie einfach die Anzahl der Anfragen zÃ¤hlen, die an einen bestimmten Host weitergeleitet wurden:</font></font><code>+1, +1, +1, ..., +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Und Sie brauchen es im Prinzip nicht - all dies kann </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Speicher des Kollektors zusammengefasst</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und gleichzeitig an die Datenbank gesendet werden </font></font><code>+10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ja, Ihre logische IntegritÃ¤t kann bei einigen Problemen "auseinanderfallen", aber dies ist fast ein unrealistischer Fall - da Sie einen normalen Server haben, eine Batterie im Controller vorhanden ist, Sie ein Transaktionsprotokoll haben, ein Protokoll im Dateisystem ... Im Allgemeinen nicht es ist es wert. Es ist den ProduktivitÃ¤tsverlust nicht wert, den Sie durch die Arbeit von Triggern / FK erhalten, die Kosten, die Ihnen gleichzeitig entstehen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleiches gilt fÃ¼r Hashing. Eine bestimmte Anfrage fliegt zu Ihnen, Sie berechnen eine bestimmte Kennung aus der Datenbank daraus, schreiben in die Datenbank und teilen sie dann allen mit. Alles ist gut, bis zum Zeitpunkt der Aufnahme eine zweite Person zu Ihnen kommt, die es aufnehmen mÃ¶chte - und Sie haben eine Sperre, und das ist schon schlecht. Wenn Sie daher die Generierung einiger IDs auf dem Client (relativ zur Datenbank) durchfÃ¼hren kÃ¶nnen, ist es besser, dies zu tun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir waren einfach ideal geeignet, um MD5 aus dem Text zu verwenden - eine Anfrage, einen Plan, eine Vorlage, ... Wir berechnen sie auf der Sammlerseite und "gieÃŸen" die bereits vorbereitete ID in die Datenbank. Die MD5-LÃ¤nge und die tÃ¤gliche Partitionierung ermÃ¶glichen es uns, uns keine Gedanken Ã¼ber mÃ¶gliche Kollisionen zu machen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/yz/uz/3cyzuzpcxxmshllydd9cjcclc9i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dies alles schnell aufzuzeichnen, mussten wir das Aufnahmeverfahren selbst Ã¤ndern.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie schreibt man normalerweise Daten? Wir haben eine Art Datensatz, zerlegen ihn in mehrere Tabellen und kopieren ihn dann - zuerst in der ersten, dann in der zweiten, in der dritten ... Es ist unpraktisch, weil wir einen Datenstrom in drei Schritten nacheinander schreiben. Unangenehm. Ist es mÃ¶glich, schneller zu machen? Kann! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu reicht es aus, diese StrÃ¶me nur parallel zu zerlegen. Es stellt sich heraus, dass wir Fehler, Anforderungen, Vorlagen, Sperren haben, in separaten Streams fliegen ... - und wir schreiben alles parallel. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sie dazu einfach </font><b><font style="vertical-align: inherit;">den COPY-Kanal fÃ¼r jede einzelne Zieltabelle permanent offen</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/v_/0z/vvv_0zw3lqqoqoznvaaqpvm19wq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das heiÃŸt, der Sammler hat </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">immer einen Stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in die ich die Daten schreiben kann, die ich brauche. Damit die Datenbank diese Daten sieht und jemand nicht in den SchlÃ¶ssern hÃ¤ngt und darauf wartet, dass diese Daten geschrieben werden, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muss COPY mit einer bestimmten HÃ¤ufigkeit unterbrochen werden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . FÃ¼r uns erwies sich ein Zeitraum in der GrÃ¶ÃŸenordnung von 100 ms als am effektivsten - schlieÃŸen Sie ihn und Ã¶ffnen Sie ihn sofort wieder auf demselben Tisch. Und wenn wir an einigen Spitzen keinen Stream haben, bÃ¼ndeln wir bis zu einem bestimmten Limit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DarÃ¼ber hinaus haben wir herausgefunden, dass fÃ¼r ein solches Lastprofil jede Aggregation, wenn DatensÃ¤tze in Paketen gesammelt werden, bÃ¶se ist. Das klassische BÃ¶se ist </font></font><code>INSERT ... VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jenseits von 1000 Aufzeichnungen. Denn in diesem Moment haben Sie eine Spitzenaufnahme auf den Medien, und alle anderen, die versuchen, etwas auf die Festplatte zu schreiben, warten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um solche Anomalien zu beseitigen, aggregieren Sie einfach nichts, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puffern Sie Ã¼berhaupt nicht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Und wenn eine Pufferung auf die Festplatte auftritt (zum GlÃ¼ck kÃ¶nnen Sie dies mithilfe der Stream-API in Node.js herausfinden) - verschieben Sie diese Verbindung. </font><font style="vertical-align: inherit;">Dann kommt das Ereignis zu Ihnen, dass es wieder kostenlos ist - schreiben Sie aus der angesammelten Warteschlange darauf. </font><font style="vertical-align: inherit;">In der Zwischenzeit ist viel los - nehmen Sie den nÃ¤chsten kostenlosen aus dem Pool und schreiben Sie ihm. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor der Implementierung dieses Ansatzes fÃ¼r die Datenaufzeichnung hatten wir ungefÃ¤hr 4K-Schreiboperationen und auf diese Weise haben wir die Last um das 4-fache reduziert. </font><font style="vertical-align: inherit;">Jetzt sind sie aufgrund neuer beobachtbarer Basen weitere 6-mal gewachsen - bis zu 100 MB / s. </font><font style="vertical-align: inherit;">Und jetzt speichern wir Protokolle der letzten 3 Monate in einer Menge von etwa 10-15 TB, in der Hoffnung, dass jeder Entwickler in nur drei Monaten jedes Problem lÃ¶sen kann.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir verstehen die Probleme</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber all diese Daten zu sammeln ist gut, nÃ¼tzlich, angemessen, aber nicht genug - Sie mÃ¼ssen es verstehen. </font><font style="vertical-align: inherit;">Weil es tÃ¤glich Millionen verschiedener PlÃ¤ne gibt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j6/kw/jg/j6kwjgsvci1xw-p_vgxpnq6ynag.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber Millionen sind unkontrollierbar, Sie mÃ¼ssen zuerst "weniger" tun. </font><font style="vertical-align: inherit;">Und zuallererst muss entschieden werden, wie Sie diese â€kleinereâ€œ organisieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben drei wichtige Punkte fÃ¼r uns identifiziert:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hat diese Anfrage gesendet? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das heiÃŸt, von welcher Anwendung er "geflogen" ist: Webinterface, Backend, Zahlungssystem oder etwas anderes.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wo ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> das passiert? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf welchem â€‹â€‹Server? </font><font style="vertical-align: inherit;">Denn wenn Sie mehrere Server unter einer Anwendung haben und plÃ¶tzlich einer "langweilig" wird (weil die "Festplatte verrottet" ist, "der Speicher durchgesickert ist", einige andere Probleme), mÃ¼ssen Sie den Server speziell ansprechen.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wie sich das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem auf die eine oder andere Weise manifestierte</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, wer uns die Anfrage gesendet hat, verwenden wir ein regulÃ¤res Tool, das eine Sitzungsvariable festlegt: </font></font><code>SET application_name = '{bl-host}:{bl-method}';</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Senden Sie den Hostnamen der GeschÃ¤ftslogik, von der die Anfrage gesendet wird, und den Namen der Methode oder Anwendung, die sie initiiert hat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir den "EigentÃ¼mer" der Anfrage Ã¼bergeben haben, muss diese im Protokoll angezeigt werden - dafÃ¼r konfigurieren wir die Variable </font></font><code>log_line_prefix = ' %m [%p:%v] [%d] %r %a'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Jeder Interessierte kann </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Handbuch sehen,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> was dies alles bedeutet. </font><font style="vertical-align: inherit;">Es stellt sich heraus, dass wir im Protokoll sehen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zeit</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prozess- und Transaktionskennungen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basisname</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP der Person, die diese Anfrage gesendet hat</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und Methodenname</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/9d/ms/_c/9dms_cgsmfbpgjiyndalqfyadf8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann haben wir festgestellt, dass es nicht sehr interessant ist, die Korrelation einer Anfrage zwischen verschiedenen Servern zu untersuchen. Es kommt selten vor, wenn Sie eine Anwendung haben, die hier und da gleichermaÃŸen scheiÃŸt. Aber auch wenn es dasselbe ist, schauen Sie sich einen dieser Server an. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abschnitt â€Ein Server - ein Tagâ€œ hat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sich fÃ¼r jede Analyse als ausreichend erwiesen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste analytische Abschnitt ist die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€Vorlageâ€œ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - eine abgekÃ¼rzte Form der Darstellung des Plans, die von allen numerischen Indikatoren befreit ist. Der zweite Abschnitt ist die Anwendung oder Methode, und der dritte ist der spezifische Knoten des Plans, der uns Probleme verursacht hat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Wechsel von bestimmten Instanzen zu Vorlagen haben wir sofort zwei Vorteile erhalten:</font></font><br>
<br>
<ul>
<li><b>     </b><br>
         ,    .</li>
<li><b></b><br>
 ,  Â«Â»   - ,       .     ,     -  , ,   ,    â€”   ,  ,     â€”     , ,      .    ,  ,  .</li>
</ul><br>
<br>
<img src="https://habrastorage.org/webt/_1/gb/is/_1gbissbzxhnibnhpb5kb5ebuuu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Ã¼brigen Methoden basieren auf den Indikatoren, die wir aus dem Plan extrahieren: Wie oft ist eine solche Vorlage aufgetreten, wie lange und durchschnittlich insgesamt, wie viel Daten von der Festplatte gelesen wurden und wie viel aus dem Speicher ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weil Sie beispielsweise vom Host auf die Analyseseite gelangen, siehe - etwas zu viel auf der Festplatte, um den Anfang zu lesen. Die Festplatte auf dem Server kommt nicht zurecht - und wer liest daraus? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und Sie kÃ¶nnen nach jeder Spalte sortieren und entscheiden, was Sie gerade tun - mit der Belastung des Prozessors oder der Festplatte oder mit der Gesamtzahl der Anforderungen ... Sortiert, â€topâ€œ, repariert - haben eine neue Version der Anwendung eingefÃ¼hrt. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[Videovorlesung]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Und sofort kÃ¶nnen Sie verschiedene Anwendungen sehen, die mit der gleichen Vorlage aus einer Anfrage wie kommen</font></font><code>SELECT * FROM users WHERE login = 'Vasya'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Frontend, Backend, Verarbeitung ... Und Sie fragen sich, warum der Benutzer die Verarbeitung lesen sollte, wenn er nicht mit ihm interagiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der umgekehrte Weg besteht darin, sofort anhand der Anwendung zu sehen, was sie tut. Ein Frontend ist beispielsweise dies, dies, dies und das einmal pro Stunde (nur die Zeitleiste hilft). Und sofort stellt sich die Frage: Es scheint nicht die Aufgabe des Frontends zu sein, einmal pro Stunde etwas zu tun ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z7/z-/4n/z7z-4nvcqjd8xktjpl1ilja63eo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach einiger Zeit stellten wir fest, dass uns aggregierte </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statistiken in Bezug auf Plan-Knoten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fehlten </font><font style="vertical-align: inherit;">. Wir haben aus den PlÃ¤nen nur diejenigen Knoten isoliert, die etwas mit den Daten der Tabellen selbst tun (sie nach Index lesen / schreiben oder nicht). Im Vergleich zum vorherigen Bild wird nur ein Aspekt hinzugefÃ¼gt - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wie viele DatensÃ¤tze dieser Knoten zu uns gebracht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hat und wie viele er gelÃ¶scht hat (Zeilen durch Filter entfernt).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie haben keinen geeigneten Index auf der Platte, Sie stellen eine Anfrage, sie fliegt am Index vorbei, fÃ¤llt in Seq Scan ... Sie haben alle DatensÃ¤tze auÃŸer einem herausgefiltert. Und warum benÃ¶tigen Sie 100 Millionen gefilterte DatensÃ¤tze pro Tag? Ist es besser, den Index zu rollen? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tk/bw/j9/tkbwj9b2v1gmeifbmblipiya86q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir alle PlÃ¤ne nach Knoten untersucht hatten, stellten wir fest, dass die PlÃ¤ne einige typische Strukturen enthalten, die sehr wahrscheinlich verdÃ¤chtig aussehen. Und es wÃ¤re schÃ¶n, dem Entwickler zu sagen: â€Freund, hier liest du zuerst nach Index, sortierst ihn dann und schneidest ihn dann abâ€œ - in der Regel gibt es einen Datensatz. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder, der Abfragen mit diesem Muster schrieb, stieÃŸ wahrscheinlich auf Folgendes: â€Gib mir die letzte Bestellung fÃ¼r Vasya, sein Datumâ€œ. Und wenn Sie keinen Index nach Datum haben oder der verwendete Index kein Datum hat, dann gehen Sie genau auf einen solchen â€Rechenâ€œ und treten Sie ein .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber wir wissen, dass dies ein "Rechen" ist - warum also nicht sofort dem Entwickler sagen, was er tun soll? </font><font style="vertical-align: inherit;">Dementsprechend sieht unser Entwickler beim Ã–ffnen des Plans sofort ein schÃ¶nes Bild mit Eingabeaufforderungen, auf dem ihm sofort gesagt wird: â€Sie haben hier und hier Probleme, aber sie werden auf diese und jene Weise gelÃ¶st.â€œ </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen ist die Menge an Erfahrung, die zu Beginn und jetzt zur LÃ¶sung von Problemen benÃ¶tigt wurde, erheblich gesunken. </font><font style="vertical-align: inherit;">Hier haben wir ein solches Werkzeug.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/1g/g6/si1gg6ffbtpgsb3q2ew_cgudqa4.jpeg"></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de487380/">https://habr.com/ru/post/de487380/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de487370/index.html">Immobilienmarktanalyse basierend auf Daten von msgr.ru.</a></li>
<li><a href="../de487372/index.html">IBM Data Science Professional-Zertifikat zertifiziert</a></li>
<li><a href="../de487374/index.html">Paul Graham: Modische Probleme</a></li>
<li><a href="../de487376/index.html">10 nÃ¼tzliche Angular-Funktionen, die Sie verpasst haben</a></li>
<li><a href="../de487378/index.html">Beste Small Business Server im Jahr 2020</a></li>
<li><a href="../de487384/index.html">Beruf: Frontend-Entwickler</a></li>
<li><a href="../de487386/index.html">Anpassungscheckliste als Soft-Entry-Tool</a></li>
<li><a href="../de487388/index.html">NatÃ¼rliche Entwicklung: Wie man vom E-Learning zum Wissensmanagement Ã¼bergeht</a></li>
<li><a href="../de487390/index.html">Webkomponenten ohne Shadow DOM</a></li>
<li><a href="../de487392/index.html">Was mÃ¶chte Magnet Ã¼ber seine Kunden wissen?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>