<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òùüèø üìü üòû Mais sobre Coroutines em C ++ üé¶ üë®‚Äçüëß‚Äçüëß üçë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° colegas. 
 
 Como parte do desenvolvimento do tema C ++ 20, encontramos um artigo bastante antigo (setembro de 2018) do hublog do Yandex, chamado ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mais sobre Coroutines em C ++</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/491996/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° colegas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como parte do desenvolvimento do tema C ++ 20, encontramos um artigo bastante antigo (setembro de 2018) do hublog do Yandex, chamado " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparando-se para C ++ 20. Coroutines TS com um exemplo real</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Termina com a seguinte vota√ß√£o muito expressiva: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a-/m4/xn/a-m4xn5j3yjfy-yl2et7aeek7sc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚ÄúPor que n√£o?‚Äù, Decidimos e traduzimos um artigo de David Pilarski sob o t√≠tulo ‚ÄúIntrodu√ß√£o √†s corotinas‚Äù. O artigo foi publicado h√° pouco mais de um ano, mas, com sorte, voc√™ o achar√° muito interessante.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o aconteceu. Ap√≥s muita d√∫vida, controv√©rsia e prepara√ß√£o desse recurso, o WG21 chegou a uma opini√£o comum sobre como as corotinas deveriam parecer no C ++ - e √© muito prov√°vel que elas sejam inclu√≠das no C ++ 20. Como esse √© um recurso importante, acho que √© hora de prepar√°-lo e estud√°-lo. agora (como voc√™ se lembra, ainda existem mais m√≥dulos, conceitos, intervalos para aprender ...) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muitos ainda se op√µem √† corotina. Freq√ºentemente eles reclamam da complexidade de seu desenvolvimento, de muitos pontos de customiza√ß√£o e, possivelmente, de desempenho abaixo do ideal devido √† aloca√ß√£o sub-otimizada de mem√≥ria din√¢mica (talvez;)).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paralelamente ao desenvolvimento de especifica√ß√µes t√©cnicas (TS) aprovadas (publicadas oficialmente), at√© tentativas foram feitas para paralelizar o desenvolvimento de outro mecanismo de corutina. </font><font style="vertical-align: inherit;">Aqui, falaremos sobre as rotinas descritas em TS ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">especifica√ß√£o t√©cnica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Uma abordagem alternativa, por sua vez, pertence ao Google. </font><font style="vertical-align: inherit;">Como resultado, a abordagem do Google sofre de numerosos problemas, cuja solu√ß√£o geralmente requer recursos adicionais estranhos do C ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final, foi decidido adotar uma vers√£o do Corutin desenvolvida pela Microsoft (patrocinada pela TS). </font><font style="vertical-align: inherit;">√â sobre essas rotinas que ser√£o discutidas neste artigo. </font><font style="vertical-align: inherit;">Ent√£o, vamos come√ßar com a quest√£o de ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que s√£o corotinas?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As corotinas j√° existem em muitas linguagens de programa√ß√£o, por exemplo, em Python ou C #. </font><font style="vertical-align: inherit;">As corotinas s√£o outra maneira de criar c√≥digo ass√≠ncrono. </font><font style="vertical-align: inherit;">Como eles diferem dos fluxos, por que as corotinas devem ser implementadas como um recurso de linguagem dedicado e, finalmente, qual √© o seu uso ser√° explicado nesta se√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe um s√©rio mal-entendido sobre o que s√£o corotinas. </font><font style="vertical-align: inherit;">Dependendo do ambiente em que s√£o usados, eles podem ser chamados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corotinas sem pilha</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corotinas de pilha</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fluxos verdes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fibras</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gorutins</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A boa not√≠cia: empilhar corutinas, correntes verdes, fibras e gorutinas s√£o a mesma coisa (mas √†s vezes s√£o usadas de maneiras diferentes). Falaremos sobre eles mais adiante neste artigo e os chamaremos de fibras ou empilharemos corotinas. Mas a corotina sem pilha possui alguns recursos que precisam ser discutidos separadamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender as corotinas, inclusive em um n√≠vel intuitivo, vamos conhecer brevemente as fun√ß√µes e (vamos colocar dessa maneira) "sua API". A maneira padr√£o de trabalhar com eles √© ligar e aguardar at√© que termine:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span>{
     <span class="hljs-keyword">return</span>; <span class="hljs-comment">//     </span><font></font>
}	<font></font>
foo(); <span class="hljs-comment">//   / </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de chamar a fun√ß√£o, j√° √© imposs√≠vel pausar ou retomar seu trabalho. Voc√™ pode executar apenas duas opera√ß√µes nas fun√ß√µes: </font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>finish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Quando a fun√ß√£o √© iniciada, voc√™ deve esperar at√© que seja conclu√≠da. Se a fun√ß√£o for chamada novamente, sua execu√ß√£o ser√° iniciada desde o in√≠cio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com as corotinas, a situa√ß√£o √© diferente. Voc√™ n√£o pode apenas inici√°-los e par√°-los, mas tamb√©m pausar e retomar. Eles ainda s√£o diferentes dos fluxos principais, porque as pr√≥prias corotinas n√£o est√£o se aglomerando (por outro lado, as corotinas geralmente se referem ao fluxo e o fluxo est√° se aglomerando). Para entender isso, considere um gerador definido em Python. Que tal coisa seja chamada de gerador em Python, em C ++ seria chamada de corotina. Um exemplo √© retirado deste </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_nums</span>():</span>
     num = <span class="hljs-number">0</span>
     <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
          <span class="hljs-keyword">yield</span> num<font></font>
          num = num + <span class="hljs-number">1</span>	<font></font>
<font></font>
nums = generate_nums()<font></font>
	<font></font>
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> nums:<font></font>
     print(x)<font></font>
	<font></font>
     <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">9</span>:
          <span class="hljs-keyword">break</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eis como este c√≥digo funciona: uma chamada de fun√ß√£o </font></font><code>generate_nums</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leva √† cria√ß√£o de um objeto de corotina. </font><font style="vertical-align: inherit;">Em cada etapa da enumera√ß√£o de um objeto de rotina, a pr√≥pria rotina retoma o trabalho e o pausa somente ap√≥s uma palavra-chave </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no c√≥digo; </font><font style="vertical-align: inherit;">ent√£o, o pr√≥ximo n√∫mero inteiro da sequ√™ncia √© retornado (o loop for √© um a√ß√∫car sint√°tico para chamar uma fun√ß√£o </font></font><code>next()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que retoma a corotina). </font><font style="vertical-align: inherit;">O c√≥digo termina o loop encontrando uma declara√ß√£o de interrup√ß√£o. </font><font style="vertical-align: inherit;">Nesse caso, o corutin nunca termina, mas √© f√°cil imaginar uma situa√ß√£o em que o corutin chegue ao fim e ao fim. </font><font style="vertical-align: inherit;">Como podemos ver, a um korutine opera√ß√µes aplic√°veis </font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>suspend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>resume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e, finalmente,</font></font><code>finish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">[Nota: C ++ tamb√©m fornece opera√ß√µes de cria√ß√£o e destrui√ß√£o, mas elas n√£o s√£o importantes no contexto de um entendimento intuitivo da corotina].</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corotinas como uma biblioteca</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, agora est√° aproximadamente claro o que s√£o corotinas. </font><font style="vertical-align: inherit;">Voc√™ pode saber que existem bibliotecas para criar objetos de fibra. </font><font style="vertical-align: inherit;">A quest√£o √©: por que precisamos de corotinas na forma de um recurso de linguagem dedicado, e n√£o apenas uma biblioteca que funcione com corotinas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, estamos tentando responder a essa pergunta e demonstrar a diferen√ßa entre corotinas empilhadas e sem pilha. </font><font style="vertical-align: inherit;">Essa diferen√ßa √© fundamental para entender o corutin como parte do idioma.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corotinas de pilha</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, vamos discutir primeiro o que s√£o as corotinas de pilha, como elas funcionam e por que elas podem ser implementadas como uma biblioteca. </font><font style="vertical-align: inherit;">Explic√°-los √© relativamente simples, porque eles se assemelham a fluxos em termos de design. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fibra ou pilha corutin possui uma pilha separada que pode ser usada para lidar com chamadas de fun√ß√£o. </font><font style="vertical-align: inherit;">Para entender exatamente como as corotinas desse tipo funcionam, examinamos brevemente os quadros de fun√ß√µes e as chamadas de fun√ß√µes de um ponto de vista de baixo n√≠vel. </font><font style="vertical-align: inherit;">Mas primeiro, vamos falar sobre as propriedades das fibras.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eles t√™m sua pr√≥pria pilha,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O tempo de vida das fibras n√£o depende do c√≥digo que as chama (geralmente elas possuem um agendador definido pelo usu√°rio),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As fibras podem ser destacadas de uma linha e conectadas a outra,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planejamento cooperativo (a fibra deve decidir mudar para outra fibra / agendador),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o √© poss√≠vel trabalhar simultaneamente no mesmo segmento.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os seguintes efeitos resultam das propriedades acima:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a altern√¢ncia do contexto das fibras deve ser realizada pelo usu√°rio das fibras, e n√£o o SO (al√©m disso, o SO pode liberar a fibra, liberando o fio no qual trabalha),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o h√° dados reais entre as duas fibras, pois a qualquer momento, apenas uma delas pode estar ativa,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O projetista de fibra deve poder escolher o local e a hora certos, onde e quando √© apropriado devolver a energia da computa√ß√£o a um poss√≠vel agendador ou chamador.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As opera√ß√µes de entrada / sa√≠da na fibra devem ser ass√≠ncronas, para que outras fibras possam executar suas tarefas sem bloquear uma √† outra.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos dar uma olhada mais de perto na opera√ß√£o das fibras e primeiro explicar como a pilha participa de chamadas de fun√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a pilha √© um bloco cont√≠nuo de mem√≥ria necess√°rio para armazenar vari√°veis ‚Äã‚Äãlocais e argumentos de fun√ß√£o. Mas, mais importante, ap√≥s cada chamada de fun√ß√£o (com algumas exce√ß√µes), informa√ß√µes adicionais s√£o enviadas para a pilha que informa √† fun√ß√£o chamada como retornar ao chamador e restaurar os registros do processador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguns desses registradores t√™m atribui√ß√µes especiais e, ao chamar fun√ß√µes, eles s√£o armazenados na pilha. Estes s√£o os registradores (no caso da arquitetura ARM): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SP - ponteiro de pilha </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LR - registro de comunica√ß√£o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PC - contador de programa </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ponteiro de pilha</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(SP) √© um registro que cont√©m o endere√ßo do in√≠cio da pilha relacionado √† chamada de fun√ß√£o atual. Gra√ßas ao valor existente, voc√™ pode consultar facilmente argumentos e vari√°veis ‚Äã‚Äãlocais armazenadas na pilha. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O registro de comunica√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (LR) √© muito importante ao chamar fun√ß√µes. Ele armazena o endere√ßo de retorno (o endere√ßo da parte que chama), onde o c√≥digo ser√° executado ap√≥s a conclus√£o da fun√ß√£o atual. Quando a fun√ß√£o √© chamada, o PC √© salvo no LR. Quando a fun√ß√£o retorna, o PC √© restaurado usando LR. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Program Counter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (PC) √© o endere√ßo da instru√ß√£o em execu√ß√£o no momento. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sempre que uma fun√ß√£o √© chamada, a lista de links √© salva, para que a fun√ß√£o saiba para onde o programa deve retornar ap√≥s a conclus√£o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/r2/yk/njr2ykw0o6hrsww5-uq3ybjjddg.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O comportamento do PC e do LR √© registrado ao chamar e retornar uma fun√ß√£o</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ao executar uma rotina de pilha, as fun√ß√µes chamadas usam a pilha alocada anteriormente para armazenar seus argumentos e vari√°veis ‚Äã‚Äãlocais. </font><font style="vertical-align: inherit;">Como todas as informa√ß√µes sobre cada fun√ß√£o chamada na pilha corutin s√£o armazenadas na pilha, a fibra pode suspender qualquer fun√ß√£o dentro dessa corutina. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/r2/yk/njr2ykw0o6hrsww5-uq3ybjjddg.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o que acontece nesta imagem. </font><font style="vertical-align: inherit;">Em primeiro lugar, cada fibra e segmento tem sua pr√≥pria pilha separada. </font><font style="vertical-align: inherit;">A cor verde indica os n√∫meros de s√©rie, indicando a sequ√™ncia de a√ß√µes.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma chamada de fun√ß√£o regular dentro de um encadeamento. </font><font style="vertical-align: inherit;">A mem√≥ria est√° alocada na pilha.</font></font></li>
<li><b>   </b>.      .     ,      .    .       ,              . </li>
<li>  .</li>
<li><b> </b>.       .</li>
<li>    .</li>
<li>    .</li>
<li><b> </b>.    ,    , ,      .</li>
<li>    .</li>
<li>    .</li>
<li><b> </b> ‚Äì     ,     . </li>
<li>        ,      .</li>
<li>    .      . </li>
<li>       .    :   ,    . ,          (  ) .</li>
<li>  ,   .</li>
<li>  .</li>
<li><b> </b>.   .     .    ,      .</li>
<li>     .</li>
<li>      , ,     .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao trabalhar com corotinas de pilha, n√£o h√° necessidade de um recurso de idioma dedicado que garanta seu uso. </font><font style="vertical-align: inherit;">O core inteiro da pilha pode ser implementado usando bibliotecas, e j√° existem bibliotecas projetadas especificamente para esta finalidade: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">swtch.com/libtask </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code.google.com/archive/p/libconcurrency </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.boost.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Boost.Fiber </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.boost.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the Boost .Corotina </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De todas essas bibliotecas, apenas o Boost √© C ++ e o restante √© C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para obter uma descri√ß√£o detalhada de como essas bibliotecas funcionam, </font><font style="vertical-align: inherit;">consulte a </font><font style="vertical-align: inherit;">documenta√ß√£o. </font><font style="vertical-align: inherit;">Mas, em geral, todas essas bibliotecas permitem que voc√™ crie uma pilha separada para fibra e forne√ßa a oportunidade de retomar a corotina (por iniciativa do chamador) e paus√°-la (por dentro).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere um exemplo </font></font><code>Boost.Fiber</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstdlib&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
	<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;boost/intrusive_ptr.hpp&gt;</span></span><font></font>
	<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;boost/fiber/all.hpp&gt;</span></span><font></font>
	<font></font>
<span class="hljs-function"><span class="hljs-keyword">inline</span>
<span class="hljs-keyword">void</span> <span class="hljs-title">fn</span><span class="hljs-params">( <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-keyword">const</span>&amp; str, <span class="hljs-keyword">int</span> n)</span> </span>{
     <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; ++i) {
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">": "</span> &lt;&lt; str &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
               boost::this_fiber::yield();<font></font>
     }<font></font>
}<font></font>
	<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
     <span class="hljs-keyword">try</span> {<font></font>
          boost::<span class="hljs-function">fibers::fiber <span class="hljs-title">f1</span><span class="hljs-params">( fn, <span class="hljs-string">"abc"</span>, <span class="hljs-number">5</span>)</span></span>;
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cerr</span> &lt;&lt; <span class="hljs-string">"f1 : "</span> &lt;&lt; f1.get_id() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
          f1.join();<font></font>
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"done."</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
	<font></font>
          <span class="hljs-keyword">return</span> EXIT_SUCCESS;<font></font>
     } <span class="hljs-keyword">catch</span> ( <span class="hljs-built_in">std</span>::exception <span class="hljs-keyword">const</span>&amp; e) {
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cerr</span> &lt;&lt; <span class="hljs-string">"exception: "</span> &lt;&lt; e.what() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
     } <span class="hljs-keyword">catch</span> (...) {
          <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cerr</span> &lt;&lt; <span class="hljs-string">"unhandled exception"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
     }<font></font>
     <span class="hljs-keyword">return</span> EXIT_FAILURE;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boost.Fiber</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a biblioteca possui um agendador interno para corotina. </font><font style="vertical-align: inherit;">Todas as fibras correm no mesmo fio. </font><font style="vertical-align: inherit;">Como o planejamento da corutina √© cooperativo, a fibra deve primeiro decidir quando devolver o controle ao planejador. </font><font style="vertical-align: inherit;">Neste exemplo, isso acontece quando a fun√ß√£o yield √© chamada, o que pausa a corotina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como n√£o h√° outra fibra, o planejador de fibra sempre decide retomar a corotina.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corotinas sem pilha</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As corotinas sem pilha diferem ligeiramente nas propriedades das de pilha. </font><font style="vertical-align: inherit;">No entanto, eles t√™m as mesmas caracter√≠sticas b√°sicas, pois as corotinas n√£o empilhadas tamb√©m podem ser iniciadas e ap√≥s a suspens√£o da retomada. </font><font style="vertical-align: inherit;">Corre√ß√µes deste tipo provavelmente encontraremos em C ++ 20. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se falamos sobre as propriedades semelhantes de corutin - coroutines podem:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corutin est√° intimamente ligada ao seu interlocutor: quando √© chamada uma corotina, a execu√ß√£o √© transferida para ela e o resultado da corotina √© transferido de volta ao interlocutor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A vida √∫til de uma pilha corutin √© igual √† vida √∫til de sua pilha. </font><font style="vertical-align: inherit;">A vida √∫til de uma rotina sem pilha √© igual √† vida do seu objeto.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, no caso de corotinas sem pilha, n√£o h√° necessidade de alocar uma pilha inteira. Eles consomem muito menos mem√≥ria do que os da pilha, mas isso √© precisamente devido a algumas de suas limita√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar, se eles n√£o alocam mem√≥ria para a pilha, como eles funcionam? Onde, no caso deles, est√£o todos os dados que devem ser armazenados na pilha ao trabalhar com corotinas da pilha. Resposta: na pilha do chamador.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segredo das corotinas sem pilha √© que elas s√≥ podem se suspender da fun√ß√£o superior. Para todas as outras fun√ß√µes, seus dados est√£o localizados na pilha do lado chamado, portanto, todas as fun√ß√µes chamadas de corutin devem ser conclu√≠das antes que o trabalho da corutin seja suspenso. Todos os dados necess√°rios pela corotina para manter seu estado s√£o alocados dinamicamente no heap. Isso geralmente requer algumas vari√°veis ‚Äã‚Äãe argumentos locais, que s√£o muito mais compactos do que uma pilha inteira que precisaria ser alocada com anteced√™ncia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veja como funcionam as corutinas sem pilha: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/vc/nw/owvcnwldgczpxdmjorsjlrh3yvm.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desafiando uma corutina sem pilha</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, agora existe apenas uma pilha - esta √© a pilha principal do encadeamento. </font><font style="vertical-align: inherit;">Vamos dar uma olhada passo a passo no que √© mostrado nesta imagem (o quadro de ativa√ß√£o da corotina aqui √© de duas cores - preto mostra o que est√° armazenado na pilha e azul - o que est√° armazenado no heap).</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma chamada de fun√ß√£o regular cujo quadro est√° armazenado na pilha</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A fun√ß√£o cria uma corotina</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ou seja, ele aloca um quadro de ativa√ß√£o para ele em algum lugar na pilha.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamada de fun√ß√£o normal.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligue para Corutin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">O corpo de Corutin se destaca em uma pilha regular. </font><font style="vertical-align: inherit;">O programa √© executado da mesma maneira que no caso de uma fun√ß√£o regular.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma chamada de fun√ß√£o regular da corotina. </font><font style="vertical-align: inherit;">Novamente, tudo ainda acontece na pilha [Nota: voc√™ n√£o pode pausar a corotina a partir deste ponto, pois essa n√£o √© a fun√ß√£o mais alta na corotina]</font></font></li>
<li>       [:     .]</li>
<li>  ‚Äì  ,        ,     .</li>
<li>  </li>
<li><b>  </b> ‚Äì      ,        +     .</li>
<li>     5.</li>
<li>     6.</li>
<li><b> </b>.        .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, √© √≥bvio que, no segundo caso, √© necess√°rio lembrar muito menos dados de todas as opera√ß√µes de suspens√£o e retomada do trabalho da corutina; no entanto, a corotina pode retomar e suspender apenas a si mesma e apenas a partir da fun√ß√£o superior. Todas as chamadas de fun√ß√µes e corotina ocorrem da mesma maneira, no entanto, alguns dados adicionais devem ser salvos entre as chamadas, e a fun√ß√£o deve poder pular para o ponto de suspens√£o e restaurar o estado das vari√°veis ‚Äã‚Äãlocais. N√£o h√° outras diferen√ßas entre o quadro da corotina e o quadro da fun√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Corutin tamb√©m pode causar outras corotinas (n√£o mostradas neste exemplo). </font><font style="vertical-align: inherit;">No caso de corotinas sem pilha, cada chamada resulta na aloca√ß√£o de um novo espa√ßo para novos dados de corutina (com uma chamada repetida de corotina, a mem√≥ria din√¢mica tamb√©m pode ser alocada v√°rias vezes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A raz√£o pela qual as corotinas precisam fornecer um recurso de linguagem dedicado √© porque o compilador precisa decidir quais vari√°veis ‚Äã‚Äãdescrevem o estado da corotina e criar c√≥digo estereotipado para ir para os pontos de suspens√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uso pr√°tico de corutin</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As corotinas em C ++ podem ser usadas da mesma maneira que em outros idiomas. </font><font style="vertical-align: inherit;">As corotinas simplificar√£o a ortografia:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geradores</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo de entrada / sa√≠da ass√≠ncrono </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">computa√ß√£o pregui√ßosa</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aplicativos orientados a eventos</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum√°rio</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que, lendo este artigo, voc√™ descubra:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por que em C ++ voc√™ precisa implementar corotinas como um recurso de linguagem dedicado</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qual √© a diferen√ßa entre corotinas empilhadas e sem pilha?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por que as corotinas s√£o necess√°rias</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt491986/index.html">RemoteLoRa - mais do que ON / OFF</a></li>
<li><a href="../pt491988/index.html">O que h√° de novo no Red Hat OpenShift 4.2 e 4.3?</a></li>
<li><a href="../pt491990/index.html">Trabalhar com o chip chin√™s ADC Hx711 (conclus√£o)</a></li>
<li><a href="../pt491992/index.html">Analista de Desenvolvimento</a></li>
<li><a href="../pt491994/index.html">Migrando do Cocoapods para o Swift Package Manager</a></li>
<li><a href="../pt492000/index.html">Produto muito primeiro. Esgotamento</a></li>
<li><a href="../pt492002/index.html">Asas que absorvem luz: o segredo das borboletas super pretas</a></li>
<li><a href="../pt492004/index.html">Como passar de um programador para um gerente ("Eu quero ser a amante do mar")</a></li>
<li><a href="../pt492006/index.html">O poder do PWA: um sistema de vigil√¢ncia por v√≠deo com um c√≥digo JS de rede neural de 300 linhas</a></li>
<li><a href="../pt492008/index.html">Resultados da pesquisa de motiva√ß√£o em TI: os desenvolvedores est√£o satisfeitos com seu trabalho?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>