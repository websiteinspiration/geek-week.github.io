<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåó ‚òπÔ∏è üë®‚Äçüëß How Yandex.Cloud is hosted by Virtual Private Cloud and how our users help us implement useful features üå∞ üêπ üà∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, my name is Kostya Kramlikh, I am a leading developer of the Virtual Private Cloud division in Yandex.Cloud. I am engaged in a virtual network, and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How Yandex.Cloud is hosted by Virtual Private Cloud and how our users help us implement useful features</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/487694/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hi, my name is Kostya Kramlikh, I am a leading developer of the Virtual Private Cloud division in Yandex.Cloud. </font><font style="vertical-align: inherit;">I am engaged in a virtual network, and, as you might guess, in this article I will talk about the Virtual Private Cloud (VPC) device in general and the virtual network in particular. </font><font style="vertical-align: inherit;">You will also learn why we, the developers of the service, appreciate the feedback from our users. </font><font style="vertical-align: inherit;">But first things first.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/gg/e2/yvgge2dsin-gzjfeildiucyjei0.jpeg"><br>
<br>
<a name="habracut"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a VPC?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nowadays, for the deployment of services there are a variety of opportunities. </font><font style="vertical-align: inherit;">I am sure that someone still keeps the server under the administrator‚Äôs table, although, I hope, there are less and less such stories. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now services are trying to go into public clouds, and right here they are faced with VPC. </font><font style="vertical-align: inherit;">VPC is a part of the public cloud that connects user, infrastructure, platform and other capacities together, wherever they are, in our Cloud or beyond. </font><font style="vertical-align: inherit;">At the same time, VPC allows not to unnecessarily put these capacities on the Internet, they remain within your isolated network.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How a virtual network looks from the outside</font></font></h2><br>
<img src="https://habrastorage.org/webt/ph/zb/lz/phzblzhdrzcaruusochkrksyoeg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By VPC, we understand primarily the overlay network and network services, such as VPNaaS, NATaas, LBaas, etc. And all this works on top of the fail-safe network infrastructure, about which there was already an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excellent article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> here on Habr√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at the virtual network and its device more closely. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dt/4p/z3/dt4pz3lfz8opbgktnuesxthdld8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider two accessibility zones. We provide a virtual network - what we called VPC. In fact, it defines the uniqueness space of your ‚Äúgray‚Äù addresses. Within each virtual network, you completely control the address space that you can assign to computing resources.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The network is global. At the same time, it is projected onto each of the access zones in the form of an entity called Subnet. For each Subnet, you assign a certain CIDR of size 16 or less. There can be more than one such entity in each availability zone, while there is always transparent routing between them. This means that all your resources within the same VPC can "communicate" with each other, even if they are in different access zones. "Communicate" without access to the Internet, through our internal channels, "thinking" that they are within the same private network.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The diagram above shows a typical situation: two VPCs that somewhere intersect at addresses. Both may belong to you. For example, one for development, another for testing. There may simply be different users - in this case, it doesn‚Äôt matter. And one virtual machine is stuck in each VPC. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cc/a6/of/cca6ofxvbdmwgvvmfd5ic9_2fvs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compound the scheme. You can make one virtual machine stick into multiple Subnet at once. And not just like that, but in different virtual networks.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cd/uc/b1/cducb15mp353i6dhqnfcaz9gh2m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, if you need to put cars on the Internet, this can be done through the API or UI. To do this, you need to configure NAT translation of your "gray", internal address, to "white" - public. You cannot select a ‚Äúwhite‚Äù address; it is assigned randomly from our address pool. As soon as you stop using the external IP, it returns to the pool. You pay only for the time you use the "white" address. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/js/re/ckjsre4wehhzgdbwbcxwd1bdtdk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also possible to give the machine access to the Internet using a NAT instance. On an instance, you can get traffic through a static routing table. We have provided such a case, because users need it, and we know about it. Accordingly, in our catalog of images lies a specially configured NAT image.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fb/ty/ca/fbtycahgt5ggobr41bytbmnr3z8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But even when there is a ready-made NAT image, the configuration can be complicated. </font><font style="vertical-align: inherit;">We realized that for some users this is not the most convenient option, so in the end we made it possible to include NAT for the desired Subnet in one click. </font><font style="vertical-align: inherit;">This feature is still in private preview-access, where it is rolled in with the help of community members.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How a virtual network works from the inside out</font></font></h2><br>
<br>
<img src="https://habrastorage.org/webt/ti/lw/yw/tilwywdjwnfdeofsd3ifg_-iefe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How does a user interact with a virtual network? </font><font style="vertical-align: inherit;">The network looks outward with its API. </font><font style="vertical-align: inherit;">The user comes to the API and works with the target state. </font><font style="vertical-align: inherit;">Through the API, the user sees how everything should be arranged and configured, while he sees the status of how much the actual state differs from the desired one. </font><font style="vertical-align: inherit;">This is a picture of the user. </font><font style="vertical-align: inherit;">What is going on inside?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We record the desired state in Yandex Database and go to configure different parts of our VPC. The overlay network in Yandex.Cloud is built on the basis of selected components of OpenContrail, which has recently been called Tungsten Fabric. Network services are implemented on a single CloudGate platform. In CloudGate, we also used a number of open source components: GoBGP - for accessing control information, and VPP - for implementing a software router working on top of DPDK for the data path. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tungsten Fabric communicates with CloudGate through GoBGP. Tells what happens on the overlay network. CloudGate, in turn, connects overlay networks to each other and to the Internet.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ny/1h/cs/ny1hcsc2v737tdplrfatmoiqxlq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see how a virtual network addresses scalability and availability. Consider a simple case. There is one availability zone and two VPCs are created in it. We deployed one instance of Tungsten Fabric, and it pulls in tens of thousands of networks. Networks communicate with CloudGate. CloudGate, as we have said, ensures their connectivity with each other and with the Internet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/ee/jq/9weejqwjnmgidmdgyxgs0y503me.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose a second accessibility zone is added. It should fail completely independently of the first. Therefore, in the second access zone, we must deliver a separate Tungsten Fabric instance. This will be a separate system that deals with overlays and knows little about the first system. And the appearance that our virtual network is global, in fact, creates our VPC API. This is his task.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPC1 is projected into access zone B if there are resources in access zone B that stick into VPC1. If there are no resources from VPC2 in access zone B, we will not materialize VPC2 in this zone. In turn, since resources from VPC3 exist only in zone B, VPC3 is not in zone A. Everything is simple and logical. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's go a little deeper and see how a particular host is arranged in Y. Cloud. The main thing that I want to note is that all hosts are arranged in the same way. We make it so that only the necessary minimum of services is spinning on the hardware, all the rest work on virtual machines. We build services of a higher order based on basic infrastructure services, and also use the Cloud to solve some engineering problems, for example, as part of Continuous Integration.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8u/qz/mc/8uqzmcmduaz8vxjv1kefffjrpby.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we look at a specific host, we will see that three components are spinning in the host OS:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compute is the part responsible for the distribution of computing resources on the host.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VRouter is part of the Tungsten Fabric that organizes the overlay, that is, tunnels packets through the underlay.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VDisk are pieces of storage virtualization.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, services were launched in virtual machines: Cloud infrastructure services, platform services and customer capabilities. Customer capabilities and platform services always go overlay through VRouter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infrastructure services can stick into the overlay, but basically they want to work on the underlay. They are stuck in an underlay by means of SR-IOV. In fact, we cut the card into virtual network cards (virtual functions) and push them into infrastructure virtual machines so as not to lose performance. For example, the same CloudGate is launched as one of such infrastructure virtual machines. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that we have described the global tasks of the virtual network and the arrangement of the basic components of the cloud, let's see how exactly the different parts of the virtual network interact with each other.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We distinguish three layers in our system:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Config Plane - sets the target state of the system. </font><font style="vertical-align: inherit;">This is what the user configures through the API.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control Plane - provides user-defined semantics, that is, it brings the state of the Data Plane to what was described by the user in Config Plane.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Plane - directly processes user packets.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/nf/5t/fw/nf5tfwjsn6ygyuexccvhg2htmei.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I said above, it all starts with the fact that a user or an internal platform service comes to the API and describes a specific target state. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This state is immediately recorded in the Yandex Database, returns the ID of the asynchronous operation through the API, and starts our internal machinery to return the state that the user wanted. Configuration tasks go to the SDN controller and tell Tungsten Fabric what to do in the overlay. For example, they reserve ports, virtual networks, and the like. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/uf/t1/riuft15r3mczwrkizebnfp2eknu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Config Plane at Tungsten Fabric ships the required state to the Control Plane. Through it, Config Plane communicates with hosts, telling what it will turn on them in the near future.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/85/lf/oa/85lfoaxus-ukudo3x3puimqa8cm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see what the system looks like on hosts. In the virtual machine there is a certain network adapter stuck in VRouter. VRouter is a Tungsten Fabric core module that looks at packets. If there is already flow for some package, the module processes it. If there is no flow, the module does the so-called punting, that is, it sends the packet to the user-mode process. The process parses the packet and either responds to it itself, as, for example, to DHCP and DNS, or tells VRouter what to do with it. After that, the VRouter can process the packet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, traffic between virtual machines within the same virtual network runs transparently, it is not directed to CloudGate. Hosts on which virtual machines are deployed communicate directly with each other. They tunnel traffic and forward it to each other through the underlay.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sk/ne/h7/skneh7dbhlphbdf0gk65onsxzgo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Control Plane communicates with each other between BGP access zones, as with another router. </font><font style="vertical-align: inherit;">They tell which machines where they are raised, so that virtual machines in one zone can directly interact with other virtual machines. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7f/0h/gx/7f0hgxdnab4re3v2jocmmkw7sci.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, Control Plane communicates with CloudGate. </font><font style="vertical-align: inherit;">It similarly reports where and which virtual machines are raised, what their addresses are. </font><font style="vertical-align: inherit;">This allows you to direct external traffic and traffic from balancers to them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Traffic that leaves VPC comes to CloudGate, in the data path, where VPP is quickly chewed with our plugins. </font><font style="vertical-align: inherit;">Next, traffic is fired either at other VPCs or outward at the edge routers that are configured through CloudGate's Control Plane.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plans for the near future</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we summarize all of the above in several sentences, we can say that VPC in Yandex.Cloud solves two important tasks:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provides isolation between different customers.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combines resources, infrastructure, platform services, other clouds and on-premise into a single network.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And to solve these problems well, you need to provide scalability and fault tolerance at the level of internal architecture, which VPC does. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPC is gradually acquiring functions, we are realizing new opportunities, we are trying to improve something in terms of user convenience. </font><font style="vertical-align: inherit;">Some ideas are voiced and fall into the priority list thanks to members of our community. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have approximately the following list of plans for the near future:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN as a service.</font></font></li>
<li>Private DNS  ‚Äì          DNS-.</li>
<li>DNS  .</li>
<li>  .</li>
<li> ¬´¬ª IP-    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The balancer and the ability to switch the IP address for the already created virtual machine were in this list at the request of users. </font><font style="vertical-align: inherit;">Frankly, without explicit feedback, we would take up these functions a little later. </font><font style="vertical-align: inherit;">And so we are already working on a task about addresses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, a ‚Äúwhite‚Äù IP address could only be added when creating the machine. </font><font style="vertical-align: inherit;">If the user forgot to do this, the virtual machine had to be recreated. </font><font style="vertical-align: inherit;">The same thing and, if necessary, remove the external IP. </font><font style="vertical-align: inherit;">Soon it will be possible to turn the public IP on and off without re-creating the machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Feel free to express your </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ideas and support the suggestions of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> other users. </font><font style="vertical-align: inherit;">You help us make the Cloud better and get important and useful features faster!</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487680/index.html">Full analysis of the ShAD-2019 exam</a></li>
<li><a href="../en487682/index.html">7 recommendations for improving the reliability of JavaScript code</a></li>
<li><a href="../en487684/index.html">Developing faster applications on Vue.js</a></li>
<li><a href="../en487688/index.html">Development of an interactive coronavirus distribution map of type 2019-nCoV in Python</a></li>
<li><a href="../en487690/index.html">PHP Digest No. 173 (January 27 - February 10, 2020)</a></li>
<li><a href="../en487696/index.html">Digital events in Moscow from February 10 to 16</a></li>
<li><a href="../en487698/index.html">Digital events in St. Petersburg from February 10 to 16</a></li>
<li><a href="../en487702/index.html">A selection of articles on machine learning: case studies, guides and research for January 2020</a></li>
<li><a href="../en487704/index.html">How we built dynamic reports at SSRS 2014</a></li>
<li><a href="../en487706/index.html">Service Discovery in distributed systems using the Consul example. Alexander Sigachev</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>