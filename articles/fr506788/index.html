<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♠️ 👐🏾 💅🏻 Migrations de bases de données avec Flyway 🍖 🍒 🕵🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une traduction de l'article a été préparée avant le début du cours Java Developer .
 
 
 1. Introduction
 Cet article décrit les concepts clés de Flyw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Migrations de bases de données avec Flyway</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/506788/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une traduction de l'article a été préparée avant le début du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cours Java Developer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></b></i><br>
<br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Introduction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article décrit les concepts clés de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flyway</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et un exemple d'utilisation de ce cadre pour modifier en continu le schéma de base de données en utilisant la base de données H2 en mémoire comme exemple à l'aide du plug-in Flyway maven. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flyway met à jour les versions de base de données à l'aide de migrations. Les migrations peuvent être écrites en SQL (avec une syntaxe spécifique à un SGBD spécifique) ou en Java. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les migrations peuvent être versionnées ou récurrentes. Les premiers ont une version unique et sont appliqués exactement une fois. Les seconds n'ont pas de numéro de version et s'appliquent lorsque leur somme de contrôle change.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les migrations répétées au cours d'une même exécution sont toujours appliquées une fois les migrations versionnées terminées. </font><font style="vertical-align: inherit;">Les migrations répétées sont appliquées dans l'ordre où elles sont décrites. </font><font style="vertical-align: inherit;">Dans une migration, toutes les opérations sont effectuées dans une seule transaction de base de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous nous concentrerons sur l'utilisation du plugin maven pour les migrations de bases de données.</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Plugin Flyway maven</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajouter le plugin Flyway Maven à </font></font><code>pom.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs">&lt;plugin&gt;<font></font>
    &lt;groupId&gt;org.flywaydb&lt;/groupId&gt;<font></font>
    &lt;artifactId&gt;flyway-maven-plugin&lt;/artifactId&gt;<font></font>
    &lt;version&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.3</span>&lt;/version&gt;<font></font>
&lt;/plugin&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La version actuelle du plugin peut être consultée dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maven Central</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une liste des paramètres du plugin peut être trouvée dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Les paramètres du plugin peuvent être configurés de quatre manières différentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.1. </font><font style="vertical-align: inherit;">Section </font></font><code><code>&lt;configuration&gt;</code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugin Les </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
paramètres peuvent être spécifiés directement dans la balise de la section plugin dans </font></font><code>pom.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">&lt;plugin&gt;<font></font>
    &lt;groupId&gt;org.flywaydb&lt;/groupId&gt;<font></font>
    &lt;artifactId&gt;flyway-maven-plugin&lt;/artifactId&gt;<font></font>
    &lt;version&gt;4.0.3&lt;/version&gt;<font></font>
    &lt;configuration&gt;<font></font>
        &lt;user&gt;databaseUser&lt;/user&gt;<font></font>
        &lt;password&gt;databasePassword&lt;/password&gt;<font></font>
        &lt;schemas&gt;<font></font>
            &lt;schema&gt;schemaName&lt;/schema&gt;<font></font>
        &lt;/schemas&gt;<font></font>
        ...<font></font>
    &lt;/configuration&gt;<font></font>
&lt;/plugin&gt;</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2. </font><font style="vertical-align: inherit;">Propriétés Maven</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez également configurer le plugin en spécifiant des paramètres dans </font></font><code><code>&lt;</code>properties&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs">&lt;project&gt;<font></font>
    ...<font></font>
    &lt;properties&gt;<font></font>
        &lt;flyway.user&gt;databaseUser&lt;/flyway.user&gt;<font></font>
        &lt;flyway.password&gt;databasePassword&lt;/flyway.password&gt;<font></font>
        &lt;flyway.schemas&gt;schemaName&lt;/flyway.schemas&gt;<font></font>
        ...<font></font>
    &lt;/properties&gt;<font></font>
    ...<font></font>
&lt;/project&gt;</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3. </font><font style="vertical-align: inherit;">Fichier de configuration externe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou décrivez la configuration dans un </font></font><code>.properties</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier </font><font style="vertical-align: inherit;">séparé </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs">flyway.user=databaseUser<font></font>
flyway.password=databasePassword<font></font>
flyway.schemas=schemaName<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le nom par défaut est le fichier de configuration </font></font><code>flyway.properties</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ce fichier doit se trouver dans le même répertoire que le fichier </font></font><code>pom.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">L'encodage est défini dans le paramètre </font></font><code>flyway.encoding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(la valeur par défaut est UTF-8). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous utilisez un nom différent pour le fichier (par exemple, </font></font><code>customConfig.properties</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), vous devez le spécifier explicitement lors de l'appel à maven:</font></font><br>
<br>
<pre><code class="java hljs">$ mvn -Dflyway.configFile=customConfig.properties</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4. </font><font style="vertical-align: inherit;">Propriétés du système</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfin, les paramètres peuvent être spécifiés en tant que propriétés système lors de l'appel de maven à partir de la ligne de commande:</font></font><br>
<br>
<pre><code class="java hljs">$ mvn -Dflyway.user=databaseUser -Dflyway.password=databasePassword<font></font>
  -Dflyway.schemas=schemaName</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la configuration est spécifiée de plusieurs manières, la priorité sera la suivante:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propriétés du système</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichier de configuration externe</font></font></li>
<li><font style="vertical-align: inherit;"></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propriétés de </font><font style="vertical-align: inherit;">section</font></font><code>&gt;</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Section de </font></font><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configuration du </font></font><code>&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugin</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Exemple de migration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cette section, nous considérerons les étapes nécessaires pour migrer un schéma de base de données en utilisant la base de données H2 en mémoire comme exemple en utilisant le plugin maven. </font><font style="vertical-align: inherit;">Pour configurer Flyway, nous utiliserons un fichier externe.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Modifications du POM</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, ajoutez une dépendance à H2:</font></font><br>
<br>
<pre><code class="java hljs">&lt;dependency&gt;<font></font>
    &lt;groupId&gt;com.h2database&lt;/groupId&gt;<font></font>
    &lt;artifactId&gt;h2&lt;/artifactId&gt;<font></font>
    &lt;version&gt;<span class="hljs-number">1.4</span><span class="hljs-number">.196</span>&lt;/version&gt;<font></font>
&lt;/dependency&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous pouvons également vérifier la dernière version de pilote disponible dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maven Central</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ajoutez un plugin pour Flyway, comme décrit précédemment.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">Configurer Flyway dans un fichier externe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez un </font></font><code>$PROJECT_ROOT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier </font></font><code>myFlywayConfig.properties</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec le contenu suivant:</font></font><br>
<br>
<pre><code class="java hljs">flyway.user=databaseUser<font></font>
flyway.password=databasePassword<font></font>
flyway.schemas=app-db<font></font>
flyway.url=jdbc:h2:mem:DATABASE<font></font>
flyway.locations=filesystem:db/migration</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La configuration ci-dessus indique que les scripts de migration sont dans le répertoire </font></font><code>db/migration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et pour se connecter à la base de données à l'aide de H2 </font></font><code>databaseUser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>databasePassword</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schéma de base de données pour l'application </font></font><code>app-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, dans les paramètres </font></font><code>flyway.user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>flyway.password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>flyway.url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous devez spécifier le nom, le mot de passe et l'URL de votre base de données.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3. </font><font style="vertical-align: inherit;">Première migration</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous les conventions Flyway, les noms des scripts de migration doivent être au format suivant:</font></font><br>
<br>
<pre><code class="plaintext hljs">&lt;Prefix&lt;code&gt;&gt;&lt;&lt;/code&gt;Version&gt;__&lt;code&gt;&lt;&lt;/code&gt;Description&gt;.sql</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Où:</font></font><br>
<br>
<ul>
<li><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Préfixe&gt; - préfixe. </font><font style="vertical-align: inherit;">Pour les migrations versionnées, la valeur par défaut est «V». </font><font style="vertical-align: inherit;">Le préfixe est configuré via la propriété flyway.sqlMigrationPrefix.</font></font></li>
<li><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version&gt; - numéro de version de la migration. </font><font style="vertical-align: inherit;">Les versions majeures et mineures peuvent être séparées en soulignant. </font><font style="vertical-align: inherit;">La version doit toujours commencer par 1.</font></font></li>
<li><code>&lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description&gt; - une description textuelle de la migration. </font><font style="vertical-align: inherit;">La description doit être séparée du numéro de version par deux traits de soulignement.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple: Créons </font></font><code>V1_1_0__my_first_migration.sql</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
donc un répertoire </font></font><code>db/migration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans </font></font><code>$PROJECT_ROOT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la migration du script </font></font><code>V1_0__create_employee_schema.sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et SQL pour créer la table </font></font><code>employee</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs">CREATE TABLE IF NOT EXISTS `employee` (<font></font>
 <font></font>
    `id` <span class="hljs-keyword">int</span> NOT NULL AUTO_INCREMENT PRIMARY KEY,<font></font>
    `name` varchar(<span class="hljs-number">20</span>),<font></font>
    `email` varchar(<span class="hljs-number">50</span>),<font></font>
    `date_of_birth` timestamp<font></font>
 <font></font>
)ENGINE=InnoDB DEFAULT CHARSET=UTF8;</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.4. </font><font style="vertical-align: inherit;">Nous effectuons des migrations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, </font></font><code>$PROJECT_ROOT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exécutez la commande maven suivante pour appliquer les migrations de base de données:</font></font><br>
<br>
<pre><code class="java hljs">$ mvn clean flyway:migrate -Dflyway.configFile=myFlywayConfig.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre première migration doit être terminée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, le schéma de base de données ressemble à ceci: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
employé:</font></font><br>
<br>
<pre><code class="java hljs">+----+------+-------+---------------+<font></font>
| id | name | email | date_of_birth |<font></font>
+----+------+-------+---------------+</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons répéter les étapes précédentes pour effectuer d'autres migrations.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.5. </font><font style="vertical-align: inherit;">Deuxième migration</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la deuxième migration, créez un fichier avec le nom </font></font><code>V2_0_create_department_schema.sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contenant les deux requêtes suivantes:</font></font><br>
<br>
<pre><code class="java hljs">CREATE TABLE IF NOT EXISTS `department` (<font></font>
 <font></font>
`id` <span class="hljs-keyword">int</span> NOT NULL AUTO_INCREMENT PRIMARY KEY,<font></font>
`name` varchar(<span class="hljs-number">20</span>)<font></font>
 <font></font>
)ENGINE=InnoDB DEFAULT CHARSET=UTF8;<font></font>
 <font></font>
ALTER TABLE `employee` ADD `dept_id` <span class="hljs-keyword">int</span> AFTER `email`;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Effectuons la migration, comme nous l'avons fait pour la première migration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, le schéma de notre base de données a changé: </font></font><code>employee</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une nouvelle colonne a été ajoutée et une nouvelle table a été créée </font></font><code>department</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<code>employee:</code><br>
<pre><code class="java hljs">+----+------+-------+---------+---------------+<font></font>
| id | name | email | dept_id | date_of_birth |<font></font>
+----+------+-------+---------+---------------+</code></pre><br>
<code>department:</code><br>
<br>
<pre><code class="java hljs">+----+------+<font></font>
| id | name |<font></font>
+----+------+</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour vérifier que les deux migrations ont réussi, exécutez la commande maven suivante:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ mvn flyway:info -Dflyway.configFile=myFlywayConfig.properties</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Désactiver Flyway dans Spring Boot</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, vous devrez peut-être désactiver les migrations Flyway. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut être nécessaire pendant les tests lorsqu'un schéma de base de données est généré sur la base d'entités. </font><font style="vertical-align: inherit;">Dans ce cas, vous pouvez désactiver Flyway pour le profil de test. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans Spring Boot, c'est très simple.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.1. </font><font style="vertical-align: inherit;">Spring boot 1.x</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout ce que nous devons faire est de définir la propriété </font></font><code>flyway.enabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le fichier </font></font><code>application-test.properties</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs">flyway.enabled=<span class="hljs-keyword">false</span></code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.2. </font><font style="vertical-align: inherit;">Spring boot 2.x</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les versions ultérieures de Spring Boot, cette propriété a été remplacée par </font></font><br>
<br>
<pre><code class="java hljs">spring.flyway.enabled:<font></font>
spring.flyway.enabled=<span class="hljs-keyword">false</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.3 Stratégie de migration vide</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous voulons désactiver uniquement la migration automatique de Flyway au démarrage, mais que nous voulons démarrer les migrations manuellement, l'utilisation des propriétés ci-dessus ne fonctionnera pas pour nous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela est dû au fait que Spring Boot ne configurera pas automatiquement les beans Flyway et, par conséquent, nous devrons les configurer nous-mêmes, ce qui n'est pas très pratique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous pouvons laisser Flyway activé et implémenter une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FlywayMigrationStrategy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vide </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmptyMigrationStrategyConfig</span> </span>{<font></font>
 <font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> FlywayMigrationStrategy <span class="hljs-title">flywayMigrationStrategy</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> flyway -&gt; {
            <span class="hljs-comment">// do nothing </span><font></font>
        };<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, cela désactivera les migrations Flyway au démarrage de l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous pouvons toujours démarrer la migration manuellement:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RunWith(SpringRunner.class)</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ManualFlywayMigrationIntegrationTest</span> </span>{<font></font>
 <font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Flyway flyway;<font></font>
 <font></font>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">skipAutomaticAndTriggerManualFlywayMigration</span><span class="hljs-params">()</span> </span>{<font></font>
        flyway.migrate();<font></font>
    }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Fonctionnement de Flyway</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour suivre quand, par qui et quelles migrations ont été appliquées, une table spéciale avec des métadonnées est ajoutée au schéma de la base de données. </font><font style="vertical-align: inherit;">Ce tableau stocke également les sommes de contrôle des migrations et des informations indiquant si la migration a réussi ou non. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le cadre fonctionne comme suit:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vérifie le schéma de base de données pour une table de métadonnées (par défaut </font></font><code>SCHEMA_VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Si la table de métadonnées n'existe pas, elle la crée.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyse le chemin de classe pour les migrations disponibles.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compare les migrations vers une table de métadonnées. </font><font style="vertical-align: inherit;">Si le numéro de version est inférieur ou égal à la version marquée comme actuelle, il est ignoré.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marque toutes les migrations restantes comme en attente. </font><font style="vertical-align: inherit;">Il les trie ensuite par numéro de version croissant et les exécute dans l'ordre spécifié.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À mesure que les migrations s'appliquent, met à jour la table de métadonnées.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Équipes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flyway dispose des principales équipes de gestion des migrations suivantes:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Info</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Affiche l'état / la version actuelle du schéma de base de données. </font><font style="vertical-align: inherit;">Informations sur les migrations attendues, celles qui ont été appliquées, l'état des migrations terminées et la date de leur achèvement.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mise à jour du schéma de base de données vers la version actuelle. </font><font style="vertical-align: inherit;">Analysez un chemin de classe pour trouver les migrations disponibles et appliquez les migrations en attente.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Référence</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Installation de la version du schéma de base de données, en ignorant les migrations jusqu'à et y compris baselineVersion. </font><font style="vertical-align: inherit;">Baseline vous aide à utiliser Flyway sur une base de données existante. </font><font style="vertical-align: inherit;">De nouvelles migrations sont appliquées comme d'habitude.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le valider</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vérification du schéma de base de données actuel par rapport aux migrations disponibles.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réparer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Restaurer la table de métadonnées.</font></font></li>
<li><b>Clean</b>.     . ,     clean    .</li>
</ul><br>
<h3>7. </h3><br>
<ul>
<li>    ,   Flyway             .</li>
<li>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a>.</li>
</ul><br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">     FLYWAY</a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr506758/index.html">Products a organisé une conférence sur le principe de l'open source, et pendant 10 ans chaque participant est organisateur</a></li>
<li><a href="../fr506762/index.html">Semaine de la sécurité 25: ensemble de correctifs record de Microsoft</a></li>
<li><a href="../fr506766/index.html">Nous refusons des plateformes RPA payantes et sommes basées sur OpenSource (OpenRPA)</a></li>
<li><a href="../fr506772/index.html">Créer ou refuser - un test d'idées de force</a></li>
<li><a href="../fr506786/index.html">Compétence en recherche d'emploi</a></li>
<li><a href="../fr506790/index.html">Scénario de données sur les stéroïdes: Présentation de Decision Intelligence</a></li>
<li><a href="../fr506792/index.html">Embarqué par Zephyr: expérience avec STM32F7-Discovery</a></li>
<li><a href="../fr506796/index.html">MREM - 200. Microscope électronique originaire de l'URSS</a></li>
<li><a href="../fr506798/index.html">Science des données pour les sciences humaines: qu'est-ce que les données</a></li>
<li><a href="../fr506806/index.html">MVP pour Android - les avantages d'utiliser Moxy comme bibliothèque d'assistance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>