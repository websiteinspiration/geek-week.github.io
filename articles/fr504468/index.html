<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📁 👩🏼‍🔧 😺 Performances du Raspberry Pi: ajoutez ZRAM et modifiez les paramètres du noyau 🥝 🚢 👨🏿‍🤝‍👨🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelques semaines, j'ai publié une critique de Pinebook Pro . Étant donné que Raspberry Pi 4 est également basé sur ARM, certaines des optimisa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Performances du Raspberry Pi: ajoutez ZRAM et modifiez les paramètres du noyau</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504468/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a quelques semaines, j'ai publié une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">critique de Pinebook Pro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Étant donné que Raspberry Pi 4 est également basé sur ARM, certaines des optimisations mentionnées dans l'article précédent lui conviennent parfaitement. </font><font style="vertical-align: inherit;">Je voudrais partager ces astuces et savoir si vous avez les mêmes améliorations de performances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir installé Raspberry Pi dans ma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salle de serveur à domicile,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j'ai remarqué qu'en période de pénurie de RAM, il ne répondait plus et se bloquait même. </font><font style="vertical-align: inherit;">Pour résoudre ce problème, j'ai ajouté ZRAM et apporté plusieurs modifications aux paramètres du noyau.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Activation de ZRAM sur Raspberry Pi</font></font></h1><br>
<img src="https://habrastorage.org/getpro/habr/post_images/032/270/fb0/032270fb0277cc21b3946def04336dfa.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZRAM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> crée un stockage de blocs dans la RAM avec le nom / dev / zram0 (ou 1, 2, 3, etc.). </font><font style="vertical-align: inherit;">Les pages qui y sont enregistrées sont compressées et stockées en mémoire. </font><font style="vertical-align: inherit;">Cela permet des E / S très rapides et libère également de la mémoire en raison de la compression. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le Raspberry Pi 4 est livré avec 1, 2, 4 ou 8 Go de RAM. </font><font style="vertical-align: inherit;">J'utiliserai le modèle 1 Go, ajustez donc les instructions en fonction de votre modèle. </font><font style="vertical-align: inherit;">Avec 1 Go de ZRAM, le fichier d'échange par défaut (lent!) Sera utilisé moins souvent. </font><font style="vertical-align: inherit;">J'ai utilisé un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> script </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">zram-swap</font></a><font style="vertical-align: inherit;"> pour l'installation et la configuration automatique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les instructions sont fournies dans le référentiel sur le lien ci-dessus. </font><font style="vertical-align: inherit;">Installation:</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://github.com/foundObjects/zram-swap.git
<span class="hljs-built_in">cd</span> zram-swap &amp;&amp; sudo ./install.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez modifier la configuration:</font></font><br>
<br>
<pre><code class="bash hljs">vi /etc/default/zram-swap</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, vous pouvez activer ZRAM par l'installation </font></font><code>zram-tools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous utilisez cette méthode, veillez à modifier la configuration</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le fichier </font></font><code>/etc/default/zramswap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et installez environ 1 Go de ZRAM:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt install zram-tools</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après l'installation, vous pouvez afficher les statistiques de stockage ZRAM avec la commande suivante:</font></font><br>
<br>
<pre><code class="bash hljs">sudo cat /proc/swaps<font></font>
Filename				Type		Size	Used	Priority<font></font>
/var/swap                               file		102396	0	-2<font></font>
/dev/zram0                              partition	1185368	265472	5<font></font>
pi@raspberrypi:~ $</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout de paramètres de noyau pour une meilleure utilisation de ZRAM</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Corrigez maintenant le comportement du système lorsque le Raspberry Pi passe au swap au dernier moment, ce qui entraîne souvent des gels. </font><font style="vertical-align: inherit;">Ajoutez quelques lignes au fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/sysctl.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et redémarrez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces lignes 1) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retardent l'épuisement inévitable de la mémoire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , augmentant la pression sur le cache du noyau, et 2) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commencent plus tôt à préparer l'épuisement de la mémoire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , initiant un échange à l'avance. </font><font style="vertical-align: inherit;">Mais ce sera un échange beaucoup plus efficace de mémoire compressée via ZRAM! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici les lignes à ajouter à la fin du fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/sysctl.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">vm.vfs_cache_pressure=500<font></font>
vm.swappiness=100<font></font>
vm.dirty_background_ratio=1<font></font>
vm.dirty_ratio=50</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous redémarrons le système ou activons les modifications avec la commande suivante:</font></font><br>
<br>
<pre><code class="bash hljs">sudo sysctl --system</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.vfs_cache_pressure = 500</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> augmente la pression sur le cache, ce qui augmente la tendance du noyau à récupérer la mémoire utilisée pour mettre en cache les objets de répertoire et les index. Vous utiliserez moins de mémoire pendant une période plus longue. Une forte baisse de productivité est annulée par les échanges antérieurs. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.swappiness = 100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> augmente le paramètre avec quelle agressivité le noyau échangera des pages de mémoire, puisque nous utilisons d'abord ZRAM. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.dirty_background_ratio = 1 &amp; vm.dirty_ratio = 50</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les processus d'arrière-plan commenceront l'enregistrement immédiatement après avoir atteint la limite de 1%, mais le système ne forcera pas les E / S synchrones jusqu'à ce qu'il atteigne dirty_ratio de 50%.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces quatre lignes (lorsqu'elles sont utilisées avec ZRAM) aideront à améliorer les performances si vous manquez </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inévitablement</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de RAM et commencez à passer au swap, comme le mien. Sachant cela, tout en tenant compte de la compression de la mémoire en ZRAM, il est trois fois préférable de démarrer ce swap à l'avance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La pression sur le cache est utile car nous disons en fait au noyau: "Hé, écoutez, je n'ai pas de mémoire supplémentaire à utiliser pour le cache, alors veuillez vous en débarrasser le plus tôt possible et ne conserver que les données les plus fréquemment utilisées / importantes."</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Même avec une mise en cache réduite, si au fil du temps la majeure partie de la mémoire installée est occupée, le noyau commencera un échange opportuniste beaucoup plus tôt, de sorte que le processeur (compression) et les E / S d'échange ne tireront pas au dernier et n'utiliseront pas toutes les ressources en même temps, quand il sera trop tard. </font><font style="vertical-align: inherit;">ZRAM utilise un peu de CPU pour la compression, mais sur la plupart des systèmes avec une petite quantité de mémoire, cela affecte les performances beaucoup moins qu'un échange sans ZRAM.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finalement</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons à nouveau le résultat:</font></font><br>
<br>
<pre><code class="plaintext hljs">pi@raspberrypi:~ $ free -h<font></font>
total used free shared buff/cache available<font></font>
Mem: 926Mi 471Mi 68Mi 168Mi 385Mi 232Mi<font></font>
Swap: 1.2Gi 258Mi 999Mi<font></font>
<font></font>
pi@raspberrypi:~ $ sudo cat /proc/swaps <font></font>
Filename Type Size Used Priority<font></font>
/var/swap file 102396 0 -2<font></font>
/dev/zram0 partition 1185368 264448 5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
264448 en ZRAM représente presque un gigaoctet de données non compressées. </font><font style="vertical-align: inherit;">Tout est allé à ZRAM et rien n'est entré dans le fichier d'échange beaucoup plus lent. </font><font style="vertical-align: inherit;">Essayez ces paramètres vous-même, ils fonctionnent sur tous les modèles de Raspberry Pi. </font><font style="vertical-align: inherit;">Mon système de congélation inadapté s'est transformé en un système fonctionnel et stable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un avenir proche, j'espère continuer et mettre à jour cet article avec quelques résultats des tests du système avant et après l'installation de ZRAM. </font><font style="vertical-align: inherit;">Maintenant, je n'ai tout simplement pas le temps pour cela. </font><font style="vertical-align: inherit;">En attendant, n'hésitez pas à effectuer vos propres tests et faites-le nous savoir dans les commentaires. </font><font style="vertical-align: inherit;">Le Raspberry Pi 4 n'est qu'une bête avec de tels paramètres. </font><font style="vertical-align: inherit;">Profitez-en!</font></font><br>
<br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur ce sujet:</font></font></b><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performances Linux: pourquoi vous devez presque toujours augmenter l'espace de swap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2017)</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performances Linux: augmentez presque toujours l'espace de swap. </font><font style="vertical-align: inherit;">Partie 2: ZRAM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2020)</font></font></li>
</ul></blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504454/index.html">Meilleurs référentiels GitHub pour les développeurs Web</a></li>
<li><a href="../fr504456/index.html">Isoler les environnements de développement avec des conteneurs LXD</a></li>
<li><a href="../fr504458/index.html">Installation d'OpenCV-Python dans un environnement virtuel pour les super-bouilloires</a></li>
<li><a href="../fr504460/index.html">À propos du livre de publicité Ogilvy de David Ogilvy</a></li>
<li><a href="../fr504464/index.html">Comment nous avons conçu le TableAdapter et simplifié le travail avec UITableView</a></li>
<li><a href="../fr504472/index.html">Mes meilleurs outils de développement gratuits</a></li>
<li><a href="../fr504480/index.html">Comment trouver un marketeur avec qui il sera rentable de travailler?</a></li>
<li><a href="../fr504482/index.html">Demandez-nous: DIT répondra aux questions</a></li>
<li><a href="../fr504484/index.html">IPSec Tout-Puissant</a></li>
<li><a href="../fr504486/index.html">Processus: création de Vue 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>