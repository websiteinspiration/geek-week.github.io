<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍🏫 👩🏿‍⚖️ 💪🏾 Linux内核TLS和Nginx 😗 🤙🏼 🧗🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在本文中，我将讨论通过将加密转移到操作系统的核心来加速TLS连接中内容分发的发展历史和当前技术水平，以及我对该方向的发展所做出的贡献。
 
 背景
 早在2015年，Netflix的Randall Stewart和Scott Long就在AsiaBSDCon2015 大会上作了关于优化加密内容分发的...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linux内核TLS和Nginx</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501010/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在本文中，我将讨论通过将加密转移到操作系统的核心来加速TLS连接中内容分发的发展历史和当前技术水平，以及我对该方向的发展所做出的贡献。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">背景</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
早在2015年，Netflix的Randall Stewart和Scott Long就在AsiaBSDCon2015 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大会</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上</font><font style="vertical-align: inherit;">作了</font><font style="vertical-align: inherit;">关于优化加密内容分发的</font><font style="vertical-align: inherit;">演讲</font><font style="vertical-align: inherit;">。该报告的主要信息是将数据加密转移到操作系统的内核，以减少内核空间和用户空间之间的数据副本数量，并使用优化的非阻塞sendfile（）系统调用。事实证明，该主题非常有前途，已经在2016年</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netdev 1.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大会上，</font><font style="vertical-align: inherit;">Facebook的Dave Watson做了一个</font><font style="vertical-align: inherit;">关于在Linux内核中创建TLS套接字的需求</font><font style="vertical-align: inherit;">的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">演示</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而Mellanox的Boris Pismenny，Ilya Lesokhin和Liran Liss </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">做了一个演示。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于在网卡中使用TLS硬件加速的功能。</font><font style="vertical-align: inherit;">Tempesta Technologies的发言人也在HighLoad ++ 2017上讨论了该主题。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux内核支持</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有这些对话的结果是内核TLS在Linux内核4.13（2017）中的出现，并支持TLSv1.2和AES128-GCM密码。</font><font style="vertical-align: inherit;">最初，仅支持对传出流量的加密，后来在Linux内核4.17（2018）中出现了解密支持。</font><font style="vertical-align: inherit;">在5.1版中，他们添加了对TLSv1.3和AES256-GCM的支持，在5.2版中，他们还添加了AES128-CCM密码（2019）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户空间支持</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在上述所有报告中，都说只能在内核中放置有用数据的加密，并且所有TLS批准和控制消息都必须在用户空间中以相同的方式处理。为此，使用了OpenSSL的修改版本。但是，在公共领域发布报告时，没有关于需要对该知名库进行哪些修改以支持该功能的信息。使用Linux内核TLS的唯一可用示例可能是博客文章Filippo Valsorda </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，在Linux 4.13和Go中使用内核TLS。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它在Linux 4.13内核发布后立即出现。</font><font style="vertical-align: inherit;">而且，尽管它显示了使用技术的有效示例，但并没有使人们了解如何在实际项目中使用该技术。</font><font style="vertical-align: inherit;">毕竟，很少有人为自己的项目编写WEB服务器，通常每个人都使用众所周知且经过时间考验的工具。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenSSL支持</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenSSL技术的首次讨论出现在2017年夏天，Linux 4.13内核（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR 3631</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">发布之前不久</font><font style="vertical-align: inherit;">，但是讨论过程非常非常缓慢，最初的真正评论出现在10月（4.13内核发布之后），实际上是</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工作版本</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在2018年2月开始讨论。在完成所有更正之时，关闭了在OpenSSL 1.1.1中添加新功能的窗口，并且对内核TLS的支持已移至下一个版本。</font><font style="vertical-align: inherit;">从那时起，添加了内核TLS RX支持，并且SSL_sendfile（）是对相应syscall的调用，仅对TLS协议中的可能情况进行了少量处理。</font><font style="vertical-align: inherit;">但是现在到2020年，OpenSSL 3.0尚未问世，绝大多数浏览器都支持TLSv1.3，而更具抵抗力的AES256-GCM积极取代了AES128-GCM密码。</font><font style="vertical-align: inherit;">因此，我自由了，发送了一个</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pull请求</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以支持新密码和TLSv1.3，希望他们在新版本的库之前接受它。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WEB服务器中的支持</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是在TLS库中仅支持内核TLS是不够的。有关该技术的报道说，使用send而不将数据复制到用户空间可以实现最大效率-使用sendfile（）系统调用。服务器应用程序应该能够区分可以在带TLS的套接字上使用sendfile（）以及何时需要“以旧方式读取” read（）/ SSL_write（）的情况。 2019年4月，在向Nginx添加功能方面取得了一些进展，但主要代码未接受任何更改。开发人员的立场是，尚未批准OpenSSL中用于这些功能的API，并且补丁中建议的实际代码似乎不足以移植到不同平台。老实说，该代码不仅看起来不太漂亮，而且还包含一些错误，这些错误会阻止在没有其他更正的情况下构建Nginx。我根本找不到其他Web服务器中的Kernel TLS支持（也许有人看到了-在评论中告诉我）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怎么办？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当社区在等待OpenSSL 3.0的发布时，为了开始使用稳定的API在Nginx中开发对内核TLS的支持，我选择了另一种方法。</font><font style="vertical-align: inherit;">在我</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">舒适的</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GitHub </font><s><font style="vertical-align: inherit;">角落</font></s><font style="vertical-align: inherit;">，我做了两件事：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我创建了一个</font><font style="vertical-align: inherit;">OpenSSL </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分支，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并将与内核TLS相关的所有内容都反向移植到了OpenSSL 1.1.1（OpenSSL_1_1_1-ktls分支）的稳定版本中。</font><font style="vertical-align: inherit;">特别是为了能够在库的其余部分稳定运行的情况下检查功能。</font><font style="vertical-align: inherit;">随着稳定版本的推出，我会尝试重新设置基础，以使分叉保持最新状态。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我创建了</font><font style="vertical-align: inherit;">Nginx的</font><font style="vertical-align: inherit;">一个</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分支</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，在其中添加了（基于Mellanox的补丁）支持，以便在确实可行且具有必要的SSL套接字检查的条件下调用SSL_sendfile（），并具有通过配置变量启用/禁用功能的能力。</font><font style="vertical-align: inherit;">除了此功能外，在我的fork中还提供了几个补丁，这些补丁可以稍微优化Nginx的工作并修复一些错误（master-feature分支）。</font><font style="vertical-align: inherit;">为了使fork保持最新状态，我尝试尽可能地基于Nginx主仓库的master分支进行基准调整。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我邀请所有人参加测试。</font><font style="vertical-align: inherit;">可以在GitHub上的Issues中抛出对代码的注释和更正。</font><font style="vertical-align: inherit;">要使用此OpenSSL和随附的内核TLS支持构建此Nginx，请向configure脚本添加参数：</font></font><br>
<br>
<pre><code class="bash hljs">./configure --with-openssl=&lt;OpenSSL-fork-dir&gt; --with-openssl-opt=<span class="hljs-string">"enable-ktls"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
目前，我没有机会在严重负载下测试此Nginx + OpenSSL捆绑包，以确认从注释到Nginx补丁的性能，因此，如果突然有人可以测量高文件上传速度下CPU负载的差异，那么获取图形并添加图形将很棒将它们整理成文章，以直观地了解效果。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN501000/index.html">通过为数据库创建客户端的示例在Go中生成代码</a></li>
<li><a href="../zh-CN501002/index.html">umka：新的静态类型脚本语言</a></li>
<li><a href="../zh-CN501004/index.html">做吧 工作</a></li>
<li><a href="../zh-CN501006/index.html">我们是STM32的朋友，在I2C总线上带有LCD显示屏1604（HAL库）</a></li>
<li><a href="../zh-CN501008/index.html">多米诺骨牌铺</a></li>
<li><a href="../zh-CN501012/index.html">我如何寻找博客的儿童引擎</a></li>
<li><a href="../zh-CN501016/index.html">关于处理器架构的发展趋势，或者为什么我相信华为在服务器市场上的成功</a></li>
<li><a href="../zh-CN501018/index.html">如何解决一些Google翻译限制</a></li>
<li><a href="../zh-CN501020/index.html">如何在引擎盖下测试包含setTimeout / setInterval的代码</a></li>
<li><a href="../zh-CN501022/index.html">“我在沙漠中”：为什么自我孤立对我们构成严重压力，这一切导致了什么</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>