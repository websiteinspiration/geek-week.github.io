<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✌🏿 👏🏻 ⚰️ Doctrine ResultSetMapping avec des exemples 🤴🏿 😻 🍡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Doctrine ORM fournit au développeur des moyens pratiques de récupérer des données. Il s'agit d'un DQL puissant pour travailler de manière orientée obj...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Doctrine ResultSetMapping avec des exemples</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496166/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doctrine ORM fournit au développeur des moyens pratiques de récupérer des données. </font><font style="vertical-align: inherit;">Il s'agit d'un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puissant </font><font style="vertical-align: inherit;">pour travailler de manière orientée objet, et d'un générateur de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requêtes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pratique </font><font style="vertical-align: inherit;">, simple et intuitif à utiliser. </font><font style="vertical-align: inherit;">Ils couvrent la plupart des besoins, mais il devient parfois nécessaire d'utiliser des requêtes SQL optimisées ou spécifiques à un SGBD particulier. </font><font style="vertical-align: inherit;">Pour travailler avec des résultats de requête dans du code, il est important de comprendre le fonctionnement du mappage dans Doctrine.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6v/jr/gx/6vjrgxkxjkih5otk5mussb5_cma.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ORM Doctrine est basé sur le modèle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Mapper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui isole la représentation relationnelle de l'objet et convertit les données entre eux. </font><font style="vertical-align: inherit;">L'un des composants clés de ce processus est l'objet </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResultSetMapping</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui décrit comment transformer les résultats de requête du modèle relationnel en objet. </font><font style="vertical-align: inherit;">La doctrine utilise toujours ResultSetMapping pour représenter les résultats de la requête, mais généralement cet objet est créé sur la base d'annotations ou de configurations yaml, xml, il reste caché aux yeux du développeur, donc tout le monde ne connaît pas ses capacités. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour des exemples de travail avec ResultSetMapping, j'utiliserai MySQL et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la base de données exemple des employés</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure DB</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/oc/qf/zy/ocqfzydztc0ia9euzhyalw8cksa.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Décrivons les entités Département, Employé, Salaire, avec lesquelles nous continuerons à travailler davantage. </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deparment</font></font></b><div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Mapping</span> <span class="hljs-title">as</span> <span class="hljs-title">ORM</span>;<font></font>
<font></font>
<span class="hljs-comment">/**
 * Departments
 *
 * <span class="hljs-doctag">@ORM</span>\Table(name="departments", uniqueConstraints={<span class="hljs-doctag">@ORM</span>\UniqueConstraint(name="dept_name", columns={"dept_name"})})
 * <span class="hljs-doctag">@ORM</span>\Entity
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Department</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> string
     *
     * <span class="hljs-doctag">@ORM</span>\Column(name="dept_no", type="string", length=4, nullable=false, options={"fixed"=true})
     * <span class="hljs-doctag">@ORM</span>\Id
     * <span class="hljs-doctag">@ORM</span>\GeneratedValue(strategy="IDENTITY")
     */</span>
    <span class="hljs-keyword">private</span> $deptNo;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> string
     *
     * <span class="hljs-doctag">@ORM</span>\Column(name="dept_name", type="string", length=40, nullable=false)
     */</span>
    <span class="hljs-keyword">private</span> $deptName;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> \Doctrine\Common\Collections\Collection
     *
     * <span class="hljs-doctag">@ORM</span>\ManyToMany(targetEntity="Employee", mappedBy="deptNo")
     */</span>
    <span class="hljs-keyword">private</span> $empNo;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Constructor
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;empNo = <span class="hljs-keyword">new</span> \Doctrine\Common\Collections\ArrayCollection();<font></font>
    }<font></font>
}<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Employé</font></font></b><div class="spoiler_text"><br>
&lt;?php<br>
<br>
namespace App\Entity;<br>
<br>
use Doctrine\ORM\Mapping as ORM;<br>
<br>
/**<br>
 * Employees<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Table(name=«employees»)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Entity<br>
 */<br>
class Employee<br>
{<br>
 /**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> int<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«emp_no», type=«integer», nullable=false)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Id<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\GeneratedValue(strategy=«IDENTITY»)<br>
 */<br>
 private $empNo;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> \DateTime<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«birth_date», type=«date», nullable=false)<br>
 */<br>
 private $birthDate;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> string<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«first_name», type=«string», length=14, nullable=false)<br>
 */<br>
 private $firstName;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> string<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«last_name», type=«string», length=16, nullable=false)<br>
 */<br>
 private $lastName;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> string<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«gender», type=«string», length=0, nullable=false)<br>
 */<br>
 private $gender;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> \DateTime<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«hire_date», type=«date», nullable=false)<br>
 */<br>
 private $hireDate;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> \Doctrine\Common\Collections\Collection<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\ManyToMany(targetEntity=«Department», inversedBy=«empNo»)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\JoinTable(name=«dept_manager»,<br>
 * joinColumns={<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\JoinColumn(name=«emp_no», referencedColumnName=«emp_no»)<br>
 * },<br>
 * inverseJoinColumns={<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\JoinColumn(name=«dept_no», referencedColumnName=«dept_no»)<br>
 * }<br>
 * )<br>
 */<br>
 private $deptNo;<br>
<br>
/**<br>
 * Constructor<br>
 */<br>
 public function __construct()<br>
 {<br>
 $this-&gt;deptNo = new \Doctrine\Common\Collections\ArrayCollection();<br>
 }<br>
<br>
}<br>
<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un salaire</font></font></b><div class="spoiler_text">&lt;?php<br>
<br>
namespace App\Entity;<br>
<br>
use Doctrine\ORM\Mapping as ORM;<br>
<br>
/**<br>
 * Salaries<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Table(name=«salaries», indexes={@ORM\Index(name=«IDX_E6EEB84BA2F57F47», columns={«emp_no»})})<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Entity<br>
 */<br>
class Salary<br>
{<br>
 /**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> \DateTime<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«from_date», type=«date», nullable=false)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Id<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\GeneratedValue(strategy=«NONE»)<br>
 */<br>
 private $fromDate;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> int<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«salary», type=«integer», nullable=false)<br>
 */<br>
 private $salary;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> \DateTime<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Column(name=«to_date», type=«date», nullable=false)<br>
 */<br>
 private $toDate;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> Employee<br>
 *<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\Id<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\OneToOne(targetEntity=«Employee»)<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\JoinColumns({<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ORM</a>\JoinColumn(name=«emp_no», referencedColumnName=«emp_no»)<br>
 * })<br>
 */<br>
 private $empNo;<br>
<br>
/**<br>
 * <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">var</a> Employee<br>
 *<br>
 */<br>
 private $employee;<br>
<br>
}<br>
<br>
</div></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat de l'entité</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par un simple, sélectionnons tous les départements de la base et projetons-les sur le département:</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> Query\ResultSetMapping();<font></font>
        $rsm-&gt;addEntityResult(Department::class, <span class="hljs-string">'d'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'d'</span>, <span class="hljs-string">'dept_no'</span>, <span class="hljs-string">'deptNo'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'d'</span>, <span class="hljs-string">'dept_name'</span>, <span class="hljs-string">'deptName'</span>);<font></font>
<font></font>
        $sql = <span class="hljs-string">'SELECT * FROM departments'</span>;<font></font>
<font></font>
        $query = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;createNativeQuery($sql, $rsm);<font></font>
<font></font>
        $result = $query-&gt;getResult();<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addEntityResult</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indique sur quelle classe notre échantillon sera projeté et les méthodes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addFieldResult</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indiquent un mappage entre les exemples de colonnes et les champs d'objet. </font><font style="vertical-align: inherit;">La requête SQL passée à la méthode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">createNativeQuery</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sera transférée dans la base de données sous cette forme et Doctrine ne la modifiera en aucune façon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de rappeler que l'entité a nécessairement un identifiant unique, qui doit être inclus dans fieldResult.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat d'entité jointe</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sélectionnons les services dans lesquels il y a des employés embauchés après le début de 2000, avec ces employés.</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> Query\ResultSetMapping();<font></font>
        $rsm-&gt;addEntityResult(Department::class, <span class="hljs-string">'d'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'d'</span>, <span class="hljs-string">'dept_no'</span>, <span class="hljs-string">'deptNo'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'d'</span>, <span class="hljs-string">'dept_name'</span>, <span class="hljs-string">'deptName'</span>);<font></font>
<font></font>
        $rsm-&gt;addJoinedEntityResult(Employee::class, <span class="hljs-string">'e'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'empNo'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'first_name'</span>, <span class="hljs-string">'firstName'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'last_name'</span>, <span class="hljs-string">'lastName'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'birth_date'</span>, <span class="hljs-string">'birthDate'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'gender'</span>, <span class="hljs-string">'gender'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'e'</span>, <span class="hljs-string">'hire_date'</span>, <span class="hljs-string">'hireDate'</span>);<font></font>
<font></font>
        $sql = <span class="hljs-string">"
        SELECT *
            FROM departments d
            JOIN dept_emp ON d.dept_no = dept_emp.dept_no
            JOIN employees e on dept_emp.emp_no = e.emp_no
        WHERE e.hire_date &gt; DATE ('1999-12-31')
       "</span>;<font></font>
<font></font>
        $query = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;createNativeQuery($sql, $rsm);<font></font>
<font></font>
        $result = $query-&gt;getResult();<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResultSetMappingBuilder</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, travailler directement avec l'objet ResultSetMapping est quelque peu compliqué et rend extrêmement détaillée la description de la comparaison de la sélection et des objets. En partie, Doctrine fournit un outil plus pratique - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ResultSetMappingBuilder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est un wrapper sur RSM et ajoute des méthodes plus pratiques pour travailler avec la cartographie. Par exemple, la méthode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generateSelectClause</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui vous permet de créer un paramètre pour la partie SELECT de la requête avec une description des champs requis pour la sélection. La demande précédente peut être réécrite sous une forme plus simple.</font></font><br>
<br>
<pre><code class="php hljs">        $sql = <span class="hljs-string">"
        SELECT {$rsm-&gt;generateSelectClause()}
            FROM departments d
            JOIN dept_emp ON d.dept_no = dept_emp.dept_no
            JOIN employees e on dept_emp.emp_no = e.emp_no
        WHERE e.hire_date &gt; DATE ('1999-12-31')
       "</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est à noter que si vous ne spécifiez pas tous les champs de l'objet créé, Doctrine renverra un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objet partiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dont l'utilisation peut être justifiée dans certains cas, mais </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leur comportement est dangereux et déconseillé</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Au lieu de cela, ResultSetMappingBuilder vous permet de ne pas spécifier chaque champ de la classe finale, mais d'utiliser des entités décrites via des annotations (configurations yaml, xml). </font><font style="vertical-align: inherit;">Nous réécrivons notre RSM à partir de la demande précédente, en tenant compte de ces méthodes:</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> Query\ResultSetMappingBuilder(<span class="hljs-keyword">$this</span>-&gt;entityManager);<font></font>
        $rsm-&gt;addRootEntityFromClassMetadata(Department::class, <span class="hljs-string">'d'</span>);<font></font>
        $rsm-&gt;addJoinedEntityFromClassMetadata(Employee::class, <span class="hljs-string">'e'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'empNo'</span>);
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat scalaire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une utilisation généralisée de l'entité décrite n'est pas justifiée, elle peut entraîner des problèmes de performances, car Doctrine doit créer de nombreux objets qui ne seront pas pleinement utilisés à l'avenir. </font><font style="vertical-align: inherit;">Dans de tels cas, un outil de mappage de résultats scalaires, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addScalarResult,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><i><font style="vertical-align: inherit;">fourni</font></i><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Choisissez le salaire moyen pour chaque département:</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> ResultSetMappingBuilder(<span class="hljs-keyword">$this</span>-&gt;entityManager);<font></font>
<font></font>
        $rsm-&gt;addScalarResult(<span class="hljs-string">'dept_name'</span>, <span class="hljs-string">'department'</span>, <span class="hljs-string">'string'</span>);<font></font>
        $rsm-&gt;addScalarResult(<span class="hljs-string">'avg_salary'</span>, <span class="hljs-string">'salary'</span>, <span class="hljs-string">'integer'</span>);<font></font>
<font></font>
        $sql = <span class="hljs-string">"
            SELECT d.dept_name, AVG(s.salary) AS avg_salary
            FROM departments d
            JOIN dept_emp de on d.dept_no = de.dept_no
            JOIN employees e on de.emp_no = e.emp_no
            JOIN salaries s on e.emp_no = s.emp_no
            GROUP BY d.dept_name
        "</span>;<font></font>
<font></font>
        $query = <span class="hljs-keyword">$this</span>-&gt;entityManager-&gt;createNativeQuery($sql, $rsm);<font></font>
<font></font>
        $result = $query-&gt;getResult();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le premier argument de la méthode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addScalarResult</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le nom de la colonne dans le jeu de résultats et le second est la clé du tableau de résultats que Doctrine renverra. </font><font style="vertical-align: inherit;">Le troisième paramètre est le type de la valeur de résultat. </font><font style="vertical-align: inherit;">La valeur de retour sera toujours un tableau de tableaux.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cartographie DTO</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais travailler avec des tableaux, en particulier lorsqu'ils ont une structure complexe, n'est pas très pratique. </font><font style="vertical-align: inherit;">Vous devez garder à l'esprit les noms des clés, les types de champs. </font><font style="vertical-align: inherit;">Doctrine DQL a la possibilité d'utiliser des DTO simples dans les résultats de sélection, par exemple:</font></font><br>
<br>
<pre><code class="php hljs">    SELECT <span class="hljs-keyword">NEW</span> DepartmentSalary(d.dept_no, avg_salary) <span class="hljs-keyword">FROM</span> …</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'en est-il de Native Query et RSM? </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doctrine ne fournit pas de capacités documentées pour créer de nouveaux DTO</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais en utilisant la propriété </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newObjectMappings,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous pouvons spécifier les objets dans lesquels nous voulons mapper les résultats de la sélection. </font><font style="vertical-align: inherit;">Contrairement à Entity, ces objets ne seront pas contrôlés par UnitOfWork et ne doivent pas nécessairement se trouver dans les espaces de noms spécifiés dans la configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Complétez RSM de l'exemple précédent:</font></font><br>
<br>
<pre><code class="php hljs">        $rsm-&gt;newObjectMappings[<span class="hljs-string">'dept_name'</span>] = [
            <span class="hljs-string">'className'</span> =&gt; DepartmentSalary::class,
            <span class="hljs-string">'argIndex'</span> =&gt; <span class="hljs-number">0</span>,
            <span class="hljs-string">'objIndex'</span> =&gt; <span class="hljs-number">0</span>,<font></font>
        ];<font></font>
<font></font>
        $rsm-&gt;newObjectMappings[<span class="hljs-string">'avg_salary'</span>] = [
            <span class="hljs-string">'className'</span> =&gt; DepartmentSalary::class,
            <span class="hljs-string">'argIndex'</span> =&gt; <span class="hljs-number">1</span>,
            <span class="hljs-string">'objIndex'</span> =&gt; <span class="hljs-number">0</span>,<font></font>
        ];<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clé dans le tableau du champ newObjectMappings pointe vers la colonne résultante, mais sa valeur est un autre tableau qui décrit l'objet en cours de création. </font><font style="vertical-align: inherit;">La clé </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">className</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> définit le nom de classe du nouvel objet, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">argIndex</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - l'ordre de l'argument dans le constructeur de l'objet, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objIndex</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - l'ordre de l'objet, si nous voulons obtenir plusieurs objets de chaque ligne de la sélection.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat méta</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le méta-résultat est utilisé pour obtenir des métadonnées de colonnes, telles que des clés étrangères ou des colonnes discriminantes. </font><font style="vertical-align: inherit;">Malheureusement, je n'ai pas pu trouver d'exemple basé sur la base de données des employés, je dois donc me limiter à une description et des exemples de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="php hljs">        $rsm = <span class="hljs-keyword">new</span> ResultSetMapping;<font></font>
        $rsm-&gt;addEntityResult(<span class="hljs-string">'User'</span>, <span class="hljs-string">'u'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'u'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'id'</span>);<font></font>
        $rsm-&gt;addFieldResult(<span class="hljs-string">'u'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'name'</span>);<font></font>
        $rsm-&gt;addMetaResult(<span class="hljs-string">'u'</span>, <span class="hljs-string">'address_id'</span>, <span class="hljs-string">'address_id'</span>);<font></font>
<font></font>
        $query = <span class="hljs-keyword">$this</span>-&gt;_em-&gt;createNativeQuery(<span class="hljs-string">'SELECT id, name, address_id FROM users WHERE name = ?'</span>, $rsm);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, avec la méthode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">addMetaResult,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous disons à Doctine que la table des utilisateurs a une clé étrangère sur les adresses, mais au lieu de charger l'association en mémoire (chargement ardent), nous créons un proxy-object qui stocke l'identifiant d'entité, et lorsqu'il est accédé, il se charge elle de la base de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les bases de données relationnelles classiques n'offrent pas de mécanismes d'héritage de table, tandis que l'héritage est répandu dans le modèle objet. </font><font style="vertical-align: inherit;">Le résultat de notre sélection peut être projeté sur la hiérarchie des classes, selon un attribut, qui est la valeur de la colonne &lt;discriminator_column&gt; dans la sélection résultante. </font><font style="vertical-align: inherit;">Dans ce cas, nous pouvons dire à RSM quelle colonne Doctrine doit déterminer la classe instanciée en utilisant la méthode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setDiscriminatorColumn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La doctrine est très riche en diverses fonctionnalités, y compris celles que tous les développeurs ne connaissent pas. </font><font style="vertical-align: inherit;">Dans cet article, j'ai essayé d'introduire une compréhension du fonctionnement de l'un des composants clés d'ORM - ResultSetMapping en combinaison avec Native Query. </font><font style="vertical-align: inherit;">L'utilisation de requêtes vraiment complexes et spécifiques à la plate-forme, tout en maintenant la disponibilité et l'intelligibilité des exemples, serait une tâche difficile, car l'accent est mis sur la compréhension du travail de ResultSetMapping. </font><font style="vertical-align: inherit;">Après cela, vous pouvez l'utiliser dans des requêtes vraiment complexes pour vos bases de données.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496154/index.html">Automatisation du service client: une solution de bout en bout de DeepPavlov</a></li>
<li><a href="../fr496156/index.html">Comment les systèmes d'analyse du trafic détectent les tactiques des pirates par MITRE ATT & CK, partie 3</a></li>
<li><a href="../fr496160/index.html">Nous étudions le moteur VoIP Mediastreamer2. Partie 5</a></li>
<li><a href="../fr496162/index.html">Terraform, référentiels mono et conformité en tant que code</a></li>
<li><a href="../fr496164/index.html">Pendant la crise, j'ai perdu mon emploi et maintenant j'ai peur d'écrire du code intelligent pour ne pas effrayer les derniers postes vacants</a></li>
<li><a href="../fr496170/index.html">Nous sommes condamnés # 1 // Udalenka en crise et mort d'originalité</a></li>
<li><a href="../fr496174/index.html">Augmentation de la demande d'analyses, d'équipes de produits, d'Amazon, d'Israël, de Singapour, du travail à distance, etc. - beaucoup discuté.</a></li>
<li><a href="../fr496176/index.html">Grande conférence virtuelle: expérience du monde réel dans la protection des données des entreprises numériques modernes</a></li>
<li><a href="../fr496178/index.html">Swift 5.2. Aperçu de toutes les modifications</a></li>
<li><a href="../fr496180/index.html">Prenez soin de l'ombre des jeunes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>