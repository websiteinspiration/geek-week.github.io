<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥¡ ğŸ‘©ğŸ½â€ğŸ³ ğŸ§—ğŸ¾ Programer tukang ledeng, atau kisah satu kebocoran dan kesulitan mengatasinya ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘¨ğŸ½ ğŸŒ â—€ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Itu Selasa, 25 Februari. Rilis versi sulit pada hari Sabtu, 22 Februari, sudah di masa lalu. Tampaknya semua yang terburuk ada di belakang, dan tidak ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Programer tukang ledeng, atau kisah satu kebocoran dan kesulitan mengatasinya</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498150/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itu Selasa, 25 Februari. Rilis versi sulit pada hari Sabtu, 22 Februari, sudah di masa lalu. Tampaknya semua yang terburuk ada di belakang, dan tidak ada yang menandakan masalah. Tetapi semuanya berubah pada satu waktu ketika kesalahan pemantauan muncul tentang kebocoran memori pada proses koordinator layanan kontrol akses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darimana? Perubahan besar terakhir dalam basis kode koordinator ada di versi sebelumnya lebih dari dua bulan lalu, dan setelah itu tidak ada yang luar biasa terjadi pada memori. Tetapi, sayangnya, jadwal pemantauannya bersikeras - ingatan koordinator itu mulai bocor di suatu tempat, genangan air besar dipamerkan di lantai layanan, yang berarti bahwa tim pipa ledeng punya banyak pekerjaan yang harus dilakukan.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/sz/a5/nc/sza5ncpnbgd9jxdzckmeu1bztsi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama kita membuat penyimpangan kecil. </font><font style="vertical-align: inherit;">Antara lain, VLSI memungkinkan Anda untuk melacak jam kerja dan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memantau akses</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan model wajah, sidik jari atau kartu akses. </font><font style="vertical-align: inherit;">Pada saat yang sama, VLSI berkomunikasi dengan pengontrol titik akhir (kunci, pintu putar, terminal akses, dll.). </font><font style="vertical-align: inherit;">Layanan terpisah berkomunikasi dengan perangkat. </font><font style="vertical-align: inherit;">Ini pasif, berinteraksi dengan perangkat kontrol akses berdasarkan protokol mereka sendiri diimplementasikan melalui HTTP (S). </font><font style="vertical-align: inherit;">Ini ditulis berdasarkan tumpukan standar untuk layanan di perusahaan kami: Database PostgreSQL, Python 3 digunakan untuk logika bisnis, diperluas dengan metode C / C ++ dari platform kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Node layanan web tipikal terdiri dari proses berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitor adalah proses root.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Koordinator adalah proses anak dari monitor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proses kerja.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitor adalah proses layanan web pertama. </font><font style="vertical-align: inherit;">Tugasnya adalah memanggil fork (), memulai proses koordinator anak dan memantau pekerjaannya. </font><font style="vertical-align: inherit;">Koordinator adalah proses utama dari layanan web, dialah yang menerima permintaan dari perangkat eksternal, mengirim tanggapan dan menyeimbangkan beban. </font><font style="vertical-align: inherit;">Koordinator mengirimkan permintaan ke proses kerja untuk dieksekusi, mereka mengeksekusinya, mentransfer respons ke memori bersama dan memberi tahu koordinator bahwa tugas telah selesai dan Anda dapat mengambil hasilnya.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Siapa yang harus disalahkan dan apa yang harus dilakukan?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, koordinator layanan kontrol akses berbeda dari koordinator layanan lain di perusahaan kami dengan keberadaan server web. Koordinator layanan lain bekerja tanpa kebocoran, jadi masalahnya harus dicari dalam konfigurasi kami. Lebih buruk lagi, pada tes berdiri, versi baru ada untuk waktu yang lama, dan tidak ada yang memperhatikan masalah memori pada mereka. Mereka mulai melihat lebih dekat dan menemukan bahwa ingatan mengalir hanya pada salah satu stan, dan itupun dengan berbagai keberhasilan - yang berarti bahwa masalahnya masih belum begitu mudah direproduksi.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c_/lg/_k/c_lg_kswgcknpdyc8k2h7bd22d8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang harus dilakukan? Bagaimana menemukan alasannya? Pertama-tama, kami mengambil dump memori dan mengirimkannya ke spesialis dari platform untuk dianalisis. Hasilnya - tidak ada apa-apa di dump: tidak ada alasan, tidak ada petunjuk ke arah mana untuk melihat lebih jauh. Kami memeriksa perubahan dalam kode koordinator dari versi sebelumnya - tiba-tiba kami melakukan beberapa pengeditan yang mengerikan, tetapi tidak segera memahami hal ini? Tapi tidak - hanya beberapa komentar yang ditambahkan ke kode koordinator, tetapi beberapa metode dipindahkan ke file baru - secara umum, tidak ada yang kriminal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mereka mulai melihat ke arah kolega kami - pengembang inti dari layanan kami. Mereka dengan yakin menyangkal kemungkinan keterlibatan dalam kemalangan kita, tetapi menawarkan untuk menanamkan pemantauan tracemalloc dalam layanan. Tidak lama setelah selesai, pada perbaikan terbaru kami menyelesaikan layanan, dengan cepat menguji, melepaskan ke pertempuran.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan apa yang kita lihat? Sekarang ingatan kita mengalir tidak hanya dengan cepat, tetapi juga sangat cepat - pertumbuhan telah menjadi eksponensial. Kami mengaitkan puncak pertama dengan kekuatan jahat dan faktor-faktor yang menyertainya, tetapi puncak kedua, beberapa jam setelah yang pertama, memperjelas bahwa butuh waktu terlalu lama untuk menunggu perbaikan terbaru berikutnya dilepaskan dengan perilaku darurat layanan tersebut. Oleh karena itu, kami mengambil hasil tracemalloc dan menambal layanan, memutar kembali pengeditan dengan pemantauan untuk mengembalikan setidaknya ke pertumbuhan linear.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zl/yh/w7/zlyhw7-3oq-9wxxwkvwvsl8gd08.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampaknya kami memiliki hasil tracemalloc yang bekerja pada memori yang dialokasikan dalam Python, sekarang kita akan melihat mereka dan menemukan penyebab kebocoran, tetapi tidak ada di sana - data yang dikumpulkan tidak memiliki puncak 5,5 GB yang kami lihat pada grafik pemantauan. Memori maksimum yang digunakan hanya 250MB, dan bahkan traceMalloc memakannya 130MB. Ini sebagian dapat dijelaskan - tracemalloc memungkinkan Anda untuk melihat dinamika memori dalam Python, tetapi ia tidak tahu tentang alokasi memori dalam paket C dan C ++ yang diimplementasikan oleh platform kami. Dalam data yang diperoleh, itu tidak mungkin untuk menemukan sesuatu yang menarik, memori dialokasikan dalam volume yang dapat diterima untuk benda-benda biasa seperti aliran, string dan kamus - secara umum, tidak ada yang mencurigakan. Kemudian kami memutuskan untuk menghapus semua yang tidak perlu dari data, hanya menyisakan total konsumsi memori dan waktu, dan memvisualisasikannya.Meskipun visualisasi tidak membantu menjawab pertanyaan "apa yang terjadi" dan "mengapa", dengan bantuannya kami melihat korelasi dengan data dari pemantauan - yang berarti bahwa kami pasti memiliki masalah di suatu tempat, dan kami perlu mencarinya.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yr/es/gp/yresgpdyry0i_dr88dbtswqr8k8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat itu, tim tukang ledeng kami kehabisan ide di mana mencari kebocoran. Untungnya, burung itu bernyanyi kepada kami bahwa satu perubahan besar dari platform memang terjadi - versi Python berubah dari 3,4 menjadi 3,7, dan ini adalah bidang pencarian yang sangat besar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memutuskan untuk mencari masalah yang berkaitan dengan kebocoran memori di Python 3.7 di Internet, karena pasti seseorang sudah menjumpai perilaku ini. Namun, Python 3.7 telah diterbitkan sejak lama, kami beralih hanya dengan pembaruan saat ini. Untungnya, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jawaban</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atas pertanyaan kami ditemukan dengan cepat, dan ada juga </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">masalah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarik-permintaan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk memperbaiki masalah, dan dia sendiri dalam perubahan yang dibuat oleh pengembang Python. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang terjadi?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dimulai dengan versi 3.7, perilaku kelas ThreadingMixIn telah berubah, dari mana kami mewarisi dari server web kami untuk memproses setiap permintaan dalam utas terpisah. Di kelas ThreadingMixIn, mereka menambahkan entri semua utas yang dibuat ke dalam array. Karena perubahan tersebut, instance kelas yang menangani koneksi perangkat tidak dibebaskan setelah selesai, dan pengumpul sampah di Python tidak dapat menghapus memori dari utas yang dihabiskan. Inilah yang menyebabkan pertumbuhan linier dari memori yang dialokasikan dalam proporsi langsung ke jumlah permintaan ke server kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini dia, kode berbahaya dari modul Python dengan lubang besar (kode dalam Python 3.5 ditampilkan di sebelah kiri sebelum perubahan, di sebelah kanan - di 3.7, setelah):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/pp/87/0mpp87t9snuuoadbahwaoxw2jj8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengetahui alasannya, kami dengan mudah menghilangkan kebocoran: di kelas pewaris kami, kami mengubah nilai bendera yang mengembalikan perilaku lama, dan hanya itu - kemenangan! </font><font style="vertical-align: inherit;">Streaming dibuat seperti sebelumnya, tanpa menulis ke variabel kelas, tetapi kami mengamati gambar yang menyenangkan pada grafik pemantauan - kebocoran telah diperbaiki! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1o/ja/ss/1ojassz9esw-378romz5kexysde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sangat menyenangkan untuk menulis tentang ini setelah kemenangan. </font><font style="vertical-align: inherit;">Kami mungkin bukan yang pertama kali mengalami masalah ini setelah beralih ke Python 3.7, tetapi kemungkinan besar bukan yang terakhir. </font><font style="vertical-align: inherit;">Bagi kami sendiri, kami menyimpulkan bahwa kami membutuhkan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ambil pendekatan yang lebih serius untuk menilai konsekuensi yang mungkin dari perubahan besar, terutama jika keputusan lain yang diterapkan bergantung pada kita.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika terjadi perubahan global pada platform, seperti, misalnya, mengubah versi Python, periksa kode Anda untuk kemungkinan masalah.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menanggapi setiap perubahan yang mencurigakan dalam jadwal pemantauan tidak hanya layanan tempur, tetapi juga yang menguji. </font><font style="vertical-align: inherit;">Meskipun pengumpul sampah saat ini, ada kebocoran memori di Python juga.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada kebutuhan untuk berhati-hati dengan alat analisis memori seperti tracemalloc, karena menggunakannya secara salah dapat memperburuk keadaan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda harus siap menghadapi kenyataan bahwa deteksi kebocoran memori akan membutuhkan kesabaran, ketekunan, dan sedikit pekerjaan detektif.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baiklah, saya ingin mengucapkan terima kasih kepada semua orang yang telah membantu mengatasi pekerjaan pipa leding darurat dan sekali lagi kembali ke kapasitas kerja semula untuk layanan kami!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id498136/index.html">Percakapan dengan Polina Gurtova tentang masa depan dan sekarang dari Frontend. Penyelenggara DUMP 2020 mengajukan beberapa pertanyaan penting.</a></li>
<li><a href="../id498138/index.html">Kehidupan setelah studi sarjana: bagaimana saya memutuskan apa yang harus dilakukan selanjutnya ketika pendidikan tinggi dan pekerjaan sudah ada</a></li>
<li><a href="../id498140/index.html">Gandakan ini. Webinar Apache Ignite dan GridGain</a></li>
<li><a href="../id498144/index.html">BERT Pertama Anda: Panduan Bergambar</a></li>
<li><a href="../id498146/index.html">Enam tren keamanan cerdas yang harus diwaspadai</a></li>
<li><a href="../id498154/index.html">Kalender acara TI gratis online dari 20 hingga 26 April</a></li>
<li><a href="../id498156/index.html">F #, morfologi gambar biner</a></li>
<li><a href="../id498158/index.html">Remote Marathon Week 1: Workplace</a></li>
<li><a href="../id498160/index.html">GlusterFS sebagai penyimpanan eksternal untuk Kubernetes</a></li>
<li><a href="../id498162/index.html">Kami mengundang Anda ke magang TI di Alfa Bank</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>