<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôåüèª üñïüèΩ ü§∞üèº Authentification dans .NET Core gRpc avec JWT üå∫ üåä üòî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je parlerai des fonctionnalit√©s de l'authentification API dans les services gRpc utilisant JWT. Je suppose que vous connaissez les e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Authentification dans .NET Core gRpc avec JWT</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499588/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans cet article, je parlerai des fonctionnalit√©s de l'authentification API dans les services gRpc utilisant JWT. </font><font style="vertical-align: inherit;">Je suppose que vous connaissez les en-t√™tes JWT et HTTP qui les utilisent dans .NET Core WebAPI, donc je ne discuterai pas de ces d√©tails. </font><font style="vertical-align: inherit;">Lorsque j'ai essay√© d'impl√©menter l'authentification dans gRpc, je suis tomb√© sur le fait que la plupart des exemples sont √©crits √† l'aide d'applications console. </font><font style="vertical-align: inherit;">C'est trop loin de la r√©alit√© dans laquelle vivent, √† mon avis, les d√©veloppeurs. </font><font style="vertical-align: inherit;">Par exemple, je ne souhaite pas cr√©er de cha√Æne √† chaque fois que je souhaite appeler une m√©thode de service. </font><font style="vertical-align: inherit;">Je ne veux pas non plus me soucier d'envoyer un jeton et des informations utilisateur √† chaque demande. </font><font style="vertical-align: inherit;">Au lieu de cela, je veux avoir un niveau d'infrastructure qui s'occupera de tout cela pour moi. </font><font style="vertical-align: inherit;">Si ce sujet vous int√©resse, il y en aura plus sous la coupe. </font><font style="vertical-align: inherit;">Tous les exemples de cet article sont valides pour .NET Core 3.1.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple utilis√©</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de plonger dans le sujet, il convient de d√©crire l'exemple utilis√© dans l'article. L'ensemble de la solution se compose de deux applications: un site Web et un service gRpc (ci-apr√®s API). Les deux sont √©crits en .NET Core 3.1. L'utilisateur peut se connecter et voir certaines donn√©es s'il y est autoris√©. Le site Web ne stocke pas de donn√©es utilisateur et s'appuie sur une API dans le processus d'authentification. Pour communiquer avec le service gRpc, le site Web doit avoir un jeton JWT valide, mais ce jeton ne s'applique pas √† l'authentification des utilisateurs dans l'application. L'application Web utilise des cookies de son c√¥t√©. Pour que l'API sache quel utilisateur fait la demande au service, des informations √† ce sujet sont envoy√©es avec le jeton JWT, mais pas dans le jeton lui-m√™me, mais avec un en-t√™te HTTP suppl√©mentaire. La figure ci-dessous montre un exemple de sch√©ma du syst√®me dont je viens de parler:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/1-/a_/vn/1-a_vno-j3cfyv8ps49vdd_jv6m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, je dois noter que lorsque j'ai fait cet exemple, je n'avais pas pour objectif de mettre en ≈ìuvre la m√©thode d'authentification la plus correcte pour l'API. </font><font style="vertical-align: inherit;">Si vous souhaitez voir certaines des meilleures pratiques, consultez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la sp√©cification OpenID Connect</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Bien que, parfois, il me semble que la solution la plus correcte peut √™tre redondante par rapport √† ce qui peut r√©soudre le probl√®me et √©conomiser du temps et de l'argent.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Activer l'authentification JWT dans le service gRpc</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La configuration du service gRpc n'est pas diff√©rente de la configuration habituelle requise par l'API .NET Core. </font><font style="vertical-align: inherit;">Un avantage suppl√©mentaire est qu'il n'est pas diff√©rent pour les protocoles HTTP et HTTPS. </font><font style="vertical-align: inherit;">En bref, vous devez ajouter des services d'authentification et d'autorisation standard, ainsi que des middlewere dans le fichier </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Startup.cs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'endroit o√π vous ajoutez le middleware est important: vous devez l'ajouter exactement entre le routage et les points ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il manque du code</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">...</span>)</span> {<font></font>
    app.UseRouting();<font></font>
    <font></font>
    app.UseAuthentication();<font></font>
    app.UseAuthorization();<font></font>
    <font></font>
    app.UseEndpoints(...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais l'endroit o√π les services sont enregistr√©s n'est pas si important, ajoutez simplement la m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigureServices ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† la m√©thode </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mais ici, vous devez configurer la v√©rification du jeton JWT. </font><font style="vertical-align: inherit;">Il peut √™tre d√©fini ici, mais je recommande de le retirer dans une classe distincte. </font><font style="vertical-align: inherit;">Ainsi, le code peut ressembler √† ceci:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">...</span>)</span> {<font></font>
    services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)<font></font>
        .AddJwtBearer(o =&gt; {<font></font>
            <span class="hljs-keyword">var</span> validator = <span class="hljs-keyword">new</span> JwtTokenValidator(...);<font></font>
            o.SecurityTokenValidators.Add(validator);<font></font>
        });<font></font>
    services.AddAuthorization();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JwtTokenValidator</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est celle o√π vous d√©finirez la logique de validation. </font><font style="vertical-align: inherit;">Vous devez cr√©er la classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TokenValidationParameters</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec les param√®tres corrects et elle fera le reste du travail de validation JWT. </font><font style="vertical-align: inherit;">En prime, vous pouvez ajouter une couche de s√©curit√© suppl√©mentaire ici. </font><font style="vertical-align: inherit;">Il peut √™tre n√©cessaire car JWT est un format bien connu. </font><font style="vertical-align: inherit;">Si vous avez JWT, vous pouvez aller sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jwt.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et voir quelques informations. </font><font style="vertical-align: inherit;">Je pr√©f√®re ajouter un chiffrement suppl√©mentaire au JWT, ce qui rend le d√©chiffrement plus difficile. </font><font style="vertical-align: inherit;">Voici √† quoi pourrait ressembler un validateur:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">JwtTokenValidator</span> : <span class="hljs-title">ISecurityTokenValidator</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">CanReadToken</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> securityToken</span>)</span> =&gt; <span class="hljs-literal">true</span>;<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClaimsPrincipal <span class="hljs-title">ValidateToken</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> securityToken, TokenValidationParameters validationParameters, <span class="hljs-keyword">out</span> SecurityToken validatedToken</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">new</span> JwtSecurityTokenHandler();
        <span class="hljs-keyword">var</span> tokenValidationParameters = <span class="hljs-keyword">new</span> TokenValidationParameters<font></font>
        {<font></font>
            ValidateIssuer = <span class="hljs-literal">true</span>,<font></font>
            ValidateAudience = <span class="hljs-literal">true</span>,<font></font>
            ValidateLifetime = <span class="hljs-literal">true</span>,<font></font>
            ValidateIssuerSigningKey = <span class="hljs-literal">true</span>,<font></font>
            ValidIssuer = <span class="hljs-string">"your string"</span>,<font></font>
            ValidAudience = <span class="hljs-string">"your string"</span>,<font></font>
            IssuerSigningKey = <span class="hljs-keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(<span class="hljs-string">"your secrete code"</span>))<font></font>
        };<font></font>
        <font></font>
        <span class="hljs-keyword">var</span> claimsPrincipal = handler.ValidateToken(token, tokenValidationParameters, <span class="hljs-keyword">out</span> validatedToken);
        <span class="hljs-keyword">return</span> claimsPrincipal;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> CanValidateToken { <span class="hljs-keyword">get</span>; } = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> MaximumTokenSizeInBytes { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">int</span>.MaxValue;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et c'est tout ce dont l'API a besoin. </font><font style="vertical-align: inherit;">L'historique de configuration du client est l√©g√®rement plus long et l√©g√®rement diff√©rent selon le protocole HTTP ou HTTPS s√©lectionn√©.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi d'en-t√™tes HTTP avec chaque demande au service gRpc</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous le connaissez peut-√™tre dans la documentation officielle, que vous ne pouvez en fait utiliser nulle part sauf dans un programme de console stupide. Par exemple, vous pouvez le voir </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> channel = GrpcChannel.ForAddress(<span class="hljs-string">"https://localhost:5001"</span>);
<span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> Greeter.GreeterClient(channel);
<span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> client.SayHelloAsync(
    <span class="hljs-keyword">new</span> HelloRequest { Name = <span class="hljs-string">"World"</span> });<font></font>
Console.WriteLine(response.Message);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'utiliser dans un vrai projet, nous avons encore besoin d'avoir une configuration centralis√©e et DI, qui ne sont presque pas consid√©r√©s. Voici ce que tu dois faire. Tout d'abord, nous devons ajouter les packages NuGet n√©cessaires √† notre projet. </font><font style="vertical-align: inherit;">
Le package </font><i><font style="vertical-align: inherit;">Grpc.Tools</font></i><font style="vertical-align: inherit;"> vous aidera √† cr√©er des prototypes lors de la construction d'un projet, et </font><i><font style="vertical-align: inherit;">Grpc.Net.ClientFactory</font></i><font style="vertical-align: inherit;"> vous aidera √† configurer DI. </font><font style="vertical-align: inherit;">
Lorsque vous travaillez avec gRpc, si vous devez impl√©menter votre traitement quelque part au milieu de la cha√Æne de requ√™te-r√©ponse, vous devez utiliser des classes h√©rit√©es d' </font><i><font style="vertical-align: inherit;">Interceptor</font></i><font style="vertical-align: inherit;"> , qui fait partie de </font><i><font style="vertical-align: inherit;">gRpc.Core</font></i><font style="vertical-align: inherit;"> . Si vous devez acc√©der √† </font><i><font style="vertical-align: inherit;">HttpContext.User.Identity au</font></i><font style="vertical-align: inherit;"> sein de vos services, vous pouvez ajouter l'interface </font><i><font style="vertical-align: inherit;">IHttpContextAccessor</font></i></font><br>
<br>
<code>dotnet add package Grpc.Net.Client<br>
dotnet add package Google.Protobuf<br>
dotnet add package Grpc.Tools<br>
dotnet add package Grpc.Net.ClientFactory<br>
</code><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† votre service (cela n√©cessite une inscription suppl√©mentaire dans les services). </font><font style="vertical-align: inherit;">Vous devez ajouter ce qui suit √† votre fichier Startup.cs.</font></font><br>
<br>
<pre><code class="cs hljs">services.AddTransient&lt;AuthHeadersInterceptor&gt;();<font></font>
services.AddHttpContextAccessor();<font></font>
<font></font>
<span class="hljs-keyword">var</span> httpClientBuilder = services.AddGrpcClient&lt;MygRpcService.MygRpcServiceClient&gt;(o =&gt; { o.Address = <span class="hljs-keyword">new</span> Uri(<span class="hljs-string">"grpc-endpoint-url"</span>); });<font></font>
httpClientBuilder.AddInterceptor&lt;AuthHeadersInterceptor&gt;();              <font></font>
httpClientBuilder.ConfigureChannel(o =&gt; o.Credentials = ChannelCredentials.Insecure);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AuthHeadersInterceptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est notre propre classe, d√©riv√©e de la classe </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interceptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il utilise IHttpContextAccessor et l'enregistrement </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.AddHttpContextAccessor ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous permet de le faire.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonctions de configuration pour HTTP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez remarquer la configuration suivante:</font></font><br>
<br>
<pre><code class="cs hljs">httpClientBuilder.ConfigureChannel(o =&gt; o.Credentials = ChannelCredentials.Insecure);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est n√©cessaire pour travailler via HTTP, mais ce n'est pas suffisant. </font><font style="vertical-align: inherit;">Vous devez √©galement exclure cette ligne de la m√©thode Configure ().</font></font><br>
<br>
<pre><code class="cs hljs">app.UseHttpsRedirection();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et encore, vous devez </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">danser pour</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©tablir un r√©glage sp√©cial avant de cr√©er un canal gRpc. </font><font style="vertical-align: inherit;">Cela ne peut √™tre effectu√© qu'une seule fois lors du lancement de l'application. </font><font style="vertical-align: inherit;">Par cons√©quent, je l'ai ajout√© √† peu pr√®s au m√™me endroit que la ligne supprim√©e mentionn√©e ci-dessus. </font><font style="vertical-align: inherit;">Cela ne devrait √™tre appel√© que pour HTTP.</font></font><br>
<br>
<pre><code class="cs hljs">AppContext.SetSwitch(<span class="hljs-string">"System.Net.Http.SocketsHttpHandler.Http2UnencryptedSupport"</span>, <span class="hljs-literal">true</span>);
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caract√©ristiques de configuration pour HTTPS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a quelques difficult√©s √† travailler avec SSL sur Windows et Linux. </font><font style="vertical-align: inherit;">Il peut arriver que vous d√©veloppiez sur un ordinateur Windows et d√©ployiez sur Docker / Kubernetes √† l'aide d'images bas√©es sur Linux. </font><font style="vertical-align: inherit;">Dans ce cas, la configuration n'est pas aussi simple que celle d√©crite dans de nombreux articles. </font><font style="vertical-align: inherit;">Je d√©crirai cette configuration dans un autre article, et ici je ne toucherai qu'au code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devons reconfigurer le canal gRpc pour utiliser les informations d'identification SSL. </font><font style="vertical-align: inherit;">Si vous d√©ployez sur Docker et cr√©ez des images bas√©es sur Linux, vous devrez peut-√™tre √©galement configurer HttpClient pour autoriser les certificats non valides. </font><font style="vertical-align: inherit;">HttpClient est cr√©√© pour chaque canal.</font></font><br>
<br>
<pre><code class="cs hljs">httpClientBuilder.ConfigureChannel(o =&gt;<font></font>
{<font></font>
    <span class="hljs-comment">// add SSL credentials</span>
    o.Credentials = <span class="hljs-keyword">new</span> SslCredentials();
    <span class="hljs-comment">// allow invalid/untrusted certificates</span>
    <span class="hljs-keyword">var</span> httpClientHandler = <span class="hljs-keyword">new</span> HttpClientHandler<font></font>
    {<font></font>
        ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator<font></font>
    };<font></font>
    <span class="hljs-keyword">var</span> httpClient = <span class="hljs-keyword">new</span> HttpClient(httpClientHandler);<font></font>
    o.HttpClient = httpClient;<font></font>
});<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout d'en-t√™tes HTTP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les en-t√™tes sont ajout√©s dans la classe d'intercepteur (successeur d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interceptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">gRpc utilise le concept de m√©tadonn√©es, qui est envoy√© avec les demandes comme en-t√™tes. </font><font style="vertical-align: inherit;">La classe d'intercepteur doit ajouter des m√©tadonn√©es pour le contexte d'appel.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AuthHeadersInterceptor</span> : <span class="hljs-title">Interceptor</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AuthHeadersInterceptor</span>(<span class="hljs-params">IHttpContextAccessor httpContextAccessor</span>)</span><font></font>
    {<font></font>
        _httpContextAccessor = httpContextAccessor;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> AsyncUnaryCall&lt;TResponse&gt; AsyncUnaryCall&lt;TRequest, TResponse&gt;(TRequest request, ClientInterceptorContext&lt;TRequest, TResponse&gt; context, AsyncUnaryCallContinuation&lt;TRequest, TResponse&gt; continuation)<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> metadata = <span class="hljs-keyword">new</span> Metadata<font></font>
        {<font></font>
            {HttpHeaderNames.Authorization, <span class="hljs-string">$"Bearer &lt;JWT_TOKEN&gt;"</span>}<font></font>
        };<font></font>
        <span class="hljs-keyword">var</span> userIdentity = _httpContextAccessor.HttpContext.User.Identity;
        <span class="hljs-keyword">if</span> (userIdentity.IsAuthenticated)<font></font>
        {<font></font>
            metadata.Add(HttpHeaderNames.User, userIdentity.Name);<font></font>
        }<font></font>
        <span class="hljs-keyword">var</span> callOption = context.Options.WithHeaders(metadata);<font></font>
        context = <span class="hljs-keyword">new</span> ClientInterceptorContext&lt;TRequest, TResponse&gt;(context.Method, context.Host, callOption);<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.AsyncUnaryCall(request, context, continuation);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le sc√©nario, lorsque vous appelez simplement le service gRpc, vous devez uniquement remplacer la m√©thode </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncUnaryCall</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Bien s√ªr, le jeton JWT peut √™tre enregistr√© dans des fichiers de configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et c'est tout. </font><font style="vertical-align: inherit;">Plus tard, j'ajouterai un lien vers le code avec un exemple simple du cas d'utilisation d√©crit. </font><font style="vertical-align: inherit;">Si vous avez d'autres questions, √©crivez-moi. </font><font style="vertical-align: inherit;">Je vais essayer de r√©pondre.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499576/index.html">Comment travailler avec des mots cl√©s √† exclure dans Yandex.Direct et Google Ads [et automatiser le processus]</a></li>
<li><a href="../fr499578/index.html">R√©seau DOS utilisant la pile mTCP</a></li>
<li><a href="../fr499582/index.html">Mod√®le Predator-Prey sur Node.js</a></li>
<li><a href="../fr499584/index.html">Moniteur tactile industriel FPM-215W</a></li>
<li><a href="../fr499586/index.html">Comment penser la navigation dans les applications mobiles</a></li>
<li><a href="../fr499592/index.html">AI: Compl√©ter le monde de demain</a></li>
<li><a href="../fr499594/index.html">Comment limiter la fr√©quence des demandes dans HAProxy: instructions pas √† pas</a></li>
<li><a href="../fr499598/index.html">Et nous irons au nord! Sera-t-il possible d'√©conomiser sur le refroidissement des centres de donn√©es en raison des conditions m√©t√©orologiques?</a></li>
<li><a href="../fr499600/index.html">Comment travailler ensemble, travailler s√©par√©ment</a></li>
<li><a href="../fr499602/index.html">D√©placer une conf√©rence en ligne: exp√©rience du sommet InnerSource Commons</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>