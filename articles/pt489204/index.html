<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüé§ üé∫ üß¶ Uma an√°lise interna da confiabilidade dos servi√ßos do Facebook üåì üë©üèæ‚Äçü§ù‚Äçüë®üèº üôã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quando o Facebook ‚Äúmente‚Äù, as pessoas pensam que √© por causa de hackers ou ataques DDoS, mas n√£o √©. Todas as "quedas" nos √∫ltimos anos foram causadas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Uma an√°lise interna da confiabilidade dos servi√ßos do Facebook</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/489204/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando o Facebook ‚Äúmente‚Äù, as pessoas pensam que √© por causa de hackers ou ataques DDoS, mas n√£o √©. Todas as "quedas" nos √∫ltimos anos foram causadas por mudan√ßas ou avarias internas. Para ensinar aos novos funcion√°rios a n√£o quebrar o Facebook com exemplos, todos os principais incidentes recebem nomes, por exemplo, "Ligue para a pol√≠cia" ou "CAPSLOCK". O primeiro foi nomeado porque, quando um dia a rede social caiu, os usu√°rios ligaram para a pol√≠cia de Los Angeles e pediram para corrigi-lo, e o xerife em desespero no Twitter pediu para n√£o incomod√°-los com isso. Durante o segundo incidente nas m√°quinas de cache, a interface de rede caiu e n√£o subiu, e todas as m√°quinas foram reiniciadas manualmente. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elina Lobanova</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabalha no Facebook h√° 4 anos na equipe da Web Foundation. Os membros da equipe s√£o chamados de engenheiros de produ√ß√£o e monitoram a confiabilidade e o desempenho de todo o back-end, publicam o Facebook quando ele est√° ativo, escrevem monitoramento e automa√ß√£o para facilitar a vida de si e dos outros. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jf/9x/nj/jf9xnjbzmqg3ufk-km_bqmgkrya.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um artigo baseado no relat√≥rio da Elina no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++ 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">mostraremos</font></a><font style="vertical-align: inherit;"> como os engenheiros de produ√ß√£o monitoram o back-end do Facebook, quais ferramentas eles usam, o que causa grandes falhas e como lidar com eles.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/wuV5DLiUuaI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meu nome √© Elina, h√° quase cinco anos, fui chamado no Facebook como desenvolvedor comum, onde encontrei sistemas realmente muito carregados - isso n√£o √© ensinado em institutos. </font><font style="vertical-align: inherit;">A empresa n√£o contrata uma equipe, mas um escrit√≥rio, ent√£o cheguei a Londres, escolhi uma equipe que monitora o trabalho do facebook.com e estava entre os engenheiros de produ√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Engenheiros de Produ√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar, vou lhe dizer o que estamos fazendo e por que somos chamados engenheiros de produ√ß√£o, e n√£o o SRE como o Google, por exemplo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2009. SRE</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O modelo padr√£o que ainda √© usado em muitas empresas √© "desenvolvedores - testadores - opera√ß√£o". </font><font style="vertical-align: inherit;">Muitas vezes eles est√£o divididos: sentam-se em andares diferentes, √†s vezes at√© em pa√≠ses diferentes, e n√£o se comunicam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em 2009, o Facebook j√° possu√≠a SRE. </font><font style="vertical-align: inherit;">No Google, o SRE come√ßou mais cedo, eles sabem como obter o DevOps e o escreveram em seu livro ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Site Reliability Engineering</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6h/o6/1l/6ho61luejwigg_bb6v_7441tlty.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No Facebook em 2009, n√£o havia nada assim. </font><font style="vertical-align: inherit;">Fomos chamados de SRE, mas fizemos o mesmo trabalho que Ops no resto do mundo: trabalho manual, sem automa√ß√£o, implanta√ß√£o de todos os servi√ßos com as m√£os, monitorando de alguma forma, ligando para tudo, um conjunto de scripts de shell.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2010. SRO e AppOps</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo isso n√£o foi dimensionado, porque o n√∫mero de usu√°rios naquela √©poca estava crescendo 3 vezes por ano e o n√∫mero de servi√ßos cresceu de acordo. </font><font style="vertical-align: inherit;">Em 2010, a decis√£o decidida Ops foi dividida em dois grupos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro grupo √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SRO</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , onde "O" √© "opera√ß√µes", envolvido no desenvolvimento, automa√ß√£o e monitoramento do site. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo grupo √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AppOps</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , eles foram integrados em equipes, cada uma para grandes servi√ßos. </font><font style="vertical-align: inherit;">O AppOps j√° est√° pr√≥ximo da id√©ia do DevOps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A separa√ß√£o por um tempo salvou a todos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2012. Engenheiros de Produ√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em 2012, o AppOps simplesmente renomeou </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os engenheiros de produ√ß√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Al√©m do nome, nada mudou, mas ficou mais confort√°vel. </font><font style="vertical-align: inherit;">Como voc√™ chama um iate, ele navegar√°, e n√≥s n√£o queremos navegar como Ops. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As SROs ainda existiam, o Facebook estava crescendo e o monitoramento de todos os servi√ßos ao mesmo tempo era dif√≠cil. </font><font style="vertical-align: inherit;">Uma pessoa que estava em chamada nem sequer foi autorizada a ir ao banheiro: ele pediu a algu√©m para substitu√≠-lo, porque ele estava constantemente queimando.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2014. SRO de fechamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um ponto, as autoridades transferiram todos para a chamada. </font><font style="vertical-align: inherit;">"Todo mundo" significa que os desenvolvedores tamb√©m: escreva seu c√≥digo, aqui est√° voc√™ e responda por esse c√≥digo! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os engenheiros de produ√ß√£o j√° foram integrados √†s equipes mais importantes em busca de ajuda, e o restante est√° sem sorte. </font><font style="vertical-align: inherit;">Come√ßamos com grandes equipes e, em alguns anos, transferimos todos no Facebook para o oncall. </font><font style="vertical-align: inherit;">Entre os desenvolvedores, houve uma grande empolga√ß√£o: algu√©m desistiu, escreveu mensagens ruins. </font><font style="vertical-align: inherit;">Mas tudo se acalmou e, em 2014, o SRO foi fechado porque n√£o era mais necess√°rio. </font><font style="vertical-align: inherit;">Ent√£o, vivemos at√© hoje. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A palavra "SRE" na empresa √© not√≥ria, mas parecemos SRE no Google. </font><font style="vertical-align: inherit;">Existem diferen√ßas.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estamos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sempre integrados em equipes. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o temos a pesquisa SRE em geral, como no Google, √© para cada servi√ßo de pesquisa separadamente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estamos nos produtos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , apenas na infraestrutura em que o produto se administra.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estamos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oncall</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> junto com os desenvolvedores.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como temos um pouco mais de experi√™ncia em sistemas e redes, nos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">concentramos em monitorar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e extinguir servi√ßos quando eles queimam intensamente. </font><font style="vertical-align: inherit;">Corrigimos erros com anteced√™ncia que poderiam levar a falhas e influenciar a arquitetura de novos servi√ßos desde o in√≠cio, para que eles funcionassem sem problemas na produ√ß√£o.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitoramento</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â o mais importante. </font><font style="vertical-align: inherit;">Como vamos fazer isso? </font><font style="vertical-align: inherit;">Como todo mundo: sem magia negra, em casa pr√≥pria. </font><font style="vertical-align: inherit;">Mas o diabo, como sempre, falar√° sobre eles em detalhes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATOP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos come√ßar de baixo. Todo mundo conhece o TOP no Linux, e usamos o ATOP, onde "A" √© "avan√ßado" - um monitor de desempenho do sistema. O principal benef√≠cio do ATOP √© que ele armazena o hist√≥rico: voc√™ pode configur√°-lo para salvar instant√¢neos em disco. Nosso ATOP √© executado em todas as m√°quinas a cada 5 segundos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° um servidor de exemplo executando o back-end do PHP para facebook.com. N√≥s escrevemos nossa m√°quina virtual para executar o c√≥digo PHP, chamado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HHVM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (HipHop Virtual Machine). De acordo com as m√©tricas exportadas, descobrimos que v√°rias m√°quinas n√£o processavam quase uma √∫nica solicita√ß√£o em um minuto. Vamos ver o porqu√™, abra o ATOP 30 segundos antes de travar.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p2/vt/wf/p2vtwfqsucdo-shyennmf64opy8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode-se ver que, com os problemas do processador, carregamos demais. </font><font style="vertical-align: inherit;">Tamb√©m h√° problemas com a mem√≥ria, apenas 1,5 GB s√£o deixados no cache e, ap√≥s 5 segundos, apenas 800 MB. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/q-/_x/dzq-_x7xjizrcgynj3gdayuh8u0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s mais 5 segundos, a CPU √© liberada, nada √© executado. </font><font style="vertical-align: inherit;">ATOP diz olhar para a linha de fundo, escrevemos para o disco, mas o que? </font><font style="vertical-align: inherit;">Acontece que estamos escrevendo swap. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4z/-j/v1/4z-jv12mgthgjnezqlvbznu6ync.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quem est√° fazendo isso? </font><font style="vertical-align: inherit;">Processos que foram retirados da mem√≥ria 0,5 GB e trocados. </font><font style="vertical-align: inherit;">Em seu lugar, surgiram dois processos suspeitos de Python, que podem ser vistos como uma linha de comando.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8y/ej/uk/8yejuk2y3eeswlw7astqbiaaste.jpeg"><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATOP √© bonito, usamos constantemente.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ n√£o o possui, eu recomendo us√°-lo. </font><font style="vertical-align: inherit;">N√£o tenha medo da unidade, o ATOP consome apenas 200 a 300 MB por dia a cada 5 segundos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malloc HTTP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs Bahamas e aos grandes incidentes, damos nomes. H√° um bug divertido relacionado ao ATOP chamado Malloc HTTP. N√≥s estreou com ATOP e strace. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usamos Thrift em todos os lugares como um RPC. Nas vers√µes anteriores de seu analisador, havia um bug incr√≠vel que funcionava assim: chegou uma mensagem na qual os primeiros 4 bytes s√£o do tamanho dos dados, depois os pr√≥prios dados e os primeiros bytes s√£o adicionados √† pr√≥xima mensagem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas uma vez que um dos programas, em vez de ir para o servi√ßo de Thrift, fui para HTTP, e recebeu uma resposta ¬´a Bad HTTP o Pedido¬ª: </font></font><code>HTTP/1.1 400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de pegar o HTTP e aloc√°-lo usando o malloc HTTP, o n√∫mero de bytes.</font></font><br>
<br>
<pre><code class="bash hljs">Thrift message<font></font>
HTTP/1.1 400<font></font>
<span class="hljs-string">"HTTP"</span> == 0x48545450</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est√° tudo bem, n√≥s nos comprometemos demais, vamos alocar mais mem√≥ria! </font><font style="vertical-align: inherit;">Alocamos com malloc, e at√© escrevermos e lermos l√°, eles n√£o nos dar√£o mem√≥ria real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas n√£o estava l√°! </font><font style="vertical-align: inherit;">Se queremos bifurcar, a bifurca√ß√£o retornar√° um erro - n√£o h√° mem√≥ria suficiente.</font></font><br>
<br>
<pre><code class="bash hljs">malloc(<span class="hljs-string">"HTTP"</span>)<font></font>
pid = fork(); // errno = ENOMEM</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas por que, h√° uma mem√≥ria? </font><font style="vertical-align: inherit;">Entendendo os manuais, descobrimos que tudo √© muito simples: a atual configura√ß√£o de supercomprometimento √© tal que √© uma heur√≠stica m√°gica, e o pr√≥prio kernel decide quando muito e quando n√£o:</font></font><br>
<br>
<pre><code class="bash hljs">malloc(<span class="hljs-string">"HTTP"</span>)<font></font>
pid = fork(); // errno = ENOMEM<font></font>
<font></font>
// 0: heuristic overcommit<font></font>
vm.overcommit_memory = 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para um processo de trabalho, isso √© normal, voc√™ pode selecionar malloc at√© TB, mas para um novo processo - n√£o. </font><font style="vertical-align: inherit;">E parte do monitoramento em n√≥s estava ligada ao fato de que o processo principal bifurcava pequenos scripts para coleta de dados. </font><font style="vertical-align: inherit;">Como resultado, nossa parte de monitoramento quebrou, porque n√£o pod√≠amos mais bifurcar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FB303</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O FB303 √© o nosso sistema b√°sico de monitoramento. </font><font style="vertical-align: inherit;">Foi nomeado ap√≥s o sintetizador de baixo padr√£o de 1982. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t2/x3/f4/t2x3f4of3j794hnfskzti5lk3va.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O princ√≠pio √© simples, portanto, ainda funciona: cada servi√ßo implementa a interface Thrift getCounters.</font></font><br>
<br>
<pre><code class="php hljs">Service FacebookService {<font></font>
    map&lt;<span class="hljs-keyword">string</span>, i64&gt; getCounters()<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, ele n√£o o implementa, porque as bibliotecas j√° est√£o escritas, tudo √© feito no c√≥digo </font></font><code>increment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="php hljs">incrementCounter(<span class="hljs-keyword">string</span>&amp; key);<font></font>
<font></font>
setCounter(<span class="hljs-keyword">string</span>&amp; key, int64_t value);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, cada servi√ßo exporta contadores na porta que registra no Service Discovery. Abaixo est√° um exemplo de uma m√°quina que gera um feed de not√≠cias e exporta cerca de 5,5 mil pares (string, n√∫mero): mem√≥ria, produ√ß√£o, qualquer coisa. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sl/sb/fj/slsbfj9kapkaqsi3quo_do4q64a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada m√°quina executa um processo bin√°rio que passa por todos os servi√ßos, coleta esses contadores e os armazena. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GUI de armazenamento se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parece </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sh/lt/li/shltlimradfvsovwo1vp1xzudmu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muito parecido com Prometeu e Grafana, mas n√£o √©. A primeira entrada do FB303 no GitHub foi em 2009 e no Prometheus em 2012. Esta √© uma explica√ß√£o de todos os produtos ‚Äúcaseiros‚Äù do Facebook: n√≥s os fizemos quando nada era normal em c√≥digo aberto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, h√° uma pesquisa pelos nomes dos contadores. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vb/b3/ya/vbb3yabg-lhlypl1y7_zwf9dolw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os gr√°ficos em si se parecem com isso.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b7/td/lj/b7tdljhxpmw6d5rt1fpguoon3ru.jpeg"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma imagem do grupo interno em que publicamos belos gr√°ficos. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma diferen√ßa importante entre nossa pilha de monitoramento e Prometheus e Grafana √© que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">armazenamos dados para sempre</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nosso monitoramento far√° uma nova amostragem dos dados e, ap√≥s 2 semanas, teremos um ponto a cada 5 minutos e depois de um ano a cada hora. </font><font style="vertical-align: inherit;">Portanto, eles podem ser armazenados demais. </font><font style="vertical-align: inherit;">Automaticamente, isso n√£o est√° configurado em nenhum lugar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas se falarmos sobre os recursos de monitoramento do Facebook, eu o descreveria com uma palavra em ingl√™s " </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">observabilidade"</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observabilidade</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe uma "caixa preta", existe uma "caixa branca" e temos uma "caixa" transparente de vidro. </font><font style="vertical-align: inherit;">Isso significa que, quando escrevemos c√≥digo, escrevemos tudo o que √© poss√≠vel nos logs, e n√£o seletivamente. </font><font style="vertical-align: inherit;">A amostragem √© bem ajustada em todos os lugares, para que o back-end para armazenamento, contadores e tudo o mais funcione perfeitamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, podemos criar nossos pain√©is em contadores existentes. </font><font style="vertical-align: inherit;">No caso de estudar esses pain√©is, este n√£o √© o ponto final com 10 gr√°ficos, mas o inicial, a partir do qual acessamos nossa interface do usu√°rio e encontramos tudo o que √© poss√≠vel.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mergulho</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse √© o cl√≠max da ideia de observabilidade. Esta √© a nossa pilha ELK. O princ√≠pio √© o mesmo: escrevemos em JSON sem um esquema espec√≠fico, depois solicitamos na forma de uma </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabela</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , s√©ries temporais de dados ou mais 10 op√ß√µes de visualiza√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Scuba registra na ordem de centenas de gigabytes por segundo. Tudo √© solicitado muito rapidamente, porque n√£o √© o Elasticsearch, e tudo est√° na mem√≥ria em m√°quinas poderosas. Sim, o dinheiro √© gasto com isso, mas como √© maravilhoso! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, abaixo da interface do usu√°rio do Scuba, uma das tabelas mais populares √© aberta nela, na qual todos os clientes de todos os servi√ßos Thrift gravam logs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dj/ah/ad/djahadigvrtru4luney67766slw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O gr√°fico mostra que, no final, algo deu errado no servi√ßo. Para descobrir o atraso, v√° para a lista de contadores, selecione o atraso, agrega√ß√£o, clique em "Mergulho". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/c-/y8/m2c-y8pfnqyrz4hivxhxyszwvnw.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A resposta vem em 2 segundos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j6/ac/kg/j6ackggq0o7xk93vejg0yfbyrhi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode-se ver que naquele momento algo aconteceu e o atraso aumentou significativamente. </font><font style="vertical-align: inherit;">Para saber mais, voc√™ pode agrupar por diferentes par√¢metros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem centenas dessas tabelas.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma tabela que mostra as vers√µes de arquivos bin√°rios, pacotes e quanta mem√≥ria √© consumida em todos os milh√µes de m√°quinas. </font><font style="vertical-align: inherit;">Em cada host, um PS √© feito uma vez por hora e enviado ao Scuba.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos os dmesg, todos os despejos de mem√≥ria s√£o enviados para outras tabelas. </font><font style="vertical-align: inherit;">Executamos o Perf a cada 10 minutos em cada m√°quina, para saber quais rastreamentos de pilha temos no kernel e o que a CPU global pode carregar.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depura√ß√£o do PHP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Scuba tamb√©m fornece um back-end para nossa principal ferramenta de depura√ß√£o do PHP. Milhares de engenheiros escrevem c√≥digo PHP e, de alguma forma, voc√™ precisa salvar o reposit√≥rio global de coisas ruins. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como funciona? O PHP tamb√©m grava um rastreamento de pilha em cada log. O Scuba (nossa Elasticsearch) simplesmente n√£o pode acomodar o rastreamento de pilha de todos os logs de todas as m√°quinas. Antes de colocar o log no Scuba, convertemos o rastreamento da pilha em um hash, amostra por hashes e os salvamos apenas. Os rastreamentos de pilha s√£o enviados para o Memcached. Em seguida, na ferramenta interna, voc√™ pode obter rapidamente um rastreamento de pilha espec√≠fico do Memcached. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/w_/im/chw_im8wjuue2nolmyzgcfappnq.jpeg"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visualiza√ß√£o com agrupamento de hash de logs e rastreios de pilha.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Depuramos o c√≥digo usando o m√©todo de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">correspond√™ncia de padr√µes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : abra o Scuba, veja como √© o gr√°fico de erros.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nd/op/nx/ndopnxibxeidsb8cmyy0rokasjm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos para o LogView, j√° existem erros agrupados por rastreamentos de pilha. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yx/0f/t3/yx0ft3lf_mnoskzxba7oqw3wtai.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um rastreamento de pilha √© carregado no Memcached e nele voc√™ j√° pode encontrar o diff (commit no reposit√≥rio PHP), que foi postado aproximadamente ao mesmo tempo, e reverte-o. </font><font style="vertical-align: inherit;">Qualquer um pode reverter e se comprometer conosco, n√£o s√£o necess√°rias permiss√µes para isso.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kh/eu/ck/kheuck1w2losbdhiyasysemlvnk.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dashboards</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terminarei o t√≥pico de monitoramento com pain√©is. Temos alguns deles - apenas dois por tr√™s indicadores. O painel em si √© bastante incomum. Eu gostaria de falar mais sobre ele. Abaixo est√° um painel padr√£o com um conjunto de gr√°ficos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kh/eu/ck/kheuck1w2losbdhiyasysemlvnk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, n√£o √© t√£o simples com ele. O fato √© que a linha roxa em um gr√°fico √© o mesmo servi√ßo que a linha azul corresponde no outro gr√°fico, e outro gr√°fico pode estar em um dia e outro em um m√™s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usamos nosso painel baseado no </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cubism</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a biblioteca JS de c√≥digo aberto. Foi escrito na Square e lan√ßado sob a licen√ßa Apache. Eles t√™m suporte embutido para Graphite e Cube. Mas √© f√°cil expandir, o que fizemos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O painel abaixo mostra um dia a um pixel por minuto. </font><font style="vertical-align: inherit;">Cada linha √© uma regi√£o: data centers pr√≥ximos. </font><font style="vertical-align: inherit;">Eles exibem o n√∫mero de logs que o back-end do Facebook grava em bytes por segundo. </font><font style="vertical-align: inherit;">Abaixo est√£o anota√ß√µes para as equipes na Am√©rica verem o que j√° corrigimos do que aconteceu durante o dia. </font><font style="vertical-align: inherit;">√â f√°cil procurar correla√ß√£o nesta imagem. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fx/3u/8f/fx3u8f42urcs2ernp8cu_gvxj6q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abaixo est√° o n√∫mero de erros 500. O que √† esquerda n√£o importava para os usu√°rios e, obviamente, eles n√£o gostavam da faixa verde escura no centro. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/dp/g1/jydpg1dmhrcxiirkeba3dhmtxcs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir est√° a lat√™ncia do 99¬∫ percentil. </font><font style="vertical-align: inherit;">Ao mesmo tempo, como no gr√°fico acima, √© poss√≠vel observar que a lat√™ncia diminuiu. </font><font style="vertical-align: inherit;">Para retornar um erro, n√£o √© necess√°rio gastar muito tempo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/4w/it/og4witypnhr2n091yaiwzjqctsg.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como funciona</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um gr√°fico de 120 pixels de altura, tudo √© vis√≠vel. Mas muitas delas n√£o podem ser colocadas em um painel, ent√£o diminuiremos para 30. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/48/-t/-2/48-t-2gfcbcmotwnkifz2tln_9u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, temos algum tipo de jib√≥ia. Vamos voltar e ver o que o cubismo faz com isso. Ele divide o gr√°fico em 4 partes: quanto maior, mais escuro e depois desmorona. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zg/s-/48/zgs-48iqemvyyyyxuh1g949aoji.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora temos a mesma programa√ß√£o de antes, mas tudo √© claramente vis√≠vel: quanto mais escuro o verde, pior. Agora est√° muito mais claro o que est√° acontecendo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä esquerda, voc√™ pode ver a onda que subia e no centro, onde √© verde escuro, tudo est√° muito ruim. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ql/0f/xu/ql0fxubdkifq0ax-mwhbn00ndxi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cubismo √© apenas o come√ßo. √â necess√°rio para visualiza√ß√£o, a fim de entender se tudo est√° ruim agora ou n√£o. Para cada tabela, j√° existem pain√©is com gr√°ficos detalhados.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_p/zx/u-/_pzxu-sbu9xc5p2gpoyrekvbybc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O monitoramento por si s√≥ ajuda a entender o estado do sistema e responder se ele quebrar. </font><font style="vertical-align: inherit;">No Facebook, todo funcion√°rio oncall deve ser capaz de reparar tudo. </font><font style="vertical-align: inherit;">Se queima intensamente, tudo acontece, mas especialmente os engenheiros de produ√ß√£o com a experi√™ncia de um administrador de sistemas, porque sabem como resolver o problema rapidamente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando o Facebook estava</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, incidentes acontecem e o Facebook mente. Geralmente, as pessoas pensam que o Facebook est√° mentindo por causa de DDoS ou hackers atacados, mas em 5 anos isso nunca aconteceu. A raz√£o sempre foi nossos engenheiros. Eles n√£o s√£o de prop√≥sito: os sistemas s√£o muito complexos e podem quebrar onde voc√™ n√£o espera. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damos nomes a todos os incidentes importantes, para que seja conveniente mencionar e informar os rec√©m-chegados sobre eles, para n√£o repetir erros no futuro. O campe√£o com o nome mais engra√ßado √© o incidente de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chamar a pol√≠cia</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . As pessoas ligaram para a pol√≠cia de Los Angeles e pediram para consertar o Facebook porque estava mentindo. O xerife de Los Angeles estava t√£o cansado disso que ele twittou: "Por favor, n√£o nos ligue!" N√≥s n√£o somos respons√°veis ‚Äã‚Äãpor isso! ‚Äù </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4p/tl/nv/4ptlnvj0sppjmmmdt3zjowumd-u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meu incidente favorito do qual participei foi chamado </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CAPSLOCK.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. √â interessante, pois mostra que tudo pode acontecer. E isso √© o que aconteceu. Ele endere√ßo obychnyyIP: </font></font><code>fd3b:5679:92eb:9ce4::1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Facebook usa o Chef para personalizar o sistema operacional. O Service Inventory armazena a configura√ß√£o do host em seu banco de dados e o Chef recebe um arquivo de configura√ß√£o do servi√ßo. Depois que o servi√ßo mudou sua vers√£o, come√ßou a ler endere√ßos IP do banco de dados imediatamente no formato MySQL e coloc√°-los em um arquivo. O novo endere√ßo agora est√° escrito no capital: </font></font><code>FD3B:5679:92EB:9CE4::1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Shef examina o novo arquivo e v√™ que o endere√ßo IP "mudou" porque ele se compara, n√£o na forma bin√°ria, mas com uma string. O endere√ßo IP √© "novo", o que significa que voc√™ precisa abaixar a interface e aumentar a interface. Em todos os milh√µes de carros em 15 minutos, a interface caiu e subiu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que est√° tudo bem - a capacidade diminuiu enquanto a rede estava em algumas m√°quinas. </font><font style="vertical-align: inherit;">Mas de repente um bug foi aberto no driver de rede de nossas placas de rede personalizadas: na inicializa√ß√£o, eles exigiam 0,5 GB de mem√≥ria f√≠sica seq√ºencial. </font><font style="vertical-align: inherit;">Nas m√°quinas de cache, esses 0,5 GB desapareceram enquanto abaixamos e aumentamos a interface. </font><font style="vertical-align: inherit;">Portanto, nas m√°quinas de cache, a interface de rede caiu e n√£o aumentou, e nada funciona sem caches. </font><font style="vertical-align: inherit;">Sentamos e reiniciamos essas m√°quinas com as m√£os. </font><font style="vertical-align: inherit;">Foi divertido.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portal do Gerenciador de Incidentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o Facebook ‚Äúqueima‚Äù, √© necess√°rio organizar o trabalho da ‚Äúbrigada de inc√™ndio‚Äù e, o mais importante, entender onde queima, porque em uma grande empresa ele pode ‚Äúcheirar queimado‚Äù em um lugar, mas o problema estar√° em outro. </font><font style="vertical-align: inherit;">A ferramenta de interface do usu√°rio chamada </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incident Manager Portal</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nos ajuda com isso </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Foi escrito por engenheiros de produ√ß√£o e est√° aberto a todos. </font><font style="vertical-align: inherit;">Assim que algo acontece, iniciamos um incidente: nome, come√ßo, descri√ß√£o.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hj/px/sm/hjpxsmys_lbno7lkm9r9osacq7o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos uma pessoa especialmente treinada - Gerente de Incidentes On-Call (IMOC). </font><font style="vertical-align: inherit;">Esta n√£o √© uma posi√ß√£o permanente, os gerentes mudam regularmente. </font><font style="vertical-align: inherit;">Em caso de grandes inc√™ndios, o IMOC organiza e coordena as pessoas para reparo, mas n√£o precisa repar√°-lo. </font><font style="vertical-align: inherit;">Assim que um incidente com um alto n√≠vel de perigo √© criado, o IMOC recebe SMS e come√ßa a ajudar a organizar tudo. </font><font style="vertical-align: inherit;">Em um sistema grande, essas pessoas n√£o podem ser dispensadas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preven√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Facebook n√£o √© t√£o comum. </font><font style="vertical-align: inherit;">Na maioria das vezes, n√£o apagamos inc√™ndios e n√£o reiniciamos as m√°quinas de cache, mas corrigimos os erros antecipadamente e, se poss√≠vel, para todos de uma vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma vez que encontramos e corrigimos o "problema da fila". </font><font style="vertical-align: inherit;">O n√∫mero de solicita√ß√µes aumenta em 50% e os erros em 100%, porque ningu√©m limita a implementa√ß√£o antecipada, especialmente em pequenos servi√ßos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s descobrimos um exemplo de v√°rios servi√ßos e definimos aproximadamente um modelo de comportamento.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sob carga normal, a solicita√ß√£o chega, √© processada e retornada ao cliente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com uma carga alta, as solicita√ß√µes est√£o aguardando em uma fila porque todos os encadeamentos para processamento de solicita√ß√µes est√£o ocupados. </font><font style="vertical-align: inherit;">O atraso est√° aumentando, mas at√© agora est√° tudo bem.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A linha est√° crescendo, a carga est√° aumentando. </font><font style="vertical-align: inherit;">Em algum momento, tudo o que o servidor executa no cliente termina com um tempo limite de resposta e o cliente cai com um erro. </font><font style="vertical-align: inherit;">Nesse ponto, o resultado do servidor pode ser simplesmente descartado.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/0b/c1/b1/0bc1b11xgg49wz266m-tvoximls.jpeg"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O tempo limite do cliente √© destacado em vermelho. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o cliente repete novamente! </font><font style="vertical-align: inherit;">Acontece que todos os pedidos que executamos s√£o jogados no lixo e ningu√©m precisa mais dele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resolver esse problema para todos de uma vez? </font><font style="vertical-align: inherit;">Introduzir um limite no tempo de espera na fila. </font><font style="vertical-align: inherit;">Se a solicita√ß√£o estiver na fila mais do que o esperado, a descartamos e n√£o a processamos no servidor, n√£o desperdi√ßamos CPU nela. </font><font style="vertical-align: inherit;">Temos um jogo honesto: jogamos fora tudo o que n√£o podemos processar e tudo o que pod√≠amos - processado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A restri√ß√£o tornou poss√≠vel, ao aumentar a carga em 50% acima do m√°ximo, ainda processar 66% das solicita√ß√µes e receber apenas 33% dos erros. </font><font style="vertical-align: inherit;">Os desenvolvedores da estrutura do Dispatch implementaram isso no lado do servidor, e n√≥s, os engenheiros de produ√ß√£o, resolvemos gentilmente o tempo limite de 100 ms na fila para todos. </font><font style="vertical-align: inherit;">Portanto, todos os servi√ßos imediatamente obtiveram limita√ß√£o b√°sica barata.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferramentas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ideologia do SRE diz que, se voc√™ tem uma grande frota de carros, v√°rios servi√ßos e nada a ver com suas m√£os, precisa automatizar. </font><font style="vertical-align: inherit;">Portanto, metade do tempo escrevemos c√≥digo e constru√≠mos ferramentas.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cubismo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> integrado </font><font style="vertical-align: inherit;">no sistema.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O FBAR √© um "cavalo de batalha" que vem e conserta, para que ningu√©m se preocupe com um carro quebrado. </font><font style="vertical-align: inherit;">Essa √© a principal tarefa do FBAR, mas agora ele tem ainda mais tarefas.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coredumper</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que escrevemos com dois colegas </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele monitora coredumps em todas as m√°quinas e os coloca em um s√≥ lugar, juntamente com rastreamentos de pilha com todas as informa√ß√µes do host: onde est√°, como encontrar o tamanho. </font><font style="vertical-align: inherit;">Mas o mais importante √© que os rastreamentos de pilha s√£o gratuitos, sem iniciar o GDB usando os programas BPF.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pesquisas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫ltima coisa que fazemos √© conversar com as pessoas, entrevist√°-las. </font><font style="vertical-align: inherit;">Parece-nos que isso √© muito importante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma pesquisa √∫til √© sobre confiabilidade. </font><font style="vertical-align: inherit;">Perguntamos sobre os servi√ßos j√° em execu√ß√£o nas principais aspas do nosso question√°rio:</font></font><br>
<blockquote><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"A principal responsabilidade do software do sistema deve ser continuar executando. </font><font style="vertical-align: inherit;">A presta√ß√£o de servi√ßos deve ser vista como um efeito colateral ben√©fico da opera√ß√£o continuada ¬ª</font></font></em></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso significa que o principal dever do sistema √© continuar funcionando, e o fato de fornecer algum tipo de servi√ßo √© um b√¥nus adicional. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As pesquisas s√£o apenas para servi√ßos m√©dios, os pr√≥prios grandes entendem. </font><font style="vertical-align: inherit;">Fornecemos um question√°rio no qual perguntamos coisas b√°sicas sobre arquitetura, SLO, teste, por exemplo.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"O que acontece se o seu sistema receber 10% da carga?" </font><font style="vertical-align: inherit;">Quando as pessoas pensam: "Mas s√©rio, o que?" </font><font style="vertical-align: inherit;">- insights aparecem e muitos at√© governam seus sistemas. </font><font style="vertical-align: inherit;">Anteriormente, eles n√£o pensavam sobre isso, mas ap√≥s a pergunta h√° uma raz√£o.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Quem √© o primeiro a perceber problemas no seu servi√ßo - voc√™ ou seus usu√°rios?" </font><font style="vertical-align: inherit;">Os desenvolvedores come√ßam a se lembrar de quando isso aconteceu e: "... Talvez voc√™ precise adicionar alertas".</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Qual √© a sua maior dor oncall?" </font><font style="vertical-align: inherit;">Isso √© incomum para desenvolvedores, especialmente para novos. </font><font style="vertical-align: inherit;">Eles imediatamente dizem: ‚ÄúTemos muitos alertas! </font><font style="vertical-align: inherit;">Vamos limp√°-los e remover aqueles que n√£o s√£o o caso ".</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Qual a frequ√™ncia de seus lan√ßamentos?" </font><font style="vertical-align: inherit;">Primeiro, eles lembram que o est√£o liberando com as m√£os e, em seguida, eles t√™m sua pr√≥pria implanta√ß√£o personalizada.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o existe codifica√ß√£o no question√°rio, ele √© padronizado e muda a cada seis meses. </font><font style="vertical-align: inherit;">Este √© um documento de duas p√°ginas que ajudamos a preencher em 2-3 semanas. </font><font style="vertical-align: inherit;">E ent√£o organizamos um com√≠cio de duas horas e encontramos solu√ß√µes para muitas dores. </font><font style="vertical-align: inherit;">Esta ferramenta simples funciona bem conosco e pode ajud√°-lo.</font></font><br>
<br>
<blockquote>6-7         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Saint HighLoad++</a>,          .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>   (,   ,  ). <br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">telegram-</a>  .   !</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt489192/index.html">Os motores inteligentes entraram entre os tr√™s primeiros no ranking da FWCI entre as organiza√ß√µes b√°sicas da FizTech</a></li>
<li><a href="../pt489194/index.html">Como o OpenShift est√° mudando a estrutura organizacional de uma organiza√ß√£o de TI. A evolu√ß√£o dos modelos organizacionais ao mudar para PaaS</a></li>
<li><a href="../pt489196/index.html">Fuma√ßa m√°gica: microcontroladores vs. reguladores lineares</a></li>
<li><a href="../pt489198/index.html">Como n√£o se dar um tiro no p√© usando Liquibase</a></li>
<li><a href="../pt489200/index.html">O que as startups est√£o procurando pelo Y Combinator em 2020</a></li>
<li><a href="../pt489206/index.html">Hist√≥rias de travamento com Patroni ou Como eliminar um cluster do PostgreSQL</a></li>
<li><a href="../pt489210/index.html">Teste de desempenho de c√≥digo do Linux com exemplos</a></li>
<li><a href="../pt489212/index.html">1C-Bitrix impede o cancelamento da inscri√ß√£o no boletim informativo pelo requisito de enviar seus dados pessoais</a></li>
<li><a href="../pt489214/index.html">Abordagem moderna para testar a localiza√ß√£o no iOS</a></li>
<li><a href="../pt489218/index.html">√â ing√™nuo. Super: c√≥digo e arquitetura de um jogo simples</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>