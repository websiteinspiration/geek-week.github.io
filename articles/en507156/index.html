<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🤝‍👨🏽 🏿 ✌🏾 Tetris on bitboards: old songs in a new way 🤦🏿 👯 ♻️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bitbordy ( Bitboard ) - special bit patterns to effectively count the moves in board games. On a habr wrote about application of bitboards to chess an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Tetris on bitboards: old songs in a new way</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/507156/"><img src="https://habrastorage.org/webt/9d/af/fd/9daffdhaacnhqxq17ngoqxn02tm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bitbordy ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bitboard</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - special bit patterns to effectively count the moves in board games. </font><font style="vertical-align: inherit;">On a habr wrote about application of bitboards to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chess</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and even to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checkers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Today we will apply the technique of bitboards to a somewhat unexpected but familiar game - to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The result of our research will be a console game, as well as an automatic search for the best moves (for a given sequence of pieces), the speed of which is just ensured by the efficiency of bit manipulations. At the same time, we will support the playback of the found moves in automatic mode in order to fully enjoy computer intelligence. At the end of the article, a link to the github with the game code in C # is given, as well as a short video game of 114 moves found by the computer by searching in depth for fifteen minutes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually a bitboard is a machine word consisting of several bytes, each bit of which corresponds to one cell of the field in the game. </font><font style="vertical-align: inherit;">So, in chess there are only 64 cells, which corresponds to the 8-byte word (ulong in C #), and in checkers - 32 (uint in C #). </font><font style="vertical-align: inherit;">Fans of Tetris will probably remember that the size of the field in standard Tetris is 10 by 20 cells, that is, 200 bits, which does not fit into any number type. </font><font style="vertical-align: inherit;">Of course, you can divide the field into four parts and use four eight-byte words, or you can not trifle and use an array of twenty two-byte words, one word for each line of the field; </font><font style="vertical-align: inherit;">all the tetris implementations on the bitboards that I found (in the amount of one piece) do just that. </font><font style="vertical-align: inherit;">But we will go the other way ...</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vectors</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will use a special set of instructions </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advanced Vector Extensions 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which we already used </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">last time</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to speed up the calculations. </font><font style="vertical-align: inherit;">They operate with 256-bit values ​​(unlike the usual instructions working with 64-bit values):</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//  , 8 </span>
<span class="hljs-keyword">ulong</span> 
    x = <span class="hljs-number">0</span>,<font></font>
    y = <span class="hljs-number">0</span>,<font></font>
    z = x &amp; y; <span class="hljs-comment">// z[i] = x[i] &amp; y[i], i = 0..7</span>
<span class="hljs-comment">// SIMD-, 32 </span>
Vector256&lt;<span class="hljs-keyword">byte</span>&gt; <font></font>
    X = Vector256&lt;<span class="hljs-keyword">byte</span>&gt;.Zero,<font></font>
    Y = Vector256&lt;<span class="hljs-keyword">byte</span>&gt;.Zero,<font></font>
    Z = Avx2.And(X, Y); <span class="hljs-comment">// Z[i] = X[i] &amp; Y[i], i = 0..31</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I must say that writing static method calls instead of arithmetic operations each time is not very convenient; </font><font style="vertical-align: inherit;">in addition, not all operations have direct analogs in AVX2, so we will use the </font><font style="vertical-align: inherit;">c # power </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tape</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and write a special structure that encapsulates a 256-bit word to write code in this style:</font></font><br>
<br>
<pre><code class="cs hljs">V256 X = <span class="hljs-number">0</span>, Y = <span class="hljs-number">0</span>, Z = X &amp; Y;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make the previous code meaningful, define V256 as a structure that stores a 256-bit data vector inside and has implicit constructors and operator overloading:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">readonly</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">struct</span> V256<font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Vector256&lt;<span class="hljs-keyword">byte</span>&gt; _data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">V256</span>(<span class="hljs-params">Vector256&lt;<span class="hljs-keyword">byte</span>&gt; data</span>)</span> { _data = data; }<font></font>
<font></font>
    <span class="hljs-comment">//    Vector&lt;256&gt;:</span>
    <span class="hljs-comment">//  V256 x = new V256(data)    V256 x = data</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">implicit</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">V256</span>(<span class="hljs-params">Vector256&lt;<span class="hljs-keyword">byte</span>&gt; data</span>)</span> =&gt; <span class="hljs-keyword">new</span> V256(data);<font></font>
<font></font>
    <span class="hljs-comment">//     x &amp; y</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-keyword">operator</span> &amp;(V256 x, V256 y) =&gt; Avx2.And(x._data, y._data);<font></font>
<font></font>
    <span class="hljs-comment">//    :    V256 x = 42;</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">implicit</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">V256</span>(<span class="hljs-params"><span class="hljs-keyword">byte</span> b</span>)</span> =&gt; Avx2.BroadcastScalarToVector256(&amp;b);<font></font>
<font></font>
    ...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add to this structure the remaining methods and operators, which we will use in the future. </font><font style="vertical-align: inherit;">Since this class is the most important in our program,</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hide it under the spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment">//  readonly,   JIT-  </span>
<span class="hljs-keyword">readonly</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">struct</span> V256<font></font>
{<font></font>
    <span class="hljs-comment">//  ,    AVX2</span>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-title">V256</span>(<span class="hljs-params"></span>)</span> { <span class="hljs-keyword">if</span> (!Avx2.IsSupported) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotSupportedException(<span class="hljs-string">"AVX2"</span>); }<font></font>
<font></font>
    <span class="hljs-comment">//         , . </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> V256 ZERO = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  . JIT-       ,</span>
    <span class="hljs-comment">//         256- </span>
    <span class="hljs-comment">//   YMM0 - YMM15</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> Vector256&lt;<span class="hljs-keyword">byte</span>&gt; _data;<font></font>
<font></font>
    <span class="hljs-comment">//   32    </span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">V256</span>(<span class="hljs-params"><span class="hljs-keyword">byte</span>* b</span>)</span> { _data = Avx2.LoadVector256(b); }<font></font>
<font></font>
    <span class="hljs-comment">//      32   </span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">V256</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-keyword">byte</span>[] buffer</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (buffer.Length &lt; <span class="hljs-number">32</span>) Array.Resize(<span class="hljs-keyword">ref</span> buffer, <span class="hljs-number">32</span>);
        <span class="hljs-keyword">fixed</span> (<span class="hljs-keyword">byte</span>* p = buffer) _data = Avx2.LoadVector256(p);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//      .  </span>
    <span class="hljs-comment">//    unmanaged,      T</span>
    <span class="hljs-comment">//    .    (int, uint, long, ulong,</span>
    <span class="hljs-comment">//  ..)   </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 Load&lt;T&gt;(<span class="hljs-keyword">params</span> T[] buffer) <span class="hljs-keyword">where</span> T : unmanaged<font></font>
    {<font></font>
        <span class="hljs-keyword">fixed</span> (T* p = buffer) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> V256((<span class="hljs-keyword">byte</span>*)p);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> Store&lt;T&gt;(T[] buffer) <span class="hljs-keyword">where</span> T : unmanaged<font></font>
    {<font></font>
        <span class="hljs-keyword">fixed</span> (T* p = buffer) Avx2.Store((<span class="hljs-keyword">byte</span>*)p, _data);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> T[] ToArray&lt;T&gt;() <span class="hljs-keyword">where</span> T : unmanaged<font></font>
    {<font></font>
        T[] array = <span class="hljs-keyword">new</span> T[<span class="hljs-number">32</span> / <span class="hljs-keyword">sizeof</span>(T)];
        <span class="hljs-keyword">fixed</span> (T* ptr = array) Avx2.Store((<span class="hljs-keyword">byte</span>*)ptr, _data);
        <span class="hljs-keyword">return</span> array;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   broadcast     </span>
    <span class="hljs-comment">//  ,   32   b</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-title">FromByte</span>(<span class="hljs-params"><span class="hljs-keyword">byte</span> b</span>)</span> =&gt;<font></font>
        Avx2.BroadcastScalarToVector256(&amp;b);<font></font>
    <span class="hljs-comment">//  16  short- s</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-title">FromShort</span>(<span class="hljs-params"><span class="hljs-keyword">short</span> s</span>)</span> =&gt;<font></font>
        Avx2.BroadcastScalarToVector256(&amp;s).AsByte();<font></font>
    <span class="hljs-comment">//      </span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-title">FromULong</span>(<span class="hljs-params"><span class="hljs-keyword">ulong</span> ul</span>)</span> =&gt;<font></font>
        Avx2.BroadcastScalarToVector256(&amp;ul).AsByte();<font></font>
<font></font>
    <span class="hljs-comment">//    :    V256 x = 42;</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">implicit</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">V256</span>(<span class="hljs-params"><span class="hljs-keyword">byte</span> b</span>)</span> =&gt; FromByte(b);<font></font>
<font></font>
    <span class="hljs-comment">//   AVX2</span>
    <span class="hljs-comment">//     ,  result[i] = </span>
    <span class="hljs-comment">// Math.Min(this[i], other[i]), i=0..31,   100  </span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> V256 <span class="hljs-title">Min</span>(<span class="hljs-params">V256 other</span>)</span> =&gt; Avx2.Min(_data, other._data);
    <span class="hljs-comment">//  table lookup: result[i] = this[data[i]], i = 0..31</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> V256 <span class="hljs-title">Shuffle</span>(<span class="hljs-params">V256 mask</span>)</span> =&gt; Avx2.Shuffle(_data, mask._data);
    <span class="hljs-comment">//  result[i] = this[i] == other[i] ? 0xFF : 0x00;</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> V256 <span class="hljs-title">CompareEqual</span>(<span class="hljs-params">V256 other</span>)</span> =&gt; Avx2.CompareEqual(_data, other._data);<font></font>
    <font></font>
    <span class="hljs-comment">//     x &amp; y, x | y  .. </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-keyword">operator</span> &amp;(V256 x, V256 y) =&gt; Avx2.And(x._data, y._data);
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-keyword">operator</span> |(V256 x, V256 y) =&gt; Avx2.Or(x._data, y._data);
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-keyword">operator</span> +(V256 x, V256 y) =&gt; Avx2.Add(x._data, y._data);
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-keyword">operator</span> -(V256 x, V256 y) =&gt; Avx2.Subtract(x._data, y._data);
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-keyword">operator</span> -(V256 x) =&gt; Avx2.Subtract(ZERO._data, x._data);<font></font>
<font></font>
    <span class="hljs-comment">//      256-   .</span>
    <span class="hljs-comment">//      AVX2  AVX512,   </span>
    <span class="hljs-comment">//   ,    :</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-keyword">operator</span> ==(V256 x, V256 y) =&gt;
        <span class="hljs-number">-1</span> == Avx2.MoveMask(Avx2.CompareEqual(x._data, y._data));<font></font>
<font></font>
    <span class="hljs-comment">//    -  .  ,    </span>
    <span class="hljs-comment">//  256-  (   AVX512,  ,  !), </span>
    <span class="hljs-comment">// :</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> V256 <span class="hljs-keyword">operator</span> &gt;&gt;(V256 x, <span class="hljs-keyword">int</span> count)<font></font>
    {<font></font>
        <span class="hljs-comment">//  ,  4  8- </span>
        Vector256&lt;<span class="hljs-keyword">ulong</span>&gt; data = Avx2.ShiftRightLogical( <font></font>
            x._data.AsUInt64(), (<span class="hljs-keyword">byte</span>)count);
        <span class="hljs-comment">//        </span>
        Vector256&lt;<span class="hljs-keyword">ulong</span>&gt; carry = Avx2.ShiftLeftLogical(<font></font>
            x._data.AsUInt64(), (<span class="hljs-keyword">byte</span>)(<span class="hljs-number">64</span> - count));
        <span class="hljs-comment">// ...</span>
        carry = Avx2.Permute4x64(carry, <span class="hljs-number">0x39</span>);
        <span class="hljs-comment">//   !</span>
        carry = Avx2.Blend(ZERO._data.AsUInt32(), carry.AsUInt32(), <span class="hljs-number">0x3F</span>).AsUInt64();<font></font>
        data = Avx2.Or(data, carry);<font></font>
        <span class="hljs-keyword">return</span> data.AsByte();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   ,   ,  .</span>
    <span class="hljs-comment">//       :   </span>
    <span class="hljs-comment">//   ,     ,</span>
    <span class="hljs-comment">//      .</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">string</span> <span class="hljs-title">ToString</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">byte</span>* buffer = <span class="hljs-keyword">stackalloc</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">32</span>];<font></font>
        Avx2.Store(buffer, _data);<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">string</span>.Join(<span class="hljs-string">" "</span>, Enumerable.Range(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>).Select(i =&gt; buffer[i].ToString(<span class="hljs-string">"X2"</span>)));<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full Version: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V256.cs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are almost ready to start writing Tetris, but before that we must write unit tests!</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Without them, nothing will work, and we won’t even understand why</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs">[<span class="hljs-meta">TestClass</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">V256Tests</span><font></font>
{<font></font>
    [<span class="hljs-meta">TestMethod</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">V256_ToString</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        Assert.AreEqual(<font></font>
            <span class="hljs-string">"05 05 05 05 05 05 05 05 05 05 05 05 05 05 05 05 "</span> +
            <span class="hljs-string">"05 05 05 05 05 05 05 05 05 05 05 05 05 05 05 05"</span>,<font></font>
            ((V256)<span class="hljs-number">5</span>).ToString());<font></font>
    }<font></font>
<font></font>
    [<span class="hljs-meta">TestMethod</span>] <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">V256_And</span>(<span class="hljs-params"></span>)</span> =&gt; <font></font>
        Assert.AreEqual((V256)<span class="hljs-number">4</span>, (V256)<span class="hljs-number">5</span> &amp; (V256)<span class="hljs-number">6</span>);<font></font>
<font></font>
    [<span class="hljs-meta">TestMethod</span>]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">V256_ShiftRight</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        V256 y = <span class="hljs-keyword">new</span> V256(
            <span class="hljs-number">0xF1</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>,
            <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>,
            <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>,
            <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x18</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x0F</span>);<font></font>
        Assert.AreEqual(<font></font>
            <span class="hljs-string">"01 18 80 01 18 80 01 18 80 01 18 80 01 18 80 01 "</span> +
            <span class="hljs-string">"18 80 01 18 80 01 18 80 01 18 80 01 F8 FF 00 00"</span>,<font></font>
            (y &gt;&gt; <span class="hljs-number">12</span>).ToString());<font></font>
    }<font></font>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetris</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, now we are almost ready to start writing tetris! Both the playing field and the pieces will be represented by the V256 structure. When the figures are falling down, the corresponding bits of the field will be set to a value of 1. Since we have just 10x20 = 200 bits, and in their 256 V256, the remaining 56 bits we can </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">drink</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to use for a good cause. First, add one cell to the left and right of each line, which will always be filled. This will allow us not to write separate code to check whether the figure exits the border of the field on the left and on the right. Similarly, we add the twenty-first line, completely filled, to get rid of checks for going beyond the field border below. So we get 21 lines of 12 bits, which gives 252 bits, leaving 4 bits for unforeseen expenses:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bs/39/oi/bs39oig4ymw9abijpeqzzlpvfag.png" alt="image" align="left"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is a bitboard for an empty field; </font><font style="vertical-align: inherit;">low bytes (go first, because little endian) correspond to the upper lines; </font><font style="vertical-align: inherit;">older ones are lower; </font><font style="vertical-align: inherit;">four-bit tail is not used:</font></font><br>
<br>
<pre><code class="cs hljs">V256 board = <span class="hljs-keyword">new</span> V256(
        <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>,
        <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>,
        <span class="hljs-number">24</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">128</span>,
        <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, <span class="hljs-number">24</span>, <span class="hljs-number">128</span>, <span class="hljs-number">255</span>, <span class="hljs-number">15</span>);
</code></pre><br>
<br>
<img src="https://habrastorage.org/webt/sb/ys/a6/sbysa6lgri0r3lpqyh9rxvc6w6u.png" alt="image" align="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And here is the T-figure in all four variants, one for each rotation:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">// possible pieces with rotations</span>
V256[][] PIECES = <span class="hljs-keyword">new</span> V256[][] { ...,
    <span class="hljs-keyword">new</span>[] { <span class="hljs-comment">// T-shape</span>
            <span class="hljs-keyword">new</span> V256(<span class="hljs-number">224</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>),
            <span class="hljs-keyword">new</span> V256(<span class="hljs-number">96</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">64</span>),
            <span class="hljs-keyword">new</span> V256(<span class="hljs-number">64</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>),
            <span class="hljs-keyword">new</span> V256(<span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">96</span>),<font></font>
    }, ... <font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will represent the falling figure as an array of all its rotations, plus an index indicating which option is currently selected:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are no bit manipulations yet.</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs">    <span class="hljs-comment">//       .</span>
    <span class="hljs-comment">//    ,</span>
    <span class="hljs-comment">//    ,    </span>
    <span class="hljs-comment">//     .</span>
    V256[] fallingPiece = <span class="hljs-keyword">new</span> V256[<span class="hljs-number">4</span>];
    <span class="hljs-comment">//  1  4</span>
    <span class="hljs-keyword">int</span> rotationsCount;
    <span class="hljs-comment">//   .   </span>
    <span class="hljs-keyword">int</span> fallingPieceRotation;
    <span class="hljs-comment">//     </span><font></font>
    V256 FallingPiece =&gt; fallingPiece[fallingPieceRotation % rotationsCount];<font></font>
<font></font>
    <span class="hljs-comment">//    ,    ;-)</span>
    Random rand = <span class="hljs-keyword">new</span> Random(<span class="hljs-number">12345</span>);
    <span class="hljs-comment">//     !</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SelectNextPiece</span>(<span class="hljs-params"></span>)</span> =&gt; SelectPiece(rand.Next(<span class="hljs-number">0</span>, PIECES.Length));
    <span class="hljs-comment">//        </span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SelectPiece</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> index</span>)</span><font></font>
    {<font></font>
        fallingPieceRotation = <span class="hljs-number">0</span>;<font></font>
        rotationsCount = PIECES[index].Length;<font></font>
        Array.Copy(PIECES[index], fallingPiece, rotationsCount);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RotateLeft</span>(<span class="hljs-params"></span>)</span> =&gt; Rotate(<span class="hljs-number">1</span>);
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RotateRight</span>(<span class="hljs-params"></span>)</span> =&gt; Rotate(<span class="hljs-number">-1</span>);
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">MoveDown</span>(<span class="hljs-params"></span>)</span> =&gt; ShiftLeft(width);
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">MoveRight</span>(<span class="hljs-params"></span>)</span> =&gt; ShiftLeft(<span class="hljs-number">1</span>);
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">MoveLeft</span>(<span class="hljs-params"></span>)</span> =&gt; ShiftRight(<span class="hljs-number">-1</span>);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Rotate</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> count</span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">//    ,   </span>
        <span class="hljs-comment">//   </span><font></font>
        fallingPieceRotation += count;<font></font>
        <span class="hljs-comment">//  ,   </span>
        <span class="hljs-keyword">if</span> (!Intersects(bord, FallingPiece)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-comment">//   ,  !</span><font></font>
        fallingPieceRotation -= count;<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">ShiftLeft</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> count</span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">//  ,     </span>
        <span class="hljs-keyword">if</span> (Intersects(board, ShiftLeft(FallingPiece, count)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-comment">//     !</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; rotationsCount; i++) <font></font>
            fallingPiece[i] = ShiftLeft(fallingPiece[i], count);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, now </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">swing your hand, stick your arms around</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gently manipulate the bits! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we need to determine the intersection of the filled cells of the field and the shape, which is done in one logical operation:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Intersects</span>(<span class="hljs-params">V256 board, V256 piece</span>)</span> =&gt; (piece &amp; board) != <span class="hljs-number">0</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Shifting a figure down, left, or right will simply be a logical shift by the corresponding number of bits (note that shifting a figure to the right is a shift of its bits upward, which corresponds to a logical shift of the bits of the vector to the left):</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> width = <span class="hljs-number">12</span>; <span class="hljs-comment">//    </span><font></font>
<font></font>
<span class="hljs-function">V256 <span class="hljs-title">MoveDown</span>(<span class="hljs-params">V256 piece</span>)</span> =&gt; piece &lt;&lt;= width;<font></font>
<font></font>
<span class="hljs-function">V256 <span class="hljs-title">MoveRight</span>(<span class="hljs-params">V256 piece</span>)</span> =&gt; piece &lt;&lt;= <span class="hljs-number">1</span>;<font></font>
<font></font>
<span class="hljs-function">V256 <span class="hljs-title">MoveLeft</span>(<span class="hljs-params">V256 piece</span>)</span> =&gt; piece &gt;&gt;= <span class="hljs-number">1</span>;<font></font>
<font></font>
<span class="hljs-comment">//      ,</span>
<span class="hljs-comment">//  ,     </span>
<span class="hljs-function">V256 <span class="hljs-title">Drop</span>(<span class="hljs-params">V256 piece</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(!Intersects(board, MoveDown(piece)) piece = MoveDown(piece);
    <span class="hljs-keyword">return</span> piece;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, since we have a console game, we need to print the field and the falling figure:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DisplayField</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    V256 field = board | FallingPiece; <span class="hljs-comment">//   ,   </span>
    <span class="hljs-keyword">while</span> (field != <span class="hljs-number">0</span>) <span class="hljs-comment">//     ,   </span><font></font>
    {<font></font>
        Console.WriteLine(GetLine(field));<font></font>
        field &gt;&gt;= width; <span class="hljs-comment">//      </span><font></font>
    }<font></font>
}<font></font>
<span class="hljs-comment">//  AVX2-,    , </span>
<span class="hljs-comment">//     </span>
V256 tile = <span class="hljs-keyword">new</span> V256(<span class="hljs-string">' '</span> &amp; <span class="hljs-number">255</span>, <span class="hljs-string">'*'</span> &amp; <span class="hljs-number">255</span>);<font></font>
V256 lineToStringShuffler = <span class="hljs-keyword">new</span> V256(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<font></font>
V256 lineToStringMask = <span class="hljs-keyword">new</span> V256(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>);
<span class="hljs-comment">//   ,     </span>
<span class="hljs-function"><span class="hljs-keyword">string</span> <span class="hljs-title">GetLine</span>(<span class="hljs-params">V256 field</span>)</span><font></font>
{<font></font>
    V256 line = field.Shuffle(lineToStringShuffler) &amp; lineToStringMask;<font></font>
    line = line.Min(V256.ONE);<font></font>
    line = tile.Shuffle(line);<font></font>
    <span class="hljs-keyword">return</span> Encoding.ASCII.GetString(line.ToArray&lt;<span class="hljs-keyword">byte</span>&gt;(), <span class="hljs-number">0</span>, width);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, the most difficult part is to identify the filled lines and delete them. </font><font style="vertical-align: inherit;">Here we can’t do without a loop (at least I didn’t succeed), so we will scan the field along the lines from the bottom up, and check with bit operations that the line is full. </font><font style="vertical-align: inherit;">To remove the filled line from the field, bitwise reset the corresponding line in the field, and move the upper part to the bottom:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mr/7m/up/mr7mupn8xgexyxfgx4kdjpavsz0.png" alt="image" align="right"> <pre><code class="cs hljs"><span class="hljs-keyword">while</span> (lineMask != <span class="hljs-number">0</span>)<font></font>
{<font></font>
    V256 boardLine = board &amp; lineMask;<font></font>
    V256 boardUnderLine = board &amp; underLineMask;<font></font>
    V256 boardOverLine = <font></font>
        board &amp; ~underLineMask &amp; ~lineMask;<font></font>
    <span class="hljs-keyword">if</span>(boardLine == lineMask)
        <span class="hljs-comment">//    </span>
        <span class="hljs-comment">//    </span><font></font>
        board = boardUnderLine |<font></font>
                (boardOverLine &lt;&lt; width) |<font></font>
                emptyLine;<font></font>
    <span class="hljs-comment">//      </span><font></font>
    underLineMask |= lineMask;<font></font>
    lineMask &gt;&gt;= width;<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Whole method</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs">V256 fullLine = <span class="hljs-keyword">new</span> V256(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ..., <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">15</span>);<font></font>
V256 emptyLine = <span class="hljs-keyword">new</span> V256(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>);<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RemoveFullLines</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> V256 board</span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//     </span><font></font>
    V256 lineMask = fullLine &gt;&gt; width;<font></font>
    <span class="hljs-comment">//      </span><font></font>
    V256 underLineMask = fullLine;<font></font>
    <span class="hljs-keyword">while</span> (lineMask != <span class="hljs-number">0</span>)<font></font>
    {<font></font>
        <span class="hljs-comment">//  ,   </span>
        <span class="hljs-keyword">while</span> ((board &amp; lineMask) == lineMask)<font></font>
        {<font></font>
            <span class="hljs-comment">//        </span><font></font>
            board = (board &amp; underLineMask) | <font></font>
                        ((board &amp; ~underLineMask &amp; ~lineMask) &lt;&lt; width) | <font></font>
                        emptyLine;<font></font>
        }<font></font>
        <span class="hljs-comment">//      </span><font></font>
        underLineMask |= lineMask;<font></font>
        lineMask &gt;&gt;= width;<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, that’s all we need. </font><font style="vertical-align: inherit;">Now the code of the game itself looks trivial, there is no hint at the bit-ups going on inside:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Game code</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">PlayGame</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        SelectNextPiece();<font></font>
<font></font>
        <span class="hljs-keyword">while</span> (!Intersects(FallingPiece))<font></font>
        {<font></font>
            DisplayField();<font></font>
<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<font></font>
            {<font></font>
                Control();<font></font>
                Thread.Sleep(<span class="hljs-number">100</span>);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!MoveDown())<font></font>
            {<font></font>
                AddPieceToBoard();<font></font>
                RemoveFullLines();<font></font>
                SelectNextPiece();<font></font>
                <span class="hljs-keyword">continue</span>;<font></font>
            }<font></font>
        }<font></font>
        DisplayField();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Control</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (Console.KeyAvailable)<font></font>
        {<font></font>
            ConsoleKeyInfo key = Console.ReadKey(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">if</span> (key.Key == ConsoleKey.UpArrow) RotateLeft();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.Key == ConsoleKey.DownArrow) RotateRight();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.Key == ConsoleKey.LeftArrow) MoveLeft();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.Key == ConsoleKey.RightArrow) MoveRight();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.Key == ConsoleKey.Spacebar) <span class="hljs-keyword">while</span> (MoveDown()) ;
            <span class="hljs-keyword">while</span> (Console.KeyAvailable) Console.ReadKey();<font></font>
            DisplayField();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is the full class code: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetris.cs</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Search for the best strategy</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, for the sake of the game it wouldn’t make much sense to fence these bit tricks. </font><font style="vertical-align: inherit;">But to find the optimal strategy - that's it! </font><font style="vertical-align: inherit;">Let's make the simplest search option - a recursive search in depth by exhaustive search: since the sequence of falling out figures is fixed, then for each figure we sort through all possible variants of its rotations and horizontal shifts. </font><font style="vertical-align: inherit;">In parallel, we store the sequence of actions so that we can reproduce the found options. </font><font style="vertical-align: inherit;">The simplified code is fairly straightforward:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Solve</span>(<span class="hljs-params"></span>)</span> =&gt; Solve(Tetris.board, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); <font></font>
<font></font>
<span class="hljs-comment">//       step</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Solve</span>(<span class="hljs-params">V256 board, <span class="hljs-keyword">int</span> step, <span class="hljs-keyword">int</span> score</span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">int</span> pieceIndex = pieceOrder[step];<font></font>
    V256[] currentPieceRotations = Tetris.PIECES[pieceIndex];<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">foreach</span> (V256 piece <span class="hljs-keyword">in</span> currentPieceRotations)<font></font>
    {<font></font>
        <span class="hljs-comment">//    (    )</span><font></font>
        Solve(board, piece, step, score);<font></font>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) <font></font>
        {<font></font>
            Solve(board, piece &lt;&lt; i, step, score);<font></font>
            Solve(board, piece &gt;&gt; i, step, score);<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Solve</span>(<span class="hljs-params">V256 board, V256 piece, <span class="hljs-keyword">int</span> step, <span class="hljs-keyword">int</span> score</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">if</span> ((piece &amp; board) != <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">//   !</span>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">while</span> ((board &amp; (piece &lt;&lt; Tetris.width)) == <span class="hljs-number">0</span>) piece &lt;&lt;= Tetris.width;<font></font>
    board |= piece; <span class="hljs-comment">//    !</span>
    Tetris.RemoveFullLines(<span class="hljs-keyword">ref</span> board, <span class="hljs-keyword">ref</span> score); <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">if</span>(score &gt; maxScore) {...} <span class="hljs-comment">//  !</span>
    <span class="hljs-comment">//      </span>
    Solve(board, step + <span class="hljs-number">1</span>, score);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Full code: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TetrisSolver.cs</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Result </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Searching by search, in fact, is not the most effective thing, since the number of options grows exponentially with each step. </font><font style="vertical-align: inherit;">However, the resulting search speed of about 15 million steps per second allows you to find quite interesting scenarios (the computer creates problems for itself, which it then heroically solves). </font><font style="vertical-align: inherit;">Something like this works:</font></font><br>
<br>
<pre><code class="plaintext hljs">C:\Tetris\bin\Release\netcoreapp3.1&gt;tetris -solve 1000<font></font>
...<font></font>
Processed 12,000,000,000 moves at 00:12:51 (15.56 M moves/second)<font></font>
new max score=57 at depth 114 after processing 12,475,091,815 moves at 00:13:22<font></font>
  0:0 0:0 0:0 ... 0:4 0:3 0:-2 0:2 0:-2 3:-4<font></font>
new max score=58 at depth 114 after processing 12,475,143,842 moves at 00:13:22<font></font>
  0:0 0:0 0:0 ... 1:-2 0:-2 0:-3 1:3 1:4 1:2 3:0<font></font>
Processed 13,000,000,000 moves at 00:13:57 (15.53 M moves/second)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is a video of the found scenario:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Computer plays Tetris</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/vx/ap/md/vxapmd5wnzsuokwng1uts-8uc04.gif" alt="image" align="left"><pre><code class="cs hljs">dotnet run -c Release -p Tetriss -replay <span class="hljs-string">"0:0 0:0 0:0 0:0 0:0 0:0 0:0 0:0 0:0 0:-3 0:3 0:-3 0:-2 0:3 0:-4 0:4 0:3 0:3 0:0 0:3 0:1 0:-3 0:3 0:-2 2:-3 0:-1 3:-4 2:-2 1:4 0:1 0:2 0:-4 1:4 0:2 0:-2 0:0 0:-3 0:-3 1:0 1:4 3:-4 1:4 1:2 0:0 0:-2 0:1 1:-4 0:0 0:-2 0:-4 0:4 1:2 1:4 1:4 1:-5 0:0 0:4 1:-4 0:-2 0:1 1:4 0:1 0:-1 1:3 2:2 0:0 1:-4 3:-1 2:4 1:-2 0:1 3:3 0:-3 1:1 3:-4 3:0 1:4 1:2 1:1 1:-4 1:-4 0:-2 0:1 1:4 3:-1 0:2 1:3 1:-5 1:4 0:1 1:-4 0:-2 1:4 1:2 0:2 1:4 1:0 0:-2 0:2 0:1 1:-4 0:1 0:1 1:4 1:-2 1:-2 0:-2 0:-3 1:3 1:4 1:2 3:0"</span></code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is posted on github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en507132/index.html">Vladimir Kitov: “It is impossible to understand how pioneering scientists foresaw universal computerization back in the 1950s!”</a></li>
<li><a href="../en507138/index.html">21st Century Geology as the Earth Data Science</a></li>
<li><a href="../en507146/index.html">Multi-colored windows: virtual constructor, CRTP and intricate templates</a></li>
<li><a href="../en507148/index.html">Send magic links using Node.js</a></li>
<li><a href="../en507150/index.html">We draw an interference picture in JavaScript</a></li>
<li><a href="../en507158/index.html">Antiquities: Decade of Apple iPad</a></li>
<li><a href="../en507160/index.html">About the “most” “realistic” “interpretation” of quantum mechanics</a></li>
<li><a href="../en507162/index.html">Game Code Command & Conquer: bugs from the 90s. Volume One</a></li>
<li><a href="../en507166/index.html">Experience in using Rutoken technology for registering and authorizing users in the system (part 3)</a></li>
<li><a href="../en507170/index.html">Are fourteen people viewing this product for sure?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>