<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔮 🔰 ☝️ インフラ管理用の電報ボット 🐫 🎦 🧖🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事に基づいて、システム管理者用のテレグラムボット（記事は私のものではありません。読んだだけです）は、アプリケーションサーバーを管理するためにPowerShellでテレグラムボットを作成した経験を共有したいと考えていました。テキスト、コード、いくつかの写真があります。建設的な批評は歓迎されます（...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>インフラ管理用の電報ボット</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483660/"><img src="https://habrastorage.org/webt/f-/dc/ax/f-dcaxuxg0id5fqzmenau-wyi4c.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事に基づいて、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム管理者用</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">テレグラムボット</font></a><font style="vertical-align: inherit;">（記事は私のものではありません。読んだだけです）は、アプリケーションサーバーを管理するためにPowerShellでテレグラムボットを作成した経験を共有したいと考えていました。テキスト、コード、いくつかの写真があります。建設的な批評は歓迎されます（主なことは、「PowerShellを使用する理由は何ですか？それはperlにあるべきだった」と言うことではありません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事はPowerShellを初めて使用する方に適していると思いますが、経験豊富な管理者はここで役立つ情報を見ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼は記事を簡単なものから複雑なものまで、部分的に組み立てようとしました。おそらく盗作が発生します、警戒してください！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、複数のサーバーでサービスまたはアプリケーションを管理（停止、開始）し、サーバーを再起動し、必要に応じてログやその他の情報を確認する必要があります。</font><font style="vertical-align: inherit;">VPNとラップトップなしで、私がやりたいことはすべて（実際にはそうではありませんが）、地下鉄の中、店の中、またはソファの上に横たわっています。</font><font style="vertical-align: inherit;">（もちろん、膝の上に書かれた）要件の。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegramボットでタスクの追加/変更が簡単</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチタスクまたは並列化 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">直感的な管理インターフェース</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少なくともある程度のセキュリティ</font></font></li>
</ul><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ある時点で、設定を別のファイルに入れることが決定されました-私たちの場合はxml（ここでは誰かがjsonですべてをやろうと言うことができますが、私たちはxmlでそれを行って満足しました）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初から始めましょう：</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート1：シンプルな電報ボット</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、ボットフォルダ（ディレクトリではなく）を探している- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BotFather（@BotFather） </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">電報では、</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gp/qz/oa/gpqzoakmx6j1swm_q2zbrajcpae.jpeg" alt="ボットファーザー"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我々は、書き込み</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ newbot</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
次に、我々は「ボット」（Haaaabr_bot）で終わるべき、ボット（私の場合、私は特に記事のためにHaaaabrと呼ばれる）とユーザー名の名前を思い付くする必要があります</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
後このBotFatherのトークンが発行されます。これを使用します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/er/vm/iaervmphz5nsdm4tjwysrtr-zd4.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ボットの画像をアップロードし、説明を入力し、コマンドのリストを作成できますが、私は</font><font style="vertical-align: inherit;">面倒</font><font style="vertical-align: inherit;">すぎました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージを受信して​​応答するシンプルなボットを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSコードを部分的に記述し、参照用に完全なコードを定期的に挿入します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
参考までに、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram Bot API API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出しの説明</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
が必要です。2つのメソッドが必要です：</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getUpdates</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ボット（スクリプト）による</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sendMessage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージの受信</font><font style="vertical-align: inherit;">-ボット（スクリプト）によるユーザーへのメッセージの送信</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じ場所で、次のことがわかります。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストの作成</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Telegram Bot APIへのすべてのクエリはHTTPS経由で提供する必要があり、次の形式で提示する必要があります：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">api.telegram.org/bot&lt;token&gt;</font></a><font style="vertical-align: inherit;"> / </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">METHOD_NAME</font></font></a> </blockquote><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順1-メッセージ</font></font></u><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
変数の</font><u><font style="vertical-align: inherit;">受信</font></u></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font><i><font style="vertical-align: inherit;">$ URL_get</font></i><font style="vertical-align: inherit;">への呼び出しが返されることを確認します</font></font><i><font style="vertical-align: inherit;"></font></i><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL_get</span></code></pre><br>
<code> ok result<br>
 -- ------<br>
True {} </code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悪くない。</font><font style="vertical-align: inherit;">ボットに何かを書いてみましょう：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ub/kn/jd/ubknjd-kciskp6cvbjd9ejj9umm.jpeg" alt="こんにちは"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして読んでください：</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span> <font></font>
<font></font>
<span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL_get</span> </code></pre><br>
<br>
<code>ok result <br>
 -- ------ <br>
True {@{update_id=635172027; message=}, @{update_id=635172028; message=}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">} </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、我々は結果が必要です。</font><font style="vertical-align: inherit;">私はユーザーからの最後のメッセージにのみ関心があるとすぐに言っておく必要があるので、次のようにします。</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL_get</span><font></font>
<font></font>
<span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-variable">$data</span>.update_id 
<span class="hljs-variable">$data</span>.message.chat.id
<span class="hljs-variable">$data</span>.message.text
<span class="hljs-variable">$data</span>.message.chat.first_name
<span class="hljs-variable">$data</span>.message.chat.last_name
<span class="hljs-variable">$data</span>.message.chat.type
<span class="hljs-variable">$data</span>.message.chat.username </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、メッセージを受信したことを確認する必要があります。</font><font style="vertical-align: inherit;">これは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getUpdates</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font><font style="vertical-align: inherit;">の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offset</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータを使用し</font><font style="vertical-align: inherit;">て、すべて同じように行われ</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デフォルトでは、未確認の最も古いアップデートから始まるアップデートが返されます。</font><font style="vertical-align: inherit;">updateUpdatesがそのupdate_idより高いオフセットで呼び出されるとすぐに、更新は確認されたと見なされます</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行う</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL_get</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、すべてを1秒のタイムアウトでサイクルに投入します。</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment"># timeout sec</span>
<span class="hljs-variable">$timeout</span> = <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL_get</span><font></font>
<font></font>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span><font></font>
<font></font>
    <span class="hljs-variable">$data</span>.update_id
    <span class="hljs-variable">$data</span>.message.chat.id
    <span class="hljs-variable">$data</span>.message.text
    <span class="hljs-variable">$data</span>.message.chat.first_name
    <span class="hljs-variable">$data</span>.message.chat.last_name
    <span class="hljs-variable">$data</span>.message.chat.type
    <span class="hljs-variable">$data</span>.message.chat.username<font></font>
<font></font>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL_get</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
<font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span>    
} </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それからメッセージ読み上げ機能を作ってみましょう。</font><font style="vertical-align: inherit;">なぜなら </font><font style="vertical-align: inherit;">関数からいくつかの値を返す必要があります-HashTable（名前付き/連想配列）を使用することにしました</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージ受信スクリプト</font></font></b><div class="spoiler_text"><pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span><span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment"># timeout sec</span>
<span class="hljs-variable">$timeout</span> = <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span><font></font>
<font></font>
    <span class="hljs-comment">#$data.update_id</span>
    <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
    <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
    <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
    <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
    <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
    <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
<font></font>
    <span class="hljs-comment">#   text </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$text</span>)<font></font>
    {<font></font>
        <span class="hljs-comment"># confirm</span>
        <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
<font></font>
        <span class="hljs-comment"># HashTable</span>
        <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-comment">#   </span>
    getUpdates <span class="hljs-variable">$URL_get</span><font></font>
<font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span>    
} </code></pre><br>
</div></div><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ2-データの</font></font></u><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
送信メッセージを送信するには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sendMessage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chat_id</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールド</font><font style="vertical-align: inherit;">が必要です（残りはオプションの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://core.telegram.org/bots/api#sendmessageです</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数をすぐに記録する</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-comment">#  HashTable,      </span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{<font></font>
        text = <span class="hljs-variable">$text</span>
        <span class="hljs-comment">#    Markdown</span>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        chat_id = <span class="hljs-variable">$chat_id</span><font></font>
    }<font></font>
    <span class="hljs-comment">#      json</span>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
    <span class="hljs-comment">#   Invoke-RestMethod,        Invoke-WebRequest</span>
    <span class="hljs-comment"># Method Post - ..  ,   Get</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span>    
} </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今呼び出すことによって</font></font><br>
<br>
<pre><code class="powershell hljs">sendMessage <span class="hljs-variable">$URL_set</span> &lt;__id&gt; <span class="hljs-string">"123"</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カートにメッセージを入れます。</font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ3-すべてをまとめる</font></font></u><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
以下は、メッセージを送受信するためのすべてのコードです</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを表示</font></font></b><div class="spoiler_text"><pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment"># timeout sec</span>
<span class="hljs-variable">$timeout</span> = <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span><font></font>
<font></font>
    <span class="hljs-comment">#$data.update_id</span>
    <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
    <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
    <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
    <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
    <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
    <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
<font></font>
    <span class="hljs-comment">#   text </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$text</span>)<font></font>
    {<font></font>
        <span class="hljs-comment"># confirm</span>
        <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
<font></font>
        <span class="hljs-comment"># HashTable</span>
        <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
    }<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-comment">#  HashTable,      </span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{<font></font>
        text = <span class="hljs-variable">$text</span>
        <span class="hljs-comment">#    Markdown</span>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        chat_id = <span class="hljs-variable">$chat_id</span><font></font>
    }<font></font>
    <span class="hljs-comment">#      json</span>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
    <span class="hljs-comment">#   Invoke-RestMethod,        Invoke-WebRequest</span>
    <span class="hljs-comment"># Method Post - ..  ,   Get</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span> | <span class="hljs-built_in">Out-Null</span>   <font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-variable">$return</span> = getUpdates <span class="hljs-variable">$URL_get</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$return</span>)<font></font>
    {<font></font>
        <span class="hljs-comment"># http://apps.timwhitlock.info/emoji/tables/unicode#block-1-emoticons</span>
        sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id (<span class="hljs-built_in">Get-Random</span>(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>))<font></font>
    }<font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span>
} </code></pre><br>
</div></div><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ return.text</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、たとえば</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switchステートメントに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
基づいて、さらにロジックを構築できます</font><font style="vertical-align: inherit;">。</font></font><br>
<pre><code class="powershell hljs"><span class="hljs-keyword">switch</span> <span class="hljs-operator">-Wildcard</span> (<span class="hljs-variable">$return</span>[<span class="hljs-string">"text"</span>])<font></font>
{<font></font>
    <span class="hljs-string">"**"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">", <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>["</span>f_name<span class="hljs-string">"])"</span> }
    <span class="hljs-string">"* ?*"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">""</span> }<font></font>
    default {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"<span class="hljs-variable">$</span>(Get-Random("</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">"))"</span>}<font></font>
} </code></pre> <br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">絵文字：</font></font></b><div class="spoiler_text">  Get-Random  emoji,          ,  PS   <br>
<img src="https://habrastorage.org/webt/ra/r6/4g/rar64gloyqqnimwf7m3lds23hs0.jpeg" alt="Get-Random"><br>
</div></div> <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート2：ボタンが必要</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電報ボットには、コマンドのリストを指定するオプションがあります（このアイコンはここに表示されます</font></font><img src="https://habrastorage.org/webt/ug/5v/bz/ug5vbz4hhz5cajcrg4auifrhw2y.jpeg" alt="アイコン"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初はそれを行いました—コマンドのセットがあり、サーバーまたはサービスの名前をパラメーターとして渡しました。</font><font style="vertical-align: inherit;">次に、ユーザーフレンドリーなインターフェースにさらに移動し、ボタン機能を接続する必要があると判断しました。</font><i><font style="vertical-align: inherit;">reply_markup</font></i><font style="vertical-align: inherit;">パラメーターを指定して</font><i><font style="vertical-align: inherit;">sendMessage</font></i><font style="vertical-align: inherit;">を</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
呼び出し</font><font style="vertical-align: inherit;">ます</font><i><font style="vertical-align: inherit;">。</font></i><font style="vertical-align: inherit;"> 
この機能では、</font><i><font style="vertical-align: inherit;">InlineKeyboardMarkup</font></i><font style="vertical-align: inherit;">タイプ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">https://core.telegram.org/bots/api#inlinekeyboardmarkup</font></a><font style="vertical-align: inherit;">を使用し</font><i><font style="vertical-align: inherit;">ました</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
説明から、</font><i><font style="vertical-align: inherit;">inline_keyboard</font></i><font style="vertical-align: inherit;">フィールド</font><font style="vertical-align: inherit;">はボタンの配列の配列である</font><font style="vertical-align: inherit;">ことが</font><i><font style="vertical-align: inherit;">わかり</font></i><font style="vertical-align: inherit;">ます。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（InlineKeyboardButtonの配列の配列）</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テスト送信ボタンを作成しようとしています</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment">#   callback_data  ,    </span>
<span class="hljs-variable">$button1</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Test1"</span>; callback_data = <span class="hljs-string">"Test1_CD"</span>}
<span class="hljs-variable">$button2</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Test2"</span>; callback_data = <span class="hljs-string">"Test2_CD"</span>}<font></font>
<font></font>
<span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{<span class="hljs-string">"inline_keyboard"</span> = <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$button1</span>, <span class="hljs-variable">$button2</span>))}<font></font>
<font></font>
<span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
    parse_mode = <span class="hljs-string">"Markdown"</span>
    reply_markup = <span class="hljs-variable">$keyboard</span>
    chat_id = ******** <span class="hljs-comment">#     Telegram ID</span>
    text = <span class="hljs-string">"Test Text"</span><font></font>
}<font></font>
<font></font>
<span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
<span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL_set</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラー：</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoke-RestMethod：{"ok"：false、 "error_code"：400、 "description"： "Bad Request：field \" inline_keyboard \ "of of the InlineKeyboardMarkup be be a Array of Arrays"} </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行：21文字：1 </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">$ json</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
変数の内容の確認</font><font style="vertical-align: inherit;">
：出力：</font></font><i><font style="vertical-align: inherit;"></font></i> <br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"reply_markup"</span>:  {
                         <span class="hljs-attr">"inline_keyboard"</span>:  [
                                                 <span class="hljs-string">"System.Collections.Hashtable System.Collections.Hashtable"</span><font></font>
                                             ]<font></font>
                     },<font></font>
    <span class="hljs-attr">"chat_id"</span>:  **********,
    <span class="hljs-attr">"text"</span>:  <span class="hljs-string">"Test Text"</span>,
    <span class="hljs-attr">"parse_mode"</span>:  <span class="hljs-string">"Markdown"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうやらそれは、テレグラムAPIのHashTableオブジェクト（ "System.Collections.Hashtable System.Collections.Hashtable"）をあまり渡していません。</font><font style="vertical-align: inherit;">少しグーグルと純利益-Jsonに変換するとき、変換深度を設定します</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment">#   callback_data  ,    </span>
<span class="hljs-variable">$button1</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Test1"</span>; callback_data = <span class="hljs-string">"Test1_CD"</span>}
<span class="hljs-variable">$button2</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Test2"</span>; callback_data = <span class="hljs-string">"Test2_CD"</span>}<font></font>
<font></font>
<span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{<span class="hljs-string">"inline_keyboard"</span> = <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$button1</span>, <span class="hljs-variable">$button2</span>))}<font></font>
<font></font>
<span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
    parse_mode = <span class="hljs-string">"Markdown"</span>
    reply_markup = <span class="hljs-variable">$keyboard</span><font></font>
    chat_id = ********<font></font>
    text = <span class="hljs-string">"Test Text"</span><font></font>
}<font></font>
<font></font>
<span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
<span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL_set</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボタンを</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wf/8x/e7/wf8xe7gkgmydxrbyftj_fph58fo.jpeg" alt="ボタン"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
取得し</font><font style="vertical-align: inherit;">ます。ボタン</font><font style="vertical-align: inherit;">を送信する機能を作成し、ボタンの配列を入力に送信します</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment">#   callback_data  ,    </span>
<span class="hljs-variable">$button1</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Test1"</span>; callback_data = <span class="hljs-string">"Test1_CD"</span>}
<span class="hljs-variable">$button2</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Test2"</span>; callback_data = <span class="hljs-string">"Test2_CD"</span>}
<span class="hljs-variable">$buttons</span> = (<span class="hljs-variable">$button1</span>, <span class="hljs-variable">$button2</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendKeyboard</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$buttons</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{<span class="hljs-string">"inline_keyboard"</span> = <span class="hljs-selector-tag">@</span>(,<span class="hljs-variable">$buttons</span>)}
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        reply_markup = <span class="hljs-variable">$keyboard</span><font></font>
        chat_id = ********<font></font>
        text = <span class="hljs-string">"Test Text"</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL_set</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span><font></font>
    <font></font>
}<font></font>
<font></font>
sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> </code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スイッチブロックを少し変更してすべてをまとめる</font></font></b><div class="spoiler_text"><pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment"># timeout sec</span>
<span class="hljs-variable">$timeout</span> = <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span><font></font>
<font></font>
    <span class="hljs-comment">#$data.update_id</span>
    <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
    <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
    <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
    <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
    <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
    <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
<font></font>
    <span class="hljs-comment">#   text </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$text</span>)<font></font>
    {<font></font>
        <span class="hljs-comment"># confirm</span>
        <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
<font></font>
        <span class="hljs-comment"># HashTable</span>
        <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
        <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
    }<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-comment">#  HashTable,      </span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{<font></font>
        text = <span class="hljs-variable">$text</span>
        <span class="hljs-comment">#    Markdown</span>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        chat_id = <span class="hljs-variable">$chat_id</span><font></font>
    }<font></font>
    <span class="hljs-comment">#      json</span>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
    <span class="hljs-comment">#   Invoke-RestMethod,        Invoke-WebRequest</span>
    <span class="hljs-comment"># Method Post - ..  ,   Get</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span> | <span class="hljs-built_in">Out-Null</span>   <font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendKeyboard</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$buttons</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{<span class="hljs-string">"inline_keyboard"</span> = <span class="hljs-selector-tag">@</span>(,<span class="hljs-variable">$buttons</span>)}
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        reply_markup = <span class="hljs-variable">$keyboard</span>
        chat_id = <span class="hljs-variable">$chat_id</span>
        text = <span class="hljs-variable">$text</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span><font></font>
    <font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-variable">$return</span> = getUpdates <span class="hljs-variable">$URL_get</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$return</span>)<font></font>
    {<font></font>
        <span class="hljs-comment"># http://apps.timwhitlock.info/emoji/tables/unicode#block-1-emoticons</span>
        <span class="hljs-comment">#sendMessage $URL_set $return.chat_id (Get-Random("", "", "", ""))</span>
        <span class="hljs-built_in">write-host</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>["</span>chat_id<span class="hljs-string">"])"</span>
        <span class="hljs-keyword">switch</span> <span class="hljs-operator">-Wildcard</span> (<span class="hljs-variable">$return</span>[<span class="hljs-string">"text"</span>])<font></font>
        {<font></font>
            <span class="hljs-string">"**"</span> {
                <span class="hljs-variable">$button1</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Project1"</span>; callback_data = <span class="hljs-string">"Project1_CD"</span>}
                <span class="hljs-variable">$button2</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Project2"</span>; callback_data = <span class="hljs-string">"Project2_CD"</span>}
                <span class="hljs-variable">$buttons</span> = (<span class="hljs-variable">$button1</span>, <span class="hljs-variable">$button2</span>)
                <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available projects:"</span>
                <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$return</span>.chat_id<font></font>
                sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$chat_id</span> <span class="hljs-variable">$text</span>
                <span class="hljs-comment">#sendMessage $URL_set $return.chat_id ", $($return["f_name"])" </span><font></font>
            }<font></font>
            <span class="hljs-string">"* ?*"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">""</span> }<font></font>
            default {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"<span class="hljs-variable">$</span>(Get-Random("</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">"))"</span>}<font></font>
        } <font></font>
 <font></font>
<font></font>
    }<font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span>
}</code></pre> <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今度は、「こんにちは」ボットからいくつかのボタンが送信されます。</font><font style="vertical-align: inherit;">ユーザーがどのボタンをクリックしたかを理解する必要があります。</font><font style="vertical-align: inherit;">現在のps関数getUpdatesは、</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$text</span>)...</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボタンをクリックしても、テキストは返されないため、関数を変更する必要があります。</font><font style="vertical-align: inherit;">ボタンをクリックし、</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mk/cb/la/mkcblawc0-d6uppcfqnkvgzrabo.jpeg" alt="ボタンを押す"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを実行して</font><i><font style="vertical-align: inherit;">$データの</font></i><font style="vertical-align: inherit;">内容を確認し</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></i><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment"># timeout sec</span>
<span class="hljs-variable">$timeout</span> = <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span><font></font>
<font></font>
    <span class="hljs-variable">$data</span>
<span class="hljs-comment">&lt;#
    $chat_id = $data.message.chat.id
    $text = $data.message.text
    $f_name = $data.message.chat.first_name
    $l_name = $data.message.chat.last_name
    $type = $data.message.chat.type
    $username = $data.message.chat.username

    #   text 
    if($text)
    {
        # confirm
        Invoke-RestMethod "$($URL)?offset=$($($data.update_id)+1)" -Method Get | Out-Null

        # HashTable
        $ht = @{}
        $ht["chat_id"] = $chat_id
        $ht["text"] = $text
        $ht["f_name"] = $f_name
        $ht["l_name"] = $l_name
        $ht["username"] = $username
        return $ht
    }
#&gt;</span><font></font>
}<font></font>
<font></font>
getUpdates <span class="hljs-variable">$URL_get</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージはもう届きません。</font><font style="vertical-align: inherit;">代わりに、現在は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">callback_query</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">編集機能</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment"># timeout sec</span>
<span class="hljs-variable">$timeout</span> = <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span>.callback_query)<font></font>
    {  <font></font>
        <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$data</span>.callback_query.data
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.callback_query.from.id
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.last_name
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.callback_query.from.username<font></font>
    }<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$data</span>.message)<font></font>
    {<font></font>
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
        <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
        <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"callback_data"</span>] = <span class="hljs-variable">$callback_data</span>
    <span class="hljs-comment"># confirm</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
    <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
}<font></font>
getUpdates <span class="hljs-variable">$URL_get</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージが存在する場合</font><font style="vertical-align: inherit;">
、関数は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返し</font><font style="vertical-align: inherit;">ます。ボタンがクリックされた場合は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">callback_dataを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">テストの段階で、次の呼び出し時にエラーが発生しました。</font></font><br>
<br>
<pre><code class="powershell hljs">sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.chat_id) <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.callback_data)</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">起動-RestMethod：{「OK」：偽、「ERROR_CODE」：400、「説明」：「不正な要求は：解析エンティティすることはできませんが、バイトで始まるエンティティの終わりを見つけることができませんが8オフセット」}</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ので</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parse_modeがある</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セットで</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Markdownを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、テキスト送信します</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$return</span>.callback_data = “Project1_CD”</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
送信する前にメッセージをフォーマットする必要があります。詳細については、</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">//core.telegram.org/bots/api#formatting-options</font></a></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
またはアンダースコア「_」を削除して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ください</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終スクリプト</font></font></b><div class="spoiler_text"><pre><code class="powershell hljs"><span class="hljs-comment"># Token</span>
<span class="hljs-variable">$token</span> = <span class="hljs-string">"***********************"</span>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-comment"># timeout sec</span>
<span class="hljs-variable">$timeout</span> = <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span><font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-variable">$text</span> = <span class="hljs-variable">$null</span>
    <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$null</span><font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span>.callback_query)<font></font>
    {  <font></font>
        <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$data</span>.callback_query.data
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.callback_query.from.id
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.last_name
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.callback_query.from.username<font></font>
    }<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$data</span>.message)<font></font>
    {<font></font>
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
        <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
        <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"callback_data"</span>] = <span class="hljs-variable">$callback_data</span>
    <span class="hljs-comment"># confirm</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
    <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-comment">#  HashTable,      </span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{<font></font>
        text = <span class="hljs-variable">$text</span>
        <span class="hljs-comment">#    Markdown</span>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        chat_id = <span class="hljs-variable">$chat_id</span><font></font>
    }<font></font>
    <span class="hljs-comment">#      json</span>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
    <span class="hljs-comment">#   Invoke-RestMethod,        Invoke-WebRequest</span>
    <span class="hljs-comment"># Method Post - ..  ,   Get</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span> | <span class="hljs-built_in">Out-Null</span>   <font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendKeyboard</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$buttons</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{<span class="hljs-string">"inline_keyboard"</span> = <span class="hljs-selector-tag">@</span>(,<span class="hljs-variable">$buttons</span>)}
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        reply_markup = <span class="hljs-variable">$keyboard</span>
        chat_id = <span class="hljs-variable">$chat_id</span>
        text = <span class="hljs-variable">$text</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span><font></font>
    <font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-variable">$return</span> = getUpdates <span class="hljs-variable">$URL_get</span>
    <span class="hljs-comment">#$return</span><font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$return</span>.text)<font></font>
    {<font></font>
<font></font>
        <span class="hljs-comment"># http://apps.timwhitlock.info/emoji/tables/unicode#block-1-emoticons</span>
        <span class="hljs-comment">#sendMessage $URL_set $return.chat_id (Get-Random("", "", "", ""))</span>
        <span class="hljs-built_in">write-host</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>["</span>chat_id<span class="hljs-string">"])"</span>
        <span class="hljs-keyword">switch</span> <span class="hljs-operator">-Wildcard</span> (<span class="hljs-variable">$return</span>[<span class="hljs-string">"text"</span>])<font></font>
        {<font></font>
            <span class="hljs-string">"**"</span> {
                <span class="hljs-variable">$button1</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Project1"</span>; callback_data = <span class="hljs-string">"Project1CD"</span>}
                <span class="hljs-variable">$button2</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-string">"Project2"</span>; callback_data = <span class="hljs-string">"Project2CD"</span>}
                <span class="hljs-variable">$buttons</span> = (<span class="hljs-variable">$button1</span>, <span class="hljs-variable">$button2</span>)
                <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available projects:"</span>
                <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$return</span>.chat_id<font></font>
                sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$chat_id</span> <span class="hljs-variable">$text</span>
                <span class="hljs-comment">#sendMessage $URL_set $return.chat_id ", $($return["f_name"])" </span><font></font>
            }<font></font>
            <span class="hljs-string">"* ?*"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">""</span> }<font></font>
            default {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"<span class="hljs-variable">$</span>(Get-Random("</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">"))"</span>}<font></font>
        }  <font></font>
<font></font>
    }<font></font>
    <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$return</span>.callback_data)<font></font>
    {<font></font>
        sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.chat_id) <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.callback_data)<font></font>
    }<font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span><font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート3：構成を行う</font></font></h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてを構成に入れる時が来ました。</font><font style="vertical-align: inherit;">ここではすべてが単純です-xmlを実行します。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">config</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">system</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">token</span>&gt;</span>***********************<span class="hljs-tag">&lt;/<span class="hljs-name">token</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">timeout</span> <span class="hljs-attr">desc</span>=<span class="hljs-string">"bot check timeout in seconds"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">timeout</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">system</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">tasks</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">task</span> <span class="hljs-attr">name</span>=<span class="hljs-string">" "</span> <span class="hljs-attr">script</span>=<span class="hljs-string">"c:\Temp\Habr\reboot_all.ps1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">task</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">task</span> <span class="hljs-attr">name</span>=<span class="hljs-string">" "</span> <span class="hljs-attr">script</span>=<span class="hljs-string">"c:\Temp\Habr\status.ps1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">task</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">task</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ipconfig1"</span> <span class="hljs-attr">script</span>=<span class="hljs-string">"ipconfig"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">task</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">task</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ipconfig2"</span> <span class="hljs-attr">script</span>=<span class="hljs-string">"ipconfig"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">task</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">task</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ipconfig3"</span> <span class="hljs-attr">script</span>=<span class="hljs-string">"ipconfig"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">task</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">task</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ipconfig4"</span> <span class="hljs-attr">script</span>=<span class="hljs-string">"ipconfig"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">task</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">task</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ipconfig5"</span> <span class="hljs-attr">script</span>=<span class="hljs-string">"ipconfig"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">task</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">tasks</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">config</span>&gt;</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクについて説明し、各タスクのスクリプトまたはコマンドを指定します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはチェックします：</font></font><br>
<br>
<pre><code class="powershell hljs">[<span class="hljs-built_in">xml</span>]<span class="hljs-variable">$xmlConfig</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-Path</span> (<span class="hljs-string">"c:\Temp\Habr\telegram_bot.xml"</span>)
<span class="hljs-variable">$token</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.token
<span class="hljs-variable">$timeout</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.timeout.<span class="hljs-string">'#text'</span><font></font>
<font></font>
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$task</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$xmlConfig</span>.config.tasks.task)<font></font>
{<font></font>
    <span class="hljs-variable">$task</span>.name   <span class="hljs-comment">#  </span>
    <span class="hljs-variable">$task</span>.script <span class="hljs-comment"># </span>
}</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メインスクリプトに配置する</font></font></b><div class="spoiler_text"><pre><code class="powershell hljs">[<span class="hljs-built_in">xml</span>]<span class="hljs-variable">$xmlConfig</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-Path</span> (<span class="hljs-string">"c:\Temp\Habr\telegram_bot.xml"</span>)
<span class="hljs-variable">$token</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.token
<span class="hljs-variable">$timeout</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.timeout.<span class="hljs-string">'#text'</span><font></font>
<font></font>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span>
    <span class="hljs-comment">#  </span>
    <span class="hljs-variable">$text</span> = <span class="hljs-variable">$null</span>
    <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$null</span><font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span>.callback_query)<font></font>
    {  <font></font>
        <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$data</span>.callback_query.data
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.callback_query.from.id
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.last_name
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.callback_query.from.username<font></font>
    }<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$data</span>.message)<font></font>
    {<font></font>
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
        <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
        <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"callback_data"</span>] = <span class="hljs-variable">$callback_data</span>
    <span class="hljs-comment"># confirm</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
    <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-comment">#  HashTable,      </span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{<font></font>
        text = <span class="hljs-variable">$text</span>
        <span class="hljs-comment">#    Markdown</span>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        chat_id = <span class="hljs-variable">$chat_id</span><font></font>
    }<font></font>
    <span class="hljs-comment">#      json</span>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
    <span class="hljs-comment">#   Invoke-RestMethod,        Invoke-WebRequest</span>
    <span class="hljs-comment"># Method Post - ..  ,   Get</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span> | <span class="hljs-built_in">Out-Null</span>   <font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendKeyboard</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$buttons</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{<span class="hljs-string">"inline_keyboard"</span> = <span class="hljs-selector-tag">@</span>(,<span class="hljs-variable">$buttons</span>)}
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        reply_markup = <span class="hljs-variable">$keyboard</span>
        chat_id = <span class="hljs-variable">$chat_id</span>
        text = <span class="hljs-variable">$text</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span><font></font>
    <font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-variable">$return</span> = getUpdates <span class="hljs-variable">$URL_get</span><font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$return</span>.text)<font></font>
    {<font></font>
<font></font>
        <span class="hljs-comment"># http://apps.timwhitlock.info/emoji/tables/unicode#block-1-emoticons</span>
        <span class="hljs-comment">#sendMessage $URL_set $return.chat_id (Get-Random("", "", "", ""))</span>
        <span class="hljs-built_in">write-host</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>["</span>chat_id<span class="hljs-string">"])"</span>
        <span class="hljs-keyword">switch</span> <span class="hljs-operator">-Wildcard</span> (<span class="hljs-variable">$return</span>[<span class="hljs-string">"text"</span>])<font></font>
        {<font></font>
            <span class="hljs-string">"**"</span> {<font></font>
<font></font>
                <span class="hljs-comment">#  </span>
                <span class="hljs-variable">$buttons</span> = <span class="hljs-selector-tag">@</span>()
                <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$task</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$xmlConfig</span>.config.tasks.task)<font></font>
                {<font></font>
                    <span class="hljs-variable">$button</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-variable">$task</span>.name; callback_data = <span class="hljs-variable">$task</span>.script}
                    <span class="hljs-variable">$buttons</span> += <span class="hljs-variable">$button</span><font></font>
                }<font></font>
                <font></font>
                <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available tasks:"</span>
                <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$return</span>.chat_id<font></font>
                sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$chat_id</span> <span class="hljs-variable">$text</span>
                <span class="hljs-comment">#sendMessage $URL_set $return.chat_id ", $($return["f_name"])" </span><font></font>
            }<font></font>
            <span class="hljs-string">"* ?*"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">""</span> }<font></font>
            default {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"<span class="hljs-variable">$</span>(Get-Random("</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">"))"</span>}<font></font>
        } <font></font>
 <font></font>
<font></font>
    }<font></font>
    <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$return</span>.callback_data)<font></font>
    {<font></font>
        sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.chat_id) <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.callback_data)<font></font>
    }<font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで「hello」と書くと、ボットはxmlファイルに記述されているタスクに対応するボタンのリストを返します。</font><font style="vertical-align: inherit;">callback_dataにコマンドまたはスクリプトがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
表面的な変更を行う場合は、1行あたり3〜4個のボタンがあることが望ましいです。そうでない場合、ボタンは完全に表示されません</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/ou/e_/qooue_7hsolqk_36nwxicfs_kt0.jpeg" alt="キーボード"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。1行あたり3つのボタンを実行します（最大）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
概略的に、キーボード配列は次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gc/sf/el/gcsfelyplaffrofxzcjtpyovtuw.jpeg" alt="キーボード"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボタン[i]-フォームの配列（連想）</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$button</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-variable">$task</span>.name; callback_data = <span class="hljs-variable">$task</span>.script}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行[1-3]は、ボタンの配列を格納する（ボタンからの）配列です（これは重要です）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーボードはLine'ovの配列です。</font><i><font style="vertical-align: inherit;">sendKeyboard</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
関数を変更する</font></font><i><font style="vertical-align: inherit;"></font></i><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendKeyboard</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$buttons</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{    <font></font>
    <span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-comment">#    ArrayList, .       -  </span>
    <span class="hljs-variable">$lines</span> = <span class="hljs-number">3</span> <font></font>
    <font></font>
    <span class="hljs-variable">$buttons_line</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList
    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$buttons</span>.Count; <span class="hljs-variable">$i</span>++)<font></font>
    {<font></font>
        <span class="hljs-comment">#     (line).    3 -  line  keyboard</span>
        <span class="hljs-variable">$buttons_line</span>.Add(<span class="hljs-variable">$buttons</span>[<span class="hljs-variable">$i</span>]) | <span class="hljs-built_in">Out-Null</span>
        <span class="hljs-comment">#   -      0</span>
        <span class="hljs-keyword">if</span>( (<span class="hljs-variable">$i</span> + <span class="hljs-number">1</span> )%<span class="hljs-variable">$lines</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span> )<font></font>
        {<font></font>
            <span class="hljs-comment">#     keyboard</span>
            <span class="hljs-variable">$keyboard</span>[<span class="hljs-string">"inline_keyboard"</span>] += <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$buttons_line</span>))
            <span class="hljs-variable">$buttons_line</span>.Clear()<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">#    </span>
    <span class="hljs-variable">$keyboard</span>[<span class="hljs-string">"inline_keyboard"</span>] += <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$buttons_line</span>))    <font></font>
    <font></font>
    <span class="hljs-comment">#$keyboard = @{"inline_keyboard" = @(,$buttons)}</span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        reply_markup = <span class="hljs-variable">$keyboard</span>
        chat_id = <span class="hljs-variable">$chat_id</span>
        text = <span class="hljs-variable">$text</span><font></font>
    }<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span>    <font></font>
} <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはチェックします：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/de/bm/cu/debmcuonvv9pedmpe0s6pfcik-y.jpeg" alt="キーボード_テレグラム"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終スクリプト</font></font></b><div class="spoiler_text"><pre><code class="powershell hljs">[<span class="hljs-built_in">xml</span>]<span class="hljs-variable">$xmlConfig</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-Path</span> (<span class="hljs-string">"c:\Temp\Habr\telegram_bot.xml"</span>)
<span class="hljs-variable">$token</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.token
<span class="hljs-variable">$timeout</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.timeout.<span class="hljs-string">'#text'</span><font></font>
<font></font>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span>
    <span class="hljs-comment">#  </span>
    <span class="hljs-variable">$text</span> = <span class="hljs-variable">$null</span>
    <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$null</span><font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span>.callback_query)<font></font>
    {  <font></font>
        <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$data</span>.callback_query.data
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.callback_query.from.id
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.last_name
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.callback_query.from.username<font></font>
    }<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$data</span>.message)<font></font>
    {<font></font>
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
        <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
        <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"callback_data"</span>] = <span class="hljs-variable">$callback_data</span>
    <span class="hljs-comment"># confirm</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
    <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-comment">#  HashTable,      </span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{<font></font>
        text = <span class="hljs-variable">$text</span>
        <span class="hljs-comment">#    Markdown</span>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        chat_id = <span class="hljs-variable">$chat_id</span><font></font>
    }<font></font>
    <span class="hljs-comment">#      json</span>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
    <span class="hljs-comment">#   Invoke-RestMethod,        Invoke-WebRequest</span>
    <span class="hljs-comment"># Method Post - ..  ,   Get</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span> | <span class="hljs-built_in">Out-Null</span>   <font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendKeyboard</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$buttons</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <font></font>
    <span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-comment">#    ArrayList, .       -  </span>
	<span class="hljs-variable">$lines</span> = <span class="hljs-number">3</span> <font></font>
<font></font>
    <span class="hljs-variable">$buttons_line</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList
    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$buttons</span>.Count; <span class="hljs-variable">$i</span>++)<font></font>
    {<font></font>
        <span class="hljs-comment">#     (line).    3 -  line  keyboard</span>
        <span class="hljs-variable">$buttons_line</span>.Add(<span class="hljs-variable">$buttons</span>[<span class="hljs-variable">$i</span>]) | <span class="hljs-built_in">Out-Null</span>
        <span class="hljs-comment">#   -      0</span>
        <span class="hljs-keyword">if</span>( (<span class="hljs-variable">$i</span> + <span class="hljs-number">1</span> )%<span class="hljs-variable">$lines</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span> )<font></font>
        {<font></font>
            <span class="hljs-comment">#     keyboard</span>
            <span class="hljs-variable">$keyboard</span>[<span class="hljs-string">"inline_keyboard"</span>] += <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$buttons_line</span>))
            <span class="hljs-variable">$buttons_line</span>.Clear()<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">#    </span>
    <span class="hljs-variable">$keyboard</span>[<span class="hljs-string">"inline_keyboard"</span>] += <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$buttons_line</span>))<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        reply_markup = <span class="hljs-variable">$keyboard</span>
        chat_id = <span class="hljs-variable">$chat_id</span>
        text = <span class="hljs-variable">$text</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span><font></font>
    <font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-variable">$return</span> = getUpdates <span class="hljs-variable">$URL_get</span>
    <span class="hljs-comment">#$return.text = ""</span>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$return</span>.text)<font></font>
    {<font></font>
<font></font>
        <span class="hljs-comment"># http://apps.timwhitlock.info/emoji/tables/unicode#block-1-emoticons</span>
        <span class="hljs-comment">#sendMessage $URL_set $return.chat_id (Get-Random("", "", "", ""))</span>
        <span class="hljs-keyword">switch</span> <span class="hljs-operator">-Wildcard</span> (<span class="hljs-variable">$return</span>[<span class="hljs-string">"text"</span>])<font></font>
        {<font></font>
            <span class="hljs-string">"**"</span> {<font></font>
<font></font>
                <span class="hljs-comment">#  </span>
                <span class="hljs-variable">$buttons</span> = <span class="hljs-selector-tag">@</span>()
                <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$task</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$xmlConfig</span>.config.tasks.task)<font></font>
                {<font></font>
                    <span class="hljs-variable">$i</span>++
                    <span class="hljs-variable">$button</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-variable">$task</span>.name; callback_data = <span class="hljs-variable">$task</span>.script}
                    <span class="hljs-variable">$buttons</span> += <span class="hljs-variable">$button</span><font></font>
                }<font></font>
                <font></font>
                <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available tasks:"</span>
                <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$return</span>.chat_id<font></font>
                sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$chat_id</span> <span class="hljs-variable">$text</span>
                <span class="hljs-comment">#sendMessage $URL_set $return.chat_id ", $($return["f_name"])" </span><font></font>
            }<font></font>
            <span class="hljs-string">"* ?*"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">""</span> }<font></font>
            default {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"<span class="hljs-variable">$</span>(Get-Random("</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">"))"</span>}<font></font>
        } <font></font>
 <font></font>
<font></font>
    }<font></font>
    <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$return</span>.callback_data)<font></font>
    {<font></font>
        <span class="hljs-comment">#sendMessage $URL_set $($return.chat_id) $($return.callback_data)</span>
        <span class="hljs-built_in">write-host</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.chat_id) <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.callback_data)"</span><font></font>
    }<font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span><font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート4：タスクとマルチタスク</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボタンが実行する時間です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マルチタスクでは、ジョブメカニズムを使用します。</font><font style="vertical-align: inherit;">このコードを確認してください：</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$script</span> = <span class="hljs-string">"ipconfig"</span>
<span class="hljs-variable">$script_block</span> = { <span class="hljs-keyword">Param</span>(<span class="hljs-variable">$script</span>) ; <span class="hljs-built_in">Invoke-Expression</span> <span class="hljs-variable">$script</span> }
<span class="hljs-variable">$job_name</span> = <span class="hljs-string">"TestJob"</span>
<span class="hljs-built_in">Start-Job</span> <span class="hljs-literal">-ScriptBlock</span> <span class="hljs-variable">$script_block</span> <span class="hljs-literal">-ArgumentList</span> <span class="hljs-variable">$script</span> <span class="hljs-literal">-Name</span> <span class="hljs-variable">$job_name</span> | <span class="hljs-built_in">Out-Null</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして5秒後、次のようにします。</font></font><br>
<pre><code class="powershell hljs">
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$job</span> <span class="hljs-keyword">in</span> (<span class="hljs-built_in">Get-Job</span> | <span class="hljs-built_in">Where</span> {<span class="hljs-variable">$_</span>.State <span class="hljs-operator">-eq</span> <span class="hljs-string">"Completed"</span>} ))<font></font>
{<font></font>
    <span class="hljs-variable">$output</span> = <span class="hljs-built_in">Get-Job</span> <span class="hljs-literal">-ID</span> <span class="hljs-variable">$job</span>.Id | <span class="hljs-built_in">Receive-Job</span>
    <span class="hljs-variable">$output</span>
    <span class="hljs-variable">$job</span> | <span class="hljs-built_in">Remove-Job</span><font></font>
} <font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$出力</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はlocalhostでipconfigを返すはずです</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これをメインスクリプトのcallback_dataブロックに追加してください</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-comment">#     </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$return</span>.callback_data)<font></font>
    {<font></font>
        <span class="hljs-variable">$script</span> = <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.callback_data)
        <span class="hljs-variable">$job_name</span> = <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.chat_id)<font></font>
<font></font>
        <span class="hljs-variable">$script_block</span> = { <span class="hljs-keyword">Param</span>(<span class="hljs-variable">$script</span>) ; <span class="hljs-built_in">Invoke-Expression</span> <span class="hljs-variable">$script</span> } <font></font>
<font></font>
        <span class="hljs-comment"># Job</span>
        <span class="hljs-built_in">Start-Job</span> <span class="hljs-literal">-ScriptBlock</span> <span class="hljs-variable">$script_block</span> <span class="hljs-literal">-ArgumentList</span> <span class="hljs-variable">$script</span> <span class="hljs-literal">-Name</span> <span class="hljs-variable">$job_name</span> | <span class="hljs-built_in">Out-Null</span>        <font></font>
<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてこれは以下です</font></font><br>
<br>
<pre><code class="powershell hljs">
        <span class="hljs-comment"># ,  job'  </span>
        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$job</span> <span class="hljs-keyword">in</span> (<span class="hljs-built_in">Get-Job</span> | <span class="hljs-built_in">Where</span> {<span class="hljs-variable">$_</span>.State <span class="hljs-operator">-eq</span> <span class="hljs-string">"Completed"</span>} ))<font></font>
        {<font></font>
            <font></font>
            <span class="hljs-variable">$output</span> = <span class="hljs-built_in">Get-Job</span> <span class="hljs-literal">-ID</span> <span class="hljs-variable">$job</span>.Id | <span class="hljs-built_in">Receive-Job</span><font></font>
      <font></font>
            <span class="hljs-comment">#   ,   job</span>
            sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$job</span>.Name <span class="hljs-variable">$output</span><font></font>
<font></font>
            <span class="hljs-variable">$job</span> | <span class="hljs-built_in">Remove-Job</span><font></font>
<font></font>
            <span class="hljs-comment">#    </span>
            <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available tasks:"</span>
            sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$job</span>.Name <span class="hljs-variable">$text</span>
        } </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェック、エラーの検出</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoke-RestMethod：{"ok"：false、 "error_code"：400、 "description"： "Bad Request：message is too long"}</font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
インターネット上で、メッセージの長さが4096文字を超えることはできないという情報が見つかりました。</font><font style="vertical-align: inherit;">オーケー...</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$output</span>.Length</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長さ39と言い</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。何が悪いのか長い間考えた結果、次のコードを試します。</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$text</span> = <span class="hljs-variable">$null</span>
<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$string</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$output</span>)<font></font>
{<font></font>
    <span class="hljs-variable">$text</span> = <span class="hljs-string">"<span class="hljs-variable">$text</span>`n<span class="hljs-variable">$string</span>"</span><font></font>
} <font></font>
sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$job</span>.Name <span class="hljs-variable">$text</span> </code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはすべてを一緒に試します</font></font></b><div class="spoiler_text"><pre><code class="powershell hljs">[<span class="hljs-built_in">xml</span>]<span class="hljs-variable">$xmlConfig</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-Path</span> (<span class="hljs-string">"c:\Temp\Habr\telegram_bot.xml"</span>)
<span class="hljs-variable">$token</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.token
<span class="hljs-variable">$timeout</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.timeout.<span class="hljs-string">'#text'</span><font></font>
<font></font>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span>
    <span class="hljs-comment">#  </span>
    <span class="hljs-variable">$text</span> = <span class="hljs-variable">$null</span>
    <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$null</span><font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span>.callback_query)<font></font>
    {  <font></font>
        <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$data</span>.callback_query.data
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.callback_query.from.id
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.last_name
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.callback_query.from.username<font></font>
    }<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$data</span>.message)<font></font>
    {<font></font>
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
        <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
        <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"callback_data"</span>] = <span class="hljs-variable">$callback_data</span>
    <span class="hljs-comment"># confirm</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
    <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-comment">#  HashTable,      </span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{<font></font>
        text = <span class="hljs-variable">$text</span>
        <span class="hljs-comment">#    Markdown</span>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        chat_id = <span class="hljs-variable">$chat_id</span><font></font>
    }<font></font>
    <span class="hljs-comment">#      json</span>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
    <span class="hljs-comment">#   Invoke-RestMethod,        Invoke-WebRequest</span>
    <span class="hljs-comment"># Method Post - ..  ,   Get</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span> | <span class="hljs-built_in">Out-Null</span><font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendKeyboard</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$buttons</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <font></font>
    <span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-variable">$lines</span> = <span class="hljs-number">3</span>
    <span class="hljs-comment">#    ArrayList, .       -  </span>
    <span class="hljs-variable">$buttons_line</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList
    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$buttons</span>.Count; <span class="hljs-variable">$i</span>++)<font></font>
    {<font></font>
        <span class="hljs-comment">#     (line).    3 -  line  keyboard</span>
        <span class="hljs-variable">$buttons_line</span>.Add(<span class="hljs-variable">$buttons</span>[<span class="hljs-variable">$i</span>]) | <span class="hljs-built_in">Out-Null</span>
        <span class="hljs-comment">#   -      0</span>
        <span class="hljs-keyword">if</span>( (<span class="hljs-variable">$i</span> + <span class="hljs-number">1</span> )%<span class="hljs-variable">$lines</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span> )<font></font>
        {<font></font>
            <span class="hljs-comment">#     keyboard</span>
            <span class="hljs-variable">$keyboard</span>[<span class="hljs-string">"inline_keyboard"</span>] += <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$buttons_line</span>))
            <span class="hljs-variable">$buttons_line</span>.Clear()<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">#    </span>
    <span class="hljs-variable">$keyboard</span>[<span class="hljs-string">"inline_keyboard"</span>] += <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$buttons_line</span>))<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        reply_markup = <span class="hljs-variable">$keyboard</span>
        chat_id = <span class="hljs-variable">$chat_id</span>
        text = <span class="hljs-variable">$text</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span><font></font>
    <font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-variable">$return</span> = getUpdates <span class="hljs-variable">$URL_get</span>
    <span class="hljs-comment">#$return.text = ""</span>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$return</span>.text)<font></font>
    {<font></font>
<font></font>
        <span class="hljs-comment"># http://apps.timwhitlock.info/emoji/tables/unicode#block-1-emoticons</span>
        <span class="hljs-comment">#sendMessage $URL_set $return.chat_id (Get-Random("", "", "", ""))</span>
        <span class="hljs-keyword">switch</span> <span class="hljs-operator">-Wildcard</span> (<span class="hljs-variable">$return</span>[<span class="hljs-string">"text"</span>])<font></font>
        {<font></font>
            <span class="hljs-string">"**"</span> {<font></font>
<font></font>
                <span class="hljs-comment">#  </span>
                <span class="hljs-variable">$buttons</span> = <span class="hljs-selector-tag">@</span>()
                <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$task</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$xmlConfig</span>.config.tasks.task)<font></font>
                {<font></font>
                    <span class="hljs-variable">$i</span>++
                    <span class="hljs-variable">$button</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-variable">$task</span>.name; callback_data = <span class="hljs-variable">$task</span>.script}
                    <span class="hljs-variable">$buttons</span> += <span class="hljs-variable">$button</span><font></font>
                }<font></font>
                <font></font>
                <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available tasks:"</span>
                <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$return</span>.chat_id<font></font>
                sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$chat_id</span> <span class="hljs-variable">$text</span>
                <span class="hljs-comment">#sendMessage $URL_set $return.chat_id ", $($return["f_name"])" </span><font></font>
            }<font></font>
            <span class="hljs-string">"* ?*"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">""</span> }<font></font>
            default {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"<span class="hljs-variable">$</span>(Get-Random("</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">"))"</span>}<font></font>
        } <font></font>
 <font></font>
<font></font>
    }<font></font>
         <span class="hljs-comment">#     </span>
        <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$return</span>.callback_data)<font></font>
        {<font></font>
            <span class="hljs-variable">$script</span> = <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.callback_data)
            <span class="hljs-variable">$job_name</span> = <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.chat_id)
            <span class="hljs-built_in">write-host</span> <span class="hljs-string">"<span class="hljs-variable">$script</span> <span class="hljs-variable">$job_name</span>"</span><font></font>
<font></font>
            <span class="hljs-variable">$script_block</span> = { <span class="hljs-keyword">Param</span>(<span class="hljs-variable">$script</span>) ; <span class="hljs-built_in">Invoke-Expression</span> <span class="hljs-variable">$script</span> }<font></font>
<font></font>
            <span class="hljs-comment"># Job</span>
            <span class="hljs-built_in">Start-Job</span> <span class="hljs-literal">-ScriptBlock</span> <span class="hljs-variable">$script_block</span> <span class="hljs-literal">-ArgumentList</span> <span class="hljs-variable">$script</span> <span class="hljs-literal">-Name</span> <span class="hljs-variable">$job_name</span> | <span class="hljs-built_in">Out-Null</span><font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"># ,  job'  </span>
        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$job</span> <span class="hljs-keyword">in</span> (<span class="hljs-built_in">Get-Job</span> | <span class="hljs-built_in">Where</span> {<span class="hljs-variable">$_</span>.State <span class="hljs-operator">-eq</span> <span class="hljs-string">"Completed"</span>} ))<font></font>
        {<font></font>
            <font></font>
            <span class="hljs-variable">$output</span> = <span class="hljs-built_in">Get-Job</span> <span class="hljs-literal">-ID</span> <span class="hljs-variable">$job</span>.Id | <span class="hljs-built_in">Receive-Job</span><font></font>
      <font></font>
            <span class="hljs-variable">$text</span> = <span class="hljs-variable">$null</span>
            <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$string</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$output</span>)<font></font>
            {<font></font>
                <span class="hljs-variable">$text</span> = <span class="hljs-string">"<span class="hljs-variable">$text</span>`n<span class="hljs-variable">$string</span>"</span><font></font>
            }<font></font>
            <span class="hljs-comment">#   ,   job</span>
            sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$job</span>.Name <span class="hljs-variable">$text</span><font></font>
<font></font>
            <span class="hljs-variable">$job</span> | <span class="hljs-built_in">Remove-Job</span><font></font>
<font></font>
            <span class="hljs-comment">#    </span>
            <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available tasks:"</span>
            sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$job</span>.Name <span class="hljs-variable">$text</span><font></font>
        } <font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span><font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<img src="https://habrastorage.org/webt/uc/0j/tj/uc0jtjsbxbvszrfqikmiebepq3m.jpeg" alt="出力"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、少しセキュリティを</font><font style="vertical-align: inherit;">調整してみましょう。xml構成に</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい行を追加し、それを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">users</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">呼び</font><font style="vertical-align: inherit;">、ボットと通信できる人のchat_idを示します。</font></font><br>
<br>
<pre><code class="xml hljs">	<span class="hljs-tag">&lt;<span class="hljs-name">system</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">token</span>&gt;</span>*********************************<span class="hljs-tag">&lt;/<span class="hljs-name">token</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">timeout</span> <span class="hljs-attr">desc</span>=<span class="hljs-string">"bot check timeout in seconds"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">timeout</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">users</span>&gt;</span>111111111, 222222222<span class="hljs-tag">&lt;/<span class="hljs-name">users</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">system</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトでは、</font><i><font style="vertical-align: inherit;">users</font></i><font style="vertical-align: inherit;">配列を取得し</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></i><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$users</span> = ((<span class="hljs-variable">$xmlConfig</span>.config.system.users).Split(<span class="hljs-string">","</span>)).Trim() </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてチェック</font></font><br>
<br>
<pre><code class="powershell hljs">     <span class="hljs-keyword">if</span>(<span class="hljs-variable">$users</span> <span class="hljs-operator">-contains</span> <span class="hljs-variable">$return</span>.chat_id)<font></font>
    { <font></font>
...<font></font>
    }</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプト全体</font></font></b><div class="spoiler_text"><pre><code class="powershell hljs">[<span class="hljs-built_in">xml</span>]<span class="hljs-variable">$xmlConfig</span> = <span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-Path</span> (<span class="hljs-string">"c:\Temp\Habr\telegram_bot.xml"</span>)
<span class="hljs-variable">$token</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.token
<span class="hljs-variable">$timeout</span> = <span class="hljs-variable">$xmlConfig</span>.config.system.timeout.<span class="hljs-string">'#text'</span>
<span class="hljs-variable">$users</span> = ((<span class="hljs-variable">$xmlConfig</span>.config.system.users).Split(<span class="hljs-string">","</span>)).Trim()<font></font>
<font></font>
<span class="hljs-comment"># Telegram URLs</span>
<span class="hljs-variable">$URL_get</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/getUpdates"</span>
<span class="hljs-variable">$URL_set</span> = <span class="hljs-string">"https://api.telegram.org/bot<span class="hljs-variable">$token</span>/sendMessage"</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUpdates</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$URL</span>
    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$json</span>.result | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Last</span> <span class="hljs-number">1</span>
    <span class="hljs-comment">#  </span>
    <span class="hljs-variable">$text</span> = <span class="hljs-variable">$null</span>
    <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$null</span><font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$data</span>.callback_query)<font></font>
    {  <font></font>
        <span class="hljs-variable">$callback_data</span> = <span class="hljs-variable">$data</span>.callback_query.data
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.callback_query.from.id
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.callback_query.from.last_name
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.callback_query.from.username<font></font>
    }<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$data</span>.message)<font></font>
    {<font></font>
        <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$data</span>.message.chat.id
        <span class="hljs-variable">$text</span> = <span class="hljs-variable">$data</span>.message.text
        <span class="hljs-variable">$f_name</span> = <span class="hljs-variable">$data</span>.message.chat.first_name
        <span class="hljs-variable">$l_name</span> = <span class="hljs-variable">$data</span>.message.chat.last_name
        <span class="hljs-variable">$type</span> = <span class="hljs-variable">$data</span>.message.chat.type
        <span class="hljs-variable">$username</span> = <span class="hljs-variable">$data</span>.message.chat.username<font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"chat_id"</span>] = <span class="hljs-variable">$chat_id</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"text"</span>] = <span class="hljs-variable">$text</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"f_name"</span>] = <span class="hljs-variable">$f_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"l_name"</span>] = <span class="hljs-variable">$l_name</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"username"</span>] = <span class="hljs-variable">$username</span>
    <span class="hljs-variable">$ht</span>[<span class="hljs-string">"callback_data"</span>] = <span class="hljs-variable">$callback_data</span>
    <span class="hljs-comment"># confirm</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$URL</span>)?offset=<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$data</span>.update_id)+1)"</span> <span class="hljs-literal">-Method</span> Get | <span class="hljs-built_in">Out-Null</span><font></font>
    <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ht</span><font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <span class="hljs-comment">#  HashTable,      </span>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{<font></font>
        text = <span class="hljs-variable">$text</span>
        <span class="hljs-comment">#    Markdown</span>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        chat_id = <span class="hljs-variable">$chat_id</span><font></font>
    }<font></font>
    <span class="hljs-comment">#      json</span>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span>
    <span class="hljs-comment">#   Invoke-RestMethod,        Invoke-WebRequest</span>
    <span class="hljs-comment"># Method Post - ..  ,   Get</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span> | <span class="hljs-built_in">Out-Null</span><font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendKeyboard</span><span class="hljs-params">(<span class="hljs-variable">$URL</span>, <span class="hljs-variable">$buttons</span>, <span class="hljs-variable">$chat_id</span>, <span class="hljs-variable">$text</span>)</span></span><font></font>
{<font></font>
    <font></font>
    <span class="hljs-variable">$keyboard</span> = <span class="hljs-selector-tag">@</span>{}
    <span class="hljs-variable">$lines</span> = <span class="hljs-number">3</span>
    <span class="hljs-comment">#    ArrayList, .       -  </span>
    <span class="hljs-variable">$buttons_line</span> = <span class="hljs-built_in">New-Object</span> System.Collections.ArrayList
    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$buttons</span>.Count; <span class="hljs-variable">$i</span>++)<font></font>
    {<font></font>
        <span class="hljs-comment">#     (line).    3 -  line  keyboard</span>
        <span class="hljs-variable">$buttons_line</span>.Add(<span class="hljs-variable">$buttons</span>[<span class="hljs-variable">$i</span>]) | <span class="hljs-built_in">Out-Null</span>
        <span class="hljs-comment">#   -      0</span>
        <span class="hljs-keyword">if</span>( (<span class="hljs-variable">$i</span> + <span class="hljs-number">1</span> )%<span class="hljs-variable">$lines</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span> )<font></font>
        {<font></font>
            <span class="hljs-comment">#     keyboard</span>
            <span class="hljs-variable">$keyboard</span>[<span class="hljs-string">"inline_keyboard"</span>] += <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$buttons_line</span>))
            <span class="hljs-variable">$buttons_line</span>.Clear()<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-comment">#    </span>
    <span class="hljs-variable">$keyboard</span>[<span class="hljs-string">"inline_keyboard"</span>] += <span class="hljs-selector-tag">@</span>(,<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$buttons_line</span>))<font></font>
<font></font>
    <span class="hljs-variable">$ht</span> = <span class="hljs-selector-tag">@</span>{ <font></font>
        parse_mode = <span class="hljs-string">"Markdown"</span>
        reply_markup = <span class="hljs-variable">$keyboard</span>
        chat_id = <span class="hljs-variable">$chat_id</span>
        text = <span class="hljs-variable">$text</span><font></font>
    }<font></font>
<font></font>
    <span class="hljs-variable">$json</span> = <span class="hljs-variable">$ht</span> | <span class="hljs-built_in">ConvertTo-Json</span> <span class="hljs-literal">-Depth</span> <span class="hljs-number">5</span>
    <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-variable">$URL</span> <span class="hljs-literal">-Method</span> Post <span class="hljs-literal">-ContentType</span> <span class="hljs-string">'application/json; charset=utf-8'</span> <span class="hljs-literal">-Body</span> <span class="hljs-variable">$json</span><font></font>
    <font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$true</span>) <span class="hljs-comment">#  </span><font></font>
{<font></font>
    <span class="hljs-variable">$return</span> = getUpdates <span class="hljs-variable">$URL_get</span><font></font>
    <font></font>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$users</span> <span class="hljs-operator">-contains</span> <span class="hljs-variable">$return</span>.chat_id)<font></font>
    {<font></font>
<font></font>
        <span class="hljs-comment">#   </span>
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$return</span>.text)<font></font>
        {<font></font>
            <span class="hljs-comment">#write-host $return.chat_id</span>
            <span class="hljs-comment"># http://apps.timwhitlock.info/emoji/tables/unicode#block-1-emoticons</span>
            <span class="hljs-comment">#sendMessage $URL_set $return.chat_id (Get-Random("", "", "", ""))</span>
            <span class="hljs-keyword">switch</span> <span class="hljs-operator">-Wildcard</span> (<span class="hljs-variable">$return</span>[<span class="hljs-string">"text"</span>])<font></font>
            {<font></font>
                <span class="hljs-string">"**"</span> {<font></font>
<font></font>
                    <span class="hljs-comment">#  </span>
                    <span class="hljs-variable">$buttons</span> = <span class="hljs-selector-tag">@</span>()
                    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$task</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$xmlConfig</span>.config.tasks.task)<font></font>
                    {<font></font>
                        <span class="hljs-variable">$i</span>++
                        <span class="hljs-variable">$button</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-variable">$task</span>.name; callback_data = <span class="hljs-variable">$task</span>.script}
                        <span class="hljs-variable">$buttons</span> += <span class="hljs-variable">$button</span><font></font>
                    }<font></font>
                <font></font>
                    <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available tasks:"</span>
                    <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$return</span>.chat_id<font></font>
                    sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$chat_id</span> <span class="hljs-variable">$text</span>
                    <span class="hljs-comment">#sendMessage $URL_set $return.chat_id ", $($return["f_name"])" </span><font></font>
                }<font></font>
                <span class="hljs-string">"* ?*"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">""</span> }<font></font>
                default {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"<span class="hljs-variable">$</span>(Get-Random("</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">"))"</span>}<font></font>
            } <font></font>
 <font></font>
<font></font>
        }<font></font>
        <span class="hljs-comment">#     </span>
        <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$return</span>.callback_data)<font></font>
        {<font></font>
            <span class="hljs-variable">$script</span> = <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.callback_data)
            <span class="hljs-variable">$job_name</span> = <span class="hljs-variable">$</span>(<span class="hljs-variable">$return</span>.chat_id)
            <span class="hljs-built_in">write-host</span> <span class="hljs-string">"<span class="hljs-variable">$script</span> <span class="hljs-variable">$job_name</span>"</span><font></font>
<font></font>
            <span class="hljs-variable">$script_block</span> = { <span class="hljs-keyword">Param</span>(<span class="hljs-variable">$script</span>) ; <span class="hljs-built_in">Invoke-Expression</span> <span class="hljs-variable">$script</span> }<font></font>
<font></font>
            <span class="hljs-comment"># Job</span>
            <span class="hljs-built_in">Start-Job</span> <span class="hljs-literal">-ScriptBlock</span> <span class="hljs-variable">$script_block</span> <span class="hljs-literal">-ArgumentList</span> <span class="hljs-variable">$script</span> <span class="hljs-literal">-Name</span> <span class="hljs-variable">$job_name</span> | <span class="hljs-built_in">Out-Null</span><font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"># ,  job'  </span>
        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$job</span> <span class="hljs-keyword">in</span> (<span class="hljs-built_in">Get-Job</span> | <span class="hljs-built_in">Where</span> {<span class="hljs-variable">$_</span>.State <span class="hljs-operator">-eq</span> <span class="hljs-string">"Completed"</span>} ))<font></font>
        {<font></font>
            <font></font>
            <span class="hljs-variable">$output</span> = <span class="hljs-built_in">Get-Job</span> <span class="hljs-literal">-ID</span> <span class="hljs-variable">$job</span>.Id | <span class="hljs-built_in">Receive-Job</span><font></font>
      <font></font>
            <span class="hljs-variable">$text</span> = <span class="hljs-variable">$null</span>
            <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$string</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$output</span>)<font></font>
            {<font></font>
                <span class="hljs-variable">$text</span> = <span class="hljs-string">"<span class="hljs-variable">$text</span>`n<span class="hljs-variable">$string</span>"</span><font></font>
            }<font></font>
            <span class="hljs-comment">#   ,   job</span>
            sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$job</span>.Name <span class="hljs-variable">$text</span><font></font>
<font></font>
            <span class="hljs-variable">$job</span> | <span class="hljs-built_in">Remove-Job</span><font></font>
<font></font>
            <span class="hljs-comment">#    </span>
            <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available tasks:"</span>
            sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$job</span>.Name <span class="hljs-variable">$text</span><font></font>
        }<font></font>
<font></font>
<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$return</span>.text)<font></font>
        {<font></font>
            sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"  ?    !"</span><font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-built_in">Start-Sleep</span> <span class="hljs-literal">-s</span> <span class="hljs-variable">$timeout</span>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート5：結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボットの機能をチェックします-何か便利なスクリプトを追加し</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ますリモートサーバーでの操作には、Invoke-Commandに続いてWrite-Outputを使用します</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$hostname</span> = <span class="hljs-string">"hostname"</span>
<span class="hljs-variable">$service</span> = <span class="hljs-string">"MSSQLSERVER"</span>
<span class="hljs-variable">$output</span> = <span class="hljs-built_in">Invoke-Command</span> <span class="hljs-literal">-ComputerName</span> <span class="hljs-variable">$hostname</span> <span class="hljs-literal">-ScriptBlock</span>{<span class="hljs-keyword">param</span>(<span class="hljs-variable">$service</span>); (<span class="hljs-built_in">Get-Service</span> <span class="hljs-literal">-Name</span> <span class="hljs-variable">$service</span>).Status} <span class="hljs-literal">-ArgumentList</span> <span class="hljs-variable">$service</span> 
<span class="hljs-built_in">write-output</span> <span class="hljs-variable">$output</span>.Value </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、テレグラムボットスクリプトを実行するアカウントには、リモートマシンに対する適切な権限が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ロギング機能には触れませんでしたが、ここでは、すべてが簡単で、思いのままに、誰がログに記録するか、しないかは自由に決定できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
確かに誰かが4096文字を超えるメッセージの送信に問題を抱えていますが、これはSubstringと送信ループによって解決されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に-世界中のどこからでも（ほとんどどこからでも）リモートコントロールは良いですが、何かがうまくいかないというリスクが常にあります（悪い人がボットコントロールを取得する可能性があります）。</font><font style="vertical-align: inherit;">この場合、特定の単語に対してスクリプトからExitを追加しました</font></font><br>
<br>
<pre><code class="powershell hljs">             <span class="hljs-keyword">switch</span> <span class="hljs-operator">-Wildcard</span> (<span class="hljs-variable">$return</span>[<span class="hljs-string">"text"</span>])<font></font>
            {<font></font>
                <span class="hljs-string">"**"</span> {<font></font>
<font></font>
                    <span class="hljs-comment">#  </span>
                    <span class="hljs-variable">$buttons</span> = <span class="hljs-selector-tag">@</span>()
                    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$task</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$xmlConfig</span>.config.tasks.task)<font></font>
                    {<font></font>
                        <span class="hljs-variable">$i</span>++
                        <span class="hljs-variable">$button</span> = <span class="hljs-selector-tag">@</span>{ <span class="hljs-string">"text"</span> = <span class="hljs-variable">$task</span>.name; callback_data = <span class="hljs-variable">$task</span>.script}
                        <span class="hljs-variable">$buttons</span> += <span class="hljs-variable">$button</span><font></font>
                    }<font></font>
                <font></font>
                    <span class="hljs-variable">$text</span> = <span class="hljs-string">"Available tasks:"</span>
                    <span class="hljs-variable">$chat_id</span> = <span class="hljs-variable">$return</span>.chat_id<font></font>
                    sendKeyboard <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$buttons</span> <span class="hljs-variable">$chat_id</span> <span class="hljs-variable">$text</span>
                    <span class="hljs-comment">#sendMessage $URL_set $return.chat_id ", $($return["f_name"])" </span><font></font>
                }<font></font>
                <span class="hljs-string">"* ?*"</span> { sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">""</span> }
                <span class="hljs-string">"!"</span> {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"bb"</span> ; <span class="hljs-keyword">Exit</span>}<font></font>
                default {sendMessage <span class="hljs-variable">$URL_set</span> <span class="hljs-variable">$return</span>.chat_id <span class="hljs-string">"<span class="hljs-variable">$</span>(Get-Random("</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">", "</span><span class="hljs-string">"))"</span>}<font></font>
            }  <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が言いたかったのはそれだけです。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja483648/index.html">ジョージア州のITビジネスのオフショア：ライフハックと落とし穴</a></li>
<li><a href="../ja483650/index.html">赤道に近いコスモドローム-ウェンチャントロピカルコスモドローム</a></li>
<li><a href="../ja483652/index.html">可能であれば私に嘘をつく：社会技術的ペンテストを実施する機能</a></li>
<li><a href="../ja483654/index.html">集会でのフィードバックは1対1で、なぜうまくいかないのか、どうやってそれを修正しようとするのか？</a></li>
<li><a href="../ja483656/index.html">小売でのTableauですか？</a></li>
<li><a href="../ja483662/index.html">Cisco Threat ResponseとCisco Stealthwatch Enterpriseの統合</a></li>
<li><a href="../ja483664/index.html">TensorFlowのKeras機能API</a></li>
<li><a href="../ja483666/index.html">Volodyaとオゾン発生器について</a></li>
<li><a href="../ja483668/index.html">先週のフロントエンドの世界からの新鮮な食材のダイジェストNo. 397（2020年1月6日〜12日）</a></li>
<li><a href="../ja483670/index.html">MACアドレスについて知りたいすべて</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>