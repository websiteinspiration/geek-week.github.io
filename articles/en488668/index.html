<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßöüèª üêπ üèóÔ∏è CI / CD chaining and Docker automation ü§òüèø üöµ üõ¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I wrote my first sites in the late 90s. Then bring them into working condition was very simple. There was an Apache server on some shared hosting, you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CI / CD chaining and Docker automation</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/488668/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wrote my first sites in the late 90s. Then bring them into working condition was very simple. There was an Apache server on some shared hosting, you could log into this server via FTP, writing something like that in the browser line </font></font><code>ftp://ftp.example.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then it was necessary to enter a name and password and upload files to the server. There were other times, everything was easier then than now. </font><font style="vertical-align: inherit;">
Over the past two decades, everything has changed a lot. Sites have become more complex, they must be assembled before being released into production. One single server has become a plurality of servers working behind load balancers; the use of version control systems has become commonplace.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/cg/bv/ch/cgbvchdac53hqrfbqadsqimp0oa.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For my personal project, I had a special configuration. And I knew that I needed the ability to deploy a site in production, performing only one action: writing code to a branch </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on GitHub. In addition, I knew that to ensure the operation of my small web application, I did not want to manage a huge Kubernetes cluster, or use Docker Swarm technology, or maintain a server park with pods, agents, and all sorts of other difficulties. In order to achieve the goal of simplifying the work as much as possible, I needed to get acquainted with CI / CD.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have a small project (in our case we are talking about a Node.js project) and you would like to learn how to automate the deployment of this project, while doing so that what is stored in the repository exactly matches what works in production, I think you might be interested in this article.</font></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prerequisites</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The reader of this article is expected to have basic knowledge of the command line area and writing Bash scripts. </font><font style="vertical-align: inherit;">In addition, he will need </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travis CI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> accounts </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Goals</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not say that this article can unconditionally be called a "training manual." </font><font style="vertical-align: inherit;">It is rather a document in which I talk about what I learned and describe the process of testing and deploying code in production that suits me, performed in one automated pass. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is how my workflow ended up. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Except for the code sent to any branch of the repository, the </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">following actions are performed:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build the project on Travis CI.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All unit, integration and end-to-end tests are performed.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only for the code that gets into </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the following holds:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All that is said above, plus ...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build the Docker image based on the current code, settings, and environment.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Placing an image on the Docker Hub.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connection to the production server.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uploading the image from the Docker Hub to the server.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stop the current container and start a new one based on the new image.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you know absolutely nothing about Docker, about images and containers - don't worry. </font><font style="vertical-align: inherit;">I‚Äôll tell you all about this.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a CI / CD?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The abbreviation CI / CD stands for "continuous integration / continuous deployment" - "continuous integration / continuous deployment."</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Continuous integration</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuous integration is a process during which developers make commits to the main repository of the project source code (usually to a branch </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">At the same time, the quality of the code is ensured by conducting automated testing.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Continuous deployment</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuous deployment is the frequent automated deployment of code in production. </font><font style="vertical-align: inherit;">The second part of the abbreviation CI / CD is sometimes disclosed as ‚Äúcontinuous delivery‚Äù. </font><font style="vertical-align: inherit;">This, in general, is the same as ‚Äúcontinuous deployment‚Äù, but ‚Äúcontinuous delivery‚Äù implies the need for manual confirmation of changes before starting the project deployment process.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginning of work</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The application on which I mastered it all is called </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TakeNote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This is the web project I'm working on, designed to take notes. First, I tried to make a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JAMStack</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> project, or just a frontend application without a server, in order to take advantage of the standard hosting and deployment </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capabilities</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> offered by </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Netlify</font></a><font style="vertical-align: inherit;"> . As the complexity of the application grew, I needed to create its server part, which meant that I would have to form my own strategy for automated integration and automated deployment of the project.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my case, the application is an Express server running in the Node.js environment, serving a single-page React application and supporting a secure server API. </font><font style="vertical-align: inherit;">This architecture follows the strategy found in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> full-stack authentication guide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I consulted with a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">friend</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> who is an automation expert and asked him what I needed to do to make it work the way I needed. </font><font style="vertical-align: inherit;">He gave me an idea of ‚Äã‚Äãwhat an automated workflow should look like, outlined in the Goals section of this article. </font><font style="vertical-align: inherit;">The fact that I set myself such goals meant that I needed to figure out how to use Docker.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Docker is a tool that, thanks to containerization technology, makes it easy to distribute applications, as well as deploy and launch them in the same environment, even if the Docker platform itself works in different environments. For starters, I needed to have Docker command line tools (CLI) at my disposal. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The instructions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for installing Docker cannot be called very clear and understandable, but you can learn from it that in order to take the first step of installation, you need to download Docker Desktop (for Mac or Windows). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Docker Hub is about the same as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for git repositories, or the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">npm</font></a><font style="vertical-align: inherit;"> registry</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for JavaScript packages. </font><font style="vertical-align: inherit;">This is an online repository for Docker images. </font><font style="vertical-align: inherit;">It connects to it Docker Desktop. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, in order to get started with Docker, you need to do two things:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Desktop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sign up for the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, you can verify that the Docker CLI is working by running the following command to verify the version of Docker:</font></font><br>
<br>
<pre><code class="plaintext hljs">docker -v</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, log in to the Docker Hub by entering, when asked, your username and password:</font></font><br>
<br>
<pre><code class="plaintext hljs">docker login</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to use Docker, you must understand the concepts of images and containers.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Images</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An image is something like a plan containing instructions for building a container. </font><font style="vertical-align: inherit;">This is an immutable snapshot of the file system and application settings. </font><font style="vertical-align: inherit;">Developers can easily share images.</font></font><br>
<br>
<pre><code class="plaintext hljs">#     <font></font>
docker images</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This command will display a table with the following heading:</font></font><br>
<br>
<pre><code class="plaintext hljs">REPOSITORY &nbsp; &nbsp; TAG     IMAGE ID &nbsp; &nbsp; CREATED     SIZE<font></font>
---</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we will consider some examples of commands in the same format - first comes a command with a comment, and then an example of what it can output.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçContainers</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A container is an executable package that contains everything you need to run an application. </font><font style="vertical-align: inherit;">An application with this approach will always work the same, regardless of infrastructure: in an isolated environment and in the same environment. </font><font style="vertical-align: inherit;">The point is that in different environments, instances of the same image are launched.</font></font><br>
<br>
<pre><code class="plaintext hljs">#   <font></font>
docker ps -a<font></font>
CONTAINER ID &nbsp; &nbsp; IMAGE     COMMAND &nbsp; &nbsp; CREATED     STATUS     PORTS &nbsp; &nbsp; NAMES<font></font>
---</code></pre><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçTags</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tag is an indication of a specific version of an image.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Docker Command Summary</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is an overview of some commonly used Docker commands.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Team</font></font><br>
</th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Context</font></font><br>
</th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Act</font></font><br>
</th>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker build</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Form</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembling an image from Dockerfile</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker tag</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Form</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Image tagging</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker images</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Form</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing images</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker run</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Container</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Image-based container launch</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker push</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Form</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Submitting an image to the registry</font></font><br>
</td>
</tr>
<tr>
<td><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker pull</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Form</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download image from registry</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker ps</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Container</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">List container</font></font><br>
</td>
</tr>
<tr>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker system prune</font></font></a><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Image / Container</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Removing unused containers and images</font></font><br>
</td>
</tr>
</tbody></table></div><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Dockerfile</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I know how to run a production application locally. </font><font style="vertical-align: inherit;">I have a Webpack configuration designed to build a ready-made React application. </font><font style="vertical-align: inherit;">Next, I have a command that starts a Node.js-based server on the port </font></font><code>5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It looks like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">npm i &nbsp; &nbsp; &nbsp; &nbsp; #  <font></font>
npm run build #  React-<font></font>
npm run start #  Node-</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It should be noted that I do not have an example application for this material. </font><font style="vertical-align: inherit;">But here, for experiments, any simple Node application is suitable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to use the container, you need to give Docker instructions. </font><font style="vertical-align: inherit;">This is done through a file called </font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">located in the root directory of the project. </font><font style="vertical-align: inherit;">This file, at first, seems pretty obscure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But what it contains only describes, with special commands, something similar to setting up a working environment. </font><font style="vertical-align: inherit;">Here are some of these commands:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FROM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - This command starts the file. </font><font style="vertical-align: inherit;">It indicates the basic image on the basis of which the container is built.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COPY</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Copy files from a local source to a container.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WORKDIR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Setting the working directory for the following commands.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RUN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Run commands.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPOSE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Port Settings.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ENTRYPOINT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Specifies the command to execute.</font></font></li>
</ul><br>
<code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> might look something like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">#   <font></font>
FROM node:12-alpine<font></font>
<font></font>
#        app/<font></font>
COPY . app/<font></font>
<font></font>
#  app/    <font></font>
WORKDIR app/<font></font>
<font></font>
#   ( npm ci  npm i,     )<font></font>
RUN npm ci --only-production<font></font>
<font></font>
#   React-  <font></font>
RUN npm run build<font></font>
<font></font>
#   <font></font>
EXPOSE 5000<font></font>
<font></font>
#  Node-<font></font>
ENTRYPOINT npm run start</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depending on the selected base image, you may need to install additional dependencies. </font><font style="vertical-align: inherit;">The fact is that some basic images (such as Node Alpine Linux) are designed to make them as compact as possible. </font><font style="vertical-align: inherit;">As a result, they may not have some of the programs you are counting on.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Build, tag and launch container</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Local assembly and launch of the container is, after we have </font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the tasks are quite simple. </font><font style="vertical-align: inherit;">Before sending an image to the Docker Hub, you need to test it locally.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Assembly</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First you need to collect the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by specifying a name, and, optionally, a tag (if the tag is not specified, the system will automatically assign a tag to the image </font></font><code>latest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<pre><code class="plaintext hljs">#  <font></font>
docker build -t &lt;image&gt;:&lt;tag&gt; .</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After executing this command, you can observe how Docker builds the image.</font></font><br>
<br>
<pre><code class="plaintext hljs">Sending build context to Docker daemon &nbsp; 2.88MB<font></font>
Step 1/9 : FROM node:12-alpine<font></font>
&nbsp;---&gt; ...  ...<font></font>
Successfully built 123456789123<font></font>
Successfully tagged &lt;image&gt;:&lt;tag&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assembly may take a couple of minutes - it all depends on how many dependencies you have. </font><font style="vertical-align: inherit;">After the assembly is completed, you can execute the command </font></font><code>docker images</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and take a look at the description of your new image.</font></font><br>
<br>
<pre><code class="plaintext hljs">REPOSITORY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG               IMAGE ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CREATED              SIZE<font></font>
&lt;image&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latest            123456789123&nbsp; &nbsp; &nbsp; &nbsp; About a minute ago   x.xxGB</code></pre><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçStart</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The image is created. </font><font style="vertical-align: inherit;">And this means that on its basis it is possible to launch a container. </font><font style="vertical-align: inherit;">Since I want to be able to access the application running in the container at the address </font></font><code>localhost:5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I </font></font><code>5000:5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">installed </font><font style="vertical-align: inherit;">on the left side of the pair </font><font style="vertical-align: inherit;">in the next command </font></font><code>5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">On the right side is the container port.</font></font><br>
<br>
<pre><code class="plaintext hljs">#      5000    5000<font></font>
docker run -p 5000:5000 &lt;image&gt;:&lt;tag&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that the container is created and launched, you can use the command </font></font><code>docker ps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to look at the information about this container (or you can use the command </font></font><code>docker ps -a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that displays information about all containers, not just working ones).</font></font><br>
<br>
<pre><code class="plaintext hljs">CONTAINER ID&nbsp; &nbsp; &nbsp; &nbsp; IMAGE               COMMAND&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CREATED              STATUS                  &nbsp; &nbsp; PORTS                    NAMES<font></font>
987654321234&nbsp; &nbsp; &nbsp; &nbsp; &lt;image&gt;             "/bin/sh -c 'npm run‚Ä¶" &nbsp; 6 seconds ago        Up 6 seconds            &nbsp; &nbsp; 0.0.0.0:5000-&gt;5000/tcp   stoic_darwin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you go to the address now </font></font><code>localhost:5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you can see the page of the working application, which looks exactly the same as the page of the application working in the production environment.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Tag Assignment and Publication</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to use one of the created images on the production server, we need to be able to download this image from the Docker Hub. </font><font style="vertical-align: inherit;">This means that you must first create a repository for the project on the Docker Hub. </font><font style="vertical-align: inherit;">After that, we will have at our disposal a place where you can fix the image. </font><font style="vertical-align: inherit;">The image must be renamed so that its name begins with our username on the Docker Hub. </font><font style="vertical-align: inherit;">After this should be the name of the repository. </font><font style="vertical-align: inherit;">At the end of the name can be any tag. </font><font style="vertical-align: inherit;">The following is an example of naming images using this scheme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can collect the image with a new name and run the command </font></font><code>docker push</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to send it to the Docker Hub repository.</font></font><br>
<br>
<pre><code class="plaintext hljs">docker build -t &lt;username&gt;/&lt;repository&gt;:&lt;tag&gt; .<font></font>
docker tag &lt;username&gt;/&lt;repository&gt;:&lt;tag&gt; &lt;username&gt;/&lt;repository&gt;:latest<font></font>
docker push &lt;username&gt;/&lt;repository&gt;:&lt;tag&gt;<font></font>
<font></font>
#     , , :<font></font>
docker build -t user/app:v1.0.0 .<font></font>
docker tag user/app:v1.0.0 user/app:latest<font></font>
docker push user/app:v1.0.0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything goes well, the image will be available on the Docker Hub and it can easily be downloaded to the server or transferred to other developers.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next steps</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To date, we have made sure that the application, in the form of a Docker container, works locally. </font><font style="vertical-align: inherit;">We uploaded the container to the Docker Hub. </font><font style="vertical-align: inherit;">All this means that we have already made very good progress towards the goal. </font><font style="vertical-align: inherit;">Now we need to solve two more questions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring a CI tool for testing and deploying code.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up the production server so that it can load and run our code.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travis CI is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> used as a CI / CD solution </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As a server - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DitigalOcean</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It should be noted that here you can use another combination of services. </font><font style="vertical-align: inherit;">For example, instead of Travis CI, you can use CircleCI or Github Actions. </font><font style="vertical-align: inherit;">And instead of DigitalOcean - AWS or Linode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We decided to work with Travis CI, and in this service I already have something configured. </font><font style="vertical-align: inherit;">Therefore, now I will briefly talk about how to prepare it for work.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travis ci</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travis CI is a tool for testing and deploying code. I would not want to go into the intricacies of setting up Travis CI, since each project is unique, and this will not bring much benefit. But I will tell you about the basics that will allow you to get started if you decide to use Travis CI. Whatever you choose - Travis CI, CircleCI, Jenkins, or something else, similar configuration methods will be used everywhere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to start working with Travis CI, go to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the project website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and create an account. </font><font style="vertical-align: inherit;">Then integrate Travis CI with your GitHub account. </font><font style="vertical-align: inherit;">During the system setup, you will need to specify the repository you want to automate with and enable access to it. </font><font style="vertical-align: inherit;">(I use GitHub, but I'm sure Travis CI can integrate with BitBucket, GitLab, and other similar services). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each time Travis CI is taken for work, a server is launched that executes the commands specified in the configuration file, including the deployment of the corresponding repository branches.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Task life cycle</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Travis CI configuration file, called </font></font><code>.travis.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and stored in the root directory of the project, supports the concept </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> job </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">life cycle</font></a><font style="vertical-align: inherit;"> events </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">These events are listed in the order in which they occur:</font></font><br>
<br>
<ul>
<li><code>apt addons</code></li>
<li><code>cache components</code></li>
<li><code>before_install</code></li>
<li><code>install</code></li>
<li><code>before_script</code></li>
<li><code>script</code></li>
<li><code>before_cache</code></li>
<li><code>after_success  after_failure</code></li>
<li><code>before_deploy</code></li>
<li><code>deploy</code></li>
<li><code>after_deploy</code></li>
<li><code>after_script</code></li>
</ul><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçTesting</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the configuration file, I am going to configure the local Travis CI server. As the language, I chose Node 12 and told the system to install the dependencies necessary for using Docker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything that is listed in </font></font><code>.travis.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be executed when all pull requests to all branches of the repository are executed, unless otherwise specified. This is a useful feature, as it means that we can test all the code coming into the repository. This allows you to know whether the code is ready to be written to the branch </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and whether it will disrupt the process of building the project. In this global configuration, I install everything locally, start the Webpack developer server in the background (this is a feature of my workflow) and run the tests.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to display icons with information about code coverage in your repository, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can find brief instructions on using Jest, Travis CI and Coveralls to collect and display this information. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So here is the contents of the file </font></font><code>.travis.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">#  <font></font>
language: node_js<font></font>
<font></font>
#   Node.js<font></font>
node_js:<font></font>
&nbsp;&nbsp;- '12'<font></font>
<font></font>
services:<font></font>
&nbsp;&nbsp;#    Docker<font></font>
&nbsp;&nbsp;- docker<font></font>
<font></font>
install:<font></font>
&nbsp;&nbsp;#    <font></font>
&nbsp;&nbsp;- npm ci<font></font>
<font></font>
before_script:<font></font>
&nbsp;&nbsp;#      <font></font>
&nbsp;&nbsp;- npm run dev &amp;<font></font>
<font></font>
script:<font></font>
&nbsp;&nbsp;#  <font></font>
&nbsp;&nbsp;- npm run test</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here the actions that are performed for all branches of the repository and for pull requests end.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Deployment</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on the assumption that all automated tests completed successfully, we, optionally, can deploy the code on the production server. </font><font style="vertical-align: inherit;">Since we want to do this only for code from a branch </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we give the system appropriate instructions in the deployment settings. </font><font style="vertical-align: inherit;">Before you try to use the code in your project, which we will consider later, I would like to warn you that you must have a real script that is called for deployment.</font></font><br>
<br>
<pre><code class="plaintext hljs">deploy:<font></font>
&nbsp;&nbsp;#  Docker-     Docker Hub<font></font>
&nbsp;&nbsp;provider: script<font></font>
&nbsp;&nbsp;script: bash deploy.sh<font></font>
&nbsp;&nbsp;on:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;branch: master</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The deployment script solves two problems:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build, tag and send the image to the Docker Hub using the CI tool (in our case, it is Travis CI).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loading the image on the server, stopping the old container and starting the new one (in our case, the server runs on the DigitalOcean platform).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First you need to configure the automatic process of assembling, tagging and sending the image to the Docker Hub. All this is very similar to what we already did manually, except that here we need a strategy for assigning unique tags to images and automating login. I had difficulties with some details of the deployment script, such as a tagging strategy, logging in, encoding SSH keys, establishing an SSH connection. But, fortunately, my boyfriend handles bash very well, as well as many other things. He helped me write this script.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the first part of the script is sending the image to the Docker Hub. This is pretty simple. The tagging scheme I used involves combining a git hash and a git tag, if one exists. This allows for the creation of a unique tag and simplifies the identification of the assembly on which it is based. </font></font><code>DOCKER_USERNAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>DOCKER_PASSWORD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are user environment variables that can be set using the Travis CI interface. Travis CI automatically processes sensitive data so that it does not fall into the wrong hands. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the first part of the script </font></font><code>deploy.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">#!/bin/sh<font></font>
set -e #     <font></font>
<font></font>
IMAGE="&lt;username&gt;/&lt;repository&gt;" &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #  Docker<font></font>
GIT_VERSION=$(git describe --always --abbrev --tags --long) # Git-  <font></font>
<font></font>
#    <font></font>
docker build -t ${IMAGE}:${GIT_VERSION} .<font></font>
docker tag ${IMAGE}:${GIT_VERSION} ${IMAGE}:latest<font></font>
<font></font>
#   Docker Hub   <font></font>
echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin<font></font>
docker push ${IMAGE}:${GIT_VERSION}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What the second part of the script will be completely depends on which host you are using and how the connection to it is organized. In my case, since I use Digital Ocean, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doctl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> commands are used to connect to the server </font><font style="vertical-align: inherit;">. When working with Aws, a utility will be used </font></font><code>aws</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and so on. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setting up the server was not particularly difficult. So, I set up a droplet based on the base image. It should be noted that the system I selected requires a one-time manual installation of Docker and a one-time manual launch of Docker. I used Ubuntu 18.04 to install Docker, so if you also use Ubuntu to do the same, you can simply follow </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simple guide.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I'm not talking here about specific commands for the service, since this aspect can vary greatly in different cases. </font><font style="vertical-align: inherit;">I will only give a general plan of action that is carried out after connecting via SSH to the server on which the project will be deployed:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You need to find the container that is currently running and stop it.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then, in the background, you need to launch a new container.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You will need to set the local server port to a value </font></font><code>80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this will allow you to enter the site at the address of the form </font></font><code>example.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, without specifying the port, and not use the address like </font></font><code>example.com:5000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And finally, you need to remove all the old containers and images.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the continuation of the script.</font></font><br>
<br>
<pre><code class="plaintext hljs">#  ID  <font></font>
CONTAINER_ID=$(docker ps | grep takenote | cut -d" " -f1)<font></font>
<font></font>
#   ,  ,  <font></font>
docker stop ${CONTAINER_ID}<font></font>
docker run --restart unless-stopped -d -p 80:5000 ${IMAGE}:${GIT_VERSION}<font></font>
docker system prune -a -f</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some Things to Consider</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps when you connect to the server via SSH from Travis CI, you will see a warning that will not allow the installation to continue, since the system will wait for the user to respond.</font></font><br>
<br>
<pre><code class="plaintext hljs">The authenticity of host '&lt;hostname&gt; (&lt;IP address&gt;)' can't be established.<font></font>
RSA key fingerprint is &lt;key fingerprint&gt;.<font></font>
Are you sure you want to continue connecting (yes/no)?</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I learned that the string key can be encoded in base64 in order to save it in a form in which it will be convenient and reliable to work with it. </font><font style="vertical-align: inherit;">At the installation stage, you can decode the public key and write it to a file </font></font><code>known_hosts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in order to get rid of the above error.</font></font><br>
<br>
<pre><code class="plaintext hljs">echo &lt;public key&gt; | base64 #  &lt; ,   base64&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In practice, this command may look like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">echo "123.45.67.89 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAklOUpkDHrfHY17SbrmTIpNLTGK9Tjom/BWDSU<font></font>
GPl+nafzlHDTYW7hdI4yZ5ew18JH4JW9jbhUFrviQzM7xlELEVf4h9lFX5QVkbPppSwg0cda3<font></font>
Pbv7kOdJ/MTyBlWXFCR+HAo3FXRitBqxiX1nKhXpHAZsMciLq8V6RjsNAQwdsdMFvSlVK/7XA<font></font>
t3FaoJoAsncM1Q9x5+3V0Ww68/eIFmb1zuUFljQJKprrX88XypNDvjYNby6vw/Pb0rwert/En<font></font>
mZ+AW4OZPnTPI89ZPmVMLuayrD2cE86Z/il8b+gw3r3+1nKatmIkjn2so1d01QraTlMqVSsbx<font></font>
NrRFi9wrf+M7Q== you@example.com" | base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is what it gives out - a base64 encoded string:</font></font><br>
<br>
<pre><code class="plaintext hljs">MTIzLjQ1LjY3Ljg5IHNzaC1yc2EgQUFBQUIzTnphQzF5YzJFQUFBQUJJd0FBQVFFQWtsT1Vwa0RIcmZIWTE3U2JybVRJcE5MVEdLOVRqb20vQldEU1UKR1BsK25hZnpsSERUWVc3aGRJNHlaNWV3MThKSDRKVzlqYmhVRnJ2aVF6TTd4bEVMRVZmNGg5bEZYNVFWa2JQcHBTd2cwY2RhMwpQYnY3a09kSi9NVHlCbFdYRkNSK0hBbzNGWFJpdEJxeGlYMW5LaFhwSEFac01jaUxxOFY2UmpzTkFRd2RzZE1GdlNsVksvN1hBCnQzRmFvSm9Bc25jTTFROXg1KzNWMFd3NjgvZUlGbWIxenVVRmxqUUpLcHJyWDg4WHlwTkR2allOYnk2dncvUGIwcndlcnQvRW4KbVorQVc0T1pQblRQSTg5WlBtVk1MdWF5ckQyY0U4NlovaWw4YitndzNyMysxbkthdG1Ja2puMnNvMWQwMVFyYVRsTXFWU3NieApOclJGaTl3cmYrTTdRPT0geW91QGV4YW1wbGUuY29tCg==</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the team mentioned above</font></font><br>
<br>
<pre><code class="plaintext hljs">install:<font></font>
&nbsp;&nbsp;- echo &lt;  ,   base64&gt; | base64 -d &gt;&gt; $HOME/.ssh/known_hosts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same approach can be used with a private key when establishing a connection, since you may need a private key to access the server. </font><font style="vertical-align: inherit;">When working with a key, you only need to ensure its safe storage in the Travis CI environment variable, and so that it would not be displayed anywhere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another thing that you should pay attention to is that you may need to run the entire deployment script, presented as a single line, for example, using </font></font><code>doctl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This may require some additional effort.</font></font><br>
<br>
<pre><code class="plaintext hljs">doctl compute ssh &lt;droplet&gt; --ssh-command "    &amp;&amp; "</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TLS / SSL and load balancing</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After I did everything that was discussed above, the last problem that arose before me was that the server did not have SSL. Since I use the Node.js server, in order to get the </font><font style="vertical-align: inherit;">Nginx and Let's Encrypt reverse proxies </font><font style="vertical-align: inherit;">to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I need to tinker a lot.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I really didn‚Äôt feel like doing all these SSL settings manually, so I just created a load balancer and recorded information about it in DNS. In the case of DigitalOcean, for example, creating a self-renewing self-signed certificate on a load balancer is a simple, free and fast procedure. This approach has an additional advantage, which, if necessary, makes it very easy to configure SSL on a variety of servers running a load balancer. This allows the servers themselves not to ‚Äúthink‚Äù about SSL at all, but use the port as usual </font></font><code>80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. So setting up SSL on a load balancer is much simpler and more convenient than alternative SSL configuration methods.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can close on the server all ports that accept incoming connections - except for the port </font></font><code>80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used for communication with the load balancer, and the port </font></font><code>22</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for SSH. </font><font style="vertical-align: inherit;">As a result, an attempt to directly access the server on any ports, with the exception of these two, will fail.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After I did everything that was described in this material, I was no longer afraid of either the Docker platform or the concept of automated CI / CD chains. I was able to set up a continuous integration chain during which the code is tested before it gets into production and the code is automatically deployed to the server. All this for me is still relatively new, and I am sure that there are ways to improve my automated workflow and make it more efficient. Therefore, if you have any ideas on this subject, let </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">me</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> know. I hope this article has helped you in your affairs. I want to believe that after reading it, you have learned as much as I did, while I figured out everything that I told about it. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There </font><font style="vertical-align: inherit;">is an image </font><font style="vertical-align: inherit;">in our </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marketplace</font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which installs in one click. </font><font style="vertical-align: inherit;">You can check the operation of containers on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">All new customers are given 3 days free of charge for testing. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dear readers! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do you use CI / CD technologies in your projects?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488658/index.html">Using faiss to search multidimensional spaces</a></li>
<li><a href="../en488660/index.html">Is it time to forget about React and upgrade to Svelte?</a></li>
<li><a href="../en488662/index.html">Browser extensions required by every web developer</a></li>
<li><a href="../en488664/index.html">Finding the Perfect Toolkit: Analyzing Popular Python Project Templates</a></li>
<li><a href="../en488666/index.html">10 React Components for All Occasions</a></li>
<li><a href="../en488670/index.html">About mask registers</a></li>
<li><a href="../en488672/index.html">Debugging ARM Cortex-M microcontrollers by UART</a></li>
<li><a href="../en488674/index.html">Infographic with Excel and PowerPoint</a></li>
<li><a href="../en488678/index.html">Big Appetites for Little Buffers at Node.js</a></li>
<li><a href="../en488682/index.html">How to test Python programming skills? Tasks from Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>