<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏙️ 🤲🏻 🚤 小孩子们的使节 🔂 🙆🏿 🙆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好！
 

我在Tinkoff担任后端开发人员，在其中参与了为个人和法人提供服务的CRM系统平台的开发。
 

 edge proxy — . , . — Envoy.
 

Envoy — , C++. Lyft — , Uber — , . — service mesh.
 

 , cor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>小孩子们的使节</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/494298/"><p><img src="https://habrastorage.org/webt/5o/m9/kr/5om9krz1akqwkavrmbu6thz5hs4.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大家好！</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我在Tinkoff担任后端开发人员，在其中参与了为个人和法人提供服务的CRM系统平台的开发。</font></font></p><br>
<p> edge proxy     —       .        ,        .        — Envoy.</p><br>
<p>Envoy —   ,   C++.    Lyft —     ,   Uber —      ,          .          — service mesh.</p><br>
<p>    ,   cors, access-control, rate limiting, outlier detection,  jwt   .</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>,              .       ,     ,      . !</p><a name="habracut"></a><br>
<p>    upstream--,  http-        .       ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">echo-server</a>  Go.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">    docker</a>,    .    :  8081, 8082, 8083 ,          container id.</p><br>
<p>, :</p><br>
<pre><code class="plaintext hljs">curl -v localhost:8081</code></pre><br>
<p>:</p><br>
<pre><code class="plaintext hljs">Request served by a29f0fba3451<font></font>
<font></font>
HTTP/1.1 GET /<font></font>
<font></font>
Host: localhost:8081<font></font>
User-Agent: curl/7.64.1<font></font>
Accept: */*</code></pre><br>
<p> <strong>a29f0fba3451</strong> —  .</p><br>
<p>     Envoy.    ,  docker —      .</p><br>
<div class="spoiler"><b class="spoiler_title"> -</b><div class="spoiler_text"><pre><code class="plaintext hljs">admin:<font></font>
  access_log_path: /tmp/admin_access.log<font></font>
  address:<font></font>
    socket_address: { address: 127.0.0.1, port_value: 9901 }<font></font>
<font></font>
static_resources:<font></font>
  listeners:<font></font>
  - name: listener_0<font></font>
    address:<font></font>
      socket_address: { address: 0.0.0.0, port_value: 10000 }<font></font>
    filter_chains:<font></font>
    - filters:<font></font>
      - name: envoy.http_connection_manager<font></font>
        config:<font></font>
          stat_prefix: ingress_http<font></font>
          route_config:<font></font>
            name: local_route<font></font>
            virtual_hosts:<font></font>
            - name: local_service<font></font>
              domains: ["*"]<font></font>
              routes:<font></font>
              - match: { prefix: "/" }<font></font>
                route: { host_rewrite: www.google.com, cluster: service_google }<font></font>
          http_filters:<font></font>
          - name: envoy.router<font></font>
  clusters:<font></font>
  - name: service_google<font></font>
    connect_timeout: 0.25s<font></font>
    type: LOGICAL_DNS<font></font>
    # Comment out the following line to test on v6 networks<font></font>
    dns_lookup_family: V4_ONLY<font></font>
    lb_policy: ROUND_ROBIN<font></font>
    hosts: [{ socket_address: { address: google.com, port_value: 443 }}]<font></font>
    tls_context: { sni: www.google.com }</code></pre></div></div><br>
<p>   :</p><br>
<ol>
<li>,    <strong>listener</strong>.</li>
<li><strong>Virtual host</strong>   .</li>
<li> .      —  <strong>routes</strong>,     .</li>
<li><strong>Cluster</strong> —   upstream-   .</li>
<li><strong>Endpoint</strong> —  upstream-    .</li>
</ol><br>
<p>   ,     LDS, VHDS, RDS, CDS  EDS .</p><br>
<p> ,      yaml-   .       control-plane-  API    envoy  gRP-.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Envoy</a>      Go  Java.                   .</p><br>
<p>       .</p><br>
<p>     <em>echo_cluster</em>      (-),   <em>load_assignment.endpoints</em>    echo-server.</p><br>
<div class="spoiler"><b class="spoiler_title">     echo-server</b><div class="spoiler_text"><pre><code class="plaintext hljs">clusters:<font></font>
    - name: echo_cluster<font></font>
      connect_timeout: 3s<font></font>
      type: STRICT_DNS<font></font>
      dns_lookup_family: V4_ONLY<font></font>
      load_assignment:<font></font>
        cluster_name: echo_cluster<font></font>
        endpoints:<font></font>
        - lb_endpoints:<font></font>
          - endpoint:<font></font>
              address:<font></font>
                socket_address:<font></font>
                  address: docker.for.mac.localhost<font></font>
                  port_value: 8081<font></font>
          - endpoint:<font></font>
              address:<font></font>
                socket_address:<font></font>
                  address: docker.for.mac.localhost<font></font>
                  port_value: 8082<font></font>
          - endpoint:<font></font>
              address:<font></font>
                socket_address:<font></font>
                  address: docker.for.mac.localhost<font></font>
                  port_value: 8083</code></pre></div></div><br>
<p>     .     <em>envoy.http_connection_manager</em>     -.   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>  . ,       "/echo"   .</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="plaintext hljs">    - filters:<font></font>
      - name: envoy.http_connection_manager<font></font>
          typed_config:<font></font>
            "@type": type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager<font></font>
            stat_prefix: echo<font></font>
            codec_type: AUTO<font></font>
            route_config:<font></font>
              name: local_route<font></font>
              virtual_hosts:<font></font>
              - name: local_service<font></font>
                domains: ["*"]<font></font>
                routes:<font></font>
                - match: { prefix: "/echo" }<font></font>
                  route: { cluster: echo_cluster }<font></font>
            http_filters:<font></font>
            - name: envoy.router</code></pre></div></div><br>
<p>  dockerfile:</p><br>
<pre><code class="plaintext hljs">FROM envoyproxy/envoy:v1.13.0<font></font>
COPY envoy.yaml /etc/envoy/envoy.yaml</code></pre><br>
<p>   ,   :</p><br>
<pre><code class="plaintext hljs">docker build -t envoy:v1 .<font></font>
docker run -p 8080:8080 --rm envoy:v1</code></pre><br>
<p>  !   http-     "/echo" Envoy      echo-server. </p><br>
<pre><code class="plaintext hljs">curl localhost:8080/echo</code></pre><br>
<pre><code class="plaintext hljs">Request served by a29f0fba3451<font></font>
<font></font>
HTTP/1.1 GET /echo<font></font>
<font></font>
Host: localhost:8080<font></font>
User-Agent: curl/7.64.1<font></font>
Accept: */*<font></font>
X-Forwarded-Proto: http<font></font>
X-Request-Id: dd4b850c-9b4e-45e5-a411-4b76293b1e33<font></font>
X-Envoy-Expected-Rq-Timeout-Ms: 15000<font></font>
Content-Length: 0</code></pre><br>
<p>     404.</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p><img src="https://habrastorage.org/webt/hl/yj/ra/hlyjralprcsvuyzd99bdn4oxzxy.png" alt="图片"></p></div></div><br>
<p>       <strong>round robin</strong> (   ),      .</p><br>
<p>         -.        .</p><br>
<div class="spoiler"><b class="spoiler_title">  500  GET '/echo'  round-robin</b><div class="spoiler_text"><p><img src="https://habrastorage.org/webt/m1/uk/ud/m1ukud-mapxqp7gthnetvakoeno.png"></p></div></div><br>
<p> Envoy   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>  ,        .       stateful-   ,       -.</p><br>
<h2 id="balansirovka-na-osnove-consistent-hashinghttpswwwenvoyproxyiodocsenvoylatestintroarch_overviewupstreamload_balancingload_balancersarch-overview-load-balancing-types-ring-hash">   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">consistent hashing</a></h2><br>
<p>,        .<br>
                  .   ,   ,      ,       .          ,                  .</p><br>
<div class="spoiler"><b class="spoiler_title"> 'lb_policy: RING_HASH'    </b><div class="spoiler_text"><pre><code class="plaintext hljs">  clusters:<font></font>
    - name: echo_cluster<font></font>
      lb_policy: RING_HASH</code></pre></div></div><br>
<p>,      . Envoy   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>. ,      . </p><br>
<div class="spoiler"><b class="spoiler_title"> id_key   </b><div class="spoiler_text"><pre><code class="plaintext hljs">    - match: { prefix: "/echo" }<font></font>
      route: {<font></font>
         cluster: echo_cluster, <font></font>
           hash_policy: { <font></font>
             header: { <font></font>
               header_name: id_key<font></font>
            }<font></font>
          }<font></font>
        }</code></pre></div></div><br>
<p> ,               .       Envoy —  http . </p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/http/"> </a>      .   , ,    cors,  ,  jwt-   .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://www.envoyproxy.io/docs/envoy/latest/api-v2/config/filter/"><em>envoy.lua</em></a>.         ,   ,        Lua.<br>
            'id_key'.</p><br>
<div class="spoiler"><b class="spoiler_title">Lua </b><div class="spoiler_text"><pre><code class="plaintext hljs">    - name: envoy.lua<font></font>
      typed_config:<font></font>
        "@type": type.googleapis.com/envoy.config.filter.http.lua.v2.Lua<font></font>
        inline_code: |<font></font>
          function envoy_on_request(request)<font></font>
<font></font>
            hasIdKey = "/echo/key/(.+)/?.*"<font></font>
            path = request:headers():get(":path")<font></font>
            key = path:match(hasIdKey)<font></font>
<font></font>
            if key ~= nil then<font></font>
              request:headers():add("id_key", key)<font></font>
            end<font></font>
          end</code></pre></div></div><br>
<p>                  echo-server:</p><br>
<div class="spoiler"><b class="spoiler_title"> 500  GET '/echo/key/2570e384-5fc0-11ea-bc55-0242ac130003'</b><div class="spoiler_text"><p><img src="https://habrastorage.org/webt/m-/wf/mq/m-wfmqjhqctfuwh0gccrmb5n-e4.png"></p></div></div><br>
<p> ,     RING_HASH   .       .</p><br>
<h2 id="subsethttpswwwenvoyproxyiodocsenvoylatestintroarch_overviewupstreamload_balancingsubsets-balansirovka"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Subset</a>-</h2><br>
<p>    -   . ,     ,     ,       ,        ,   .<br>
Envoy     ,          .</p><br>
<div class="spoiler"><b class="spoiler_title"> lb_subset_config,     instance_id</b><div class="spoiler_text"><pre><code class="plaintext hljs">- name: echo_cluster<font></font>
      lb_policy: ROUND_ROBIN<font></font>
      lb_subset_config:<font></font>
        fallback_policy: ANY_ENDPOINT<font></font>
        subset_selectors:<font></font>
        - keys:<font></font>
          - instance_id</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"> instance_id    </b><div class="spoiler_text"><pre><code class="plaintext hljs">endpoints:<font></font>
        - lb_endpoints:<font></font>
          - endpoint:<font></font>
              address:<font></font>
                socket_address:<font></font>
                  address: docker.for.mac.localhost<font></font>
                  port_value: 8081<font></font>
            metadata:<font></font>
              filter_metadata: { "envoy.lb" : { "instance_id": "a29f0fba3451"}}<font></font>
          - endpoint:<font></font>
              address:<font></font>
                socket_address:<font></font>
                  address: docker.for.mac.localhost<font></font>
                  port_value: 8082<font></font>
            metadata:<font></font>
              filter_metadata: { "envoy.lb" : { "instance_id": "d6325ed590c0"}}<font></font>
          - endpoint:<font></font>
              address:<font></font>
                socket_address:<font></font>
                  address: docker.for.mac.localhost<font></font>
                  port_value: 8083<font></font>
            metadata:<font></font>
              filter_metadata: { "envoy.lb" : { "instance_id": "6e2f60a09101"}}</code></pre></div></div><br>
<p> Envoy     instance_id   ,       .</p><br>
<p>   http- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/header_to_metadata_filter&amp;usg=ALkJrhhFnlL2ErDfNnsHC3yedL6O4W7f9A#config-"><em>envoy.filters.http.header_to_metadata</em></a>,         instance-id.<br>
 ,   -       ,       .</p><br>
<div class="spoiler"><b class="spoiler_title">Lua    instance-id   </b><div class="spoiler_text"><pre><code class="plaintext hljs">    - name: envoy.lua<font></font>
      typed_config:<font></font>
        "@type": type.googleapis.com/envoy.config.filter.http.lua.v2.Lua<font></font>
        inline_code: |<font></font>
          function envoy_on_request(request)<font></font>
            hasInstanceId = "/echo/instance/(.+)/?.*"<font></font>
<font></font>
            path = request:headers():get(":path")<font></font>
            key = path:match(hasInstanceId)<font></font>
<font></font>
            if key ~= nil then<font></font>
              request:headers():add("instance-id", key)<font></font>
            end<font></font>
          end</code></pre></div></div><br>
<p>,   ,   instance-id (container id),      ,      .</p><br>
<div class="spoiler"><b class="spoiler_title"> 500  GET '/echo/instance/a29f0fba3451'</b><div class="spoiler_text"><p><img src="https://habrastorage.org/webt/jm/dk/bp/jmdkbpkio6y-jfxp9h_a9ft9p_0.png"></p></div></div><br>
<h2 id="vmesto-vyvoda"> </h2><br>
<p>    ,    ,       Envoy   .</p><br>
<p>           .  -    ,   -   .     ,                .</p><br>
<p>             .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  .</a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN494286/index.html">Raspberry Pi上的Embox RTOS</a></li>
<li><a href="../zh-CN494290/index.html">#YAMY工作。可能是正确的决定</a></li>
<li><a href="../zh-CN494292/index.html">毁灭：与OKR合作5年</a></li>
<li><a href="../zh-CN494294/index.html">通过3D打印认证，适用于石油，天然气和海洋工业</a></li>
<li><a href="../zh-CN494296/index.html">小米网关（欧盟版-Lumi.gateway.mieu01）被黑</a></li>
<li><a href="../zh-CN494300/index.html">委派RDP会话管理</a></li>
<li><a href="../zh-CN494302/index.html">日常目标作为团队管理工具</a></li>
<li><a href="../zh-CN494304/index.html">增强现实的30个UX技巧</a></li>
<li><a href="../zh-CN494306/index.html">没钱。WHO？</a></li>
<li><a href="../zh-CN494308/index.html">太空2020等着您</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>