<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèø üçí üí° Como encontrar erros em um projeto C #, trabalhando no Linux e macOS ü§ôüèº üëçüèª üë®üèæ‚Äçü§ù‚Äçüë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O PVS-Studio √© um analisador de c√≥digo est√°tico bem conhecido que permite encontrar muitos erros complicados ocultos na fonte. O teste beta da nova ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como encontrar erros em um projeto C #, trabalhando no Linux e macOS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/507110/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6a2/607/d60/6a2607d60720993d5834a2c2e83a6bb1.png" alt="Quadro 8"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O PVS-Studio √© um analisador de c√≥digo est√°tico bem conhecido que permite encontrar muitos erros complicados ocultos na fonte. </font><font style="vertical-align: inherit;">O teste beta da nova vers√£o foi conclu√≠do recentemente, no qual √© poss√≠vel analisar projetos C # para Linux e macOS. </font><font style="vertical-align: inherit;">Al√©m disso, o analisador agora pode ser integrado ao JetBrains Cross-Platform IDE - Rider. </font><font style="vertical-align: inherit;">Este artigo permitir√° que voc√™ se familiarize com esses recursos no exemplo de verifica√ß√£o do projeto de c√≥digo aberto RavenDB.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° algum tempo, meu colega </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sergey Vasiliev</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> escreveu uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nota</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre a abertura de um teste beta de uma nova vers√£o do analisador est√°tico PVS-Studio que estamos desenvolvendo. </font><font style="vertical-align: inherit;">Agora o teste beta est√° conclu√≠do e a nova vers√£o pode ser baixada clicando no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No mesmo artigo, examinaremos como analisar projetos C # no Linux / macOS usando a interface do console e o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Depois disso, conduziremos uma an√°lise tradicional de algumas opera√ß√µes interessantes do analisador.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ravendb</font></font></h2><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5ec/dca/148/5ecdca148f1673576dcd824058b19e63.png" alt="Quadro 5"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verifica√ß√£o, foi escolhido um projeto aberto do RavenDB, cujo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reposit√≥rio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> totaliza quase 5 mil arquivos de c√≥digo-fonte. </font><font style="vertical-align: inherit;">√â um banco de dados NoSQL bastante popular. </font><font style="vertical-align: inherit;">Detalhes podem ser encontrados no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">√â f√°cil adivinhar que fiquei atra√≠do pelo tamanho, porque em um projeto t√£o grande e, sem d√∫vida, s√©rio, provavelmente haver√° algo interessante.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface da Linha de comando</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar, considere como analisar atrav√©s do console. </font><font style="vertical-align: inherit;">Esta se√ß√£o, na minha opini√£o, ser√° especialmente interessante para aqueles que desejam integrar o analisador ao sistema de IC. </font><font style="vertical-align: inherit;">A equipe que inicia a an√°lise tem v√°rias op√ß√µes interessantes, mas, no caso geral, tudo √© bastante trivial. </font><font style="vertical-align: inherit;">Para analisar o RavenDB, vou para a pasta do projeto e insiro o seguinte no console:</font></font><br>
<br>
<pre><code class="cs hljs">pvs-studio-dotnet -t ./RavenDB.sln </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sinalizador -t (abrevia√ß√£o de destino) √© usado para especificar uma solu√ß√£o ou arquivo de projeto para verifica√ß√£o. </font><font style="vertical-align: inherit;">A linha apresentada acima inicia a an√°lise e, como resultado do trabalho, forma um arquivo contendo os erros encontrados. </font><font style="vertical-align: inherit;">√â simples, n√£o √©?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cavaleiro</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabalhar com o analisador no Rider √© praticamente o mesmo que no Visual Studio. </font><font style="vertical-align: inherit;">A interface simples e intuitiva do plugin permite que voc√™ verifique o projeto em apenas alguns cliques. </font><font style="vertical-align: inherit;">Isso n√£o √© um exagero - para realizar a an√°lise do RavenDB, basta clicar no menu superior Ferramentas, apontar para ‚ÄúPVS-Studio‚Äù e clicar em ‚ÄúVerificar solu√ß√£o / projeto atual‚Äù.</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a2c/105/bd4/a2c105bd4e20693c064b6c1a4f0dc9f5.png" alt="Quadro 2"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os resultados da an√°lise ser√£o exibidos na parte inferior da janela na guia PVS-Studio (bem, qual mais? :))</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7a4/8d2/477/7a48d2477e60a0038e89c97dbd991406.png" alt="Quadro 3"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como no plug-in do Visual Studio, clicar duas vezes em um aviso exibir√° o local ao qual est√° associado. Tudo √© conveniente e compreens√≠vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais importante, a ferramenta PVS-Studio n√£o indica apenas erros, mas possui uma infraestrutura que facilita a implementa√ß√£o da metodologia de an√°lise est√°tica, mesmo em um grande projeto antigo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ideia geral √© a seguinte. O usu√°rio iniciou o analisador e recebeu muitos avisos. Como um projeto desenvolvido por muitos anos est√° vivo, desenvolve e ganha dinheiro, provavelmente n√£o haver√° muitos avisos no relat√≥rio indicando defeitos cr√≠ticos. Em outras palavras, os bugs cr√≠ticos j√° foram corrigidos de uma maneira ou de outra de maneiras mais caras ou gra√ßas ao feedback dos clientes. Assim, tudo o que o analisador encontra agora pode ser considerado uma d√≠vida t√©cnica, o que √© impratic√°vel tentar eliminar imediatamente. √â racional ignorar esses avisos por enquanto, mas escrever um novo c√≥digo j√° executando an√°lises regulares.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode dizer ao PVS-Studio para considerar esses avisos irrelevantes (adiar a d√≠vida t√©cnica para mais tarde) e n√£o mostr√°-los novamente. O analisador cria um arquivo especial onde armazena informa√ß√µes sobre erros desinteressantes at√© o momento. E agora o PVS-Studio emitir√° avisos apenas em c√≥digo novo ou alterado. Al√©m disso, tudo isso √© implementado de maneira inteligente. Se, por exemplo, uma linha vazia for adicionada ao in√≠cio de um arquivo, o analisador entender√° que, de fato, nada mudou e permanecer√° silencioso. Esse arquivo de marca√ß√£o pode ser incorporado no sistema de controle de vers√£o. O arquivo √© grande, mas n√£o √© assustador, porque geralmente n√£o faz sentido coloc√°-lo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora todos os programadores ver√£o avisos relacionados apenas ao c√≥digo novo ou alterado. Assim, o analisador pode come√ßar a usar o que √© chamado no dia seguinte. E ser√° poss√≠vel retornar √† d√≠vida t√©cnica posteriormente, corrigir gradualmente os erros e configurar o analisador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para suprimir avisos sobre o c√≥digo existente no Rider, basta ir ao menu superior em Ferramentas-&gt; PVS-Studio e clicar em "Suprimir todas as mensagens".</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1d3/860/1eb/1d38601ebc120fa0c03d91df2237a8df.png" alt="Imagem 1"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na janela que aparece, avisando que todas as opera√ß√µes atuais se enquadram na lista de supress√£o, clique em "Ok". </font><font style="vertical-align: inherit;">Como resultado, um arquivo de supress√£o ser√° criado na pasta do projeto, que ser√° levada em considera√ß√£o pelo analisador durante os trabalhos futuros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note-se que o Rider j√° possui um analisador que destaca com √™xito alguns erros. </font><font style="vertical-align: inherit;">Assim, uma s√©rie de avisos do PVS-Studio aponta para um c√≥digo que parece suspeito do ponto de vista do editor. </font><font style="vertical-align: inherit;">No entanto, o PVS-Studio frequentemente encontra erros que podem afastar os olhos sens√≠veis do analisador do JetBrains. </font><font style="vertical-align: inherit;">√â por isso que a solu√ß√£o mais eficaz √© permitir que eles trabalhem em equipe.</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/401/c23/d47/401c23d47c7f813c25acd347e7517482.png" alt="Quadro 10"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E para sobremesa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, como prometido, consideraremos os avisos interessantes que o analisador exibiu de acordo com os resultados da verifica√ß√£o. O projeto cont√©m um grande n√∫mero de arquivos de c√≥digo-fonte, portanto, n√£o foi surpreendente encontrar muitos momentos suspeitos nele. N√£o h√° nada a ser feito - todos cometem erros, mas √© importante fazer todos os esfor√ßos para detect√°-los e corrigi-los em tempo h√°bil. A an√°lise est√°tica pode simplificar bastante essa tarefa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado da verifica√ß√£o, foram exibidos cerca de mil avisos:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a6/3d4/124/2a63d41242fd337aaff1753454f8a79c.png" alt="Quadro 11"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode ler mais sobre os n√≠veis de aviso clicando no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, nem todos os gatilhos indicam erros super assustadores. </font><font style="vertical-align: inherit;">Se assim fosse, seria improv√°vel que pelo menos algo funcionasse no projeto :). </font><font style="vertical-align: inherit;">Mas √© importante entender que, se o analisador "xingar", o c√≥digo parece estranho e deve ser cuidadosamente estudado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o projeto encontrou muitos pontos positivos interessantes. </font><font style="vertical-align: inherit;">No entanto, eu n√£o gostaria que o artigo fosse muito grande, portanto consideraremos apenas alguns deles.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apenas um cheque extra?</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">EnsurePathExists</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">var</span> dirpath = Path.GetDirectoryName(file);<font></font>
  List&lt;<span class="hljs-keyword">string</span>&gt; dirsToCreate = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-keyword">string</span>&gt;();
  <span class="hljs-keyword">while</span> (Directory.Exists(dirpath) == <span class="hljs-literal">false</span>)<font></font>
  {<font></font>
    dirsToCreate.Add(dirpath);<font></font>
    dirpath = Directory.GetParent(dirpath).ToString();<font></font>
    <span class="hljs-keyword">if</span> (dirpath == <span class="hljs-literal">null</span>)                                  <span class="hljs-comment">// &lt;=</span>
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  dirsToCreate.ForEach(x =&gt; Directory.CreateDirectory(x));<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> express√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">V3022</font></a><font style="vertical-align: inherit;"> 'dirpath == null' √© sempre falsa. PosixHelper.cs (124) Voron </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta opera√ß√£o pode ser considerada de diferentes maneiras. Por um lado, √© claro que um cheque extra n√£o √© muito bom, mas por si s√≥ n√£o √© um erro. Por outro lado, vale a pena considerar: esse c√≥digo realmente funciona da maneira que o programador pretendia? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez o desenvolvedor realmente n√£o soubesse que o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nunca retornaria </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se n√£o for assim, podemos fazer uma suposi√ß√£o sobre o que ele queria alcan√ßar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interrup√ß√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deva ser chamada quando n√£o for poss√≠vel obter um pai para o diret√≥rio em quest√£o. Nesse caso, verifique se h√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">faz sentido. </font><font style="vertical-align: inherit;">No entanto, precisamos considerar n√£o o resultado de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas o valor retornado pelo m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetParent</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs">dirsToCreate.Add(dirpath);
<span class="hljs-keyword">var</span> dir = Directory.GetParent(dirpath);    
<span class="hljs-keyword">if</span> (dir == <span class="hljs-literal">null</span>)
  <span class="hljs-keyword">break</span>;<font></font>
<font></font>
dirpath = dir.ToString();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Caso contr√°rio, retornar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetParent lan√ßa</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uma exce√ß√£o ao chamar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nulo t√≠pico</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">ScanOldest</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; copy.Length; i++)<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> item = copy[i].Value;
    <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span> || item == InvalidLowLevelTransaction) <span class="hljs-comment">// &lt;=</span><font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> (val &gt; item.Id)                                    <span class="hljs-comment">// &lt;=</span><font></font>
        val = item.Id;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3125</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O objeto 'item' foi usado ap√≥s a verifica√ß√£o contra nulo. Verifique as linhas: 249, 247. ActiveTransactions.cs (249), ActiveTransactions.cs (247) Voron </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo parece estranho devido ao que acontece quando o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">item √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> realmente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . De fato, se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InvalidLowLevelTransaction</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamb√©m </font><i><font style="vertical-align: inherit;">for </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a condi√ß√£o ser√° verdadeira e uma tentativa de obter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">item.Id</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lan√ßar√° uma exce√ß√£o. E se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InvalidLowLevelTransaction</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o puder ser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a condi√ß√£o " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">item == InvalidLowLevelTransaction</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"√© simplesmente sup√©rfluo. Isso ocorre porque ele √© verificado apenas quando o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">item == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Bem, se de repente o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">item</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o puder ser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , toda a condi√ß√£o perde seu significado e adiciona aninhamento desnecess√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acho que aqui, talvez o operador l√≥gico errado est√° selecionado. Se voc√™ substituir "||" por "&amp;&amp;" na condi√ß√£o, o c√≥digo imediatamente come√ßar√° a parecer l√≥gico. Bem, nenhum problema pode surgir nesse caso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse plano √© t√≠pico dos erros muito perigosos na teoria detectada pelo analisador Para ser justo, deve-se notar que o analisador incorporado no Rider tamb√©m marca esse fragmento como potencialmente perigoso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outro cheque de novo?</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteObjectEnd</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (_continuationState.Count &gt; <span class="hljs-number">1</span>)<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> outerState = <font></font>
      _continuationState.Count &gt; <span class="hljs-number">0</span> ? _continuationState.Pop() : currentState<font></font>
    ;<font></font>
    <span class="hljs-keyword">if</span> (outerState.FirstWrite == <span class="hljs-number">-1</span>)<font></font>
      outerState.FirstWrite = start;<font></font>
    _continuationState.Push(outerState);<font></font>
  }  <font></font>
   ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> express√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">V3022</font></a><font style="vertical-align: inherit;"> '_continuationState.Count&gt; 0' sempre √© verdadeira. </font><font style="vertical-align: inherit;">ManualBlittableJsonDocumentBuilder.cs (152) Sparrow </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, na condi√ß√£o externa, verifica-se que o n√∫mero de elementos na cole√ß√£o √© maior que 1 e, na pr√≥xima linha, o operador tern√°rio verifica se o n√∫mero √© maior que 0. Parece que uma das verifica√ß√µes deve parecer diferente. </font><font style="vertical-align: inherit;">De uma forma ou de outra, esse c√≥digo parece muito suspeito e deve ser cuidadosamente estudado e processado, se necess√°rio.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poss√≠vel NRE</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Expression <span class="hljs-title">VisitIndex</span>(<span class="hljs-params">IndexExpression node</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (node.Object != <span class="hljs-literal">null</span>)<font></font>
  {<font></font>
    Visit(node.Object);<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    Out(node.Indexer.DeclaringType.Name); <span class="hljs-comment">// &lt;=</span><font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (node.Indexer != <span class="hljs-literal">null</span>)               <span class="hljs-comment">// &lt;=</span><font></font>
  {<font></font>
    Out(<span class="hljs-string">"."</span>);<font></font>
    Out(node.Indexer.Name);<font></font>
  }<font></font>
  VisitExpressions(<span class="hljs-string">'['</span>, node.Arguments, <span class="hljs-string">']'</span>);
  <span class="hljs-keyword">return</span> node;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O objeto 'node.Indexer' foi usado antes de ser verificado como nulo. Verifique as linhas: 1180, 1182. ExpressionStringBuilder.cs (1180), ExpressionStringBuilder.cs (1182) Raven.Client </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, esse √© outro local que o PVS-Studio e o Rider consideram suspeitos. √â verdade que a reda√ß√£o √© um pouco diferente: o analisador do JetBrains apenas destaca o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node.Indexer.DeclaringType</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o coment√°rio ‚ÄúPossible NullReferenceException‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ambos os revisores afirmam que uma exce√ß√£o pode realmente ser lan√ßada nesse fragmento. Devo dizer que o aviso do PVS-Studio n√£o apenas diz que um erro √© poss√≠vel aqui, mas tamb√©m explica por que ele tinha essa opini√£o. Parece um pouco, mas legal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, n√£o √© fato que realmente haja um erro. </font><font style="vertical-align: inherit;">√â poss√≠vel que, se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node.Object == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node.Indexer esteja</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exatamente especificado. </font><font style="vertical-align: inherit;">Nesse caso, uma situa√ß√£o √© permitida quando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node.Object</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node.Indexer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o </font><i><font style="vertical-align: inherit;">s√£o </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Somente nesse caso a opera√ß√£o especificada de ambos os analisadores pode ser considerada falsa. </font><font style="vertical-align: inherit;">Portanto, vale a pena analisar cuidadosamente todas as op√ß√µes poss√≠veis.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E se voc√™ cavar mais fundo?</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">LoadStartingWithInternal</span>(<span class="hljs-params">....</span>)</span><font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">var</span> command = operation.CreateRequest();
  <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span>)                       <span class="hljs-comment">// &lt;=</span><font></font>
  {<font></font>
    <span class="hljs-keyword">await</span> RequestExecutor<font></font>
      .ExecuteAsync(command, Context, SessionInfo, token)<font></font>
      .ConfigureAwait(<span class="hljs-literal">false</span>)<font></font>
    ;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (stream != <span class="hljs-literal">null</span>)<font></font>
      Context.Write(stream, command.Result.Results.Parent);<font></font>
    <span class="hljs-keyword">else</span><font></font>
      operation.SetResult(command.Result);<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> express√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">V3022</font></a><font style="vertical-align: inherit;"> 'command! = Null' sempre √© verdadeira. AsyncDocumentSession.Load.cs (175) Raven.Client Um </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aviso √© emitido porque o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo CreateRequest</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nunca retorna </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . De fato, basta olhar para o c√≥digo para ver isso:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> GetDocumentsCommand <span class="hljs-title">CreateRequest</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  _session.IncrementRequestCount();<font></font>
  <span class="hljs-keyword">if</span> (Logger.IsInfoEnabled)<font></font>
    Logger.Info(....);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> GetDocumentsCommand(....);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, essa verifica√ß√£o n√£o √© um problema, embora possa ser que o m√©todo usado para retornar nulo em determinadas circunst√¢ncias, mas agora emita uma exce√ß√£o. </font><font style="vertical-align: inherit;">Quem sabe, √© poss√≠vel que, em vez dessa verifica√ß√£o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , agora haja uma tentativa de captura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode ter uma pergunta muito razo√°vel: onde est√° a exce√ß√£o lan√ßada aqui? </font><font style="vertical-align: inherit;">Caso contr√°rio, ainda temos uma verifica√ß√£o extra e n√£o h√° erro aqui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por√©m, quando o m√©todo √© executado, uma exce√ß√£o pode ser lan√ßada, al√©m disso, duas vezes. </font><font style="vertical-align: inherit;">Primeiro no m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IncrementRequestCount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">IncrementRequestCount</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (++NumberOfRequests &gt; MaxNumberOfRequestsPerSession)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(....);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, no construtor de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetDocumentsCommand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GetDocumentsCommand</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> startWith, ....</span>)</span><font></font>
{<font></font>
  _startWith = startWith ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(startWith));<font></font>
  ....<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiar e colar tradicional</font></font></h3><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteTo</span>(<span class="hljs-params">StringBuilder writer</span>)</span><font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (SqlConnectionStringsUpdated)<font></font>
    json[<span class="hljs-keyword">nameof</span>(SqlConnectionStringsUpdated)] = SqlConnectionStringsUpdated;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (ClientConfigurationUpdated)<font></font>
    json[<span class="hljs-keyword">nameof</span>(ClientConfigurationUpdated)] = ClientConfigurationUpdated;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (ConflictSolverConfigUpdated)<font></font>
    json[<span class="hljs-keyword">nameof</span>(ConflictSolverConfigUpdated)] = ClientConfigurationUpdated;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (PeriodicBackupsUpdated)<font></font>
    json[<span class="hljs-keyword">nameof</span>(PeriodicBackupsUpdated)] = PeriodicBackupsUpdated;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (ExternalReplicationsUpdated)<font></font>
    json[<span class="hljs-keyword">nameof</span>(ExternalReplicationsUpdated)] = ExternalReplicationsUpdated;<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3127</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dois fragmentos de c√≥digo semelhantes foram encontrados. Talvez seja um erro de digita√ß√£o. SmugglerResult.cs (256), SmugglerResult.cs (253) Raven.Client </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duvido muito que pelo menos algu√©m veja estranheza aqui, olhando o c√≥digo. A fun√ß√£o consiste em 14 condi√ß√µes semelhantes e todas as vari√°veis ‚Äã‚Äãterminam em Atualizado. Mesmo quando uma pequena parte √© fornecida aqui, o erro n√£o √© imediatamente vis√≠vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√©rebro humano literalmente se recusa a procurar qualquer coisa nesse c√≥digo. Ao mesmo tempo, o PVS-Studio descobriu facilmente que est√° atribu√≠do, provavelmente, est√° completamente errado, deveria:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">if</span> (ClientConfigurationUpdated)<font></font>
    json[<span class="hljs-keyword">nameof</span>(ClientConfigurationUpdated)] = ClientConfigurationUpdated;<font></font>
<font></font>
<span class="hljs-keyword">if</span> (ConflictSolverConfigUpdated)<font></font>
    json[<span class="hljs-keyword">nameof</span>(ConflictSolverConfigUpdated)] = ClientConfigurationUpdated;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â l√≥gico que a linha inferior √† direita do operador de atribui√ß√£o seja </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConflictSolverConfigUpdated</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Estou certo de que, sem a an√°lise est√°tica, essa singularidade seria encontrada apenas se algo s√©rio o suficiente tivesse quebrado por causa disso. </font><font style="vertical-align: inherit;">O programador poder√° perceber que um problema est√° oculto nessa fun√ß√£o, a menos que ele saiba com anteced√™ncia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh aquilo "??"</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Count =&gt; <font></font>
  _documentsByEntity.Count + _onBeforeStoreDocumentsByEntity?.Count ?? <span class="hljs-number">0</span>;</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3123</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Talvez o '??' O operador trabalha de uma maneira diferente da esperada. Sua prioridade √© menor que a prioridade de outros operadores na parte esquerda. InMemoryDocumentSessionOperations.cs (1952) Raven.Client </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, resta a possibilidade de que isso n√£o seja um erro, √© assim que ele foi planejado. E, no entanto, este lugar parece muito suspeito. Afinal, √© l√≥gico supor que a id√©ia da fun√ß√£o n√£o seja retornar 0 com </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_onBeforeStoreDocumentsByEntity == null.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Eu acho que realmente existe um erro relacionado √†s prioridades dos operadores. Nesse caso, voc√™ deve colocar os colchetes:</font></font><br>
<br>
<pre><code class="cs hljs">_documentsByEntity.Count + (_onBeforeStoreDocumentsByEntity?.Count ?? <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, se de repente tudo estiver realmente planejado, talvez voc√™ deva apontar explicitamente - o analisador e os programadores que l√™em o c√≥digo n√£o ter√£o perguntas:</font></font><br>
<br>
<pre><code class="cs hljs">(_documentsByEntity.Count + _onBeforeStoreDocumentsByEntity?.Count) ?? <span class="hljs-number">0</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas isso √© uma quest√£o de gosto, √© claro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passando par√¢metros</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateEnvironmentVariableLicenseString</span>(<span class="hljs-params">....</span>)</span><font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (ValidateLicense(newLicense, rsaParameters, oldLicense) == <span class="hljs-literal">false</span>)
    <span class="hljs-keyword">return</span>;<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3066</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Poss√≠vel ordem incorreta de argumentos transmitida para o m√©todo 'ValidateLicense': 'newLicense' e 'oldLicense'. </font><font style="vertical-align: inherit;">LicenseHelper.cs (177) Raven.Server Os </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
argumentos foram passados ‚Äã‚Äãpara o m√©todo em ordem suspeita. </font><font style="vertical-align: inherit;">De fato, d√™ uma olhada no an√∫ncio:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">ValidateLicense</span>(<span class="hljs-params">
  License oldLicense, 
  RSAParameters rsaParameters, 
  License newLicense
</span>)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â muito agrad√°vel que o PVS-Studio seja capaz de encontrar at√© esses erros. </font><font style="vertical-align: inherit;">Este √© um √≥timo exemplo da quest√£o dos benef√≠cios da an√°lise est√°tica sobre a an√°lise din√¢mica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o obstante o exposto, sugeri inicialmente que n√£o importa em que ordem esses argumentos s√£o passados. </font><font style="vertical-align: inherit;">Obviamente, nesse caso, os nomes n√£o teriam sido escolhidos corretamente, mas o que voc√™ pode fazer. </font><font style="vertical-align: inherit;">No entanto, a estrutura interna do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ValidateLicense</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sugere que esses par√¢metros ainda tenham significados diferentes. </font><font style="vertical-align: inherit;">O c√≥digo desta fun√ß√£o pode ser visualizado clicando no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nunca continuar</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;CounterOperation&gt; <span class="hljs-title">GetCounterOperationsFor</span>(<span class="hljs-params">RavenEtlItem item</span>)</span><font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; counters.Count; i++)<font></font>
  {<font></font>
    counters.GetPropertyByIndex(i, <span class="hljs-keyword">ref</span> prop);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (<font></font>
      GetCounterValueAndCheckIfShouldSkip(<font></font>
        item.DocumentId, <font></font>
        <span class="hljs-literal">null</span>, <font></font>
        prop, <font></font>
        <span class="hljs-keyword">out</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">value</span>, 
        <span class="hljs-keyword">out</span> <span class="hljs-keyword">bool</span> delete<font></font>
      )<font></font>
    ) <span class="hljs-keyword">continue</span>;<font></font>
    ....<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> express√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">V3022</font></a><font style="vertical-align: inherit;"> 'GetCounterValueAndCheckIfShouldSkip (item.DocumentId, null, prop, valor longo, valor bool out)' √© sempre falsa. RavenEtlDocumentTransformer.cs (362) Raven.Server </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse m√©todo pode ser totalmente considerado ao clicar no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um aviso indica que uma chamada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cont√≠nua</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nesse loop √© inacess√≠vel. E se sim, ent√£o o fragmento √© realmente estranho. Mas talvez seja apenas um falso positivo? No entanto, Rider n√£o jura sobre isso. </font><i><font style="vertical-align: inherit;">D√™ uma</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
olhada no m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetCounterValueAndCheckIfShouldSkip</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">GetCounterValueAndCheckIfShouldSkip</span>(<span class="hljs-params">
  LazyStringValue docId, 
  <span class="hljs-keyword">string</span> function, 
  BlittableJsonReaderObject.PropertyDetails prop, 
  <span class="hljs-keyword">out</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">value</span>, 
  <span class="hljs-keyword">out</span> <span class="hljs-keyword">bool</span> delete
</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">value</span> = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (prop.Value <span class="hljs-keyword">is</span> LazyStringValue)<font></font>
  {<font></font>
    delete = <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    delete = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">value</span> = CountersStorage.InternalGetCounterValue(<font></font>
      prop.Value <span class="hljs-keyword">as</span> BlittableJsonReaderObject.RawBlob, <font></font>
      docId, <font></font>
      prop.Name<font></font>
    );<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (function != <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
      <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> result = BehaviorsScript.Run(<font></font>
        Context, <font></font>
        Context, <font></font>
        function, <font></font>
        <span class="hljs-keyword">new</span> <span class="hljs-keyword">object</span>[] { docId, prop.Name }<font></font>
      ))<font></font>
      {<font></font>
        <span class="hljs-keyword">if</span> (result.BooleanValue != <span class="hljs-literal">true</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, esse m√©todo pode retornar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> somente se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! = </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No c√≥digo considerado anteriormente, exatamente o ponteiro nulo √© passado para o local desse par√¢metro. </font><font style="vertical-align: inherit;">Portanto, a chamada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">continuada</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><font style="vertical-align: inherit;">realmente inacess√≠vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse momento pode ser uma omiss√£o inofensiva e um problema associado a algum erro na condi√ß√£o. </font><font style="vertical-align: inherit;">De uma forma ou de outra, voc√™ deve prestar aten√ß√£o a isso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confie mas verifique</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> LicenseType Type<font></font>
{<font></font>
  <span class="hljs-keyword">get</span><font></font>
  {<font></font>
    <span class="hljs-keyword">if</span> (ErrorMessage != <span class="hljs-literal">null</span>)
      <span class="hljs-keyword">return</span> LicenseType.Invalid;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (Attributes == <span class="hljs-literal">null</span>)
      <span class="hljs-keyword">return</span> LicenseType.None;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (Attributes != <span class="hljs-literal">null</span> &amp;&amp;                             <span class="hljs-comment">// &lt;=</span>
        Attributes.TryGetValue(<span class="hljs-string">"type"</span>, <span class="hljs-keyword">out</span> <span class="hljs-keyword">object</span> type) &amp;&amp;<font></font>
        type <span class="hljs-keyword">is</span> <span class="hljs-keyword">int</span><font></font>
    )<font></font>
    {<font></font>
      <span class="hljs-keyword">var</span> typeAsInt = (<span class="hljs-keyword">int</span>)type;
      <span class="hljs-keyword">if</span> (Enum.IsDefined(<span class="hljs-keyword">typeof</span>(LicenseType), typeAsInt))
        <span class="hljs-keyword">return</span> (LicenseType)typeAsInt;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> LicenseType.Community;<font></font>
  }<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3063</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uma parte da express√£o condicional sempre √© verdadeira se for avaliada: Atributos! = Nulo. </font><font style="vertical-align: inherit;">LicenseStatus.cs (28) Raven.Server </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um fragmento extremamente estranho. </font><font style="vertical-align: inherit;">Normalmente, as verifica√ß√µes sup√©rfluas s√£o pelo menos de alguma forma separadas - aqui a correspond√™ncia da vari√°vel com o ponteiro nulo √© verificada diretamente nas pr√≥ximas linhas. </font><font style="vertical-align: inherit;">Parece que o c√≥digo, muito provavelmente, n√£o √© exatamente o que o programador queria.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anul√°vel que nunca √© nulo</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">SuspendObserver</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (ServerStore.IsLeader())<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> suspend = GetBoolValueQueryString(<span class="hljs-string">"value"</span>);
    <span class="hljs-keyword">if</span> (suspend.HasValue)                                  <span class="hljs-comment">// &lt;=</span><font></font>
    {<font></font>
      Server.ServerStore.Observer.Suspended = suspend.Value;<font></font>
    }<font></font>
<font></font>
    NoContentStatus();<font></font>
    <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
  }<font></font>
<font></font>
  RedirectToLeader();<font></font>
<font></font>
  <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> express√£o V3022 'suspend.HasValue' sempre √© verdadeira. </font><font style="vertical-align: inherit;">RachisAdminHandler.cs (116) Raven.Server </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra verifica√ß√£o "extra" aparentemente inofensiva. </font><font style="vertical-align: inherit;">Embora ainda n√£o esteja claro por que o analisador considera isso. </font><i><font style="vertical-align: inherit;">V√°</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetBoolValueQueryString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">bool</span>? GetBoolValueQueryString(<span class="hljs-keyword">string</span> name, <span class="hljs-keyword">bool</span> required = <span class="hljs-literal">true</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">var</span> boolAsString = GetStringQueryString(name, required);
  <span class="hljs-keyword">if</span> (boolAsString == <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">bool</span>.TryParse(boolAsString, <span class="hljs-keyword">out</span> <span class="hljs-keyword">bool</span> result) == <span class="hljs-literal">false</span>)<font></font>
    ThrowInvalidBoolean(name, boolAsString);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, algumas vezes essa fun√ß√£o retorna </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sim, e Rider n√£o considerou essa verifica√ß√£o desnecess√°ria. </font><font style="vertical-align: inherit;">O unic√≥rnio falhou?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/349/99d/ab6/34999dab64459aebc38561a25b2bad72.png" alt="Quadro 15"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas e se voc√™ olhar para o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetStringQueryString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-title">GetStringQueryString</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> name, <span class="hljs-keyword">bool</span> required = <span class="hljs-literal">true</span></span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">var</span> val = HttpContext.Request.Query[name];
  <span class="hljs-keyword">if</span> (val.Count == <span class="hljs-number">0</span> || <span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(val[<span class="hljs-number">0</span>]))<font></font>
  {<font></font>
    <span class="hljs-keyword">if</span> (required)<font></font>
      ThrowRequiredMember(name);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> val[<span class="hljs-number">0</span>];<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hmm, se o par√¢metro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necess√°rio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> == </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThrowRequiredMember</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ser√° chamado </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eu me pergunto o que ele faz? </font><font style="vertical-align: inherit;">:) Bem, de modo que certamente n√£o resta d√∫vida:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ThrowRequiredMember</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> name</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(
    <span class="hljs-string">$"Query string <span class="hljs-subst">{name}</span> is mandatory, but wasn't specified."</span><font></font>
  );<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, resumimos. O desenvolvedor chama o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetBoolValueQueryString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ele provavelmente acredita que potencialmente o m√©todo n√£o obter√° o valor necess√°rio. Bem, como resultado, ele retorna </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dentro, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetStringQueryString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><i><font style="vertical-align: inherit;">chamado</font></i><font style="vertical-align: inherit;"> . Em caso de problemas, ele retornar√° nulo ou lan√ßar√° uma exce√ß√£o. O segundo ocorre se o par√¢metro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necess√°rio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> estiver </font><font style="vertical-align: inherit;">definido como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Al√©m disso, este √© o seu valor padr√£o. Ao mesmo tempo, ao chamar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetBoolValueQueryString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se voc√™ observar o c√≥digo acima, n√£o ser√° transmitido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vejamos mais uma vez o c√≥digo do m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SuspendObserver</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cujo fragmento foi jurado pelo analisador:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">SuspendObserver</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (ServerStore.IsLeader())<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> suspend = GetBoolValueQueryString(<span class="hljs-string">"value"</span>);
    <span class="hljs-keyword">if</span> (suspend.HasValue)<font></font>
    {<font></font>
      Server.ServerStore.Observer.Suspended = suspend.Value;<font></font>
    }<font></font>
<font></font>
    NoContentStatus();<font></font>
    <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
  }<font></font>
<font></font>
  RedirectToLeader();<font></font>
<font></font>
  <span class="hljs-keyword">return</span> Task.CompletedTask;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que, por design, o segmento n√£o deve ser interrompido aqui se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetBoolValueQueryString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o puder obter o valor. De fato, ap√≥s um bloco com uma verifica√ß√£o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , v√°rias a√ß√µes s√£o executadas e um valor √© retornado. Acredito que, por design, essas a√ß√µes s√£o executadas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">independentemente do</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sucesso do m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetBoolValueQueryString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O que realmente vai acontecer? Um encadeamento de execu√ß√£o ser√° interrompido por uma exce√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para esse ponto correto, voc√™ precisa de uma chamada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetBoolValueQueryString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pass como o segundo par√¢metro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exigido</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> valor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ent√£o tudo realmente funcionar√° como esperado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como eu disse anteriormente, √†s vezes parece que o analisador est√° errado (que pecado esconder, √†s vezes acontece). </font><font style="vertical-align: inherit;">Tamb√©m com bastante frequ√™ncia, o aviso parece insignificante. </font><font style="vertical-align: inherit;">Parece que h√° uma verifica√ß√£o extra aqui, e tudo bem. </font><font style="vertical-align: inherit;">Bem, ou melhor ainda - n√≥s a removemos e sem problemas - o aviso desaparecer√°! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo nos casos em que a opera√ß√£o parece estranha e incompreens√≠vel, n√£o a marque apressadamente como falsa. </font><font style="vertical-align: inherit;">Voc√™ precisa entender por que o analisador considera o local problem√°tico e tomar uma decis√£o depois disso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extravag√¢ncias</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">WriteDocumentsJsonAsync</span>(<span class="hljs-params">...., <span class="hljs-keyword">int</span> numberOfResults</span>) <span class="hljs-comment">// &lt;=</span></span><font></font>
{<font></font>
  <span class="hljs-keyword">using</span> (
    <span class="hljs-keyword">var</span> writer = <span class="hljs-keyword">new</span> AsyncBlittableJsonTextWriter(<font></font>
      context, <font></font>
      ResponseBodyStream(), <font></font>
      Database.DatabaseShutdown<font></font>
    )<font></font>
  )<font></font>
  {<font></font>
    writer.WriteStartObject();<font></font>
    writer.WritePropertyName(<span class="hljs-keyword">nameof</span>(GetDocumentsResult.Results));<font></font>
    numberOfResults = <span class="hljs-keyword">await</span> writer.WriteDocumentsAsync(                    <span class="hljs-comment">// &lt;=</span><font></font>
      context, <font></font>
      documentsToWrite, <font></font>
      metadataOnly<font></font>
    );<font></font>
<font></font>
    ....<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> numberOfResults;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3061 O</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par√¢metro 'numberOfResults' sempre √© reescrito no corpo do m√©todo antes de ser usado. </font><font style="vertical-align: inherit;">DocumentHandler.cs (273), DocumentHandler.cs (267) Raven.Server </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O par√¢metro passado para a fun√ß√£o n√£o √© usado, mas √© imediatamente substitu√≠do. </font><font style="vertical-align: inherit;">Por que √© necess√°rio aqui? </font><font style="vertical-align: inherit;">Eles queriam passar por ref? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fiquei curioso para ver como esse m√©todo √© usado no c√≥digo existente. </font><font style="vertical-align: inherit;">Eu esperava que, uma vez que √© privado, n√£o deveria haver muitos deles. </font><font style="vertical-align: inherit;">Gra√ßas a Rider, encontrei facilmente onde a liga√ß√£o √© feita. </font><font style="vertical-align: inherit;">Este era o √∫nico lugar:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">GetDocumentsByIdAsync</span>(<span class="hljs-params">....</span>)</span><font></font>
{<font></font>
  ....            <font></font>
  <span class="hljs-keyword">int</span> numberOfResults = <span class="hljs-number">0</span>;<font></font>
<font></font>
  numberOfResults = <span class="hljs-keyword">await</span> WriteDocumentsJsonAsync(<font></font>
    context, <font></font>
    metadataOnly, <font></font>
    documents, <font></font>
    includes, <font></font>
    includeCounters?.Results, <font></font>
    numberOfResults<font></font>
  );<font></font>
<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A vari√°vel √© atribu√≠da 0 e, em seguida, √© passada para o m√©todo, cujo resultado √© atribu√≠do a ela. </font><font style="vertical-align: inherit;">E dentro do m√©todo, este par√¢metro n√£o √© usado de forma alguma. </font><font style="vertical-align: inherit;">Em. </font><font style="vertical-align: inherit;">Por que tudo isso?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/74a/e29/1cf/74ae291cf3c642aafc84c5bfce7ed18e.png" alt="Quadro 6"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operador l√≥gico errado</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> OrderByField <span class="hljs-title">ExtractOrderByFromMethod</span>(<span class="hljs-params">....</span>)</span><font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (me.Arguments.Count &lt; <span class="hljs-number">2</span> &amp;&amp; me.Arguments.Count &gt; <span class="hljs-number">3</span>)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidQueryException(....);<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> express√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">V3022</font></a><font style="vertical-align: inherit;"> 'me.Arguments.Count &lt;2 &amp;&amp; me.Arguments.Count&gt; 3' √© sempre falsa. </font><font style="vertical-align: inherit;">Provavelmente o '||' </font><font style="vertical-align: inherit;">operador deve ser usado aqui. </font><font style="vertical-align: inherit;">QueryMetadata.cs (861) Raven.Server O </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
m√©todo completo pode ser visualizado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desta vez, temos um erro √≥bvio, que consiste em usar o operador l√≥gico errado. </font><font style="vertical-align: inherit;">Em sua forma atual, verificar o n√∫mero de argumentos simplesmente n√£o funciona, porque n√£o h√° valor menor que 2 e maior que 3. As verdadeiras inten√ß√µes do desenvolvedor s√£o facilmente reveladas pelo primeiro argumento passado ao construtor de exce√ß√£o:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-string">"Invalid ORDER BY 'spatial.distance(from, to, roundFactor)' call, 
expected 2-3 arguments, got "</span> + me.Arguments.Count<font></font>
   ,    <span class="hljs-string">"&amp;&amp;"</span>  <span class="hljs-string">"||"</span>.</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©todo de tentativa estranho</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">Operator</span>(<span class="hljs-params">OperatorField fieldOption, <span class="hljs-keyword">out</span> QueryExpression op</span>)</span><font></font>
{ <font></font>
  ....<font></font>
  <span class="hljs-keyword">switch</span> (match)<font></font>
  {<font></font>
    ....<font></font>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"("</span>:
      <span class="hljs-keyword">var</span> isMethod = Method(field, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> method); <span class="hljs-comment">// &lt;=</span><font></font>
      op = method;<font></font>
<font></font>
      <span class="hljs-keyword">if</span> (isMethod &amp;&amp; Operator(OperatorField.Optional, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> methodOperator))<font></font>
      {<font></font>
        ....<font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">return</span> isMethod;<font></font>
    ....<font></font>
  }<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3063</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uma parte da express√£o condicional sempre √© verdadeira se for avaliada: isMethod. QueryParser.cs (1797) Raven.Server O </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
m√©todo completo pode ser visto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A constru√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var isMethod = Method (campo, out var method)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> me lembrou m√©todos padr√£o como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Int.TryParse</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esses m√©todos tentam obter o resultado e grav√°-lo na vari√°vel out, e o sinalizador do sucesso da opera√ß√£o √© o valor de retorno. O c√≥digo que utiliza essas fun√ß√µes geralmente verifica o valor de retorno e executa determinadas opera√ß√µes com base nele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na minha opini√£o, a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usado aqui dessa maneira. O resultado do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , al√©m disso, √© o valor de retorno do m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operator</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que o chama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O analisador indica que a vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isMethod</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sempre ser√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verdadeira</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e sua verifica√ß√£o na condi√ß√£o n√£o faz sentido. Isso significa que a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©todo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nunca retorna </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falso</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Qual √© ent√£o o uso de tal constru√ß√£o? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar, verifique se o analisador n√£o se enganou:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">Method</span>(<span class="hljs-params">FieldExpression field, <span class="hljs-keyword">out</span> MethodExpression op</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">var</span> args = ReadMethodArguments();<font></font>
<font></font>
  op = <span class="hljs-keyword">new</span> MethodExpression(field.FieldValue, args);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, o valor de retorno desse m√©todo √© sempre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verdadeiro</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . E se tudo foi planejado como era, ent√£o isso √© estranho, mas n√£o importa, em princ√≠pio. Mas e se n√£o? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReadMethodArguments</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cujo c√≥digo pode ser exibido </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lan√ßa exce√ß√µes em alguns casos. Isso acontece quando um m√©todo n√£o pode executar corretamente sua tarefa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que o c√≥digo que chama a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o foi projetado para gerar exce√ß√µes. Provavelmente, assume-se que, quando n√£o for poss√≠vel obter corretamente o valor da vari√°vel out, a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No entanto, com a implementa√ß√£o atual, uma exce√ß√£o ser√° lan√ßada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seja como for, vale a pena prestar aten√ß√£o a esse fragmento.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null! = null?</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> Address <span class="hljs-title">GetNextEdge</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (m_curEdgeBlock == <span class="hljs-literal">null</span> || m_curEdgeBlock.Count &lt;= m_curEdgeIdx)<font></font>
  {<font></font>
    m_curEdgeBlock = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (m_edgeBlocks.Count == <span class="hljs-number">0</span>)<font></font>
    {<font></font>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationException(
        <span class="hljs-string">"Error not enough edge data.  Giving up on heap dump."</span><font></font>
      );<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> nextEdgeBlock = m_edgeBlocks.Dequeue();
    <span class="hljs-keyword">if</span> (<font></font>
      m_curEdgeBlock != <span class="hljs-literal">null</span> &amp;&amp;                       <span class="hljs-comment">// &lt;=</span>
      nextEdgeBlock.Index != m_curEdgeBlock.Index + <span class="hljs-number">1</span><font></font>
    )<font></font>
    {<font></font>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationException(
        <span class="hljs-string">"Error expected Node Index "</span> + (m_curEdgeBlock.Index + <span class="hljs-number">1</span>) + 
        <span class="hljs-string">" Got "</span> + nextEdgeBlock.Index + <span class="hljs-string">" Giving up on heap dump."</span><font></font>
      );<font></font>
    }<font></font>
<font></font>
    m_curEdgeBlock = nextEdgeBlock;<font></font>
    m_curEdgeIdx = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> m_curEdgeBlock.Values(m_curEdgeIdx++).Target;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3063</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Uma parte da express√£o condicional √© sempre falsa se for avaliada: m_curEdgeBlock! = Null. </font><font style="vertical-align: inherit;">DotNetHeapDumpGraphReader.cs (803) Raven.Debug A </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vari√°vel recebe um ponteiro nulo e, depois de algumas linhas, √© verificada sua desigualdade </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nula</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nesse caso, o c√≥digo que verifica </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nextEdgeBlock.Index! = M_curEdgeBlock.Index + 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se torna sem sentido </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Al√©m disso, uma exce√ß√£o nunca ser√° lan√ßada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â l√≥gico supor que algo n√£o est√° funcionando como deveria, porque o fragmento parece muito estranho. </font><font style="vertical-align: inherit;">Ou a verifica√ß√£o n√£o √© necess√°ria aqui, ou de alguma forma √© implementada incorretamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode considerar o disparo e, por outro lado, seguir o oposto. </font><font style="vertical-align: inherit;">Vamos tentar imaginar uma situa√ß√£o em que essa resposta √© falsa. </font><font style="vertical-align: inherit;">Eu acho que isso s√≥ √© poss√≠vel se o valor da vari√°vel puder ser alterado chamando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deque</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">No entanto, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_curEdgeBlock</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um campo privado e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_edgeBlocks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma fila padr√£o que √© inicializada na mesma classe. </font><font style="vertical-align: inherit;">Portanto, √© altamente duvidoso que uma chamada para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desenfileirar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> possa de alguma forma afetar o valor de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m_curEdgeBlock</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, o gatilho provavelmente n√£o √© falso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro ou nulo</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> HashSet&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">FindSpecialColumns</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> tableSchema, <span class="hljs-keyword">string</span> tableName</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">var</span> mainSchema = GetTable(tableSchema, tableName);<font></font>
<font></font>
  <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">new</span> HashSet&lt;<span class="hljs-keyword">string</span>&gt;();<font></font>
  mainSchema.PrimaryKeyColumns.ForEach(x =&gt; result.Add(x)); <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> fkCandidate <span class="hljs-keyword">in</span> Tables)
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> tableReference <span class="hljs-keyword">in</span> fkCandidate.References.Where(<font></font>
        x =&gt; x.Table == tableName &amp;&amp; x.Schema == tableSchema<font></font>
      )<font></font>
    )<font></font>
    {<font></font>
      tableReference.Columns.ForEach(x =&gt; result.Add(x));<font></font>
    }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3146</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Poss√≠vel desrefer√™ncia nula de 'mainSchema'. O 'Tables.FirstOrDefault' pode retornar o valor nulo padr√£o. DatabaseSchema.cs (31) Raven.Server </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font><font style="vertical-align: inherit;">opera√ß√£o </font><font style="vertical-align: inherit;">, √† primeira vista, pode parecer incompreens√≠vel. De fato, o que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FirstOrDefault</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tem a ver com </font><i><font style="vertical-align: inherit;">isso</font></i><font style="vertical-align: inherit;"> ? Para esclarecer por que o analisador jura, voc√™ precisa observar a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> TableSchema <span class="hljs-title">GetTable</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> schema, <span class="hljs-keyword">string</span> tableName</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">return</span> Tables.FirstOrDefault(<font></font>
    x =&gt; x.Schema == schema &amp;&amp; x.TableName == tableName<font></font>
  );<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma chamada para o m√©todo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FirstOrDefault em</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vez de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser devido ao fato de a cole√ß√£o n√£o conter elementos que correspondam √† condi√ß√£o especificada. Nesse caso, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FirstOrDefault</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e, portanto, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pois </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TableSchema</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© um tipo de refer√™ncia. √â por isso que o PVS-Studio diz que nesse c√≥digo uma tentativa de desreferenciar um ponteiro nulo pode ocorrer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainda pode valer a pena verificar esse caso, para que a execu√ß√£o n√£o seja interrompida com uma </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se a op√ß√£o na qual </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tables.FirstOrDefault</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null for</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> imposs√≠vel, n√£o h√° sentido em usar</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FirstOrDefault em</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vez de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sempre verdade</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VerifyCanExecuteCommand</span>(<span class="hljs-params">
  ServerStore store, TransactionOperationContext context, <span class="hljs-keyword">bool</span> isClusterAdmin
</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">using</span> (context.OpenReadTransaction())<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> read = store.Cluster.GetCertificateByThumbprint(context, Name);
    <span class="hljs-keyword">if</span> (read == <span class="hljs-literal">null</span>)
      <span class="hljs-keyword">return</span>;<font></font>
<font></font>
    <span class="hljs-keyword">var</span> definition = JsonDeserializationServer.CertificateDefinition(read);
    <span class="hljs-keyword">if</span> (<font></font>
      definition.SecurityClearance != SecurityClearance.ClusterAdmin || <span class="hljs-comment">// &lt;=</span>
      definition.SecurityClearance != SecurityClearance.ClusterNode     <span class="hljs-comment">// &lt;=</span><font></font>
    )<font></font>
      <span class="hljs-keyword">return</span>;<font></font>
  }<font></font>
<font></font>
  AssertClusterAdmin(isClusterAdmin);<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do analisador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> express√£o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">V3022</font></a><font style="vertical-align: inherit;"> √© sempre verdadeira. </font><font style="vertical-align: inherit;">Provavelmente o operador '&amp;&amp;' deve ser usado aqui. </font><font style="vertical-align: inherit;">DeleteCertificateFromClusterCommand.cs (21) Raven.Server </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro exemplo de situa√ß√£o em que o operador l√≥gico errado provavelmente est√° selecionado. </font><font style="vertical-align: inherit;">Nesse caso, a condi√ß√£o √© sempre verdadeira, porque a vari√°vel definitivamente n√£o √© igual a pelo menos um dos valores com os quais √© comparada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu acredito que "||" </font><font style="vertical-align: inherit;">deve ser substitu√≠do por "&amp;&amp;". </font><font style="vertical-align: inherit;">Ent√£o os escritos far√£o sentido. </font><font style="vertical-align: inherit;">Se o operador l√≥gico for escolhido corretamente, provavelmente uma das condi√ß√µes deve ser uma compara√ß√£o de outras vari√°veis. </font><font style="vertical-align: inherit;">De um jeito ou de outro, esse fragmento parece muito suspeito e deve ser analisado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de tudo, quero agradecer a todos que chegaram a este lugar. O artigo foi bastante longo, mas espero que voc√™ esteja interessado em trabalhar comigo para entender a nova vers√£o do analisador PVS-Studio e estudar os erros encontrados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante lembrar que o desenvolvedor deve definir como seu principal objetivo n√£o reduzir o n√∫mero de opera√ß√µes. N√£o para obter um log de erros vazio, √© necess√°rio usar o PVS-Studio. Lutar contra os positivos √© como combater os sintomas de uma doen√ßa da qual o c√≥digo-fonte sofre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao examinar as mensagens do analisador, voc√™ deve sempre tentar entender por que esse ou aquele aviso √© emitido. </font><font style="vertical-align: inherit;">Somente realizando a l√≥gica pela qual o analisador emitiu um aviso, podemos concluir se ele indica um erro ou n√£o. </font><font style="vertical-align: inherit;">√â neste caso que voc√™ n√£o lutar√° com o sintoma, mas com a doen√ßa. </font><font style="vertical-align: inherit;">E √© assim que seu c√≥digo se tornar√° mais limpo e saud√°vel. </font><font style="vertical-align: inherit;">E, √© claro, haver√° muito menos problemas com uma fonte t√£o boa. </font><font style="vertical-align: inherit;">Embora seja melhor eu desejo que voc√™ n√£o os tenha :)</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/843/ca9/91e/843ca991e0e2688c6dc6a299fe3af231.png" alt="Quadro 16"></div><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: Nikita Lipilin. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como encontrar erros em um projeto C # trabalhando no Linux e macOS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt507086/index.html">Converter script Bash em c√≥digo C # para enviar SMS via modem usb HUAWEI E3372</a></li>
<li><a href="../pt507090/index.html">Como uma equipe de tecnologia pode construir sua startup ou o caminho do monitoramento funcional para a plataforma AIOps</a></li>
<li><a href="../pt507092/index.html">Convidamos voc√™ para o segundo Zapbix mitap on-line</a></li>
<li><a href="../pt507104/index.html">A grande divis√£o na importa√ß√£o: esclarecendo as incertezas com a importa√ß√£o no TypeScript</a></li>
<li><a href="../pt507106/index.html">Como √© a implementa√ß√£o do DNS sobre HTTPS</a></li>
<li><a href="../pt507112/index.html">PayOnline | Aquisi√ß√£o de empresas pela Internet</a></li>
<li><a href="../pt507114/index.html">Ode Excel: 34 Anos de Magia</a></li>
<li><a href="../pt507116/index.html">"Udalenka". Notas do desenvolvedor do escrit√≥rio de ontem. Parte 2</a></li>
<li><a href="../pt507124/index.html">O APO n√£o √© apenas pele valiosa</a></li>
<li><a href="../pt507132/index.html">Vladimir Kitov: "√â imposs√≠vel entender como os cientistas pioneiros previram a informatiza√ß√£o universal nos anos 50!"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>