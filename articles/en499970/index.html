<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèø ü•§ ü§πüèø We study the Mediastreamer2 VoIP engine. Part 12 ü¶á ü§ë üìç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Article material taken from my zen channel .
 


 

In the last article , I promised to consider the issue of estimating the load on the ticker and wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We study the Mediastreamer2 VoIP engine. Part 12</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499970/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Article material taken from my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zen channel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p><br>
<p><img src="https://habrastorage.org/webt/qy/mv/pc/qymvpcmoqpjjqvi424d2qr115bo.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the last </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I promised to consider the issue of estimating the load on the ticker and ways to deal with excessive computing load in the media streamer. </font><font style="vertical-align: inherit;">But I decided that it would be more logical to cover the debugging issues of craft filters associated with moving data and only then consider performance optimization issues.</font></font></p><br>
<h2 id="otladka-kraftovyh-filtrov"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debugging craft filters</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After we examined the mechanism for moving data in a media streamer in a previous article, it would be logical to talk about the dangers lurking in it. </font><font style="vertical-align: inherit;">One of the features of the "data flow" principle is that the allocation of memory from the heap occurs in the filters that are located at the source of the data stream, and the filters located at the end of the stream path make the memory free and return to the heap. </font><font style="vertical-align: inherit;">In addition, the creation of new data and its destruction can occur somewhere at intermediate points. </font><font style="vertical-align: inherit;">In the general case, freeing the memory is performed by the wrong filter that created the data block.</font></font></p><a name="habracut"></a><br>
<p>         ,  ,   ,         ,           .           ‚Äî      ,                .       ,       ,   ‚Äî        /         .</p><br>
<p>    ,     ,         (      ).         ""       "" .  ,                .       .    ""      ,    MS_TEE      ,     .       ,               : <em>ms_free()</em>.    ,          , ..  "".           (        )      .</p><br>
<p>       ""     ,        .       ‚Äî                     .       ,         .   ,   ,          ,   ""   ,     .</p><br>
<h3 id="kak-proyavlyaet-sebya-utechka-pamyati">    ?</h3><br>
<p> ,     <em>top</em>     ,   .</p><br>
<p>     ,   -        ,   .      ,     .        ,    ,      ..</p><br>
<p>         ( ).    <em>Valgrind</em> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"></a>  )     <em>gcc</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">MemorySanitizer</a>  - .   ,        ,           .</p><br>
<h3 id="metod-treh-sosen">  </h3><br>
<p>    ,       ,      .       ""  , , ,   .  ,      ,      . </p><br>
<p>   ""   ,         ,              .</p><br>
<p>   ,                     .           ,   .</p><br>
<h3 id="metod-skolzyaschego-izolyatora">  </h3><br>
<p>          .    .</p><br>
<p><img src="https://habrastorage.org/webt/zh/fb/fb/zhfbfbqtrezvfuzspumzjuqbcum.png"></p><br>
<p> ,            F1...F4,   ,          .    ,        .      ,     ,              N-  .   ,        MS_VOID_SOURCE.     ‚Äî    .      . ..    .</p><br>
<p>           ,    ,        ,      ,   ""   ,    ,   .     . ,    ,     .      ‚Äî         ,        .   -      . </p><br>
<p>     voidsourse:<br>
<img src="https://habrastorage.org/webt/hq/l9/bk/hql9bkkd3_vyqfldpexgv8lwqoa.png"></p><br>
<p>    ,  ,    ,     .       ,       ( ).       ,       . ,      ,   ,        ""   .  ,            .  ""   ,     .       (   ). "" ,              .</p><br>
<h4 id="realizaciya-filtra-izolyatora"> -</h4><br>
<p>      .  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*  iso_filter.h    . */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> iso_filter_h</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> iso_filter_h</span><font></font>
<font></font>
<span class="hljs-comment">/*   . */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mediastreamer2/msfilter.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_ISO_FILTER_ID 1024</span><font></font>
<font></font>
<span class="hljs-keyword">extern</span> MSFilterDesc iso_filter_desc;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre><br>
<p> :</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*  iso_filter.c    . */</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"iso_filter.h"</span></span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">iso_init</span> <span class="hljs-params">(MSFilter * f)</span>
</span>{<font></font>
}<font></font>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">iso_uninit</span> <span class="hljs-params">(MSFilter * f)</span>
</span>{<font></font>
}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span>
<span class="hljs-title">iso_process</span> <span class="hljs-params">(MSFilter * f)</span>
</span>{
    <span class="hljs-keyword">mblk_t</span> *im;<font></font>
<font></font>
    <span class="hljs-keyword">while</span> ((im = ms_queue_get (f-&gt;inputs[<span class="hljs-number">0</span>])) != <span class="hljs-literal">NULL</span>)<font></font>
    {<font></font>
        ms_queue_put (f-&gt;outputs[<span class="hljs-number">0</span>], copymsg (im));<font></font>
        freemsg (im);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">static</span> MSFilterMethod iso_methods[] = {<font></font>
    {<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>}<font></font>
};<font></font>
<font></font>
MSFilterDesc iso_filter_desc = {<font></font>
    MY_ISO_FILTER_ID,<font></font>
    <span class="hljs-string">"iso_filter"</span>,
    <span class="hljs-string">"A filter that reads from input and copy to its output."</span>,<font></font>
    MS_FILTER_OTHER,<font></font>
    <span class="hljs-literal">NULL</span>,
    <span class="hljs-number">1</span>,
    <span class="hljs-number">1</span>,<font></font>
    iso_init,<font></font>
    <span class="hljs-literal">NULL</span>,<font></font>
    iso_process,<font></font>
    <span class="hljs-literal">NULL</span>,<font></font>
    iso_uninit,<font></font>
    iso_methods<font></font>
};<font></font>
<font></font>
MS_FILTER_DESC_EXPORT (iso_desc)<font></font>
</code></pre><br>
<h3 id="metod-podmeny-funkciy-upravleniya-pamyatyu">    </h3><br>
<p>   ,            ,       ",   ".   .    :</p><br>
<pre><code class="cpp hljs">OrtpMemoryFunctions reserv;<font></font>
OrtpMemoryFunctions my;<font></font>
<font></font>
reserv.malloc_fun = ortp_malloc;<font></font>
reserv.realloc_fun = ortp_realloc;<font></font>
reserv.free_fun = ortp_free;<font></font>
<font></font>
my.malloc_fun = &amp;my_malloc;<font></font>
my.realloc_fun = &amp;my_realloc;<font></font>
my.free_fun = &amp;my_free;<font></font>
<font></font>
ortp_set_memory_functions(&amp;my);</code></pre><br>
<p>    ,      ,         .              . </p><br>
<p>      ,   .         ,   ,     . </p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the next article, we will consider the issue of estimating the load on the ticker and ways to deal with excessive computing load in the media streamer.</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499960/index.html">JanusGraph graph DBMS experiment to solve the problem of finding suitable paths</a></li>
<li><a href="../en499962/index.html">Some facts about cascading classifiers, which are rarely seriously considered in scientific articles.</a></li>
<li><a href="../en499964/index.html">NASA has selected three firms that will participate in the program to create a ship for landing on the moon</a></li>
<li><a href="../en499966/index.html">Measuring the UVA UVB</a></li>
<li><a href="../en499968/index.html">List of the most persistent online mitaps that take place even in May</a></li>
<li><a href="../en499972/index.html">May online events digest</a></li>
<li><a href="../en499974/index.html">3D games on Instagram Javascript, or sausage flight path</a></li>
<li><a href="../en499978/index.html">Translation of Andrew Un's book, Passion for Machine Learning, Chapters 36 and 37</a></li>
<li><a href="../en499982/index.html">Beginner Tester Plan: From ‚ÄúEnter IT‚Äù to ‚ÄúI Am an Engineer!‚Äù</a></li>
<li><a href="../en499986/index.html">And again about embedded: looking for bugs in the Embox project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>