<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍⚕️ ⚓️ 💆🏼 EF Core + Oracle: So machen Sie Migrationen idempotent 💛 📉 🌉</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In der Regel wird das EF Core-Framework in Verbindung mit MS SQL, einem anderen Microsoft-Produkt, verwendet. Dies ist jedoch kein Dogma. Bei CUSTIS s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>EF Core + Oracle: So machen Sie Migrationen idempotent</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/494278/"><img src="https://habrastorage.org/webt/3a/lj/or/3aljorcjihhefstlxuybizl-3tg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Regel wird das EF Core-Framework in Verbindung mit MS SQL, einem anderen Microsoft-Produkt, verwendet. </font><font style="vertical-align: inherit;">Dies ist jedoch kein Dogma. </font><font style="vertical-align: inherit;">Bei CUSTIS schreiben wir beispielsweise Geschäftslogik in C # und verwenden Oracle zur Verwaltung der Datenbanken. </font><font style="vertical-align: inherit;">EF Core hat einen wunderbaren Migrationsmechanismus, aber in unserem Fall sind sie nicht idempotent. </font><font style="vertical-align: inherit;">Tatsache ist, dass Oracle und eine Reihe anderer Datenbanken wie MySQL </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keine Transaktions-DDL unterstützen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dies bedeutet, dass die Migration, wenn sie irgendwo in der Mitte liegt, nicht zurückgesetzt oder zurückgesetzt werden kann. </font><font style="vertical-align: inherit;">Wie implementiere ich idempotente Migrationen zu EF Core ohne MS SQL?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser Unternehmen verfügt über ein ziemlich leistungsfähiges Tool zum Installieren von Patches in einer Oracle-Datenbank, das wir in einer Reihe von Projekten verwenden. </font><font style="vertical-align: inherit;">Es wurde geschrieben, als es keine Liquibase, EF-Migrationen und andere offene Tools gab. </font><font style="vertical-align: inherit;">Mit Patcher können Sie mit Hunderten von Datenbanken arbeiten, den Installationsverlauf verfolgen, Protokolle anzeigen, Geheimnisse speichern und vieles mehr. </font><font style="vertical-align: inherit;">Skripte zum Ändern der Datenbank werden in Form von SQL- oder m4-Makros geschrieben. </font><font style="vertical-align: inherit;">Mit ihrer Hilfe können Sie unter anderem die Struktur ändern: Tabellen, Spalten und andere Objekte erstellen. </font><font style="vertical-align: inherit;">Darüber hinaus sind m4-Makros idempotent. </font><font style="vertical-align: inherit;">Das heißt, wenn Sie beispielsweise versuchen, die Tabelle zu erstellen, fällt das Skript nicht herunter, sondern sieht, dass es bereits vorhanden ist, und überspringt die Erstellung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, ein Skript zum Installieren eines Patches besteht aus zwei Vorgängen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie Tabelle A.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen von Tabelle B.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn das Skript nach der ersten Operation abstürzt, bleibt Tabelle A in Oracle. Das erneute Anwenden des Patches funktioniert ordnungsgemäß: Das Skript überprüft, ob A bereits vorhanden ist, und fährt sofort mit der zweiten Operation fort. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zusätzlich zu den Vorteilen hat der Patcher noch einen Nachteil - das Tool ist geschlossen und wird nur in CUSTIS verwendet. Entwickler müssen lernen, mit ihm zu arbeiten, und außerhalb des Unternehmens ist eine solche Erfahrung nicht sehr wertvoll. Darüber hinaus unterstützt der Patcher den Code First-Betriebsmodus nicht, sodass alle Skripte zum Ändern der Datenbankstruktur manuell geschrieben werden müssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir wollten einen vorgefertigten Mechanismus für die Installation von Patches ausprobieren und haben uns für die Migration entschieden. Ende 2019 wurde gerade ein weiteres Projekt für den Kunden gestartet, bei dem wir beschlossen, einen neuen Ansatz zu testen. Das Hauptproblem dieses Mechanismus war die Nichtidepotenz von Migrationen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In MS SQL wird eine Kette von DDL-Anweisungen oder eine Migration als einzelne zusammengesetzte Transaktion ausgeführt. </font><font style="vertical-align: inherit;">Im Falle einer Unterbrechung wird der Vorgang vollständig abgebrochen. </font><font style="vertical-align: inherit;">Oracle DDL ist nicht transaktionsbezogen, sodass ein Rückgang der Migration zu einem inkonsistenten Status der Datenbank führt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kehren wir zu dem Patch zurück, der aus zwei Vorgängen besteht: Erstellen der Tabellen A und B. Wenn der Migrator nach dem ersten fällt, bleibt Oracle in Tabelle A. Ein Neustart funktioniert nicht - der Operator </font></font><code>CREATE TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird nicht mögen, dass A bereits vorhanden ist. </font><font style="vertical-align: inherit;">Außerdem kann die Migration nicht rückgängig gemacht werden: EF Core schreibt erst am Ende des Prozesses in die Systemtabelle, dass die Migration abgeschlossen wurde. </font><font style="vertical-align: inherit;">Wenn aus Sicht von EF Core die Migration noch nicht abgeschlossen ist, gibt es nichts, was zurückgesetzt werden könnte.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entscheidung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Suche nach einer vorgefertigten Lösung für Oracle im Internet ergab keine Ergebnisse. Ich habe nur Artikel zum </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schreiben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installieren von</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Patches bei der Arbeit mit EF gefunden. Wenig später kam mir bei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StackOverflow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> die Idee, meinen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">IMigrationsSqlGenerator zu erstellen</font></a><font style="vertical-align: inherit;"> . Diese Schnittstelle ist für die Generierung von SQL-Code verantwortlich, der EF-Operationen verarbeitet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Paket </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oracle.EntityFrameworkCore</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enthielt OracleMigrationsSqlGenerator und implementiert IMigrationsSqlGenerator. Wenn Sie beispielsweise eine Spalte hinzufügen möchten, wird der folgende Code generiert:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> MY_TABLE <span class="hljs-keyword">ADD</span> (MY_COLUMN <span class="hljs-built_in">DATE</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anschließend wird der Code an andere Klassen übergeben, um in der Datenbank ausgeführt zu werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu Beginn habe ich versucht, zwei OracleMigrationsSqlGenerator-Vorgänge zu überschreiben. </font><font style="vertical-align: inherit;">Die Aufgabe erwies sich als durchaus machbar, und ich begann, einen idempotenten Migranten zu schreiben. </font><font style="vertical-align: inherit;">So entstand </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor der Operation EF überprüft unser Migrator, ob sie zuvor ausgeführt wurde. </font><font style="vertical-align: inherit;">Zum Beispiel wird eine Spalte wie folgt hinzugefügt:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span>
    i <span class="hljs-built_in">NUMBER</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> i
    <span class="hljs-keyword">FROM</span> user_tab_columns
    <span class="hljs-keyword">WHERE</span> table_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_TABLE'</span>) <span class="hljs-keyword">AND</span> column_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_COLUMN'</span>);<font></font>
    IF I != 1 THEN<font></font>
        <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">IMMEDIATE</span> <span class="hljs-string">'ALTER TABLE MY_TABLE ADD (MY_COLUMN DATE)'</span>;  
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;       
<span class="hljs-keyword">END</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden von</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Verwendung des Pakets ist sehr einfach - Sie müssen es nur </font></font><code>IMigrationsSqlGenerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im richtigen Kontext </font><font style="vertical-align: inherit;">ersetzen </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnConfiguring</span>(<span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span>)</span><font></font>
    {<font></font>
        optionsBuilder.ReplaceService&lt;IMigrationsSqlGenerator, IdempotentSqlGenerator&gt;();<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Migrationen werden mit den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standardtools für EF Core</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gebildet und festgelegt </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cs hljs">dotnet ef migrations <span class="hljs-keyword">add</span> v1<span class="hljs-number">.0</span><span class="hljs-number">.1</span>
dotnet ef database update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> festgelegte allgemeine Ansatz </font><font style="vertical-align: inherit;">kann in Generatoren implementiert werden, die für MySQL, MariaDB, Teradata, AmazonAurora und andere Datenbanken geschrieben wurden, in denen DDL nicht transaktional ist.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verweise</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Paket ist in NuGet </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Sources auf GitHub </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">verfügbar</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de494264/index.html">Zwei-Knoten-Cluster - der Teufel im Detail</a></li>
<li><a href="../de494266/index.html">Über Udalenka, ungeschütztes RDP und die Zunahme der Anzahl der im Internet verfügbaren Server</a></li>
<li><a href="../de494270/index.html">Antiquitäten: Fernarbeit an Geräten von 1998</a></li>
<li><a href="../de494272/index.html">Erstellen eines IT-Startup-Geschäftsplans: Schritt für Schritt detaillierte Struktur</a></li>
<li><a href="../de494274/index.html">E-Commerce-Autotest-System</a></li>
<li><a href="../de494284/index.html">Hausgemachtes Antiseptikum aus dem, was in der Apotheke ist. Wir machen Alkohol aus Wodka ohne Mondschein auf altmodische Weise</a></li>
<li><a href="../de494286/index.html">Embox RTOS auf Raspberry Pi</a></li>
<li><a href="../de494290/index.html">#YAMYWork. Eine Entscheidung, die richtig sein kann</a></li>
<li><a href="../de494292/index.html">Wrike: 5 Jahre bei OKR</a></li>
<li><a href="../de494294/index.html">3D-Druck für die Öl- und Gasindustrie sowie die Schifffahrtsindustrie zertifiziert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>