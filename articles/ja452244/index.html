<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♉️ 🕴🏿 🈺 PHPUnit。Dockrine Entity Managerのモック 🤚🏻 🤜🏽 ⚠️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最新のデータベースアプリケーションの多くは、Doctrine ORMプロジェクトを使用しています。
 

データベースでの作業をサービスに移行することをお勧めします。そして、サービスをテストする必要があります。
 

テストサービスの場合は、テストデータベースに接続するか、エンティティマネージャーと...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PHPUnit。Dockrine Entity Managerのモック</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452244/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最新のデータベースアプリケーションの多くは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doctrine ORM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトを使用しています</font><font style="vertical-align: inherit;">。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースでの作業をサービスに移行することをお勧めします。</font><font style="vertical-align: inherit;">そして、サービスをテストする必要があります。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストサービスの場合は、テストデータベースに接続するか、エンティティマネージャーとリポジトリをロックできます。</font><font style="vertical-align: inherit;">最初のオプションではすべてが明確ですが、サービスをテストするためにデータベースをデプロイすることが必ずしも意味があるとは限りません。</font><font style="vertical-align: inherit;">これについて話します。</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たとえば、次のサービスを考えます。</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src /サービス/ユーザー/ UserService.php</font></font></b>
                        <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// src/Service/User/UserService.php</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">User</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">Code</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">User</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repository</span>\<span class="hljs-title">CodeRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repository</span>\<span class="hljs-title">UserRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">Generator</span>\<span class="hljs-title">CodeGenerator</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">Sender</span>\<span class="hljs-title">SenderService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">User</span>\<span class="hljs-title">Exception</span>\<span class="hljs-title">LoginAlreadyExistsException</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">User</span>\<span class="hljs-title">Exception</span>\<span class="hljs-title">ReferrerUserNotFoundException</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">EntityManagerInterface</span>;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span>
</span>{<font></font>
<font></font>
    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> EntityManagerInterface */</span>
    <span class="hljs-keyword">private</span> $em;<font></font>
<font></font>
    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> UserRepository */</span>
    <span class="hljs-keyword">private</span> $users;<font></font>
<font></font>
    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> CodeRepository */</span>
    <span class="hljs-keyword">private</span> $codes;<font></font>
<font></font>
    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> SenderService */</span>
    <span class="hljs-keyword">private</span> $sender;<font></font>
<font></font>
    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> CodeGenerator */</span>
    <span class="hljs-keyword">private</span> $generator;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">EntityManagerInterface $em, SenderService $sender, CodeGenerator $generator</span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;em = $em;
        <span class="hljs-keyword">$this</span>-&gt;users = $em-&gt;getRepository(User::class);
        <span class="hljs-keyword">$this</span>-&gt;codes = $em-&gt;getRepository(Code::class);
        <span class="hljs-keyword">$this</span>-&gt;sender = $sender;
        <span class="hljs-keyword">$this</span>-&gt;generator = $generator;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> string $login
     * <span class="hljs-doctag">@param</span> string $email
     * <span class="hljs-doctag">@param</span> string|null $referrerLogin
     * <span class="hljs-doctag">@return</span> User
     * <span class="hljs-doctag">@throws</span> LoginAlreadyExistsException
     * <span class="hljs-doctag">@throws</span> ReferrerUserNotFoundException
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $login, <span class="hljs-keyword">string</span> $email, ?<span class="hljs-keyword">string</span> $referrerLogin = <span class="hljs-literal">null</span></span>): <span class="hljs-title">User</span>
    </span>{<font></font>
        $exists = <span class="hljs-keyword">$this</span>-&gt;users-&gt;findOneByLogin($login);
        <span class="hljs-keyword">if</span> ($exists) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LoginAlreadyExistsException();<font></font>
        $referrer = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> ($referrerLogin) {<font></font>
            $referrer = <span class="hljs-keyword">$this</span>-&gt;users-&gt;findOneByLogin($referrerLogin);
            <span class="hljs-keyword">if</span> (!$referrer) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ReferrerUserNotFoundException();<font></font>
        }<font></font>
        $user = (<span class="hljs-keyword">new</span> User())-&gt;setLogin($login)-&gt;setEmail($email)-&gt;setReferrer($referrer);<font></font>
        $code = (<span class="hljs-keyword">new</span> Code())-&gt;setEmail($email)-&gt;setCode(<span class="hljs-keyword">$this</span>-&gt;generator-&gt;generate());
        <span class="hljs-keyword">$this</span>-&gt;sender-&gt;sendCode($code);
        <span class="hljs-keyword">$this</span>-&gt;em-&gt;persist($user);
        <span class="hljs-keyword">$this</span>-&gt;em-&gt;persist($code);
        <span class="hljs-keyword">$this</span>-&gt;em-&gt;flush();
        <span class="hljs-keyword">return</span> $user;<font></font>
    }<font></font>
}</code></pre></div>
                    </div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは彼の唯一の方法をテストする必要があり</font></font><code>create()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のケースを選択します。</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リファラーなしのユーザー作成の成功</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リファラーによるユーザー作成の成功</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラー「すでにログインしています」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラー「リ​​ファラーが見つかりません」</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスをテストするには、インターフェースを実装するオブジェクトが必要です </font></font><code>Doctrine\ORM\EntityManagerInterface</code></p><br>
<h2 id="variant-1-ispolzuem-realnuyu-bazu-dannyh"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプション1.実際のデータベースを使用する</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト用の基本クラスを作成し、そこから後で継承します。</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト/TestCase.php</font></font></b>
                        <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// tests/TestCase.php</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">Common</span>\<span class="hljs-title">Annotations</span>\<span class="hljs-title">AnnotationReader</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">Common</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">ArrayCache</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">EntityManager</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">EntityManagerInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Mapping</span>\<span class="hljs-title">Driver</span>\<span class="hljs-title">AnnotationDriver</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">SchemaTool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">Setup</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">TestCase</span> <span class="hljs-title">as</span> <span class="hljs-title">BaseTestCase</span>;<font></font>
<font></font>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestCase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTestCase</span>
</span>{<font></font>
<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEntityManager</span>(<span class="hljs-params"></span>): <span class="hljs-title">EntityManagerInterface</span>
    </span>{<font></font>
<font></font>
        $paths = [<font></font>
            dirname(<span class="hljs-keyword">__DIR__</span>) . DIRECTORY_SEPARATOR . <span class="hljs-string">'src'</span> . DIRECTORY_SEPARATOR . <span class="hljs-string">'Entity'</span>,<font></font>
        ];<font></font>
        $cache = <span class="hljs-keyword">new</span> ArrayCache();<font></font>
        $driver = <span class="hljs-keyword">new</span> AnnotationDriver(<span class="hljs-keyword">new</span> AnnotationReader(), $paths);<font></font>
<font></font>
        $config = Setup::createAnnotationMetadataConfiguration($paths, <span class="hljs-literal">false</span>);<font></font>
        $config-&gt;setMetadataCacheImpl($cache);<font></font>
        $config-&gt;setQueryCacheImpl($cache);<font></font>
        $config-&gt;setMetadataDriverImpl($driver);<font></font>
        $connection = <span class="hljs-keyword">array</span>(
            <span class="hljs-string">'driver'</span>   =&gt; getenv(<span class="hljs-string">'DB_DRIVER'</span>),
            <span class="hljs-string">'path'</span>     =&gt; getenv(<span class="hljs-string">'DB_PATH'</span>),
            <span class="hljs-string">'user'</span>     =&gt; getenv(<span class="hljs-string">'DB_USER'</span>),
            <span class="hljs-string">'password'</span> =&gt; getenv(<span class="hljs-string">'DB_PASSWORD'</span>),
            <span class="hljs-string">'dbname'</span>   =&gt; getenv(<span class="hljs-string">'DB_NAME'</span>),<font></font>
        );<font></font>
        $em = EntityManager::create($connection, $config);<font></font>
        <span class="hljs-comment">/*
         *       .
         *         
         */</span>
        $schema = <span class="hljs-keyword">new</span> SchemaTool($em);<font></font>
        $schema-&gt;dropSchema($em-&gt;getMetadataFactory()-&gt;getAllMetadata());<font></font>
        $schema-&gt;createSchema($em-&gt;getMetadataFactory()-&gt;getAllMetadata());<font></font>
        <span class="hljs-keyword">return</span> $em;<font></font>
    }<font></font>
}</code></pre></div>
                    </div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これで、テストで環境変数を設定することが理にかなっています。</font></font><code>phpunit.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セクション</font><font style="vertical-align: inherit;">のファイル</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">追加します</font></font><code>php</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">sqlite</font></a><font style="vertical-align: inherit;"> dbを使用します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">phpunit.xml</font></font></b>
                        <div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">phpunit</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:noNamespaceSchemaLocation</span>=<span class="hljs-string">"https://schema.phpunit.de/8.1/phpunit.xsd"</span>
         <span class="hljs-attr">bootstrap</span>=<span class="hljs-string">"vendor/autoload.php"</span>
         <span class="hljs-attr">executionOrder</span>=<span class="hljs-string">"depends,defects"</span>
         <span class="hljs-attr">forceCoversAnnotation</span>=<span class="hljs-string">"true"</span>
         <span class="hljs-attr">beStrictAboutCoversAnnotation</span>=<span class="hljs-string">"true"</span>
         <span class="hljs-attr">beStrictAboutOutputDuringTests</span>=<span class="hljs-string">"true"</span>
         <span class="hljs-attr">beStrictAboutTodoAnnotatedTests</span>=<span class="hljs-string">"true"</span>
         <span class="hljs-attr">verbose</span>=<span class="hljs-string">"true"</span>
         <span class="hljs-attr">colors</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">php</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"DB_DRIVER"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"pdo_sqlite"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"DB_PATH"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"var/db-test.sqlite"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"DB_USER"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"DB_PASSWORD"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"DB_NAME"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">php</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">testsuites</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">testsuite</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"default"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>tests/Unit<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">testsuite</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">testsuites</span>&gt;</span><font></font>
<font></font>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">whitelist</span> <span class="hljs-attr">processUncoveredFilesFromWhitelist</span>=<span class="hljs-string">"true"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">".php"</span>&gt;</span>src<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">whitelist</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">phpunit</span>&gt;</span></code></pre></div>
                    </div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次にサービステストを書きます</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト/ユニット/サービス/UserServiceTest.php</font></font></b>
                        <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// tests/Unit/Service/UserServiceTest.php</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">Unit</span>\<span class="hljs-title">Service</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">Code</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">User</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repository</span>\<span class="hljs-title">CodeRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repository</span>\<span class="hljs-title">UserRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">Generator</span>\<span class="hljs-title">CodeGenerator</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">Sender</span>\<span class="hljs-title">SenderService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">User</span>\<span class="hljs-title">Exception</span>\<span class="hljs-title">LoginAlreadyExistsException</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">User</span>\<span class="hljs-title">Exception</span>\<span class="hljs-title">ReferrerUserNotFoundException</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Service</span>\<span class="hljs-title">User</span>\<span class="hljs-title">UserService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">EntityManagerInterface</span>;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceTest</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span>
</span>{<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> UserService
     */</span>
    <span class="hljs-keyword">protected</span> $service;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> EntityManagerInterface
     */</span>
    <span class="hljs-keyword">protected</span> $em;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUp</span>(<span class="hljs-params"></span>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-built_in">parent</span>::setUp();
        <span class="hljs-keyword">$this</span>-&gt;em = <span class="hljs-keyword">$this</span>-&gt;getEntityManager();
        <span class="hljs-keyword">$this</span>-&gt;service = <span class="hljs-keyword">new</span> UserService(<span class="hljs-keyword">$this</span>-&gt;em, <span class="hljs-keyword">new</span> SenderService(), <span class="hljs-keyword">new</span> CodeGenerator());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@throws</span> LoginAlreadyExistsException
     * <span class="hljs-doctag">@throws</span> ReferrerUserNotFoundException
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCreateSuccessWithoutReferrer</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-comment">//       </span>
        $login = <span class="hljs-string">'case1'</span>;<font></font>
        $email = $login . <span class="hljs-string">'@localhost'</span>;<font></font>
        $user = <span class="hljs-keyword">$this</span>-&gt;service-&gt;create($login, $email);
        <span class="hljs-comment">// ,      </span>
        <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(User::class, $user);
        <span class="hljs-keyword">$this</span>-&gt;assertSame($login, $user-&gt;getLogin());
        <span class="hljs-keyword">$this</span>-&gt;assertSame($email, $user-&gt;getEmail());
        <span class="hljs-keyword">$this</span>-&gt;assertFalse($user-&gt;isApproved());
        <span class="hljs-comment">// ,     </span>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> UserRepository $userRepo */</span>
        $userRepo = <span class="hljs-keyword">$this</span>-&gt;em-&gt;getRepository(User::class);<font></font>
        $u = $userRepo-&gt;findOneByLogin($login);<font></font>
        <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(User::class, $u);
        <span class="hljs-keyword">$this</span>-&gt;assertSame($login, $u-&gt;getLogin());
        <span class="hljs-keyword">$this</span>-&gt;assertSame($email, $u-&gt;getEmail());
        <span class="hljs-keyword">$this</span>-&gt;assertFalse($u-&gt;isApproved());
        <span class="hljs-comment">// ,      </span>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> CodeRepository $codeRepo */</span>
        $codeRepo = <span class="hljs-keyword">$this</span>-&gt;em-&gt;getRepository(Code::class);<font></font>
        $c = $codeRepo-&gt;findLastByEmail($email);<font></font>
        <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(Code::class, $c);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@throws</span> LoginAlreadyExistsException
     * <span class="hljs-doctag">@throws</span> ReferrerUserNotFoundException
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCreateSuccessWithReferrer</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-comment">//     </span>
        $referrerLogin  = <span class="hljs-string">'referer'</span>;<font></font>
        $referrer = <span class="hljs-keyword">new</span> User();<font></font>
        $referrer<font></font>
            -&gt;setLogin($referrerLogin)<font></font>
            -&gt;setEmail($referrerLogin.<span class="hljs-string">'@localhost'</span>)<font></font>
        ;<font></font>
        <span class="hljs-keyword">$this</span>-&gt;em-&gt;persist($referrer);
        <span class="hljs-keyword">$this</span>-&gt;em-&gt;flush();
        <span class="hljs-comment">//       </span>
        $login = <span class="hljs-string">'case2'</span>;<font></font>
        $email = $login . <span class="hljs-string">'@localhost'</span>;<font></font>
        $user = <span class="hljs-keyword">$this</span>-&gt;service-&gt;create($login, $email, $referrerLogin);
        <span class="hljs-comment">// ,      </span>
        <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(User::class, $user);
        <span class="hljs-keyword">$this</span>-&gt;assertSame($login, $user-&gt;getLogin());
        <span class="hljs-keyword">$this</span>-&gt;assertSame($email, $user-&gt;getEmail());
        <span class="hljs-keyword">$this</span>-&gt;assertFalse($user-&gt;isApproved());
        <span class="hljs-keyword">$this</span>-&gt;assertSame($referrer, $user-&gt;getReferrer());
        <span class="hljs-comment">// ,     </span>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> UserRepository $userRepo */</span>
        $userRepo = <span class="hljs-keyword">$this</span>-&gt;em-&gt;getRepository(User::class);<font></font>
        $u = $userRepo-&gt;findOneByLogin($login);<font></font>
        <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(User::class, $u);
        <span class="hljs-keyword">$this</span>-&gt;assertSame($login, $u-&gt;getLogin());
        <span class="hljs-keyword">$this</span>-&gt;assertSame($email, $u-&gt;getEmail());
        <span class="hljs-keyword">$this</span>-&gt;assertFalse($u-&gt;isApproved());
        <span class="hljs-comment">// ,      </span>
        <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> CodeRepository $codeRepo */</span>
        $codeRepo = <span class="hljs-keyword">$this</span>-&gt;em-&gt;getRepository(Code::class);<font></font>
        $c = $codeRepo-&gt;findLastByEmail($email);<font></font>
        <span class="hljs-keyword">$this</span>-&gt;assertInstanceOf(Code::class, $c);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@throws</span> LoginAlreadyExistsException
     * <span class="hljs-doctag">@throws</span> ReferrerUserNotFoundException
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCreateFailWithNonexistentReferrer</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-comment">//   ,     ReferrerUserNotFoundException</span>
        <span class="hljs-keyword">$this</span>-&gt;expectException(ReferrerUserNotFoundException::class);<font></font>
<font></font>
        $referrerLogin  = <span class="hljs-string">'nonexistent-referer'</span>;<font></font>
        $login = <span class="hljs-string">'case3'</span>;<font></font>
        $email = $login . <span class="hljs-string">'@localhost'</span>;
        <span class="hljs-comment">//      </span>
        <span class="hljs-keyword">$this</span>-&gt;service-&gt;create($login, $email, $referrerLogin);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@throws</span> LoginAlreadyExistsException
     * <span class="hljs-doctag">@throws</span> ReferrerUserNotFoundException
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCreateFailWithExistentLogin</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-comment">//   ,     LoginAlreadyExistsException</span>
        <span class="hljs-keyword">$this</span>-&gt;expectException(LoginAlreadyExistsException::class);<font></font>
<font></font>
        <span class="hljs-comment">//      </span>
        $login  = <span class="hljs-string">'case4'</span>;<font></font>
        $email = $login . <span class="hljs-string">'@localhost'</span>;
        <span class="hljs-comment">//       ,   </span>
        $existentUser = <span class="hljs-keyword">new</span> User();<font></font>
        $existentUser<font></font>
            -&gt;setLogin($login)<font></font>
            -&gt;setEmail($login.<span class="hljs-string">'@localhost'</span>)<font></font>
        ;<font></font>
        <span class="hljs-keyword">$this</span>-&gt;em-&gt;persist($existentUser);
        <span class="hljs-keyword">$this</span>-&gt;em-&gt;flush();
        <span class="hljs-comment">//      </span>
        <span class="hljs-keyword">$this</span>-&gt;service-&gt;create($login, $email, <span class="hljs-literal">null</span>);<font></font>
    }<font></font>
}</code></pre></div>
                    </div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスが適切に機能していることを確認してください </font></font></p><br>
<pre><code class="plaintext hljs">./vendor/bin/phpunit</code></pre><br>
<h2 id="variant-2-ispolzuem-mockbuilder"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプション2. MockBuilderを使用する</font></font></h2><br>
<p>     —  .   phpunit          mockBuilder.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> Symfony</a></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">   Symfony</b>
                        <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-comment">// tests/Salary/SalaryCalculatorTest.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Tests</span>\<span class="hljs-title">Salary</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">Employee</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Salary</span>\<span class="hljs-title">SalaryCalculator</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">Common</span>\<span class="hljs-title">Persistence</span>\<span class="hljs-title">ObjectManager</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">Common</span>\<span class="hljs-title">Persistence</span>\<span class="hljs-title">ObjectRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">TestCase</span>;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SalaryCalculatorTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testCalculateTotalSalary</span>(<span class="hljs-params"></span>)
    </span>{<font></font>
        $employee = <span class="hljs-keyword">new</span> Employee();<font></font>
        $employee-&gt;setSalary(<span class="hljs-number">1000</span>);<font></font>
        $employee-&gt;setBonus(<span class="hljs-number">1100</span>);<font></font>
<font></font>
        <span class="hljs-comment">// Now, mock the repository so it returns the mock of the employee</span>
        $employeeRepository = <span class="hljs-keyword">$this</span>-&gt;createMock(ObjectRepository::class);
        <span class="hljs-comment">// use getMock() on PHPUnit 5.3 or below</span>
        <span class="hljs-comment">// $employeeRepository = $this-&gt;getMock(ObjectRepository::class);</span>
        $employeeRepository-&gt;expects(<span class="hljs-keyword">$this</span>-&gt;any())<font></font>
            -&gt;method(<span class="hljs-string">'find'</span>)<font></font>
            -&gt;willReturn($employee);<font></font>
<font></font>
        <span class="hljs-comment">// Last, mock the EntityManager to return the mock of the repository</span>
        $objectManager = <span class="hljs-keyword">$this</span>-&gt;createMock(ObjectManager::class);
        <span class="hljs-comment">// use getMock() on PHPUnit 5.3 or below</span>
        <span class="hljs-comment">// $objectManager = $this-&gt;getMock(ObjectManager::class);</span>
        $objectManager-&gt;expects(<span class="hljs-keyword">$this</span>-&gt;any())<font></font>
            -&gt;method(<span class="hljs-string">'getRepository'</span>)<font></font>
            -&gt;willReturn($employeeRepository);<font></font>
<font></font>
        $salaryCalculator = <span class="hljs-keyword">new</span> SalaryCalculator($objectManager);
        <span class="hljs-keyword">$this</span>-&gt;assertEquals(<span class="hljs-number">2100</span>, $salaryCalculator-&gt;calculateTotalSalary(<span class="hljs-number">1</span>));<font></font>
    }<font></font>
}</code></pre></div>
                    </div><br>
<p> ,   .   ,        EntityManager.<br>
,            ,  .   — .</p><br>
<p>     EntityManager,             .</p><br>
<h2 id="variant-3-ispolzuem-mockbuilder-s-hraneniem-dannyh-v-pamyati"> 3.  MockBuilder     .</h2><br>
<p> ,   ,        .    <code>phpunit.xml</code></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> phpunit.xml</b>
                        <div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
    <span class="hljs-comment">&lt;!--   ... --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">php</span>&gt;</span>
        <span class="hljs-comment">&lt;!--   ... --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">env</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"EMULATE_BD"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span> /&gt;</span>
        <span class="hljs-comment">&lt;!--   ... --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">php</span>&gt;</span>
    <span class="hljs-comment">&lt;!--   ... --&gt;</span></code></pre></div>
                    </div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次に、基本クラスを変更します</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変更されたテスト/ TestCase.php</font></font></b>
                        <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// tests/TestCase.php</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Tests</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">Code</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">User</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repository</span>\<span class="hljs-title">CodeRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repository</span>\<span class="hljs-title">UserRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">Common</span>\<span class="hljs-title">Annotations</span>\<span class="hljs-title">AnnotationReader</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">Common</span>\<span class="hljs-title">Cache</span>\<span class="hljs-title">ArrayCache</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">EntityManager</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">EntityManagerInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Mapping</span>\<span class="hljs-title">Driver</span>\<span class="hljs-title">AnnotationDriver</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">SchemaTool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Doctrine</span>\<span class="hljs-title">ORM</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">Setup</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">MockObject</span>\<span class="hljs-title">MockObject</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">TestCase</span> <span class="hljs-title">as</span> <span class="hljs-title">BaseTestCase</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">ReflectionClass</span>;<font></font>
<font></font>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestCase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseTestCase</span>
</span>{<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> MockObject[]
     */</span>
    <span class="hljs-keyword">private</span> $_mock = [];<font></font>
<font></font>
    <span class="hljs-keyword">private</span> $_data = [<font></font>
        User::class =&gt; [],<font></font>
        Code::class =&gt; [],<font></font>
    ];<font></font>
<font></font>
    <span class="hljs-keyword">private</span> $_persist = [<font></font>
        User::class =&gt; [],<font></font>
        Code::class =&gt; [],<font></font>
    ];<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> Closure[][]
     */</span>
    <span class="hljs-keyword">private</span> $_fn = [];<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$name = <span class="hljs-literal">null</span>, <span class="hljs-keyword">array</span> $data = [], $dataName = <span class="hljs-string">''</span></span>)
    </span>{
        <span class="hljs-built_in">parent</span>::__construct($name, $data, $dataName);
        <span class="hljs-keyword">$this</span>-&gt;initFn();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEntityManager</span>(<span class="hljs-params"></span>): <span class="hljs-title">EntityManagerInterface</span>
    </span>{<font></font>
        $emulate = (<span class="hljs-keyword">int</span>)getenv(<span class="hljs-string">'EMULATE_BD'</span>);
        <span class="hljs-keyword">return</span> $emulate ? <span class="hljs-keyword">$this</span>-&gt;getMockEntityManager() : <span class="hljs-keyword">$this</span>-&gt;getRealEntityManager();<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRealEntityManager</span>(<span class="hljs-params"></span>): <span class="hljs-title">EntityManagerInterface</span>
    </span>{<font></font>
        $paths = [<font></font>
            dirname(<span class="hljs-keyword">__DIR__</span>) . DIRECTORY_SEPARATOR . <span class="hljs-string">'src'</span> . DIRECTORY_SEPARATOR . <span class="hljs-string">'Entity'</span>,<font></font>
        ];<font></font>
        $cache = <span class="hljs-keyword">new</span> ArrayCache();<font></font>
        $driver = <span class="hljs-keyword">new</span> AnnotationDriver(<span class="hljs-keyword">new</span> AnnotationReader(), $paths);<font></font>
<font></font>
        $config = Setup::createAnnotationMetadataConfiguration($paths, <span class="hljs-literal">false</span>);<font></font>
        $config-&gt;setMetadataCacheImpl($cache);<font></font>
        $config-&gt;setQueryCacheImpl($cache);<font></font>
        $config-&gt;setMetadataDriverImpl($driver);<font></font>
        $connection = <span class="hljs-keyword">array</span>(
            <span class="hljs-string">'driver'</span>   =&gt; getenv(<span class="hljs-string">'DB_DRIVER'</span>),
            <span class="hljs-string">'path'</span>     =&gt; getenv(<span class="hljs-string">'DB_PATH'</span>),
            <span class="hljs-string">'user'</span>     =&gt; getenv(<span class="hljs-string">'DB_USER'</span>),
            <span class="hljs-string">'password'</span> =&gt; getenv(<span class="hljs-string">'DB_PASSWORD'</span>),
            <span class="hljs-string">'dbname'</span>   =&gt; getenv(<span class="hljs-string">'DB_NAME'</span>),<font></font>
        );<font></font>
        $em = EntityManager::create($connection, $config);<font></font>
        <span class="hljs-comment">/*
         *       .
         *         
         */</span>
        $schema = <span class="hljs-keyword">new</span> SchemaTool($em);<font></font>
        $schema-&gt;dropSchema($em-&gt;getMetadataFactory()-&gt;getAllMetadata());<font></font>
        $schema-&gt;createSchema($em-&gt;getMetadataFactory()-&gt;getAllMetadata());<font></font>
        <span class="hljs-keyword">return</span> $em;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getMockEntityManager</span>(<span class="hljs-params"></span>): <span class="hljs-title">EntityManagerInterface</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;mock(EntityManagerInterface::class);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mock</span>(<span class="hljs-params">$class</span>)
    </span>{
        <span class="hljs-keyword">if</span> (!array_key_exists($class, <span class="hljs-keyword">$this</span>-&gt;_mock)) {
            <span class="hljs-comment">/*
             *    
             */</span>
            $mock = <span class="hljs-keyword">$this</span>-&gt;getMockBuilder($class)<font></font>
                -&gt;disableOriginalConstructor()<font></font>
                -&gt;getMock()<font></font>
            ;<font></font>
<font></font>
            <span class="hljs-comment">/*
             *    
             */</span>
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;_fn[$class] <span class="hljs-keyword">as</span> $method =&gt; $fn) {<font></font>
                $mock<font></font>
                    <span class="hljs-comment">/*     */</span>
                    -&gt;expects(<span class="hljs-keyword">$this</span>-&gt;any())
                    <span class="hljs-comment">/*  $method */</span><font></font>
                    -&gt;method($method)<font></font>
                    <span class="hljs-comment">/*  (  )  */</span><font></font>
                    -&gt;with()<font></font>
                    <span class="hljs-comment">/*     */</span>
                    -&gt;will(<span class="hljs-keyword">$this</span>-&gt;returnCallback($fn))<font></font>
                ;<font></font>
            }<font></font>
            <span class="hljs-keyword">$this</span>-&gt;_mock[$class] = $mock;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;_mock[$class];<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/*
     *    .
     *     $fn_[][]
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initFn</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-comment">/*
         * EntityManagerInterface::persist($object) -     
         */</span>
        <span class="hljs-keyword">$this</span>-&gt;_fn[EntityManagerInterface::class][<span class="hljs-string">'persist'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$object</span>)
        </span>{<font></font>
            $entity = get_class($object);<font></font>
            <span class="hljs-keyword">switch</span> ($entity) {
                <span class="hljs-keyword">case</span> User::class:
                    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> User $object */</span>
                    <span class="hljs-keyword">if</span> (!$object-&gt;getId()) {<font></font>
                        $id = count(<span class="hljs-keyword">$this</span>-&gt;_persist[$entity]) + <span class="hljs-number">1</span>;<font></font>
                        $reflection = <span class="hljs-keyword">new</span> ReflectionClass($object);<font></font>
                        $property = $reflection-&gt;getProperty(<span class="hljs-string">'id'</span>);<font></font>
                        $property-&gt;setAccessible(<span class="hljs-literal">true</span>);<font></font>
                        $property-&gt;setValue($object, $id);<font></font>
                    }<font></font>
                    $id = $object-&gt;getId();<font></font>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> Code::class:
                    <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> Code $object */</span>
                    <span class="hljs-keyword">if</span> (!$object-&gt;getId()) {<font></font>
                        $id = count(<span class="hljs-keyword">$this</span>-&gt;_persist[$entity]) + <span class="hljs-number">1</span>;<font></font>
                        $reflection = <span class="hljs-keyword">new</span> ReflectionClass($object);<font></font>
                        $property = $reflection-&gt;getProperty(<span class="hljs-string">'id'</span>);<font></font>
                        $property-&gt;setAccessible(<span class="hljs-literal">true</span>);<font></font>
                        $property-&gt;setValue($object, $id);<font></font>
                    }<font></font>
                    $id = $object-&gt;getId();<font></font>
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:<font></font>
                    $id = spl_object_hash($object);<font></font>
            }<font></font>
            <span class="hljs-keyword">$this</span>-&gt;_persist[$entity][$id] = $object;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-comment">/*
         * EntityManagerInterface::flush() -     
         */</span>
        <span class="hljs-keyword">$this</span>-&gt;_fn[EntityManagerInterface::class][<span class="hljs-string">'flush'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-keyword">$this</span>-&gt;_data = array_replace_recursive(<span class="hljs-keyword">$this</span>-&gt;_data, <span class="hljs-keyword">$this</span>-&gt;_persist);<font></font>
        };<font></font>
<font></font>
        <span class="hljs-comment">/*
         * EntityManagerInterface::getRepository($className) -   
         */</span>
        <span class="hljs-keyword">$this</span>-&gt;_fn[EntityManagerInterface::class][<span class="hljs-string">'getRepository'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$className</span>)
        </span>{
            <span class="hljs-keyword">switch</span> ($className) {
                <span class="hljs-keyword">case</span> User::class:
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;mock(UserRepository::class);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> Code::class:
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;mock(CodeRepository::class);
                    <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-comment">/*
         * UserRepository::findOneByLogin($login) -      
         */</span>
        <span class="hljs-keyword">$this</span>-&gt;_fn[UserRepository::class][<span class="hljs-string">'findOneByLogin'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$login</span>) </span>{
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;_data[User::class] <span class="hljs-keyword">as</span> $user) {
                <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> User $user
                 */</span>
                <span class="hljs-keyword">if</span> ($user-&gt;getLogin() == $login) <span class="hljs-keyword">return</span> $user;<font></font>
            }<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-comment">/*
         * CodeRepository::findOneByCodeAndEmail -     
         *       
         */</span>
        <span class="hljs-keyword">$this</span>-&gt;_fn[CodeRepository::class][<span class="hljs-string">'findOneByCodeAndEmail'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$code, $email</span>) </span>{<font></font>
            $result = [];<font></font>
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;_data[Code::class] <span class="hljs-keyword">as</span> $c) {
                <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> Code $c */</span>
                <span class="hljs-keyword">if</span> ($c-&gt;getEmail() == $email &amp;&amp; $c-&gt;getCode() == $code) {<font></font>
                    $result[$c-&gt;getId()] = $c;<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span> (!$result) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">return</span> array_shift($result);<font></font>
        };<font></font>
<font></font>
        <span class="hljs-comment">/*
         * CodeRepository::findLastByEmail($email) -  ()   
         *    
         */</span>
        <span class="hljs-keyword">$this</span>-&gt;_fn[CodeRepository::class][<span class="hljs-string">'findLastByEmail'</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$email</span>) </span>{<font></font>
            $result = [];<font></font>
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;_data[Code::class] <span class="hljs-keyword">as</span> $c) {
                <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> Code $c */</span>
                <span class="hljs-keyword">if</span> ($c-&gt;getEmail() == $email) {<font></font>
                    $result[$c-&gt;getId()] = $c;<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span> (!$result) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">return</span> array_shift($result);<font></font>
        };<font></font>
    }<font></font>
}</code></pre></div>
                    </div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これで、テストを再度実行して、データベースに接続せずにサービスが機能することを確認できます。</font></font></p><br>
<pre><code class="plaintext hljs">./vendor/bin/phpunit</code></pre><br>
<p><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Githubで</font></a><font style="vertical-align: inherit;">入手可能なソースコード</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452230/index.html">3I306Mの例でトンネルダイオードを研究</a></li>
<li><a href="../ja452232/index.html">ObjectRepository-ホームプロジェクト用の.NETインメモリリポジトリパターン</a></li>
<li><a href="../ja452234/index.html">ATMEGA 328P-MUの温度計と湿度計-Arduinoの開発レベルを上げる</a></li>
<li><a href="../ja452236/index.html">Androidアプリケーション内のスクリプトの調和</a></li>
<li><a href="../ja452240/index.html">オルガスムとWi-Fiの共通点</a></li>
<li><a href="../ja452246/index.html">Vitaly Bragilevskyへのインタビュー：「誰もがHaskellでプログラムする世界は、良い世界ではありません」</a></li>
<li><a href="../ja452248/index.html">パターンを使用してVueの開発を促進します：HOC</a></li>
<li><a href="../ja452252/index.html">Googleスタイルのセキュリティ</a></li>
<li><a href="../ja452258/index.html">Corda-ビジネス向けのオープンソースのブロックチェーン</a></li>
<li><a href="../ja452262/index.html">Angular：ライブラリの作成と公開</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>