<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíáüèø üå¨Ô∏è üí± Migrating from OpenVPN to WireGuard to join networks into one L2 network ‚ôÄÔ∏è üëâüèº üèÇüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to share the experience of combining networks in three geographically remote apartments, in each of which routers with OpenWRT are used a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Migrating from OpenVPN to WireGuard to join networks into one L2 network</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486864/"><img src="https://habrastorage.org/webt/sk/lb/nc/sklbncaul8kfwr65yuroz8eteki.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would like to share the experience of combining networks in three geographically remote apartments, in each of which routers with OpenWRT are used as a gateway into one common network. </font><font style="vertical-align: inherit;">When choosing a method for combining networks between L3 with routing of subnets and L2 with bridging, when all nodes of the network will be on the same subnet, the second method was preferred, which was more difficult to configure, but giving more opportunities, since the network was planned to use transparent technologies Wake-on-Lan and DLNA.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 1: Background</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenVPN was initially chosen as the protocol for implementing this task, because, firstly, it can create a tap device that can be easily added to the bridge, and secondly, OpenVPN supports TCP protocol operation, which was also important, because none of the apartments had a dedicated IP address, and I was not able to use STUN, because for some reason my provider blocks incoming connections via UDP from their networks, while TCP allowed me to forward the port of the VPN server to leased VPS using SSH. Yes, this approach gives a big load, since the data is encrypted twice, but I did not want to enter VPS into my private network, as there was a risk of third parties gaining control over it, therefore,having such a device on the home network was extremely undesirable and it was decided to pay for security with a large overhead.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To forward the port on the router on which it was planned to deploy the server, the sshtunnel program was used. I will not describe the intricacies of its configuration - this is done quite easily, I just note that its task was to forward the TCP port 1194 from the router to the VPS. Next, the OpenVPN server was configured on the tap0 device, which wound up in the br-lan bridge. After checking the connection to the server you just created from the laptop, it became clear that the idea of ‚Äã‚Äãport forwarding had paid off and my laptop became a member of the router network, although I was not physically there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The matter remained small: it was necessary to distribute IP addresses in different apartments so that they did not conflict and configure routers as OpenVPN clients. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following router IP addresses and DHCP server ranges were selected:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a range of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.80</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the server</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a range of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.101</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.149</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the router in apartment No. 2</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.150</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a range of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.151</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.199</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the router in apartment No. 3</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was also necessary to assign these addresses to the client routers of the OpenVPN server by adding the following lines to its configuration:</font></font><br>
<br>
<pre><code class="plaintext hljs">ifconfig-pool-persist /etc/openvpn/ipp.txt 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and adding the following lines to the /etc/openvpn/ipp.txt file:</font></font><br>
<br>
<pre><code class="plaintext hljs">flat1_id 192.168.10.100<font></font>
flat2_id 192.168.10.150<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where flat1_id and flat2_id are the device names specified when creating certificates for connecting to OpenVPN</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, OpenVPN clients were configured on the routers, tap0 devices on both were added to the br-lan bridge. At this stage, it seemed that everything was in order, since all three networks see each other and work as a whole. However, it turned out to be a not very pleasant detail: sometimes devices could not get an IP address from their router, with all the ensuing consequences. For some reason, the router in one of the apartments did not have time to respond in time to DHCPDISCOVER and the device did not receive its address. I realized that I need to filter such requests in tap0 on each of the routers, but, as it turned out, iptables cannot work with the device if it is part of the bridge and ebtables should come to my aid. Unfortunately, it wasn‚Äôt in my firmware and I had to rebuild the images for each device.Having done this and adding such lines to /etc/rc.local of each router, the problem was solved:</font></font><br>
<br>
<pre><code class="bash hljs">ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This configuration lasted for three years.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 2: Introducing WireGuard</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recently, on the Internet, they began to talk more and more about WireGuard, admiring the simplicity of its configuration, high transmission speed, low ping with comparable security. The search for additional information about him made it clear that they did not support either working as a member of the bridge or working with the TCP protocol, which made me think that there were still no alternatives to OpenVPN for me. So I put off getting to know WireGuard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A few days ago, over the resources, one way or another connected with IT, the news flashed that WireGuard will finally be included in the Linux kernel, starting with version 5.6. News articles, as always, praised WireGuard. I again plunged into the search for ways to replace the good old OpenVPN. This time I ran into </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It talked about building an Ethernet tunnel over L3 using GRE. This article gave me hope. It remained unclear what to do with the UDP protocol. The search led me to articles about using socat in conjunction with an SSH tunnel to forward a UDP port, however, they noted that this approach only works in single connection mode, that is, the work of several VPN clients would be impossible. I came up with the idea of ‚Äã‚Äãraising a VPN server on VPS, and setting up GRE for clients, but as it turned out, GRE does not support encryption, which will lead to the fact that in case of access to the server by third parties, all traffic between my networks is in their hands that did not suit me in principle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Again, the decision was made in favor of excessive encryption, by using a VPN over a VPN according to the following scheme:</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First level VPN: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with an internal address of 192.168.30.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">client</font></i><font style="vertical-align: inherit;"> with an internal address of 192.168.30.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">client</font></i><font style="vertical-align: inherit;"> with an internal address of 192.168.30.3 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">client</font></i><font style="vertical-align: inherit;"> with an internal address of 192.168.30.3 </font><b><font style="vertical-align: inherit;">MK2</font></b><font style="vertical-align: inherit;"> is </font><i><font style="vertical-align: inherit;">a </font></i></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">second-level VPN: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with an external address 192.168.30.2 and an internal 192.168.31.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS </font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">client</font></i><font style="vertical-align: inherit;"> with an address of 192.168.30.2 and has an internal IP 192.168.31.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an </font></font></i> <font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">MS </font></b><i><font style="vertical-align: inherit;">client</font></i></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the address 192.168.30.2 and has an internal IP 192.168.31.3 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - router-server in apartment 1, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - router in apartment 2, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - router in apartment 3 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Device configurations are published in the spoiler at the end of the article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so, pings between the nodes of the network 192.168.31.0/24 go, it is time to move on to setting up the GRE tunnel. Before this, in order not to lose access to the routers, it is worth setting up SSH tunnels to forward 22 ports on the VPS, so that, for example, the router from apartment 2 will be available on the 10022nd VPS port, and on the 11122th port the VPS will be available the router is from apartment 3. It is best to configure forwarding with the same sshtunnel, as it will restore the tunnel if it falls.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The tunnel is configured, you can connect to SSH through the forwarded port:</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@_VPS -p 10022</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, disable OpenVPN:</font></font><br>
<br>
<pre><code class="bash hljs">/etc/init.d/openvpn stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now configure the GRE tunnel on the router from apartment 2:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.1 <span class="hljs-built_in">local</span> 192.168.31.2<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And add the created interface to the bridge:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will perform a similar procedure on the router-server:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.2 <span class="hljs-built_in">local</span> 192.168.31.1<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And, also, add the created interface to the bridge:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
starting from this moment, pings begin to successfully go to the new network and I, with satisfaction, am going to drink coffee. </font><font style="vertical-align: inherit;">Then, in order to evaluate how the network works on the other end of the wire, I try to connect via SSH to one of the computers in apartment 2, but the ssh client freezes without prompting for a password. </font><font style="vertical-align: inherit;">I try to connect to this computer via telnet to port 22 and I see a line from which it can be understood that the connection is being established, the SSH server is responding, just for some reason does not offer me to log in.</font></font><br>
<br>
<pre><code class="bash hljs">$ telnet 192.168.10.110 22<font></font>
SSH-2.0-OpenSSH_8.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I try to connect to it via VNC and see a black screen. I assure myself that it is a remote computer, because I can easily connect to the router from this apartment at the internal address. However, I decide to connect to the SSH of this computer through a router and am surprised to find that the connection is successful and the remote computer is working properly, but it also cannot connect to my computer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I remove the grelan0 device from the bridge and run OpenVPN on the router in apartment 2 and make sure that the network works again as expected and the connections do not break. When I search, I come across forums where people complain about the same problems, where they are advised to raise the MTU. However, I was not able to increase the MTU for the first level VPN (wg0): with MTUs above 1420, which is set automatically, breaks begin, but at the same time, the second level VPN wg1 working on top of wg0 worked correctly with MTU 1600. This is enough to install The MTU is 1500 for the gretap device, so that this interface has the same MTU value as the br-lan bridge into which gretap was planned to be added. As I understand it, the bridge sets the MTU equal to the smaller of the available values ‚Äã‚Äãon all devices.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I made a similar configuration on the router from apartment 3, with the only difference being that on the router the server added a second gretap interface named grelan1, which was also added to the br-lan bridge. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is working. </font><font style="vertical-align: inherit;">Now you can put the gretap assembly at startup. </font><font style="vertical-align: inherit;">To do this: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Put these lines in /etc/rc.local on the router in apartment 2:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.2<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Added this to /etc/rc.local on the router in apartment 3:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And on the server router:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.2 local 192.168.31.1<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
<font></font>
ip link add grelan1 type gretap remote 192.168.31.3 local 192.168.31.1<font></font>
ip link set dev grelan1 mtu 1500<font></font>
ip link set grelan1 up<font></font>
brctl addif br-lan grelan1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After rebooting the client routers, I found that for some reason they did not connect to the server. </font><font style="vertical-align: inherit;">Having connected to their SSH (fortunately, I preconfigured sshtunnel for this), it was discovered that WireGuard was creating a route for endpoint for some reason, but it was incorrect. </font><font style="vertical-align: inherit;">So, for 192.168.30.2, the route table indicated the route through the pppoe-wan interface, that is, via the Internet, although the route to it should have been routed through the wg0 interface. </font><font style="vertical-align: inherit;">After deleting this route, the connection was restored. </font><font style="vertical-align: inherit;">I could not find somewhere instructions on how to make WireGuard not create these routes. </font><font style="vertical-align: inherit;">Moreover, I did not even understand, a feature is OpenWRT, or WireGuard itself. </font><font style="vertical-align: inherit;">Not having to deal with this problem for a long time, I simply added a line to this router to the script looped over by a timer to delete this route:</font></font><br>
<br>
<pre><code class="bash hljs">route del 192.168.30.2
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To summarize</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have not yet achieved a complete rejection of OpenVPN, since I sometimes need to connect to a new network from a laptop or phone, and setting up a gretap device on them is generally impossible, but despite this, I got an advantage in the data transfer speed between apartments and, for example, the use of VNC now does not cause inconvenience. </font><font style="vertical-align: inherit;">Ping decreased slightly, but became more stable: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When using OpenVPN:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=133 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=125 ms<font></font>
<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19006ms<font></font>
rtt min/avg/max/mdev = 124.722/126.152/136.907/3.065 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When using WireGuard:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=124 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=124 ms<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19003ms<font></font>
rtt min/avg/max/mdev = 123.954/124.423/126.708/0.675 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is more affected by the high ping before VPS, which is approximately 61.5 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, the speed has increased significantly. </font><font style="vertical-align: inherit;">So, in an apartment with a router-server, I have an Internet connection speed of 30 Mbps, and in other apartments - 5 Mbps. </font><font style="vertical-align: inherit;">At the same time, while using OpenVPN, I was not able to achieve a data transfer speed between networks of more than 3.8 Mb / s according to iperf, while WireGuard ‚Äúpumped‚Äù it to the same 5 Mb / s.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WireGuard Configuration on VPS</font></font></b><div class="spoiler_text"><code>[Interface]<br>
Address = 192.168.30.1/24<br>
ListenPort = 51820<br>
PrivateKey = &lt;___VPS&gt;<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_1_&gt;<br>
AllowedIPs = 192.168.30.2/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_2&gt;<br>
AllowedIPs = 192.168.30.3/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_3&gt;<br>
AllowedIPs = 192.168.30.4/32</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WireGuard configuration on MS (added to / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.2/24'<font></font>
        option private_key '__VPN_1_'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option route_allowed_ips '1'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_'<font></font>
        option listen_port '51821'<font></font>
        list addresses '192.168.31.1/24'<font></font>
        option auto '1'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_2'<font></font>
        list allowed_ips '192.168.31.2'<font></font>
<font></font>
config wireguard_wg1ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
        option public_key '__VPN_2_3'<font></font>
        list allowed_ips '192.168.31.3'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WireGuard configuration on MK2 (added to / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.3/24'<font></font>
        option private_key '__VPN_1_2'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_2'<font></font>
        list addresses '192.168.31.2/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WireGuard configuration on MK3 (added to / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.4/24'<font></font>
        option private_key '__VPN_1_3'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_3'<font></font>
        list addresses '192.168.31.3/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the described configurations for the second level VPN, I specify the 51821 port to WireGuard clients. In principle, this is not necessary, as the client will establish a connection from any free unprivileged port, but I made it so that I could block all incoming connections on the wg0 interfaces of all routers, except incoming UDP connections to port 51821. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope this article is useful to someone. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Also, I want to share my script that sends me a PUSH notification on the phone to the WirePusher application when a new device appears on my network. </font><font style="vertical-align: inherit;">Here is the link to the script: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/r0ck3r/device_discover</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPDATE:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuring OpenVPN Server and Clients</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN server</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client-to-client<font></font>
<font></font>
ca /etc/openvpn/server/ca.crt<font></font>
cert /etc/openvpn/server/vpn-server.crt<font></font>
dh /etc/openvpn/server/dh.pem<font></font>
key /etc/openvpn/server/vpn-server.key<font></font>
<font></font>
dev tap<font></font>
ifconfig-pool-persist /etc/openvpn/ipp.txt 0<font></font>
keepalive 10 60<font></font>
proto tcp4<font></font>
server-bridge 192.168.10.1 255.255.255.0 192.168.10.80 192.168.10.254<font></font>
status /var/log/openvpn-status.log<font></font>
verb 3<font></font>
comp-lzo</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN client</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client<font></font>
tls-client<font></font>
dev tap<font></font>
proto tcp<font></font>
remote VPS_IP 1194 # Change to your router's External IP<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
<font></font>
ca client/ca.crt<font></font>
cert client/client.crt<font></font>
key client/client.key<font></font>
dh client/dh.pem<font></font>
<font></font>
comp-lzo<font></font>
persist-tun<font></font>
persist-key<font></font>
verb 3</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To generate certificates used easy-rsa</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486844/index.html">The evolution of Facebook webhook processing: from zero to 25,000 per second</a></li>
<li><a href="../en486850/index.html">New reserved seat - like a capsule hotel</a></li>
<li><a href="../en486858/index.html">Creating a full-fledged Viberbot. Part two - first contact or "conversion_started"</a></li>
<li><a href="../en486860/index.html">ATX12VO - Eating a New Way</a></li>
<li><a href="../en486862/index.html">5 reasons why motion design helps you connect with people</a></li>
<li><a href="../en486866/index.html">Synchronous Fuete: Biological Motors in Nanotechnology</a></li>
<li><a href="../en486868/index.html">Why and for whom we do Slime Agile</a></li>
<li><a href="../en486870/index.html">How we took fraud out of the hut</a></li>
<li><a href="../en486872/index.html">Linux Keyboard setup</a></li>
<li><a href="../en486874/index.html">Coronavirus 2019-nCoV: low mortality, high mortality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>