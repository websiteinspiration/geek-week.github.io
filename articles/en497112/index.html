<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍💻 🍠 👀 CI / CD Process Update: octopus deploy 🛌🏼 👨‍🎤 🎰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The third part of the article is about updating CI / CD processes.  
 
 At this stage, we have (at least should have) an understanding of how CI will ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CI / CD Process Update: octopus deploy</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497112/"><img src="https://habrastorage.org/webt/ll/fr/wq/llfrwqyrix6tk6l50b5sk86rqtm.png" alt="image" align="left" width="300"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The third part of the article is about updating CI / CD processes.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, we have (at least should have) an understanding of how CI will work, what we have at the input, how to get the result from it, and what needs to be done so that the build output becomes a full-fledged project module and gets started. As well as an established octopus (preferably LTS). In the last part, the process of setting up teamcity was considered: everything that happens from the moment when the code gets into the repository and until the ready archive can be unpacked, and in theory, it should work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I remind the table of contents: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 1: what is, why it is not like, planning, a little bash.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I would call this part near-technical. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 2: teamcity. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 3: octopus deploy.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Part 4: behind the scenes. </font><font style="vertical-align: inherit;">Unpleasant moments, plans for the future, possibly FAQ. </font><font style="vertical-align: inherit;">Most likely, it can also be called near-technical.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Octopus: General</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the input, we have the code, at the output, assembly artifacts, everything is clear here. </font><font style="vertical-align: inherit;">But the result for each module consists of two parts: a core package (the result of the build itself), and an individual package (unique configurations and libraries). </font><font style="vertical-align: inherit;">So, in order for a particular module to work, we need something like the following:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An instance in IIS that has its own pool and that "looks" in document root. </font><font style="vertical-align: inherit;">A separate pool is allocated for each module.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Core package files in document root.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Individual package files in document root.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is advisable to backup the old contents of document root in front of all this. </font><font style="vertical-align: inherit;">We, of course, are confident in ourselves, but people are divided into two types: those who do not backup, and those who </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">already</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do.&nbsp;</font></font></li>
<li>  ( )       ( ).    ,     ,   .</li>
<li>   ,    ,    .</li>
<li>   ,   .</li>
<li>    ()    .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not that much, but not enough. </font><font style="vertical-align: inherit;">There are no problems with step 1. </font><font style="vertical-align: inherit;">Octopus has a Deploy to IIS template, it has everything you need. </font><font style="vertical-align: inherit;">At steps 2 and 3 we will dwell in more detail below. </font><font style="vertical-align: inherit;">For step 4, a prompted variable is sufficient, which we will pass from teamcity. </font><font style="vertical-align: inherit;">Step 5 is a powershell script. </font><font style="vertical-align: inherit;">He will also rotate backups. </font><font style="vertical-align: inherit;">Why do we need to store them all, the old ones can be removed. </font><font style="vertical-align: inherit;">Step 6 is also powershell. </font><font style="vertical-align: inherit;">Step 7 - the finished Slack - Detailed Notification template. </font><font style="vertical-align: inherit;">Step 8 - again powershell. </font><font style="vertical-align: inherit;">It sounds like a plan, so we will implement it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenants</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A little more details about steps 2 and 3. I assume that the reader is familiar with octopus deploy. If not - there are wonderful (and only) articles right there on the hub They can give a basic understanding. Here they are: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">second</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . So, we have tabs of projects, infrastructure, tenants, libraries, current tasks and settings. Necessary - tenants. The literal translation of the word tenant is tenant. In this context, most likely the customer, the client, was meant. Oktopus tells us that tenants allow you to deploy different instances of a project at once for many clients (tenants). This is the page with their list.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gf/u-/xr/gfu-xrcwm5ehwz023dggr3e-vhs.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, tenants are used a little differently. Each tenant represents an individual client. For the tenant there is the opportunity to add projects that will be launched when it is deployed. There will accordingly be a core project and an individual project. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two tags for each tenant: TenantRole - common for everyone, indicating that a module of a specific type (core) is deployed to all tenants with this tag, and ModName is a tag matching the module name (individual).&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k5/iu/0f/k5iu0fknzckzncis11o2y0xmkd4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last octopus is received from timcity as a parameter, thus identifying the module that is currently </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deployed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Deploy.Env and Deploy.2</font></a><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see from the screen, when deploying a module for a specific organization, the core project will start first ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deploy.2 teamcity step</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), then an individual project ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">steps deploy.3 and deploy.4 teamcity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Each tenant has access to the variables of all projects that are included in it, as well as to the variables of the tenant itself (collected in a variable set, and contain the ModName tag). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sk/zs/3c/skzs3cxhjryge9jcrvu8alp2skg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;The tenant for the deployment is selected in the team as follows:&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tenantRoleTag variable - contains TenantRole (tenant tag name in octopus), and its actual value;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.modName - The value of the ModName tag in octopus.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Variables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Variables are an important part of the project, and they need to be structured correctly. </font><font style="vertical-align: inherit;">In this project, the octopus variables are divided into three types: common for all projects (collected in the Library set “Environment”), individual for each project (configured directly in the project), and variables directly from tenants (also a library set). </font><font style="vertical-align: inherit;">In the Environment, as already mentioned, everything common for all projects, in particular:&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base paths to document root (for example, C: \ inetpub \);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base URL (for example, for all modules the common domain is organization.com);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">access to databases (needed to organize backups);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etc.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A huge plus is that in the octopus for each environment there may be a variable value. The separation can be anything. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/59/qx/ag/59qxag_xyk4vlnmqwxgc9tphyuu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, lines 3, 6 and 7 on the screen. Line 3 is a common case. Everything that needs to be deployed to the production environment gets here. Lines 6 and 7 describe quite specific cases, for example: the production environment with the role “CompanyWebsite” (line 6), and the production environment with the tenant tag “orgznizationX”. This is necessary to identify the servers on which the package will get, because for organizationX, for example, a separate server is allocated.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The variables for the project include everything else. </font><font style="vertical-align: inherit;">Something that is not common and differs for different environments, for example, the fully qualified domain name of the module. </font><font style="vertical-align: inherit;">In general, it is compiled as # {Tenant.ModName}. # {BaseModuleDomain}, however, it may be different in some cases. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/19/cx/ne19cx7wbn5t0k8rctfcc53-ocq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
&nbsp;Just such a case is presented in the picture.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Channels</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Still worth talking about the channels. </font><font style="vertical-align: inherit;">Briefly and quickly - channels allow you to set the deployment logic. </font><font style="vertical-align: inherit;">Very straightforward, this is described in the official documentation, in particular </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">For example, a release with only the stable tag can get into the production channel, etc. </font><font style="vertical-align: inherit;">There are 4 channels in the project that coincide with the environments (development, test, staging, production). </font><font style="vertical-align: inherit;">Releases fall into them according to pre-release tags. </font><font style="vertical-align: inherit;">It is indicated in the build number format teamcity ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.General</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> settings of the part about teamcity). </font><font style="vertical-align: inherit;">From teamcity, the channel is transferred in step </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the additional command line arguments field (--channel parameter).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patterns</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have not yet appreciated all the advantages of using templates while reading an article about teamcity, now is the time. It is advisable to template custom steps that are common enough, because if there is a need to make edits, you will have to remember in which places this step is applied, click on each similar place and make edits as many times as the uses for this step. In this project, templates were created to check the site’s health and to send a list of domains back to teamcity. Briefly consider the process of creating a template. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a powershell script that needs to be run every time after the deployment of any module.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$url</span> = <span class="hljs-string">"<span class="hljs-variable">$scheme</span>"</span> + <span class="hljs-string">"://"</span> + <span class="hljs-string">"<span class="hljs-variable">$domain</span>"</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Requesting '<span class="hljs-variable">$url</span>'"</span>
[<span class="hljs-type">Net.ServicePointManager</span>]::SecurityProtocol = [<span class="hljs-type">Net.SecurityProtocolType</span>]::Tls12
<span class="hljs-variable">$request</span> = [<span class="hljs-type">System.Net.WebRequest</span>]::Create(<span class="hljs-variable">$url</span>)
<span class="hljs-variable">$request</span>.Timeout = <span class="hljs-variable">$timeout</span>
<span class="hljs-variable">$response</span> = <span class="hljs-variable">$request</span>.GetResponse()
<span class="hljs-variable">$response</span>.Close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The script accepts the input scheme, domain and timeout after which we believe that the site is not operational. </font><font style="vertical-align: inherit;">You can create a template in Library - Step templates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enter a name, choose a logo. </font><font style="vertical-align: inherit;">Next, configure the input parameters and their default values. </font><font style="vertical-align: inherit;">The default value may also be the value of the specified variable (the value of the variable # {HostName} is the default value of the input parameter # {Domain}). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sm/1b/hd/sm1bhd7tlanxkhokj5ykkwndnqy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we modify the script a little, and add it as a step to execution: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/an/ae/jo/anaejohklygki3oeyvzdf9wzwf8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Done. </font><font style="vertical-align: inherit;">At the output, we get a step template that is pleasant to work with, and also, in the absence of our work, colleagues will be able to figure out the field values ​​without reading the obscure scripts.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zn/wh/cb/znwhcbju96vpkpnojnkahezaink.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Octopus: process details</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All projects are divided into groups, the description will be carried out on the example of the Modules group. </font><font style="vertical-align: inherit;">It contains the following projects:&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">core;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">individual module projects.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the core project. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the overview page: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/h1/ej/l8/h1ejl8qvrwpp86te_6pls3nkkwi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you can clearly see which versions of the kernel where they got. </font><font style="vertical-align: inherit;">I apologize for the confusion in the version numbers, now we are switching to versioning tied to the git tag, and everywhere except production we already use the new versioning. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, for some tenants there are no defined environments. </font><font style="vertical-align: inherit;">They are either not yet created or not foreseen.&nbsp;</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deployment process core</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the stage of kernel delivery, part of the service operations are also performed, namely the backup of the database (if necessary), backup of the previous version of the files, rotation of backups and the kernel deployment.&nbsp;</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mq/xe/jn/mqxejndhfnxbgb80o5bvfery-ls.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Step 1: backup the database. </font><font style="vertical-align: inherit;">It is optional, and is based on the value of the variable parameter that is passed from teamcity in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> step. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">2</font></a><font style="vertical-align: inherit;"> to the additional command line arguments field. </font><font style="vertical-align: inherit;">By default, this variable is set to false, since the backup of the database should be done only on demand, and not constantly. </font><font style="vertical-align: inherit;">In team city, starting with changing this parameter looks like this (you need to click on the ellipsis next to the run button): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ru/48/s3/ru48s3ycp-wc53-ikai6vjwzqy0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In octopus, it looks like this:&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ec/ua/xo/ecuaxoycij2hzotqmux4sjjrcmw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, nothing unusual. </font><font style="vertical-align: inherit;">A backup copy of files in zip (by template), backup rotation (the script will be a bit lower), and a kernel deployment by template.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What you should pay attention to:&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all significant parameters are set by variables, this allows you to quickly change their value in one place without digging deep into the process settings;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the IIS pool name matches the instance name and the service domain name (for convenience);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the deploy IIS step, Merge with existing bindings is installed, instead of replacing. </font><font style="vertical-align: inherit;">Since in addition to the service one, we still have a bunch of client domains at each instance;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cleaning up document root (checkmark purge this directory before installation) fails. </font><font style="vertical-align: inherit;">New files replace old ones as you copy. </font><font style="vertical-align: inherit;">This is done so that the site does not “crash” during the deployment. </font><font style="vertical-align: inherit;">The delay in loading the page is much nicer than the death screen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Backup rotation script:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$days</span> = <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"DaysStoreBackups"</span>]
<span class="hljs-variable">$limit</span> = (<span class="hljs-built_in">Get-Date</span>).AddDays(-<span class="hljs-variable">$days</span>)
<span class="hljs-variable">$pathDb</span> = <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"DbBackupDir"</span>]
<span class="hljs-variable">$pathFiles</span> = <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"FilesBackupDir"</span>] + <span class="hljs-string">'\'</span> + <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"HostName"</span>]<font></font>
<font></font>
<span class="hljs-comment"># Delete files older than the $limit.</span>
<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$pathDb</span> <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { !<span class="hljs-variable">$_</span>.PSIsContainer <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.CreationTime <span class="hljs-operator">-lt</span> <span class="hljs-variable">$limit</span> } | <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Force</span>
<span class="hljs-comment"># Delete any empty directories left behind after deleting the old files.</span>
<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$pathDb</span> <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span>.PSIsContainer <span class="hljs-operator">-and</span> (<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$_</span>.FullName <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { !<span class="hljs-variable">$_</span>.PSIsContainer }) <span class="hljs-operator">-eq</span> <span class="hljs-variable">$null</span> } | <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-Recurse</span><font></font>
<font></font>
<span class="hljs-comment"># Delete files older than the $limit.</span>
<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$pathFiles</span> <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { !<span class="hljs-variable">$_</span>.PSIsContainer <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.CreationTime <span class="hljs-operator">-lt</span> <span class="hljs-variable">$limit</span> } | <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Force</span>
<span class="hljs-comment"># Delete any empty directories left behind after deleting the old files.</span>
<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$pathFiles</span> <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span>.PSIsContainer <span class="hljs-operator">-and</span> (<span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$_</span>.FullName <span class="hljs-literal">-Recurse</span> <span class="hljs-literal">-Force</span> | <span class="hljs-built_in">Where-Object</span> { !<span class="hljs-variable">$_</span>.PSIsContainer }) <span class="hljs-operator">-eq</span> <span class="hljs-variable">$null</span> } | <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-Recurse</span>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The deployment process of an individual package</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the stage of delivery of an individual module package, the configs and unique libraries are deployed, the files are located and / or renamed, the site is requested (firstly, sites on .net are loaded for the first time for a long time, this step allows you to perform this procedure immediately, and secondly it allows you to understand whether there are any errors when loading the site). </font><font style="vertical-align: inherit;">A notification is also sent to slack, and an actual list of all domains belonging to this module is transferred to teamcity.&nbsp;</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zh/vk/pr/zhvkprmelbx8edaxft0imsokmja.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the important:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the deploy step, document root is not cleaned up (the new core package is already there);</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Step 3, the script. </font><font style="vertical-align: inherit;">It was a little higher in the description of the templates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Step 5. It is also associated with the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deploy.4</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> step </font><font style="vertical-align: inherit;">in teamcity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In octopus, it looks like this:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$baseDomain</span> = <span class="hljs-variable">$OctopusParameters</span>[<span class="hljs-string">"HostName"</span>]
<span class="hljs-variable">$domains</span> = (<span class="hljs-built_in">Get-WebBinding</span> <span class="hljs-variable">$baseDomain</span>).bindingInformation | %{ <span class="hljs-variable">$_</span>.Split(<span class="hljs-string">':'</span>)[<span class="hljs-number">2</span>] } | <span class="hljs-built_in">Sort-Object</span> | <span class="hljs-built_in">Get-Unique</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"##teamcity[setParameter name='AllInstanceDomains' value='<span class="hljs-variable">$domains</span>']"</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"##teamcity[setParameter name='ServiceDomain' value='<span class="hljs-variable">$baseDomain</span>']"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The syntax </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">## teamcity ...</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows you to set the build parameter in teamcity. </font><font style="vertical-align: inherit;">Actually, in it, this step looks like this:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"All domains on instance %ServiceDomain% :"</span>
<span class="hljs-variable">$domains</span> = <span class="hljs-string">"%AllInstanceDomains%"</span>
<span class="hljs-variable">$domains</span> = <span class="hljs-variable">$</span>(<span class="hljs-variable">$domains</span>.Split(<span class="hljs-string">" "</span>) | <span class="hljs-built_in">ForEach-Object</span> {<span class="hljs-string">"http://<span class="hljs-variable">$_</span>"</span>} | <span class="hljs-built_in">Out-String</span>)
<span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$domains</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Service domain: http://%ServiceDomain%"</span>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Octopus: results</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The whole build process is as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code is collected from a specific branch (corresponding to the environment);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the result of the assembly (artifacts) is given to the octopus and consists of two parts: the kernel and an individual module package. </font><font style="vertical-align: inherit;">This allows for efficient use of disk space and saves overall update delivery time.&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each package has a version consisting of a number and a pre-release tag that defines the channel and the environment in which this release will fall.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Octopus, by input, creates a release and delivers packets to the appropriate servers, guided by the organization data (tenant tags), channels (pre-release tag) and additional instructions (optional backup of the database), and also makes an elementary check of the module’s performance.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's kind of like that. </font><font style="vertical-align: inherit;">Most likely, there will be another near-technical article, so to speak, behind the scenes. </font><font style="vertical-align: inherit;">It will include everything that did not enter here: some details, what became new in the process of work and what you may have to face for those who decide on this, corrections and updates on the project, perhaps frequent questions / answers. </font><font style="vertical-align: inherit;">Thank you for the attention.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497098/index.html">How we made the autopilot for the combine harvester on video analytics the first in the world</a></li>
<li><a href="../en497100/index.html">Launch Jupyter into orbit LXD</a></li>
<li><a href="../en497106/index.html">Network simulator tutorial ns-3. Chapters 1.2</a></li>
<li><a href="../en497108/index.html">Fighting Covid-2019: The Great Turn comes</a></li>
<li><a href="../en497110/index.html">Do I need voice acting for video clips about games?</a></li>
<li><a href="../en497114/index.html">It's time to landfill</a></li>
<li><a href="../en497116/index.html">Starsky Robotics unmanned trucks come to an end</a></li>
<li><a href="../en497118/index.html">[Forecast] Will all unmanned trucks come to an end or only Starsky Robotics?</a></li>
<li><a href="../en497126/index.html">Backlog scoring and prioritization techniques</a></li>
<li><a href="../en497132/index.html">#SaveFirst Initiative to Support Socially Important Projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>