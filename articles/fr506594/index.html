<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëáüèæ üèΩ ‚õ¥Ô∏è Redis Best Practices, Partie 3 üö¥üèª üë∂üèΩ ‚è≠Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Traduction finale des sections Redis Best Practices du site officiel de Redis Labs. Le plus insolite et int√©ressant aujourd'hui sous la coupe!
 
 
 La...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Redis Best Practices, Partie 3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506594/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduction finale des sections </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis Best Practices</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> du site officiel de Redis Labs. </font><font style="vertical-align: inherit;">Le plus insolite et int√©ressant aujourd'hui sous la coupe!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hr/6y/f5/hr6yf5w1hp0fh-i5vfa0p1pxeuy.png" width="15%"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re partie est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le second est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article contient les rubriques suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©quences temporelles sur des ensembles tri√©s;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©quences temporelles sur des ensembles tri√©s lexicographiquement;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©quences temporelles sur les champs de bits;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mod√®le de base de limitation de la bande passante;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filtre de floraison;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compteur;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mod√®le de comptage de bits;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyperLogLog;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts Lua.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Donn√©es de s√©quence temporelle</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les donn√©es de s√©quence temporelle, ou les donn√©es avec un ordre temporel naturel, peuvent √™tre mod√©lis√©es dans Redis de plusieurs mani√®res, selon les donn√©es elles-m√™mes et la mani√®re dont vous souhaitez y acc√©der. </font><font style="vertical-align: inherit;">Nous allons examiner quelques-uns de ces mod√®les:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©quences temporelles sur des ensembles tri√©s;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©quences temporelles sur des ensembles tri√©s lexicographiquement;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©quences temporelles sur les champs de bits;</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©quences temporelles sur des ensembles tri√©s</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les s√©quences temporelles sur des ensembles tri√©s (zsets) sont un moyen typique de mod√©liser une s√©quence temporelle dans Redis. </font><font style="vertical-align: inherit;">Les ensembles tri√©s sont constitu√©s d'objets uniques dont les partitions sont stock√©es sous une seule cl√©. </font><font style="vertical-align: inherit;">L'utilisation de ce type de donn√©es pour des ensembles tri√©s signifie que le comptage se comporte comme une sorte d'indicateur de temps (souvent c'est un horodatage pr√©cis √† la milliseconde), et l'√©l√©ment est des donn√©es enregistr√©es. </font><font style="vertical-align: inherit;">Le seul avantage est que puisqu'il s'agit d'une forme d'ensemble, seuls les √©l√©ments uniques sont autoris√©s, et essayer d'enregistrer des s√©quences de temps avec les m√™mes valeurs ne fera que rafra√Æchir la partition. </font><font style="vertical-align: inherit;">Pour illustrer ce probl√®me, nous prenons l'exemple suivant d'enregistrement p√©riodique de la temp√©rature:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Horodatage</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temp√©rature, C</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1586697976001</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1586697977001</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1586697978001</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous les ajoutez simplement √† l'ensemble tri√© √† l'aide de ZADD, vous risquez de perdre certaines valeurs: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ANTI-PATTERN</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZADD temperature 1586697976001 21<font></font>
(integer) 1<font></font>
&gt; ZADD temperature 1586697977001 22<font></font>
(integer) 1<font></font>
&gt; ZADD temperature 1586697978001 21<font></font>
(integer) 0<font></font>
&gt; ZRANGEBYSCORE temperature -inf +inf WITHSCORES<font></font>
1) "22"<font></font>
2) "1586697977001"<font></font>
3) "21"<font></font>
4) "1586697978001"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que le troisi√®me appel √† ZADD renvoie 0, ce qui indique que le nouvel √©l√©ment n'a pas √©t√© ajout√© √† l'ensemble. Ensuite, dans ZRANGEBYSCORE, nous voyons qu'il n'y a que deux enregistrements dans l'ensemble tri√©. Pourquoi? Parce que le premier et le troisi√®me partagent le m√™me objet, et nous venons de mettre √† jour le compte de cet objet. Il existe plusieurs fa√ßons de contourner ce probl√®me. L'un d'eux consiste √† inclure des donn√©es al√©atoires avec une variation suffisante, garantissant ainsi l'unicit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, cr√©ez un nombre r√©el pseudo-al√©atoire de 0 √† 1, inclus, puis ajoutez-le √† notre horodatage. Dans notre exemple, nous le laisserons sous forme d√©cimale pour plus de lisibilit√© (en r√©alit√©, il serait plus sage de simplement convertir en une cha√Æne de 8 octets pour √©conomiser de l'espace).</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZADD temperature2 1586697976001 21:1586697976001.2583<font></font>
(integer) 1<font></font>
&gt; ZADD temperature2 1586697977001 22:1586697977001.941678<font></font>
(integer) 1<font></font>
&gt; ZADD temperature2 1586697978001 21:1586697978001.732015<font></font>
(integer) 1<font></font>
&gt; ZRANGEBYSCORE temperature2 -inf +inf WITHSCORES<font></font>
1) "21:1586697976001.2583"<font></font>
2) "1511533205001"<font></font>
3) "22:1586697977001.941678"<font></font>
4) "1586697977001"<font></font>
5) "21:1586697978001.732015"<font></font>
6) "1586697978001"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, tous les ZADD ont renvoy√© 1, indiquant un ajout r√©ussi, et ZRANGEBYSCORE a renvoy√© toutes les valeurs. </font><font style="vertical-align: inherit;">Il s'agit d'une m√©thode de travail, cependant, elle n'est pas tr√®s efficace en raison du gaspillage d'octets pour garantir l'unicit√©, ce qui ajoute une surcharge au stockage. </font><font style="vertical-align: inherit;">Dans la plupart des cas, l'unicit√© sera simplement balay√©e par votre application. </font><font style="vertical-align: inherit;">Il convient de noter que l'ajout d'unicit√© n'est pas n√©cessaire si vos donn√©es sont d√©j√† uniques (par exemple, les donn√©es, y compris les UUID). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cette m√©thode, vous avez acc√®s √† toutes les m√©thodes d'ensembles tri√©s pour l'analyse et le contr√¥le:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZRANGEBYSCORE vous permet d'obtenir une tranche sp√©cifique entre deux horodatages (ZREVRANGEBYSCORE renverra la tranche dans l'ordre d√©croissant);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZREMRANGEBYSCORE vous permet de supprimer une plage sp√©cifique d'horodatages;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZCOUNT - le nombre d'√©l√©ments entre la plage d'horodatage;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZINTERSTORE - vous permet d'obtenir l'intersection de deux donn√©es et de l'enregistrer sous une nouvelle cl√©;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZUNIONSTORE - vous permet d'obtenir l'union de deux donn√©es et de l'enregistrer sous une nouvelle cl√©. </font><font style="vertical-align: inherit;">Vous pouvez √©galement l'utiliser pour dupliquer un ensemble tri√©.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Op√©rations ZINTERSTORE et ZUNIONSTORE qui fonctionnent avec plusieurs cl√©s. </font><font style="vertical-align: inherit;">Lorsque vous travaillez avec un environnement partag√©, vous devez faire attention √† v√©rifier que votre nouvelle cl√© se trouve dans le m√™me segment, sinon ces commandes entra√Æneront une erreur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©quences temporelles sur des ensembles tri√©s lexicographiquement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre fa√ßon de travailler avec des s√©quences temporelles consiste √† utiliser les propri√©t√©s lexicographiques des ensembles tri√©s pour stocker un horodatage et une valeur. Si vous n'√™tes pas d√©j√† familier avec cela, alors il est temps de lire </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cette section</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cette m√©thode, nous stockons tout avec le m√™me nombre et encodons d'abord l'horodatage, puis ajoutons la valeur en tant qu'√©l√©ment. Prenons un exemple:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZADD lex-temperature 0 1589392163001:21<font></font>
(integer) 1<font></font>
&gt; ZADD lex-temperature 0 1589392164001:22<font></font>
(integer) 1<font></font>
&gt; ZADD lex-temperature 0 1589392165001:21<font></font>
(integer) 1<font></font>
&gt; ZRANGE lex-temperature 0 -1<font></font>
1) "1589392163001:21"<font></font>
2) "1589392164001:22"<font></font>
3) "1589392165001:21"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ces trois appels ZADD, l'horodatage est s√©par√© de la valeur par deux points, et nous pouvons voir que 1 est retourn√© √† chaque fois, ce qui signifie que les trois ont √©t√© ajout√©s. Dans ZRANGE, nous voyons la commande enregistr√©e. Pourquoi? Dans les ensembles tri√©s, si le score est le m√™me, les r√©sultats avec le m√™me score sont class√©s par tri binaire. √âtant donn√© que les horodatages de cette p√©riode ont le m√™me nombre de chiffres, tout sera tri√© correctement (si vos horodatages sont avant 2002 ou apr√®s 2285, vous aurez besoin de plus de chiffres pour les remplir). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir une plage de valeurs de ce type, utilisez la commande ZRANGEBYLEX:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZRANGEBYLEX lex-temperature (1511533200001 +<font></font>
1) "1589392163001:21"<font></font>
2) "1589392164001:22"<font></font>
3) "1589392165001:21"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxi√®me argument a un pr√©fixe (indiquant l'exclusivit√© de la valeur (l'inclusivit√© est not√©e par [). En pratique, ce format rend l'inclusivit√© et l'exclusivit√© non pertinentes, car l'horodatage sera toujours suivi de donn√©es suppl√©mentaires. Le troisi√®me argument + indique le caract√®re illimit√© de la limite sup√©rieure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayez d'obtenir la date entre 1589392160001 et 1589392165001 inclus:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZRANGEBYLEX lex-temperature [1589392160001 [1589392165001<font></font>
1) "1589392163001:21"<font></font>
2) "1589392164001:22"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi les donn√©es d'horodatage 1589392165001 ne sont-elles pas entr√©es dans l'√©chantillon, malgr√© le pr√©fixe inclus? </font><font style="vertical-align: inherit;">Je veux croire que Redis comprend en quelque sorte qu'il s'agit d'un horodatage. </font><font style="vertical-align: inherit;">En fait, Redis ne voit que le tri binaire. </font><font style="vertical-align: inherit;">Dans le tri binaire, 1589392165001: 21 est sup√©rieur √† 1589392165001 inclus ou exclusif. </font><font style="vertical-align: inherit;">La bonne fa√ßon d'inclure cela dans la limite sup√©rieure consiste √† ajouter 1 milliseconde √† la limite sup√©rieure souhait√©e et √† utiliser l'exclusivit√©:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; ZRANGEBYLEX lex-temperature [1589392160001 (1589392165002<font></font>
1) "1589392163001:21"<font></font>
2) "1589392164001:22"<font></font>
3) "1589392165001:21"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les s√©quences temporaires avec des ensembles tri√©s lexicographiquement ont un ensemble similaire de commandes utiles, comme les s√©quences temporaires avec des ensembles simplement tri√©s:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZRANGEBYLEX / ZREVRANGEBYLEX - Obtient une plage de valeurs dans l'ordre croissant ou d√©croissant;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZREMRANGEBYLEX - supprime une plage de valeurs tri√©e sp√©cifique;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZLEXCOUNT - Obtient le nombre d'√©l√©ments dans une plage de valeurs tri√©e.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZINTERSTORE et ZUNIONSTORE peuvent √™tre utilis√©s sur des ensembles tri√©s lexicographiquement, mais il existe un risque de perte de donn√©es, car les combinaisons en double d'horodatages et de valeurs ne seront pas dupliqu√©es dans le r√©sultat renvoy√©. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous vous demandez peut-√™tre pourquoi choisir des ensembles tri√©s avec des horodatages au lieu de coder des ensembles tri√©s lexicographiquement. </font><font style="vertical-align: inherit;">En r√®gle g√©n√©rale, il est pr√©f√©rable de travailler avec des ensembles tri√©s lexicographiquement pour les s√©quences temporelles - si les valeurs ne sont pas toujours uniques, les horodatages seront plus efficaces.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©quences temporelles de champ de bits</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis peut stocker efficacement des s√©quences temporelles dans des champs de bits. </font><font style="vertical-align: inherit;">Pour ce faire, vous devez d'abord s√©lectionner un point de r√©f√©rence arbitraire et un format num√©rique. </font><font style="vertical-align: inherit;">Prenez l'exemple de mesure de la temp√©rature. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous voulons prendre la temp√©rature toutes les minutes, et nous fixerons le point de d√©part pour minuit chaque jour. </font><font style="vertical-align: inherit;">Nous mesurons la temp√©rature ambiante en degr√©s Celsius. </font><font style="vertical-align: inherit;">Vous pouvez structurer les donn√©es comme suit:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 minute = octet 0;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la temp√©rature est √©crite dans un nombre non sign√© de 8 bits (0-255).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une journ√©e, les donn√©es sont tap√©es √† environ 1,44 ko. </font><font style="vertical-align: inherit;">Vous pouvez enregistrer la temp√©rature avec la commande BITFIELD:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts SET u8 #0 22<font></font>
1) (integer) 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, √† l'aide de la touche bit-ts, la valeur de temp√©rature 22 est √©crite sur le nombre non sign√© 8 bits (u8) √† minuit (# 0). Les </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
champs de bits ne sont pas limit√©s aux valeurs non sign√©es 8 bits. </font><font style="vertical-align: inherit;">Faites attention au signe de la livre avant le d√©calage. </font><font style="vertical-align: inherit;">Cela signifie que l'alignement se produira sur le type s√©lectionn√©. </font><font style="vertical-align: inherit;">Par exemple, si vous sp√©cifiez "# 79" - cela signifiera le 79e octet, "79" - le 79e bit (voir l'aide de BITFIELD). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le d√©calage peut √™tre align√© par le type du num√©ro stock√©, √† partir de 0. Par exemple, si nous voulons √©crire 1 heure du matin, en consid√©rant les cr√©neaux z√©ro, nous utilisons le d√©calage # 59 ou le d√©calage # 719 pour midi.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts SET u8 #59 23 SET u8 #719 25<font></font>
1) (integer) 0<font></font>
2) (integer) 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple montre √©galement que BITFIELD est variable, c'est-√†-dire </font><font style="vertical-align: inherit;">Vous pouvez travailler avec plusieurs valeurs en un seul appel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez quelques valeurs suppl√©mentaires:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts SET u8 #60 21 SET u8 #61 20<font></font>
1) (integer) 0<font></font>
2) (integer) 0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous allons extraire:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts GET u8 #59 GET u8 #60 GET u8 #61<font></font>
1) (integer) 23<font></font>
2) (integer) 21<font></font>
3) (integer) 20</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La signature de la sous-commande GET bit est similaire √† la signature SET, √† la seule diff√©rence qu'elle n'accepte pas de valeur comme troisi√®me argument. </font><font style="vertical-align: inherit;">C'est normal lorsque nous connaissons tous les indices que nous devons obtenir, mais parfois nous avons besoin d'une plage de valeurs, et chaque octet individuellement sera trop stressant. </font><font style="vertical-align: inherit;">Nous pouvons utiliser la commande GETRANGE. </font><font style="vertical-align: inherit;">Dans une situation normale, il est utilis√© pour obtenir des octets d'une cha√Æne, mais les BITFIELD ne sont qu'un autre moyen d'adresser les m√™mes donn√©es.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; GETRANGE bit-ts 59 61<font></font>
"\x17\x15\x14"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La commande a renvoy√© les octets 59 √† 61 en hexad√©cimal (23, 21 et 20 en d√©cimal. Les langages clients g√®rent mieux les donn√©es binaires que redis-cli et peuvent g√©n√©ralement obtenir un tableau d'octets sp√©cifique √† la langue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre exemple, nous avons utilis√© les octets 0 , 59-61 et 719. Que se passe-t-il si nous demandons des octets qui n'ont pas encore √©t√© d√©finis?</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITFIELD bit-ts GET u8 #40<font></font>
1) (integer) 0<font></font>
&gt; BITFIELD bit-ts GET u8 #750<font></font>
1) (integer) 0<font></font>
&gt; GETRANGE bit-ts 30 50<font></font>
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis renvoie 0 octets non sp√©cifi√©s. Cela peut entra√Æner des difficult√©s lorsque vous travaillez avec des donn√©es de s√©quence temporelle - la logique d'application doit faire la distinction entre 0 et une valeur non d√©finie. </font><font style="vertical-align: inherit;">L'arrondi et l'omission de valeurs 0 sont possibles, en particulier lors de l'utilisation d'entiers sign√©s, car il peut s'agir d'une valeur valide au milieu de votre plage. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La longueur r√©elle de la s√©quence temporelle d√©pend en fait du dernier octet. </font><font style="vertical-align: inherit;">Dans l'exemple, le dernier octet stock√© est 719, la longueur des donn√©es est donc de 720 octets.</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; STRLEN bit-ts<font></font>
(integer) 720</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les s√©quences temporelles bas√©es sur BITFIELD sont un mod√®le puissant et compact pour stocker des donn√©es num√©riques ou binaires. </font><font style="vertical-align: inherit;">Cependant, cette solution ne couvre pas tous les cas d'utilisation et son utilisation doit √™tre soigneusement envisag√©e pour r√©pondre √† vos besoins.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mod√®le de limite de bande passante de base</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La cr√©ation de limiteurs de bande passante avec Redis est facile gr√¢ce aux commandes INCR et EXPIRE. </font><font style="vertical-align: inherit;">L'id√©e est que vous souhaitez limiter les demandes √† un service sp√©cifique pour une p√©riode de temps donn√©e. </font><font style="vertical-align: inherit;">Supposons que nous ayons un service dans lequel les utilisateurs sont identifi√©s par une cl√© API. </font><font style="vertical-align: inherit;">Le service a une limite de 20 demandes par minute. </font><font style="vertical-align: inherit;">Pour impl√©menter cela, nous voulons cr√©er une cl√© Redis sur la cl√© API toutes les minutes. </font><font style="vertical-align: inherit;">Afin de ne pas salir la base de donn√©es, la p√©riode de validit√© de la cl√© est √©galement fix√©e √† 1 minute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cl√© API - zA21X31, en gras - limite atteinte:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis Key</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 1</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 2</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 3</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zA21X31: 4</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Valeur</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vingt</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vingt</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expire dans</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:02</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:03</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:04</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:05</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:06</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:00</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:01</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:02</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:03</font></font></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:04</font></font></b></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La cl√© est compos√©e de la cl√© API et du nombre de minutes √† travers deux points. </font><font style="vertical-align: inherit;">√âtant donn√© que les cl√©s expirent toujours, il nous suffit d'utiliser uniquement les chiffres des minutes - avec le d√©but de la nouvelle heure, nous pouvons √™tre s√ªrs qu'il n'y a pas 59 autres cl√©s (elles ont expir√© il y a 59 minutes). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons voir comment √ßa fonctionne:</font></font><br>
<br>
<ol>
<li><pre><code class="plaintext hljs">&gt; GET [ API]:[ ]</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le r√©sultat est inf√©rieur √† 20 ou non d√©fini, passez √† l'√©tape 4, sinon passez √† l'√©tape 3;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afficher un message d'erreur, fermer la connexion et terminer;</font></font></li>
<li><pre><code class="plaintext hljs">&gt; MULTI<font></font>
OK<font></font>
&gt; INCR [user-api-key]:[current minute number]<font></font>
QUEUED<font></font>
&gt; EXPIRE [user-api-key]:[current minute number] 59<font></font>
QUEUED<font></font>
&gt; EXEC<font></font>
OK</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuez le programme.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux points cl√©s:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INCR sur une cl√© inexistante sera toujours 1;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXPIRE est √† l'int√©rieur de la transaction MULTI avec INCR, ce qui signifie que ce sera une op√©ration atomique.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le pire des cas est que, pour une raison tr√®s √©trange et peu probable, le serveur Redis meure entre INCR et EXPIRE. </font><font style="vertical-align: inherit;">Lors de la restauration de donn√©es √† partir d'AOF ou d'une r√©plique en m√©moire, INCR ne sera pas restaur√© car la transaction n'a pas √©t√© termin√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'utilisation de ce mod√®le, il est possible qu'un utilisateur poss√®de deux cl√©s: l'une actuellement utilis√©e et l'autre qui expire √† cette minute. </font><font style="vertical-align: inherit;">Cependant, le motif est tr√®s efficace.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filtre Bloom</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le filtre Bloom est une structure de donn√©es probabiliste int√©ressante que vous pouvez utiliser pour v√©rifier si un √©l√©ment a √©t√© ajout√© auparavant. Voici le libell√© intentionnellement. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La probabilit√© est qu'il ne peut y avoir qu'un faux positif, mais pas un faux n√©gatif. Le filtre Bloom fournit un moyen beaucoup plus compact et rapide de v√©rifier la disponibilit√© que d'enregistrer tous les √©l√©ments dans un ensemble et d'appeler SISMEMBER.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le filtre Bloom fonctionne en passant un √©l√©ment √† travers la fonction de hachage rapide, en s√©lectionnant des bits de celui-ci et en les d√©finissant sur 1 et 0 √† un certain intervalle dans le champ de bits. Pour v√©rifier la pr√©sence d'un filtre, les m√™mes bits sont s√©lectionn√©s. De nombreux √©l√©ments peuvent avoir des bits qui se chevauchent, mais comme la fonction de hachage cr√©e des identificateurs uniques, si un bit du hachage est toujours √©gal √† 0, alors nous savons qu'il n'a pas √©t√© ajout√© auparavant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis utilise le filtre depuis de nombreuses ann√©es comme biblioth√®que cliente qui utilise GETBIT et SETBIT pour travailler avec les champs de bits. Heureusement, le module ReBloom est disponible √† partir de Redis 4.0, ce qui √©limine le besoin de cr√©er votre propre impl√©mentation du filtre Bloom.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un bon cas d'utilisation de ce filtre consiste √† v√©rifier si le nom d'utilisateur a d√©j√† √©t√© utilis√©. </font><font style="vertical-align: inherit;">Il n'y a aucun probl√®me avec les petites tailles de donn√©es, mais √† mesure que le service se d√©veloppe, les requ√™tes de base de donn√©es peuvent √™tre co√ªteuses. </font><font style="vertical-align: inherit;">C'est facile √† r√©soudre avec ReBloom. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez quelques noms pour le test:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BF.ADD usernames funnyfred<font></font>
(integer) 1<font></font>
&gt; BF.ADD usernames fredisfunny<font></font>
(integer) 1<font></font>
&gt; BF.ADD usernames fred<font></font>
(integer) 1<font></font>
&gt; BF.ADD usernames funfred<font></font>
(integer) 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Testez maintenant le filtre Bloom:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BF.EXISTS usernames fred<font></font>
(integer) 1<font></font>
&gt; BF.EXISTS usernames fred_is_funny<font></font>
(integer) 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme pr√©vu, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fred_is_funny a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoy√© 0. Cela signifie qu'un tel nom n'a pas √©t√© utilis√©. </font><font style="vertical-align: inherit;">Bien qu'il soit impossible de le dire avec certitude, car les bits peuvent simplement se chevaucher entre plusieurs √©l√©ments. </font><font style="vertical-align: inherit;">Fondamentalement, le risque de faux positifs est faible, mais pas √©gal √† 0. Au fur et √† mesure que le filtre Bloom se remplit, le risque augmente, mais vous pouvez ajuster le taux d'erreur et la taille initiale (par d√©faut √† 0,01 et 100, respectivement).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compteur</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un compteur dans Redis peut √™tre impl√©ment√© de plusieurs mani√®res. </font><font style="vertical-align: inherit;">Le plus √©vident est INCR et al (INCRBY, INCRBYFLOAT, HINCRBY, HINCRBYFLOAT, ZINCRBY), qui peuvent √™tre trouv√©s en lisant simplement la documentation. </font><font style="vertical-align: inherit;">L'utilisation de BITCOUNT et PFADD est moins √©vidente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mod√®le de comptage de bits</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BITCOUNT compte le nombre de bits mis √† 1 dans le champ de bits par cl√©. </font><font style="vertical-align: inherit;">Cela peut √™tre utilis√© pour calculer une s√©rie d'activit√©s sur une p√©riode de temps arbitraire (similaire au mod√®le de s√©quences temporelles sur les champs de bits). </font><font style="vertical-align: inherit;">Le processus consiste √† choisir un point dans le temps, et chaque bit repr√©sente une unit√© de p√©riode. </font><font style="vertical-align: inherit;">Chaque fois qu'une action est effectu√©e pendant cette p√©riode, ex√©cutez SETBIT √† une distance de 1 unit√© du dernier point.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:00</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:02</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:03</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12:04</font></font></th>
</tr>
<tr>
<td></td>
<td><pre><code class="plaintext hljs">&gt; SETBIT btct 2 1</code></pre></td>
<td><pre><code class="plaintext hljs">&gt; SETBIT btct 3 1</code></pre></td>
<td><pre><code class="plaintext hljs">&gt; SETBIT btct 4 1</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[point de d√©part]</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acte</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acte</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acte</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour calculer √† quelles minutes de 12 h 00 √† 12 h 30 l'activit√© s'est produite, vous pouvez proc√©der comme suit:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; BITCOUNT btct 0 30<font></font>
(integer) 3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, ce mod√®le r√©pond √† la question ¬´combien de fois?¬ª Plut√¥t que ¬´combien de fois?¬ª. </font><font style="vertical-align: inherit;">Par exemple, un utilisateur peut √™tre actif 20 fois en une minute, mais cela comptera pour 1. Le </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
v√©ritable avantage de ce mod√®le est qu'il fournit le score minimum possible pendant une certaine p√©riode de temps, car les bits sont les √©l√©ments de construction les plus √©l√©mentaires du stockage. </font><font style="vertical-align: inherit;">Il s'agit litt√©ralement du plus petit r√©f√©rentiel (non compress√©) pour le comptage.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyperLogLog</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compter des objets uniques peut √™tre d√©licat. Cela signifie g√©n√©ralement stocker chaque √©l√©ment unique, puis invoquer ces informations d'une mani√®re ou d'une autre. Dans Redis, cela peut √™tre fait en utilisant plusieurs √©quipes, cependant, √† la fois le volume occup√© et la complexit√© temporelle seront tr√®s importants. HyperLogLog fournit une alternative probabiliste. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HyperLogLog est similaire en interne √† un filtre Bloom, il alimente √©galement les √©l√©ments via une fonction de hachage non cryptographique et d√©finit les bits dans un champ de bits. Mais, contrairement au filtre Bloom, HyperLogLog stocke un compteur d'√©l√©ments qui s'incr√©mente lorsqu'un nouvel √©l√©ment est ajout√© qui n'a pas √©t√© ajout√© auparavant. Cela donne un faible taux d'erreur lors du comptage d'√©l√©ments uniques dans un ensemble. HyperLogLog est int√©gr√© directement dans Redis.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe 3 commandes HyperLogLog dans Redis: PFADD, PFCOUNT et PFMERGE. </font><font style="vertical-align: inherit;">Disons que nous cr√©ons un scanner Web et que nous voulons compter le nombre d'URL uniques des pages consult√©es au cours de la journ√©e. </font><font style="vertical-align: inherit;">Pour chaque page, ex√©cutez la commande suivante:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PFADD crawled:20200613 "http://www.google.com/"<font></font>
(integer) 1<font></font>
&gt; PFADD crawled:20200613 "http://www.redislabs.com/"<font></font>
(integer) 1<font></font>
&gt; PFADD crawled:20200613 "http://www.redis.io/"<font></font>
(integer) 1<font></font>
&gt; PFADD crawled:20200614 "http://www.redisearch.io/"<font></font>
(integer) 1<font></font>
&gt; PFADD crawled:20200614 "http://www.redis.io/"<font></font>
(integer) 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque cl√© ci-dessus est index√©e par jour. </font><font style="vertical-align: inherit;">Pour voir combien de pages ont √©t√© consult√©es le 13/06/2020, vous pouvez proc√©der comme suit:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PFCOUNT crawled:20200613<font></font>
(integer) 3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour afficher le nombre de pages pour 13/06/2020 et 14/06/2020, utilisez la commande PFMERGE pour cr√©er une nouvelle cl√© avec une valeur qui combine deux compteurs. </font><font style="vertical-align: inherit;">Veuillez noter que, puisque </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.redis.io</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est stock√© dans les deux ensembles, il sera calcul√© une fois:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; PFMERGE crawled:20200613-14 crawled:20200613 crawled:20200614<font></font>
OK<font></font>
&gt; PFCOUNT crawled:20200613-14<font></font>
(integer) 4</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette op√©ration peut fonctionner avec plusieurs cl√©s, donc soyez prudent dans un environnement divis√©, afin que les cl√©s soient sur le m√™me fragment.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts Lua</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redis peut faire des choses incroyables juste √† partir de "redis-cli" et encore plus entre Redis et votre langage de programmation. Mais parfois, un comportement qui ne peut pas √™tre obtenu dans l'architecture client-serveur en raison de probl√®mes d'efficacit√© ou de s√©curit√© peut √™tre requis - la logique doit √™tre ex√©cut√©e dans la couche de base de donn√©es. Dans de tels cas, Lua vient √† la rescousse. Lua fonctionne dans Redis en tant que langage de script. Avec lui, vous pouvez ex√©cuter du code dans Redis, sans frais de transport vers et depuis le client.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un sc√©nario de test ajoute une valeur √† un champ de hachage. </font><font style="vertical-align: inherit;">Alors que Redis peut facilement ajouter une valeur √† une cl√© de cha√Æne √† l'aide d'APPEND, il n'y a pas de commande pour ajouter une valeur √† un champ de hachage. </font><font style="vertical-align: inherit;">Vous pouvez essayer d'obtenir ceci en extrayant la valeur du client, en ajoutant une nouvelle ligne √† la valeur et en supprimant les champs de hachage, mais c'est une mauvaise id√©e. </font><font style="vertical-align: inherit;">√âtant donn√© que ce n'est pas atomique, il est probable que pendant que vous ajoutez une valeur, un autre client peut la modifier plus t√¥t, puis vous √©craserez la nouvelle valeur.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client 1</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client 2</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><pre><code class="plaintext hljs">&gt; HGET myhash myfield</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[bonjour revient]</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ajoute ¬´monde¬ª √† ¬´bonjour¬ª]</font></font></td>
<td><pre><code class="plaintext hljs">&gt; HSET myhash myfield "goodbye"</code></pre></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><pre><code class="plaintext hljs">&gt; HSET myhash myfield "hello world"</code></pre></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td></td>
<td><pre><code class="plaintext hljs">&gt; HGET myhash myfield</code></pre></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir sur la ligne 2, la mise √† jour sera perdue. </font><font style="vertical-align: inherit;">Vous pouvez utiliser des scripts Lua pour contourner ce probl√®me et supprimer le co√ªt d'envoi / r√©ception de valeurs du client. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un √©diteur de texte, cr√©ez un script et appelez - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">happened.lua</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="lua hljs"><span class="hljs-keyword">local</span> original = redis.call(<span class="hljs-string">'HGET'</span>,KEYS[<span class="hljs-number">1</span>],ARGV[<span class="hljs-number">1</span>])
<span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'HSET'</span>,KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>], original .. ARGV[<span class="hljs-number">2</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la premi√®re ligne, cr√©ez une variable locale d' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">origine</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dans laquelle nous enregistrons la valeur actuelle de la cl√© de hachage √† partir du premier argument pass√©, et le champ est le premier argument non cl√©. Il est important de comprendre que les scripts Lua d'ex√©cution distinguent les arguments cl√©s et non cl√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la deuxi√®me ligne, HSET est appel√© pour la m√™me cl√© et le m√™me champ, puis nous combinons la valeur d'origine avec le deuxi√®me argument non cl√©. Cela revient √† Redis, nous conserverons donc la valeur de retour HSET d'origine.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ex√©cution directe de scripts Lua avec la commande EVAL peut √™tre d√©routante et inefficace. </font><font style="vertical-align: inherit;">Redis dispose d'un cache de script int√©gr√© qui vous permet de pr√©charger le script, puis d'y acc√©der √† l'aide du hachage SHA1 √† partir du script principal. </font><font style="vertical-align: inherit;">Vous pouvez t√©l√©charger ce script √† partir de la ligne de commande en utilisant "cat" et "redis-cli". </font><font style="vertical-align: inherit;">Veuillez noter que si votre script diff√®re d'au moins un caract√®re, il aura un hachage compl√®tement diff√©rent.</font></font><br>
<br>
<pre><code class="bash hljs">$ redis-cli -a yourRedisPassword SCRIPT LOAD <span class="hljs-string">"<span class="hljs-subst">$(cat ./happend.lua)</span>"</span>
<span class="hljs-string">"d30c7f6d0c23fcfe6d4630b11f4e3db4cb2db099"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez maintenant utiliser EVALSHA pour appeler le script et ajouter:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt; HSET mynewhash greeting "Hello"<font></font>
(integer) 1<font></font>
&gt; EVALSHA d30c7f6d0c23fcfe6d4630b11f4e3db4cb2db099 1 mynewhash greeting " world"<font></font>
(integer) 0<font></font>
&gt; HGET mynewhash greeting<font></font>
"Hello world"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le premier argument de la commande EVALSHA est le hachage du script g√©n√©r√© par SCRIPT LOAD. Le deuxi√®me argument est le nombre de cl√©s. Dans notre cas, la cl√© est une. Le troisi√®me argument est la cl√© sur laquelle nous effectuons l'action. Et enfin, le quatri√®me est la valeur que nous ajoutons au champ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que l'ajout se produit √† l'int√©rieur du script Lua, le script ci-dessus sera abandonn√©, car les scripts Lua sont ex√©cut√©s de mani√®re synchrone et atomique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que Lua puisse √™tre tr√®s utile pour r√©soudre les probl√®mes, vous devez l'utiliser avec prudence. Le script bloque le serveur et peut conduire √† une base de donn√©es non r√©active. Dans les situations de partitionnement, les scripts tentent d'enregistrer toutes les op√©rations sur un seul serveur afin d'√©viter les erreurs crois√©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est l√† que se termine la section Redis Best Practices. </font><font style="vertical-align: inherit;">N'ayez pas peur d'essayer et d'exp√©rimenter, Redis est tr√®s riche en fonctionnalit√©s. </font><font style="vertical-align: inherit;">Laissez vos cas d'utilisation int√©ressants dans les commentaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re que les techniques d√©crites vous aideront sinon directement, du moins en vous indiquant la bonne voie pour r√©soudre les probl√®mes!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr506574/index.html">Visualisation de la liste des femmes laur√©ates du prix Nobel sous forme de cristaux en 3D √† l'aide de Vue, WebGL, three.js</a></li>
<li><a href="../fr506578/index.html">Volume de leads g√©r√©s</a></li>
<li><a href="../fr506586/index.html">FizzBuzz logique</a></li>
<li><a href="../fr506588/index.html">Qu'est-ce qu'un algorithme! (partie 2)</a></li>
<li><a href="../fr506590/index.html">Conf√©rence DEVOXX UK. Choisissez un framework: Docker Swarm, Kubernetes ou Mesos. Partie 2</a></li>
<li><a href="../fr506598/index.html">Microsoft: Rust —è–≤–ª—è–µ—Ç—Å—è '–ª—É—á—à–∏–º —à–∞–Ω—Å–æ–º' –≤ –æ—Ç—Ä–∞—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º</a></li>
<li><a href="../fr506600/index.html">Le contrat de d√©veloppement du site en termes de gestion de projet (th√©orie + √©chantillon)</a></li>
<li><a href="../fr506604/index.html">Concurrence et efficacit√©: Python vs FSM</a></li>
<li><a href="../fr506606/index.html">Cr√©ation d'un clicker PIXI.js</a></li>
<li><a href="../fr506610/index.html">WAL-G: Sauvegardes et restauration de bases de donn√©es PostgreSQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>