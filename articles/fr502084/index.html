<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíù üë∞üèª ‚òÄÔ∏è V√©rification du portail des services publics r√©gionaux sous charge par le biais de marionnettistes üí¢ üö≤ üë©üèº‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Vous aussi, vous √™tes curieusement en train de regarder "l'√©pop√©e du Far West am√©ricain sur la distribution des parcelles de terrain - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>V√©rification du portail des services publics r√©gionaux sous charge par le biais de marionnettistes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502084/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! Vous aussi, vous √™tes curieusement en train de regarder "l'√©pop√©e du Far West am√©ricain sur la distribution des parcelles de terrain - allez d'abord et collez un drapeau √† jalonner" ou peut-√™tre m√™me y participez. Plus pr√©cis√©ment dans sa version moderne - soyez le premier √† demander des services publics afin de recevoir de l'argent pour les enfants ou obtenir un laissez-passer pour quitter la maison. En regardant tout cela, je voudrais partager l'exp√©rience de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notre √©quipe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en testant et en participant √† la pr√©paration du portail r√©gional de services pour la fourniture du service "First Class Record". Il est √©galement tr√®s similaire √† l'effet habra et, je pense, √©tait proche de ce qui s'est pass√© il y a quelques jours avec le portail f√©d√©ral gosuslugi.ru, mais √† l'√©chelle r√©gionale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons r√©ussi ce d√©fi √† Khabarovsk en janvier de cette ann√©e et avons r√©cemment particip√© √† la pr√©paration d'un service similaire pour la d√©livrance de permis de chasse dans une autre r√©gion. Vous trouverez ci-dessous une petite exp√©rience qui vous donnera l'occasion d'examiner la question de la pr√©paration du travail des portails de services publics r√©gionaux pour les p√©riodes de pointe sous un autre angle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour commencer - une photo d'un bus noir, qui √©tait en service √† l'√©cole pendant trois jours jour et nuit, dans lequel l'auteur de ces lignes a confirm√© son tour parmi les parents il y a trois ans. Au moins, nos parents se sont r√©unis. Regarder en hiver √† Khabarovsk √† -30 degr√©s est toujours un plaisir.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o8/vh/rb/o8vhrboqvtrufnftfwxsxb1rgm4.png" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cadre de la pr√©paration de l'enregistrement de pointe en premi√®re ann√©e, plusieurs √©quipes ont travaill√©, car </font><font style="vertical-align: inherit;">d'une mani√®re ou d'une autre y participe: l'exploitant du centre de donn√©es, l'exploitant et le d√©veloppeur du syst√®me d'information du portail r√©gional, l'exploitant et le d√©veloppeur du syst√®me int√©gr√© d'information p√©dagogique, l'accompagnement technique des utilisateurs du portail r√©gional. </font><font style="vertical-align: inherit;">Nous √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iondv</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ex√©cutons la derni√®re t√¢che, la </font><font style="vertical-align: inherit;">surveillance ind√©pendante de </font><font style="vertical-align: inherit;">la sant√© des utilisateurs du </font><font style="vertical-align: inherit;">portail et de </font><font style="vertical-align: inherit;">soutien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre r√¥le dans la pr√©paration est d'organiser des tests et des recommandations sur les configurations de mise en cache dans nginx, eh bien, nous avons √©galement pr√©par√© des instructions pour les utilisateurs avec le ¬´comportement¬ª recommand√©.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour ceux qui ne connaissent pas le probl√®me de l'√©criture en 1√®re ann√©e</font></font></b>
                        <div class="spoiler_text">         ,    .  .          ,     ,   -     (      ,   ‚Äî      ),    ,  -     ,   ,            .  ,       ,      ,     ‚Äì    ,        .           .<br>
<br>
     1-          ,    .           0:00 ,        10:00 26 . ,    ‚Äì       .        10:00 ,       ‚Äî    ,      - .<br>
<br>
            .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>    .   2017 .     .         ,    ,    .          .<br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un service pour une ressource demand√©e comme t√¢che technique</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me dans des services comme ¬´l'√©criture au 1er grade¬ª dans l'indicateur int√©gral de la charge (ou probabilit√© de requ√™tes) tendant vers la ¬´fonction delta¬ª (fonction Œ¥, fonction Dirac) est clairement visible sur les graphiques sous forme de pics. En ce moment, il y a une augmentation multiple des appels en peu de temps. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0l/uc/c6/0lucc67w9pr4uh2ig1swg5tgtq0.png" alt="Statistiques des fonctions Œ¥ et des requ√™tes de pointe"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'apr√®s notre exp√©rience, la t√¢che principale de la formation n'est pas d'augmenter les ressources. La t√¢che consiste √† minimiser le nombre potentiel de demandes par seconde, √† les √©tirer pendant une certaine p√©riode et √† pr√©parer le syst√®me pour la charge restante. Dans ce cas, il est n√©cessaire de trouver et d'acc√©l√©rer les goulots d'√©tranglement - cela donnera le plus grand effet conform√©ment aux principes de la th√©orie des syst√®mes born√©s (principes de Goldratt). Et sinon, c'est le goulot d'√©tranglement qui √©chouera. Tout le syst√®me devrait fonctionner de lui: le principe du "tambour-corde-tampon".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est physiquement impossible de renverser tout le volume en 10 minutes de sablier en 1 minute - il est √©vident qu'ils s'effondreront. </font><font style="vertical-align: inherit;">De m√™me pour la prestation de services. </font><font style="vertical-align: inherit;">Cela ne surprend personne - quand c'est le tour du MFC et les scandales de recevoir des services, mais cela surprend tout le monde - pourquoi le portail est tomb√© en panne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe diff√©rents mod√®les de comportement de gestion de charge issus de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la th√©orie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">mise en file</font></a><font style="vertical-align: inherit;"> d' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">attente</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez mettre les utilisateurs en attente, c'est-√†-dire </font><font style="vertical-align: inherit;">augmenter la file d'attente;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous pouvez simplement refuser de servir ceux qui sont venus plus tard, par exemple, jusqu'√† ce que les pr√©c√©dents soient trait√©s;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vous pouvez essayer d'augmenter sans cesse la productivit√©.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'opportunit√© se situe quelque part entre les deux. En effet, pour un service aux ressources limit√©es fournies par une r√©gion ou un √âtat, non seulement la rapidit√© est importante, mais, tout d'abord, la pr√©servation de la justice sociale - c'est-√†-dire des conditions √©gales pour tous. Dans le m√™me temps - si l'utilisateur n'a pas re√ßu ce dont il a besoin, il lance une nouvelle demande. Dans ce cas, les demandes se d√©veloppent dans une avalanche, formant un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mod√®le de l'attaque ¬´</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> effet de pile de chiens </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">¬ª</font></a><font style="vertical-align: inherit;"> (effet de pile de chiens, ru√©e du cache, hit miss storm) - l'utilisateur a d√©j√† annul√© la demande et en a lanc√© une nouvelle, tandis que la pr√©c√©dente est toujours dans la file d'attente √† traiter.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce processus renforce le fait que des familles enti√®res participent √† la soumission - papa et maman remplissent les demandes en m√™me temps et soumettent souvent les demandes plusieurs fois pour plus de fiabilit√©. </font><font style="vertical-align: inherit;">Et d'ailleurs, souvent aussi dans plusieurs onglets et plusieurs navigateurs. </font><font style="vertical-align: inherit;">Par cons√©quent, la charge de pointe attendue a g√©n√©ralement du sens de se multiplier par 2 √† 3 fois, √† partir du nombre de ceux qui demandent effectivement de tels services.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retraite de la justice</font></font></b>
                        <div class="spoiler_text">,   ¬´¬ª,            .   ?  ¬´¬ª    ,    .   .     ‚Äî        ,     .        ¬´ ¬ª.        .          .<br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organisation de la prestation de services</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons calcul√© le nombre pr√©vu de candidats sur la base d'une combinaison de donn√©es sur le nombre total de demandes soumises l'ann√©e derni√®re et de donn√©es par minute pour d'autres r√©gions. </font><font style="vertical-align: inherit;">En r√®gle g√©n√©rale, les applications atteignent un pic √† 5-10 minutes, notamment parce que les portails ne r√©pondent presque pas pendant les trois √† cinq premi√®res minutes, et les utilisateurs ult√©rieurs remplissent le formulaire de 1 √† 5 minutes (ne soyez pas surpris que beaucoup remplissent m√™me depuis le t√©l√©phone dans des conditions ¬´nerveuses¬ª) . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un mod√®le de calcul approximatif pour les 1000 applications conditionnelles par heure est le suivant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pic de 5 √† 10 minutes d√®s le d√©but et 80% des demandes seront d√©pos√©es selon la r√®gle de Paretto</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Classiquement, nous pr√©voyons 160 applications par minute ou 3 applications par seconde.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, la premi√®re soumission s'est produite apr√®s une minute et 45 secondes, et le pic des demandes est pass√© de 4 minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©duire la charge sur ESIA et sur le syst√®me de g√©n√©rer des sessions d'autorisation, les instructions sugg√®rent aux utilisateurs de se connecter √† l'avance et d'allonger la dur√©e de vie de la session. </font><font style="vertical-align: inherit;">En fait, 50% ont √©t√© autoris√©s en 1 heure et ~ 90% en une demi-heure. </font><font style="vertical-align: inherit;">Nous avons rencontr√© plus t√¥t que les utilisateurs ont commenc√© √† se connecter au portail 10 minutes avant le d√©but du service - et l'autorisation a commenc√© √† fonctionner de mani√®re instable. </font><font style="vertical-align: inherit;">Il est difficile de dire pourquoi. </font><font style="vertical-align: inherit;">La raison en est peut-√™tre que lorsque le travail technique est effectu√© la nuit √† Moscou, √† Khabarovsk, nous n'avons que le d√©but de la journ√©e de travail.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retraite sur l'enseignement et les dispositions organisationnelles</font></font></b>
                        <div class="spoiler_text">            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>.<br>
<br>
         ,    ¬´ ¬ª     . ..      .       ,   -   .. <br>
<br>
    ,        ,         ,    .        -        .      ,       ,      .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est impossible de supprimer la "fonction delta" lorsque le formulaire est recharg√© √† 00h00. L'int√©r√™t de cette proc√©dure est que le service appara√Æt √† un moment donn√©. Mais vous pouvez essayer de r√©duire le nombre de demandes de navigateur sur toutes les routes utilisateur attendues et ainsi laisser la charge sur le syst√®me uniquement √† partir des demandes n√©cessaires - formulaire, r√©pertoires dynamiques et applications d'envoi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les param√®tres nginx eux-m√™mes sont assez standard. Ici, il est plus important de choisir les limitations que le syst√®me peut supporter. Ramassez-les - c.-√†-d. d√©marrer les demandes de mise en file d'attente lorsque le serveur devrait atteindre la limite de ses capacit√©s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, et surtout, nous avons forc√© la mise en cache (proxy_cache) et augment√© la dur√©e de vie des donn√©es "expir√©es" dans nginx pour tous les chemins statiques et, si possible, les pages dynamiques dans lesquelles il n'y a pas de sessions. Au fait, c'est une erreur courante lors de la mise en cache - en √©crivant dans les donn√©es de cache (parfois m√™me statiques) dans lesquelles la session de quelqu'un d'autre est enregistr√©e, la sortie consiste g√©n√©ralement √† supprimer ces cookies des en-t√™tes si le serveur ne peut pas s√©parer les types de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le navigateur de l'utilisateur, cela ressemble √† la mise √† jour de pages √† partir de fichiers t√©l√©charg√©s depuis le disque ou la m√©moire. Mais m√™me lorsque l'utilisateur les obtient du serveur, ils sont extraits du cache nginx. Les r√©pertoires eux-m√™mes, bien s√ªr, sont mis en cache dans le syst√®me lui-m√™me.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qi/oq/nv/qioqnv0ofdjd5e0ygculnetdta4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela a r√©duit le nombre de demandes potentielles de 89 √† 14 et le volume de 2,1 Mo (pour 1000 utilisateurs qui ont mis √† jour la page, il s'agit d'un pic potentiel de 4-8 Gbit / s) √† 38 Ko (nous nous souvenons tous du webpack, mais pour les plates-formes d'entreprise, ce n'est pas toujours facile √† faire). Selon les r√©sultats du passage, il √©tait encore n√©cessaire de mettre en cache non seulement dans le syst√®me, mais aussi dans nginx certains des r√©pertoires du formulaire et des classificateurs dynamiques non utilis√©s au moment de pointe et de forcer la dur√©e de vie pour eux. Et avec une augmentation de la charge, il est g√©n√©ralement judicieux de mettre la page principale enti√®rement statique avec les utilisateurs de routage vers le service souhait√© ou de cr√©er une ressource distincte pour le service.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour r√©duire la charge d'envoi, les brouillons et le remplissage automatique des donn√©es pour l'enfant ont √©t√© d√©sactiv√©s. Tous les utilisateurs ont des vitesses de saisie de donn√©es diff√©rentes, ce qui √©limine l'apparence d'un formulaire qui est compl√®tement pr√™t pour la soumission et √©vite la fonction delta pour l'envoi des candidatures - les 1000 en une minute. Dans le m√™me temps, la justice sociale est maintenue, bien que, bien s√ªr, des plaintes apparaissent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne d√©crirai pas l'optimisation du syst√®me lui-m√™me - lors des tests de charge, des goulots d'√©tranglement ont √©t√© identifi√©s - principalement dans les requ√™tes SGBD et les index et les requ√™tes eux-m√™mes ont √©t√© optimis√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'optimisation la plus importante est probablement de simplifier le formulaire. Qu'est-ce qui affecte le plus la vitesse lorsqu'elle est impl√©ment√©e dans un formulaire?</font></font><br>
<br>
<ul>
<li>   ‚Äî   ,        ,      .    ‚Äî       5-10 (   iPhone         )   5-       375 /  (1       10 ,     <code>application/x-www-form-urlencoded </code>‚Äì  20 ),  100      625 /.           100/      ‚Äî        .   ,      ¬´  ¬ª.    ‚Äî     ?     ,     .    ,      ?</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guides sophistiqu√©s. </font><font style="vertical-align: inherit;">La charge est g√©n√©ralement augment√©e en utilisant le r√©pertoire d'adresses FIAS ou CLADR. </font><font style="vertical-align: inherit;">Les probl√®mes ici sont dus √† la taille - FIAS prend jusqu'√† 40 Go dans la base de donn√©es et il faut du temps pour la rechercher. </font><font style="vertical-align: inherit;">Des dizaines de seconde, mais multipli√©es par 1000 requ√™tes simultan√©es, chargent n'importe quel syst√®me. </font><font style="vertical-align: inherit;">Sans pr√©paration sp√©ciale, peut-√™tre sous la forme d'un service Web distinct et sur une ressource distincte, il est difficile de supporter la charge - par cons√©quent, ils utilisent souvent un champ de texte brut pour l'adresse.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, passons aux tests.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test de charge en pr√©paration</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les tests ont √©t√© effectu√©s par le biais de marionnettistes - en √©mulant les actions des utilisateurs dans le navigateur Crominium. </font><font style="vertical-align: inherit;">Yanedeks.tank et JMeter combattent la protection contre les attaques, car ils g√©n√®rent un grand nombre de demandes du m√™me type. </font><font style="vertical-align: inherit;">De plus, ces tests co√Øncident faiblement avec le profil des requ√™tes r√©elles lors de la modification du comportement du syst√®me sous charge. </font><font style="vertical-align: inherit;">De plus, les serveurs mettent en cache les demandes et il est difficile de reproduire une partie des processus en eux (par exemple, l'autorisation). </font><font style="vertical-align: inherit;">Soit dit en passant, √† partir d'un des ateliers </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devDV</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous avons une pr√©sentation avec une pr√©sentation sur l'utilisation des marionnettistes pour les tests, y compris </font><font style="vertical-align: inherit;">charger, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien vers la vid√©o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, nous avons compil√© un profil de comportement de l'utilisateur et divis√© la proc√©dure en √©tapes cl√©s:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> autorisation de masse en EIES</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mise √† jour unique du formulaire de service,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alimentation de masse </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour chacune des √©tapes, nous avons effectu√© un test distinct. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ann√©e derni√®re, il y avait des difficult√©s au stade de l'autorisation dans l'EIES, mais le tester √† grande √©chelle est difficile. Le syst√®me est externe, la protection contre les attaques et les interdictions d'autorisation est d√©clench√©e. N√©anmoins, il est possible de formuler un profil de test pour tester avec pr√©cision les goulots d'√©tranglement du syst√®me test√© - il s'agit g√©n√©ralement du nombre de sessions simultan√©ment autoris√©es et des valeurs d'autorisation planifi√©es par minute, qui peuvent √™tre r√©glement√©es par des recommandations.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le test, le wrapper est important pour organiser plusieurs threads, nous utilisons le 'puppeteer-cluster'. Mais g√©n√©ralement, il est plus compliqu√© de g√©rer les exceptions et de modifier le comportement du portail sous charge - les √©l√©ments de disposition sont souvent r√©v√©l√©s qui apparaissent deux fois. Ou les √©l√©ments n'apparaissent pas si certaines donn√©es ne se sont pas charg√©es comme pr√©vu. Ce sont toutes les erreurs que les utilisateurs verront et rechargeront la page - ce qui signifie qu'ils cr√©eront une charge suppl√©mentaire. Il existe deux m√©thodes: impl√©mentez la gestion des exceptions dans le test. Ou modifiez le portail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le test lui-m√™me est simple. Ci-dessous est un fragment de cliquer sur le bouton "Connexion" sur le portail de services pour entrer des donn√©es dans l'EIES.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">await</span> page.waitForSelector(AUTH_AVAIL,{<span class="hljs-attr">timeout</span>:OPT_ELEM_WAIT_TIME});
<span class="hljs-keyword">const</span> needAuth = <span class="hljs-keyword">await</span> page.$(ELEM_AUTH_IN);
<span class="hljs-keyword">if</span> (!needAuth) <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`  `</span>));<font></font>
        <font></font>
<span class="hljs-keyword">await</span> page.waitForSelector(AUTH_BUT, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">await</span> page.click(AUTH_BUT);
<span class="hljs-keyword">await</span> waitNewUrl(page, <span class="hljs-string">'https://esia.gosuslugi.ru/idp/rlogin?cc=bp'</span>, OPT_PAGE_WAIT_TIME);
<span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#mobileOrEmail'</span>, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">let</span> text = <span class="hljs-keyword">await</span> elemGetText(page, <span class="hljs-string">'#authnFrm &gt; div.login-slils-box &gt; div &gt; div.detected &gt; div.left &gt; div.this-user'</span>);
<span class="hljs-keyword">if</span> (text) <font></font>
   text = text.replace(<span class="hljs-regexp">/ -\(\)/g</span>, <span class="hljs-string">''</span>);        
<span class="hljs-keyword">if</span> (text &amp;&amp; text.indexOf(user) === <span class="hljs-number">-1</span>) {
  <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'div.click-to-another &gt; a'</span>);
  <span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#authnFrm &gt; div.login-slils-box &gt; div &gt;'</span> +
                <span class="hljs-string">' div.detected &gt; div.left &gt; div.this-user'</span>, OPT_ELEMENT_INVISIBLE);<font></font>
}<font></font>
<span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#password'</span>, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#mobileOrEmail'</span>, user);
<span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#password'</span>, pwd);
<span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#loginByPwdButton'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√©rification de la mise √† jour du formulaire de demande des utilisateurs en attente ¬´ouverture de l'enregistrement¬ª. Le test de red√©marrage est essentiellement une √©tape, mais il est important de v√©rifier les types d'erreurs renvoy√©es - le r√©seau est un probl√®me, une erreur nginx, une erreur de serveur et si le formulaire r√©pond aux crit√®res. Et la difficult√© est de g√©n√©rer le volume maximum de requ√™tes en un minimum de temps et de ne pas tomber sous les restrictions de protection (cependant, lors des tests il peut √™tre modifi√©, d'autre part, c'est aussi une v√©rification des param√®tres d'infrastructure r√©seau et serveur et WAF). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De tels tests sur les marionnettistes n√©cessitent beaucoup de ressources pour fonctionner. De facto, il s'est av√©r√© que vous avez besoin d'au moins 2 c≈ìurs contre le 1er c≈ìur du sous-syst√®me frontal et d'un canal tr√®s large. Mais lorsque vous les louez dans le cloud - c'est assez abordable. Nous avons utilis√© Yandex.cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le test, l'autorisation est d'abord mise en ≈ìuvre dans l'EIES pour chaque flux s√©par√©ment. </font><font style="vertical-align: inherit;">Apr√®s cela, un navigateur distinct est lanc√© pour chaque thread et dans le cadre d'une instance, un nombre donn√© de mises √† jour est effectu√©. </font><font style="vertical-align: inherit;">Apr√®s cela, l'instance red√©marre. </font><font style="vertical-align: inherit;">La v√©rification elle-m√™me peut inclure un chemin d'acc√®s typique, par exemple, la page principale, la forme du service. </font><font style="vertical-align: inherit;">Mais le plus souvent, il suffit de mettre √† jour compl√®tement le service et de v√©rifier dans le r√©pertoire n√©cessaire que le service peut √™tre soumis - tout comme dans les instructions pour les utilisateurs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oe/8w/vk/oe8wvknrrkkw1hn3vb4ke0oh8sw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un fragment du test pour ouvrir le principal et rafra√Æchir la page.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> page.setViewport(PUP_OPT);
  <span class="hljs-keyword">await</span> page.goto(BASE_URL);
  <span class="hljs-keyword">await</span> page.setCookie(...cookies[worker.id]);
  <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/nd/lk/form/dnv.htm`</span>);<font></font>
  rdyRefresh++;<font></font>
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#       <span class="hljs-subst">${data}</span>: <span class="hljs-subst">${err.message}</span>`</span>);<font></font>
  getErr++;<font></font>
  <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
}<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; AMOUNT_REFRESH - <span class="hljs-number">1</span>; i++) {
  <span class="hljs-keyword">const</span> filenameIter = path.join(BASE_DIR, PIC_DIR, <span class="hljs-string">`<span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>.png`</span>);
   <span class="hljs-keyword">try</span> {
       <span class="hljs-keyword">await</span> page.reload({<span class="hljs-attr">waitUntil</span>: [<span class="hljs-string">"networkidle0"</span>, <span class="hljs-string">"domcontentloaded"</span>]});<font></font>
        rdyRefresh++;<font></font>
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">if</span> (!err.message.includes(<span class="hljs-string">'Navigation failed because browser'</span>)) {
           <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#     <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);<font></font>
           getErr++;<font></font>
           <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filenameIter});<font></font>
        }<font></font>
   }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le chargement en envoyant des candidatures, l'ensemble du cycle de v√©rification a √©t√© mis en ≈ìuvre - avec un rechargement du formulaire et une v√©rification de la saisie de toutes les donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fragment.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; AMOUNT_RESEND; i++) {
   <span class="hljs-keyword">const</span> filename = path.join(BASE_DIR, PIC_DIR, <span class="hljs-string">`<span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>.png`</span>);
  <span class="hljs-keyword">try</span> {
     <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">'https://uslugi27.ru/nd/lk/form/dnv.htm'</span>);<font></font>
  } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#      1  <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
      <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
      getErr++;<font></font>
      <span class="hljs-keyword">continue</span>;<font></font>
 }<font></font>
 <span class="hljs-keyword">try</span> {
     <span class="hljs-keyword">const</span> FORM_PREF = <span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; '</span>;
     <span class="hljs-keyword">await</span> clickDelayed(page,<span class="hljs-string">`<span class="hljs-subst">${FORM_PREF}</span>fieldset.petgroup.ungroupped-attrs &gt; div &gt; div:nth-child(4) &gt; div.col-md-9.attr-data`</span>);
<span class="hljs-comment">// &lt;‚Ä¶&gt;</span>
     <span class="hljs-keyword">await</span> page.type(<span class="hljs-string">`<span class="hljs-subst">${FORM_PREF}</span>fieldset:nth-child(2) &gt; div &gt; div:nth-child(1) &gt; div.col-md-9.attr-data &gt; input`</span>, <span class="hljs-string">''</span>);
<span class="hljs-comment">// &lt;‚Ä¶&gt;</span>
  } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#      <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
      <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});
     <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div.col_100.controls &gt; button.btn.btn-primary.pull-right.next'</span>);
      <span class="hljs-keyword">await</span> clickDelayed(page,<span class="hljs-string">`#createForm &gt; div:nth-child(5) &gt; fieldset &gt; div &gt; div:nth-child(1) &gt; div &gt; div`</span>);
       <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div:nth-child(5) &gt; fieldset &gt; div &gt; div:nth-child(2) &gt; div &gt; div'</span>);
       <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div.col_100.controls &gt; button.btn.btn-success.pull-right.submit'</span>);<font></font>
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#     <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
    <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
    sendErr++;<font></font>
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, le test peut √™tre acc√©l√©r√© si vous saisissez toutes les donn√©es ne provenant pas du marionnettiste par la construction page.type en attente, mais transf√©rez cette logique au navigateur lui-m√™me. Mais alors la complexit√© des erreurs de capture augmente. Ainsi</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; fieldset.petgroup.ungroupped-attrs &gt; div &gt; div:nth-child(4) &gt; div.col-md-9.attr-data'</span>).click();
 <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; fieldset:nth-child(2) &gt; div &gt; div:nth-child(1) &gt; div.col-md-9.attr-data &gt; input'</span>).value = <span class="hljs-string">''</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours des tests, nous avons fourni plusieurs milliers d'autorisations EIES et environ 16 000 demandes envoy√©es. Comment a √©t√© la restauration d'un syst√®me d'information √©ducatif productif apr√®s un tel nombre de d√©clarations - ne demandez m√™me pas. C'est une histoire compl√®tement diff√©rente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le principal r√©sultat visible de ce processus a √©t√© que les m√©dias locaux s'ennuyaient maintenant √† l'√©poque de l'inscription en premi√®re ann√©e. Le service a quitt√© la zone des m√©dias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En parall√®le, nous avons r√©alis√© un tableau de bord pour suivre les performances du formulaire bas√© sur Grafana: le nombre d'applications, le nombre d'appels, les m√©triques Yandex, etc. Mais nous laisserons ce sujet pour la prochaine fois.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, je voudrais f√©liciter tous ceux qui sont li√©s au sujet de l'am√©lioration de la qualit√© de la prestation des services publics et municipaux sous forme √©lectronique. </font><font style="vertical-align: inherit;">Ce travail de pr√©paration sans fin n'a pas √©t√© vain - apr√®s tout, en avril et en mai, le nombre de candidatures soumises a consid√©rablement augment√©.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502068/index.html">110 volts sur votre ordinateur</a></li>
<li><a href="../fr502070/index.html">L'histoire de Pentax (article plus vid√©o)</a></li>
<li><a href="../fr502072/index.html">Amarrage de l'ISS √† l'aide de JavaScript et d'une boussole</a></li>
<li><a href="../fr502076/index.html">Trolley Robot 2.0. Partie 1. Navigation autonome d'un robot domestique bas√© sur ROS</a></li>
<li><a href="../fr502080/index.html">M√©thode Kanban: Exemple PNZ n ¬∞ 1, le processus de mesure-√©tude dans une startup</a></li>
<li><a href="../fr502086/index.html">Configuration de Minio pour que l'utilisateur ne puisse travailler qu'avec son bucket</a></li>
<li><a href="../fr502088/index.html">Une histoire d'exc√®s et de temps perdu. Selon py3</a></li>
<li><a href="../fr502092/index.html">Assistance technologique et r√©glementaire pour les services de confiance num√©rique dans la F√©d√©ration de Russie</a></li>
<li><a href="../fr502098/index.html">Comment nous avons construit le B2B</a></li>
<li><a href="../fr502102/index.html">AutoML est g√©nial et puissant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>