<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💝 👰🏻 ☀️ Vérification du portail des services publics régionaux sous charge par le biais de marionnettistes 💢 🚲 👩🏼‍🍳</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Vous aussi, vous êtes curieusement en train de regarder "l'épopée du Far West américain sur la distribution des parcelles de terrain - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Vérification du portail des services publics régionaux sous charge par le biais de marionnettistes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502084/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! Vous aussi, vous êtes curieusement en train de regarder "l'épopée du Far West américain sur la distribution des parcelles de terrain - allez d'abord et collez un drapeau à jalonner" ou peut-être même y participez. Plus précisément dans sa version moderne - soyez le premier à demander des services publics afin de recevoir de l'argent pour les enfants ou obtenir un laissez-passer pour quitter la maison. En regardant tout cela, je voudrais partager l'expérience de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">notre équipe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en testant et en participant à la préparation du portail régional de services pour la fourniture du service "First Class Record". Il est également très similaire à l'effet habra et, je pense, était proche de ce qui s'est passé il y a quelques jours avec le portail fédéral gosuslugi.ru, mais à l'échelle régionale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons réussi ce défi à Khabarovsk en janvier de cette année et avons récemment participé à la préparation d'un service similaire pour la délivrance de permis de chasse dans une autre région. Vous trouverez ci-dessous une petite expérience qui vous donnera l'occasion d'examiner la question de la préparation du travail des portails de services publics régionaux pour les périodes de pointe sous un autre angle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour commencer - une photo d'un bus noir, qui était en service à l'école pendant trois jours jour et nuit, dans lequel l'auteur de ces lignes a confirmé son tour parmi les parents il y a trois ans. Au moins, nos parents se sont réunis. Regarder en hiver à Khabarovsk à -30 degrés est toujours un plaisir.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o8/vh/rb/o8vhrboqvtrufnftfwxsxb1rgm4.png" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cadre de la préparation de l'enregistrement de pointe en première année, plusieurs équipes ont travaillé, car </font><font style="vertical-align: inherit;">d'une manière ou d'une autre y participe: l'exploitant du centre de données, l'exploitant et le développeur du système d'information du portail régional, l'exploitant et le développeur du système intégré d'information pédagogique, l'accompagnement technique des utilisateurs du portail régional. </font><font style="vertical-align: inherit;">Nous à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iondv</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exécutons la dernière tâche, la </font><font style="vertical-align: inherit;">surveillance indépendante de </font><font style="vertical-align: inherit;">la santé des utilisateurs du </font><font style="vertical-align: inherit;">portail et de </font><font style="vertical-align: inherit;">soutien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre rôle dans la préparation est d'organiser des tests et des recommandations sur les configurations de mise en cache dans nginx, eh bien, nous avons également préparé des instructions pour les utilisateurs avec le «comportement» recommandé.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour ceux qui ne connaissent pas le problème de l'écriture en 1ère année</font></font></b>
                        <div class="spoiler_text">         ,    .  .          ,     ,   -     (      ,   —      ),    ,  -     ,   ,            .  ,       ,      ,     –    ,        .           .<br>
<br>
     1-          ,    .           0:00 ,        10:00 26 . ,    –       .        10:00 ,       —    ,      - .<br>
<br>
            .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>    .   2017 .     .         ,    ,    .          .<br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un service pour une ressource demandée comme tâche technique</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème dans des services comme «l'écriture au 1er grade» dans l'indicateur intégral de la charge (ou probabilité de requêtes) tendant vers la «fonction delta» (fonction δ, fonction Dirac) est clairement visible sur les graphiques sous forme de pics. En ce moment, il y a une augmentation multiple des appels en peu de temps. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0l/uc/c6/0lucc67w9pr4uh2ig1swg5tgtq0.png" alt="Statistiques des fonctions δ et des requêtes de pointe"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'après notre expérience, la tâche principale de la formation n'est pas d'augmenter les ressources. La tâche consiste à minimiser le nombre potentiel de demandes par seconde, à les étirer pendant une certaine période et à préparer le système pour la charge restante. Dans ce cas, il est nécessaire de trouver et d'accélérer les goulots d'étranglement - cela donnera le plus grand effet conformément aux principes de la théorie des systèmes bornés (principes de Goldratt). Et sinon, c'est le goulot d'étranglement qui échouera. Tout le système devrait fonctionner de lui: le principe du "tambour-corde-tampon".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est physiquement impossible de renverser tout le volume en 10 minutes de sablier en 1 minute - il est évident qu'ils s'effondreront. </font><font style="vertical-align: inherit;">De même pour la prestation de services. </font><font style="vertical-align: inherit;">Cela ne surprend personne - quand c'est le tour du MFC et les scandales de recevoir des services, mais cela surprend tout le monde - pourquoi le portail est tombé en panne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe différents modèles de comportement de gestion de charge issus de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la théorie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">mise en file</font></a><font style="vertical-align: inherit;"> d' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">attente</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez mettre les utilisateurs en attente, c'est-à-dire </font><font style="vertical-align: inherit;">augmenter la file d'attente;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous pouvez simplement refuser de servir ceux qui sont venus plus tard, par exemple, jusqu'à ce que les précédents soient traités;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vous pouvez essayer d'augmenter sans cesse la productivité.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'opportunité se situe quelque part entre les deux. En effet, pour un service aux ressources limitées fournies par une région ou un État, non seulement la rapidité est importante, mais, tout d'abord, la préservation de la justice sociale - c'est-à-dire des conditions égales pour tous. Dans le même temps - si l'utilisateur n'a pas reçu ce dont il a besoin, il lance une nouvelle demande. Dans ce cas, les demandes se développent dans une avalanche, formant un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modèle de l'attaque «</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> effet de pile de chiens </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">»</font></a><font style="vertical-align: inherit;"> (effet de pile de chiens, ruée du cache, hit miss storm) - l'utilisateur a déjà annulé la demande et en a lancé une nouvelle, tandis que la précédente est toujours dans la file d'attente à traiter.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce processus renforce le fait que des familles entières participent à la soumission - papa et maman remplissent les demandes en même temps et soumettent souvent les demandes plusieurs fois pour plus de fiabilité. </font><font style="vertical-align: inherit;">Et d'ailleurs, souvent aussi dans plusieurs onglets et plusieurs navigateurs. </font><font style="vertical-align: inherit;">Par conséquent, la charge de pointe attendue a généralement du sens de se multiplier par 2 à 3 fois, à partir du nombre de ceux qui demandent effectivement de tels services.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retraite de la justice</font></font></b>
                        <div class="spoiler_text">,   «»,            .   ?  «»    ,    .   .     —        ,     .        « ».        .          .<br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organisation de la prestation de services</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons calculé le nombre prévu de candidats sur la base d'une combinaison de données sur le nombre total de demandes soumises l'année dernière et de données par minute pour d'autres régions. </font><font style="vertical-align: inherit;">En règle générale, les applications atteignent un pic à 5-10 minutes, notamment parce que les portails ne répondent presque pas pendant les trois à cinq premières minutes, et les utilisateurs ultérieurs remplissent le formulaire de 1 à 5 minutes (ne soyez pas surpris que beaucoup remplissent même depuis le téléphone dans des conditions «nerveuses») . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un modèle de calcul approximatif pour les 1000 applications conditionnelles par heure est le suivant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pic de 5 à 10 minutes dès le début et 80% des demandes seront déposées selon la règle de Paretto</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Classiquement, nous prévoyons 160 applications par minute ou 3 applications par seconde.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, la première soumission s'est produite après une minute et 45 secondes, et le pic des demandes est passé de 4 minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour réduire la charge sur ESIA et sur le système de générer des sessions d'autorisation, les instructions suggèrent aux utilisateurs de se connecter à l'avance et d'allonger la durée de vie de la session. </font><font style="vertical-align: inherit;">En fait, 50% ont été autorisés en 1 heure et ~ 90% en une demi-heure. </font><font style="vertical-align: inherit;">Nous avons rencontré plus tôt que les utilisateurs ont commencé à se connecter au portail 10 minutes avant le début du service - et l'autorisation a commencé à fonctionner de manière instable. </font><font style="vertical-align: inherit;">Il est difficile de dire pourquoi. </font><font style="vertical-align: inherit;">La raison en est peut-être que lorsque le travail technique est effectué la nuit à Moscou, à Khabarovsk, nous n'avons que le début de la journée de travail.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retraite sur l'enseignement et les dispositions organisationnelles</font></font></b>
                        <div class="spoiler_text">            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"></a>.<br>
<br>
         ,    « »     . ..      .       ,   -   .. <br>
<br>
    ,        ,         ,    .        -        .      ,       ,      .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est impossible de supprimer la "fonction delta" lorsque le formulaire est rechargé à 00h00. L'intérêt de cette procédure est que le service apparaît à un moment donné. Mais vous pouvez essayer de réduire le nombre de demandes de navigateur sur toutes les routes utilisateur attendues et ainsi laisser la charge sur le système uniquement à partir des demandes nécessaires - formulaire, répertoires dynamiques et applications d'envoi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les paramètres nginx eux-mêmes sont assez standard. Ici, il est plus important de choisir les limitations que le système peut supporter. Ramassez-les - c.-à-d. démarrer les demandes de mise en file d'attente lorsque le serveur devrait atteindre la limite de ses capacités.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, et surtout, nous avons forcé la mise en cache (proxy_cache) et augmenté la durée de vie des données "expirées" dans nginx pour tous les chemins statiques et, si possible, les pages dynamiques dans lesquelles il n'y a pas de sessions. Au fait, c'est une erreur courante lors de la mise en cache - en écrivant dans les données de cache (parfois même statiques) dans lesquelles la session de quelqu'un d'autre est enregistrée, la sortie consiste généralement à supprimer ces cookies des en-têtes si le serveur ne peut pas séparer les types de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le navigateur de l'utilisateur, cela ressemble à la mise à jour de pages à partir de fichiers téléchargés depuis le disque ou la mémoire. Mais même lorsque l'utilisateur les obtient du serveur, ils sont extraits du cache nginx. Les répertoires eux-mêmes, bien sûr, sont mis en cache dans le système lui-même.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qi/oq/nv/qioqnv0ofdjd5e0ygculnetdta4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela a réduit le nombre de demandes potentielles de 89 à 14 et le volume de 2,1 Mo (pour 1000 utilisateurs qui ont mis à jour la page, il s'agit d'un pic potentiel de 4-8 Gbit / s) à 38 Ko (nous nous souvenons tous du webpack, mais pour les plates-formes d'entreprise, ce n'est pas toujours facile à faire). Selon les résultats du passage, il était encore nécessaire de mettre en cache non seulement dans le système, mais aussi dans nginx certains des répertoires du formulaire et des classificateurs dynamiques non utilisés au moment de pointe et de forcer la durée de vie pour eux. Et avec une augmentation de la charge, il est généralement judicieux de mettre la page principale entièrement statique avec les utilisateurs de routage vers le service souhaité ou de créer une ressource distincte pour le service.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour réduire la charge d'envoi, les brouillons et le remplissage automatique des données pour l'enfant ont été désactivés. Tous les utilisateurs ont des vitesses de saisie de données différentes, ce qui élimine l'apparence d'un formulaire qui est complètement prêt pour la soumission et évite la fonction delta pour l'envoi des candidatures - les 1000 en une minute. Dans le même temps, la justice sociale est maintenue, bien que, bien sûr, des plaintes apparaissent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne décrirai pas l'optimisation du système lui-même - lors des tests de charge, des goulots d'étranglement ont été identifiés - principalement dans les requêtes SGBD et les index et les requêtes eux-mêmes ont été optimisés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'optimisation la plus importante est probablement de simplifier le formulaire. Qu'est-ce qui affecte le plus la vitesse lorsqu'elle est implémentée dans un formulaire?</font></font><br>
<br>
<ul>
<li>   —   ,        ,      .    —       5-10 (   iPhone         )   5-       375 /  (1       10 ,     <code>application/x-www-form-urlencoded </code>–  20 ),  100      625 /.           100/      —        .   ,      «  ».    —     ?     ,     .    ,      ?</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guides sophistiqués. </font><font style="vertical-align: inherit;">La charge est généralement augmentée en utilisant le répertoire d'adresses FIAS ou CLADR. </font><font style="vertical-align: inherit;">Les problèmes ici sont dus à la taille - FIAS prend jusqu'à 40 Go dans la base de données et il faut du temps pour la rechercher. </font><font style="vertical-align: inherit;">Des dizaines de seconde, mais multipliées par 1000 requêtes simultanées, chargent n'importe quel système. </font><font style="vertical-align: inherit;">Sans préparation spéciale, peut-être sous la forme d'un service Web distinct et sur une ressource distincte, il est difficile de supporter la charge - par conséquent, ils utilisent souvent un champ de texte brut pour l'adresse.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, passons aux tests.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test de charge en préparation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les tests ont été effectués par le biais de marionnettistes - en émulant les actions des utilisateurs dans le navigateur Crominium. </font><font style="vertical-align: inherit;">Yanedeks.tank et JMeter combattent la protection contre les attaques, car ils génèrent un grand nombre de demandes du même type. </font><font style="vertical-align: inherit;">De plus, ces tests coïncident faiblement avec le profil des requêtes réelles lors de la modification du comportement du système sous charge. </font><font style="vertical-align: inherit;">De plus, les serveurs mettent en cache les demandes et il est difficile de reproduire une partie des processus en eux (par exemple, l'autorisation). </font><font style="vertical-align: inherit;">Soit dit en passant, à partir d'un des ateliers </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devDV</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous avons une présentation avec une présentation sur l'utilisation des marionnettistes pour les tests, y compris </font><font style="vertical-align: inherit;">charger, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien vers la vidéo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, nous avons compilé un profil de comportement de l'utilisateur et divisé la procédure en étapes clés:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> autorisation de masse en EIES</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mise à jour unique du formulaire de service,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alimentation de masse </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour chacune des étapes, nous avons effectué un test distinct. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'année dernière, il y avait des difficultés au stade de l'autorisation dans l'EIES, mais le tester à grande échelle est difficile. Le système est externe, la protection contre les attaques et les interdictions d'autorisation est déclenchée. Néanmoins, il est possible de formuler un profil de test pour tester avec précision les goulots d'étranglement du système testé - il s'agit généralement du nombre de sessions simultanément autorisées et des valeurs d'autorisation planifiées par minute, qui peuvent être réglementées par des recommandations.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le test, le wrapper est important pour organiser plusieurs threads, nous utilisons le 'puppeteer-cluster'. Mais généralement, il est plus compliqué de gérer les exceptions et de modifier le comportement du portail sous charge - les éléments de disposition sont souvent révélés qui apparaissent deux fois. Ou les éléments n'apparaissent pas si certaines données ne se sont pas chargées comme prévu. Ce sont toutes les erreurs que les utilisateurs verront et rechargeront la page - ce qui signifie qu'ils créeront une charge supplémentaire. Il existe deux méthodes: implémentez la gestion des exceptions dans le test. Ou modifiez le portail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le test lui-même est simple. Ci-dessous est un fragment de cliquer sur le bouton "Connexion" sur le portail de services pour entrer des données dans l'EIES.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">await</span> page.waitForSelector(AUTH_AVAIL,{<span class="hljs-attr">timeout</span>:OPT_ELEM_WAIT_TIME});
<span class="hljs-keyword">const</span> needAuth = <span class="hljs-keyword">await</span> page.$(ELEM_AUTH_IN);
<span class="hljs-keyword">if</span> (!needAuth) <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`  `</span>));<font></font>
        <font></font>
<span class="hljs-keyword">await</span> page.waitForSelector(AUTH_BUT, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">await</span> page.click(AUTH_BUT);
<span class="hljs-keyword">await</span> waitNewUrl(page, <span class="hljs-string">'https://esia.gosuslugi.ru/idp/rlogin?cc=bp'</span>, OPT_PAGE_WAIT_TIME);
<span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#mobileOrEmail'</span>, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">let</span> text = <span class="hljs-keyword">await</span> elemGetText(page, <span class="hljs-string">'#authnFrm &gt; div.login-slils-box &gt; div &gt; div.detected &gt; div.left &gt; div.this-user'</span>);
<span class="hljs-keyword">if</span> (text) <font></font>
   text = text.replace(<span class="hljs-regexp">/ -\(\)/g</span>, <span class="hljs-string">''</span>);        
<span class="hljs-keyword">if</span> (text &amp;&amp; text.indexOf(user) === <span class="hljs-number">-1</span>) {
  <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'div.click-to-another &gt; a'</span>);
  <span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#authnFrm &gt; div.login-slils-box &gt; div &gt;'</span> +
                <span class="hljs-string">' div.detected &gt; div.left &gt; div.this-user'</span>, OPT_ELEMENT_INVISIBLE);<font></font>
}<font></font>
<span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#password'</span>, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#mobileOrEmail'</span>, user);
<span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#password'</span>, pwd);
<span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#loginByPwdButton'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vérification de la mise à jour du formulaire de demande des utilisateurs en attente «ouverture de l'enregistrement». Le test de redémarrage est essentiellement une étape, mais il est important de vérifier les types d'erreurs renvoyées - le réseau est un problème, une erreur nginx, une erreur de serveur et si le formulaire répond aux critères. Et la difficulté est de générer le volume maximum de requêtes en un minimum de temps et de ne pas tomber sous les restrictions de protection (cependant, lors des tests il peut être modifié, d'autre part, c'est aussi une vérification des paramètres d'infrastructure réseau et serveur et WAF). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De tels tests sur les marionnettistes nécessitent beaucoup de ressources pour fonctionner. De facto, il s'est avéré que vous avez besoin d'au moins 2 cœurs contre le 1er cœur du sous-système frontal et d'un canal très large. Mais lorsque vous les louez dans le cloud - c'est assez abordable. Nous avons utilisé Yandex.cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le test, l'autorisation est d'abord mise en œuvre dans l'EIES pour chaque flux séparément. </font><font style="vertical-align: inherit;">Après cela, un navigateur distinct est lancé pour chaque thread et dans le cadre d'une instance, un nombre donné de mises à jour est effectué. </font><font style="vertical-align: inherit;">Après cela, l'instance redémarre. </font><font style="vertical-align: inherit;">La vérification elle-même peut inclure un chemin d'accès typique, par exemple, la page principale, la forme du service. </font><font style="vertical-align: inherit;">Mais le plus souvent, il suffit de mettre à jour complètement le service et de vérifier dans le répertoire nécessaire que le service peut être soumis - tout comme dans les instructions pour les utilisateurs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oe/8w/vk/oe8wvknrrkkw1hn3vb4ke0oh8sw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un fragment du test pour ouvrir le principal et rafraîchir la page.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> page.setViewport(PUP_OPT);
  <span class="hljs-keyword">await</span> page.goto(BASE_URL);
  <span class="hljs-keyword">await</span> page.setCookie(...cookies[worker.id]);
  <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/nd/lk/form/dnv.htm`</span>);<font></font>
  rdyRefresh++;<font></font>
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#       <span class="hljs-subst">${data}</span>: <span class="hljs-subst">${err.message}</span>`</span>);<font></font>
  getErr++;<font></font>
  <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
}<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; AMOUNT_REFRESH - <span class="hljs-number">1</span>; i++) {
  <span class="hljs-keyword">const</span> filenameIter = path.join(BASE_DIR, PIC_DIR, <span class="hljs-string">`<span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>.png`</span>);
   <span class="hljs-keyword">try</span> {
       <span class="hljs-keyword">await</span> page.reload({<span class="hljs-attr">waitUntil</span>: [<span class="hljs-string">"networkidle0"</span>, <span class="hljs-string">"domcontentloaded"</span>]});<font></font>
        rdyRefresh++;<font></font>
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">if</span> (!err.message.includes(<span class="hljs-string">'Navigation failed because browser'</span>)) {
           <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#     <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);<font></font>
           getErr++;<font></font>
           <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filenameIter});<font></font>
        }<font></font>
   }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le chargement en envoyant des candidatures, l'ensemble du cycle de vérification a été mis en œuvre - avec un rechargement du formulaire et une vérification de la saisie de toutes les données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fragment.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; AMOUNT_RESEND; i++) {
   <span class="hljs-keyword">const</span> filename = path.join(BASE_DIR, PIC_DIR, <span class="hljs-string">`<span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>.png`</span>);
  <span class="hljs-keyword">try</span> {
     <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">'https://uslugi27.ru/nd/lk/form/dnv.htm'</span>);<font></font>
  } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#      1  <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
      <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
      getErr++;<font></font>
      <span class="hljs-keyword">continue</span>;<font></font>
 }<font></font>
 <span class="hljs-keyword">try</span> {
     <span class="hljs-keyword">const</span> FORM_PREF = <span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; '</span>;
     <span class="hljs-keyword">await</span> clickDelayed(page,<span class="hljs-string">`<span class="hljs-subst">${FORM_PREF}</span>fieldset.petgroup.ungroupped-attrs &gt; div &gt; div:nth-child(4) &gt; div.col-md-9.attr-data`</span>);
<span class="hljs-comment">// &lt;…&gt;</span>
     <span class="hljs-keyword">await</span> page.type(<span class="hljs-string">`<span class="hljs-subst">${FORM_PREF}</span>fieldset:nth-child(2) &gt; div &gt; div:nth-child(1) &gt; div.col-md-9.attr-data &gt; input`</span>, <span class="hljs-string">''</span>);
<span class="hljs-comment">// &lt;…&gt;</span>
  } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#      <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
      <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});
     <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div.col_100.controls &gt; button.btn.btn-primary.pull-right.next'</span>);
      <span class="hljs-keyword">await</span> clickDelayed(page,<span class="hljs-string">`#createForm &gt; div:nth-child(5) &gt; fieldset &gt; div &gt; div:nth-child(1) &gt; div &gt; div`</span>);
       <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div:nth-child(5) &gt; fieldset &gt; div &gt; div:nth-child(2) &gt; div &gt; div'</span>);
       <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div.col_100.controls &gt; button.btn.btn-success.pull-right.submit'</span>);<font></font>
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#     <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
    <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
    sendErr++;<font></font>
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, le test peut être accéléré si vous saisissez toutes les données ne provenant pas du marionnettiste par la construction page.type en attente, mais transférez cette logique au navigateur lui-même. Mais alors la complexité des erreurs de capture augmente. Ainsi</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; fieldset.petgroup.ungroupped-attrs &gt; div &gt; div:nth-child(4) &gt; div.col-md-9.attr-data'</span>).click();
 <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; fieldset:nth-child(2) &gt; div &gt; div:nth-child(1) &gt; div.col-md-9.attr-data &gt; input'</span>).value = <span class="hljs-string">''</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours des tests, nous avons fourni plusieurs milliers d'autorisations EIES et environ 16 000 demandes envoyées. Comment a été la restauration d'un système d'information éducatif productif après un tel nombre de déclarations - ne demandez même pas. C'est une histoire complètement différente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le principal résultat visible de ce processus a été que les médias locaux s'ennuyaient maintenant à l'époque de l'inscription en première année. Le service a quitté la zone des médias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En parallèle, nous avons réalisé un tableau de bord pour suivre les performances du formulaire basé sur Grafana: le nombre d'applications, le nombre d'appels, les métriques Yandex, etc. Mais nous laisserons ce sujet pour la prochaine fois.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, je voudrais féliciter tous ceux qui sont liés au sujet de l'amélioration de la qualité de la prestation des services publics et municipaux sous forme électronique. </font><font style="vertical-align: inherit;">Ce travail de préparation sans fin n'a pas été vain - après tout, en avril et en mai, le nombre de candidatures soumises a considérablement augmenté.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502068/index.html">110 volts sur votre ordinateur</a></li>
<li><a href="../fr502070/index.html">L'histoire de Pentax (article plus vidéo)</a></li>
<li><a href="../fr502072/index.html">Amarrage de l'ISS à l'aide de JavaScript et d'une boussole</a></li>
<li><a href="../fr502076/index.html">Trolley Robot 2.0. Partie 1. Navigation autonome d'un robot domestique basé sur ROS</a></li>
<li><a href="../fr502080/index.html">Méthode Kanban: Exemple PNZ n ° 1, le processus de mesure-étude dans une startup</a></li>
<li><a href="../fr502086/index.html">Configuration de Minio pour que l'utilisateur ne puisse travailler qu'avec son bucket</a></li>
<li><a href="../fr502088/index.html">Une histoire d'excès et de temps perdu. Selon py3</a></li>
<li><a href="../fr502092/index.html">Assistance technologique et réglementaire pour les services de confiance numérique dans la Fédération de Russie</a></li>
<li><a href="../fr502098/index.html">Comment nous avons construit le B2B</a></li>
<li><a href="../fr502102/index.html">AutoML est génial et puissant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>