<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïï üîú üë∂üèª WebRTC on Android: how to enable hardware encoding on multiple devices ‚òÇÔ∏è üï° üò≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For video calls in Badoo, we use the WebRTC standard and the H.264 codec. If you believe the documentation, this codec should work without problems on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WebRTC on Android: how to enable hardware encoding on multiple devices</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/500654/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For video calls in Badoo, we use the WebRTC standard and the H.264 codec. </font><font style="vertical-align: inherit;">If you believe the documentation, this codec should work without problems on any Android device since Android 5.0. </font><font style="vertical-align: inherit;">But in practice, everything turned out to be not quite so. </font><font style="vertical-align: inherit;">In this article, I will talk about the features of implementing hardware encoding for the H.264 codec in WebRTC and how to make it work on more devices.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tu/lt/w1/tultw1tnly1q-hovglpxdkzaax8.jpeg"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why H.264?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When connected via WebRTC, all devices participating in the session transmit various communication parameters, including video and audio codecs. If devices support multiple codecs (for example, VP8 and H.264), priority codecs for the platform are listed first. This data is used at the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reconciliation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> stage </font><font style="vertical-align: inherit;">in WebRTC, after which only codecs that are supported by all devices remain. An example of such data with decryption can be seen in this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">document</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of video calls, if one of the devices does not support the H.264 codec, both devices can switch, for example, to the VP8 codec, which does not depend on the hardware implementation on the device. </font><font style="vertical-align: inherit;">But our application is available on a variety of gadgets, including smartphones from previous generations. </font><font style="vertical-align: inherit;">Therefore, for video communications, we wanted to use hardware encoding whenever possible: it reduces the load on the processor and does not eat the battery so much, which is critical for outdated gadgets. </font><font style="vertical-align: inherit;">H.264 hardware encoding support is implemented on a large number of devices, unlike the same </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VP8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H.264 support on Android</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you believe the description of support </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for multimedia formats</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , decoding H.264 Baseline Profile should work on all Android devices, and encoding - starting with Android 3.0. In Badoo, we support devices starting with Android 5.0, so we shouldn't have any problems. But it was not so simple: even in gadgets with the fifth version, we found a large number of features. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With what it can be connected? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you know, when developing a new device on Android, any manufacturer needs to pass the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compatibility Test Suite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It runs on a PC connected to the device, and its results must be sent to Google to confirm that the device meets the requirements of the Android OS of the specified version. Only after that the gadget can be released to the market. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are interested in multimedia tests in this test suite, and more specifically, video encoding and decoding tests. I decided to stop on tests </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EncodeDecodeTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DecoderTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EncoderTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as they are present on all versions of Android since 4.3. The graph of the number of lines of code in these tests looks like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/td/g_/4p/tdg_4prrdcocytay8z7df_igw0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prior to version 4.3, most of these tests simply did not exist, and their significant increase fell on versions 5 and 7. Therefore, we can say that before version Android 4.3 Google did not check the compliance of devices with its specifications for encoding and decoding video, but in version 5.0 greatly improved this check. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would seem that this indicates that starting from version 5.0 with encoding everything should be in order. But, given my previous experience with decoding streaming video on Android, I was sure that it was not. It was enough to look at the number of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">topics</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about coding in the Google group </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discuss-webrtc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebRTC source files, which are in the public domain, helped us search for pitfalls. Let's consider them in more detail.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H.264 support in WebRTC</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HardwareVideoEncoderFactory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a method with the talking name isHardwareSupportedInCurrentSdkH264:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHardwareSupportedInCurrentSdkH264</span><span class="hljs-params">(MediaCodecInfo info)</span> </span>{
  <span class="hljs-comment">// First, H264 hardware might perform poorly on this model.</span>
  <span class="hljs-keyword">if</span> (H264_HW_EXCEPTION_MODELS.contains(Build.MODEL)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<font></font>
  }<font></font>
  String name = info.getName();<font></font>
  <span class="hljs-comment">// QCOM H264 encoder is supported in KITKAT or later.</span>
  <span class="hljs-keyword">return</span> (name.startsWith(QCOM_PREFIX) &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT)
      <span class="hljs-comment">// Exynos H264 encoder is supported in LOLLIPOP or later.</span><font></font>
      || (name.startsWith(EXYNOS_PREFIX)<font></font>
             &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we can see, support for hardware encoding on Android is implemented only for Qualcomm and Exynos chipsets. Why is there no support for other chipsets in the standard WebRTC implementation? Most likely, this is due to the peculiarities of the implementation of hardware codecs manufacturers. And it‚Äôs often possible to identify these features only at production, since it is not always possible to find particular devices. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All codec descriptions on the device are stored in the media_codecs.xml file. Here, for example, is this file for the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pixel XL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and for the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HUAWEI P8 lite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . When you get a list of codecs using the getCodecInfos () method of the MediaCodecList object, this file is parsed - and the codecs stored in it are returned. This operation and the correct filling of this file by the manufacturer are covered in the CTS test.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecListTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which also increased from 160 lines of code in Android 4.3 to 740 lines in Android 10. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Badoo, we changed the isHardwareSupportedInCurrentSdkH264 method code, rejecting the ‚Äúwhite‚Äù codec list and replacing it with a ‚Äúblack‚Äù list of program codec prefixes that are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">listed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in WebRTC:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] SOFTWARE_IMPLEMENTATION_PREFIXES = {<span class="hljs-string">"OMX.google."</span>, <span class="hljs-string">"OMX.SEC."</span>};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But you can‚Äôt just take and implement support for all codecs without paying any attention to manufacturers' features. </font><font style="vertical-align: inherit;">From the names of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">topics</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devoted to hardware coding on Android in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discuss-webrtc group</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , we can understand that in this case we will definitely encounter errors. </font><font style="vertical-align: inherit;">Basically, they appear at the codec configuration stage.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec configuration options</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The initialization of the codec for encoding is as follows:</font></font><br>
<br>
<pre><code class="java hljs">MediaCodec mediaCodec = createByCodecName(codecName);<font></font>
MediaFormat format = MediaFormat.createVideoFormat(mime, width, height);<font></font>
format.setInteger(MediaFormat.KEY_BIT_RATE, targetBitrateBps);<font></font>
format.setInteger(MediaFormat.KEY_BITRATE_MODE, VIDEO_ControlRateConstant);<font></font>
format.setInteger(MediaFormat.KEY_COLOR_FORMAT, colorFormat);<font></font>
format.setInteger(MediaFormat.KEY_FRAME_RATE, targetFps);<font></font>
format.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, keyFrameIntervalSec);<font></font>
mediaCodec.configure(format, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is easy to make a mistake in some of these parameters, which will throw an exception when configuring the codec and disrupt the application. </font><font style="vertical-align: inherit;">Also, when working with a codec, you may need to adjust its bitrate depending on various factors, since the codec itself does it wrong. </font><font style="vertical-align: inherit;">For this, in WebRTC, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class is </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">responsible</font></a><font style="vertical-align: inherit;"> , which has two descendants:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DynamicBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - adjusts the bitrate depending on the amount of data</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FramerateBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - adjusts the bitrate depending on the frame rate.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accordingly, for each codec, you must choose your own bitrate adjustment mechanism. </font><font style="vertical-align: inherit;">Let us consider in more detail the features of setting the initialization parameters for hardware codecs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stream resolution</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After receiving the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecInfo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object for the codec, </font><font style="vertical-align: inherit;">you can examine the codec in more detail by getting its capabilities in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CodecCapabilities</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">From them you can find out if the codec supports the selected resolution and frame rate. </font><font style="vertical-align: inherit;">If it supports these parameters, they can be set safely. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, sometimes this rule does not work. </font><font style="vertical-align: inherit;">We are faced with the fact that codecs with the prefix ‚ÄúOMX.MARVELL.‚Äù </font><font style="vertical-align: inherit;">encoded incorrectly, showing green stripes at the edges of the screen if the resolution of the stream was different from 4: 3. </font><font style="vertical-align: inherit;">At the same time, the codec itself claimed that the selected resolution and frame rate are supported.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit rate mode</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The standard mode for all video codecs is a constant bitrate. </font><font style="vertical-align: inherit;">However, once we had to use a variable bitrate:</font></font><br>
<br>
<pre><code class="java hljs">format.setInteger(MediaFormat.KEY_BITRATE_MODE, VIDEO_ControlRateVariable);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This happened on a Lenovo A1000 device with the Spreadtrum chipset (now Unisoc) starting with the prefix ‚ÄúOMX.sprd.‚Äù. </font><font style="vertical-align: inherit;">A search on the Internet led us to a </font><font style="vertical-align: inherit;">six-year-old </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">post</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Firefox OS that describes this problem and how to solve it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Color format</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When using the codec in byte-buffer mode, you must select the correct format. </font><font style="vertical-align: inherit;">This is usually done using a function of the following form:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Nullable</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> Integer <span class="hljs-title">selectColorFormat</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] supportedColorFormats, CodecCapabilities capabilities)</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> supportedColorFormat : supportedColorFormats) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> codecColorFormat : capabilities.colorFormats) {
      <span class="hljs-keyword">if</span> (codecColorFormat == supportedColorFormat) {
        <span class="hljs-keyword">return</span> codecColorFormat;<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Roughly speaking, the first of the supported color formats is always selected. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, in the case of HUAWEI codecs starting with the prefixes "OMX.IMG.TOPAZ.", "OMX.hisi." </font><font style="vertical-align: inherit;">and ‚ÄúOMX.k3.‚Äù, it didn‚Äôt work, and after a long search we found a solution: no matter what format these codecs return, you need to use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLOR_FormatYUV420SemiPlanar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> format </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">thread</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> helped us to </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;">figure this out</font></a><font style="vertical-align: inherit;"> in one Chinese forum.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bitrate Adjustment</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The standard WebRTC code contains the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">following</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> BitrateAdjuster <span class="hljs-title">createBitrateAdjuster</span><span class="hljs-params">(VideoCodecMimeType type, String codecName)</span> </span>{
  <span class="hljs-keyword">if</span> (codecName.startsWith(EXYNOS_PREFIX)) {
    <span class="hljs-keyword">if</span> (type == VideoCodecMimeType.VP8) {
        <span class="hljs-comment">// Exynos VP8 encoders need dynamic bitrate adjustment.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DynamicBitrateAdjuster();<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Exynos VP9 and H264 encoders need framerate-based bitrate adjustment.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FramerateBitrateAdjuster();<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-comment">// Other codecs don't need bitrate adjustment.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BaseBitrateAdjuster();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see from this code, for all chipsets except Exynos, bitrate adjustment is turned off. But this applies only to Qualcomm, since only Exynos and Qualcomm are supported in the standard code. Experimenting with various values ‚Äã‚Äãof this setting, as well as searching the Internet, we found out that for codecs with prefixes ‚ÄúOMX.MTK.‚Äù it also needs to be turned on. It is also necessary to do this for HUAWEI codecs starting with the prefix "OMX.IMG.TOPAZ.", "OMX.hisi." or "OMX.k3.". This is due to the fact that these codecs do not use timestamps of frames to adjust the bitrate, assuming that all frames come with the same frequency set when configuring the codec.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In conclusion, I will give a list of codecs that we received for devices on Android 5.0 and 5.1. </font><font style="vertical-align: inherit;">They were of interest to us primarily because on newer versions of Android the situation is improving and non-standard codecs are becoming smaller. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This can be seen in the graph below. </font><font style="vertical-align: inherit;">The logarithmic scale to better show rare cases. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/ng/ws/lengwsark1w8mgc0jmg95pptv_k.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we can see, most devices had Spreadtrum, MediaTek, HUAWEI and MARVELL chipsets - therefore, our changes helped enable hardware encoding on these gadgets.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Result</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although we assumed that some devices would have problems working with H.264, Android was again able to surprise us. As we can see from Badoo user statistics, there are still quite a few devices in the hands of users in 2014-2016, which they do not want or cannot update. And although the situation with the release of Android updates for new devices is already much better than a few years ago, the proportion of previous generation gadgets is declining quite slowly and will have to be maintained for quite some time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now WebRTC is being actively developed by Google due to its use in the Stadia project (here's the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with details on this topic), so it will become better and better and, most likely, will become the standard for implementing video communications. </font><font style="vertical-align: inherit;">I hope that this article will help you understand the features of working with H.264 in WebRTC and use it in your projects.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500640/index.html">How to make a successful outsourcing company</a></li>
<li><a href="../en500642/index.html">Igrostroy: threshold for entering the industry, specialties and possible income</a></li>
<li><a href="../en500644/index.html">Random Coffee Habr Edition - networking for the IT community</a></li>
<li><a href="../en500646/index.html">Cooking bytecode in the JVM kitchen</a></li>
<li><a href="../en500648/index.html">What is an architectural model of company maturity?</a></li>
<li><a href="../en500656/index.html">Hierarchical logging of the application to the database</a></li>
<li><a href="../en500660/index.html">A simplified and very short history of the development of "clouds"</a></li>
<li><a href="../en500666/index.html">Microsoft online certification - you, your space, and your computer</a></li>
<li><a href="../en500668/index.html">Wireless motor control from Lego using Steam Controller</a></li>
<li><a href="../en500670/index.html">How we create our product. Part One, Research</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>