<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüíª üìÉ üöæ L'√©tude d'un malveillant üôéüèº ü§∏üèΩ üíÜüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je suis tomb√© sur un fichier doc r√©cemment malveillant qui a √©t√© envoy√© avec des e-mails de phishing. J'ai d√©cid√© que c'√©tait une bonne raison de prat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>L'√©tude d'un malveillant</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489020/"><img src="https://habrastorage.org/webt/ee/hd/a7/eehda7mpejjegq4jc2me1nvupy4.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suis tomb√© sur un fichier doc r√©cemment malveillant qui a √©t√© envoy√© avec des e-mails de phishing. </font><font style="vertical-align: inherit;">J'ai d√©cid√© que c'√©tait une bonne raison de pratiquer l'ing√©nierie inverse et d'√©crire quelque chose de nouveau sur Habr. </font><font style="vertical-align: inherit;">Under the cat - un exemple d'analyse d'un compte-gouttes de macro malveillant et non moins de DLL malveillantes.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Macro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sha256 du fichier - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abb052d9b0660f90bcf5fc394db0e16d6edd29f41224f8053ed90a4b8ef1b519</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans le fichier doc lui-m√™me, sur la premi√®re page, il y a une image informant que ce fichier est prot√©g√© et expliquant comment activer les macros; il y a deux grands tableaux avec des nombres dans le fichier. Les nombres sont √©crits sous forme d√©cimale, les plus longs sont √† dix chiffres, ils sont √† la fois positifs et n√©gatifs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la victime autorise l'ex√©cution de macros (il y a ceux qui l'ont activ√© par d√©faut?), Une cha√Æne d'actions est lanc√©e, qui ex√©cute finalement la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui change le r√©pertoire actuel en un r√©pertoire temporaire et y cr√©e le fichier "icutils.dll", dans lequel il √©crit les nombres de la premi√®re table cons√©cutive sous la forme d'un entier 32 bits avec un signe. </font><font style="vertical-align: inherit;">Le r√©sultat est la bonne DLL. </font><font style="vertical-align: inherit;">La fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est import√©e de cette dll </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="vbscript hljs">Declare PtrSafe <span class="hljs-keyword">Function</span> clone Lib <span class="hljs-string">"icutils.dll"</span> _<font></font>
(<span class="hljs-keyword">ByVal</span> Saved As <span class="hljs-built_in">String</span>, <span class="hljs-keyword">ByVal</span> <span class="hljs-built_in">Time</span> As Integer) As Boolean</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et cela commence par deux param√®tres:</font></font><br>
<br>
<pre><code class="vbscript hljs">R1 = Module1.clone(<span class="hljs-string">"Cream"</span>, <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si l'appel de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoie False, le fichier icutils.dll est remplac√© par les donn√©es de la deuxi√®me table et le clone avec les m√™mes param√®tres est appel√© √† nouveau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'avenir, je dirai que la premi√®re dll est en 64 bits et ne fonctionnera pas sur les syst√®mes 32 bits. </font><font style="vertical-align: inherit;">Ainsi, la macro s√©lectionne l'architecture de code binaire correcte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fait int√©ressant, la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a un morceau de code qui n'a aucun objectif fonctionnel:</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">Sub</span> updatedb_network()<font></font>
...<font></font>
<span class="hljs-keyword">Dim</span> query_to_change As Variant
    <span class="hljs-keyword">Set</span> query_to_change = CurrentDb.QueryDefs(<span class="hljs-string">"query_name"</span>)<font></font>
    <font></font>
    query_to_change.SQL = <span class="hljs-string">"SELECT * FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE Fashion"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE '"</span> &amp; something &amp; <span class="hljs-string">"'"</span><font></font>
...<font></font>
<span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre qu'il est l√† pour donner l'apparence d'un travail utile √† ceux qui feuilletent rapidement le code, voient quelques lignes en SQL et pensent que tout va bien? </font><font style="vertical-align: inherit;">Je ne sais pas. </font><font style="vertical-align: inherit;">De plus, la plupart des fonctions et des variables ont des noms al√©atoires ou non r√©els (tels que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui n'interagit pas avec la base de donn√©es ou le r√©seau). </font><font style="vertical-align: inherit;">Bien qu'il existe, par exemple, la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dump_payload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui stocke 4 octets dans icutil.dll. </font><font style="vertical-align: inherit;">Mais dans tous les cas, la pr√©sence de la fonction </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Document_Open</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devrait imm√©diatement alerter </font><font style="vertical-align: inherit;">, les auteurs du malware ne peuvent pas le renommer arbitrairement (bien qu'ils puissent utiliser √† la place une autre fonction lanc√©e automatiquement). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la fonctionnalit√© de macro est plus ou moins claire, il est temps de d√©charger la DLL et de proc√©der √† leur analyse.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premi√®re dll</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re dll (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7427cc4b6b659b89552bf727aed332043f4551ca2ee2126cca75fbe1ab8bf114</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 64 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La liste des fonctions import√©es contient les fonctions </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (d√©marrage du programme), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (cr√©ation d'un thread dans </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un autre</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processus), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (allocation d'un bloc de m√©moire dans </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un autre</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processus), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (√©criture dans la m√©moire d' </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un autre</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processus), ce qui sugg√®re imm√©diatement l'injection de code dans un autre processus. Voyons maintenant ce qu'elle fait exactement avec IDA Free et Ghidra.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le point d'entr√©e principal renvoie simplement 1, ne fait rien d'autre. La deuxi√®me fonction export√©e est clone, qui est appel√©e par la macro et contient du code malveillant. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les param√®tres avec lesquels il est appel√© ne semblent rien affecter. L'application d√©chiffre deux blocs de donn√©es. Le premier bloc de donn√©es 0x78 avec le contenu suivant (d√©j√† d√©chiffr√©):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d&lt;\x04\xe0\x1d\xe6\x00\xde\x01\xa4\x17\xbc\x03x\x01\xe0\x1d\xe2\x16x\x07Qy\xbc\x03@Fx\x07Df\xbc\x03\x89a\xde\x01q\x11\xe0\x1d|Ix\x07D@\xbc\x03\x8a\x01\xde\x01^9\xde\x01\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d\xab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxi√®me bloc de donn√©es a une longueur de 0x1D4C et contient du code ex√©cutable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, un pointeur vers le module kernel32, le r√©sultat de la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTickCount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () et l'adresse de la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwDelayExecution</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () de kernel32 sont </font><font style="vertical-align: inherit;">√©crits dans la structure d'octets 0x90 </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, le processus ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ¬´cmd.exe¬ª est cr√©√©. En utilisant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , deux tampons y sont allou√©s: avec des autorisations RW d'une longueur de 0x108 et avec des autorisations RWX d'une longueur de 0x1D4C. Le tampon RW copie le bloc de donn√©es ci-dessus et la structure susmentionn√©e avec une longueur de 0x90. La structure √©crit √©galement un pointeur sur le bloc de donn√©es d√©chiffr√© (dans l'espace d'adressage du processus enfant (cmd.exe)). Dans RWX, le tampon est copi√© ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) bloc de donn√©es d√©chiffr√© avec code. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, dans le processus cmd.exe, un flux ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) est cr√©√© avec un point d'entr√©e au d√©but du tampon RWX, un pointeur vers le tampon RW est pass√© en argument. </font><font style="vertical-align: inherit;">Ceci termine la fonction de clonage, l'action se poursuit dans le processus cmd.exe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fait int√©ressant, la fonction de clonage semble √™tre comme un morceau de code inaccessible qui importe ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibraryW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) la biblioth√®que " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WorkPolyhistor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code inject√© dans cmd.exe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il effectue les actions suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trouve les adresses des fonctions n√©cessaires √† partir de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel32.dll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (son adresse est obtenue √† partir du processus parent)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">charge les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biblioth√®ques ntdll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ole32</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User32</font></font></i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherche les adresses des fonctions n√©cessaires dans ces biblioth√®ques.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est int√©ressant de noter que pour la plupart des fonctions du code, il n'y a pas de nom de fonction, mais uniquement CRC32 au nom de (tous les noms de fonction de la biblioth√®que charg√©e sont recherch√©s jusqu'√† ce qu'il y ait une fonction avec le CRC32 souhait√© au nom de). </font><font style="vertical-align: inherit;">Il s'agit peut-√™tre d'une protection contre l'obtention de la liste des fonctions import√©es par l'utilitaire de cha√Ænes, bien qu'il soit √©trange que le code stock√© sous forme crypt√©e dispose d'une telle protection, tandis que la DLL elle-m√™me importe les fonctions simplement par nom. </font><font style="vertical-align: inherit;">Au total, les fonctions suivantes sont d√©tect√©es: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kernel32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetProcAddress</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Biblioth√®que de chargement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalalloc</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetTempPath </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetFileAttributesW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateProcessW </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalfree </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GlobalRealloc </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fichier d'√©criture</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateFileW (trouv√© par son nom)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fichier d'√©criture</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Closehandle</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gettickcount</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ReadFile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetfileSize</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntdll:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RtlCreateUnicodeStringFromAsciiz</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwDelayExecution</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwTerminateProcess</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> swprintf</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ole32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoInitialize (trouv√© par son nom)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoCreateInstance (trouv√© par son nom)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
msvcrt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rand</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> srand</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, le processus utilisant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTempPath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> obtient le chemin d'acc√®s au r√©pertoire temporaire, y cr√©e un fichier avec un nom de la forme 26342235.dat, o√π le nom de fichier est l'enregistrement d√©cimal de TickCount re√ßu du processus parent et it√®re √† chaque nouvelle tentative (c'est-√†-dire s'il n'√©tait pas possible de t√©l√©charger la charge utile √† la premi√®re tentative, puis √† la deuxi√®me tentative, un fichier sera cr√©√© avec le nom 26342236.dat). </font><font style="vertical-align: inherit;">Apr√®s cela, la biblioth√®que wininet est charg√©e et il existe des pointeurs vers les fonctions suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetCloseHandle (crc32: 0xe5191d24)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState (crc32: 0xf2e5fc0c)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenA (crc32: 0xda16a83d)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenUrlA (crc32: 0x16505e0)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetReadFile (crc32: 0x6cc098f5)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState, il</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> v√©rifie s'il y a un r√©seau, sinon, l'application appelle la fonction √† une adresse inexistante et se bloque (une telle protection contre la d√©termination de l'adresse d'o√π la charge utile est obtenue en utilisant une machine isol√©e du r√©seau. C'est le seul cas o√π l'application se termine anormalement, dans le reste 3 tentatives sont faites , apr√®s quoi cmd.exe se termine √† l'aide de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). S'il existe un r√©seau, √† l'aide des fonctions trouv√©es, la charge utile est t√©l√©charg√©e √† partir de l'URL transmise par le processus parent (https://pastebin.com/raw/Jyujxy7z) et enregistr√©e dans le fichier cr√©√© pr√©c√©demment avec l'extension .dat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, la charge utile est lue √† partir du fichier .dat, d√©cod√©e (base64), d√©crypt√©e √† l'aide de XOR avec CRC32 √† partir de l'URL, v√©rifiez que les 2 premiers octets des donn√©es d√©crypt√©es sont 'MZ', si c'est le cas, le r√©sultat est enregistr√© dans un fichier avec le m√™me nom mais l'extension. EXE</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code de d√©chiffrement Python</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> crc32
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_payload</span>(<span class="hljs-params">payload_b64: bytes, url: str</span>):</span><font></font>
    payload_bin = b64decode(payload_b64.decode())<font></font>
    key = str(crc32(url.encode())).encode()<font></font>
    decrypted = bytearray()<font></font>
    <span class="hljs-keyword">for</span> i, b <span class="hljs-keyword">in</span> enumerate(payload_bin):<font></font>
        decrypted.append(b ^ key[i % len(key)])<font></font>
    <span class="hljs-keyword">return</span> bytes(decrypted)
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä l'aide de la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le </font><font style="vertical-align: inherit;">fichier enregistr√© est lanc√©. </font><font style="vertical-align: inherit;">Si tout se passe bien, le processus cmd.exe se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ferme √† l'</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aide de </font><i><font style="vertical-align: inherit;">ZwTerminateProcess</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si quelque chose ne va pas (sauf pour l'absence de r√©seau), alors tout est r√©p√©t√© √† nouveau, un maximum de 3 tentatives sont faites, les noms des fichiers dat et exe sont augment√©s de 1 √† chaque fois.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxi√®me dll</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me dll (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">006200fcd7cd1e71be6c2ee029c767e3a28f480613e077bf15fadb60a88fdfca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 32 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce document, la principale fonctionnalit√© malveillante est impl√©ment√©e dans la fonction de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clonage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il d√©chiffre √©galement 2 tampons. </font><font style="vertical-align: inherit;">Le premier tampon a une taille de 0x78 (120) octets, ces donn√©es sont d√©chiffr√©es et √©crites dessus (sous forme d√©chiffr√©e):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\x1e(\xf0\x0e\xc5r\xc0;\x12)\xc0;Jr\xc0;Y4\xbc\x03/Mx\x07\x038\xde\x01\x9e\x05\xe0\x1d#\x08\xbc\x03\xeeU\xf0\x0e\x18{x\x078\x1a\xf0\x0e\xccg\xf0\x0eze\xde\x01\x89&amp;\xe0\x1d\xf6\x1f\xe0\x1d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut voir qu'au d√©but c'est la m√™me URL que dans la version x64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un deuxi√®me tampon de taille 0x4678 octets est allou√© avec des autorisations RWX. </font><font style="vertical-align: inherit;">Le code y est d√©crypt√©, apr√®s quoi une fonction est appel√©e √† partir de celui-ci avec un d√©calage de 0x4639 depuis le d√©but du tampon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas analys√© ce code en d√©tail. </font><font style="vertical-align: inherit;">Il trouve √©galement des fonctions sur CRC32, lance notepad.exe, y injecte du code qui t√©l√©charge la charge utile √† partir de la m√™me URL sur pastebin.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charge utile avec pastebin</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La charge utile d√©crypt√©e avec pastebin est un fichier exe 32 bits (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9509111de52db3d9a6c06aa2068e14e0128b31e9e45ada7a8936a35ddfaf155f</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) Je ne l'ai pas encore d√©mont√© en d√©tail par manque de temps.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, le malware m'a impressionn√© assez mal √©crit, avec beaucoup d'erreurs (je ne les appelle pas ici intentionnellement). </font><font style="vertical-align: inherit;">Comme s'ils fouettaient. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dll trouve dans la m√©moire des fonctions qui ne seront ensuite utilis√©es nulle part. </font><font style="vertical-align: inherit;">Peut-√™tre que ce code, comme une macro, est r√©guli√®rement r√©√©crit par des cybercriminels chaque fois qu'il commence √† √™tre d√©tect√© par des antivirus, √† la suite de quoi de tels artefacts restent dans le code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est √©galement int√©ressant de noter que dans la version ¬´dll¬ª de la dll ¬´d√©pos√©e¬ª sur le disque x64, les noms des fonctions import√©es ¬´dangereuses¬ª ne sont pas masqu√©s (vous pouvez au moins les voir sous forme de cha√Ænes), et dans le code qui est d√©chiffr√© en m√©moire et ne tient pas sur le disque, ils sont situ√©s sur CRC32 √† partir de nom, pas seulement par son nom. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La charge utile pastebin a √©t√© supprim√©e quelques jours plus tard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KDPV pris d'ici</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489008/index.html">Routage dans des chatbots complexes avec le framework Hobot</a></li>
<li><a href="../fr489010/index.html">Nous partageons la plus grande couche de donn√©es en Russie sur la formation en ligne avec des projets en linguistique, personnalisation, conception graphique, ML</a></li>
<li><a href="../fr489012/index.html">Google Cloud Spanner: bon, mauvais, mal</a></li>
<li><a href="../fr489014/index.html">Le livre ¬´Algorithme parfait. Algorithmes gourmands et programmation dynamique ¬ª</a></li>
<li><a href="../fr489016/index.html">Gref allemand: ¬´Nous avons essay√© d'organiser une discussion sur l'AGI, et pas un seul scientifique qui se respecte n'est venu √† lui¬ª</a></li>
<li><a href="../fr489022/index.html">Utilisation de RabbitMQ avec MonsterMQ Partie 2</a></li>
<li><a href="../fr489024/index.html">Biblioth√®que JavaScript Webix vue par un d√©butant. Partie 5. Travailler avec des donn√©es c√¥t√© utilisateur</a></li>
<li><a href="../fr489026/index.html">La modification des algorithmes Google AdSense peut conduire les propri√©taires de sites et les webmasters</a></li>
<li><a href="../fr489028/index.html">√Ä propos du travail √† distance</a></li>
<li><a href="../fr489034/index.html">La nouvelle application mobile de l'ISU pour le salut ou le salut pour ceux qui cherchent des march√©s publics?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>