<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😍 🥣 👩🏽‍⚖️ So erstellen Sie einen Raketenbeschleuniger für PowerCLI-Skripte  👩🏾‍🍳 🍔 🐢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Früher oder später kann jeder VMware-Systemadministrator Routineaufgaben automatisieren. Alles beginnt über die Befehlszeile, dann kommt PowerShell od...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>So erstellen Sie einen Raketenbeschleuniger für PowerCLI-Skripte </h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/498628/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Früher oder später kann jeder VMware-Systemadministrator Routineaufgaben automatisieren. </font><font style="vertical-align: inherit;">Alles beginnt über die Befehlszeile, dann kommt PowerShell oder VMware PowerCLI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, Sie beherrschen PowerShell etwas weiter als das Starten von ISE und die Verwendung von Standard-Cmdlets aus Modulen, die mit einer Art Magie arbeiten. </font><font style="vertical-align: inherit;">Wenn Sie anfangen, Hunderte von virtuellen Maschinen zu zählen, werden Sie feststellen, dass Skripte, die in kleinen Maßstäben geholfen haben, in großen deutlich langsamer arbeiten.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser Situation helfen 2 Tools:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell Runspaces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ein Ansatz, mit dem Sie die Ausführung von Prozessen in separaten Threads parallelisieren können.&nbsp;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get-View</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist eine grundlegende PowerCLI-Funktion, ein Analogon zu Get-WMIObject unter Windows. </font><font style="vertical-align: inherit;">Dieses Cmdlet zieht keine damit verbundenen Objekte, sondern empfängt Informationen in Form eines einfachen Objekts mit einfachen Datentypen. </font><font style="vertical-align: inherit;">In vielen Fällen kommt es schneller heraus.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als nächstes werde ich kurz auf jedes Tool eingehen und Anwendungsbeispiele zeigen. </font><font style="vertical-align: inherit;">Wir werden bestimmte Skripte analysieren und sehen, wann eines am besten funktioniert, wann das zweite. </font><font style="vertical-align: inherit;">Gehen!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/2q/fe/xp2qfe2m-lyc8feedka2nyhc2sq.jpeg"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erste Stufe: Runspace</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher ist Runspace für die parallele Verarbeitung von Aufgaben außerhalb des Hauptmoduls ausgelegt. </font><font style="vertical-align: inherit;">Natürlich können Sie einen anderen Prozess starten, der Speicher, Prozessor usw. verbraucht. Wenn Ihr Skript in wenigen Minuten ausgeführt wird und ein Gigabyte Speicher verbraucht, benötigen Sie wahrscheinlich keinen Runspace. </font><font style="vertical-align: inherit;">Aber für Skripte auf Zehntausenden von Objekten wird es benötigt.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können die Entwicklung hier starten:&nbsp; </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginn der Verwendung von PowerShell-Runspaces: Teil 1</font></font></a></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was nutzt Runspace:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geschwindigkeit durch Begrenzung der Liste der ausführbaren Befehle,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parallele Aufgaben</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sicherheit.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist ein Beispiel aus dem Internet, wenn Runspace hilft:</font></font><br>
<blockquote>«    –   ,     vSphere.  vCenter     ,      .  ,        PowerShell.<br>
 ,     VMware      vCenter          .&nbsp;&nbsp;<br>
  PowerShell runspaces,    ESXi          Runspace     .   PowerShell   ,        ,     ». <br>
<br>
<i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">How to Show Virtual Machine I/O on an ESXi Dashboard</a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im folgenden Fall ist Runspace nicht mehr im Geschäft:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„Ich versuche, ein Skript zu schreiben, das viele Daten von der VM sammelt und bei Bedarf neue Daten schreibt. </font><font style="vertical-align: inherit;">Das Problem ist, dass es viele VMs gibt und es für einen Computer 5-8 Sekunden dauert. “&nbsp;</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelle: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multithreading PowerCLI mit RunspacePool</font></font></a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View wird hier benötigt, fahren wir fort.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zweite Stufe: Get-View</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie daran, wie Cmdlets im Allgemeinen funktionieren, um die Nützlichkeit von Get-View zu verstehen.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cmdlets werden benötigt, um bequem Informationen zu erhalten, ohne API-Nachschlagewerke studieren und das Rad neu erfinden zu müssen. Was früher in hundert oder zwei Codezeilen geschrieben wurde, ermöglicht PowerShell, einen Befehl auszuführen. Für diese Bequemlichkeit zahlen wir Geschwindigkeit. In den Cmdlets selbst gibt es keine Magie: das gleiche Skript, aber auf einer niedrigeren Ebene, geschrieben von den erfahrenen Händen eines Meisters aus dem sonnigen Indien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nehmen Sie zum Vergleich mit Get-View das Cmdlet Get-VM: Es greift auf die virtuelle Maschine zu und gibt ein zusammengesetztes Objekt zurück, dh es werden andere verwandte Objekte daran angehängt: VMHost, Datenspeicher usw.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View an seiner Stelle schraubt nichts extra in das zurückgegebene Objekt. </font><font style="vertical-align: inherit;">Darüber hinaus können Sie genau angeben, welche Informationen wir benötigen, was das Objekt an der Ausgabe erleichtert. </font><font style="vertical-align: inherit;">In Windows Server im Allgemeinen und in Hyper-V im Besonderen ist das Cmdlet Get-WMIObject ein direktes Analogon - die Idee ist genau dieselbe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View ist bei Routineoperationen mit Punktfunktionen unpraktisch. </font><font style="vertical-align: inherit;">Aber wenn es um Tausende und Zehntausende von Objekten geht, hat er keinen Preis.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Weitere Informationen finden Sie im VMware-Blog: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einführung in Get-View</font></font></a></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt zeige ich alles an einem realen Fall.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir schreiben ein Skript zum Entladen einer VM</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einmal bat mich mein Kollege, sein Skript zu optimieren. </font><font style="vertical-align: inherit;">Die Aufgabe ist eine normale Routine: Suchen Sie alle VMs mit einem doppelten Parameter cloud.uuid (ja, dies ist möglich, wenn Sie eine VM in vCloud Director klonen).&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die offensichtliche Lösung, die mir in den Sinn kommt:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Holen Sie sich eine Liste aller VMs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analysiere irgendwie die Liste.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Originalversion war so ein einfaches Skript:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-CloudUUID1</span></span> {
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vms</span> = <span class="hljs-built_in">Get-VM</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   ,     2 :    Cloud UUID.</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     PS-   VM  UUID</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vm</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vms</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span> = <span class="hljs-string">""</span> | <span class="hljs-built_in">select</span> VM,UUID<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span>.VM = <span class="hljs-variable">$vm</span>.name
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span>.UUID = (<span class="hljs-variable">$vm</span> | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> cloud.uuid).Value<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span> += <span class="hljs-variable">$table</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<span class="hljs-comment">#   </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span><font></font>
}<font></font>
<span class="hljs-comment">#     </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles ist sehr einfach und klar. Es ist in ein paar Minuten mit einer Kaffeepause geschrieben. Schrauben Sie den Filter an und fertig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber messen Sie die Zeit: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iz/xb/i-/izxbi-_-xo9odcuouzqan83vd1o.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/kv/xy/fb/kvxyfb7lj5asvvkm3nuebjljcx0.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 Minuten 47 Sekunden,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wenn Sie fast 10.000 VM verarbeiten. Ein Bonus ist das Fehlen von Filtern und die Notwendigkeit, das Ergebnis manuell zu sortieren. Offensichtlich fordert das Skript eine Optimierung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ransepses sind die ersten, die Abhilfe schaffen, wenn Sie Host-Metriken gleichzeitig mit vCenter abrufen oder Zehntausende von Objekten verarbeiten müssen. Mal sehen, was dieser Ansatz geben wird. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir aktivieren die erste Geschwindigkeit: PowerShell Runspaces</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Das erste, was </font><b><font style="vertical-align: inherit;">Ihnen</font></b><font style="vertical-align: inherit;"> bei diesem Skript einfällt, ist: </font><b><font style="vertical-align: inherit;">Um</font></b><font style="vertical-align: inherit;"> die Schleife nicht in Reihe, sondern in parallelen Threads auszuführen, sammeln Sie alle Daten in einem Objekt und filtern Sie sie.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt jedoch ein Problem: Mit PowerCLI können wir nicht viele unabhängige Sitzungen für vCenter öffnen und es wird ein lustiger Fehler ausgegeben:</font></font><br>
<br>
<pre><code class="plaintext hljs">You have modified the global:DefaultVIServer and global:DefaultVIServers system variables. This is not allowed. Please reset them to $null and reconnect to the vSphere server.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dies zu lösen, müssen Sie zuerst Sitzungsinformationen an den Stream übergeben. </font><font style="vertical-align: inherit;">Wir erinnern uns, dass PowerShell mit Objekten arbeitet, die als Parameter an mindestens eine Funktion, zumindest an ScriptBlock, übergeben werden können. </font><font style="vertical-align: inherit;">Übergeben wir die Sitzung als solches Objekt unter Umgehung von $ global: DefaultVIServers (Connect-VIServer mit dem Schlüssel -NotDefault):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$ConnectionString</span> = <span class="hljs-selector-tag">@</span>()
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vCenter</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vCenters</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-AllLinked</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (<span class="hljs-variable">$er</span>.Message <span class="hljs-operator">-like</span> <span class="hljs-string">"*not part of a linked mode*"</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt implementieren wir Multithreading durch Runspace-Pools.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Algorithmus ist wie folgt:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Holen Sie sich eine Liste aller VMs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In parallelen Threads erhalten wir cloud.uuid.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir sammeln Daten aus Streams in einem Objekt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir filtern das Objekt durch Gruppierung nach dem Wert des CloudUUID-Felds: diejenigen, bei denen die Anzahl der eindeutigen Werte mehr als 1 beträgt und die gewünschten VMs vorhanden sind.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis erhalten wir das Skript:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-VMCloudUUID</span></span> {
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">param</span> (<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">string</span>[]]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">ValidateNotNullOrEmpty</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vCenters</span> = <span class="hljs-selector-tag">@</span>(),<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$MaxThreads</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.PSCredential</span>]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.Credential</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span><font></font>
&nbsp;&nbsp;&nbsp;)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vCenter</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vCenters</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-AllLinked</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (<span class="hljs-variable">$er</span>.Message <span class="hljs-operator">-like</span> <span class="hljs-string">"*not part of a linked mode*"</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Global:AllVMs</span> = <span class="hljs-built_in">Get-VM</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># !</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ISS</span> = [<span class="hljs-type">system.management.automation.runspaces.initialsessionstate</span>]::CreateDefault()
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span> = [<span class="hljs-type">runspacefactory</span>]::CreateRunspacePool(<span class="hljs-number">1</span>, <span class="hljs-variable">$MaxThreads</span>, <span class="hljs-variable">$ISS</span>, <span class="hljs-variable">$Host</span>)
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.ApartmentState = <span class="hljs-string">"MTA"</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Open()
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Jobs</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
<span class="hljs-comment"># ScriptBlock  !)))</span>
<span class="hljs-comment">#      </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$scriptblock</span> = {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">Param</span> (
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$VM</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Data</span> = <span class="hljs-variable">$VM</span> | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> Cloud.uuid <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Entity.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={<span class="hljs-variable">$_</span>.Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.Entity.PowerState}}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> <span class="hljs-variable">$Data</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<span class="hljs-comment">#  </span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$VM</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$AllVMs</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$PowershellThread</span> = [<span class="hljs-type">PowerShell</span>]::Create()
<span class="hljs-comment">#  </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddScript(<span class="hljs-variable">$scriptblock</span>)
<span class="hljs-comment">#  ,      </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddArgument(<span class="hljs-variable">$ConnectionString</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddArgument(<span class="hljs-variable">$VM</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$PowershellThread</span>.RunspacePool = <span class="hljs-variable">$RunspacePool</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Handle</span> = <span class="hljs-variable">$PowershellThread</span>.BeginInvoke()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span> = <span class="hljs-string">""</span> | <span class="hljs-built_in">Select-Object</span> Handle, Thread, object
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Handle = <span class="hljs-variable">$Handle</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread = <span class="hljs-variable">$PowershellThread</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Object = <span class="hljs-variable">$VM</span>.ToString()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Jobs</span> += <span class="hljs-variable">$Job</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment">#      </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">While</span> (<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle <span class="hljs-operator">-ne</span> <span class="hljs-variable">$Null</span>}).count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Remaining</span> = <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | Where-Object {<span class="hljs-variable">$_</span>.Handle.IsCompleted -eq <span class="hljs-variable">$False</span>}).object)"</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">If</span> (<span class="hljs-variable">$Remaining</span>.Length <span class="hljs-operator">-gt</span> <span class="hljs-number">60</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Remaining</span> = <span class="hljs-variable">$Remaining</span>.Substring(<span class="hljs-number">0</span>,<span class="hljs-number">60</span>) + <span class="hljs-string">"..."</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">Write-Progress</span> <span class="hljs-literal">-Activity</span> <span class="hljs-string">"Waiting for Jobs - <span class="hljs-variable">$</span>(<span class="hljs-variable">$MaxThreads</span> - <span class="hljs-variable">$</span>(<span class="hljs-variable">$RunspacePool</span>.GetAvailableRunspaces())) of <span class="hljs-variable">$MaxThreads</span> threads running"</span> <span class="hljs-literal">-PercentComplete</span> ((<span class="hljs-variable">$Jobs</span>.count - <span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle.IsCompleted <span class="hljs-operator">-eq</span> <span class="hljs-variable">$False</span>}).count)) / <span class="hljs-variable">$Jobs</span>.Count * <span class="hljs-number">100</span>) <span class="hljs-literal">-Status</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(@(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | Where-Object {<span class="hljs-variable">$_</span>.Handle.IsCompleted -eq <span class="hljs-variable">$False</span>})).count) remaining - <span class="hljs-variable">$remaining</span>"</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ForEach</span> (<span class="hljs-variable">$Job</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle.IsCompleted <span class="hljs-operator">-eq</span> <span class="hljs-variable">$True</span>})){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread.EndInvoke(<span class="hljs-variable">$Job</span>.Handle)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread.Dispose()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread = <span class="hljs-variable">$Null</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Handle = <span class="hljs-variable">$Null</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Close() | <span class="hljs-built_in">Out-Null</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Dispose() | <span class="hljs-built_in">Out-Null</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-CloudUUID2</span></span><font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">param</span>(<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">string</span>[]]<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">ValidateNotNullOrEmpty</span>()]
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vCenters</span> = <span class="hljs-selector-tag">@</span>(),<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$MaxThreads</span> = <span class="hljs-number">50</span>,<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.PSCredential</span>]<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.Credential</span>()]
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span>)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>(!<span class="hljs-variable">$Credential</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span> = <span class="hljs-built_in">Get-Credential</span> <span class="hljs-literal">-Message</span> <span class="hljs-string">"Please enter vCenter credentials."</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   Get-VMCloudUUID,    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$AllCloudVMs</span> = <span class="hljs-built_in">Get-VMCloudUUID</span> <span class="hljs-literal">-vCenters</span> <span class="hljs-variable">$vCenters</span> <span class="hljs-literal">-MaxThreads</span> <span class="hljs-variable">$MaxThreads</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Result</span> = <span class="hljs-variable">$AllCloudVMs</span> | <span class="hljs-built_in">Sort-Object</span> Value | <span class="hljs-built_in">Group-Object</span> <span class="hljs-literal">-Property</span> CloudUUID | <span class="hljs-built_in">Where-Object</span> <span class="hljs-literal">-FilterScript</span> {<span class="hljs-variable">$_</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">1</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> <span class="hljs-built_in">Group</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Result</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Schöne an diesem Skript ist, dass es in anderen ähnlichen Fällen verwendet werden kann, indem einfach der ScriptBlock und die Parameter ersetzt werden, die an den Stream übergeben werden. Nutze es aus! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir messen die Zeit: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d_/hr/ji/d_hrjiq58scxnha1wiknf9jd1zw.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">55 Sekunden.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schon besser, aber immer noch schneller.&nbsp; </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir gehen zur zweiten Geschwindigkeit über: GetView</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wir finden heraus, was falsch ist. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstens und offensichtlich: Die Fertigstellung des Cmdlets Get-VM dauert lange. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweitens: Das Cmdlet Get-AdvancedOptions wird noch länger ausgeführt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns zuerst den zweiten behandeln.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-AdvancedOptions ist praktisch für einzelne VM-Objekte, jedoch sehr langsam, wenn mit vielen Objekten gearbeitet wird. </font><font style="vertical-align: inherit;">Wir können die gleichen Informationen vom Objekt der virtuellen Maschine selbst (Get-VM) erhalten. </font><font style="vertical-align: inherit;">Es ist nur so, dass es gut im ExtensionData-Objekt vergraben ist. </font><font style="vertical-align: inherit;">Mit Filterung beschleunigen wir den Prozess des Abrufs der erforderlichen Daten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit einem Handgriff ist dies:</font></font><br>
<br>
<pre><code class="powershell hljs">
VM | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> Cloud.uuid <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Entity.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={<span class="hljs-variable">$_</span>.Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.Entity.PowerState}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wird daraus:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-variable">$VM</span> | <span class="hljs-built_in">Where-Object</span> {(<span class="hljs-variable">$_</span>.ExtensionData.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={(<span class="hljs-variable">$_</span>.ExtensionData.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.summary.runtime.powerstate}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Schlussfolgerung ist dieselbe wie bei Get-AdvancedOptions, funktioniert jedoch um ein Vielfaches schneller.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun zu Get-VM. Es wird nicht schnell ausgeführt, da es sich um komplexe Objekte handelt. Es stellt sich eine logische Frage: Warum benötigen wir in diesem Fall zusätzliche Informationen und ein monströses PSO-Objekt, wenn wir nur den Namen der VM, ihren Status und den Wert des kniffligen Attributs benötigen?&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus hat die Bremse angesichts von Get-AdvancedOptions das Skript verlassen. Die Verwendung von Runspace-Pools scheint jetzt übertrieben, da beim Übertragen einer Sitzung keine langsame Aufgabe mehr in Streams mit Squats parallelisiert werden muss. Das Tool ist gut, aber nicht für diesen Fall.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir betrachten die Ausgabe von ExtensionData: Es ist nichts anderes als ein Get-View-Objekt.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nennen wir die alte Technik der PowerShell-Master: eine Zeile mit Filtern, Sortierungen und Gruppierungen. Alle vorherigen Horrorvorgänge fallen elegant in einer Zeile zusammen und werden in einer Sitzung ausgeführt:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-variable">$AllVMs</span> = <span class="hljs-built_in">Get-View</span> <span class="hljs-literal">-viewtype</span> VirtualMachine <span class="hljs-literal">-Property</span> Name,Config.ExtraConfig,summary.runtime.powerstate | <span class="hljs-built_in">Where-Object</span> {(<span class="hljs-variable">$_</span>.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={(<span class="hljs-variable">$_</span>.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.summary.runtime.powerstate}} | <span class="hljs-built_in">Sort-Object</span> CloudUUID | <span class="hljs-built_in">Group-Object</span> <span class="hljs-literal">-Property</span> CloudUUID | <span class="hljs-built_in">Where-Object</span> <span class="hljs-literal">-FilterScript</span> {<span class="hljs-variable">$_</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">1</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> <span class="hljs-built_in">Group</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir messen die Zeit: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iy/x4/7q/iyx47qcshcsbjbglrcwi_zzceps.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 Sekunden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für fast 10.000 Objekte mit Filterung nach den gewünschten Bedingungen. </font><font style="vertical-align: inherit;">Fein! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anstelle einer Schlussfolgerung Ein</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
akzeptables Ergebnis hängt direkt von der Wahl des Werkzeugs ab. </font><font style="vertical-align: inherit;">Es ist oft schwierig, genau zu sagen, was genau gewählt werden sollte, um dies zu erreichen. </font><font style="vertical-align: inherit;">Jede der aufgelisteten Skriptbeschleunigungsmethoden ist im Rahmen ihrer Anwendbarkeit gut. </font><font style="vertical-align: inherit;">Ich hoffe, dieser Artikel hilft Ihnen bei der schwierigen Aufgabe, die Grundlagen der Prozessautomatisierung und deren Optimierung in Ihrer Infrastruktur zu verstehen. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Der Autor dankt allen Mitgliedern der Gemeinde für ihre Hilfe und Unterstützung bei der Vorbereitung des Artikels. </font><font style="vertical-align: inherit;">Sogar die mit Pfoten. </font><font style="vertical-align: inherit;">Und selbst wer keine Beine hat, wie eine Boa Constrictor.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de498612/index.html">Entscheiden Sie nicht für den Designer die Aufgabe des Designers</a></li>
<li><a href="../de498614/index.html">Analyse einer Reihe von Werbevideos für das Spiel Spin Voyage</a></li>
<li><a href="../de498618/index.html">Android in einem industriellen Controller</a></li>
<li><a href="../de498620/index.html">Die Welt berühren: Biomechanik des menschlichen Hautrezeptors</a></li>
<li><a href="../de498624/index.html">[Anleitung] Erstellen von Google-Tests (Google-Formulare)</a></li>
<li><a href="../de498630/index.html">Physikalische Simulation von Hunderttausenden von Partikeln auf Unity + DOTS</a></li>
<li><a href="../de498632/index.html">Peptid für einen schönen Mulatten</a></li>
<li><a href="../de498634/index.html">11 dumme Fragen an einen Orthopäden und eine Masseuse über die Arbeit am Computer und nicht nur</a></li>
<li><a href="../de498636/index.html">Einfacher Shader für Punktlichter im Nebel</a></li>
<li><a href="../de498638/index.html">3D-Arcade im Browser: Wie wir das Spiel auf React + Redux gemacht haben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>