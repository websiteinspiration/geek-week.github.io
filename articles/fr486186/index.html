<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💄 🙏🏾 🕚 Nuage catastrophique: comment cela fonctionne 🐎 💿 👩🏿‍💻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Après les vacances du Nouvel An, nous avons redémarré un cloud résistant aux catastrophes basé sur deux sites. Aujourd'hui, nous al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nuage catastrophique: comment cela fonctionne</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/486186/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après les vacances du Nouvel An, nous avons redémarré un cloud résistant aux catastrophes basé sur deux sites. </font><font style="vertical-align: inherit;">Aujourd'hui, nous allons vous expliquer comment cela fonctionne et montrer ce qui arrive aux machines virtuelles clientes lorsque des éléments de cluster individuels échouent et que tout le site tombe en panne (spoiler - tout va bien avec eux). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/no/xs/p9/noxsp98upzfesoanpuhefetyilq.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stockage cloud résistant aux catastrophes sur le site OST.</font></font></i><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce qu'il y a dedans</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sous le capot du cluster se trouvent des serveurs Cisco UCS avec hyperviseur VMware ESXi, deux systèmes de stockage INFINIDAT InfiniBox F2240, un équipement réseau Cisco Nexus, ainsi que des commutateurs SAN Brocade. </font><font style="vertical-align: inherit;">Le cluster est réparti sur deux sites - OST et NORD, c'est-à-dire que dans chaque centre de données un ensemble d'équipements identique. </font><font style="vertical-align: inherit;">En fait, cela le rend catastrophique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au sein d'une même plateforme, les principaux éléments sont également dupliqués (hôtes, commutateurs SAN, carte réseau). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux sites sont reliés par des chemins de fibre optique dédiés, également réservés. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelques mots sur le stockage. </font><font style="vertical-align: inherit;">Le premier cloud résistant aux catastrophes que nous avons construit sur NetApp. </font><font style="vertical-align: inherit;">INFINIDAT a été choisi ici, et voici pourquoi:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option de réplication active-active. </font><font style="vertical-align: inherit;">Il permet à la machine virtuelle de rester opérationnelle même si l'un des systèmes de stockage tombe complètement en panne. </font><font style="vertical-align: inherit;">Je vous en dirai plus sur la réplication plus tard.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trois contrôleurs de disque pour une meilleure résilience du système. </font><font style="vertical-align: inherit;">Il y en a généralement deux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution prête. </font><font style="vertical-align: inherit;">Un rack déjà assemblé nous est parvenu, qui n'a besoin que d'être connecté au réseau et configuré.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support technique attentif. </font><font style="vertical-align: inherit;">Les ingénieurs INFINIDAT analysent en permanence les journaux et les événements des systèmes de stockage, installent de nouvelles versions dans le micrologiciel et aident à la configuration.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici quelques photos de déballage:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ro/r1/9i/ror19i6ohplap3nzivyq9dxqaog.png"><br>
<br>
<img src="https://habrastorage.org/webt/rg/zm/of/rgzmofi67yaghzz7fziewaka3fw.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment ça marche</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le cloud est déjà résilient en lui-même. Il protège le client contre les pannes matérielles et logicielles uniques. Une catastrophe aidera à protéger contre les pannes de masse au sein d'un même site: par exemple, la défaillance du système de stockage (ou du cluster SDS, ce qui arrive souvent :)), les erreurs de masse dans le réseau de stockage et plus encore. Eh bien et le plus important: un tel nuage enregistre lorsqu'un site entier devient inaccessible en raison d'un incendie, d'une panne de courant, d'une capture de voleur, </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'atterrissages étrangers.</font></font></s><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dans tous ces cas, les machines virtuelles clientes continuent de fonctionner, et voici pourquoi.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le schéma de cluster est conçu pour que tout hôte ESXi avec des machines virtuelles clientes puisse accéder à l'un des deux systèmes de stockage. Si le stockage sur le site OST échoue, les machines virtuelles continueront de fonctionner: les hôtes sur lesquels elles travaillent accéderont au stockage sur NORD pour les données. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/pq/0u/vupq0uycl3yelwrujymst8jqpke.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici à quoi ressemble le diagramme de connexion dans le cluster.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Cela est possible du fait qu’une liaison inter-commutateurs est configurée entre les usines SAN des deux sites: le commutateur Fabric A OST SAN est connecté au commutateur Fabric A NORD SAN, de la même manière que les commutateurs Fabric B SAN.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, pour que toutes ces subtilités des usines SAN aient un sens, la réplication Active-Active est configurée entre les deux systèmes de stockage: les informations sont écrites presque simultanément sur les systèmes de stockage local et distant, RPO = 0. Il s'avère que sur un SHD les données originales sont stockées, sur l'autre - leur réplique. Les données sont répliquées au niveau du volume de stockage et les données de la machine virtuelle (ses disques, fichier de configuration, fichier d'échange, etc.) y sont déjà stockées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'hôte ESXi considère le volume principal et sa réplique comme un seul périphérique de stockage. Il existe 24 chemins depuis l'hôte ESXi vers chaque périphérique de disque:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12 chemins l'associent au stockage local (chemins optimaux) et les 12 autres - au distant (chemins non optimaux). Dans une situation normale, ESXi accède aux données sur le stockage local en utilisant des chemins «optimaux». Si ce système de stockage tombe en panne, ESXi perd ses chemins optimaux et passe à des chemins «non optimaux». Voici à quoi cela ressemble dans le diagramme. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/zu/rp/tlzurpwt1mspwdpbjeb53ydas4i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le schéma d'un cluster résistant aux catastrophes.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tous les réseaux clients sont établis sur les deux sites via une usine de réseau commune. Provider Edge (PE) s'exécute sur chaque site, sur lequel les réseaux clients sont terminés. Les PE sont combinés en un seul cluster. Si PE échoue sur un site, tout le trafic est redirigé vers le deuxième site. Grâce à cela, les machines virtuelles du site sans PE restent disponibles sur le réseau pour le client.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant ce qui arrivera aux machines virtuelles clientes en cas de pannes diverses. </font><font style="vertical-align: inherit;">Commençons par les options les plus légères et terminons par les plus graves - la défaillance de l'ensemble du site. </font><font style="vertical-align: inherit;">Dans les exemples, le site principal sera OST et la sauvegarde, avec des répliques de données, sera NORD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'advient-il d'une machine virtuelle cliente si ... </font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Échec du lien de réplication.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La réplication entre les systèmes de stockage des deux sites s'arrête. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESXi ne fonctionnera qu'avec des périphériques de disque locaux (le long des chemins optimaux). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les machines virtuelles continuent de fonctionner. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xd/1u/rs/xd1urscyrw5ldefaecvzg2sxsbg.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a un écart ISL (Inter-Switch Link).</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L'affaire est peu probable. Sauf si une excavatrice folle creuse plusieurs routes optiques à la fois, qui passent par des routes indépendantes et sont amenées sur les sites par différentes entrées. Mais peu importe. Dans ce cas, les hôtes ESXi perdent la moitié de leur chemin d'accès et ne peuvent accéder qu'à leur stockage local. Les répliques sont collectées, mais les hôtes ne pourront pas y accéder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les machines virtuelles fonctionnent normalement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eh/pg/p2/ehpgp21qksqs333elaz_px8hohs.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refuse un commutateur SAN sur l'un des sites.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les hôtes ESXi perdent certains de leurs chemins de stockage. Dans ce cas, les hôtes du site où le commutateur a échoué ne fonctionneront que via leur propre HBA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même temps, les machines virtuelles continuent de fonctionner normalement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/_1/0w/vz_10wdyjuu3yp9flx0-kyiog9w.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les commutateurs SAN sur l'un des sites échouent.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Disons qu'une telle catastrophe s'est produite sur le site de l'OST. Dans ce cas, les hôtes ESXi sur ce site perdront tous les chemins d'accès à leurs périphériques de disque. Le mécanisme standard de VMware vSphere HA entre en jeu: il redémarrera toutes les machines virtuelles de la plateforme OST dans NORD après un maximum de 140 secondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les machines virtuelles exécutées sur les hôtes du site NORD fonctionnent normalement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yg/le/w8/yglew89bonr-aubz9dw85jxbnb0.gif"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refuse l'hôte ESXi sur un seul site.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici, le mécanisme vSphere HA fonctionne à nouveau: les machines virtuelles d'un hôte défaillant sont redémarrées sur d'autres hôtes - sur le même site ou sur un site distant. Le temps de redémarrage de la machine virtuelle peut aller jusqu'à 1 minute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tous les hôtes ESXi de la plate-forme OST échouent, il n'y a pas d'options: les VM redémarrent sur un autre. L'heure de redémarrage est la même. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ij/ri/no/ijrino56s-akqtzivujr3en3ejy.gif"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refuse le stockage sur le même site.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Disons que le système de stockage a refusé sur le site OST. Ensuite, les hôtes OST ESXi basculent pour fonctionner avec des répliques de stockage dans NORD. Après le retour du système de stockage défaillant sur le système, une réplication forcée aura lieu, les hôtes OST ESXi recommenceront à contacter le système de stockage local. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les machines virtuelles ont fonctionné tout ce temps. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ng/gk/vy/nggkvy-lk3dbjs-zfop2racir3u.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Échoue l'un des sites.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans ce cas, toutes les machines virtuelles redémarreront sur le site de sauvegarde via le mécanisme vSphere HA. Temps de redémarrage de la machine virtuelle - 140 secondes. Dans ce cas, tous les paramètres réseau de la machine virtuelle sont enregistrés et restent disponibles pour le client sur le réseau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour redémarrer les machines sur le site de sauvegarde sans problème, chaque site n'est qu'à moitié plein. La seconde moitié est la réserve au cas où toutes les machines virtuelles seraient déplacées du deuxième site endommagé. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oa/hg/hr/oahghrsypij8je-zwym7trlj0-g.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un cloud à l'épreuve des catastrophes basé sur deux centres de données protège contre de telles pannes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce plaisir n'est pas bon marché, car, en plus des principales ressources, il faut une réserve sur le deuxième site. </font><font style="vertical-align: inherit;">Par conséquent, ils placent les services essentiels à l'entreprise dans un tel cloud, dont le long temps d'indisponibilité entraîne des pertes financières et de réputation importantes, ou si des exigences de tolérance aux catastrophes sont imposées au système d'information par les régulateurs ou les règlements internes de l'entreprise. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources:</font></font></b><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.infinidat.com/sites/default/files/resource-pdfs/DS-INFBOX-190331-US_0.pdf</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support.infinidat.com/hc/en-us/articles/207057109-InfiniBox-best-practices-guides</font></font></a></li>
</ol></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es487948/index.html">Autenticación de dos factores en OpenVPN con Telegram bot</a></li>
<li><a href="../fr486176/index.html">Mémo de correspondance par e-mail d'entreprise</a></li>
<li><a href="../fr486178/index.html">FOSS News No. 1 - revue des nouvelles gratuites et open source du 27 janvier au 2 février 2020</a></li>
<li><a href="../fr486180/index.html">Conseils et sources pour créer des applications sans serveur</a></li>
<li><a href="../fr486184/index.html">Comment utiliser efficacement la recherche</a></li>
<li><a href="../fr486188/index.html">Présentation du système de sauvegarde PostgreSQL wal-g</a></li>
<li><a href="../fr486190/index.html">Notre expérience dans le développement d'un pilote CSI dans Kubernetes pour Yandex.Cloud</a></li>
<li><a href="../fr486192/index.html">Les cyber fraudeurs piratent les opérateurs mobiles pour accéder aux numéros de téléphone des abonnés</a></li>
<li><a href="../fr486194/index.html">À propos des sauvegardes dans Proxmox VE</a></li>
<li><a href="../fr486198/index.html">Parler est difficile. Essais sur la communication avec les non-programmeurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>