<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🍳 🍗 🐍 あいまいな行動の研究 😔 🔍 🌷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、適切な値でreturnを呼び出さずにvoid以外の関数が完了したときにc ++で発生する未定義の動作の考えられる症状について説明します。記事は実用的というより科学的で面白いです。
 
 レーキで楽しくジャンプするのが嫌いな人-通り過ぎても止まりません。
 
 前書き
 C ++コードを...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>あいまいな行動の研究</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499020/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、適切な値でreturnを呼び出さずにvoid以外の関数が完了したときにc ++で発生する未定義の動作の考えられる症状について説明します。</font><font style="vertical-align: inherit;">記事は実用的というより科学的で面白いです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レーキで楽しくジャンプするのが嫌いな人-通り過ぎても止まりません。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++コードを開発するとき、未定義の動作を許可してはならないことは誰もが知っています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかしながら：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不確定な動作は、起こり得る結果の抽象性のために十分に危険に思えない場合があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">線がどこにあるかは必ずしも明確ではありません。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのかなり単純なケースで発生する未定義の動作の可能な兆候を指定してみましょう-非void関数では戻り値はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、さまざまな最適化モードで最も一般的なコンパイラーによって生成されたコードを検討してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Linuxでの調査は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイラエクスプローラ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して行われ</font><font style="vertical-align: inherit;">ます。 WindowsとmacOs Xの研究-私が直接入手できるハードウェアについて。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのビルドはx86-x64で行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイラの警告/エラーを強化または抑制するための対策は講じられません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
逆アセンブルされたコードがたくさんあります。</font><font style="vertical-align: inherit;">残念ながらそのデザインは雑多です。</font><font style="vertical-align: inherit;">私はいくつかの異なるツールを使用する必要があります（少なくとも、どこでもIntel構文を取得できました）。</font><font style="vertical-align: inherit;">逆アセンブルされたコードについて、適度に詳細なコメントを付けますが、プロセッサレジスタとスタックの原理についての知識は必要ありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準を読む</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 11最終ドラフトn3797、C ++ 14最終ドラフトN3936：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.6.3 returnステートメント</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数の最後からフローすることは、値のないreturnと同じです。</font><font style="vertical-align: inherit;">これにより</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、値を返す関数</font><font style="vertical-align: inherit;">で未定義の</font><font style="vertical-align: inherit;">動作が発生します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の終わりに到達することは、戻り値なしで戻ることと同じです。</font><font style="vertical-align: inherit;">戻り値が提供される関数の場合、これは未定義の動作につながります。</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 17ドラフトn4713</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.6.3 returnステートメント</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
戻り値の型がcv voidのコンストラクタ、デストラクタ、または関数の最後からフローすることは、オペランドのないreturnと同等です。</font><font style="vertical-align: inherit;">それ以外の場合、main（6.8.3.1）以外の関数の最後からフローすると、未定義の動作が発生します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンストラクタ、デストラクタ、または関数の最後にvoidの戻り値（おそらくconstおよびvolatile修飾子を指定）で到達することは、戻り値なしでreturnすることと同じです。</font><font style="vertical-align: inherit;">他のすべての関数の場合、これは未定義の動作につながります（メイン関数を除く）。</font></font><br>
</blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは実際にはどういう意味ですか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数のシグネチャが戻り値を提供する場合：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その実行は、適切なタイプのインスタンスを含むreturnステートメントで終了する必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そうでなければ、漠然とした行動。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未定義の動作は、関数が呼び出された瞬間からではなく、戻り値が使用された瞬間からではなく、関数が正しく完了しなかった瞬間から始まります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数に正しい実行パスと正しくない実行パスの両方が含まれている場合-未定義の動作は、正しくないパスでのみ発生します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題の未定義の動作は、関数の本体に含まれる命令の実行には影響しません。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メイン関数に関する語句は、c ++ 17の新機能ではありません。以前のバージョンの標準では、同様の例外がセクション3.6.1メイン関数で説明されていました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1-ブール</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++では、ブールよりも単純な状態の型はありません。</font><font style="vertical-align: inherit;">彼から始めましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MSVCは、このような例のC4716コンパイルエラーを生成するため、少なくとも1つの正しい実行パスを提供することにより、MSVCのコードを少し複雑にする必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイル：</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プラットホーム</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイラ</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイル結果</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 Clang 10.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告：非void関数は値を返しません[-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 gcc 9.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告：void以外を返す関数にreturnステートメントがありません[-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apple clangバージョン11.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告：コントロールが非void関数の終わりに達しました[-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィンドウズ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSVC 2019 16.5.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">元の例は複雑なエラーC4716です-警告C4715：すべての制御パスが値を返すわけではありません</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行結果：</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムリターン</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1、-O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1、-O2、-O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clangバージョン11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0、-O1、-O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、元の例</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od、/ O1、/ O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドなし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドなし</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4複雑な例</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1 / / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この最も単純な例でさえ、4つのコンパイラが未定義の動作を表示する少なくとも3つの方法を示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのコンパイラーがそこでコンパイルしたものを理解しましょう。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0、-O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/yc/pg/vw/ycpgvw4062ruxbxhec61lpr5oec.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（）関数の最後のステートメントは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下からの指示の内容</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インテル64およびIA-32アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<blockquote>UD2—Undefined Instruction<br>
Generates an invalid opcode exception. This instruction is provided for software testing to explicitly generate an invalid opcode exception. The opcode for this instruction is reserved for this purpose.<br>
Other than raising the invalid opcode exception, this instruction has no effect on processor state or memory.<br>
<br>
Even though it is the execution of the UD2 instruction that causes the invalid opcode exception, the instruction pointer saved by delivery of the exception references the UD2 instruction (and not the following instruction).<br>
<br>
This instruction’s operation is the same in non-64-bit modes and 64-bit mode.<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、これは例外をスローするための特別な命令です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪い（）呼び出しをtry ... catchでラップする必要があります！ブロック </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どんなに。</font><font style="vertical-align: inherit;">これはC ++の例外ではありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行時にud2をキャッチすることは可能ですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windowsでは、__ tryを使用する必要があります; LinuxおよびmacOs Xでは、SIGILLシグナルハンドラー。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0、-O1、-O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/qg/al/gl/qgalgl3q6xaqajpp2kdjqxpbp9m.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適化の結果として、コンパイラーはbad（）関数の本体とその呼び出しの両方を単に破棄しました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3、-O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/a7/ny/2g/a7ny2ghbcx-bj4a73pqzu_y_eam.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
説明（この場合、チェーンは最後から解析する方が簡単なので、逆順）：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. boolのストリームの出力演算子が呼び出されます（14行目）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.アドレスstd :: coutがediレジスタに配置されます-これは、ストリーム（行13）の出力演算子の最初の引数です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. eaxレジスターの内容は、esiレジスターに入れられます。これは、ストリーム（12行目）の出力演算子の2番目の引数です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. eaxの上位3バイトがゼロにリセットされ、alの値は変化しません（行11）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. bad（）関数が呼び出されます（10行目）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0. bad（）関数は、戻り値をalレジスターに入れる必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
代わりに、4行目はnop（操作なし、ダミー）を示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
alレジスタからの1バイトのゴミがコンソールに出力されます。</font><font style="vertical-align: inherit;">プログラムは正常終了します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3、-O1、-O2、-O3</font></font></h4><br>
<img src="https://habrastorage.org/webt/dp/sl/yh/dpslyhnvjwxt2c24ifgw6lgpxnu.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適化の結果、コンパイラーはすべてをスローしました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clangバージョン11.0.0、-O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数main（）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/kl/aw/eyklawd5cgswoa14yg-h8iotxkq.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力演算子のブール引数からストリームへのパス（今回は直接的な順序）：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. alレジスターの内容がedxレジスターに配置されます（8行目）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.最下位（9行目）を除いて、edxレジスタのすべてのビットがゼロになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. std :: coutへのポインタがrdiレジスタに配置されます-これは、ストリーム（行10）の出力演算子の最初の引数です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. edxレジスタの内容はesiレジスタに配置されます。これは、ストリーム（行11）の出力演算子への2番目の引数です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5.出力文はboolのストリームで呼び出されます（13行目）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
main関数は、alレジスタからbad（）関数の結果を取得することを期待しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（）関数：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v5/tx/1p/v5tx1pohulp-fewcheimnj0wnkk.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.まだ割り当てられていない、スタックの次のバイトの値がalレジスタに配置されます（4行目）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.最下位（5行目）を除いて、alレジスタのすべてのビットが除外されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
割り当てられていないスタックからのゴミの1ビットがコンソールに出力されます。</font><font style="vertical-align: inherit;">たまたま、テスト実行中にゼロになることがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムは正常終了します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clangバージョン11.0.0、-O1、-O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/zh/mm/t0/zhmmt0z4yvmtiunqa287sdu9lky.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ストリームの出力演算子のブール引数は無効になります（5行目）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（）呼び出しが最適化中にスローされました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムは常にコンソールにゼロを表示し、正常に終了します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、高度な例、/ OD</font></font></h4><br>
<img src="https://habrastorage.org/webt/pb/iz/ku/pbizkuhiff8y37zk6i2ea1qrwb8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（）関数がalレジスタに戻り値を提供する必要があることがわかります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/ej/zn/auejznebzsjq0n_e4kgtbkfd5ae.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（）関数によって返された値は、最初にスタックにプッシュされ、次にedxレジスターにプッシュされて、ストリームに出力されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
alレジスタからの1バイトのガベージがコンソールに出力されます（少し正確に言えば、rand（）の結果の下位バイト）。</font><font style="vertical-align: inherit;">プログラムは正常終了します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4複雑な例、/ O1、/ O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/mk/wr/jy/mkwrjyimc1tfaqfzq_hzuorcaba.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイラは不正な（）呼び出しを強制的にインライン化しました。</font><font style="vertical-align: inherit;">主な機能：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[rsp + 30h]にあるメモリからebxから1バイトをコピーします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rand（）がゼロを返した場合、ユニットをecxからebxにコピーします（行11）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じ値をdl（より正確には、最下位バイト）にコピーします（13行目）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">streamで出力関数を呼び出し、dl値を出力します（14行目）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RAMから（アドレスrsp + 30hから）1バイトのゴミがストリームに出力されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1の結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
逆アセンブラーのリストを検討した結果を表に示します。</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムリターン</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原因</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1、-O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化の結果、コンソール出力とbad（）関数の呼び出しがスローされました</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジスターalからの1バイトのごみ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1、-O2、-O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化の結果、コンソール出力とbad（）関数の呼び出しがスローされました</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clangバージョン11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMからの1ビットのゴミ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1、-O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数呼び出しbad（）はゼロに置き換えられました</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、元の例</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od、/ O1、/ O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドなし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドなし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドなし</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4複雑な例</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジスターalからの1バイトのごみ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1 / / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMからの1バイトのゴミ</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結局のところ、コンパイラは3つではなく6つもの未定義の動作のバリエーションを示していませんでした。逆アセンブラのリストを検討する直前には、それらのいくつかを区別できませんでした。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1a-未定義の動作の管理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
未定義の動作で少し操縦してみましょう-bad（）関数によって返される値に影響を与えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、ガベージを出力するコンパイラでのみ実行できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、コンパイラーが取得する場所で目的の値を掌握します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3、-O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
空のbad（）関数は、呼び出しコードが必要とするため、レジスタalの値を変更しません。</font><font style="vertical-align: inherit;">したがって、bad（）を呼び出す前にalに特定の値を配置すると、bad（）を実行した結果としてその値が表示されることが期待されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、これはboolを返す他の関数を呼び出すことで実行できます。</font><font style="vertical-align: inherit;">しかし、これは、たとえば、未署名のcharを返す関数を使用して行うこともできます。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なサンプルコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodTrue</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> rand();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodFalse</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> !goodTrue();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
    <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    goodTrue();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodFalse();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールへの出力：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、/ OD</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MSVCの例では、bad（）関数はrand（）の結果の下位バイトを返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（）関数を変更しないと、外部コードはrand（）の結果を変更することにより、戻り値に影響を与える可能性があります。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なサンプルコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">control</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> value)</span>
</span>{
    <span class="hljs-keyword">uint32_t</span> count = <span class="hljs-number">0</span>;<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">while</span> ((rand() &amp; <span class="hljs-number">0xff</span>) != value) {<font></font>
        ++count;<font></font>
    }<font></font>
<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {<font></font>
        rand();<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    control(<span class="hljs-number">1</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">0</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールへの出力：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、/ O1、/ O2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（）関数によって「返される」値に影響を与えないようにするには、1つのスタック変数を作成するだけで十分です。</font><font style="vertical-align: inherit;">その中のレコードが最適化中に破棄されないようにするには、揮発性としてマークする必要があります。</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なサンプルコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">1</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">85</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">240</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールへの出力：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clangバージョン11.0.0、-O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（）を呼び出す前に、そのメモリセルに、bad（）を呼び出したときのスタックの最上位よりも1つ小さい値を入力する必要があります。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なサンプルコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putToStack</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> value)</span>
</span>{
    <span class="hljs-keyword">uint8_t</span> memory[<span class="hljs-number">1</span>]{value};<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    putToStack(<span class="hljs-number">20</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">55</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">0xfe</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">11</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
      -O0,         memory.          ,    .<br>
<br>
   memory      ,   —       ,    ,   .<br>
<br>
   , ..        ,      —   putToStack     .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールへの出力：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
発生したようです：bad（）関数の出力を変更することが可能で、下位ビットのみが考慮されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1aの結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例では、逆アセンブラーリストの正しい解釈を検証することが可能になりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1b-壊れたブール</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さて、あなたはそれを考えると、「1」の代わりに「41」がコンソールに表示されます...これは危険ですか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1バイトのゴミを提供する2つのコンパイラを確認します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、/ OD</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なサンプルコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">bool</span> badBool1 = bad();
    <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (!badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールへの出力：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1：41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2：35 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if（badBool1）：true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if（！badBool1）：false </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（badBool1 == true || badBool1 == false || badBool1 == badBool2）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1、badBool2 、true、false} .size（）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1、badBool2、true、false} .size（）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
未定義の動作により、少なくとも次の動作を停止するブール変数が出現しました。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブール値の比較演算子。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブール値のハッシュ関数。</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、/ O1、/ O2</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なサンプルコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">213</span>;
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
  ch = <span class="hljs-number">137</span>;
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールへの出力：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1：213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2：137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if（badBool1）：true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if（！badBool1）：false </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（badBool1 == true || badBool1 == false || badBool1 == badBool2）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1、badBool2 、true、false} .size（）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1、badBool2、true、false} .size（）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
破損したブール変数の操作は、最適化をオンにしても変更されませんでした。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3、-O0</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なサンプルコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
  <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  goodChar(<span class="hljs-number">213</span>);
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
<font></font>
  goodChar(<span class="hljs-number">137</span>);
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールへの出力：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1：213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2：137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if（badBool1）：true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if（！badBool1）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
（badBool1 == true || badBool1 == false || badBool1 == badBool2）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1、badBool2 、true、false} .size（）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1、badBool2、true、false} .size（）：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font><br>
</b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MSVCと比較して、gccはnot演算子の誤った操作も追加しました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1bの結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブール値を使用した基本操作の中断は、高レベルのロジックに深刻な結果をもたらす可能性があります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜそれが起こったのですか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブール変数を使用した一部の操作は、trueが厳密に単位であるという前提の下で実装されているためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
逆アセンブラではこの問題は考慮しません。記事は膨大な量になることがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度、コンパイラの動作を表に示します。</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムリターン</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原因</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bad（）の結果を使用した結果</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1、-O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化の結果、コンソール出力とbad（）関数の呼び出しがスローされました</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジスターalからの1バイトのごみ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕事の違反：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ない; </font><font style="vertical-align: inherit;">==; </font><font style="vertical-align: inherit;">！=; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std ::ハッシュ。</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1、-O2、-O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力なし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化の結果、コンソール出力とbad（）関数の呼び出しがスローされました</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clangバージョン11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMからの1ビットのゴミ</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1、-O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数呼び出しbad（）はゼロに置き換えられました</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、元の例</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od、/ O1、/ O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドなし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドなし</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドなし</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4複雑な例</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジスターalからの1バイトのごみ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕事の違反：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">！=; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std ::ハッシュ。</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1 / / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAMからの1バイトのゴミ</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕事の違反：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">！=; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std ::ハッシュ。</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4つのコンパイラは、未定義の動作の7つの異なる症状を示しました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例2-構造体</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう少し複雑な例を見てみましょう：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test構造は、構築するためにint型の単一のパラメーターを必要とします。</font><font style="vertical-align: inherit;">診断メッセージは、コンストラクタとデストラクタから出力されます。</font><font style="vertical-align: inherit;">bad（int）関数には2つの有効な実行パスがあり、それらのいずれも1回の呼び出しで実装されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回-最初に表、次に不明瞭なポイントの逆アセンブラ分析。</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化</font></font></b></td>
<td><b>Program return</b></td>
<td><b>Console output</b></td>
<td><b></b></td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 Clang 10.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>255</td>
<td>rnd: 1804289383</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 gcc 9.3</b></td>
</tr>
<tr>
<td>-O0</td>
<td>0</td>
<td>rnd: 1804289383<br>
4198608<br>
Test::~Test()</td>
<td>nop       .<br>
value    .</td>
</tr>
<tr>
<td>-O1, -O2, -O3</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>macOs X Apple clang version 11.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>The program has unexpectedly finished.</td>
<td>rnd: 16807</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 16807<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Windows MSVC 2019 16.5.4</b></td>
</tr>
<tr>
<td>/Od /RTCs</td>
<td>Access violation reading location 0x00000000CCCCCCCC</td>
<td>rnd: 41</td>
<td>  MSVC stack frame run-time error checking</td>
</tr>
<tr>
<td>/Od, /O1, /O2</td>
<td>0</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd：41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791061810776 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テスト::〜テスト（）</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレスがraxにあるメモリロケーションからのガベージ</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
繰り返しますが、多くのオプションがあります。既知のud2に加えて、少なくとも4つの異なる動作があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンストラクターによるコンパイラー処理は非常に興味深いものです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合によっては、コンストラクターを呼び出さずに実行が続行されました-この場合、オブジェクトはランダムな状態でした。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 他の場合では、コンストラクター呼び出しが実行パスで提供されなかったため、かなり奇妙です。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0、-O1、-O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/z7/cq/ry/z7cqry23rk0ul156zrdhnedehl0.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードでは比較が1つだけ行われ（14行目）、条件付きジャンプは1つだけです（15行目）。</font><font style="vertical-align: inherit;">コンパイラーは2番目の比較と2番目の条件ジャンプを無視しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、無期限の行動が基準が規定するよりも早く始まったという疑いをもたらします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、2番目のifの状態をチェックすると、副作用が含まれず、コンパイラロジックは次のように機能します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番目の条件がtrueの場合-引数142でコンストラクターTestを呼び出す必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番目の条件が真でない場合、関数は値を返さずに終了します。これは、コンパイラーが何でもできる未定義の動作を意味します。</font><font style="vertical-align: inherit;">含む-同じ引数で同じコンストラクタを呼び出します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検証は不必要です。引数142のTestコンストラクターは、条件をチェックせずに呼び出すことができます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のチェックに副作用のある条件が含まれているとどうなるか見てみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<img src="https://habrastorage.org/webt/j5/mi/-w/j5mi-w148l3tnejie9aaxus5nr8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイラーは、rand（）（16行目）を呼び出すことにより、意図したすべての副作用を正直に再現し、未定義の動作の不適切な早期開始に関する疑問を払拭しました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、/ OD / RTC</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ RTCsオプションは、スタックフレームのランタイムエラーチェックを有効にします。このオプションは、デバッグアセンブリでのみ使用できます。 main（）セクションの逆アセンブルされたコードを検討してください：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kl/sr/4y/klsr4ygrimmzxwbwuqtvfd3xvmy.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（int）（4行目）を呼び出す前に、引数が準備されます-rnd変数の値がedxレジスター（2行目）にコピーされ、アドレスにあるローカル変数の実効アドレスがrcxレジスターにロードされますrsp + 28h（3行目）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく、rsp + 28は、bad（int）の呼び出しの結果を格納する一時変数のアドレスです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この仮定は19行目と20行目で確認されています。同じ変数の実効アドレスがrcxにロードされ、その後デストラクタが呼び出されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、4行目から18行目の間隔では、ストリームへのデータフィールドの値の出力にもかかわらず、この変数はアクセスされません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前のMSVCリストから見てきたように、ストリーム出力演算子の引数はrdxレジスターにあるはずです。</font><font style="vertical-align: inherit;">rdxレジスタは、raxにあるアドレスを逆参照した結果を取得します（行9）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、呼び出しコードは不良（int）を予期します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rcxレジスタを介してアドレスが渡される変数を入力します（ここではRVOの動作を確認しています）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raxレジスタを介してこの変数のアドレスを返します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bad（int）のリストに移りましょう：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c3/vm/-x/c3vm-xwuhghbvtp6byyqwf6l6xg.png" alt="画像"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eaxでは、値0xCCCCCCCCが入力されます。これは、アクセス違反メッセージ（9行目）で確認できます（AccessViolationメッセージではアドレスが8バイトであるのに対し、4バイトのみであることに注意してください）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rep stosコマンドが呼び出され、アドレスrdi（行10）からメモリにeaxコンテンツを書き込む0xCサイクルが実行されます。</font><font style="vertical-align: inherit;">これらは48バイトで、6行目のスタックに割り当てられているのとまったく同じです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しい実行パスでは、rsp + 40hの値がraxに入力されます（23、36行目）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rcxレジスタの値（main（）が宛先アドレスを渡すために使用）は、rsp + 8（4行目）でスタックにプッシュされます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdiがスタックにプッシュされ、rspが8だけ減少します（5行目）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rspを減らすことにより、スタックに30hバイトが割り当てられます（6行目）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、4行目のrsp + 8と残りのコードのrsp + 40hは同じ値です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは次のようにかなり混乱しています </font><font style="vertical-align: inherit;">rbpは使用しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクセス違反メッセージには2つの事故があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレスの上部にゼロ-ゴミがあります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">住所が誤って判明した。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうやら、/ RTCsオプションは、特定のゼロ以外の値でスタックの上書きを有効にし、アクセス違反メッセージは単なるランダムな副作用でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ RTCsオプションがオンになっているコードと、それがないコードとの違いを見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r4/ai/gh/r4aighkarr9kdcerpk60u6jvdya.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
main（）のセクションのコードは、スタック上のローカル変数のアドレスのみが異なります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/oi/zt/kqoizt0khccfqovtmw6qn_--xiq.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（明確にするために、私はその隣に悪い（int）関数の2つのバリアントを配置しました-/ RTCありとなしで）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ RTCなしでは、rep stos命令が消え、関数の最初にそのための引数を準備しました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例2a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
繰り返しになりますが、無期限の動作を制御してみてください。</font><font style="vertical-align: inherit;">今回は1つのコンパイラのみです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4、/ OD / RTC</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ RTCsオプションを使用すると、コンパイラは不良（int）関数の先頭にコードを挿入し、raxの下半分に固定値を入力します。これにより、アクセス違反が発生する可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この動作を変更するには、raxに有効なアドレスを入力します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、非常に単純な変更で実現できます。何かの出力をstd :: coutに不良（int）ボディに追加します。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なサンプルコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; v &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd：41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791039331928 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テスト::〜テスト（）</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
演算子&lt;&lt;はストリームへのリンクを返します。これは、アドレスstd :: coutをraxに配置することで実装されます。</font><font style="vertical-align: inherit;">アドレスは正しく、逆参照することができます。</font><font style="vertical-align: inherit;">アクセス違反は防止されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も単純な例を使用して、次のことができました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不定の行動の約10の異なる症状を収集します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> これらのオプションがどのように実行されるかを詳細に学習します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのコンパイラは、標準に厳密に準拠していることを示しました-不確定な動作が以前に始まった例はありません。</font><font style="vertical-align: inherit;">しかし、コンパイラ開発者に空想を拒否することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、顕現は微妙なニュアンスに依存します。一見無関係なコード行を追加または削除する価値があり、プログラムの動作は大幅に変化します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、後でパズルを解くよりも、そのようなコードを記述しない方が簡単です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja499008/index.html">開発者が非常に遅い理由：一般的な問題とその解決策</a></li>
<li><a href="../ja499010/index.html">Mediastreamer2 VoIPエンジンを研究します。パート11</a></li>
<li><a href="../ja499014/index.html">JavaScriptインタビューの23の難しい質問</a></li>
<li><a href="../ja499016/index.html">ESIA for .Netとの統合：思ったより簡単</a></li>
<li><a href="../ja499018/index.html">6つのホームスポーツアプリ</a></li>
<li><a href="../ja499030/index.html">20分でisic上のGrafanaのMySQLパフォーマンスを監視する</a></li>
<li><a href="../ja499032/index.html">Prometheusを使用してGitLabで異常を検出する方法</a></li>
<li><a href="../ja499034/index.html">危険なリファクタリングを100万人のユーザーに提供する方法は？</a></li>
<li><a href="../ja499036/index.html">プロバイダーの仕事：プロトコル、IT、ネットワークインフラストラクチャに関するさまざまな資料</a></li>
<li><a href="../ja499038/index.html">縦型モニターの使用経験</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>