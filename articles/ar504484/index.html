<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐻 👼 🤩 IPSec سبحانه وتعالى 🏴󠁧󠁢󠁥󠁮󠁧󠁿 👨🏾‍🍳 🔡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="مساء الخير يا اصدقاء. ليس سراً أن الكثير منا لديه مرة واحدة على الأقل ، ولكن كان عليه أن يتعامل مع الحاجة إلى تكوين VPN. كوني قارئًا نشطًا لحبر ، لاحظ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec سبحانه وتعالى</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">مساء الخير يا اصدقاء. </font><font style="vertical-align: inherit;">ليس سراً أن الكثير منا لديه مرة واحدة على الأقل ، ولكن كان عليه أن يتعامل مع الحاجة إلى تكوين VPN. </font><font style="vertical-align: inherit;">كوني قارئًا نشطًا لحبر ، لاحظت أنه على الرغم من وفرة المقالات حول IPSec ، إلا أنه بالنسبة للكثيرين لا يزال يبدو شيئًا معقدًا ومحملاً. </font><font style="vertical-align: inherit;">في هذه المقالة سأحاول تبديد هذه الأساطير باستخدام التكوين الخاص بي الذي يعمل بشكل كامل كمثال. </font><font style="vertical-align: inherit;">في أربعة أمثلة ، سنستعرض تمامًا تكوين حل Linux (Strongswan) الأكثر شيوعًا ، من نفق بسيط مع مصادقة جانبية بمفاتيح PSK إلى اتصال من مضيف إلى مصادقة مع كلا الجانبين بناءً على شهادات من Let's Encrypt. </font><font style="vertical-align: inherit;">مثير للإعجاب؟ </font><font style="vertical-align: inherit;">مرحبًا بك في القط!</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">خلفية</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في البداية ، تم التخطيط لشبكة VPN فقط لتنظيم القناة بين جهاز التوجيه المصغر للوالدين وخادم "جانب السرير" المنزلي ، والذي يعمل في الوقت نفسه كجهاز توجيه. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بعد فترة قصيرة ، تمت إضافة Keenetic إلى هذه الشركة من جهازين. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ولكن بمجرد البدء ، اتضح أنه من الصعب إيقافه ، وسرعان ما ظهرت الهواتف والكمبيوتر المحمول على الرسم التخطيطي ، الذين أرادوا الاختباء من العين الإعلانية الواضحة لـ MT_Free وشبكات WiFi غير المشفرة الأخرى. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ثم أصبح ILV المحبوب في النهاية أقوى Banhammer ، الذي وقع بشكل لا يصدق في حب التأرجح علنا ​​في جميع الاتجاهات ، ومن أجل تحييد قلقه لمجرد البشر ، كان عليه أن </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يدعم قطاع تكنولوجيا المعلومات الأجنبي</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> للحصول على VPS في الخارج.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بالإضافة إلى ذلك ، مواطنة معينة تشبه شابوكلياك ، تتجول في كل مكان مع </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">شبكتها من خلال</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> الحزمة ، وربما تعتقد أن "من يساعد الناس ، يضيع الوقت. </font><font style="vertical-align: inherit;">لا يمكنك أن تصبح مشهورًا بالأعمال الصالحة "، أردت أن ألق نظرة خاطفة على حركة مرور شخص آخر وأخذها بالقلم الرصاص. </font><font style="vertical-align: inherit;">سيكون علينا أيضًا الدفاع عن أنفسنا ضد مثل هذا الحب غير المرغوب فيه والشبكة الافتراضية الخاصة في هذه الحالة بالضبط التي طلبها الطبيب. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لتلخيص ملخص قصير. </font><font style="vertical-align: inherit;">كان من الضروري إيجاد حل يمكنه بشكل مثالي إغلاق العديد من المهام في وقت واحد:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> الترابط بين موجهات Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> بناء نفق بين لينكس والأسرة الحركية</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> امنح حق الوصول إلى الموارد المنزلية والإنترنت للأجهزة القابلة للارتداء (الهواتف وأجهزة الكمبيوتر المحمولة) من الشبكات غير الموثوق بها</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إنشاء نفق مشفر بأمان إلى VPS البعيد</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لا تنس مبدأ KISS الرائع - حافظ على البساطة ، يا غبي. </font><font style="vertical-align: inherit;">كلما شاركنا في مكونات أقل ، أصبح من الأسهل تكوين كل منها - كلما كانت أكثر موثوقية.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">نظرة عامة على الحلول الموجودة</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
استعرض بإيجاز ما هو الآن: </font><font style="vertical-align: inherit;">
جد </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> لينين من جميع البروتوكولات. </font><font style="vertical-align: inherit;">توفي "العفن المتحلل والعسل الزيزفون". </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
هل يستخدم هذا أحد غير مزود واحد؟ </font><font style="vertical-align: inherit;">
مشروع </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wireguard</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> يتطور. </font><font style="vertical-align: inherit;">المنشور بنشاط. </font><font style="vertical-align: inherit;">من السهل إنشاء نفق بين زملاء لهما عنوان IP ثابت. </font><font style="vertical-align: inherit;">في حالات أخرى ، تكون العكازات والدراجات ذات العجلات المربعة والشريط الكهربائي الأزرق دائمًا على استعداد للمساعدة ، ولكن هذا ليس طريقنا. </font><font style="vertical-align: inherit;">
إيجابيات </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> دعم منصات متعددة - Windows و Linux و OpenWRT ومشتقاته ، Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> تشفير قوي ودعم الشهادة.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> مرونة التخصيص.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 والسلبيات:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> اعمل بالكامل في مساحة المستخدم.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> دعم محدود من أجهزة التوجيه المنزلية - krenenko-kosenko على Mikrotik (دون الانتقاص من المزايا الأخرى للغدد) والطبيعي في OpenWRT.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> صعوبات في إعداد برامج الأجهزة المحمولة: تحتاج إلى تنزيل أو إنشاء المثبت الخاص بك ونسخ التهيئة في مكان ما.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إذا كان هناك العديد من الأنفاق ، فإن الرقصات تنتظر مع تحرير وحدات systemd على الخادم.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect (تطبيق مفتوح المصدر لبروتوكول Cisco Anyconnect)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
هو حل مثير للاهتمام للغاية ، وهو للأسف قليل من المعلومات. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
الإيجابيات:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> يعد الدعم الواسع نسبيًا للعديد من الأنظمة الأساسية - Windows و Android و Mac استنادًا إلى تطبيق Cisco Anyconnect الأصلي من المتجر - خيارًا مثاليًا لتوفير الوصول إلى الشبكة الداخلية للأجهزة القابلة للارتداء.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> تشفير قوي ، دعم الشهادة ، اتصال 2FA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">البروتوكول نفسه قائم على TLS بالكامل (على عكس OpenVPN ، الذي يمكن اكتشافه بسهولة على المنفذ 443). </font><font style="vertical-align: inherit;">بالإضافة إلى TLS ، يتم أيضًا دعم DTLS - خلال الجلسة المحددة ، يمكن للعميل التبديل إلى إرسال البيانات عبر UDP والعكس صحيح.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> تعايش ممتاز على منفذ واحد لكل من VPN وخادم ويب كامل باستخدام sniproxy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إعداد سهل لكل من الخادم والعملاء.</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
هنا أيضًا ، لم تكن بدون سلبيات:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> اعمل بالكامل في مساحة المستخدم.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">إن TCP أعلى TCP هي فكرة سيئة.</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> لا يوجد دعم من معدات العملاء.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> تعقيد تثبيت الأنفاق بين لينكسين: ممكن نظريًا وعمليًا - من الأفضل قضاء بعض الوقت على شيء أكثر فائدة.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> إذا كان هناك العديد من الأنفاق ، فإن الرقصات مع العديد من التكوينات ووحدات تحرير النظام تنتظر.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
قد يبدو وكأنه طريق مسدود ، ولكن بعد إلقاء نظرة فاحصة وقضاء بعض الوقت في الدراسة ، أدركت أن IPSec القائم على IKEv2 قادر على استبدال كل شيء آخر. </font><font style="vertical-align: inherit;">
إيجابيات </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IKEv2 IPSEC</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> مع ظهور IKEv2 ، أصبح تكوين البروتوكول نفسه أسهل ، مقارنة بالإصدار السابق ، ولكن على حساب فقدان التوافق العكسي.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">بفضل التوحيد القياسي ، يتم توفير العمل في أي مكان وعلى أي شيء - يمكن الحفاظ على القائمة إلى أجل غير مسمى. </font><font style="vertical-align: inherit;">Linux ، Mikrotik (في أحدث إصدارات RouterOS) ، OpenWRT ، Android ، iPhone. </font><font style="vertical-align: inherit;">يحتوي Windows أيضًا على دعم أصلي بدءًا من Windows 7.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">سرعة عالية: معالجة حركة المرور بالكامل في مساحة النواة. </font><font style="vertical-align: inherit;">جزء مساحة المستخدم مطلوب فقط لإعداد معلمات الاتصال ومراقبة صحة القناة.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> القدرة على استخدام العديد من طرق المصادقة: باستخدام كل من PSK والشهادات ، وفي أي مجموعة.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">العديد من أوضاع التشغيل: النفق والنقل. </font><font style="vertical-align: inherit;">كيف تختلف يمكن قراءتها بما في ذلك على حبري.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">إعدادات غير متطلبة للعقد المتوسطة: إذا كانت هناك مشاكل ناجمة عن NAT في الإصدار الأول من IKE ، فإن IKEv2 يحتوي على آليات مدمجة للتغلب على NAT والتجزئة الأصلية لرسائل IKE ، مما يسمح لك بإنشاء اتصال على القنوات باستخدام منحنى MTU. </font><font style="vertical-align: inherit;">واستشرافا للمستقبل ، سأقول أنني لم أواجه في الواقع شبكة WiFi ، حيث يمكن للعميل إنشاء اتصال.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ومع ذلك ، فإن السلبيات تحتوي أيضًا على:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> تحتاج إلى قضاء بعض الوقت في الدراسة وفهم كيفية عملها.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ميزة يمكن أن تخلط مبتدئ: IPSec ، على عكس حلول VPN التقليدية ، لا تنشئ واجهات شبكة. </font><font style="vertical-align: inherit;">يتم تعيين سياسات معالجة حركة المرور فقط ، ويتم حل كل شيء آخر عن طريق جدار الحماية.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
قبل متابعة الإعداد ، نفترض أن القارئ بالفعل على دراية بالمفاهيم والمصطلحات الأساسية. </font><font style="vertical-align: inherit;">لمساعدة المبتدئين ، يمكنك التوصية بمقالة من </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> و Habr نفسه ، والتي تحتوي بالفعل على مقالات مفيدة ومثيرة للاهتمام حول هذا الموضوع.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الشروع في الإعداد</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بعد البت في القرار ، ننتقل إلى التكوين. </font><font style="vertical-align: inherit;">يحتوي مخطط الشبكة في حالتي على الشكل التالي (تمت إزالته تحت المفسد)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">رسم تخطيطي للشبكة</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> هو الخادم الرئيسي الذي يعد مركز الشبكة. IP الخارجي 1.1.1.1. شبكة داخلية 10.0.0.0/23 وعنوان آخر 10.255.255.1/30 لإعداد جلسة BGP خاصة مع VPS ؛ </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ماما</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> هو موجه لينكس مبني على شبكة صغيرة صامتة مثبتة من قبل الوالدين. يصدر ISP عنوان IP ديناميكي. الشبكة الداخلية 10.0.3.0/24 ؛ </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keenetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - موجه </font><b><font style="vertical-align: inherit;">حركي</font></b><font style="vertical-align: inherit;"> مع تثبيت IPSec. يصدر ISP عنوان IP ديناميكي. الشبكة الداخلية 10.0.4.0/24 ؛ </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">محاربو الطرق</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - أجهزة محمولة متصلة من شبكات غير موثوقة. يتم إصدار العناوين للعملاء بشكل ديناميكي عند الاتصال من التجمع الداخلي (10.1.1.0/24) ؛ </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- VPS خارج نطاق اختصاص ILV محترم. </font><font style="vertical-align: inherit;">IP الخارجي - 5.5.5.5 ، العنوان الداخلي 10.255.255.2/30 لإعداد جلسة BGP خاصة.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الخطوة الأولى. </font><font style="vertical-align: inherit;">من البسيط إلى المعقد: الأنفاق باستخدام المفاتيح المشتركة مسبقًا (PSK)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نقوم بتثبيت الحزم الضرورية على كل من علب Linux:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على كلا المضيفين ، افتح المنافذ 500 / UDP و 4500 / UDP واسمح بمرور بروتوكول ESP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
قم بتحرير الملف /etc/strongswan/ipsec.secrects (على جانب المضيف ipsecgw.example.com) وأضف السطر التالي:</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على الجانب الثاني بالمثل:</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
في هذه الحالة ، المعرّف هو عنوان بريد إلكتروني وهمي. </font><font style="vertical-align: inherit;">يمكن العثور على مزيد من المعلومات في </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الويكي</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> الرسمي </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
حفظ الأسرار ، والمضي قدما. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على مضيف ipsecgw.example.com ، قم بتحرير الملف /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وبالمثل ، نقوم بتحرير الأقران عن بعد /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إذا قارنت التكوينات ، يمكنك أن ترى أنها متطابقة تقريبًا ، فقط يتم تبادل تعريفات النظراء. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
التوجيه </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">التلقائي =</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> توجيه </font><font style="vertical-align: inherit;">يؤدي charon إلى تعيين فخ لحركة المرور التي تقع في توجيهات right / Rightsubnet (محددات حركة المرور). </font><font style="vertical-align: inherit;">سيبدأ تنسيق معلمات النفق وتبادل المفاتيح فور ظهور حركة المرور التي تقع تحت الظروف المحددة. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على خادم ipsecgw.example.com في إعدادات جدار الحماية ، نحظر التنكر لشبكة 10.0.3.0/24. </font><font style="vertical-align: inherit;">السماح بإعادة توجيه الحزم بين 10.0.0.0/23 و 10.0.3.0/24 والعكس. </font><font style="vertical-align: inherit;">على المضيف البعيد ، نقوم بتنفيذ إعدادات مماثلة عن طريق تعطيل التنكر لشبكة 10.0.0.0/23 وإعداد إعادة التوجيه. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نعيد تشغيل strongswan على كلا الخادمين ونحاول تنفيذ الأمر ping على العقدة المركزية:</font></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تأكد من أن كل شيء يعمل:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
سيكون من المفيد أيضًا التأكد من تعيين المعلمة make_before_break على "نعم" في ملف /etc/strongswan/strongswan.d/charon.conf لدى جميع الأقران. </font><font style="vertical-align: inherit;">في هذه الحالة ، لن يحذف برنامج charon الذي يخدم بروتوكول IKEv2 اقتران الأمان الحالي أثناء إجراء تغيير المفتاح ، ولكنه سينشئ واحدًا جديدًا أولاً.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الخطوة الثانية </font><font style="vertical-align: inherit;">ظهور الحركية</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
كانت المفاجأة السارة هي IPSec VPN المدمج في البرنامج الثابت الرسمي Keenetic. </font><font style="vertical-align: inherit;">لتنشيطه ، ما عليك سوى الانتقال إلى </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">إعدادات مكونات KeeneticOS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> وإضافة حزمة </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec VPN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نجهز الإعدادات على العقدة المركزية لهذا: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تحرير /etc/strongswan/ipsec.secrects وإضافة PSK للنظير الجديد:</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تحرير /etc/strongswan/ipsec.conf وإضافة اتصال آخر إلى النهاية:</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على الجانب الحركي ، يتم التهيئة في WebUI على طول المسار: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الإنترنت -&gt; اتصالات -&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
اتصالات أخرى</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">إنه بسيط للغاية</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3 صور)</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
إذا كنت تخطط لقيادة كميات كبيرة من حركة المرور عبر النفق ، فيمكنك محاولة تمكين تسريع الأجهزة ، والذي تدعمه العديد من النماذج. </font><font style="vertical-align: inherit;">ممكّن بواسطة أمر </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">أجهزة محرك التشفير</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> في CLI. </font><font style="vertical-align: inherit;">لتعطيل عمليات التشفير والتجزئة ومعالجتها باستخدام تعليمات وحدة المعالجة المركزية للأغراض العامة - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">برنامج محرك التشفير</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
بعد حفظ الإعدادات ، نقوم باستعادة القوي ونترك Keenetic يفكر لمدة نصف دقيقة. </font><font style="vertical-align: inherit;">ثم نرى في المحطة اتصال ناجح:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">كل شيء يعمل:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الخطوة الثالثة </font><font style="vertical-align: inherit;">حماية الأجهزة المحمولة</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بعد قراءة مجموعة من الكتيبات ومجموعة من المقالات ، تقرر التوقف عند مجموعة من شهادة مجانية من Let's Encrypt لمصادقة الخادم والتفويض الكلاسيكي عن طريق تسجيل الدخول وكلمة المرور للعملاء. </font><font style="vertical-align: inherit;">وبالتالي ، نتخلص من الحاجة إلى الحفاظ على البنية التحتية للمفاتيح العمومية الخاصة بنا ، ومراقبة انتهاء صلاحية المفاتيح وإجراء إيماءات غير ضرورية مع الأجهزة المحمولة عن طريق تثبيت الشهادات الموقعة ذاتيًا في القائمة الموثوقة. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
قم بتثبيت الحزم المفقودة:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نحصل على الشهادة المستقلة (لا تنس أن تفتح 80 / tcp في إعدادات iptables أولاً):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بعد انتهاء سيرتبوت من عملها ، يجب أن نعلم سترونجسوان لرؤية شهادتنا:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في الدليل /etc/strongswan/ipsec.d/cacerts أنشئ رابطين رمزيين: أحدهما إلى المتجر الجذري للشهادات الموثوق بها في / etc / pki / tls / certs ؛ </font><font style="vertical-align: inherit;">وثانية باسم ca.pem تشير إلى /etc/letsencrypt/live/ipsecgw.example.com/chain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">يتم أيضًا إنشاء ارتباطين رمزيين في دليل /etc/strongswan/ipsec.d/certs: يشير الأول ، الذي يحمل اسم Certificate.pem ، إلى الملف /etc/letsencrypt/live/ipsecgw.example.com/cert.pem. </font><font style="vertical-align: inherit;">والثاني ، يدعى fullchain.pem ، ويرتبط بـ /etc/letsencrypt/live/ipsecgw.example.com/fullchain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">في الدليل /etc/strongswan/ipsec.d/private ، ضع الرابط الرمزي key.pem الذي يشير إلى المفتاح الخاص الذي تم إنشاؤه بواسطة certbot والوقوف على المسار /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أضف المصادقة عبر RSA إلى ipsec.secrets ومجموعة من تسجيلات الدخول / كلمات المرور للمستخدمين الجدد:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نعيد تشغيل Strongswan وعند استدعاء قوائم sudo strongswan يجب أن نرى معلومات الشهادة:</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ثم نصف الاتصال الجديد في </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لا تنس تحرير الملف / etc / sysconfig / certbot للإشارة إلى أننا سنقوم أيضًا بتحديث الشهادة على أنها قائمة بذاتها ، مع إضافة CERTBOT_ARGS = "- مستقل" إليها. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أيضًا ، لا تنس تشغيل موقت certbot-تجديد.timer وتعيين الخطاف لإعادة تشغيل Strongswan في حالة إصدار شهادة جديدة. </font><font style="vertical-align: inherit;">للقيام بذلك ، إما أن تضع نص bash بسيطًا في / etc / allowencrypt / تجديد التجديد / النشر / ، أو قم بتحرير ملف / etc / sysconfig / certbot مرة أخرى. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نعيد تشغيل Strongswan ، ونقوم بتشغيل التنكر لشبكة 10.1.1.0/24 في iptables ونستمر في تكوين الأجهزة المحمولة.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ذكري المظهر</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
قم بتثبيت تطبيق </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> من Google Play </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أطلقنا وخلق جديد</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الملف الشخصي</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نحن نحفظ الملف الشخصي ، ونتصل ، وبعد ثانية ، لا داعي للقلق بشأن قدرة شخص ما على التجسس علينا.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">نحن نفحص:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">شبابيك</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
فوجئت Windows من الإصدارات الحالية سارة. </font><font style="vertical-align: inherit;">تتم جميع إعدادات VPN الجديدة عن طريق استدعاء cmdlets PowerShell cmdlets:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وهناك شيء آخر ، إذا تم تكوين Strongswan لإصدار عناوين IPv6 للعملاء (نعم ، يمكنه القيام بذلك أيضًا):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الجزء الرابع ، النهائي. </font><font style="vertical-align: inherit;">قطعنا نافذة إلى أوروبا</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بعد أن رأيت بذرة المزود "تم حظر الموقع بقرار الكعب الأيسر للنائب الخامس للمدعي العام لقرية ترودوفي موزولي من مقاطعة بوغوزابييت" ، ظهر VPS صغير غير واضح (مع اسم المجال الذي يبدو جيدًا rkn.example.com) على بعد ألف كيلومتر من القرود التي ترغب في التلويح بحاجز للحجب وحجب شبكات الحجم. / 16 مرة. وكان الغزل على VPS الصغير هذا إنشاءًا رائعًا لزملاء من NIC.CZ يسمى BIRD. توفي طائر الإصدار الأول باستمرار في حالة من الذعر من نشاط القرود بالهراوات ، الذين حظروا ما يقرب من 4 ٪ من الإنترنت في ذروة نشاط المخاض ، تاركين التفكير العميق أثناء إعادة التكوين ، لذلك تم تحديثه إلى الإصدار 2.0.7. إذا كان القراء مهتمين ، فسأنشر مقالًا عن الانتقال من BIRD إلى BIRD2 ، والذي تغير فيه تنسيق التكوين بشكل كبير ،لكن الإصدار الجديد أصبح أسرع بكثير ولا توجد مشاكل في إعادة التشكيل بعدد كبير من المسارات. وبما أننا نستخدم بروتوكول التوجيه الديناميكي ، فيجب أن تكون هناك واجهة شبكة تحتاج من خلالها إلى توجيه حركة المرور. بشكل افتراضي ، لا يقوم IPSec بإنشاء واجهات ، ولكن نظرًا لمرونته ، يمكننا استخدام أنفاق GRE الكلاسيكية ، والتي سنحميها في المستقبل. كمكافأة ، سيقوم مضيفو ipsecgw.example.com و rkn.example.com بمصادقة بعضهما البعض باستخدام شهادات التجديد الذاتي Lets Encrypt. لا يوجد PSK ، فقط الشهادات ، المتشددين فقط ، ليس هناك الكثير من الأمان.بشكل افتراضي ، لا يقوم IPSec بإنشاء واجهات ، ولكن نظرًا لمرونته ، يمكننا استخدام أنفاق GRE الكلاسيكية ، والتي سنحميها في المستقبل. كمكافأة ، سيقوم مضيفو ipsecgw.example.com و rkn.example.com بمصادقة بعضهما البعض باستخدام شهادات التجديد الذاتي Lets Encrypt. لا يوجد PSK ، فقط الشهادات ، المتشددين فقط ، ليس هناك الكثير من الأمان.بشكل افتراضي ، لا يقوم IPSec بإنشاء واجهات ، ولكن نظرًا لمرونته ، يمكننا استخدام أنفاق GRE الكلاسيكية ، والتي سنحميها في المستقبل. كمكافأة ، سيقوم مضيفو ipsecgw.example.com و rkn.example.com بمصادقة بعضهما البعض باستخدام شهادات التجديد الذاتي Lets Encrypt. لا يوجد PSK ، فقط الشهادات ، المتشددين فقط ، ليس هناك الكثير من الأمان.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نعتقد أن VPS جاهز ، وقد تم تثبيت Strongswan و Certbot بالفعل. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على مضيف ipsecgw.example.com (عنوان IP الخاص به هو 1.1.1.1) ، نصف واجهة gif0 الجديدة:</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
معكوسة على المضيف vps.example.com (عنوان IP هو 5.5.5.5):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نرفع الواجهات ، ولكن نظرًا لأن iptables لا يحتوي على قاعدة تسمح ببروتوكول GRE ، فلن تنتقل حركة المرور (وهو ما نحتاج إليه ، نظرًا لعدم وجود حماية داخل GRE ضد المعجبين من أي نوع من "الحزم" التشريعية).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الطبخ VPS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
أولاً ، نحصل على شهادة أخرى لاسم النطاق rkn.example.com. </font><font style="vertical-align: inherit;">قم بإنشاء روابط رمزية في /etc/strongswan/ipsec.d كما هو موضح في القسم السابق. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
قم بتعديل ipsec.secrets بإضافة سطر واحد إليها:</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
تحرير ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على جانب المضيف ، تمت إضافة ipsecgw.example.com أيضًا إلى ipsec.conf في قسم الإعداد المعلمة الصارمة = نعم ، والتي تتضمن فحص CRL الصارم. </font><font style="vertical-align: inherit;">ووصف اتصال آخر:</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يتم عكس Conf Confs تقريبًا. </font><font style="vertical-align: inherit;">يمكن للقارئ اليقظ بالفعل الانتباه إلى نقطتين:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left / Rightsubnet =٪ dynamic - يوجه Strongswan إلى تطبيق السياسات على جميع أنواع الزيارات بين أقرانهم</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لا تنسَ تكوين شهادات جدار الحماية والتجديد التلقائي. </font><font style="vertical-align: inherit;">بعد إعادة تشغيل Strongswan على كلا الخادمين ، ابدأ تنفيذ الأمر ping على الجانب البعيد من نفق GRE وشاهد اتصال ناجح. </font><font style="vertical-align: inherit;">على VPS (rkn):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وعلى الجانب المضيف ipsecgw </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">تحت المفسد</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يتم تثبيت النفق ، تذهب الأصوات ، في tcpdump ، من الواضح أن ESP ينتقل فقط بين المضيفين. </font><font style="vertical-align: inherit;">يبدو من الممكن أن نفرح. </font><font style="vertical-align: inherit;">ولكن لا يمكنك الاسترخاء دون التحقق من كل شيء حتى النهاية. </font><font style="vertical-align: inherit;">نحن نحاول إعادة إصدار شهادة VPS و ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">طاه ، كل شيء مكسور</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
نبدأ في فهم وإيجاد ميزة غير سارة في Let's Encrypt ، وهي جميلة في كل شيء آخر - مع أي إعادة إصدار للشهادة ، يتغير المفتاح الخاص المرتبط بها أيضًا. المفتاح الخاص تغير - والجمهور تغير. للوهلة الأولى ، فإن الوضع ميئوس منه بالنسبة لنا: حتى إذا تمكنا من استخراج المفتاح العام بسهولة أثناء إعادة إصدار الشهادة باستخدام الخطاف في سيرتبوت وتمريره إلى الجانب البعيد عبر SSH ، فليس من الواضح كيفية جعل Strongswan البعيد يعيد قراءته. ولكن المساعدة أتت من حيث لم ينتظروا - يستطيع systemd مراقبة التغييرات في نظام الملفات وتشغيل الخدمات المرتبطة بالحدث. سوف نستفيد من هذا.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
سننشئ مستخدم خدمة Keywatcher على كل مضيف له الحقوق الأكثر تقييدًا ، وننشئ مفاتيح SSH لكل منهم ، ونقوم بتبادلها بين المضيفين. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على مضيف ipsecgw.example.com ، أنشئ دليل / opt / ipsec-pubkey الذي نضع فيه سكريبتَين.</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على VPS (المضيف rkn.example.com) ، نقوم بالمثل بإنشاء دليل بنفس الاسم ، حيث نقوم أيضًا بإنشاء نصوص مشابهة ، مع تغيير اسم المفتاح فقط. </font><font style="vertical-align: inherit;">كود ، حتى لا تشوش المادة ، تحت</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">المفسد</font></font></b>
                        <div class="spoiler_text">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
مطلوب البرنامج النصي pubkey-copy.sh لاستخراج الجزء العام من المفتاح ونسخه إلى المضيف البعيد عند إصدار شهادة جديدة. </font><font style="vertical-align: inherit;">للقيام بذلك ، في / etc / letencrypt / تجديد التجديدات / نشر الدليل على كلا الخادمين ، قم بإنشاء نص مصغر آخر:</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يتم حل نصف المشكلة ، وإعادة إصدار الشهادات ، واستخراج المفاتيح العامة ونسخها بين الخوادم ، وقد حان الوقت لنظام systemd مع وحدات المسار الخاصة به. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
على خادم ipsecgw.example.com في دليل / etc / systemd / system ، أنشئ ملف keyupdater.path</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وبالمثل على مضيف VPS:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
وأخيرًا ، على كل خادم نقوم بإنشاء خدمة مرتبطة بهذه الوحدة ، والتي سيتم إطلاقها عند تحقق الشرط (PathChanged) - تغيير الملف وإغلاقه بعد التسجيل. </font><font style="vertical-align: inherit;">نقوم بإنشاء الملفات /etc/systemd/system/keyupdater.service ونكتب:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
لا تنسى إعادة قراءة تكوينات systemd مع sudo systemctl daemon-reload وتعيين التشغيل التلقائي لوحدات المسار عبر sudo systemctl تمكين keyupdater.path &amp;&amp; sudo systemctl start keyupdater. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بمجرد أن يكتب المضيف البعيد الملف الذي يحتوي على المفتاح العام إلى الدليل الرئيسي لمستخدم مراقب المفاتيح ويتم إغلاق واصف الملف ، سيقوم systemd تلقائيًا بتشغيل الخدمة المقابلة ، والتي ستنسخ المفتاح إلى الموقع المطلوب وإعادة تشغيل Strongswan. </font><font style="vertical-align: inherit;">سيتم تثبيت النفق باستخدام المفتاح العام الصحيح للجانب الثاني. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
يمكنك الزفير والاستمتاع بالنتيجة.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">بدلا من الاستنتاج</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
كما رأينا للتو </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">الجحيم</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> أمن بروتوكول الإنترنت ليس كما مخيفة كما رسمها. </font><font style="vertical-align: inherit;">كل ما تم وصفه هو تكوين كامل التشغيل قيد الاستخدام حاليًا. </font><font style="vertical-align: inherit;">حتى بدون الكثير من المعرفة ، يمكنك تكوين VPN وحماية بياناتك بشكل موثوق. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
بالطبع ، ظلت لحظات إعداد iptables خارج نطاق المقالة ، ولكن تبين أن المقالة نفسها كانت ضخمة بالفعل ، وقد كتب الكثير عن iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
هناك نقاط في المقالة يمكن تحسينها ، سواء رفض إعادة تشغيل برنامج Strongswan ، وإعادة قراءة التكوينات والشهادات ، ولكن لم أستطع تحقيق ذلك. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ومع ذلك ، لم تكن عمليات إعادة تشغيل البرنامج الخفي مخيفة: فقد واحد أو اثنين من الأصوات بين النظراء ، واستعادة عملاء الجوّال الاتصال بأنفسهم.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
آمل أن يدفع الزملاء في التعليقات إلى الحل الصحيح.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar504464/index.html">كيف توصلنا إلى TableAdapter وتبسيط العمل مع UITableView</a></li>
<li><a href="../ar504468/index.html">أداء Raspberry Pi: أضف ZRAM وغيّر معلمات kernel</a></li>
<li><a href="../ar504472/index.html">أفضل أدوات المطور المجانية</a></li>
<li><a href="../ar504480/index.html">كيف تجد مسوقًا يكون معه مربحًا للعمل؟</a></li>
<li><a href="../ar504482/index.html">اسألنا: ستجيب DIT على الأسئلة</a></li>
<li><a href="../ar504486/index.html">العملية: إنشاء Vue 3</a></li>
<li><a href="../ar504488/index.html">ما هي الصناعات والتقنيات التي ستبدأ في التطور بسرعة بعد حل مشكلة COVID-19</a></li>
<li><a href="../ar504490/index.html">ملخص أحداث يونيو أون لاين</a></li>
<li><a href="../ar504492/index.html">اضغط الزر: نظرية وممارسة التصويت الإلكتروني - مائدة مستديرة في 30 مايو</a></li>
<li><a href="../ar504502/index.html">الحياة القصيرة والغريبة لأول روبوت صديق في العالم</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>