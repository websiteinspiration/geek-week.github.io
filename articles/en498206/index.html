<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèº üôâ üö´ Create a graphql backend on Golang üìº üéÇ üî†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will develop an application in Golang + GraphQL. 
 
 We often use GraphQL in our projects and we know a lot about it, used it together with v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Create a graphql backend on Golang</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498206/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Today we will develop an application in Golang + GraphQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We often use GraphQL in our projects and we know a lot about it, used it together with various programming languages: Javascript, Ruby and now our hands have reached the point of trying the Golang GraphQL bunch.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lot has been said about the advantages of GraphQL query language on the Internet, many praise it for its simplicity, flexibility and convenience, both when used on the server side and on the client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For convenient development using GraphQL, GraphiQL or GraphQL Playground is often configured - an interface for sending requests and viewing API documentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To deploy such a Playground locally, it is enough to use this open source solution - Golang HTTP.Handler for graphl-go. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/872/fcf/818/872fcf818836ec2689737c639fb7beff.png" alt="graphql playground golang"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks like a running playground. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's move on to writing a small application, an example of which will figure out how to work with GraphQL and Go. The full application code can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the link on Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we‚Äôll start the server and the playground.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
  schema, err := graphql.NewSchema(defineSchema()) <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
     log.Panic(<span class="hljs-string">"Error when creating the graphQL schema"</span>, err)<font></font>
  }<font></font>
<font></font>
  h := handler.New(&amp;handler.Config{<font></font>
     Schema:     &amp;schema,<font></font>
     Pretty:     <span class="hljs-literal">true</span>,<font></font>
     GraphiQL:   <span class="hljs-literal">false</span>,<font></font>
     Playground: <span class="hljs-literal">true</span>,<font></font>
  }) <span class="hljs-comment">//      FormatErrorFn -    </span><font></font>
<font></font>
  http.Handle(<span class="hljs-string">"/graphql"</span>, h) <span class="hljs-comment">//      playground    </span>
  err = http.ListenAndServe(<span class="hljs-string">":8080"</span>, <span class="hljs-literal">nil</span>)
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
     log.Panic(<span class="hljs-string">"Error when starting the http server"</span>, err)<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not a single graphql backend can do without a description of the circuit; now we will analyze its description.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">var</span> User = graphql.NewObject(<font></font>
  graphql.ObjectConfig{<font></font>
     Name: <span class="hljs-string">"User"</span>,<font></font>
     Fields: graphql.Fields{<font></font>
        <span class="hljs-string">"_id"</span>: &amp;graphql.Field{<font></font>
           Type: ObjectID,<font></font>
        },<font></font>
        <span class="hljs-string">"firstName"</span>: &amp;graphql.Field{<font></font>
           Type: graphql.String,<font></font>
        },<font></font>
        <span class="hljs-string">"lastName"</span>: &amp;graphql.Field{<font></font>
           Type: graphql.String,<font></font>
        },<font></font>
        <span class="hljs-string">"email"</span>: &amp;graphql.Field{<font></font>
           Type: graphql.String,<font></font>
        },<font></font>
     },<font></font>
  },<font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">var</span> UserInput = graphql.NewInputObject(<font></font>
  graphql.InputObjectConfig{<font></font>
     Name: <span class="hljs-string">"UserInput"</span>,<font></font>
     Fields: graphql.InputObjectConfigFieldMap{<font></font>
        <span class="hljs-string">"firstName"</span>: &amp;graphql.InputObjectFieldConfig{<font></font>
           Type: graphql.String,<font></font>
        },<font></font>
        <span class="hljs-string">"lastName"</span>: &amp;graphql.InputObjectFieldConfig{<font></font>
           Type: graphql.Int,<font></font>
        },<font></font>
        <span class="hljs-string">"email"</span>: &amp;graphql.InputObjectFieldConfig{<font></font>
           Type: graphql.String,<font></font>
        },<font></font>
     },<font></font>
  },<font></font>
)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">defineSchema</span><span class="hljs-params">()</span> <span class="hljs-title">graphql</span>.<span class="hljs-title">SchemaConfig</span></span> {
  <span class="hljs-keyword">return</span> graphql.SchemaConfig{<font></font>
     Query: graphql.NewObject(graphql.ObjectConfig{<font></font>
        Name: <span class="hljs-string">"Query"</span>,<font></font>
        Fields: graphql.Fields{<font></font>
           <span class="hljs-string">"users"</span>: &amp;graphql.Field{<font></font>
              Name:    <span class="hljs-string">"users"</span>,<font></font>
              Type:    graphql.NewList(User),<font></font>
              Resolve: usersResolver,<font></font>
           },<font></font>
        },<font></font>
     }),<font></font>
     Mutation: graphql.NewObject(graphql.ObjectConfig{<font></font>
        Name: <span class="hljs-string">"Mutation"</span>,<font></font>
        Fields: graphql.Fields{<font></font>
           <span class="hljs-string">"addUser"</span>: &amp;graphql.Field{<font></font>
              Name:    <span class="hljs-string">"addUser"</span>,<font></font>
              Type:    User,<font></font>
              Resolve: addUserResolver,<font></font>
              Args: graphql.FieldConfigArgument{<font></font>
                 <span class="hljs-string">"input"</span>: &amp;graphql.ArgumentConfig{<font></font>
                    Type: UserInput,<font></font>
                 },<font></font>
              },<font></font>
           },<font></font>
        },<font></font>
     })}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Above, we described the User type with the fields _id, firstName, lastName and email, which we will use as the type of response to requests. </font><font style="vertical-align: inherit;">The _id field is of type ObjectID, which is a custom type, since it was necessary to serialize the native ObjectID type MongoDB, which is a structure of this kind.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> InsertOneResult <span class="hljs-keyword">struct</span> {<font></font>
  InsertedID <span class="hljs-keyword">interface</span>{}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To describe the input parameters to the mutation for adding a user, the UserInput type was created containing 3 optional fields that describe our user. </font><font style="vertical-align: inherit;">The _id field is absent in this type, since it will be generated in the resolver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To connect to mongodb, this project uses the golang mongodb driver.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">usersCollection</span><span class="hljs-params">()</span> *<span class="hljs-title">mongo</span>.<span class="hljs-title">Collection</span></span> { <span class="hljs-comment">// ,   users    </span>
  ctx, _ := context.WithTimeout(context.Background(), <span class="hljs-number">10</span>*time.Second)<font></font>
  client, err := mongo.NewClient(options.Client().ApplyURI(<span class="hljs-string">"mongodb://mongo:27017"</span>))
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
     log.Panic(<span class="hljs-string">"Error when creating mongodb connection client"</span>, err)<font></font>
  }<font></font>
  collection := client.Database(<span class="hljs-string">"testing"</span>).Collection(<span class="hljs-string">"users"</span>)<font></font>
  err = client.Connect(ctx)<font></font>
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
     log.Panic(<span class="hljs-string">"Error when connecting to mongodb"</span>, err)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> collection<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//      </span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">usersResolver</span><span class="hljs-params">(_ graphql.ResolveParams)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>{}, error)</span></span> {<font></font>
  ctx, _ := context.WithTimeout(context.Background(), <span class="hljs-number">10</span>*time.Second)<font></font>
  collection := usersCollection()<font></font>
  result, err := collection.Find(ctx, bson.D{})<font></font>
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
     log.Print(<span class="hljs-string">"Error when finding user"</span>, err)
     <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">defer</span> result.Close(ctx)<font></font>
<font></font>
  <span class="hljs-keyword">var</span> r []bson.M<font></font>
  err = result.All(ctx, &amp;r)<font></font>
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
     log.Print(<span class="hljs-string">"Error when reading users from cursor"</span>, err)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> r, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//     </span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addUserResolver</span><span class="hljs-params">(p graphql.ResolveParams)</span> <span class="hljs-params">(<span class="hljs-keyword">interface</span>{}, error)</span></span> {<font></font>
  ctx, _ := context.WithTimeout(context.Background(), <span class="hljs-number">10</span>*time.Second)<font></font>
  collection := usersCollection()<font></font>
  <span class="hljs-comment">//         ,   _id</span>
  id, err := collection.InsertOne(ctx, p.Args[<span class="hljs-string">"input"</span>])
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
     log.Print(<span class="hljs-string">"Error when inserting user"</span>, err)
     <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">var</span> result bson.M
  <span class="hljs-comment">//       _id</span>
  err = collection.FindOne(ctx, bson.M{<span class="hljs-string">"_id"</span>: id.InsertedID}).Decode(&amp;result)
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
     log.Print(<span class="hljs-string">"Error when finding the inserted user by its id"</span>, err)
     <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> result, <span class="hljs-literal">nil</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we processed the user acquisition and mutation request using mongodb as a place to store user data. Instead of this database, you could use any other without any problems, both non-relational and relational, because GraphQL does not limit us in choosing a database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I used docker compose to bundle golang and mongodb. For this, I described a small settings file. </font><font style="vertical-align: inherit;">
Everything is ready. </font><font style="vertical-align: inherit;">
A couple of golang mongo technologies allows us to store user data in a convenient form for further return from GraphQL queries.</font></font><br>
<br>
<code>version: '3'<br>
services:<br>
 graphql:<br>
 image: golang<br>
 volumes:<br>
 - .:/go/src<br>
 command: /bin/bash -c "cd src &amp;&amp; go run *.go"<br>
 ports:<br>
 - 8080:8080<br>
 mongo:<br>
 image: mongo<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, this application turned out to be quite simple and compact. </font><font style="vertical-align: inherit;">And it can be taken as a basis for your next project and supplemented with new types, requests and mutations, and other functionality. </font><font style="vertical-align: inherit;">This time we did not consider examples of implementation of some more interesting GraphQL features, for example, subscription. </font><font style="vertical-align: inherit;">Perhaps I will continue this example in the future, so leave comments if something was missing for you in this article and in the next part we will definitely consider this.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498192/index.html">Steroid Cosmetic Bag: XD Design Urban Bumbag Review</a></li>
<li><a href="../en498194/index.html">Service Locator - Dispelling Myths</a></li>
<li><a href="../en498196/index.html">FunCorp is looking for QA engineers: go through an interview and receive an offer on the same day</a></li>
<li><a href="../en498200/index.html">Data Platform for regulatory reporting</a></li>
<li><a href="../en498202/index.html">Landing Digest. Information Security Specialist</a></li>
<li><a href="../en498208/index.html">Security Week 17: Implications of Linux Server Attack</a></li>
<li><a href="../en498214/index.html">Maria Popova: ‚ÄúSome first learned about OpenStreetMap due to the fact that they marked hogweed on the map‚Äù</a></li>
<li><a href="../en498216/index.html">Coloring texts in html and React</a></li>
<li><a href="../en498218/index.html">As I wrote music from cosmic rays</a></li>
<li><a href="../en498220/index.html">How coronavirus (COVID-XX) can help 1C take over the world?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>