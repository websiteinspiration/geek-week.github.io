<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✌🏾 🖇️ 🕺 Comment exécuter cron plus d'une fois par minute en utilisant PHP 🤞🏿 👸 👨🏻‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le fichier de configuration classique pour les entrées de tâches cron dans le système d'exploitation Linux est le suivant:
 
 

# ┌───────────── (0 - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment exécuter cron plus d'une fois par minute en utilisant PHP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498934/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le fichier de configuration classique pour les entrées de tâches cron dans le système d'exploitation Linux est le suivant:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># ┌─────────────  (0 - 59)</span>
<span class="hljs-comment"># │ ┌─────────────  (0 - 23)</span>
<span class="hljs-comment"># │ │ ┌─────────────  (1 - 31)</span>
<span class="hljs-comment"># │ │ │ ┌─────────────  (1 - 12)</span>
<span class="hljs-comment"># │ │ │ │ ┌─────────────   (0 - 6)</span>
<span class="hljs-comment"># │ │ │ │ │</span>
<span class="hljs-comment"># * * * * * &lt;  &gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cinq premiers paramètres indiquent le temps d'exécution de cette tâche, et le sixième - la commande elle-même, qui doit être exécutée. Les paramètres horaires sont: minutes, heures, jours, mois et jour de la semaine. De plus, tous les nombres doivent être représentés sous forme d'entiers ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sous forme de syntaxe spéciale</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, l'intervalle minimum possible pour lancer une commande est une fois par minute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour de nombreuses tâches, l'exécution des commandes est nécessaire beaucoup plus souvent, par exemple toutes les 10 secondes. Pour certaines tâches d'automatisation des processus métier, le délai maximal autorisé n'est souvent pas supérieur à 1 à 1,5 seconde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, le cron classique ne convient pas à cela - il doit être amélioré.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui suit est une implémentation pas à pas de la création de fonctionnalités supplémentaires (en PHP) au cron classique sous Linux en utilisant une protection supplémentaire contre les processus de redémarrage.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration des tâches et configuration cron</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, nous utiliserons la tâche suivante:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En frontal, l'utilisateur peut lancer l'exécution d'une tâche complexe en cliquant sur le bouton "Exécuter";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur principal après avoir écrit une nouvelle ligne dans la base de données informe l'utilisateur de la confirmation;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grâce à cron, nous allons «suivre» ces nouvelles tâches et les terminer le plus rapidement possible afin que l'utilisateur n'obtienne pas le résultat en une minute, mais immédiatement *.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Si vous utilisez le lancement des commandes, juste par minute, alors la tâche commencera lorsque les secondes atteindront le zéro le plus proche (le début d'une nouvelle minute). </font><font style="vertical-align: inherit;">Par conséquent, dans la forme classique, l'utilisateur devra attendre l'exécution de 0 à 59 secondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, cron sera configuré dans sa forme maximale, c'est-à-dire </font><font style="vertical-align: inherit;">une fois par minute:</font></font><br>
<br>
<pre><code class="bash hljs">* * * * * /usr/bin/php -q /run.php &gt; /dev/null 2&gt;&amp;1
<span class="hljs-comment">#/usr/bin/php -    PHP   (      )</span>
<span class="hljs-comment">#/run.php -   PHP   </span>
<span class="hljs-comment">#&gt; /dev/null 2&gt;&amp;1 - ,            run.php</span>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cycle unique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialement, vous devez décider de la fréquence à laquelle nous demanderons de nouvelles tâches dans la base de données - en fonction de cela, le nombre de cycles et la veille logique (fonction </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>sleep</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">changeront. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'exemple actuel, une étape de 10 secondes est utilisée. </font><font style="vertical-align: inherit;">Par conséquent, le nombre de cycles est de 60/10 = 6. Total, le code général est le suivant:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">for</span> ($cycle = <span class="hljs-number">1</span>; $cycle &lt;= <span class="hljs-number">6</span>; $cycle++) { <span class="hljs-comment"># 6 </span>
    $all_tasks = get_all_tasks(); <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">if</span> ($all_tasks) { <span class="hljs-comment">#    - </span>
        <span class="hljs-keyword">foreach</span>($all_tasks <span class="hljs-keyword">as</span> $one_task) { <span class="hljs-comment">#     </span>
            solve_one_task($one_task); <span class="hljs-comment">#  </span><font></font>
        }<font></font>
    }<font></font>
    sleep(<span class="hljs-number">10</span>); <span class="hljs-comment">#  ,  ""  10 </span><font></font>
}<font></font>
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clarification</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : dans cet exemple, une étape de 10 secondes est utilisée, ce qui peut fournir un intervalle minimum d'exécution de script une fois toutes les 10 secondes. </font><font style="vertical-align: inherit;">Par conséquent, pour une exécution plus fréquente, vous devez modifier le nombre de cycles et le "temps de sommeil".</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Éviter l'exécution répétée de tâches</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la forme présentée, il y a une incertitude, à savoir l'exécution répétée de la tâche si elle a déjà été lancée. </font><font style="vertical-align: inherit;">Cela devient particulièrement vrai si la tâche est "difficile" et nécessite quelques secondes pour la mettre en œuvre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela crée un problème de réexécution:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fonction est </font></font><code>solve_one_task()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déjà en cours d'exécution, mais n'a pas encore terminé son travail;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par conséquent, dans la base de données, la tâche est toujours marquée comme non exécutée;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le cycle suivant récupérera cette tâche et exécutera à </font></font><code>solve_one_task()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nouveau </font><font style="vertical-align: inherit;">la fonction </font><font style="vertical-align: inherit;">, avec la même tâche.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, cela peut être résolu, par exemple, en modifiant un état dans la base de données pour cette tâche. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous ne chargerons pas la base de données: sur la base de mes tests, MYSQL peut accepter la demande, mais pas la traiter immédiatement. </font><font style="vertical-align: inherit;">Une différence de 0,5 seconde peut entraîner des exécutions répétées, ce qui n'est absolument pas approprié. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas également, nous ne parlons que de l'état des tâches, il est donc préférable d'utiliser le système de fichiers du serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le modèle de vérification de base est construit à l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>flock</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- une fonction qui définit et déverrouille un fichier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En exécution PHP, la fonction peut être représentée comme suit:</font></font><br>
<br>
<pre><code class="php hljs">$lock_file_abs = <span class="hljs-string">'file'</span>; <span class="hljs-comment">#  </span>
$fp = fopen($lock_file_abs,<span class="hljs-string">"w+"</span>); <span class="hljs-comment">#   </span>
<span class="hljs-keyword">if</span> (flock($fp, LOCK_EX | LOCK_NB)) { <span class="hljs-comment">#,    </span>
    solve_one_task($one_task); <span class="hljs-comment">#  </span>
    flock($fp, LOCK_UN); <span class="hljs-comment">#   ,     </span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> {
    <span class="hljs-comment">#,   , ..       </span><font></font>
}<font></font>
fclose($fp); <span class="hljs-comment">#   </span>
unlink($lock_file_abs); <span class="hljs-comment"># ,   </span>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La vue générale de l'ensemble du cycle est la suivante:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">for</span> ($cycle = <span class="hljs-number">1</span>; $cycle &lt;= <span class="hljs-number">6</span>; $cycle++) {<font></font>
    $all_tasks = get_all_tasks();<font></font>
    <span class="hljs-keyword">if</span> ($all_tasks) {
        <span class="hljs-keyword">foreach</span>($all_tasks <span class="hljs-keyword">as</span> $one_task) {<font></font>
            $lock_file_abs = <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/locks/run_'</span>.$one_task[<span class="hljs-string">'id'</span>];<font></font>
            $fp = fopen($lock_file_abs,<span class="hljs-string">"w+"</span>);
            <span class="hljs-keyword">if</span> (flock($fp, LOCK_EX | LOCK_NB)) {<font></font>
                solve_one_task($one_task);<font></font>
                flock($fp, LOCK_UN);<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">#    </span><font></font>
            }<font></font>
            fclose($fp);<font></font>
            unlink($lock_file_abs);<font></font>
        }<font></font>
    }<font></font>
    sleep(<span class="hljs-number">10</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, un tel algorithme vous permet de démarrer une exécution cyclique du traitement des tâches et ne craint pas que la tâche soit traitée plus d'une fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, il suffit d'exécuter ce code via cron toutes les minutes, et à son tour, il exécutera des cycles plus petits déjà à l'intérieur de lui-même.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498922/index.html">Des erreurs qui ruineront un projet de toute complexité. Expérience des gestionnaires Redmadrobot</a></li>
<li><a href="../fr498924/index.html">Pourquoi j'aime IKEv2 plus que les autres VPN</a></li>
<li><a href="../fr498928/index.html">Langages et technologies d'impression</a></li>
<li><a href="../fr498930/index.html">Pourquoi ne devrais-tu pas devenir chef d'équipe?</a></li>
<li><a href="../fr498932/index.html">Le livre "Gestion de la mémoire dans .NET pour les professionnels" dans la traduction correcte de l'équipe DotNetRu</a></li>
<li><a href="../fr498936/index.html">Liaison API Cloudflare PHP</a></li>
<li><a href="../fr498940/index.html">AMA avec Habr. # 18. Marathon, promo et résumé mis à jour</a></li>
<li><a href="../fr498942/index.html">Comment Service Desk évolue dans ITIL 4</a></li>
<li><a href="../fr498944/index.html">Télégramme Chien ou comment ne pas faire de miroirs</a></li>
<li><a href="../fr498948/index.html">Il est temps pour les dragons. Auto-isolement avec des puzzles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>