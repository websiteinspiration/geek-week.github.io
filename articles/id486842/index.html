<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛈️ 🏭 👩🏿‍🤝‍👨🏻 Konsul + iptables =: 3 ⛵️ 👏 🤬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada 2010, Wargaming memiliki 50 server dan model jaringan sederhana: backend, frontend, dan firewall. Jumlah server bertambah, model menjadi lebih ru...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Konsul + iptables =: 3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486842/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada 2010, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wargaming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memiliki 50 server dan model jaringan sederhana: backend, frontend, dan firewall. Jumlah server bertambah, model menjadi lebih rumit: staging, VLAN terisolasi dengan ACL, kemudian VPN dengan VRF, VLAN dengan ACL ke L2, VRF dari ACL ke L3. Kepala berputar? Lebih banyak akan lebih menyenangkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika server mulai bekerja 16.000 tanpa air mata dengan begitu banyak segmen heterogen, itu menjadi mustahil. Karena itu, mereka datang dengan solusi yang berbeda. Kami mengambil tumpukan Netfilter, menambahkan Konsul sebagai sumber data, dan kami mendapat firewall yang didistribusikan dengan cepat. Mereka mengganti ACL pada router dan digunakan sebagai firewall eksternal dan internal. Untuk manajemen alat yang dinamis, kami mengembangkan sistem BEFW, yang digunakan di mana-mana: dari mengendalikan akses pengguna ke jaringan bahan makanan hingga mengisolasi segmen jaringan dari satu sama lain.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/wg/bd/odwgbdlxcjww7ln1u_btv23hyvq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana cara kerjanya dan mengapa Anda harus melihat lebih dekat pada sistem ini, kata </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ivan Agarkov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">annmuor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - kepala kelompok keamanan infrastruktur unit Pemeliharaan di pusat pengembangan perusahaan Minsk. </font><font style="vertical-align: inherit;">Ivan adalah penggemar SELinux, mencintai Perl, menulis kode. </font><font style="vertical-align: inherit;">Sebagai kepala kelompok IB, ia secara teratur bekerja dengan log, cadangan, dan R&amp;D untuk melindungi Wargaming dari peretas dan memastikan operasi semua server game di perusahaan.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4zP67uYnsR4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi sejarah</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum memberitahu bagaimana kami melakukannya, saya akan memberi tahu Anda bagaimana kami sampai pada ini dan mengapa itu diperlukan. Untuk melakukan ini, kami transfer 9 tahun lalu: 2010, hanya World of Tanks yang muncul. Wargaming memiliki sekitar 50 server. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e6/qf/6h/e6qf6hugl_efcmn73qn16mcyeoc.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafik pertumbuhan server perusahaan.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Kami memiliki model jaringan. Untuk saat itu sudah optimal. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/zw/vj/bizwvjhrfphzbrhme6v1avzjxag.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model jaringan pada tahun 2010.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Di ujung depan ada orang jahat yang ingin menghancurkan kita, tetapi ada firewall di dalamnya. Tidak ada firewall di backend, tetapi ada 50 server di sana, kita semua tahu mereka. Semuanya bekerja dengan baik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lebih dari 4 tahun, armada server telah tumbuh 100 kali, hingga 5000. Jaringan terisolasi pertama muncul - panggung: mereka tidak dapat masuk ke produksi, dan seringkali hal-hal yang bisa berbahaya berputar di sana. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z0/6e/ba/z06ebavv-r6yu7fuhy2zvvhsnw0.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model jaringan pada tahun 2014.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan inersia, semua potongan besi yang sama digunakan, dan semua pekerjaan dilakukan pada VLAN yang terisolasi: ACL ditulis ke VLAN yang memungkinkan atau melarang koneksi apa pun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada 2016, jumlah server mencapai 8000. Wargaming menyerap studio lain, jaringan afiliasi tambahan muncul. Mereka tampaknya milik kita, tetapi tidak cukup: VLAN sering tidak berfungsi untuk mitra, Anda harus menggunakan VPN dengan VRF, isolasi menjadi lebih rumit. Campuran isolat ACL tumbuh. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w-/zj/ej/w-zjej3fr8frinvbg4z1thbwdre.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model jaringan pada 2016.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pada awal 2018, armada mobil tumbuh menjadi 16.000.Ada 6 segmen, dan sisanya kami tidak menghitung, termasuk yang tertutup, di mana data keuangan disimpan. Ada jaringan kontainer (Kubernetes), DevOps, jaringan cloud yang terhubung melalui VPN, misalnya, dari IVS. Ada banyak aturan - itu menyakitkan. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/zf/cd/ivzfcdz9lzxsiugegpfthzwubik.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model jaringan dan metode isolasi pada tahun 2018.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk isolasi kami menggunakan: VLAN dengan ACL pada L2, VRF dengan ACL pada L3, VPN dan banyak lagi. </font><font style="vertical-align: inherit;">Terlalu banyak.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua orang hidup dengan ACL dan VLAN. </font><font style="vertical-align: inherit;">Apa yang umumnya salah? </font><font style="vertical-align: inherit;">Harold, menyembunyikan rasa sakit, akan menjawab pertanyaan ini. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y2/hi/tl/y2hitlbrqlvcbm6rjg59tzaaqxw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada banyak masalah, tetapi ada lima masalah besar.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenaikan harga geometris untuk aturan baru</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Setiap aturan baru ditambahkan lebih lama dari yang sebelumnya, karena Anda harus terlebih dahulu melihat apakah sudah ada aturan seperti itu.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak ada firewall di dalam segmen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Segmen entah bagaimana dipisahkan satu sama lain, di dalamnya sudah tidak ada sumber daya yang cukup.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aturan sudah diterapkan sejak lama. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tangan satu operator aturan lokal bisa menulis dalam satu jam. </font><font style="vertical-align: inherit;">Global membutuhkan waktu beberapa hari.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesulitan dengan audit aturan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Lebih tepatnya, itu tidak mungkin. </font><font style="vertical-align: inherit;">Aturan pertama ditulis kembali pada tahun 2010, dan sebagian besar penulis mereka tidak lagi bekerja untuk perusahaan.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tingkat kontrol yang rendah terhadap infrastruktur</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini adalah masalah utama - kami tidak tahu apa yang terjadi dengan kami.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah apa yang tampak seperti insinyur jaringan pada tahun 2018 ketika dia mendengar: "Kami membutuhkan lebih banyak ACL."</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/rl/_i/hhrl_ig_xefe7lps5yrz_liioam.png" width="350"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solusi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada awal 2018, diputuskan untuk melakukan sesuatu tentang hal itu. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Harga integrasi terus tumbuh.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Titik awalnya adalah bahwa pusat data yang besar tidak lagi mendukung VLAN dan ACL yang terisolasi, karena memori pada perangkat habis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusi: menghilangkan faktor manusia dan mengotomatiskan penyediaan akses secara maksimal. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aturan baru berlaku untuk waktu yang lama.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solusi: mempercepat penerapan aturan, membuatnya terdistribusi dan paralel. Untuk melakukan ini, Anda memerlukan sistem terdistribusi sehingga aturan dikirimkan sendiri, tanpa rsync atau SFTP per seribu sistem. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurangnya firewall di dalam segmen.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firewall di dalam segmen mulai terbang kepada kami ketika berbagai layanan muncul dalam jaringan yang sama. Solusi: gunakan firewall berbasis host. Hampir di mana-mana kita memiliki Linux, dan iptables ada di mana-mana, ini bukan masalah. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesulitan dengan audit aturan.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solusi: simpan semua aturan di satu tempat untuk ditinjau dan dikelola, sehingga kami dapat mengaudit semuanya. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tingkat kontrol yang rendah terhadap infrastruktur.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solusi: lakukan inventarisasi semua layanan dan akses di antara mereka.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini lebih merupakan proses administrasi daripada yang teknis. </font><font style="vertical-align: inherit;">Terkadang kami memiliki 200-300 rilis baru per minggu, terutama selama promosi dan pada hari libur. </font><font style="vertical-align: inherit;">Namun, ini hanya untuk satu tim DevOps kami. </font><font style="vertical-align: inherit;">Dengan begitu banyak rilis, tidak mungkin untuk melihat port, IP, integrasi apa yang dibutuhkan. </font><font style="vertical-align: inherit;">Karena itu, kami membutuhkan manajer layanan terlatih khusus yang mewawancarai tim: "Apa yang ada di sana dan mengapa Anda membesarkannya?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah semua yang kami luncurkan, insinyur jaringan pada 2019 mulai terlihat seperti ini.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/fx/qi/yvfxqisjbogjxfy6czj0p6xmvuw.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konsul</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memutuskan bahwa kami akan meletakkan semua yang kami temukan dengan bantuan manajer layanan di Konsul dan dari sana kami akan menulis aturan iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana kami memutuskan untuk melakukan ini?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengumpulkan semua layanan, jaringan, dan pengguna.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mari kita membuat aturan iptables berdasarkan pada mereka.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontrol otomatis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KEUNTUNGAN.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konsul bukan API jarak jauh, ia dapat bekerja pada setiap node dan menulis ke iptables. </font><font style="vertical-align: inherit;">Tetap hanya muncul dengan kontrol otomatis yang akan membersihkan kelebihan, dan sebagian besar masalah akan terpecahkan! </font><font style="vertical-align: inherit;">Kami akan menyelesaikan sisanya dalam proses.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa konsul?</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapan.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pada 2014-15, kami menggunakannya sebagai backend untuk Vault, tempat kami menyimpan kata sandi. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak kehilangan data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Selama penggunaan, Konsul tidak kehilangan data dalam kecelakaan apa pun. Ini merupakan nilai tambah besar untuk sistem manajemen firewall. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Komunikasi P2P mempercepat penyebaran perubahan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dengan P2P, semua perubahan datang dengan cepat, tidak perlu menunggu berjam-jam. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API SISA Nyaman.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kami juga mempertimbangkan Apache ZooKeeper, tetapi tidak memiliki API REST, Anda harus meletakkan kruk. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ini berfungsi sebagai keystore (KV), dan sebagai direktori (Service Discovery)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Anda dapat segera menyimpan layanan, katalog, pusat data. Ini nyaman tidak hanya bagi kami, tetapi juga untuk tim tetangga, karena ketika membangun layanan global, kami berpikir besar.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ditulis dalam Go, yang merupakan bagian dari tumpukan Wargaming. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menyukai bahasa ini, kami memiliki banyak pengembang Go. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistem ACL yang kuat. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di Konsul, Anda dapat menggunakan ACL untuk mengelola siapa dan apa yang harus ditulis. </font><font style="vertical-align: inherit;">Kami menjamin bahwa aturan firewall tidak akan tumpang tindih dengan hal lain dan kami tidak akan mengalami masalah dengan ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi Konsul memiliki kekurangannya.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itu tidak skala dalam pusat data, jika Anda tidak memiliki versi bisnis. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itu hanya diskalakan oleh federasi.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sangat tergantung pada kualitas jaringan dan beban server. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konsul tidak akan berfungsi secara normal sebagai server di server yang sibuk jika ada kelambatan dalam jaringan, misalnya, kecepatan tidak rata. </font><font style="vertical-align: inherit;">Ini karena koneksi P2P dan memperbarui model distribusi.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesulitan dengan pemantauan aksesibilitas</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dalam status Konsul dapat mengatakan bahwa semuanya baik-baik saja, tetapi ia telah lama mati.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memecahkan sebagian besar masalah ini selama pengoperasian Konsul, jadi kami memilihnya. </font><font style="vertical-align: inherit;">Perusahaan memiliki rencana untuk backend alternatif, tetapi kami telah belajar bagaimana menghadapi masalah dan masih hidup dengan Konsul.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana Konsul Bekerja</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di pusat data bersyarat, kami memasang server - mulai dari tiga hingga lima. </font><font style="vertical-align: inherit;">Satu atau dua server tidak akan berfungsi: mereka tidak akan dapat mengatur kuorum dan memutuskan siapa yang benar, siapa yang salah, ketika data tidak cocok. </font><font style="vertical-align: inherit;">Lebih dari lima tidak masuk akal, kinerja akan turun. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/bb/ms/ljbbms9ipssmvl-pooll-judvgs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klien terhubung dalam urutan apa pun ke server: agen yang sama, hanya dengan bendera </font></font><code>server = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jx/ku/ub/jxkuubjet3kolzk07yqq0qkak8m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah itu, klien menerima daftar koneksi P2P dan membangun koneksi di antara mereka. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/st/ca/owstcacfv-iuaz42vdlyk1cmes8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di tingkat global, kami menghubungkan beberapa pusat data. </font><font style="vertical-align: inherit;">Mereka juga menghubungkan P2P dan berkomunikasi. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gx/5r/s5/gx5rs5yetwzbe63odrgx6ppfnm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat kami ingin mengumpulkan data dari pusat data lain, permintaan berpindah dari server ke server. </font><font style="vertical-align: inherit;">Skema semacam itu disebut </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">protokol Serf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Protokol Budak, seperti Konsul, dikembangkan oleh HashiCorp.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa Fakta Penting Tentang Konsul</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konsul memiliki dokumentasi yang menjelaskan karyanya. </font><font style="vertical-align: inherit;">Saya hanya akan memberikan fakta terpilih yang layak diketahui. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server konsul memilih master dari kalangan pemilih</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Konsul memilih wizard dari daftar server untuk setiap pusat data, dan semua permintaan hanya pergi ke sana, terlepas dari jumlah server. </font><font style="vertical-align: inherit;">Hanging the wizard tidak mengarah pada pemilihan ulang. </font><font style="vertical-align: inherit;">Jika wizard tidak dipilih, permintaan tidak dilayani oleh siapa pun.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apakah Anda ingin penskalaan horizontal? </font><font style="vertical-align: inherit;">Maaf tapi tidak.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permintaan ke pusat data lain berjalan dari master ke master, terlepas dari server mana ia datang. </font><font style="vertical-align: inherit;">Master yang dipilih menerima 100% dari beban, kecuali untuk beban pada permintaan penerusan. </font><font style="vertical-align: inherit;">Semua server pusat data memiliki salinan data terbaru, tetapi hanya satu jawaban.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Satu-satunya cara untuk menskala adalah mengaktifkan mode basi pada klien.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam mode basi, Anda dapat merespons tanpa kuorum. Ini adalah mode di mana kami menolak konsistensi data, tetapi kami membaca sedikit lebih cepat dari biasanya dan server mana pun merespons. Secara alami, perekaman hanya melalui master. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konsul tidak menyalin data antara pusat data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Saat mengumpulkan federasi, setiap server hanya akan memiliki data sendiri. Bagi yang lain, dia selalu beralih ke orang lain. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atomicity operasi tidak dijamin di luar transaksi</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ingatlah bahwa tidak hanya Anda yang dapat mengubah sesuatu. Jika Anda menginginkannya berbeda, lakukan transaksi dengan kunci. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operasi pemblokiran tidak menjamin pemblokiran</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Permintaan beralih dari master ke master, dan tidak secara langsung, sehingga tidak ada jaminan bahwa kunci akan berfungsi ketika Anda mengunci, misalnya, di pusat data lain.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACL juga tidak menjamin akses (dalam banyak kasus)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . ACL mungkin tidak berfungsi karena disimpan di satu pusat data federasi - di pusat data ACL (Primer DC). Jika DC tidak menjawab Anda, ACL tidak akan berfungsi. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seorang penyihir yang sedang melayang akan membekukan seluruh federasi</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Misalnya, dalam federasi ada 10 pusat data, dan di satu ada jaringan yang buruk, dan satu master jatuh. Setiap orang yang berkomunikasi dengannya terjebak dalam lingkaran: permintaan sedang dibuat, tidak ada jawaban untuk itu, utasnya hang. Tidak akan mungkin untuk mengetahui kapan ini akan terjadi, hanya dalam satu atau dua jam seluruh federasi akan jatuh. Anda tidak bisa berbuat apa-apa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Status, kuorum, dan pemilihan diproses dalam utas terpisah. </font><font style="vertical-align: inherit;">Seleksi ulang tidak akan terjadi, status tidak akan menunjukkan apa-apa. </font><font style="vertical-align: inherit;">Anda berpikir bahwa Anda memiliki Konsul langsung, Anda bertanya, dan tidak ada yang terjadi - tidak ada jawaban. </font><font style="vertical-align: inherit;">Apalagi statusnya menunjukkan bahwa semuanya baik-baik saja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menghadapi masalah ini, kami harus membangun kembali bagian-bagian pusat data tertentu untuk menghindarinya. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versi bisnis dari Consul Enterprise tidak memiliki beberapa kekurangan di atas</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini memiliki banyak fungsi yang berguna: suara, distribusi, penskalaan. </font><font style="vertical-align: inherit;">Hanya ada satu "tetapi" - sistem lisensi untuk sistem terdistribusi sangat mahal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retas seumur hidup: </font></font><code>rm -rf /var/lib/consul</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- obat untuk semua penyakit agen. </font><font style="vertical-align: inherit;">Jika sesuatu tidak berhasil untuk Anda, cukup hapus data Anda dan unduh data dari salinan. </font><font style="vertical-align: inherit;">Kemungkinan besar, Konsul akan bekerja.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Befw</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang mari kita bicara tentang apa yang kita tambahkan ke Konsul. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BEFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - singkatan dari </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bed and</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ack </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nd </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the F</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ire of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the W</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> all. </font><font style="vertical-align: inherit;">Itu perlu entah bagaimana memberi nama produk ketika saya membuat repositori untuk melakukan tes pertama yang dilakukan. </font><font style="vertical-align: inherit;">Nama ini tetap ada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Templat Aturan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aturan ditulis dalam sintaks iptables.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-N BEFW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-P DROP INPUT</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A INPUT -m state - state TERKAIT, DIDIRIKAN -j MENERIMA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INPUT -A lo -j MENERIMA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INPUT -J BEFW</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita semua pergi ke rantai BEFW, kecuali </font></font><code>ESTABLISHED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RELATED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan localhost. </font><font style="vertical-align: inherit;">Template dapat berupa apa saja, ini hanya sebuah contoh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa gunanya BEFW?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jasa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memiliki layanan, selalu memiliki port, simpul tempat kerjanya. </font><font style="vertical-align: inherit;">Dari simpul kami, kami dapat secara lokal bertanya kepada agen dan mengetahui bahwa kami memiliki semacam layanan. </font><font style="vertical-align: inherit;">Anda juga dapat menaruh tag. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/lc/7n/fmlc7n4h4rmyqbeemb7lcn6lzco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap layanan yang berjalan dan terdaftar dengan Konsul berubah menjadi aturan iptables. </font><font style="vertical-align: inherit;">Kami memiliki SSH - port terbuka 22. Skrip bash sederhana: ikal dan iptables, tidak ada lagi yang diperlukan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pelanggan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana cara membuka akses bukan untuk semua orang, tetapi secara selektif? </font><font style="vertical-align: inherit;">Dengan nama layanan, tambahkan daftar IP ke repositori KV. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pg/y4/nu/pgy4nufltcqaimdqv7ncfpntix0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, kami ingin semua orang dari jaringan kesepuluh dapat mengakses layanan SSH_TCP_22. </font><font style="vertical-align: inherit;">Tambahkan satu bidang TTL kecil? </font><font style="vertical-align: inherit;">dan sekarang kami memiliki izin sementara, misalnya, selama sehari.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akses</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menghubungkan layanan dan pelanggan: kami memiliki layanan, untuk setiap penyimpanan KV siap. </font><font style="vertical-align: inherit;">Sekarang kami memberikan akses bukan kepada semua orang, tetapi secara selektif.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/yo/vn/f1yovnkwz7qddj1sw267obg3gvk.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grup</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika setiap kali kita menulis ribuan IP untuk diakses, kita akan lelah. </font><font style="vertical-align: inherit;">Mari kita datang dengan pengelompokan - subset terpisah di KV. </font><font style="vertical-align: inherit;">Kami akan menyebutnya Alias ​​(atau grup) dan kami akan menyimpan grup di sana sesuai dengan prinsip yang sama. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/un/um/vzunum6qz9s9fs8odlwiwlz6vsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connect: sekarang kita dapat membuka SSH tidak secara khusus pada P2P, tetapi pada seluruh grup atau beberapa grup. </font><font style="vertical-align: inherit;">Demikian pula, ada TTL - Anda dapat menambahkan ke grup dan menghapus dari grup sementara.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/2w/as/ao2was0eioehjrwnn1ypgh4zj5w.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrasi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalah kita adalah faktor manusia dan otomatisasi. Sejauh ini kami telah menyelesaikannya seperti itu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/pv/j0/8gpvj0liyxy64mamjpwr8nbn4xc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami bekerja dengan Wayang, dan mentransfer semua yang terkait dengan sistem (kode aplikasi) ke sana. Puppetdb (PostgreSQL biasa) menyimpan daftar layanan yang berjalan di sana, Anda dapat menemukannya berdasarkan jenis sumber daya. Di sana Anda dapat menemukan siapa yang pergi ke mana. Kami juga memiliki permintaan tarik dan menggabungkan sistem permintaan untuk ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menulis befw-sync, solusi paling sederhana yang membantu mentransfer data. Pertama, sinkronisasi cookie ke puppetdb. HTTP API dikonfigurasi di sana: kami bertanya layanan apa yang kami miliki, apa yang perlu dilakukan. Kemudian mereka membuat permintaan ke Konsul.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apakah ada integrasi? </font><font style="vertical-align: inherit;">Ya: mereka menulis aturan, diizinkan untuk menerima Permintaan Tarik. </font><font style="vertical-align: inherit;">Perlu beberapa port atau menambahkan host ke beberapa grup? </font><font style="vertical-align: inherit;">Tarik Permintaan, tinjau - tidak lebih "Cari 200 ACL lain dan coba lakukan sesuatu."</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimasi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ping localhost dengan rantai aturan kosong membutuhkan waktu 0,075 ms. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/6p/ce/_j6pceeghhejvrabuazobzgbfmw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambahkan 10.000 iptables ke rantai ini. </font><font style="vertical-align: inherit;">Akibatnya, ping akan meningkat 5 kali: iptables benar-benar linier, memproses setiap alamat membutuhkan waktu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/v9/ic/erv9ic34w6oqhoy7aekpfimpys4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk firewall, tempat kami memigrasikan ribuan ACL, kami memiliki banyak aturan, dan ini menyebabkan penundaan. </font><font style="vertical-align: inherit;">Untuk protokol game, ini buruk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi jika kita menempatkan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.000 alamat di</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ping </font><strong><font style="vertical-align: inherit;">ipset</font></strong><font style="vertical-align: inherit;"> bahkan akan berkurang. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_l/zb/qs/_lzbqsckkctv-01v3vu-irjhvcq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intinya adalah bahwa "O" (kompleksitas algoritma) untuk ipset selalu 1, tidak peduli berapa banyak aturan yang ada. </font><font style="vertical-align: inherit;">Benar, ada batasan - tidak boleh ada lebih dari 65535 aturan Untuk saat ini, kita hidup dengan ini: Anda dapat menggabungkannya, memperluasnya, membuat dua ipset dalam satu.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penyimpanan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kelanjutan logis dari proses iterasi adalah penyimpanan informasi pelanggan untuk layanan di ipset. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/up/dv/x0updv72n35faryycb_ntjmpqik.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kami memiliki SSH yang sama, dan kami tidak segera menulis 100 IP, tetapi kami menetapkan nama ipset untuk berkomunikasi, dan aturan berikut </font></font><code>DROP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Anda dapat mengulang aturan "Siapa yang tidak di sini, itu DROP", tetapi lebih jelas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kami memiliki aturan dan set. </font><font style="vertical-align: inherit;">Tugas utama adalah membuat set sebelum menulis aturan, karena jika tidak, iptables tidak akan menulis aturan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skema umum</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam bentuk diagram, semua yang saya katakan terlihat seperti ini. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/qa/i-/9wqai-52aq3i3onq1dovwbfzpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berkomitmen untuk Wayang, semuanya dikirim ke tuan rumah, layanan ada di sini, ipset ada di sana, dan siapa pun yang tidak terdaftar di sana tidak diperbolehkan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memungkinkan menyangkal</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menyelamatkan dunia dengan cepat atau mematikan seseorang, di awal semua rantai kami membuat dua ipset: </font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>rules_deny</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Bagaimana itu bekerja? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, seseorang dengan bot menciptakan muatan di Web kami. </font><font style="vertical-align: inherit;">Sebelumnya, perlu untuk menemukan IP-nya dengan log, merujuknya ke insinyur jaringan sehingga mereka dapat menemukan sumber lalu lintas dan melarangnya. </font><font style="vertical-align: inherit;">Sekarang terlihat berbeda. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a6/so/xq/a6soxqdkwf8qokucl-ztjs6xdde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengirim ke Konsul, tunggu 2,5 s, dan Anda selesai. </font><font style="vertical-align: inherit;">Karena Konsul cepat mendistribusikan melalui P2P, ia bekerja di mana saja, di mana saja di dunia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah saya entah bagaimana benar-benar menghentikan WOT, membuat kesalahan dengan firewall. </font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Ini adalah asuransi kami terhadap kasus-kasus seperti itu. </font><font style="vertical-align: inherit;">Jika kami membuat kesalahan dengan firewall di suatu tempat, ada sesuatu yang diblokir di suatu tempat, kami selalu dapat mengirim persyaratan </font></font><code>0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk dengan cepat meningkatkan semuanya. </font><font style="vertical-align: inherit;">Maka kita akan memperbaiki semuanya dengan tangan kita.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set lainnya</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat menambahkan set lain di ruang angkasa </font></font><code>$IPSETS$</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/md/hv/jf/mdhvjfb8t36heje-udbnw5fly0m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk apa? </font><font style="vertical-align: inherit;">Kadang-kadang seseorang membutuhkan ipset, misalnya, untuk meniru pemutusan beberapa bagian cluster. </font><font style="vertical-align: inherit;">Setiap orang dapat membawa set, memanggil mereka dan mereka akan diambil dari Konsul. </font><font style="vertical-align: inherit;">Pada saat yang sama, set dapat berpartisipasi dalam aturan iptables dan menjadi seperti tim </font></font><code>NOOP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: konsistensi akan didukung oleh daemon.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengguna</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dulu seperti ini: pengguna yang terhubung ke jaringan dan menerima parameter melalui domain. </font><font style="vertical-align: inherit;">Hingga generasi firewall berikutnya, Cisco tidak dapat memahami di mana pengguna berada dan di mana IP tersebut. </font><font style="vertical-align: inherit;">Oleh karena itu, akses diberikan hanya melalui mesin hostname. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang telah kita lakukan? </font><font style="vertical-align: inherit;">Terjepit pada saat menerima alamat. </font><font style="vertical-align: inherit;">Biasanya itu dot1x, Wi-Fi atau VPN - semuanya berjalan melalui RADIUS. </font><font style="vertical-align: inherit;">Untuk setiap pengguna, buat grup dengan nama pengguna dan masukkan IP dengan TTL di dalamnya, yang sama dengan dhcpnya. Silakan - segera setelah habis masa berlakunya, aturan akan hilang. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/ps/ad/tfpsad3jh-egdfn_uehr3yvmcao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kita dapat membuka akses ke layanan, serta ke grup lain, dengan nama pengguna. </font><font style="vertical-align: inherit;">Kami menghilangkan rasa sakit dengan nama host ketika mereka berubah, dan mengambil beban dari insinyur jaringan karena mereka tidak lagi membutuhkan Cisco. </font><font style="vertical-align: inherit;">Sekarang, para insinyur sendiri meresepkan akses ke server mereka.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isolasi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara paralel, kami mulai membongkar isolasi. </font><font style="vertical-align: inherit;">Manajer layanan mengambil inventaris, dan kami menganalisis semua jaringan kami. </font><font style="vertical-align: inherit;">Kami menguraikan mereka ke dalam kelompok yang sama, dan pada server yang diperlukan kelompok ditambahkan, misalnya, untuk ditolak. </font><font style="vertical-align: inherit;">Sekarang pementasan isolasi yang sama masuk ke rules_deny dalam produksi, tetapi tidak dalam produksi itu sendiri. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fd/9g/ed/fd9gedlbs2_9gyyg-5lwm_fp75m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skema ini bekerja dengan cepat dan sederhana: menghapus semua ACL dari server, membongkar perangkat keras, mengurangi jumlah VLAN yang terisolasi.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontrol integritas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelumnya, pemicu khusus bekerja untuk kami, yang memberi tahu ketika seseorang mengubah aturan firewall dengan tangan mereka. </font><font style="vertical-align: inherit;">Saya menulis pemeriksa aturan firewall yang besar, sulit. </font><font style="vertical-align: inherit;">Sekarang integritas mengontrol BEFW. </font><font style="vertical-align: inherit;">Dia dengan penuh semangat memastikan bahwa aturan yang dia buat tidak berubah. </font><font style="vertical-align: inherit;">Jika seseorang mengubah aturan firewall, ia akan mengembalikan semuanya kembali. </font><font style="vertical-align: inherit;">“Saya dengan cepat mengangkat proxy di sini untuk bekerja dari rumah” - tidak ada opsi seperti itu lagi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW mengontrol ipset dari layanan dan daftar di befw.conf, aturan layanan dalam rantai BEFW. </font><font style="vertical-align: inherit;">Tetapi tidak mengikuti rantai dan aturan lain dan ipset lainnya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perlindungan kecelakaan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW selalu menyimpan negara sukses terakhir secara langsung dalam struktur biner state.bin. Jika terjadi kesalahan, selalu kembali ke kondisi ini.bin. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2z/fe/ru/2zferuy2qiohwpa6odt1s0d642g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah asuransi Konsul yang tidak stabil ketika ia tidak mengirim data atau seseorang melakukan kesalahan dan menggunakan aturan yang tidak dapat diterapkan. Agar kita tidak dibiarkan tanpa firewall, BEFW akan kembali ke keadaan terakhir jika terjadi kesalahan pada tahap tertentu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam situasi kritis, ini adalah jaminan bahwa kami akan tetap menggunakan firewall yang berfungsi. Kami membuka semua jaringan abu-abu dengan harapan admin akan datang dan memperbaikinya. Suatu hari saya akan mengeluarkannya di konfigurasi, tetapi sekarang kami hanya memiliki tiga jaringan abu-abu: 10/8, 172/12 dan 192.168 / 16. Sebagai bagian dari Konsul kami, ini adalah fitur penting yang membantu mengembangkan lebih lanjut.</font></font><br>
<br>
<em>:      -  BEFW.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> GitHub</a>.</em><br>
<br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan memberi tahu Anda tentang bug yang kami temui. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset tambahkan set 0.0.0.0/0.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Apa yang terjadi jika Anda menambahkan ke ipset 0.0.0.0/0? Apakah semua IP akan ditambahkan? Apakah akses Internet akan dibuka? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak, kami mendapatkan bug yang menghabiskan waktu dua jam untuk kami. Selain itu, bug belum berfungsi sejak 2016, itu terletak di RedHat Bugzilla di bawah nomor # 1297092, tetapi kami menemukannya secara tidak sengaja - dari laporan pengembang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang BEFW memiliki aturan ketat, yang </font></font><code>0.0.0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">berubah menjadi dua alamat: </font></font><code>0.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>128.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset restore set &lt;file.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Apa yang dilakukan ipset saat Anda memberi tahu </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Apakah Anda pikir ini berfungsi seperti iptables? Pulihkan data? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak ada yang semacam itu - ia melakukan penggabungan, dan alamat lama tidak hilang, Anda tidak menutup akses.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menemukan bug ketika kami menguji isolasi. Sekarang ada sistem yang agak rumit - bukannya </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dilakukan </font></font><code>create temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dulu </font></font><code>restore flush temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font><font style="vertical-align: inherit;">kemudian </font></font><code>restore temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pada akhir swap: untuk atomicity, karena jika Anda pertama kali melakukan </font></font><code>flush</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan pada saat itu beberapa paket tiba, itu akan dibuang dan ada sesuatu yang salah. Karena itu, ada sedikit ilmu hitam. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consul kv get -datacenter = lainnya.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Seperti yang saya katakan, kami berpikir bahwa kami meminta beberapa data, tetapi kami akan mendapatkan data atau kesalahan. Kita dapat melakukan ini melalui Konsul secara lokal, tetapi dalam kasus ini keduanya akan hang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klien Konsul lokal adalah pembungkus API HTTP. Tapi itu hanya hang dan tidak menjawab Ctrl + C, atau Ctrl + Z, tidak peduli apa, hanya</font></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di konsol yang berdekatan. </font><font style="vertical-align: inherit;">Kami menemukan ini ketika kami sedang membangun sebuah cluster besar. </font><font style="vertical-align: inherit;">Tapi kami masih belum punya solusi, kami sedang bersiap untuk memperbaiki kesalahan ini di Konsul. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pemimpin konsul tidak merespons. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Master kami di pusat data tidak merespons, kami berpikir: "Mungkin, algoritma seleksi ulang akan berfungsi sekarang?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak, itu tidak akan bekerja, dan pemantauan tidak akan menunjukkan apa-apa: Konsul akan mengatakan bahwa ada indeks komitmen, seorang pemimpin telah ditemukan, semuanya baik-baik saja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana kita melawan ini? </font></font><code>service consul restart</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di cron setiap jam. </font><font style="vertical-align: inherit;">Jika Anda memiliki 50 server - bukan masalah besar. </font><font style="vertical-align: inherit;">Ketika akan ada 16.000, Anda akan mengerti cara kerjanya.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasilnya, kami mendapat keuntungan sebagai berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cakupan 100% dari semua mesin Linux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kecepatan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otomatisasi</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insinyur besi dan jaringan dibebaskan dari perbudakan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada peluang integrasi yang hampir tak ada habisnya: bahkan dengan Kubernetes, bahkan dengan Ansible, bahkan dengan Python.</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cons</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Consul, dengan siapa kita hidup sekarang, dan harga kesalahan yang sangat tinggi. </font><font style="vertical-align: inherit;">Sebagai contoh, pada jam 6 sore (jam tayang utama di Rusia), saya memutuskan sesuatu dalam daftar jaringan. </font><font style="vertical-align: inherit;">Kami membangun isolasi di BEFW saat itu. </font><font style="vertical-align: inherit;">Saya keliru di suatu tempat, sepertinya, saya menunjukkan topeng yang salah, tetapi semuanya jatuh dalam dua detik. </font><font style="vertical-align: inherit;">Memantau menyala, petugas jaga datang: "Semuanya ada pada kita!" </font><font style="vertical-align: inherit;">Kepala departemen berubah abu-abu ketika dia menjelaskan kepada bisnis mengapa ini terjadi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Harga kesalahan sangat tinggi sehingga kami membuat prosedur profilaksis rumit kami sendiri. </font><font style="vertical-align: inherit;">Jika Anda akan menerapkannya pada produksi besar, Anda tidak perlu memberikan token utama kepada Konsul kepada semua orang. </font><font style="vertical-align: inherit;">Itu akan berakhir dengan buruk. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biaya.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya menulis kode selama 400 jam sendirian. </font><font style="vertical-align: inherit;">Untuk mendukung tim saya yang terdiri dari 4 orang menghabiskan 10 jam sebulan sama sekali. </font><font style="vertical-align: inherit;">Dibandingkan dengan harga firewall generasi baru, gratis. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rencana. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rencana jangka panjang adalah mencari transportasi alternatif sebagai imbalan atau sebagai tambahan untuk Konsul. </font><font style="vertical-align: inherit;">Mungkin itu akan Kafka atau semacamnya. </font><font style="vertical-align: inherit;">Tetapi di tahun-tahun mendatang kita akan hidup di Konsul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rencana segera: integrasi dengan Fail2ban, dengan pemantauan, dengan nftables, mungkin dengan distribusi lain, metrik, pemantauan lanjutan, optimisasi. </font><font style="vertical-align: inherit;">Dukungan Kubernetes juga ada di suatu rencana, karena saat ini kami memiliki beberapa kluster dan keinginan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rencana lainnya:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mencari anomali lalu lintas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manajemen peta jaringan;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dukungan Kubernetes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perakitan paket untuk semua sistem;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UI web</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami terus berupaya memperluas konfigurasi, meningkatkan metrik, dan mengoptimalkan. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bergabunglah dengan proyek ini. </font><font style="vertical-align: inherit;">Proyek itu ternyata keren, tapi, sayangnya, ini masih proyek satu orang. </font><font style="vertical-align: inherit;">Datanglah ke </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan coba lakukan sesuatu: komit, tes, tawarkan sesuatu, berikan penilaian Anda.</font></font></i><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sementara itu, kami bersiap-siap untuk </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saint HighLoad ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang akan diadakan pada tanggal 6 dan 7 April di St. Petersburg, dan kami mengundang pengembang sistem yang sarat muatan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk mengajukan laporan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pembicara yang berpengalaman sudah tahu apa yang harus dilakukan, dan kami menyarankan agar pendatang baru untuk pidato setidaknya </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mencoba</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Berpartisipasi dalam konferensi sebagai pembicara memiliki beberapa keunggulan. </font><font style="vertical-align: inherit;">Yang mana, Anda dapat membaca, misalnya, di akhir </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id486842/">https://habr.com/ru/post/id486842/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id486822/index.html">[Di dermaga] Berkibar. Bagian 4. Untuk pengembang web</a></li>
<li><a href="../id486824/index.html">Saran buruk ketika bekerja dengan ANTLR</a></li>
<li><a href="../id486826/index.html">Membuat Viberbot lengkap di Django 2 dan API Viber REST. Bagian Satu - Webhook</a></li>
<li><a href="../id486828/index.html">Intisari Desain Makanan, Januari 2020</a></li>
<li><a href="../id486832/index.html">Berapa tahun pergi taiga - mengerti tidak</a></li>
<li><a href="../id486844/index.html">Evolusi pemrosesan webhook Facebook: dari nol menjadi 25.000 per detik</a></li>
<li><a href="../id486850/index.html">Kursi baru yang dipesan - seperti hotel kapsul</a></li>
<li><a href="../id486858/index.html">Membuat Viberbot lengkap. Bagian dua - kontak pertama atau "conversion_started"</a></li>
<li><a href="../id486860/index.html">ATX12VO - Makan dengan Cara Baru</a></li>
<li><a href="../id486862/index.html">5 alasan mengapa desain gerak membantu Anda terhubung dengan orang-orang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>