<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòù üë©üèΩ‚Äçüîß üéø IPSec Almighty ‚õÑÔ∏è üöò üì∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon friends. It's no secret that many of us have at least once, but have had to deal with the need to configure a VPN. Being an active read...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec Almighty</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good afternoon friends. </font><font style="vertical-align: inherit;">It's no secret that many of us have at least once, but have had to deal with the need to configure a VPN. </font><font style="vertical-align: inherit;">Being an active reader of Habr, I noticed that despite the abundance of articles about IPSec, for many it still seems to be something complicated and overloaded. </font><font style="vertical-align: inherit;">In this article I will try to dispel these myths using my own fully working configuration as an example. </font><font style="vertical-align: inherit;">In four examples, we will completely go through the configuration of the most popular Linux (Strongswan) solution, from a simple tunnel with side authentication with PSK keys to a host-to-host connection with authentication of both sides based on certificates from Let's Encrypt. </font><font style="vertical-align: inherit;">Interesting? </font><font style="vertical-align: inherit;">Welcome to cat!</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, the VPN was planned only for the organization of the channel between the mini-router of the parents and the home "bedside" server, which concurrently acts as a router. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After a short period of time, Keenetic was added to this company from two devices. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But once starting, it turned out to be difficult to stop, and soon phones and a laptop appeared on the diagram, who wanted to hide from the all-seeing advertising eye of MT_Free and other unencrypted WiFi networks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the beloved ILV finally got stronger the Banhammer, whom he incredibly fell in love with publicly swinging in all directions, and in order to neutralize his concern for mere mortals, he had to </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support the foreign IT sector</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to acquire VPS abroad.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, a certain citizen who looks like Shapoklyak, running around everywhere with her </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reticule by the</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Package, and probably believing that ‚ÄúWho helps people, is wasting time. </font><font style="vertical-align: inherit;">You cannot become famous for good deeds, ‚ÄùI wanted to secretly peek at someone else's traffic and take it in pencil. </font><font style="vertical-align: inherit;">We will also have to defend ourselves against such unsolicited love and VPN in this case exactly what the doctor ordered. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To summarize a short summary. </font><font style="vertical-align: inherit;">It was necessary to find a solution that ideally could close several tasks at once:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interconnect between Linux routers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Build a tunnel between Linux and Keenetic Household</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Give access to home resources and the Internet to wearable devices (telephones, laptops) from untrusted networks</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Create a securely encrypted tunnel to the remote VPS</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget about the wonderful KISS principle - Keep It Simple, Stupid. </font><font style="vertical-align: inherit;">The fewer components will be involved and the easier it is to configure each of them - the more reliable.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Overview of existing solutions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Briefly go over what is now: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Grandfather Lenin of all protocols. </font><font style="vertical-align: inherit;">Died, "Decayed on mold and linden honey." </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Does anyone but one provider use this? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wireguard</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
project is developing. </font><font style="vertical-align: inherit;">Actively sawn. </font><font style="vertical-align: inherit;">It is easy to create a tunnel between two peers having a static IP. </font><font style="vertical-align: inherit;">In other cases, crutches, bicycles with square wheels and a blue electrical tape are always ready to help, but this is not our way. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Support for multiple platforms - Windows, Linux, OpenWRT and its derivatives, Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Strong encryption and certificate support.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Flexibility of customization.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 And cons:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Work entirely in user-space.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Limited support from home routers - krenenko-kosenko on Mikrotik (without detracting from the other advantages of the glands) and normal in OpenWRT.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Difficulties with setting up mobile clients: you need to download, or create your own installer, copy configs somewhere.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If there are several tunnels, dances await with editing systemd units on the server.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect (open-source implementation of the Cisco Anyconnect protocol)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A very interesting solution about which, unfortunately, is quite a bit of information. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Relatively broad support for various platforms - Windows, Android, Mac based on the Cisco Anyconnect native application from the store - is an ideal option to provide access to the internal network of wearable devices.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Strong encryption, certificate support, 2FA connectivity</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The protocol itself is fully TLS-based (unlike OpenVPN, which is easily detected on port 443). </font><font style="vertical-align: inherit;">In addition to TLS, DTLS is also supported - during the established session, the client can switch to transmitting data via UDP and vice versa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Excellent coexistence on one port of both a VPN and a full-fledged web server using sniproxy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Easy setup of both server and clients.</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, too, were not without cons:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Work entirely in user-space.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP on top of TCP is a bad idea.</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There is no support from customer-grade equipment.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The complexity of installing tunnels between two Linux: theoretically possible, practically - it is better to spend time on something more useful.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If there are several tunnels, dances with several configs and editing systemd units are waiting.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would seem like a dead end, but after taking a closer look and spending a bit of time studying, I realized that IPSec based on IKEv2 is able to replace everything else. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IKEv2 IPSEC</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> With the advent of IKEv2, the protocol itself has become easier to configure, compared to the previous version, but at the cost of losing backward compatibility.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks to standardization, work is provided anywhere and on anything - the list can be maintained indefinitely. </font><font style="vertical-align: inherit;">Linux, Mikrotik (in the latest versions of RouterOS), OpenWRT, Android, iPhone. </font><font style="vertical-align: inherit;">Windows also has native support starting with Windows 7.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">High speed: traffic processing completely in kernel-space. </font><font style="vertical-align: inherit;">The user-space part is needed only for setting connection parameters and monitoring the channel‚Äôs health.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The ability to use several authentication methods: using both PSK and certificates, and in any combination.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Several operating modes: tunnel and transport. </font><font style="vertical-align: inherit;">How they differ can be read including on Habr√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Undemanding settings for intermediate nodes: if in the first version of IKE there were problems caused by NAT, then IKEv2 has built-in mechanisms for overcoming NAT and native fragmentation of IKE messages, which allows you to establish a connection on channels with an MTU curve. </font><font style="vertical-align: inherit;">Looking ahead, I‚Äôll say that in practice I‚Äôve never encountered a WiFi network, wherever a client can establish a connection.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cons, however, also have:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> You need to spend some time studying and understanding how it works.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A feature that can confuse a newbie: IPSec, unlike conventional VPN solutions, does not create network interfaces. </font><font style="vertical-align: inherit;">Only traffic processing policies are set, everything else is resolved by means of firewall.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before proceeding with the setup, we assume that the reader is already a little familiar with the basic concepts and terms. </font><font style="vertical-align: inherit;">To help a beginner, you can recommend an article from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and Habr himself, on which there are already quite interesting and useful articles on this topic.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getting started setting up</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having decided on the decision, we proceed to the configuration. </font><font style="vertical-align: inherit;">The network diagram in my case has the following form (removed under the spoiler)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network diagram</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the home server that is the center of the network. External IP 1.1.1.1. An internal network 10.0.0.0/23 and another address 10.255.255.1/30 for setting a private BGP session with VPS; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a Linux router based on a small, silent nettop installed by parents. The ISP issues a dynamic IP address. Internal network 10.0.3.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keenetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">Keenetic</font></b><font style="vertical-align: inherit;"> router with IPSec installed. The ISP issues a dynamic IP address. Internal network 10.0.4.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">road-warriors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - portable devices connecting from untrusted networks. Addresses are issued to clients dynamically when connected from the internal pool (10.1.1.0/24); </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- VPS outside the jurisdiction of a respected ILV. </font><font style="vertical-align: inherit;">External IP - 5.5.5.5, internal address 10.255.255.2/30 for setting a private BGP session.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First step. </font><font style="vertical-align: inherit;">From simple to complex: tunnels using pre-shared keys (PSK)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On both Linux-boxes we install the necessary packages:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On both hosts, open the ports 500 / udp, 4500 / udp and allow the passage of the ESP protocol. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit the file /etc/strongswan/ipsec.secrects (on the host side ipsecgw.example.com) and add the following line:</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the second side, similarly:</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, the ID is a fictitious email address. </font><font style="vertical-align: inherit;">More information can be found on the official </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secrets saved, moving on. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the ipsecgw.example.com host, edit the /etc/strongswan/ipsec.conf file:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Similarly, we edit on the remote peer /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you compare the configs, you can see that they are almost mirrored, only the definitions of peers are cross-exchanged. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto = route</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directive </font><font style="vertical-align: inherit;">causes charon to set a trap for traffic falling into the left / rightsubnet (traffic selectors) directives. </font><font style="vertical-align: inherit;">Coordination of the tunnel parameters and key exchange will begin immediately after the appearance of traffic that falls under the given conditions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the ipsecgw.example.com server in the firewall settings, we prohibit masquerading for a 10.0.3.0/24 network. </font><font style="vertical-align: inherit;">Allow packet forwarding between 10.0.0.0/23 and 10.0.3.0/24 and vice versa. </font><font style="vertical-align: inherit;">On the remote host, we perform similar settings by disabling masquerading for the 10.0.0.0/23 network and setting up forwarding. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We restart strongswan on both servers and try to ping the central node:</font></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make sure everything works:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It will also be useful to make sure that the make_before_break parameter is set to yes in the /etc/strongswan/strongswan.d/charon.conf file at all peers. </font><font style="vertical-align: inherit;">In this case, the charon daemon serving the IKEv2 protocol will not delete the current security association during the key change procedure, but will create a new one first.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step Two </font><font style="vertical-align: inherit;">The appearance of Keenetic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pleasant surprise was the built-in IPSec VPN in the official Keenetic firmware. </font><font style="vertical-align: inherit;">To activate it, just go to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KeeneticOS Component Settings</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and add the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec VPN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We prepare the settings on the central node, for this: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit /etc/strongswan/ipsec.secrects and add the PSK for the new peer:</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit /etc/strongswan/ipsec.conf and add another connection to the end:</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the Keenetic side, configuration is performed in the WebUI along the path: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet -&gt; Connections -&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Other Connections</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It's pretty simple</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3 pictures)</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you plan to drive significant volumes of traffic through the tunnel, then you can try to enable hardware acceleration, which is supported by many models. </font><font style="vertical-align: inherit;">Enabled by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto engine hardware</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">in the CLI. </font><font style="vertical-align: inherit;">To disable and process encryption and hashing processes using general-purpose CPU instructions - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crypto engine software</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After saving the settings, we restore strongswan and let Keenetic think for half a minute. </font><font style="vertical-align: inherit;">Then in the terminal we see a successful connection:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is working:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step Three </font><font style="vertical-align: inherit;">Protecting mobile devices</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After reading a bunch of manuals and a bunch of articles, it was decided to stop at a bunch of a free certificate from Let's Encrypt to authenticate the server and classic authorization by login and password for clients. </font><font style="vertical-align: inherit;">Thus, we get rid of the need to maintain our own PKI infrastructure, monitor the expiration of keys and perform unnecessary gestures with mobile devices by installing self-signed certificates in the trusted list. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the missing packages:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get the standalone certificate (do not forget to open 80 / tcp in the iptables settings first):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After certbot has completed its work, we must teach Strongswan to see our certificate:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the directory /etc/strongswan/ipsec.d/cacerts create 2 symbolic links: one to the root store of trusted certificates in / etc / pki / tls / certs; </font><font style="vertical-align: inherit;">and a second with the name ca.pem pointing to /etc/letsencrypt/live/ipsecgw.example.com/chain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two symlinks are also created in the /etc/strongswan/ipsec.d/certs directory: the first, with the name certificate.pem, refers to the file /etc/letsencrypt/live/ipsecgw.example.com/cert.pem. </font><font style="vertical-align: inherit;">And the second, named fullchain.pem, linking to /etc/letsencrypt/live/ipsecgw.example.com/fullchain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the /etc/strongswan/ipsec.d/private directory, place the key.pem symlink pointing to the private key generated by certbot and lying along the path /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add authentication via RSA to ipsec.secrets and a bunch of logins / passwords for new users:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We restart Strongswan and when calling sudo strongswan listcerts we should see the certificate information:</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we describe the new connection in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget to edit the file / etc / sysconfig / certbot indicating that we will also update the certificate as standalone, adding CERTBOT_ARGS = "- standalone" to it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, do not forget to turn on the certbot-renew.timer timer and set the hook to restart Strongswan in case of issuing a new certificate. </font><font style="vertical-align: inherit;">To do this, either place a simple bash script in / etc / letsencrypt / renewal-hooks / deploy /, or edit the / etc / sysconfig / certbot file again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We restart Strongswan, turn on masquerading for the 10.1.1.0/24 network in iptables and go on to configure mobile devices.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> application from Google Play </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We launch and create a new</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">profile</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We save the profile, connect and, after a second, we don‚Äôt have to worry about someone being able to spy on us.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We check:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows of current versions was pleasantly surprised. </font><font style="vertical-align: inherit;">All configuration of the new VPN takes place by calling two PowerShell cmdlets:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And one more thing, if Strongswan is configured to issue IPv6 addresses to clients (yes, he can do it too):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part Four, Final. </font><font style="vertical-align: inherit;">We cut a window to Europe</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having seen the provider stubs ‚ÄúThe site was blocked by the decision of the left heel of the fifth deputy prosecutor of the village Trudovye Mozoli of Bogozabyt county‚Äù, a small, inconspicuous VPS appeared (with the well-sounding domain name rkn.example.com) a thousand kilometers from monkeys who like to wave with a banhammer and block networks of size / 16 at a time. And spinning on this little VPS was a wonderful creation of colleagues from NIC.CZ called BIRD. The bird of the first version constantly died in a panic from the activity of monkeys with batons, who banned almost 4% of the Internet at the peak of their labor activity, leaving for deep thoughtfulness during reconfig, therefore it was updated to version 2.0.7. If readers are interested, I‚Äôll publish an article on the transition from BIRD to BIRD2, in which the config format has changed dramatically,but the new version has become much faster and there are no problems with reconfig with a large number of routes. And since we use the dynamic routing protocol, then there must be a network interface through which you need to route traffic. By default, IPSec does not create interfaces, but due to its flexibility, we can use the classic GRE tunnels, which we will protect in the future. As a bonus, the ipsecgw.example.com and rkn.example.com hosts will authenticate each other using Lets Encrypt self-renewing certificates. No PSK, only certificates, only hardcore, there is not much security.By default, IPSec does not create interfaces, but due to its flexibility, we can use the classic GRE tunnels, which we will protect in the future. As a bonus, the ipsecgw.example.com and rkn.example.com hosts will authenticate each other using Lets Encrypt self-renewing certificates. No PSK, only certificates, only hardcore, there is not much security.By default, IPSec does not create interfaces, but due to its flexibility, we can use the classic GRE tunnels, which we will protect in the future. As a bonus, the ipsecgw.example.com and rkn.example.com hosts will authenticate each other using Lets Encrypt self-renewing certificates. No PSK, only certificates, only hardcore, there is not much security.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We believe that the VPS is prepared, Strongswan and Certbot are already installed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the ipsecgw.example.com host (its IP is 1.1.1.1), we describe the new gif0 interface:</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mirrored on the host vps.example.com (its IP is 5.5.5.5):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We raise the interfaces, but since iptables does not have a rule that allows the GRE protocol, traffic will not go (which is what we need, since there is no protection inside GRE against fans of any kind of legislative ‚Äúpackages‚Äù).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cooking VPS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we get another certificate for the domain name rkn.example.com. </font><font style="vertical-align: inherit;">Create symlinks in /etc/strongswan/ipsec.d as described in the previous section. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit ipsec.secrets by adding a single line to it:</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the host side, ipsecgw.example.com is also added to ipsec.conf in the setup section the strictcrlpolicy = yes parameter, which includes strict CRL checking. </font><font style="vertical-align: inherit;">And describe another connection:</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configs are almost mirrored. </font><font style="vertical-align: inherit;">The attentive reader could already pay attention to a couple of points:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left / rightsubnet =% dynamic - instructs Strongswan to apply policies to all types of traffic between peers</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget to configure the firewall and auto-renew certificates. </font><font style="vertical-align: inherit;">After restarting Strongswan on both servers, start ping the far side of the GRE tunnel and see a successful connection. </font><font style="vertical-align: inherit;">On VPS (rkn):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And on the host side ipsecgw </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">under the spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The tunnel is installed, pings go, in tcpdump it is visible that only ESP goes between hosts. </font><font style="vertical-align: inherit;">It would seem possible to rejoice. </font><font style="vertical-align: inherit;">But you can not relax without checking everything to the end. </font><font style="vertical-align: inherit;">We are trying to reissue the certificate for VPS and ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chef, it's all broken</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We begin to understand and stumble upon one unpleasant feature of Let's Encrypt, which is beautiful in everything else - with any reissue of the certificate, the private key associated with it also changes. The private key has changed - and the public has changed. At first glance, the situation is hopeless for us: even if we can easily extract the public key during re-issuance of the certificate using the hook in certbot and pass it to the remote side via SSH, it is not clear how to make the remote Strongswan re-read it. But help came from where they did not wait - systemd can monitor changes to the file system and run the services associated with the event. This is what we will use.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will create a keywatcher service user on each of the hosts with the most restricted rights, generate SSH keys for each of them, and exchange them between the hosts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the ipsecgw.example.com host, create the / opt / ipsec-pubkey directory in which we place 2 scripts.</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On VPS (the host rkn.example.com), we similarly create a directory with the same name, in which we also create similar scripts, changing only the name of the key. </font><font style="vertical-align: inherit;">Code, so as not to clutter up the article, under</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spoiler</font></font></b>
                        <div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The pubkey-copy.sh script is needed to extract the public part of the key and copy it to the remote host when issuing a new certificate. </font><font style="vertical-align: inherit;">To do this, in the / etc / letsencrypt / renewal-hooks / deploy directory on both servers, create another microscript:</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Half of the problem is resolved, certificates are re-issued, public keys are extracted and copied between the servers, and the time has come for systemd with its path units. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the ipsecgw.example.com server in the / etc / systemd / system directory, create the keyupdater.path file</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Similarly on the VPS host:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And finally, on each server we create a service associated with this unit, which will be launched when the condition (PathChanged) is fulfilled - changing the file and closing it after recording. </font><font style="vertical-align: inherit;">We create the files /etc/systemd/system/keyupdater.service and write:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget to re-read the systemd configurations with sudo systemctl daemon-reload and assign autostart to path units via sudo systemctl enable keyupdater.path &amp;&amp; sudo systemctl start keyupdater. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as the remote host writes the file containing the public key to the keywatcher user home directory and the file descriptor is closed, systemd will automatically start the corresponding service, which will copy the key to the desired location and restart Strongswan. </font><font style="vertical-align: inherit;">The tunnel will be installed using the correct public key of the second side. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can exhale and enjoy the result.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead of a conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we just saw the </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hell</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec is not as scary as it is painted. </font><font style="vertical-align: inherit;">All that has been described is a fully operational configuration that is currently in use. </font><font style="vertical-align: inherit;">Even without much knowledge, you can configure a VPN and reliably protect your data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the moments of iptables setup remained outside the scope of the article, but the article itself turned out to be already voluminous, and much has been written about iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are points in the article that can be improved, be it refusal to restart the Strongswan daemon, re-reading its configs and certificates, but I could not achieve this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, the daemon‚Äôs restarts weren‚Äôt scary: one or two pings between peers are lost, mobile clients restore the connection themselves.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope colleagues in the comments will prompt the correct solution.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504464/index.html">How we came up with the TableAdapter and simplified the work with UITableView</a></li>
<li><a href="../en504468/index.html">Raspberry Pi performance: add ZRAM and change kernel parameters</a></li>
<li><a href="../en504472/index.html">My Top Free Developer Tools</a></li>
<li><a href="../en504480/index.html">How to find a marketer with whom it will be profitable to work?</a></li>
<li><a href="../en504482/index.html">Ask us: DIT will answer questions</a></li>
<li><a href="../en504486/index.html">Process: Creating Vue 3</a></li>
<li><a href="../en504488/index.html">What industries and technologies will begin to develop rapidly after solving the problem of COVID-19</a></li>
<li><a href="../en504490/index.html">June Online Events Digest</a></li>
<li><a href="../en504492/index.html">Press the button: theory and practice of electronic voting - round table on May 30</a></li>
<li><a href="../en504502/index.html">The short and strange life of the world's first friendly robot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>