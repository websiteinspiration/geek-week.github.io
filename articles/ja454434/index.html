<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤶 🛌 🈯️ PDA（Pocket Travel Computer）：回路GPSロガー 🎴 👨🏿‍🎨 🚈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私の趣味のプロジェクトはGPSロガーです。コメントで、彼らはそれを「トリップコンピュータ」と呼ぶことさえ提案しました、ロギングは、デバイスのすべての機能のほんの一部です。多くはすでに実装されていますが、ほとんどはまだ実装されていません。
 
 以前の記事では、私が説明したSTM32にアルドゥイーノか...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PDA（Pocket Travel Computer）：回路GPSロガー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454434/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私の趣味のプロジェクトは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPSロガー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。コメントで、彼らはそれを「トリップコンピュータ」と呼ぶことさえ提案しました、ロギングは、デバイスのすべての機能のほんの一部です。多くはすでに実装されていますが、ほとんどはまだ実装されていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前の記事では、私が説明した</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32にアルドゥイーノからの移行を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STMCube / HAL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドシステムについて少し話をした</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブートローダ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複合USBデバイスを構築しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その速度を汲み上げ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これはすべて</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Blue Pill STM32F103CBボード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とワイヤーのハリネズミに</font><font style="vertical-align: inherit;">基づくブレッドボードで行われました</font><font style="vertical-align: inherit;">。電子（回路）と物理（本体）の両方のデバイスを形にする時が来ました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0g/et/tj/0gettjt59u77r2mjpz73hyfn7sc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階で解決しなければならない問題は、相互に関連しています。プロジェクトのコンポーネントを選択するときは、コンポーネントを押し込むことができるハウジングを大まかに想像する必要があります。また、その逆の場合、使用可能なコンポーネントとボードについてケースを作成する必要があります。この場合も、ケースに注意して行う必要があります。一般に、相互に関連する問題のもつれ。もちろん、大きな箱を持ってそこに何かを押し込むこともできますが、コンパクトで軽いものを望んでいました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すぐに始める前に、これがデバイスの最終バージョンではないことに注意したいと思います。</font><font style="vertical-align: inherit;">ほとんどの場合、スキームにエラーがあり、何かが意図したとおりに機能しない可能性があります。コメントでは、より正しい解決策を示しており、いくつかのアプローチが再検討されます。</font><font style="vertical-align: inherit;">デバイスの2番目または3番目のバージョンも回避できないと思います。</font><font style="vertical-align: inherit;">したがって、私はあなたの建設的なコメントを喜んでいます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カッターの下にはマルチビードがありますが、エンジニアリングになります。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何と理由</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GPSロガーのHolux M241は、すべての旅行で私の忠実な仲間です。彼は何千キロも私と一緒にいた。ロガーが書き込むトラックは、主に写真にジオタグを付けるために使用されますが、ルート自体も重要です。スキーの速度、飛行機の飛行経路、バスの窓の外を照らしている光景を見つけるのは楽しいことです。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、このデバイスの簡単なレビューを行いました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、このデバイスの機能は長い間私に適していませんでした。私は常に最も不都合な瞬間に座っているバッテリーをいじるのにうんざりしています。また、非常に低いUSB速度、少量の内部フラッシュ、トラックをマージするための不便なメカニズム、ディスプレイに表示できる情報がほとんどない、精度が低い、非常に原始的な走行距離計、衛星に関する情報がないなど、その他多くの機能があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、最新のトラッカーが提供するものを探すことができます-確かに、私の要件を満たすデバイスがすでに販売されています。しかし、これは趣味です。難しい、面白くて、有用で、必要なことをしたいと思っています。使用してもしましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全体としてのプロジェクトの目標は、私のウィッシュリストだけを詰め込んだ、同じようなデバイスを何かで作ることです。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリーズの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">最初の記事</font></a><font style="vertical-align: inherit;">では、デバイスの要件を詳しく説明しました。</font><font style="vertical-align: inherit;">要するに、私は次のことをしたいと思います：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電源システムをリサイクルし、リチウム電池に移す</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より有益な表示をする</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より正確なGPS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDカードでフラッシュを拡張する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパスと加速度計を追加する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">また、必要なフォーマットでトラックを吐き出すようにロギングシステムを再設計したいと考えています。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
技術的な要件とウィッシュリストに加えて、非技術的な（機能しない）ものもあります。そこで、複雑なデバイスを一から作成して、さまざまな電子コンポーネントの仕組み、プログラム方法、ボードの作成方法、ケースの設計方法を理解したいと思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最新の電話すべてにGPS、大画面、大容量のメモリが搭載されているのに、なぜ別のデバイスが必要なのですか？さて、まず第一に、トラック録音モードでGPSがオンになっている電話が1日中耐えられるかどうかはわかりません。電話なしで見知らぬ国に留まりたくありません。また、個人的には別のデバイスを使用する方が簡単です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく、時間の経過とともに、デバイスのコンセプトは変化します。したがって、たとえば、画面を放棄してBluetooth経由で電話に接続し、電話ですべてのロジックトリックを実行することがますます論理的になっています。このアイデアは非常に堅牢で魅力的です。しかし、この段階では、私はまだディスプレイを持ちたいと思っています-私は常にそれを放棄する時間があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の1年半、さまざまな種類のデバッグボードでデバイスを開発しました（最初にarduino nano、次にSTM32F103青い錠剤、次にSTM32F407VE）。配線に周辺機器を接続する必要があり、モジュールを購入しました。その結果、ワイヤーでできたハリネズミがテーブルで判明しましたが、路上でのGPS受信をテストするためには機能しませんでした。接続をどこかで切断しないと、ワイヤーを移動することさえできない場合があります。そして幸せなデバッグ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
毎回、便利な機能を書くために座っていると、システムの他の部分が正常に動作しなくなり、完全に無関係なものをデバッグするのに何時間も費やす必要があるという事実に直面しました。</font><font style="vertical-align: inherit;">したがって、たとえば、システムの最も重要なコンポーネントであるGPS受信機は、結局のところ開発が最も遅れていることがわかりました。</font><font style="vertical-align: inherit;">私はデバッグUSB、SDカード、ライブラリのセットアップなどに向かわなければなりませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、私はそれに飽きて、デバッグボードを作ることにしました-これは、今日の記事のトピックになります。</font><font style="vertical-align: inherit;">プロジェクトのこの部分で自分のために設定した目標は次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非接触コンポーネントで問題が発生しないデバッグボードを作成する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主な技術および回路図ソリューションを決定する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次に使用するコンポーネントを大まかに決定します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レイアウトと本体を大まかに決める</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">回路は、さまざまなコンポーネントとそのモードを試すことができるように十分に一般的でなければなりません</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして究極の目標はコンパクトなバッテリーデバイスですが、今日は次のようなことはしません</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パワーモードの微調整</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消費設定</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スリープモード</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボードとメインコードの準備ができたら、消費設定を処理します。</font><font style="vertical-align: inherit;">ちなみに、今日のコードについてもそうではありませんが、興味深い資料がたくさんあるので、間違いなくこの質問に戻ります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部品</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンポーネントと周辺機器から始めましょう。途中で、この動物園を接続するために必要なマイクロコントローラーの脚の数と、電力パラメーターを推定します。なぜなら店舗/ ebay /アリで実際に購入できるもの、および自宅ではんだ付けできるものから（もちろん、私がすでに持っているものからも）コンポーネントを選択したのは趣味のプロジェクトです。おそらくいくつかの特定のマイクロ回路が問題をよりよく解決できるかもしれませんが、手頃な価格と価格の問題は私にとって重要です。</font></font><br>
<br>
<ul>
<li>  GPS , ,  <b>GPS </b>.       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Beitian BN-880</a>    UBlox M8N.        HMC5883L.<br>
<br>
: 2  UART  GPS  2  I2C  <br>
 :  2.7<br>
 : 50<br>
<br>
<ul>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Beitial BN-220</a>.    ,      (2020  3030).         .  . ,   ,      1.4,        .</li>
<li>     - .   BN-880    UBlox M8N,   BN-220   U-blox M8030-KT.       ,  ,   .  M8N  ,  M8030-KT   .         — M8N   2.7,   M8030-KT  1.4.</li>
<li>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://www.aliexpress.com/item/1PC-SIM868-GSM-GPRS-Bluetooth-GNSS-SMS-GSM-Module-Instead-of-SIM808-SIM908/32821272639.html%3Fspm%3Da2g0s.9042311.0.0.27424c4dTkhPkq)%2520(%25D0%25BE%25D1%2582%25D0%25BB%25D0%25B0%25D0%25B4%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F%2520%25D0%25BF%25D0%25BB%25D0%25B0%25D1%2582%25D0%25B0%2520">SIM868</a>.      GPS   GSM/GPRS   Bluetooth.       .       .</li>
</ul></li>
<li>    “  ”   <b></b>.        I2C,      25%.       ,   ,       25,          .    ,         I2C,      SPI<br>
<br>
: 2  I2C  3  SPI ( write-only,   MISO  ,     Data/Command)<br>
 :  3<br>
 : 25<br>
</li>
<li>       <b>2 </b>,   2  , <br>
</li>
<li>   (Holux M241,      )        .            .   ,              .     <b>Bluetooth</b>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">HM-13</a>.    ,    SPP    BLE.<br>
<br>
: 2  UART, 1   (/ )<br>
: 2.5V — 3.9V<br>
: 50 (        13.      )<br>
</li>
<li>  ,     ,          .     <b> </b>MMA8452             - .<br>
<br>
: 2  I2C, 1   <br>
   2  3.6  -  <br>
</li>
<li>GPS     <b>SD </b>.        SPI  ,  , .   .    SD  — SDIO<br>
<br>
: 6 <br>
 :  1.8<br>
  ,     20<br>
</li>
<li>        ,      .        <b></b>,      <br>
<br>
: 5 ,      (GPS, Bluetooth, , SD , )<br>
<br>
UPD   .      —      .        ( SD ) —       .   ( GPS)       .          —      .             .  ,        .</li>
<li><b> </b>    (    ?).      ,     .<br>
<br>
: 2 <br>
 : 10<br>
</li>
<li>         —  <b>USB</b>.     4  —    , 1   ,     USB,        (   2    )<br>
</li>
<li>    .           ,      <b></b>?   <b></b>.    .<br>
<br>
: 1 <br>
</li>
<li>    .      PT1502       <b> </b>.        2 :    ,      .             .<br>
</li>
<li>,        .     <b>-  INA219</b><br>
<br>
 : 3-5,  3.3<br>
 : 2  I2C<br>
<br>
       3     .   ,  -   2.7  .       //        2.7.    .<br>
</li>
<li>     <b>SWD </b>(3 )  <b> UART</b> ( 2 )<br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は常に、多数のポートを持つコントローラーが必要な理由の問題に常に関心があり、機能に必要な39の足を簡単に数えました。</font><font style="vertical-align: inherit;">そして、それはクオーツ、リセット、および電力を数えていません。</font><font style="vertical-align: inherit;">そして、さらに12をどうするかについてのアイデアがあります（たとえば、ディスプレイは、パラレルIntel 8080またはMotorola 6800インターフェイスを介して接続できます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、I2Cポートエクスターナーをねじ込んで、使用する脚の数を減らすこともできます。</font><font style="vertical-align: inherit;">しかし、最初に、これらはボード上の追加のコンポーネントであり、2番目に、ソフトウェア部分は非常に複雑になり、3番目に、小さなマイクロコントローラーにはまだメモリがほとんどなく、十分なメモリがある場合は、十分なポートもあります。</font><font style="vertical-align: inherit;">したがって、すべてを複雑にする理由はないと思います。39行あるとします。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">栄養</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電源では、すべてがそれほど明確ではありません。</font><font style="vertical-align: inherit;">おそらく3.3Vからすべてのデバイスに電力を供給し、落ち着くことができます。</font><font style="vertical-align: inherit;">しかし、それでも、モバイルデバイスを作るつもりです。つまり、エネルギーの節約について考える必要があります。</font><font style="vertical-align: inherit;">したがって、より小さな電源電圧を選択する必要があります。</font><font style="vertical-align: inherit;">以下では、どの程度の節約を実現できるかを見積もります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、プレート内のすべてのデバイスのデータです。この形式では、このデバイスまたはそのデバイスを接続する電源ドメインを選択する方が便利です。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">端末</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パワーレンジ</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パワードメイン</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コミュニケーション</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2-3.6V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2V</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加速度計</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2-3.6V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I2C</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDカード</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.8Vまたは3.6V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDIO</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表示</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.65-3.3V </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または3-5V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I2CまたはSPI</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPS</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.7-5.5V </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または1.4Vから</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.7V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブルートゥース</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.5-3.9V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.7V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UART</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パワーメーター（INA219）</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3-5.5V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3v</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I2C</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブザー</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3V-5V</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vbat</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プレートから、一部のデバイスは十分に低い電圧（1.8Vから）で動作できることが簡単にわかります。他は2.7Vから快適に働くことができます。最後に、3V未満の残りのデバイスは機能しません。きしむ音は、一般的には5Vを必要としますが、私にとってはそれが最も高い電圧によって供給されます-それがいくらであっても、バッテリーから。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディスプレイの力でまだ完全に理解されていません。アリ付きのディスプレイモジュールの説明では、範囲は3〜5Vですが、マトリックスコントローラーSSD1309のデータシートでは、範囲は1.65〜3.3Vです。ディスプレイモジュールボードのブーストコンバーターをスイングするには3Vが必要であると思いますが、ロジックには1.65Vで十分です。レイアウトに関する説明からわかるように、ディスプレイモジュールを放棄してディスプレイを直接接続することは理にかなっています。これにより、2Bドメインからディスプレイに電力を供給できるようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はGPSについてほぼ同じ理由を持っています-異なるソースは異なる供給電圧を示します。これまでのところ、最終的にどのモジュールを使用するのか理解していないので、レシーバーを2.7Vドメインでハングアウトさせてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDカードでは、それはまったく明確ではありません。仕様には、一般的にカードは3.3Vから給電する必要があると明記されていますが、最新のカードは十分にスマートであり、低電圧デバイスでスタックし、1.8Vからの電力に切り替えることができることを理解できます。しかし、食品を選択するメカニズムはあまり明確ではありません。カードを2Bからフィードして、何が起こるかを確認します。動作しません-3Vから動作します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、4つの電源バスが織り込まれている-2V、2.7V、3Vとバッテリー。私は食事をしていて常に働いているすべての消費者（そしてこれはコントローラーとGPSです）を最低電圧のバスに置きたいと思っていますが、現時点ではまだGPSモジュール（したがってその電源-2または2.7V）を決定していないため、それが必要になりますある種の普遍的な解決策。ボードを分離して、どちらか一方の電圧を簡単に印加できるようにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どこからそんなに多くの異なるストレスを得るのですか？プロジェクトの初期段階でさえ、PT1502マイクロ回路を調べ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、別のプロジェクトでそれを試すこと</font></a><font style="vertical-align: inherit;">も</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。リチウム電池の充電器に加えて、この超小型回路には3つの電源（1つのパルスと2つのラインダウン）があります。ただし、ここでは、電圧はそのうちの1つで調整されておらず、3Vです。そこからINA219に電力を供給しようとします。残りの2つの電源は問題ではありません。そこで電圧を選択できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
消費量の見積もりはあまり成功していません。ピーク消費量はデータシートに示されています。これは、主要なトランジスタの電力を計算するには十分ですが、必要なバッテリー容量を見積もるには十分ではありません。とりあえず、ケースの空き容量に基づいてバッテリーを選択し、そこで実際の消費量を測定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
疑問が生じるかもしれませんが、異なる動作電圧のデバイスをどのように一致させるのですか？それを正しくしましょう。</font></font><br>
<br>
<ul>
<li>      Five Volt Tolerant ( UART2   PA2/PA3),      3.3        </li>
<li>     2,          .     —   MMA8452Q         (  “”   )</li>
<li>SD       ,   ,      . </li>
<li>GPS  Bluetooth     “”   .      “” </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、なぜ私が供給電圧を下げるためにそんなに戦っているのかについて少し説明します。</font><font style="vertical-align: inherit;">パルスDC-DCコンバーターのチップ。ボルトをアンペアに交換できます（もちろん、コンバーター自体の損失を考慮しない場合）。</font><font style="vertical-align: inherit;">より正確には、より高い電圧をより低い電流でより低い電圧とより高い電流に交換します。</font><font style="vertical-align: inherit;">この場合、逆の推論に関心があります。DC-DCを介して低電圧の負荷を供給する場合、コンバーターと一緒にこの構造全体の消費電流は、負荷自体の消費電流よりも低くなります。</font><font style="vertical-align: inherit;">まあ、バッテリー容量はmAhで測定されるので、電流消費を減らすとバッテリーの寿命が伸びます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カウント？</font></font></b><div class="spoiler_text">  ,        90%,        DC-DC        .  .      ,      DC-DC   . <br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.   900    4.1  3.5 (      ).  DC-DC    90% (   ).    100.            .<br>
<br>
,      900  100  9 .          — 9.3     3.3, 11.4   2.7,   15    2. ,    ,    ,        .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイクロコントローラー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はマイクロコントローラーを慎重に選択するという質問に取り組みました。私は長い間コンフィギュレーターで遊んで、各オプションの長所と短所を比較検討しました。私はSTM32マイクロコントローラーが本当に好きだったので、特別な必要なしに他のコントローラーの方向を見るポイントがわかりません。さらに、STM32シリーズには、あらゆる好みと周辺機器に対応するコントローラーがあります。プロジェクトの前の段階で得られた経験により、周辺機器のリスト、既に作成されたソフトウェアバインディング、および将来実装したい機能に基づいて、コントローラーの選択を絞り込むことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、私のSTM32F103CBの20kbのメモリが明らかに小さいことは明らかです-SDカードおよびUSBと通信するための十分なサイズのバッファがありません。</font><font style="vertical-align: inherit;">私は計画された機能の多くを実装することさえ始めていませんが、それはすでに19kb以上かかりました。</font><font style="vertical-align: inherit;">しかし、処理能力があれば、これは特に必要ありません。</font><font style="vertical-align: inherit;">周辺機器とのすべての通信がDMAにプッシュされると、中央プロセッサのシェアは数パーセントに留まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラーから必要なもののリストを見積もったので、以下を計算しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; = 128kbフラッシュ（現在約50kが使用されています）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; = 40 kbのメモリ（現在は19kが使用されています）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; = 40フィートGPIO（上記の理由を参照）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; = 40MHz（多くは必要ありませんが、主なものは消費量を減らすことです）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DMA（本当に気に入った）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; = 2x I2C、&gt; = 3x UART、&gt; = 1 SPI</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDIO（SPI経由のフラッシュドライブが非常に遅い）</font></font></li>
<li> USB Full Speed,  High Speed</li>
<li> (      )</li>
<li>      LCD  (         FSMC)</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STMicroelectornicsマイクロコントローラーは、すべての好み、色、財布について、わずか1ダースです。最初に、シリーズから進めるコントローラーを選択しようとしました。ルーラーL0とF0は弱すぎてメモリが足りません。逆に、S7とH7はファンシーすぎます。L4にはSDIOがありません（UPD：SDIOは、シリーズのタイトルページで言及していません）。シリーズの残りの部分では、特に特定の要件はないので、私のニーズに基づいて何かを選択できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STM32WBシリーズはBluetoothの存在に感銘を与えますが、VFQFPN68ケースは趣味のプロジェクトでそれを使用したいという欲求を多少冷やします。そして、私は小売店でそのようなコントローラーを見つけませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はLQFP64ケースを目指しました-脚の数は十分ですが、同時にそれほど大きくなく、自宅ではんだ付けできます。フィルターを使用して必要なものを選択できるCubeMXコンフィギュレーターがあるのは良いことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STM32F103RBコントローラーを選択した理由は3つあります。まず、F103シリーズについては、Blue Pillボードを使ってよく研究しました。一般に、STM32F103CBコントローラーは私に完全に適しています。メモリだけでは不十分でした。次に、このコントローラー用のブートローダーと低レベルのコードを既に持っていますが、他のコードをやり直す必要があります。そして3番目に、約1年前に、私はすでに3個のSTM32F103RBを購入することに喜びを感じていました。次に、利用可能なコントローラーの詳細な調査は行わず、F103ラインからより厚いコントローラーを選びました。今それを捨てないでください:)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに述べたように、特に特定の周辺機器やパフォーマンスの要件はありません。</font><font style="vertical-align: inherit;">しかし、何かに遭遇した場合は、F4ライン（より強力なものが必要な場合）のコントローラー、または消費で何かを決定する必要がある場合はL152RD（UPD：L433RCも調べた）のコントローラーが既にあることに注意してください。</font><font style="vertical-align: inherit;">STM32では、ほとんどすべてのピン対ピンコントローラーに互換性があり、ボードを変更せずにF4およびL1 / L4をはんだ付けできます。</font><font style="vertical-align: inherit;">異なるMKで消費を収集して比較することもできます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本文とレイアウトについて一言</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
詳細を決めました。ダイアグラムを描画し、ボードをトレースして、ケースに取り付けます。か否か？認めるために、私は最初はこのように行っただけですが、その後、すべてを逆の順序で行う必要があるという結論に達しました。まあ、または少なくとも同時に。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパクトなデバイスが欲しいのですが。そのためには、利用可能なスペースのサイズを正確に理解し、ボードの配置場所とそのサイズ、バッテリーが収まるサイズ、ボタン、画面、USBコネクタなどの外部コンポーネントを配置する場所を理解し、コンポーネントの取り付け方法を理解する必要があります。それらの間にワイヤーを敷くのは便利ですか？これらすべてのことを理解せずに取締役会を立ち上げることは、単に無意味です。したがって、最初にボディとレイアウトを処理してから、回路に移る必要があることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ケースを描く過程で、部品の選択を何度か見直す必要がありました。したがって、最初は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安価な128x64 0.96インチディスプレイ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（作業領域21.7 x 11.2mm）</font><font style="vertical-align: inherit;">を使用することを考えました</font><font style="vertical-align: inherit;">が、このディスプレイは、はるかに大きなケースの背景に対して完全に微視的に見えました。その後</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、1.3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インチの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ディスプレイ</font></a><font style="vertical-align: inherit;">が注文されました</font><font style="vertical-align: inherit;">（作業領域29.4 x 14.7 mm）が、それよりはよくなりませんでした。次に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、1.54</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インチ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ディスプレイ</font></a><font style="vertical-align: inherit;">（35 x 17.5 mm）</font><font style="vertical-align: inherit;">を手に入れまし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;"> -それは多かれ少なかれ正常です。これが現在主な機能オプションです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
推定によると、1.8インチ-2インチディスプレイの方が見栄えが良かったのですが、これらはすでにカラーで高解像度になっているため、画面バッファーはコントローラーに十分な大きさになります（1kbではなく35kb）。まあ、ケースに大きなディスプレイを押し込むことも問題になることがあります。そのようなモジュールの着陸ブラケットは、ディスプレイのアクティブ領域よりもかなり大きいです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私がアリについてこの記事を書いている間、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モノクロの2.42</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インチ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ディスプレイ</font></a><font style="vertical-align: inherit;">は同じ解像度（128x64）で</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">表示さ</font></a><font style="vertical-align: inherit;">れ、1.54とまったく同じバインディングで表示されました。私はこれを自分用に注文しました。デバイスを大幅に増やすことなく、ケースに貼り付ける可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ケースの作業段階におけるもう1つの重要な点は、購入したディスプレイモジュールが占有するスペースが多すぎて、メインボードのスペースが大幅に減少することを理解することでした。したがって、完成したディスプレイモジュールを放棄し、代わりにディスプレイとそのバインディングをボードに配置することにしました。回路の部品点数はわずかに増加しましたが、デザイン全体が著しく簡素化され、よりコンパクトになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GPSモジュールのトピックについても同様の考えがあります。それほど大きくはありませんが、どのように配置したり干渉したりしたり、アンテナがバッテリーによって閉じられていたりしても関係ありません。モジュールの詰め物をボードに配置し、アンテナを別の場所に配置することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ケースの作業により、バッテリーのサイズと容量を決定することも可能になりました。利用可能なボリュームで、900mAhバッテリーがちょうど見つかりました-私たちはそれに焦点を当てます。私のデバイスが15〜20時間のバッテリーで動作するようにしたいと考えています。つまり、消費は45〜60 mAのレベルでなければなりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現時点では、船体の作業が終了したとは言えません。</font><font style="vertical-align: inherit;">まず、一部のコンポーネント（ディスプレイ、GPS）の選択の問題は未解決のままです。</font><font style="vertical-align: inherit;">第二に、私の回路が原則的に始動するのか、それとも根本的に何かを変える必要があるのか​​は明らかではありません。</font><font style="vertical-align: inherit;">3番目に、ボードが小さすぎることが判明しました。溶解、はんだ付け、デバッグできるかどうかわかりません。</font><font style="vertical-align: inherit;">したがって、この記事では、引き続き回路の問題に焦点を当て、より簡単で理解しやすい手順で説明し、次回はそのケースについて説明します。</font><font style="vertical-align: inherit;">ここには、シードのレンダリングと写真がいくつかあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4j/ff/l-/4jffl-arvuselp1d93s5muqazqy.png"><br>
<br>
<img src="https://habrastorage.org/webt/o2/a9/ve/o2a9vejujirpcxe634dzikwqc0e.png"><br>
<br>
<img src="https://habrastorage.org/webt/a9/hu/ka/a9huka9xfxi-g0wegdzhb8ezonm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/az/nl/b2/aznlb21azpqtsfgoaim0occrvgc.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキーム</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今、あなたは電子工学を行うことができます。回路ソリューションについて詳しく説明します。まず第一に、私と同じエレクトロニクスの新人、そして自分へのあらすじ。経験豊富なエレクトロニクスエンジニアは、回路をざっと見て、次のセクションに戻ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
栄養から始めましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデバイスはリチウム電池で動作します。つまり、充電コントローラーが必要です。また、一部のコンポーネントの上限電圧は約3.6Vですが、バッテリーは4Vを超える可能性があります。したがって、降圧電源が必要です。すでにわかったように、いくつかの異なるストレスが必要になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PT1502チップを使用することはすでに述べました。それはよくフィットします、なぜなら充電コントローラー、3つの電源、ボタンスイッチデバイス回路を実装します。マイクロ回路にはいくつかの機能ブロックがあり、わかりやすくするために図で分割しています。回路自体は、わずかに改訂されたデータシート回路です。こちらがリチウム電池充電コントローラーで、</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7y/p7/sk/7yp7skuez7vcdpdzr33f6rhtfk4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
抵抗R3が充電電流を設定します。デフォルトでは、これは470mAに相当します。おそらく、テスト結果に応じて、この抵抗の値を510オームに減らします。これにより、約900mA（1C）の充電電流が得られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラは、足のCHG_STATで現在の充電モードを報告できます。さらに、彼は信号を3まで与える方法を知っています。充電する、充電しない、すでに充電されているが、コンセントに接続されている。最初のバージョンでは、内部トランジスタが足を地面に押し付けており、これはコントローラで簡単に認識できます。第２の実施形態では、トランジスタは完全に閉じられ、脚は高インピーダンス状態になる。パワーアップを使用すると、このような信号もコントローラで簡単に読み取ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、3番目の状態では、すべてがそれほど単純ではありません。そこで、トランジスタは半開きで、20μAの電流が流れます。そのような状況を考えるために、栄養の約半分が足にかかるようにリフトを選ぶよう促されました。そうすれば、ADCを使用してそのような状態を簡単に検出できるようになります。オームの法則を使用すると、R5 = 1V / 20mkA = 50kになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先ほど述べたように、PT1502チップは単なる充電器ではなく、すべての電力を制御するトリッキーなコントローラーでもあります。マイクロ回路は回路内の電圧を監視し、RESET信号を使用してメインプロセッサを制御できます（まだ早期に起動する必要があるため、電力がまだ安定していません）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/21/z3/f1/21z3f1tkkpvqsph462qukz0_anu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、マイクロ回路はボタン（BTN1）に触れるだけでデバイスを起動でき、マイクロコントローラー（PWR_HOLD）からの信号で操作を完了して電源をオフにすることもできます。まあ、バッテリーが信号BAT_LOWを使い果たしていることをプロセッサに知らせるために。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これが主な動力源です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nb/5x/tc/nb5xtc2txxl98wz1pfwgmzsr49u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力電圧はBUCKFB端子の電圧によって設定され、バッテリー電源で2Vに設定されます。しかし、2ボルト電源では、1つの問題が発見されました-USBが機能しません。それら。バッテリーは充電されますが、データを送信することはできません。マイクロコントローラーは、十分な振幅のUSBバスに信号を出力できなくなります。 Datashitは、少なくとも2.7V、できれば3.3Vの電圧を推奨します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の電源をブロックせず、それらを切り替える方法を考えるために、分圧器R1 / R4 + R7の比率を調整することにしました。この包含により、インパルスは継続的に動作します。デバイスがUSBに接続されるとすぐに、トランジスタが開き、R7をシャントします。駆動抵抗の比率が変化し、出力で3.16Vが得られます（まだ定格で遊んで3.3Vに到達できます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PT1502には、2つのリニアコントロールもあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1c/s0/tj/1cs0tjf8eerkuske4_dyqithygm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
低消費コンポーネント（INA219）または短命（bluetooth）のいずれかがこれらのコントローラーに接続されるため、これらのソースの効率は問題になりません。 LDO2電源電圧は、LDO2_SETx信号を使用して調整できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電源電圧に関する未解決の質問があるため、ジャンパーを分離してLDO2_SETxモードを選択することにしました。また、対応するバスの実際の消費量を測定できるようにするために、JP1 / JP2 / JP3のジャンパーをコームにブリッジします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電源のトピックを終えて、我々はディスプレイのパワーに言及する必要があります。</font><font style="vertical-align: inherit;">私はもう少し高く書いた。コンパクトさの名の下に、購入したディスプレイモジュールを放棄して、ボードにストラップで留めてディスプレイを拾わなければならなかった。</font><font style="vertical-align: inherit;">このディスプレイには、特別な7-16Vブーストコンバーターが必要です。</font><font style="vertical-align: inherit;">便利なことに、この信号源はEN信号を使用してオンとオフを切り替えることができます。</font><font style="vertical-align: inherit;">回路自体はブースターのデータシートからコピーされますが、aliを備えたディスプレイモジュールではまったく同じものが使用されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oi/bd/zm/oibdzmvkie49fxcjamxcvszh9gw.png"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PT1505</font></font></b><div class="spoiler_text">       PT1502       —  PT1505.      ,    .           .    PT1505    .<br>
<br>
,           .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、マイクロコントローラーのパワーについて少し説明します。マイクロ回路は大きく、6本の電源ラインがあります-デジタル部用に4本、アナログ電源用に1本、クロック用に1本。 STM32F103のデータシートによると、すべての電力線（おそらくクロックを除く）では、コンデンサーに沿って100nFのコンデンサーがあり、もう1つは4.7uFにあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、STM32F4のデータシートでは、マイクロコントローラーは出力に関しては実質的に互換性がありますが、それでも多少異なる電力スキームがあると言われています。したがって、2つの端子には、端子とグラウンドの間に（F1のようにグラウンドと電源の間にではなく）2.2μFのコンデンサが必要です。したがって、私は両方のオプションと、特定のマイクロコントローラーがコンデンサーの一部のみをはんだ付けすることを検討する必要がありました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/ai/a4/vvaia45dk-cjpdj9jrypfecczug.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
栄養のトピックを続けて、あなたはそれを測定する方法を理解する必要があります。 BAT_LOW信号に依存して、バッテリーが少ない場合はすぐに丸めるようにユーザーに要求できます。しかし、これは私がオリジナルのHolux M-241で好きでなかったものとまったく同じです。この信号は遅すぎて見逃されがちでした。バッテリー残量のより有益なインジケーターが必要です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2r/6l/0g/2r6l0gd1bdyewq--m8zij_nugxs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
念のため、私はバッテリー電圧を測定するために最も普通の分圧器を置きました。ただし、リチウム電池の場合、これは情報を提供するだけの指標であり、信頼してはなりません。インターネットでのより正直なバッテリー測定値については、「ペンダント」の使用を勧めています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/an/3u/nc/an3uncm2tjzd-pu3n6ns8vqnhz0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この小さなマイクロチップは、それを通過してバッテリーに出入りしたエネルギーの量をカウントします。シャントR10で測定が行われます。マイクロ回路の読み取り値は、I2Cを介して読み取ることができます。マイクロ回路は、バッテリーの電圧、抵抗を通過する電流を測定し、さらに互いに乗算することができます。残念ながら、彼女はワットを通過した時間の値を累積する方法を知りません* *したがって、彼女は常に調査を行う必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デジタル部分に移りましょう。システム全体の中心はSTM32F103RBマイクロコントローラーです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hm/ws/ma/hmwsma-hii28gwjrskmvmfsytl4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのクオーツの形のストラップは、インターネット上で見つかった他の回路から取られました（データシートで再確認されています）。 RAMから起動する必要はありませんが、信号BOOT1がグランドに引き下げられているためです。 BOOT0は、ジャンパーを使用してメインフラッシュメモリまたは組み込みのUARTブートローダー（デバイスのプライマリファームウェアなど）から起動するように選択できます</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。次はLEDです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ja/bg/ah/jabgahdeoppmxzipfiqu5mpd9dq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主電源電圧は2〜3.3Vであるため、LEDを接続しないでください。明るさと消費電流は大きく異なります。したがって、LEDは2.7Vバスに接続され、それに応じて電流制限抵抗が計算されます。マイクロコントローラーは、バッテリーで電力供給されている場合、そのレッグに2Vを超える電力を供給することができないため、GPIOプッシュプルモードは使用できません。オープンドレインのみ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リセットボタンについて特別なことはありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6x/eq/is/6xeqise0ghoatscub44uzcykfoq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3ボルトのデバイス（INA219）がI2Cバス上に配置されるため、3ボルトのブレースも作成する必要があり、</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xj/yi/n7/xjyin76yz6g_sg7vo9t2s4eqrms.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SWDコネクタも標準です。バッテリーとプログラマーからの外部電源との間で電力を切り替えるには、ダイオードが必要です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vl/s7/pw/vls7pw9grlfznf3gfo1_yglclqw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らがこれを行わないこと、およびそのような接続が実際にバッテリーを切断しないことの叫びを予測します。はい、オフにはなりませんが、ダイオードはこれに対応していません。バッテリーが接続されていない場合、プログラマーからデバイスに電力を供給できるようにするために、これが必要です。接続されている場合は、それから機能させます。まあ、バッテリーが接続されている場合は、プログラマー自体をバッテリーの4.2Vから保護する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ボタンについてさらに詳しく説明することは価値があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gg/du/gi/ggdugivqqx7iqjimaqwkbsiehru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際のところ、最初のボタンはボタンであるだけでなく、デバイススイッチとしても機能します。BTN1信号はPT1502電源コントローラチップに接続されています。デバイスの電源がオフになっていると、マイクロコントローラやその他の消費者には電力が供給されません。このため、ボタンは電源（VCC）ではなくバッテリー（BAT）に接続されています。このボタンを押すと、PT1502はすべての電源をオンにして、マイクロコントローラーを起動します。その後、ボタンは通常のボタンのように機能します。マイクロコントローラーを高電圧バッテリーで燃やさないようにするために、BTN1信号を必要なフレームに駆動する小さな分圧器を作成しました（ただし、これがなくても可能です。マイクロコントローラーには5Vに耐える入力があります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のボタンは目立たないです。プロセッサー内部では、地面への引き寄せがオンになり、ボタンがユニットをラインに送ります... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スムーズに重い周辺に切り替えます。 USB USB </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hj/vn/tg/hjvntgq_-3sjzwjv03t0dqd--gg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コネクタはデバイスから突き出ており、静電気がそこを歩くことがあります。マイクロコントローラを外部の影響から保護する特別なマイクロ回路（STF202-22など）があることがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、他に興味深い点があります。 1.5k抵抗は、VBUSフットとD +ラインの間に接続されているSTF202チップの内部に隠されています。この抵抗はUSB仕様に従って必要です-それは何かに引っかかっていることをホストに伝えます。多くの回路では、この抵抗は常に電源とD +ラインの間に接続されています。ホストがD +ラインでこのような抵抗を検出するとすぐに、ホストはすぐにデバイスとの通信を開始します。これは必ずしも適切ではありません。デバイスによっては、すぐに通信できる状態にならない場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは私のケースです。これには簡単なトリックがあります（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで説明しています）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）トランジスタを使用してこの抵抗をオン/オフにすることができます。通信が必要です-抵抗をオンにし、USBから電力を供給したいだけです-オフにします。携帯電話をUSBに差し込むと、通常、「私たちは何をしますか？」データをマージするのか、それとも単に課金するのか？」 -エレクトロニクスに関して言えば、これはプルアップ抵抗を接続することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、デバイスがUSBで動かなくなっているかどうかはどうやってわかりますか？これを行うために、最も単純な分周器から削除されたUSB_PLUGGED信号を提供しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hx/lr/u5/hxlru5qf7wv13uxeseybbyhhpdi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USBからの5Vを直接マイクロコントローラーのフットに供給することもできます-それらはまだ5Vに耐えます。しかし、それはすでに仕切りを通っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今加速度計</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-g/t1/5j/-gt15jf_cub3nubnrpsbr5hiusa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキームはデータシートから取得されます。モジュールはI2Cを介して接続されますが、ニュースがあることをマイクロコントローラーに通知するために、割り込みラインも使用されます。また、3ボルトのINA219はまだ同じI2Cバスに掛かっているので、加速度計の通信レッグにもレベルを調整するために3Bバスから電力が供給されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エネルギーを節約し、未使用のアプライアンスをオフにしたいことはすでに述べました。したがって、加速度計の電源はトランジスタによってオンになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、いわゆるデジタルトランジスタ-2つの抵抗を備えたトランジスタ。これにより、ボード上のスペースが少し節約されます。 2ボルトの電源では、少なくともある程度の電流（最大20〜30 mA）のデジタルトランジスタをピックアップできなかったのは残念です。したがって、より貪欲な消費者はMOSFETに接続する必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GPS </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vr/l-/hm/vrl-hm0a27os6lit3ont256xd1g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GPSは別のボード上にあり、ループバック経由で接続します。 GPSモジュールはまだ決めていないので、2種類の電源を用意しました。プロセッサボードの側面にあるパワートランジスタに加えて、これ以上興味深いものはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UARTについて簡単に説明します。最初は、3つすべてを使用する予定でした。1つはファームウェアのアップロードとデバッグ用、2つ目はGPS用、3つ目はBluetooth用です。しかし、UART3はI2C No. 2と同じピン上にあることが判明しました。私が選ばなければなりませんでした。その結果、ファームウェアをアップロードし、GPS用に予約されている同じUARTを介してデバッグできるという結論に達しました（もちろん、GPSを無効にする必要があります）。まあ、GPS自体、つまりUSB CDC（ログをアップロードできる）とSWDをデビューする必要がある場合は。少し後、私はI2C No. 2の使用をやめたため、UART3は解放されましたが、バッテリーを節約するという名目で、2つのUARTに焦点を合わせることにしました。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブルートゥース</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/m6/zt/r2m6ztztpabt1_2yprjrdava5nq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bluetoothは、データシートのスキームに従って接続されています。ピンPIO1は2つのモードで動作できます。最初の例では、LEDが接続されており、モジュールはこのLEDで点滅します。ウィンクが異なると、ステータスも異なります。別のモードでは、このピンはデジタルとして機能します—通信が確立されたときに1つ、確立されていないときに0。モジュールの初期化中に、ATコマンドによってモードが切り替えられます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDカード</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDカードの接続方式は、標準ではありますが、何らかの理由で私にとって非常に困難でした。インターネットにはさまざまな接続オプションがあり、どちらが適切かを判断するのは簡単ではありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9g/mi/xh/9gmixhnhcfhlo0s98wcmfz1dubk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどの場合、私はブッシュについて質問しました。ときどき、抵抗を1kにするスキームがあります。一部の回路は、どうやら静電気に対する保護として、22オームの抵抗を配置しています。それにもかかわらず、回路の大部分はパススルー抵抗を備えていないので、おそらく同じように進みます。以来、静力学はありませんフラッシュドライブはケースの中に住んでいます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私にはパワートランジスタも需要がないようですが、カードは常に機能すると思います。それはロガーです。しかし、これはテストボードなので、実際にテストしてみましょう。コイルについても同じことが言えます-明らかにオリジナルに含まれているのは偏執狂的でしたか、またはカードは電力や干渉が少ない環境で使用されました。そこにゼロ抵抗をはんだ付けし、コイルなしで試してみると思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
表示</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディスプレイモジュールの1つをSPI経由でAliに接続し、I2C経由の接続と比較する機会がありました。特に問題はなく、コードを少し無駄にするだけで済みました。この場合、SPIの速度はI2Cの速度より1桁高くなります。消費に関するデータシートのデータ（SPIの4 mA対I2Cの10 mA）を追加し、I2Cのプルアップ抵抗が必要になったため、SPIを介してディスプレイを接続することにしました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zn/zx/yh/znzxyhs4tcmv4fyyhb-hfxzihns.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、BS0信号はディスプレイループに出力されないため、3線式SPIモードを選択できません。4線式SPIしか選択できません。追加のD / Cライン（データ/コマンド）の違い。3線式モードの場合、SPIデータの9番目のビットによって送信されます。ただし、4線式モードの方が適している場合があります。 STM32のSPIは8ビットのみを送信できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキームの残りの部分はデータシートに対応しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に、きしむ者。</font><font style="vertical-align: inherit;">特別なことは何もありません-トランジスタを通してオンにします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b9/nk/9u/b9nk9uzbod6oeswokssk4nhfvsq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ツイーターの代わりに振動モーターがある場合、私は保護ダイオードを用意しました。</font><font style="vertical-align: inherit;">しかし、保護ダイオードもツイーターを傷つけないという意見を聞きました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">鉄で</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記では、軍団についての私の考えを述べた。実際、私はこのケースのためにボードを育てようとさえしました。残念ながら、ボードは窮屈すぎました。双方向インストールを使用して、コンポーネント1206から0805に切り替える必要がありましたが、それでもボード上のコンポーネントは非常に密に配置されていました。さらに、スキームの変更はすべて苦痛でした。ボードのほぼ半分を再繁殖しなければなりませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで私は彼女と数週間いじったが、理事会は私を打ち負かし、私はほぼ1年間プロジェクトを断念した。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらの記事が</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キックになり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。しかし、実際には、これはプロトタイプにすぎず、いくつかのうちの最初のものです。大きなボードですべてをデバッグできるのに、はんだごてやオシロスコープでクロールできない超コンパクトなボードに悩むのはなぜですか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、iPhoneのような大きなボードを作る必要はありませんが、JLCPCBの100x100mm 2レイヤーのプロモーションに参加することは十分に可能です。</font><font style="vertical-align: inherit;">あなたは実質的に自分を制限することができます。</font><font style="vertical-align: inherit;">そのため、ボード上には巨大な2.42インチディスプレイ、すべての電力線、必要な場所と不要な場所の電力用コンデンサ、一般的には設置できなかった多くの部品の消費量を測定するジャンパーがありました。</font><font style="vertical-align: inherit;">まだ場所が残っています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nm/ig/vr/nmigvrrichuyvfy4vddfogpnquu.png"><br>
<br>
<img src="https://habrastorage.org/webt/sr/cy/ed/srcyeditmbixylghywsn15j-qas.png"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">写真ビューにあります</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/d-/co/ru/d-coru_uwsrkpvz44tirfmisedg.png"><br>
<br>
<img src="https://habrastorage.org/webt/5w/pq/xk/5wpqxktdsgqt1auvgeh4wnhbaz4.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
配線について言うことは何もありません。私は信号線と電力線のほとんどを上層に沿って分けましたが、下層はほとんど完全に地下に埋められていました。残念ながら、レイアウトはまだかなり密集しており、一部の信号線は下層に沿ってボードの半分までドラッグする必要がありました。このため、土地は緩く接続されたいくつかの島に「引き裂かれ」ます。これが問題にならないことを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブルートゥースアンテナの下で地球を動かすことはしませんでしたが、それでも信号ゾーンの1つをこのゾーンにドラッグする必要がありました。ただし、これはBT_ONラインであり、これに沿って信号が実行されないことがよくあります（そこでオンまたはオフになります）。これは、特に信号に影響を与えないことを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
夏が近づいてきて、休暇中に家賃を持ち歩くつもりでした。ホテルのメイドがワイヤーのファンを備えた裸のデバッグボードを恐れないように、ケースに隠しておくとよいでしょう。私は喜びを否定することができず、同時にケースとボードを開発しました。だからケースには取り付け板があり、ディスプレイホルダーを取り付けていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GPSモジュールは、いくつかのボードのサンドイッチと12 mm厚のアンテナです。ボードの上に引っ掛けるのではなく、同じレベルに置くことにしました。これによりケースの厚さが減少しましたが、ボードの1つの角が食い込んでいます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボードと最終（プロジェクトのこの段階における）デバイスの写真。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/yk/-g/sryk-gs6dpsw3cjk4mx7fhj4khw.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/i7/hm/im/i7hmimruqywcfpkw9q5qudxkyog.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/r_/wo/bj/r_wobjeewfmg8fohrp_nmehi1c4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッテリーはディスプレイの下にうまく配置されましたが、ディスプレイを上部カバーに近づけるために小さな箱を作る必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アセンブリボード上のいくつかの単語。私はすべてを約3晩ではんだ付けしました。夜の約1週間は、ソフトウェア側からデバッグとチェックを行うのにゆっくりとかかりました。驚いたことに、ボードの設定に基本的な問題はなく、ほとんどすべてが正常に起動しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0805のはんだ付けは1206よりもはんだ付けすることはそれほど難しいことではないことが判明しました、それは虫眼鏡で家庭でかなり食べられます。 0603でスイングすることもできます。しかし、マイクロコントローラとディスプレイコネクタ（0.5 mmピッチ）をはんだ付けするため、いじくり回す必要がありました。人々のYouTubeでは、どういうわけか、はんだごてを使っただけでしたが、私の結論はすべてすぐに行き詰まりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小さな問題がないわけではありません。一部の場所では飲酒がなく、どこかに「鼻水」がありました。 USBコネクタのフットプリントは間違っていることが判明しました-彼は結論が必要なものより少なかったという結論に達しました（そのため、インターネットからのフットプリントを信頼してください！）。結論を少し曲げて、軌道に乗らなければなりませんでした。</font><font style="vertical-align: inherit;">Aliで購入した</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスプレイ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">コネクタ</font></a><font style="vertical-align: inherit;">は、下部にコンタクトが付いていることがわかりましたが、上部にコンタクトが必要でした（これまでこのような違いを疑ったことはありませんでした）。標準のディスプレイボードからコネクタを「吹き飛ばす」必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ケースにボードを詰め込んだ後、コネクタを引き抜くだけではバッテリーを切り離すことができないことがわかりましたが、デバッグしたボードを電圧下に置いたままにしたくありませんでした。スイッチを突く必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボードをセットアップするとき、オシロスコープのプローブを接続できる場所にはアース接続がないことがわかりました。ワニでUSBコネクタにしがみついていました。ボードの次のバージョンでテストサイトを提供する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回路も問題を明らかにした。したがって、RESETピンのPT1502チップが3Vの電圧を生成することは、まったく予期せぬ事実でした（オープンコレクターのようなものが存在することを私は完全に確信していました）。その結果、私はそこに2Vのみを配置する予定であったにもかかわらず、これらの3Vが電源ラインにリークしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは何が起こったかの簡略図です。</font></font><br>
<img src="https://habrastorage.org/webt/ag/rw/tg/agrwtgjika-hvgzl_die2gokf4c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
偉大な心とeasyelectronics.ruの人たちのおかげで、このジョイントは1つのダイオードを追加することによって決定されました。少し手術をしたところ、この部分は正常に機能しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、固定の3Vではなく、誤って主電源（2V）に接続したBluetoothモジュール（2.5Vで駆動）。これでBluetoothは、主電源の電圧が3.3Vに上昇したときにUSBが接続されている場合にのみ機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原則として、メスを振ってBluetoothを正しい電力にはんだ付けすることはできますが、Bluetoothが接続されているUART2は5Vに対応していません（彼自身が分析段階でデータシートでそれを読み、彼自身が上記のテキストでこれを指摘し、最終的にボードを配線するときに忘れました）したがって、Bluetoothの電源への接続は、マイクロコントローラーの電源よりも高いです...ボードの次のバージョンでは、Bluetoothを他のUARTに接続するだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可変電圧のDC-DCコンバーターも計画どおりに機能しました-バッテリーで電力を供給すると2Vが出力され、USBを接続すると3.16Vに上昇します（定格で遊んで3.3Vに達する必要があります）。しかし、ここで回路のもう1つの欠陥が発生しました。プログラマーから電力が供給されているときに、電圧を上げることができる必要もあります。これは別のダイオードを追加することで処理されていると思います。少し後で遊んでみます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、ボードでの作業中、SDカードに低電圧から適切に電力を供給する方法がまだわかりませんでした。短いグーグルは何にもつながりませんでした。どうやら、タイトなページの仕様（さらに、部分的に閉じられている）を読むことに没頭する必要があります。その間、私はR7を短絡させ、ボードは固定された3.16V（3.3V）から電力を供給されます。私はソフトウェアの部分に取り組んでいる間、私はそれを次の数ヶ月間このようにしておくでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソフトウェアと言えば。意外にも（かなり期待されていますが）、一般的にすべてが問題なく起動しました。同じシリーズのマイクロコントローラー（F103CBからF103RC）を切り替えたので、ソフトウェア部分を変更する必要はありませんでした。ピン番号のみを修正しましたが、トランジスタの追加を追加しました。それにもかかわらず、私がいじくる必要があった2つの重要な瞬間がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初はバッテリー電源です。 USB電源を使用してボードをデバッグしましたが、すべて正常に動作しました。しかし、ボードはしつこくバッテリーを入れたくありませんでした。それら。 （USBが接続されているときにオンにしてからコードを抜くと）機能しますが、低温のものからは機能しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PT1502チップの設計によれば、ボードはこのように始まるはずです。ユーザーがBTN1ボタンを押すと、3分の1秒後にチップがすべての電源をオンにします。電力がすべて問題ない場合、PT1502はRESET信号を「解放」し、それによってマイクロコントローラーを起動します。次に、プロセッサは信号PWR_HOLDを1に設定し、開始したことを通知します。次に、PT1502は、マイクロコントローラーが信号PWR_HOLDをゼロに下げるまで定期的に回路に電力を供給します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは理論上です。実際、プロセッサがPWR_HOLD信号を設定するとすぐに、ボードは即座にオフになりました。電源回路全体をシャベルで覆い、主信号の波形を見て、ブートローダーのコードを前後に入れ替えましたが、問題を理解できませんでした。インストールするのを忘れたPWR_HOLDラインにプルダウン抵抗がないことにも罪を犯しましたが、データシートでは推奨されています（おそらくまだ必要です）。しかし、天蓋付きで追加しても問題は解決しませんでした。そして、私が4チャネルのオシロスコープを貸したときだけ、すべてがはっきりしました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/ie/xf/ixiexf-lau1vggfbwu9ta4ys_hq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーがボタン（オレンジ色の線）を押すと、PT1502チップが電源（紫の線）をオンにします。これはすべて、この波形のイベントのかなり前（300ms）に発生します。そして興味深いことが起こります。 PT1502がRESET（青色の線）を解放すると、プロセッサが起動し、何らかの理由でボタンの線をゼロに下げます。マイクロコントローラーがまだPOWER_HOLDライン（緑のライン）を上げようとしていますが、手遅れですが、PT1502はすでにすべての電源をオフにしています。その後、さらにいくつかのけいれんが発生しますが、回路はまだ静かに停止します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は、ボタンのゼロはどこから来たのですか？全体のポイントは</font><font style="vertical-align: inherit;">、BTN1レッグが出力モードに設定されていたために</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブートローダー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">目立たない間違いであり</font></a><font style="vertical-align: inherit;">（おそらく、その瞬間に奇跡が他のレッグでも発生した）、そこに低い信号が表示されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他に私が取り組む必要があったのはSDカードでした。古いマイクロコントローラーには単にSDIOモジュールがなかったので、私はこの部分をゼロから研究しなければなりませんでした。私はほぼ一日中マップを取得しようと試み、インターネット上の例からコードの一部をコピーし、CubeMXが生成したものを使用しました。カードはコンピュータ上で完全に読み取り可能でしたが、私の回路で永続的に開始したくありませんでした。私ははんだ付け不良、誤って選択されたプルアップ抵抗、不器用な回路、誤って解釈されたデータシートについて罪を犯しました。しかし、驚いたことに、同じコードと同じボード上の別のカードが問題なく起動しました。この問題をより詳細に検討する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カードに別の問題がありました。オシロスコープで別のラインを突っ込んでみたところ、D0ラインでのみアクティビティが見られましたが、D1-D3では沈黙があり、カードはシングルビットモードで動作しました。 HALでは、4ビット転送モードを有効にできるHAL_SD_ConfigWideBusOperation（）関数も見つかりました。残念ながら、カードが4ビットモードに切り替えられたとき、SDIOペリフェラルは深いRX FIFOオーバーランに入り、動作を停止しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は非常に興味深いことがわかりました。</font><font style="vertical-align: inherit;">HAL_SD_ReadBlocks（）関数の内部には、SDIOフラグをポーリングする特定のループがあることがわかりました。</font><font style="vertical-align: inherit;">カードから新しいデータが到着すると、このコードは内部FIFOバッファーからユーザーメモリにバイトを転送します。</font><font style="vertical-align: inherit;">したがって、カードはバイトを非常に高速に送信したため、HAL_SD_ReadBlocks（）のコードにはデータを転送する時間がありませんでした。</font><font style="vertical-align: inherit;">カードのクロック周波数を一時的に下げる必要がありました。</font><font style="vertical-align: inherit;">まあ、将来的にはDMAを使用するので、そのような問題は原則的に発生しないはずです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論と次のステップ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場所で完成したデバイスが見られると期待していた人は私をがっかりさせる必要があります。テストボードだけが完成し、それでも鉄片だけが完成します。今、あなたはそれに命を吹き込み、プログラミングを行い、モードと消費を微調整する必要があります。まあ、実際にロギングコードを書いてください。それが、プロジェクト全体が開始された理由です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それにもかかわらず、私にとって個人的にこの段階は非常に大きく重要な成果です。エレクトロニクスは私の専門ではなく、デバイスが起動したことさえ非常に嬉しく思います。回路の設計、複数のデバイスのマッチング、ボードの配線、コンポーネントの選択など、さまざまな方法で十分にポンプを使用できました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソフトウェアの部分についてはまた別の機会に話します。</font><font style="vertical-align: inherit;">同様に設定のニュアンスについて。</font><font style="vertical-align: inherit;">実際には、この充填全体を最初に復活させてテストする必要があります。</font><font style="vertical-align: inherit;">現時点では、ボード上のすべてのデバイスを起動することができました（トゥイーターを除く）。ただし、「起動して、なんとかして応答する」量でのみです。</font><font style="vertical-align: inherit;">処理ロジックはまだ書かれていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
近い将来の計画：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまなモードで電子機器を駆動し、回路が引き続き機能することを確認します。</font><font style="vertical-align: inherit;">ボードの2番目のバージョンの側枠を修正</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">周辺全体の消費量を測定し、消費量を最適化する方法を見つけます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまなマイクロコントローラー（L152またはL433など）でいくつかのボードオプションを組み立てる</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SD仕様をよく読んで、カードを低電圧信号モード（1.8V）で正しく接続する方法を理解してください。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のGPSモジュールを試して、最後にどのモジュールを使用するかを決定します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のコンパスチップ（たとえば、HMC5883LまたはHSCDTD008A）を注文して、どういうわけかそれらを使用してみます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部コードのリファクタリングを行い、すべての主要なライブラリをHALからアップグレードします</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後に、機能の作成を開始します。</font><font style="vertical-align: inherit;">デバイスが意図したものを実際に実装する</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これについて、休暇を取らせてください。</font><font style="vertical-align: inherit;">回路設計とPCBレイアウトに関する建設的なコメント、アイデア、アドバイスに感謝します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソース：</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブートローダーコード</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plata </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハウジング</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454424/index.html">Androidアーキテクチャコンポーネントを使用する際の5つの一般的な間違い</a></li>
<li><a href="../ja454426/index.html">人工：人工知能の黎明期</a></li>
<li><a href="../ja454428/index.html">AppleがWWDCで導入したものとiOS開発者がそれについてどう思うか</a></li>
<li><a href="../ja454430/index.html">3Dパーティクルライフ</a></li>
<li><a href="../ja454432/index.html">面白い考古学：虫眼鏡の下のRスタイルガイド</a></li>
<li><a href="../ja454436/index.html">ペティペティジョイ＃1：ログル</a></li>
<li><a href="../ja454438/index.html">一輪車の乗り方を学ぶには？</a></li>
<li><a href="../ja454440/index.html">ペティリトルファン＃2：スターレット</a></li>
<li><a href="../ja454442/index.html">ビジネス用のプロキシネットワークを選択する方法：3つの実用的なヒント</a></li>
<li><a href="../ja454444/index.html">Habrの読み込み、またはページの189リクエストがどのように影響を与えるかをプロファイルします</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>