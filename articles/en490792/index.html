<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèæ üåö üë©üèª‚Äçüé® VXLAN in NSX-V - Troubled Underlay üë∏üèø üòÆ ‚úãüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, and first a little lyrics. I sometimes envy colleagues working remotely - it‚Äôs great to be able to work from anywhere in the world connecte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>VXLAN in NSX-V - Troubled Underlay</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490792/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Greetings, and first a little lyrics. I sometimes envy colleagues working remotely - it‚Äôs great to be able to work from anywhere in the world connected to the Internet, holidays at any time, responsibility for projects and deadlines, and not being in the office from 8 to 17. My position and work responsibilities practically exclude the possibility of a long absence in the data center. However - interesting cases like the one described below occasionally happen, and I understand that there are few positions where there is such scope for creative expression of an internal troubleshooter.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A small disclaimer - at the time of writing, the case has not been completely resolved, but given the speed of the vendors' response, a complete solution may take another months, and I want to share my findings right now. I hope, dear readers, you will forgive me this haste. But enough water - what about the case?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First introductory: there is a company (where I work as a network engineer) that hosts client solutions in VMWare's private cloud. Most of the new solutions connect to the VXLAN segments that are controlled by NSX-V - I will not evaluate how much time this solution gave me, in short - a lot. I even managed to train my colleagues to configure NSX ESG and small client solutions are deployed without my participation. An important note is the control plane with unicast replication. Hypervisors are redundantly connected by two interfaces to different physical Juniper QFX5100 switches (assembled in Virtual Chassis) and the timing policy route based on originating virtual port is for completeness.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Client solutions are very heterogeneous: from Windows IIS, where all web server components are installed on one machine to quite large ones - for example, load-balanced Apache web fronts + LB MariaDB in Galera + server-balloons synchronized using GlusterFS. Almost every server needs to be monitored separately, and not all components have public addresses - if you have encountered this problem and have a more elegant solution, I will be glad to advise. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My monitoring solution consists in ‚Äúconnecting‚Äù the firewall (Fortigate) to each internal client network (+ SNAT and, of course, strict restrictions on the type of allowed traffic) and monitoring the internal addresses - in this way a certain unification and simplification of monitoring is achieved. Monitoring itself comes from a cluster of PRTG servers. The monitoring scheme is something like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_m/tf/gb/_mtfgbp-yj4608pxce0zj9ktzrw.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
While we operated only with VLAN, everything was quite usual and predictably worked like a clock. After the implementation, NSX-V and VXLAN faced the question - is it possible to continue monitoring in the old way? At the time of this question, the fastest solution was to deploy the NSX ESG and connect the VXLAN trunk interface to the VTEP network. Quick in quotes - since using the GUI to configure client networks, SNAT and firewall rules can and unifies management in a single vSphere interface, but in my opinion it is rather cumbersome and, among other things, limits the set of tools for troubleshooting. Those who used the NSX ESG as a substitute for a ‚Äúreal‚Äù firewall, I think, would agree. Although, probably, such a solution would be more stable - after all, everything happens within the framework of one vendor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another solution is to use the NSX DLR in bridge mode between VLAN and VXLAN. Here, I think everything is clear - the benefit of using VXLAN is corny - because in this case, you still have to pull the VLAN to the monitoring installation. By the way, in the process of working out this solution, I ran into a problem when the DLR bridge did not send packets to the virtual machine with which it was on the same host. I know, I know - in books and guides on NSX-V it is explicitly stated that a separate cluster should be allocated for NSX Edge, but this is in the books ... Anyway, after a couple of months with support we did not solve the problem. In principle, I understood the logic of the action - the hypervisor core module responsible for VXLAN encapsulation was not activated if DLR and the monitored server were on the same host, since the traffic does not leave the host and, logically, it should be connected to the VXLAN segment - encapsulation is not needed.With support, we settled on the virtual interface vdrPort, which logically combines uplinks and it also performs bridging / encapsulation - there it was noticed a mismatch in the incoming traffic, which I took to work out in the current case. But as it was said, I did not finish this case to the end, as it was transferred to another project and the branch was initially dead-end and there was no particular desire to develop it. If I am not mistaken, the problem was observed in versions NSX and 6.1.4 and 6.2.since it was transferred to another project and the branch was initially dead-end and there was no particular desire to develop it. If I am not mistaken, the problem was observed in versions NSX and 6.1.4 and 6.2.since it was transferred to another project and the branch was initially dead-end and there was no particular desire to develop it. If I am not mistaken, the problem was observed in versions NSX and 6.1.4 and 6.2.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here - bingo! Fortinet annonsiruet native </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support VXLAN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . And not just point-to-point or VXLAN-over-IPSec, not software-based VLAN-VXLAN bridging - they started to implement all this since version 5.4 (and presented by other </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vendors</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but real support for unicast control plane. When implementing the solution, I ran into another problem - the checked servers periodically ‚Äúdisappeared‚Äù and sometimes appeared in monitoring, although the virtual machine itself was still alive. The reason it turned out was that I forgot to enable Ping on the VXLAN interface. In the process of rebalancing the clusters, the virtual machines moved, and vMotion ended with Ping to indicate the new ESXI host to which the machine moved. My stupidity, but this problem once again undermined the credibility of the support was produced - in this case Fortinet. I‚Äôm not saying that every case related to VXLAN starts with the question ‚Äúwhere is the VLAN-VXLAN softswitch in your settings?‚Äù This time I was advised to change the MTU - this is for Ping, which is 32 bytes. Then "play around" with tcp-send-mss and tcp-receive-mss in the policy - for VXLAN,which is encapsulated in UDP. Fuf, I'm sorry - it‚Äôs boiling. In general, I solved this problem on my own.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having successfully rolled back the test traffic, it was decided to implement this solution. </font><font style="vertical-align: inherit;">And in the production it turned out that after a day or two, everything that is monitored via VXLAN gradually falls off altogether. </font><font style="vertical-align: inherit;">Deactivating / activating the interface helped, but only temporarily. </font><font style="vertical-align: inherit;">Mindful of the slow-moving support, I went into Troubleshoot for my part - in the end, my company, my network is my responsibility. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Under the spoiler is the course of troubleshooting. </font><font style="vertical-align: inherit;">Who is tired of letters and bragging - skip and go to the postanalysis.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trouble Shooting</font></font></b><div class="spoiler_text">,    ‚Äî !<br>
<br>
,    ,    .        . ,           Fortigate  5.6+,    ¬´diagnose debug flow¬ª ‚Äî              .     . ,  ,      RFC1918,        .   VXLAN   ...15,   ...254,       VTEP.<br>
<br>
   VXLAN-        .  overlay  ARP  OVSDB,  underlay  ARP  CAM.   Fortigate VXLAN FDB   OVSDB.   :<br>
<br>
<pre><code class="plaintext hljs"> fortigate (root) #diag sys vxlan fdb list vxlan-LS<font></font>
mac=00:50:56:8f:3f:5a state=0x0002 flags=0x00 remote_ip=...47 port=4789 vni=5008 ifindex=7<font></font>
</code></pre><br>
    ‚Äî MAC      VTEP   ...47.     ESXI ,  ,  MAC  ,  VTEP .  CAM/ARP    ‚Äî      ESXI :<br>
<br>
<pre><code class="plaintext hljs">fortigate (root) #get sys arp | grep ...47<font></font>
...47 0 00:50:56:65:f6:2c dmz<font></font>
</code></pre><br>
     ‚Äî     ?        Juniper' ‚Äî          ,      ‚Äî   VLAN  VTEP     .     DLR-, VDR    ‚Äî    ESXI ,      VMWare.  MAC ¬´97:6e¬ª  , vmnic1 ‚Äî  ,   VTEP   ...47     "--dir 2":<br>
<br>
<pre><code class="plaintext hljs">pktcap-uw --uplink vmnic1 --vni 5008  --mac 90:6c:ac:a9:97:6e --dir 2 -o /tmp/monitor.pcap
</code></pre><br>
<img src="https://habrastorage.org/webt/cb/km/gq/cbkmgqv0xd3fidrang8xwmhzzwi.png" alt="image"><br>
<br>
 ‚Äî    ARP    .   ARP     .   ,         ...15 ‚Äî   ICMP ? ,     .     ,         ( teaming policy),        vNIC       ,      ,     :<br>
<br>
<pre><code class="plaintext hljs">pktcap-uw --uplink vmnic4 --vni 5008  --mac 90:6c:ac:a9:97:6e --dir 2 -o /tmp/monitor.pcap
</code></pre><br>
<img src="https://habrastorage.org/webt/yi/w2/ei/yiw2eiaz43lr7-zfnybmxbsk4rk.png" alt="image"><br>
<br>
   ,   .      .   ‚Äî   ‚Äî         VDR,        .    ,      ,      ,   .   ¬´¬ª     Ethernet  underlay. -    MAC  VTEP     IP.   , ,  ‚Äî ,   .  ARP  ,    .     Ethernet    :<br>
<br>
<pre><code class="plaintext hljs">fortigate (root) #get sys arp | grep ...47<font></font>
...47 0 00:50:56:65:f6:2c dmz<font></font>
fortigate (root) #get sys arp | grep ...42<font></font>
...42 0 00:50:56:6a:78:86 dmz<font></font>
</code></pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, what do we have in the end - after the migration of the virtual machine, the fortigate tries to send traffic to VTEP from the (correct) VXLAN FDB, but it uses the wrong MAC DST and the traffic is expected to be discarded by the receiving hypervisor interface. Moreover, in one case out of four, this MAC belonged to the original hypervisor, from which the migration of the machine began. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yesterday I received a letter from Fortinet tech support - they opened a bug 615586 on my case. I don‚Äôt know how to rejoice or grieve: on the one hand, the problem is not in the settings, on the other, the fix will only come with an update of the firmware, the following, at best. The FAQ also heats up another bug that I discovered last month, though at that time in the HTML5 GUI vSphere. Well, the local QA department of the vendors is direct ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll venture to suggest the following:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 - multicast control plane most likely will not be subject to the described problem - after all, the VTEP MAC addresses are obtained from the IP address of the group to which the interface is subscribed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 - most likely the problem of fortics in offload sessions on Network Processor (approximately analogous to CEF) - if each packet is passed through the CPU, tables containing the correct information ‚Äî at least visually ‚Äî will be used. In favor of this assumption is what helps to close / open the interface or wait a while - more than 5 minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 - changing the teaming policy, for example, to explicit failover, or introducing the LAG will not solve the problem, since the MAC stuck on the original hypervisor in encapsulated packets was observed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In light of this, I can share what I recently discovered a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where in one of the articles it was stated that stetfull firewalls and cached methods of data transfer are crutches. </font><font style="vertical-align: inherit;">Well, I‚Äôm not so experienced in IT to say that, and I don‚Äôt agree with all the statements in the blog articles. </font><font style="vertical-align: inherit;">However, something tells me that there is some truth in Ivan's words. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for attention! </font><font style="vertical-align: inherit;">I will be glad to answer questions and hear constructive criticism.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490782/index.html">AnalogBytes Conference: Roskomnadzor, media, highload and all-all-all</a></li>
<li><a href="../en490784/index.html">I am an Android developer and I didn‚Äôt like to do manual work.</a></li>
<li><a href="../en490786/index.html">Second order leak analysis: when it leaks from those who steal data from a bank</a></li>
<li><a href="../en490788/index.html">Useless REPL. Yandex Report</a></li>
<li><a href="../en490790/index.html">Zip Files: History, Explanation, and Implementation</a></li>
<li><a href="../en490796/index.html">How to automate the security of containers in the style of Policy as Code using CRD</a></li>
<li><a href="../en490804/index.html">How a hacker's mom got into prison and infected the boss‚Äôs computer</a></li>
<li><a href="../en490808/index.html">Mathematics in astronautics: rotational detonation engine</a></li>
<li><a href="../en490812/index.html">Spring Professional Certification 5 Submission Experience</a></li>
<li><a href="../en490816/index.html">How do E-commerce sites resist the AuthBots botnets?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>