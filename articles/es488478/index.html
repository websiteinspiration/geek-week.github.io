<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úãüèΩ üë®üèæ‚Äçü§ù‚Äçüë®üèª üé≠ Transfiera todas las bases de datos de MS SQL Server a otra m√°quina üëáüèª üèÇüèº üçå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, era necesario transferir todas las bases de datos (> 50 en una instancia de SQL Server) desde el entorno de desarrollo a otra instancia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Transfiera todas las bases de datos de MS SQL Server a otra m√°quina</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488478/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recientemente, era necesario transferir todas las bases de datos (&gt; 50 en una instancia de SQL Server) desde el entorno de desarrollo a otra instancia de SQL Server, que se encontraba en un hardware diferente. </font><font style="vertical-align: inherit;">Quer√≠a minimizar el trabajo manual y hacer todo lo m√°s r√°pido posible.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descargo de responsabilidad</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los scripts se escriben para una situaci√≥n espec√≠fica: este es un entorno de desarrollo, todas las bases de datos en un modelo de recuperaci√≥n simple, archivos de datos y registros de transacciones est√°n en el mismo mont√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo lo escrito a continuaci√≥n se aplica solo a esta situaci√≥n, pero puede terminarlos f√°cilmente (sus condiciones) sin mucho esfuerzo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los scripts no usan el nuevo STRING_AGG y otras cosas buenas, por lo que todo deber√≠a funcionar comenzando con SQL Server 2008 (o 2008 R2, no recuerdo d√≥nde apareci√≥ la compresi√≥n de copia de seguridad). Para versiones anteriores, debe eliminar WITH COMPRESSION del comando de copia de seguridad, pero es posible que ya no existan diferencias de tiempo con la copia de archivos. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta no es una instrucci√≥n: "c√≥mo" hacer dicha transferencia. Esta es una demostraci√≥n de c√≥mo se pueden usar los metadatos en SQL din√°mico.</font></font></b><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, la forma m√°s r√°pida ser√≠a simplemente volver a conectar el estante del disco al nuevo servidor, pero esa no era nuestra opci√≥n. Separar - copiar - Se consider√≥ adjuntar, pero no encajaba, ya que el canal era bastante estrecho y la transferencia de la base de datos sin comprimir llevar√≠a un per√≠odo de tiempo bastante largo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, decidimos que har√≠amos una copia de seguridad con compresi√≥n en la bola en el nuevo servidor y luego la restablecer√≠amos all√≠. El hierro tanto en la ubicaci√≥n antigua como en la nueva no es malo, la copia de seguridad no es mala y la ganancia de tiempo tampoco es mala. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces se escribi√≥ el "generador de script":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span> @unc_backup_path <span class="hljs-keyword">AS</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) = <span class="hljs-string">'\\newServer\backup_share\'</span>
	, @local_backup_path <span class="hljs-keyword">AS</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) = <span class="hljs-string">'E:\Backup\'</span>
	, @new_data_path <span class="hljs-keyword">as</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) = <span class="hljs-string">'D:\SQLServer\data\'</span>;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span>	
	, <span class="hljs-string">'BACKUP DATABASE ['</span> + <span class="hljs-keyword">name</span> + <span class="hljs-string">'] TO DISK = '''</span> + @unc_backup_path + <span class="hljs-keyword">name</span> + <span class="hljs-string">'.bak'' WITH INIT, COPY_ONLY, STATS = 5;'</span> <span class="hljs-keyword">AS</span> backup_command<font></font>
	, <span class="hljs-string">'ALTER DATABASE ['</span> + <span class="hljs-keyword">name</span> + <span class="hljs-string">'] SET OFFLINE WITH ROLLBACK IMMEDIATE;'</span> <span class="hljs-keyword">AS</span> offline_command<font></font>
	, <span class="hljs-string">'RESTORE DATABASE ['</span> + <span class="hljs-keyword">name</span> + <span class="hljs-string">'] FROM DISK = '''</span> + @local_backup_path + <span class="hljs-keyword">name</span> + <span class="hljs-string">'.bak'' WITH '</span> <font></font>
		+ (<font></font>
			<span class="hljs-keyword">SELECT</span> <span class="hljs-string">'MOVE '''</span> + mf.name + <span class="hljs-string">''' TO '''</span> + <font></font>
				@new_data_path + <span class="hljs-keyword">REVERSE</span>(<span class="hljs-keyword">LEFT</span>(<span class="hljs-keyword">REVERSE</span>(mf.physical_name), <span class="hljs-keyword">CHARINDEX</span>(<span class="hljs-string">'\'</span>, <span class="hljs-keyword">REVERSE</span>(mf.physical_name))<span class="hljs-number">-1</span>)) +
				<span class="hljs-string">''', '</span>
			<span class="hljs-keyword">FROM</span> sys.master_files mf
			<span class="hljs-keyword">WHERE</span> mf.database_id = d.database_id
			<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">XML</span> <span class="hljs-keyword">PATH</span>(<span class="hljs-string">''</span>)<font></font>
		) + <span class="hljs-string">'REPLACE, RECOVERY, STATS = 5;'</span> <span class="hljs-keyword">AS</span> restore_command
<span class="hljs-keyword">FROM</span> sys.databases d
<span class="hljs-keyword">WHERE</span> database_id &gt; <span class="hljs-number">4</span> <span class="hljs-keyword">AND</span> state_desc = N<span class="hljs-string">'ONLINE'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la salida, obtenemos comandos listos para crear copias de seguridad en el lugar correcto, transfiriendo la base de datos fuera de l√≠nea, para que sus usuarios no puedan trabajar con ellos en el servidor antiguo y las secuencias de comandos para restaurar las copias de seguridad recibidas en el nuevo servidor (con transferencia autom√°tica de todos los archivos de datos y registros de transacciones a la ubicaci√≥n especificada ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema con esto es que alguien tiene que sentarse y ejecutar todos los scripts a su vez (recuperaci√≥n de copia de seguridad sin conexi√≥n), o alguien primero debe iniciar todas las copias de seguridad, luego desconectar todas las bases de datos, luego restaurar todo; hay menos acciones, pero necesita sentarse y rastrear.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quer√≠a automatizar todas estas operaciones. Por un lado, todo es simple: ya hay comandos listos para usar, ajustar el cursor y ejecutar. Y, en principio, hice exactamente eso, agregu√© un nuevo servidor como servidor vinculado en el anterior y lo inici√©. En el servidor local, el comando se ejecut√≥ a trav√©s de EXECUTE (@sql_text); en el servidor vinculado, EXECUTE (@sql_text) AT [LinkedServerName]. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, las operaciones se realizaron secuencialmente: copia de seguridad local, traducci√≥n de la base de datos local fuera de l√≠nea, restauraci√≥n al servidor vinculado. Todo comenz√≥, saludos, pero me pareci√≥ que puedes acelerar un poco el proceso si las copias de seguridad y las restauraciones se realizan de forma independiente.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, el cursor inventado se dividi√≥ en dos partes: en el antiguo servidor en el cursor, se realiza una copia de seguridad de cada base de datos y se transfiere sin conexi√≥n, despu√©s de lo cual el segundo servidor debe comprender que ha aparecido una nueva tarea y realizar una restauraci√≥n de la base de datos. </font><font style="vertical-align: inherit;">Para implementar este mecanismo, utilic√© un registro en una tabla en un servidor vinculado y un bucle infinito (era demasiado vago para encontrar criterios de detenci√≥n), que busca ver si hay nuevos registros y est√° tratando de restaurar algo, si lo hay.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el servidor anterior, se crea y completa una tabla temporal global ## CommandList, en la que se recopilan todos los comandos y ser√° posible rastrear el estado de las copias de seguridad en el mismo lugar. </font><font style="vertical-align: inherit;">La tabla es global para que en cualquier momento desde otra sesi√≥n pueda ver lo que est√° sucediendo all√≠ ahora.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span> @unc_backup_path <span class="hljs-keyword">AS</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) = <span class="hljs-string">'D:\SQLServer\backup\'</span> <span class="hljs-comment">--       </span>
	, @local_backup_path <span class="hljs-keyword">AS</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) = <span class="hljs-string">'D:\SQLServer\backup\'</span>	<span class="hljs-comment">--        </span>
	, @new_data_path <span class="hljs-keyword">as</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>) = <span class="hljs-string">'D:\SQLServer\data\'</span>;		<span class="hljs-comment">--      ,    </span><font></font>
<font></font>
<span class="hljs-keyword">SET</span> NOCOUNT <span class="hljs-keyword">ON</span>;<font></font>
<font></font>
IF OBJECT_ID ('tempdb..<span class="hljs-comment">##CommandList', 'U') IS NULL</span>
	<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">##CommandList (</span>
		dbName sysname <span class="hljs-keyword">unique</span>			<span class="hljs-comment">-- </span>
		, backup_command <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>)	<span class="hljs-comment">--   </span>
		, offline_command <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>)	<span class="hljs-comment">--        </span>
		, restore_command <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>)	<span class="hljs-comment">--       </span>
		, processed <span class="hljs-built_in">bit</span>				<span class="hljs-comment">-- : NULL -  , 0 -  , 1 - </span>
		, start_dt datetime			<span class="hljs-comment">--  </span>
		, finish_dt datetime			<span class="hljs-comment">--  </span>
		, error_msg <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>)		<span class="hljs-comment">--  ,  </span><font></font>
	);<font></font>
<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-comment">##CommandList (dbname, backup_command, offline_command, restore_command)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span>	
	, <span class="hljs-string">'BACKUP DATABASE ['</span> + <span class="hljs-keyword">name</span> + <span class="hljs-string">'] TO DISK = '''</span> + @unc_backup_path + <span class="hljs-keyword">name</span> + <span class="hljs-string">'.bak'' WITH INIT, COPY_ONLY, STATS = 5;'</span> <span class="hljs-keyword">AS</span> backup_command <span class="hljs-comment">-- INIT -      </span>
	, <span class="hljs-string">'ALTER DATABASE ['</span> + <span class="hljs-keyword">name</span> + <span class="hljs-string">'] SET OFFLINE WITH ROLLBACK IMMEDIATE;'</span> <span class="hljs-keyword">AS</span> offline_command<font></font>
	, <span class="hljs-string">'RESTORE DATABASE ['</span> + <span class="hljs-keyword">name</span> + <span class="hljs-string">'] FROM DISK = '''</span> + @local_backup_path + <span class="hljs-keyword">name</span> + <span class="hljs-string">'.bak'' WITH '</span> <font></font>
		+ (<font></font>
			<span class="hljs-keyword">SELECT</span> <span class="hljs-string">'MOVE '''</span> + mf.name + <span class="hljs-string">''' TO '''</span> + <font></font>
				@new_data_path + <span class="hljs-keyword">REVERSE</span>(<span class="hljs-keyword">LEFT</span>(<span class="hljs-keyword">REVERSE</span>(mf.physical_name), <span class="hljs-keyword">CHARINDEX</span>(<span class="hljs-string">'\'</span>, <span class="hljs-keyword">REVERSE</span>(mf.physical_name))<span class="hljs-number">-1</span>)) +
				<span class="hljs-string">''', '</span>	
			<span class="hljs-keyword">FROM</span> sys.master_files mf
			<span class="hljs-keyword">WHERE</span> mf.database_id = d.database_id
			<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">XML</span> <span class="hljs-keyword">PATH</span>(<span class="hljs-string">''</span>)<font></font>
		) + <span class="hljs-string">'REPLACE, RECOVERY, STATS = 5;'</span> <span class="hljs-keyword">AS</span> restore_command	
<span class="hljs-keyword">FROM</span> sys.databases d
<span class="hljs-keyword">WHERE</span> database_id &gt; <span class="hljs-number">4</span> 
	<span class="hljs-keyword">AND</span> state_desc = N<span class="hljs-string">'ONLINE'</span>
	<span class="hljs-keyword">AND</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> dbname <span class="hljs-keyword">FROM</span> <span class="hljs-comment">##CommandList)</span>
	<span class="hljs-keyword">AND</span> <span class="hljs-keyword">name</span> &lt;&gt; <span class="hljs-string">'Maintenance'</span>;	<span class="hljs-comment">--  linked server -    ,   ,    "linked server"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos qu√© sucedi√≥ all√≠ (SELECT * FROM ## CommandList): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2d/z7/k3/2dz7k3yvtbryjpasnxt5z0c7ipw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Genial, todos los comandos se recopilan all√≠ para hacer una copia de seguridad / restaurar todas las bases de datos necesarias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La base de datos de mantenimiento se cre√≥ en el nuevo servidor y la tabla CommandList est√° en ella, que contendr√° informaci√≥n sobre la restauraci√≥n de las bases de datos:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">USE</span> [Maintenance]
<span class="hljs-keyword">GO</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> CommandList (<font></font>
	dbName sysname <span class="hljs-keyword">unique</span>				<span class="hljs-comment">-- </span>
	, restore_command <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>)		<span class="hljs-comment">--  </span>
	, processed <span class="hljs-built_in">bit</span>						<span class="hljs-comment">-- </span>
	, creation_dt datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">GETDATE</span>()	<span class="hljs-comment">--  </span>
	, start_dt datetime					<span class="hljs-comment">--  </span>
	, finish_dt datetime					<span class="hljs-comment">--  </span>
	, error_msg <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>)				<span class="hljs-comment">-- ,  </span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se configur√≥ un servidor vinculado en el servidor anterior, mirando la nueva instancia de SQL Server. </font><font style="vertical-align: inherit;">Los scripts que se dan en esta publicaci√≥n, los escrib√≠ en casa y no me molest√© con una nueva instancia, us√© uno y lo conect√© como un servidor vinculado a m√≠ mismo. </font><font style="vertical-align: inherit;">Por lo tanto, aqu√≠ tengo los mismos caminos y unc-path local. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora puede declarar un cursor para hacer una copia de seguridad de las bases de datos, desconectarlas y escribir un comando para restaurar en el servidor vinculado:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span> @dbname <span class="hljs-keyword">AS</span> sysname<font></font>
	, @backup_cmd <span class="hljs-keyword">AS</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>)<font></font>
	, @restore_cmd <span class="hljs-keyword">AS</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>)<font></font>
	, @offline_cmd <span class="hljs-keyword">AS</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>);<font></font>
<font></font>
<span class="hljs-keyword">DECLARE</span> MoveDatabase <span class="hljs-keyword">CURSOR</span>
<span class="hljs-keyword">FOR</span> 
<span class="hljs-keyword">SELECT</span> dbName, backup_command, offline_command, restore_command
<span class="hljs-keyword">FROM</span> <span class="hljs-comment">##CommandList</span>
<span class="hljs-keyword">WHERE</span> processed <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
OPEN MoveDatabase;<font></font>
<font></font>
FETCH NEXT FROM MoveDatabase INTO @dbname, @backup_cmd, @offline_cmd, @restore_cmd;<font></font>
<font></font>
WHILE @@FETCH_STATUS = 0<font></font>
	<span class="hljs-keyword">BEGIN</span>
		<span class="hljs-comment">--    ,  :</span>
		<span class="hljs-comment">--  </span>
		<span class="hljs-comment">--   -      </span>
		<span class="hljs-comment">--    ,      </span>
		<span class="hljs-comment">--     </span><font></font>
<font></font>
		<span class="hljs-comment">--    </span>
		<span class="hljs-keyword">UPDATE</span> <span class="hljs-comment">##CommandList</span>
		<span class="hljs-keyword">SET</span> start_dt = <span class="hljs-keyword">GETDATE</span>()
		<span class="hljs-keyword">WHERE</span> dbName = @dbname;<font></font>
<font></font>
		<span class="hljs-keyword">BEGIN</span> TRY<font></font>
			<font></font>
			RAISERROR (<span class="hljs-string">'  %s'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, @dbname) <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">NOWAIT</span>; <span class="hljs-comment">--   messages   </span><font></font>
			<font></font>
			<span class="hljs-comment">--  </span><font></font>
			EXEC (@backup_cmd);<font></font>
<font></font>
			RAISERROR ('    %s', 0, 1, @dbname) <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">NOWAIT</span>;<font></font>
<font></font>
			<span class="hljs-comment">--    -  linked server</span>
			<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> [(<span class="hljs-keyword">LOCAL</span>)].[Maintenance].[dbo].[CommandList] (dbName, restore_command)
			<span class="hljs-keyword">VALUES</span> (@dbname, @restore_cmd);<font></font>
<font></font>
			RAISERROR (' %s  OFFLINE', 0, 1, @dbname) <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">NOWAIT</span>;<font></font>
<font></font>
			<span class="hljs-comment">--    </span><font></font>
			EXEC (@offline_cmd);<font></font>
<font></font>
			<span class="hljs-comment">--  ,    </span>
			<span class="hljs-keyword">UPDATE</span> <span class="hljs-comment">##CommandList</span>
			<span class="hljs-keyword">SET</span> processed = <span class="hljs-number">0</span>
				, finish_dt = <span class="hljs-keyword">GETDATE</span>()
			<span class="hljs-keyword">WHERE</span> dbName = @dbname;<font></font>
<font></font>
		<span class="hljs-keyword">END</span> TRY
		<span class="hljs-keyword">BEGIN</span> CATCH<font></font>
			<font></font>
			RAISERROR (<span class="hljs-string">'    %s.   error_msg  ##CommandList'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, @dbname) <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">NOWAIT</span>;<font></font>
<font></font>
			<span class="hljs-comment">--  -   ,      </span>
			<span class="hljs-keyword">UPDATE</span> <span class="hljs-comment">##CommandList</span>
			<span class="hljs-keyword">SET</span> processed = <span class="hljs-number">1</span>
				, finish_dt = <span class="hljs-keyword">GETDATE</span>()<font></font>
				, error_msg = ERROR_MESSAGE();<font></font>
<font></font>
		<span class="hljs-keyword">END</span> CATCH<font></font>
<font></font>
		<span class="hljs-keyword">FETCH</span> <span class="hljs-keyword">NEXT</span> <span class="hljs-keyword">FROM</span> MoveDatabase <span class="hljs-keyword">INTO</span> @dbname, @backup_cmd, @offline_cmd, @restore_cmd;
	<span class="hljs-keyword">END</span><font></font>
<font></font>
<span class="hljs-keyword">CLOSE</span> MoveDatabase;<font></font>
<font></font>
<span class="hljs-keyword">DEALLOCATE</span> MoveDatabase;<font></font>
<font></font>
<span class="hljs-comment">-- </span>
<span class="hljs-keyword">SELECT</span> dbName<font></font>
	, <span class="hljs-keyword">CASE</span> processed <span class="hljs-keyword">WHEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">''</span> <span class="hljs-keyword">WHEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">''</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-string">' '</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">Status</span> <font></font>
	, start_dt<font></font>
	, finish_dt<font></font>
	, error_msg<font></font>
<span class="hljs-keyword">FROM</span> <span class="hljs-comment">##CommandList</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> start_dt;<font></font>
<font></font>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-comment">##CommandList;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada acci√≥n se "registra" en la pesta√±a Mensajes en SSMS; all√≠ puede observar la acci√≥n actual. </font><font style="vertical-align: inherit;">Si usa WITH LOG en RAISERROR, en principio, puede ponerlo todo en alg√∫n trabajo y luego mirar los registros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tiempo de ejecuci√≥n, puede acceder a la ## CommandList y ver en forma de tabla qu√© est√° sucediendo y c√≥mo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el nuevo servidor, en paralelo, un ciclo sin fin giraba:</font></font><br>
<br>
<pre><code class="sql hljs">
<span class="hljs-keyword">SET</span> NOCOUNT <span class="hljs-keyword">ON</span>;<font></font>
<font></font>
<span class="hljs-keyword">DECLARE</span> @dbname <span class="hljs-keyword">AS</span> sysname<font></font>
	, @restore_cmd <span class="hljs-keyword">AS</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-keyword">max</span>);<font></font>
<font></font>
WHILE 1 = 1	<span class="hljs-comment">--   ,    </span>
<span class="hljs-keyword">BEGIN</span>
	<span class="hljs-keyword">SELECT</span> TOP <span class="hljs-number">1</span> @dbname = dbName, @restore_cmd = restore_command 
	<span class="hljs-keyword">FROM</span> CommandList
	<span class="hljs-keyword">WHERE</span> processed <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">--    ,  </span><font></font>
<font></font>
	IF @dbname IS NOT NULL <font></font>
	<span class="hljs-keyword">BEGIN</span>
		<span class="hljs-comment">--    </span>
		<span class="hljs-keyword">UPDATE</span> CommandList
		<span class="hljs-keyword">SET</span> start_dt = <span class="hljs-keyword">GETDATE</span>()
		<span class="hljs-keyword">WHERE</span> dbName = @dbname;<font></font>
<font></font>
		RAISERROR('  %s', 0, 1, @dbname) <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">NOWAIT</span>;<font></font>
		<font></font>
		<span class="hljs-keyword">BEGIN</span> TRY<font></font>
<font></font>
			<span class="hljs-comment">--  ,  -  ,  CATCH    </span><font></font>
			EXEC (@restore_cmd);<font></font>
<font></font>
			<span class="hljs-comment">--   </span>
			<span class="hljs-keyword">UPDATE</span> CommandList
			<span class="hljs-keyword">SET</span> processed = <span class="hljs-number">0</span>
				, finish_dt = <span class="hljs-keyword">GETDATE</span>()
			<span class="hljs-keyword">WHERE</span> dbName = @dbname;<font></font>
<font></font>
			RAISERROR(' %s  ', 0, 1, @dbname) <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">NOWAIT</span>;<font></font>
<font></font>
		<span class="hljs-keyword">END</span> TRY
		<span class="hljs-keyword">BEGIN</span> CATCH<font></font>
<font></font>
			RAISERROR(<span class="hljs-string">'    %s'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, @dbname) <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">NOWAIT</span>;<font></font>
<font></font>
			<span class="hljs-keyword">UPDATE</span> CommandList 
			<span class="hljs-keyword">SET</span> processed = <span class="hljs-number">1</span>
				, finish_dt = <span class="hljs-keyword">GETDATE</span>()<font></font>
				, error_msg = ERROR_MESSAGE();<font></font>
<font></font>
		<span class="hljs-keyword">END</span> CATCH<font></font>
<font></font>
	<span class="hljs-keyword">END</span>
	<span class="hljs-keyword">ELSE</span>	<span class="hljs-comment">--   ,    </span>
		<span class="hljs-keyword">BEGIN</span><font></font>
<font></font>
			RAISERROR(<span class="hljs-string">'waiting'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">NOWAIT</span>;<font></font>
<font></font>
			WAITFOR DELAY '00:00:30';<font></font>
<font></font>
		<span class="hljs-keyword">END</span><font></font>
		<font></font>
	<span class="hljs-keyword">SET</span> @dbname = <span class="hljs-literal">NULL</span>;
	<span class="hljs-keyword">SET</span> @restore_cmd = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-keyword">END</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo lo que hace, mira la tabla de la Lista de comandos, si hay al menos un registro sin procesar, toma el nombre de la base de datos y el comando para restaurar e intenta ejecutarlo usando EXEC (@sql_text); </font><font style="vertical-align: inherit;">Si no hay entradas, espere 30 segundos e intente nuevamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tanto el cursor como el bucle procesan cada registro solo una vez. </font><font style="vertical-align: inherit;">¬øNo funciono? </font><font style="vertical-align: inherit;">Escribimos un mensaje de error en la tabla y ya no regresamos aqu√≠.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre la condici√≥n para parar: en realidad era vago. </font><font style="vertical-align: inherit;">Mientras escrib√≠a, se me ocurrieron al menos tres soluciones, como una opci√≥n, agregando las banderas "Listo para la recuperaci√≥n \ No listo para la recuperaci√≥n \ Terminado", completando la lista de bases de datos y comandos de inmediato, al completar ## CommandList en el servidor anterior y actualizar la bandera dentro del cursor. </font><font style="vertical-align: inherit;">Nos detenemos cuando no quedan "registros listos para la recuperaci√≥n", ya que sabemos de inmediato la cantidad total de trabajo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recomendaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero no hay conclusiones. Pens√© que podr√≠a ser √∫til / interesante para alguien ver c√≥mo usar metadatos para formar y ejecutar sql din√°mico. Las secuencias de comandos que figuran en la publicaci√≥n, tal como est√°n, no son adecuadas para su uso en el producto, sin embargo, pueden terminarse ligeramente por s√≠ mismas y utilizarse, por ejemplo, para la personalizaci√≥n masiva de grupos de env√≠o de registros / duplicaci√≥n de bases de datos / disponibilidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al realizar una copia de seguridad en la bola, la cuenta en la que se ejecuta SQL Server debe tener permisos para escribir all√≠.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La creaci√≥n de Linked Server no se revel√≥ en la publicaci√≥n (el mouse en la GUI se configura intuitivamente en un par de minutos) y la transferencia de inicios de sesi√≥n al nuevo servidor. </font><font style="vertical-align: inherit;">Aquellos que han experimentado la migraci√≥n de usuarios saben que simplemente volver a crear inicios de sesi√≥n sql no ayuda mucho, porque tienen sid s con los que los usuarios de la base de datos est√°n conectados. </font><font style="vertical-align: inherit;">Los scripts para generar inicios de sesi√≥n sql con contrase√±as actuales y sid correcto est√°n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en msdn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es488468/index.html">Introduciendo FastAPI</a></li>
<li><a href="../es488470/index.html">Kim Dotcom: Atrapado, la persona m√°s buscada en l√≠nea. Parte 4</a></li>
<li><a href="../es488472/index.html">Lectura de fin de semana: 10 materiales sobre dispositivos de audio, desde radios de autom√≥viles sovi√©ticos hasta enchufes con cancelaci√≥n de ruido</a></li>
<li><a href="../es488474/index.html">Sobre el color, el sonido y la "exploraci√≥n de multitudes" como un tipo separado de belleza</a></li>
<li><a href="../es488476/index.html">Bobina de tubo Tesla</a></li>
<li><a href="../es488480/index.html">Una l√°mpara inteligente para los "ricos" con sus manos "flojas", es "simple" y conveniente</a></li>
<li><a href="../es488482/index.html">¬øCu√°nto cuesta Appium para la gente?</a></li>
<li><a href="../es488484/index.html">Lanzamiento de SQL: evento de Microsoft SQL Server 2019</a></li>
<li><a href="../es488488/index.html">Para OpenBSD Un poco de deleite</a></li>
<li><a href="../es488490/index.html">Likbez en respiradores. ¬øEl respirador ayuda con la infecci√≥n por virus? Resumen de 11 respiradores</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>