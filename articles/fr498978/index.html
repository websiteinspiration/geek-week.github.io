<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌚 👩🏻‍💼 👩🏻‍🚀 Utilisation de Graylog et NLog pour collecter les journaux des applications C #. Expérience personnelle 🔣 👩🏾‍🎨 🧘🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="KDPV
 
 Habr, bienvenue! 
 
 Ce qui suit n'est en aucun cas un tutoriel ou une meilleure pratique . J'ai décidé seulement d'agréger et de documenter m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Utilisation de Graylog et NLog pour collecter les journaux des applications C #. Expérience personnelle</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498978/"><img src="https://habrastorage.org/webt/_y/ee/iu/_yeeiuyxudo9su5z6rjaloimftg.jpeg"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KDPV</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Habr, bienvenue! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui suit n'est en aucun cas un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tutoriel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou une </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">meilleure pratique</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">J'ai décidé seulement d'agréger et de documenter mes réalisations dans la question posée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'espère que le contenu de cet article permettra à ceux qui recherchent des informations sur la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">journalisation d'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apprendre quelque chose de nouveau ou de prendre une décision. </font><font style="vertical-align: inherit;">Et, bien sûr, j'espère obtenir un retour constructif de la communauté. </font><font style="vertical-align: inherit;">Cela donne une chance de faire quelque chose de mieux.</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour quoi? </font><font style="vertical-align: inherit;">Pour qui?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais essayer de décrire ce qu'est la journalisation dans mes propres mots:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enregistrer des informations lisibles par l'homme sur un événement positif ou négatif pendant l'exécution du code de programme, éventuellement avec la préservation d'indicateurs et de données qualitatifs ou quantitatifs dans le cadre des informations stockées en référence à l'heure à laquelle l'événement s'est produit.</font></font><br>
</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une formulation compliquée est sortie, mais dans le cas général, elle décrit pleinement la tâche de création et de maintenance des journaux. </font><font style="vertical-align: inherit;">Une journalisation de haute qualité aide le développeur à contrôler l'état interne du code à n'importe quelle étape de sa vie: du débogage à l'installation dans un environnement inconnu de l'ordinateur du consommateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, montrons comment j'écris des journaux.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outils</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous omettons la prise en compte de la journalisation à l'aide de messages texte peu informatifs tels que «La </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base de données n'est pas disponible</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> », « </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Échec de l'enregistrement du fichier</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> » et autres. Les journaux de ce type sont faciles à créer, mais ils ne sont souvent pas suffisants pour comprendre l'essence et les sources du problème dans le code ou l'environnement. À un moment donné, chaque développeur doit simplement proposer une journalisation structurée. Comme mon bon ami et mentor informatique m'a dit: « </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collectez tout, puis excluez les éléments inutiles ...</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> » Des cadres spécialisés nous y aideront. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y en a assez. La plupart d'entre eux ont des capacités et des limitations similaires. De nombreux articles et </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">critiques</font></a><font style="vertical-align: inherit;"> ont été écrits à leur sujet.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comparaisons et manuels. </font><font style="vertical-align: inherit;">Pour me connecter aux applications écrites en C #, j'ai choisi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NLog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Maintenant, je ne me souviens pas pourquoi c'était lui, mais c'est comme ça. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette plateforme a une très bonne </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cas d'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilisation </font><font style="vertical-align: inherit;">extrêmement utiles </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Naturellement, à différents moments et pour différents projets, j'ai utilisé NLog de différentes manières. </font><font style="vertical-align: inherit;">Mais à un moment donné, un code est né qui est maintenant utilisé comme extrait de code et ne change pratiquement pas.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la mise en oeuvre</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les affaires! </font><font style="vertical-align: inherit;">Afficher le code:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Diagnostics;
<span class="hljs-keyword">using</span> System.IO;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Reflection;
<span class="hljs-keyword">using</span> System.Runtime.InteropServices;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> Newtonsoft.Json;
<span class="hljs-keyword">using</span> NLog;
<span class="hljs-keyword">using</span> NLog.Config;
<span class="hljs-keyword">using</span> NLog.Layouts;
<span class="hljs-keyword">using</span> NLog.Targets;
<span class="hljs-keyword">using</span> NLog.Targets.GraylogHttp;
<span class="hljs-keyword">using</span> NLog.Targets.Wrappers;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">BIMLIB.Converter</span><font></font>
{<font></font>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BimlibLogger</span><font></font>
	{<font></font>
		<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ApplicationSettings _settings = BimlibSettingsManager.Instance.AppSettings;
		<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Lazy&lt;LogFactory&gt; _instance = <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LoggingConfiguration _logConfig = <span class="hljs-literal">null</span>;<font></font>
<font></font>
		<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Lazy&lt;LogFactory&gt; Instance<font></font>
		{<font></font>
			<span class="hljs-keyword">get</span><font></font>
			{<font></font>
				<span class="hljs-keyword">return</span> _instance ?? (_instance = <span class="hljs-keyword">new</span> Lazy&lt;LogFactory&gt;(BuildLogFactory));<font></font>
			}<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Logger <span class="hljs-title">GetLogger</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			<span class="hljs-keyword">return</span> Instance.Value.GetCurrentClassLogger();<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LogFactory <span class="hljs-title">BuildLogFactory</span>(<span class="hljs-params"></span>)</span><font></font>
		{<font></font>
			LoggingConfiguration config = _logConfig ?? <span class="hljs-keyword">new</span> LoggingConfiguration();
			<span class="hljs-comment">//     .   .</span>
			<span class="hljs-keyword">string</span> headerStr = _settings.LogHeader;
			<span class="hljs-comment">//    .       - , : https://github.com/drewnoakes/figgle</span><font></font>
			Layout header = headerStr;<font></font>
<font></font>
			<span class="hljs-comment">//      : https://nlog-project.org/config/?tab=layout-renderers</span>
			<span class="hljs-comment">//     :</span>
			<span class="hljs-comment">// -   : 2020-04-24 19:13:51.1620 [BIMLIB.Converter.MainClass.Main] -&gt; I : Service starting...</span>
			<span class="hljs-comment">// -  : 2020-04-22 09:55:33.1132 [BIMLIB.Converter.Converter.ClearFile] -&gt; E : mscorlib</span>
			<span class="hljs-comment">//{</span>
			<span class="hljs-comment">//	"Type":"System.IO.FileNotFoundException", "Message":" 'D:\\path\\to\\file\\file_name.ifc'  .", "FileName":"D:\\path\\to\\file\\file_name.ifc", "Data":{</span>
			<span class="hljs-comment">//	}, "TargetSite":"Void WinIOError(Int32, System.String)", "StackTrace":"    System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath)\r\n    System.IO.FileInfo.get_Length()\r\n    BIMLIB.Converter.Converter.ClearFile(String path)", "Source":"mscorlib", "HResult":-2147024894}</span><font></font>
<font></font>
			Layout layout = <span class="hljs-string">"${longdate} [${callsite:className=true:includeNamespace=true:fileName=false:includeSourcePath=false:methodName=true:cleanNamesOfAnonymousDelegates=true:cleanNamesOfAsyncContinuations=true}] -&gt; ${level:format=FirstCharacter} : ${message}${onexception:inner=${newline}${exception:format=@}}"</span>;<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> Targets ----------------------------</span><font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> FileTarget ----------------------------</span><font></font>
<font></font>
			Target fileTarget = FileTarget(header, layout).MakeAsyncTarget();<font></font>
			config.AddTarget(fileTarget);<font></font>
			config.AddRuleForAllLevels(fileTarget);<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> ConsoleTarget ----------------------------</span><font></font>
<font></font>
			Target consoleTarget = ConsoleTarget(header, layout).MakeAsyncTarget();<font></font>
			config.AddTarget(consoleTarget);<font></font>
			config.AddRuleForAllLevels(consoleTarget);<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> DebuggerTarget ----------------------------</span><font></font>
<font></font>
			Target debugTarget = DebuggerTarget(header, layout).MakeAsyncTarget();<font></font>
			config.AddTarget(debugTarget);<font></font>
			config.AddRuleForAllLevels(debugTarget);<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> GelfTarget ----------------------------</span><font></font>
<font></font>
			<span class="hljs-comment">//       Graylog  ,    </span>
			<span class="hljs-keyword">if</span> (_settings.Statistics)<font></font>
			{<font></font>
				Target gelfTarget = GelfTarget(headerStr).MakeAsyncTarget();<font></font>
				config.AddTarget(gelfTarget);<font></font>
				config.AddRuleForAllLevels(gelfTarget);<font></font>
			}<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			LogFactory logFactory = <span class="hljs-keyword">new</span> LogFactory<font></font>
			{<font></font>
				Configuration = config<font></font>
			};<font></font>
<font></font>
			<span class="hljs-keyword">try</span><font></font>
			{<font></font>
				<span class="hljs-comment">// ,           </span><font></font>
				config.LoggingRules.ToList().ForEach(r =&gt; r.SetLoggingLevels(LogLevel.AllLevels.Min(), LogLevel.AllLevels.Max()));<font></font>
<font></font>
				_logConfig = config;<font></font>
			}<font></font>
			<span class="hljs-keyword">catch</span> (Exception ex)<font></font>
			{<font></font>
				<span class="hljs-comment">//  ,        </span><font></font>
				Debug.Write(ex);<font></font>
			}<font></font>
<font></font>
			<span class="hljs-keyword">return</span> logFactory;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> Target Methods</span><font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FileTarget <span class="hljs-title">FileTarget</span>(<span class="hljs-params">Layout header, Layout layout</span>)</span><font></font>
		{<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> FileTarget ----------------------------</span><font></font>
<font></font>
			FileTarget fileTarget = <span class="hljs-keyword">new</span> FileTarget(<span class="hljs-string">"log_file_target"</span>)<font></font>
			{<font></font>
				ArchiveAboveSize = <span class="hljs-number">1048576</span>,<font></font>
				ArchiveDateFormat = <span class="hljs-string">"yyyy.MM.dd_HH.mm.ss"</span>,<font></font>
				ArchiveEvery = FileArchivePeriod.Day,<font></font>
				ArchiveFileName = GetApplicationLogAndArchivePath(<span class="hljs-literal">false</span>),<font></font>
				ArchiveNumbering = ArchiveNumberingMode.Date,<font></font>
				ArchiveOldFileOnStartup = <span class="hljs-literal">false</span>,<font></font>
				AutoFlush = <span class="hljs-literal">true</span>,<font></font>
				ConcurrentWrites = <span class="hljs-literal">true</span>,<font></font>
				DeleteOldFileOnStartup = <span class="hljs-literal">false</span>,<font></font>
				EnableArchiveFileCompression = <span class="hljs-literal">true</span>,<font></font>
				EnableFileDelete = <span class="hljs-literal">true</span>,<font></font>
				Encoding = Encoding.UTF8,<font></font>
				FileName = GetApplicationLogAndArchivePath(<span class="hljs-literal">true</span>),<font></font>
				Header = header,<font></font>
				Layout = layout,<font></font>
				MaxArchiveFiles = <span class="hljs-number">100</span>,<font></font>
				OpenFileCacheTimeout = <span class="hljs-number">30</span>,<font></font>
				OpenFileFlushTimeout = <span class="hljs-number">30</span>,<font></font>
				OptimizeBufferReuse = <span class="hljs-literal">true</span><font></font>
			};<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			<span class="hljs-keyword">return</span> fileTarget;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColoredConsoleTarget <span class="hljs-title">ConsoleTarget</span>(<span class="hljs-params">Layout header, Layout layout</span>)</span><font></font>
		{<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> ConsoleTarget ----------------------------</span><font></font>
<font></font>
			ColoredConsoleTarget consoleTarget = <span class="hljs-keyword">new</span> ColoredConsoleTarget(<span class="hljs-string">"log_console_target"</span>)<font></font>
			{<font></font>
				Encoding = Encoding.UTF8,<font></font>
				EnableAnsiOutput = <span class="hljs-literal">false</span>,<font></font>
<font></font>
				UseDefaultRowHighlightingRules = <span class="hljs-literal">true</span>,<font></font>
<font></font>
				Layout = layout,<font></font>
				Header = header<font></font>
			};<font></font>
<font></font>
			ConsoleWordHighlightingRule dateHighLightRule = <span class="hljs-keyword">new</span> ConsoleWordHighlightingRule<font></font>
			{<font></font>
				Regex = <span class="hljs-string">@"^(?=\d).+(?=\s\[)"</span>,<font></font>
				ForegroundColor = ConsoleOutputColor.Yellow<font></font>
			};<font></font>
<font></font>
			ConsoleWordHighlightingRule methodsHighLightRule = <span class="hljs-keyword">new</span> ConsoleWordHighlightingRule<font></font>
			{<font></font>
				Regex = <span class="hljs-string">@"(?&lt;=\[).+(?=\])"</span>,<font></font>
				ForegroundColor = ConsoleOutputColor.Blue<font></font>
			};<font></font>
<font></font>
			ConsoleWordHighlightingRule levelHighLightRule = <span class="hljs-keyword">new</span> ConsoleWordHighlightingRule<font></font>
			{<font></font>
				Regex = <span class="hljs-string">@"(?&lt;=&gt;).+(?=\s:)"</span>,<font></font>
				ForegroundColor = ConsoleOutputColor.Red<font></font>
			};<font></font>
<font></font>
			ConsoleWordHighlightingRule messageHighLightRule = <span class="hljs-keyword">new</span> ConsoleWordHighlightingRule<font></font>
			{<font></font>
				Regex = <span class="hljs-string">@"(?&lt;=\s:\s).+"</span>,<font></font>
				ForegroundColor = ConsoleOutputColor.Green<font></font>
			};<font></font>
<font></font>
			consoleTarget.WordHighlightingRules.Add(dateHighLightRule);<font></font>
			consoleTarget.WordHighlightingRules.Add(methodsHighLightRule);<font></font>
			consoleTarget.WordHighlightingRules.Add(levelHighLightRule);<font></font>
			consoleTarget.WordHighlightingRules.Add(messageHighLightRule);<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			<span class="hljs-keyword">return</span> consoleTarget;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DebuggerTarget <span class="hljs-title">DebuggerTarget</span>(<span class="hljs-params">Layout header, Layout layout</span>)</span><font></font>
		{<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> DebuggerTarget ----------------------------</span><font></font>
<font></font>
			DebuggerTarget debugTarget = <span class="hljs-keyword">new</span> DebuggerTarget(<span class="hljs-string">"log_debug_target"</span>)<font></font>
			{<font></font>
				Layout = layout,<font></font>
				Header = header<font></font>
			};<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			<span class="hljs-keyword">return</span> debugTarget;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> GraylogHttpTarget <span class="hljs-title">GelfTarget</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> header</span>)</span><font></font>
		{<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">region</span> GelfTarget ----------------------------</span><font></font>
<font></font>
			Layout gelfCommonLayout = <span class="hljs-string">"${message}"</span>;<font></font>
<font></font>
			IList&lt;TargetPropertyWithContext&gt; gelfParameterInfos =<font></font>
				<span class="hljs-keyword">new</span> List&lt;TargetPropertyWithContext&gt;()<font></font>
				{<font></font>
					<span class="hljs-comment">//     : https://nlog-project.org/config/?tab=layout-renderers</span>
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"appdomain"</span>, Layout = <span class="hljs-string">"${appdomain}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"assembly-version"</span>, Layout = <span class="hljs-string">"${assembly-version}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"activityid"</span>, Layout = <span class="hljs-string">"${activityid}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"callsite"</span>, Layout = <span class="hljs-string">"${callsite}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"callsite-linenumber"</span>, Layout = <span class="hljs-string">"${callsite-linenumber}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"environment-user"</span>, Layout = <span class="hljs-string">"${environment-user:userName=true:domain=true}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"exeption_json_data"</span>, Layout = <span class="hljs-string">"${onexception:inner=${exception:format=@}}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"frameWorkInfo"</span>, Layout = <span class="hljs-string">$"<span class="hljs-subst">{RuntimeInformation.FrameworkDescription}</span> (<span class="hljs-subst">{RuntimeInformation.ProcessArchitecture}</span>)"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"guid"</span>, Layout = <span class="hljs-string">"${guid:format=N}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"hostname"</span>, Layout = <span class="hljs-string">"${hostname}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"identity"</span>, Layout = <span class="hljs-string">"${identity:authType=true:separator=\n:name=true:isAuthenticated=true}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"level_name"</span>, Layout = <span class="hljs-string">"${level:format=Name}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"local-ip"</span>, Layout = <span class="hljs-string">"${local-ip:addressFamily=InterNetwork}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"logger"</span>, Layout = <span class="hljs-string">"${logger:shortName=false}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"machinename"</span>, Layout = <span class="hljs-string">"${machinename}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"osInfo"</span>, Layout = <span class="hljs-string">$"<span class="hljs-subst">{RuntimeInformation.OSDescription}</span> (<span class="hljs-subst">{RuntimeInformation.OSArchitecture}</span>)"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"processid"</span>, Layout = <span class="hljs-string">"${processid}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"processinfo_MainWindowHandle"</span>, Layout = <span class="hljs-string">"${processinfo:property=MainWindowHandle}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"processinfo_PagedMemorySize"</span>, Layout = <span class="hljs-string">"${processinfo:property=PagedMemorySize}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"processname"</span>, Layout = <span class="hljs-string">"${processname:fullName=true}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"processtime"</span>, Layout = <span class="hljs-string">"${processtime:invariant=false}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"sequenceid"</span>, Layout = <span class="hljs-string">"${sequenceid}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"stacktrace"</span>, Layout = <span class="hljs-string">"${stacktrace:format=Raw:topFrames=3:skipFrames=0:separator=
}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"threadid"</span>, Layout = <span class="hljs-string">"${threadid}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"threadname"</span>, Layout = <span class="hljs-string">"${threadname}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"timestamp"</span>, Layout = <span class="hljs-string">$"<span class="hljs-subst">{DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()}</span>"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"timestamp_local"</span>, Layout = <span class="hljs-string">@"${date:universalTime=false:format=yyyy-MM-dd HH\:mm\:ss zzz}"</span> },
					<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"windows-identity"</span>, Layout = <span class="hljs-string">"${windows-identity:userName=true:domain=true}"</span> }<font></font>
				};<font></font>
<font></font>
			GraylogHttpTarget gelfUdpTarget = <span class="hljs-keyword">new</span> GraylogHttpTarget<font></font>
			{<font></font>
				AddNLogLevelName = <span class="hljs-literal">true</span>,<font></font>
				Facility = header,<font></font>
				GraylogServer = _settings.LogServerAddress,<font></font>
				IncludeCallSite = <span class="hljs-literal">true</span>,<font></font>
				IncludeCallSiteStackTrace = <span class="hljs-literal">true</span>,<font></font>
				IncludeEventProperties = <span class="hljs-literal">true</span>,<font></font>
				Layout = gelfCommonLayout,<font></font>
				Name = <span class="hljs-string">"GelfHttp"</span>,<font></font>
				OptimizeBufferReuse = <span class="hljs-literal">true</span><font></font>
			};<font></font>
<font></font>
			<span class="hljs-keyword">foreach</span> (TargetPropertyWithContext gelfParameterInfo <span class="hljs-keyword">in</span> gelfParameterInfos)<font></font>
			{<font></font>
				gelfUdpTarget.ContextProperties.Add(gelfParameterInfo);<font></font>
			}<font></font>
<font></font>
			<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
			<span class="hljs-keyword">return</span> gelfUdpTarget;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-comment">//   https://github.com/nlog/NLog/wiki/AsyncWrapper-target    </span>
		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Target <span class="hljs-title">MakeAsyncTarget</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> Target targ</span>)</span><font></font>
		{<font></font>
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AsyncTargetWrapper<font></font>
			{<font></font>
				BatchSize = <span class="hljs-number">100</span>,<font></font>
				ForceLockingQueue = <span class="hljs-literal">true</span>,<font></font>
				FullBatchSizeWriteLimit = <span class="hljs-number">5</span>,<font></font>
				Name = targ.Name,<font></font>
				OptimizeBufferReuse = <span class="hljs-literal">true</span>,<font></font>
				OverflowAction = AsyncTargetWrapperOverflowAction.Grow,<font></font>
				QueueLimit = <span class="hljs-number">10000</span>,<font></font>
				TimeToSleepBetweenBatches = <span class="hljs-number">1</span>,<font></font>
				WrappedTarget = targ<font></font>
			};<font></font>
		}<font></font>
<font></font>
		<span class="hljs-meta">#<span class="hljs-meta-keyword">endregion</span></span><font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> <span class="hljs-title">GetApplicationLogAndArchivePath</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> isLog</span>)</span><font></font>
		{<font></font>
			<span class="hljs-keyword">string</span> addition;<font></font>
<font></font>
			<span class="hljs-keyword">if</span> (!isLog)<font></font>
			{<font></font>
				addition = <span class="hljs-string">".{#}.zip"</span>;<font></font>
			}<font></font>
			<span class="hljs-keyword">else</span><font></font>
			{<font></font>
				addition = <span class="hljs-string">".log"</span>;<font></font>
			}<font></font>
<font></font>
			<span class="hljs-keyword">try</span><font></font>
			{<font></font>
				<span class="hljs-keyword">if</span> (!Directory.Exists(_settings.LogsFolder))<font></font>
				{<font></font>
					Directory.CreateDirectory(_settings.LogsFolder);<font></font>
				}<font></font>
<font></font>
				<span class="hljs-keyword">return</span> Path.Combine(_settings.LogsFolder, _settings.ProductName + addition);<font></font>
			}<font></font>
			<span class="hljs-keyword">catch</span> (Exception ex)<font></font>
			{<font></font>
				Debug.Write(ex);<font></font>
				<span class="hljs-keyword">return</span> <span class="hljs-keyword">string</span>.Empty;<font></font>
			}<font></font>
		}<font></font>
}<font></font>
</code></pre></div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple d'utilisation:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">using</span> NLog;<font></font>
...<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Downloader</span><font></font>
	{<font></font>
		...<font></font>
		<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Logger log = BimlibLogger.GetLogger();<font></font>
		...<font></font>
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> <span class="hljs-title">GetFileToConvert</span>(<span class="hljs-params">ConverterRequest.Inputitem inputItem</span>)</span><font></font>
		{<font></font>
			...<font></font>
			<span class="hljs-keyword">try</span><font></font>
			{<font></font>
				...<font></font>
				log.Debug(<span class="hljs-string">$"Downloaded file: <span class="hljs-subst">{downloadedFile}</span>, size: <span class="hljs-subst">{new FileInfo(downloadedFile).Length / <span class="hljs-number">1e6</span>}</span>Mb"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">catch</span> (Exception ex)<font></font>
			{<font></font>
				log.Error(ex, ex.Source);<font></font>
				<span class="hljs-keyword">return</span> ...;<font></font>
			}<font></font>
		}<font></font>
	}<font></font>
</code></pre></div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelques détails</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code nu, bien qu'avec des commentaires, n'est pas cool. </font><font style="vertical-align: inherit;">Par conséquent, je décrirai un certain nombre de conventions et d'hypothèses:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_settings</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - un certain objet de paramètres. </font><font style="vertical-align: inherit;">Il n'est pas trop important de savoir exactement comment il est formé, mais il doit être reçu avant la première initialisation de l'enregistreur.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_logConfig</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Configuration NLog, effectuée non dans un fichier </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NLog.config</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> distinct </font><font style="vertical-align: inherit;">, mais directement dans le code.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme le dit la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NLog ne produira de sortie que si vous avez configuré une (ou plusieurs) cibles NLog.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, les méthodes de la région </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Méthodes cibles</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont responsables de la création de ces «objectifs»: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FileTarget</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour écrire le journal dans un fichier.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi ressemble un fichier journal?</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/bn/fz/iw/bnfziwxjz-gabqdfyv92qkab3bq.png"></div>
                    </div><br>
 <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ColoredConsoleTarget</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour </font><b><font style="vertical-align: inherit;">envoyer</font></b><font style="vertical-align: inherit;"> de "beaux" messages à la console (le cas échéant).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi ressemble une console couleur?</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/9p/b6/b0/9pb6b0idaxhi4t46opp5wsxk6oa.png"></div>
                    </div><br>
 <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DebuggerTarget</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour la sortie des messages de l'enregistreur vers la fenêtre de sortie de Visual Studio ou vers un débogueur connecté tiers en mode débogage.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi ressemblent les messages NLog dans le débogueur?</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qo/4n/0j/qo4n0jtkpdylzlxtwhg7xplmmwo.png"></div>
                    </div><br>
 <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraylogHttpTarget</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - l'objectif est d'envoyer des messages au serveur sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lequel Graylog est</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> installé </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi ressemble un message Graylog?</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/l9/9j/vu/l99jvuf49hfnuy1attfxuxpg6hu.png"></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon premier </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur Habr, j'ai mentionné l'utilisation de Graylog. </font><font style="vertical-align: inherit;">Je voudrais m'attarder sur le dernier objectif de la liste. </font><font style="vertical-align: inherit;">C'est elle qui vous permet d'envoyer des messages de l'application au service Graylog en utilisant la bibliothèque NLog. </font><font style="vertical-align: inherit;">Je vais essayer de vous dire à quel point j'ai personnellement aimé cet outil.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À propos de Graylog (un peu)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La description de l'installation et de la configuration du service ne sera pas incluse dans cet article. </font><font style="vertical-align: inherit;">Je peux seulement dire que je l'ai déployé dans le docker. </font><font style="vertical-align: inherit;">Ceci est également décrit dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je vous donne mon fichier de composition</font></font></b>
                        <div class="spoiler_text"><pre><code class="powershell hljs">version: <span class="hljs-string">'2'</span><font></font>
services:<font></font>
  <span class="hljs-comment"># MongoDB: https://hub.docker.com/_/mongo/</span><font></font>
  mongodb:<font></font>
    image: mongo:<span class="hljs-number">4</span><font></font>
    restart: always<font></font>
    volumes:<font></font>
    - mongo_data:/<span class="hljs-keyword">data</span>/db:rw<font></font>
    - /etc/localtime:/etc/localtime  <font></font>
  <span class="hljs-comment"># Elasticsearch: https://www.elastic.co/guide/en/elasticsearch/reference/6.x/docker.html</span><font></font>
  elasticsearch:<font></font>
    image: docker.elastic.co/elasticsearch/elastic<span class="hljs-built_in">search-oss</span>:<span class="hljs-number">6.8</span>.<span class="hljs-number">2</span><font></font>
    restart: always<font></font>
    volumes:<font></font>
    - es_data:/usr/share/elasticsearch/<span class="hljs-keyword">data</span>:rw<font></font>
    - /etc/localtime:/etc/localtime<font></font>
    environment:<font></font>
      - http.host=<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span><font></font>
      - transport.host=localhost<font></font>
      - network.host=<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>
      - <span class="hljs-string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span><font></font>
    ulimits:<font></font>
      memlock:<font></font>
        soft: <span class="hljs-literal">-1</span>
        hard: <span class="hljs-literal">-1</span>
    mem_limit: <span class="hljs-number">1</span>g
  <span class="hljs-comment"># Graylog: https://hub.docker.com/r/graylog/graylog/</span>
  <span class="hljs-comment"># Graylog: I want to have the lastest</span><font></font>
  graylog:<font></font>
    image: graylog/graylog:<span class="hljs-number">3.2</span><font></font>
    restart: always<font></font>
    volumes:<font></font>
    - graylog_data:/usr/share/graylog/<span class="hljs-keyword">data</span>/journal:rw<font></font>
    - /etc/localtime:/etc/localtime<font></font>
<span class="hljs-comment"># :   .     - </span>
    - /home/MYUSER/graylog<span class="hljs-literal">-data</span>/plugin/graylog<span class="hljs-literal">-plugin</span><span class="hljs-literal">-telegram</span><span class="hljs-literal">-notification</span><span class="hljs-literal">-2</span>.<span class="hljs-number">3.0</span>.jar:/usr/share/graylog/plugin/graylog<span class="hljs-literal">-plugin</span><span class="hljs-literal">-telegram</span><span class="hljs-literal">-notification</span><span class="hljs-literal">-2</span>.<span class="hljs-number">3.0</span>.jar<font></font>
    environment:<font></font>
      <span class="hljs-comment"># CHANGE ME (must be at least 16 characters)!</span><font></font>
      - GRAYLOG_PASSWORD_SECRET=somepasswordpepper<font></font>
      <span class="hljs-comment"># Password: MYPASSWORD</span><font></font>
      - GRAYLOG_ROOT_PASSWORD_SHA2=SHA2MYPASSWORDPLEASEINANYONLINESERVICE<font></font>
      - GRAYLOG_HTTP_BIND_ADDRESS=<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">9999</span>
      - GRAYLOG_WEB_LISTEN_URI=http://my.ex.ipa.dr:<span class="hljs-number">9999</span>/<font></font>
      - GRAYLOG_HTTP_EXTERNAL_URI=http://my.ex.ipa.dr:<span class="hljs-number">9999</span>/<font></font>
      - GRAYLOG_HTTP_PUBLISH_URI=http://my.ex.ipa.dr:<span class="hljs-number">9999</span>/<font></font>
      - GRAYLOG_ROOT_TIMEZONE=Europe/Moscow<font></font>
      - GRAYLOG_PLUGIN_DIR=plugin<font></font>
    links:<font></font>
      - mongodb:mongo<font></font>
      - elasticsearch<font></font>
    depends_on:<font></font>
      - mongodb<font></font>
      - elasticsearch<font></font>
    ports:<font></font>
      - <span class="hljs-number">5044</span>:<span class="hljs-number">5044</span>
      <span class="hljs-comment"># Graylog web interface and REST API</span>
      - <span class="hljs-number">9999</span>:<span class="hljs-number">9999</span>
      <span class="hljs-comment"># Syslog TCP</span>
      - <span class="hljs-number">1514</span>:<span class="hljs-number">1514</span>
      <span class="hljs-comment"># Syslog UDP</span>
      - <span class="hljs-number">1514</span>:<span class="hljs-number">1514</span>/udp
      <span class="hljs-comment"># GELF TCP</span>
      - <span class="hljs-number">12201</span>:<span class="hljs-number">12201</span>
      <span class="hljs-comment"># GELF UDP</span>
      - <span class="hljs-number">12201</span>:<span class="hljs-number">12201</span>/udp
      <span class="hljs-comment">#Volumes</span><font></font>
volumes:<font></font>
  mongo_data:<font></font>
    driver: local<font></font>
  es_data:<font></font>
    driver: local<font></font>
  graylog_data:<font></font>
    driver: local<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ajouterai également un exemple de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réglage de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> «Input» dans Graylog:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graylog écoute le trafic http sur le port 12201</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/5o/ya/vj/5oyavjsjaxvtbwjdc9bae_jrcy8.png" align="left"><br>
<br>
<blockquote>Graylog nodes accept data via inputs. Launch or terminate as many inputs as you want here.</blockquote><br>
<br>
<s>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">my.web.adress.domain</a>   12201  -,      .       ...</s><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À propos de GELF</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GELF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Format de journal étendu Graylog. Le format des messages que Graylog perçoit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour envoyer quelque chose au format GELF à une certaine URL, vous devrez utiliser une </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cible</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> supplémentaire </font><font style="vertical-align: inherit;">. Ils sont présentés dans la section </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intégrations</font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai choisi </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NLog.Targets.GraylogHttp</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuget</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> installé dans le projet </font><font style="vertical-align: inherit;">et a pu utiliser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NLog.Targets.GraylogHttp.GraylogHttpTarget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la configuration de son enregistreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disposition même</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> des messages que j'ai simplifiée en un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">message</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais rempli </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ContextProperties</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cible'une</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> large gamme de champs supplémentaires:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"someParamName1"</span>, Layout = <span class="hljs-string">"someStringInfo"</span> },
<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"someParamName2"</span>, Layout = <span class="hljs-string">"someNLogLayoutRendered"</span> },
<span class="hljs-keyword">new</span> TargetPropertyWithContext()  { Name = <span class="hljs-string">"someParamName3"</span>, Layout = (<span class="hljs-keyword">string</span>)SomeMethodThatGetsInfo() }</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai spécifiquement utilisé du code généralisé pour clarifier le principe: «nom arbitraire + valeur arbitraire». </font><font style="vertical-align: inherit;">La valeur peut être «extraite» avec succès par une méthode qui lui est propre. </font><font style="vertical-align: inherit;">Par exemple, lire les paramètres réseau ou l'espace libre sur le lecteur système. </font><font style="vertical-align: inherit;">Peu importe ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prime</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une opinion (et je ne le conteste pas) selon laquelle les journaux sont les plus utiles pour détecter les erreurs. </font><font style="vertical-align: inherit;">Les constructions </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try / catch</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ont été utilisées avec succès et dans la plupart des cas se justifient. </font><font style="vertical-align: inherit;">L '"objet d'erreur" lui-même est rempli d'informations de débogage, de données sur la chaîne d'événements lorsqu'elle se produit et d'autres. </font><font style="vertical-align: inherit;">Il est pratique de lire un tel objet ne fonctionne pas toujours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour moi, j'ai développé cette solution:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Méthode bonus à la classe logger pour l'envoi de champs depuis des objets vers Graylog:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment">// -. ,    Graylog    - .</span>
		<span class="hljs-comment">//     objWithProps -            json (  GELF)...</span>
		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LogEventInfo <span class="hljs-title">GetLogEventWithProperties</span>(<span class="hljs-params">LogLevel logLevel, <span class="hljs-keyword">string</span> logName, <span class="hljs-keyword">string</span> message, <span class="hljs-keyword">object</span> objWithProps</span>)</span><font></font>
		{<font></font>
			<span class="hljs-comment">//     ,      </span>
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">string</span>.IsNullOrEmpty(message))<font></font>
			{<font></font>
				message = objWithProps?.GetType()?.Name ?? <span class="hljs-string">"custom_json_data"</span>;<font></font>
			}<font></font>
<font></font>
			LogEventInfo e = <span class="hljs-keyword">new</span> LogEventInfo(logLevel, logName, message);<font></font>
<font></font>
			<span class="hljs-keyword">object</span> logEventProperty = <span class="hljs-literal">null</span>;
			<span class="hljs-comment">//     Newtonsoft.Json: https://www.newtonsoft.com/json</span>
			JsonSerializerSettings jsonSerializerSettings = <span class="hljs-keyword">new</span> JsonSerializerSettings<font></font>
			{<font></font>
				ReferenceLoopHandling = ReferenceLoopHandling.Serialize,<font></font>
				PreserveReferencesHandling = PreserveReferencesHandling.Objects,<font></font>
				NullValueHandling = NullValueHandling.Include<font></font>
			};<font></font>
<font></font>
			<span class="hljs-keyword">try</span><font></font>
			{<font></font>
				<span class="hljs-comment">//  ""  ()   ...</span><font></font>
				logEventProperty = JsonConvert.SerializeObject(objWithProps, Formatting.Indented, jsonSerializerSettings);<font></font>
			}<font></font>
			<span class="hljs-keyword">catch</span> (Exception ex)<font></font>
			{<font></font>
				Debug.Write(ex);<font></font>
<font></font>
				<span class="hljs-keyword">try</span><font></font>
				{<font></font>
					<span class="hljs-comment">// ...,   :  ,   , ...</span>
					IEnumerable&lt;PropertyInfo&gt; objProps = objWithProps?.GetType()?.GetProperties()?.Where(p =&gt; p?.GetGetMethod()?.GetParameters()?.Length == <span class="hljs-number">0</span>);<font></font>
<font></font>
					<span class="hljs-keyword">if</span> (objProps?.Any() == <span class="hljs-literal">true</span>)<font></font>
					{<font></font>
						<span class="hljs-comment">// ...   ,...</span>
						Dictionary&lt;<span class="hljs-keyword">string</span>, <span class="hljs-keyword">string</span>&gt; objPropsDict =<font></font>
							objProps<font></font>
							.ToDictionary(<font></font>
								x =&gt; x?.Name,<font></font>
								x =&gt;<font></font>
								{<font></font>
									<span class="hljs-keyword">string</span> rezVal = <span class="hljs-keyword">string</span>.Empty;
									<span class="hljs-keyword">try</span><font></font>
									{<font></font>
										rezVal = x?.GetValue(objWithProps, <span class="hljs-literal">null</span>)?.ToString();<font></font>
									}<font></font>
									<span class="hljs-keyword">catch</span> (Exception ex0)<font></font>
									{<font></font>
										Debug.Write(ex0);<font></font>
									}<font></font>
									<span class="hljs-keyword">return</span> rezVal;<font></font>
								}<font></font>
							)?<font></font>
							.OrderBy(x =&gt; x.Key)?<font></font>
							.ToDictionary(obj =&gt; obj.Key, obj =&gt; obj.Value);<font></font>
						<span class="hljs-comment">// ...   Newtonsoft.Json</span><font></font>
						logEventProperty = JsonConvert.SerializeObject(objPropsDict, Formatting.Indented, jsonSerializerSettings);<font></font>
					}<font></font>
				}<font></font>
				<span class="hljs-keyword">catch</span> (Exception ex1)<font></font>
				{<font></font>
					Debug.Write(ex1);<font></font>
				}<font></font>
			}<font></font>
			<span class="hljs-comment">//   json-,  Graylog      .</span>
			e.Properties[<span class="hljs-string">"custom_json_data"</span>] = logEventProperty;
			<span class="hljs-keyword">return</span> e;<font></font>
		}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple d'utilisation:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs">log.Debug(BimlibLogger.GetLogEventWithProperties(LogLevel.Debug, log.Name, <span class="hljs-string">$"Got the task"</span>, message));</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi ressemble-t-il dans Graylog?</font></font></b>
                        <div class="spoiler_text"> <i>exeption_json_data</i> — <i>exception</i>,   json.<br>
<br>
<img src="https://habrastorage.org/webt/q0/fw/tz/q0fwtze_zbep1dbbwzlqecz2e3q.png"><br>
<br>
  <i>exception</i>,   .<br>
<br>
<img src="https://habrastorage.org/webt/m3/7b/km/m37bkmo_szukwtunyvkxukrw9hm.png"><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grâce à l'application de l'approche décrite et à une implémentation raisonnable des appels de l'enregistreur dans le corps du code, nous obtenons une collection de journaux centralisée avec une interface pratique pour les lire, les analyser et les analyser. </font><font style="vertical-align: inherit;">Nous avons un outil pratique pour les notifications sur certaines valeurs dans les journaux. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les fichiers journaux habituels, qui peuvent également être relus, tirer des conclusions, ne disparaissent pas. </font><font style="vertical-align: inherit;">Ce n'est pas un concurrent ou un remplaçant des systèmes de surveillance. </font><font style="vertical-align: inherit;">Mais maintenant, la situation «mon application fonctionne sur plus de 100 ordinateurs très différents dans plus de 3 pays en langue étrangère et se casse soudainement quelque part» est résolue un peu plus facilement et beaucoup plus rapidement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est tout?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 En principe, je vous ai dit tout ce dont vous avez besoin pour une journalisation relativement confortable de vos applications. </font><font style="vertical-align: inherit;">Prêt à discuter, obtenez des conseils. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci d'avoir lu. </font><font style="vertical-align: inherit;">Rendez-vous dans les commentaires. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ajout de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">cibles </font></a></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncWrapper</font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> au </font><font style="vertical-align: inherit;">travail </font><font style="vertical-align: inherit;">sur les conseils</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">justmara</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498958/index.html">L'erreur n'est pas UIAlertController</a></li>
<li><a href="../fr498962/index.html">À propos du multitâche: les fenêtres sous contrôle</a></li>
<li><a href="../fr498970/index.html">Kubernetes ConfigMaps: Nuances à connaître</a></li>
<li><a href="../fr498974/index.html">Coronavirus: une dangereuse illusion d'insécurité</a></li>
<li><a href="../fr498976/index.html">Présentation de .NET 5.0 Preview 3</a></li>
<li><a href="../fr498982/index.html">Floppies for Dreamcast</a></li>
<li><a href="../fr498984/index.html">Stealth School: 5 types de gadgets dans les jeux furtifs</a></li>
<li><a href="../fr498988/index.html">Recherche d'emploi à l'étranger et immigration au Canada</a></li>
<li><a href="../fr498990/index.html">Prise en charge de la manette de jeu pour l'émulateur Omega Red</a></li>
<li><a href="../fr498996/index.html">Différence entre les sockets Web et Socket.IO</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>