<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘‹ ğŸš¾ ğŸ™ SQLã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼-ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æœ€é©åŒ–ãŠã‚ˆã³ç¶­æŒã™ã‚‹ãŸã‚ã®ç„¡æ–™ãƒ„ãƒ¼ãƒ« ğŸ‘¶ğŸ¾ ğŸŒ¾ ğŸ‚ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="é•·å¹´SQL Server DBAã¨ã—ã¦åƒã„ã¦ãŠã‚Šã€ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ã‚’è¡Œã£ãŸå¾Œã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã—ã¾ã—ãŸã€‚ä¸€èˆ¬çš„ã«ã€ç§ã¯è‡ªç”±ãªæ™‚é–“ã«å®‡å®™ã¨ç§ãŸã¡ã®åŒåƒšã®ãŸã‚ã«å½¹ç«‹ã¤ä½•ã‹ã‚’ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚ãã®çµæœã€SQL Serverã¨Azureå‘ã‘ã®å°ã•ãªã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ„ãƒ¼ãƒ«ãŒæ‰‹ã«å…¥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SQLã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼-ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æœ€é©åŒ–ãŠã‚ˆã³ç¶­æŒã™ã‚‹ãŸã‚ã®ç„¡æ–™ãƒ„ãƒ¼ãƒ«</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459914/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é•·å¹´SQL Server DBAã¨ã—ã¦åƒã„ã¦ãŠã‚Šã€ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ã‚’è¡Œã£ãŸå¾Œã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ä¸€èˆ¬çš„ã«ã€ç§ã¯è‡ªç”±ãªæ™‚é–“ã«å®‡å®™ã¨ç§ãŸã¡ã®åŒåƒšã®ãŸã‚ã«å½¹ç«‹ã¤ä½•ã‹ã‚’ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãã®çµæœã€</font><font style="vertical-align: inherit;">SQL Serverã¨Azureå‘ã‘ã®</font><font style="vertical-align: inherit;">å°ã•ãª</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ãƒ„ãƒ¼ãƒ«</font></a><font style="vertical-align: inherit;">ãŒæ‰‹ã«å…¥ã‚Šã¾ã—ãŸ</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jw/8s/vk/jw8svkqqg0ybvtdgt1cdoiulxsm.png" alt="SQLã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼"><br>
<br>
<a name="habracut"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è€ƒãˆ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å„ªå…ˆé †ä½ã«å–ã‚Šçµ„ã‚€ã¨ãã«ã€äººã¯æŒ‡ã‚¿ã‚¤ãƒ—ã®ãƒãƒƒãƒ†ãƒªãƒ¼ã«ä¼¼ã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™-ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ¼ã‚¸ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãŒ1ã¤ã ã‘ã‚ã‚Šã€ãã‚Œã ã‘ã§ã™ã€‚ãã—ã¦æœ€è¿‘ã¾ã§ã€ç§ã¯ã“ã®ç”Ÿå‘½ã®è¦³å¯Ÿã®ä¾‹å¤–ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è‡ªåˆ†ã§ä½•ã‹ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã‚ˆãè¦‹ã‹ã‘ã¾ã—ãŸãŒã€å„ªå…ˆé †ä½ãŒå¤‰æ›´ã•ã‚Œã€ä½•ã‚‚æœ€å¾Œã¾ã§ã‚‚ãŸã‚‰ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL Serverã€MySQLã€ãŠã‚ˆã³Oracleãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é–‹ç™ºã¨ç®¡ç†ã®ãŸã‚ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ä½œæˆã«æºã‚ã£ã¦ã„ãŸãƒãƒªã‚³ãƒ•ã®ä¼šç¤¾ã§ã‚ã‚‹Devartã®ä»•äº‹ã«ã‚ˆã£ã¦ã€ç§ã®å‹•æ©Ÿã¨å°‚é–€èƒ½åŠ›ã®é–‹ç™ºã«ã‹ãªã‚Šå¼·ã„å½±éŸ¿ãŒã‚ã‚Šã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½¼ã‚‰ã«æ¥ã‚‹å‰ã¯ã€è‡ªåˆ†ã®è£½å“ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®è©³ç´°ã«ã¤ã„ã¦ã»ã¨ã‚“ã©è€ƒãˆã¦ã„ã¾ã›ã‚“ã§ã—ãŸãŒã€ãã®éç¨‹ã§SQL Serverã®å†…éƒ¨æ§‹é€ ã«ã¤ã„ã¦å¤šãã®çŸ¥è­˜ã‚’å¾—ã¾ã—ãŸã€‚ 1å¹´ä»¥ä¸Šã«ã‚ãŸã£ã¦è£½å“ãƒ©ã‚¤ãƒ³ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æœ€é©åŒ–ã—ã¦ããŸãŸã‚ã€å¸‚å ´ã§ã©ã®æ©Ÿèƒ½ãŒä»–ã®ã©ã®æ©Ÿèƒ½ã‚ˆã‚Šã‚‚éœ€è¦ãŒé«˜ã„ã‹ã‚’å¾ã€…ã«ç†è§£ã—å§‹ã‚ã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ã‚‹æ®µéšã§ã€æ–°ã—ã„ãƒ‹ãƒƒãƒãªè£½å“ã‚’ä½œã‚‹ã¨ã„ã†ã‚¢ã‚¤ãƒ‡ã‚¢ãŒç”Ÿã¾ã‚Œã¾ã—ãŸãŒã€äº‹æƒ…ã«ã‚ˆã‚Šã€ã“ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã†ã¾ãã„ãã¾ã›ã‚“ã§ã—ãŸã€‚å½“æ™‚ã€æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ã‚³ã‚¢ãƒ“ã‚¸ãƒã‚¹ã‚’æãªã†ã“ã¨ãªãã€ç¤¾å†…ã«ååˆ†ãªç©ºããƒªã‚½ãƒ¼ã‚¹ãŒååˆ†ã«ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã™ã§ã«æ–°ã—ã„å ´æ‰€ã§åƒã„ã¦è‡ªåˆ†ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚„ã‚ã†ã¨ã—ãŸã¨ãã€å½¼ã¯å¸¸ã«ã„ãã¤ã‹ã®å¦¥å”ã‚’ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">å¤§ããªè£½å“ã«æ©Ÿèƒ½ã‚’æº€è¼‰ã«ã™ã‚‹ã¨ã„ã†å½“åˆã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã™ãã«æ©Ÿèƒ½ã—ãªããªã‚Šã€æ¬¡ç¬¬ã«åˆ¥ã®æ–¹å‘ã«å¤‰ã‚ã‚Šã¾ã—ãŸ-è¨ˆç”»ã•ã‚ŒãŸæ©Ÿèƒ½ã‚’å€‹åˆ¥ã®ãƒŸãƒ‹ãƒ„ãƒ¼ãƒ«ã«åˆ†å‰²ã—ã€äº’ã„ã«ç‹¬ç«‹ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®çµæœã€</font><font style="vertical-align: inherit;">SQL Serverã¨Azureå‘ã‘ã®ç„¡æ–™ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ„ãƒ¼ãƒ«</font><font style="vertical-align: inherit;">ã§ã‚ã‚‹</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL Index ManagerãŒ</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">èª•ç”Ÿã—ã¾ã—ãŸ</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä¸»ãªã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã€RedGateã¨Devartã‹ã‚‰å¸‚è²©ã®ä»£æ›¿å“ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã€ãã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’æ”¹å–„ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">åˆå¿ƒè€…ã¨çµŒé¨“è±Šå¯Œãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸¡æ–¹ã«ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¾¿åˆ©ã«åˆ†æãŠã‚ˆã³ä¿å®ˆã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãŸã‚ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Ÿè£…</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¨€ã„æ›ãˆã‚Œã°ã€ã™ã¹ã¦ãŒå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã«èã“ãˆã¾ã™...ç§ã¯1ã¤ã‚’å–ã‚Šã€ã„ãã¤ã‹ã®å‹•æ©Ÿä»˜ã‘ã®vidosikã‚’è¦‹ã¦ã€ãƒ©ãƒƒã‚¯ã«ç«‹ã¡ã€ã‚¯ãƒ¼ãƒ«ãªè£½å“ã‚’ä½œã‚Šå§‹ã‚ã¾ã—ãŸã€‚ãŸã ã—ã€sys.dm_db_index_physical_statsã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«ã¯å¤šãã®è½ã¨ã—ç©´ãŒã‚ã‚Šã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ–­ç‰‡åŒ–ã«é–¢ã™ã‚‹é–¢é€£æƒ…å ±ã‚’å–å¾—ã§ãã‚‹å”¯ä¸€ã®å ´æ‰€ã§ã‚ã‚‹ãŸã‚ã€å®Ÿéš›ã«ã¯ã™ã¹ã¦ãŒãƒãƒ©ãƒãƒ©ã ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é–‹ç™ºã®æœ€åˆã®æ—¥ã‹ã‚‰ã€æ¨™æº–çš„ãªã‚¹ã‚­ãƒ¼ãƒ ã®é–“ã«ç­‹é“ã‚’ãŸã©ã‚Šã€ç«¶åˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæ¥­ã®ãƒ‡ãƒãƒƒã‚°æ¸ˆã¿ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã¨åŒæ™‚ã«ã€å°‘ã—ã‚®ãƒ£ã‚°ã‚’è¿½åŠ ã™ã‚‹çµ¶å¥½ã®æ©Ÿä¼šã§ã—ãŸã€‚ã—ã‹ã—ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®è¦æ±‚ã‚’åˆ†æã—ãŸå¾Œã€ç§ã¯ã‚ˆã‚Šæœ€é©åŒ–ã•ã‚ŒãŸä½•ã‹ã‚’ã—ãŸã‹ã£ãŸã®ã§ã™ã€‚ãã‚Œã¯ã€å¤§ä¼æ¥­ã®å®˜åƒšä¸»ç¾©ã®ãŸã‚ã«ã€å½¼ã‚‰ã®è£½å“ã«ã¯æ±ºã—ã¦ç¾ã‚Œãªã‹ã£ãŸã§ã—ã‚‡ã†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RedGate SQLã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆ1.1.9.1378-$ 155ï¼‰ã‚’åˆ†æã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒéå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚1ã¤ã®ã‚¯ã‚¨ãƒªã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ“ãƒ¥ãƒ¼ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã€2ç•ªç›®ã®ã‚¯ã‚¨ãƒªã®å¾Œã«ã€é¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ã™ã¹ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒªã‚¹ãƒˆãŒè¿”ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">SELECT objects.name AS tableOrViewName<font></font>
     , objects.object_id AS tableOrViewId<font></font>
     , schemas.name AS schemaName<font></font>
     , CAST(ISNULL(lobs.NumLobs, <span class="hljs-number">0</span>) AS BIT) AS ContainsLobs<font></font>
     , o.is_memory_optimized<font></font>
FROM sys.objects AS objects<font></font>
JOIN sys.schemas AS schemas ON schemas.schema_id = objects.schema_id<font></font>
LEFT JOIN (<font></font>
    SELECT object_id<font></font>
         , COUNT(*) AS NumLobs<font></font>
    FROM sys.columns WITH (NOLOCK)<font></font>
    WHERE system_type_id IN (<span class="hljs-number">34</span>, <span class="hljs-number">35</span>, <span class="hljs-number">99</span>)<font></font>
        OR max_length = -<span class="hljs-number">1</span><font></font>
    GROUP BY object_id<font></font>
) AS lobs ON objects.object_id = lobs.object_id<font></font>
LEFT JOIN sys.tables AS o ON o.object_id = objects.object_id<font></font>
WHERE objects.type = 'U'<font></font>
    OR objects.type = 'V'<font></font>
<font></font>
SELECT i.object_id AS tableOrViewId<font></font>
     , i.name AS indexName<font></font>
     , i.index_id AS indexId<font></font>
     , i.allow_page_locks AS allowPageLocks<font></font>
     , p.partition_number AS partitionNumber<font></font>
     , CAST((c.numPartitions - <span class="hljs-number">1</span>) AS BIT) AS belongsToPartitionedIndex<font></font>
FROM sys.indexes AS i<font></font>
JOIN sys.partitions AS p ON p.index_id = i.index_id<font></font>
                        AND p.object_id = i.object_id<font></font>
JOIN (<font></font>
    SELECT COUNT(*) AS numPartitions<font></font>
         , object_id<font></font>
         , index_id<font></font>
    FROM sys.partitions<font></font>
    GROUP BY object_id<font></font>
           , index_id<font></font>
) AS c ON c.index_id = i.index_id<font></font>
      AND c.object_id = i.object_id<font></font>
WHERE i.index_id &gt; <span class="hljs-number">0</span> -- ignore heaps<font></font>
    AND i.is_disabled = <span class="hljs-number">0</span>
    AND i.is_hypothetical = <span class="hljs-number">0</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€ãƒ«ãƒ¼ãƒ—ã§ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«ã€ã‚µã‚¤ã‚ºã¨æ–­ç‰‡åŒ–ã®ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚¹ã‚­ãƒ£ãƒ³ã®æœ€å¾Œã«ã€ã‚¨ãƒ³ãƒˆãƒªã®ã—ãã„å€¤ã‚ˆã‚Šã‚‚å°ã•ã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ç ´æ£„ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">EXEC sp_executesql N'<font></font>
SELECT index_id, avg_fragmentation_in_percent, page_count<font></font>
FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)'<font></font>
    , N'@databaseId int,@objectId int,@indexId int,@partitionNr int'<font></font>
    , @databaseId = <span class="hljs-number">7</span>, @objectId = <span class="hljs-number">2133582639</span>, @indexId = <span class="hljs-number">1</span>, @partitionNr = <span class="hljs-number">1</span><font></font>
<font></font>
EXEC sp_executesql N'<font></font>
SELECT index_id, avg_fragmentation_in_percent, page_count<font></font>
FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)'<font></font>
    , N'@databaseId int,@objectId int,@indexId int,@partitionNr int'<font></font>
    , @databaseId = <span class="hljs-number">7</span>, @objectId = <span class="hljs-number">2133582639</span>, @indexId = <span class="hljs-number">2</span>, @partitionNr = <span class="hljs-number">1</span><font></font>
<font></font>
EXEC sp_executesql N'<font></font>
SELECT index_id, avg_fragmentation_in_percent, page_count<font></font>
FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)'<font></font>
    , N'@databaseId int,@objectId int,@indexId int,@partitionNr int'<font></font>
    , @databaseId = <span class="hljs-number">7</span>, @objectId = <span class="hljs-number">2133582639</span>, @indexId = <span class="hljs-number">3</span>, @partitionNr = <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†æã™ã‚‹ã¨ã€å¤šãã®æ¬ ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€ã•ã•ã„ãªã“ã¨ã§å•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å‰ã«ã€ç¾åœ¨ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚­ãƒ£ãƒ³ã‹ã‚‰ç©ºã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é™¤å¤–ã™ã‚‹è¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ã‹ã—ã€ã“ã®å•é¡Œã¯åˆ¥ã®å´é¢ã§æœ€ã‚‚æ·±åˆ»ã§ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã¸ã®è¦æ±‚ã®æ•°ã¯ã€sys.partitionsã‹ã‚‰ã®è¡Œã®ç·æ•°ã¨ã»ã¼ç­‰ã—ããªã‚Šã¾ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯æ•°ä¸‡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã¨ã„ã†äº‹å®Ÿã‚’è€ƒãˆã‚‹ã¨ã€ã“ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã¯ã‚µãƒ¼ãƒãƒ¼ã¸ã®åŒæ§˜ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è†¨å¤§ãªæ•°ã«ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒãƒªãƒ¢ãƒ¼ãƒˆã§ã‚ã‚‹çŠ¶æ³ã§ã¯ã€æœ€ã‚‚å˜ç´”ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚ã£ã¦ã‚‚ã€ãã‚Œãã‚Œã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ãŒå¢—åŠ ã™ã‚‹ãŸã‚ã€ã‚¹ã‚­ãƒ£ãƒ³æ™‚é–“ãŒã•ã‚‰ã«é•·ããªã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RedGateã¨ã¯ç•°ãªã‚Šã€Devartã§é–‹ç™ºã•ã‚ŒãŸåŒæ§˜ã®è£½å“-dbForge Index Manager for SQL Serverï¼ˆ1.10.38-$ 99ï¼‰ã¯ã€1ã¤ã®å¤§ããªã‚¯ã‚¨ãƒªã§æƒ…å ±ã‚’å—ã‘å–ã‚Šã€ã™ã¹ã¦ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¡¨ç¤ºã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">SELECT SCHEMA_NAME(o.[schema_id]) AS [schema_name]<font></font>
     , o.name AS parent_name<font></font>
     , o.[type] AS parent_type<font></font>
     , i.name<font></font>
     , i.type_desc<font></font>
     , s.avg_fragmentation_in_percent<font></font>
     , s.page_count<font></font>
     , p.partition_number<font></font>
     , p.[rows]<font></font>
     , ISNULL(lob.is_lob_legacy, <span class="hljs-number">0</span>) AS is_lob_legacy<font></font>
     , ISNULL(lob.is_lob, <span class="hljs-number">0</span>) AS is_lob<font></font>
     , CASE WHEN ds.[type] = 'PS' THEN <span class="hljs-number">1</span> ELSE <span class="hljs-number">0</span> END AS is_partitioned<font></font>
FROM sys.dm_db_index_physical_stats(DB_ID(), <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>) s<font></font>
JOIN sys.partitions p ON s.[object_id] = p.[object_id]<font></font>
                     AND s.index_id = p.index_id<font></font>
                     AND s.partition_number = p.partition_number<font></font>
JOIN sys.indexes i ON i.[object_id] = s.[object_id]<font></font>
                  AND i.index_id = s.index_id<font></font>
LEFT JOIN (<font></font>
    SELECT c.[object_id]<font></font>
         , index_id = ISNULL(i.index_id, <span class="hljs-number">1</span>)<font></font>
         , is_lob_legacy = MAX(CASE WHEN c.system_type_id IN (<span class="hljs-number">34</span>, <span class="hljs-number">35</span>, <span class="hljs-number">99</span>) THEN <span class="hljs-number">1</span> END)<font></font>
         , is_lob = MAX(CASE WHEN c.max_length = -<span class="hljs-number">1</span> THEN <span class="hljs-number">1</span> END)<font></font>
    FROM sys.columns c<font></font>
    LEFT JOIN sys.index_columns i ON c.[object_id] = i.[object_id]<font></font>
                                 AND c.column_id = i.column_id<font></font>
                                 AND i.index_id &gt; <span class="hljs-number">0</span>
    WHERE c.system_type_id IN (<span class="hljs-number">34</span>, <span class="hljs-number">35</span>, <span class="hljs-number">99</span>)<font></font>
        OR c.max_length = -<span class="hljs-number">1</span><font></font>
    GROUP BY c.[object_id], i.index_id<font></font>
) lob ON lob.[object_id] = i.[object_id]<font></font>
     AND lob.index_id = i.index_id<font></font>
JOIN sys.objects o ON o.[object_id] = i.[object_id]<font></font>
JOIN sys.data_spaces ds ON i.data_space_id = ds.data_space_id<font></font>
WHERE i.[type] IN (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<font></font>
    AND i.is_disabled = <span class="hljs-number">0</span>
    AND i.is_hypothetical = <span class="hljs-number">0</span>
    AND s.index_level = <span class="hljs-number">0</span><font></font>
    AND s.alloc_unit_type_desc = 'IN_ROW_DATA'<font></font>
    AND o.[type] IN ('U', 'V')</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç«¶åˆè£½å“ã®åŒã˜ã‚¿ã‚¤ãƒ—ã®ã‚¯ã‚¨ãƒªã®ãƒ™ãƒ¼ãƒ«ã«é–¢ã™ã‚‹ä¸»ãªå•é¡Œã‚’ãªã‚“ã¨ã‹å–ã‚Šé™¤ãã“ã¨ãŒã§ãã¾ã—ãŸãŒã€ã“ã®å®Ÿè£…ã®æ¬ ç‚¹ã¯ã€æ˜ã‚‰ã‹ã«ä¸è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’åˆ¶é™ã§ãã‚‹è¿½åŠ ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒsys.dm_db_index_physical_statsé–¢æ•°ã«æ¸¡ã•ã‚Œãªã„ã“ã¨ã§ã™ã€‚å®Ÿéš›ã€ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚¹ãƒ†ãƒ å†…ã®ã™ã¹ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«é–¢ã™ã‚‹æƒ…å ±ãŒå–å¾—ã•ã‚Œã€ã‚¹ã‚­ãƒ£ãƒ³æ®µéšã§è¿½åŠ ã®ãƒ‡ã‚£ã‚¹ã‚¯è² è·ãŒç™ºç”Ÿã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sys.dm_db_index_physical_statsã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ãƒãƒƒãƒ•ã‚¡ãƒ¼ãƒ—ãƒ¼ãƒ«ã«æ°¸ç¶šçš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œãªã„ãŸã‚ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ–­ç‰‡åŒ–ã«é–¢ã™ã‚‹æƒ…å ±ã‚’å–å¾—ã™ã‚‹éš›ã®ç‰©ç†çš„ãªèª­ã¿å–ã‚Šã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã“ã¨ãŒã€é–‹ç™ºä¸­ã®å„ªå…ˆã‚¿ã‚¹ã‚¯ã®1ã¤ã§ã‚ã£ãŸã“ã¨ã«æ³¨æ„ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã„ãã¤ã‹ã®å®Ÿé¨“ã®å¾Œã€ã‚¹ã‚­ãƒ£ãƒ³ã‚’2ã¤ã®éƒ¨åˆ†ã«åˆ†å‰²ã—ã¦ã€ä¸¡æ–¹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã¾ãšã€1ã¤ã®å¤§ããªã‚¯ã‚¨ãƒªã§ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚µã‚¤ã‚ºãŒæ±ºå®šã•ã‚Œã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç¯„å›²ã«ãªã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒäº‹å‰ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">INSERT INTO <span class="hljs-meta">#AllocationUnits (ContainerID, ReservedPages, UsedPages)</span><font></font>
SELECT [container_id]<font></font>
     , SUM([total_pages])<font></font>
     , SUM([used_pages])<font></font>
FROM sys.allocation_units WITH(NOLOCK)<font></font>
GROUP BY [container_id]<font></font>
HAVING SUM([total_pages]) BETWEEN @MinIndexSize AND @MaxIndexSize</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€ç©ºã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰ã®ä¸è¦ãªèª­ã¿å–ã‚Šæ“ä½œã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã‚’å–å¾—ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">SELECT [object_id]<font></font>
     , [index_id]<font></font>
     , [partition_id]<font></font>
     , [partition_number]<font></font>
     , [rows]<font></font>
     , [data_compression]<font></font>
INTO <span class="hljs-meta">#Partitions</span><font></font>
FROM sys.partitions WITH(NOLOCK)<font></font>
WHERE [object_id] &gt; <span class="hljs-number">255</span>
    AND [rows] &gt; <span class="hljs-number">0</span>
    AND [object_id] NOT IN (SELECT * FROM <span class="hljs-meta">#ExcludeList)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¨­å®šã«å¿œã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ†æã—ãŸã„ã‚¿ã‚¤ãƒ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã¿ãŒå–å¾—ã•ã‚Œã¾ã™ï¼ˆãƒ’ãƒ¼ãƒ—ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼/éã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ãŠã‚ˆã³åˆ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ“ä½œãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ï¼‰ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">INSERT INTO <span class="hljs-meta">#Indexes</span><font></font>
SELECT ObjectID         = i.[object_id]<font></font>
     , IndexID          = i.index_id<font></font>
     , IndexName        = i.[name]<font></font>
     , PagesCount       = a.ReservedPages<font></font>
     , UnusedPagesCount = a.ReservedPages - a.UsedPages<font></font>
     , PartitionNumber  = p.[partition_number]<font></font>
     , RowsCount        = ISNULL(p.[rows], <span class="hljs-number">0</span>)<font></font>
     , IndexType        = i.[type]<font></font>
     , IsAllowPageLocks = i.[allow_page_locks]<font></font>
     , DataSpaceID      = i.[data_space_id]<font></font>
     , DataCompression  = p.[data_compression]<font></font>
     , IsUnique         = i.[is_unique]<font></font>
     , IsPK             = i.[is_primary_key]<font></font>
     , FillFactorValue  = i.[fill_factor]<font></font>
     , IsFiltered       = i.[has_filter]<font></font>
FROM <span class="hljs-meta">#AllocationUnits a</span>
JOIN <span class="hljs-meta">#Partitions p ON a.ContainerID = p.[partition_id]</span><font></font>
JOIN sys.indexes i WITH(NOLOCK) ON i.[object_id] = p.[object_id]<font></font>
                               AND p.[index_id] = i.[index_id] <font></font>
WHERE i.[type] IN (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)<font></font>
    AND i.[object_id] &gt; <span class="hljs-number">255</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®å¾Œã€å°ã•ãªé­”æ³•ãŒå§‹ã¾ã‚Šã¾ã™ã€‚ã™ã¹ã¦ã®å°ã•ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã¤ã„ã¦ã€ã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®å®Œå…¨ãªæŒ‡æ¨™ã‚’ä½¿ç”¨ã—ã¦sys.dm_db_index_physical_statsé–¢æ•°ã‚’ç¹°ã‚Šè¿”ã—å‘¼ã³å‡ºã™ã“ã¨ã«ã‚ˆã‚Šã€æ–­ç‰‡åŒ–ã®ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®šã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">INSERT INTO <span class="hljs-meta">#Fragmentation (ObjectID, IndexID, PartitionNumber, Fragmentation)</span><font></font>
SELECT i.ObjectID<font></font>
     , i.IndexID<font></font>
     , i.PartitionNumber<font></font>
     , r.[avg_fragmentation_in_percent]<font></font>
FROM <span class="hljs-meta">#Indexes i</span><font></font>
CROSS APPLY sys.dm_db_index_physical_stats(@DBID, i.ObjectID, i.IndexID, i.PartitionNumber, 'LIMITED') r<font></font>
WHERE i.PagesCount &lt;= @PreDescribeSize<font></font>
    AND r.[index_level] = <span class="hljs-number">0</span><font></font>
    AND r.[alloc_unit_type_desc] = 'IN_ROW_DATA'<font></font>
    AND i.IndexType IN (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€ã™ã¹ã¦ã®å¯èƒ½ãªæƒ…å ±ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã—ã€ä½™åˆ†ãªãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">SELECT i.ObjectID<font></font>
     , i.IndexID<font></font>
     , i.IndexName<font></font>
     , ObjectName       = o.[name]<font></font>
     , SchemaName       = s.[name]<font></font>
     , i.PagesCount<font></font>
     , i.UnusedPagesCount<font></font>
     , i.PartitionNumber<font></font>
     , i.RowsCount<font></font>
     , i.IndexType<font></font>
     , i.IsAllowPageLocks<font></font>
     , u.TotalWrites<font></font>
     , u.TotalReads<font></font>
     , u.TotalSeeks<font></font>
     , u.TotalScans<font></font>
     , u.TotalLookups<font></font>
     , u.LastUsage<font></font>
     , i.DataCompression<font></font>
     , f.Fragmentation<font></font>
     , IndexStats       = STATS_DATE(i.ObjectID, i.IndexID)<font></font>
     , IsLobLegacy      = ISNULL(lob.IsLobLegacy, <span class="hljs-number">0</span>)<font></font>
     , IsLob            = ISNULL(lob.IsLob, <span class="hljs-number">0</span>)<font></font>
     , IsSparse         = CAST(CASE WHEN p.ObjectID IS <span class="hljs-literal">NULL</span> THEN <span class="hljs-number">0</span> ELSE <span class="hljs-number">1</span> END AS BIT)<font></font>
     , IsPartitioned    = CAST(CASE WHEN dds.[data_space_id] IS NOT <span class="hljs-literal">NULL</span> THEN <span class="hljs-number">1</span> ELSE <span class="hljs-number">0</span> END AS BIT)<font></font>
     , FileGroupName    = fg.[name]<font></font>
     , i.IsUnique<font></font>
     , i.IsPK<font></font>
     , i.FillFactorValue<font></font>
     , i.IsFiltered<font></font>
     , a.IndexColumns<font></font>
     , a.IncludedColumns<font></font>
FROM <span class="hljs-meta">#Indexes i</span><font></font>
JOIN sys.objects o WITH(NOLOCK) ON o.[object_id] = i.ObjectID<font></font>
JOIN sys.schemas s WITH(NOLOCK) ON s.[schema_id] = o.[schema_id]<font></font>
LEFT JOIN <span class="hljs-meta">#AggColumns a ON a.ObjectID = i.ObjectID</span><font></font>
                       AND a.IndexID = i.IndexID<font></font>
LEFT JOIN <span class="hljs-meta">#Sparse p ON p.ObjectID = i.ObjectID</span>
LEFT JOIN <span class="hljs-meta">#Fragmentation f ON f.ObjectID = i.ObjectID</span><font></font>
                          AND f.IndexID = i.IndexID<font></font>
                          AND f.PartitionNumber = i.PartitionNumber<font></font>
LEFT JOIN (<font></font>
    SELECT ObjectID      = [object_id]<font></font>
         , IndexID       = [index_id]<font></font>
         , TotalWrites   = NULLIF([user_updates], <span class="hljs-number">0</span>)<font></font>
         , TotalReads    = NULLIF([user_seeks] + [user_scans] + [user_lookups], <span class="hljs-number">0</span>)<font></font>
         , TotalSeeks    = NULLIF([user_seeks], <span class="hljs-number">0</span>)<font></font>
         , TotalScans    = NULLIF([user_scans], <span class="hljs-number">0</span>)<font></font>
         , TotalLookups  = NULLIF([user_lookups], <span class="hljs-number">0</span>)<font></font>
         , LastUsage     = (<font></font>
                                SELECT MAX(dt)<font></font>
                                FROM (<font></font>
                                    VALUES ([last_user_seek])<font></font>
                                         , ([last_user_scan])<font></font>
                                         , ([last_user_lookup])<font></font>
                                         , ([last_user_update])<font></font>
                                ) t(dt)<font></font>
                           )<font></font>
    FROM sys.dm_db_index_usage_stats WITH(NOLOCK)<font></font>
    WHERE [database_id] = @DBID<font></font>
) u ON i.ObjectID = u.ObjectID<font></font>
   AND i.IndexID = u.IndexID<font></font>
LEFT JOIN <span class="hljs-meta">#Lob lob ON lob.ObjectID = i.ObjectID</span><font></font>
                  AND lob.IndexID = i.IndexID<font></font>
LEFT JOIN sys.destination_data_spaces dds WITH(NOLOCK) ON i.DataSpaceID = dds.[partition_scheme_id]<font></font>
                                                      AND i.PartitionNumber = dds.[destination_id]<font></font>
JOIN sys.filegroups fg WITH(NOLOCK) ON ISNULL(dds.[data_space_id], i.DataSpaceID) = fg.[data_space_id] <font></font>
WHERE o.[type] IN ('V', 'U')<font></font>
    AND (<font></font>
            f.Fragmentation &gt;= @Fragmentation<font></font>
        OR<font></font>
            i.PagesCount &gt; @PreDescribeSize<font></font>
        OR<font></font>
            i.IndexType IN (<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®å¾Œã€ãƒã‚¤ãƒ³ãƒˆã‚¯ã‚¨ãƒªã¯å¤§ããªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ–­ç‰‡åŒ–ã®ãƒ¬ãƒ™ãƒ«ã‚’æ±ºå®šã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="1c hljs">EXEC sp_executesql N'<font></font>
DECLARE @DBID INT = DB_ID()<font></font>
SELECT [avg_fragmentation_in_percent]<font></font>
FROM sys.dm_db_index_physical_stats(@DBID, @ObjectID, @IndexID, @PartitionNumber, ''LIMITED'')<font></font>
WHERE [index_level] = 0<font></font>
    AND [alloc_unit_type_desc] = ''IN_ROW_DATA'''<font></font>
    , N'@ObjectID int,@IndexID int,@PartitionNumber int'<font></font>
    , @ObjectId = <span class="hljs-number">1044198770</span>, @IndexId = <span class="hljs-number">1</span>, @PartitionNumber = <span class="hljs-number">1</span><font></font>
<font></font>
EXEC sp_executesql N'<font></font>
DECLARE @DBID INT = DB_ID()<font></font>
SELECT [avg_fragmentation_in_percent]<font></font>
FROM sys.dm_db_index_physical_stats(@DBID, @ObjectID, @IndexID, @PartitionNumber, ''LIMITED'')<font></font>
WHERE [index_level] = 0<font></font>
    AND [alloc_unit_type_desc] = ''IN_ROW_DATA'''<font></font>
    , N'@ObjectID int,@IndexID int,@PartitionNumber int'<font></font>
    , @ObjectId = <span class="hljs-number">1552724584</span>, @IndexId = <span class="hljs-number">0</span>, @PartitionNumber = <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€ã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆã™ã‚‹ã¨ãã«ã€ç«¶åˆä»–ç¤¾ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ç™ºç”Ÿã—ãŸã‚¹ã‚­ãƒ£ãƒ³ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¯å®Œæˆã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€é–‹ç™ºã®éç¨‹ã§ã€è£½å“ã®é©ç”¨ç¯„å›²ã‚’æ‹¡å¤§ã§ãã‚‹æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå¾ã€…ã«ç¾ã‚Œã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åˆã¯ã€WAIT_AT_LOW_PRIORITYã§ã®ä½œæ¥­ã®ã‚µãƒãƒ¼ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ãŸãŸã‚ã€DATA_COMPRESSIONãŠã‚ˆã³FILL_FACTORã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†æ§‹ç¯‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kd/em/xj/kdemxjo8sj0hxa4y_omvv3dph6a.png" alt="SQLã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®è¨­å®š"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ä»¥å‰ã¯è¨ˆç”»ã•ã‚Œã¦ã„ãªã‹ã£ãŸæ©Ÿèƒ½ã®columntorã¸ã®ã‚µãƒ¼ãƒ“ã‚¹ãªã©ã€å°‘ã—ã°ã‹ã‚Šå¤§ãããªã‚Šã¾ã—ãŸã€‚</font></font><br>
<br>
<pre><code class="1c hljs">SELECT *<font></font>
FROM (<font></font>
    SELECT IndexID          = [index_id]<font></font>
         , PartitionNumber  = [partition_number]<font></font>
         , PagesCount       = SUM([size_in_bytes]) / <span class="hljs-number">8192</span>
         , UnusedPagesCount = ISNULL(SUM(CASE WHEN [state] = <span class="hljs-number">1</span> THEN [size_in_bytes] END), <span class="hljs-number">0</span>) / <span class="hljs-number">8192</span>
         , Fragmentation    = CAST(ISNULL(SUM(CASE WHEN [state] = <span class="hljs-number">1</span> THEN [size_in_bytes] END), <span class="hljs-number">0</span>)<font></font>
                            * <span class="hljs-number">100</span>. / SUM([size_in_bytes]) AS FLOAT)<font></font>
    FROM sys.fn_column_store_row_groups(@ObjectID)<font></font>
    GROUP BY [index_id]<font></font>
           , [partition_number]<font></font>
) t<font></font>
WHERE Fragmentation &gt;= @Fragmentation<font></font>
    AND PagesCount BETWEEN @MinIndexSize AND @MaxIndexSize</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãŸã¯ã€dm_db_missing_indexã‹ã‚‰ã®æƒ…å ±ã«åŸºã¥ã„ã¦éã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åŒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹æ©Ÿèƒ½ï¼š</font></font><br>
<br>
<pre><code class="1c hljs">SELECT ObjectID     = d.[object_id]<font></font>
     , UserImpact   = gs.[avg_user_impact]<font></font>
     , TotalReads   = gs.[user_seeks] + gs.[user_scans]<font></font>
     , TotalSeeks   = gs.[user_seeks]<font></font>
     , TotalScans   = gs.[user_scans]<font></font>
     , LastUsage    = ISNULL(gs.[last_user_scan], gs.[last_user_seek])<font></font>
     , IndexColumns =<font></font>
                CASE<font></font>
                    WHEN d.[equality_columns] IS NOT <span class="hljs-literal">NULL</span> AND d.[inequality_columns] IS NOT <span class="hljs-literal">NULL</span><font></font>
                        THEN d.[equality_columns] + ', ' + d.[inequality_columns]<font></font>
                    WHEN d.[equality_columns] IS NOT <span class="hljs-literal">NULL</span> AND d.[inequality_columns] IS <span class="hljs-literal">NULL</span><font></font>
                        THEN d.[equality_columns]<font></font>
                    ELSE d.[inequality_columns]<font></font>
                END<font></font>
     , IncludedColumns = d.[included_columns]<font></font>
FROM sys.dm_db_missing_index_groups g WITH(NOLOCK)<font></font>
JOIN sys.dm_db_missing_index_group_stats gs WITH(NOLOCK) ON gs.[group_handle] = g.[index_group_handle]<font></font>
JOIN sys.dm_db_missing_index_details d WITH(NOLOCK) ON g.[index_handle] = d.[index_handle]<font></font>
WHERE d.[database_id] = DB_ID()</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¦‚è¦</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç©æ¥µçš„ãªé–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã®6ã‹æœˆå¾Œã€ã“ã®è£½å“ã‚’é–‹ç™ºã—ç¶šã‘ãŸã„ã®ã§ã€è¨ˆç”»ãŒãã“ã§çµ‚ã‚ã‚‰ãªã„ã“ã¨ã‚’å¬‰ã—ãæ€ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€é‡è¤‡ã¾ãŸã¯æœªä½¿ç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œç´¢ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã¨ã€SQL Serverå†…ã§çµ±è¨ˆã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®æœ¬æ ¼çš„ãªã‚µãƒãƒ¼ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¾åœ¨ã€å¤šãã®æœ‰æ–™ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¸‚å ´ã«ã‚ã‚‹ã¨ã„ã†äº‹å®Ÿã«åŸºã¥ã„ã¦ã€ç„¡æ–™ã®ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã€ã‚ˆã‚Šæœ€é©åŒ–ã•ã‚ŒãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª¬æ˜ã€ãŠã‚ˆã³èª°ã‹ã«ã¨ã£ã¦ã•ã¾ã–ã¾ãªä¾¿åˆ©ãªå°ã•ãªã‚‚ã®ã®å­˜åœ¨ã«ã‚ˆã‚Šã€ã“ã®è£½å“ã¯æ—¥å¸¸æ¥­å‹™ã§é–“é•ã„ãªãå½¹ç«‹ã¤ã¨ä¿¡ã˜ã¦ã„ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHubã‹ã‚‰</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ã</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;">ã¾ã™</font></b></a><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ã‚½ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459898/index.html">è¨ˆç”»ã¯çµŒæ¸ˆã«æˆ»ã£ãŸ</a></li>
<li><a href="../ja459900/index.html">Seabornãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦DataFrameã‹ã‚‰åˆ—ã‚’è¦–è¦šåŒ–ã™ã‚‹</a></li>
<li><a href="../ja459902/index.html">åˆå¿ƒè€…ã®ãŸã‚ã®ãƒ­ã‚·ã‚¢ã®åœ°åŸŸã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ—ã€‚ç§ãŒã—ãŸã€ã‚ãªãŸãŒã—ã¦ã¯ã„ã‘ãªã„é–“é•ã„</a></li>
<li><a href="../ja459906/index.html">Tic Tac Toeãƒ‘ãƒ¼ãƒˆ3ï¼šã‚³ãƒãƒ³ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ãŸå…ƒã«æˆ»ã™/ã‚„ã‚Šç›´ã—</a></li>
<li><a href="../ja459910/index.html">çŠ¶æ³ï¼šä¼æ¥­ã¯éŸ³å£°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå‘ã‘ã®ã‚µãƒ¼ãƒ“ã‚¹ã®é–‹ç™ºã‚’æ€¥ã„ã§ã„ã¾ã›ã‚“-ãƒªã‚¹ã‚¯ã¯ä½•ã§ã™ã‹</a></li>
<li><a href="../ja459918/index.html">pwnable.kr 03ã«ã‚ˆã‚‹å•é¡Œè§£æ±º-bofã€‚ã‚¹ã‚¿ãƒƒã‚¯ã§ã®ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼</a></li>
<li><a href="../ja459920/index.html">ã€Œéé€šä¿¡å®šç†ã€ã‚’å›é¿ã™ã‚‹æ–¹æ³•ã¯ï¼Ÿæ™‚ç©ºã‚’è¶…ãˆãŸæƒ…å ±ä¼é”</a></li>
<li><a href="../ja459922/index.html">ãƒ™ã‚¢ãƒªãƒ³ã‚°ã®æŒ¯å‹•è¨ºæ–­ä¸­ã«æŒ¯å‹•ã‚»ãƒ³ã‚µãƒ¼ã®ä¿¡å·ã‹ã‚‰é«˜å‘¨æ³¢ãƒã‚¤ã‚ºã‚’é™¤å»</a></li>
<li><a href="../ja459924/index.html">Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆã®å…¨ã‚µã‚¤ã‚¯ãƒ«ã€‚Auto.ruã‚’å ±å‘Šã™ã‚‹</a></li>
<li><a href="../ja459928/index.html">å­¦ç”Ÿã®ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™ºã¸ã®é“ã®ã‚Š</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>