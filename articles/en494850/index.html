<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßìüèø üåõ üôÑ Configure Microsoft Windows Server 2016/2019 to provide DHCP services for VXLAN (DFA) ü¶ñ üöÆ üï†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of this article is to simplify the configuration of the DHCP service for the VXLAN BGP EVPN and DFA factory using Microsoft Windows Server...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Configure Microsoft Windows Server 2016/2019 to provide DHCP services for VXLAN (DFA)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494850/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The purpose of this article is to simplify the configuration of the DHCP service for the VXLAN BGP EVPN and DFA factory using Microsoft Windows Server 2016/2019.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rd/1s/iz/rd1sizzcvjahwoqt9cpr8u149ec.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the official documentation, the DHCP service based on Microsoft Windows Server 2012 for the factory is configured as SuperScope containing the Loopback pool (in this pool, the highlight is the exclusion from the pool of all pool IP addresses (excluded IP address = pool)) and IP address issuing pools for real networks (here is the highlight - the policy is configured - in which the DHCP Relay Circuit ID is filtered and this DHCP relay Circuit ID contains the VNI for the network, that is, for another pool this DHCP Relay Circuit ID will be slightly different). </font></font><br>
<br>
<pre><code class="plaintext hljs">To configure DHCP on Windows server. <font></font>
<font></font>
1. Create a super scope. Within the super scope, create scope B, S1, S2, S3, ‚Ä¶, Sn for the subnet B and the subnets for each segment. <font></font>
2. In scope B,  specify the 'Exclusion Range' to be the entire address range (so that the offered address range must not be from this scope). <font></font>
3. For every segment scope Si, specify a policy that matches on Agent Circuit ID with value of '0108000600XXXXXX', where '0108000600' is a fixed value for all segments, the 6 numbers "XXXXXX" is the segment ID value in hexadecimal. Also ensure to check the Append wildcard(*) check box. <font></font>
4. Set the policy address range to the entire range of the scope.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article answers the following questions:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why are Microsoft Windows Server 2000/2003/2008 not supported?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why is configuration so complicated in Microsoft Windows Server 2012?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How easy is setup in Microsoft Windows Server 2016/2019?</font></font></a></li>
</ul><a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Content</font></font></b><div class="spoiler_text"><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How DHCP Relay is configured in the VXLAN BGP EVPN factory</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFCs used in DHCP Relay from VXLAN BGP EVPN factory</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  Cisco    DHCP  Microsoft Windows Server 2012</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">DHCP  Microsoft Windows Server</a> (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">superscope</a> &amp; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">policy</a>)</li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   Microsoft Windows Server 2000/2003/2008?</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  Microsoft Windows Server 2012   ?</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Microsoft Windows Server 2016/2019?</a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> DHCP   Microsoft Windows Server 2019</a></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a></li>
</ul></div></div><a name="introduction"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This part briefly lists all the initial data: Instructions for setting up network equipment, RFCs used in DHCP packets in eVPN factories, the evolution of DHCP server settings on Microsoft Windows Server 2012 in the Cisco documentation is provided for reference. </font><font style="vertical-align: inherit;">As well as brief information about Superscope and Policy in the DHCP service on Microsoft Windows Server servers.</font></font><br>
<a name="ConfigurationNexusDHCPRelay"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How DHCP Relay is configured in the VXLAN BGP EVPN, DFA factory</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuring DHCP Relay in the VXLAN BGP factory EVPN is not the main topic of this article, because it is quite simple. </font><font style="vertical-align: inherit;">I provide links to documentation and a spoiler for settings on network equipment.</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nexus 9000 VXLAN Configuration Guide 7.X </font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nexus 9000 VXLAN Configuration Guide 9.3</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DFA (Cisco Dynamic Fabric Automation)</font></font></a></li>
</ul><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DHCP Relay setup example on Nexus 9000V v9.2 (3)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">service dhcp<font></font>
ip dhcp relay<font></font>
ip dhcp relay information option<font></font>
ip dhcp relay information option vpn<font></font>
interface loopback10<font></font>
  vrf member VRF1<font></font>
  ip address 10.120.0.1/32 tag 1234567<font></font>
interface Vlan12<font></font>
  no shutdown<font></font>
  vrf member VRF1<font></font>
  no ip redirects<font></font>
  ip address 10.120.251.1/24 tag 1234567<font></font>
  no ipv6 redirects<font></font>
  fabric forwarding mode anycast-gateway<font></font>
  ip dhcp relay address 10.0.0.5<font></font>
  ip dhcp relay source-interface loopback10<font></font>
</code></pre><br>
</div></div><br>
<a name="RFCDHCPRelayVXLAN"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFCs implemented in the operation of the DHCP Relay service in VXLAN BGP EVPN factories</font></font></h4><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> RFC,  Nexus 9000 v9.3</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> RFC, Nexus 9000 v7.x</a></li>
</ul><br>
<div class="spoiler"><b class="spoiler_title">RFC#6607: Sub-option 151(0x97) - Virtual Subnet Selection</b><div class="spoiler_text"><pre><code class="plaintext hljs">‚Ä¢	Sub-option 151(0x97) - Virtual Subnet Selection (Defined in RFC#6607)<font></font>
Used to convey VRF related information to the DHCP server in an MPLS-VPN and VXLAN EVPN multi-tenant environment.</code></pre><br>
 ¬´¬ª VRF    .<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title">RFC#5107: Sub-option 11(0xb) - Server ID Override</b><div class="spoiler_text"><pre><code class="plaintext hljs">‚Ä¢	Sub-option 11(0xb) - Server ID Override (Defined in RFC#5107.) <font></font>
The server identifier (server ID) override sub-option allows the DHCP relay agent to specify a new value for the server ID option, which is inserted by the DHCP server in the reply packet. This sub-option allows the DHCP relay agent to act as the actual DHCP server such that the renew requests will come to the relay agent rather than the DHCP server directly. The server ID override sub-option contains the incoming interface IP address, which is the IP address on the relay agent that is accessible from the client. Using this information, the DHCP client sends all renew and release request packets to the relay agent. The relay agent adds all of the appropriate sub-options and then forwards the renew and release request packets to the original DHCP server. For this function, Cisco‚Äôs proprietary implementation is sub-option 152(0x98). You can use the ip dhcp relay sub-option type cisco command to manage the function.</code></pre><br>
   ,          IP     . ( Cisco VXLAN BGP EVPN ‚Äì  Anycast      .)<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title">RFC#3527: Sub-option 5(0x5) - Link Selection</b><div class="spoiler_text"><pre><code class="plaintext hljs">Sub-option 5(0x5) - Link Selection (Defined in RFC#3527.) <font></font>
<font></font>
The link selection sub-option provides a mechanism to separate the subnet/link on which the DHCP client resides from the gateway address (giaddr), which can be used to communicate with the relay agent by the DHCP server. The relay agent will set the sub-option to the correct subscriber subnet and the DHCP server will use that value to assign an IP address rather than the giaddr value. The relay agent will set the giaddr to its own IP address so that DHCP messages are able to be forwarded over the network. For this function, Cisco‚Äôs proprietary implementation is sub-option 150(0x96). You can use the ip dhcp relay sub-option type ciscocommand to manage the function.</code></pre><br>
 ,     IP .<br>
</div></div><br>
<a name="CiscoDocumentationEvalution"></a><br>
<h4>  Cisco    DHCP  Microsoft Windows Server 2012<br>
</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I included this section because there is a positive tendency on the part of the vendor: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nexus 9000 VXLAN Configuration Guide 7.3</font></font></a> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The documentation only shows the DHCP Relay setting on the network equipment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another article was used to configure DHCP on Windows Server 2012: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring Microsoft Windows Server 2012 to provide DHCP services in an eVPN Scenario (VXLAN, Cisco One Fabric, etc)</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This article indicates that each network / VNI needs its own SuperScope bundle and its own own set of Loopback addresses:</font></font><br>
<br>
<pre><code class="plaintext hljs">If multiple DHCP Scopes are required for multiple subnets, you need to create one LoopbackX per subnet/vlan on all LEAFS and create a superscope with a loopbackX range scope and actual client IP subnet scope per vlan.</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nexus 9000 VXLAN Configuration Guide 9.3</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Added Windows 2012 Server settings to the documentation for configuring network equipment. </font><font style="vertical-align: inherit;">For all used address pools, one SuperScope per data center is required and this SuperScope is the data center boundary:</font></font><br>
<br>
<pre><code class="plaintext hljs">Create Superscope for all scopes you want to use for Option 82-based policies.<font></font>
Note<font></font>
The Superscope should combine all scopes and act as the administrative boundary.</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cisco Dynamic Fabric Automation</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Very comprehensively talked about everything:</font></font><br>
<br>
<pre><code class="plaintext hljs">Let us assume the switch is using the address from subnet B (it can be the backbone subnet, management subnet, or any customer designated subnet for this purpose) to communicate with the Windows DHCP server. In DFA we have subnets S1, S2, S3, ‚Ä¶, Sn for segment s1, s2, s3, ‚Ä¶, sn. <font></font>
<font></font>
To configure DHCP on Windows server. <font></font>
<font></font>
1. Create a super scope. Within the super scope, create scope B, S1, S2, S3, ‚Ä¶, Sn for the subnet B and the subnets for each segment. <font></font>
2. In scope B,  specify the 'Exclusion Range' to be the entire address range (so that the offered address range must not be from this scope). <font></font>
3. For every segment scope Si, specify a policy that matches on Agent Circuit ID with value of '0108000600XXXXXX', where '0108000600' is a fixed value for all segments, the 6 numbers "XXXXXX" is the segment ID value in hexadecimal. Also ensure to check the Append wildcard(*) check box. <font></font>
4. Set the policy address range to the entire range of the scope.<font></font>
</code></pre><br>
<a name="DHCPSuperScopeAndPolicy"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DHCP on Microsoft Windows Server (superscope &amp; policy)</font></font></h4><br>
<a name="DHCPSuperScope"></a><h4><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Superscope</font></font></a></h4><br>
<pre><code class="plaintext hljs">Superscope is an administrative feature of a DHCP server that can be used to group multiple scopes as a single administrative entity. Superscope allows a DHCP server to provide leases from more than one scope to clients on a single physical network. Scopes added to a superscope are called member scopes.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is SuperScope? This is a feature that allows you to combine several pools of IP addresses into one administrative unit. </font><font style="vertical-align: inherit;">To announce to users in the same physical network (in one VLAN) ip addresses from several pools. </font><font style="vertical-align: inherit;">If the request came to the address pool as part of SuperScope, then you can issue the client an address from another Scope included in this SuperScope.</font></font><br>
<a name="DHCPPolicy"></a><br>
<h4><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Policy</font></font></a></h4><br>
<pre><code class="plaintext hljs">The DHCP Server role in Windows Server 2012 introduces a new feature that allows you to create IPv4 policies that specify custom IP address and option assignments for DHCP clients based on a set of conditions.<font></font>
<font></font>
The policy based assignment (PBA) feature allows you to group DHCP clients by specific attributes based on fields contained in the DHCP client request packet. PBA enables targeted administration and greater control of the configuration parameters delivered to network devices with DHCP.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Policies - allow users to assign IP addresses depending on the type of user or parameter. </font><font style="vertical-align: inherit;">Cisco engineers use policies in Windows Server 2012 to filter by VNI (Virtual Network Identifier).</font></font><br>
<a name="Common"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Main part</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this section, the results of research are carried out, why it is not supported, how it works (logic), what is new and how this new will help us.</font></font><br>
<a name="WhyVXLANDHCPRelayDoNotSupportWindows2008andEarley"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why is Microsoft Windows Server 2000/2003/2008 not supported?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Microsoft Windows Server 2008 and earlier do not handle option 82 (Option 82) and send the return packet without option 82. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Win2k8 R2 DHCP problem with Option82</font></font></a><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A request from the client is sent to Broadcast (DHCP Discover).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equipment (Nexus) sends a packet to a DHCP server (DHCP Discover + Option 82).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The DHCP server accepts the packet, processes it, sends it back, but without option 82. (DHCP Offer - without option 82)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equipment (Nexus) receives a packet from a DHCP server. </font><font style="vertical-align: inherit;">(DHCP Offer) But does not send this packet to the end user.</font></font></li>
</ol><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sniffer data - on Windows Server 2008 and on the DHCP client</font></font></b><div class="spoiler_text">Windows Server 2008     . (Option 82   )<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5t/6y/f1/5t6yf11x4wzzkq40ugc0npkvmiq.png"></div><br>
Windows Server 2008     . (Option 82      )<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cz/tk/la/cztklab6ehf-mq5culrwuvzt9bk.png"></div><br>
   ‚Äì  DHCP Discover   DHCP Offer<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/mu/o9/72/muo972vrkbrrfriqbcayclmzwtq.png"></div><br>
   :<br>
<br>
<pre><code class="plaintext hljs">NEXUS-9000V-SW-1# show ip dhcp relay statistics <font></font>
----------------------------------------------------------------------<font></font>
Message Type             Rx              Tx           Drops  <font></font>
----------------------------------------------------------------------<font></font>
Discover                  8               8               0<font></font>
Offer                     8               8               0<font></font>
Request(*)                0               0               0<font></font>
Ack                       0               0               0<font></font>
Release(*)                0               0               0<font></font>
Decline                   0               0               0<font></font>
Inform(*)                 0               0               0<font></font>
Nack                      0               0               0<font></font>
----------------------------------------------------------------------<font></font>
Total                    16              16               0<font></font>
----------------------------------------------------------------------<font></font>
<font></font>
DHCP L3 FWD:<font></font>
Total Packets Received                           :         0<font></font>
Total Packets Forwarded                          :         0<font></font>
Total Packets Dropped                            :         0<font></font>
Non DHCP:<font></font>
Total Packets Received                           :         0<font></font>
Total Packets Forwarded                          :         0<font></font>
Total Packets Dropped                            :         0<font></font>
DROP:<font></font>
DHCP Relay not enabled                           :         0<font></font>
Invalid DHCP message type                        :         0<font></font>
Interface error                                  :         0<font></font>
Tx failure towards server                        :         0<font></font>
Tx failure towards client                        :         0<font></font>
Unknown output interface                         :         0<font></font>
Unknown vrf or interface for server              :         0<font></font>
Max hops exceeded                                :         0<font></font>
Option 82 validation failed                      :         0<font></font>
Packet Malformed                                 :         0<font></font>
Relay Trusted port not configured                :         0<font></font>
DHCP Request dropped on MCT                      :         0<font></font>
*  -  These counters will show correct value when switch <font></font>
receives DHCP request packet with destination ip as broadcast<font></font>
address. If request is unicast it will be HW switched<font></font>
NEXUS-9000V-SW-1#</code></pre></div></div><br>
<a name="WhyWindows2012DHCPSoHardToConfigure"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why is configuration so complicated in Microsoft Windows Server 2012?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Microsoft Windows Server 2012, RFC # 3527 (Option 82 Sub-option 5 (0x5) - Link Selection) is not yet supported, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
but the Policy functionality has already been implemented. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How it works:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft Windows Server 2012 has a super pool (SuperScope) in which there are Loopback addresses and pools for real networks.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The choice of the pool for issuing the IP address falls into SuperScope, because the response came from DHCP Relay from the Source Loopback address included in SuperScope.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using a Policy request, it selects from Superscope the member scope whose VNI is contained in Option 82 Suboption 1 Agent Circuit ID. </font><font style="vertical-align: inherit;">(‚Äú0108000600‚Äù + 24 VNI bits + 24 bits whose values ‚Äã‚ÄãI do not know, but the sniffer shows the values ‚Äã‚Äã0 in this field.)</font></font></li>
</ul><br>
<a name="howsimplifiedsetupwindows20162019"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How easy is setup in Microsoft Windows Server 2016/2019?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Microsoft Windows Server 2016 implements RFC # 3527 functionality. </font><font style="vertical-align: inherit;">That is, Windows Server 2016 can recognize the correct network from the Option 82 Sub-option 5 (0x5) attribute - Link Selection </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 questions arise right away:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can we do without Superscope?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can we do without Policy and translating VNI into a hexadecimal form?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can we do without Scope for Loopback DHCP Source addresses?</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Can we do without Superscope? </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yes, scope can be created immediately in the scope of IPv4 addresses. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Can we do without Policy and translating VNI into a hexadecimal form? </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yes, network selection is based on Option 82 Suboption 0x5, </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Can we do without Scope for Loopback DHCP Source addresses? </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No, we cannot. </font><font style="vertical-align: inherit;">Since Microsoft Windows Server 2016/2019 has protection against malicious DHCP requests. </font><font style="vertical-align: inherit;">That is, all requests from addresses that are not in the DHCP server pool are considered malicious. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DHCP Subnet Selection Options</font></font></a><br>
<br>
<pre><code class="plaintext hljs"> Note<font></font>
All relay agent IP addresses (GIADDR) must be part of an active DHCP scope IP address range. Any GIADDR outside of the DHCP scope IP address ranges is considered a rogue relay and Windows DHCP Server will not acknowledge DHCP client requests from those relay agents.<font></font>
<font></font>
A special scope can be created to "authorize" relay agents. Create a scope with the GIADDR (or multiple if the GIADDR's are sequential IP addresses), exclude the GIADDR address(es) from distribution, and then activate the scope. This will authorize the relay agents while preventing the GIADDR addresses from being assigned.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Those. </font><font style="vertical-align: inherit;">To configure a DHCP pool on a Microsoft Windows Server 2016/2019 DHCP pool for a VXLAN BGP EVPN factory, you only need:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a pool for Source Relay addresses.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a pool for client networks</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is not necessary (but you can configure it and it will work, and will not interfere with work):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create Policy</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create SuperScope</font></font></li>
</ul><br>
<a name="windows20162019dhcpexample"></a><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example</font></font></b><div class="spoiler_text">  DHCP  ( 2   DHCP ‚Äî    VXLAN )<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jq/n0/r1/jqn0r1fwp2dbkq_4qmijzcxbwqs.png"></div><br>
   :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yl/5g/7t/yl5g7tplibicy0kp61f9cnyeipc.png"></div><br>
    (  ‚Äî          ):<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/8o/nj/-s/8onj-sel5gh9rd7eehvqmfb0fku.png"></div><br>
    Source  DHCP Relay (         ):<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ov/m2/ap/ovm2apghdwv3d28oh1d3pl5exoe.png"></div></div></div><br>
<a name="windows20162019dhcpsetup"></a><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure DHCP service on Microsoft Windows Server 2019</font></font></b><div class="spoiler_text"><h4>   Loopback  (source)  DHCP Relay.</h4><br>
   (Scope)   IPv4.<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ld/ln/8y/ldln8ynsyur3ioujxiblk7vi8ne.png"></div><br>
  . ¬´Next &gt;¬ª<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_m/ka/ex/_mkaexct0-lfkgthcgpohowcry8.png"></div><br>
     (Description) .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nl/a9/i-/nla9i-age-j6flpyjiot1-ebxri.png"></div><br>
  IP   Loopback    .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/u4/ra/nl/u4ranlgomumqmvnpsrbchoim-yq.png"></div><br>
 .        .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/up/vl/xg/upvlxgvlm3oytebmehhekh8cvou.png"></div><br>
 . ¬´Next &gt;¬ª<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/9y/27/bd/9y27bda17opodckel-naed9_jde.png"></div><br>
:   DHCP   (DNS, WINS, Gateway, Domain)    .    ,     .               .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ob/ho/lq/obholqozhdhsjgpwwyqngsbqrbq.png"></div><br>
,    ,   . ¬´Finish¬ª<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jn/nz/6o/jnnz6oexdz9rcask-nlahgl5sa4.png"></div><br>
  . ‚Äî  Scope     ‚Äî  ¬´Activate¬ª. <br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gl/nq/z2/glnqz2ua4j7vjal7ufm48nz5uks.png"></div><br>
<h4>   /.</h4><br>
  .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4k/m_/yr/4km_yrndaqm5usjactwxzmilywm.png"></div><br>
  . ¬´Next &gt;¬ª<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_5/ky/6c/_5ky6c-a8pqm7c-5uxsvhyq4mxk.png"></div><br>
     (Description) .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/76/1a/bj/761abjdaiooqbbagwgpxrx4vc6y.png"></div><br>
  IP   Loopback    .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/8a/xe/4q/8axe4q9kqynymfclcgeo9ongfae.png"></div><br>
 . (    ) ¬´Next &gt;¬ª<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lg/kk/4e/lgkk4eu2iickwyzbgd8dnm4c67i.png"></div><br>
 . ¬´Next &gt;¬ª<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/8k/ed/ua/8keduaoxmfiudot-bxiygmqwwww.png"></div><br>
:   DHCP   (DNS, WINS, Gateway, Domain)    .   .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3b/dj/6w/3bdj6whbzubdwfsxr4cvloxbp1k.png"></div><br>
    .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/o7/bk/3z/o7bk3z17h-8y7fgvy-zqukqb1-y.png"></div><br>
    DNS .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ea/jt/pa/eajtpavrwb869r3jo2lwt3rcwww.png"></div><br>
 IP  WINS .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ob/4v/tc/ob4vtclgce3z38hgk2xhnp_duxm.png"></div><br>
 Scope.<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/95/m0/ka/95m0ka3laeg0jov4rfjkukkzxbe.png"></div><br>
 . ¬´Finish¬ª<br>
<br>
<img src="https://habrastorage.org/webt/im/d4/fu/imd4fuo66097rlxxc16cj1w2we8.png"><br>
</div></div><br>
<a name="finale"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using Windows Server 2016/2019 reduces the complexity of configuring a DHCP server for a VXLAN factory (or any other factory). </font><font style="vertical-align: inherit;">(It is not required to transfer IT specialists special bundles: Network / Agent Circuit ID for prescribing filters.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Will the configuration for Windows Server 2012 work on the new servers 2016/2019 - let it work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This document provides links to 2 versions: 7.X and 9.3. </font><font style="vertical-align: inherit;">This is due to the fact that version 7.0 (3) I7 (7) is the Cisco Suggested release, and version 9.3 is the most innovative (up to the support of Multicast via VXLAN Multisite).</font></font><br>
<a name="listofsources"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">List of sources</font></font></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nexus 9000 VXLAN Configuration Guide 7.x</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nexus 9000 VXLAN Configuration Guide 9.3</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DFA (Cisco Dynamic Fabric Automation)</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring Microsoft Windows Server 2012 to provide DHCP services in an eVPN Scenario (VXLAN, Cisco One Fabric, etc)</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.4 DHCP Superscopes</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction to DHCP Policies</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Win2k8 R2 DHCP problem with Option82</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DHCP Subnet Selection Options</font></font></a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494824/index.html">How the content system of Turbo pages is arranged: schemes, facts and a bit of history</a></li>
<li><a href="../en494826/index.html">To be ‚Äúnew‚Äù or not to be ...</a></li>
<li><a href="../en494830/index.html">ViennaNET: a set of libraries for the backend</a></li>
<li><a href="../en494838/index.html">GSM / 3G / 4G modems in embedded systems using the Quectel EC21 LTE modem and Yocto Project as an example</a></li>
<li><a href="../en494848/index.html">15 women who have made a great contribution to astronomy</a></li>
<li><a href="../en494854/index.html">Security Week 14: pandemic privacy</a></li>
<li><a href="../en494856/index.html">Test assessment: how to calculate the exact time to test the system or "When will the tests be ready ?!"</a></li>
<li><a href="../en494858/index.html">Remote for business. We show, tell, connect</a></li>
<li><a href="../en494860/index.html">How is the production of sticks for testing for coronavirus</a></li>
<li><a href="../en494862/index.html">We optimize the memory of the Rails service (real case)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>