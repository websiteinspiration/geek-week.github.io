<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐵 🔯 📼 Aviasales API integration with Amazon Kinesis and serverless simplicity 🧔🏾 🤜 👨🏼‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 
 
 Do you like to fly airplanes? I love it, but on self-isolation I also liked to analyze the airfare data of one well-known resource - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Aviasales API integration with Amazon Kinesis and serverless simplicity</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500382/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do you like to fly airplanes? </font><font style="vertical-align: inherit;">I love it, but on self-isolation I also liked to analyze the airfare data of one well-known resource - Aviasales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today we will analyze the work of Amazon Kinesis, build a streaming system with real-time analytics, put the Amazon DynamoDB NoSQL database as the main data warehouse and set up SMS alerts for interesting tickets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All the details under the cut! </font><font style="vertical-align: inherit;">Go!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/-n/qn/yn/-nqnynmwzv61pmiq2ocatoxseme.jpeg"></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we need access to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Aviasales API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Access to it is provided free of charge and without restrictions, you only need to register in the "Developers" section to get your API token for accessing data.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The main purpose of this article is to give a general understanding of the use of streaming information in AWS, we make it out of the question that the data returned by the API used is not strictly relevant and is transferred from the cache, which is generated based on searches of users of the Aviasales.ru and Jetradar.com sites for last 48 hours. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Kinesis-agent ticket data received through the API installed on the producer machine will be automatically parsed and transferred to the desired stream through Kinesis Data Analytics. </font><font style="vertical-align: inherit;">An unprocessed version of this stream will be written directly to the repository. </font><font style="vertical-align: inherit;">Deployed in DynamoDB storage of raw data will allow for a more in-depth analysis of tickets through BI tools, such as AWS Quick Sight. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will consider two options for deploying the entire infrastructure:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual - through the AWS Management Console;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastructure from Terraform code - for lazy automation engineers;</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture of the system under development</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vt/ss/mx/vtssmx0accvfcphkjvmzwdf4udg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Components Used:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviasales API</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the data returned by this API will be used for all subsequent work;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EC2 Producer Instance</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a regular virtual machine in the cloud on which the input data stream will be generated:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kinesis Agent</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a locally installed Java application that provides an easy way to collect and send data to Kinesis (Kinesis Data Streams or Kinesis Firehose). </font><font style="vertical-align: inherit;">The agent constantly monitors a set of files in the specified directories and sends new data to Kinesis;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caller API Script</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a Python script that makes API requests and puts the response in a folder that Kinesis Agent monitors;</font></font></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b>Kinesis Data Streams</b></a> —            ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b>Kinesis Analytics</b></a> —  ,        . Amazon Kinesis Data Analytics              ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b>AWS Lambda</b></a> — ,        .        ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b>Amazon DynamoDB</b></a> —    «‑»  ,     10      .   DynamoDB    - ,       . DynamoDB   ,        .       ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b>Amazon SNS</b></a> —        « — » (Pub/Sub),      ,     . SNS           push-, SMS-   .</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initial training</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To emulate the data stream, I decided to use the airfare information returned by the Aviasales API. </font><font style="vertical-align: inherit;">The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation has a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fairly extensive list of different methods, take one of them - the “Price Calendar for the Month”, which returns prices for each day of the month, grouped by the number of transfers. </font><font style="vertical-align: inherit;">If you do not transmit the search month in the request, information will be returned for the month following the current one. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, register, get your token. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example request below:</font></font><br>
<br>
<pre><code class="bash hljs">http://api.travelpayouts.com/v2/prices/month-matrix?currency=rub&amp;origin=LED&amp;destination=HKT&amp;show_to_affiliates=<span class="hljs-literal">true</span>&amp;token=TOKEN_API</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The above method of receiving data from the API with the token in the request will work, but I prefer to pass the access token through the header, so we will use this method in the api_caller.py script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Answer example:</font></font><br>
<br>
<pre><code class="json hljs">{{
   <span class="hljs-attr">"success"</span>:<span class="hljs-literal">true</span>,
   <span class="hljs-attr">"data"</span>:[{
      <span class="hljs-attr">"show_to_affiliates"</span>:<span class="hljs-literal">true</span>,
      <span class="hljs-attr">"trip_class"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-attr">"origin"</span>:<span class="hljs-string">"LED"</span>,
      <span class="hljs-attr">"destination"</span>:<span class="hljs-string">"HKT"</span>,
      <span class="hljs-attr">"depart_date"</span>:<span class="hljs-string">"2015-10-01"</span>,
      <span class="hljs-attr">"return_date"</span>:<span class="hljs-string">""</span>,
      <span class="hljs-attr">"number_of_changes"</span>:<span class="hljs-number">1</span>,
      <span class="hljs-attr">"value"</span>:<span class="hljs-number">29127</span>,
      <span class="hljs-attr">"found_at"</span>:<span class="hljs-string">"2015-09-24T00:06:12+04:00"</span>,
      <span class="hljs-attr">"distance"</span>:<span class="hljs-number">8015</span>,
      <span class="hljs-attr">"actual"</span>:<span class="hljs-literal">true</span><font></font>
   }]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The API response example above shows a ticket from St. Petersburg to Phuk ... Oh, what to dream of ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since I'm from Kazan, and Phuket is "just dreaming about us" now, we will look for tickets from St. Petersburg to Kazan.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is assumed that you already have an AWS account. </font><font style="vertical-align: inherit;">I want to pay special attention right away that Kinesis and sending notifications via SMS are not included in the annual </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Free Tier (free use)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But even despite this, having a couple of dollars in mind, it is quite possible to build the proposed system and play with it. </font><font style="vertical-align: inherit;">And, of course, do not forget to delete all resources after they become unnecessary.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fortunately, DynamoDb and lambda functions will be shareware for us if you keep within the monthly free limits. </font><font style="vertical-align: inherit;">For example, for DynamoDB: 25 GB of storage, 25 WCU / RCU and 100 million requests. </font><font style="vertical-align: inherit;">And a million calls to lambda functions per month.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual deployment system</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up Kinesis Data Streams</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to the Kinesis Data Streams service and create two new streams, one shard for each.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a shard?</font></font></b>
                        <div class="spoiler_text"> —       Amazon Kinesis.         1 /       2 /.     1000  PUT  .         . ,       .          2 /       4 /    2000  PUT  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The more shards in your stream, the greater its throughput. </font><font style="vertical-align: inherit;">In principle, streams are scaled this way by adding shards. </font><font style="vertical-align: inherit;">But the more shards you have, the higher the price. </font><font style="vertical-align: inherit;">Each shard costs 1.5 cents per hour and an additional 1.4 cents for every million PUT payload units. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a new thread with the name </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">airline_tickets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , 1 shard will be enough for it:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f8/5p/jg/f85pjg59pxlsbjio2_yzpz1wng4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now create another stream called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4l/_t/eo/4l_teoxvvwv5pablkpfnv-tlnac.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Producer Setting</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a data producer for parsing a task, it is enough to use a regular EC2 instance. </font><font style="vertical-align: inherit;">It does not have to be a powerful expensive virtual machine; spot t2.micro is quite suitable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important note: for example, you should use image - Amazon Linux AMI 2018.03.0, with it there are fewer settings to quickly launch the Kinesis Agent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to the EC2 service, create a new virtual machine, select the desired AMI with the t2.micro type, which is included in Free Tier:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3q/rg/gt/3qrggtrxqistnkvgzn0bwkfdvbk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for the newly created virtual machine to be able to interact with the Kinesis service, you must give it the right to do so. </font><font style="vertical-align: inherit;">The best way to do this is to assign an IAM Role. </font><font style="vertical-align: inherit;">Therefore, on the Step 3: Configure Instance Details screen, select </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create new IAM Role</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating IAM Roles for EC2</font></font></b>
                        <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/_p/rm/xv/_prmxvgp0iv148grjwdpunwaela.jpeg"></div><br>
  , ,      EC2     Permissions:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/as/nn/zvasnnl8ootjsr6rojjfhmjtfiw.jpeg"></div><br>
             ,     : AmazonKinesisFullAccess  CloudWatchFullAccess.<br>
<br>
 -     , : EC2-KinesisStreams-FullAccess.  ,     ,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/rj/38/jhrj38s8czngu9ri77mu26lh_o0.jpeg"></div><br>
    ,         :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yn/he/23/ynhe23lg4gfpfbjvlphntvfypyw.jpeg"></div><br>
           . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can leave the parameters of the hard disk by default, the tags too (although it’s good practice to use tags, at least give the name of the instance and specify the environment). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we are on the Step 6: Configure Security Group tab, where you need to create a new one or specify your existing Security group, which allows you to connect via ssh (port 22) to the instance. </font><font style="vertical-align: inherit;">Select Source -&gt; My IP there and you can run the instance.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/cd/z9/y7cdz9fllra7haynrf6gyu0jkdq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once it enters running status, you can try to connect to it via ssh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To be able to work with Kinesis Agent, after a successful connection to the machine, you must enter the following commands in the terminal:</font></font><br>
<br>
<pre><code class="bash hljs">sudo yum -y update<font></font>
sudo yum install -y python36 python36-pip<font></font>
sudo /usr/bin/pip-3.6 install --upgrade pip<font></font>
sudo yum install -y aws-kinesis-agent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a folder for saving API responses:</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /var/<span class="hljs-built_in">log</span>/airline_tickets</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before starting the agent, you need to configure its config:</font></font><br>
<br>
<pre><code class="bash hljs">sudo vim /etc/aws-kinesis/agent.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The contents of the agent.json file should look like this:</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"cloudwatch.emitMetrics"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"kinesis.endpoint"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-attr">"firehose.endpoint"</span>: <span class="hljs-string">""</span>,<font></font>
<font></font>
  <span class="hljs-attr">"flows"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"filePattern"</span>: <span class="hljs-string">"/var/log/airline_tickets/*log"</span>,
      <span class="hljs-attr">"kinesisStream"</span>: <span class="hljs-string">"airline_tickets"</span>,
      <span class="hljs-attr">"partitionKeyOption"</span>: <span class="hljs-string">"RANDOM"</span>,
      <span class="hljs-attr">"dataProcessingOptions"</span>: [<font></font>
         {<font></font>
            <span class="hljs-attr">"optionName"</span>: <span class="hljs-string">"CSVTOJSON"</span>,
            <span class="hljs-attr">"customFieldNames"</span>: [<span class="hljs-string">"cost"</span>,<span class="hljs-string">"trip_class"</span>,<span class="hljs-string">"show_to_affiliates"</span>,
                <span class="hljs-string">"return_date"</span>,<span class="hljs-string">"origin"</span>,<span class="hljs-string">"number_of_changes"</span>,<span class="hljs-string">"gate"</span>,<span class="hljs-string">"found_at"</span>,
                <span class="hljs-string">"duration"</span>,<span class="hljs-string">"distance"</span>,<span class="hljs-string">"destination"</span>,<span class="hljs-string">"depart_date"</span>,<span class="hljs-string">"actual"</span>,<span class="hljs-string">"record_id"</span>]<font></font>
         }<font></font>
      ]<font></font>
    }<font></font>
  ]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see from the configuration file, the agent will monitor files with the .log extension in the / var / log / airline_tickets / directory, parse them and transfer them to the airline_tickets stream. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We restart the service and make sure that it starts and works:</font></font><br>
<br>
<pre><code class="bash hljs">sudo service aws-kinesis-agent restart</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now download the Python script that will request data from the API:</font></font><br>
<br>
<pre><code class="bash hljs">REPO_PATH=https://raw.githubusercontent.com/igorgorbenko/aviasales_kinesis/master/producer<font></font>
<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/api_caller.py -P /home/ec2-user/<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/requirements.txt -P /home/ec2-user/<font></font>
sudo chmod a+x /home/ec2-user/api_caller.py<font></font>
sudo /usr/<span class="hljs-built_in">local</span>/bin/pip3 install -r /home/ec2-user/requirements.txt
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The api_caller.py script requests data from Aviasales and saves the received response in the directory that Kinesis agent scans. </font><font style="vertical-align: inherit;">The implementation of this script is fairly standard, there is a class TicketsApi, it allows you to pull the API asynchronously. </font><font style="vertical-align: inherit;">In this class, we pass the header with the token and the request parameters:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsApi</span>:</span>
    <span class="hljs-string">"""Api caller class."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, headers</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.base_url = BASE_URL<font></font>
        self.headers = headers<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">self, data</span>):</span>
        <span class="hljs-string">"""Get the data from API query."""</span><font></font>
        response_json = {}<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(headers=self.headers) <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">try</span>:<font></font>
                response = <span class="hljs-keyword">await</span> session.get(self.base_url, data=data)<font></font>
                response.raise_for_status()<font></font>
                LOGGER.info(<span class="hljs-string">'Response status %s: %s'</span>,<font></font>
                            self.base_url, response.status)<font></font>
                response_json = <span class="hljs-keyword">await</span> response.json()
            <span class="hljs-keyword">except</span> HTTPError <span class="hljs-keyword">as</span> http_err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! HTTP error occurred: %s'</span>, str(http_err))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! An error ocurred: %s'</span>, str(err))
            <span class="hljs-keyword">return</span> response_json<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_request</span>(<span class="hljs-params">api_token</span>):</span>
    <span class="hljs-string">"""Return the headers and query fot the API request."""</span>
    headers = {<span class="hljs-string">'X-Access-Token'</span>: api_token,
               <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'gzip'</span>}<font></font>
<font></font>
    data = FormData()<font></font>
    data.add_field(<span class="hljs-string">'currency'</span>, CURRENCY)<font></font>
    data.add_field(<span class="hljs-string">'origin'</span>, ORIGIN)<font></font>
    data.add_field(<span class="hljs-string">'destination'</span>, DESTINATION)<font></font>
    data.add_field(<span class="hljs-string">'show_to_affiliates'</span>, SHOW_TO_AFFILIATES)<font></font>
    data.add_field(<span class="hljs-string">'trip_duration'</span>, TRIP_DURATION)
    <span class="hljs-keyword">return</span> headers, data<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-string">"""Get run the code."""</span>
    <span class="hljs-keyword">if</span> len(sys.argv) != <span class="hljs-number">2</span>:<font></font>
        print(<span class="hljs-string">'Usage: api_caller.py &lt;your_api_token&gt;'</span>)<font></font>
        sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span>
    api_token = sys.argv[<span class="hljs-number">1</span>]<font></font>
    headers, data = prepare_request(api_token)<font></font>
<font></font>
    api = TicketsApi(headers)<font></font>
    response = <span class="hljs-keyword">await</span> api.get_data(data)
    <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'success'</span>, <span class="hljs-literal">None</span>):<font></font>
        LOGGER.info(<span class="hljs-string">'API has returned %s items'</span>, len(response[<span class="hljs-string">'data'</span>]))
        <span class="hljs-keyword">try</span>:<font></font>
            count_rows = log_maker(response)<font></font>
            LOGGER.info(<span class="hljs-string">'%s rows have been saved into %s'</span>,<font></font>
                        count_rows,<font></font>
                        TARGET_FILE)<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
            LOGGER.error(<span class="hljs-string">'Oops! Request result was not saved to file. %s'</span>,<font></font>
                         str(e))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        LOGGER.error(<span class="hljs-string">'Oops! API request was unsuccessful %s!'</span>, response)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To test the correct settings and operability of the agent, we will make a test run of the api_caller.py script:</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/u8/17/rr/u817rrbmcgutepqlpx-aa7k2mo4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we look at the result of work in the Agent’s logs and on the Monitoring tab in the airline_tickets data stream:</font></font><br>
<br>
<pre><code class="bash hljs">tail -f /var/<span class="hljs-built_in">log</span>/aws-kinesis-agent/aws-kinesis-agent.log</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/5r/oy/ep5royv-vndczuzfhaufx2duuau.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/g3/pi/ya/g3piyaltiksnogpxwm0temjdpz4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, everything works and the Kinesis Agent successfully sends data to the stream. </font><font style="vertical-align: inherit;">Now configure consumer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up Kinesis Data Analytics</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's move on to the central component of the entire system - create a new application in Kinesis Data Analytics called kinesis_analytics_airlines_app:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dp/0s/4a/dp0s4aesniewnc3j7envuvi2lqa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kinesis Data Analytics enables real-time analytics of data from Kinesis Streams using SQL. </font><font style="vertical-align: inherit;">This is a fully auto-scalable service (unlike Kinesis Streams), which:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to create new streams (Output Stream) based on queries to the source data;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">provides a stream with errors that occurred during application operation (Error Stream);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It can automatically determine the input data scheme (it can be manually redefined if necessary).</font></font></li>
</ol><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is an expensive service - 0.11 USD per hour, so you should use it carefully and remove it when you complete the work.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connect the application to the data source:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/sc/g6/2xscg6tquygvrr4dxhjofyxjx-m.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Select the stream you want to connect to (airline_tickets):</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/c7/ma/y1c7ma8a_9n3wwwokqleszry-qa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to attach the new IAM Role so that the application can read from the stream and write to the stream. </font><font style="vertical-align: inherit;">To do this, it is enough to not change anything in the Access permissions block:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dg/96/wq/dg96wq1hgmmd0ouhxpxs8r0tjss.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we request the discovery of the data scheme in the stream, for this we click on the button "Discover schema". </font><font style="vertical-align: inherit;">As a result, the IAM role is updated (a new one is created) and the discovery of the scheme from the data that has already arrived in the stream is launched:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/co/6r/5eco6ro21kgrevovywr-2ulfysw.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you need to go to the SQL editor. </font><font style="vertical-align: inherit;">When you click on this button, a window with a question about launching the application will appear - choose what we want to run:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kt/oc/ta/ktoctaokxjgsxbosk5eu8-yw_e0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the SQL editor window, insert such a simple query and click Save and Run SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> STREAM <span class="hljs-string">"DESTINATION_SQL_STREAM"</span> (<span class="hljs-string">"cost"</span> <span class="hljs-keyword">DOUBLE</span>, <span class="hljs-string">"gate"</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>));<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> PUMP <span class="hljs-string">"STREAM_PUMP"</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"DESTINATION_SQL_STREAM"</span>
<span class="hljs-keyword">SELECT</span> STREAM <span class="hljs-string">"cost"</span>, <span class="hljs-string">"gate"</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"SOURCE_SQL_STREAM_001"</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-string">"cost"</span> &lt; <span class="hljs-number">5000</span>
    <span class="hljs-keyword">and</span> <span class="hljs-string">"gate"</span> = <span class="hljs-string">'Aeroflot'</span>;
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In relational databases, you work with tables using INSERT statements to add records and a SELECT statement to query data. </font><font style="vertical-align: inherit;">In Amazon Kinesis Data Analytics, you work with streams (STREAM) and “pumps” (PUMP) - continuous insertion requests that insert data from one stream in an application into another stream.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the above SQL query, Aeroflot tickets are searched for at prices below five thousand rubles. </font><font style="vertical-align: inherit;">All records that fall under these conditions will be placed in the DESTINATION_SQL_STREAM stream.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l7/zk/8l/l7zk8ltrlivhjnmj3u1xcvazwai.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the Destination block, select the special_stream stream, and in the In-application stream name DESTINATION_SQL_STREAM drop-down list:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5r/5s/7r/5r5s7rpwfezpiyjokrby1jkmcly.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result of all the manipulations, something similar to the picture below should turn out:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/o3/_b/4co3_blpb57-arskyc7jwsc2d_i.jpeg"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating and subscribing to the SNS topic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go to the Simple Notification Service and create a new topic named Airlines:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/su/ur/zr/suurzrkeqmmm7jk3-j5iuqaiar8.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We subscribe to this topic, in it we indicate the mobile phone number to which SMS notifications will come:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/gc/sz/epgcszgapjrsl4-jhx7vktgi7fi.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a table in DynamoDB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To store the raw data of their airline_tickets stream, create a table in DynamoDB with the same name. </font><font style="vertical-align: inherit;">As the primary key, we will use record_id:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/t7/td/4e/t7td4eq2asrdur1arxzbmsuthdk.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a lambda collector function</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's create a lambda function called Collector, whose task is to poll the airline_tickets stream and, if there are new records there, insert these records into the DynamoDB table. </font><font style="vertical-align: inherit;">Obviously, in addition to the default rights, this lambda must have access to read the Kinesis data stream and write to DynamoDB.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating an IAM role for a lambda collector function</font></font></b>
                        <div class="spoiler_text">    IAM      Lambda-TicketsProcessingRole:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s9/sv/_f/s9sv_fh7p4flqdklnzh5rohd9ws.jpeg"></div><br>
       AmazonKinesisReadOnlyAccess  AmazonDynamoDBFullAccess,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/v0/zy/f_v0zyuhd3h9y5e9tiuurfbpqnq.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/78/db/ge/78dbgeqrxjuuh6rzlqd-k1qdgee.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This lambda should be triggered by a Kinesis trigger when new entries hit the airline_stream stream, so you need to add a new trigger:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/h0/gg/qth0ggplzpl1afpad4shlgl_tbu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/we/2c/ip/we2cipjv713dvyo10ry4wmyrdi0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to insert the code and save the lambda.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-string">"""Parsing the stream and inserting into the DynamoDB table."""</span>
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal<font></font>
<font></font>
DYNAMO_DB = boto3.resource(<span class="hljs-string">'dynamodb'</span>)<font></font>
TABLE_NAME = <span class="hljs-string">'airline_tickets'</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsParser</span>:</span>
    <span class="hljs-string">"""Parsing info from the Stream."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, table_name, records</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.table = DYNAMO_DB.Table(table_name)<font></font>
        self.json_data = TicketsParser.get_json_data(records)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_json_data</span>(<span class="hljs-params">records</span>):</span>
        <span class="hljs-string">"""Return deserialized data from the stream."""</span>
        decoded_record_data = ([base64.b64decode(record[<span class="hljs-string">'kinesis'</span>][<span class="hljs-string">'data'</span>])
                                <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records])<font></font>
        json_data = ([json.loads(decoded_record)<font></font>
                      <span class="hljs-keyword">for</span> decoded_record <span class="hljs-keyword">in</span> decoded_record_data])
        <span class="hljs-keyword">return</span> json_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_item_from_json</span>(<span class="hljs-params">json_item</span>):</span>
        <span class="hljs-string">"""Pre-process the json data."""</span><font></font>
        new_item = {<font></font>
            <span class="hljs-string">'record_id'</span>: json_item.get(<span class="hljs-string">'record_id'</span>),
            <span class="hljs-string">'cost'</span>: Decimal(json_item.get(<span class="hljs-string">'cost'</span>)),
            <span class="hljs-string">'trip_class'</span>: json_item.get(<span class="hljs-string">'trip_class'</span>),
            <span class="hljs-string">'show_to_affiliates'</span>: json_item.get(<span class="hljs-string">'show_to_affiliates'</span>),
            <span class="hljs-string">'origin'</span>: json_item.get(<span class="hljs-string">'origin'</span>),
            <span class="hljs-string">'number_of_changes'</span>: int(json_item.get(<span class="hljs-string">'number_of_changes'</span>)),
            <span class="hljs-string">'gate'</span>: json_item.get(<span class="hljs-string">'gate'</span>),
            <span class="hljs-string">'found_at'</span>: json_item.get(<span class="hljs-string">'found_at'</span>),
            <span class="hljs-string">'duration'</span>: int(json_item.get(<span class="hljs-string">'duration'</span>)),
            <span class="hljs-string">'distance'</span>: int(json_item.get(<span class="hljs-string">'distance'</span>)),
            <span class="hljs-string">'destination'</span>: json_item.get(<span class="hljs-string">'destination'</span>),
            <span class="hljs-string">'depart_date'</span>: json_item.get(<span class="hljs-string">'depart_date'</span>),
            <span class="hljs-string">'actual'</span>: json_item.get(<span class="hljs-string">'actual'</span>)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> new_item<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""Batch insert into the table."""</span>
        <span class="hljs-keyword">with</span> self.table.batch_writer() <span class="hljs-keyword">as</span> batch_writer:
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.json_data:<font></font>
                dynamodb_item = TicketsParser.get_item_from_json(item)<font></font>
                batch_writer.put_item(dynamodb_item)<font></font>
<font></font>
        print(<span class="hljs-string">'Has been added '</span>, len(self.json_data), <span class="hljs-string">'items'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-string">"""Parse the stream and insert into the DynamoDB table."""</span>
    print(<span class="hljs-string">'Got event:'</span>, event)<font></font>
    parser = TicketsParser(TABLE_NAME, event[<span class="hljs-string">'Records'</span>])<font></font>
    parser.run()<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a lambda function notifier</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second lambda function, which will monitor the second stream (special_stream) and send a notification to SNS, is created in the same way. </font><font style="vertical-align: inherit;">Therefore, this lambda must have read access from Kinesis and send messages to the specified SNS topic, which is then sent by the SNS service to all subscribers of this topic (email, SMS, etc.).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create IAM Roles</font></font></b>
                        <div class="spoiler_text">  IAM  Lambda-KinesisAlarm   ,         alarm_notifier:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/fn/ru/zmfnru75p-tp0y1fqzxaoea2xos.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/vp/u0/ypvpu0jl74aak54hl-d4wf7r1kc.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This lambda should work according to the trigger for new entries to enter the special_stream, so you need to configure the trigger in the same way as we did for the Collector lambda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the convenience of configuring this lambda, we introduce a new environment variable - TOPIC_ARN, where we place the ANR (Amazon Recourse Names) topic of Airlines:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/43/nn/qf/43nnqfmsnahbfu30k5mqadhbuhi.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And insert the lambda code, it’s very simple:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
SNS_CLIENT = boto3.client(<span class="hljs-string">'sns'</span>)<font></font>
TOPIC_ARN = os.environ[<span class="hljs-string">'TOPIC_ARN'</span>]<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-keyword">try</span>:<font></font>
        SNS_CLIENT.publish(TopicArn=TOPIC_ARN,<font></font>
                           Message=<span class="hljs-string">'Hi! I have found an interesting stuff!'</span>,<font></font>
                           Subject=<span class="hljs-string">'Airline tickets alarm'</span>)<font></font>
        print(<span class="hljs-string">'Alarm message has been successfully delivered'</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
        print(<span class="hljs-string">'Delivery failure'</span>, str(err))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that this completes the manual system configuration. </font><font style="vertical-align: inherit;">It remains only to test and make sure that we configured everything correctly.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy from Terraform code</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Necessary preparation</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a very convenient open-source tool for deploying infrastructure from code. </font><font style="vertical-align: inherit;">It has its own syntax that is easy to learn and many examples of how and what to deploy. </font><font style="vertical-align: inherit;">There are many convenient plugins in the Atom or Visual Studio Code editor that make it easier to work with Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can download the distribution kit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A detailed analysis of all the features of Terraform is beyond the scope of this article, so we will restrict ourselves to the main points.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to start</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full project code is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in my repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We clone a repository to ourselves. </font><font style="vertical-align: inherit;">Before starting, you need to make sure that you have installed and configured AWS CLI, as </font><font style="vertical-align: inherit;">Terraform will look for credentials in the ~ / .aws / credentials file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It’s good practice to deploy the entire infrastructure before launching the plan command to see what Terraform is creating for us in the cloud:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe plan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will be prompted to enter a phone number to send notifications to it. </font><font style="vertical-align: inherit;">At this stage, it is optional.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/e3/-i/ps/e3-ipsgvy03inzbw_26haktayk4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After analyzing the program’s work plan, we can start the creation of resources:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe apply</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After sending this command, you will again be asked to enter a phone number, type “yes” when the question about the actual execution of actions is displayed. </font><font style="vertical-align: inherit;">This will allow you to raise the entire infrastructure, carry out all the necessary settings for EC2, deploy lambda functions, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After all the resources have been successfully created through the Terraform code, you need to go into the details of the Kinesis Analytics application (unfortunately, I did not find how to do this directly from the code). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Launch the application:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/ns/qc/qxnsqcjpbkiaradzqomahtxzhnu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, you must explicitly set the in-application stream name by choosing from the drop-down list:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ki/m5/pl/kim5plwariaz8bp-qo-qonli4yu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hg/69/kf/hg69kfwwtwhwkzxlpnb7g3k2ctm.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now everything is ready to go.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application Testing</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardless of how you deployed the system, manually or through the Terraform code, it will work the same. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We go through SSH to the EC2 virtual machine where Kinesis Agent is installed and run the api_caller.py script</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to wait for an SMS to your number: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ui/mc/98uimcirxv_n6pglm2qz5jtkvf4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SMS - message arrives on the phone in almost 1 minute: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kg/u7/dj/kgu7djc9xgex84h349dlpfukivg.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to be seen whether records are saved in the DynamoDB database for subsequent, more detailed analysis. </font><font style="vertical-align: inherit;">The airline_tickets table contains something like this:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/dj/vc/gqdjvcmx0q45o_sgqc_l5po_l-c.jpeg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the course of the work done, an online data processing system based on Amazon Kinesis was built. </font><font style="vertical-align: inherit;">We examined the options for using Kinesis Agent in conjunction with Kinesis Data Streams and real-time analytics of Kinesis Analytics using SQL commands, as well as the interaction of Amazon Kinesis with other AWS services. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We deployed the above system in two ways: long enough manual and fast from the Terraform code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The entire source code of the project is available </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in my repository on GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I suggest you familiarize yourself with it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With pleasure I am ready to discuss the article, I'm waiting for your comments. </font><font style="vertical-align: inherit;">I hope for constructive criticism. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wish you success!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500364/index.html">Expanding the school learning portal on Moodle and BigBlueButton</a></li>
<li><a href="../en500368/index.html">Generating predictable random sequences: a different approach to permutation</a></li>
<li><a href="../en500370/index.html">10 useful English-language podcasts for programmers worth subscribing to in 2020</a></li>
<li><a href="../en500378/index.html">Effective information search at work</a></li>
<li><a href="../en500380/index.html">Processing personal data remotely: risks and possible consequences</a></li>
<li><a href="../en500384/index.html">Pixar Studio Pioneers Received Turing Award and $ 1 Million</a></li>
<li><a href="../en500386/index.html">Adapting your existing business solution for SwiftUI. Part 2</a></li>
<li><a href="../en500390/index.html">Actual models of linguistic localization in the field of IT and digital communications. Part 1</a></li>
<li><a href="../en500396/index.html">Problems of autonomous access control systems - Where they did not expect</a></li>
<li><a href="../en500398/index.html">Remote Marathon Week 3: Inoperative Processes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>