<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí™üèº ü§∏üèΩ ü¶ç We are writing firmware for TI cc2530 on Z-Stack 3.0 for Zigbee Sonoff BASICZBR3 relay with ds18b20 sensor üåßÔ∏è ‚úçüèΩ üõåüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is assumed that the reader already has an initial knowledge of the C language, knows something about Zigbee, the cc2530 chip, methods for flashing ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We are writing firmware for TI cc2530 on Z-Stack 3.0 for Zigbee Sonoff BASICZBR3 relay with ds18b20 sensor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/495926/"><img src="https://habrastorage.org/webt/pk/k8/1r/pkk81rmgifam0ccamhmapnesahq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is assumed that the reader already has an initial knowledge of the C language, knows something about Zigbee, the cc2530 chip, methods for flashing it and using it, and is also familiar with projects like zigbee2mqtt. </font><font style="vertical-align: inherit;">If not, get ready or go read it at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://myzigbee.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.zigbee2mqtt.io/ The</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
article is written first in detail, but gradually accelerates and does not stop at the details, but describes the finished firmware code. </font><font style="vertical-align: inherit;">If someone is not interested in reasoning, then just open the firmware sources and read them. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The source code of the finished firmware</font></font></a><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The code and development approach does not claim to be ideal. </font><font style="vertical-align: inherit;">"I'm not a magician, I'm just learning."</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">purpose</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main goal is to understand how to write firmware for Z-Stack for a long time. </font><font style="vertical-align: inherit;">Therefore, I decided to implement an alternative firmware for the finished equipment ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sonoff BASICZBR3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> relay was chosen as an example </font><font style="vertical-align: inherit;">) and add the ability to connect the popular ds18b20 temperature sensor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, I wanted to show beginners Zigbee developers an example of developing firmware for the TI cc2530 chip on Z-Stack.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Preparation</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To start development, you need to download and install </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-Stack 3.0.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this is an SDK for developing firmware with examples and documentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You also need to download and install </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IAR Embeded Workbench for 8051</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this is a development environment with the ability to compile for TI cc2530 chips. </font><font style="vertical-align: inherit;">The free use period is 1 month (but the seeker will find a solution). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For development and debugging, I use CCDebugger - it allows not only flashing cc2531 / cc2530 chips, but also debugging the application in the IAR environment. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/aj/pr/_jajpr3cvn5q93lo6_igpenpdly.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To simplify the experiments, prototyping and debugging I do on the devboard and the corresponding cc2530 module:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ql/xc/cq/qlxccqkdbxnqt3pcuo8049lj0ci.jpeg"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Creating a new application</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We create a new project based on GenericApp. </font><font style="vertical-align: inherit;">This is an example of a basic Z-Stack application. </font><font style="vertical-align: inherit;">It is located in the Z-Stack 3.0.2 \ Projects \ zstack \ HomeAutomation \ GenericApp folder. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We copy it nearby and rename it, for example, to DIYRuZRT (let's call the application for our device). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inside the CC2530DB folder there are files:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.ewd - project settings for C-SPY</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.ewp - project file</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenericApp.eww - Workspace</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rename the files to DIYRuZRT.eww and DIYRuZRT.ewp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inside all the files (including the Source folder), we also change all references to GenericApp to DIYRuZRT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now open the DIYRuZRT.ewp project in IAR. We select the configuration of RouterEB and perform Rebuild All. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fb/re/mb/fbremb-ma8rcyafhwdcj6klys9k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The RouterEB folder will be created in the CC2530DB folder, and the DIYRuZRT.d51 file will appear inside the EXE folder - this file is convenient for flashing and debugging from IAR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But if we need to flash the firmware via SmartRF Flash Programmer, then we will make small changes. To do this, in the project settings in the Link section on the Output tab, change the settings for the Output file and Format: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/cb/xl/r5cbxlrunrutiwxxgt-gytlwjz4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, the DIYRuZRT.hex firmware file will be created in the EXE folder, convenient </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for flashing from other tools and in other ways</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But after uploading this firmware, the device does not connect to the network. </font><font style="vertical-align: inherit;">Well, we will understand.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. A bit of terminology</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zigbee terminology has the following concepts:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Endpoint</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - The description point of the end device. </font><font style="vertical-align: inherit;">Usually in simple devices one endpoint. </font><font style="vertical-align: inherit;">There can be several of them in multifunction devices, as well as in devices with different interaction profiles (one profile - one endpoint).</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster (cluster)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a set of attributes and commands related to a single functional (on / off, dimming, temperature measurements, etc.). </font><font style="vertical-align: inherit;">The cluster indicates the opportunities realized by the endpoint. </font><font style="vertical-align: inherit;">In one endpoint, you can implement several different clusters, but not the same ones.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribute (attribute)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a characteristic of a cluster whose value can be read or written. </font><font style="vertical-align: inherit;">A cluster can have many attributes.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - A control message that the cluster can process. </font><font style="vertical-align: inherit;">A team may have parameters. </font><font style="vertical-align: inherit;">This is implemented by a function that is executed when a command and parameters are received.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Types of clusters, attributes, commands are standardized in the Zigbee Cluster Library. </font><font style="vertical-align: inherit;">But manufacturers can use their own clusters, with their own attributes and teams. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some pitiful producers do not care about the standards and do something about the standard. </font><font style="vertical-align: inherit;">Then you have to adapt to them. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Z-Stack</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
terminology </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also has its own concepts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , for example:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL (Operating System Abstraction Layer)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the abstraction level of the Operating System. </font><font style="vertical-align: inherit;">Here they operate with tasks (tasks), messages (messages), events (events), timers (timers) and other objects.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL (Hardware Abstraction Layer)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - level of equipment abstraction. </font><font style="vertical-align: inherit;">Here they operate with buttons (keys), LEDs (leds), interrupts (Interrupt), etc.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The hardware layer provides isolation of the program code and the equipment that it controls. </font><font style="vertical-align: inherit;">The operational level provides mechanisms for building and interacting between application elements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using this all awaits you below and, in principle, when developing firmware.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. What do we have inside the base application?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The application code is located in the Source folder:</font></font><br>
<br>
<ul>
<li><i>OSAL_DIYRuZRT.c</i> ‚Äî    <br>
</li>
<li><i>zcl_DIYRuZRT.h</i> ‚Äî  <br>
</li>
<li><i>zcl_DIYRuZRT.c</i> ‚Äî   <br>
</li>
<li><i>zcl_DIYRuZRT_data.c</i> ‚Äî  ,   <br>
</li>
</ul><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL_DIYRuZRT.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the main file in which the array of task handlers (task)&nbsp; </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pTaskEventHandlerFn tasksArr is populated</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">osalInitTasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> initialization function is </font><b><font style="vertical-align: inherit;">implemented</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All other files are needed to implement these initializers and handlers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The list of task handlers </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pTaskEventHandlerFn tasksAr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r is populated with function references. Some tasks are connected / disconnected by the corresponding compilation directives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can view and configure compilation directives in the Defined symbols compiler options:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/tl/u6/pntlu6bioazjsoaywmdfofeloas.png"><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> pTaskEventHandlerFn tasksArr[] = {<font></font>
  macEventLoop,<font></font>
  nwk_event_loop,<font></font>
#<span class="hljs-keyword">if</span> !defined (DISABLE_GREENPOWER_BASIC_PROXY) &amp;&amp; (ZG_BUILD_RTR_TYPE)<font></font>
  gp_event_loop,<font></font>
#endif  <font></font>
  Hal_ProcessEvent,<font></font>
#<span class="hljs-keyword">if</span> defined( MT_TASK )<font></font>
  MT_ProcessEvent,<font></font>
#endif<font></font>
  APS_event_loop,<font></font>
#<span class="hljs-keyword">if</span> defined ( ZIGBEE_FRAGMENTATION )<font></font>
  APSF_ProcessEvent,<font></font>
#endif<font></font>
  ZDApp_event_loop,<font></font>
#<span class="hljs-keyword">if</span> defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )<font></font>
  ZDNwkMgr_event_loop,<font></font>
#endif<font></font>
  <span class="hljs-comment">//Added to include TouchLink functionality</span>
  #<span class="hljs-keyword">if</span> defined ( INTER_PAN )<font></font>
    StubAPS_ProcessEvent,<font></font>
  #endif<font></font>
  <span class="hljs-comment">// Added to include TouchLink initiator functionality</span>
  #<span class="hljs-keyword">if</span> defined ( BDB_TL_INITIATOR )<font></font>
    touchLinkInitiator_event_loop,<font></font>
  #endif<font></font>
  <span class="hljs-comment">// Added to include TouchLink target functionality</span>
  #<span class="hljs-keyword">if</span> defined ( BDB_TL_TARGET )<font></font>
    touchLinkTarget_event_loop,<font></font>
  #endif<font></font>
  zcl_event_loop,<font></font>
  bdb_event_loop,<font></font>
  zclDIYRuZRT_event_loop<font></font>
};<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">osalInitTasks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the application start-up function that registers tasks </font><b><font style="vertical-align: inherit;">performed by the</font></b><font style="vertical-align: inherit;"> application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Registration of tasks is performed in order, and each task gets its own number. It is important to follow the same order as in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tasksArr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> array </font><font style="vertical-align: inherit;">, as handlers are called according to the task number.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">osalInitTasks</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{<font></font>
  uint8 taskID = <span class="hljs-number">0</span>;<font></font>
<font></font>
  tasksEvents = (uint16 *)osal_mem_alloc( <span class="hljs-keyword">sizeof</span>( uint16 ) * tasksCnt);<font></font>
  osal_memset( tasksEvents, <span class="hljs-number">0</span>, (<span class="hljs-keyword">sizeof</span>( uint16 ) * tasksCnt));<font></font>
<font></font>
  macTaskInit( taskID++ );<font></font>
  nwk_init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> !defined (DISABLE_GREENPOWER_BASIC_PROXY) &amp;&amp; (ZG_BUILD_RTR_TYPE)</span><font></font>
  gp_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  Hal_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined( MT_TASK )</span><font></font>
  MT_TaskInit( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  APS_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( ZIGBEE_FRAGMENTATION )</span><font></font>
  APSF_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  ZDApp_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( ZIGBEE_FREQ_AGILITY ) || defined ( ZIGBEE_PANID_CONFLICT )</span><font></font>
  ZDNwkMgr_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-comment">// Added to include TouchLink functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( INTER_PAN )</span><font></font>
  StubAPS_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">// Added to include TouchLink initiator functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined( BDB_TL_INITIATOR )</span><font></font>
  touchLinkInitiator_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-comment">// Added to include TouchLink target functionality</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined ( BDB_TL_TARGET )</span><font></font>
  touchLinkTarget_Init( taskID++ );<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
  zcl_Init( taskID++ );<font></font>
  bdb_Init( taskID++ );<font></font>
  zclDIYRuZRT_Init( taskID );<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our application registered the function handler </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_event_loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the initialization function </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . They are added last in the list. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are the two main functions of our application. The implementation of these functions is in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_DIYRuZRT.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - task registration function. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_ENDPOINT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the endpoint number implemented by our application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The registration steps that describe our application are sequentially performed:</font></font><br>
<br>
<ul>
<li><b>bdb_RegisterSimpleDescriptor </b> ‚Äî    .    <b>SimpleDescriptionFormat_t zclDIYRuZRT_SimpleDesc</b> ‚Äî    ,  , ,    .       <i>OSAL_DIYRuZRT_data.c</i><br>
</li>
<li><b>zclGeneral_RegisterCmdCallbacks </b> ‚Äî      <b>zclGeneral_AppCallbacks_t zclDIYRuZRT_CmdCallbacks</b> ‚Äî  ,       .<br>
</li>
<li><b>zcl_registerAttrList </b> ‚Äî    <b>zclAttrRec_t zclDIYRuZRT_Attrs</b> ‚Äî  ,     .<br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_registerForMsg</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - register receipt of control messages.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RegisterForKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - we sign our task for receiving button click events.</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*********************************************************************
 * SIMPLE DESCRIPTOR
 */</span>
<span class="hljs-comment">// This is the Cluster ID List and should be filled with Application</span>
<span class="hljs-comment">// specific cluster IDs.</span>
<span class="hljs-keyword">const</span> cId_t zclDIYRuZRT_InClusterList[] =<font></font>
{<font></font>
  ZCL_CLUSTER_ID_GEN_BASIC,<font></font>
  ZCL_CLUSTER_ID_GEN_IDENTIFY,<font></font>
  <font></font>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Add application specific Input Clusters Here. </span>
  <span class="hljs-comment">//       See zcl.h for Cluster ID definitions</span><font></font>
  <font></font>
};<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCLDIYRuZRT_MAX_INCLUSTERS   (sizeof(zclDIYRuZRT_InClusterList) / sizeof(zclDIYRuZRT_InClusterList[0]))</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">const</span> cId_t zclDIYRuZRT_OutClusterList[] =<font></font>
{<font></font>
  ZCL_CLUSTER_ID_GEN_BASIC,<font></font>
  <font></font>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Add application specific Output Clusters Here. </span>
  <span class="hljs-comment">//       See zcl.h for Cluster ID definitions</span><font></font>
};<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCLDIYRuZRT_MAX_OUTCLUSTERS  (sizeof(zclDIYRuZRT_OutClusterList) / sizeof(zclDIYRuZRT_OutClusterList[0]))</span><font></font>
<font></font>
<font></font>
SimpleDescriptionFormat_t zclDIYRuZRT_SimpleDesc =<font></font>
{<font></font>
  DIYRuZRT_ENDPOINT,                  <span class="hljs-comment">//  int Endpoint;</span>
  ZCL_HA_PROFILE_ID,                     <span class="hljs-comment">//  uint16 AppProfId;</span>
  <span class="hljs-comment">// DIYRuZRT_<span class="hljs-doctag">TODO:</span> Replace ZCL_HA_DEVICEID_ON_OFF_LIGHT with application specific device ID</span>
  ZCL_HA_DEVICEID_ON_OFF_LIGHT,          <span class="hljs-comment">//  uint16 AppDeviceId; </span>
  DIYRuZRT_DEVICE_VERSION,            <span class="hljs-comment">//  int   AppDevVer:4;</span>
  DIYRuZRT_FLAGS,                     <span class="hljs-comment">//  int   AppFlags:4;</span>
  ZCLDIYRuZRT_MAX_INCLUSTERS,         <span class="hljs-comment">//  byte  AppNumInClusters;</span>
  (cId_t *)zclDIYRuZRT_InClusterList, <span class="hljs-comment">//  byte *pAppInClusterList;</span>
  ZCLDIYRuZRT_MAX_OUTCLUSTERS,        <span class="hljs-comment">//  byte  AppNumInClusters;</span>
  (cId_t *)zclDIYRuZRT_OutClusterList <span class="hljs-comment">//  byte *pAppInClusterList;</span><font></font>
};<font></font>
</code></pre><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_event_loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - function of event handlers of our application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, the system events are processed in a loop:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZCL_INCOMING_MSG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - device control commands are processed in zclDIYRuZRT_ProcessIncomingMsg.</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KEY_CHANGE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - button click events are processed in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_HandleKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZDO_STATE_CHANGE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - network status change events.</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">if</span> ( events &amp; SYS_EVENT_MSG )<font></font>
  {<font></font>
    <span class="hljs-keyword">while</span> ( (MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( zclDIYRuZRT_TaskID )) )<font></font>
    {<font></font>
      <span class="hljs-keyword">switch</span> ( MSGpkt-&gt;hdr.event )<font></font>
      {<font></font>
        <span class="hljs-keyword">case</span> ZCL_INCOMING_MSG:
          <span class="hljs-comment">// Incoming ZCL Foundation command/response messages</span><font></font>
          zclDIYRuZRT_ProcessIncomingMsg( (zclIncomingMsg_t *)MSGpkt );<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">case</span> KEY_CHANGE:<font></font>
          zclDIYRuZRT_HandleKeys( ((keyChange_t *)MSGpkt)-&gt;state, ((keyChange_t *)MSGpkt)-&gt;keys );<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">case</span> ZDO_STATE_CHANGE:<font></font>
          zclDIYRuZRT_NwkState = (devStates_t)(MSGpkt-&gt;hdr.status);<font></font>
<font></font>
          <span class="hljs-comment">// now on the network</span>
          <span class="hljs-keyword">if</span> ( (zclDIYRuZRT_NwkState == DEV_ZB_COORD) ||<font></font>
               (zclDIYRuZRT_NwkState == DEV_ROUTER)   ||<font></font>
               (zclDIYRuZRT_NwkState == DEV_END_DEVICE) )<font></font>
          {<font></font>
            giGenAppScreenMode = GENERIC_MAINMODE;<font></font>
            zclDIYRuZRT_LcdDisplayUpdate();<font></font>
          }<font></font>
          <span class="hljs-keyword">break</span>;<font></font>
<font></font>
        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
<font></font>
      <span class="hljs-comment">// Release the memory</span><font></font>
      osal_msg_deallocate( (uint8 *)MSGpkt );<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next is the processing of the special event </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_EVT_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which switches the state of the LED </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_LED_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and starts the timer for 500m with the same event. </font><font style="vertical-align: inherit;">This starts the flashing of the LED </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_LED_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-keyword">if</span> ( events &amp; DIYRuZRT_EVT_1 )<font></font>
  {<font></font>
    <span class="hljs-comment">// toggle LED 2 state, start another timer for 500ms</span><font></font>
    HalLedSet ( HAL_LED_2, HAL_LED_MODE_TOGGLE );<font></font>
    osal_start_timerEx( zclDIYRuZRT_TaskID, DIYRuZRT_EVT_1, <span class="hljs-number">500</span> );<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> ( events ^ DIYRuZRT_EVT_1 );<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that when the firmware starts, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_SW_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> event </font><b><font style="vertical-align: inherit;">occurs</font></b><font style="vertical-align: inherit;"> and it is in it that the timer and the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_EVT_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> event are </font><b><font style="vertical-align: inherit;">initialized</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">And if you press the S2 button, then the blinking will stop (my LED remains on). </font><font style="vertical-align: inherit;">Pressing it again will start flashing.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. HAL: LEDs and buttons</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚ÄúWait, which LED and buttons?‚Äù, You ask. </font><font style="vertical-align: inherit;">Initially, all the examples in Z-stack are focused on various kinds of debug boards of the SmartRF05 EB series: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/bl/ru/tzblrurrrpoze3kghx_dd1zrume.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have a slightly different debug board and a module with a chip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are 2 buttons (+ reset) and 3 LEDs (+ power indicator) on the board. </font><font style="vertical-align: inherit;">Here is one of them (D2) flashing when the firmware is working correctly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having called the contacts, we determine the correspondence of pins, diodes and buttons:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D1 - P10</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D2 - P11</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D3 - P14</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S2 - P20</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S1 - P01</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, HAL is a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hardware Abstraction Layer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a way to abstract from the implementation of equipment. The application code uses macros and functions that work with abstractions such as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Button 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the specific correspondence of abstractions and equipment is set separately. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let‚Äôs </font><font style="vertical-align: inherit;">figure out what kind of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_LED_2 is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and how to understand which pin it is suspended on. </font><i><font style="vertical-align: inherit;">By</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
searching, we find the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_led.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">, where these constants and the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalLedSet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function are </font><b><font style="vertical-align: inherit;">described</font></b><font style="vertical-align: inherit;"> , where the LED number and mode are transmitted. Inside, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalLedOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function is </font><b><font style="vertical-align: inherit;">called</font></b><font style="vertical-align: inherit;"> to turn on and off the LED, which in turn executes either </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_ON_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_OFF_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_ON_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TURN_OFF_LED2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are the macros described in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Macros change depending on the hardware configuration. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my case:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_TURN_OFF_LED2() &nbsp; &nbsp; &nbsp; st( LED2_SBIT = LED2_POLARITY (0); )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_TURN_ON_LED2()&nbsp; &nbsp; &nbsp; &nbsp; st( LED2_SBIT = LED2_POLARITY (1); )</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A little higher in the file are the correspondences of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_SBIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_POLARITY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">&nbsp;&nbsp;<span class="hljs-comment">/* 2 - Red */</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(1)</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT &nbsp; &nbsp; &nbsp; &nbsp; P1_1</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; P1DIR</span>
&nbsp;&nbsp;<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_HIGH</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that LED 2 is located on pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and its switching level is high. </font><font style="vertical-align: inherit;">But, judging by the code, the LED should go out when the button is pressed, but with us it remains on. </font><font style="vertical-align: inherit;">If in this file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h we</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> change:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_HIGH</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
on the</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY &nbsp; &nbsp; ACTIVE_LOW</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
then now the LED goes out when you press the S2 button, as it should be by logic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order not to change common files that are not related to our application, it is better to do otherwise:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create a copy of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">(from the Z-Stack 3.0.2 \ Components \ hal \ target \ CC2530EB \ folder) in our Source folder and name it for example </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">let us make our copy of the file the very first one (thereby excluding the connection of the shared file). </font><font style="vertical-align: inherit;">Create a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file in our Source folder </font><font style="vertical-align: inherit;">and write the line there:</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"hal_board_cfg_DIYRuZRT.h"</span></span></code></pre><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicate the connection of this file is the very first - in the project settings:</font></font><br>
</li>
</ul><br>
<pre><code class="cpp hljs">$PROJ_DIR$\..\Source\preinclude.h</code></pre><br>
<img src="https://habrastorage.org/webt/jl/_f/j_/jl_fj_oy71xhwehgszprw9jhdiw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can change the equipment parameters in our </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">and in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">without having to edit shared files. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I transferred the compiler directives to the same preinclude.h file and deleted them in the compiler Options:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SECURE 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TC_LINKKEY_JOIN</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NV_INIT</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NV_RESTORE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xZTOOL_P1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_TASK</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_APP_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_SYS_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_ZDO_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_ZDO_MGMT</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> xMT_APP_CNF_FUNC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LEGACY_LCD_DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LCD_SUPPORTED DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MULTICAST_ENABLED FALSE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_READ</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_WRITE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_BASIC</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_IDENTIFY</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_SCENES</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_GROUPS</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the same file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we find the description of the S1 button and Joystick Center Press:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* S1 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH1_BV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH1_SBIT&nbsp; &nbsp; &nbsp; &nbsp; P0_1</span><font></font>
<font></font>
<span class="hljs-comment">/* Joystick Center Press */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_BV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BV(0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_SBIT&nbsp; &nbsp; &nbsp; &nbsp; P2_0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_POLARITY&nbsp; &nbsp; ACTIVE_HIGH</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This corresponds to the pins of the buttons on the board. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at the hardware initialization - the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_BOARD_INIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> macro </font><font style="vertical-align: inherit;">in the same file. </font><font style="vertical-align: inherit;">By default, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_BOARD_CC2530EB_REV17</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directive is </font><b><font style="vertical-align: inherit;">turned on</font></b><font style="vertical-align: inherit;"> , so we look at the corresponding macro variant.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* ----------- Board Initialization ---------- */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined (HAL_BOARD_CC2530EB_REV17) &amp;&amp; !defined (HAL_PA_LNA) &amp;&amp; \
    !defined (HAL_PA_LNA_CC2590) &amp;&amp; !defined (HAL_PA_LNA_SE2431L) &amp;&amp; \
    !defined (HAL_PA_LNA_CC2592)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_BOARD_INIT()                                         \
{                                                                \
  uint16 i;                                                      \
                                                                 \
  SLEEPCMD &amp;= ~OSC_PD;                       <span class="hljs-comment">/* turn on 16MHz RC and 32MHz XOSC */</span>                \
  while (!(SLEEPSTA &amp; XOSC_STB));            <span class="hljs-comment">/* wait for 32MHz XOSC stable */</span>                     \
  asm(<span class="hljs-meta-string">"NOP"</span>);                                <span class="hljs-comment">/* chip bug workaround */</span>                            \
  for (i=0; i&lt;504; i++) asm(<span class="hljs-meta-string">"NOP"</span>);          <span class="hljs-comment">/* Require 63us delay for all revs */</span>                \
  CLKCONCMD = (CLKCONCMD_32MHZ | OSC_32KHZ); <span class="hljs-comment">/* Select 32MHz XOSC and the source for 32K clock */</span> \
  while (CLKCONSTA != (CLKCONCMD_32MHZ | OSC_32KHZ)); <span class="hljs-comment">/* Wait for the change to be effective */</span>   \
  SLEEPCMD |= OSC_PD;                        <span class="hljs-comment">/* turn off 16MHz RC */</span>                              \
                                                                 \
  <span class="hljs-comment">/* Turn on cache prefetch mode */</span>                              \
  PREFETCH_ENABLE();                                             \
                                                                 \
  HAL_TURN_OFF_LED1();                                           \
  LED1_DDR |= LED1_BV;                                           \
  HAL_TURN_OFF_LED2();                                           \
  LED2_DDR |= LED2_BV;                                           \
  HAL_TURN_OFF_LED3();                                           \
  LED3_DDR |= LED3_BV;                                           \
  HAL_TURN_OFF_LED4();                                           \
  LED4_SET_DIR();                                                \
                                                                 \
  <span class="hljs-comment">/* configure tristates */</span>                                      \
  P0INP |= PUSH2_BV;                                             \
}</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is in this macro that the modes and registers of the processor are initialized. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instead </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_DDR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and others will be substituted </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1DIR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - register this port </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , charge operation mode pins (input or output). Accordingly, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LED2_BV</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is setting to 1 per bit of the corresponding pin (in our case, 1 bit, which corresponds to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pin </font><font style="vertical-align: inherit;">): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qr/ed/0y/qred0ypxdrfxxkaleymbpqmjgto.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Registers and processor modes are described in the documentation of the </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúcc253x User's Guide‚Äù.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
But nowhere is it visible how the buttons are configured. Buttons are processed similarly, but in another file - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_key.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It defines the parameters of the buttons and functions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyInit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyConfig</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyRead</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HalKeyPoll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">These functions are responsible for initializing the subsystem of working with buttons and reading values. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, button processing is performed on a timer every 100ms. </font><font style="vertical-align: inherit;">Pin P2_0 for the current configuration is assigned to the joystick and its current state is read as a click - therefore, the LED blink timer starts.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. We configure the device for ourselves</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Change in the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zcl_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_ENDPOINT on 1</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL_DIYRuZRT_data.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_DEVICE_VERSION at 1</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ManufacturerName on {6, 'D', 'I', 'Y', 'R', 'u', 'Z'}</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ModelId on {9, 'D', 'I', 'Y', 'R', 'u', 'Z', '_', 'R', 'T'}</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_DateCode on {8, '2', '0', '2', '0', '0', '4', '0', '5'}</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for the device to be able to connect to the network on any channel (only 11 by default, specified in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEFAULT_CHANLIST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directive </font><font style="vertical-align: inherit;">in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tools \ f8wConfig.cfg file</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), you must specify this feature in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><i><font style="vertical-align: inherit;">by</font></i><font style="vertical-align: inherit;"> changing the value of the directive. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also add the compilation directive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DISABLE_GREENPOWER_BASIC_PROXY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> so that the GREENPOWER endpoint is not created for our device. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also turn off the unnecessary support for the LCD screen.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//#define LCD_SUPPORTED DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DISABLE_GREENPOWER_BASIC_PROXY</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEFAULT_CHANLIST 0x07FFF800&nbsp; <span class="hljs-comment">// ALL Channels</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for our device to automatically try to connect to the network, we will add the connection to the network in the function code </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs">bdb_StartCommissioning(BDB_COMMISSIONING_MODE_NWK_STEERING |<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BDB_COMMISSIONING_MODE_FINDING_BINDING);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, execute Build, fill the firmware into the chip and start pairing on the coordinator. </font><font style="vertical-align: inherit;">I check the operation of the Zigbee network in ioBroker.zigbee, this is how the new connected device looks: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/ik/ss/umikss4n4f19icobraxj-rb_tj4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great, it turned out to connect the device!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. We complicate the operation of the device</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's try to adapt the functionality a bit:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The process of connecting the device to the network is done by a long press on the button.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the device was already on the network, then a long press displays it from the network.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Short press - switches the status of the LED.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The status of the LED should be maintained when the device starts after a power failure.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To set up my own button processing, I created the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_HalKeyInit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">similar to the one in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_key.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> module </font><font style="vertical-align: inherit;">, but exclusively for my set of buttons.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    ()</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DIYRuZRT_HalKeyInit</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">/*      0 */</span>
  halKeySavedKeys = <span class="hljs-number">0</span>;<font></font>
<font></font>
  PUSH1_SEL &amp;= ~(PUSH1_BV); <span class="hljs-comment">/*    - GPIO */</span>
  PUSH1_DIR &amp;= ~(PUSH1_BV); <span class="hljs-comment">/*    -  */</span><font></font>
  <font></font>
  PUSH1_ICTL &amp;= ~(PUSH1_ICTLBIT); <span class="hljs-comment">/*      */</span>
  PUSH1_IEN &amp;= ~(PUSH1_IENBIT);   <span class="hljs-comment">/*     */</span><font></font>
  <font></font>
  PUSH2_SEL &amp;= ~(PUSH2_BV); <span class="hljs-comment">/* Set pin function to GPIO */</span>
  PUSH2_DIR &amp;= ~(PUSH2_BV); <span class="hljs-comment">/* Set pin direction to Input */</span><font></font>
  <font></font>
  PUSH2_ICTL &amp;= ~(PUSH2_ICTLBIT); <span class="hljs-comment">/* don't generate interrupt */</span>
  PUSH2_IEN &amp;= ~(PUSH2_IENBIT);   <span class="hljs-comment">/* Clear interrupt enable bit */</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Calling this function added to the macro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_BOARD_INIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">To avoid conflict, disable the built-in hal_key in the same file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> HAL_KEY FALSE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Because </font><font style="vertical-align: inherit;">the standard button reader is disabled, we will do it ourselves. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the initialization function </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><b><font style="vertical-align: inherit;">we</font></b><font style="vertical-align: inherit;"> start the timer for reading the states of the buttons. </font><font style="vertical-align: inherit;">The timer will generate our </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> event </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs">osal_start_reload_timer( zclDIYRuZRT_TaskID, HAL_KEY_EVENT, <span class="hljs-number">100</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in the event loop, we will handle the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_KEY_EVENT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> event </font><b><font style="vertical-align: inherit;">by</font></b><font style="vertical-align: inherit;"> calling the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_HalKeyPoll</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DIYRuZRT_HalKeyPoll</span> <span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
  uint8 keys = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-comment">//   1 ?</span>
  <span class="hljs-keyword">if</span> (HAL_PUSH_BUTTON1())<font></font>
  {<font></font>
    keys |= HAL_KEY_SW_1;<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-comment">//   2 ?</span>
  <span class="hljs-keyword">if</span> (HAL_PUSH_BUTTON2())<font></font>
  {<font></font>
    keys |= HAL_KEY_SW_2;<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (keys == halKeySavedKeys)<font></font>
  {<font></font>
    <span class="hljs-comment">//  -  </span>
    <span class="hljs-keyword">return</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//        . </span><font></font>
  halKeySavedKeys = keys;<font></font>
<font></font>
  <span class="hljs-comment">//     </span><font></font>
  OnBoard_SendKeys(keys, HAL_KEY_STATE_NORMAL);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saving the state of the buttons in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">halKeySavedKeys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">allows us to determine the moment of change - pressing and releasing the buttons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you click on the button, start the timer for 5 seconds. </font><font style="vertical-align: inherit;">If this timer fires, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_EVT_LONG</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> event will be generated </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If the button is released, the timer is reset. </font><font style="vertical-align: inherit;">In any case, if you press the button, we switch the status of the LED.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_HandleKeys</span><span class="hljs-params">( byte shift, byte keys )</span>
</span>{
  <span class="hljs-keyword">if</span> ( keys &amp; HAL_KEY_SW_1 )<font></font>
  {<font></font>
    <span class="hljs-comment">//       - 5 </span>
    osal_start_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_LONG, <span class="hljs-number">5000</span>);
    <span class="hljs-comment">//  </span>
    updateRelay(RELAY_STATE == <span class="hljs-number">0</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    <span class="hljs-comment">//     </span><font></font>
    osal_stop_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_LONG);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, when processing a long-press event, we pay attention to the current state of the network through the structure attribute </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bdbAttributes.bdbNodeIsOnANetwork</font></font></b><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">//  DIYRuZRT_EVT_LONG</span>
  <span class="hljs-keyword">if</span> ( events &amp; DIYRuZRT_EVT_LONG )<font></font>
  {<font></font>
    <span class="hljs-comment">//    </span>
    <span class="hljs-comment">//      ?</span>
    <span class="hljs-keyword">if</span> ( bdbAttributes.bdbNodeIsOnANetwork )<font></font>
    {<font></font>
      <span class="hljs-comment">//  </span><font></font>
      zclDIYRuZRT_LeaveNetwork();<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> <font></font>
    {<font></font>
      <span class="hljs-comment">//    </span><font></font>
      bdb_StartCommissioning(<font></font>
        BDB_COMMISSIONING_MODE_NWK_FORMATION | <font></font>
        BDB_COMMISSIONING_MODE_NWK_STEERING | <font></font>
        BDB_COMMISSIONING_MODE_FINDING_BINDING | <font></font>
        BDB_COMMISSIONING_MODE_INITIATOR_TL<font></font>
      );<font></font>
      <span class="hljs-comment">//  ,   </span>
      osal_start_timerEx(zclDIYRuZRT_TaskID, DIYRuZRT_EVT_BLINK, <span class="hljs-number">500</span>);<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">return</span> ( events ^ DIYRuZRT_EVT_LONG );<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We go further. </font><font style="vertical-align: inherit;">The state of the LED will be saved in a variable, the value of which we will save in the NV-memory. </font><font style="vertical-align: inherit;">When the device starts, we will read the value from memory into a variable.</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">//  NVM   RELAY STATE</span>
  <span class="hljs-keyword">if</span> ( SUCCESS == osal_nv_item_init( NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">1</span>, &amp;RELAY_STATE ) ) {
    <span class="hljs-comment">//   RELAY STATE  </span>
    osal_nv_read( NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;RELAY_STATE );<font></font>
  }<font></font>
  <span class="hljs-comment">//   </span><font></font>
  applyRelay();<font></font>
</code></pre><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateRelay</span> <span class="hljs-params">( <span class="hljs-keyword">bool</span> value )</span>
</span>{
  <span class="hljs-keyword">if</span> (value) {<font></font>
    RELAY_STATE = <span class="hljs-number">1</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    RELAY_STATE = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//   </span>
  osal_nv_write(NV_DIYRuZRT_RELAY_STATE_ID, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;RELAY_STATE);
  <span class="hljs-comment">//   </span><font></font>
  applyRelay();<font></font>
}<font></font>
  <font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">applyRelay</span> <span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">if</span> (RELAY_STATE == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">//    1</span><font></font>
    HalLedSet ( HAL_LED_1, HAL_LED_MODE_OFF );<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">//    1</span><font></font>
    HalLedSet ( HAL_LED_1, HAL_LED_MODE_ON );<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Now we will deal with Zigbee</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far we have sorted out the hardware - with the button we control the LED. </font><font style="vertical-align: inherit;">Now we implement the same through Zigbee. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To control the relay, it is enough for us to use our only endpoint and implement the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cluster </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We read the Zigbee Cluster Library specification for the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cluster </font><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zo/9z/z7/zo9zz7ccj2oyfyrxrk3mithxh0i.png"><br>
<br>
<img src="https://habrastorage.org/webt/7b/na/ek/7bnaekoi4gmleiisjwvbfw75hao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is enough to implement the OnOff attribute and the On, Off, Toggle commands. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, add the directive to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preinclude.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_ON_OFF</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the description of our attributes zclDIYRuZRT_Attrs we add new cluster attributes:</font></font><br>
<br>
<pre><code class="cpp hljs">  <span class="hljs-comment">// ***  On/Off  ***</span><font></font>
  {<font></font>
    ZCL_CLUSTER_ID_GEN_ON_OFF,<font></font>
    { <span class="hljs-comment">// </span><font></font>
      ATTRID_ON_OFF,<font></font>
      ZCL_DATATYPE_BOOLEAN,<font></font>
      ACCESS_CONTROL_READ,<font></font>
      (<span class="hljs-keyword">void</span> *)&amp;RELAY_STATE<font></font>
    }<font></font>
  },<font></font>
  {<font></font>
    ZCL_CLUSTER_ID_GEN_ON_OFF,<font></font>
    {  <span class="hljs-comment">//  On/Off </span><font></font>
      ATTRID_CLUSTER_REVISION,<font></font>
      ZCL_DATATYPE_UINT16,<font></font>
      ACCESS_CONTROL_READ | ACCESS_CLIENT,<font></font>
      (<span class="hljs-keyword">void</span> *)&amp;zclDIYRuZRT_clusterRevision_all<font></font>
    }<font></font>
  },<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also add the cluster to the list of supported incoming endpoint clusters </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_InClusterList</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To implement control commands, add a handler to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_CmdCallbacks</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*********************************************************************
 *    ZCL 
 */</span>
<span class="hljs-keyword">static</span> zclGeneral_AppCallbacks_t zclDIYRuZRT_CmdCallbacks =<font></font>
{<font></font>
  zclDIYRuZRT_BasicResetCB,               <span class="hljs-comment">// Basic Cluster Reset command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Identify Trigger Effect command</span>
  zclDIYRuZRT_OnOffCB,                    <span class="hljs-comment">// On/Off cluster commands</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command Off with Effect</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command On with Recall Global Scene</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// On/Off cluster enhanced command On with Timed Off</span><font></font>
#ifdef ZCL_LEVEL_CTRL<font></font>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Move to Level command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Move command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Step command</span>
  <span class="hljs-literal">NULL</span>,                                   <span class="hljs-comment">// Level Control Stop command</span><font></font>
#endif<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we implement it:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    OnOff</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_OnOffCB</span><span class="hljs-params">(uint8 cmd)</span>
</span>{
  <span class="hljs-comment">//  ,   </span>
  <span class="hljs-comment">//    </span><font></font>
  afIncomingMSGPacket_t *pPtr = zcl_getRawAFMsg();<font></font>
  zclDIYRuZRT_DstAddr.addr.shortAddr = pPtr-&gt;srcAddr.addr.shortAddr;<font></font>
  <font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">if</span> (cmd == COMMAND_ON) {<font></font>
    updateRelay(TRUE);<font></font>
  }<font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == COMMAND_OFF) {<font></font>
    updateRelay(FALSE);<font></font>
  }<font></font>
  <span class="hljs-comment">// </span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd == COMMAND_TOGGLE) {<font></font>
    updateRelay(RELAY_STATE == <span class="hljs-number">0</span>);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great, now the relay can be switched by commands. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rg/_b/r5/rg_br5mwpw1z8g63trgcdts2o84.png"><br>
<br>
<img src="https://habrastorage.org/webt/sc/s8/-h/scs8-heldl3hz6l7h4ia3jllscw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But this is not enough. </font><font style="vertical-align: inherit;">Now we must also inform the coordinator about the current state of the LED, if we switch it with the button. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Again, add the directive:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ZCL_REPORTING_DEVICE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now create a function </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ReportOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that sends a status message. </font><font style="vertical-align: inherit;">We will call it when the LED is switched and when the device starts.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_ReportOnOff</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">const</span> uint8 NUM_ATTRIBUTES = <span class="hljs-number">1</span>;<font></font>
<font></font>
  zclReportCmd_t *pReportCmd;<font></font>
<font></font>
  pReportCmd = osal_mem_alloc(<span class="hljs-keyword">sizeof</span>(zclReportCmd_t) +<font></font>
                              (NUM_ATTRIBUTES * <span class="hljs-keyword">sizeof</span>(zclReport_t)));
  <span class="hljs-keyword">if</span> (pReportCmd != <span class="hljs-literal">NULL</span>) {<font></font>
    pReportCmd-&gt;numAttr = NUM_ATTRIBUTES;<font></font>
<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrID = ATTRID_ON_OFF;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].dataType = ZCL_DATATYPE_BOOLEAN;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrData = (<span class="hljs-keyword">void</span> *)(&amp;RELAY_STATE);<font></font>
<font></font>
    zclDIYRuZRT_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;<font></font>
    zclDIYRuZRT_DstAddr.addr.shortAddr = <span class="hljs-number">0</span>;<font></font>
    zclDIYRuZRT_DstAddr.endPoint = <span class="hljs-number">1</span>;<font></font>
<font></font>
    zcl_SendReportCmd(DIYRuZRT_ENDPOINT, &amp;zclDIYRuZRT_DstAddr,<font></font>
                      ZCL_CLUSTER_ID_GEN_ON_OFF, pReportCmd,<font></font>
                      ZCL_FRAME_CLIENT_SERVER_DIR, <span class="hljs-literal">false</span>, SeqNum++);<font></font>
  }<font></font>
<font></font>
  osal_mem_free(pReportCmd);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now in the logs we see messages about a change in the status of the LED.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9. Connect the ds18b20 temperature sensor</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The sensor is connected to any free pin (in my case, set </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the sensor polling code to the application. We will interview regularly - once a minute. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immediately upon polling, the network coordinator will notify you of the current value. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read the ZCL specifications for sending data from temperature sensors. We need a cluster </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temperature Measurement.</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/o2/_q/8h/o2_q8h7gtgxs7cjvvz8dumonsgq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We see that we need to implement 3 attributes, one of which represents the temperature value multiplied by 100. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we add the attributes by analogy with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GenOnOff</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cluster </font><font style="vertical-align: inherit;">. The coordinator will be informed on the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIYRuZRT_REPORTING_EVT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> event </font><font style="vertical-align: inherit;">, which we plan at the start once a minute. In the event handler, we will call</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zclDIYRuZRT_ReportTemp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which will read the temperature of the sensor and send a message.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">zclDIYRuZRT_ReportTemp</span><span class="hljs-params">( <span class="hljs-keyword">void</span> )</span>
</span>{
  <span class="hljs-comment">//  </span><font></font>
  zclDIYRuZRT_MeasuredValue = readTemperature();<font></font>
  <font></font>
  <span class="hljs-keyword">const</span> uint8 NUM_ATTRIBUTES = <span class="hljs-number">1</span>;<font></font>
<font></font>
  zclReportCmd_t *pReportCmd;<font></font>
<font></font>
  pReportCmd = osal_mem_alloc(<span class="hljs-keyword">sizeof</span>(zclReportCmd_t) +<font></font>
                              (NUM_ATTRIBUTES * <span class="hljs-keyword">sizeof</span>(zclReport_t)));
  <span class="hljs-keyword">if</span> (pReportCmd != <span class="hljs-literal">NULL</span>) {<font></font>
    pReportCmd-&gt;numAttr = NUM_ATTRIBUTES;<font></font>
<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrID = ATTRID_MS_TEMPERATURE_MEASURED_VALUE;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].dataType = ZCL_DATATYPE_INT16;<font></font>
    pReportCmd-&gt;attrList[<span class="hljs-number">0</span>].attrData = (<span class="hljs-keyword">void</span> *)(&amp;zclDIYRuZRT_MeasuredValue);<font></font>
<font></font>
    zclDIYRuZRT_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;<font></font>
    zclDIYRuZRT_DstAddr.addr.shortAddr = <span class="hljs-number">0</span>;<font></font>
    zclDIYRuZRT_DstAddr.endPoint = <span class="hljs-number">1</span>;<font></font>
<font></font>
    zcl_SendReportCmd(DIYRuZRT_ENDPOINT, &amp;zclDIYRuZRT_DstAddr,<font></font>
                      ZCL_CLUSTER_ID_MS_TEMPERATURE_MEASUREMENT, pReportCmd,<font></font>
                      ZCL_FRAME_CLIENT_SERVER_DIR, <span class="hljs-literal">false</span>, SeqNum++);<font></font>
  }<font></font>
<font></font>
  osal_mem_free(pReportCmd);<font></font>
}<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. Pour firmware into the device</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To change devboard to Sonoff BASICZBR3, you need to adjust the matching of the LED pins and buttons. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eg/fu/we/egfuweya8lj53yh-5rarbvslzvk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redo LED 1 on pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0_7</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to control the relay. Inclusion is carried out by a high level of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACTIVE_HIGH</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">We re-hang the </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">on pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the information LED 2 on </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P1_0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We leave the temperature sensor on pin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We make all these changes in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hal_board_cfg_DIYRuZRT.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">. To select a configuration, we will make a separate directive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_SONOFF</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If it is set, then the settings for Sonoff BASICZBR3 will be used, otherwise for devboard.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> HAL_SONOFF</span>
  <span class="hljs-comment">/* 1 - P0_7  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_BV           BV(7)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_SBIT         P0_7</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_DDR          P0DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_POLARITY     ACTIVE_HIGH</span><font></font>
<font></font>
  <span class="hljs-comment">/* 2 - P1_0  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV           BV(0)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT         P1_0</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY     ACTIVE_LOW</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
  <span class="hljs-comment">/* 1 - P1_0  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_BV           BV(0)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_SBIT         P1_0</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED1_POLARITY     ACTIVE_LOW</span><font></font>
<font></font>
  <span class="hljs-comment">/* 2 - P1_1  */</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_BV           BV(1)</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_SBIT         P1_1</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_DDR          P1DIR</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LED2_POLARITY     ACTIVE_LOW</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another important parameter had to be corrected - the presence of "watch" quartz, because </font><font style="vertical-align: inherit;">On the Sonoff BASICZBR3 board it is not soldered:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//#define HAL_CLOCK_CRYSTAL</span>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> OSC32K_CRYSTAL_INSTALLED FALSE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Without these options, the firmware does not start (or rather, not always). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, we collect the firmware and connect to the firmware.</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATTENTION!!! </font><font style="vertical-align: inherit;">Disconnect the Sonoff BASICZBR3 relay from the AC power before any connection and firmware!</font></font></b></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We connect Sonoff BASICZBR3 wiring with CCDebugger, erase the chip and flash our firmware.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bz/w-/3b/bzw-3bib84ucfczt0kg_mmbajtw.jpeg"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11. We start the device in zigbee2mqtt and ioBroker.Zigbee</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although the device we have appeared in the list of connected devices and we can manage it by sending commands, but we need to do this more correctly - with pictures and states. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get a new device in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker.Zigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you need to perform 2 steps:</font></font><br>
<br>
<ol>
<li>     <b>zigbee-herdsman-converters</b>.       ,       <b>zigbee2mqtt</b>.<br>
</li>
<li>    <b>ioBroker.Zigbee</b><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All changes can be made first in local files, and then done PR in the corresponding repositories. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We find the location of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee-herdsman-converters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">in the installed ioBroker (or zigbee2mqtt). Inside the package we find the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devices.js</font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/Koenkk/zigbee-herdsman-converters/blob/master/devices.js</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This file contains descriptions of all the devices that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioBroker.zigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee2mqtt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can work </font><b><font style="vertical-align: inherit;">with</font></b><font style="vertical-align: inherit;"> . We find in it a block of descriptions of DIYRuZ devices (after 2300 lines). Add a description of the new device to this block:</font></font><br>
<br>
<pre><code class="javascript hljs">&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">zigbeeModel</span>: [<span class="hljs-string">'DIYRuZ_RT'</span>],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">model</span>: <span class="hljs-string">'DIYRuZ_RT'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">vendor</span>: <span class="hljs-string">'DIYRuZ'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">description</span>: <span class="hljs-string">''</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">supports</span>: <span class="hljs-string">'on/off, temperature'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">fromZigbee</span>: [fz.on_off, fz.temperature],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">toZigbee</span>: [tz.on_off],<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fromZigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attribute </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> we specify the converters that will process messages coming from the device. Our two posts are standardized. The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fz.on_off</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> converter </font><font style="vertical-align: inherit;">processes the on / off message, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fz.temperature processes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the temperature data. The code of these converters (located in the file converters / fromZigbee.js) shows how incoming messages are processed and that the temperature is divided by 100.</font></font><br>
<br>
<pre><code class="javascript hljs">   on_off: {
        <span class="hljs-attr">cluster</span>: <span class="hljs-string">'genOnOff'</span>,
        <span class="hljs-attr">type</span>: [<span class="hljs-string">'attributeReport'</span>, <span class="hljs-string">'readResponse'</span>],
        <span class="hljs-attr">convert</span>: <span class="hljs-function">(<span class="hljs-params">model, msg, publish, options, meta</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (msg.data.hasOwnProperty(<span class="hljs-string">'onOff'</span>)) {
                <span class="hljs-keyword">const</span> property = getProperty(<span class="hljs-string">'state'</span>, msg, model);
                <span class="hljs-keyword">return</span> {[property]: msg.data[<span class="hljs-string">'onOff'</span>] === <span class="hljs-number">1</span> ? <span class="hljs-string">'ON'</span> : <span class="hljs-string">'OFF'</span>};<font></font>
            }<font></font>
        },<font></font>
    },<font></font>
</code></pre><br>
<pre><code class="javascript hljs"> temperature: {
        <span class="hljs-attr">cluster</span>: <span class="hljs-string">'msTemperatureMeasurement'</span>,
        <span class="hljs-attr">type</span>: [<span class="hljs-string">'attributeReport'</span>, <span class="hljs-string">'readResponse'</span>],
        <span class="hljs-attr">convert</span>: <span class="hljs-function">(<span class="hljs-params">model, msg, publish, options, meta</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> temperature = <span class="hljs-built_in">parseFloat</span>(msg.data[<span class="hljs-string">'measuredValue'</span>]) / <span class="hljs-number">100.0</span>;
            <span class="hljs-keyword">return</span> {<span class="hljs-attr">temperature</span>: calibrateAndPrecisionRoundOptions(temperature, options, <span class="hljs-string">'temperature'</span>)};<font></font>
        },<font></font>
    },<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toZigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attribute, </font><b><font style="vertical-align: inherit;">we</font></b><font style="vertical-align: inherit;"> specify the converters that will process our commands to the device. </font><font style="vertical-align: inherit;">In our case, it is the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tz.on_off</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> converter </font><font style="vertical-align: inherit;">for switching relays. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything added to the "converters". </font><font style="vertical-align: inherit;">Who uses </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigbee2mqtt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - you can already use it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And ioBroker users still add a description of the device to the </font><i><font style="vertical-align: inherit;">ioBroker.zigbee \ lib \ devices.js</font></i><font style="vertical-align: inherit;"> file</font></font><i><font style="vertical-align: inherit;"></font></i><br>
<br>
<pre><code class="javascript hljs">&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">vendor</span>: <span class="hljs-string">'DIYRuZ'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">models</span>: [<span class="hljs-string">'DIYRuZ_RT'</span>],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">icon</span>: <span class="hljs-string">'img/DIYRuZ.png'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">states</span>: [<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.state,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.temperature,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;},<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is enough to indicate exactly the same model, a file with a picture and a list of states. </font><font style="vertical-align: inherit;">In our case, the states are also standard: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">state</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the state of the relay, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temperature</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for displaying temperature values.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oz/fu/zm/ozfuzmz72p-e1lwweegnd4fv74q.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12. What next?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, I could not figure out all the aspects and features that Z-Stack 3.0 provides. </font><font style="vertical-align: inherit;">Most likely I didn‚Äôt even correctly implement some kind of functionality or some built-in mechanisms could be used to implement it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, the above solution can be improved and developed. </font><font style="vertical-align: inherit;">Here are some directions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I could not quickly find solutions for the possibility of connecting child devices via relays. </font><font style="vertical-align: inherit;">Other router devices can execute the permit_join command and connect new devices through themselves, without having to bring the new device to the coordinator. </font><font style="vertical-align: inherit;">The device is represented by a router, it is correctly displayed on the network map, but refuses to execute the ‚Äúpermit_join‚Äù command. </font><font style="vertical-align: inherit;">More precisely, the command executes, but the devices do not connect through it.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, did not implement correct reporting. </font><font style="vertical-align: inherit;">This is a way to configure status notification when you can use the configReport command to specify a list of attributes to send and the frequency of notification.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work with groups.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deal with interrupts and implement polling buttons through interrupts.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, for the following devices you need to deal with power modes and the creation of "sleeping" devices on batteries.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As always, in addition to comments, I invite you to discuss this and other devices in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram chat on Zigbee</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I want to express my gratitude for the support and assistance in the development of my colleagues in the Telegram chat and Zigbee community:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/DJONvl</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/antstar</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/Jager_f</font></font></a></li>
</ul><br>
</blockquote><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main documentation is included in the Z-Stack 3.0.2 SDK and is installed with it. </font><font style="vertical-align: inherit;">But I will give part of the links here:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSAL and HAL </font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TI ZIgbee Wiki</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Create New Application For SmartRF05 + CC2530 SWRA231 Version 1.1</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Z-Stack Home Sample Application User's Guide SWRU354 Version 1.3</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Z-Stack Sample Applications SWRA201 Version 1.6</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Z-Stack Developer's Guide SWRA176 Version 1.12</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Z-Stack 3.0 Developer's Guide Version 1.14</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Z-Stack API SWRA195 Version 1.10</a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">TI CC253x User's Guide</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">https://github.com/formtapez/ZigUP</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Zigbee Cluster Library rev 6</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   DIYRuZ_RT</a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495910/index.html">Installing ROS in a Ubuntu Single-Board IMG Image</a></li>
<li><a href="../en495912/index.html">Smart replay stickers</a></li>
<li><a href="../en495918/index.html">How to reproduce realistic sound in computer games and VR and why it is difficult</a></li>
<li><a href="../en495920/index.html">Implementation Details of the PTPv2 Time Synchronization Protocol</a></li>
<li><a href="../en495924/index.html">Why is it so damn difficult to build a good COVID-19 distribution model?</a></li>
<li><a href="../en495932/index.html">What is the hidden meaning of the authors in the SCRUM Guide. Part 1. About the process</a></li>
<li><a href="../en495934/index.html">DataGovernance in the home</a></li>
<li><a href="../en495938/index.html">A selection of articles on machine learning: cases, guides and studies for March 2020</a></li>
<li><a href="../en495942/index.html">Save time, nerves and man hours</a></li>
<li><a href="../en495944/index.html">Updated TOP50 (rating of CIS supercomputers): dynamics and trends</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>