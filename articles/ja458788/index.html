<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✍🏿 😱 🔔 GTMのカスタムテンプレート：例 👮 ☕️ ↔️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="5月の終わりに、GoogleはGoogleタグマネージャー（GTM）に新機能、カスタムテンプレートまたはカスタムテンプレートを導入しました。それが必要な理由、その使用方法、HTMLタグやJavaScript変数との違いを見てみましょう。
 
 例として、VKontakte動的リターゲティングピクセル...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GTMのカスタムテンプレート：例</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458788/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5月の終わりに、GoogleはGoogleタグマネージャー（GTM）に新機能、カスタムテンプレートまたはカスタムテンプレートを導入しました。</font><font style="vertical-align: inherit;">それが必要な理由、その使用方法、HTMLタグやJavaScript変数との違いを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例として、VKontakte動的リターゲティングピクセルのカスタムテンプレートを作成し、それを介してGTMタグをさらにカスタマイズすることを検討してください。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c-/62/zr/c-62zrfxks1t6c2gfsv0kn2brjm.png"><br>
<a name="habracut"></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   Custom Templates</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Custom Template</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">•  Info</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">•  Fields</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">•  Code</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">•  Permissions</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">      Custom Template</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">• Pageview</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">• AddToCart</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">•  </a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a><br>
<br>
<a name="1"></a><h2>   Custom Templates</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタムテンプレートは、ユーザーが新しいタグまたは変数を作成できるテンプレートです。 GTMには、Google Analyticsタグ、Googleオプティマイズなど、既製のテンプレートがあります（「注目」または「推奨」セクションにあります）。これで、テンプレートでそれらを補完できます。作成後、それらは[カスタム]タブに表示さ</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nx/q_/mu/nxq_mu_uxl6tyiumnl8xbzt6o2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
れます。HTMLタグやJS変数との主な違いは、ユーザーが既製のテンプレートに従ってタグまたは変数を作成するときに、JSコードを操作しないことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーテンプレートのコードは、作成の段階で開発者またはWebアナリストによって記述されます。次に、ユーザーテンプレートに従ってタグまたは変数を作成する場合、すべての対話はインターフェイス（ユーザーテンプレートの作成時にも構成されます）を介して実行されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pe/e2/te/pee2tevqbahm_nplbfgj0btis34.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、HTMLタグやJS変数を記述する場合と比較して、JavaScriptの操作に関する知識やスキルを必要としないため、ユーザーテンプレートに応じたタグや変数のカスタマイズがはるかに簡単になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーテンプレートのもう1つの大きなプラスは、タグのJSコードのエラーにより、サイトを「置く」確率が1桁低下することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、動的リターゲティングタグ「VKontakte」を構成するために、開発者に連絡する必要がなくなりました。GTMの経験のみを持ち、商品に関するデータの転送（サイトで高度なGoogle eコマースを構成）も含めて、すべてを個別に設定できます。</font></font><br>
<br>
<a name="2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタムテンプレートの作成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タグテンプレートを作成しているので、[テンプレート]セクションに移動し、[タグテンプレート]セクションの[新規]ボタンをクリックする必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/bt/sa/cabtsaamxy-zoglccqgvt1v_tra.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、テンプレートエディターが開きます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bf/c3/jf/bfc3jf2xgpkasmc3qvik2tp4wxy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定ウィンドウは</font><font style="vertical-align: inherit;">エディター</font><font style="vertical-align: inherit;">の左側にあり、プレビューウィンドウとコンソールは右側にあります。</font><font style="vertical-align: inherit;">テンプレートの作成と操作に必要な設定ウィンドウには4つのタブがあります。</font></font><br>
<br>
<a name="3"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情報タブ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このタブには、名前、説明、アイコンなどのタグに関する情報が入力されます。</font><font style="vertical-align: inherit;">これは、テンプレートのリストで新しいタグを作成するときに表示される情報</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dd/nm/9f/ddnm9fvcygh2ob6jzkliccqgi1o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
です。タグアイコンの要件があります：PNG、JPEGまたはGIF形式、少なくとも64x64ピクセルの解像度、50 KB以下のサイズ。</font></font><br>
<br>
<a name="4"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドタブ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このセクションでは、テンプレートのインターフェースを作成します。</font><font style="vertical-align: inherit;">インターフェースは、ユーザーが新しいタグまたは変数を作成する段階で対話するさまざまなフィールドとフォームで構成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今後、インターフェースを使用してタグを作成するときにユーザーが入力した情報は、テンプレートコードで使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい要素を追加するには、[フィールドの追加]ボタンをクリックします。</font><font style="vertical-align: inherit;">要素タイプ選択ウィンドウが表示されます</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g5/ko/d7/g5kod7ox7dal761180kpdfhojto.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。GTMでは、次のタイプのインターフェース要素を選択できます。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストボックス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドロップダウンメニュー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックボックス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スイッチ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シンプルなテーブル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ここで各セルを編集できます。</font></font></li>
<li><b> </b>,    ,           « — »;</li>
<li><b> </b>,      ;</li>
<li><b></b>      ,       .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要素を追加したら、わかりやすい名前を付ける必要があります。これは、コードで使用されます。これは一種の変数名です。わかりやすく、作成されたインターフェイス要素の本質を明らかにする必要があります。たとえば、「ID」という名前は特定のものを意味しませんが、「pixelIDs」という名前は、ユーザーが入力したピクセルIDがこの要素に格納されていることをすでに示しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fv/1h/ht/fv1hht_iaatbuhi1ejovajkehhc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、各要素の設定に移動し、必要なプロパティをアクティブにします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さまざまな状況で、インターフェイス要素のさまざまなプロパティが必要となるため、デフォルトではすべて非表示になっているため、ここで必要なものをアクティブ化する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ah/jx/o1/ahjxo1oz0w8fp6pntytshfs1y_o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さまざまなタイプの要素にはさまざまな使用可能なプロパティがあり、最も頻繁に使用される要素を示します。これらはほとんどすべての要素です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.表示名</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これは、タグを作成するときにユーザーがインターフェースに表示する名前です</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jf/lk/-g/jflk-glzt0dahft6vpdx9qrzy8q.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">値の例</font></b><font style="vertical-align: inherit;">。これは、フィールドに入力する値に関するユーザーへのヒントです。3 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/b6/zz/sc/b6zzscielm1pjho74x22rk88c0c.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.ヘルプテキスト</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これは、ユーザーが要素のヘルプアイコンにカーソルを合わせると表示されるテキストです</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nv/wo/qr/nvwoqraide7hp-qrbdjaomwvg3e.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。4。データ検証ルール</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このプロパティでは、ユーザーがフィールドに入力したデータをチェックするための特定のルールを設定でき、必要に応じて、チェックに合格しなかったデータを含むタグを保存しようとしたときに表示されるエラーテキストを設定できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、フィールドに入力する必要があることを指定できます。 2番目の例：ユーザーからメールアドレスを取得する必要があり、ユーザーが入力したデータが正規表現</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。* @。* \ .. *に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一致する必要があることを確認でき</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3s/ma/pb/3smapbl1aorsc4fsvhwpd-1oy4m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
入力したデータが検証ルールに準拠していない場合に表示されるエラーテキストを指定するには、ルールの詳細設定を有効にする必要があります。詳細設定では、</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kb/zw/qr/kbzwqr32irigkreu9bbht9fxf1m.png"><br>
<br>
<img src="https://habrastorage.org/webt/ek/xh/hg/ekxhhgobsta59wpr6uxsbaqzdwg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このルールを有効にする条件を指定することもできます（条件の有効化フィールド）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.包含の条件</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これらは、ユーザーがこのインターフェイス要素を持つ条件です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、テンプレートにインターフェイス要素をオーバーロードしないようにするために、チェックボックスがオンのときに必要な要素の外観を作成できます。</font><font style="vertical-align: inherit;">つまり、ユーザーがピクセル単位で商品データの転送を設定したい場合（これはサイトで設定された高度なGoogle eコマースサイトで可能です）、[dataLayerを使用して商品データを転送する]チェックボックスをオンにし、チェックボックスをオンにした後、タグインターフェースに要素が表示されます。このような転送を構成するために必要です。</font><font style="vertical-align: inherit;">ボックスがチェックされていない場合、インターフェースには要素がありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rp/ui/x_/rpuix__y-ya--_uat8taekcwpa0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、追加直後に要素に割り当てる必要があった要素の名前を示す必要があることに注意します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定を追加してインターフェースを作成すると、すべての変更をプレビューウィンドウですぐに表示してテストできます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/df/bl/l9/dfbll9mc0qvpwcxnbzzx-fbg71g.png"><br>
<br>
<a name="5"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードタブ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このタブはコードエディターです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GTMカスタムテンプレートのコードは「簡略化された」ES6 JavaScriptで記述され、APIを介してグローバルデータとのすべての通信（つまり、ページと直接）が行われる分離された環境で実行されます。</font><font style="vertical-align: inherit;">ウィンドウやドキュメントなどのグローバルオブジェクトは、通常のメソッドにもありません。</font><font style="vertical-align: inherit;">たとえば、コンストラクター（新しいオブジェクトなど）、setTimeout、parseInt、deleteなどです。</font><font style="vertical-align: inherit;">-これはすべてカスタムテンプレートでは機能しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、このためのAPIがあります。</font><font style="vertical-align: inherit;">したがって、カスタムテンプレートのコードを作成するには、コードで使用するAPIを定義する必要があります。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">// API</span><font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> copyFromWindow = <span class="hljs-built_in">require</span>(<span class="hljs-string">'copyFromWindow'</span>);<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> setInWindow = <span class="hljs-built_in">require</span>(<span class="hljs-string">'setInWindow'</span>);<font></font>
<font></font>
<span class="hljs-comment">//     </span>
<span class="hljs-keyword">const</span> injectScript = <span class="hljs-built_in">require</span>(<span class="hljs-string">'injectScript'</span>);<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> callInWindow = <span class="hljs-built_in">require</span>(<span class="hljs-string">'callInWindow'</span>);<font></font>
<font></font>
<span class="hljs-comment">//  ,     ,   </span>
<span class="hljs-keyword">const</span> makeTableMap = <span class="hljs-built_in">require</span>(<span class="hljs-string">'makeTableMap'</span>);<font></font>
<font></font>
<span class="hljs-comment">//   URL </span>
<span class="hljs-keyword">const</span> getUrl = <span class="hljs-built_in">require</span>(<span class="hljs-string">'getUrl'</span>);<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> getQueryParameters = <span class="hljs-built_in">require</span>(<span class="hljs-string">'getQueryParameters'</span>);<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> makeInteger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'makeInteger'</span>);<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> makeString = <span class="hljs-built_in">require</span>(<span class="hljs-string">'makeString'</span>);<font></font>
<font></font>
<span class="hljs-comment">//  setTimeout</span>
<span class="hljs-keyword">const</span> callLater = <span class="hljs-built_in">require</span>(<span class="hljs-string">'callLater'</span>);<font></font>
<font></font>
<span class="hljs-comment">//  console.log</span>
<span class="hljs-keyword">const</span> logToConsole = <span class="hljs-built_in">require</span>(<span class="hljs-string">'logToConsole'</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIの完全なリストと詳細なドキュメントについては、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Googleデベロッパーヘルプを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧ください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIの操作方法の例を紹介します。</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th> </th>
<th> JS</th>
<th>Custom Template API</th>
</tr>
<tr>
<td>  </td>
<td>console.log(‘Hi’);</td>
<td>logToConsole(‘Hi’);</td>
</tr>
<tr>
<td> </td>
<td>setTimeout(function,100);</td>
<td>callLater(function);</td>
</tr>
<tr>
<td>  </td>
<td>String(1234);</td>
<td>makeString(1234);</td>
</tr>
<tr>
<td>   </td>
<td>parseInt(‘1234’,10);</td>
<td>makeInteger(‘1234’);</td>
</tr>
<tr>
<td> </td>
<td>window.location.hostname</td>
<td>getUrl('host');</td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例の表からわかるように、APIを定義した後、標準のJS構造の代わりにそれを使用する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIを定義した後、ユーザーが入力した設定でオブジェクトを定義することが望ましいです。これは、たとえば実行可能コードの実行中に、ユーザーの設定から必要なデータを要求した後に行うこともできます。ただし、最初から設定オブジェクトを定義すると、すべてのユーザー設定が別のオブジェクトに格納されるため、コードの操作がより簡単で理解しやすくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターフェース要素からデータを取得するには、データ構造を使用する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
{{要素名}}：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> settings = {
   <span class="hljs-comment">// </span>
   <span class="hljs-attr">event</span>: data.event,<font></font>
<font></font>
   <span class="hljs-comment">//ID  ()</span>
   <span class="hljs-attr">pixelIDs</span>: data.pixelIDs,<font></font>
<font></font>
   <span class="hljs-comment">//ID - (  1 -)</span>
   <span class="hljs-attr">priceListId</span>: data.priceListId,<font></font>
<font></font>
   <span class="hljs-comment">//   -?</span>
   <span class="hljs-attr">fewPriceLists</span>: data.fewPriceLists,<font></font>
<font></font>
   <span class="hljs-comment">//ID - (    )</span>
   <span class="hljs-attr">priceListIds</span>: data.priceListIds === <span class="hljs-literal">undefined</span> ? data.priceListIds : makeTableMap(data.priceListIds,<span class="hljs-string">'hostname'</span>,<span class="hljs-string">'priceListId'</span>),<font></font>
<font></font>
   <span class="hljs-comment">//  ecommerce   ?</span>
   <span class="hljs-attr">ecommerceUse</span>: data.ecommerceUse,<font></font>
<font></font>
   <span class="hljs-comment">// ecommerce  </span>
   <span class="hljs-attr">eventEcommerce</span>: data.eventEcommerce,<font></font>
<font></font>
   <span class="hljs-comment">//    </span>
   <span class="hljs-attr">siteSearchQueryParam</span>: data.siteSearchQueryParam<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注：undefinedをmakeTableMapメソッドに渡すと、スクリプトエラーが発生するため、3項演算子（短縮されたif-else構文）を使用してこのようなスクリプトを除外します。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">makeTableMapメソッドについて。</font></font></b>
                        <div class="spoiler_text">     ,        :<br>
<br>
<pre><code class="javascript hljs">[
   <span class="hljs-string">'key'</span>: <span class="hljs-string">'k1'</span>, <span class="hljs-string">'value'</span>: <span class="hljs-string">'v1'</span>},
   <span class="hljs-string">'key'</span>: <span class="hljs-string">'k2'</span>, <span class="hljs-string">'value'</span>: <span class="hljs-string">'v2'</span>}<font></font>
]<font></font>
</code></pre><br>
   makeTableMap       « — »:<br>
<br>
<pre><code class="javascript hljs">{
   <span class="hljs-string">'k1'</span>: <span class="hljs-string">'v1'</span>,
   <span class="hljs-string">'k2'</span>: <span class="hljs-string">'v2'</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタムテンプレートコードのもう1つの要件：タグが正常に実行された場合は、data.gtmOnSuccess（）メソッドを呼び出す必要があり、エラーの場合はdata.gtmOnFailure（）メソッドを呼び出す必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、私のコードでは、リクエストが正常に送信された後にdata.gtmOnSuccess（）メソッドが呼び出され、外部スクリプトページVK openapi.jsでダウンロードが失敗するとdata.gtmOnFailure（）メソッドが呼び出されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIを定義し、設定でオブジェクトを定義したら、ピクセルを処理するためのアルゴリズムの記述を開始できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで覚えておくべき主なことは次のとおりです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
•グローバル変数を取得する必要がある場合は、copyFromWindow APIメソッドを使用します。</font></font><br>
<br>
<pre><code class="javascript hljs">copyFromWindow(<span class="hljs-string">'VK'</span>);
<span class="hljs-comment">//VK -   ,    </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
•グローバル変数を設定する必要がある場合は、setInWindow APIメソッドを使用します。</font></font><br>
<br>
<pre><code class="javascript hljs">setInWindow(<span class="hljs-string">'openapiInject'</span>, <span class="hljs-number">1</span>);
<span class="hljs-comment">//openapiInject -   ,   </span>
<span class="hljs-comment">//1 - ,    .</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
•グローバル関数を実行する必要がある場合は、callInWindow APIメソッドを使用します。</font></font><br>
<br>
<pre><code class="javascript hljs">callInWindow(<span class="hljs-string">'VK.Retargeting.Init'</span>, p);
<span class="hljs-comment">//VK.Retargeting.Init -   ,   </span>
<span class="hljs-comment">//p - ,     </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
•ページに外部スクリプトを追加する必要がある場合は、injectScript APIメソッドを使用します。</font></font><br>
<br>
<pre><code class="javascript hljs">injectScript(<span class="hljs-string">'https://vk.com/js/api/openapi.js?159'</span>, pixel.setVkAsyncInit(), data.gtmOnFailure, <span class="hljs-string">'vkPixel'</span>);
<span class="hljs-comment">//https://vk.com/js/api/openapi.js?159 -  ,     </span>
<span class="hljs-comment">//pixel.setVkAsyncInit() - ,       </span>
<span class="hljs-comment">//data.gtmOnFailure - ,       </span>
<span class="hljs-comment">//vkPixel -  ,  ,   URL  .    ,   JavaScript      </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
•URL（またはその一部）を取得する必要がある場合-getUrl APIメソッドを使用します。</font></font><br>
<br>
<pre><code class="javascript hljs">getUrl(<span class="hljs-string">'host'</span>);
<span class="hljs-comment">//host -  URL,  .  ,  host: protocol, port, path, extension, fragment, query.</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上で書いたように、カスタムテンプレートはJS ES6をサポートしています。</font><font style="vertical-align: inherit;">この構文を使用することをお勧めします。これにより、コードが短縮されて読みやすくなり、JSの作業がより予測可能になり、他のプログラミング言語と同様になります。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JS ES6構文の詳細を読む</font></font></b>
                        <div class="spoiler_text">,   , —       const  let  var.<br>
 <br>
,   const, —  ,    .<br>
<br>
,   let,     var :<br>
<br>
<ul>
<li>let      window;</li>
<li>  let   ;</li>
<li>,   let,   .</li>
</ul><br>
        :<br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//1.  </span>
<span class="hljs-keyword">const</span> func1 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
   <span class="hljs-keyword">return</span> <span class="hljs-string">'test'</span>;<font></font>
}<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> func1 = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-string">'test'</span>;<font></font>
<font></font>
<span class="hljs-comment">//2.  </span>
<span class="hljs-keyword">const</span> func2 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arg</span>) </span>{
   <span class="hljs-keyword">if</span> (arg &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'plus'</span>;
   <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">'minus'</span>;<font></font>
}<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> func2 = <span class="hljs-function"><span class="hljs-params">arg</span> =&gt;</span> {
   <span class="hljs-keyword">if</span> (arg &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'plus'</span>;
   <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">'minus'</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//3.  </span>
<span class="hljs-keyword">const</span> func3 = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arg1, arg2</span>)</span>{
   <span class="hljs-keyword">if</span> (arg1 &gt; arg2) <span class="hljs-keyword">return</span> arg1;
   <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> arg2;<font></font>
}<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> func3 = <span class="hljs-function">(<span class="hljs-params">arg1, arg2</span>) =&gt;</span> {
   <span class="hljs-keyword">if</span> (arg1 &gt; arg2) <span class="hljs-keyword">return</span> arg1;
   <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> arg2;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタムテンプレートAPIの使用方法を理解したので、JavaScript ES6構文を使用してタグ操作コードを記述できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のコードには、ピクセルの起動、VK openapi.jsのインストール、dataLayerからの製品データの取得（Googleの高度な電子商取引サイトで構成されている場合）、このデータを処理してVKontakteリターゲティングピクセルに送信するために必要な形式にするためのメソッドが含まれています、およびイベントディスパッチメソッド。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ピクセルトリガーメソッドは、3つのシナリオをサポートします。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ピクセルは、openapi.jsがないページで実行されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ピクセルはopenapi.jsがあるページで実行されますが、まだ読み込まれていません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ピクセルは、openapi.jsが読み込まれたページから始まります。</font></font></li>
</ol><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VKontakteピクセルダイナミックリターゲティング用のカスタムGTMテンプレートの完全なコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment">//api</span>
<span class="hljs-keyword">const</span> copyFromWindow = <span class="hljs-built_in">require</span>(<span class="hljs-string">'copyFromWindow'</span>);
<span class="hljs-keyword">const</span> setInWindow = <span class="hljs-built_in">require</span>(<span class="hljs-string">'setInWindow'</span>);
<span class="hljs-keyword">const</span> injectScript = <span class="hljs-built_in">require</span>(<span class="hljs-string">'injectScript'</span>);
<span class="hljs-keyword">const</span> callInWindow = <span class="hljs-built_in">require</span>(<span class="hljs-string">'callInWindow'</span>);
<span class="hljs-keyword">const</span> makeTableMap = <span class="hljs-built_in">require</span>(<span class="hljs-string">'makeTableMap'</span>);
<span class="hljs-keyword">const</span> getUrl = <span class="hljs-built_in">require</span>(<span class="hljs-string">'getUrl'</span>);
<span class="hljs-keyword">const</span> getQueryParameters = <span class="hljs-built_in">require</span>(<span class="hljs-string">'getQueryParameters'</span>);
<span class="hljs-keyword">const</span> makeInteger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'makeInteger'</span>);
<span class="hljs-keyword">const</span> makeString = <span class="hljs-built_in">require</span>(<span class="hljs-string">'makeString'</span>);
<span class="hljs-keyword">const</span> callLater = <span class="hljs-built_in">require</span>(<span class="hljs-string">'callLater'</span>);<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> settings = {
   <span class="hljs-attr">event</span>: data.event,
   <span class="hljs-attr">pixelIDs</span>: data.pixelIDs,
   <span class="hljs-attr">priceListId</span>: data.priceListId,
   <span class="hljs-attr">fewPriceLists</span>: data.fewPriceLists,
   <span class="hljs-attr">priceListIds</span>: data.priceListIds === <span class="hljs-literal">undefined</span> ? data.priceListIds : makeTableMap(data.priceListIds,<span class="hljs-string">'hostname'</span>,<span class="hljs-string">'priceListId'</span>),
   <span class="hljs-attr">ecommerceUse</span>: data.ecommerceUse,
   <span class="hljs-attr">eventEcommerce</span>: data.eventEcommerce,
   <span class="hljs-attr">siteSearchQueryParam</span>: data.siteSearchQueryParam<font></font>
};<font></font>
<font></font>
<span class="hljs-comment">//      </span>
<span class="hljs-keyword">const</span> pixel = {
   <span class="hljs-comment">//   </span>
   <span class="hljs-attr">getPageHostname</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> getUrl(<span class="hljs-string">'host'</span>),<font></font>
<font></font>
   <span class="hljs-comment">//    VK</span>
   <span class="hljs-attr">getVK</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> copyFromWindow(<span class="hljs-string">'VK'</span>),<font></font>
<font></font>
   <span class="hljs-comment">//    VK</span>
   <span class="hljs-attr">setVkAsyncInit</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
       setInWindow(<span class="hljs-string">'vkAsyncInit'</span>, pixel.sendEvent);<font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//      </span>
   <span class="hljs-attr">getSiteSearchPhrase</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
       <span class="hljs-keyword">if</span> (settings.event === <span class="hljs-string">'view_search'</span>) <span class="hljs-keyword">return</span> getQueryParameters(settings.siteSearchQueryParam);
       <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;<font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//     </span>
   <span class="hljs-attr">getEventParams</span>: <span class="hljs-function">(<span class="hljs-params">products, currencyCode, revenue</span>) =&gt;</span> {
       <span class="hljs-keyword">let</span> eventParamsClean= {};
       <span class="hljs-keyword">let</span> eventParams = {
           <span class="hljs-attr">products</span>: eventProducts.getProductParams(products),
           <span class="hljs-attr">category_ids</span>: eventProducts.getCategoryString(products),
           <span class="hljs-attr">currency_code</span>: currencyCode,
           <span class="hljs-attr">total_price</span>: eventProducts.getTotalPrice(products, revenue),
           <span class="hljs-attr">search_string</span>: pixel.getSiteSearchPhrase()<font></font>
       };<font></font>
       <span class="hljs-keyword">if</span> (eventParams.products !== <span class="hljs-literal">undefined</span>) eventParamsClean.products = eventParams.products;
       <span class="hljs-keyword">if</span> (eventParams.category_ids !== <span class="hljs-literal">undefined</span>) eventParamsClean.category_ids = eventParams.category_ids;
       <span class="hljs-keyword">if</span> (eventParams.currency_code !== <span class="hljs-literal">undefined</span>) eventParamsClean.currency_code = eventParams.currency_code;
       <span class="hljs-keyword">if</span> (eventParams.total_price !== <span class="hljs-literal">undefined</span>) eventParamsClean.total_price = eventParams.total_price;
       <span class="hljs-keyword">if</span> (eventParams.search_string !== <span class="hljs-literal">undefined</span>) eventParamsClean.search_string = eventParams.search_string;
       <span class="hljs-keyword">return</span> eventParamsClean;<font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//  -</span>
   <span class="hljs-attr">getPriceListId</span>: <span class="hljs-function"><span class="hljs-params">hostname</span> =&gt;</span> {
       <span class="hljs-keyword">if</span> (settings.fewPriceLists) <span class="hljs-keyword">return</span> settings.priceListIds[hostname];
       <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> settings.priceListId;<font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//  openapi.js</span>
   <span class="hljs-attr">openapiInit</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
       injectScript(<span class="hljs-string">'https://vk.com/js/api/openapi.js?159'</span>, pixel.setVkAsyncInit(), data.gtmOnFailure, <span class="hljs-string">'vkPixel'</span>);<font></font>
       setInWindow(<span class="hljs-string">'openapiInject'</span>, <span class="hljs-number">1</span>);<font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//  </span>
   <span class="hljs-attr">sendEvent</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
       <span class="hljs-keyword">if</span> (settings.event === <span class="hljs-string">'hit'</span>) {<font></font>
           settings.pixelIDs.split(<span class="hljs-string">','</span>).forEach(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> {<font></font>
               callInWindow(<span class="hljs-string">'VK.Retargeting.Init'</span>,p);<font></font>
               callInWindow(<span class="hljs-string">'VK.Retargeting.Hit'</span>);<font></font>
           });<font></font>
       } <span class="hljs-keyword">else</span> {
           <span class="hljs-keyword">const</span> pricelist = pixel.getPriceListId(pixel.getPageHostname());
           <span class="hljs-keyword">const</span> name = settings.event;
           <span class="hljs-keyword">let</span> products = [];
           <span class="hljs-keyword">if</span>(settings.ecommerceUse) products = name === <span class="hljs-string">'view_home'</span> || name === <span class="hljs-string">'view_category'</span> || name === <span class="hljs-string">'view_search'</span> || name === <span class="hljs-string">'view_other'</span> ? settings.eventEcommerce : settings.eventEcommerce.products;
           <span class="hljs-keyword">else</span> products = <span class="hljs-literal">undefined</span>;
           <span class="hljs-keyword">const</span> currencyCode = settings.ecommerceUse ? settings.eventEcommerce.currencyCode : <span class="hljs-literal">undefined</span>;
           <span class="hljs-keyword">const</span> revenue = (settings.ecommerceUse &amp;&amp; name === <span class="hljs-string">'purchase'</span>) ? settings.eventEcommerce.actionField.revenue : <span class="hljs-literal">undefined</span>;
           <span class="hljs-keyword">const</span> eventParams = settings.ecommerceUse ? pixel.getEventParams(products, currencyCode, revenue) : <span class="hljs-literal">undefined</span>;<font></font>
           settings.pixelIDs.split(<span class="hljs-string">','</span>).forEach(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> {<font></font>
               callInWindow(<span class="hljs-string">'VK.Retargeting.Init'</span>,p);<font></font>
               callInWindow(<span class="hljs-string">'VK.Retargeting.ProductEvent'</span>, pricelist, name, eventParams);<font></font>
           });<font></font>
       <font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//  </span>
   <span class="hljs-attr">start</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
       <span class="hljs-keyword">if</span> (pixel.getVK() === <span class="hljs-literal">undefined</span> &amp;&amp; copyFromWindow(<span class="hljs-string">'openapiInject'</span>) !== <span class="hljs-number">1</span>) {<font></font>
           pixel.openapiInit();<font></font>
           data.gtmOnSuccess();<font></font>
       } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pixel.getVK() === <span class="hljs-literal">undefined</span> &amp;&amp; copyFromWindow(<span class="hljs-string">'openapiInject'</span>) === <span class="hljs-number">1</span>) {
           <span class="hljs-keyword">if</span> (pixel.count &lt; <span class="hljs-number">50</span>) {<font></font>
               callLater(pixel.start);<font></font>
               pixel.count++;<font></font>
           } <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span>;<font></font>
       } <span class="hljs-keyword">else</span> {<font></font>
           pixel.sendEvent();<font></font>
           data.gtmOnSuccess();<font></font>
       <font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//  </span>
   <span class="hljs-attr">count</span>: <span class="hljs-number">0</span><font></font>
};<font></font>
<font></font>
<span class="hljs-comment">//      </span>
<span class="hljs-keyword">const</span> eventProducts = {
   <span class="hljs-comment">//    products  </span>
   <span class="hljs-attr">getProductParams</span>: <span class="hljs-function"><span class="hljs-params">products</span> =&gt;</span> {
       <span class="hljs-keyword">let</span> arr = [];<font></font>
       products.forEach(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> {
           <span class="hljs-keyword">let</span> productParamsClean = {};
           <span class="hljs-keyword">let</span> productParams = {
               <span class="hljs-attr">id</span>: makeString(i.id),
               <span class="hljs-attr">group_id</span>: makeString(i.brand),
               <span class="hljs-attr">price</span>: makeInteger(i.price * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span><font></font>
           };<font></font>
           <span class="hljs-keyword">if</span> (productParams.id !== <span class="hljs-string">'undefined'</span>) productParamsClean.id = productParams.id;
           <span class="hljs-keyword">if</span> (productParams.group_id !== <span class="hljs-string">'undefined'</span>) productParamsClean.group_id = productParams.group_id;
           <span class="hljs-keyword">if</span> (productParams.price !== <span class="hljs-number">0</span>) productParamsClean.price = productParams.price;<font></font>
           arr.push(productParamsClean);<font></font>
       });<font></font>
       <span class="hljs-keyword">return</span> arr;<font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//       'a,b,c'      </span>
   <span class="hljs-attr">getCategoryString</span>: <span class="hljs-function"><span class="hljs-params">products</span> =&gt;</span> {
       <span class="hljs-keyword">let</span> categoryId = <span class="hljs-string">''</span>;
       <span class="hljs-keyword">let</span> check = [];<font></font>
       products.forEach(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> {
           <span class="hljs-keyword">if</span>(check.indexOf(i.category) === <span class="hljs-number">-1</span>) {<font></font>
               check.push(i.category);<font></font>
               categoryId += <span class="hljs-string">','</span> + i.category;<font></font>
           <font></font>
       });<font></font>
       <span class="hljs-keyword">return</span> categoryId.slice(<span class="hljs-number">1</span>);<font></font>
   },<font></font>
<font></font>
   <span class="hljs-comment">//    </span>
   <span class="hljs-attr">getTotalPrice</span>: <span class="hljs-function">(<span class="hljs-params">products, revenue</span>) =&gt;</span> {
       <span class="hljs-keyword">let</span> sumPrice = <span class="hljs-number">0</span>;
       <span class="hljs-keyword">if</span> (revenue !== <span class="hljs-literal">undefined</span> ) <span class="hljs-keyword">return</span> makeInteger(revenue * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>;
       <span class="hljs-keyword">else</span> {<font></font>
           products.forEach(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> {
               <span class="hljs-keyword">if</span> (i.hasOwnProperty(<span class="hljs-string">'quantity'</span>)) sumPrice += (makeInteger(i.price * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>) * makeInteger(i.quantity);
               <span class="hljs-keyword">else</span> sumPrice += makeInteger(i.price * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>;<font></font>
           });<font></font>
           <span class="hljs-keyword">return</span> sumPrice;<font></font>
       <font></font>
   <font></font>
};<font></font>
<font></font>
<span class="hljs-comment">// </span>
pixel.start();</code></pre><br>
</div>
                    </div><br>
<a name="6"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">権限タブ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タグコードを記述した後、最後のステップは残ります-ページのグローバルデータを操作するためのアクセス許可を発行します。これは、[権限]タブでのみ実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは分離された環境で実行され、グローバルデータとのやり取りはAPIを介して行われるため、APIメソッドごとに（必要な場合）、特定のアクションの権限を手動で指定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、グローバルページデータを使用する作業にできる限り慎重に取り組み、テンプレートのコードでサイトをエラーに陥らせる可能性を最小限に抑えるために行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードで使用されるAPIメソッドには、3つのタイプの権限を発行する必要があります</font></font><br>
<br>
<img src="https://habrastorage.org/webt/29/og/lw/29oglwyra6zkhac7_2lr4jpqq5a.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。1.グローバル変数にアクセスします</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-コードで使用されるグローバル変数への読み取り、書き込み、実行アクセス。</font><font style="vertical-align: inherit;">変数は手動で追加する必要があり、変数ごとに、許可されていることを示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f3/qb/6b/f3qb6b9sj6rn1v4q55t_z9f362e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、VK変数は読み取り専用で、vkAsyncInitは読み取りと再定義が可能で、VK.Retargeting.Hitメソッドは実行のみが可能です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. URLを読み取ります</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ここでは、URLの受信を許可する部分を指定する必要があります。</font><font style="vertical-align: inherit;">URLの任意の部分の受信を許可します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/do/um/li/doumlixqd-rw2cppm4ordw1svae.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、必要に応じて、特定のものを指定できます</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sj/d3/ne/sjd3nefe52_foeat88kifeodi-w.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">スクリプトを挿入し</font></b><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ここでは、外部スクリプトをダウンロードできるアドレスを指定する必要があります。</font><font style="vertical-align: inherit;">私のコードでは、VK openapi.jsを含む1つのスクリプトのみが読み込まれ、そのアドレスを指定しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xt/oy/hd/xtoyhd-yprd2sn_eu41mbquh2s0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以上で、カスタムテンプレートのセットアップは完了です。テンプレートを保存して、テストに進むことができます。</font></font><br>
<br>
<a name="7"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成されたカスタムテンプレートでのタグのカスタマイズとテスト</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例として、作成したカスタムテンプレートを使用して、2つのVKontakte動的リターゲティングタグを作成します：pageviewとaddToCart。</font></font><br>
<br>
<a name="8"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページビュー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なGTMコンテナーに移動し、新しいタグを作成し、カスタムセクションでVKピクセルのタグタイプを選択します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gd/s-/fi/gds-fi0tqxxcmfkkccsi8trowq4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タグ名を入力し、追跡イベントヒットを選択します（これは標準のページビューです）、[ピクセルID]フィールドで、ピクセルの送信先となる2つのピクセルのIDを指定しますデータ、トリガーを設定し</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vr/op/-0/vrop-0cjfqndkh35qnbtdsoxpc4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます</font><font style="vertical-align: inherit;">すべてのページ：</font><font style="vertical-align: inherit;">作成したタグを保存します。</font></font><br>
<br>
<a name="9"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カートに追加</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カートに商品を追加するイベントのタグを作成することは、ヒットタグよりも少し複雑になります。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、バスケットに追加された商品を転送する必要があります。上で書いたように、これはサイトに設定されたGoogleの高度なeコマースで可能です。この場合、製品データはdataLayerから取得されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのためには、GTMでdataLayer変数を作成する必要があります。この変数には、addToCartイベントのeコマースオブジェクトが格納されます。変数の設定は次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ko/r5/gu/kor5gumudjjzs9groemuo7nepco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、eコマースのaddToCartイベントが発生したときにタグをアクティブにするトリガーを作成する必要があります（addToCartイベントが発生したときにdataLayerをプッシュすると、トリガーがタグをアクティブにします）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/xl/lt/ogxlltp_4_spurvq8fesqg3uy0m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eコマースオブジェクトとトリガーで変数を作成したら、タグの作成を開始できます：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dp/qg/zq/dpqgzqb27rcdydnjeen5fftp6ba.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
順番に：</font></font><br>
<br>
<ol>
<li>     Add To Cart.</li>
<li>   ID  ,     .</li>
<li>  «  -»:           -.</li>
<li>   -.</li>
<li>  « ecommerce     ».</li>
<li>  ecommerce      .</li>
<li>    ,    — AddToCart.</li>
<li>.</li>
</ol><br>
<a name="10"></a><h3> </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VKontakteでの動的リターゲットのピクセルの動作を確認するには、GTMでプレビューモードをアクティブにし、Webサイトにアクセスしてブラウザーコンソールの[ネットワーク]セクションを開き、[フィルター]フィールドに「rtrg」と入力します。</font></font><br>
<img src="https://habrastorage.org/webt/ci/m9/z8/cim9z824mbc9dfvdz-4425fe02w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、ページが更新され、2つのリクエスト-イベントが発生します。 2ピクセルで送信されたヒット：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o0/5x/80/o05x80jeypiwcogusca_zgsnaju.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ステータス200は、リクエストがサーバーによって正常に送受信されたことを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、プレビューGTMウィンドウでは、作成したタグがページビューイベントで正しく機能していることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add To Cartイベントを確認するには、商品をカートに追加します。コンソールには、さらに2つのリクエストがあります</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wt/jm/-k/wtjm-k50mmapqa1xtyva_yd3wcc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。GTMプレビューウィンドウで、2番目のタグが正常に機能していることがわかります。 dataLayerからの製品データはプルアップされて正しく処理され、正しい価格表も代用されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のホストの場合、価格リストも正しく置き換え</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n3/de/h3/n3deh30jep61h2kv9zefwruu8cy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
られます。他のイベントのタグは、同じ方法で構成およびチェックされます。</font></font><br>
<br>
<a name="11"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタムテンプレートは、GTMの使い慣れたパラダイムを変えています。</font><font style="vertical-align: inherit;">誰もがHTMLタグとJS変数に慣れていますが、今では素晴らしい代替手段があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
高品質のカスタムテンプレートを1回作成するだけで十分で、GTMに精通している人なら誰でもそれを使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作成したテンプレートを共有する機能があれば、ユーザーに人気が出てくると思います。</font><font style="vertical-align: inherit;">この記事で検討し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;"> VKontakte </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">カスタム</font></a><font style="vertical-align: inherit;">ダイナミックリターゲティングピクセル</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">テンプレート</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウンロード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でき</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンプレートをインポートするには、新しいカスタムテンプレートを作成して、メニューから[インポート]を選択する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mx/nn/jc/mxnnjc0419poxmshokabjcgeoye.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素材には、出版ppc.world掲載することにより調製しました</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458774/index.html">機能的なDBMS</a></li>
<li><a href="../ja458778/index.html">Satellite 6.5 Reporting Engine：何を、そしてなぜ</a></li>
<li><a href="../ja458782/index.html">ZXスペクトラムのプログラムを最新の手段でTR-DOSに適合させます。パート3</a></li>
<li><a href="../ja458784/index.html">Altium DesignerからPADS Professionalにプロジェクトとライブラリをブロードキャスト</a></li>
<li><a href="../ja458786/index.html">ビデオゲームキーパーがゲーム文化を段階的に維持</a></li>
<li><a href="../ja458790/index.html">CatBoostの概要。Yandexレポート</a></li>
<li><a href="../ja458792/index.html">「焦げた」従業員：方法はありますか？</a></li>
<li><a href="../ja458794/index.html">7月18日Redmadrobotでのビジネスアナリスト会議</a></li>
<li><a href="../ja458796/index.html">重いワークロードにサイトを準備する方法：5つの実用的なヒントと便利なツール</a></li>
<li><a href="../ja458798/index.html">NutrientBot、またはフィットネストレーナーからパンを取りたい方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>