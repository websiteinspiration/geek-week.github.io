<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍💻 🔄 👨🏿‍🌾 How to build a rocket accelerator for PowerCLI scripts  😇 👩🏼‍🏫 🖇️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sooner or later, any VMware system administrator gets to automate routine tasks. It all starts from the command line, then comes PowerShell or VMware ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to build a rocket accelerator for PowerCLI scripts </h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/498628/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sooner or later, any VMware system administrator gets to automate routine tasks. </font><font style="vertical-align: inherit;">It all starts from the command line, then comes PowerShell or VMware PowerCLI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose you’ve mastered PowerShell a bit further than starting ISE and using standard cmdlets from modules that work with some kind of magic. </font><font style="vertical-align: inherit;">When you start counting hundreds of virtual machines, you will find that scripts that helped out on small scales work noticeably slower on large ones.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this situation, 2 tools will help out:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell Runspaces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - an approach that allows you to parallelize the execution of processes in separate threads;&nbsp;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get-View</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a basic PowerCLI function, an analogue of Get-WMIObject on Windows. </font><font style="vertical-align: inherit;">This cmdlet does not drag objects related to it, but receives information in the form of a simple object with simple data types. </font><font style="vertical-align: inherit;">In many cases, it comes out faster.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, I will briefly talk about each tool and show examples of use. </font><font style="vertical-align: inherit;">We will analyze specific scripts and see when one works best, when the second. </font><font style="vertical-align: inherit;">Go!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/2q/fe/xp2qfe2m-lyc8feedka2nyhc2sq.jpeg"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First Stage: Runspace</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, Runspace is designed for parallel processing of tasks outside the main module. </font><font style="vertical-align: inherit;">Of course, you can start another process that will eat some memory, processor, etc. If your script runs in a couple of minutes and spends a gigabyte of memory, you probably will not need Runspace. </font><font style="vertical-align: inherit;">But for scripts on tens of thousands of objects it is needed.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can start the development from here:&nbsp; </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginning Use of PowerShell Runspaces: Part 1</font></font></a></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What gives use of Runspace:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">speed by limiting the list of executable commands,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parallel tasks</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">safety.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is an example from the internet when Runspace helps:</font></font><br>
<blockquote>«    –   ,     vSphere.  vCenter     ,      .  ,        PowerShell.<br>
 ,     VMware      vCenter          .&nbsp;&nbsp;<br>
  PowerShell runspaces,    ESXi          Runspace     .   PowerShell   ,        ,     ». <br>
<br>
<i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">How to Show Virtual Machine I/O on an ESXi Dashboard</a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case below, Runspace is no longer in business:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“I'm trying to write a script that collects a lot of data from the VM and, if necessary, writes new data. </font><font style="vertical-align: inherit;">The problem is that there are a lot of VMs, and it takes 5-8 seconds for one machine. ”&nbsp;</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multithreading PowerCLI with RunspacePool</font></font></a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View is needed here, let's move on to it.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Second stage: Get-View</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand the usefulness of Get-View, remember how cmdlets work in general.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cmdlets are needed to conveniently obtain information without having to study API reference books and reinvent the wheel. What in the old days was written in a hundred or two lines of code, PowerShell allows you to do one command. For this convenience we pay speed. Inside the cmdlets themselves, there is no magic: the same script, but of a lower level, written by the skilled hands of a master from sunny India. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, for comparison with Get-View, take the Get-VM cmdlet: it accesses the virtual machine and returns a composite object, that is, attaches other related objects to it: VMHost, Datastore, etc.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View in its place does not screw anything extra into the returned object. </font><font style="vertical-align: inherit;">Moreover, it allows you to rigidly indicate exactly what information we need, which will facilitate the object at the output. </font><font style="vertical-align: inherit;">In Windows Server in general, and in Hyper-V in particular, the Get-WMIObject cmdlet is a direct analogue - the idea is exactly the same. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View is inconvenient in routine operations on point features. </font><font style="vertical-align: inherit;">But when it comes to thousands and tens of thousands of objects, he has no price.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read more on the VMware Blog: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction to Get-View</font></font></a></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I’ll show everything on a real case.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We write a script for unloading a VM</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once my colleague asked me to optimize his script. </font><font style="vertical-align: inherit;">The task is a normal routine: find all VMs with a duplicate cloud.uuid parameter (yes, this is possible when cloning a VM in vCloud Director).&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The obvious solution that comes to mind:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get a list of all VMs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Somehow parse the list.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The original version was such a simple script:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-CloudUUID1</span></span> {
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vms</span> = <span class="hljs-built_in">Get-VM</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   ,     2 :    Cloud UUID.</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     PS-   VM  UUID</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vm</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vms</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span> = <span class="hljs-string">""</span> | <span class="hljs-built_in">select</span> VM,UUID<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span>.VM = <span class="hljs-variable">$vm</span>.name
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span>.UUID = (<span class="hljs-variable">$vm</span> | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> cloud.uuid).Value<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span> += <span class="hljs-variable">$table</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<span class="hljs-comment">#   </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span><font></font>
}<font></font>
<span class="hljs-comment">#     </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is extremely simple and clear. It is written in a couple of minutes with a coffee break. Screw on the filter, and it's done. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But measure the time: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iz/xb/i-/izxbi-_-xo9odcuouzqan83vd1o.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/kv/xy/fb/kvxyfb7lj5asvvkm3nuebjljcx0.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 minutes 47 seconds</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> when processing almost 10k VM. A bonus is the lack of filters and the need to manually sort the result. Obviously, the script is asking for optimization. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ransepses are the first to come to the rescue when you need to get host metrics with vCenter at one time or you need to process tens of thousands of objects. Let's see what this approach will give. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We turn on the first speed: PowerShell Runspaces</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The first thing that comes to mind for this script is to execute the loop not in series, but in parallel threads, collect all the data in one object and filter it.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there is a problem: PowerCLI will not allow us to open many independent sessions to vCenter and will throw a funny error:</font></font><br>
<br>
<pre><code class="plaintext hljs">You have modified the global:DefaultVIServer and global:DefaultVIServers system variables. This is not allowed. Please reset them to $null and reconnect to the vSphere server.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve it, you must first pass session information into the stream. </font><font style="vertical-align: inherit;">We recall that PowerShell works with objects that can be passed as a parameter to at least a function, at least to ScriptBlock. </font><font style="vertical-align: inherit;">Let's pass the session as such an object bypassing $ global: DefaultVIServers (Connect-VIServer with the -NotDefault key):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$ConnectionString</span> = <span class="hljs-selector-tag">@</span>()
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vCenter</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vCenters</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-AllLinked</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (<span class="hljs-variable">$er</span>.Message <span class="hljs-operator">-like</span> <span class="hljs-string">"*not part of a linked mode*"</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we implement multithreading through Runspace Pools.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The algorithm is as follows:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get a list of all VMs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In parallel threads we get cloud.uuid.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We collect data from streams into one object.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We filter the object through grouping by the value of the CloudUUID field: those where the number of unique values ​​is more than 1, and there are the desired VMs.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we get the script:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-VMCloudUUID</span></span> {
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">param</span> (<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">string</span>[]]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">ValidateNotNullOrEmpty</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vCenters</span> = <span class="hljs-selector-tag">@</span>(),<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$MaxThreads</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.PSCredential</span>]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.Credential</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span><font></font>
&nbsp;&nbsp;&nbsp;)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vCenter</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vCenters</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-AllLinked</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (<span class="hljs-variable">$er</span>.Message <span class="hljs-operator">-like</span> <span class="hljs-string">"*not part of a linked mode*"</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Global:AllVMs</span> = <span class="hljs-built_in">Get-VM</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># !</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ISS</span> = [<span class="hljs-type">system.management.automation.runspaces.initialsessionstate</span>]::CreateDefault()
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span> = [<span class="hljs-type">runspacefactory</span>]::CreateRunspacePool(<span class="hljs-number">1</span>, <span class="hljs-variable">$MaxThreads</span>, <span class="hljs-variable">$ISS</span>, <span class="hljs-variable">$Host</span>)
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.ApartmentState = <span class="hljs-string">"MTA"</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Open()
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Jobs</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
<span class="hljs-comment"># ScriptBlock  !)))</span>
<span class="hljs-comment">#      </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$scriptblock</span> = {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">Param</span> (
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$VM</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Data</span> = <span class="hljs-variable">$VM</span> | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> Cloud.uuid <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Entity.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={<span class="hljs-variable">$_</span>.Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.Entity.PowerState}}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> <span class="hljs-variable">$Data</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<span class="hljs-comment">#  </span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$VM</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$AllVMs</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$PowershellThread</span> = [<span class="hljs-type">PowerShell</span>]::Create()
<span class="hljs-comment">#  </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddScript(<span class="hljs-variable">$scriptblock</span>)
<span class="hljs-comment">#  ,      </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddArgument(<span class="hljs-variable">$ConnectionString</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddArgument(<span class="hljs-variable">$VM</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$PowershellThread</span>.RunspacePool = <span class="hljs-variable">$RunspacePool</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Handle</span> = <span class="hljs-variable">$PowershellThread</span>.BeginInvoke()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span> = <span class="hljs-string">""</span> | <span class="hljs-built_in">Select-Object</span> Handle, Thread, object
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Handle = <span class="hljs-variable">$Handle</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread = <span class="hljs-variable">$PowershellThread</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Object = <span class="hljs-variable">$VM</span>.ToString()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Jobs</span> += <span class="hljs-variable">$Job</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment">#      </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">While</span> (<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle <span class="hljs-operator">-ne</span> <span class="hljs-variable">$Null</span>}).count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Remaining</span> = <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | Where-Object {<span class="hljs-variable">$_</span>.Handle.IsCompleted -eq <span class="hljs-variable">$False</span>}).object)"</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">If</span> (<span class="hljs-variable">$Remaining</span>.Length <span class="hljs-operator">-gt</span> <span class="hljs-number">60</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Remaining</span> = <span class="hljs-variable">$Remaining</span>.Substring(<span class="hljs-number">0</span>,<span class="hljs-number">60</span>) + <span class="hljs-string">"..."</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">Write-Progress</span> <span class="hljs-literal">-Activity</span> <span class="hljs-string">"Waiting for Jobs - <span class="hljs-variable">$</span>(<span class="hljs-variable">$MaxThreads</span> - <span class="hljs-variable">$</span>(<span class="hljs-variable">$RunspacePool</span>.GetAvailableRunspaces())) of <span class="hljs-variable">$MaxThreads</span> threads running"</span> <span class="hljs-literal">-PercentComplete</span> ((<span class="hljs-variable">$Jobs</span>.count - <span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle.IsCompleted <span class="hljs-operator">-eq</span> <span class="hljs-variable">$False</span>}).count)) / <span class="hljs-variable">$Jobs</span>.Count * <span class="hljs-number">100</span>) <span class="hljs-literal">-Status</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(@(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | Where-Object {<span class="hljs-variable">$_</span>.Handle.IsCompleted -eq <span class="hljs-variable">$False</span>})).count) remaining - <span class="hljs-variable">$remaining</span>"</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ForEach</span> (<span class="hljs-variable">$Job</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle.IsCompleted <span class="hljs-operator">-eq</span> <span class="hljs-variable">$True</span>})){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread.EndInvoke(<span class="hljs-variable">$Job</span>.Handle)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread.Dispose()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread = <span class="hljs-variable">$Null</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Handle = <span class="hljs-variable">$Null</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Close() | <span class="hljs-built_in">Out-Null</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Dispose() | <span class="hljs-built_in">Out-Null</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-CloudUUID2</span></span><font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">param</span>(<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">string</span>[]]<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">ValidateNotNullOrEmpty</span>()]
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vCenters</span> = <span class="hljs-selector-tag">@</span>(),<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$MaxThreads</span> = <span class="hljs-number">50</span>,<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.PSCredential</span>]<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.Credential</span>()]
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span>)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>(!<span class="hljs-variable">$Credential</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span> = <span class="hljs-built_in">Get-Credential</span> <span class="hljs-literal">-Message</span> <span class="hljs-string">"Please enter vCenter credentials."</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   Get-VMCloudUUID,    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$AllCloudVMs</span> = <span class="hljs-built_in">Get-VMCloudUUID</span> <span class="hljs-literal">-vCenters</span> <span class="hljs-variable">$vCenters</span> <span class="hljs-literal">-MaxThreads</span> <span class="hljs-variable">$MaxThreads</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Result</span> = <span class="hljs-variable">$AllCloudVMs</span> | <span class="hljs-built_in">Sort-Object</span> Value | <span class="hljs-built_in">Group-Object</span> <span class="hljs-literal">-Property</span> CloudUUID | <span class="hljs-built_in">Where-Object</span> <span class="hljs-literal">-FilterScript</span> {<span class="hljs-variable">$_</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">1</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> <span class="hljs-built_in">Group</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Result</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The beauty of this script is that it can be used in other similar cases, simply replacing the ScriptBlock and the parameters that will be transferred to the stream. Exploit it! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We measure time: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d_/hr/ji/d_hrjiq58scxnha1wiknf9jd1zw.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">55 seconds.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Already better, but still faster.&nbsp; </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We pass to the second speed: GetView</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We find out what is wrong. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First and obvious: the Get-VM cmdlet takes a long time to complete. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Second: the Get-AdvancedOptions cmdlet runs even longer. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, let's deal with the second.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-AdvancedOptions is convenient on individual VM objects, but very slow when working with many objects. </font><font style="vertical-align: inherit;">We can get the same information from the virtual machine object itself (Get-VM). </font><font style="vertical-align: inherit;">It's just that it is well buried in the ExtensionData object. </font><font style="vertical-align: inherit;">Armed with filtering, we accelerate the process of obtaining the necessary data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With a flick of the wrist this is:</font></font><br>
<br>
<pre><code class="powershell hljs">
VM | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> Cloud.uuid <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Entity.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={<span class="hljs-variable">$_</span>.Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.Entity.PowerState}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Turns into this:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-variable">$VM</span> | <span class="hljs-built_in">Where-Object</span> {(<span class="hljs-variable">$_</span>.ExtensionData.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={(<span class="hljs-variable">$_</span>.ExtensionData.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.summary.runtime.powerstate}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The conclusion is the same as Get-AdvancedOptions, but it works many times faster.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now to Get-VM. It is not executed quickly, since it deals with complex objects. A logical question arises: why in this case do we need extra information and a monstrous PSObject when we just need the name of the VM, its state and value of the tricky attribute?&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, the brake in the face of Get-AdvancedOptions has left the script. The use of Runspace Pools now seems overkill, since there is no longer any need to parallelize a slow task in streams with squats when transferring a session. The tool is good, but not for this case.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We look at the output of ExtensionData: it is nothing but a Get-View object.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's call the ancient technique of the PowerShell masters: one line using filters, sorts and groupings. All previous horror elegantly collapses into one line and is executed in one session:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-variable">$AllVMs</span> = <span class="hljs-built_in">Get-View</span> <span class="hljs-literal">-viewtype</span> VirtualMachine <span class="hljs-literal">-Property</span> Name,Config.ExtraConfig,summary.runtime.powerstate | <span class="hljs-built_in">Where-Object</span> {(<span class="hljs-variable">$_</span>.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={(<span class="hljs-variable">$_</span>.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.summary.runtime.powerstate}} | <span class="hljs-built_in">Sort-Object</span> CloudUUID | <span class="hljs-built_in">Group-Object</span> <span class="hljs-literal">-Property</span> CloudUUID | <span class="hljs-built_in">Where-Object</span> <span class="hljs-literal">-FilterScript</span> {<span class="hljs-variable">$_</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">1</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> <span class="hljs-built_in">Group</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We measure time: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iy/x4/7q/iyx47qcshcsbjbglrcwi_zzceps.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 seconds</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for almost 10k objects with filtering according to the desired condition. </font><font style="vertical-align: inherit;">Fine! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead of a conclusion An</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
acceptable result directly depends on the choice of tool. </font><font style="vertical-align: inherit;">It is often difficult to say for sure what exactly should be chosen to achieve it. </font><font style="vertical-align: inherit;">Each of the listed script acceleration methods is good within the limits of its applicability. </font><font style="vertical-align: inherit;">I hope this article will help you in the difficult task of understanding the basics of process automation and their optimization in your infrastructure. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The author thanks all the members of the commune for their help and support in preparing the article. </font><font style="vertical-align: inherit;">Even those with paws. </font><font style="vertical-align: inherit;">And even who has no legs, like a boa constrictor.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498612/index.html">Do not decide for the designer the task of the designer</a></li>
<li><a href="../en498614/index.html">Analysis of a series of promotional videos for the game Spin Voyage</a></li>
<li><a href="../en498618/index.html">Android in an industrial controller</a></li>
<li><a href="../en498620/index.html">Touching the world: human skin receptor biomechanics</a></li>
<li><a href="../en498624/index.html">[Instruction] Creating Google tests (Google forms)</a></li>
<li><a href="../en498630/index.html">Physical simulation of hundreds of thousands of particles on Unity + DOTS</a></li>
<li><a href="../en498632/index.html">Peptide for a beautiful mulatto</a></li>
<li><a href="../en498634/index.html">11 stupid questions to an orthopedist and masseuse about working at a computer and not only</a></li>
<li><a href="../en498636/index.html">Simple shader for point lights in fog</a></li>
<li><a href="../en498638/index.html">3D arcade in the browser: how we made the game on React + Redux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>