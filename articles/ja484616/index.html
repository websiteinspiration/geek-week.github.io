<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😺 🔂 👀 Node.jsサービスのパフォーマンス最適化の経験から学んだ6つの教訓 🍧 ✊🏾 👩🏿‍🤝‍👩🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Klarnaは、開発者が高品質で安全なサービスを作成できるように多大な努力を払いました。開発者向けのツールの1つは、A / Bテストを実行するためのプラットフォームです。このシステムの最も重要なコンポーネントは、着信要求ごとに、要求を送信するテストのタイプ（AまたはB）を決定する多数のプロセスです。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Node.jsサービスのパフォーマンス最適化の経験から学んだ6つの教訓</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/484616/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klarnaは、開発者が高品質で安全なサービスを作成できるように多大な努力を払いました。開発者向けのツールの1つは、A / Bテストを実行するためのプラットフォームです。このシステムの最も重要なコンポーネントは、着信要求ごとに、要求を送信するテストのタイプ（AまたはB）を決定する多数のプロセスです。これにより、ボタンの表示方法、ユーザーに表示するレイアウト、または使用するサードパーティのパッケージが決まります。これらの決定は、ユーザーエクスペリエンスに直接影響します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/uj/lq/cw/ujlqcwr9lf7qwjnjafp_m6v2yme.jpeg"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KlarnaはNode.jsプラットフォームを使用しています </font><font style="vertical-align: inherit;">本日の翻訳は、会社のスペシャリストがサービスのパフォーマンスを最適化した経験から学んだレッスンに特化しています。</font></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レッスン番号1：パフォーマンステストでは、リリースごとにシステムの速度が低下しないことを確信できる</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのプロセスはKlarnaエコシステムの重要な意思決定パスで同期的に使用されるため、各プロセスのパフォーマンスは大きな役割を果たします。</font><font style="vertical-align: inherit;">このようなタスクの通常のパフォーマンス要件は、要求の99.9％の場合、決定は遅延して行われる必要があることであり、その時間は1桁で表されます。</font><font style="vertical-align: inherit;">システムがこれらの要件から逸脱しないことを確認するために、同社はサービスのストレステスト用のコンベヤを開発しました。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レッスン2：負荷を個別に「巻き上げ」、問題が生産に達する前でも特定できる</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プラットフォームが運用環境で使用されている2年間、パフォーマンス上の問題はほとんどありませんでしたが、テストによって明らかにいくつかの問題が明らかになりました。</font><font style="vertical-align: inherit;">テストの数分以内に、リクエストをある程度安定したレベルで受信すると、リクエストの処理時間は通常の値から数秒に急激に増加しました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9bc/092/03e/9bc09203e2bd4a2f442e70c43e5570d9.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストの処理に必要な時間に関する情報。</font><font style="vertical-align: inherit;">問題がいくつか明らかになりまし</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
たが、本番環境ではまだ発生していませんが、これは時間の問題であると判断しました。</font><font style="vertical-align: inherit;">実際の負荷が一定のレベルに達すると、同様の問題が発生する可能性があります。</font><font style="vertical-align: inherit;">したがって、この問題を調査する必要があることが決定されました。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レッスン番号3：長期ストレステストでは、さまざまな問題を特定できます。</font><font style="vertical-align: inherit;">問題がなければ、テストの期間を長くしてみてください。</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意が必要なもう1つのことは、システムの問題が負荷のかかった作業の2〜3分後に現れることです。</font><font style="vertical-align: inherit;">最初は、2分間だけテストを実行しました。</font><font style="vertical-align: inherit;">また、テストの実行時間が10分に増加したときにのみ問題が発生しました。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レッスン番号4：発信要求を考慮して、名前のDNS解決に必要な時間を考慮することを忘れないでください。</font><font style="vertical-align: inherit;">キャッシュエントリの有効期間を無視しないでください-これはアプリケーションを深刻に混乱させる可能性があります</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、次のメトリックを使用してサービスを監視します。1秒あたりの受信リクエスト数、受信リクエストの処理時間、エラーのレベル。</font><font style="vertical-align: inherit;">これにより、システムの状態に関するかなり良い指標が得られ、システムに問題があるかどうかが示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、これらのメトリックは、サービスの誤動作中に価値ある情報を提供しません。</font><font style="vertical-align: inherit;">何か問題が発生した場合、システムのボトルネックがどこにあるかを知る必要があります。</font><font style="vertical-align: inherit;">このような場合、Node.jsランタイムが使用するリソースを監視する必要があります。</font><font style="vertical-align: inherit;">問題のある状況で状態が監視されるインジケーターの構成には、プロセッサーとメモリーの使用が含まれることは明らかです。</font><font style="vertical-align: inherit;">ただし、システムの速度がそれらに依存しない場合もあります。</font><font style="vertical-align: inherit;">たとえば、私たちのケースでは、プロセッサ使用率のレベルは低かったです。</font><font style="vertical-align: inherit;">メモリ消費量についても同様です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Node.jsプロジェクトのパフォーマンスを決定するもう1つのリソースは、イベントループです。プロセスで使用されているメモリの量を知ることが重要であるのと同様に、イベントループを処理するために必要な「タスク」の数を知る必要があります。 Node.jsのイベントループはC ++ libuvライブラリで実装されている（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、それについての良いビデオ）。 「タスク」は、本明細書では「アクティブな要求」と呼ばれる。別の重要な指標は、Node.jsプロセスで使用される開いているファイル記述子またはソケットによって表される「アクティブハンドル」の数です。記述子タイプの完全なリストは、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ドキュメント</font></a><font style="vertical-align: inherit;">にあり</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libuvへ。その結果、テストが30の接続を使用する場合、システムには30のアクティブな記述子があることが期待できます。アクティブな要求の数を特徴付けるインジケーターは、特定の記述子をインラインで待機している操作の数を示します。これらはどのような操作ですか？たとえば、読み取り/書き込み操作。それらの完全なリストは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスメトリックを分析した後、ここで問題が発生していることがわかりました。アクティブな記述子の数は予想どおりでしたが（このテストでは約30）、アクティブな要求の数は非常に多く、数万に上ります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/263/190/d76/263190d766b15ca41050043d82d7bdc0.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクティブな記述子とアクティブな要求</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
しかし、キューにどのような種類の要求があるかはまだわかりませんでした。アクティブなクエリをタイプに分けた後、状況は少し改善されました。つまり、リクエストは非常に目立ちました</font></font><code>UV_GETADDRINFO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 Node.jsがDNS名を解決しようとしたときに生成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムがDNS名解決要求を非常に多く生成するのはなぜですか？</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">使用</font></a><font style="vertical-align: inherit;">している</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"> StatsD</font></a><font style="vertical-align: inherit;">クライアントが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各発信メッセージのホスト名を解決しようとしました。このクライアントはDNSクエリの結果をキャッシュする可能性を提供しますが、対応するDNSレコードのTTLはここでは考慮されないことに注意してください。結果は無期限にキャッシュされます。その結果、クライアントが対応する名前をすでに解決した後でレコードが更新された場合、クライアントはそれを知ることはありません。 StatsDロードバランサーは別のIPアドレスで再デプロイでき、DNSキャッシュを更新するためにサービスを強制的に再起動できないため、無制限のキャッシュを使用するこのアプローチは適していませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策は、DNSクエリをキャッシュするためにクライアントの外部の手段を使用することでした。</font><font style="vertical-align: inherit;">これは、DNSモジュールの「モンキーパッチ」を実行することで簡単に実行できます。</font><font style="vertical-align: inherit;">結果は以前よりもはるかに良く見えました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86c/f85/4f2/86cf854f2638044c29561353253a96f5.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストの処理に必要な時間に関する情報。</font><font style="vertical-align: inherit;">外部DNSキャッシュを使用した結果</font></font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レッスン＃5：I / O操作をバッチモードで実行します。</font><font style="vertical-align: inherit;">このような操作は、非同期であっても、深刻なリソース消費者です。</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の問題を解決した後、以前に無効にしたサービスの一部の機能をオンにして、再度テストしました。</font><font style="vertical-align: inherit;">特に、着信リクエストごとにKafkaトピックにメッセージを送信するコードが含まれています。</font><font style="vertical-align: inherit;">このテストでも、長い時間間隔で観測された応答時間（秒について話している）の測定結果に有意なピークが見られました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/af6/134/596/af61345966c133da6903fc0328314d09.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストの処理に必要な時間に関する情報。</font><font style="vertical-align: inherit;">テストの</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
結果</font><i><font color="#999999"><font style="vertical-align: inherit;">、回答の形成に必要な時間が大幅に増加している</font></font></i><font style="vertical-align: inherit;">ことがわかりました</font><i><font color="#999999"><font style="vertical-align: inherit;">。</font></font></i><font style="vertical-align: inherit;">これらの結果は、テスト前に組み込んだ関数に明らかな問題があることを示しています。</font><font style="vertical-align: inherit;">特に、カフカへのメッセージの送信には時間がかかりすぎるという事実に直面しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ad7/8de/687/ad78de687656c182f9516d7c56b7cc06.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kafkaのメッセージを生成するために必要な時間に関する情報</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ここでは、最も単純な改善を使用することにしました。送信メッセージをメモリのキューに入れ、これらのメッセージを毎秒バッチモードで送信します。</font><font style="vertical-align: inherit;">テストを再度実行することにより、サービスが応答を形成するのに必要な時間に明らかな改善が見られました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab2/3ba/330/ab23ba3302b44744e219828e3375788a.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストの処理に必要な時間に関する情報。</font><font style="vertical-align: inherit;">バッチメッセージ処理を整理した後の改善</font></font></font></i><br>
 <br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レッスン6：システムを改善する前に、テストを準備します。その結果は信頼できます。</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスのパフォーマンスの最適化に関する上記の作業は、再現性のある一貫した結果を得ることができるテスト実行メカニズムなしでは不可能でした。私たちのテストシステムの最初のバージョンでは、統一された結果が得られなかったため、重要な決定を下す際にそれに頼ることができませんでした。信頼性の高いテストシステムの作成に投資した結果、さまざまなモードでプロジェクトをテストし、修正を試すことができました。新しいテストシステムは、ほとんどの場合、得られたテスト結果が現実のものであり、どこから来たものでもないという確信を私たちに与えました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストを整理するために使用される特定のツールについて少し説明しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
負荷は、Locustを分散モードで簡単に実行できるようにする内部ツールによって生成されました。</font><font style="vertical-align: inherit;">一般に、すべては単一のコマンドの実行に帰着し、その後、負荷ジェネレーターが起動され、テストスクリプトがそれらに転送され、Grafanaコントロールパネルによって視覚化された結果が収集されました。</font><font style="vertical-align: inherit;">対応する結果は、背景が暗いグラフの資料に表示されます。</font><font style="vertical-align: inherit;">これは、クライアントの観点からシステムがテストでどのように見えるかです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テスト中のサービスは、データログに測定情報を提供します。</font><font style="vertical-align: inherit;">この情報は、背景が明るいグラフで表示されます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読者の皆様！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのNode.jsサービステストシステムを使用していますか？</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja484604/index.html">新年、新しいブラウザ：Microsoft Edgeの予備評価が終了し、ダウンロードできるようになりました</a></li>
<li><a href="../ja484606/index.html">マイクロソフトは2030年までにマイナスの炭素排出量に完全に切り替えます</a></li>
<li><a href="../ja484610/index.html">さよならクリーンコード</a></li>
<li><a href="../ja484612/index.html">プロジェクトのビルド時間を最適化する</a></li>
<li><a href="../ja484614/index.html">安全なGoアプリケーションを開発するための6つの推奨事項</a></li>
<li><a href="../ja484618/index.html">Angular 9とIvy：遅延コンポーネント読み込み</a></li>
<li><a href="../ja484620/index.html">Omega Red Emulator用の新しいPS1グラフィックレンダラー</a></li>
<li><a href="../ja484624/index.html">インターバル断食-時間を正確に計算する方法</a></li>
<li><a href="../ja484628/index.html">ウィキペディア/グーグルの検閲の例としてのエリック・チャラメラ</a></li>
<li><a href="../ja484630/index.html">CES 2020：驚きの時</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>