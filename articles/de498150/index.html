<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÅ üîë üîΩ Klempnerprogrammierer oder die Geschichte eines Lecks und die Schwierigkeiten, damit umzugehen üë®üèæ‚Äçüåæ ü§∂üèΩ ü§æüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es war Dienstag, der 25. Februar. Die schwierige Ver√∂ffentlichung der Version am Samstag, den 22. Februar, war bereits in der Vergangenheit. Es schien...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Klempnerprogrammierer oder die Geschichte eines Lecks und die Schwierigkeiten, damit umzugehen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498150/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es war Dienstag, der 25. Februar. Die schwierige Ver√∂ffentlichung der Version am Samstag, den 22. Februar, war bereits in der Vergangenheit. Es schien, als sei das Schlimmste zur√ºckgeblieben, und nichts deutete auf √Ñrger hin. Es √§nderte sich jedoch alles auf einmal, als ein √úberwachungsfehler zu einem Speicherverlust im Koordinatorprozess des Zugriffskontrolldienstes f√ºhrte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Woher? Die letzten gr√∂√üeren √Ñnderungen in der Codebasis des Koordinators waren in der vorherigen Version vor mehr als zwei Monaten vorgenommen worden, und danach passierte dem Speicher nichts Bemerkenswertes. Leider waren die √úberwachungspl√§ne unnachgiebig - das Ged√§chtnis des Koordinators begann offensichtlich irgendwo zu lecken, eine gro√üe Pf√ºtze wurde auf der Servicefl√§che zur Schau gestellt, was bedeutet, dass das Sanit√§r-Team viel zu tun hatte.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/sz/a5/nc/sza5ncpnbgd9jxdzckmeu1bztsi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst machen wir einen kleinen Exkurs. </font><font style="vertical-align: inherit;">Mit VLSI k√∂nnen Sie unter anderem die Arbeitszeiten verfolgen und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den Zugriff</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> anhand von Gesichtsmodellen, Fingerabdr√ºcken oder Zugangskarten </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">√ºberwachen</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Gleichzeitig kommuniziert VLSI mit Endpoint Controllern (Schl√∂sser, Drehkreuze, Zugangsterminals usw.). </font><font style="vertical-align: inherit;">Ein separater Dienst kommuniziert mit Ger√§ten. </font><font style="vertical-align: inherit;">Es ist passiv und interagiert mit Zugriffssteuerungsger√§ten basierend auf ihren eigenen Protokollen, die √ºber HTTP (S) implementiert sind. </font><font style="vertical-align: inherit;">Es basiert auf dem Standardstapel f√ºr Services in unserem Unternehmen: Die PostgreSQL-Datenbank Python 3 wird f√ºr die Gesch√§ftslogik verwendet und mit C / C ++ - Methoden von unserer Plattform aus erweitert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein typischer Webdienstknoten besteht aus folgenden Prozessen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitor ist der Root-Prozess.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Koordinator ist ein untergeordneter Prozess eines Monitors.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeits prozess.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitor ist der erste Webdienstprozess. </font><font style="vertical-align: inherit;">Seine Aufgabe ist es, fork () aufzurufen, den Prozess des untergeordneten Koordinators zu starten und seine Arbeit zu √ºberwachen. </font><font style="vertical-align: inherit;">Der Koordinator ist der Hauptprozess des Webdienstes. Er empf√§ngt Anforderungen von externen Ger√§ten, sendet Antworten und gleicht die Last aus. </font><font style="vertical-align: inherit;">Der Koordinator sendet die Anforderung zur Ausf√ºhrung an die Arbeitsprozesse, f√ºhrt sie aus, sendet die Antwort an den gemeinsam genutzten Speicher und informiert den Koordinator dar√ºber, dass die Aufgabe abgeschlossen ist, und Sie k√∂nnen das Ergebnis abrufen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wer ist schuld und was zu tun?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher unterscheidet sich der Koordinator des Zugriffskontrolldienstes von den Koordinatoren anderer Dienste in unserem Unternehmen durch das Vorhandensein eines Webservers. Die Koordinatoren anderer Dienste arbeiteten ohne Lecks, daher musste das Problem in unserer Konfiguration gesucht werden. Schlimmer noch, auf den Pr√ºfst√§nden gab es die neue Version schon lange, und niemand bemerkte Speicherprobleme. Sie begannen genauer hinzuschauen und stellten fest, dass die Erinnerung nur auf einem der St√§nde flie√üt, und selbst dann mit unterschiedlichem Erfolg - was bedeutet, dass das Problem immer noch nicht so leicht reproduzierbar ist.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c_/lg/_k/c_lg_kswgcknpdyc8k2h7bd22d8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist zu tun? Wie finde ich einen Grund? Zun√§chst haben wir einen Speicherauszug erstellt und ihn zur Analyse an Spezialisten von der Plattform gesendet. Das Ergebnis - es gibt nichts im Dump: keinen Grund, keinen Hinweis, in welche Richtung man weiter schauen soll. Wir haben die √Ñnderungen im Code des Koordinators gegen√ºber der vorherigen Version √ºberpr√ºft - pl√∂tzlich haben wir einige schreckliche √Ñnderungen vorgenommen, aber das nicht sofort verstanden? Aber nein - nur ein paar Kommentare wurden zum Koordinatorcode hinzugef√ºgt, aber ein paar Methoden wurden in neue Dateien verschoben - im Allgemeinen nichts Kriminelles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie begannen, auf unsere Kollegen zu schauen - Entwickler des Kerns unseres Dienstes. Sie bestritten zuversichtlich die M√∂glichkeit einer Beteiligung an unserem Ungl√ºck, boten jedoch an, die Tracemalloc-√úberwachung in den Dienst zu implantieren. Kaum gesagt als getan, beim n√§chsten Hotfix schlie√üen wir den Service ab, testen ihn schnell und geben ihn f√ºr den Kampf frei.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und was sehen wir? Jetzt flie√üt unser Ged√§chtnis nicht nur schnell, sondern auch sehr schnell weg - das Wachstum ist exponentiell geworden. Der erste Peak wird b√∂sen M√§chten und verwandten Faktoren zugeschrieben, aber der zweite Peak, einige Stunden nach dem ersten, macht deutlich, dass es zu lange dauert, bis der n√§chste Hotfix mit einem solchen Notfallverhalten des Dienstes ver√∂ffentlicht wird. Daher nehmen wir die Ergebnisse von tracemalloc und patchen den Service, wobei wir die √Ñnderungen mit √úberwachung zur√ºcksetzen, um zumindest zum linearen Wachstum zur√ºckzukehren.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zl/yh/w7/zlyhw7-3oq-9wxxwkvwvsl8gd08.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es schien, als h√§tten wir die Ergebnisse der Arbeit von tracemalloc f√ºr den in Python zugewiesenen Speicher erhalten. Jetzt werden wir sie untersuchen und den Schuldigen des Lecks finden, aber es war nicht vorhanden - in den gesammelten Daten sind keine 5,5-GB-Peaks in den √úberwachungsdiagrammen zu sehen. Der maximal verwendete Speicher betr√§gt nur 250 MB, und sogar traceMalloc belegt 130 MB davon. Dies ist teilweise erkl√§rbar - mit tracemalloc k√∂nnen Sie die Speicherdynamik in Python anzeigen, es ist jedoch nichts √ºber die Speicherzuweisung in C- und C ++ - Paketen bekannt, die von unserer Plattform implementiert werden. Es war nicht m√∂glich, etwas Interessantes in den erhaltenen Daten zu finden, der Speicher wird in akzeptablen Volumina gew√∂hnlichen Objekten wie Streams, Strings und W√∂rterb√ºchern zugewiesen - im Allgemeinen nichts Verd√§chtiges. Dann haben wir beschlossen, alles √úberfl√ºssige aus den Daten zu entfernen, nur den gesamten Speicherverbrauch und die gesamte Zeit zu belassen und zu visualisieren.Obwohl die Visualisierung nicht dazu beigetragen hat, die Fragen ‚ÄûWas passiert‚Äú und ‚ÄûWarum‚Äú zu beantworten, haben wir mit ihrer Hilfe eine Korrelation mit den Daten aus der √úberwachung festgestellt - was bedeutet, dass wir definitiv irgendwo ein Problem haben und danach suchen m√ºssen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yr/es/gp/yresgpdyry0i_dr88dbtswqr8k8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem Zeitpunkt gingen unserem Klempnerteam die Ideen aus, wo nach einem Leck gesucht werden sollte. Gl√ºcklicherweise hat uns der Vogel vorgesungen, dass eine wesentliche √Ñnderung von der Plattform stattgefunden hat - die Python-Version wurde von 3.4 auf 3.7 ge√§ndert, und dies ist ein riesiges Suchfeld. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben uns entschlossen, im Internet nach Problemen im Zusammenhang mit Speicherlecks in Python 3.7 zu suchen, da dieses Verhalten mit Sicherheit bereits auf jemanden gesto√üen ist. Trotzdem wurde Python 3.7 vor langer Zeit ver√∂ffentlicht, wir haben erst mit dem aktuellen Update darauf umgestellt. Gl√ºcklicherweise wurde die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antwort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf unsere Frage schnell gefunden, und es gab auch ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pull-Anfrage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um das Problem zu beheben, und sie selbst war an den √Ñnderungen beteiligt, die von den Python-Entwicklern vorgenommen wurden. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist passiert?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ab Version 3.7 hat sich das Verhalten der ThreadingMixIn-Klasse ge√§ndert, von der wir von unserem Webserver erben, um jede Anforderung in einem separaten Thread zu verarbeiten. In der ThreadingMixIn-Klasse haben sie den Eintrag aller erstellten Threads zu einem Array hinzugef√ºgt. Aufgrund solcher √Ñnderungen werden Klasseninstanzen, die Ger√§teverbindungen verarbeiten, nach Abschluss nicht freigegeben, und der Garbage Collector in Python kann den Speicher nicht aus verbrauchten Threads l√∂schen. Dies f√ºhrte zu einem linearen Wachstum des zugewiesenen Speichers in direktem Verh√§ltnis zur Anzahl der Anforderungen an unseren Server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist es, der heimt√ºckische Code des Python-Moduls mit einem gro√üen Loch (der Code in Python 3.5 wird links vor √Ñnderungen angezeigt, rechts - in 3.7 danach):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/pp/87/0mpp87t9snuuoadbahwaoxw2jj8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als wir den Grund herausfanden, konnten wir das Leck leicht beseitigen: In unserer Erbenklasse haben wir den Wert der Flagge ge√§ndert, die das alte Verhalten zur√ºckgegeben hat, und das ist alles - ein Sieg! </font><font style="vertical-align: inherit;">Streams werden wie zuvor erstellt, ohne in die Klassenvariable zu schreiben, aber wir sehen ein angenehmes Bild in den √úberwachungsgraphen - das Leck wurde behoben! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1o/ja/ss/1ojassz9esw-378romz5kexysde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist sch√∂n, nach einem Sieg dar√ºber zu schreiben. </font><font style="vertical-align: inherit;">Wir sind wahrscheinlich nicht die Ersten, die nach dem Wechsel zu Python 3.7 auf dieses Problem sto√üen, aber h√∂chstwahrscheinlich nicht die Letzten. </font><font style="vertical-align: inherit;">F√ºr uns selbst kamen wir zu dem Schluss, dass wir:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gehen Sie ernsthafter vor, um die m√∂glichen Folgen gr√∂√üerer √Ñnderungen zu bewerten, insbesondere wenn andere angewandte Entscheidungen von uns abh√§ngen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberpr√ºfen Sie Ihren Code bei globalen √Ñnderungen der Plattform, z. B. beim √Ñndern der Python-Version, auf m√∂gliche Probleme.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reagieren Sie auf verd√§chtige √Ñnderungen in den √úberwachungspl√§nen nicht nur von Kampfdiensten, sondern auch von Testdiensten. </font><font style="vertical-align: inherit;">Trotz des aktuellen Garbage Collector gibt es auch in Python Speicherlecks.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bei Speicheranalysetools wie tracemalloc ist Vorsicht geboten, da eine falsche Verwendung die Situation verschlimmern kann.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie m√ºssen darauf vorbereitet sein, dass die Erkennung von Speicherlecks Geduld, Ausdauer und ein wenig Detektivarbeit erfordert.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, ich m√∂chte allen meinen Dank aussprechen, die bei der Bew√§ltigung der Sanit√§rnotarbeiten mitgewirkt haben und wieder zu ihrer fr√ºheren Arbeitsf√§higkeit in unseren Dienst zur√ºckkehren!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de498136/index.html">Gespr√§ch mit Polina Gurtova √ºber die Zukunft und Gegenwart von Frontend. Die Organisatoren von DUMP 2020 stellen einige wichtige Fragen.</a></li>
<li><a href="../de498138/index.html">Leben nach dem Grundstudium: Wie ich mich entschieden habe, was ich als n√§chstes tun soll, wenn es bereits Hochschulbildung und Arbeit gibt</a></li>
<li><a href="../de498140/index.html">Replizieren Sie dies. Webinare Apache Ignite und GridGain</a></li>
<li><a href="../de498144/index.html">Ihr erster BERT: Eine illustrierte Anleitung</a></li>
<li><a href="../de498146/index.html">Sechs intelligente Sicherheitstrends, auf die Sie achten sollten</a></li>
<li><a href="../de498154/index.html">Kalender der kostenlosen IT-Veranstaltungen online vom 20. bis 26. April</a></li>
<li><a href="../de498156/index.html">F #, Morphologie von Bin√§rbildern</a></li>
<li><a href="../de498158/index.html">Remote Marathon Woche 1: Arbeitsplatz</a></li>
<li><a href="../de498160/index.html">GlusterFS als externer Speicher f√ºr Kubernetes</a></li>
<li><a href="../de498162/index.html">Wir laden Sie zu einem IT-Praktikum bei der Alfa Bank ein</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>