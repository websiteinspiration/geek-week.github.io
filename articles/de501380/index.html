<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧦 🗑️ 👩🏽‍🚒 Data Build Tool oder was zwischen einem Data Warehouse und einem Smoothie gemeinsam ist 🎖️ 🚇 🥣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Was sind die Prinzipien eines idealen Data Warehouse? 
 
 Konzentrieren Sie sich auf den Geschäftswert und die Analyse, wenn kein Code für das Boilerp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Data Build Tool oder was zwischen einem Data Warehouse und einem Smoothie gemeinsam ist</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501380/"><img src="https://habrastorage.org/webt/94/m4/yy/94m4yy6-3edqwrae5dja92zyiya.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was sind die Prinzipien eines idealen Data Warehouse? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konzentrieren Sie sich auf den Geschäftswert und die Analyse, wenn kein Code für das Boilerplate vorhanden ist. </font><font style="vertical-align: inherit;">Verwalten von DWH als Codebasis: Versionierung, Überprüfung, automatisierte Tests und CI. </font><font style="vertical-align: inherit;">Modularität, Erweiterbarkeit, Open Source und Community. </font><font style="vertical-align: inherit;">Freundliche Benutzerdokumentation und Abhängigkeitsvisualisierung (Data Lineage). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mehr dazu und zur Rolle von DBT im Big Data &amp; Analytics-Ökosystem - willkommen bei cat.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo alle zusammen</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Kontakt mit Artemy Kozyr. </font><font style="vertical-align: inherit;">Seit über 5 Jahren arbeite ich mit Data Warehouses, dem Aufbau von ETL / ELT sowie der Datenanalyse und -visualisierung. </font><font style="vertical-align: inherit;">Ich arbeite derzeit bei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wheely</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , unterrichte bei OTUS im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Engineer-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kurs </font><font style="vertical-align: inherit;">und möchte heute einen Artikel mit Ihnen teilen, den ich am Vorabend des Beginns eines </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neuen Kurses geschrieben habe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurze Review</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im DBT-Framework dreht sich alles um den Buchstaben T im Akronym ELT (Extract - Transform - Load). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem Aufkommen produktiver und skalierbarer Analysedatenbanken wie BigQuery, Redshift und Snowflake verschwand jeder Sinn, Transformationen außerhalb des Data Warehouse vorzunehmen.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBT lädt keine Daten aus Quellen herunter, bietet jedoch enorme Möglichkeiten, mit Daten zu arbeiten, die bereits in den Speicher geladen wurden (im internen oder externen Speicher).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99f/db8/537/99fdb8537040978a7f704780435bdded.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Hauptzweck von DBT besteht darin, den Code zu übernehmen, ihn in SQL zu kompilieren und die Befehle in der richtigen Reihenfolge im Repository auszuführen.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBT-Projektstruktur</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Projekt besteht aus Verzeichnissen und Dateien von nur 2 Typen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modell (.sql) - Transformationseinheit, ausgedrückt durch eine SELECT-Abfrage</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurationsdatei (.yml) - Parameter, Einstellungen, Tests, Dokumentation</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grundsätzlich ist die Arbeit wie folgt strukturiert:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Benutzer bereitet den Modellcode in einer beliebigen IDE vor</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Über die CLI werden Modelle gestartet, DBT kompiliert den Modellcode in SQL</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kompilierter SQL-Code wird im Warehouse in der angegebenen Reihenfolge ausgeführt (Grafik)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So könnte der Start über die CLI aussehen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/893/fd8/a9c/893fd8a9c5ef3206e4568259b7ec1660.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alles ist AUSGEWÄHLT</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist eine Killer-Funktion des Data Build Tool-Frameworks. </font><font style="vertical-align: inherit;">Mit anderen Worten, DBT abstrahiert den gesamten Code, der sich auf die Materialisierung Ihrer Abfragen im Warehouse bezieht (Abweichungen von den Befehlen CREATE, INSERT, UPDATE, DELETE ALTER, GRANT, ...). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jedes Modell beinhaltet das Schreiben einer SELECT-Abfrage, die den resultierenden Datensatz definiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig kann die Transformationslogik mehrstufig sein und Daten aus mehreren anderen Modellen konsolidieren. </font><font style="vertical-align: inherit;">Ein Beispiel für ein Modell, das ein Schaufenster mit Aufträgen erstellt (f_orders):</font></font><br>
<br>
<pre><code class="sql hljs">{% <span class="hljs-keyword">set</span> payment_methods = [<span class="hljs-string">'credit_card'</span>, <span class="hljs-string">'coupon'</span>, <span class="hljs-string">'bank_transfer'</span>, <span class="hljs-string">'gift_card'</span>] %}<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">with</span> orders <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">ref</span>(<span class="hljs-string">'stg_orders'</span>) }}<font></font>
&nbsp;<font></font>
),<font></font>
&nbsp;<font></font>
order_payments <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">ref</span>(<span class="hljs-string">'order_payments'</span>) }}<font></font>
&nbsp;<font></font>
),<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.order_id,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.customer_id,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.order_date,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.status,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">for</span> payment_method <span class="hljs-keyword">in</span> payment_methods -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_payments.{{payment_method}}_amount,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% endfor -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_payments.total_amount <span class="hljs-keyword">as</span> amount
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">from</span> orders
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> order_payments <span class="hljs-keyword">using</span> (order_id)<font></font>
&nbsp;<font></font>
)<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">final</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Welche interessanten Dinge können wir hier sehen? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstens: CTE (Common Table Expressions) werden verwendet, um Code zu organisieren und zu verstehen, der viele Transformationen und Geschäftslogik enthält </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. Zweitens: Modellcode ist eine Mischung aus SQL und der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jinja-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sprache </font><font style="vertical-align: inherit;">(Template-Sprache). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Beispiel wurde die </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for-</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schleife verwendet </font><font style="vertical-align: inherit;">, um den Betrag für jede im </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">festgelegten</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ausdruck angegebene Zahlungsmethode zu bilden </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Die </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ref-</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><font style="vertical-align: inherit;">wird </font><font style="vertical-align: inherit;">ebenfalls verwendet </font><font style="vertical-align: inherit;">- die Möglichkeit, innerhalb des Codes auf andere Modelle zu verweisen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zur Kompilierungszeit wird </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ref</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in einen Zielzeiger auf eine Tabelle oder Ansicht im Repository konvertiert</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit ref</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> können Sie ein Diagramm der Modellabhängigkeiten erstellen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jinja,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der DBT nahezu unbegrenzte Möglichkeiten bietet. </font><font style="vertical-align: inherit;">Die am häufigsten verwendeten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If / else-Anweisungen - Verzweigungsanweisungen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Für Schleifen - Schleifen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Variablen - Variablen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makro - Makros erstellen</font></font></li>
</ul><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Materialisierung: Tabelle, Ansicht, Inkrementell</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Materialisierungsstrategie - Ein Ansatz, nach dem der resultierende Satz von Modelldaten im Repository gespeichert wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grundsätzlich gilt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tabelle - physische Tabelle im Speicher</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansicht - Ansicht, virtuelle Tabelle im Repository</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt komplexere Materialisierungsstrategien:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inkrementelles - inkrementelles Laden (große Faktentabellen); </font><font style="vertical-align: inherit;">Neue Zeilen werden hinzugefügt, geänderte aktualisiert, gelöschte gelöscht&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vergänglich - das Modell materialisiert sich nicht direkt, sondern nimmt als CTE an anderen Modellen teil</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alle anderen Strategien können Sie selbst hinzufügen</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben Materialisierungsstrategien eröffnen sich Optimierungsmöglichkeiten für bestimmte Lager, zum Beispiel:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schneeflocke</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Transiente Tabellen, Zusammenführungsverhalten, Tabellenclustering, Kopieren von Zuschüssen, Sichere Ansichten</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rotverschiebung</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Distkey, Sortkey (verschachtelt, zusammengesetzt), Late Binding Views</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BigQuery</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Tabellenpartitionierung und Clustering, Zusammenführungsverhalten, KMS-Verschlüsselung, Beschriftungen und Tags</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spark</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Dateiformat (Parkett, CSV, JSON, ORC, Delta), partition_by, clustered_by, Buckets, inkrementelle_Strategie</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die folgenden Repositorys werden derzeit unterstützt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgres</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rotverschiebung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bigquery</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schneeflocke</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Presto (teilweise)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funke (teilweise)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft SQL Server (Community-Adapter)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns unser Modell verbessern:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Machen Sie die Füllung inkrementell (inkrementell)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fügen Sie Segmentierungs- und Sortierschlüssel für Redshift hinzu</font></font></li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-comment">--  :&nbsp;</span>
<span class="hljs-comment">--  ,      (unique_key)</span>
<span class="hljs-comment">--   (dist),   (sort)</span><font></font>
{{<font></font>
&nbsp;&nbsp;config(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;materialized='incremental',<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unique_key='order_id',<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist="customer_id",<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort="order_date"<font></font>
&nbsp;&nbsp;&nbsp;)<font></font>
}}<font></font>
&nbsp;<font></font>
{% <span class="hljs-keyword">set</span> payment_methods = [<span class="hljs-string">'credit_card'</span>, <span class="hljs-string">'coupon'</span>, <span class="hljs-string">'bank_transfer'</span>, <span class="hljs-string">'gift_card'</span>] %}<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">with</span> orders <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">ref</span>(<span class="hljs-string">'stg_orders'</span>) }}
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">where</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">if</span> is_incremental() -%}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--        </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">and</span> order_date &gt;= (<span class="hljs-keyword">select</span> <span class="hljs-keyword">max</span>(order_date) <span class="hljs-keyword">from</span> {{ this }})<font></font>
&nbsp;&nbsp;&nbsp;{%- endif %}&nbsp;<font></font>
&nbsp;<font></font>
),<font></font>
&nbsp;<font></font>
order_payments <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">ref</span>(<span class="hljs-string">'order_payments'</span>) }}<font></font>
&nbsp;<font></font>
),<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.order_id,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.customer_id,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.order_date,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.status,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">for</span> payment_method <span class="hljs-keyword">in</span> payment_methods -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_payments.{{payment_method}}_amount,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% endfor -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_payments.total_amount <span class="hljs-keyword">as</span> amount
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">from</span> orders
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> order_payments <span class="hljs-keyword">using</span> (order_id)<font></font>
&nbsp;<font></font>
)<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">final</span>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modellabhängigkeitsdiagramm</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Er ist ein Baum der Abhängigkeiten. </font><font style="vertical-align: inherit;">Er ist ein DAG (Directed Acyclic Graph - Directional Acyclic Graph). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBT erstellt ein Diagramm basierend auf der Konfiguration aller Projektmodelle oder ref () verknüpft innerhalb von Modellen mit anderen Modellen. </font><font style="vertical-align: inherit;">Mit einem Diagramm können Sie Folgendes tun:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelle in der richtigen Reihenfolge ausführen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parallelisierung der Fensterdekoration</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ausführen eines beliebigen Untergraphen&nbsp;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispiel für eine Grafikvisualisierung:</font></font><br>
<br>
<strong><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5d/9f7/bc4/b5d9f7bc41fb5563b8337b04ee123e9a.png"></div></strong><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder Knoten des Diagramms ist ein Modell. Die Kanten des Diagramms werden durch den Ausdruck ref angegeben.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenqualität und Dokumentation</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zusätzlich zur Bildung der Modelle selbst können Sie mit DBT eine Reihe von Aussagen über den resultierenden Datensatz testen, z.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nicht null</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einzigartig</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referenzintegrität - Referenzintegrität (z. B. entspricht customer_id in der Auftragstabelle der ID in der Kundentabelle)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Übereinstimmende gültige Liste</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können Ihre eigenen Tests (benutzerdefinierte Datentests) hinzufügen, z. B. die prozentuale Abweichung des Umsatzes mit Indikatoren vor einem Tag, einer Woche oder einem Monat. </font><font style="vertical-align: inherit;">Jede als SQL-Abfrage formulierte Annahme kann ein Test sein. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf diese Weise können unerwünschte Abweichungen und Fehler in Daten in der Storefront des Speichers abgefangen werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Bezug auf die Dokumentation bietet DBT Mechanismen zum Hinzufügen, Versionsversetzen und Verteilen von Metadaten und Kommentaren auf Modellebene und sogar von Attributen.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht das Hinzufügen von Tests und Dokumentationen auf Ebene der Konfigurationsdatei aus:</font></font><br>
<br>
<pre><code class="ruby hljs">&nbsp;- <span class="hljs-symbol">name:</span> fct_orders
&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> This table has basic information about orders, as well as some derived facts based on payments
&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">columns:</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">name:</span> order_id
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">tests:</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- unique <span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- not_null <span class="hljs-comment">#    null</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> This is a unique identifier <span class="hljs-keyword">for</span> an order<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">name:</span> customer_id
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> Foreign key to the customers table
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">tests:</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- not_null<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">relationships:</span> <span class="hljs-comment">#   </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">to:</span> ref(<span class="hljs-string">'dim_customers'</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">field:</span> customer_id<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">name:</span> order_date
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> Date (UTC) that the order was placed<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">name:</span> status
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> <span class="hljs-string">'{{ doc("orders_status") }}'</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">tests:</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">accepted_values:</span> <span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">values:</span> [<span class="hljs-string">'placed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'completed'</span>, <span class="hljs-string">'return_pending'</span>, <span class="hljs-string">'returned'</span>]
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und so sieht diese Dokumentation bereits auf der generierten Website aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/854/8b6/27e/8548b627ea48caab60c524697984ef77.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makros und Module</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Zweck von DBT besteht nicht darin, eine Reihe von SQL-Skripten zu werden, sondern den Benutzern leistungsstarke und funktionsreiche Tools zum Erstellen eigener Transformationen und zum Verteilen dieser Module bereitzustellen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Makros sind Sätze von Konstrukten und Ausdrücken, die als Funktionen innerhalb von Modellen aufgerufen werden können. </font><font style="vertical-align: inherit;">Mit Makros können Sie SQL zwischen Modellen und Projekten gemäß dem DRY-Konstruktionsprinzip (Don't Repeat Yourself) wiederverwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Makro Beispiel:</font></font><br>
<br>
<pre><code class="sql hljs">{% macro rename_category(column_name) %}<font></font>
case<font></font>
&nbsp;when {{ column_name }} ilike&nbsp; '%osx%' then 'osx'<font></font>
&nbsp;when {{ column_name }} ilike&nbsp; '%android%' then 'android'<font></font>
&nbsp;when {{ column_name }} ilike&nbsp; '%ios%' then 'ios'<font></font>
&nbsp;else 'other'<font></font>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> renamed_product<font></font>
{% endmacro %}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und seine Verwendung:</font></font><br>
<br>
<pre><code class="sql hljs">{% <span class="hljs-keyword">set</span> column_name = <span class="hljs-string">'product'</span> %}
<span class="hljs-keyword">select</span><font></font>
&nbsp;product,<font></font>
&nbsp;{{ rename_category(column_name) }} <span class="hljs-comment">--  </span>
<span class="hljs-keyword">from</span> my_table
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBT wird mit einem Paketmanager geliefert, mit dem Benutzer einzelne Module und Makros veröffentlichen und wiederverwenden können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies bedeutet die Möglichkeit, Bibliotheken herunterzuladen und zu verwenden, wie z.</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dbt_utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Arbeiten mit Datum / Uhrzeit, Ersatzschlüsseln, Schematests, Pivot / Unpivot und anderen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorgefertigte Schaufenstervorlagen für Dienste wie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schneepflug</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Streifen</font></font></a>&nbsp;</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bibliotheken für bestimmte Data Warehouses wie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redshift</font></font></a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protokollierung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - DBT- </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Protokollierungsmodul</font></a></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine vollständige Liste der Pakete finden Sie im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dbt Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noch mehr Funktionen</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier werde ich einige andere interessante Funktionen und Implementierungen beschreiben, mit denen ich und das Team ein Data Warehouse in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wheely erstellen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trennung von Laufzeitumgebungen DEV - TEST - PROD</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auch innerhalb desselben DWH-Clusters (innerhalb verschiedener Schemata). </font><font style="vertical-align: inherit;">Verwenden Sie beispielsweise den folgenden Ausdruck:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">with</span> <span class="hljs-keyword">source</span> <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">source</span>(<span class="hljs-string">'salesforce'</span>, <span class="hljs-string">'users'</span>) }}
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">where</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
&nbsp;&nbsp;&nbsp;{%- <span class="hljs-keyword">if</span> target.name <span class="hljs-keyword">in</span> [<span class="hljs-string">'dev'</span>, <span class="hljs-string">'test'</span>, <span class="hljs-string">'ci'</span>] -%}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">where</span> <span class="hljs-built_in">timestamp</span> &gt;= <span class="hljs-keyword">dateadd</span>(<span class="hljs-keyword">day</span>, <span class="hljs-number">-3</span>, <span class="hljs-keyword">current_date</span>)&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;{%- endif -%}<font></font>
&nbsp;<font></font>
)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Code sagt wörtlich: </font><font style="vertical-align: inherit;">Nehmen Sie </font><font style="vertical-align: inherit;">für </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entwickler-, Test- und CI-</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Umgebungen </font><font style="vertical-align: inherit;">Daten nur für die letzten 3 Tage und nicht mehr. </font><font style="vertical-align: inherit;">Das heißt, das Ausführen in diesen Umgebungen ist viel schneller und erfordert weniger Ressourcen. </font><font style="vertical-align: inherit;">Beim Start in einer </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Produktumgebung</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wird </font><font style="vertical-align: inherit;">die Filterbedingung ignoriert.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alternative Spaltencodierungsmaterialisierung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redshift ist ein Spalten-DBMS, mit dem Sie Datenkomprimierungsalgorithmen für jede einzelne Spalte angeben können. </font><font style="vertical-align: inherit;">Durch die Auswahl optimaler Algorithmen kann der belegte Speicherplatz um 20-50% reduziert werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redshift.compress_table</font></font></strong></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Makro </font><font style="vertical-align: inherit;">wird der Befehl ANALYZE COMPRESSION ausführen, erstellen Sie </font><font style="vertical-align: inherit;">eine neue Tabelle mit der empfohlenen Säule Codierungsalgorithmen durch die Segmentierung Tasten (dist_key) angegeben und sort (key_key), die Daten an sie, und löschen Sie </font><font style="vertical-align: inherit;">die alte Kopie , </font><font style="vertical-align: inherit;">wenn nötig. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Makrosignatur:</font></font><br>
<br>
<pre><code class="sql hljs">{{ compress_table(schema, table,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;drop_backup=False,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comprows=none|Integer,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort_style=none|compound|interleaved,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort_keys=none|List&lt;String&gt;,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist_style=none|all|even,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist_key=none|String) }}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protokollierungsmodell wird gestartet</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für jede Ausführung des Modells können Sie Hooks aufhängen, die vor dem Start oder unmittelbar nach der Erstellung des Modells ausgeführt werden:</font></font><br>
<br>
<pre><code class="ruby hljs">&nbsp;&nbsp;&nbsp;pre-<span class="hljs-symbol">hook:</span> <span class="hljs-string">"{{ logging.log_model_start_event() }}"</span>
&nbsp;&nbsp;&nbsp;post-<span class="hljs-symbol">hook:</span> <span class="hljs-string">"{{ logging.log_model_end_event() }}"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dem Protokollierungsmodul können Sie alle erforderlichen Metadaten in einer separaten Tabelle aufzeichnen, anhand derer Sie anschließend Problembereiche (Engpässe) prüfen und analysieren können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht das Dashboard in den Suchdaten in Looker aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d0b/0f4/d7c/d0b0f4d7c7074880fa7ad5d9de6fc196.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speicherautomatisierung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie einige Erweiterungen der Funktionalität des verwendeten Speichers verwenden, z. B. UDF (User Defined Functions), ist die Versionierung dieser Funktionen, die Zugriffskontrolle und die automatische Einführung neuer Releases in DBT sehr bequem zu implementieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir verwenden UDF in Python, um Hash-Werte, Mail-Domain-Domänen und Decodierungs-Bitmasken zu berechnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispielmakro, das UDF zu jeder Laufzeit erstellt (dev, test, prod):</font></font><br>
<br>
<pre><code class="sql hljs">{% macro create_udf() -%}<font></font>
&nbsp;<font></font>
&nbsp;{% <span class="hljs-keyword">set</span> <span class="hljs-keyword">sql</span> %}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> {{ target.schema }}.f_sha256(mes <span class="hljs-string">"varchar"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">varchar</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">LANGUAGE</span> plpythonu<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STABLE<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">AS</span> $$&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">import</span> hashlib
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> hashlib.sha256(mes).hexdigest()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<font></font>
&nbsp;{% endset %}<font></font>
&nbsp;&nbsp;<font></font>
&nbsp;{% <span class="hljs-keyword">set</span> <span class="hljs-keyword">table</span> = run_query(<span class="hljs-keyword">sql</span>) %}<font></font>
&nbsp;<font></font>
{%- endmacro %}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei Wheely verwenden wir Amazon Redshift, das auf PostgreSQL basiert. </font><font style="vertical-align: inherit;">Für Redshift ist es wichtig, regelmäßig Statistiken zu Tabellen zu sammeln und Speicherplatz freizugeben - die Befehle ANALYZE und VACUUM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu werden die Befehle des Makros redshift_maintenance jede Nacht ausgeführt:</font></font><br>
<br>
<pre><code class="sql hljs">{% macro redshift_maintenance() %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> vacuumable_tables=run_query(vacuumable_tables_sql) %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">for</span> <span class="hljs-keyword">row</span> <span class="hljs-keyword">in</span> vacuumable_tables %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> message_prefix=loop.index ~ <span class="hljs-string">" of "</span> ~ loop.length %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{%- <span class="hljs-keyword">set</span> relation_to_vacuum = adapter.get_relation(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">database</span>=<span class="hljs-keyword">row</span>[<span class="hljs-string">'table_database'</span>],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">schema</span>=<span class="hljs-keyword">row</span>[<span class="hljs-string">'table_schema'</span>],<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier=<span class="hljs-keyword">row</span>[<span class="hljs-string">'table_name'</span>]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">do</span> run_query(<span class="hljs-string">"commit"</span>) %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">if</span> relation_to_vacuum %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> <span class="hljs-keyword">start</span>=modules.datetime.datetime.now() %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ dbt_utils.log_info(message_prefix ~ <span class="hljs-string">" Vacuuming "</span> ~ relation_to_vacuum) }}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">do</span> run_query(<span class="hljs-string">"VACUUM "</span> ~ relation_to_vacuum ~ <span class="hljs-string">" BOOST"</span>) %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ dbt_utils.log_info(message_prefix ~ <span class="hljs-string">" Analyzing "</span> ~ relation_to_vacuum) }}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">do</span> run_query(<span class="hljs-string">"ANALYZE "</span> ~ relation_to_vacuum) %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> <span class="hljs-keyword">end</span>=modules.datetime.datetime.now() %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> total_seconds = (<span class="hljs-keyword">end</span> - <span class="hljs-keyword">start</span>).total_seconds() | <span class="hljs-keyword">round</span>(<span class="hljs-number">2</span>)&nbsp; %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ dbt_utils.log_info(message_prefix ~ <span class="hljs-string">" Finished "</span> ~ relation_to_vacuum ~ <span class="hljs-string">" in "</span> ~ total_seconds ~ <span class="hljs-string">"s"</span>) }}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">else</span> %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ dbt_utils.log_info(message_prefix ~ <span class="hljs-string">' Skipping relation "'</span> ~ row.values() | <span class="hljs-keyword">join</span> (<span class="hljs-string">'"."'</span>) ~ <span class="hljs-string">'" as it does not exist'</span>) }}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% endif %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;{% endfor %}<font></font>
&nbsp;<font></font>
{% endmacro %}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBT Cloud</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist möglich, DBT als Service (Managed Service) zu verwenden. </font><font style="vertical-align: inherit;">Im Komplekt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web-IDE zur Entwicklung von Projekten und Modellen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jobkonfiguration und Zeitplaneinstellung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einfacher und bequemer Zugriff auf Protokolle</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Website mit der Dokumentation Ihres Projekts</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CI-Verbindung (Continuous Integration)</font></font></li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8cc/9bc/923/8cc9bc9236411e74d49472864f81fd06.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Kochen und Konsumieren von DWH ist genauso angenehm und vorteilhaft wie das Trinken von Smoothies. </font><font style="vertical-align: inherit;">DBT besteht aus Jinja, benutzerdefinierten Erweiterungen (Modulen), Compiler, Engine (Executor) und Paketmanager. </font><font style="vertical-align: inherit;">Nachdem Sie diese Elemente zusammengetragen haben, erhalten Sie eine vollwertige Arbeitsumgebung für Ihr Data Warehouse. </font><font style="vertical-align: inherit;">Es gibt heute kaum einen besseren Weg, um Transformationen innerhalb von DWH zu verwalten.</font></font><br>
<br>
<h1><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/869/0b7/b1e/8690b7b1e979e07c3afdd7cf2c839769.png"></div><br>
</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Überzeugungen der DBT-Entwickler lauten wie folgt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code, nicht GUI, ist die beste Abstraktion, um komplexe analytische Logik auszudrücken</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Arbeit mit Daten sollte die Best Practices der Softwareentwicklung (Software Engineering) anpassen.</font></font></li>
</ul><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kritische Dateninfrastruktur muss von der Benutzergemeinschaft als Open-Source-Software gesteuert werden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nicht nur Analysetools, sondern auch Code werden zunehmend Teil der Open Source-Community.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Grundüberzeugungen haben ein Produkt hervorgebracht, das heute von mehr als 850 Unternehmen verwendet wird, und sie bilden die Grundlage für viele interessante Erweiterungen, die in Zukunft erstellt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für Interessierte gibt es ein Video einer offenen Lektion, die ich vor einigen Monaten im Rahmen einer offenen Lektion im OTUS - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Build Tool für Amazon Redshift-Repository verbracht habe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben DBT und Data Warehouses führen meine Kollegen und ich im Rahmen des Data Engineer-Kurses auf der OTUS-Plattform Kurse zu einer Reihe anderer relevanter und moderner Themen durch:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architekturkonzepte für Big Data-Anwendungen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Übe mit Spark und Spark Streaming</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lernmethoden und Tools zum Laden von Datenquellen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen von analytischen Vitrinen in DWH</font></font></li>
<li> NoSQL: HBase, Cassandra, ElasticSearch</li>
<li>    &nbsp;</li>
<li> :       </li>
</ul><br>
<h1>:</h1><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DBT documentation — Introduction</a> —  </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">What, exactly, is dbt?</a> —      DBT&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Data Build Tool   Amazon Redshift</a> — YouTube,    OTUS</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  Greenplum</a> —    15  2020</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  Data Engineering</a> — OTUS</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Building a Mature Analytics Workflow</a> —        </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">It’s time for open source analytics</a> —     Open Source</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Continuous Integration and Automated Build Testing with dbtCloud</a> —   CI   DBT</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Getting started with DBT tutorial</a> — ,     </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Jaffle shop — Github DBT Tutorial</a> — Github,   </li>
</ol><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  .</a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de501368/index.html">Digitale Veranstaltungen in Moskau vom 11. bis 17. Mai</a></li>
<li><a href="../de501370/index.html">Trello - ein effektives Wissensmanagementsystem für ein kleines IT-Team</a></li>
<li><a href="../de501374/index.html">Emulationskommodore 65</a></li>
<li><a href="../de501376/index.html">Agile lehrt uns die wahre Bedeutung von Architektur</a></li>
<li><a href="../de501378/index.html">Navigieren zwischen Ansichten mit @EnvironmentObject in SwiftUI</a></li>
<li><a href="../de501386/index.html">MNT-Reform - Vollständig offenes Notizbuch für Paranoide</a></li>
<li><a href="../de501388/index.html">Ist Agile für das gesamte Unternehmen möglich?</a></li>
<li><a href="../de501392/index.html">Responsive Schriftart. Anpassen von Text zwischen Layout und Mindestwerten</a></li>
<li><a href="../de501394/index.html">Über die Übersetzung von "Theorie" / "theoretisch" ohne Theorie / Theorie</a></li>
<li><a href="../de501396/index.html">Interview mit Sergey Zhuk - Autor von Büchern und Screencasts auf ReactPHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>