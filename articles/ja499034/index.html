<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕧 👭 👨🏼‍🔧 危険なリファクタリングを100万人のユーザーに提供する方法は？ 👩‍❤️‍💋‍👩 🐆 🙏🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="映画「飛行機」、1980。
 
 これが、製品に別のリファクタリングを注ぎ込んだときの感じです。メトリクスとログでコード全体をカバーする場合でも、すべての環境で機能をテストしてください。これにより、デプロイ後にファカップから100％節約できません。
 
 最初のFakap
 どういうわけか、Goog...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>危険なリファクタリングを100万人のユーザーに提供する方法は？</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/manychat/blog/499034/"><img src="https://habrastorage.org/webt/xi/ny/b7/xinyb7sar_jz5ueywnjobp8rfrs.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">映画「飛行機」、1980。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが、製品に別のリファクタリングを注ぎ込んだときの感じです。</font><font style="vertical-align: inherit;">メトリクスとログでコード全体をカバーする場合でも、すべての環境で機能をテストしてください。これにより、デプロイ後にファカップから100％節約できません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のFakap</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どういうわけか、Googleスプレッドシートとの統合処理をリファクタリングしました。ユーザーにとって、これは非常に価値のある機能です。同時にリンクする必要がある多くのツールを使用する-連絡先をテーブルに送信する、質問への回答をアップロードする、ユーザーをエクスポートするなど。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
統合コードは最初のバージョンからリファクタリングされなかったため、保守がますます困難になりました。これはユーザーに影響を与え始めました-コードの複雑さのために編集することを恐れていた古いバグが明らかになりました。それについて何かをする時が来ました。論理的な変更は想定されていません。テストを記述し、クラスと櫛の名前を移動するだけです。もちろん、開発環境で機能をテストし、展開に行きました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
20分後、ユーザーは統合が機能しなかったと書いています。</font><font style="vertical-align: inherit;">Googleスプレッドシートにデータを送信する機能が低下しました-デバッグの場合、販売環境とローカル環境でさまざまな形式でデータを送信することがわかりました。</font><font style="vertical-align: inherit;">リファクタリングするとき、私たちは販売のためのフォーマットにぶつかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
統合を修正しましたが、それにもかかわらず、金曜日の陽気な夕方からの堆積物は（そしてあなたが思ったとおりです！）残りました。</font><font style="vertical-align: inherit;">振り返って（スプリントを完了するためにチームに会う）、私たちは将来そのような状況を防ぐ方法について考え始めました-手動テスト、自動テスト、メトリックとアラームの操作の練習を改善する必要があり、これに加えて、機能フラグを使用してリファクタリングをテストするというアイデアを得ましたprode、実際には、これは議論されます。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキームは単純です。ユーザーがフラグを有効にしている場合は、新しいバージョンのコードに移動し、そうでない場合は、古いバージョンのコードに移動します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span> ($user-&gt;hasFeature(UserFeatures::FEATURE_1)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチでは、最初にprodでリファクタリングをテストし、次にユーザーにリファクタリングする機会があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほぼプロジェクトの最初から、フラグ機能の基本的な実装がありました。</font><font style="vertical-align: inherit;">ユーザーとアカウントの2つの基本エンティティのデータベースに、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビットマスク</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">である機能フィールドが追加されました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">コードでは、機能の新しい定数を登録し、ユーザーが特定の機能を利用できるようになった場合は、その定数をマスクに追加しました。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_1 = <span class="hljs-number">0b0000001</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_2 = <span class="hljs-number">0b0000010</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> ALLOW_FEATURE_3 = <span class="hljs-number">0b0000100</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードでの使用は次のようになります。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_FEATURE_1)) {
  <span class="hljs-comment">// feature 1 logic</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、リファクタリング時には、まずテストのためにチームにフラグを開き、次に機能をアクティブに使用する複数のユーザーに公開し、最後にすべてに公開しますが、より複雑なスキームが表示されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">過負荷の場所のリファクタリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのシステムの1つはFacebookのWebhookを受け入れ、それらをキューで処理します。キューの処理が停止し、ユーザーは特定のメッセージを遅延して受信し始め、ボットサブスクライバーのエクスペリエンスに重大な影響を与える可能性があります。処理をより複雑なキュースキームに移すことで、この場所をリファクタリングし始めました。場所は重要です。すべてのサーバーに新しいロジックを注ぐのは危険なので、フラグの下で新しいロジックを閉じ、製品でテストすることができました。しかし、このフラグを開くとどうなりますか？インフラストラクチャはどのように動作しますか？今回はサーバーにフラグの開始を配置し、メトリックに従いました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスタに分割したすべての重要なデータ処理。</font><font style="vertical-align: inherit;">各クラスターにはIDがあります。</font><font style="vertical-align: inherit;">特定のサーバーでのみフラグ機能を開くことにより、このような複雑なリファクタリングのテストを簡略化することにしました。コードのチェックは次のようになります。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::CGT_REFACTORING) ||<font></font>
    \in_array($cluster, Configurator::get(<span class="hljs-string">'cgt_refactoring_cluster_ids'</span>))) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、リファクタリングを注ぎ、フラグをチームに公開しました。</font><font style="vertical-align: inherit;">次に、cgt機能を積極的に使用し、フラグを開き、すべてが機能するかどうかを確認するユーザーを見つけました。</font><font style="vertical-align: inherit;">そして最後に、サーバー上のフラグを開き、メトリックを追跡し始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cgt_refactoring_cluster_idsフラグは、管理パネルから変更できます。</font><font style="vertical-align: inherit;">最初に、値cgt_refactoring_cluster_idsを空の配列に割り当ててから、一度に1つのクラスターを追加し[1]、しばらくの間メトリックを確認し、システム全体をテストするまで別のクラスターを追加します[1、2]。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuratorの実装</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuratorの概要と実装方法について少しお話します。</font><font style="vertical-align: inherit;">たとえば、上の例のように、ロジックを大幅にロールバックする必要がある場合に、展開せずにロジックを変更できるように記述されています。</font><font style="vertical-align: inherit;">また、動的構成にも使用します。たとえば、さまざまなキャッシュ時間をテストする必要がある場合は、取り出してすばやくテストできます。</font><font style="vertical-align: inherit;">開発者にとって、これは変更可能な管理値を持つフィールドのリストのように見えます。</font><font style="vertical-align: inherit;">これらすべてをDBに格納し、Redisにキャッシュし、ワーカーの統計に格納します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">古い場所のリファクタリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の四半期では、登録ロジックをリファクタリングし、いくつかのサービスを通じて登録の可能性に移行する準備をしました。</font><font style="vertical-align: inherit;">私たちの状況では、特定のユーザーが特定のロジックに関連付けられるように登録ロジックをクラスター化することは不可能であり、ロジックをテストして、すべての登録リクエストのパーセンテージをロールアウトする以外に何も思いつきませんでした。</font><font style="vertical-align: inherit;">これは、フラグを使用して同様の方法で簡単に実行できます。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">If</span> (Configurator::get(<span class="hljs-string">'auth_refactoring_percentage'</span>) &gt; \random_int(<span class="hljs-number">0</span>, <span class="hljs-number">99</span>)) {
  <span class="hljs-comment">// new version</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// old version</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、管理パネルのauth_refactoring_percentageの値を0から100に設定しました。もちろん、最終的に変換を削減しなかったことを理解するために、認証ロジック全体をメトリックで「塗りつぶし」ました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指標</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フラグを開くプロセスでメトリックをどのように追跡するかを示すために、別のケースをより詳細に検討します。</font><font style="vertical-align: inherit;">ManyChatは、サブスクライバーがFacebook Messengerにメッセージを送信するときにFacebookからのFacebookフックを受け入れます。</font><font style="vertical-align: inherit;">ビジネスロジックに従って各メッセージを処理する必要があります。</font><font style="vertical-align: inherit;">cgt機能の場合、関連するメッセージを返信するために、購読者がFacebookのコメントから会話を開始したかどうかを判別する必要があります。</font><font style="vertical-align: inherit;">コードでは、現在のサブスクライバーのコンテキストを判別するように見えます。widgetIdを判別できる場合は、そこからの応答メッセージを判別します。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能の詳細</font></font></b>
                        <div class="spoiler_text"> Facebook                api.      —    .        Widget,   :<br>
<br>
  —&gt;     —&gt;     —&gt;         Facebook:<br>
<br>
<img src="https://habrastorage.org/webt/a7/n8/jx/a7n8jxdxulwxquozeje_kzabv_y.gif"><br>
<br>
     : <br>
  —&gt;    —&gt;  <br>
<br>
<img src="https://habrastorage.org/webt/y0/i7/1l/y0i71lh-zttfdvcs3n1bny56w8e.gif"><br>
<br>
     “ , !”   ,        .   ,     “  !”   id       ,     —   ,     id.<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前は、次の3つの方法でコンテキストを定義しました。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;gt_widget_id_context) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_context'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $user-&gt;gt_widget_id_context;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $user-&gt;name) {<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByThread($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_thread'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
<font></font>
    $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByConversation($user);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_conversation'</span>);<font></font>
<font></font>
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ウォッチャーサービスは、一致時にそれぞれ分析を送信します。3つのケースすべてのメトリックがありました：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bh/x5/gy/bhx5gygff9kthgcyd_zcri1fkyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンクが異なる方法で</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">時間内に</font><i><font style="vertical-align: inherit;">コンテキストが検出された回数。</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
次に、古いオプションをすべて置き換える必要がある別の一致メソッドが見つかりました。</font><font style="vertical-align: inherit;">これをテストするために、別のメトリックを取得しました。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
      $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_via_echo_message'</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//    </span>
  <span class="hljs-comment">// ...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階では、新しいヒットの数が古いヒットの合計と等しいことを確認したいので、$ widgetIdを返さずにメトリックを記述します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/kw/wp/wakwwppphodtzn7huuj_vhajdb4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいメソッドによって検出されたコンテキスト</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><i><font style="vertical-align: inherit;">数は、古いメソッドによるバインディングの合計を完全にカバーしますが、</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
すべてのケースで正しい一致ロジックが保証されるわけではありません。</font><font style="vertical-align: inherit;">次のステップは、フラグを開くことによる段階的なテストです。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{
  <span class="hljs-comment">//    </span>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-comment">//    ,   </span>
    <span class="hljs-keyword">If</span> (<span class="hljs-keyword">$this</span>-&gt;allowMatchingByEcho($user)) {
      <span class="hljs-keyword">return</span> $widgetId;<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// ...</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">allowMatchingByEcho</span>(<span class="hljs-params">User $user</span>): <span class="hljs-title">bool</span>
</span>{
  <span class="hljs-comment">//    </span>
  <span class="hljs-keyword">If</span> ($user-&gt;hasFeature(UserFeatures::ALLOW_CGT_MATCHING_BY_ECHO)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-keyword">If</span> (\in_array(<span class="hljs-keyword">$this</span>-&gt;clusterId, Configurator::get(<span class="hljs-string">'cgt_matching_by_echo_cluster_ids'</span>))) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、テストプロセスが開始されました。最初に、すべての環境で、およびUserFeatures :: ALLOW_CGT_MATCHING_BY_ECHOフラグを開いて、マッチングを頻繁に使用するランダムユーザーで新機能をテストしました。</font><font style="vertical-align: inherit;">この段階で、マッチが正しく機能せずに修復されたいくつかのケースをキャッチしました。</font><font style="vertical-align: inherit;">その後、サーバーへの展開を開始しました。平均して、1週間に1日で1台のサーバーを展開しました。</font><font style="vertical-align: inherit;">テストの前に、機能に関連するチケットを注意深く調べて、奇妙な点について書面で報告することをサポートに警告します。</font><font style="vertical-align: inherit;">サポートとユーザーのおかげで、いくつかのコーナーケースが修正されました。</font><font style="vertical-align: inherit;">そして最後に、最後のステップは無条件にすべてを発見することです。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getWidgetIdContext</span>(<span class="hljs-params">User $user, WatchService $watcher</span>): <span class="hljs-title">int</span>?
</span>{<font></font>
  $widgetId = <span class="hljs-keyword">$this</span>-&gt;cgtMatchByEcho($user);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> !== $widgetId) {<font></font>
    $watcher-&gt;logTick(<span class="hljs-string">'cgt_match_processor_matched_by_echo_message'</span>);<font></font>
  <font></font>
    <span class="hljs-keyword">return</span> $widgetId;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいフラグ機能の実装</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事の冒頭で説明したフラグ機能の実装は約3年間役に立ちましたが、チームの成長に伴い不快になりました。各フラグを作成するときに展開する必要があり、フラグの値をクリアすることを忘れないでください（さまざまな機能に定数値を再利用しました）。</font><font style="vertical-align: inherit;">最近、コンポーネントが書き直され、管理パネルを通じてフラグを柔軟に管理できるようになりました。</font><font style="vertical-align: inherit;">フラグはビットマスクからアンタイドされ、別のテーブルに保存されました。これにより、新しいフラグを簡単に作成できます。</font><font style="vertical-align: inherit;">各エントリには説明と所有者もあり、フラグの管理がより透過的になりました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのようなアプローチの短所</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチには大きなマイナス点があります。コードには2つのバージョンがあり、それらは同時にサポートされる必要があります。</font><font style="vertical-align: inherit;">テストするとき、ロジックには2つの分岐があることを考慮する必要があり、それらすべてをチェックする必要があります。これは非常に困難です。</font><font style="vertical-align: inherit;">開発中に、1つのロジックに修正を導入したが、別のロジックを忘れてしまい、ある時点で失敗する場合がありました。</font><font style="vertical-align: inherit;">したがって、このアプローチは重要な場所でのみ使用し、古いバージョンのコードをできるだけ早く取り除くようにしています。</font><font style="vertical-align: inherit;">残りのリファクタリングを小さな反復で実行しようとします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合計</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在のプロセスは次のようになります。最初にフラグの条件でロジックを閉じ、次に展開して徐々にフラグを開き始めます。フラグを展開するとき、何かがうまくいかないとすぐにエラーとメトリックを注意深く監視します-フラグをすぐにロールバックして問題に対処します。プラスは、フラグの開閉が非常に高速であることです。これは、管理パネルの値の変更にすぎません。しばらくして、古いバージョンのコードを削除しました。これは、両方のバージョンのコードの変更を防ぐための最小時間です。そのようなリファクタリングについて同僚に警告することは重要です。私たちはgithubを通じてレビューを行い、</font><font style="vertical-align: inherit;">そのようなリファクタリング中に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード所有者</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><font style="vertical-align: inherit;">て、リファクタリングの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">作成者</font></a><font style="vertical-align: inherit;">の知識がなければコードに変更が入り込まないようにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、私は新しいバージョンのFacebook Graph APIを公開しました。</font><font style="vertical-align: inherit;">1秒で、APIに3000を超えるリクエストが行われ、エラーが発生すると高額になります。</font><font style="vertical-align: inherit;">したがって、私は最小限の影響でフラグの下で変更を公開しました-私は1つの不愉快なバグをキャッチし、新しいバージョンをテストし、最終的には心配することなく完全にそれに切り替えました。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja499016/index.html">ESIA for .Netとの統合：思ったより簡単</a></li>
<li><a href="../ja499018/index.html">6つのホームスポーツアプリ</a></li>
<li><a href="../ja499020/index.html">あいまいな行動の研究</a></li>
<li><a href="../ja499030/index.html">20分でisic上のGrafanaのMySQLパフォーマンスを監視する</a></li>
<li><a href="../ja499032/index.html">Prometheusを使用してGitLabで異常を検出する方法</a></li>
<li><a href="../ja499036/index.html">プロバイダーの仕事：プロトコル、IT、ネットワークインフラストラクチャに関するさまざまな資料</a></li>
<li><a href="../ja499038/index.html">縦型モニターの使用経験</a></li>
<li><a href="../ja499040/index.html">週末にお読みください：DNS、IT規制、ハードウェアの歴史に関する資料の選択1cloud.ru</a></li>
<li><a href="../ja499044/index.html">OpenStreetMap No.508の世界からのニュース（2020年4月7日、2020年4月13日）</a></li>
<li><a href="../ja499046/index.html">サイバーカルマー神経進化</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>