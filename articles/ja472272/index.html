<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌏 💼 👨🏿‍🌾 Three.jsの古い雰囲気の新しいゲーム。パート2 👩🏾‍🏭 👩🏼‍🎨 🧒🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="では最初の部分私はThree.jsを使用してブラウザのための3Dゲームを作成する過程で直面する問題について話しました。ここで、レベルの構築、衝突の検出、ブラウザウィンドウの任意の比率への画像の適応など、ゲームを作成する際のいくつかの重要な問題を解決する方法について詳しく説明します。
 
 
 レベル...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Three.jsの古い雰囲気の新しいゲーム。パート2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472272/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の部分私はThree.jsを使用してブラウザのための3Dゲームを作成する過程で直面する問題について話しました。</font><font style="vertical-align: inherit;">ここで、レベルの構築、衝突の検出、ブラウザウィンドウの任意の比率への画像の適応など、ゲームを作成する際のいくつかの重要な問題を解決する方法について詳しく説明します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ds/jr/45/dsjr45-khpwum64yaoqvndmfynw.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レベル図</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、レベル自体は3Dエディタで作成されます。つまり、それらのジオメトリ、テクスチャマッピング、ベイクシャドウなどです。</font><font style="vertical-align: inherit;">このすべてを最初の部分で説明しました。</font><font style="vertical-align: inherit;">なぜ他のスキームがあるのですか？</font><font style="vertical-align: inherit;">実際、Three.jsはいかなる種類の物理エンジンも提供していないため、レベルスキームを使用して障害を特定しています。</font></font><br>
<a name="habracut"></a><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pk/7u/j6/pk7uj6hvp3cyrkehdo_ohagtfnc.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
衝突の問題を解決するThree.jsは、レイトレーシング（オブジェクトのジオメトリの交差を決定する最も簡単な方法）のみを提供します。</font><font style="vertical-align: inherit;">原則として、それは使用することができ、私はすでに他のプロジェクトの1つでも使用しています。</font><font style="vertical-align: inherit;">それは、ブラウザー上でサイト上にある仮想都市でした。</font><font style="vertical-align: inherit;">あなたは街を動き回ることができ、壁を通り抜けることはできません。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ud/8y/4s/ud8y4smxvagibioopva3vc1ajoc.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
移動中にプレイヤーの形状と建物の交差が発生した場合、壁の反対方向に一定距離だけプレイヤーの反発を実装しました。しかし、このためには、オブジェクトは平行六面体でなければなりません。いくつかの複雑なオブジェクトの周りに、コライダーを作成しました（障害物の役割を果たし、プレイヤーが自分自身を通過できないようにする非表示のオブジェクトを呼び出します）。これにより、交差が計算されました。また、一部の建物の下部分は、単に「ボックス」であり、それ自体がコライダーとして使用されることもありました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fz/on/3e/fzon3eg8bjup0zvzs_cgg81lrmo.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幾何学的に複雑なオブジェクトでは、レイトレーシングが機能しないか、不適切に動作する場合があります。</font><font style="vertical-align: inherit;">また、解決策として、1つではなく、透明度100％の平行六面体の形でいくつかの小さな不可視のコライダーをオブジェクトに埋め込むことができます。これらのコライダーは、互いに隣り合って互いに重なり合い、オブジェクトの形状をほぼ繰り返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダンジョンに関するゲームでは、レベルは単一の長いオブジェクトであり、プレイヤーを動かすためにカットムーブが行われます。</font><font style="vertical-align: inherit;">実際には、衝突の問題を解決するために、不可視のコライダーを必要に応じて貼り付け、レイトレーシングを使用することができます。</font><font style="vertical-align: inherit;">しかし、私は逆に行くことにしました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rz/ul/ln/rzullnsn4a_befsw71uctfqjyzg.jpeg"></div><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、コライダーの配列を作成するプロセスを自動化したかったのです。</font></font></li>
<li>-,      ,  ,    ,     3D  -   .</li>
<li>-,                ,         .</li>
<li> -,  , ,   .  ,   ,  ,     .          ,     ,         .  ,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レベルダイアグラムファイル（png）の名前や色などの入力パラメーターを取り、その塗りつぶしが障害物として解釈されるスクリプトを作成しました。</font><font style="vertical-align: inherit;">デフォルトの空き領域の色は黒です。</font><font style="vertical-align: inherit;">スクリプトで処理するには、各レベルのスキームを個別のpngファイルに保存する必要があります。</font><font style="vertical-align: inherit;">たとえば、最低レベルの場合、次のようになります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ba/rg/kw/bargkw-qc8xqbvpszjia3zvnllq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのブロックは幅80ピクセル、高さ48ピクセルにする必要があることに同意しました。</font><font style="vertical-align: inherit;">これは、3Dワールドの4 x 2.4メートルに相当します。</font><font style="vertical-align: inherit;">40 x 24ピクセル、つまり10倍にすることは可能ですが、写真では小さく見えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のレベルのスクリプトの結果（画像は右にトリミングされています）：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xx/zu/9f/xxzu9fsntacg-giuqubbj75iq5k.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトはブラウザで実行されます。 HTMLマークアップには意味がないと思います。それは基本的なものです。データ入力フィールドとスタートボタンです。次に、読み取った画像がキャンバスに表示されます。スクリプトの結果、3Dワールドスケールの配列が画像の下に表示されます。これには、各ブロックの左下と右上の座標が含まれ、各レベルのスクリプトでオフセットが指定されています。この配列は、コライダーのリストにコピーして貼り付け、ゲームで使用することができます（これについては以下で詳しく説明します）。なんらかの定数に格納されます。座標も画像自体に表示されますが、2D画像の参照フレーム内に表示されます。これらの数値は各ブロックの中央に表示され、すべてのブロックが計算に含まれているかどうかを確認できます。これらの番号は、目視検査以外には必要ありません。列などの一部のブロック、プレーヤーが通過する間はカウントされません。計算から除外されるオブジェクトについて-以下。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、たとえば、2番目のレベルには、プレイヤーが歩く薄い水平のプレートがあります。</font><font style="vertical-align: inherit;">それらを考慮する必要があります。</font><font style="vertical-align: inherit;">したがって、数字も表示されるようにする必要があります。</font><font style="vertical-align: inherit;">図では、2ピクセルの高さにします。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pq/vm/w1/pqvmw1tghz4brz--t0qh6y-bzek.jpeg"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
では、スクリプトがブロックをどのように考慮するかについてです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキームは80x48ブロックで処理されます。各ブロックの領域は、水平方向に2〜79ピクセル、垂直方向に2〜47ピクセルです。</font><font style="vertical-align: inherit;">最初と最後のピクセルは使用されないため、ブロックの周囲に幅1ピクセルの黒いフレームを作成できます。これにより、回路の視覚的認識が向上し、作成が容易になります。</font></font></li>
<li>     .     ,       ,                .         .</li>
<li>     .     ,          ,                   3    .   ,    .        .       .   «»  ,   ,           —  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空のブロック内の列やその他の装飾は処理されません。これは、ピクセルの上下の行のみが考慮されるためです。</font><font style="vertical-align: inherit;">したがって、ブロックの内部に、装飾、図の説明、ポインター、列などを配置できます。これにより、スクリプトの結果に何らかの影響が及ぶことを心配する必要はありません。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、配列から受け取ったすべての座標が3Dワールドのスケールに変換され、そのスケールの係数（作成時に3Dエディターで選択された）が乗算されます。</font><font style="vertical-align: inherit;">アレイはゲームで使用する準備ができています。</font><font style="vertical-align: inherit;">スクリプトコードは速攻で記述されているため、洗練されたふりはしませんが、タスクを実行します。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">ap = {<font></font>
<font></font>
    <span class="hljs-comment">//      (  ),   3D  </span>
    <span class="hljs-attr">lvd</span>: {
        <span class="hljs-string">'lv01.png'</span>: {
            <span class="hljs-attr">invw</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">invh</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">level_dw</span>: <span class="hljs-number">-8.5</span>,
            <span class="hljs-attr">level_dh</span>: <span class="hljs-number">-1.5</span><font></font>
        },<font></font>
        <span class="hljs-string">'lv02.png'</span>: {
            <span class="hljs-attr">invw</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">invh</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">level_dw</span>: <span class="hljs-number">-19.5</span>,
            <span class="hljs-attr">level_dh</span>: <span class="hljs-number">-5.5</span><font></font>
        }<font></font>
    },<font></font>
<font></font>
    <span class="hljs-attr">blockw</span>: <span class="hljs-number">80</span>, <span class="hljs-comment">//   2D</span>
    <span class="hljs-attr">blockh</span>: <span class="hljs-number">48</span>, <span class="hljs-comment">//   2D</span>
    <span class="hljs-attr">sc3d</span>: <span class="hljs-number">0.05</span>, <span class="hljs-comment">//,   3D </span>
    <span class="hljs-attr">ex</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">//  3D (-   )</span><font></font>
<font></font>
<font></font>
    <span class="hljs-attr">v</span>: {
        <span class="hljs-attr">data</span>: []<font></font>
    },<font></font>
    <span class="hljs-attr">i</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">par</span>: {},
    <span class="hljs-attr">datai</span>: [],
    <span class="hljs-attr">resi</span>: [],
    <span class="hljs-attr">ars</span>: [],
    <span class="hljs-attr">fStopEncode</span>: <span class="hljs-literal">false</span>,<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">blockColor</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cl</span>) </span>{
        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'input_cl'</span>).value = cl;<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">startEncode</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
<font></font>
        <span class="hljs-comment">//     </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> ap.lvd) {<font></font>
            ap.lvd[key].dw = ap.lvd[key].level_dw * ap.blockw;<font></font>
            ap.lvd[key].dh = ap.lvd[key].level_dh * ap.blockh;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'startbtn'</span>).style.display = <span class="hljs-string">'none'</span>;
        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'startmsg'</span>).style.display = <span class="hljs-string">'block'</span>;<font></font>
<font></font>
        <span class="hljs-keyword">var</span> cl = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'input_cl'</span>).value;
        <span class="hljs-keyword">var</span> fld = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'input_fld'</span>).value;
        <span class="hljs-keyword">var</span> nm = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'input_nm'</span>).value;<font></font>
<font></font>
        ap.nm = nm;<font></font>
<font></font>
        ap.par = {<font></font>
            <span class="hljs-attr">path</span>: [fld + <span class="hljs-string">'/'</span>, nm],
            <span class="hljs-attr">key</span>: [nm],
            <span class="hljs-attr">cl</span>: aplib.hexToRgb(cl.substring(<span class="hljs-number">1</span>, <span class="hljs-number">7</span>))<font></font>
        };<font></font>
<font></font>
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
            ap.datai[ap.par.key] = <span class="hljs-keyword">new</span> Image();<font></font>
            ap.datai[ap.par.key].onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
                ap.parseData();<font></font>
            };<font></font>
            ap.datai[ap.par.key].src = ap.par.path[<span class="hljs-number">0</span>] + ap.par.path[<span class="hljs-number">1</span>];<font></font>
        }, <span class="hljs-number">500</span>);<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">stopEnode</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ap !== <span class="hljs-string">"undefined"</span>) {
            <span class="hljs-keyword">if</span> (e.keyCode == <span class="hljs-number">27</span>) {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'stop'</span>);<font></font>
                ap.fStopEncode = <span class="hljs-literal">true</span>;<font></font>
            };<font></font>
        };<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">parseData</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
        ap.w = ap.datai[ap.par.key[<span class="hljs-number">0</span>]].width, ap.h = ap.datai[ap.par.key[<span class="hljs-number">0</span>]].height;<font></font>
        aplib.initCanv(ap.w, ap.h);<font></font>
        ctx.drawImage(ap.datai[ap.par.key[<span class="hljs-number">0</span>]], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ap.w, ap.h, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ap.w, ap.h);<font></font>
        ap.ars = [];<font></font>
        ap.i = <span class="hljs-number">0</span>;<font></font>
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
            ap.parseData1();<font></font>
        }, <span class="hljs-number">1000</span>);<font></font>
<font></font>
    },<font></font>
<font></font>
    <span class="hljs-attr">parseData1</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (ap.i &lt; ap.par.key.length) {
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'info'</span>).innerHTML = <span class="hljs-string">''</span> + ap.nm;<font></font>
            ap.blocksw = <span class="hljs-built_in">Math</span>.floor(ap.w / ap.blockw);<font></font>
            ap.blocksh = <span class="hljs-built_in">Math</span>.floor(ap.h / ap.blockh);<font></font>
            ap.ar = [];<font></font>
            ap.arv = {};<font></font>
            ap.hi = <span class="hljs-number">0</span>;<font></font>
            ctx.fillStyle = <span class="hljs-string">'#CCCCCC'</span>;<font></font>
            ap.parseData2();<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'startbtn'</span>).style.display = <span class="hljs-string">'block'</span>;
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'startmsg'</span>).style.display = <span class="hljs-string">'none'</span>;<font></font>
        };<font></font>
    },<font></font>
<font></font>
    <span class="hljs-attr">parseData2</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (ap.hi &lt; ap.blocksh) {<font></font>
            ap.ar.push([]);<font></font>
            ap.wi = <span class="hljs-number">0</span>;<font></font>
            ap.parseData3();<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            ap.parseData4();<font></font>
        };<font></font>
    },<font></font>
<font></font>
    <span class="hljs-attr">parseData3</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> k = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> (ap.wi &lt; ap.blocksw) {
            <span class="hljs-keyword">var</span> fground = <span class="hljs-literal">true</span>,<font></font>
                fvari = <span class="hljs-literal">false</span>,<font></font>
                fempty = <span class="hljs-literal">true</span>;<font></font>
<font></font>
            <span class="hljs-keyword">var</span> upx1 = <span class="hljs-number">0</span>,<font></font>
                upx2 = <span class="hljs-number">0</span>,<font></font>
                dnx1 = <span class="hljs-number">0</span>,<font></font>
                dnx2 = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> upxf = <span class="hljs-literal">false</span>,<font></font>
                dnxf = <span class="hljs-literal">false</span>;<font></font>
<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> wii = <span class="hljs-number">1</span>; wii &lt; ap.blockw - <span class="hljs-number">2</span> + <span class="hljs-number">2</span>; wii++) {<font></font>
                pixelDatai = ctx.getImageData(ap.wi * ap.blockw + wii, ap.hi * ap.blockh + <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).data; <span class="hljs-comment">// </span>
                pixelDatai2 = ctx.getImageData(ap.wi * ap.blockw + wii, (ap.hi + <span class="hljs-number">1</span>) * ap.blockh - <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).data; <span class="hljs-comment">// </span><font></font>
<font></font>
                <span class="hljs-keyword">if</span> ((pixelDatai[<span class="hljs-number">0</span>] == ap.par.cl.r) &amp; (pixelDatai[<span class="hljs-number">1</span>] == ap.par.cl.g) &amp; (pixelDatai[<span class="hljs-number">2</span>] == ap.par.cl.b)) {
                    <span class="hljs-comment">//   ground   </span>
                    <span class="hljs-keyword">if</span> (upxf == <span class="hljs-literal">false</span>) {<font></font>
                        upxf = <span class="hljs-literal">true</span>;<font></font>
                        upx1 = wii;<font></font>
                    };<font></font>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">//   </span>
                    <span class="hljs-keyword">if</span> (upxf == <span class="hljs-literal">true</span>) {<font></font>
                        upx2 = wii + <span class="hljs-number">1</span>;<font></font>
                        upx1--;<font></font>
                        <span class="hljs-comment">//  </span>
                        dy = <span class="hljs-number">-1</span>; <span class="hljs-comment">// 3D       1</span>
                        ap.v.data.push([ap.wi * ap.blockw + upx1, ap.hi * ap.blockh + dy, ap.wi * ap.blockw + upx2, ap.hi * (ap.blockh) + ap.blockh - <span class="hljs-number">1</span>]);<font></font>
                        upxf = <span class="hljs-literal">false</span>;<font></font>
                        upx1 = <span class="hljs-number">0</span>;<font></font>
                        upx2 = <span class="hljs-number">0</span>;<font></font>
                    };<font></font>
                };<font></font>
<font></font>
                <span class="hljs-keyword">if</span> ((pixelDatai2[<span class="hljs-number">0</span>] == ap.par.cl.r) &amp; (pixelDatai2[<span class="hljs-number">1</span>] == ap.par.cl.g) &amp; (pixelDatai2[<span class="hljs-number">2</span>] == ap.par.cl.b)) {
                    <span class="hljs-comment">//   ground    </span>
                    <span class="hljs-keyword">if</span> (upxf == <span class="hljs-literal">false</span>) {
                        <span class="hljs-keyword">if</span> (dnxf == <span class="hljs-literal">false</span>) {<font></font>
                            dnxf = <span class="hljs-literal">true</span><font></font>
                            dnx1 = wii;<font></font>
                        };<font></font>
                    };<font></font>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (upxf == <span class="hljs-literal">false</span>) {
                        <span class="hljs-keyword">if</span> (dnxf == <span class="hljs-literal">true</span>) {<font></font>
                            dnx2 = wii + <span class="hljs-number">1</span>;<font></font>
                            dnx1--;<font></font>
                            <span class="hljs-comment">//  </span>
                            dy = <span class="hljs-number">2</span>; <span class="hljs-comment">// 3D    2</span>
                            ap.v.data.push([ap.wi * ap.blockw + dnx1, (ap.hi + <span class="hljs-number">1</span>) * ap.blockh - <span class="hljs-number">3</span> + dy, ap.wi * ap.blockw + dnx2, (ap.hi + <span class="hljs-number">1</span>) * ap.blockh - <span class="hljs-number">3</span> + <span class="hljs-number">2</span> + dy]);<font></font>
                            dnxf = <span class="hljs-literal">false</span>;<font></font>
                            dnx1 = <span class="hljs-number">0</span>;<font></font>
                            dnx2 = <span class="hljs-number">0</span>;<font></font>
                        };<font></font>
                    };<font></font>
                };<font></font>
<font></font>
            };<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (ap.fStopEncode == <span class="hljs-literal">true</span>) {<font></font>
                ap.hi = ap.h, ap.wi = ap.w, i = ap.par.key.length;<font></font>
            };<font></font>
<font></font>
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
                ap.wi++;<font></font>
                ap.parseData3();<font></font>
            }, <span class="hljs-number">10</span>);<font></font>
<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            ap.hi++;<font></font>
            ap.parseData2();<font></font>
        };<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">parseData4</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> t, tw, tx, ty, ar = [];
            <span class="hljs-comment">// </span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ap.v.data.length; i++) {<font></font>
                ar = ap.v.data[i];<font></font>
                t = ar[<span class="hljs-number">0</span>] + <span class="hljs-string">';'</span> + (ar[<span class="hljs-number">1</span>]+<span class="hljs-number">1</span>) + <span class="hljs-string">'&lt;br/&gt;'</span> + ar[<span class="hljs-number">2</span>] + <span class="hljs-string">';'</span> + (ar[<span class="hljs-number">3</span>]+<span class="hljs-number">1</span>);<font></font>
                tw = ar[<span class="hljs-number">2</span>] - ar[<span class="hljs-number">0</span>];<font></font>
                tx = ar[<span class="hljs-number">0</span>];<font></font>
                ty = ar[<span class="hljs-number">1</span>] + <span class="hljs-built_in">Math</span>.floor((ar[<span class="hljs-number">3</span>] - ar[<span class="hljs-number">1</span>]) / <span class="hljs-number">2</span>) - <span class="hljs-number">0</span>;<font></font>
                aplib.Tex2Canvas(ctx, t, <span class="hljs-string">'normal 10px Arial'</span>, <span class="hljs-number">10</span>, <span class="hljs-string">'#CCCCCC'</span>, tx, ty, tw, <span class="hljs-number">0</span>, <span class="hljs-string">'center'</span>, <span class="hljs-string">'top'</span>);<font></font>
            };<font></font>
<font></font>
            ap.parseData5();<font></font>
<font></font>
        }, <span class="hljs-number">10</span>);<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">parseData5</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> t, tw, tx, ty, ar = [],<font></font>
            n;<font></font>
<font></font>
        <span class="hljs-comment">//   3D</span>
        <span class="hljs-keyword">var</span> lv = ap.lvd[ap.nm];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ap.v.data.length; i++) {<font></font>
            ar = ap.v.data[i];<font></font>
            ar[<span class="hljs-number">0</span>] += lv.dw;<font></font>
            ar[<span class="hljs-number">1</span>] += lv.dh;<font></font>
            ar[<span class="hljs-number">2</span>] += lv.dw;<font></font>
            ar[<span class="hljs-number">3</span>] += lv.dh;
            <span class="hljs-keyword">if</span> (lv.invh == <span class="hljs-literal">true</span>) {<font></font>
                n = -ar[<span class="hljs-number">1</span>];<font></font>
                ar[<span class="hljs-number">1</span>] = -ar[<span class="hljs-number">3</span>];<font></font>
                ar[<span class="hljs-number">3</span>] = n;<font></font>
            };<font></font>
            <span class="hljs-keyword">if</span> (lv.invw == <span class="hljs-literal">true</span>) {<font></font>
                n = -ar[<span class="hljs-number">0</span>]<font></font>
                ar[<span class="hljs-number">0</span>] = -ar[<span class="hljs-number">2</span>];<font></font>
                ar[<span class="hljs-number">2</span>] = n;<font></font>
            };<font></font>
            ar[<span class="hljs-number">0</span>] = <span class="hljs-built_in">Math</span>.round(ap.sc3d * ar[<span class="hljs-number">0</span>] * ap.ex) / ap.ex;<font></font>
            ar[<span class="hljs-number">1</span>] = <span class="hljs-built_in">Math</span>.round(ap.sc3d * ar[<span class="hljs-number">1</span>] * ap.ex) / ap.ex;<font></font>
            ar[<span class="hljs-number">2</span>] = <span class="hljs-built_in">Math</span>.round(ap.sc3d * ar[<span class="hljs-number">2</span>] * ap.ex) / ap.ex;<font></font>
            ar[<span class="hljs-number">3</span>] = <span class="hljs-built_in">Math</span>.round(ap.sc3d * ar[<span class="hljs-number">3</span>] * ap.ex) / ap.ex;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-comment">//   </span><font></font>
        ap.v.data.sort(aplib.sortBy0);<font></font>
<font></font>
        <span class="hljs-built_in">console</span>.log(ap.v.data);<font></font>
<font></font>
        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'divresult'</span>).innerHTML = <span class="hljs-built_in">JSON</span>.stringify(ap.v.data);<font></font>
    }<font></font>
<font></font>
};<font></font>
<font></font>
<font></font>
aplib = {<font></font>
<font></font>
    <span class="hljs-attr">hexToRgb</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">hex</span>) </span>{
        <span class="hljs-keyword">var</span> arrBuff = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">4</span>);
        <span class="hljs-keyword">var</span> vw = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataView</span>(arrBuff);<font></font>
        vw.setUint32(<span class="hljs-number">0</span>, <span class="hljs-built_in">parseInt</span>(hex, <span class="hljs-number">16</span>), <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">var</span> arrByte = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(arrBuff);
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">r</span>: arrByte[<span class="hljs-number">1</span>],
            <span class="hljs-attr">g</span>: arrByte[<span class="hljs-number">2</span>],
            <span class="hljs-attr">b</span>: arrByte[<span class="hljs-number">3</span>],
            <span class="hljs-attr">s</span>: arrByte[<span class="hljs-number">1</span>] + <span class="hljs-string">","</span> + arrByte[<span class="hljs-number">2</span>] + <span class="hljs-string">","</span> + arrByte[<span class="hljs-number">3</span>]<font></font>
        };<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">//   canvas</span>
    <span class="hljs-attr">Tex2Canvas</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctx, t, font, lin, fcolor, x, y, w, h, haln, valn</span>) </span>{
        <span class="hljs-comment">//left, right, center, center-lim-</span><font></font>
        ctx.font = font;<font></font>
        ctx.fillStyle = fcolor;<font></font>
        <span class="hljs-keyword">var</span> l = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> tx = x;
        <span class="hljs-keyword">var</span> ftw = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">var</span> tw = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">var</span> arr = t.split(<span class="hljs-string">'&lt;br/&gt;'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i++) {<font></font>
            arr[i] = arr[i].split(<span class="hljs-string">' '</span>);<font></font>
        };<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i++) {
            <span class="hljs-keyword">var</span> s = <span class="hljs-string">''</span>,<font></font>
                slen = <span class="hljs-number">0</span>,<font></font>
                s1 = <span class="hljs-string">''</span>,<font></font>
                j = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> (j &lt; arr[i].length) {
                <span class="hljs-keyword">var</span> wordcount = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">while</span> ((slen &lt; w) &amp; (j &lt; arr[i].length)) {<font></font>
                    s = s1;<font></font>
                    s1 = s + arr[i][j] + <span class="hljs-string">' '</span>;<font></font>
                    slen = ctx.measureText(s1).width;<font></font>
                    <span class="hljs-keyword">if</span> (slen &lt; w) {<font></font>
                        j++;<font></font>
                        wordcount++;<font></font>
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (wordcount &gt; <span class="hljs-number">0</span>) {<font></font>
                            s1 = s;<font></font>
                        } <span class="hljs-keyword">else</span> {<font></font>
                            j++;<font></font>
                        };<font></font>
                    };<font></font>
                };<font></font>
                ftw = <span class="hljs-literal">false</span>;<font></font>
                tw = ctx.measureText(s1).width;<font></font>
                <span class="hljs-keyword">if</span> (haln == <span class="hljs-string">'center'</span>) {<font></font>
                    tx = x + <span class="hljs-built_in">Math</span>.round((w - tw) / <span class="hljs-number">2</span>);<font></font>
                };<font></font>
                <span class="hljs-keyword">if</span> (haln == <span class="hljs-string">'right'</span>) {<font></font>
                    tx = x + <span class="hljs-built_in">Math</span>.round((w - tw));<font></font>
                };<font></font>
                <span class="hljs-keyword">if</span> (haln == <span class="hljs-string">'center-lim'</span>) {
                    <span class="hljs-keyword">if</span> (tw &gt; w) {<font></font>
                        tw = w;<font></font>
                    };<font></font>
                    <span class="hljs-keyword">if</span> (tw &lt; <span class="hljs-number">1</span>) {<font></font>
                        tw = <span class="hljs-number">1</span>;<font></font>
                    };<font></font>
                    tx = x + <span class="hljs-built_in">Math</span>.round((w - tw) / <span class="hljs-number">2</span>);<font></font>
                    ftw = <span class="hljs-literal">true</span>;<font></font>
                };<font></font>
                <span class="hljs-keyword">if</span> (ftw == <span class="hljs-literal">false</span>) {<font></font>
                    ctx.fillText(s1, tx, l * lin + y);<font></font>
                } <span class="hljs-keyword">else</span> {<font></font>
                    ctx.fillText(s1, tx, l * lin + y, tw);<font></font>
                };<font></font>
                <span class="hljs-keyword">if</span> (s1 == <span class="hljs-string">''</span>) {<font></font>
                    j = arr[i].length + <span class="hljs-number">1</span>;<font></font>
                };<font></font>
                l++;<font></font>
                s1 = <span class="hljs-string">''</span>;<font></font>
                slen = <span class="hljs-number">0</span>;<font></font>
            };<font></font>
        };<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round(tw);<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-comment">// canvas</span>
    <span class="hljs-attr">initCanv</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">w, h</span>) </span>{<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canvErr</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'divcanv'</span>).innerHTML = <span class="hljs-string">'&lt;div style="height:130px"&gt;&lt;/div&gt;&lt;div style="width:440px; border:#FFFFFF 1px solid; margin:10px; padding:4px; background-color:#000000"&gt;&lt;p class="txterr"&gt;---&gt; Error&lt;br/&gt;HTML5 Canvas is not supported!&lt;br/&gt;Please, update your browser!&lt;/p&gt;&lt;/div&gt;'</span>;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (w == <span class="hljs-number">0</span>) {<font></font>
            w = <span class="hljs-number">740</span>;<font></font>
            h = <span class="hljs-number">680</span>;<font></font>
        };<font></font>
<font></font>
        elcanv = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'divcanv'</span>);<font></font>
        elcanv.innerHTML = <span class="hljs-string">'&lt;canvas id="canv" style="width:'</span> + w + <span class="hljs-string">'px; height:'</span> + h + <span class="hljs-string">'px; display:block;" width="'</span> + w + <span class="hljs-string">'" height="'</span> + h + <span class="hljs-string">'"&gt;&lt;/canvas&gt;'</span>;<font></font>
        canvas1 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'canv'</span>);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!canvas1) {<font></font>
            canvErr();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (canvas1.getContext) {<font></font>
                ctx = canvas1.getContext(<span class="hljs-string">'2d'</span>);<font></font>
                ctx.clearRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h);
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                canvErr();<font></font>
            };<font></font>
        };<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">sortBy0</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">i, ii</span>) </span>{
        <span class="hljs-keyword">if</span> (i[<span class="hljs-number">0</span>] &gt; ii[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (i[<span class="hljs-number">0</span>] &lt; ii[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
};</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、ゲームがブロックの配列でどのように機能するかについて。ゲームは交差する廊下（レベル）を使用します。プレイヤーが廊下に変わると、ブロックの新しい配列が接続されます。したがって、廊下ごとに、レベルスキームから取得された独自の配列が取得されます。プレイヤーの移動中、彼の座標は各ブロック内にあるかどうかチェックされます。そして、彼がいずれかのブロック内にいる場合、衝突が発生します。しかし、プレイヤーのあらゆる動きにおいて、レベルのすべてのブロックとの交差を探す必要はありません。プレーヤーに最も近いブロックのみの配列を作成します。</font></font><br>
<br>
<pre><code class="javascript hljs">collisionsUpdate: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y, dw, dh</span>) </span>{
    <span class="hljs-keyword">var</span> coll = [];
    <span class="hljs-keyword">var</span> o;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ap.v.lv.d.length; i++) {<font></font>
        o = ap.v.lv.d[i];<font></font>
        <span class="hljs-keyword">if</span> ((o[<span class="hljs-number">0</span>] &gt;= x - ap.v.dw) &amp; (o[<span class="hljs-number">2</span>] &lt;= x + ap.v.dw)) {
            <span class="hljs-keyword">if</span> ((o[<span class="hljs-number">1</span>] &gt;= y - ap.v.dh) &amp; (o[<span class="hljs-number">3</span>] &lt;= y + ap.v.dh)) {<font></font>
                coll.push(o);<font></font>
            };<font></font>
        };<font></font>
    };<font></font>
    ap.v.coll = coll;<font></font>
},</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、入力xで、yはプレーヤーの現在の座標です。dw、dhは、ブロックを水平および垂直に検索する距離です。たとえば、12メートルや8メートルです。言い換えれば、プレーヤーの周囲のすべてのブロックを24x16メートルの正方形で囲みます。彼らは衝突の検索に参加します。 ap.v.lv.d [i]は現在のレベルのブロックの配列の要素です。実際、彼自身も1つのブロックの境界を定義する4つの数値の配列です-[x1、y1、x2、y2]したがって、正方形をチェックします水平方向にはインデックス0と2、垂直方向には1と3の要素を使用します。一致する場合は、このブロックを衝突のリストap.v.collに追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プレーヤーが移動すると、この衝突のリストが更新されますが、パフォーマンスを節約するために、すべてのステップ（つまり、フレームのレンダリング）ではなく、プレーヤーがap.v.collwStepで指定された少し小さい特定の正方形を離れると、 ap.v.collhStep、たとえば8メートルと4メートル。つまり、プレイヤーが特定のパスを元の位置から水平または垂直に通過したときに、コリジョンアレイを再度組み立てます。同時に、次の反復で使用するために配列を再構成した位置を覚えておきます。 pers [ax]-ここではaxは座標軸（ax）を意味し、プレーヤーが歩いている廊下の方向に応じて、xまたはzになります。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//  </span>
<span class="hljs-keyword">if</span> ((<span class="hljs-built_in">Math</span>.abs(pers[ax] - ap.v.collw) &gt; ap.v.collwStep) || (<span class="hljs-built_in">Math</span>.abs(pers.y - ap.v.collh) &gt; ap.v.collhStep)) {<font></font>
	ap.v.collw = pers[ax];<font></font>
	ap.v.collh = pers.y;<font></font>
	ap.collisionsUpdate(pers[ax], pers.y, <span class="hljs-number">12</span>, <span class="hljs-number">8</span>);<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜそのような困難なのか？</font><font style="vertical-align: inherit;">レベルで衝突のすべての配列を使用して、スチームバスを利用しないのはなぜですか？</font><font style="vertical-align: inherit;">実際には、衝突検出ははるかに複雑なアルゴリズムに従って実行され、フレームのすべてのレンダリングで、最も近いブロックではなく、すべてのレベルのブロックとの衝突をチェックすることは不利益です。</font><font style="vertical-align: inherit;">（ただし、これは正確ではありません。）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記で準備した衝突配列を使用したフレームの各レンダリングでの衝突の定義：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">collisionsDetect: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y, xOld, yOld, up</span>) </span>{<font></font>
<font></font>
    <span class="hljs-comment">//up=-1 - </span>
    <span class="hljs-keyword">var</span> res = <span class="hljs-literal">false</span>,<font></font>
        o;<font></font>
<font></font>
    <span class="hljs-keyword">var</span> collw = <span class="hljs-literal">false</span>,<font></font>
        collh = <span class="hljs-literal">false</span>,<font></font>
        collwi = <span class="hljs-literal">false</span>,<font></font>
        collhi = <span class="hljs-literal">false</span>,<font></font>
        collhsup = <span class="hljs-literal">false</span>,<font></font>
        support = [],<font></font>
        supportf = <span class="hljs-literal">false</span>,<font></font>
        fw = <span class="hljs-literal">false</span>,<font></font>
        upb = <span class="hljs-number">-1</span>;<font></font>
<font></font>
    <span class="hljs-keyword">var</span> bub = <span class="hljs-number">-1</span>,<font></font>
        bubw = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">var</span> pw2 = ap.v.player.pw2,<font></font>
        ph2 = ap.v.player.ph2,<font></font>
        supportd = ap.v.supportd;<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ap.v.coll.length; i++) {<font></font>
<font></font>
        o = ap.v.coll[i];<font></font>
        collwi = <span class="hljs-literal">false</span>;<font></font>
        collhi = <span class="hljs-literal">false</span>;<font></font>
        collhsup = <span class="hljs-literal">false</span>;<font></font>
        fw = <span class="hljs-literal">false</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((x + pw2 &gt;= o[<span class="hljs-number">0</span>]) &amp; (x - pw2 &lt;= o[<span class="hljs-number">2</span>])) {
            <span class="hljs-keyword">if</span> ((y + ph2 &gt; o[<span class="hljs-number">1</span>]) &amp; (y - ph2 &lt; o[<span class="hljs-number">3</span>])) {<font></font>
                collwi = <span class="hljs-literal">true</span>;<font></font>
            };<font></font>
        };<font></font>
<font></font>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">if</span> ((xOld + pw2 &gt;= o[<span class="hljs-number">0</span>]) &amp; (xOld - pw2 &lt;= o[<span class="hljs-number">2</span>])) {
            <span class="hljs-keyword">if</span> ((yOld + ph2 &gt; o[<span class="hljs-number">1</span>]) &amp; (yOld - ph2 &lt; o[<span class="hljs-number">3</span>])) {<font></font>
                bub = i;<font></font>
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(xOld - o[<span class="hljs-number">0</span>]) &lt; <span class="hljs-built_in">Math</span>.abs(xOld - o[<span class="hljs-number">2</span>])) {<font></font>
                    bubw = <span class="hljs-number">-1</span>;<font></font>
                } <span class="hljs-keyword">else</span> {<font></font>
                    bubw = <span class="hljs-number">1</span>;<font></font>
                };<font></font>
            };<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((x &gt;= o[<span class="hljs-number">0</span>]) &amp; (x &lt;= o[<span class="hljs-number">2</span>])) {<font></font>
            fw = <span class="hljs-literal">true</span>; <span class="hljs-comment">//  i  </span><font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((y + ph2 &gt;= o[<span class="hljs-number">1</span>]) &amp; (y - ph2 &lt;= o[<span class="hljs-number">3</span>])) {
            <span class="hljs-keyword">if</span> ((x &gt; o[<span class="hljs-number">0</span>]) &amp; (x &lt; o[<span class="hljs-number">2</span>])) {<font></font>
                collhi = <span class="hljs-literal">true</span>;
                <span class="hljs-comment">// </span>
                <span class="hljs-keyword">if</span> (y + ph2 &gt; o[<span class="hljs-number">3</span>]) {<font></font>
                    collhsup = <span class="hljs-literal">true</span>;<font></font>
                    supportf = <span class="hljs-literal">true</span>;<font></font>
                    support = o;<font></font>
                    upb = <span class="hljs-number">1</span>;<font></font>
                };<font></font>
                <span class="hljs-comment">// </span>
                <span class="hljs-keyword">if</span> (y - ph2 &lt; o[<span class="hljs-number">1</span>]) {<font></font>
                    upb = <span class="hljs-number">-1</span>;<font></font>
                };<font></font>
            };<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((y - ph2 &gt;= o[<span class="hljs-number">3</span>] + supportd - <span class="hljs-number">0.11</span>) &amp; (y - ph2 &lt;= o[<span class="hljs-number">3</span>] + supportd + <span class="hljs-number">0.001</span>)) {
            <span class="hljs-keyword">if</span> (fw == <span class="hljs-literal">true</span>) {<font></font>
                collhi = <span class="hljs-literal">true</span>;<font></font>
                collh = <span class="hljs-literal">true</span>;<font></font>
                res = <span class="hljs-literal">true</span>;<font></font>
                collhsup = <span class="hljs-literal">true</span>;<font></font>
                supportf = <span class="hljs-literal">true</span>;<font></font>
                support = o;<font></font>
            };<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (collwi &amp; collhi) {<font></font>
            res = <span class="hljs-literal">true</span>;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (collwi) {<font></font>
            collw = <span class="hljs-literal">true</span>;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (collhi) {<font></font>
            collh = <span class="hljs-literal">true</span>;<font></font>
        };<font></font>
<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">f</span>: res,
        <span class="hljs-attr">w</span>: collw,
        <span class="hljs-attr">h</span>: collh,
        <span class="hljs-attr">support</span>: support,
        <span class="hljs-attr">supportf</span>: supportf,
        <span class="hljs-attr">upb</span>: upb,
        <span class="hljs-attr">bub</span>: bub,
        <span class="hljs-attr">bubw</span>: bubw<font></font>
    };<font></font>
},</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、x、y、xOld、yOldは、プレーヤーの新しい現在の座標です。新しい座標は、ボタンが押されたときに、指定された移動速度に基づいて計算されます。つまり、これらは可能な座標です。衝突のリストにあるブロック内にあるかどうかがチェックされます。彼らが落ちた場合、彼らは古いものにロールバックし、プレイヤーは障害物を通過しません。そして、彼らが落ちなければ、彼らは最新のものになります。 pw2とph2は、プレーヤーの架空のコライダーの幅と高さの半分です（プレーヤーの幅/ 2、プレーヤーの高さ/ 2）。出力は、水平方向および垂直方向の衝突（collw、collh）がある場合、プレーヤーの下にサポートブロック（supportf）があるかどうかで発行されます-これにより、落下アニメーションをさらに開始するか、またはプレーヤーが単に隣接ブロックに切り替えたかなどが明確になります。なぜそこに0.001を加え、0.11を差し引いたのかと聞かないでください。それは不気味な松葉杖ですこれは、ブロックを通り抜けて落下するのを防ぎ、水平障害物との衝突によるジッターの影響を防ぎます...この機能は機能しますが、通常の方法で書き換える必要があります。この関数の最適化もまだ欠けています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
衝突の場合は、ここで終了する価値があると思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の方法がレイトレーシングよりどれほど速いか、おそらく遅いかを言うのは難しいですが、後者の場合、Three.jsは衝突システムに参加するオブジェクトの配列も保存します。</font><font style="vertical-align: inherit;">そこにある衝突は、ビームを放射する方法と、オブジェクトの側面の平面との交点によって、そして私と一緒に、1つのオブジェクトの座標が2つの軸のそれぞれに沿って他のオブジェクトの内側にあるかどうかを決定することによって決まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームには、移動するオブジェクト（サメ）と、ある種のアニメーションをトリガーするマーカーオブジェクトもあります（たとえば、水に触れるとサメの動きがトリガーされます）。</font><font style="vertical-align: inherit;">これらのオブジェクトはすべて衝突にも関与し、一部は時変座標を伴います。</font><font style="vertical-align: inherit;">奇妙なことに、すべてが単純です。オブジェクトの移動中に、その座標がプレーヤーの座標と比較されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/mj/cx/rz/mjcxrz4m_3fwkm7kep-yrtbp-qa.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゲームパッド</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、ブラウザでJavaScriptゲームパッドをサポートすることは簡単な作業ではありません。</font><font style="vertical-align: inherit;">ボタンを押して離すイベントはありません。</font><font style="vertical-align: inherit;">デバイスを接続および切断するイベントと、定期的なポーリングによって取得できる状態のみがあり、それを以前のイベントと比較します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows 8.1のタブレットとWindows 10のPCのブラウザーでのゲームパッドの操作を説明するビデオ。ただし、タブレットは2014年にリリースされた古いものであるため、ゲームの動的照明はオフになっています。</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/knkMKB5uizk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームパッドをポーリングするために、100ミリ秒ごとに関数が呼び出されます。</font><font style="vertical-align: inherit;">それは私のライブラリm3d.lib.globalTimer.addEventの関数を使用して設定されます。</font></font><br>
<br>
<pre><code class="javascript hljs">m3d.lib.globalTimer.addEvent({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'gamepad'</span>,
    <span class="hljs-attr">ti</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">f</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> st = m3d.gamepad.state();
        <span class="hljs-keyword">if</span> (st == <span class="hljs-literal">false</span>) {
            <span class="hljs-keyword">if</span> (contr.gpDownFlag == <span class="hljs-literal">true</span>) {<font></font>
                m3d.gamepad.resetH();<font></font>
            };<font></font>
        };<font></font>
    }<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、globalTimerは、私が作成したjavascript setIntervalタイマーイベント管理システムです。そこでは、一連のイベントが特定の配列に追加され、異なる間隔で呼び出す必要があります。次に、1つのsetIntervalタイマーに、最も頻度の高いイベントに対応する頻度が設定されます。タイマーは関数m3d.lib.globalTimer.update（）をポーリングします。これは、すべてのイベントのリストを実行し、実行されるようになったイベントの関数を実行します。イベントを追加または削除すると、間隔の頻度も変わる可能性があります（たとえば、最速のイベントを削除した場合）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームは、各ゲームパッドキーのハンドラーも設定します。'a 'は軸（ax）、' b 'はボタン（button）、11は十字ボタンの水平軸に沿った左の偏差です（ボタン1の場合と同様）。 12-十字の横軸（ボタン2のように）に沿った右偏差、21および22-縦軸。例：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
['a'、11]、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
['b'、3] </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
は、次の関数が水平軸に沿った左への偏差とボタン3（左）の偏差に対して同時に設定されることを意味します。さて、ボタンが押されたときに実行され、離されたときに実行される関数が設定されています。</font></font><br>
<br>
<pre><code class="javascript hljs">    m3d.gamepad.setHandler(<font></font>
<font></font>
        [<font></font>
            [<span class="hljs-string">'a'</span>, <span class="hljs-number">11</span>],<font></font>
            [<span class="hljs-string">'b'</span>, <span class="hljs-number">3</span>]<font></font>
        ],<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{
            <span class="hljs-keyword">if</span> (contr.btState.lt == <span class="hljs-literal">false</span>) {<font></font>
                contr.keyDownFlag = <span class="hljs-literal">true</span>;<font></font>
                contr.btState.lt = <span class="hljs-literal">true</span>;<font></font>
                contr.gpDownFlag = <span class="hljs-literal">true</span>;<font></font>
                apcontrolsRenderStart();<font></font>
            };<font></font>
        },<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{<font></font>
            contr.btState.lt = <span class="hljs-literal">false</span>;<font></font>
            m3d.contr.controlsCheckBt();<font></font>
            apcontrolsRenderStart();<font></font>
        }<font></font>
<font></font>
    );</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでapcontrolsRenderStart（）は、まだ実行されていない場合にレンダリングを起動する関数です。</font><font style="vertical-align: inherit;">一般に、ゲームパッドのサポートは私のm3dライブラリと密接に結びついているので、その機能のすべてを説明すると、非常に長い間伸びてしまいます... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームパッドの初期化を実装し、ハンドラーをインストールし、状態をポーリングする最も簡単な方法であるゲームパッドの部分のみを与えます。 。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">gamepad: {<font></font>
<font></font>
    <span class="hljs-attr">connected</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">gamepad</span>: {},
    <span class="hljs-attr">gamepadKey</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">axesCount</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">buttonsCount</span>: <span class="hljs-number">0</span>,<font></font>
<font></font>
    <span class="hljs-attr">f</span>: [], <span class="hljs-comment">// </span>
    <span class="hljs-attr">fup</span>: [], <span class="hljs-comment">// </span>
    <span class="hljs-attr">fval</span>: [], <span class="hljs-comment">//     </span>
    <span class="hljs-attr">fupCall</span>: [], <span class="hljs-comment">//  </span>
    <span class="hljs-attr">buttons</span>: [], <span class="hljs-comment">//link to f [0.. ]</span>
    <span class="hljs-attr">axes</span>: [], <span class="hljs-comment">//link to f [0.. ]</span><font></font>
<font></font>
    <span class="hljs-attr">initCb</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{},
    <span class="hljs-attr">resetH</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{},<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">init</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gp</span>) </span>{
        <span class="hljs-keyword">var</span> f = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> gp) {
            <span class="hljs-keyword">if</span> (f == <span class="hljs-literal">false</span>) {
                <span class="hljs-keyword">if</span> (gp[key] != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> gp[key].id !== <span class="hljs-string">"undefined"</span>) {<font></font>
                        f = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">this</span>.connected = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">this</span>.gamepad = gp[key];
                        <span class="hljs-keyword">this</span>.gamepadKey = key;<font></font>
                    };<font></font>
                };<font></font>
            };<font></font>
        };<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.gamepad.axes !== <span class="hljs-string">"undefined"</span>) {
            <span class="hljs-keyword">this</span>.axesCount = <span class="hljs-keyword">this</span>.gamepad.axes.length;<font></font>
        };<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.gamepad.buttons !== <span class="hljs-string">"undefined"</span>) {
            <span class="hljs-keyword">this</span>.buttonsCount = <span class="hljs-keyword">this</span>.gamepad.buttons.length;<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.f = [];
        <span class="hljs-keyword">this</span>.fup = [];
        <span class="hljs-keyword">this</span>.fval = [];
        <span class="hljs-keyword">this</span>.fupCall = [];<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.axes = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.axesCount * <span class="hljs-number">2</span>; i++) {
            <span class="hljs-keyword">this</span>.axes.push(<span class="hljs-number">-1</span>);<font></font>
        };<font></font>
        <span class="hljs-keyword">this</span>.buttons = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.buttonsCount; i++) {
            <span class="hljs-keyword">this</span>.buttons.push(<span class="hljs-number">-1</span>);<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.initCb();<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">setHandlerReset</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">f</span>) </span>{
        <span class="hljs-keyword">this</span>.resetH = f;<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">setHandler</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ar, f, fup</span>) </span>{
        <span class="hljs-comment">//ar['b',3] ['a',11]</span>
        <span class="hljs-keyword">var</span> fi, bt, ax, finext, finexta;<font></font>
        finexta = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; ar.length; i++) {
            <span class="hljs-keyword">if</span> (ar[i][<span class="hljs-number">0</span>] == <span class="hljs-string">'a'</span>) {<font></font>
                ax = <span class="hljs-built_in">Math</span>.floor(ar[i][<span class="hljs-number">1</span>] / <span class="hljs-number">10</span>);<font></font>
                bt = ar[i][<span class="hljs-number">1</span>] - (ax * <span class="hljs-number">10</span>);<font></font>
                bt = ax * <span class="hljs-number">2</span> + bt - <span class="hljs-number">3</span>;<font></font>
                fi = <span class="hljs-keyword">this</span>.axes[bt];
                <span class="hljs-keyword">if</span> (fi == <span class="hljs-number">-1</span>) {
                    <span class="hljs-comment">//  </span>
                    fi = <span class="hljs-keyword">this</span>.f.length;
                    <span class="hljs-keyword">if</span> (finexta == <span class="hljs-literal">false</span>) {<font></font>
                        finexta = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">this</span>.f.push(f);
                        <span class="hljs-keyword">this</span>.fup.push(fup);
                        <span class="hljs-keyword">this</span>.fval.push(<span class="hljs-number">0</span>);
                        <span class="hljs-keyword">this</span>.fupCall.push(<span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.axes[bt] = fi;<font></font>
                    } <span class="hljs-keyword">else</span> {<font></font>
                        fi--;<font></font>
                        <span class="hljs-keyword">this</span>.f[fi] = f;
                        <span class="hljs-keyword">this</span>.fup[fi] = fup;
                        <span class="hljs-keyword">this</span>.axes[bt] = fi;<font></font>
                    };<font></font>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.f[fi] = f;
                    <span class="hljs-keyword">this</span>.fup[fi] = fup;<font></font>
                };<font></font>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ar[i][<span class="hljs-number">0</span>] == <span class="hljs-string">'b'</span>) {<font></font>
                bt = ar[i][<span class="hljs-number">1</span>] - <span class="hljs-number">1</span>;<font></font>
                fi = <span class="hljs-keyword">this</span>.buttons[bt];
                <span class="hljs-keyword">if</span> (fi == <span class="hljs-number">-1</span>) {
                    <span class="hljs-comment">//  </span>
                    fi = <span class="hljs-keyword">this</span>.f.length;
                    <span class="hljs-keyword">if</span> (finexta == <span class="hljs-literal">false</span>) {<font></font>
                        finexta = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">this</span>.f.push(f);
                        <span class="hljs-keyword">this</span>.fup.push(fup);
                        <span class="hljs-keyword">this</span>.fval.push(<span class="hljs-number">0</span>);
                        <span class="hljs-keyword">this</span>.fupCall.push(<span class="hljs-literal">true</span>);
                        <span class="hljs-keyword">this</span>.buttons[bt] = fi;<font></font>
                    } <span class="hljs-keyword">else</span> {<font></font>
                        fi--;<font></font>
                        <span class="hljs-keyword">this</span>.f[fi] = f;
                        <span class="hljs-keyword">this</span>.fup[fi] = fup;
                        <span class="hljs-keyword">this</span>.buttons[bt] = fi;<font></font>
                    };<font></font>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.f[fi] = f;
                    <span class="hljs-keyword">this</span>.fup[fi] = fup;<font></font>
                };<font></font>
            };<font></font>
        };<font></font>
    },<font></font>
<font></font>
<font></font>
    <span class="hljs-attr">state</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> pressed = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">var</span> fi, fval, axesval;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.fval.length; i++) {
            <span class="hljs-keyword">this</span>.fval[i] = <span class="hljs-number">0</span>;<font></font>
        };<font></font>
<font></font>
		<span class="hljs-comment">//  </span>
        <span class="hljs-keyword">var</span> gp = navigator.getGamepads()[<span class="hljs-keyword">this</span>.gamepadKey];<font></font>
		<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.axesCount; i++) {<font></font>
            axesval = <span class="hljs-built_in">Math</span>.round(gp.axes[i]);
            <span class="hljs-keyword">if</span> (axesval &lt; <span class="hljs-number">0</span>) {<font></font>
                pressed = <span class="hljs-literal">true</span>;<font></font>
                fi = <span class="hljs-keyword">this</span>.axes[i * <span class="hljs-number">2</span>];
                <span class="hljs-keyword">if</span> (fi != <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">this</span>.fval[fi] = gp.axes[i];
                    <span class="hljs-keyword">this</span>.fupCall[fi] = <span class="hljs-literal">true</span>;<font></font>
                };<font></font>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (axesval &gt; <span class="hljs-number">0</span>) {<font></font>
                pressed = <span class="hljs-literal">true</span>;<font></font>
                fi = <span class="hljs-keyword">this</span>.axes[i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>];
                <span class="hljs-keyword">if</span> (fi != <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">this</span>.fval[fi] = gp.axes[i];
                    <span class="hljs-keyword">this</span>.fupCall[fi] = <span class="hljs-literal">true</span>;<font></font>
                };<font></font>
            };<font></font>
        };<font></font>
		<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.buttonsCount; i++) {
            <span class="hljs-keyword">if</span> (gp.buttons[i].pressed == <span class="hljs-literal">true</span>) {<font></font>
                pressed = <span class="hljs-literal">true</span>;<font></font>
                fi = <span class="hljs-keyword">this</span>.buttons[i];
                <span class="hljs-keyword">if</span> (fi != <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">this</span>.fval[fi] = <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">this</span>.fupCall[fi] = <span class="hljs-literal">true</span>;<font></font>
                };<font></font>
            };<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.fval.length; i++) {<font></font>
            fval = <span class="hljs-keyword">this</span>.fval[i];
            <span class="hljs-keyword">if</span> (fval != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">this</span>.f[i](<span class="hljs-keyword">this</span>.fval[i]);<font></font>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.fupCall[i] == <span class="hljs-literal">true</span>) {
                    <span class="hljs-keyword">this</span>.fupCall[i] = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">this</span>.fup[i](<span class="hljs-keyword">this</span>.fval[i]);<font></font>
                };<font></font>
            };<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">return</span> pressed;<font></font>
    }<font></font>
<font></font>
}, <span class="hljs-comment">//gamepad</span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、ゲームでのゲームパッドのサポートはまだ不完全です。最も単純なゲームパッドのサポートのみが実装されていますが、たとえばXBoxで使用されているものはありません。入手できたら、プログラムして作業します。そこでは、キャラクターの速度を調整することが可能になります。つまり、ステップからランまでの範囲の任意の速度で移動することが可能になります。これは、軸から分数パラメーターを取得することで実現されます。私のゲームパッドは整数-1と1のみを返します。さらに、私のゲームパッドには不快な十字があり、左または右を押すと、同時に下または上を押します。そのため、十字の上下を使わずに、ゲームパッドの右側にあるボタンを使って複製しました...ゲームのリリースまでに、ゲームパッドのプロファイルをいくつか作成する予定です。また、複数のゲームパッドを接続すると、これまでは後者のみが使用されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">応答画面</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームは16：9のアスペクト比で設計されています。</font><font style="vertical-align: inherit;">しかし、±10％の自動水平調整を追加して、拡張されたブラウザーウィンドウの両側にそのような黒いバーが表示されないようにしました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ey/bn/a5/eybna55ofeptyziaakgix67heea.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてそれは次のようになります：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vm/0n/aa/vm0naaertcqacqufxjadz-sdfyu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全画面モードでは、実際の16：9になります。画像をブラウザウィンドウの任意の比率に一般的に適合させることは可能ですが、ウィンドウ幅が狭いと視野角が大きくなりすぎ、ゲームプレイの観点からは好ましくないため、これを実行しませんでした。行き止まり、オブジェクト、敵がすぐに表示されます。プレイヤーがまだ見る必要のない他のすべてのもの。そのため、16：9の±10％以内で調整することに制限を設けました。ただし、幅の狭いモニター（4：3）の場合は、Yキーを押すことで16：9から適応モードに4：3から16：9に切り替えることができることに気付きました。しかし、広くはありません-繰り返しますが、ゲームプレイを中断しないようにしてください。つまり、従来の16：9の比率で再生したり、画像を水平方向にトリミングしてウィンドウの高さに拡大したりできます。これは、たとえばアーケードの状況で、横からプレイヤーに向かって何かが飛ぶ場合など、あまり良くありません。反応のための時間はほとんどありません。ただし、いつでもクラシックモードにすばやく戻すことができます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/re/bp/ci/rebpciy7i7vmap1bwt_ijmub2fk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画面の調整と、ゲームで使用されるすべてのホットキーを次のビデオに示します。</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/FamXdunFFHY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、アスペクト比はゲームの設定で設定されます。</font></font><br>
<br>
<pre><code class="javascript hljs">aspect1:{<span class="hljs-attr">w</span>:<span class="hljs-number">1280</span>, <span class="hljs-attr">h</span>:<span class="hljs-number">720</span>, <span class="hljs-attr">p</span>:<span class="hljs-number">10</span>}, <span class="hljs-comment">//16x9 +- 10%</span>
<span class="hljs-attr">aspect2</span>:{<span class="hljs-attr">w</span>:<span class="hljs-number">960</span>, <span class="hljs-attr">h</span>:<span class="hljs-number">720</span>, <span class="hljs-attr">p</span>:<span class="hljs-number">34</span>}, <span class="hljs-comment">//4x3 +- 34%</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてゲームでは、Yを押すと次のように切り替わります。</font></font><br>
<br>
<pre><code class="javascript hljs">contr.btCodesDn[<span class="hljs-number">89</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">//'y'</span>
    <span class="hljs-keyword">if</span> (m3dcache.setup.aspect.swch == <span class="hljs-number">1</span>) {<font></font>
        m3dcache.setup.aspect = m3dcache.setup.aspect2;<font></font>
        m3dcache.setup.aspect.swch = <span class="hljs-number">2</span>;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        m3dcache.setup.aspect = m3dcache.setup.aspect1;<font></font>
        m3dcache.setup.aspect.swch = <span class="hljs-number">1</span>;<font></font>
    };<font></font>
    m3d.core.onWindowResize(<span class="hljs-number">0</span>);<font></font>
    m3d.contr.renderAll();<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のライブラリには、サイズ変更ウィンドウでハングするイベントがあります。</font><font style="vertical-align: inherit;">以下はその断片です：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">m3dcache.v.vw = <span class="hljs-built_in">window</span>.innerWidth;<font></font>
m3dcache.v.vh = <span class="hljs-built_in">window</span>.innerHeight;<font></font>
m3dcache.v.vclipw = <span class="hljs-number">0</span>;<font></font>
m3dcache.v.vcliph = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> m3dcache.setup.aspect !== <span class="hljs-string">"undefined"</span>) {
    <span class="hljs-keyword">if</span> ((m3dcache.setup.aspect.w == <span class="hljs-number">0</span>) || (m3dcache.setup.aspect.h == <span class="hljs-number">0</span>)) {} <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> o = m3d.lib.inBlock(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, m3dcache.setup.aspect.w, m3dcache.setup.aspect.h, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, m3dcache.v.vw, m3dcache.v.vh, <span class="hljs-string">'center'</span>, <span class="hljs-string">'center'</span>, <span class="hljs-string">'resize'</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> m3dcache.setup.aspect.p !== <span class="hljs-string">"undefined"</span>) {
            <span class="hljs-keyword">if</span> (o.clipx &gt; <span class="hljs-number">0</span>) {<font></font>
                o.w = o.w * (m3dcache.setup.aspect.p / <span class="hljs-number">100</span> + <span class="hljs-number">1</span>);
                <span class="hljs-keyword">if</span> (o.w &gt; m3dcache.v.vw) {<font></font>
                    o.w = m3dcache.v.vw;<font></font>
                };<font></font>
                o = m3d.lib.inBlock(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, o.w, o.h, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, m3dcache.v.vw, m3dcache.v.vh, <span class="hljs-string">'center'</span>, <span class="hljs-string">'center'</span>, <span class="hljs-string">'resize'</span>);<font></font>
            };<font></font>
        };<font></font>
<font></font>
        m3dcache.v.vclipw = o.clipx;<font></font>
        m3dcache.v.vcliph = o.clipy;<font></font>
<font></font>
        <span class="hljs-keyword">var</span> margx = o.clipx + <span class="hljs-string">'px'</span>,<font></font>
            margy = o.clipy + <span class="hljs-string">'px'</span>;
        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'m3dcontainer'</span>).style.marginLeft = margx;
        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'m3dcontainer'</span>).style.marginTop = margy;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'renderer'</span>) !== <span class="hljs-literal">null</span>) {
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'renderer'</span>).style.marginLeft = margx;
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'renderer'</span>).style.marginTop = margy;<font></font>
        };<font></font>
<font></font>
        m3dcache.v.vw = o.w;<font></font>
        m3dcache.v.vh = o.h;<font></font>
    };<font></font>
};</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
m3d.lib.inBlockも私のライブラリの機能です。これは、四角形をセンタリング、スケーリング、クロッピングなどのパラメーターで別の四角形に内接し、内接した四角形の新しい寸法と、このプロセスで形成されるフィールドのサイズを表示します。</font><font style="vertical-align: inherit;">この情報に基づいて、ウィンドウのdivコンテナーが配置されます。</font><font style="vertical-align: inherit;">「レンダラー」は、3Dシーンのブロックコンテキスト要素です。</font><font style="vertical-align: inherit;">さらに、取得されたパラメータに従ってキャンバスがそこでスケーリングされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UIは、別のキャンバス要素のコンテナーに表示されます。一般に、ドキュメントツリーは、絶対配置の3つの透明なDIVブロックで構成されます（ゲームのニーズに応じて、多かれ少なかれ可能です）。下部は3Dシーンのキャンバス、上部はIUのキャンバス、上部はインターフェイス要素やその他の視覚効果のアニメーション化に使用されます。つまり、UIは3Dではレンダリングされず、そのナバスまたはレイヤー上にレンダリングされます。レイヤーを1つの画像に組み合わせる作業は、ブラウザに任されています。 UIを操作するために、ライブラリーに特別なオブジェクトがあります。簡単に言えば、本質は次のとおりです。透明なpng形式のUI要素を含むスプライトリストが読み込まれます。そこから、必要な要素が取られます-背景、ボタン。そして、それらはjs drawImage関数（img、ix、iy、iw、ih、x、y、w、h）を使用して中央のキャンバスに描画されます。つまり、画像の必要な断片が画面上の目的の位置に表示されます。ボタンは、接続されている背景の上に表示されます。ボタンの位置とサイズはすべて、UI構成で設定されます。ウィンドウのサイズを変更すると、ターゲットキャンバス（要素が表示されている）上の要素の位置が再計算されます。これは、この要素またはその要素が水平および垂直の中央に配置されているか、画面の隅または面にスナップされているかによって異なります。これにより、画面のアスペクト比に依存しないアダプティブUIが作成されます。要素が互いにオーバーラップしないように、可能な限り最小の解像度を水平および垂直に設定し、それを下回らないようにする必要があります。記事が膨大であることが判明したため、UIについては別の機会に説明します。必要な機能がまだ多く残っているため、UIの作業を続けています。例えば、高解像度モニターでは、インターフェースは小さく見えます。画面解像度に応じて、要素のサイズに特定の係数を掛けることができます。一方、画面上の大きなボタンは必要ないのでしょうか？画面の解像度が大きい場合、画面自体は非常に大きくなります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kg/id/am/kgidamgcsszbyxejvyyar7bgave.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、プログラマに選択肢を与えることができます-ウィンドウのサイズに合わせてIUを動的にスケーリングするか、要素を隅に配置するか。動的なサイズの場合、それ自体の質問もあります。たとえば、大きすぎるスケールで表示されたときのインターフェースの「石鹸」などです。意図的に巨大な解像度でインターフェース要素のスプライトを作成すると、それらは多くのスペースを占有し、おそらく小さなデバイスには役立ちません-大きなスプライトは必要ありませんが、メモリを消費します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日はこれで十分だと思います。</font><font style="vertical-align: inherit;">まだ検討すべきことがあり、これをどのように実装するか。</font><font style="vertical-align: inherit;">その間、私はしばらくプログラミングから抜け出し、プロモーションを行います。</font><font style="vertical-align: inherit;">私は2つのインディーショーケースに参加する予定で、ソーシャルネットワークでのゲームの宣伝に積極的に取り組んでいます。11月にクラウドファンディングプラットフォームに行く予定です。ゲームを完了するには、3Dグラフィックスと骨格アニメーションの分野の専門家が必要になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の記事では、モバイルデバイスのブラウザーでのタッチコントロールについて説明します。誰もがゲームパッドやキーボードをタブレットに接続しているわけではなく、低電力デバイス用の3Dグラフィックスの最適化などについて説明しています。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472258/index.html">「学ぶことを学ぶ」方法-マインドフルネスを改善する</a></li>
<li><a href="../ja472262/index.html">モバイル＃318開発者向けの興味深い資料のダイジェスト（10月14〜20日）</a></li>
<li><a href="../ja472264/index.html">デジタル考古学と仮想現実、またはBIMとVRで友達を作ろうとした方法</a></li>
<li><a href="../ja472268/index.html">ChromiumでのMicrosoft Edgeコントロールの改善</a></li>
<li><a href="../ja472270/index.html">「現在の祈りにアクセスできません」：バチカンのハイテクビーズが15分でハッキングされました</a></li>
<li><a href="../ja472274/index.html">リモートSSH：ヒントとハック</a></li>
<li><a href="../ja472278/index.html">私のお気に入りのgit commit</a></li>
<li><a href="../ja472280/index.html">静脈スキャナーで手のひらの存在を判断するタスク</a></li>
<li><a href="../ja472288/index.html">開発者向けの9つの便利なブラウザー拡張機能（2020のリスト）</a></li>
<li><a href="../ja472290/index.html">構造体とクラス</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>