<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💇🏿 🤱🏻 🤱🏽 Zabbix Agent 2のプラグイン開発 🦍 💇🏽 🅾️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前回のZabbix Summit 2019で、Zabbix 4.4のリリースとともに、新しいZabbix Agent 2が発表されました。その主な機能は、Go言語でプラグインを作成できることです。そして多くの人がすぐに尋ね始めました：しかし、実際には、これらのプラグインはどのように記述し、どのように...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Zabbix Agent 2のプラグイン開発</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/zabbix/blog/489244/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回のZabbix Summit 2019で、Zabbix 4.4のリリースとともに、新しいZabbix Agent 2が発表されました。その主な機能は、Go言語でプラグインを作成できることです。</font><font style="vertical-align: inherit;">そして多くの人がすぐに尋ね始めました：しかし、実際には、これらのプラグインはどのように記述し、どのように配置されていますか？</font><font style="vertical-align: inherit;">ドキュメントとサンプルはどこで入手できますか？</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、これらの質問と他のいくつかの質問に答えたいと思います。</font><font style="vertical-align: inherit;">すべてが</font><font style="vertical-align: inherit;">順調</font><font style="vertical-align: inherit;">ですが、あなたがすぐに戦闘に突入する人の1人である場合は、紹介部分をスキップして、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">練習に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">進んでください⎝◔◞◔⎠</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そう...</font></font></p><br>
<p><img src="https://habrastorage.org/webt/ta/ur/3h/taur3hmj5wglxy31l6rfvwr4hd0.png"></p><a name="habracut"></a><br>
<h1 id="chto-za-novyy-agent-i-zachem-on-poyavilsya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのような新しいエージェント、そしてなぜ彼は現れたのですか？</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のZabbixエージェント用のプラグインを作成しようとした場合、または少なくともそれを意図した場合は、オプションが非常に制限されていることにおそらく気づきました。 </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のエージェントのプラグインは、いくつかの異なるプロセスで実行でき、作成者に、たとえば永続的な接続の使用、チェック間の状態の維持、トラップの受信を実装するための十分な制御を与えず、そのようなことを行うのは困難または不可能でした。</font></font></p><br>
<p>     .       Go (      Zabbix Agent),             .   Go- —       —         .   , Go-     Zabbix Agent   ,   .</p><br>
<p> ,   Go-:</p><br>
<ul>
<li>     onfig   ;</li>
<li>   "out-of-the-box";</li>
<li>       ;</li>
<li>   Windows ;</li>
<li>      .<br>
     Zabbix 4.4    ,    Zabbix 5.0    "production-ready".</li>
</ul><br>
<h1 id="arhitektura-agenta"> </h1><br>
<p>    ,     ,     " ".  ,     Zabbix 4.4. ,  Go-     ,  ,    Zabbix 5.0 -  . </p><br>
<p>   —  ServerConnector, ServerListener  Scheduler. </p><br>
<p><strong>ServerConnector</strong>     ( / ),  items    .       .</p><br>
<p><strong>ServerListener</strong>        Scheduler.      ,       .</p><br>
<p><strong>Scheduler</strong>          .    Scheduler    ()    ,   item'.</p><br>
<p>          :    (   Bulk Passive,    ).   ,      ,         .</p><br>
<p>       .      —   PlantUML ¯\<em>(ツ)</em>/¯</p><br>
<h3 id="aktivnye-proverki"> </h3><br>
<p><img src="https://habrastorage.org/webt/lx/nj/wl/lxnjwl-_ixow4oz8wbjtk_eakoe.png"><br>
     : ServerConnector  ResultCache,       . </p><br>
<h3 id="passivnye-proverki"> </h3><br>
<p><img src="https://habrastorage.org/webt/ob/dz/j7/obdzj7sshh63k1oz0gon85b_r0k.png"><br>
     Scheduler   ,   ServerConnector'  ServerListener     item'.   ,     ResultWriter,        .</p><br>
<h2 id="obrabotka-konfiguracii"> </h2><br>
<p>  items  Zabbix , ServerConnector       updateRequest   ,   .     ,        .  ,      ,        .</p><br>
<h2 id="planirovschik-i-zadachi">  </h2><br>
<p>        :</p><br>
<ul>
<li>     ;</li>
<li>     .<br>
     .       -  ,      (      )     ,      .</li>
</ul><br>
<p>        :</p><br>
<ol>
<li>configuratorTask</li>
<li>starterTask</li>
<li>collectorTask</li>
<li>watcherTask</li>
<li>exporterTask (directExporterTask)</li>
<li>stopperTask<br>
  (taskBase)    ,       ,      .</li>
</ol><br>
<p><strong>exporterTask</strong><br>
ExporterTask     ( bulk    ).    item,    . Scheduler   Export  Exporter          ResultWriter. </p><br>
<p><strong>directExporterTask</strong><br>
directExporterTask        ExporterTask , ,       ( ),     ,   1      .           .    — directExporterTask     . </p><br>
<p><strong>watcherTask</strong><br>
WatcherTask    ()  .    Watch  Watcher,      .</p><br>
<p><strong>collectorTask</strong><br>
Scheduler   Collect  Collector  Period() .</p><br>
<p><strong>starterTask</strong><br>
   Start  Runner,   .</p><br>
<p><strong>stopperTask</strong><br>
   Stop  Runner,   .</p><br>
<p><strong>configuratorTask</strong><br>
   Configure  Configurator,              ,    .</p><br>
<h2 id="interfeysy"></h2><br>
<p>  5 : Exporter, Watcher, Collector, Runner  Configurator.<br>
Exporter  Watcher     : Exporter  pull ,  Watcher — push.</p><br>
<h3 id="pluginexporter">plugin.Exporter</h3><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Exporter <span class="hljs-keyword">interface</span> {<font></font>
    Export(key <span class="hljs-keyword">string</span>, params []<span class="hljs-keyword">string</span>, context ContextProvider) (result <span class="hljs-keyword">interface</span>{}, err error)<font></font>
}</code></pre><br>
<p>Exporter —   ,      ,  ,      .    ,    .     . ,    ,   .      ,         ,    - . </p><br>
<p> ,        .             .          Go: , ,  , sync.Map    .    race-,     .</p><br>
<p>       Export() —  100   .           ,   plugin.Base.SetCapacity.</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Base)</span> <span class="hljs-title">SetCapacity</span><span class="hljs-params">(capacity <span class="hljs-keyword">int</span>)</span></span></code></pre><br>
<p> , capacity         . :<br>
Plugins.&lt;PluginName&gt;.Capacity=1</p><br>
<h3 id="pluginwatcher">plugin.Watcher</h3><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Watcher <span class="hljs-keyword">interface</span> {<font></font>
    Watch(requests []*Request, context ContextProvider)<font></font>
}</code></pre><br>
<p>Watcher       ,     .      ,   trapping,         .  use case   —  , ,    ,    . , ,      ,         ,    . </p><br>
<h3 id="plugincollector">plugin.Collector</h3><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Collector <span class="hljs-keyword">interface</span> {<font></font>
    Collect() error<font></font>
    Period() <span class="hljs-keyword">int</span>
}</code></pre><br>
<p>Collector   ,         .      ,          Exporter’.</p><br>
<p> use case  Collector —        ,      ,     Zabbix . </p><br>
<p> Collector’  2 : </p><br>
<ul>
<li>Collect    ;</li>
<li>Period    .<br>
Collector,  ,           .</li>
</ul><br>
<h3 id="pluginrunner">plugin.Runner</h3><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Runner <span class="hljs-keyword">interface</span> {<font></font>
    Start()<font></font>
    Stop()<font></font>
}</code></pre><br>
<p>Runner     ,    ( Start),  ,       ( Stop).<br>
  ,  ,  ,    -  ,   ,    ..</p><br>
<p>            ()  .    ,      (Zabbix Server  Proxy),    .     ,     ,  .  ,         .    ,    ,     ,    24     .</p><br>
<h3 id="pluginconfigurator">plugin.Configurator</h3><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Configurator <span class="hljs-keyword">interface</span> {<font></font>
    Configure(globalOptions *GlobalOptions, privateOptions <span class="hljs-keyword">interface</span>{})<font></font>
    Validate(privateOptions <span class="hljs-keyword">interface</span>{}) error<font></font>
}</code></pre><br>
<p> Configurator ,     .<br>
  2 :</p><br>
<ul>
<li>Configure       . </li>
<li>Validate  config   .    ,    ,       . </li>
</ul><br>
<p> ,     ,         .      .</p><br>
<p>  Go-      Zabbix    .</p><br>
<h3 id="tipy-plaginov"> </h3><br>
<p>    . ,      — , ,  .     internal/agent    "plugin_"  .  ,   ,     UserParameters.</p><br>
<p> ,  ,     (  , , ,   ..) —   .             .      go/plugins,    .</p><br>
<h1 id="hello-world">Hello, world!</h1><br>
<p> —    Go,       ,    .   :</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> packageName<font></font>
<font></font>
<span class="hljs-keyword">import</span> <span class="hljs-string">"zabbix.com/pkg/plugin"</span><font></font>
<font></font>
<span class="hljs-keyword">type</span> Plugin <span class="hljs-keyword">struct</span> {<font></font>
    plugin.Base<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> impl Plugin<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Export</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, params []<span class="hljs-keyword">string</span>, ctx plugin.ContextProvider)</span> <span class="hljs-params">(res <span class="hljs-keyword">interface</span>{}, err error)</span></span> {
    <span class="hljs-comment">// Write your code here</span>
    <span class="hljs-keyword">return</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {<font></font>
    plugin.RegisterMetrics(&amp;impl, <span class="hljs-string">"PluginName"</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"Description."</span>)<font></font>
}</code></pre><br>
<p>  ,    bash  python, ? ⎝^ω^⎠      ,    -  .</p><br>
<p>      ,     ,        .</p><br>
<p>     :<br>
     Zabbix.</p><br>
<pre><code class="bash hljs">$ git <span class="hljs-built_in">clone</span> https://git.zabbix.com/scm/zbx/zabbix.git --depth 1 zabbix-agent2<font></font>
$ <span class="hljs-built_in">cd</span> zabbix-agent2
<span class="hljs-comment">#     master ,            </span>
$ git checkout -b feature/myplugin release/4.4</code></pre><br>
<p>  src/go/plugins/weather    weather.go  ,     .</p><br>
<p>,    "zabbix.com/pkg/plugin".</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> weather
<span class="hljs-keyword">import</span>  <span class="hljs-string">"zabbix.com/pkg/plugin"</span></code></pre><br>
<p>  ,     Base   plugin.     .</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Plugin <span class="hljs-keyword">struct</span> {<font></font>
    plugin.Base<font></font>
}<font></font>
<span class="hljs-keyword">var</span> impl Plugin</code></pre><br>
<p>       . ,    , : </p><br>
<ol>
<li> GET   API   (, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">wttr.in</a>)</li>
<li> </li>
<li> </li>
<li> .</li>
</ol><br>
<p>       Exporter.</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Export</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, params []<span class="hljs-keyword">string</span>, ctx plugin.ContextProvider)</span> <span class="hljs-params">(result <span class="hljs-keyword">interface</span>{}, err error)</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(params) != <span class="hljs-number">1</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"Wrong parameters."</span>)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// https://github.com/chubin/wttr.in</span>
    res, err := p.httpClient.Get(fmt.Sprintf(<span class="hljs-string">"https://wttr.in/~%s?format=%%t"</span>, params[<span class="hljs-number">0</span>]))
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
    }<font></font>
<font></font>
    temp, err := ioutil.ReadAll(res.Body)<font></font>
    _ = res.Body.Close()<font></font>
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">string</span>(temp)[<span class="hljs-number">0</span> : <span class="hljs-built_in">len</span>(temp)<span class="hljs-number">-4</span>], <span class="hljs-literal">nil</span>
}</code></pre><br>
<p>  —  ,            .</p><br>
<p>  plugin.RegisterMetrics.</p><br>
<pre><code class="go hljs"><span class="hljs-comment">// impl —    </span>
<span class="hljs-comment">// name —  </span>
<span class="hljs-comment">// params —       (key1, descr1, key2, descr2, keyN, descrN...)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterMetrics</span><span class="hljs-params">(impl Accessor, name <span class="hljs-keyword">string</span>, params ...<span class="hljs-keyword">string</span>)</span></span></code></pre><br>
<p>    init (     ).</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {<font></font>
  plugin.RegisterMetrics(&amp;impl, <span class="hljs-string">"Weather"</span>, <span class="hljs-string">"weather.temp"</span>, <span class="hljs-string">"Returns Celsius temperature."</span>)<font></font>
}</code></pre><br>
<p>          ,      .</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> plugins 
<span class="hljs-keyword">import</span> (<font></font>
  _ <span class="hljs-string">"zabbix.com/plugins/kernel"</span>
  _ <span class="hljs-string">"zabbix.com/plugins/log"</span>
<span class="hljs-comment">// ...</span>
  _ <span class="hljs-string">"zabbix.com/plugins/weather"</span>
)</code></pre><br>
<p>,     3 : linux, darwin  windows.  ,  , ,  .</p><br>
<p> :            ,         src/go/plugins/plugins_&lt;platform&gt;.go.</p><br>
<h1 id="sborka"></h1><br>
<p>      Go,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>.</p><br>
<p>   Go   1.13. </p><br>
<p>      ,     --enable-agent2      make.</p><br>
<pre><code class="bash hljs">$ <span class="hljs-built_in">cd</span> &lt;zabbix-source&gt;<font></font>
$ ./bootstrap.sh; ./configure --<span class="hljs-built_in">enable</span>-agent2 --<span class="hljs-built_in">enable</span>-static; make</code></pre><br>
<p>       ,    .          “moscow”   .</p><br>
<pre><code class="bash hljs">$ &lt;zabbix-source&gt;/src/go/bin/zabbix_agent2 -t weather.temp[moscow]<font></font>
+1</code></pre><br>
<p>     .    ,     go run,     .</p><br>
<pre><code class="bash hljs">$ go run &lt;zabbix-source&gt;/src/go/cmd/zabbix_agent2/zabbix_agent2.go</code></pre><br>
<h1 id="logirovanie"></h1><br>
<p>   ,      zabbix.com/pkg/log: Tracef, Debugf, Warningf, Infof, Errf, Critf.       Plugin,       log.    ,     [&lt;PluginName&gt;]  .</p><br>
<h1 id="konfiguraciya-plagina"> </h1><br>
<p>Go-        .      Plugins.  ,      -,     ,   ,          .      : Plugins.&lt;PluginName&gt;.&lt;Parameter&gt;=&lt;Value&gt;.  :</p><br>
<ol>
<li>,       ;</li>
<li>     ;</li>
<li>     ;</li>
<li>   ;</li>
<li>     .</li>
</ol><br>
<p>     ,   Configurator.         Timeout,       HTTP .</p><br>
<p>,  ,  Timeout     1  30 ,      (  )     .</p><br>
<p> ,   .</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> PluginOptions <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// Timeout is the maximum time for waiting when a request has to be done. Default value equals the global timeout.</span>
    Timeout <span class="hljs-keyword">int</span> <span class="hljs-string">`conf:"optional,range=1:30"`</span>
}</code></pre><br>
<p>   ,              conf.        .</p><br>
<p>   : [name=&lt;name&gt;,][optional,][range=&lt;range&gt;,][default=&lt;default value&gt;], :</p><br>
<ul>
<li>&lt;name&gt; —   (         );</li>
<li>optional — ,     ;</li>
<li>&lt;range&gt; —   &lt;min&gt;:&lt;max&gt;,   &lt;min&gt;  &lt;max&gt; ;</li>
<li>&lt;default value&gt; —    .     .</li>
</ul><br>
<p>   Plugin       ,   — http.Client,      .</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Plugin <span class="hljs-keyword">struct</span> {<font></font>
    plugin.Base<font></font>
    options PluginOptions<font></font>
    httpClient http.Client<font></font>
}</code></pre><br>
<p>  Configurator.   ,   2 : Configure  Validate.</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Configure</span><span class="hljs-params">(global *plugin.GlobalOptions, privateOptions <span class="hljs-keyword">interface</span>{})</span></span> {
    <span class="hljs-keyword">if</span> err := conf.Unmarshal(privateOptions, &amp;p.options); err != <span class="hljs-literal">nil</span> {<font></font>
        p.Errf(<span class="hljs-string">"cannot unmarshal configuration options: %s"</span>, err)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// Set default value</span>
    <span class="hljs-keyword">if</span> p.options.Timeout == <span class="hljs-number">0</span> {<font></font>
        p.options.Timeout = global.Timeout<font></font>
    }<font></font>
<font></font>
    p.httpClient = http.Client{Timeout: time.Duration(p.options.Timeout) * time.Second}<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Validate</span><span class="hljs-params">(privateOptions <span class="hljs-keyword">interface</span>{})</span> <span class="hljs-title">error</span></span> {
    <span class="hljs-comment">// Nothing to validate</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}</code></pre><br>
<p>  conf.Unmarshal       .<br>
  http.Get  p.httpClient.Get.</p><br>
<pre><code class="go hljs">res, err := p.httpClient.Get(fmt.Sprintf(<span class="hljs-string">"https://wttr.in/~%s?format=%%t"</span>, params[<span class="hljs-number">0</span>]))
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">if</span> err.(*url.Error).Timeout() {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"Request timeout."</span>)<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
}</code></pre><br>
<p>,         :<br>
Plugins.Weather.Timeout=1</p><br>
<p>    ,    .</p><br>
<p> ,    -     ?    —       . Timeout    default, ..    .</p><br>
<p>           (   ,     Validate  Configure).</p><br>
<p>    ,   . ,   ,    ,  ,   .      Validate.        ,   .</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Validate</span><span class="hljs-params">(privateOptions <span class="hljs-keyword">interface</span>{})</span> <span class="hljs-title">error</span></span> {
    <span class="hljs-keyword">var</span> opts PluginOptions
    <span class="hljs-keyword">return</span> conf.Unmarshal(privateOptions, &amp;opts)<font></font>
}</code></pre><br>
<p>      ,       ,  : "cannot create scheduling manager: invalid plugin Weather configuration: Cannot assign configuration: invalid parameter Plugins.Weather.Timeout at line 411: value out of range".</p><br>
<p>         " ".    runtime     Validate  Configure,            .  ,    -    Configure —     ,            . ,         Start  Stop ( Runner).</p><br>
<p>      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/VadimIpatov/zabbix-weather-plugin.</a></p><br>
<h1 id="primer-poslozhney"> </h1><br>
<p>    Exporter .    .     ,   Collector  Runner.</p><br>
<p>  !  - .    ,     HTTP        .</p><br>
<p>     .     "net/http/httptrace" (   Go 1.7).</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> timeSample <span class="hljs-keyword">struct</span> {<font></font>
    DnsLookup         <span class="hljs-keyword">float64</span> <span class="hljs-string">`json:"dnsLookup"`</span>
    Connect           <span class="hljs-keyword">float64</span> <span class="hljs-string">`json:"connect"`</span>
    TlsHandshake      <span class="hljs-keyword">float64</span> <span class="hljs-string">`json:"tlsHandshake"`</span>
    FirstResponseByte <span class="hljs-keyword">float64</span> <span class="hljs-string">`json:"firstResponseByte"`</span>
    Rtt               <span class="hljs-keyword">float64</span> <span class="hljs-string">`json:"rtt"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">measureTime</span><span class="hljs-params">(url <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(timeSample, error)</span></span> {
    <span class="hljs-keyword">var</span> (<font></font>
        sample                            timeSample<font></font>
        start, connect, dns, tlsHandshake time.Time<font></font>
    )<font></font>
<font></font>
    req, _ := http.NewRequest(<span class="hljs-string">"GET"</span>, url, <span class="hljs-literal">nil</span>)<font></font>
<font></font>
    trace := &amp;httptrace.ClientTrace{<font></font>
        DNSStart: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ httptrace.DNSStartInfo)</span></span> {<font></font>
            dns = time.Now()<font></font>
        },<font></font>
        DNSDone: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ httptrace.DNSDoneInfo)</span></span> {<font></font>
            sample.DnsLookup = <span class="hljs-keyword">float64</span>(time.Since(dns) / time.Millisecond)<font></font>
        },<font></font>
<font></font>
        ConnectStart: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_, _ <span class="hljs-keyword">string</span>)</span></span> {<font></font>
            connect = time.Now()<font></font>
        },<font></font>
        ConnectDone: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(net, addr <span class="hljs-keyword">string</span>, err error)</span></span> {
            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
                p.Errf(<span class="hljs-string">"unable to connect to host %s: %s"</span>, addr, err.Error())<font></font>
            }<font></font>
            sample.Connect = <span class="hljs-keyword">float64</span>(time.Since(connect) / time.Millisecond)<font></font>
        },<font></font>
<font></font>
        GotFirstResponseByte: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {<font></font>
            sample.FirstResponseByte = <span class="hljs-keyword">float64</span>(time.Since(start) / time.Millisecond)<font></font>
        },<font></font>
<font></font>
        TLSHandshakeStart: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {<font></font>
            tlsHandshake = time.Now()<font></font>
        },<font></font>
        TLSHandshakeDone: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ tls.ConnectionState, _ error)</span></span> {<font></font>
            sample.TlsHandshake = <span class="hljs-keyword">float64</span>(time.Since(tlsHandshake) / time.Millisecond)<font></font>
        },<font></font>
    }<font></font>
<font></font>
    ctx, cancel := context.WithTimeout(req.Context(), time.Duration(p.options.Timeout)*time.Second)<font></font>
    <span class="hljs-keyword">defer</span> cancel()<font></font>
    req = req.WithContext(httptrace.WithClientTrace(ctx, trace))<font></font>
<font></font>
    start = time.Now()<font></font>
    <span class="hljs-keyword">if</span> _, err := http.DefaultTransport.RoundTrip(req); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> timeSample{}, err<font></font>
    }<font></font>
    sample.Rtt = <span class="hljs-keyword">float64</span>(time.Since(start) / time.Millisecond)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> sample, <span class="hljs-literal">nil</span>
}</code></pre><br>
<p>     -   .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  (Ring Buffer).</a>     ,    — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github.com/VadimIpatov/gcircularqueue.</a>      ,      .       Open Source    Go —     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">github.com/montanaflynn/stats.</a>        .</p><br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Plugin <span class="hljs-keyword">struct</span> {<font></font>
    plugin.Base<font></font>
    urls <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*urlUnit<font></font>
    sync.Mutex<font></font>
    options Options<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> urlUnit <span class="hljs-keyword">struct</span> {<font></font>
    url      <span class="hljs-keyword">string</span><font></font>
    history  *gcircularqueue.CircularQueue<font></font>
    accessed time.Time <span class="hljs-comment">// last access time</span>
    modified time.Time <span class="hljs-comment">// data collect time</span>
}</code></pre><br>
<p>       Start  Stop  Runner.</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Start</span><span class="hljs-params">()</span></span> {<font></font>
    p.urls = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]*urlUnit)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Stop</span><span class="hljs-params">()</span></span> {<font></font>
    p.urls = <span class="hljs-literal">nil</span>
}</code></pre><br>
<p>      Collector.</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Collect</span><span class="hljs-params">()</span> <span class="hljs-params">(err error)</span></span> {<font></font>
    now := time.Now()<font></font>
    p.Lock()<font></font>
    <span class="hljs-keyword">for</span> key, url := <span class="hljs-keyword">range</span> p.urls {
        <span class="hljs-keyword">if</span> now.Sub(url.accessed) &gt; maxInactivityPeriod {<font></font>
            p.Debugf(<span class="hljs-string">"removed expired url %s"</span>, url.url)
            <span class="hljs-built_in">delete</span>(p.urls, key)
            <span class="hljs-keyword">continue</span><font></font>
        }<font></font>
        res, err := p.measureTime(url.url)<font></font>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
            p.Errf(err.Error())<font></font>
            <span class="hljs-keyword">continue</span><font></font>
        }<font></font>
        url.history.Push(res)<font></font>
        <span class="hljs-keyword">if</span> url.history.IsFull() {<font></font>
            _ = url.history.Shift()<font></font>
        }<font></font>
        url.modified = now<font></font>
    }<font></font>
    p.Unlock()<font></font>
<font></font>
    <span class="hljs-keyword">return</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Period</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> {
    <span class="hljs-keyword">return</span> p.options.Interval<font></font>
}</code></pre><br>
<p>       URL (    ),       p.measureTime(url.url)     .       ,      url.modified.</p><br>
<p>     URL  ,      .</p><br>
<p>  , Collector    .   Exporter.</p><br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Plugin)</span> <span class="hljs-title">Export</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, params []<span class="hljs-keyword">string</span>, ctx plugin.ContextProvider)</span> <span class="hljs-params">(result <span class="hljs-keyword">interface</span>{}, err error)</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(params) != <span class="hljs-number">1</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"Wrong parameters."</span>)<font></font>
    }<font></font>
<font></font>
    url, err := parseURL(params[<span class="hljs-number">0</span>])
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">switch</span> key {
    <span class="hljs-keyword">case</span> keyHttpTraceStats:
        <span class="hljs-keyword">if</span> _, ok := p.urls[url]; !ok {<font></font>
            p.urls[url] = &amp;urlUnit{<font></font>
                url:     url,<font></font>
                history: gcircularqueue.NewCircularQueue(maxHistory),<font></font>
            }<font></font>
        }<font></font>
        p.Lock()<font></font>
        <span class="hljs-keyword">defer</span> p.Unlock()<font></font>
        p.urls[url].accessed = time.Now()<font></font>
        <span class="hljs-keyword">if</span> p.urls[url].history.Len() &lt; minStatRange {
            <span class="hljs-comment">// no data gathered yet</span>
            <span class="hljs-keyword">return</span><font></font>
        }<font></font>
<font></font>
        data := prepareData(p.urls[url].history.Elements())<font></font>
<font></font>
        jsonRes, err := json.Marshal(stat{<font></font>
            <span class="hljs-comment">// Median: timeSample{...},</span>
            <span class="hljs-comment">// P75:    timeSample{...},</span>
            <span class="hljs-comment">// P95:    timeSample{...},</span><font></font>
            P99: timeSample{<font></font>
                DnsLookup:         percentile(data[metricDnsLookup], p99),<font></font>
                Connect:           percentile(data[metricConnect], p99),<font></font>
                TlsHandshake:      percentile(data[metricTlsHandshake], p99),<font></font>
                FirstResponseByte: percentile(data[metricFirstResponseByte], p99),<font></font>
                Rtt:               percentile(data[metricRtt], p99),<font></font>
            },<font></font>
        })<font></font>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
            p.Errf(err.Error())<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"Cannot marshal JSON."</span>)<font></font>
        }<font></font>
<font></font>
        value := <span class="hljs-keyword">string</span>(jsonRes)
        <span class="hljs-keyword">return</span> plugin.Result{<font></font>
            Value: &amp;value,<font></font>
            Ts:    p.urls[url].modified,<font></font>
        }, <span class="hljs-literal">nil</span><font></font>
<font></font>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, plugin.UnsupportedMetricError<font></font>
    }<font></font>
}</code></pre><br>
<p> ,       Collect  Export, ..    .<br>
   (   ):</p><br>
<pre><code class="bash hljs">$ zabbix_get -s zabbix.local -k <span class="hljs-string">"httptrace.stats[yoursite.com]"</span><font></font>
{<font></font>
    <span class="hljs-string">"median"</span>: {
        <span class="hljs-string">"dnsLookup"</span>: 13,
        <span class="hljs-string">"connect"</span>: 28,
        <span class="hljs-string">"tlsHandshake"</span>: 56,
        <span class="hljs-string">"firstResponseByte"</span>: 126.5,
        <span class="hljs-string">"rtt"</span>: 126.5<font></font>
    },<font></font>
    <span class="hljs-string">"p75"</span>: {
        <span class="hljs-string">"dnsLookup"</span>: 20,
        <span class="hljs-string">"connect"</span>: 31,
        <span class="hljs-string">"tlsHandshake"</span>: 60,
        <span class="hljs-string">"firstResponseByte"</span>: 138.5,
        <span class="hljs-string">"rtt"</span>: 138.5<font></font>
    },<font></font>
    <span class="hljs-string">"p95"</span>: {
        <span class="hljs-string">"dnsLookup"</span>: 22.5,
        <span class="hljs-string">"connect"</span>: 35,
        <span class="hljs-string">"tlsHandshake"</span>: 78.5,
        <span class="hljs-string">"firstResponseByte"</span>: 159.5,
        <span class="hljs-string">"rtt"</span>: 159.5<font></font>
    },<font></font>
    <span class="hljs-string">"p99"</span>: {
        <span class="hljs-string">"dnsLookup"</span>: 50,
        <span class="hljs-string">"connect"</span>: 51.5,
        <span class="hljs-string">"tlsHandshake"</span>: 125.5,
        <span class="hljs-string">"firstResponseByte"</span>: 266.5,
        <span class="hljs-string">"rtt"</span>: 266.5<font></font>
    }<font></font>
}</code></pre><br>
<p>      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://github.com/VadimIpatov/zabbix-">https://github.com/VadimIpatov/zabbix-httptrace-plugin.</a></p><br>
<h1 id="monitoring-monitoringa"> </h1><br>
<p>   runtime  metrics,          .     .<br>
   :</p><br>
<pre><code class="bash hljs">$ zabbix_agent2 -R metrics<font></font>
...<font></font>
[Weather]<font></font>
active: <span class="hljs-literal">true</span><font></font>
capacity: 0/100<font></font>
tasks: 0<font></font>
weather.temp: Returns Celsius temperature.<font></font>
...</code></pre><br>
<p>       —  HTTP.         StatusPort=,        http://&lt;ZabbixAgentHost&gt;:&lt;Port&gt;/status.<br>
</p><p><img src="https://habrastorage.org/webt/a3/za/i6/a3zai6noy8eq0sxzfu-zmpduqce.png"></p><br>
<h1 id="chto-dalshe"> ?</h1><br>
<p>      .    ,     :</p><br>
<ul>
<li>       (        ).</li>
<li>   , ..   .</li>
<li>     Zabbix. ,      Docker’  Mysql.</li>
</ul><br>
<h1 id="mne-malo"> !</h1><br>
<p> ,      ,     :<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Templates guidelines</a> —            .<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">An official guide to making and managing great templates</a> —    Zabbix Summit    .<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Magic of the new zabbix agent</a> —  Zabbix Agent 2.<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   Zabbix Agent 2.</a><br>
        Zabbix Agent 2 (  : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">git.zabbix.com</a>).   ,    .<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   Weather.</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://github.com/VadimIpatov/zabbix-">   HttpTrace.</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Writing watcher Zabbix Agent2 MQTT plugin in Go</a> —    Watcher .<br>
        Go,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">"   Go"</a> , ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">A Tour of Go</a> ʕ☉Ѡ☉ʔ</p><br>
<h1 id="itog"></h1><br>
<p>Zabbix Agent 2 —      Zabbix   .     Go,                ,      ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">C Loadable modules.</a></p><br>
<h3 id="stay-tuned">Stay tuned!</h3><br>
<p>P.S.        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> .</a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja489232/index.html">携帯電話の未来に戻るII</a></li>
<li><a href="../ja489234/index.html">ペンテストに合格する方法（悪いアドバイス）</a></li>
<li><a href="../ja489236/index.html">春：コンテキストを探す</a></li>
<li><a href="../ja489240/index.html">地域会議の特徴。スピーカーがMKADを離れる必要があるのはなぜですか？</a></li>
<li><a href="../ja489242/index.html">「見て、これは何か」：人工DNAの自己複製</a></li>
<li><a href="../ja489246/index.html">私は14歳で、ゲームを開発することにしました</a></li>
<li><a href="../ja489252/index.html">テレグラムの歴史：アイデアから独自の暗号通貨まで</a></li>
<li><a href="../ja489254/index.html">Yandexはマルウェアの拡散に役立ちますか？</a></li>
<li><a href="../ja489256/index.html">Foundation Fieldbus Automation Systems</a></li>
<li><a href="../ja489258/index.html">Pythonで非常に長い整数型はどのように実装されていますか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>