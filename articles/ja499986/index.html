<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧖🏾 🙁 🤩 そして再び組み込みについて：Emboxプロジェクトのバグを探す 🚢 💨 ♠️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Emboxは、組み込みシステム向けのクロスプラットフォームのマルチタスクリアルタイムオペレーティングシステムです。少ないコンピューティングリソースで動作するように設計されており、Linuxを使用せずにマイクロコントローラーでLinuxベースのアプリケーションを実行できます。もちろん、他のアプリケーシ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>そして再び組み込みについて：Emboxプロジェクトのバグを探す</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/499986/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/20f/e3c/e6220fe3c8d556e40580a1cf49eab7cb.png" alt="図2"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Emboxは、組み込みシステム向けのクロスプラットフォームのマルチタスクリアルタイムオペレーティングシステムです。少ないコンピューティングリソースで動作するように設計されており、Linuxを使用せずにマイクロコントローラーでLinuxベースのアプリケーションを実行できます。もちろん、他のアプリケーションと同様に、Emboxのバグも回避されません。この記事では、Emboxプロジェクトのコードで見つかったエラーの分析について説明します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数か月前に、</font><font style="vertical-align: inherit;">組み込みシステム用のもう1つのOSであるFreeRTOSのチェック</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関する記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をすでに書い</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">て</font></a><font style="vertical-align: inherit;">い</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">そのときはエラーは見つかりませんでしたが、独自のバージョンのFreeRTOSを開発しているときに、Amazonのメンバーが追加したライブラリでエラーを見つけました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
目の前にある記事は、ある意味、前の記事のテーマを引き継いでいます。</font><font style="vertical-align: inherit;">FreeRTOSを確認するリクエストを頻繁に受け取り、それを確認しました。</font><font style="vertical-align: inherit;">今回は、特定のプロジェクトを確認するリクエストはありませんでしたが、それを気に入ってもっと欲しい組み込み開発者からの手紙やコメントを受け取り始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、PVS-Studio for Embeddedマガジンの新刊は成熟し、あなたの目の前にあります。</font><font style="vertical-align: inherit;">観るのを楽しむ！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析は、PVS-Studio-C、C ++、C＃、およびJava用の静的コードアナライザーを使用して実行されました。分析の前に、プロジェクトをアセンブルする必要があります。そのため、プロジェクトコードが機能していることを確認し、アナライザーに、コードの検証に役立つアセンブリ情報を収集する機会を提供します。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">公式の</font></a><font style="vertical-align: inherit;"> Embox </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">リポジトリ</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の手順は、</font><font style="vertical-align: inherit;">さまざまなシステム（Arch Linux、macOS、Debian）で構築し、Dockerを使用する機能を提供し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。私は自分の生活にいくつかの種類を追加し、仮想マシンに最近インストールしたDebianの下からビルドして分析することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組み立てはスムーズに進みました。</font><font style="vertical-align: inherit;">さて、分析を行う必要がありました。</font><font style="vertical-align: inherit;">Debianは、サポートされているPVS-Studio Linuxベースのシステムの1つです。</font><font style="vertical-align: inherit;">Linuxからプロジェクトをチェックする便利な方法は、トレースをコンパイルすることです。</font><font style="vertical-align: inherit;">これは、アナライザーがアセンブリーに関するすべての必要な情報を収集する特別なモードです。これにより、ワンクリックで分析を開始できます。</font><font style="vertical-align: inherit;">私がする必要があるのは、</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）PVS-Studioをダウンロードしてインストールする</font><font style="vertical-align: inherit;">ことだけでした</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）Emboxのあるフォルダーに移動し、ターミナルに入力して、アセンブリ追跡を起動します</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -- make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3）アセンブリが完了するのを待ってから、次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -o /path/to/output.<span class="hljs-built_in">log</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4）未加工のレポートを任意の形式に変換します。</font><font style="vertical-align: inherit;">アナライザーには、これを行うことができる特別なユーティリティPlogConverterが付属しています。</font><font style="vertical-align: inherit;">たとえば、レポートをタスクリストに変換するコマンド（たとえば、QtCreatorで表示するため）は次のようになります。</font></font><br>
<br>
<pre><code class="cpp hljs">plog-converter -t tasklist -o /path/to/output.tasks /path/to/project</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべて！</font><font style="vertical-align: inherit;">これらのポイントを完了するのに15分もかかりませんでした。</font><font style="vertical-align: inherit;">レポートの準備ができました。これでエラーを表示できます。</font><font style="vertical-align: inherit;">さて、始めましょう:)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">奇妙なサイクル</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザーによって検出されたエラーの1つは、奇妙なwhileループでした。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span> ) {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
<font></font>
    dp.skip --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span>);       <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">do</span> {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    ....<font></font>
<font></font>
    dp.count --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.count != <span class="hljs-number">0</span>);<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studioの</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">：</font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">V715</font></a><font style="vertical-align: inherit;"> 'while'演算子の本文が空です。</font><font style="vertical-align: inherit;">不審なパターンが検出されました： 'while（expr）{...} while（dp.skip！= 0）;'。</font><font style="vertical-align: inherit;">dd.c 225 hm </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。</font><font style="vertical-align: inherit;">本当に奇妙なループ。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">式</font><i><font style="vertical-align: inherit;">（dp.skip！= 0）</font></i><font style="vertical-align: inherit;">は2回書き込まれ</font><i><font style="vertical-align: inherit;">ます。1</font></i><font style="vertical-align: inherit;">回はループの真上、もう1回はループのすぐ下です。</font><font style="vertical-align: inherit;">実際、これらは2つの異なるサイクルになりました。1つは中括弧内の式を含み、2つ目は空です。</font><font style="vertical-align: inherit;">この場合、2番目のサイクルは実行されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、do ... whileループに似た条件があります。これは、私に考えさせます。奇妙なループは、もともとdo ... whileを意味していましたが、何かがうまくいきませんでした。</font><font style="vertical-align: inherit;">この確率の高いコードには論理エラーが含まれていると思います。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリリーク</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、それらなしではありません。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">krename</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *oldpath, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *newpath)</span> </span>{<font></font>
  <font></font>
  <span class="hljs-keyword">char</span> *newpatharg, *oldpatharg;<font></font>
<font></font>
  ....<font></font>
<font></font>
  oldpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(oldpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));<font></font>
  newpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(newpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == oldpatharg || <span class="hljs-literal">NULL</span> == newpatharg) {<font></font>
    SET_ERRNO(ENOMEM);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studioの警告：</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">V773</a> The function was exited without releasing the 'newpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">V773</a> The function was exited without releasing the 'oldpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数は、ローカル変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oldpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をそれ自体の内部に作成します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これらのポインタには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して内部的に割り当てられた新しいメモリ位置のアドレスが割り当てられます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">メモリの割り当て時に問題が発生した場合、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はnullポインターを返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリブロックが1つだけ割り当てられている場合はどうなりますか？</font><font style="vertical-align: inherit;">この関数は、メモリを解放せずにクラッシュします。</font><font style="vertical-align: inherit;">たまたま割り当てられたサイトは、メモリに残っているため、再度アクセスして、さらに使用するために解放することができません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリリークのもう1つの例は、少し明るくなります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">block_dev_test</span><span class="hljs-params">(....)</span> </span>{
  <span class="hljs-keyword">int8_t</span> *read_buf, *write_buf;<font></font>
  <font></font>
  ....<font></font>
<font></font>
  read_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
  write_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (read_buf == <span class="hljs-literal">NULL</span> || write_buf == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to allocate memory for buffer!\n"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (read_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(read_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (write_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(write_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> -ENOMEM;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (s_block &gt;= blocks) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Starting block should be less than number of blocks\n"</span>);
    <span class="hljs-keyword">return</span> -EINVAL;            <span class="hljs-comment">// &lt;=</span><font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studioの警告：</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">V773</a> The function was exited without releasing the 'read_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">V773</a> The function was exited without releasing the 'write_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、プログラマーはすでに精度を示しており、メモリを1つしか割り当てることができなかった場合を正しく処理しています。</font><font style="vertical-align: inherit;">正しく処理されました...次の式で文字通り別の間違いを犯しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正しく記述されたチェックのおかげで、式が実行されたときに、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-EINVALを確実</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><i><font style="vertical-align: inherit;">返すことができます。</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_bufの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">両方にメモリが確実に割り当てられ</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">したがって、このような関数からの戻りにより、一度に2つのリークが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組み込みデバイスでメモリリークが発生することは、従来のPCよりも苦痛であると思います。</font><font style="vertical-align: inherit;">リソースが大幅に制限されている状況では、特に注意深く監視する必要があります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポインターの誤操作</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のエラーコードは簡潔で十分に単純です。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">scsi_write</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">char</span> *buffer,
                      <span class="hljs-keyword">size_t</span> count, <span class="hljs-keyword">blkno_t</span> blkno)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_dev</span> *<span class="hljs-title">sdev</span>;</span>
  <span class="hljs-keyword">int</span> blksize;<font></font>
<font></font>
  ....<font></font>
<font></font>
  sdev = bdev-&gt;privdata;<font></font>
  blksize = sdev-&gt;blk_size; <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!sdev) {              <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">return</span> -ENODEV;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nullptrに対して検証される前に「sdev」ポインターが使用されました。チェック行：116、118。scsi_disk.c 116 </font><font style="vertical-align: inherit;">NULLがチェックされる直前に、</font><i><font style="vertical-align: inherit;">sdev</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ポインター</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">逆参照されます。誰かがそのようなチェックを書いた場合、このポインタはnullである可能性があると想定するのは当然です。この場合、文字列</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_sizeで</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nullポインターの逆参照が発生する可能性があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーは、チェックが必要な場所に配置されていないことです。 " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev = bdev-&gt; privdata;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">という行の後、 " </font><i><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size;</font></i><font style="vertical-align: inherit;"> "という行の前にある</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はずです</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。その後、ゼロアドレスへの潜在的なアピールを回避できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studioは、次のコードでさらに2つのエラーを検出しました：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xdrrec_create</span><span class="hljs-params">(....)</span>
</span>{
  <span class="hljs-keyword">char</span> *buff;<font></font>
<font></font>
  ....<font></font>
<font></font>
  buff = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(sendsz + recvsz);<font></font>
  assert(buff != <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  ....<font></font>
<font></font>
  xs-&gt;extra.rec.in_base = xs-&gt;extra.rec.in_curr = buff;<font></font>
  xs-&gt;extra.rec.in_boundry <font></font>
    = xs-&gt;extra.rec.in_base + recvsz;                    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
  xs-&gt;extra.rec.out_base<font></font>
    = xs-&gt;extra.rec.out_hdr = buff + recvsz;             <span class="hljs-comment">// &lt;= </span><font></font>
  xs-&gt;extra.rec.out_curr <font></font>
    = xs-&gt;extra.rec.out_hdr + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">union</span> xdrrec_hdr);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studioの警告：</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「xs-&gt; extra.rec.in_base + recvsz」式の「xs-&gt; extra.rec.in_base」ポインタはnullptrになる可能性があります。</font><font style="vertical-align: inherit;">このような場合、結果の値は無意味になるため、使用しないでください。</font><font style="vertical-align: inherit;">チェック行：56、48。xdr_rec.c 56</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「buff + recvsz」式の「buff」ポインタはnullptrになる可能性があります。</font><font style="vertical-align: inherit;">このような場合、結果の値は無意味になるため、使用しないでください。</font><font style="vertical-align: inherit;">チェック行：61、48。xdr_rec.c 61</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
bufポインターは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">初期化され</font><font style="vertical-align: inherit;">、その値は他のポインターを初期化するために使用されます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">はnullポインターを返す可能</font><font style="vertical-align: inherit;">性</font><font style="vertical-align: inherit;">があり、これは常にチェックする必要があります。ここ</font><font style="vertical-align: inherit;">に</font><i><font style="vertical-align: inherit;">NULLの</font></i><i><font style="vertical-align: inherit;">buf</font></i><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">確認</font><font style="vertical-align: inherit;">する</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アサート</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があるように思われ</font><font style="vertical-align: inherit;">、すべてが正常に動作するはずです。</font><font style="vertical-align: inherit;">
しかし、違います！実際、</font><i><font style="vertical-align: inherit;">assert</font></i><font style="vertical-align: inherit;">はデバッグに使用され、リリース構成でプロジェクトをビルド</font><i><font style="vertical-align: inherit;">する</font></i><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">、この</font><i><font style="vertical-align: inherit;">アサート</font></i><font style="vertical-align: inherit;">は削除されます。 Debugで作業する場合、プログラムは正しく動作し、Releaseでビルドする場合、nullポインターはさらに「進む」ことがわかりました。</font><i><font style="vertical-align: inherit;">nullを</font></i><font style="vertical-align: inherit;"> 
使用</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">算術演算では、そのような演算の結果は意味をなさず、そのような結果は使用できないため、正しくありません。</font><font style="vertical-align: inherit;">これはアナライザーが警告するものです。</font><i><font style="vertical-align: inherit;">malloc</font></i><font style="vertical-align: inherit;"> / </font><i><font style="vertical-align: inherit;">realloc</font></i><font style="vertical-align: inherit;"> / </font><i><font style="vertical-align: inherit;">callocの</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
後にポインターをチェックしないことは恐れがないと主張する人もいます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">同様に、ヌルポインターによる最初のアクセス時に、シグナル/例外が発生し、問題はありません。</font><font style="vertical-align: inherit;">実際には、すべてがはるかに複雑であり、検証の欠如があなたにとって危険ではないと思われる場合は、記事「</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">malloc関数が何を返したかを確認することが重要である理由</font></a><font style="vertical-align: inherit;">」を参照することをお勧めします</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配列の不適切な処理</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のエラーは、直前の例と非常に似ています。</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fat_read_filename</span><span class="hljs-params">(struct fat_file_info *fi,
                      <span class="hljs-keyword">void</span> *p_scratch,
                      <span class="hljs-keyword">char</span> *name)</span> </span>{
  <span class="hljs-keyword">int</span> offt = <span class="hljs-number">1</span>;<font></font>
<font></font>
  ....<font></font>
<font></font>
  offt = <span class="hljs-built_in">strlen</span>(name);
  <span class="hljs-keyword">while</span> (name[offt - <span class="hljs-number">1</span>] == <span class="hljs-string">' '</span> &amp;&amp; offt &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// &lt;=</span>
    name[--offt] = <span class="hljs-string">'\0'</span>;<font></font>
  }<font></font>
  log_debug(<span class="hljs-string">"name(%s)"</span>, name);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> DFS_OK;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V781</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「offt」インデックスの値は、使用後にチェックされます。</font><font style="vertical-align: inherit;">プログラムのロジックに誤りがある可能性があります。</font><font style="vertical-align: inherit;">fat_common.c 1813 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offtは、</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初にインデックス作成操作の中で使用され、その後、その値がゼロより大きいかどうかがチェックされます。</font><font style="vertical-align: inherit;">しかし、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名前</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が空の文字列であることが判明した</font><font style="vertical-align: inherit;">場合はどう</font><font style="vertical-align: inherit;">なりますか？</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を返し</font><font style="vertical-align: inherit;">、次に脚に大きなショット</font><font style="vertical-align: inherit;">が返さ</font><font style="vertical-align: inherit;">れます。</font><font style="vertical-align: inherit;">プログラムは負のインデックスでアクセスするため、未定義の動作が発生します。</font><font style="vertical-align: inherit;">プログラムのクラッシュなど、何かが発生する可能性があります。</font><font style="vertical-align: inherit;">めちゃくちゃ！</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8d/fde/b0d/a8dfdeb0d70054257d1d08162bbd39aa.png" alt="写真1"></div> <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不審な状態</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてそれらなしでどこに？</font><font style="vertical-align: inherit;">私たちはチェックするすべてのプロジェクトで文字通りそのようなエラーを見つけます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">index_descriptor_cloexec_set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> cloexec)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idesc_table</span> *<span class="hljs-title">it</span>;</span><font></font>
<font></font>
  it = task_resource_idesc_table(task_self());<font></font>
  assert(it);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (cloexec | FD_CLOEXEC) {<font></font>
    idesc_cloexec_set(it-&gt;idesc_table[fd]);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    idesc_cloexec_clear(it-&gt;idesc_table[fd]);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V617</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状態の検査を検討してください。 '|'の '0x0010'引数ビット演算にはゼロ以外の値が含まれています。 index_descriptor.c 55 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エラーの原因を理解するには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FD_CLOEXEC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定数の定義を確認します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FD_CLOEXEC 0x0010</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
式では</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、（cloexec | FD_CLOEXEC）が</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビット単位の「or」の右側にある場合、常にゼロ以外の定数があることが</font><i><font style="vertical-align: inherit;">わかり</font></i><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">このような操作の結果は常にゼロ以外の数値になります。</font><font style="vertical-align: inherit;">したがって、この式は常に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if（true）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">式と同等であり、常に</font><i><font style="vertical-align: inherit;">if</font></i><font style="vertical-align: inherit;">式</font><font style="vertical-align: inherit;">のthen分岐のみを処理します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このマクロ定数がEmboxオペレーティングシステムの事前設定に使用されているのではないかと思いますが、それでも常にこの真の状態は奇妙に見えます。</font><font style="vertical-align: inherit;">おそらくここ</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＆</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">演算子を使用したかったの</font><font style="vertical-align: inherit;">ですが、タイプミスがありました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整数除算</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のエラーは、C言語の1つの機能に関連しています。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SBSIZE    1024</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2fs_format</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">void</span> *priv)</span> </span>{
  <span class="hljs-keyword">size_t</span> dev_bsize;
  <span class="hljs-keyword">float</span> dev_factor;<font></font>
<font></font>
  ....<font></font>
<font></font>
  dev_size = block_dev_size(bdev);<font></font>
  dev_bsize = block_dev_block_size(bdev);<font></font>
  dev_factor = SBSIZE / dev_bsize;            <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ext2_dflt_sb(&amp;sb, dev_size, dev_factor);<font></font>
  ext2_dflt_gd(&amp;sb, &amp;gd);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">：</font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">V636</font></a><font style="vertical-align: inherit;">「1024 / dev_bsize」式が「int」型から「float」型に暗黙的にキャストされました。小数部の損失を回避するために、明示的な型キャストを利用することを検討してください。例：double A =（double）（X）/ Y;。 ext2.c 777 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能は次のとおりです。2つの整数値を除算すると、除算の結果は整数になります。したがって、除算は剰余なしで行われます。つまり、小数部分は除算結果から破棄されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時々プログラマーはそれを忘れ、このようなエラーが発生します。 SBSIZE定数と変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_bsizeに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は整数型が</font><font style="vertical-align: inherit;">あります</font><font style="vertical-align: inherit;">（それぞれ、intとsize_t）。したがって、</font><i><font style="vertical-align: inherit;">SBSIZE / dev_bsize式の</font></i><font style="vertical-align: inherit;">結果</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整数型にもなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ちょっと待ってください。</font><font style="vertical-align: inherit;">変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">型</font><font style="vertical-align: inherit;">です！</font><font style="vertical-align: inherit;">明らかに、プログラマーは分数除算の結果を期待していました。</font><font style="vertical-align: inherit;">この変数をさらに使用することに注意すれば、これをさらに検証できます。</font><font style="vertical-align: inherit;">たとえば</font><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">dev_factorが</font></i><font style="vertical-align: inherit;"> 3番目のパラメーターとして渡される</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_dflt_sb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">には、次のシグネチャがあります。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ext2_dflt_sb</span><span class="hljs-params">(struct ext2sb *sb, <span class="hljs-keyword">size_t</span> dev_size, <span class="hljs-keyword">float</span> dev_factor)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数が</font><i><font style="vertical-align: inherit;">使用される</font></i><font style="vertical-align: inherit;">他の場所では、</font><font style="vertical-align: inherit;">すべてが浮動小数点数が予期されることを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このエラーを修正するには、除算オペランドの1つを実数型にキャストするだけで十分です。</font><font style="vertical-align: inherit;">例えば：</font></font><br>
<br>
<pre><code class="cpp hljs">dev_factor = <span class="hljs-keyword">float</span>(SBSIZE) / dev_bsize;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうすると、除算の結果は小数になります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未検証の入力</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のエラーは、プログラムの外部から受信した未検証のデータの使用に関連しています。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> ret;
  <span class="hljs-keyword">char</span> text[SMTP_TEXT_LEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == fgets(&amp;text[<span class="hljs-number">0</span>], <span class="hljs-keyword">sizeof</span> text - <span class="hljs-number">2</span>, <span class="hljs-comment">/* for \r\n */</span>
      <span class="hljs-built_in">stdin</span>)) { ret = -EIO; <span class="hljs-keyword">goto</span> error; }<font></font>
    text[<span class="hljs-built_in">strlen</span>(&amp;text[<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>] = <span class="hljs-string">'\0'</span>; <span class="hljs-comment">/* remove \n */</span>    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックされていない汚染されたデータがインデックスで使用されています： 'strlen（＆text [0]）'。</font><font style="vertical-align: inherit;">sendmail.c 102 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数が何を返すかを考えます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">行の読み取りに成功した場合、関数はこの行へのポインターを返します。</font><font style="vertical-align: inherit;">リードが発生した場合に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンド・オブ・ファイルを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少なくとも一つの要素が読み出される前に、又は入力エラーが発生した場合、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数fgetsは</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能</font><font style="vertical-align: inherit;">返す</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULLを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、式は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL == fgets（....）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">受け取った入力が正しいかどうかをチェックします。ただし、注意点が1つあります。読み取る最初の文字としてnull端末を転送する場合（これは、たとえば、WindowsコマンドラインのレガシーモードでCtrl + 2を押すことで実行できます）、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULLを返さ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ずにそれを考慮し</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。この場合、記録が行われる行には1つの要素（ ' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '）</font><font style="vertical-align: inherit;">しかありません</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は何が起こるのだろう？式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen（＆text [0]）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を返し</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。その結果、負のインデックス呼び出しが発生します。</font></font><br>
<br>
<pre><code class="cpp hljs">text[ <span class="hljs-number">0</span> - <span class="hljs-number">1</span> ] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、行末文字を入力に渡すだけでプログラムを「覆す」ことができます。</font><font style="vertical-align: inherit;">これは扱いにくく、Emboxを使用するシステムを攻撃するために使用される可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この診断ルールを開発していた私の同僚は、NcFTPプロジェクトへのこのような攻撃の例を記しています。</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8DBQjvPQ7tk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような機会をまだ信じていないかどうかを確認することをお勧めします:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、アナライザーは、同じエラーのある場所をさらに2つ見つけました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010チェックされていない汚染されたデータがインデックスで使用されています： 'strlen（＆from [0]）'。</font><font style="vertical-align: inherit;">sendmail.c 55</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010チェックされていない汚染されたデータがインデックスで使用されています： 'strlen（＆to [0]）'。</font><font style="vertical-align: inherit;">sendmail.c 65</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ミスラ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRAは、信頼性の高い組み込みシステム用の安全なCおよびC ++コードを作成するための一連のガイドラインとガイドラインです。</font><font style="vertical-align: inherit;">ある意味で、これはいわゆる「コードのにおい」だけでなく、プログラムを脆弱性から保護するためのトレーニングマニュアルでもあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRAは、医療、自動車、航空機、軍事産業など、組み込みシステムの品質に依存する人命に使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studioには</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MISRA CおよびMISRA C ++標準にコードが準拠しているかどうかをチェックできる診断ルールの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">広範なセットがあり</font></a><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">デフォルトでは、これらの診断のモードはオフになっていますが、組み込みシステムのプロジェクトでエラーを探しているため、MISRAがなければ実行できませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが私がなんとか見つけたものです：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* find and read symlink file */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2_read_symlink</span><span class="hljs-params">(struct nas *nas,
                             <span class="hljs-keyword">uint32_t</span> parent_inumber,
                             <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **cp)</span> </span>{
  <span class="hljs-keyword">char</span> namebuf[MAXPATHLEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  *cp = namebuf;              <span class="hljs-comment">// &lt;=</span>
  <span class="hljs-keyword">if</span> (*namebuf != <span class="hljs-string">'/'</span>) {<font></font>
    inumber = parent_inumber;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    inumber = (<span class="hljs-keyword">uint32_t</span>) EXT2_ROOTINO;<font></font>
  }<font></font>
  rc = ext2_read_inode(nas, inumber);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
} </code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告：</font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6]ローカル配列 'namebuf'のアドレスは、この配列のスコープ外に保存しないでください。 ext2.c 298 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザーは、未定義の動作につながる可能性のある疑わしい割り当てを検出しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを詳しく見てみましょう。ここで、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は関数のローカルスコープで作成された配列であり、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポインターは</font><font style="vertical-align: inherit;">ポインターによって関数に渡されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C構文によれば、配列の名前は、配列が格納されているメモリ領域の最初の要素へのポインタです。式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* cp = namebufは</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、配列</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebufの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレスを</font><i><font style="vertical-align: inherit;">cpが</font></i><font style="vertical-align: inherit;">指す変数に</font><font style="vertical-align: inherit;">割り当て</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。以来、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPはれる</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポインタにより関数に渡され、それが指している値の変化は、関数が呼び出された場所に反映されます。</font><i><font style="vertical-align: inherit;">ext2_read_symlink</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
関数が</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">処理を完了</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">した後、</font><font style="vertical-align: inherit;">3番目のパラメーターは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配列が一度占有した領域を示すことが</font><i><font style="vertical-align: inherit;">わかり</font></i><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「but」は1つしかありません</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はスタックで予約されている配列であるため、関数が終了すると削除されます。したがって、関数の外部に存在するポインターは、解放されたメモリーを指します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのアドレスで何が起こりますか？</font><font style="vertical-align: inherit;">予測することは不可能です。</font><font style="vertical-align: inherit;">しばらくの間、配列の内容がメモリに残っている可能性があります。または、プログラムがこの領域を別の何かですぐに消去する可能性があります。</font><font style="vertical-align: inherit;">一般に、そのようなアドレスにアクセスすると未定義の値が返され、そのような値を使用すると重大なエラーが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザーは、同じ警告を持つ別のエラーも検出しました。</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6]ローカル変数「dst_haddr」のアドレスは、この変数のスコープ外に保存しないでください。</font><font style="vertical-align: inherit;">net_tx.c 82</font></font></li>
</ul><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ba/353/6e6/2ba3536e675a564e65b802a3e596fa36.png" alt="図6"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Emboxプロジェクトでの作業が好きでした。記事で見つかったすべてのエラーを書き出さなかったという事実にもかかわらず、警告の総数は比較的少なく、一般にプロジェクトコードは高品質で書かれていました。したがって、私は開発者だけでなく、コミュニティに代わってプロジェクトに貢献した人々にも感謝の意を表します。あなたは素晴らしいです！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機会に、トゥーラの開発者に挨拶をします。サンクトペテルブルク</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
は</font><font style="vertical-align: inherit;">今の</font><font style="vertical-align: inherit;">ところ</font><font style="vertical-align: inherit;">それほど寒くないと</font><font style="vertical-align: inherit;">思います</font><font style="vertical-align: inherit;">:) </font><font style="vertical-align: inherit;">これで私の記事は終わりです。私はあなたがそれを楽しんで楽しんだことを望みます、そしてあなたはあなた自身のために何か新しいものを見つけました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studioに興味があり、それを使用しているプロジェクトを個別に検証したい場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウンロードして試してください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これには15分もかかりません。</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事を英語圏の読者と共有したい場合は、翻訳へのリンクを使用してください：George Gribkov。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再び埋め込みについて：Emboxプロジェクトでバグを検索し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja499970/index.html">Mediastreamer2 VoIPエンジンを研究します。パート12</a></li>
<li><a href="../ja499972/index.html">5月のオンラインイベントダイジェスト</a></li>
<li><a href="../ja499974/index.html">Instagram JavaScriptの3Dゲーム、またはソーセージの飛行経路</a></li>
<li><a href="../ja499978/index.html">Andrew Unの本、機械学習への情熱、36章と37章の翻訳</a></li>
<li><a href="../ja499982/index.html">初心者テスター計画：「ITに入る」から「エンジニアです！」</a></li>
<li><a href="../ja499988/index.html">砂糖とCOVID-19</a></li>
<li><a href="../ja499990/index.html">ジオコーディング 10分間で25万のアドレスを座標にバインドする方法は？</a></li>
<li><a href="../ja499992/index.html">企業クライアント向けの課金システムの実装のための設計テクノロジー（パート2）</a></li>
<li><a href="../ja499994/index.html">コロナウイルスがいつ終わるか</a></li>
<li><a href="../ja500000/index.html">ラジオデーへ。コミュニケーション-戦争の神経</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>