<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äç‚öïÔ∏è ‚ìÇÔ∏è üöµ Datenbank mit Primzahlen bis zu hundert Milliarden am Knie üëä üö£üèø ‚ö™Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der bekannteste Algorithmus zum Auffinden aller Primzahlen, die nicht gr√∂√üer als eine bestimmte sind, ist das Eratosthenes-Sieb . Es funktioniert herv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Datenbank mit Primzahlen bis zu hundert Milliarden am Knie</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504598/"><img src="https://habrastorage.org/webt/zd/6i/ot/zd6iot54oxpybjjvtfpznmgymem.png" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der bekannteste Algorithmus zum Auffinden aller Primzahlen, die nicht gr√∂√üer als eine bestimmte sind, ist das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eratosthenes-Sieb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es funktioniert hervorragend f√ºr Zahlen bis zu Milliarden, vielleicht bis zu zehn Milliarden, wenn es ordentlich geschrieben ist. Jeder, der Spa√ü mit Primzahlen haben m√∂chte, wei√ü jedoch, dass Sie immer so viele wie m√∂glich zur Hand haben m√∂chten. Um ein Problem mit einem Hackerrank zu l√∂sen, brauchte ich einmal eine In-Memory-Datenbank mit Primzahlen von bis zu hundert Milliarden. Wenn das Eratosthenes-Sieb bei maximaler Speicheroptimierung ungerade Zahlen mit einem Bit-Array aufweist, betr√§gt seine Gr√∂√üe etwa 6 Gigabyte, was nicht in den Speicher meines Laptops passt. Es gibt eine Modifikation des Algorithmus, die im Speicher viel weniger anspruchsvoll ist (Aufteilen des urspr√ºnglichen Zahlenbereichs in mehrere Teile und Verarbeiten von jeweils einem Teil) -</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segmentiertes Sieb von Eratosthenes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber es ist schwieriger zu implementieren, und das gesamte Ergebnis wird sowieso nicht in den Speicher passen. </font><font style="vertical-align: inherit;">Im Folgenden m√∂chte ich Sie auf einen Algorithmus aufmerksam machen, der fast so einfach ist wie das Eratosthenes-Sieb, aber eine doppelte Optimierung durch den Speicher erm√∂glicht (dh eine Datenbank mit Primzahlen von bis zu einhundert Milliarden belegt etwa 3 Gigabyte, die bereits in den Speicher eines Standard-Laptops passen sollten).</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zun√§chst erinnern wir uns daran, wie das Sieb von Eratosthenes funktioniert: In einer Reihe von Zahlen von 1 bis N werden durch zwei teilbare Zahlen durchgestrichen, dann durch 3 teilbare Zahlen und so weiter. </font><font style="vertical-align: inherit;">Die nach dem Durchstreichen verbleibenden Zahlen sind einfach:</font></font><br>
<br>
<pre><code class="plaintext hljs">2 3 . 5 . 7 . 9 . 11 . 13 . 15 . 17 . 19 . 21 . 23 . 25 . 27  . 29  ...<font></font>
2 3 . 5 . 7 . . . 11 . 13 .  . . 17 . 19 .  . . 23 . 25 .  .  . 29  ...<font></font>
2 3 . 5 . 7 . . . 11 . 13 .  . . 17 . 19 .  . . 23 .  . .  .  . 29  ...<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C # -Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">EratospheneSieve</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span>[] Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EratospheneSieve</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> length</span>)</span><font></font>
    {<font></font>
        Data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">bool</span>[length];<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span>; i &lt; Data.Length; i++) Data[i] = <span class="hljs-literal">true</span>;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span>; i * i &lt; Length; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!Data[i]) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> d = i * i; d &lt; Length; d += i) Data[d] = <span class="hljs-literal">false</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Length =&gt; Data.Length;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> n</span>)</span> =&gt; Data[n];<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf meinem Laptop z√§hlt es bis zu 15 Milliarden Sekunden und verbraucht ein Gigabyte Speicher. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Algorithmus, den wir verwenden werden, hei√üt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Radfaktorisierung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Um seine Essenz zu verstehen, schreiben wir nat√ºrliche Zahlen mit einer Tafel mit 30 Teilen hintereinander:</font></font><br>
<br>
<pre><code class="plaintext hljs"> 0  1  2  3  4  5 ... 26 27 28 29<font></font>
30 31 32 33 34 35 ... 56 57 58 59<font></font>
60 61 62 63 64 65 ... 86 87 88 89<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und streichen Sie alle durch 2, 3 und 5 teilbaren Zahlen durch:</font></font><br>
<br>
<pre><code class="cs hljs">.  <span class="hljs-number">1</span> . . . . .  <span class="hljs-number">7</span> . . . <span class="hljs-number">11</span> . <span class="hljs-number">13</span> . . . <span class="hljs-number">17</span> . <span class="hljs-number">19</span> . . . <span class="hljs-number">23</span> . . . . . <span class="hljs-number">29</span>
. <span class="hljs-number">31</span> . . . . . <span class="hljs-number">37</span> . . . <span class="hljs-number">41</span> . <span class="hljs-number">43</span> . . . <span class="hljs-number">47</span> . <span class="hljs-number">49</span> . . . <span class="hljs-number">53</span> . . . . . <span class="hljs-number">59</span>
. <span class="hljs-number">61</span> . . . . . <span class="hljs-number">67</span> . . . <span class="hljs-number">71</span> . <span class="hljs-number">73</span> . . . <span class="hljs-number">77</span> . <span class="hljs-number">79</span> . . . <span class="hljs-number">83</span> . . . . . <span class="hljs-number">89</span><font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist ersichtlich, dass in jeder Zeile die Nummern an den gleichen Positionen durchgestrichen sind. </font><font style="vertical-align: inherit;">Da wir nur zusammengesetzte Zahlen durchgestrichen haben (mit Ausnahme der Zahlen 2, 3, 5), k√∂nnen Primzahlen nur an nicht markierten Positionen stehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da jede Zeile acht solcher Zahlen enth√§lt, haben wir die Idee, jeweils drei√üig Zahlen mit einem Byte darzustellen, von denen jedes der acht Bits die Einfachheit der Zahl an der entsprechenden Position anzeigt. </font><font style="vertical-align: inherit;">Dieser Zufall ist nicht nur √§sthetisch sch√∂n, sondern vereinfacht auch die Implementierung des Algorithmus erheblich!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sc/kk/_9/sckk_9guzbjn14nmzo7djdiyvxm.png" alt="Bild"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Technische Umsetzung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstens ist es unser Ziel, einhundert Milliarden zu erreichen, sodass auf vier Byte-Zahlen nicht mehr verzichtet werden kann. </font><font style="vertical-align: inherit;">Daher sieht unser Algorithmus ungef√§hr so ‚Äã‚Äãaus:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        ...<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        ...<font></font>
    }<font></font>
    ...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Vereinfachung der Implementierung runden wir die L√§nge auf die n√§chste durch 30 teilbare Zahl auf. Dann</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ensure length divides by 30</span>
        length = (length + <span class="hljs-number">29</span>) / <span class="hljs-number">30</span> * <span class="hljs-number">30</span>; <font></font>
        Data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length/<span class="hljs-number">30</span>];<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; Data.Length * <span class="hljs-number">30L</span>;<font></font>
<font></font>
    ...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als n√§chstes ben√∂tigen wir zwei Arrays: eines √ºbersetzt den Index 0..29 in die Bitnummer, das zweite im Gegenteil die Bitnummer in die Position drei√üig. </font><font style="vertical-align: inherit;">Mit diesen Arrays und etwas Bitarithmetik erstellen wir eine Eins-zu-Eins-Entsprechung zwischen nat√ºrlichen Zahlen und Bits im Datenarray. </font><font style="vertical-align: inherit;">Der Einfachheit halber verwenden wir nur zwei Methoden: IsPrime (n), mit dem Sie herausfinden k√∂nnen, ob die Zahl eine Primzahl ist, und ClearPrime (n), mit dem das entsprechende Bit auf 0 gesetzt wird, wobei die Zahl n als Verbindung markiert wird:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] BIT_TO_INDEX = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>, <span class="hljs-number">29</span> };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] INDEX_TO_BIT = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] {
        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">1</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">2</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">3</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">4</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">5</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">6</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">7</span>,<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] Data;<font></font>
<font></font>
    ...<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> n == <span class="hljs-number">2</span> || n == <span class="hljs-number">3</span> || n == <span class="hljs-number">5</span>;
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> (Data[n / <span class="hljs-number">30</span>] &amp; (<span class="hljs-number">1</span> &lt;&lt; bit)) != <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<font></font>
        Data[n / <span class="hljs-number">30</span>] &amp;= (<span class="hljs-keyword">byte</span>)~(<span class="hljs-number">1</span> &lt;&lt; bit);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beachten Sie, dass wenn die Zahl durch 2, 3 oder 5 teilbar ist, die Bitnummer -1 ist, was bedeutet, dass die Zahl offensichtlich zusammengesetzt ist. </font><font style="vertical-align: inherit;">Nun, und nat√ºrlich verarbeiten wir einen Sonderfall n &lt;= 5. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun tats√§chlich der Algorithmus selbst, der das Sieb von Eratosthenes fast buchst√§blich wiederholt:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        length = (length + <span class="hljs-number">29</span>) / <span class="hljs-number">30</span> * <span class="hljs-number">30</span>;<font></font>
        Data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length / <span class="hljs-number">30</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; Data.Length; i++) Data[i] = <span class="hljs-keyword">byte</span>.MaxValue;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">7</span>; i * i &lt; Length; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!IsPrime(i)) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> d = i * i; d &lt; Length; d += i) ClearPrime(d);<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dementsprechend ist die gesamte resultierende Klasse:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sieht so aus</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] BIT_TO_INDEX = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>, <span class="hljs-number">29</span> };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] INDEX_TO_BIT = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] {
        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">1</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">2</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">3</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">4</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">5</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">6</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">7</span>,<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ensure length divides by 30</span>
        length = (length + <span class="hljs-number">29</span>) / <span class="hljs-number">30</span> * <span class="hljs-number">30</span>;<font></font>
        Data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length / <span class="hljs-number">30</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; Data.Length; i++) Data[i] = <span class="hljs-keyword">byte</span>.MaxValue;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">7</span>; i * i &lt; Length; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!IsPrime(i)) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> d = i * i; d &lt; Length; d += i) ClearPrime(d);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; Data.Length * <span class="hljs-number">30L</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (n &gt;= Length) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Number too big"</span>);
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> n == <span class="hljs-number">2</span> || n == <span class="hljs-number">3</span> || n == <span class="hljs-number">5</span>;
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> (Data[n / <span class="hljs-number">30</span>] &amp; (<span class="hljs-number">1</span> &lt;&lt; bit)) != <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<font></font>
        Data[n / <span class="hljs-number">30</span>] &amp;= (<span class="hljs-keyword">byte</span>)~(<span class="hljs-number">1</span> &lt;&lt; bit);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt nur ein kleines Problem: Dieser Code funktioniert nicht f√ºr Zahlen gr√∂√üer als etwa 65 Milliarden! </font><font style="vertical-align: inherit;">Wenn Sie versuchen, es mit solchen Zahlen zu starten, st√ºrzt das Programm mit einem Fehler ab:</font></font><br>
<br>
<pre><code class="plaintext hljs">Unhandled Exception: System.OverflowException: Array dimensions exceeded supported range.
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Problem ist, dass in c # Arrays nicht mehr als 2 ^ 31 Elemente enthalten k√∂nnen (anscheinend, weil die interne Implementierung einen 4-Byte-Array-Index verwendet). </font><font style="vertical-align: inherit;">Eine M√∂glichkeit besteht darin, beispielsweise ein langes [] Array anstelle eines Byte [] Arrays zu erstellen. Dies erschwert jedoch die Bitarithmetik ein wenig. </font><font style="vertical-align: inherit;">Der Einfachheit halber gehen wir in die andere Richtung und erstellen eine spezielle Klasse, die das gew√ºnschte Array simuliert und zwei kurze Arrays enth√§lt. </font><font style="vertical-align: inherit;">Gleichzeitig geben wir ihm die M√∂glichkeit, uns auf der Festplatte zu speichern, damit Sie Primzahlen einmal berechnen und dann die Datenbank erneut verwenden k√∂nnen:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">class</span> <span class="hljs-title">LongArray</span><font></font>
    {<font></font>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">long</span> MAX_CHUNK_LENGTH = <span class="hljs-number">2</span>_000_000_000L;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] firstBuffer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] secondBuffer;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LongArray</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
        {<font></font>
            firstBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[Math.Min(MAX_CHUNK_LENGTH, length)];
            <span class="hljs-keyword">if</span> (length &gt; MAX_CHUNK_LENGTH) secondBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length - MAX_CHUNK_LENGTH];<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LongArray</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
        {<font></font>
            ...<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; firstBuffer.LongLength + (secondBuffer == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : secondBuffer.LongLength);<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span> <span class="hljs-keyword">this</span>[<span class="hljs-keyword">long</span> index]<font></font>
        {<font></font>
            <span class="hljs-keyword">get</span> =&gt; index &lt; MAX_CHUNK_LENGTH ? firstBuffer[index] : secondBuffer[index - MAX_CHUNK_LENGTH];
            <span class="hljs-keyword">set</span><font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (index &lt; MAX_CHUNK_LENGTH) firstBuffer[index] = <span class="hljs-keyword">value</span>; 
                <span class="hljs-keyword">else</span> secondBuffer[index - MAX_CHUNK_LENGTH] = <span class="hljs-keyword">value</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
        {<font></font>
            ...<font></font>
        }<font></font>
<font></font>
    }<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kombinieren Sie abschlie√üend alle Schritte in</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">endg√ºltige Version des Algorithmus</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">class</span> <span class="hljs-title">LongArray</span><font></font>
    {<font></font>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">long</span> MAX_CHUNK_LENGTH = <span class="hljs-number">2</span>_000_000_000L;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] firstBuffer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] secondBuffer;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LongArray</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
        {<font></font>
            firstBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[Math.Min(MAX_CHUNK_LENGTH, length)];
            <span class="hljs-keyword">if</span> (length &gt; MAX_CHUNK_LENGTH) secondBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length - MAX_CHUNK_LENGTH];<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LongArray</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span>(FileStream stream = File.OpenRead(file))<font></font>
            {<font></font>
                <span class="hljs-keyword">long</span> length = stream.Length;<font></font>
                firstBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[Math.Min(MAX_CHUNK_LENGTH, length)];
                <span class="hljs-keyword">if</span> (length &gt; MAX_CHUNK_LENGTH) secondBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length - MAX_CHUNK_LENGTH];<font></font>
                stream.Read(firstBuffer, <span class="hljs-number">0</span>, firstBuffer.Length);
                <span class="hljs-keyword">if</span>(secondBuffer != <span class="hljs-literal">null</span>) stream.Read(secondBuffer, <span class="hljs-number">0</span>, secondBuffer.Length);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; firstBuffer.LongLength + (secondBuffer == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : secondBuffer.LongLength);<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span> <span class="hljs-keyword">this</span>[<span class="hljs-keyword">long</span> index]<font></font>
        {<font></font>
            <span class="hljs-keyword">get</span> =&gt; index &lt; MAX_CHUNK_LENGTH ? firstBuffer[index] : secondBuffer[index - MAX_CHUNK_LENGTH];
            <span class="hljs-keyword">set</span><font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (index &lt; MAX_CHUNK_LENGTH) firstBuffer[index] = <span class="hljs-keyword">value</span>; 
                <span class="hljs-keyword">else</span> secondBuffer[index - MAX_CHUNK_LENGTH] = <span class="hljs-keyword">value</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span>(FileStream stream = File.OpenWrite(file))<font></font>
            {<font></font>
                stream.Write(firstBuffer, <span class="hljs-number">0</span>, firstBuffer.Length);
                <span class="hljs-keyword">if</span> (secondBuffer != <span class="hljs-literal">null</span>) stream.Write(secondBuffer, <span class="hljs-number">0</span>, secondBuffer.Length);<font></font>
            }<font></font>
        }<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] BIT_TO_INDEX = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>, <span class="hljs-number">29</span> };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] INDEX_TO_BIT = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] {
        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">1</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">2</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">3</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">4</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">5</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">6</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">7</span>,<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> LongArray Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ensure length divides by 30</span>
        length = (length + <span class="hljs-number">29</span>) / <span class="hljs-number">30</span> * <span class="hljs-number">30</span>;<font></font>
        Data = <span class="hljs-keyword">new</span> LongArray(length / <span class="hljs-number">30</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; Data.Length; i++) Data[i] = <span class="hljs-keyword">byte</span>.MaxValue;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">7</span>; i * i &lt; Length; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!IsPrime(i)) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> d = i * i; d &lt; Length; d += i) ClearPrime(d);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
    {<font></font>
        Data = <span class="hljs-keyword">new</span> LongArray(file);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span> =&gt; Data.Save(file);<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; Data.Length * <span class="hljs-number">30L</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (n &gt;= Length) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Number too big"</span>);
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> n == <span class="hljs-number">2</span> || n == <span class="hljs-number">3</span> || n == <span class="hljs-number">5</span>;
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> (Data[n / <span class="hljs-number">30</span>] &amp; (<span class="hljs-number">1</span> &lt;&lt; bit)) != <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<font></font>
        Data[n / <span class="hljs-number">30</span>] &amp;= (<span class="hljs-keyword">byte</span>)~(<span class="hljs-number">1</span> &lt;&lt; bit);<font></font>
    }<font></font>
<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis haben wir eine Klasse erhalten, die Primzahlen von nicht mehr als einhundert Milliarden berechnen und das Ergebnis auf der Festplatte speichern kann (ich hatte diesen Code 50 Minuten lang auf meinem Laptop; die Gr√∂√üe der erstellten Datei betrug erwartungsgem√§√ü etwa 3 Gigabyte):</font></font><br>
<br>
<pre><code class="cs hljs">        <span class="hljs-keyword">long</span> N = <span class="hljs-number">100</span>_000_000_000L;<font></font>
        Wheel235 wheel = <span class="hljs-keyword">new</span> Wheel235(N);<font></font>
        wheel.Save(<span class="hljs-string">"./primes.dat"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dann von der Festplatte lesen und verwenden:</font></font><br>
<br>
<pre><code class="cs hljs">        DateTime start = DateTime.UtcNow;<font></font>
        Wheel235 loaded = <span class="hljs-keyword">new</span> Wheel235(<span class="hljs-string">"./primes.dat"</span>);<font></font>
        DateTime end = DateTime.UtcNow;<font></font>
        Console.WriteLine(<span class="hljs-string">$"Database of prime numbers up to <span class="hljs-subst">{loaded.Length:N0}</span> loaded from file to memory  in <span class="hljs-subst">{end - start}</span>"</span>);
        <span class="hljs-keyword">long</span> number = <span class="hljs-number">98</span>_000_000_093L;<font></font>
        Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{number:N0}</span> is <span class="hljs-subst">{(loaded.IsPrime(number) ? <span class="hljs-string">"prime"</span> : <span class="hljs-string">"not prime"</span>)}</span>!"</span>);
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de504578/index.html">Wie Amerikaner Million√§re werden: FEUERprinzipien</a></li>
<li><a href="../de504582/index.html">HackTheBox. Walkthrough Resolute. Passwort spr√ºhen. Von DnsAdmin zu SYSTEM</a></li>
<li><a href="../de504586/index.html">ES2020 Innovationen, die ich wirklich mag</a></li>
<li><a href="../de504590/index.html">Reine PHP-Architektur. Wie kann man es messen und steuern?</a></li>
<li><a href="../de504592/index.html">PuppetConf 2016. Kubernetes f√ºr Systemadministratoren. Teil 3</a></li>
<li><a href="../de504600/index.html">Was die Fluggesellschaft nach der Krise erwartet: Warren Buffetts Meinung</a></li>
<li><a href="../de504602/index.html">Telemetrie ‚Üí spannungsfreie Metriken</a></li>
<li><a href="../de504604/index.html">Was passiert heute auf dem Markt f√ºr Videodienste?</a></li>
<li><a href="../de504612/index.html">M√∂glicherweise ben√∂tigen Sie Svelte nicht, um Ihr JavaScript zu reduzieren</a></li>
<li><a href="../de504622/index.html">Was macht Rust zu einer universellen Programmiersprache?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>