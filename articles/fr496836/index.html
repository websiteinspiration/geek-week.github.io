<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç∫ üë®üèæ‚Äç‚úàÔ∏è üíô QSerializer: solution pour une s√©rialisation JSON / XML simple „äôÔ∏è üë©üèø‚Äç‚öïÔ∏è üêò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Je pensais que cela se r√©v√©lait injustement - en Java, C #, Go, Python, etc. Il existe des biblioth√®ques pour une s√©rialisation con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>QSerializer: solution pour une s√©rialisation JSON / XML simple</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496836/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pensais que cela se r√©v√©lait injustement - en Java, C #, Go, Python, etc. </font><font style="vertical-align: inherit;">Il existe des biblioth√®ques pour une s√©rialisation confortable des donn√©es d'objet en JSON et XML d√©sormais √† la mode, mais en C ++, ils ont oubli√©, ou ne voulaient pas, ou n'en avaient pas vraiment besoin, ou si tout cela est compliqu√©, ou peut-√™tre tous ensemble. </font><font style="vertical-align: inherit;">J'ai donc d√©cid√© de r√©parer ce truc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les d√©tails, comme d'habitude, sous la coupe.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j9/cp/vw/j9cpvwvjh9gfvhqxigysyx7m78c.png" alt="image"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois de plus, j'ai d√©cid√© de reprendre le prochain projet pour animaux de compagnie, dont l'essence √©tait l'√©change client-serveur, tandis que le serveur pr√©f√©r√© de beaucoup √©tait RaspberryPi. Entre autres choses, je m'int√©ressais √† la question de la cr√©ation de ¬´points de sauvegarde¬ª - afin que je puisse le plus simplement possible, dans le cadre du prototype, enregistrer l'√©tat de l'objet avant de quitter et de r√©cup√©rer au prochain d√©marrage. En raison de mon hostilit√© d√©raisonnable envers Python et de mon attitude tr√®s chaleureuse envers Qt, j'ai choisi Qt &amp; C ++. √âcrire des classes et des fonctions spaghetti pour analyser JSON est toujours un plaisir, j'avais besoin d'une solution universelle et en m√™me temps facile √† mon probl√®me. "Nous devons comprendre", me suis-je dit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, un peu sur les termes:</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La s√©rialisation est le processus de traduction d'une structure de donn√©es en une s√©quence de bits. </font><font style="vertical-align: inherit;">L'inverse de l'op√©ration de s√©rialisation est l'op√©ration de d√©s√©rialisation (structuration) - la restauration de l'√©tat initial de la structure de donn√©es √† partir d'une s√©quence de bits.</font></font><br>
</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go a un package d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encodage / json</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬´natif¬ª tr√®s utile </font><font style="vertical-align: inherit;">qui vous permet de terminer la s√©rialisation de l'objet en utilisant la m√©thode Marshal et la structuration inverse en utilisant Unmarshal (√† cause de cette biblioth√®que, j'ai d'abord eu une id√©e incorrecte sur le marshaling, mais </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desine sperare qui hic intras</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) . </font><font style="vertical-align: inherit;">En suivant les concepts de ce paquet, j'ai trouv√© une autre biblioth√®que pour Java - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GSON</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui s'est av√©r√©e √™tre un produit tr√®s agr√©able, c'√©tait un plaisir de l'utiliser.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai r√©fl√©chi √† ce que j'aime de ces biblioth√®ques et suis arriv√© √† la conclusion que c'√©tait leur facilit√© d'utilisation. Fonctionnalit√© flexible et tout en un appel, pour la s√©rialisation en JSON, il suffisait d'appeler la m√©thode toJson et de lui passer l'objet s√©rialisable. Cependant, C ++ lui-m√™me n'a pas, par d√©faut, les capacit√©s de m√©taobjet appropri√©es pour fournir suffisamment d'informations sur les champs d'une classe, comme cela se fait, par exemple, en Java (ClassName.class). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'aimais </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QJson que pour la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plate </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">forme Qt </font><font style="vertical-align: inherit;">, mais cela ne correspondait pas tout √† fait √† ma compr√©hension de la facilit√© d'utilisation g√©n√©r√©e par les biblioth√®ques susmentionn√©es. Le projet est donc apparu, qui sera discut√© ici. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Petit avertissement:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de tels m√©canismes ne r√©soudront pas pour vous le probl√®me de l'interpr√©tation des donn√©es. </font><font style="vertical-align: inherit;">Tout ce que vous pouvez en tirer, c'est la conversion des donn√©es sous une forme plus pratique pour vous.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structure du projet QSerializer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le projet et les exemples peuvent √™tre consult√©s sur GitHub ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien vers le r√©f√©rentiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Des instructions d'installation d√©taill√©es y sont √©galement fournies. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anticipant le suicide architectural, je ferai une r√©serve que ce n'est pas la version finale. </font><font style="vertical-align: inherit;">Les travaux se poursuivront malgr√© les pierres abandonn√©es, mais en tenant compte des souhaits.</font></font><br>
<img src="https://habrastorage.org/webt/lg/rp/op/lgrpopckj4waexmewif_u2zngf4.png" alt="D√©pendances structurelles g√©n√©rales de la biblioth√®que QSerializer"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'objectif principal de ce projet est de rendre la s√©rialisation √† l'aide d'un format de donn√©es convivial en C ++ accessible et √©l√©mentaire. </font><font style="vertical-align: inherit;">La cl√© du d√©veloppement de la qualit√© et de la maintenance du produit est son architecture. </font><font style="vertical-align: inherit;">Je n'exclus pas que d'autres modes de mise en ≈ìuvre puissent appara√Ætre dans les commentaires de cet article, j'ai donc laiss√© un peu ¬´d'espace pour la cr√©ativit√©¬ª. </font><font style="vertical-align: inherit;">Si vous modifiez l'impl√©mentation, vous pouvez soit ajouter une nouvelle impl√©mentation de l'interface PropertyKeeper, soit modifier les m√©thodes d'usine afin de ne rien changer dans les fonctions QSerializer.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©claration de champ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fa√ßon de collecter des informations sur les m√©ta-objets dans Qt est de les d√©crire dans le syst√®me de m√©ta-objets de Qt lui-m√™me. </font><font style="vertical-align: inherit;">C'est peut-√™tre le moyen le plus simple. </font></font><abbr title="Compilateur de m√©ta-objets"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOC</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> g√©n√©rera toutes les m√©tadonn√©es n√©cessaires au moment de la compilation. </font><font style="vertical-align: inherit;">Vous pouvez appeler la m√©thode metaObject sur l'objet d√©crit, qui renverra une instance de la classe QMetaObject, avec laquelle nous devons travailler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©clarer des champs √† s√©rialiser, vous devez h√©riter la classe de QObject et y inclure la macro </font></font><font color="#FF1493"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q_OBJECT</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , afin d'indiquer clairement au MOC la qualification du type de classe en tant que type de base de QObject. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, la macro </font></font><font color="#FF1493"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q_PROPERTY</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©crit les membres de la classe. </font><font style="vertical-align: inherit;">Nous appellerons la </font><font style="vertical-align: inherit;">propri√©t√© propri√©t√© </font><font style="vertical-align: inherit;">d√©crite dans </font></font><font color="#FF1493"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q_PROPERTY</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">QSerializer ignorera la propri√©t√© sans que l'indicateur USER soit d√©fini sur true.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi le drapeau USER</font></font></b>
                        <div class="spoiler_text">     , ,  QML.        . ,   <font color="#FF1493">Q_PROPERTY</font>  QML   QSerializer     .<br>
</div>
                    </div><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> :</span> <span class="hljs-keyword">public</span> QObject<font></font>
{<font></font>
Q_OBJECT<font></font>
<span class="hljs-comment">// Define data members to be serialized</span>
Q_PROPERTY(QString name MEMBER name USER <span class="hljs-literal">true</span>)<font></font>
Q_PROPERTY(<span class="hljs-keyword">int</span> age MEMBER age USER <span class="hljs-literal">true</span>)<font></font>
Q_PROPERTY(QString email MEMBER email USER <span class="hljs-literal">true</span>)<font></font>
Q_PROPERTY(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;QString&gt; phone MEMBER phone USER <span class="hljs-literal">true</span>)<font></font>
Q_PROPERTY(<span class="hljs-keyword">bool</span> vacation MEMBER vacation USER <span class="hljs-literal">true</span>)
<span class="hljs-keyword">public</span>:
  <span class="hljs-comment">// Make base constructor</span><font></font>
  User() { }<font></font>
 <font></font>
  QString name;<font></font>
  <span class="hljs-keyword">int</span> age{<span class="hljs-number">0</span>};<font></font>
  QString email;<font></font>
  <span class="hljs-keyword">bool</span> vacation{<span class="hljs-literal">false</span>};
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;QString&gt; phone; <font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©clarer des types d'utilisateurs non standard dans le syst√®me de m√©ta-objets Qt, je sugg√®re d'utiliser la macro </font></font><font color="#FF1493"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QS_REGISTER</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est d√©finie dans qserializer.h. </font></font><font color="#FF1493"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QS_REGISTER</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> automatise le processus d'enregistrement des variations de type. </font><font style="vertical-align: inherit;">Cependant, vous pouvez utiliser la m√©thode classique d'enregistrement de types avec qRegisterMetaType &lt; </font></font><font color="#FF1493"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; (). </font><font style="vertical-align: inherit;">Pour un syst√®me de m√©ta-objet, le type de classe ( </font></font><font color="#FF1493"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) et le pointeur de classe ( </font></font><font color="#FF1493"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> *) sont des types compl√®tement diff√©rents; ils auront des identifiants diff√©rents dans la liste des types g√©n√©raux.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> QS_METATYPE(Type) qRegisterMetaType<span class="hljs-meta-string">&lt;Type&gt;(#Type) ;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> QS_REGISTER(Type)       \
QS_METATYPE(Type)               \
QS_METATYPE(Type*)              \
QS_METATYPE(std::vector<span class="hljs-meta-string">&lt;Type*&gt;) \</span></span>
QS_METATYPE(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;Type&gt;)  \
</code></pre><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>;</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
<span class="hljs-comment">// define user-type in Qt meta-object system</span><font></font>
QS_REGISTER(User)<font></font>
...<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espace de noms QSerializer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir sur le diagramme UML, QSerializer contient un certain nombre de fonctions de s√©rialisation et de structuration. </font><font style="vertical-align: inherit;">L'espace de noms refl√®te conceptuellement l'essence d√©clarative de QSerializer. </font><font style="vertical-align: inherit;">La fonctionnalit√© int√©gr√©e est accessible via le nom de QSerializer, sans avoir besoin de cr√©er un objet n'importe o√π dans le code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant l'exemple de construction de JSON bas√© sur l'objet de la classe User d√©crit ci-dessus, il vous suffit d'appeler la m√©thode QSerializer :: toJson:</font></font><br>
<br>
<pre><code class="cpp hljs">User u;<font></font>
u.name = <span class="hljs-string">"Mike"</span>;<font></font>
u.age = <span class="hljs-number">25</span>;<font></font>
u.email = <span class="hljs-string">"example@exmail.com"</span>;<font></font>
u.phone.push_back(<span class="hljs-string">"+12345678989"</span>);<font></font>
u.phone.push_back(<span class="hljs-string">"+98765432121"</span>);<font></font>
u.vacation = <span class="hljs-literal">true</span>;<font></font>
QJsonObject json = QSerializer::toJson(&amp;u);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici le JSON r√©sultant:</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Mike"</span>,
    <span class="hljs-attr">"age"</span>: <span class="hljs-number">25</span>,
    <span class="hljs-attr">"email"</span>: <span class="hljs-string">"example@exmail.com"</span>,
    <span class="hljs-attr">"phone"</span>: [
        <span class="hljs-string">"+12345678989"</span>,
        <span class="hljs-string">"+98765432121"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"vacation"</span>: <span class="hljs-literal">true</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe deux fa√ßons de structurer un objet:</font></font><br>
<br>
<ul>
<li><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous devez modifier un objet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs">User u;<font></font>
QJsonObject userJson;<font></font>
QSerializer::fromJson(&amp;u, userJson);</code></pre></div>
                    </div></li>
<li><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous avez besoin d'obtenir un nouvel objet</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs">QJsonObject userJson;<font></font>
User * u = QSerializer::fromJson&lt;User&gt;(userJson);</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus d'exemples et de r√©sultats peuvent √™tre vus dans le dossier d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemples</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gardiens</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour organiser l'√©criture et la lecture pratiques des propri√©t√©s d√©clar√©es, QSerializer utilise des classes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keepers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , chacune d'entre elles stockant un pointeur sur un objet (descendant de QObject) et l'un de ses QMetaProperty. </font><font style="vertical-align: inherit;">QMetaProperty lui-m√™me n'a pas de valeur particuli√®re, en fait, c'est seulement un objet avec une description de la classe de propri√©t√©s qui a √©t√© d√©clar√©e pour le MOC. </font><font style="vertical-align: inherit;">Pour lire et √©crire, vous avez besoin d'un objet de classe sp√©cifique, o√π cette propri√©t√© est d√©crite - c'est la principale chose dont vous devez vous souvenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque champ s√©rialisable pendant la s√©rialisation est transmis au d√©positaire du type correspondant. </font><font style="vertical-align: inherit;">Des gardiens sont n√©cessaires pour encapsuler la fonctionnalit√© de s√©rialisation et de structuration pour une impl√©mentation sp√©cifique pour un type sp√©cifique de donn√©es d√©crites. </font><font style="vertical-align: inherit;">J'ai mis en √©vidence 4 types:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QMetaSimpleKeeper - gardien de propri√©t√© avec des types de donn√©es primitifs</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QMetaArrayKeeper - gardien de propri√©t√© avec des tableaux de donn√©es primitives</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QMetaObjectKeeper - gardien des objets imbriqu√©s</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QMetaObjectArrayKeeper - gardien des tableaux d'objets imbriqu√©s </font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/dw/ao/0d/dwao0de8yeaqdcdb5zfkbuoof-k.png" alt="Flux de donn√©es"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au c≈ìur des d√©positaires de donn√©es primitifs se trouve la conversion des informations de JSON / XML vers QVariant et vice versa, car QMetaProperty fonctionne avec QVariant par d√©faut.</font></font><br>
<br>
<pre><code class="cpp hljs">QMetaProperty prop;<font></font>
QObject * linkedObj;<font></font>
...<font></font>
<span class="hljs-function"><span class="hljs-built_in">std</span>::pair&lt;QString, QJsonValue&gt; <span class="hljs-title">QMetaSimpleKeeper::toJson</span><span class="hljs-params">()</span>
</span>{<font></font>
    QJsonValue result = QJsonValue::fromVariant(prop.read(linkedObj));<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::make_pair(QString(prop.name()), result);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">QMetaSimpleKeeper::fromJson</span><span class="hljs-params">(<span class="hljs-keyword">const</span> QJsonValue &amp;val)</span>
</span>{<font></font>
    prop.write(linkedObj, QVariant(val));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les conservateurs d'objets sont bas√©s sur le transfert d'informations de JSON / XML vers une s√©rie d'autres conservateurs et vice versa. </font><font style="vertical-align: inherit;">Ces d√©positaires travaillent avec leur propri√©t√© en tant qu'objet distinct, qui peut √©galement avoir ses propres d√©positaires, leur t√¢che consiste √† collecter des donn√©es s√©rialis√©es √† partir de l'objet propri√©t√© et √† structurer l'objet propri√©t√© en fonction des donn√©es disponibles.</font></font><br>
<br>
<pre><code class="cpp hljs">QMetaProperty prop;<font></font>
QObject * linkedObj;<font></font>
...<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">QMetaObjectKeeper::fromJson</span><span class="hljs-params">(<span class="hljs-keyword">const</span> QJsonValue &amp;json)</span>
</span>{<font></font>
    ...<font></font>
    QSerializer::fromJson(linkedObj, json.toObject());<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-built_in">std</span>::pair&lt;QString, QJsonValue&gt; <span class="hljs-title">QMetaObjectKeeper::toJson</span><span class="hljs-params">()</span>
</span>{<font></font>
    QJsonObject result = QSerializer::toJson(linkedObj);;<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::make_pair(prop.name(),QJsonValue(result));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les gardiens impl√©mentent l'interface PropertyKeeper, dont la classe abstraite de base des gardiens est h√©rit√©e. </font><font style="vertical-align: inherit;">Cela vous permet d'analyser et de composer des documents au format XML ou JSON s√©quentiellement de haut en bas, en descendant simplement les propri√©t√©s stock√©es d√©crites et en approfondissant lorsque vous descendez dans les objets incorpor√©s, le cas √©ch√©ant, dans les propri√©t√©s d√©crites, sans entrer dans les d√©tails de l'impl√©mentation.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface PropertyKeeper</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PropertyKeeper</span>
{</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">virtual</span> ~PropertyKeeper() = <span class="hljs-keyword">default</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-built_in">std</span>::pair&lt;QString, QJsonValue&gt; <span class="hljs-title">toJson</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fromJson</span><span class="hljs-params">(<span class="hljs-keyword">const</span> QJsonValue&amp;)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-built_in">std</span>::pair&lt;QString, QDomNode&gt; <span class="hljs-title">toXml</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fromXml</span><span class="hljs-params">(<span class="hljs-keyword">const</span> QDomNode &amp;)</span> </span>= <span class="hljs-number">0</span>;<font></font>
};<font></font>
</code></pre></div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guardian Factory</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que tous les d√©positaires impl√©mentent une interface, toutes les impl√©mentations sont masqu√©es derri√®re un √©cran pratique, et un ensemble de ces impl√©mentations est fourni par la fabrique KeepersFactory. </font><font style="vertical-align: inherit;">√Ä partir de l'objet transf√©r√© √† l'usine, vous pouvez obtenir une liste de toutes les propri√©t√©s d√©clar√©es via son QMetaObject, en fonction du type de d√©positaire d√©termin√©.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise en ≈ìuvre de KeepersFactory Factory</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs">    <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-keyword">simple_t</span> =<font></font>
    {<font></font>
        qMetaTypeId&lt;<span class="hljs-keyword">int</span>&gt;(),<font></font>
        qMetaTypeId&lt;<span class="hljs-keyword">bool</span>&gt;(),<font></font>
        qMetaTypeId&lt;<span class="hljs-keyword">double</span>&gt;(),<font></font>
        qMetaTypeId&lt;QString&gt;(),<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-keyword">array_of_simple_t</span> =<font></font>
    {<font></font>
        qMetaTypeId&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt;&gt;(),<font></font>
        qMetaTypeId&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">bool</span>&gt;&gt;(),<font></font>
        qMetaTypeId&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">double</span>&gt;&gt;(),<font></font>
        qMetaTypeId&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;QString&gt;&gt;(),<font></font>
    };<font></font>
...<font></font>
<span class="hljs-function">PropertyKeeper *<span class="hljs-title">KeepersFactory::getMetaKeeper</span><span class="hljs-params">(QObject *obj, QMetaProperty prop)</span>
</span>{
    <span class="hljs-keyword">int</span> t_id = QMetaType::type(prop.typeName());
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">std</span>::find(<span class="hljs-keyword">simple_t</span>.begin(), <span class="hljs-keyword">simple_t</span>.end(), t_id) != <span class="hljs-keyword">simple_t</span>.end())
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QMetaSimpleKeeper(obj,prop);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">std</span>::find(<span class="hljs-keyword">array_of_simple_t</span>.begin(),<span class="hljs-keyword">array_of_simple_t</span>.end(), t_id) != <span class="hljs-keyword">array_of_simple_t</span>.end())<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span>( t_id == qMetaTypeId&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt;&gt;())
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QMetaArrayKeeper&lt;<span class="hljs-keyword">int</span>&gt;(obj, prop);<font></font>
<font></font>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(t_id == qMetaTypeId&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;QString&gt;&gt;())
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QMetaArrayKeeper&lt;QString&gt;(obj, prop);<font></font>
<font></font>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(t_id == qMetaTypeId&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">double</span>&gt;&gt;())
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QMetaArrayKeeper&lt;<span class="hljs-keyword">double</span>&gt;(obj, prop);<font></font>
<font></font>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(t_id == qMetaTypeId&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">bool</span>&gt;&gt;())
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QMetaArrayKeeper&lt;<span class="hljs-keyword">bool</span>&gt;(obj, prop);<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
        QObject * castobj = qvariant_cast&lt;QObject *&gt;(prop.read(obj));<font></font>
        <span class="hljs-keyword">if</span>(castobj)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QMetaObjectKeeper(castobj,prop);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (QString(prop.typeName()).contains(<span class="hljs-string">"std::vector&lt;"</span>))<font></font>
        {<font></font>
            QString t = QString(prop.typeName()).remove(<span class="hljs-string">"std::vector&lt;"</span>).remove(<span class="hljs-string">"&gt;"</span>);
            <span class="hljs-keyword">int</span> idOfElement = QMetaType::type(t.toStdString().c_str());
            <span class="hljs-keyword">if</span>(QMetaType::typeFlags(idOfElement).testFlag(QMetaType::PointerToQObject))
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QMetaObjectArrayKeeper(obj, prop);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">throw</span> QSException(UnsupportedPropertyType);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;PropertyKeeper *&gt; <span class="hljs-title">KeepersFactory::getMetaKeepers</span><span class="hljs-params">(QObject *obj)</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;PropertyKeeper*&gt; keepers;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; obj-&gt;metaObject()-&gt;propertyCount(); i++)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span>(obj-&gt;metaObject()-&gt;property(i).isUser(obj))<font></font>
            keepers.push_back(getMetaKeeper(obj, obj-&gt;metaObject()-&gt;property(i)));<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> keepers;<font></font>
}<font></font>
...<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une caract√©ristique cl√© de la fabrique de gardiens est la possibilit√© de fournir une s√©rie compl√®te de gardiens pour un objet, et vous pouvez √©tendre la liste des types primitifs pris en charge en modifiant des collections constantes avec des identificateurs de type. </font><font style="vertical-align: inherit;">Chaque s√©rie de gardiens est une sorte de carte pour les propri√©taires de l'objet. </font><font style="vertical-align: inherit;">Lorsqu'un objet KeepersFactory est d√©truit, la m√©moire allou√©e √† la s√©rie de keepers qu'il fournit est lib√©r√©e.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limitations et comportement</font></font></h2><div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Situation</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comportement</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenter de s√©rialiser un objet dont le type n'est pas h√©rit√© de QObject</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erreur de compilation</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type non d√©clar√© lors d'une tentative de s√©rialisation / struturisation</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exception QSException :: UnsupportedPropertyType</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une tentative de s√©rialiser / structurer un objet avec un type primitif diff√©rent de celui d√©crit dans les collections simple_t et array_of_simple_t.</font></font></td>
<td> QSException::UnsupportedPropertyType.    ,     ‚Äî     ,   </td>
</tr>
<tr>
<td> JSON/XML   </td>
<td>  </td>
</tr>
<tr>
<td>   propertyes,    JSON/XML</td>
<td> propertyes .       ‚Äî  propertyes          </td>
</tr>
<tr>
<td>      JSON  property </td>
<td> QSException</td>
</tr>
</tbody></table></div><br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä mon avis, le projet s'est av√©r√© utile, car cet article a √©t√© √©crit. </font><font style="vertical-align: inherit;">Pour ma part, j'ai conclu qu'il n'y a pas de solutions universelles, il faut toujours sacrifier quelque chose. </font><font style="vertical-align: inherit;">En d√©veloppant une flexibilit√©, en termes d'utilisation, de fonctionnalit√©, vous tuez la simplicit√©, et vice versa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne vous conseille pas d'utiliser QSerializer, mon objectif est plut√¥t mon propre d√©veloppement en tant que programmeur. </font><font style="vertical-align: inherit;">Bien s√ªr, je poursuis √©galement l'objectif d'aider quelqu'un, mais en premier lieu - simplement me faire plaisir. </font><font style="vertical-align: inherit;">Sois positif)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496824/index.html">Votre environnement de travail nordique</a></li>
<li><a href="../fr496826/index.html">Des millions de sprites √† plus de 120 images par seconde</a></li>
<li><a href="../fr496828/index.html">O√π trouver des freelances qui seront amusants? (Spoiler: pas Upwork)</a></li>
<li><a href="../fr496830/index.html">Qu'est-ce que la communication √©mergente et pourquoi vous devez savoir</a></li>
<li><a href="../fr496832/index.html">Visite photo: que font-ils dans le laboratoire de nanophotonique hybride et d'opto√©lectronique du New Physics Institute ITMO</a></li>
<li><a href="../fr496838/index.html">M√©thodologie de d√©ploiement de projet utilis√©e par Slack</a></li>
<li><a href="../fr496840/index.html">Musk pense que 12 000 satellites n'interf√©reront pas avec les astronomes. Son opinion n'est pas conforme au mod√®le</a></li>
<li><a href="../fr496842/index.html">Un mod√®le √©pid√©mique simple avec des outils de base Python</a></li>
<li><a href="../fr496846/index.html">M√©canique du langage des piles et des pointeurs</a></li>
<li><a href="../fr496848/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 340 (du 6 au 12 avril)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>