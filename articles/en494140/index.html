<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèº üìè üìú Investigating a DNSpionage Campaign Using Cisco Threat Response, Including Remote Work üÜó üïí üë©üèª‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I‚Äôve already talked about the free Cisco Threat Response (CTR) solution, which can significantly reduce the time to investigate incidents characterize...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Investigating a DNSpionage Campaign Using Cisco Threat Response, Including Remote Work</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/cisco/blog/494140/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I‚Äôve already talked about the free Cisco Threat Response (CTR) solution, which can significantly reduce the time to investigate incidents characterized by many different types of compromise indicators - file hashes, IP addresses, domain names, e-mail addresses, etc. But past notes were devoted either to examples of using CTR with separate Cisco solutions, or to its integration with GosSOPKA and FinCERT. Today I would like to describe how CTR can be used to investigate individual hacker campaigns that can use many vectors against many different goals within the company. As an example, take the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DNSpionage campaign</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I mentioned in a previous article </font><font style="vertical-align: inherit;">.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Last time I showed how it can be detected with just one solution - the Cisco Stealthwatch Enterprise network anomaly analysis system. Then we recorded the interaction of the malicious client part with the command server using the DNS protocol, which served as an indicator if it was used on unauthorized nodes within the corporate network. In fact, we looked for anomalies in network traffic to look for signs of an incident. Now let's see how to identify the DNSpionage campaign using more familiar indicators of malicious activity (IOC)? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can see the list of indicators in any Threat Intelligence bulletin. In this case, we will use the site of Cisco Talos, the largest non-governmental incident investigation group in the world, which first revealed the DNSpionage campaign (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/if/ov/-1/ifov-1vhdwekrvyy45jaovtiix4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the newsletter we see a list of indicators - file hashes, IP and domain addresses of the command and phishing servers involved in the attack. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/dy/bv/xpdybvedg1uraqxn0yo2m1ehzpy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we ‚Äúdrive‚Äù each of the indicators through appropriate means of protection, then it will take us too long. For example, in Cisco AMP for Endpoints, a solution of the EDR class, we enter one or several hashes of interest to us in the search bar (top right): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jd/us/2b/jdus2bkm5mu_b4s0l1cdnr9vtri.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and we get the result we are interested in - we found a node on which the activity of the malicious program was detected for which we have the hash .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/ea/6q/tlea6qaed_a8kcopyzzfepcx07m.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, I want to note that hash search can be used not only to detect malicious activity, but also to combat information leaks. Recall that one of the technologies for dealing with leaks (along with containers / tags and content analysis) is the use of digital fingerprints, which can be implemented using just the hashes that AMP4E will control (as well as other Cisco solutions, which may include implemented AMP engine - Cisco Firepower, Cisco Email Security Appliance, Cisco Web Security Appliance, Cisco Umbrella, etc.). True, such a mechanism works only for rarely modified files. If you are interested in what Cisco offers to deal with leaks, I can recommend </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recording</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presentation.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">our latest webinar, which we dedicated to this topic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But back to our story. </font><font style="vertical-align: inherit;">If you try to track access to the domains of command or phishing servers, then Cisco Umbrella can help us. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c2/1x/gx/c21xgx-dvavn5o9cgpjurhzr4mm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the main vector of infection in most incidents is email, we also need to look for indicators of interest to us in e-mail. </font><font style="vertical-align: inherit;">To do this, we indicate the hash of the corresponding indicator in the Cisco Security Management Appliance or the Cisco E-mail Security Appliance: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yg/ul/r8/ygulr8dih6q_5u4xb77qmdel2eq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and we find 5 mailboxes in which traces of the files we are looking for are found.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fy/zm/pf/fyzmpftvdwyxm2gejaovdfsgmb0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, Cisco Firepower, the next-generation firewall with built-in intrusion prevention system, helps us track (and block) the IP addresses that the client part of the malicious campaign interacts with.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yn/zk/y7/ynzky7yzkvxxrhipzos4ypgu7iu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this example, although we detect the signs of DNSpionage, we are not doing it as fast as we wanted. We are switching between consoles. We carry out many copy-past operations and 4 different products are looking for 4 different types of indicators of compromise, thereby increasing the time for investigation and response. Can this process be accelerated? Of course. You can use SIEM, which can be integrated with TI sources, or into which you can download indicators of compromise from external TI sources. But it is expensive if it is commercial, or requires high competencies, if it is from the category of open source. There is a simpler and all the more free solution - Cisco Threat Response, which is focused primarily on Cisco solutions, as well as on solutions of other vendors.Using the browser plug-in, we ‚Äúpull‚Äù all indicators from the Cisco Talos blog page describing the DNSpionage campaign.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vk/wz/sh/vkwzshjii1wgjxmth16plgfxb5e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To speed up the response process, we can block the relevant indicators directly through the plugin. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w1/jw/iw/w1jwiwoxjpkmmvm_is3eunkjnga.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we are interested in investigating the incident in an attempt to understand which of our nodes and users were compromised. And it is advisable to see everything on one screen. CTR just gives us this opportunity. In the upper left of the graphical interface, we see all our indicators. In the lower left - a map of our "infection".</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qb/p9/mr/qbp9mrufw-sj1vki2ofqyyuemgo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The purple color shows already affected targets in our infrastructure - PCs, mailboxes, subnets, etc. In the upper right part we see a timeline that displays the dates of the appearance (including the first) of indicators in our network environment. Finally, the lower right area allows us to get detailed information on each indicator, enriched and verified by external TI sources, for example, VirusTotal, or third-party protection tools. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/l9/jx/yq/l9jxyqsjricd3smbegy3su8hsoy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having understood the extent of the infection, we can begin to respond appropriately to the identified threat by blocking its occurrence through Cisco Umbrella, which blocks interaction with command server domains: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/0c/ac/xp0cactpyjnuh4dnluuvjediqhg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
or through Cisco AMP for Endpoints, which isolates the operation of a malicious file or process.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/un/jz/mo/unjzmo-jhiuzledetjvf-t_q5fy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immediately from the CTR interface, we can see the result of blocking a file, domain or other indicator. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hk/qa/jo/hkqajo70ap-vqaw4gc51wfulglg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By integrating CTR with the Cisco E-mail Security Appliance or Cisco Firepower, we can also isolate infected mailboxes or compromised sites, respectively. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Is it possible to do the same thing, but without using the Cisco Threat Response interface? Sometimes you want to use your own, more familiar tools for this. Yes you can. For example, we can embed CTR functionality in any technology that supports a browser (for example, in our own portal), and due to the availability of APIs, CTR functions can be accessed from anywhere.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose you prefer a command line interface and want to investigate and respond by entering all the commands from the keyboard. This is also easy to do. For example, here's how CTR integration works with the Cisco Webex Teams teamwork system and the AskWill bot developed for it using the DNSpionage campaign as an example. Cisco Webex Teams is often used by our customers to organize the interaction of security professionals. This example is all the more interesting because it shows how you can build a process of investigation and response when working remotely, when, the only thing that unites SOC specialists is a communication system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we want to get the status for the domain 0ffice36o.com, which was used by the command server as part of DNSpionage. We see that Cisco Umbrella returns us the status of "malicious".</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g6/ml/p6/g6mlp61yd2fe8a1lr48j2kwvgju.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is how the team will look for information on whether there are several indicators of compromise for the DNSpionage campaign identified by Cisco Talos in our infrastructure at once. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/aw/2l/ax/aw2laxyma1otgdyvtp5ewi1sduu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we can block the malicious domain through Cisco Umbrella or Cisco Stealthwatch Cloud. In the latter case, the anomaly analysis system will block interaction with the command server for the Amazon AWS, MS Azure cloud infrastructures we use, etc. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kz/yp/ba/kzypbayjmcv56maxri4jjmblzgq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, if we mistakenly blocked an indicator, or over time it became known that it has ceased to pose a threat, we can remove it from the black list of protective solutions.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bh/a5/rs/bha5rsgaph_on7cm55cbvucvm5c.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is how the free Cisco Threat Response solution works, whose main task is to reduce the time to investigate and respond to incidents. </font><font style="vertical-align: inherit;">And as our customers say, CTR allows them to significantly reduce it. </font><font style="vertical-align: inherit;">60% of users have a reduction of 50%; </font><font style="vertical-align: inherit;">another 23% have at least 25%. </font><font style="vertical-align: inherit;">Not bad for a free solution, huh ?!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Additional Information:</font></font></h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integration of Cisco Threat Response and Cisco Stealthwatch Enterprise</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interaction of Cisco solutions in GosSOPKoy and FinCERT</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why doesn't Cisco buy Splunk or a talk about how the Cisco platform works for threat hunting</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Threat Hunting with Cisco Visibility</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case Studies for Using Network Anomaly Analysis Tools: DNSpionage Campaign Discovery</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494128/index.html">Hackspace Neuron - a meeting place for hackers in Moscow</a></li>
<li><a href="../en494130/index.html">What happens to online events: some of our statistics</a></li>
<li><a href="../en494132/index.html">Befunge compiler in Python</a></li>
<li><a href="../en494136/index.html">What to drip in the eye, so as not to itch</a></li>
<li><a href="../en494138/index.html">Human rights and algorithms: copyright brute force will not work in the USA, Australia, Russia and the EU</a></li>
<li><a href="../en494150/index.html">ClickHouse in Avito: live gatherings with Alexey Milovidov</a></li>
<li><a href="../en494152/index.html">HoughNet: Search for vanishing points fused with a classic algorithm</a></li>
<li><a href="../en494154/index.html">How we accelerated video encoding eight times</a></li>
<li><a href="../en494156/index.html">How to work from home - the experience of Plesk removers</a></li>
<li><a href="../en494158/index.html">How to maintain the quality of work under quarantine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>