<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔞 ⚡️ 📢 并非没有运动的一天：重新编程中国心率监测器 🅰️ 🚶🏼 ♥️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="“听着，慢跑时应该有什么样的心率？” 
 -好吧，我不知道-150首
 -是吗？为什么我有840？
 -每分钟840吗？！
 -什么，有必要考虑一下还是什么？
 “你觉得呢？” 
 “好吧，我只是数了数，直到迷路了……所以，好吧，我去点票了。” 
 （电影“选举日”）
 
 几乎与中国的心率监测器有...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>并非没有运动的一天：重新编程中国心率监测器</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493384/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“听着，慢跑时应该有什么样的心率？” </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-好吧，我不知道-150首</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-是吗？为什么我有840？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-每分钟840吗？！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-什么，有必要考虑一下还是什么？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“你觉得呢？” </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“好吧，我只是数了数，直到迷路了……所以，好吧，我去点票了。” </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（电影“选举日”）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
几乎与中国的心率监测器有关。俗话说，如果你想做点好事，那就自己去做。并且，如果该设备无法正常运行，那么是否有可能对其进行改进？</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fe/pp/23/fepp230sxqy_lyvvcnoihcc1_ey.png"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
许多对运动感兴趣的人在运动过程中会监控自己的心率。</font><font style="vertical-align: inherit;">为此，使用心率监测器。</font><font style="vertical-align: inherit;">本文的任务不是考虑所有类型，而是最可靠和最可靠的方法之一是从心脏接收电信号的胸部脉冲传感器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了增加我的运动量，还购买了</font><font style="vertical-align: inherit;">Kyto 2809 </font></font><abbr title="心率"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">心率</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">监测器</font><font style="vertical-align: inherit;">，脉搏很好，但需要精确测量RR间隔。</font><font style="vertical-align: inherit;">心率监测器支持两种协议：ANT +和BLE。</font><font style="vertical-align: inherit;">根据规范，除了直接心跳速率外，这两者都传输RR间隔的持续时间。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">什么是RR间隔</font></font></b><div class="spoiler_text">RR  –     R    .<br>
<br>
<img src="https://habrastorage.org/webt/yd/in/ea/ydineadtr4darurwgdkucttqlse.png"><br>
 RR   ,  .     .        ,   (.    «  RR »   « »).         .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了记录来自两个渠道的数据，编写了一个Android应用程序来满足您的需求，同时将数据日志记录到文本文件中。</font><font style="vertical-align: inherit;">模拟心率监测器作为或多或少合适的标准发送，以5.3 kHz的频率发送信号，并通过arduino直接连接到PC。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一次比较有点难过。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kf/yp/xw/kfypxwjqzbjd1jif9yp-dh9kto0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一次实际心跳的“设备”显示4-5不存在（在蓝色图表上，您可以看到很多点）。</font><font style="vertical-align: inherit;">即使考虑到可能的平均值，该脉冲也不会准确发光。</font><font style="vertical-align: inherit;">关于测量RR语音间隔完全没有用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
与制造商的沟通并没有带来结果。</font><font style="vertical-align: inherit;">除了几个视频之外，还试图说服我一切都很好，并说出“ KYTO2809心率数据准确！”的字样，但我没有从中得到任何帮助。</font><font style="vertical-align: inherit;">然后他的目光用螺丝刀落在盒子上。</font><font style="vertical-align: inherit;">打开盒子，我发现了nRF51422芯片。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/au/wi/0b/auwi0bchg8cuiqj74jaz-elv49g.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
知道有用于这些MK的SDK后，我决定尝试对其进行刷新。</font><font style="vertical-align: inherit;">那里需要最简单的程序：从心脏电信号的放大器（照片中的黑点）开始，信号进入MK输入，这是技术问题，我们通过中断捕获脉冲，测量它们之间的时间，并通过BLE和ANT +显示所有这些。</font><font style="vertical-align: inherit;">一切都很简单，但是中国程序员显然出了点问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些芯片通过SWD编程。</font><font style="vertical-align: inherit;">本机固件受到保护，无法读取。</font><font style="vertical-align: inherit;">因此，毫不犹豫地执行了命令</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ format c：”</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> “-eraseall”。</font><font style="vertical-align: inherit;">面板甚至显示相应的联系人。</font><font style="vertical-align: inherit;">来自心脏的电信号的放大器的输入P0.07。</font><font style="vertical-align: inherit;">BLE模块本身的引脚排列是（从上到下）：</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地线</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vdd</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.30</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.00</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.01</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.02</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.03</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.04</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.05</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.06</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.07</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P0.08</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SDK包含许多足以编写您自己的固件的示例。该芯片已经很旧了，其SDK也已经过时，版本为10。使用它们，在心率监测器上提高了BLE服务：设备信息，电池服务，心率。已为ANT +添加HeartRate配置文件。我们使用计时器测量RR间隔，将数据发送到BLE和ANT +配置文件。为了在没有外部刺激的情况下（5秒内）节省电荷，心率监测器进入睡眠模式。当出现脉冲（输入中断）时，MK唤醒。在制造商的固件中，Kyto2809不断通过BLE传输广告数据包，即仅使用ANT +通道时，BLE继续发送数据包并耗尽电池电量。我将广告时间限制为5分钟，这应该会对盈利产生积极影响。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
测试表明，对于“计算的心率”参数，最好引入滤波（故意丢弃不准确的数据，即低于30且高于240的脉冲）并以移动平均值进行平均。与下面的模拟心率监视器的最终比较。 RR间隔的测量差异为0-2 ms，这是完全可以接受的。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aa/rw/qw/aarwqwkdl2sg16sbflzjv2itsw0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在有用的功能中，添加了更新OTA固件（原始名称DFU OTA）的功能。</font><font style="vertical-align: inherit;">现在，已经缝制了OTA-bootloader，如果您想更改代码中的某些内容，就可以轻松更新固件。</font><font style="vertical-align: inherit;">固件是通过智能实用程序nRFConnect从智能手机完成的。</font><font style="vertical-align: inherit;">另外，如果我没记错的话，您可以在Android应用程序中提供OTA支持，这里有一些库。</font><font style="vertical-align: inherit;">不幸的是，要将引导加载程序填充到内存中，您需要通过SWD连接，因为 </font><font style="vertical-align: inherit;">OTA最初不是由制造商提供的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
固件顺序：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们缝了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SoftDevice310</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它是BLE和ANT + Nordic的堆栈；</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们缝了Kyto_DFU_bootloader.hex（可以组装箱子）；</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过nRFConnect填充完成的软件包kyto_hr_dfu.zip</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后两个文件在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">也有不带OTA的固件（KytoHR.hex）。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN493374/index.html">冠状病毒-实用技巧和理论知识</a></li>
<li><a href="../zh-CN493376/index.html">大倡议理论-俄罗斯工业企业数字化转型的经验</a></li>
<li><a href="../zh-CN493378/index.html">Steam有您：数字发行如何夺走我们的游戏</a></li>
<li><a href="../zh-CN493380/index.html">朱莉娅与量子计算</a></li>
<li><a href="../zh-CN493382/index.html">.NET Core Windows窗体设计器更新</a></li>
<li><a href="../zh-CN493386/index.html">冠状病毒如何治疗？</a></li>
<li><a href="../zh-CN493390/index.html">.NET 5预览版1简介</a></li>
<li><a href="../zh-CN493392/index.html">喀山的机器学习或Ta斯坦共和国的机器学习专家培训方式</a></li>
<li><a href="../zh-CN493394/index.html">上帝综合症：斯塔夫罗波尔地区冠状病毒的主要传染病专家如何传播的故事（a）*</a></li>
<li><a href="../zh-CN493396/index.html">预测方法摘要</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>