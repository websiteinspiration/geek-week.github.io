<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦕 🧑‍🤝‍🧑 ☝🏼 Evolusi pemrosesan webhook Facebook: dari nol menjadi 25.000 per detik 🤴🏾 🐼 🚔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kemungkinan besar, tidak ada yang perlu tahu apa itu webhooks. Tapi untuk berjaga-jaga: webhooks adalah mekanisme untuk melaporkan peristiwa dalam sis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Evolusi pemrosesan webhook Facebook: dari nol menjadi 25.000 per detik</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kemungkinan besar, tidak ada yang perlu tahu apa itu webhooks. Tapi untuk berjaga-jaga: webhooks adalah mekanisme untuk melaporkan peristiwa dalam sistem eksternal. Misalnya, tentang membeli di toko online melalui kasir online, mengirim kode ke repositori GitHub, atau tindakan pengguna dalam obrolan. Dalam API biasa, Anda harus terus-menerus meminta server jika pengguna menulis sesuatu di obrolan. Menggunakan mekanisme webhook, Anda dapat "berlangganan" pemberitahuan, dan server itu sendiri akan mengirim permintaan HTTP ketika suatu peristiwa terjadi. Ini lebih nyaman dan lebih cepat daripada terus-menerus meminta data baru di server.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChat adalah platform yang membantu bisnis berkomunikasi dengan pelanggan mereka melalui obrolan dalam pesan instan. Webhooks adalah salah satu bagian penting dari ManyChat, karena melalui merekalah bisnis berkomunikasi dengan pelanggan. Dan mereka banyak berkomunikasi - misalnya, melalui sistem, bisnis mengirim miliaran pesan sebulan ke pelanggan mereka. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagian besar pesan dikirim melalui Facebook Messenger. Ini memiliki fitur - API lambat. Ketika seorang pelanggan menulis pesan untuk memesan pizza, Facebook mengirimkan webhook ke ManyChat. Platform memprosesnya, mengirimkan permintaan kembali dan pengguna menerima pesan. Karena API lambat, beberapa permintaan berlangsung beberapa detik. Tetapi ketika platform tidak merespon untuk waktu yang lama, bisnis kehilangan klien, dan Facebook dapat memutuskan aplikasi dari webhooks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, memproses webhook adalah salah satu tugas rekayasa utama platform. </font><font style="vertical-align: inherit;">Untuk mengatasi masalah tersebut, ManyChat mengubah arsitektur pemrosesan beberapa kali selama tiga tahun dari pengontrol sederhana di Yii menjadi sistem terdistribusi dengan Galaksi. </font><font style="vertical-align: inherit;">Baca lebih lanjut tentang ini di bawah cut Dmitry Kushnikov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancellarius</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kushnikov memimpin pengembangan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan telah memprogram secara profesional dalam PHP sejak tahun 2001. </font><font style="vertical-align: inherit;">Dmitry akan memberi tahu Anda bagaimana arsitektur telah berubah seiring dengan pertumbuhan layanan dan beban, solusi dan teknologi apa yang diterapkan pada tahap yang berbeda, bagaimana pemrosesan webhook telah berkembang dan bagaimana platform mengelola untuk mengatasi beban yang sangat besar menggunakan sumber daya sederhana di PHP. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Catatan. </font><font style="vertical-align: inherit;">Artikel ini didasarkan pada laporan Dmitry "Evolusi pemrosesan webhook Facebook: dari nol menjadi 12.500 per detik" di </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russia 2019</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tetapi ketika dia sedang bersiap, indikator naik menjadi 25.000.</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa itu ManyChat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, saya akan memperkenalkan Anda ke dalam konteks tugas kami. ManyChat adalah layanan yang membantu bisnis menggunakan pesan instan untuk pemasaran, penjualan, dan dukungan. Produk utama adalah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">platform untuk Pemasaran Messenger di Facebook Messenger</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Selama tiga tahun, lebih dari 1 juta bisnis dari 100 negara di dunia menggunakan layanan ini untuk berkomunikasi dengan 700 juta pelanggan mereka. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di sisi klien,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sepertinya ini. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tombol, gambar, dan galeri dalam dialog di Facebook Messenger.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ini adalah antarmuka Facebook Messenger. Selain pesan teks, Anda dapat mengirim elemen interaktif di dalamnya untuk berinteraksi dengan pelanggan, terlibat dalam dialog, meningkatkan minat pada produk Anda dan menjual. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dari sisi bisnis</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semuanya terlihat berbeda. </font><font style="vertical-align: inherit;">Ini adalah antarmuka aplikasi web kami di mana, menggunakan antarmuka visual, perwakilan bisnis membuat dan skrip dialog program. </font><font style="vertical-align: inherit;">Gambar adalah salah satu contoh skenario. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jantung dari sistem kami adalah komponen Flow Builder. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rangkaian skrip dan aturan otomatisasi yang kami sebut </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Oleh karena itu, untuk mempermudah, kita dapat mengatakan bahwa ManyChat adalah desainer bot. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contoh bot. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klien bisnis yang berpartisipasi dalam dialog disebut </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pelanggan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , karena untuk interaksi klien </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">berlangganan bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa Facebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengapa Facebook Messenger, kami adalah negara Telegram yang masih hidup? </font><font style="vertical-align: inherit;">Ada alasan untuk ini.</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     №1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interaksi dengan Facebook diatur seperti ini: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bisnis menggunakan aplikasi web untuk mengonfigurasi logika bot. </font><font style="vertical-align: inherit;">Ketika klien berinteraksi dengan bot melalui telepon, Facebook menerima informasi tentang ini dan mengirimkan kepada kami webhook. </font><font style="vertical-align: inherit;">ManyChat memprosesnya, tergantung pada logika yang diprogram oleh bisnis, dan mengirimkan permintaan kembali. </font><font style="vertical-align: inherit;">Kemudian Facebook mengirimkan pesan ke ponsel pengguna.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tumpukan teknologi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami melakukan semua ini pada tumpukan sederhana. </font><font style="vertical-align: inherit;">Intinya, tentu saja, adalah PHP. </font><font style="vertical-align: inherit;">Server web menjalankan Nginx, basis data utamanya adalah PostgreSQL, dan ada juga Redis dan Elasticsearch. </font><font style="vertical-align: inherit;">Semuanya berputar di awan Amazon Web Services.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menangani Facebook Webhook</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti inilah tampilan webcam Facebook: ini adalah permintaan dengan payload dalam format JSON.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Webhook hanya 10% dari beban kami, tetapi merupakan bagian terpenting dari sistem. </font><font style="vertical-align: inherit;">Melalui mereka, bisnis berkomunikasi dengan pengguna. </font><font style="vertical-align: inherit;">Jika pesan melambat atau tidak terkirim, maka pengguna menolak untuk berinteraksi dengan bot, dan bisnis kehilangan klien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat evolusi arsitektur kita sejak peluncuran produk. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mei 2016</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Kami baru saja meluncurkan layanan kami: 20 bot, 10 di antaranya adalah yang uji, dan 20 pelanggan. </font><font style="vertical-align: inherit;">Muatannya adalah 0 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skema interaksi terlihat seperti ini:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permintaan masuk ke nginx.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx mengakses PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM membawa aplikasi hingga Yii.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontroler webhook memproses logika dan mengirimkan permintaan ke Facebook sesuai dengannya.</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sekelompok Nginx dan PHP-FPM</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juni 2016.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sebulan kemudian, kami mengumumkan ManyChat di ProductHunt dan jumlah bot meningkat menjadi 2 ribu. </font><font style="vertical-align: inherit;">Jumlah pelanggan telah meningkat menjadi 7 ribu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat ini, masalah pertama muncul di sistem. </font><font style="vertical-align: inherit;">API Facebook tidak terlalu cepat: beberapa permintaan bisa memakan waktu beberapa detik, dan beberapa permintaan bisa memakan waktu puluhan detik. </font><font style="vertical-align: inherit;">Tetapi server webhook ingin kita merespons dengan cepat. </font><font style="vertical-align: inherit;">Karena API lambat, kami tidak merespons untuk waktu yang lama: server pertama bersumpah, dan kemudian itu benar-benar dapat memutuskan aplikasi dari webhooks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada beberapa pengguna, kami masih mengembangkan aplikasi, kami mencari pasar kami, audiens, dan masalah pemuatan telah muncul. </font><font style="vertical-align: inherit;">Tetapi kami diselamatkan oleh solusi sederhana: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pada saat pengontrol dimulai, kami mengganggu akses ke Facebook</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Kami memberi tahu Facebook bahwa semuanya baik-baik saja, tetapi di latar belakang kami memproses permintaan dan webhook.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antrian di PostgreSQL</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desember 2016.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Layanan tumbuh 5-10 kali: 10 ribu bot dan 700 ribu pelanggan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat yang sama, kami mengerjakan tugas-tugas baru: menampilkan statistik, pengiriman pesan, konversi tayangan, dan transisi. </font><font style="vertical-align: inherit;">Juga menerapkan Obrolan Langsung. </font><font style="vertical-align: inherit;">Selain mengotomatisasi interaksi, itu memberi bisnis kemampuan untuk menulis pesan langsung ke pelanggan mereka. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusi untuk masalah ini meningkatkan jumlah kait dilacak sebanyak 4 kali. </font><font style="vertical-align: inherit;">Untuk setiap pesan yang kami kirim, kami menerima 3 kait web tambahan. </font><font style="vertical-align: inherit;">Sistem pemrosesan perlu ditingkatkan lagi. </font><font style="vertical-align: inherit;">Kami adalah platform kecil, hanya dua orang yang bekerja di backend, jadi kami memilih solusi paling sederhana - antrian di PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami belum ingin menerapkan sistem yang kompleks, jadi kami cukup membagikan alur pemrosesan. </font><font style="vertical-align: inherit;">Webhook yang perlu diproses dengan cepat sehingga pengguna menerima respons diproses secara sinkron. </font><font style="vertical-align: inherit;">Semua sisanya dikirim dalam antrian untuk permintaan asinkron.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antrian di Redis</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juni 2017.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Layanan tumbuh: 75 ribu bot, 7 juta pelanggan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami sedang mengimplementasikan fitur baru lainnya. Semua webhook yang kami proses hanya menyangkut komunikasi di messenger. Tetapi sekarang kami memutuskan untuk memberikan peluang bisnis kepada bisnis untuk berkomunikasi </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan pelanggan halaman bisnis</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan mulai memproses jenis-jenis webhook baru - yang terkait dengan umpan halaman itu sendiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Umpan halaman bisnis jarang diperbarui. Pemasar sering memposting sesuatu, kemudian mereka mengikuti setiap suka dan menghitungnya. Tidak ada lalu lintas besar di halaman bisnis. Tetapi ada situasi sebaliknya, misalnya, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hari Katy Perry</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Katy Perry adalah penyanyi Amerika terkenal dengan sejumlah besar penggemar di seluruh dunia. </font><font style="vertical-align: inherit;">Ada 64 juta pelanggan di grup Facebook-nya saja. </font><font style="vertical-align: inherit;">Pada titik tertentu, pemasar penyanyi memutuskan untuk membuat bot di Facebook Messenger dan memilih platform kami. </font><font style="vertical-align: inherit;">Pada saat itu, ketika mereka menerbitkan pesan panggilan untuk berlangganan bot, beban kami meningkat 3-4 kali. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Situasi ini membantu kami memahami bahwa tanpa implementasi antrian yang normal, kami tidak dapat melakukan apa pun. </font><font style="vertical-align: inherit;">Sebagai solusi, mereka memilih Redis.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memilih Redis untuk antrian adalah keputusan yang sangat bagus.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dia membantu memecahkan sejumlah besar masalah. Sekarang setiap detik melalui Redis-cluster kami melewati 1 juta permintaan berbeda. Kami menggunakannya tidak hanya untuk semua antrian kaskade, tetapi juga untuk tugas-tugas lain, misalnya, pemantauan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antrian di Redis tidak diterapkan pada percobaan pertama. Ketika kami mulai melipat kait web di Redis dan memprosesnya dalam satu proses, kami memperluas corong di atas: ada lebih banyak kait web masuk yang diproses juga, tetapi prosesnya sendiri masih membutuhkan waktu. Keputusan pertama ini tidak berhasil.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika mereka mencoba mengukur jumlah permintaan ini, ada sedikit keruntuhan. Antrian dapat mengakumulasi permintaan dari halaman yang berbeda, tetapi permintaan dari satu halaman dapat berjalan berurutan. Jika satu handler lambat, maka permintaan dari satu pelanggan dan dari satu bot akan diproses dalam urutan yang salah. Pengguna mengirim pesan, melakukan beberapa tindakan dengan bot, tetapi menerima respons secara acak. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini sepertinya kasus yang jarang, tetapi pengujian pada beban kerja kami telah menunjukkan bahwa ini akan sering terjadi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mulai mencari solusi lain. Di sini kesederhanaan dan kekuatan Redis datang untuk menyelamatkan - kami memutuskan untuk membuat </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antrian untuk setiap bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana itu bekerja? Pesan yang berhubungan dengan setiap bot ditambahkan ke antrian. Agar tidak menaikkan handler ke setiap antrian, kami membuat </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antrian kontrol</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dia bekerja seperti itu. Setiap kali permintaan datang dari bot, dua pesan diterbitkan di Redis: satu di antrian bot, yang kedua di kontrol. Pawang memonitor kontrol dan setiap kali memulai daemon ketika ada tugas untuk memproses bot. Iblis itu membuat antrian bot yang sesuai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain tugas utama, kami memecahkan masalah "tetangga yang bising". Ini adalah ketika satu bot menghasilkan sejumlah besar webhooks dan memperlambat sistem, karena halaman lain sedang menunggu untuk diproses. Untuk mengatasi masalah, cukup dengan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skala</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ketika antrian kontrol penuh, kami menambahkan penangan baru.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antriannya virtual</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini hanya sel dalam memori Redis. </font><font style="vertical-align: inherit;">Ketika tidak ada apa pun dalam antrian, itu tidak ada, itu tidak menempati apa pun.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Januari 2018</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Kami telah mencapai 1 miliar posting per bulan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bebannya 5 ribu RPS per sistem. Ini bukan beban puncak, tetapi standar. Ketika bot penyanyi terkenal muncul, semuanya tumbuh beberapa kali dari figur ini. Tapi itu bukan masalah. Masalahnya adalah di PHP-FPM: tidak bisa lagi menahan beban 5 ribu RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua orang pada waktu itu berbicara tentang pemrosesan asinkron yang modis. Kami melihat lebih dekat, melihat ReactPHP, melakukan tes cepat, menggantinya dengan PHP-FPM dan langsung mendapat peningkatan 4 kali lipat. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami tidak menulis ulang pemrosesan pemrosesan kami - ReactPHP mengangkat kerangka Yii. Pertama, kami meningkatkan 4 layanan ReactPHP, dan kemudian kami mencapai 30. Untuk waktu yang lama kami menggunakannya, dan kerangka kerjanya mengatasi beban.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segera setelah kami memperluas corong, keruntuhan lainnya terjadi: setelah memulai corong di resepsi, pemrosesan mulai menderita lagi. </font><font style="vertical-align: inherit;">Untuk mengatasi masalah ini, kami memutuskan untuk memisahkan pemrosesan menjadi beberapa kluster.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mereka mengambil bot, membagikannya ke dalam kelompok dan membangun rantai logis dari Redis, Postgres dan seorang pawang. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai hasilnya, kami telah membentuk konsep </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Galaxy" - abstraksi fisik logis atas pemrosesan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini terdiri dari contoh: Redis, PostgreSQL dan satu set layanan PHP. </font><font style="vertical-align: inherit;">Setiap bot milik cluster tertentu, dan ReactPHP tahu di mana cluster pesan untuk bot ini harus ditempatkan. </font><font style="vertical-align: inherit;">Skema di atas bekerja lebih jauh. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semesta berkembang, Semesta sistem kami juga, dan kami menambahkan "Galaxy" baru ketika ini terjadi.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Galaksi adalah cara penskalaan kita.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengganti ReactPHP dengan sekelompok Nginx dan Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selama enam bulan ke depan, kami terus tumbuh: 200 juta pelanggan dan 3 miliar pesan per bulan. </font><font style="vertical-align: inherit;">Bayangkan sebuah situs untuk 200 juta pengguna terdaftar - beban yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalah baru telah muncul. </font><font style="vertical-align: inherit;">Webhook adalah tugas kecil dengan tipe yang sama, dan PHP tidak cocok untuk menyelesaikannya. </font><font style="vertical-align: inherit;">Bahkan ReactPHP tidak membantu lagi.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dia tidak bisa mengatasi beban 10 ribu RPS - sejak diperkenalkannya ReactPHP, beban telah meningkat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itu perlu untuk me-restart bahkan dengan penyebaran, apalagi, secara berurutan, karena Anda tidak dapat mengganggu pemrosesan webhook yang masuk. </font><font style="vertical-align: inherit;">Facebook menonaktifkan aplikasi ketika menyadari bahwa ia memiliki masalah. </font><font style="vertical-align: inherit;">Bagi ManyChat, ini adalah bencana - 650 ribu bisnis yang aktif tidak akan memaafkan kami.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, kami secara bertahap menggigit logika yang berbeda dari ReactPHP, meneruskannya ke prosesor, dan mengisolasi antrian baru. Dalam prosesnya, mereka memperhatikan bahwa </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP melakukan satu tugas sederhana - dibutuhkan webhook dan menempatkannya dalam antrian</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Semua sisanya dilakukan oleh prosesi. Apakah ada analog untuk tugas sesederhana itu? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami ingat bahwa Nginx memiliki modul dan memperhatikan perpustakaan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Selain mendukung bahasa pemrograman Lua, ia memiliki modul untuk bekerja dengan Redis. Tes yang ditulis dalam 3 jam menunjukkan bahwa semua pekerjaan dari 30 layanan di ReactPHP dapat dilakukan langsung di sisi nginx. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Begini hasilnya: kami memproses semacam titik akhir, mengambil badan permintaan dan menambahkannya langsung ke Redis.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty dan Lua telah membantu meningkatkan throughput. </font><font style="vertical-align: inherit;">Kami terus mengatasi beban kerja kami, layanan tetap hidup, semua orang senang.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memperbaiki solusi pada Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tahap terakhir ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">catatan: pada saat laporan</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) adalah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Februari 2019</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">500 juta pelanggan mengirim dan menerima 7 juta pesan dari sejuta bot setiap bulan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah langkah untuk meningkatkan solusi kami pada Lua. </font><font style="vertical-align: inherit;">Secara bertahap gigit beberapa logika dari antrian, dan transfer pemrosesan utama mendistribusikan webhooks antara sistem ke Lua. </font><font style="vertical-align: inherit;">Sekarang sistem kami lebih produktif dan kurang tergantung. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mempertahankan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pemrosesan terpisah dan pemrosesan asinkron</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Memproses masalah statistik dan hal lainnya - sekarang ini adalah sistem yang sama sekali berbeda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sistemnya tampak sederhana, tetapi ternyata tidak. </font><font style="vertical-align: inherit;">Di bawah tenda, ada 500 layanan yang memproses permintaan mereka. </font><font style="vertical-align: inherit;">Seluruh sistem berjalan pada 50 instance Amazon: Redis, PostgreSQL, dan PHP handler itu sendiri.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memproses Evolusi</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Highload bisa keren dilakukan di PHP.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ingat secara singkat bagaimana kami melakukan ini dalam proses pengembangan sistem.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dimulai dengan Nginx dan PHP-FPM biasa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menambahkan antrian ke PostgreSQL, dan kemudian ke Redis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menambahkan pengelompokan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diimplementasikan ReactPHP.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengganti ReactPHP dengan sekelompok Nginx dan Lua, dan kemudian memindahkan logika ke kelompok itu.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari pengalaman kami, kami menemukan bahwa adalah mungkin untuk menumbuhkan dan membangun arsitektur dengan berturut-turut mengubah bagian-bagian yang rentan, menggunakan pendekatan sederhana yang terkenal dan pada saat yang sama tidak memperluas tumpukan.</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id486824/index.html">Saran buruk ketika bekerja dengan ANTLR</a></li>
<li><a href="../id486826/index.html">Membuat Viberbot lengkap di Django 2 dan API Viber REST. Bagian Satu - Webhook</a></li>
<li><a href="../id486828/index.html">Intisari Desain Makanan, Januari 2020</a></li>
<li><a href="../id486832/index.html">Berapa tahun pergi taiga - mengerti tidak</a></li>
<li><a href="../id486842/index.html">Konsul + iptables =: 3</a></li>
<li><a href="../id486850/index.html">Kursi baru yang dipesan - seperti hotel kapsul</a></li>
<li><a href="../id486858/index.html">Membuat Viberbot lengkap. Bagian dua - kontak pertama atau "conversion_started"</a></li>
<li><a href="../id486860/index.html">ATX12VO - Makan dengan Cara Baru</a></li>
<li><a href="../id486862/index.html">5 alasan mengapa desain gerak membantu Anda terhubung dengan orang-orang</a></li>
<li><a href="../id486864/index.html">Bermigrasi dari OpenVPN ke WireGuard untuk bergabung dengan jaringan menjadi satu jaringan L2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>