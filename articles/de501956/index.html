<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😅 👮 🥜 Unsere Erfahrung mit Daten in etcd Kubernetes-Cluster direkt zu arbeiten (ohne K8s API) 🤦 👦🏾 👩🏻‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Immer häufiger wenden sich Kunden mit der Bitte an uns, Zugriff auf den Kubernetes-Cluster zu gewähren, um auf Dienste innerhalb des Clusters zugreife...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unsere Erfahrung mit Daten in etcd Kubernetes-Cluster direkt zu arbeiten (ohne K8s API)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/501956/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Immer häufiger wenden sich Kunden mit der Bitte an uns, Zugriff auf den Kubernetes-Cluster zu gewähren, um auf Dienste innerhalb des Clusters zugreifen zu können: Um eine direkte Verbindung zu einer Datenbank oder einem Dienst herstellen zu können, um die lokale Anwendung mit Anwendungen innerhalb des Clusters zu verbinden ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/mh/du/rimhduzpzbuwtylhnil4dorhzw4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispielsweise muss eine Verbindung hergestellt werden von Ihrem lokalen Computer zum Service </font></font><code>memcached.staging.svc.cluster.local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Wir bieten diese Möglichkeit mit einem VPN innerhalb des Clusters, mit dem der Client eine Verbindung herstellt. Zu diesem Zweck kündigen wir die Subnetze von Pods, Diensten und Push-Cluster-DNS an den Client an. Wenn der Client versucht, eine Verbindung zum Dienst herzustellen </font></font><code>memcached.staging.svc.cluster.local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wird die Anforderung an das Cluster-DNS gesendet und erhält als Antwort die Adresse dieses Dienstes vom Clusterdienstnetzwerk oder die Pod-Adresse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir konfigurieren K8s-Cluster mit kubeadm, wobei das Service-Subnetz standardmäßig </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und das Pod-Netzwerk </font><font style="vertical-align: inherit;">aktiviert </font><font style="vertical-align: inherit;">sind </font></font><code>10.244.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Normalerweise funktioniert alles gut, aber es gibt ein paar Punkte:</font></font><a name="habracut"></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Subnetz wird </font></font><code>192.168.*.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">häufig in Büronetzwerken von Clients und noch häufiger in Heimnetzwerken von Entwicklern verwendet. </font><font style="vertical-align: inherit;">Und dann kommt es zu Konflikten: Heimrouter arbeiten in diesem Subnetz und das VPN überträgt diese Subnetze vom Cluster zum Client.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben mehrere Cluster (Produktions-, Stage- und / oder mehrere Entwicklungscluster). </font><font style="vertical-align: inherit;">Dann gibt es in allen standardmäßig dieselben Subnetze für Pods und Dienste, was große Schwierigkeiten bei der gleichzeitigen Arbeit mit Diensten in mehreren Clustern verursacht.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seit geraumer Zeit verwenden wir die Praxis, unterschiedliche Subnetze für Dienste und Pods innerhalb desselben Projekts zu verwenden - im Allgemeinen, sodass sich alle Cluster in unterschiedlichen Netzwerken befinden. </font><font style="vertical-align: inherit;">Es gibt jedoch eine große Anzahl von Clustern in Betrieb, die ich nicht von Grund auf neu erstellen möchte, da auf ihnen viele Dienste, Stateful-Anwendungen usw. ausgeführt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dann haben wir uns gefragt: Wie würde ich das Subnetz in einem vorhandenen Cluster ändern?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suche nach Entscheidungen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am häufigsten werden </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dienste mit dem ClusterIP-Typ neu erstellt. </font><font style="vertical-align: inherit;">Alternativ können </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sie dies auch empfehlen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der folgende Prozess hat ein Problem: Nachdem alles konfiguriert wurde, wird in den Pods die alte IP als DNS-Nameserver in /etc/resolv.conf angezeigt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da ich die Lösung immer noch nicht gefunden habe, musste ich den gesamten Cluster mit kubeadm reset zurücksetzen und erneut starten.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber das passt nicht jedem ... Hier sind detailliertere einleitende Anmerkungen zu unserem Fall: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wird von Flanell verwendet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Es gibt Cluster sowohl in den Wolken als auch auf dem Eisen;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ich möchte die wiederholte Bereitstellung aller Dienste im Cluster vermeiden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Es ist notwendig, alles mit einem Minimum an Problemen zu tun.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Die Kubernetes-Version ist 1.16.6 (weitere Aktionen sind jedoch für andere Versionen ähnlich).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Hauptaufgabe besteht darin </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es </font><font style="vertical-align: inherit;">durch einen Cluster zu </font><font style="vertical-align: inherit;">ersetzen </font><font style="vertical-align: inherit;">, der mithilfe von kubeadm mit einem Service-Subnetz bereitgestellt wird </font></font><code>172.24.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und es ist einfach so passiert, dass es für uns lange Zeit interessant war zu sehen, was und wie in Kubernetes in etcd gespeichert ist, was damit überhaupt gemacht werden kann ... Also dachten wir: „ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum nicht einfach die Daten in etcd aktualisieren, indem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wir </font><b><font style="vertical-align: inherit;">die alten IP-Adressen (Subnetz) ersetzen? zu neuen</font></b><font style="vertical-align: inherit;"> ? " </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der Suche nach vorgefertigten Tools für die Arbeit mit Daten in etcd haben wir nichts gefunden, was die Aufgabe vollständig löst. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Übrigens, wenn Sie über Dienstprogramme für die Arbeit mit Daten direkt in etcd Bescheid wissen, sind wir für die Links dankbar.) </font></font></i><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">OpenShift </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etcdhelper</font></font></b><font style="vertical-align: inherit;"></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wurde jedoch zu einem guten Ausgangspunkt </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(dank seiner Autoren!)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Dienstprogramm ist in der </font><font style="vertical-align: inherit;">Lage zu verbinden Zertifikate ETCD verwenden und die ausgelesenen Daten mit </font><font style="vertical-align: inherit;">den Befehlen </font></font><code>ls</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>dump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fügen Sie etcdhelper hinzu</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der folgende Gedanke ist logisch: "Was verhindert das Hinzufügen dieses Dienstprogramms und das Hinzufügen der Fähigkeit, Daten in etcd zu schreiben?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde in eine modifizierte Version von etcdhelper mit zwei neuen übersetzt </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font><font style="vertical-align: inherit;">Funktionen </font></font><code>changePodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sie </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">können</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ihren </font><b><font style="vertical-align: inherit;">Code </font></b><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">hier sehen</font></a></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was machen die neuen Funktionen? </font><font style="vertical-align: inherit;">Algorithmus </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einen Deserializer erstellen;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kompilieren Sie einen regulären Ausdruck, um CIDR zu ersetzen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir durchlaufen alle Dienste mit dem ClusterIP-Typ im Cluster:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dekodieren Sie den Wert von etcd in das Go-Objekt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ersetzen Sie mit einem regulären Ausdruck die ersten beiden Bytes der Adresse.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Weisen Sie dem Dienst eine IP-Adresse aus einem neuen Subnetz zu.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erstellen Sie einen Serializer, konvertieren Sie das Go-Objekt in Protobuf, schreiben Sie neue Daten in etcd.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Funktion </font></font><code>changePodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist im Wesentlichen dieselbe </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- nur anstatt die Dienstspezifikation zu bearbeiten, tun wir dies für den Knoten und ändern sie </font></font><code>.spec.PodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in ein neues Subnetz.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trainieren</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ändern Sie serviceCIDR</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Plan für die Implementierung der Aufgabe ist sehr einfach, beinhaltet jedoch Ausfallzeiten zum Zeitpunkt der Neuerstellung aller Pods im Cluster. </font><font style="vertical-align: inherit;">Nachdem wir die Hauptschritte beschrieben haben, werden wir auch unsere Gedanken darüber teilen, wie dieser einfache theoretisch minimiert werden kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vorbereitende Maßnahmen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Installieren der erforderlichen Software und Zusammenstellen des gepatchten etcdhelper;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backup etcd und </font></font><code>/etc/kubernetes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kurzer Aktionsplan zur Änderung von serviceCIDR:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ändern von Manifesten für Apiserver und Controller-Manager</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Neuausstellung von Zertifikaten;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Änderung der ClusterIP-Dienste in etcd;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Starten Sie alle Pods in einem Cluster neu.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Folgende ist eine vollständige Abfolge von Aktionen im Detail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Installieren Sie etcd-client für den Datendump:</font></font><br>
<br>
<pre><code class="bash hljs">apt install etcd-client</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Wir sammeln etcdhelper:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir setzen Golang:</font></font><br>
<br>
<pre><code class="bash hljs">GOPATH=/root/golang<font></font>
mkdir -p <span class="hljs-variable">$GOPATH</span>/<span class="hljs-built_in">local</span>
curl -sSL https://dl.google.com/go/go1.14.1.linux-amd64.tar.gz | tar -xzvC <span class="hljs-variable">$GOPATH</span>/<span class="hljs-built_in">local</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"export GOPATH=\"<span class="hljs-variable">$GOPATH</span>\""</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export GOROOT="$GOPATH/local/go"'</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH="$PATH:$GOPATH/local/go/bin"'</span> &gt;&gt; ~/.bashrc</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir retten uns </font></font><code>etcdhelper.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, laden die Abhängigkeiten, sammeln:</font></font><br>
<br>
<pre><code class="bash hljs">wget https://raw.githubusercontent.com/flant/examples/master/2020/04-etcdhelper/etcdhelper.go<font></font>
go get go.etcd.io/etcd/clientv3 k8s.io/kubectl/pkg/scheme k8s.io/apimachinery/pkg/runtime<font></font>
go build -o etcdhelper etcdhelper.go</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Backup machen etcd:</font></font><br>
<br>
<pre><code class="bash hljs">backup_dir=/root/backup<font></font>
mkdir <span class="hljs-variable">${backup_dir}</span>
cp -rL /etc/kubernetes <span class="hljs-variable">${backup_dir}</span>
ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --key=/etc/kubernetes/pki/etcd/server.key --cert=/etc/kubernetes/pki/etcd/server.crt --endpoints https://192.168.199.100:2379 snapshot save <span class="hljs-variable">${backup_dir}</span>/etcd.snapshot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Ändern Sie das Service-Subnetz in den Manifesten der Kubernetes-Steuerebene. </font><font style="vertical-align: inherit;">In Dateien </font></font><code>/etc/kubernetes/manifests/kube-apiserver.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ändern Sie den Parameter </font></font><code>--service-cluster-ip-range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in ein neues Subnetz: </font></font><code>172.24.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stattdessen </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Da wir das Service-Subnetz ändern, an das kubeadm Zertifikate für Apiserver (einschließlich) ausstellt, müssen diese erneut ausgestellt werden:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schauen wir uns an, für welche Domänen und IP-Adressen das aktuelle Zertifikat ausgestellt wird:</font></font><br>
<br>
<pre><code class="bash hljs">openssl x509 -noout -ext subjectAltName &lt;/etc/kubernetes/pki/apiserver.crt<font></font>
X509v3 Subject Alternative Name:<font></font>
    DNS:dev-1-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:apiserver, IP Address:192.168.0.1, IP Address:10.0.0.163, IP Address:192.168.199.100</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bereiten Sie die Mindestkonfiguration für kubeadm vor:</font></font><br>
<br>
<pre><code class="bash hljs">cat kubeadm-config.yaml<font></font>
apiVersion: kubeadm.k8s.io/v1beta1<font></font>
kind: ClusterConfiguration<font></font>
networking:<font></font>
  podSubnet: <span class="hljs-string">"10.244.0.0/16"</span>
  serviceSubnet: <span class="hljs-string">"172.24.0.0/16"</span><font></font>
apiServer:<font></font>
  certSANs:<font></font>
  - <span class="hljs-string">"192.168.199.100"</span> <span class="hljs-comment"># IP-  </span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Löschen wir die alte CRT und den alten Schlüssel, da ohne diese kein neues Zertifikat ausgestellt wird:</font></font><br>
<br>
<pre><code class="bash hljs">rm /etc/kubernetes/pki/apiserver.{key,crt}</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Stellen Sie Zertifikate für den API-Server erneut aus:</font></font><br>
<br>
<pre><code class="bash hljs">kubeadm init phase certs apiserver --config=kubeadm-config.yaml</code></pre></li>
<li> ,      :<br>
<br>
<pre><code class="bash hljs">openssl x509 -noout -ext subjectAltName &lt;/etc/kubernetes/pki/apiserver.crt<font></font>
X509v3 Subject Alternative Name:<font></font>
    DNS:kube-2-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:172.24.0.1, IP Address:10.0.0.163, IP Address:192.168.199.100</code></pre></li>
<li>    API-   :<br>
<br>
<pre><code class="bash hljs">docker ps | grep k8s_kube-apiserver | awk <span class="hljs-string">'{print $1}'</span> | xargs docker restart</code></pre></li>
<li>    <code>admin.conf</code>:<br>
<br>
<pre><code class="bash hljs">kubeadm alpha certs renew admin.conf</code></pre></li>
<li>    etcd:<br>
<br>
<pre><code class="bash hljs">./etcdhelper -cacert /etc/kubernetes/pki/etcd/ca.crt -cert /etc/kubernetes/pki/etcd/server.crt -key /etc/kubernetes/pki/etcd/server.key -endpoint https://127.0.0.1:2379 change-service-cidr 172.24.0.0/16 </code></pre><br>
<b>!</b>         ,      pod'  <code>/etc/resolv.conf</code>    CoreDNS (kube-dns),  kube-proxy   iptables     .         .</li>
<li>  ConfigMap'    <code>kube-system</code>:<br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubelet-config-1.16</code></pre><br>
—   <code>clusterDNS</code>   IP-  kube-dns: <code>kubectl -n kube-system get svc kube-dns</code>.<br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubeadm-config</code></pre><br>
—  <code>data.ClusterConfiguration.networking.serviceSubnet</code>   .</li>
<li>     kube-dns,    kubelet   :<br>
<br>
<pre><code class="bash hljs">kubeadm upgrade node phase kubelet-config &amp;&amp; systemctl restart kubelet</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Es bleibt, alle Pods im Cluster neu zu starten:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get pods --no-headers=<span class="hljs-literal">true</span> --all-namespaces |sed -r <span class="hljs-string">'s/(\S+)\s+(\S+).*/kubectl --namespace \1 delete pod \2/e'</span></code></pre></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minimierte Ausfallzeiten</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gedanken zur Minimierung von Ausfallzeiten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie nach dem Ändern der Manifestationen der Steuerebene einen neuen kube-dns-Dienst, z. B. mit einem Namen </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und einer neuen Adresse </font></font><code>172.24.0.10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make </font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in etcdhelper, wodurch der kube-dns-Dienst nicht geändert wird.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ersetzen Sie die Adresse in allen Kubelets </font></font><code>ClusterDNS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">durch eine neue, während der alte Dienst gleichzeitig mit dem neuen Dienst weiterarbeitet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Warten Sie, bis die Pods mit den Anwendungen aus natürlichen Gründen oder zu einem vereinbarten Zeitpunkt von selbst rollen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Löschen Sie den Dienst </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und ändern Sie ihn </font></font><code>serviceSubnetCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für den kube-dns-Dienst.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Plan minimiert Ausfallzeiten von bis zu ~ einer Minute - für die Zeit, in der der Dienst entfernt </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und das Subnetz für den Dienst ersetzt wird </font></font><code>kube-dns</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modifikation podNetwork</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig haben wir uns entschlossen zu sehen, wie podNetwork mithilfe des resultierenden etcdhelper geändert werden kann. </font><font style="vertical-align: inherit;">Die Reihenfolge der Aktionen ist wie folgt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wir reparieren Konfigurationen in </font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir korrigieren das Manifest von kube-controller-manager.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wir ändern podCIDR direkt in etcd;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Starten Sie alle Knoten des Clusters neu.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weitere </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Informationen zu </font><font style="vertical-align: inherit;">diesen Aktionen: </font><font style="vertical-align: inherit;">1. Ändern Sie ConfigMap im Namespace </font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubeadm-config</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- </font></font><code>data.ClusterConfiguration.networking.podSubnet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einem neuen Subnetz </font><font style="vertical-align: inherit;">behoben </font></font><code>10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kube-proxy</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Wir korrigieren </font></font><code>data.config.conf.clusterCIDR: 10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Ändern Sie das Manifest des Controller-Managers:</font></font><br>
<br>
<pre><code class="bash hljs">vim /etc/kubernetes/manifests/kube-controller-manager.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Wir korrigieren </font></font><code>--cluster-cidr=10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Schauen Sie </font><font style="vertical-align: inherit;">sich die aktuellen Werte </font></font><code>.spec.podCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.spec.podCIDRs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.InternalIP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.status.addresses</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für alle Knoten im Cluster:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get no -o json | jq <span class="hljs-string">'[.items[] | {"name": .metadata.name, "podCIDR": .spec.podCIDR, "podCIDRs": .spec.podCIDRs, "InternalIP": (.status.addresses[] | select(.type == "InternalIP") | .address)}]'</span></code></pre><br>
<pre><code class="json hljs">[<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.2"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.1.239"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.222"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.4.73"</span><font></font>
  }<font></font>
]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Ersetzen Sie podCIDR, indem Sie Änderungen direkt an etcd vornehmen:</font></font><br>
<br>
<pre><code class="bash hljs">./etcdhelper -cacert /etc/kubernetes/pki/etcd/ca.crt -cert /etc/kubernetes/pki/etcd/server.crt -key /etc/kubernetes/pki/etcd/server.key -endpoint https://127.0.0.1:2379 change-pod-cidr 10.55.0.0/16</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Überprüfen Sie, ob sich podCIDR wirklich geändert hat:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get no -o json | jq <span class="hljs-string">'[.items[] | {"name": .metadata.name, "podCIDR": .spec.podCIDR, "podCIDRs": .spec.podCIDRs, "InternalIP": (.status.addresses[] | select(.type == "InternalIP") | .address)}]'</span></code></pre><br>
<pre><code class="json hljs">[<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.2"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.1.239"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.222"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.4.73"</span><font></font>
  }<font></font>
]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Im Gegenzug starten wir alle Knoten des Clusters neu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. Wenn mindestens ein Knoten </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den alten podCIDR verlässt, kann der</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kube-controller-manager nicht gestartet werden und Pods im Cluster werden nicht geplant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsächlich kann das Ändern von podCIDR vereinfacht werden (z. B. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Wir wollten jedoch lernen, wie man direkt mit etcd arbeitet, da es Fälle gibt, in denen das Bearbeiten von Kubernetes-Objekten in etcd die </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einzig</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mögliche Option ist. </font><font style="vertical-align: inherit;">(Sie können beispielsweise nicht einfach das Feld eines Dienstes ohne Ausfallzeit ändern </font></font><code>spec.clusterIP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesamt</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Artikel betrachtet die Möglichkeit, direkt mit Daten in etcd zu arbeiten, d. H. </font><font style="vertical-align: inherit;">Umgehen der Kubernetes-API. </font><font style="vertical-align: inherit;">Manchmal können Sie mit diesem Ansatz "knifflige Dinge" tun. </font><font style="vertical-align: inherit;">Die im Text beschriebenen Operationen wurden an realen K8-Clustern getestet. </font><font style="vertical-align: inherit;">Ihr Status der Bereitschaft zur weit verbreiteten Verwendung ist jedoch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PoC (Proof of Concept)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wenn Sie daher eine modifizierte Version des Dienstprogramms etcdhelper in Ihren Clustern verwenden möchten, tun Sie dies auf eigene Gefahr und Gefahr.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie auch in unserem Blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etcd 3.4.3: Speicherzuverlässigkeit und Sicherheitsforschung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calico für das Web bei Kubernetes: Kennenlernen und ein bisschen Erfahrung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> “;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 unterhaltsame Systemfehler beim Betrieb von Kubernetes [und deren Lösung]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">      Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de501938/index.html">Prometheus, geh nicht: 6 alternative Überwachungstools für Kubernetes</a></li>
<li><a href="../de501940/index.html">Ein bisschen über Neutralino.js</a></li>
<li><a href="../de501942/index.html">Kanban-Methode: Verstehen Sie Ihren Prozess als kollektiven Lernprozess</a></li>
<li><a href="../de501948/index.html">Wie ein Zug von Bahnhof zu Bahnhof fährt: Routing-Funktionen</a></li>
<li><a href="../de501954/index.html">Ob VR auf Microsoft Kinect wartet oder die Zukunft des Spielens ist - lassen Sie uns gemeinsam sprechen</a></li>
<li><a href="../de501960/index.html">Suchskalierung. Elasticsearch Seine Vorteile und Grundvoraussetzungen für die Installation</a></li>
<li><a href="../de501964/index.html">Wofür sind Industriecomputer?</a></li>
<li><a href="../de501968/index.html">MVI-Architekturvorlage in Kotlin Multiplattform, Teil 1</a></li>
<li><a href="../de501970/index.html">Was brauchst du, um einen guten Dungeon in RPG zu erstellen?</a></li>
<li><a href="../de501976/index.html">So lernen Sie, Software zu testen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>