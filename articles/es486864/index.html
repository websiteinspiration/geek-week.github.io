<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå∞ üë®üèø‚Äç‚öñÔ∏è üì≤ Migraci√≥n de OpenVPN a WireGuard para unir redes en una red L2 üéá üïû üë®‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Me gustar√≠a compartir la experiencia de combinar redes en tres apartamentos geogr√°ficamente remotos, en cada uno de los cuales los enrutadores con Ope...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Migraci√≥n de OpenVPN a WireGuard para unir redes en una red L2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486864/"><img src="https://habrastorage.org/webt/sk/lb/nc/sklbncaul8kfwr65yuroz8eteki.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me gustar√≠a compartir la experiencia de combinar redes en tres apartamentos geogr√°ficamente remotos, en cada uno de los cuales los enrutadores con OpenWRT se utilizan como puerta de entrada a una red com√∫n. </font><font style="vertical-align: inherit;">Al elegir un m√©todo para combinar redes entre L3 con enrutamiento de subredes y L2 con puente, cuando todos los nodos de la red estar√°n en la misma subred, se prefiri√≥ el segundo m√©todo, que era m√°s dif√≠cil de configurar, pero que daba m√°s oportunidades, ya que la red estaba planeada para usar tecnolog√≠as transparentes Wake-on-Lan y DLNA.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1: antecedentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenVPN se eligi√≥ inicialmente como el protocolo para implementar esta tarea, porque, en primer lugar, puede crear un dispositivo de tap que se puede agregar f√°cilmente al puente, y en segundo lugar, OpenVPN admite la operaci√≥n del protocolo TCP, que tambi√©n era importante, porque ninguno de los apartamentos ten√≠a una direcci√≥n IP dedicada, y no pude usar STUN, porque por alguna raz√≥n mi proveedor bloquea las conexiones entrantes a trav√©s de UDP desde sus redes, mientras que TCP me permiti√≥ reenviar el puerto del servidor VPN a VPS arrendado utilizando SSH. S√≠, este enfoque genera una gran carga, porque los datos se cifran dos veces, pero no quer√≠a ingresar VPS en mi red privada, ya que exist√≠a el riesgo de que terceros obtuvieran el control sobre ellos, por lo tanto,tener un dispositivo de este tipo en la red dom√©stica era extremadamente indeseable y se decidi√≥ pagar por la seguridad con una gran sobrecarga.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para reenviar el puerto en el enrutador en el que se plane√≥ implementar el servidor, se utiliz√≥ el programa sshtunnel. No describir√© las complejidades de su configuraci√≥n: esto se hace con bastante facilidad, solo noto que su tarea era reenviar el puerto TCP 1194 desde el enrutador al VPS. Luego, el servidor OpenVPN se configur√≥ en el dispositivo tap0, que termin√≥ en el puente br-lan. Despu√©s de verificar la conexi√≥n al servidor que acaba de crear desde la computadora port√°til, qued√≥ claro que la idea del reenv√≠o de puertos hab√≠a valido la pena y mi computadora port√°til se convirti√≥ en miembro de la red del enrutador, aunque yo no estaba f√≠sicamente all√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El asunto segu√≠a siendo peque√±o: era necesario distribuir direcciones IP en diferentes apartamentos para que no entraran en conflicto y configurar los enrutadores como clientes OpenVPN. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se seleccionaron las siguientes direcciones IP de enrutador y rangos de servidor DHCP:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con un rango de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.80</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el servidor</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con un rango de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.101</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.149</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el enrutador en el apartamento No. 2</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.150</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con un rango de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.151</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.199</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el enrutador en el apartamento No. 3</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n fue necesario asignar estas direcciones a los enrutadores del cliente del servidor OpenVPN agregando las siguientes l√≠neas a su configuraci√≥n:</font></font><br>
<br>
<pre><code class="plaintext hljs">ifconfig-pool-persist /etc/openvpn/ipp.txt 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
y agregando las siguientes l√≠neas al archivo /etc/openvpn/ipp.txt:</font></font><br>
<br>
<pre><code class="plaintext hljs">flat1_id 192.168.10.100<font></font>
flat2_id 192.168.10.150<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
donde flat1_id y flat2_id son los nombres de dispositivo especificados al crear certificados para conectarse a OpenVPN</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, los clientes OpenVPN se configuraron en los enrutadores, se agregaron dispositivos tap0 en ambos al puente br-lan. En esta etapa, parec√≠a que todo estaba en orden, ya que las tres redes se ven y funcionan como un todo. Sin embargo, result√≥ ser un detalle no muy agradable: a veces los dispositivos no pod√≠an obtener una direcci√≥n IP de su enrutador, con todas las consecuencias resultantes. Por alguna raz√≥n, el enrutador en algunos de los apartamentos no tuvo tiempo de responder a tiempo a DHCPDISCOVER y el dispositivo no recibi√≥ su direcci√≥n. Me di cuenta de que necesito filtrar tales solicitudes en tap0 en cada uno de los enrutadores, pero result√≥ que iptables no puede funcionar con el dispositivo si es parte del puente y ebtables deber√≠an ayudarme. Desafortunadamente, no estaba en mi firmware y tuve que reconstruir las im√°genes para cada dispositivo.Despu√©s de hacer esto y agregar tales l√≠neas a /etc/rc.local de cada enrutador, el problema se resolvi√≥:</font></font><br>
<br>
<pre><code class="bash hljs">ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta configuraci√≥n dur√≥ tres a√±os.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2: Presentaci√≥n de WireGuard</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recientemente, en Internet, comenzaron a hablar cada vez m√°s sobre WireGuard, admirando la simplicidad de su configuraci√≥n, alta velocidad de transmisi√≥n, bajo ping con seguridad comparable. La b√∫squeda de informaci√≥n adicional sobre √©l dej√≥ en claro que no apoyaban trabajar como miembro puente o trabajar con TCP, lo que me hizo pensar que todav√≠a no hab√≠a alternativas a OpenVPN para m√≠. As√≠ que dej√© de conocer WireGuard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace unos d√≠as, a trav√©s de los recursos, de una forma u otra relacionados con TI, apareci√≥ la noticia de que WireGuard finalmente se incluir√° en el kernel de Linux, comenzando con la versi√≥n 5.6. Los art√≠culos de noticias, como siempre, elogiaron a WireGuard. Nuevamente me sumerg√≠ en la b√∫squeda de formas de reemplazar el buen viejo OpenVPN. Esta vez me encontr√© con </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Hablaba de construir un t√∫nel Ethernet sobre L3 usando GRE. Este art√≠culo me dio esperanza. No qued√≥ claro qu√© hacer con el protocolo UDP. La b√∫squeda me llev√≥ a art√≠culos sobre el uso de socat junto con un t√∫nel SSH para reenviar un puerto UDP, sin embargo, notaron que este enfoque solo funciona en modo de conexi√≥n √∫nica, es decir, el trabajo de varios clientes VPN ser√≠a imposible. Se me ocurri√≥ la idea de crear un servidor VPN en VPS y configurar GRE para clientes, pero result√≥ que GRE no admite el cifrado, lo que conducir√° al hecho de que, en caso de que terceros accedan al servidor, todo el tr√°fico entre mis redes est√° en sus manos. eso no me conven√≠a en principio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuevamente, la decisi√≥n se tom√≥ a favor del cifrado excesivo, mediante el uso de una VPN sobre una VPN de acuerdo con el siguiente esquema:</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN de primer nivel: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servidor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con una direcci√≥n interna de 192.168.30.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un cliente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS con una direcci√≥n interna de 192.168.30.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un cliente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPS con una direcci√≥n interna de 192.168.30.3 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">cliente</font></i><font style="vertical-align: inherit;"> VPS </font><font style="vertical-align: inherit;">con una direcci√≥n interna de 192.168.30.3 </font><b><font style="vertical-align: inherit;">MK2</font></b><font style="vertical-align: inherit;"> es </font><i><font style="vertical-align: inherit;">una </font></i></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN de segundo nivel: </font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servidor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con una direcci√≥n externa 192.168.30.2 y una interna 192.168.31.1 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un cliente </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con una direcci√≥n 192.168.30.2 y tiene una IP interna 192.168.31.2 </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un cliente </font></font></i> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con la direcci√≥n 192.168.30.2 y tiene una IP interna 192.168.31.3 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - enrutador-servidor en el apartamento 1, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - enrutador en el apartamento 2, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - enrutador en el apartamento 3 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Las configuraciones del dispositivo se publican en el spoiler al final del art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y as√≠, los pings entre los nodos de la red 192.168.31.0/24 van, es hora de pasar a configurar el t√∫nel GRE. Antes de esto, para no perder el acceso a los enrutadores, vale la pena configurar t√∫neles SSH para reenviar 22 puertos en el VPS, de modo que, por ejemplo, el enrutador del apartamento 2 estar√° disponible en el puerto VPS 10022 y en el puerto 11122 el VPS estar√° disponible el enrutador es del departamento 3. Es mejor configurar el reenv√≠o con el mismo sshtunnel, ya que restaurar√° el t√∫nel si se cae.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El t√∫nel est√° configurado, puede conectarse a SSH a trav√©s del puerto reenviado:</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@_VPS -p 10022</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, deshabilite OpenVPN:</font></font><br>
<br>
<pre><code class="bash hljs">/etc/init.d/openvpn stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora configure el t√∫nel GRE en el enrutador desde el apartamento 2:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.1 <span class="hljs-built_in">local</span> 192.168.31.2<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y agregue la interfaz creada al puente:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realizaremos un procedimiento similar en el servidor enrutador:</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.2 <span class="hljs-built_in">local</span> 192.168.31.1<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y, tambi√©n, agregue la interfaz creada al puente:</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a partir de este momento, los pings comienzan a ir con √©xito a la nueva red y yo, con satisfacci√≥n, voy a tomar caf√©. </font><font style="vertical-align: inherit;">Luego, para evaluar c√≥mo funciona la red en el otro extremo del cable, intento conectarme a trav√©s de SSH a una de las computadoras en el departamento 2, pero el cliente ssh se congela sin solicitar una contrase√±a. </font><font style="vertical-align: inherit;">Intento conectarme a esta computadora a trav√©s del telnet al puerto 22 y veo una l√≠nea desde la cual se puede entender que se est√° estableciendo la conexi√≥n, el servidor SSH est√° respondiendo, solo por alguna raz√≥n no me ofrece iniciar sesi√≥n.</font></font><br>
<br>
<pre><code class="bash hljs">$ telnet 192.168.10.110 22<font></font>
SSH-2.0-OpenSSH_8.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intento conectarme a √©l a trav√©s de VNC y veo una pantalla en negro. Me aseguro que es una computadora remota, porque puedo conectarme f√°cilmente al enrutador desde este departamento en la direcci√≥n interna. Sin embargo, decido conectarme a la SSH de esta computadora a trav√©s de un enrutador y me sorprende ver que la conexi√≥n es exitosa y que la computadora remota funciona correctamente, pero tampoco puede conectarse a mi computadora.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quito el dispositivo grelan0 del puente y ejecuto OpenVPN en el enrutador en el apartamento 2 y me aseguro de que la red vuelva a funcionar como se esperaba y que las conexiones no se rompan. Cuando busco, me encuentro con foros donde las personas se quejan de los mismos problemas, donde se les aconseja elevar el MTU. Sin embargo, no pude aumentar la MTU para la VPN de primer nivel (wg0): con MTU superiores a 1420, que se configura autom√°ticamente, comienzan los descansos, pero al mismo tiempo, la VPN de segundo nivel wg1 que funciona sobre wg0 funcion√≥ correctamente con MTU 1600. Esto es suficiente para instalar La MTU es 1500 para el dispositivo gretap, por lo que esta interfaz tiene el mismo valor de MTU que el puente br-lan en el que se plane√≥ agregar gretap. Seg√∫n tengo entendido, el puente establece la MTU igual al menor de los valores disponibles en todos los dispositivos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hice una configuraci√≥n similar en el enrutador desde el Apartamento 3, con la √∫nica diferencia de que en el enrutador el servidor agreg√≥ una segunda interfaz gretap llamada grelan1, que tambi√©n se agreg√≥ al puente br-lan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo esta funcionando. </font><font style="vertical-align: inherit;">Ahora puede poner el ensamblaje gretap al inicio. </font><font style="vertical-align: inherit;">Para hacer esto: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
coloque estas l√≠neas en /etc/rc.local en el enrutador en el apartamento 2:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.2<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agreg√≥ esto a /etc/rc.local en el enrutador en el apartamento 3:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y en el enrutador del servidor:</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.2 local 192.168.31.1<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
<font></font>
ip link add grelan1 type gretap remote 192.168.31.3 local 192.168.31.1<font></font>
ip link set dev grelan1 mtu 1500<font></font>
ip link set grelan1 up<font></font>
brctl addif br-lan grelan1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de reiniciar los enrutadores del cliente, descubr√≠ que por alguna raz√≥n no se conectaban al servidor. </font><font style="vertical-align: inherit;">Despu√©s de conectarme a su SSH (afortunadamente, preconfig√© sshtunnel para esto), se descubri√≥ que WireGuard estaba creando una ruta para el punto final por alguna raz√≥n, pero era incorrecto. </font><font style="vertical-align: inherit;">Entonces, para 192.168.30.2, la tabla de rutas indicaba la ruta a trav√©s de la interfaz pppoe-wan, es decir, a trav√©s de Internet, aunque la ruta a ella deber√≠a haberse enrutado a trav√©s de la interfaz wg0. </font><font style="vertical-align: inherit;">Despu√©s de eliminar esta ruta, se restableci√≥ la conexi√≥n. </font><font style="vertical-align: inherit;">No pude encontrar en alguna parte instrucciones sobre c√≥mo hacer que WireGuard no cree estas rutas. </font><font style="vertical-align: inherit;">Adem√°s, ni siquiera entend√≠, una caracter√≠stica es OpenWRT o WireGuard en s√≠. </font><font style="vertical-align: inherit;">Sin tener que lidiar con este problema durante mucho tiempo, acabo de agregar una l√≠nea a este enrutador al script en bucle por un temporizador al bucle del temporizador:</font></font><br>
<br>
<pre><code class="bash hljs">route del 192.168.30.2
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para resumir</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todav√≠a no he logrado un rechazo completo de OpenVPN, ya que a veces necesito conectarme a una nueva red desde una computadora port√°til o tel√©fono, y configurar un dispositivo gretap en ellos generalmente es imposible, pero a pesar de esto, obtuve una ventaja en la velocidad de transferencia de datos entre apartamentos y, por ejemplo, el uso de VNC ahora no causa inconvenientes. </font><font style="vertical-align: inherit;">Ping disminuy√≥ ligeramente, pero se volvi√≥ m√°s estable: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cuando se usa OpenVPN:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=133 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=125 ms<font></font>
<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19006ms<font></font>
rtt min/avg/max/mdev = 124.722/126.152/136.907/3.065 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando use WireGuard:</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=124 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=124 ms<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19003ms<font></font>
rtt min/avg/max/mdev = 123.954/124.423/126.708/0.675 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se ve m√°s afectado por el ping alto antes de VPS, que es de aproximadamente 61,5 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, la velocidad ha aumentado significativamente. </font><font style="vertical-align: inherit;">Entonces, en un departamento con un enrutador-servidor, tengo una velocidad de conexi√≥n a Internet de 30 Mbit / s, y en otros departamentos: 5 Mbit / s. </font><font style="vertical-align: inherit;">Al mismo tiempo, mientras usaba OpenVPN, no pude lograr una velocidad de transferencia de datos entre redes de m√°s de 3.8 Mb / s seg√∫n iperf, mientras que WireGuard la "bombe√≥" a los mismos 5 Mb / s.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de WireGuard en VPS</font></font></b><div class="spoiler_text"><code>[Interface]<br>
Address = 192.168.30.1/24<br>
ListenPort = 51820<br>
PrivateKey = &lt;___VPS&gt;<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_1_&gt;<br>
AllowedIPs = 192.168.30.2/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_2&gt;<br>
AllowedIPs = 192.168.30.3/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_3&gt;<br>
AllowedIPs = 192.168.30.4/32</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de WireGuard en MS (agregado a / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.2/24'<font></font>
        option private_key '__VPN_1_'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option route_allowed_ips '1'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_'<font></font>
        option listen_port '51821'<font></font>
        list addresses '192.168.31.1/24'<font></font>
        option auto '1'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_2'<font></font>
        list allowed_ips '192.168.31.2'<font></font>
<font></font>
config wireguard_wg1ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
        option public_key '__VPN_2_3'<font></font>
        list allowed_ips '192.168.31.3'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de WireGuard en MK2 (agregado a / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.3/24'<font></font>
        option private_key '__VPN_1_2'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_2'<font></font>
        list addresses '192.168.31.2/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de WireGuard en MK3 (agregado a / etc / config / network)</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.4/24'<font></font>
        option private_key '__VPN_1_3'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_3'<font></font>
        list addresses '192.168.31.3/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En las configuraciones descritas para la VPN de segundo nivel, especifico el puerto 51821 para los clientes WireGuard. En principio, esto no es necesario, ya que el cliente establecer√° una conexi√≥n desde cualquier puerto libre sin privilegios, pero lo hice para poder bloquear todas las conexiones entrantes en las interfaces wg0 de todos los enrutadores, excepto conexiones UDP entrantes al puerto 51821. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que este art√≠culo sea √∫til para alguien. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PD:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tambi√©n quiero compartir mi script que me env√≠a una notificaci√≥n PUSH en el tel√©fono a la aplicaci√≥n WirePusher cuando aparece un nuevo dispositivo en mi red. </font><font style="vertical-align: inherit;">Aqu√≠ est√° el enlace al script: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/r0ck3r/device_discover</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACTUALIZACI√ìN:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuraci√≥n de OpenVPN Server y Clientes</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor OpenVPN</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client-to-client<font></font>
<font></font>
ca /etc/openvpn/server/ca.crt<font></font>
cert /etc/openvpn/server/vpn-server.crt<font></font>
dh /etc/openvpn/server/dh.pem<font></font>
key /etc/openvpn/server/vpn-server.key<font></font>
<font></font>
dev tap<font></font>
ifconfig-pool-persist /etc/openvpn/ipp.txt 0<font></font>
keepalive 10 60<font></font>
proto tcp4<font></font>
server-bridge 192.168.10.1 255.255.255.0 192.168.10.80 192.168.10.254<font></font>
status /var/log/openvpn-status.log<font></font>
verb 3<font></font>
comp-lzo</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente OpenVPN</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client<font></font>
tls-client<font></font>
dev tap<font></font>
proto tcp<font></font>
remote VPS_IP 1194 # Change to your router's External IP<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
<font></font>
ca client/ca.crt<font></font>
cert client/client.crt<font></font>
key client/client.key<font></font>
dh client/dh.pem<font></font>
<font></font>
comp-lzo<font></font>
persist-tun<font></font>
persist-key<font></font>
verb 3</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para generar certificados se utiliza easy-rsa</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es486864/">https://habr.com/ru/post/es486864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es486844/index.html">La evoluci√≥n del procesamiento de webhook de Facebook: de cero a 25,000 por segundo</a></li>
<li><a href="../es486850/index.html">Nuevo asiento reservado, como un hotel c√°psula</a></li>
<li><a href="../es486858/index.html">Creando un Viberbot completo. Segunda parte: primer contacto o "conversion_started"</a></li>
<li><a href="../es486860/index.html">ATX12VO - Comer una nueva forma</a></li>
<li><a href="../es486862/index.html">5 razones por las que el dise√±o de movimiento te ayuda a conectarte con las personas</a></li>
<li><a href="../es486866/index.html">Fuete s√≠ncrono: motores biol√≥gicos en nanotecnolog√≠a</a></li>
<li><a href="../es486868/index.html">Por qu√© y para qui√©n hacemos Slime Agile</a></li>
<li><a href="../es486870/index.html">C√≥mo sacamos el fraude de la caba√±a</a></li>
<li><a href="../es486872/index.html">Linux Configuraci√≥n del teclado</a></li>
<li><a href="../es486874/index.html">Coronavirus 2019-nCoV: baja mortalidad, alta mortalidad</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>