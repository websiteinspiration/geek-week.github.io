<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍⚕️ 🏴 ⏬ 「Kubernetesが遅延を10倍に増やした」：誰のせいですか？ 💇🏽 😄 👨🏼‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="注意ペレフ。：この記事は、ヨーロッパのAdevintaでプリンシパルソフトウェアエンジニアを務めているGalo Navarroが執筆したもので、インフラストラクチャ運用の分野で魅力的で有益な「調査」です。元の名前は、著者が最初に説明した理由により、翻訳でわずかに補足されました。
 
 
 
 著者か...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>「Kubernetesが遅延を10倍に増やした」：誰のせいですか？</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/477996/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意ペレフ。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：この記事は、ヨーロッパのAdevintaでプリンシパルソフトウェアエンジニアを務めているGalo Navarroが執筆したもので、インフラストラクチャ運用の分野で魅力的で有益な「調査」です。元の名前は、著者が最初に説明した理由により、翻訳でわずかに補足されました。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/r6/q5/jz/r6q5jzrkmqmxzrachnj8an0rjai.png"><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">著者からの注意</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：この出版物は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">引き付けられた</font></a><font style="vertical-align: inherit;">ようです</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a>   ,  .         ,           .    , ,      ,   ,    .     Kubernetes    :  ,    (,    ),    Kubernetes,   ,  ,  -,  .        .         (  ,  Kubernetes     ).         Kubernetes,          .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数週間前、私のチームは、CI / CD、Kubernetes、メトリックス、およびその他のユーティリティに基づく作業環境を含む、メインプラットフォームへの1つのマイクロサービスの移行に従事していました。</font><font style="vertical-align: inherit;">この移行は試験的なものでした。これをベースとして、今後数か月で約150のサービスを移行する予定でした。</font><font style="vertical-align: inherit;">それらのすべては、スペインで最大のいくつかのオンラインサイト（Infojobs、Fotocasaなど）の仕事を担当しています。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションをKubernetesにデプロイし、トラフィックの一部をリダイレクトした後、驚くべき驚きが待っていました。</font><font style="vertical-align: inherit;">Kubernetesリクエストの</font><font style="vertical-align: inherit;">遅延</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（レイテンシ）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はEC2の10倍でした。</font><font style="vertical-align: inherit;">一般に、この問題の解決策を模索するか、マイクロサービス（場合によってはプロジェクト全体から）の移行を拒否する必要がありました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesの遅延がEC2の遅延よりもはるかに大きいのはなぜですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボトルネックを見つけるために、クエリパス全体にわたってメトリックを収集しました。私たちのアーキテクチャはシンプルです。APIゲートウェイ（Zuul）は、EC2またはKubernetesのマイクロサービスインスタンスへのリクエストをプロキシします。 Kubernetesでは、NGINX Ingress Controllerを使用します。バックエンドは</font><font style="vertical-align: inherit;">、Springプラットフォームに基づくJVMアプリケーションを備えた</font><font style="vertical-align: inherit;">通常の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deployment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクト</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<pre><code class="plaintext hljs">                                  EC2<font></font>
                            +---------------+<font></font>
                            |  +---------+  |<font></font>
                            |  |         |  |<font></font>
                       +-------&gt; BACKEND |  |<font></font>
                       |    |  |         |  |<font></font>
                       |    |  +---------+  |                   <font></font>
                       |    +---------------+<font></font>
             +------+  |<font></font>
Public       |      |  |<font></font>
      -------&gt; ZUUL +--+<font></font>
traffic      |      |  |              Kubernetes<font></font>
             +------+  |    +-----------------------------+<font></font>
                       |    |  +-------+      +---------+ |<font></font>
                       |    |  |       |  xx  |         | |<font></font>
                       +-------&gt; NGINX +------&gt; BACKEND | |<font></font>
                            |  |       |  xx  |         | |<font></font>
                            |  +-------+      +---------+ |<font></font>
                            +-----------------------------+</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は、バックエンドでの作業の初期段階での遅延に関連しているようです（チャートの問題領域を「xx」としてマークしました）。</font><font style="vertical-align: inherit;">EC2では、アプリケーションの応答に約20ミリ秒かかりました。</font><font style="vertical-align: inherit;">Kubernetesでは、遅延が100〜200ミリ秒に増加しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ランタイム環境の変更に関連する可能性のある容疑者を迅速に破棄しました。</font><font style="vertical-align: inherit;">JVMバージョンは同じままです。</font><font style="vertical-align: inherit;">コンテナー化の問題もそれとは関係ありません。アプリケーションはEC2のコンテナーで既に正常に実行されていました。</font><font style="vertical-align: inherit;">読み込んでいますか？</font><font style="vertical-align: inherit;">しかし、1秒あたり1リクエストでも高い遅延が観察されました。</font><font style="vertical-align: inherit;">ガベージコレクションの一時停止も無視できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前にDNSクエリが同様の問題を引き起こしていたため、Kubernetes管理者の1人がアプリケーションに外部依存関係があるかどうか尋ねました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮説1：DNS名前解決</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションはリクエストごとに、のようなドメインのAWS Elasticsearchのインスタンスを1〜3回呼び出します</font></font><code>elastic.spain.adevinta.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">コンテナー内に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がある</font><font style="vertical-align: inherit;">ので、ドメイン検索に本当に時間がかかるかどうかを確認できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテナからのDNSクエリ：</font></font><br>
<br>
<pre><code class="bash hljs">[root@be-851c76f696-alf8z /]<span class="hljs-comment"># while true; do dig "elastic.spain.adevinta.com" | grep time; sleep 2; done</span><font></font>
;; Query time: 22 msec<font></font>
;; Query time: 22 msec<font></font>
;; Query time: 29 msec<font></font>
;; Query time: 21 msec<font></font>
;; Query time: 28 msec<font></font>
;; Query time: 43 msec<font></font>
;; Query time: 39 msec</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションが実行されているEC2インスタンスの1つからの同様のリクエスト：</font></font><br>
<br>
<pre><code class="bash hljs">bash-4.4<span class="hljs-comment"># while true; do dig "elastic.spain.adevinta.com" | grep time; sleep 2; done</span><font></font>
;; Query time: 77 msec<font></font>
;; Query time: 0 msec<font></font>
;; Query time: 0 msec<font></font>
;; Query time: 0 msec<font></font>
;; Query time: 0 msec</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
検索に約30ミリ秒かかるため、ElasticsearchにアクセスするときにDNSを解決するとレイテンシが増加することが明らかになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは2つの理由で奇妙でした：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWSリソースとやり取りするKubernetesのアプリケーションはすでにたくさんありますが、長い遅延に悩まされることはありません。</font><font style="vertical-align: inherit;">理由が何であれ、それは特にこのケースに関連しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JVMがインメモリDNSキャッシングを提供することはわかっています。</font><font style="vertical-align: inherit;">TTL値の画像が書き込まれ</font></font><code>$JAVA_HOME/jre/lib/security/java.security</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、10秒に設定されてい</font></font><code>networkaddress.cache.ttl = 10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">つまり、JVMはすべてのDNSクエリを10秒間キャッシュする必要があります。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の仮説を確認するために、DNSへの呼び出しを一時的に拒否し、問題が解決するかどうかを確認することにしました。</font><font style="vertical-align: inherit;">最初に、ドメイン名ではなくIPアドレスで直接Elasticsearchと通信するようにアプリケーションを再構成することにしました。</font><font style="vertical-align: inherit;">これにはコードの修正と新しい展開が必要になるため、ドメインをIPアドレスでマッピングしました</font></font><code>/etc/hosts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">34.55.5.111 elastic.spain.adevinta.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これでコンテナはほぼ瞬時にIPを受け取りました。</font><font style="vertical-align: inherit;">これはある程度の改善につながりましたが、予想される遅延レベルにわずかに近づきました。</font><font style="vertical-align: inherit;">DNS解決には長い時間がかかりましたが、本当の理由はまだ私たちを逃れていました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワーク診断</font></font></h2><br><font style="vertical-align: inherit;"></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークで何が起こっているかを正確に追跡</font><font style="vertical-align: inherit;">
するため</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">、コンテナーからのトラフィックを分析することにし</font><font style="vertical-align: inherit;">ました。</font></font><br>
<br>
<pre><code class="bash hljs">[root@be-851c76f696-alf8z /]<span class="hljs-comment"># tcpdump -leni any -w capture.pcap</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、リクエストをいくつか送信し</font></font><code>kubectl cp my-service:/capture.pcap capture.pcap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wireshark</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でさらに分析するために</font><font style="vertical-align: inherit;">キャプチャ（</font><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">ダウンロードしました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNSクエリに疑わしいものはありませんでした（後で説明する1つの小さなことを除いて）。しかし、サービスが各リクエストを処理する方法には、いくつかの奇妙な点がありました。以下は、応答が始まる前の要求の受け入れを示すキャプチャースクリーンショット</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-s/_r/ik/-s_rikvkui1ukqadatz-lh08cv0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
です。最初の列にパッケージ番号が表示されています。わかりやすくするために、さまざまなTCPストリームをカラーで強調表示しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
328番目のパケットから始まる緑のスレッドは、クライアント（172.17.22.150）がコンテナー（172.17.36.147）へのTCP接続を確立した方法を示しています。最初のハンドシェイク（328-330）の後、パケット331が</font></font><code>HTTP GET /v1/..</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスに着信要求を</font><font style="vertical-align: inherit;">もたらし</font><font style="vertical-align: inherit;">ました。プロセス全体で1ミリ秒かかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
灰色のストリーム（パケット339から）は、サービスがHTTPリクエストをElasticsearchインスタンスに送信したことを示しています（既存の接続が使用されているため、TCPハンドシェイクはありません）。 18ミリ秒かかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これまでのところ、すべてが問題なく、時間はおおよそ予想される遅延（クライアントから測定した場合は20〜30 ms）に対応しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、青いセクションには86 msかかります。その中で何が起こっているのですか？パケット333を使用して、サービスはHTTP GETリクエストを</font></font><code>/latest/meta-data/iam/security-credentials</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">送信し</font><font style="vertical-align: inherit;">、その直後に同じTCP接続を介しての別のGETリクエストを送信しました</font></font><code>/latest/meta-data/iam/security-credentials/arn:..</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがトレース全体のすべてのリクエストで繰り返されることがわかりました。</font><font style="vertical-align: inherit;">コンテナーではDNS解決が実際には少し遅くなります（この現象の説明は非常に興味深いですが、別の記事のために保存します）。</font><font style="vertical-align: inherit;">大幅な遅延の原因は、リクエストごとのAWSインスタンスメタデータサービスの呼び出しであることが判明しました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮説2：AWSへの追加呼び出し</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
両方のエンドポイントは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWS Instance Metadata API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が所有してい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私たちのマイクロサービスは、Elasticsearchと連携しながらこのサービスを使用します。</font><font style="vertical-align: inherit;">どちらの呼び出しも、基本的な承認プロセスの一部です。</font><font style="vertical-align: inherit;">最初のリクエストでアクセスされるエンドポイントは、インスタンスに関連付けられたIAMロールを発行します。</font></font><br>
<br>
<pre><code class="bash hljs">/ <span class="hljs-comment"># curl http://169.254.169.254/latest/meta-data/iam/security-credentials/</span>
arn:aws:iam::&lt;account_id&gt;:role/some_role</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の要求は、このインスタンスの一時的な権限のために2番目のエンドポイントに送信されます。</font></font><br>
<br>
<pre><code class="bash hljs">/ <span class="hljs-comment"># curl http://169.254.169.254/latest/meta-data/iam/security-credentials/arn:aws:iam::&lt;account_id&gt;:role/some_role`</span><font></font>
{<font></font>
    <span class="hljs-string">"Code"</span> : <span class="hljs-string">"Success"</span>,
    <span class="hljs-string">"LastUpdated"</span> : <span class="hljs-string">"2012-04-26T16:39:16Z"</span>,
    <span class="hljs-string">"Type"</span> : <span class="hljs-string">"AWS-HMAC"</span>,
    <span class="hljs-string">"AccessKeyId"</span> : <span class="hljs-string">"ASIAIOSFODNN7EXAMPLE"</span>,
    <span class="hljs-string">"SecretAccessKey"</span> : <span class="hljs-string">"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"</span>,
    <span class="hljs-string">"Token"</span> : <span class="hljs-string">"token"</span>,
    <span class="hljs-string">"Expiration"</span> : <span class="hljs-string">"2017-05-17T15:09:54Z"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントはそれらを短期間使用でき、定期的に（証明書の前に</font></font><code>Expiration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">新しい証明書を受信する必要があります</font><font style="vertical-align: inherit;">。モデルは単純です。AWSはセキュリティ上の理由から一時キーのローテーションを頻繁に実行しますが、クライアントはそれらを数分間キャッシュして、新しい証明書の取得に関連するパフォーマンスの低下を補うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWS Java SDKは、このプロセスを編成する責任を負う必要がありますが、何らかの理由でこれが発生しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitHubで問題を検索した後、問題</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃1921に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遭遇しました</font><font style="vertical-align: inherit;">。彼女は、私たちがさらに「掘る」方向を決定するのを助けました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWS SDKは、次のいずれかの条件が発生したときに証明書を更新します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それらの有効期限（</font></font><code>Expiration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）はに含まれ</font></font><code>EXPIRATION_THRESHOLD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、15分間コードに厳密に設定されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">証明書を更新する最後の試行以降、</font></font><code>REFRESH_THRESHOLD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ハードコード」で60分</font><font style="vertical-align: inherit;">よりも長い時間が経過しました</font><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
受け取った証明書の実際の有効期限を確認するために、コンテナーとEC2インスタンスから上記のcURLコマンドを実行しました。</font><font style="vertical-align: inherit;">コンテナから受け取った証明書の有効期間ははるかに短く、正確には15分でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これですべてが明らかになりました。最初のリクエストで、サービスは一時的な証明書を受け取りました。</font><font style="vertical-align: inherit;">それらの有効期間は15分を超えなかったため、後続のリクエストにより、AWS SDKはそれらを更新することを決定しました。</font><font style="vertical-align: inherit;">そして、これはすべての要求で起こりました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">証明書の有効期限が短くなったのはなぜですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWSインスタンスメタデータは、KubernetesではなくEC2インスタンスで動作するように設計されています。一方、アプリケーションインターフェイスは変更したくありませんでした。これを行うために、</font><font style="vertical-align: inherit;">各Kubernetesノード上のエージェントの助けを借りて、ユーザー（アプリケーションをクラスターにデプロイするエンジニア）がEC2インスタンスのようにポッド内のコンテナーにIAMロールを割り当てることができるツールである</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KIAM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。 KIAMは、AWS Instance Metadataサービスへの呼び出しをインターセプトし、以前にAWSから受け取ったキャッシュからそれらを処理します。アプリケーションの観点からは、何も変更されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KIAMはポッドに短期証明書を配信します。これは、ポッドの平均寿命がEC2インスタンスの平均寿命よりも短いと考えると妥当です。デフォルトの証明書の有効期限</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じ15分に等しい</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、両方のデフォルト値を互いの上に置くと、問題が発生します。アプリケーションに提供される各証明書は15分で期限切れになります。同時に、AWS Java SDKは15分未満で期限切れになる証明書を強制的に更新します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、一時証明書はリクエストごとに強制的に更新されます。これにより、AWS APIへの呼び出しが2回発生し、レイテンシが大幅に増加します。 AWS Java SDKで</font><font style="vertical-align: inherit;">、同様の問題について言及する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能リクエスト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">見つかりました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策は簡単でした。</font><font style="vertical-align: inherit;">長期間の証明書を要求するようにKIAMを再構成しただけです。</font><font style="vertical-align: inherit;">これが発生するとすぐに、AWSメタデータサービスの参加なしでリクエストが通過し始め、遅延はEC2よりも低いレベルにまで下がりました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
移行の経験に基づくと、問題の最も一般的な原因の1つは、Kubernetesまたはプラットフォームの他の要素のエラーではないと言えます。また、移管するマイクロサービスの根本的な欠陥とは関係ありません。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまな要素を接続するだけで問題が発生することがよくあります。</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
以前は互いに相互作用したことがない複雑なシステムを混合し、それらが一緒になって単一のより大きなシステムを形成することを期待します。悲しいかな、より多くの要素、より多くのエラーの余地、より高いエントロピー。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの場合、レイテンシが高くなったのは、Kubernetes、KIAM、AWS Java SDK、またはマイクロサービスのエラーや誤った決定によるものではありません。</font><font style="vertical-align: inherit;">これは、2つの独立したデフォルトパラメータを組み合わせた結果です。1つはKIAMに、もう1つはAWS Java SDKにあります。</font><font style="vertical-align: inherit;">それとは別に、両方のパラメーターが意味を成します。AWSJava SDKのアクティブな証明書更新ポリシーとKAIMの短い証明書有効期間です。</font><font style="vertical-align: inherit;">しかし、それらを組み合わせると、結果は予測できなくなります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2つの独立した論理的な決定を組み合わせても意味がありません。</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻訳者からのPS</font></font></h2><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font><font style="vertical-align: inherit;">
AWS IAMとKubernetesを統合するためのKIAMユーティリティアーキテクチャの詳細について、</font><font style="vertical-align: inherit;">作成者から</font><font style="vertical-align: inherit;">学ぶことができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私たちのブログでも読んでください：</font></font><br>
<br>
<ul>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">3   Kubernetes  production: anti-affinity, graceful shutdown, webhook</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  pod'  Kubernetes     Grafana Labs</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">6      Kubernetes [  ]</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">6     SRE-</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja477984/index.html">関連する唯一のメトリックの基本的なトラップ</a></li>
<li><a href="../ja477986/index.html">有毒なパリティ</a></li>
<li><a href="../ja477990/index.html">Quiet.js：超音波でデータを送受信するためのライブラリ</a></li>
<li><a href="../ja477992/index.html">Elixirのような構文を持つRubyメソッドシグネチャ仕様</a></li>
<li><a href="../ja477994/index.html">カオスエンジニアリング：意図的な破壊の芸術。パート3</a></li>
<li><a href="../ja478000/index.html">請負業者との契約に含まれている必要があります</a></li>
<li><a href="../ja478004/index.html">「1か月で、私はフルスタックの開発者になりました。」学生がABBYYでインターンシップについて語る</a></li>
<li><a href="../ja478006/index.html">ITの詐欺-ロシアに、または「煙突」（デューデリジェンス）の利点についての傾向が来ています。</a></li>
<li><a href="../ja478010/index.html">Airbnbで全国的な詐欺を誤って発見した方法</a></li>
<li><a href="../ja478012/index.html">プロバイダーを離れて送信し、任意のブラウザーでHTTPS経由のDNSを有効にする方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>