<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌛 🔦 👨🏿‍🤝‍👨🏽 Cases for Using Network Anomaly Analysis Tools: Leak Detection ☝🏼 🛌🏿 🕜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At one of the events, an interesting discussion ensued on the usefulness of NTA (Network Traffic Analysis) solutions, which, using the Netflow telemet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cases for Using Network Anomaly Analysis Tools: Leak Detection</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/cisco/blog/487346/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At one of the events, an interesting discussion ensued on the usefulness of NTA (Network Traffic Analysis) solutions, which, using the Netflow telemetry network infrastructure (or other flow protocols), makes it possible to detect a wide range of attacks. My opponents argued that when analyzing headers and related information (and NTA does not analyze the body of packet data, unlike the classic attack detection systems, IDS), you can not see much. In this article I will try to refute this opinion and to make the conversation more substantive, I will give some real examples when the NTA really helps to identify various anomalies and threats that are missing on the perimeter or even past the perimeter. And I’ll start with the threat that came first in the last year’s threat rating and, I think, will remain so this year.It will be about information leaks and the ability to detect them via network telemetry.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not consider the situation with the crooked hands of admins who left the Internet looking unprotected Elastic or MongoDB. Let's talk about the targeted actions of attackers, as was the case with the acclaimed story of Equifax credit bureaus. Let me remind you that in this case, the attackers first penetrated through the unpatched vulnerability to the public Web-portal, and then to the internal database servers. Remaining unnoticed for several months, they were able to steal data on 146 million credit bureau clients. Could such an incident be identified using DLP solutions? Most likely not, since classic DLPs are not tailored to the task of monitoring traffic from databases using specific protocols, and even under the condition that this traffic is encrypted.But the solution of the NTA class can quite easily detect such leaks by exceeding a certain threshold value of the amount of information downloaded from the database. Next, I will show how this is all configured and discovered using the Cisco Stealthwatch Enterprise solution.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the first thing we need to do is understand where our database servers are located in the network, determine their addresses and group them. In Cisco Stealthwatch, the inventory task can be performed either manually or using a special classifier that analyzes traffic and, according to the protocols used and the behavior of the node, allows you to attribute it to one or another category. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/n5/uy/rin5uykkickqn7znft9qa0ulllu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After we have information about all database servers, we begin an investigation to find out if we are leaking large amounts of data from the desired group of nodes. We see that in our case, the databases most actively communicate with DHCP servers and domain controllers.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lb/xq/1z/lbxq1znvwtgzs01n4quxfwtgjli.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Attackers often establish control over any of the network nodes and use it as a bridgehead to develop their attack. At the level of network traffic, it looks like an anomaly - network scanning from this node is becoming more frequent, data is being captured from the file share, or interaction with any servers. Therefore, our next task is to understand with whom exactly our databases most often communicate. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wb/er/0b/wber0bo8wqxtkswej7n7vmoffc8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the group of DHCP servers, it turns out that this is a node with the address 10.201.0.15, interaction with which accounts for about 50% of all traffic from database servers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yz/yb/vb/yzybvbnmgicokharg8oxu57lxwm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next logical question that we ask ourselves as part of the investigation is: “And what is this node like 10.201.0.15? Who is he interacting with? How often? What protocols? ”</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mt/-s/ac/mt-sacge5hjgo2jwerw7omqwmlk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that the node of interest to us communicates with various segments and nodes of our network (which is not surprising, since it is a DHCP server), but the question causes too much interaction with the terminal server with the address 10.201.0.23. Is this normal? There is clearly some kind of anomaly. A DHCP server cannot communicate so actively with a terminal server - 5610 streams and 23.5 GB of data. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4i/mk/jm/4imkjmqkv1eumztrmdyb88etx3c.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And this interaction is carried out through NFS. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vl/2a/wo/vl2awoxjk2kijyg494rvz8bqsr4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We take the next step and try to understand who our terminal server interacts with? It turns out that he has quite active communication with the outside world - with nodes in the USA, Great Britain, Canada, Denmark, the UAE, Qatar, Switzerland, etc.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uw/yr/3s/uwyr3shmwntm1clarsxud2xfcgq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suspicion was caused by the fact of P2P interaction with Puerto Rico, which accounted for 90% of all traffic. Moreover, our terminal server transmitted more than 17 GB of data to Puerto Rico via the 53rd port, which is connected with the DNS protocol. Can you imagine that you have such a volume of data transmitted via DNS? And I remind you that according to Cisco research, 92% of malware uses DNS to hide its activity (downloading updates, receiving commands, discharging data). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/mm/5b/f1mm5b4rmsqx5butgpw-mlsmk0e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if the ITU DNS protocol is not just open, but not inspected, then we have a huge hole in our perimeter. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yt/_4/dj/yt_4djyxlui4rzkyvsko1zsejlu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as the node 10.201.0.23 caused us such suspicions, let's see who he is still talking to?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zh/ya/7r/zhya7r8umwppjkxvidzpmpca9zy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our “suspect” exchanges half of all the traffic with the node 10.201.3.18, which is placed in a group of workstations of employees of the sales and marketing department. How typical are these for our organization for the terminal server to “communicate” with the computer of the seller or marketer?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pu/vq/nf/puvqnfekb1fdkqjenprrlsesxpi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we conducted an investigation and found out the following picture. Data from the database server was “poured” onto a DHCP server with their subsequent transfer via NFS to a terminal server inside our network, and then to external addresses in Puerto Rico using the DNS protocol. This is a clear violation of security policies. At the same time, the terminal server also interacted with one of the workstations within the network. What caused this incident? A stolen account? Infected device? We do not know. This will require a continuation of the investigation, which was based on the NTA class solution, which allows analyzing network traffic anomalies.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ge/wt/vo/gewtvo6-5k-41fdkkxaozhlep7q.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now we are interested in what will we do with the identified violations of security policy? You can conduct regular analysis according to the above scheme, or you can configure the NTA policy so that it immediately signals when similar violations are detected. This is done either through the corresponding general menu, or for each connection detected during the investigation. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cc/rp/qa/ccrpqaqizyxou5zjqqfw36hsl4i.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is what the interaction detection rule will look like, the source of which is the database server, and the destination is any external nodes, as well as any internal, excluding Web-servers.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hu/xy/ah/huxyah2skmz8jpc7d3dhtxtl3xe.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If such an event is detected, the network traffic analysis system immediately generates a correspondence alarm and, depending on the settings, sends it to SIEM, using the means of communication with the administrator, or it can even automatically block the detected violation (Cisco Stealthwatch does this by interacting with Cisco ISE ) </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/ii/rn/ljiirng2huuf6qzjxg-kiagufcu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recall that when I mentioned the case with Equifax, I mentioned that the attackers used an encrypted channel to dump data. For DLP, this traffic becomes an insoluble task, but for NTA-class solutions, they do not - they track any excess traffic or unauthorized interaction between nodes, regardless of the use of encryption.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u2/qg/qg/u2qgqgkkrsk_etuu7nav-k9hndg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only one case was shown above (in the following materials we will consider other examples of using NTA for information security purposes), but in fact, modern solutions of the Network Traffic Analysis class allow you to create very flexible rules and take into account not only the basic parameters of the IP packet header: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/15/ya/uk/15yaukzbimtm-o-yf41wnibz2ik.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
but also conduct a deeper analysis, up to associating the incident with the user name from Active Directory, searching for malicious files by hash (for example, obtained as a compromise indicator from SOSOPKA, FinCERT, Cisco Threat Grid, etc.), etc.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dc/oe/55/dcoe55wr_luv_kvpjjrqwapc5jc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is easy to implement. For example, this is how the usual rule looks for detecting all types of interaction between database servers and external nodes using any protocol over the past 30 days. We see that our databases “communicated” with nodes external to the DBMS segment using the DNS, SMB, and port 8088 protocols. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hn/70/nh/hn70nhlbp10lmjmgbkjj_8_bs8i.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the tabular form for presenting the results of investigations or searches, we can also visualize them. For our scenario, a fragment of the network flow diagram may look like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zs/yv/jf/zsyvjfgvrptgxwgv0eefnyz5pju.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And right from the same map we can manage policies - block connections or automate the process of creating monitoring rules for the flows of interest to us.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/tj/rk/ixtjrkszqelbtsgpwdmdxdluubm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is a quite interesting and lively example of using Netflow monitoring tools (and other flow protocols) for cybersecurity. </font><font style="vertical-align: inherit;">In the following notes, I plan to show how you can use NTA to detect malicious code (using the Shamoon example), malicious servers (using the DNSpionage campaign as an example), remote access programs (RAT), bypassing corporate proxies, etc.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487332/index.html">Test cheap Ergolux LED bulbs</a></li>
<li><a href="../en487334/index.html">How “remote" improves collaboration</a></li>
<li><a href="../en487336/index.html">Unity - Enable Multidex or Too Many Methods</a></li>
<li><a href="../en487340/index.html">As we did the next designer of chat bots. Part 1</a></li>
<li><a href="../en487342/index.html">Lesson # 2 - Meetings and Events</a></li>
<li><a href="../en487348/index.html">Priority task ranking - IL TEMPO app</a></li>
<li><a href="../en487356/index.html">Are you going to change? Think again</a></li>
<li><a href="../en487358/index.html">BERT, ELMO and Co. in pictures (how transfer training came to NLP)</a></li>
<li><a href="../en487360/index.html">Anonymization of data does not guarantee your complete anonymity</a></li>
<li><a href="../en487362/index.html">Angular 9 is now available - Ivy has arrived</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>