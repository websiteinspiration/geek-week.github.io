<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüéì üë∂üèæ üë©‚Äçüëß‚Äçüëß Otimiza√ß√£o de renderiza√ß√£o para celular üìì üëµüèø üë®üèº‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° queridos leitores, amantes e profissionais de programa√ß√£o gr√°fica! Chamamos a aten√ß√£o para uma s√©rie de artigos dedicados √† otimiza√ß√£o da renderiz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Otimiza√ß√£o de renderiza√ß√£o para celular</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/playrix/blog/492874/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° queridos leitores, amantes e profissionais de programa√ß√£o gr√°fica! Chamamos a aten√ß√£o para uma s√©rie de artigos dedicados √† otimiza√ß√£o da renderiza√ß√£o para dispositivos m√≥veis: telefones e tablets baseados em iOS e Android. O ciclo consistir√° em tr√™s partes. Na primeira parte, examinaremos os recursos da popular </font><font style="vertical-align: inherit;">arquitetura de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocos de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GPU </font><font style="vertical-align: inherit;">no celular </font><font style="vertical-align: inherit;">. No segundo, abordaremos as principais fam√≠lias de GPUs apresentadas em dispositivos modernos e consideraremos seus pontos fortes e fracos. Na terceira parte, vamos nos familiarizar com os recursos da otimiza√ß√£o de shader. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, vamos √† primeira parte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O desenvolvimento de placas de v√≠deo em desktops e consoles ocorreu na aus√™ncia de restri√ß√µes significativas ao consumo de energia. Com o advento das placas de v√≠deo para dispositivos m√≥veis, os engenheiros enfrentaram a tarefa de garantir um desempenho aceit√°vel em resolu√ß√µes de desktop compar√°veis, enquanto o consumo de energia dessas placas de v√≠deo deveria ser 2 ordens de magnitude menor.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/51e/4fa/969/51e4fa969a3e5ede3b31064499c33226.png"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solu√ß√£o foi encontrada em uma arquitetura especial chamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tile Based Rendering (TBR)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para um programador gr√°fico com experi√™ncia em desenvolvimento de PC, quando ele se familiariza com o desenvolvimento m√≥vel, tudo parece familiar: uma API OpenGL ES semelhante √© usada, a mesma estrutura do pipeline gr√°fico. No entanto, a arquitetura de blocos de GPUs m√≥veis √© significativamente diferente daquela usada nos consoles PC / </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo Imediato</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Conhecer os pontos fortes e fracos da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TBR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ajudar√° voc√™ a tomar as decis√µes corretas e obter um √≥timo desempenho com o Mobile. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abaixo est√° um diagrama simplificado de um pipeline gr√°fico cl√°ssico usado em PCs e consoles pela terceira d√©cada.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/281/67b/5e2/28167b5e2eaa4746ebd1ed45f8aa2dfb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No est√°gio de processamento da geometria, os atributos do v√©rtice s√£o lidos na mem√≥ria de v√≠deo da GPU. Ap√≥s v√°rias transforma√ß√µes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Vertex Shader), as</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> primitivas prontas para renderizar na ordem original (FIFO) s√£o passadas para o rasterizador, que divide as primitivas em pixels. Depois disso, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> realizado o est√°gio de processamento do fragmento de cada pixel </font><b><font style="vertical-align: inherit;">(Fragment Shader)</font></b><font style="vertical-align: inherit;"> e os valores de cores obtidos s√£o gravados no buffer da tela, que tamb√©m est√° localizado na mem√≥ria de v√≠deo. Um recurso da arquitetura tradicional do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúModo Imediato‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© a grava√ß√£o do resultado do Fragment Shader em se√ß√µes arbitr√°rias do buffer de tela ao processar uma √∫nica </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chamada de empate.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Assim, para cada chamada de empate, pode ser necess√°rio acesso a todo o buffer da tela. Trabalhar com uma grande variedade de mem√≥ria requer uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">largura de banda de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> barramento apropriada ( </font><b><font style="vertical-align: inherit;">largura de banda</font></b><font style="vertical-align: inherit;"> ) e est√° associado ao alto consumo de energia. Portanto, as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPUs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√≥veis </font><font style="vertical-align: inherit;">come√ßaram a adotar uma abordagem diferente. Na arquitetura de blocos t√≠pica das placas de v√≠deo m√≥veis, a renderiza√ß√£o √© feita em um pequeno peda√ßo de mem√≥ria correspondente √† parte da tela - o bloco. O tamanho pequeno do bloco (por exemplo, 16x16 pixels para placas de v√≠deo do Mali, 32x32 para PowerVR) permite coloc√°-lo diretamente no chip da placa de v√≠deo, o que torna a velocidade de acesso compar√°vel √† velocidade de acesso aos registros principais do shader, ou seja, muito r√°pido.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/7bf/c65/86d7bfc65e53739ab9be0d5ea1242c0e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, como as primitivas podem cair em se√ß√µes arbitr√°rias do buffer de tela e um bloco cobre apenas uma pequena parte dele, foi necess√°ria uma etapa adicional no pipeline de gr√°ficos. </font><font style="vertical-align: inherit;">A seguir, √© apresentado um diagrama simplificado de como o pipeline funciona com a arquitetura de blocos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/531/ea5/00c/531ea500c507eb47558676582e20c94c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de processar os v√©rtices e construir as primitivas, as √∫ltimas, em vez de serem enviadas para o pipeline de fragmentos, caem no chamado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tiler</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Aqui, as primitivas s√£o distribu√≠das por blocos, nos pixels dos quais caem. </font><font style="vertical-align: inherit;">Ap√≥s essa distribui√ß√£o, que, em regra, cobre todas as chamadas de desenho direcionadas a um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objeto de buffer de quadro</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tamb√©m conhecido como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">destino de renderiza√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), os blocos s√£o renderizados seq√ºencialmente. </font><font style="vertical-align: inherit;">Para cada bloco, a seguinte sequ√™ncia de a√ß√µes √© executada:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carregando conte√∫do antigo do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da mem√≥ria do sistema ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Renderizar primitivos que caem nesse bloco</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upload de novo conte√∫do do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na mem√≥ria do sistema ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Store</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
</ol><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9ea/20b/74b/9ea20b74b9fb716af30d5e0fa4ee1b34.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deve-se observar que a </font><font style="vertical-align: inherit;">opera√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carregamento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser considerada como uma superposi√ß√£o adicional da "textura de tela cheia" sem compacta√ß√£o. </font><font style="vertical-align: inherit;">Se poss√≠vel, evite esta opera√ß√£o, ou seja, </font><font style="vertical-align: inherit;">N√£o permita que o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alterne </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Se </font><font style="vertical-align: inherit;">todo o seu conte√∫do for limpo </font><font style="vertical-align: inherit;">antes da renderiza√ß√£o no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font><font style="vertical-align: inherit;">opera√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o ser√° executada. </font><font style="vertical-align: inherit;">No entanto, para enviar o sinal correto ao motorista, os par√¢metros dessa limpeza devem atender a certos crit√©rios:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deve ser desativado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scissor Rect</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A grava√ß√£o em todos os canais de cores e alfa deve ser permitida.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para impedir a </font><font style="vertical-align: inherit;">opera√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carregamento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do buffer de profundidade e do est√™ncil, eles tamb√©m precisam ser limpos antes do in√≠cio da renderiza√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m √© poss√≠vel evitar a opera√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">armazenamento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para o buffer de profundidade / est√™ncil. </font><font style="vertical-align: inherit;">Afinal, o conte√∫do desses buffers n√£o √© exibido de forma alguma na tela. </font><font style="vertical-align: inherit;">Antes da opera√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glSwapBuffers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><b><font style="vertical-align: inherit;">voc√™</font></b><font style="vertical-align: inherit;"> pode chamar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glDiscardFramebufferEXT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glInvalidateFramebuffer</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> GLenum attachments[] = {GL_DEPTH_ATTACHMENT, GL_STENCIL_ATTACHMENT};<font></font>
glDiscardFramebufferEXT (GL_FRAMEBUFFER, <span class="hljs-number">2</span>, attachments);</code></pre><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> GLenum attachments[] = {GL_DEPTH_ATTACHMENT, GL_STENCIL_ATTACHMENT};<font></font>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, attachments);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem cen√°rios de renderiza√ß√£o nos quais </font><font style="vertical-align: inherit;">n√£o √© necess√°ria </font><font style="vertical-align: inherit;">a coloca√ß√£o de buffers de profundidade / est√™ncil, bem como de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na mem√≥ria do sistema. Por exemplo, se a renderiza√ß√£o no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o buffer de profundidade for cont√≠nua e as informa√ß√µes de profundidade do quadro anterior n√£o forem usadas, o buffer de profundidade n√£o precisar√° ser carregado na mem√≥ria do bloco antes do in√≠cio da renderiza√ß√£o ou descarregado ap√≥s a conclus√£o da renderiza√ß√£o. Portanto, a mem√≥ria do sistema n√£o pode ser alocada no buffer de profundidade. APIs gr√°ficas modernas, como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vulkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metal,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permitem definir explicitamente o modo de mem√≥ria para suas contrapartes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">  &nbsp;( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTLStorageModeMemoryless</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metal, VK_IMAGE_USAGE_TRANSIENT_ATTACHMENT_BIT +</font></font></b> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VK_MEMORY_PROPERTY_LAZILY_ALLOCATED_BIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vulkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Destaca-se a implementa√ß√£o do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em arquiteturas de </font><font style="vertical-align: inherit;">blocos </font><font style="vertical-align: inherit;">. O buffer de alta resolu√ß√£o para o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o deixa a mem√≥ria do bloco dividindo o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em mais blocos. Por exemplo, para o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA 2x2, os</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> blocos de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16x16</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ser√£o resolvidos como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8x8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durante a </font><font style="vertical-align: inherit;">opera√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Armazenamento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou seja, No total, ser√° necess√°rio processar 4 vezes mais pe√ßas. Por√©m, a mem√≥ria adicional para o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o </font><b><font style="vertical-align: inherit;">√©</font></b><font style="vertical-align: inherit;"> necess√°ria e, devido √† renderiza√ß√£o na mem√≥ria r√°pida do bloco, n√£o haver√° restri√ß√µes significativas de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">largura de banda.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No entanto, use</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na arquitetura de </font><b><font style="vertical-align: inherit;">blocos</font></b><font style="vertical-align: inherit;"> aumenta a carga no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tiler, o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que pode afetar negativamente o desempenho da renderiza√ß√£o de cenas com muita geometria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resumindo o exposto, apresentamos o esquema desejado para trabalhar com o FBO na arquitetura de blocos:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// 1.   ,    auxFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, auxFBO);<font></font>
glDisable(GL_SCISSOR);<font></font>
glColorMask(GL_TRUE, GL_TRUE, GL_TRUE, GL_TRUE);<font></font>
glDepthMask(GL_TRUE);<font></font>
<span class="hljs-comment">// glClear,     </span><font></font>
glClear(GL_COLOR_BUFFER_BIT |&nbsp;GL_DEPTH_BUFFER_BIT |&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GL_STENCIL_BUFFER_BIT);<font></font>
<font></font>
renderAuxFBO();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
<font></font>
<span class="hljs-comment">//   /      </span>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, depth_and_stencil);
<span class="hljs-comment">// 2.   mainFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
glDisable(GL_SCISSOR);<font></font>
<font></font>
glClear(...);<font></font>
<span class="hljs-comment">//   mainFBO    auxFBO</span><font></font>
renderMainFBO(auxFBO);<font></font>
<font></font>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, depth_and_stencil);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ alternar para a renderiza√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auxFBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no meio da forma√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mainFBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , poder√° obter </font><font style="vertical-align: inherit;">opera√ß√µes </font><font style="vertical-align: inherit;">desnecess√°rias de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carregamento e armazenamento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o que pode aumentar significativamente o tempo de forma√ß√£o de quadros. </font><font style="vertical-align: inherit;">Em nossa pr√°tica, encontramos uma desacelera√ß√£o na renderiza√ß√£o, mesmo no caso de configura√ß√µes ociosas da FBO, ou seja, </font><font style="vertical-align: inherit;">sem a renderiza√ß√£o real neles. </font><font style="vertical-align: inherit;">Devido √† arquitetura do mecanismo, nosso circuito antigo era assim:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   mainFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
<span class="hljs-comment">//   </span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, auxFBO);<font></font>
<span class="hljs-comment">//  auxFBO</span><font></font>
renderAuxFBO();<font></font>
<font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
<span class="hljs-comment">//   mainFBO</span><font></font>
renderMainFBO(auxFBO);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apesar da falta de chamadas gl ap√≥s a primeira instala√ß√£o do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mainFBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , em alguns dispositivos obtivemos </font><font style="vertical-align: inherit;">opera√ß√µes </font><font style="vertical-align: inherit;">extras de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load &amp; Store</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e pior desempenho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para melhorar nossa compreens√£o das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">despesas indiretas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do uso de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBOs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> intermedi√°rios </font><font style="vertical-align: inherit;">, medimos a perda de tempo para alternar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBOs de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tela cheia </font><font style="vertical-align: inherit;">usando um teste sint√©tico. A tabela mostra o tempo gasto na </font><font style="vertical-align: inherit;">opera√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Store</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao alternar o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> v√°rias vezes </font><font style="vertical-align: inherit;">em um quadro (o tempo de uma dessas opera√ß√µes √© fornecido). </font><font style="vertical-align: inherit;">Opera√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausente devido ao </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glClear</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ou seja, </font><font style="vertical-align: inherit;">um cen√°rio mais favor√°vel foi medido. </font><font style="vertical-align: inherit;">A permiss√£o usada no dispositivo contribuiu. </font><font style="vertical-align: inherit;">Pode corresponder mais ou menos ao poder da GPU instalada. </font><font style="vertical-align: inherit;">Portanto, esses n√∫meros d√£o apenas uma id√©ia geral de quanto custa a troca de alvos em placas de v√≠deo m√≥veis de v√°rias gera√ß√µes.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">milissegundos</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">milissegundos</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 320</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2.</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 512</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,74</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerVR G6200</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3.</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 615</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,7</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-400</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2.</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 530</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,4</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-t720</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.9</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-g51</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,32</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerVR SXG 544</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-t830</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,15</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base nos dados obtidos, podemos chegar √† recomenda√ß√£o de n√£o usar mais de um ou dois comutadores FBO por quadro, pelo menos para placas de v√≠deo antigas. Se o jogo tiver uma passagem de c√≥digo separada para dispositivos low-end, √© aconselh√°vel n√£o usar a altera√ß√£o FBO l√°. No entanto, no low-end, a quest√£o da redu√ß√£o da resolu√ß√£o geralmente se torna relevante. No Android, voc√™ pode diminuir a resolu√ß√£o de renderiza√ß√£o sem recorrer ao uso de um FBO intermedi√°rio chamando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SurfaceHolder.setFixedSize ():</font></font></b><br>
<br>
<pre><code class="java hljs">surfaceView.getHolder().setFixedSize(...)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este m√©todo n√£o funcionar√° se o jogo for renderizado atrav√©s do </font><font style="vertical-align: inherit;">aplicativo </font><font style="vertical-align: inherit;">principal do </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surface</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (um esquema t√≠pico para trabalhar com o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NativeActivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Se voc√™ usar o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surface</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> principal </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> poder√° definir uma resolu√ß√£o mais baixa chamando a fun√ß√£o nativa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ANativeWindow_setBuffersGeometry.</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">JNIEXPORT <span class="hljs-keyword">void</span> JNICALL <span class="hljs-title">Java_com_organization_app_AppNativeActivity_setBufferGeometry</span><span class="hljs-params">(JNIEnv *env, jobject thiz, jobject surface, jint width, jint height)</span>
</span>{<font></font>
ANativeWindow* window = ANativeWindow_fromSurface(env, surface);&nbsp;<font></font>
ANativeWindow_setBuffersGeometry(window, width, height, AHARDWAREBUFFER_FORMAT_R8G8B8X8_UNORM);&nbsp;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em Java:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBufferGeometry</span><span class="hljs-params">(Surface surface, <span class="hljs-keyword">int</span> width , <span class="hljs-keyword">int</span> height )</span></span>;&nbsp;<font></font>
...<font></font>
<span class="hljs-comment">//   SurfaceHolder.Callback</span>
<span class="hljs-meta">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">surfaceChanged</span><span class="hljs-params">(SurfaceHolder holder, <span class="hljs-keyword">int</span> format, <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height)</span>
</span>{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setBufferGeometry(holder.getSurface(), <span class="hljs-number">768</span>, <span class="hljs-number">1366</span>); <span class="hljs-comment">/* ... */</span>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por fim, mencionamos o conveniente comando ADB para controlar os buffers de superf√≠cie selecionados no Android:</font></font><br>
<br>
<pre><code class="plaintext hljs">adb shell dumpsys surfaceflinger
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode obter uma conclus√£o semelhante que permite estimar o consumo de mem√≥ria para buffers de superf√≠cie:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/2fe/ea6/5242feea615abe186c6c3538c9d60565.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A captura de tela mostra o sistema destacando 3 buffers para o buffer triplo do </font><font style="vertical-align: inherit;">jogo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLSurfaceView</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (destacado em amarelo), bem como 2 buffers para a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">superf√≠cie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> principal </font><font style="vertical-align: inherit;">(destacada em vermelho). </font><font style="vertical-align: inherit;">No caso de renderiza√ß√£o atrav√©s do Surface principal, que √© o esquema padr√£o ao usar o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NativeActivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a aloca√ß√£o de buffers adicionais pode ser evitada.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â tudo por agora. </font><font style="vertical-align: inherit;">Nos artigos a seguir, classificaremos as GPUs m√≥veis, bem como analisaremos os m√©todos para otimizar shaders para elas.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt492862/index.html">15 melhores dicas de ajuste de desempenho do Oracle APEX para desenvolvedores</a></li>
<li><a href="../pt492864/index.html">Posso invadir um navio?</a></li>
<li><a href="../pt492866/index.html">O livro "Machine Learning sem palavras"</a></li>
<li><a href="../pt492868/index.html">Otimiza√ß√£o de string no ClickHouse. Relat√≥rio Yandex</a></li>
<li><a href="../pt492872/index.html">Como organizar o acesso remoto e n√£o sofrer hackers</a></li>
<li><a href="../pt492878/index.html">Chinelos geek: procurando resultados positivos em fechamentos tempor√°rios de escrit√≥rios</a></li>
<li><a href="../pt492880/index.html">O que devemos construir uma casa inteligente?</a></li>
<li><a href="../pt492884/index.html">Recebendo mensagens de transmiss√µes do youtube + autoriza√ß√£o do google em PHP</a></li>
<li><a href="../pt492886/index.html">Receita de testadores de recrutamento em massa</a></li>
<li><a href="../pt492888/index.html">Por que voc√™ n√£o deve usar o WireGuard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>