<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏼 🚊 🎅🏿 L'Internet des objets dans Yandex.Cloud: comment les services Yandex IoT Core et Yandex Cloud Functions sont organisés 🕓 👩🏿‍🎤 💩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En octobre de l'année dernière, la première conférence sur le cloud Yandex Yandex Scale a eu lieu. Il a annoncé le lancement de nombreux nouveaux serv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>L'Internet des objets dans Yandex.Cloud: comment les services Yandex IoT Core et Yandex Cloud Functions sont organisés</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/491740/"><img src="https://habrastorage.org/webt/wf/_u/zo/wf_uzobkj9vxp2ddkzxzux7lhbo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En octobre de l'année dernière, la première conférence sur le cloud Yandex Yandex Scale a eu lieu. Il a annoncé le lancement de nombreux nouveaux services, y compris Yandex IoT Core, qui vous permet d'échanger des données avec des millions d'appareils IoT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, je vais vous expliquer pourquoi Yandex IoT Core est nécessaire et comment il fonctionne, ainsi que comment il peut interagir avec d'autres services Yandex.Cloud. Vous en apprendrez sur l'architecture, les subtilités de l'interaction des composants et les caractéristiques de la mise en œuvre des fonctionnalités - tout cela vous aidera à optimiser l'utilisation de ces services.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, rappelons les principaux avantages des clouds publics et de la PaaS - réduire le temps et les coûts de développement, ainsi que les coûts de support et d'infrastructure, ce qui est également pertinent pour les projets IoT. Mais il existe quelques fonctionnalités utiles moins évidentes que vous pouvez obtenir dans le cloud. Cette mise à l'échelle efficace et cette tolérance aux pannes sont des aspects importants lorsque vous travaillez avec des appareils, en particulier dans les projets d'infrastructure d'informations critiques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une mise à l'échelle efficace est la capacité d'augmenter ou de diminuer librement le nombre d'appareils sans rencontrer de problèmes techniques et voir un changement prévisible du coût du système après les changements.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tolérance aux pannes est l'assurance que les services sont conçus et déployés de manière à garantir les meilleures performances possibles même en cas de défaillance de certaines ressources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entrons maintenant dans les détails.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture de script IoT</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons d'abord à quoi ressemble l'architecture globale du script IoT. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z_/po/yk/z_poykwjdwprirjgwkxmkvjnq0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On y distingue deux grandes parties:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le premier est la livraison des données au stockage et la livraison des commandes aux appareils. </font><font style="vertical-align: inherit;">Lorsque vous créez un système IoT, cette tâche doit être résolue dans tous les cas, quel que soit le projet que vous réalisez.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le second travaille avec les données reçues. </font><font style="vertical-align: inherit;">Tout est similaire à tout autre projet basé sur l'analyse et la visualisation d'ensembles de données. </font><font style="vertical-align: inherit;">Vous disposez d'un référentiel avec un tableau initial d'informations, avec lequel travailler vous permettra de réaliser votre tâche.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première partie est approximativement la même dans tous les systèmes IoT: elle est construite sur des principes généraux et s'inscrit dans un scénario commun adapté à la plupart des systèmes IoT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxième partie est presque toujours unique en termes de fonctions exécutées, bien qu'elle soit construite sur des composants standard. Dans le même temps, sans système d'interaction avec le matériel de haute qualité, tolérant aux pannes et évolutif, l'efficacité de la partie analytique de l'architecture est réduite à presque zéro, car il n'y a tout simplement rien à analyser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est pourquoi l'équipe Yandex.Cloud a tout d'abord décidé de se concentrer sur la création d'un écosystème de services pratique qui fournirait rapidement, efficacement et de manière fiable des données des appareils aux stockages, et vice versa - envoyer des commandes aux appareils.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tq/k8/ug/tqk8ugcmjnp3-s3cscc4ldhmuou.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour résoudre ces problèmes, nous travaillons sur la fonctionnalité et l'intégration de Yandex IoT Core, des fonctions Yandex et des services de stockage de données dans le Cloud: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le service Yandex IoT Core est un courtier MQTT évolutif à sécurité intégrée avec un ensemble de fonctions utiles supplémentaires.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le service Yandex Cloud Functions est représentatif de la direction prometteuse sans serveur et vous permet d'exécuter votre code en tant que fonction dans un environnement sûr, tolérant aux pannes et évolutif automatiquement sans créer ni entretenir de machines virtuelles.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le stockage d'objets Yandex est un stockage efficace de tableaux de données volumineux et convient parfaitement aux enregistrements d'archives «historiques».</font></font></li>
<li>          ,    ,      Yandex Managed Service for ClickHouse,     «»  .       «»      ,       ,     ,             .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si les services de stockage et d'analyse de données sont des services `` à usage général '' qui ont déjà été beaucoup écrits, alors Yandex IoT Core et son interaction avec Yandex Cloud Functions posent généralement beaucoup de questions, en particulier pour les personnes qui commencent tout juste à comprendre l'Internet des objets et les technologies cloud. </font><font style="vertical-align: inherit;">Et puisque ces services offrent une tolérance aux pannes et une mise à l'échelle du travail avec les appareils, nous verrons d'abord ce qu'ils ont sous le capot.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment fonctionne Yandex IoT Core</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex IoT Core est un service de plateforme spécialisé pour l'échange de données bidirectionnel entre le cloud et les appareils exécutant le protocole MQTT. En fait, ce protocole est devenu la norme pour le transfert de données vers l'IoT. Il utilise le concept de files d'attente nommées (rubriques), où, d'une part, vous pouvez écrire des données, et d'autre part, les recevoir de manière asynchrone en vous abonnant aux événements de cette file d'attente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le service Yandex IoT Core est multi-locataire, ce qui signifie une seule entité accessible à tous les utilisateurs. Autrement dit, tous les appareils et tous les utilisateurs interagissent avec la même instance de service.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela permet, d'une part, d'assurer l'uniformité du travail pour tous les utilisateurs, d'autre part, une mise à l'échelle efficace et une tolérance aux pannes, afin de maintenir une connexion avec un nombre illimité d'appareils et de traiter une quantité illimitée de données en volume et en vitesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'ensuit que le service doit avoir à la fois des mécanismes de redondance et la capacité de gérer de manière flexible les ressources utilisées - afin de répondre aux changements de charge. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, la multi-location nécessite une logique particulière de partage des droits d'accès aux rubriques MQTT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons comment cela est mis en œuvre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme de nombreux autres services Yandex.Cloud, Yandex IoT Core est logiquement divisé en deux parties - Plan de contrôle et Plan de données:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8a/u0/f3/8au0f3pzmwa1v-hhsxikvo_l_0m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data Plane est responsable de la logique de fonctionnement sous le protocole MQTT, et Control Plane est responsable de la délimitation des droits d'accès à certains sujets et utilise le registre et le périphérique des entités logiques à cette fin. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eu/b1/1n/eub11nm0nlmhprrhfqzohfwcyow.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque utilisateur de Yandex.Cloud peut avoir plusieurs registres, chacun pouvant contenir son propre sous-ensemble d'appareils. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'accès aux rubriques est fourni comme suit: Les </font></font><br>
<br>
<img src="https://habrastorage.org/webt/df/wc/hd/dfwchdy-bdwxs56mkgykrcs0ia4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
appareils peuvent envoyer des données uniquement à leur rubrique d'événements et à la rubrique d'événements de registre:</font></font><br>
<br>
<pre><code class="xml hljs">$devices/<span class="hljs-tag">&lt;<span class="hljs-name">Device1</span> <span class="hljs-attr">ID</span>&gt;</span>/events<font></font>
$registries/<span class="hljs-tag">&lt;<span class="hljs-name">Registry</span> <span class="hljs-attr">ID</span>&gt;</span>/events</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et abonnez-vous aux messages de votre rubrique de commandes et rubrique de commandes de registre:</font></font><br>
<br>
<pre><code class="xml hljs">$devices/<span class="hljs-tag">&lt;<span class="hljs-name">Device1</span> <span class="hljs-attr">ID</span>&gt;</span>/commands<font></font>
$registries/<span class="hljs-tag">&lt;<span class="hljs-name">Registry</span> <span class="hljs-attr">ID</span>&gt;</span>/commands</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le registre peut envoyer des données à toutes les rubriques des commandes de périphérique et à la rubrique des commandes de registre:</font></font><br>
<br>
<pre><code class="xml hljs">$devices/<span class="hljs-tag">&lt;<span class="hljs-name">Device1</span> <span class="hljs-attr">ID</span>&gt;</span>/commands<font></font>
$devices/<span class="hljs-tag">&lt;<span class="hljs-name">Device2</span> <span class="hljs-attr">ID</span>&gt;</span>/commands<font></font>
$registries/<span class="hljs-tag">&lt;<span class="hljs-name">Registry</span> <span class="hljs-attr">ID</span>&gt;</span>/commands</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et abonnez-vous aux messages de tous les sujets des événements de périphérique et du sujet des événements de registre:</font></font><br>
<br>
<pre><code class="xml hljs">$devices/<span class="hljs-tag">&lt;<span class="hljs-name">Device1</span> <span class="hljs-attr">ID</span>&gt;</span>/events<font></font>
$devices/<span class="hljs-tag">&lt;<span class="hljs-name">Device2</span> <span class="hljs-attr">ID</span>&gt;</span>/events<font></font>
$registries/<span class="hljs-tag">&lt;<span class="hljs-name">Registry</span> <span class="hljs-attr">ID</span>&gt;</span>/events</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour fonctionner avec toutes les entités décrites ci-dessus, Data Plane possède un protocole gRPC et un protocole REST, en fonction desquels l'accès est implémenté via la console GUI de Yandex.Cloud et l'interface de ligne de commande CLI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quant au Data Plane, il prend en charge la version 3.1.1 du protocole MQTT. </font><font style="vertical-align: inherit;">Cependant, il existe plusieurs fonctionnalités:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de la connexion, assurez-vous d'utiliser TLS.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seule la connexion TCP est prise en charge. </font><font style="vertical-align: inherit;">WebSocket n'est pas encore disponible.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'autorisation est disponible à la fois par login et mot de passe (où login est le périphérique ou l'ID de registre, et les mots de passe sont définis par l'utilisateur), et à l'aide de certificats.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'indicateur Conserver n'est pas pris en charge lors de l'utilisation du courtier MQTT qui enregistre le message marqué avec l'indicateur et l'envoie la prochaine fois que vous vous abonnez à la rubrique.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La session persistante n'est pas prise en charge, dans laquelle le courtier MQTT enregistre des informations sur le client (périphérique ou registre) pour faciliter la reconnexion.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec l'abonnement et la publication, seuls les deux premiers niveaux de service sont pris en charge:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QoS0 - Au plus une fois. </font><font style="vertical-align: inherit;">Il n'y a pas de garantie de livraison, mais il n'y a pas de nouvelle livraison du même message.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QoS1 - Au moins une fois. </font><font style="vertical-align: inherit;">La livraison est garantie, mais il est possible de recevoir à nouveau le même message.</font></font></li>
</ol></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour simplifier la connexion à Yandex IoT Core, nous ajoutons régulièrement de nouveaux exemples pour différentes plateformes et langues à notre référentiel sur GitHub, et décrivons également des scripts dans la documentation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'architecture du service ressemble à ceci: La </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6g/ig/4o/6gig4ofj7dksmbn18wvq5swkpuo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
logique métier du service comprend quatre parties:</font></font><br>
<br>
<ol>
<li> Device management —     .   Control Plane.</li>
<li> MQTT Broker —  MQTT-.  Data Plane.</li>
<li> Triggers —     Yandex Cloud Functions.  Data Plane.</li>
<li> Shards —      MQTT-    .  Data Plane.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toute interaction avec le «monde extérieur» passe par des équilibreurs de charge. De plus, conformément à la philosophie du dogfooding, Yandex Load Balancer est utilisé, disponible pour tous les utilisateurs de Yandex.Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque partie de la logique métier se compose de plusieurs ensembles de trois machines virtuelles - une dans chaque zone de disponibilité (dans les schémas A, B et C). Les machines virtuelles sont exactement les mêmes que tous les utilisateurs de Yandex.Cloud. Lorsque la charge augmente, la mise à l'échelle se fait à l'aide de l'ensemble complet - trois machines sont ajoutées à la fois dans le cadre d'une partie de la logique métier. Cela signifie que si un ensemble de trois machines MQTT Broker ne peut pas gérer la charge, un autre ensemble de trois machines MQTT Broker sera ajouté, tandis que la configuration des autres parties de la logique métier restera la même.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et seul Logbroker n'est pas accessible au public. Il s'agit d'un service pour un fonctionnement à sécurité intégrée efficace avec des flux de données. Il est basé sur Apache Kafka, mais il a de nombreuses autres fonctions utiles: il implémente des processus de reprise après sinistre (y compris une seule sémantique lorsque vous avez une garantie de livraison de message sans duplication) et des processus de service (tels que la réplication entre centres, la distribution de données clusters de calcul), et dispose également d'un mécanisme de distribution uniforme et non dupliquée des données entre les abonnés au flux - une sorte d'équilibreur de charge. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fonctions de gestion des appareils dans Control Plane sont décrites ci-dessus. Mais avec Data Plane, tout est beaucoup plus intéressant.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque instance de MQTT Broker fonctionne indépendamment et ne sait rien des autres instances. Toutes les données reçues (publiées par les clients) sont envoyées par les courtiers à Logbroker, d'où elles sont récupérées par Shards and Triggers. Et c'est dans les fragments que la synchronisation se produit entre les instances des courtiers. Les fragments connaissent tous les clients MQTT et la répartition de leurs abonnements (abonnement) entre les instances des courtiers MQTT et déterminent où envoyer les données reçues. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, le client MQTT A est abonné au sujet à partir du courtier A et le client MQTT B est abonné au même sujet à partir du courtier B. Si le client MQTT C effectue la publication sur le même sujet, mais au courtier C, le fragment transfère les données de courtier C aux courtiers A et B, à la suite de quoi les données seront reçues par le client MQTT A et le client MQTT B.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/dv/dz/iadvdzgd2cs6o1r3stjkqfhsq6y.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dernière partie de la logique métier, Déclencheurs, reçoit également toutes les données reçues des clients MQTT et, si elles sont configurées par l'utilisateur, les transfère aux déclencheurs du service Yandex Cloud Functions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, Yandex IoT Core a une architecture et une logique de travail assez compliquées, qui sont difficiles à répéter sur les installations locales. </font><font style="vertical-align: inherit;">Cela lui permet de résister à la perte de deux des trois zones de disponibilité, et de travailler sur un nombre illimité de connexions et des volumes de données illimités. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, toute cette logique est cachée à l'utilisateur «sous le capot», mais de l'extérieur, tout semble très simple - comme si vous travaillez avec un seul courtier MQTT.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déclencheurs et fonctions cloud Yandex</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex Cloud Functions est un représentant des services dits "sans serveur" (sans serveur) dans Yandex.Cloud. L'essence principale de ces services est que l'utilisateur ne passe pas son temps à configurer, déployer et faire évoluer l'environnement pour exécuter du code, mais ne s'occupe que de la chose la plus précieuse pour lui - écrire le code lui-même qui effectue la tâche nécessaire. Dans le cas des fonctions, il s'agit du code dit sans état atomique qui peut être déclenché par un événement. «Atomique» et «sans état» signifient que ce code doit effectuer une tâche relativement petite mais intégrale, tandis que le code ne doit utiliser aucune variable afin de stocker des valeurs entre les appels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe plusieurs façons d'appeler des fonctions: un appel HTTP direct, un appel avec minuterie (cron) ou un abonnement à un événement. Comme ce dernier, le service prend déjà en charge l'abonnement aux files d'attente de messages (Yandex Message Queue), les événements générés par le service de stockage d'objets et (le plus utile pour le scénario IoT) l'abonnement aux messages dans Yandex IoT Core.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré le fait que vous pouvez travailler avec Yandex IoT Core à l'aide de n'importe quel client compatible MQTT, Yandex Cloud Functions est l'un des moyens les plus optimaux et pratiques pour recevoir et traiter des données. La raison en est très simple. Une fonction peut être appelée sur chaque message entrant de n'importe quel appareil, et les fonctions seront exécutées en parallèle les unes aux autres (en raison de l'atomicité et de l'approche sans état), et le nombre de leurs appels changera naturellement à mesure que le nombre de messages entrants provenant des appareils changera. Ainsi, l'utilisateur peut ignorer complètement les problèmes de mise en place de l'infrastructure et, de plus, contrairement aux mêmes machines virtuelles, le paiement n'aura lieu que pour le travail réellement effectué.Cela vous permettra d'économiser considérablement à faible charge et d'obtenir un coût clair et prévisible avec la croissance.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mécanisme d'appel des fonctions sur les événements (abonnement aux événements) est appelé déclencheur (Trigger). Son essence est illustrée dans le diagramme: Un </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5u/yv/bn/5uyvbnyviueygxt4ykzdh9n2nug.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
service qui génère des événements pour appeler des fonctions les place dans une file d'attente dans Logbroker. Dans le cas de Yandex IoT Core, les déclencheurs de Data Plane le font. De plus, ces événements sont pris par le préprocesseur, qui recherche un enregistrement dans la base de données pour cet événement indiquant la fonction à appeler. Si une telle entrée est trouvée, le préprocesseur place les informations sur l'appel de fonction (ID de fonction et paramètres d'appel) dans la file d'attente du service Yandex Message Queue, d'où le gestionnaire d'appel la récupère. Le gestionnaire, à son tour, envoie une demande HTTP pour appeler la fonction au service Yandex Cloud Functions.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même temps, encore une fois, conformément à la philosophie dogfooding, le service Yandex Message Queue, accessible à tous les utilisateurs, est utilisé et les fonctions sont appelées exactement de la même manière que tout autre utilisateur peut appeler leurs fonctions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disons quelques mots sur Yandex Message Queue. Bien qu'il s'agisse d'un service de file d'attente, comme Logbroker, il existe une différence significative entre eux. Lors du traitement des messages des files d'attente, le gestionnaire informe la file d'attente qu'elle est terminée et que le message peut être supprimé. Il s'agit d'un mécanisme de fiabilité important dans de tels services, mais il complique la logique de travail avec les messages.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex Message Queue vous permet de «paralléliser» le traitement de chaque message dans la file d'attente. En d'autres termes, le message de la file d'attente en cours de traitement ne bloque pas la possibilité qu'un autre "thread" récupère l'événement suivant de la file d'attente pour traitement. C'est ce qu'on appelle la simultanéité au niveau du message. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et LogBroker fonctionne sur les groupes de messages, et tant que le groupe entier n'est pas traité, le groupe suivant ne peut pas être récupéré pour traitement. Cette approche est appelée concurrence au niveau de la partition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et c'est précisément l'utilisation de Yandex Message Queue qui vous permet de traiter rapidement et efficacement en parallèle un grand nombre de demandes pour appeler une fonction pour les événements d'un service particulier.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que les déclencheurs soient une unité indépendante distincte, ils font partie du service Yandex Cloud Functions. Il nous suffit de comprendre exactement comment les fonctions sont appelées.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fb/ew/ke/fbewkedbrp6eyri7zkubwiu6dzu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les demandes d'appeler des fonctions (externes et internes) tombent dans l'équilibreur de charge, qui les distribue aux routeurs dans différentes zones d'accès (AZ), plusieurs éléments sont déployés dans chaque zone. Lors de la réception d'une demande, le routeur va d'abord au service Identity and Access Manager (IAM) pour s'assurer que la source de la demande a le droit d'appeler cette fonction. Il se tourne ensuite vers le planificateur et demande sur quel travailleur exécuter la fonction. Worker est une machine virtuelle avec un runtime personnalisé de fonctions isolées. De plus, le routeur, ayant reçu du planificateur l'adresse du travailleur sur lequel exécuter la fonction, envoie une commande à ce travailleur pour démarrer la fonction avec certains paramètres.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'où vient le travailleur? C'est là que toute la magie sans serveur se produit. Les planificateurs, analysant la charge (le nombre et la durée des fonctions), gèrent (démarrent et arrêtent) les machines virtuelles avec un runtime particulier. NodeJS et Python sont désormais pris en charge. Et ici, un paramètre est extrêmement important - la vitesse de lancement des fonctions. L'équipe de développement des services a fait un excellent travail, et maintenant la machine virtuelle démarre dans un maximum de 250 ms, tout en utilisant l'environnement le plus sécurisé pour isoler les fonctions les unes des autres - la virtualisation QEMU, qui exécute tout Yandex. Cloud. Dans le même temps, s'il existe déjà un travailleur actif pour la demande entrante, la fonction démarre presque instantanément.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et, conformément à la même approche dogfooding, le Load Balancer utilise un service public accessible à tous les utilisateurs, et le travailleur, le planificateur et le routeur sont des machines virtuelles ordinaires, les mêmes que tous les utilisateurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la tolérance aux pannes du service est implémentée au niveau de l'équilibreur de charge et de la redondance des composants clés du système (routeur et ordonnanceur), et la mise à l'échelle se produit en raison du déploiement ou de la réduction du nombre de travailleurs. </font><font style="vertical-align: inherit;">De plus, chaque zone d'accessibilité fonctionne indépendamment, ce qui permet de survivre à la perte de même deux des trois zones.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liens utiles</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conclusion, je souhaite vous donner quelques liens qui vous permettront d'étudier plus en détail les services:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex IoT Core: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud.yandex.ru/services/iot-core</font></font></a> </li>
<li> Yandex Cloud Functions: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cloud.yandex.ru/services/functions</a> </li>
<li> Yandex Message Queue: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cloud.yandex.ru/services/message-queue</a> </li>
<li> Yandex Managed Service for ClickHouse: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cloud.yandex.ru/services/managed-clickhouse</a> </li>
<li> Yandex Load Balancer: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cloud.yandex.ru/services/load-balancer</a> </li>
<li> Yandex Object Storage: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cloud.yandex.ru/services/storage</a> </li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491724/index.html">Le livre "Laravel. Guide complet. 2e édition</a></li>
<li><a href="../fr491726/index.html">Développer les colonnes imbriquées - listes utilisant le langage R (paquet tidyr et fonctions familiales unnest)</a></li>
<li><a href="../fr491728/index.html">Principe SEC avec Laravel</a></li>
<li><a href="../fr491732/index.html">Y a-t-il une vie après Scratch, ou comment initier un enfant à Python</a></li>
<li><a href="../fr491736/index.html">TMS1000: le premier microcontrôleur disponible dans le commerce</a></li>
<li><a href="../fr491742/index.html">Sherbet: clavier de jeu ergonomique</a></li>
<li><a href="../fr491744/index.html">Des pirates iraniens ont exploité des vulnérabilités dans un VPN</a></li>
<li><a href="../fr491746/index.html">L'histoire de la synthèse vocale: l'ère des solutions électriques</a></li>
<li><a href="../fr491748/index.html">Technologies qui aident les aveugles à apprendre l'anglais</a></li>
<li><a href="../fr491750/index.html">Nous écrivons mieux la recherche de sous-chaînes que dans les manuels</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>