<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéõÔ∏è üöÜ ü•ñ Antipatterns PostgreSQL: quelle est la profondeur du trou du lapin? passer par la hi√©rarchie ü§±üèø üë©‚Äç‚öñÔ∏è üòÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans les syst√®mes ERP complexes, de nombreuses entit√©s ont une nature hi√©rarchique , lorsque des objets homog√®nes s'alignent dans une arborescence de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Antipatterns PostgreSQL: quelle est la profondeur du trou du lapin? passer par la hi√©rarchie</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/501614/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans les syst√®mes ERP complexes, de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombreuses entit√©s ont une nature hi√©rarchique</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lorsque des objets homog√®nes s'alignent dans une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arborescence de relations anc√™tre-descendant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - il s'agit de la structure organisationnelle de l'entreprise (toutes ces branches, d√©partements et groupes de travail), et du catalogue de produits, des zones de travail et de la g√©ographie. points de vente, ... </font><font style="vertical-align: inherit;">
En fait, il n'y a pas une seule </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">sph√®re de l'automatisation des affaires</font></a><font style="vertical-align: inherit;"> o√π au moins une certaine hi√©rarchie ne serait pas le r√©sultat. Mais m√™me si vous ne travaillez pas ¬´pour les affaires¬ª, vous pouvez toujours rencontrer facilement des relations hi√©rarchiques. Trite, m√™me votre arbre g√©n√©alogique ou plan d'√©tage des locaux dans le centre commercial est la m√™me structure. </font><font style="vertical-align: inherit;">
Il existe de nombreuses fa√ßons de stocker une telle arborescence dans un SGBD, mais aujourd'hui, nous nous concentrerons sur une seule option:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/-o/tq/ad/-otqadbymksleulmgjdpxf6e2bo.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> hier(
  <span class="hljs-keyword">id</span>
    <span class="hljs-built_in">integer</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, pid<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> hier<font></font>
, <span class="hljs-keyword">data</span>
    <span class="hljs-keyword">json</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> hier(pid); <span class="hljs-comment">--  ,  FK    ,    PK</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pendant que vous regardez dans les profondeurs de la hi√©rarchie, il attend patiemment la fa√ßon dont [na√Øf] vos mani√®res "na√Øves" de travailler avec une telle structure se r√©v√©leront.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nx/na/_z/nxna_zsl1hv506-owlmrxybpute.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analysons les t√¢ches √©mergentes typiques, leur impl√©mentation en SQL et essayons d'am√©liorer leurs performances.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#1. </font><font style="vertical-align: inherit;">Quelle est la profondeur du terrier du lapin?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons, pour √™tre pr√©cis, que cette structure refl√©tera la subordination des d√©partements dans la structure de l'organisation: d√©partements, divisions, secteurs, branches, groupes de travail ... peu importe comment vous les appelez.</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kl/yg/ck/klygckuyurttjnrskva_a6clwfy.png"></div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, nous g√©n√©rons notre ¬´arbre¬ª ‚Äã‚Äãd'√©l√©ments 10K</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hier
<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-number">1</span>::<span class="hljs-built_in">integer</span> <span class="hljs-keyword">id</span>
  , <span class="hljs-string">'{1}'</span>::<span class="hljs-built_in">integer</span>[] pids
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">id</span> + <span class="hljs-number">1</span>
  , pids[<span class="hljs-number">1</span>:(random() * array_length(pids, <span class="hljs-number">1</span>))::<span class="hljs-built_in">integer</span>] || (<span class="hljs-keyword">id</span> + <span class="hljs-number">1</span>)
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> &lt; <span class="hljs-number">10000</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  pids[array_length(pids, <span class="hljs-number">1</span>)] <span class="hljs-keyword">id</span>
, pids[array_length(pids, <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>] pid
<span class="hljs-keyword">FROM</span>
  T;</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par la t√¢che la plus simple - trouver tous les employ√©s qui travaillent dans un secteur sp√©cifique, ou en termes de hi√©rarchie - pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trouver tous les descendants d'un n≈ìud</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il serait √©galement int√©ressant d'obtenir la ¬´profondeur¬ª du descendant ... Tout cela peut √™tre n√©cessaire, par exemple, pour construire une sorte de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©lection complexe √† partir de la liste des identifiants de ces employ√©s</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout irait bien s'il n'y avait que quelques niveaux de ces descendants et quantitativement dans une douzaine, mais s'il y a plus de 5 niveaux et qu'il y a d√©j√† des dizaines de descendants, il peut y avoir des probl√®mes. </font><font style="vertical-align: inherit;">Voyons comment les options de recherche traditionnelles ¬´en bas de l'arbre¬ª ‚Äã‚Äãsont √©crites (et fonctionnent). </font><font style="vertical-align: inherit;">Mais d'abord, nous d√©terminons lequel des n≈ìuds sera le plus int√©ressant pour notre recherche. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les </font><font style="vertical-align: inherit;">sous-arbres </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"les plus profonds"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">id</span><font></font>
  , pid<font></font>
  , <span class="hljs-built_in">ARRAY</span>[<span class="hljs-keyword">id</span>] <span class="hljs-keyword">path</span>
  <span class="hljs-keyword">FROM</span><font></font>
    hier<font></font>
  <span class="hljs-keyword">WHERE</span>
    pid <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    hier.id<font></font>
  , hier.pid<font></font>
  , T.path || hier.id<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    hier<font></font>
      <span class="hljs-keyword">ON</span> hier.pid = T.id<font></font>
)<font></font>
<span class="hljs-keyword">TABLE</span> T <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> array_length(<span class="hljs-keyword">path</span>, <span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span>;</code></pre><br>
<pre><code class="plaintext hljs"> id  | pid  | path<font></font>
---------------------------------------------<font></font>
7624 | 7623 | {7615,7620,7621,7622,7623,7624}<font></font>
4995 | 4994 | {4983,4985,4988,4993,4994,4995}<font></font>
4991 | 4990 | {4983,4985,4988,4989,4990,4991}<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les </font><font style="vertical-align: inherit;">sous-arbres </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"les plus larges"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs">...
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">path</span>[<span class="hljs-number">1</span>] <span class="hljs-keyword">id</span>
, <span class="hljs-keyword">count</span>(*)
<span class="hljs-keyword">FROM</span><font></font>
  T<font></font>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">2</span> <span class="hljs-keyword">DESC</span>;</code></pre><br>
<pre><code class="plaintext hljs">id   | count<font></font>
------------<font></font>
5300 |   30<font></font>
 450 |   28<font></font>
1239 |   27<font></font>
1573 |   25<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ces requ√™tes, nous avons utilis√© un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOIN r√©cursif</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> typique </font><font style="vertical-align: inherit;">: </font></font><br>
<img src="https://habrastorage.org/webt/lx/cx/3n/lxcx3n6k4cttix3mbrcoj8hyap8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âvidemment, avec ce mod√®le de requ√™te, le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre d'it√©rations co√Øncidera avec le nombre total de descendants</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (et il y en a plusieurs dizaines), et cela peut prendre des ressources assez importantes et, par cons√©quent, du temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√©rifions le sous-arbre "le plus large":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">id</span>
  <span class="hljs-keyword">FROM</span><font></font>
    hier<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-number">5300</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    hier.id<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    hier<font></font>
      <span class="hljs-keyword">ON</span> hier.pid = T.id<font></font>
)<font></font>
<span class="hljs-keyword">TABLE</span> T;</code></pre><br>
<img src="https://habrastorage.org/webt/gx/xg/q6/gxxgq6p6c0eynpmffoohetg2iye.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
expliquez.tensor.ru </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">]</font></a><font style="vertical-align: inherit;"> Comme pr√©vu, nous avons trouv√© les 30 entr√©es. </font><font style="vertical-align: inherit;">Mais ils y ont consacr√© 60% du temps - car ils ont effectu√© 30 recherches sur l'index. </font><font style="vertical-align: inherit;">Et moins - vous le pouvez?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relecture en masse par index</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour chaque n≈ìud, devons-nous faire une demande d'index distincte? Il s'av√®re que non - nous pouvons lire √† partir de l'index </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur plusieurs touches √† la fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec </font><b><font style="vertical-align: inherit;">un seul appel</font></b></font><code>= ANY(array)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et dans chacun de ces groupes d'identifiants, nous pouvons prendre tous les identifiants trouv√©s √† l'√©tape pr√©c√©dente par des ¬´n≈ìuds¬ª. Autrement dit, √† chaque √©tape suivante, nous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rechercherons imm√©diatement tous les descendants d'un certain niveau √† la fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais, par malchance, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans une s√©lection r√©cursive, vous ne pouvez pas vous r√©f√©rer √† vous-m√™me dans une sous-requ√™te</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais nous devons simplement s√©lectionner en quelque sorte exactement ce qui a √©t√© trouv√© au niveau pr√©c√©dent ... Il s'av√®re que vous ne pouvez pas faire une sous-requ√™te √† l'ensemble de l'√©chantillon, mais √† son champ sp√©cifique - pouvez. Et ce champ peut √©galement √™tre un tableau - c'est ce que nous devons utiliser</font></font><code>ANY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble un peu sauvage, mais sur le diagramme - tout est simple.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/_t/qz/fm_tqzx1c9ri4-mbrgtxqvjizri.png"><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-built_in">ARRAY</span>[<span class="hljs-keyword">id</span>] <span class="hljs-keyword">id</span>$
  <span class="hljs-keyword">FROM</span><font></font>
    hier<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-number">5300</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">id</span>
      <span class="hljs-keyword">FROM</span><font></font>
        hier<font></font>
      <span class="hljs-keyword">WHERE</span>
        pid = <span class="hljs-keyword">ANY</span>(T.id$)<font></font>
    ) <span class="hljs-keyword">id</span>$
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">coalesce</span>(<span class="hljs-keyword">id</span>$, <span class="hljs-string">'{}'</span>) &lt;&gt; <span class="hljs-string">'{}'</span> <span class="hljs-comment">--     -  </span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">unnest</span>(<span class="hljs-keyword">id</span>$) <span class="hljs-keyword">id</span>
<span class="hljs-keyword">FROM</span>
  T;</code></pre><br>
<img src="https://habrastorage.org/webt/i0/a-/sk/i0a-sk-ytooivrkxwyxsq-ipnoi.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Et ici, la chose la plus importante n'est m√™me pas de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gagner 1,5 fois dans le temps</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais que nous avons soustrait moins de tampons, car nous n'avons que 5 appels √† l'index au lieu de 30! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un bonus suppl√©mentaire est le fait qu'apr√®s la derni√®re version, les identifiants ne seront pas class√©s par ¬´niveaux¬ª.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Balise de n≈ìud</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La prochaine consid√©ration qui contribuera √† am√©liorer la productivit√© est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que les ¬´feuilles¬ª ne peuvent pas avoir d‚Äôenfants</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c‚Äôest-√†-dire qu‚Äôelles n‚Äôont pas besoin de regarder vers le bas. Dans la formulation de notre t√¢che, cela signifie que si nous suivons la cha√Æne des d√©partements et atteignons l'employ√©, il n'est pas n√©cessaire de chercher plus loin dans cette branche. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduisons un </font><b><font style="vertical-align: inherit;">champ </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suppl√©mentaire</font></font><code>boolean</code><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans notre table </font><font style="vertical-align: inherit;">, qui nous dira tout de suite si cette entr√©e particuli√®re dans notre arbre est un ¬´n≈ìud¬ª </font><b><font style="vertical-align: inherit;">- c'est-√†-dire</font></b><font style="vertical-align: inherit;"> , si elle peut avoir des enfants.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> hier
  <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> branch <span class="hljs-built_in">boolean</span>;<font></font>
<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  hier T<font></font>
<span class="hljs-keyword">SET</span>
  branch = <span class="hljs-literal">TRUE</span>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">EXISTS</span>(
    <span class="hljs-keyword">SELECT</span>
      <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">FROM</span><font></font>
      hier<font></font>
    <span class="hljs-keyword">WHERE</span><font></font>
      pid = T.id<font></font>
    <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span><font></font>
);<font></font>
<span class="hljs-comment">--   : 3033    42 .</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien! </font><font style="vertical-align: inherit;">Il s'av√®re que seulement un peu plus de 30% de tous les √©l√©ments d'arbre ont des descendants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, </font></font><code>LATERAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous allons </font><font style="vertical-align: inherit;">appliquer une m√©canique l√©g√®rement diff√©rente - la connexion √† la partie r√©cursive </font><font style="vertical-align: inherit;">, qui nous permettra d'acc√©der imm√©diatement aux champs de la "table" r√©cursive, et d'utiliser la fonction d'agr√©gation avec la condition de filtre par l'attribut du n≈ìud pour r√©duire le jeu de cl√©s:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/3x/vb/f13xvb2zblngijramviz8kpidks.png"><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    array_agg(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">id</span>$<font></font>
  , array_agg(<span class="hljs-keyword">id</span>) FILTER(<span class="hljs-keyword">WHERE</span> branch) ns$
  <span class="hljs-keyword">FROM</span><font></font>
    hier<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-number">5300</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    X.*<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (
    <span class="hljs-keyword">SELECT</span>
      array_agg(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">id</span>$<font></font>
    , array_agg(<span class="hljs-keyword">id</span>) FILTER(<span class="hljs-keyword">WHERE</span> branch) ns$
    <span class="hljs-keyword">FROM</span><font></font>
      hier<font></font>
    <span class="hljs-keyword">WHERE</span>
      pid = <span class="hljs-keyword">ANY</span>(T.ns$)<font></font>
  ) X<font></font>
    <span class="hljs-keyword">ON</span> <span class="hljs-keyword">coalesce</span>(T.ns$, <span class="hljs-string">'{}'</span>) &lt;&gt; <span class="hljs-string">'{}'</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">unnest</span>(<span class="hljs-keyword">id</span>$) <span class="hljs-keyword">id</span>
<span class="hljs-keyword">FROM</span>
  T;</code></pre><br>
<img src="https://habrastorage.org/webt/jc/6r/fa/jc6rfaqvbbvy6avqifoi1bf5chk.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[regardez expliquez.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nous avons pu r√©duire un autre appel √† l'indice et avons </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gagn√© plus de 2 fois en termes de montant</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©duit.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2 </font><font style="vertical-align: inherit;">Retour aux sources</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet algorithme sera utile si vous devez collecter des enregistrements pour tous les √©l√©ments ¬´dans l'arborescence¬ª, tout en conservant des informations sur la feuille source (et avec quels indicateurs) qui l'a fait tomber dans l'√©chantillon - par exemple, pour g√©n√©rer un rapport r√©capitulatif avec agr√©gation des n≈ìuds.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ah/xs/xb/ahxsxbntkmfs884ggqqqvoeyqbc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La seconde doit √™tre consid√©r√©e exclusivement comme une preuve de concept, car la demande est tr√®s lourde. </font><font style="vertical-align: inherit;">Mais s'il domine votre base de donn√©es - il vaut la peine d'envisager l'utilisation de telles techniques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par quelques d√©clarations simples:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√©f√©rable de ne lire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le m√™me enregistrement de la base de donn√©es </font><b><font style="vertical-align: inherit;">qu'une seule fois</font></b><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les entr√©es de la base de donn√©es sont </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lues plus efficacement dans un "ensemble"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qu'individuellement.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons maintenant de concevoir la requ√™te dont nous avons besoin.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtape 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âvidemment, lors de l'initialisation de la r√©cursion (o√π sans elle!) Nous devrons soustraire les enregistrements des feuilles eux-m√™mes de l'ensemble des identifiants de source:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    rec <span class="hljs-comment">--    </span>
  , <span class="hljs-keyword">id</span>::<span class="hljs-built_in">text</span> chld <span class="hljs-comment">--  ""    </span>
  <span class="hljs-keyword">FROM</span><font></font>
    hier rec<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192}'</span>::<span class="hljs-built_in">integer</span>[])
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il semble √©trange √† quelqu'un que ¬´l'ensemble¬ª soit stock√© dans une cha√Æne, pas dans un tableau, alors il y a une explication simple. </font><font style="vertical-align: inherit;">Pour les cha√Ænes, il existe une fonction int√©gr√©e de ¬´collage¬ª d'agr√©gation </font></font><code>string_agg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais pour les tableaux, non. </font><font style="vertical-align: inherit;">Bien qu'il </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> soit </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">pas difficile de le mettre en ≈ìuvre vous-m√™me</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtape 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous aurions un ensemble d'ID de section qui devront √™tre soustraits davantage. </font><font style="vertical-align: inherit;">Presque toujours, ils seront dupliqu√©s dans diff√©rents enregistrements de l'ensemble source - nous les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">regrouperions donc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tout en conservant les informations sur les feuilles source. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ici trois probl√®mes nous attendent:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La partie "sous-r√©cursive" d'une requ√™te ne peut pas contenir de fonctions d'agr√©gation c </font></font><code>GROUP BY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un appel √† une ¬´table¬ª r√©cursive ne peut pas √™tre dans une sous-requ√™te imbriqu√©e.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une requ√™te dans la partie r√©cursive ne peut pas contenir un CTE.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, tous ces probl√®mes sont facilement contourn√©s. </font><font style="vertical-align: inherit;">Commen√ßons par la fin.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTE dans la partie r√©cursive</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce n'est </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comme </font><b><font style="vertical-align: inherit;">√ßa</font></b><font style="vertical-align: inherit;"> que </font><b><font style="vertical-align: inherit;">√ßa</font></b><font style="vertical-align: inherit;"> marche:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (<font></font>
  ...<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-keyword">WITH</span> T (...)
  <span class="hljs-keyword">SELECT</span> ...<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc √ßa marche, les parenth√®ses d√©cident!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (<font></font>
  ...<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
  (<font></font>
    <span class="hljs-keyword">WITH</span> T (...)
    <span class="hljs-keyword">SELECT</span> ...<font></font>
  )<font></font>
)</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Requ√™te imbriqu√©e pour une "table" r√©cursive</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hmm ... Un appel √† un CTE r√©cursif ne peut pas √™tre dans une sous-requ√™te. </font><font style="vertical-align: inherit;">Mais √ßa peut √™tre √† l'int√©rieur du CTE! </font><font style="vertical-align: inherit;">Une sous-demande peut d√©j√† faire r√©f√©rence √† ce CTE!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GROUPE PAR r√©cursivit√© int√©rieure</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est d√©sagr√©able, mais ... Nous avons aussi un moyen simple de simuler GROUP BY en utilisant </font></font><code>DISTINCT ON</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les fonctions de la fen√™tre!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  (rec).pid <span class="hljs-keyword">id</span>
, string_agg(chld::<span class="hljs-built_in">text</span>, <span class="hljs-string">','</span>) chld
<span class="hljs-keyword">FROM</span><font></font>
  tree<font></font>
<span class="hljs-keyword">WHERE</span>
  (rec).pid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span> <span class="hljs-comment">--  !</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc √ßa marche!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>((rec).pid)<font></font>
  (rec).pid <span class="hljs-keyword">id</span>
, string_agg(chld::<span class="hljs-built_in">text</span>, <span class="hljs-string">','</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> (rec).pid) chld
<span class="hljs-keyword">FROM</span><font></font>
  tree<font></font>
<span class="hljs-keyword">WHERE</span>
  (rec).pid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons maintenant pourquoi l'ID num√©rique s'est transform√© en texte - afin qu'ils puissent √™tre coll√©s avec une virgule!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtape 3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la finale, il ne nous reste plus rien:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous lisons des enregistrements de "sections" sur un ensemble d'ID group√©s</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">faire correspondre les sections soustraites avec les ¬´ensembles¬ª de feuilles source</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"D√©veloppez" la cha√Æne d√©finie √† l'aide de </font></font><code>unnest(string_to_array(chld, ',')::integer[])</code></li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    rec<font></font>
  , <span class="hljs-keyword">id</span>::<span class="hljs-built_in">text</span> chld
  <span class="hljs-keyword">FROM</span><font></font>
    hier rec<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">id</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192}'</span>::<span class="hljs-built_in">integer</span>[])
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
  (<font></font>
    <span class="hljs-keyword">WITH</span> prnt <span class="hljs-keyword">AS</span> (
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>((rec).pid)<font></font>
        (rec).pid <span class="hljs-keyword">id</span>
      , string_agg(chld::<span class="hljs-built_in">text</span>, <span class="hljs-string">','</span>) <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> (rec).pid) chld
      <span class="hljs-keyword">FROM</span><font></font>
        tree<font></font>
      <span class="hljs-keyword">WHERE</span>
        (rec).pid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span><font></font>
    )<font></font>
    , nodes <span class="hljs-keyword">AS</span> (
      <span class="hljs-keyword">SELECT</span><font></font>
        rec<font></font>
      <span class="hljs-keyword">FROM</span><font></font>
        hier rec<font></font>
      <span class="hljs-keyword">WHERE</span>
        <span class="hljs-keyword">id</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-built_in">ARRAY</span>(
          <span class="hljs-keyword">SELECT</span>
            <span class="hljs-keyword">id</span>
          <span class="hljs-keyword">FROM</span><font></font>
            prnt<font></font>
        ))<font></font>
    )<font></font>
    <span class="hljs-keyword">SELECT</span><font></font>
      nodes.rec<font></font>
    , prnt.chld<font></font>
    <span class="hljs-keyword">FROM</span><font></font>
      prnt<font></font>
    <span class="hljs-keyword">JOIN</span><font></font>
      nodes<font></font>
        <span class="hljs-keyword">ON</span> (nodes.rec).id = prnt.id<font></font>
  )<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">unnest</span>(string_to_array(chld, <span class="hljs-string">','</span>)::<span class="hljs-built_in">integer</span>[]) leaf<font></font>
, (rec).*<font></font>
<span class="hljs-keyword">FROM</span>
  tree;</code></pre><br>
<img src="https://habrastorage.org/webt/hl/e5/jn/hle5jn8eolot086fr-ecmutxlye.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[  explain.tensor.ru]</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr501598/index.html">Un guide modeste des sch√©mas de base de donn√©es</a></li>
<li><a href="../fr501600/index.html">Console de jeux stm32</a></li>
<li><a href="../fr501604/index.html">Traduction du livre d'Andrew Un, Passion for Machine Learning. Chapitres 51 et 52</a></li>
<li><a href="../fr501610/index.html">Barre de d√©filement personnalis√©e en angulaire</a></li>
<li><a href="../fr501612/index.html">Quelle carte graphique choisir pour votre ordinateur en 2020</a></li>
<li><a href="../fr501616/index.html">Portrait du client: composer et compter</a></li>
<li><a href="../fr501622/index.html">Cas: comment cr√©er un plan de contenu pour un blog B2B bas√© sur la s√©mantique de l'information</a></li>
<li><a href="../fr501624/index.html">Mod√®les r√©els de localisation linguistique dans le domaine de l'informatique et des communications num√©riques. Partie 2</a></li>
<li><a href="../fr501628/index.html">Entretien avec Alexander Filippov, concepteur de jeu en chef World of Tanks Blitz</a></li>
<li><a href="../fr501630/index.html">Cinq risques de s√©curit√© lors d'un travail √† distance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>