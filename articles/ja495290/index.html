<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤰🏼 👨🏽 👬 Zephyrオペレーティングシステムのコード品質の調査 🎦 🤽 🚞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近、PVS-StudioコードアナライザーがPlatformIOと統合し始めたと述べました。当然ながら、同時に、PVS-Studio開発チームはPlatformIOチームと連絡を取り、興味を引くためにZephyrリアルタイムオペレーティングシステムのコードをチェックすることを提案しました。なぜだと...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Zephyrオペレーティングシステムのコード品質の調査</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/495290/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ee/aeb/25b/4eeaeb25b1ec54a9016cec031ae97451.png" alt="PVS-StudioおよびZephyr"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近、PVS-StudioコードアナライザーがPlatformIOと統合し始めたと述べました。</font><font style="vertical-align: inherit;">当然ながら、同時に、PVS-Studio開発チームはPlatformIOチームと連絡を取り、興味を引くためにZephyrリアルタイムオペレーティングシステムのコードをチェックすることを提案しました。</font><font style="vertical-align: inherit;">なぜだと思いました、そしてここにそのような研究についての記事があります。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PlatformIO</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事の主要部分を始める前に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PlatformIO</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトを組み込みシステムの開発者にすすめたいと思います</font><font style="vertical-align: inherit;">。これ</font><font style="vertical-align: inherit;">により、組み込みシステムの開発が</font><font style="vertical-align: inherit;">容易になります。</font><font style="vertical-align: inherit;">これは、クロスプラットフォームのマイクロコントローラープログラミングツールです。</font><font style="vertical-align: inherit;">PlatformIOのコアはコマンドラインツールですが、Visual Studio Codeのプラグインとして使用することをお勧めします。</font><font style="vertical-align: inherit;">最新のチップとそれらに基づくマザーボードが多数サポートされています。</font><font style="vertical-align: inherit;">適切なアセンブリシステムを自動的にダウンロードすることができ、サイトにはプラグイン電子コンポーネントを管理するためのライブラリの大規模なコレクションがあります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studioは組み込みシステムの世界ではまだほとんど知られていないため、念のため、このツールにまだ慣れていない新しい読者のために紹介します。</font><font style="vertical-align: inherit;">通常の読者は、次のセクションにスキップできます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、C、C ++、C＃およびJavaで記述されたプログラムのコードのエラーと潜在的な脆弱性を検出できる静的コードアナライザーです。</font><font style="vertical-align: inherit;">CとC ++のみについて説明する場合は、次のコンパイラがサポートされています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィンドウズ </font><font style="vertical-align: inherit;">Visual Studio 2010-2019 C、C ++、C ++ / CLI、C ++ / CX（WinRT）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィンドウズ </font><font style="vertical-align: inherit;">ARM C、C ++用IAR Embedded Workbench、C / C ++コンパイラ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウィンドウズ </font><font style="vertical-align: inherit;">QNX Momentics、QCC C、C ++</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows / Linux </font><font style="vertical-align: inherit;">Keil µVision、DS-MDK、ARMコンパイラ5/6 C、C ++</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows / Linux </font><font style="vertical-align: inherit;">Texas Instruments Code Composer Studio、ARMコード生成ツールC、C ++</font></font></li>
<li>Windows/Linux/macOS. GNU Arm Embedded Toolchain, Arm Embedded GCC compiler, C, C++</li>
<li>Windows/Linux/macOS. Clang C, C++</li>
<li>Linux/macOS. GCC C, C++</li>
<li>Windows. MinGW C, C++</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザーには独自の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分類</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">システム</font></a><font style="vertical-align: inherit;">がありますが、必要に応じて、コーディング標準</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEI CERT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISRA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に従ってアラートの表示を有効にすることができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大規模なレガシープロジェクトでも、PVS-Studioを使用して定期的にすばやく開始できます。この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を大量に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">抑制</font></a><font style="vertical-align: inherit;">するための特別なメカニズム</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が</font></a><font style="vertical-align: inherit;">用意されてい</font><font style="vertical-align: inherit;">ます。現在の警告はすべて技術的負債と見なされ、非表示になっているため、新しいコードまたは変更されたコードにのみ適用される警告に集中できます。これにより、チームは毎日すぐにアナライザーの使用を開始することができ、時々技術的な義務に戻ってコードを改善することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studioを使用する他の多くのシナリオがあります。</font><font style="vertical-align: inherit;">たとえば、SonarQubeへのプラグインとして使用できます。</font><font style="vertical-align: inherit;">Travis CI、CircleCI、GitLab CI / CDなどのシステムとの統合が可能です。</font><font style="vertical-align: inherit;">PVS-Studioの詳細な説明は、この記事の範囲を超えています。</font><font style="vertical-align: inherit;">したがって、私はこの記事に慣れることをお勧めします。この記事には多くの便利なリンクがあり、多くの質問に対する回答が示さ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れています</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。「</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">PVS-Studio静的コードアナライザーを開発プロセスに導入する理由</font></a><font style="vertical-align: inherit;">」</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゼファー</font></font></h2><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-StudioのPlatformIOへの統合に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
取り組んでいる</font><font style="vertical-align: inherit;">私たちのチームは話し合い、組み込み世界のプロジェクト、つまりZephyrをチェックアウトするように求められました。</font><font style="vertical-align: inherit;">この記事を書く理由となったアイデアが気に入りました。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zephyr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、さまざまなアーキテクチャの限られたリソースを持つデバイスで動作するように設計された軽量のリアルタイムオペレーティングシステムです。</font><font style="vertical-align: inherit;">コードは、オープンソースのApache 2.0ライセンスの下で配布されます。</font><font style="vertical-align: inherit;">次のプラットフォームで動作します：ARM（Cortex-M0、Cortex-M3、Cortex-M4、Cortex-M23、Cortex-M33、Cortex-R4、Cortex-R5、Cortex-A53）、x86、x86-64、ARC、RISC- V、Nios II、Xtensa。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの機能：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">統一されたアドレス空間。</font><font style="vertical-align: inherit;">カスタムカーネルと組み合わせた特定のアプリケーションコードは、デバイス上で実行されるモノリシックイメージを作成します。</font></font></li>
<li>  .     ,        .</li>
<li>    .       .</li>
<li>  .     .           .</li>
<li>    : ,  ,  ,     ,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちにとって興味深い瞬間の中で、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synopsys</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はオペレーティングシステムの開発に関与しています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">2014年、SynopsysはCoverityを買収し、同名の静的コードアナライザーを生み出しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zephyr開発者が最初から</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coverity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アナライザーを使用するのは当然です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">アナライザーは市場のリーダーであり、これはオペレーティングシステムコードの品質に影響を与える可能性があります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zephyrコードの品質</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の意見では、Zephyrオペレーティングシステムのコードは品質に優れています。</font><font style="vertical-align: inherit;">ここに私がそう考える理由を与えます：</font></font><br>
<br>
<ul>
<li> PVS-Studio  122     High  367   Medium.  , ,    560 C/C++ .     .       7810 C/C++   10075  . ,     . ,      ,          .</li>
<li>       .    «» ,   .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースコードを分析した</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SourceMonitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティ</font><font style="vertical-align: inherit;">は、コードの48％がコメントであるという統計を提供しました。</font><font style="vertical-align: inherit;">これは多くのことであり、私の経験では、コードの品質、他の開発者にとってのその包括性に対する高い懸念を示しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの開発時には、Coverity静的コードアナライザーが使用されます。</font><font style="vertical-align: inherit;">ほとんどの場合、この事実により、PVS-Studioアナライザーは、プロジェクトでエラーを検出しましたが、他のプロジェクトを分析する場合にそうであるように、鮮明に表示できませんでした。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これに基づいて、プロジェクトの作成者はコードの品質と信頼性を気にかけていると思います。</font><font style="vertical-align: inherit;">次に、PVS-Studioアナライザー（バージョン7.06）によって発行されたいくつかの警告を見てみましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">半偽の警告</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトコードは、その低レベルのため、非常に具体的に記述されており、多数の条件付きコンパイル（#ifdef）を使用しています。これは、実際の間違いを示さない多数の警告を生成しますが、それらを単に偽と呼ぶことはできません。これをいくつかの例で明らかにするのが最も簡単です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「準誤った」作動N1の例</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">char_framebuffer</span> <span class="hljs-title">char_fb</span>;</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">cfb_framebuffer_invert</span><span class="hljs-params">(struct device *dev)</span>
</span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">char_framebuffer</span> *<span class="hljs-title">fb</span> = &amp;<span class="hljs-title">char_fb</span>;</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!fb || !fb-&gt;buf) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  fb-&gt;inverted = !fb-&gt;inverted;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V560</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条件式の一部は常にfalse </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です：！Fb</font></a><font style="vertical-align: inherit;">。 cfb.c 188 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
静的変数のアドレスを取得すると、常にゼロ以外のポインタが取得されます。したがって、ポインター</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fbは</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常に非ゼロであり、その検証は意味がありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、これはまったくエラーではなく、単に過度のチェックであり、害はありません。さらに、リリースバージョンをビルドすると、コンパイラーはそれを破棄するため、これによっても速度低下は発生しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の理解では、同様のケースが「半偽の」アナライザー操作の概念に該当します。正式には、アナライザーは完全に正しいです。そして、コードから余分な無意味なチェックを削除することをお勧めします。しかし、これはすべてささいなことであり、そのような警告は記事のフレームワークで検討することすら興味深いものではありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N2の「セミカット」作動の例</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">hex2char</span><span class="hljs-params">(<span class="hljs-keyword">u8_t</span> x, <span class="hljs-keyword">char</span> *c)</span>
</span>{
  <span class="hljs-keyword">if</span> (x &lt;= <span class="hljs-number">9</span>) {<font></font>
    *c = x + <span class="hljs-string">'0'</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">10</span> &amp;&amp; x &lt;= <span class="hljs-number">15</span>) {<font></font>
    *c = x - <span class="hljs-number">10</span> + <span class="hljs-string">'a'</span>;<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> -EINVAL;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
警告PVS-Studio：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V560</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条件式の一部は常にtrueです：x&gt; = 10. hex.c 31 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザーは再び、条件の一部が常にtrueであると断定することにおいて正式に正しいです。</font><font style="vertical-align: inherit;">変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xが</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 9以下/でない</font><font style="vertical-align: inherit;">場合は、</font><font style="vertical-align: inherit;">常に10以上/に等しいことがわかります。また、コードを簡略化できます。</font></font><br>
<br>
<pre><code class="cpp hljs">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x &lt;= <span class="hljs-number">15</span>) {</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
繰り返しになりますが、ここには実際に有害なエラーはなく、コードの美しさのためだけに追加の比較が記述されています。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次に、N3のより複雑な例を見てみましょう。</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
まず、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CHECKIF</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マクロを実装する方法を見てみましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(CONFIG_ASSERT_ON_ERRORS)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHECKIF(expr) \
  __ASSERT_NO_MSG(!(expr));   \
  <span class="hljs-meta-keyword">if</span> (0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined(CONFIG_NO_RUNTIME_CHECKS)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHECKIF(...) \
  <span class="hljs-meta-keyword">if</span> (0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHECKIF(expr) \
  <span class="hljs-meta-keyword">if</span> (expr)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトのコンパイルモードによっては、チェックが実行されるかスキップされる場合があります。</font><font style="vertical-align: inherit;">今回のケースでは、PVS-Studioを使用してコードをチェックするときに、このマクロ実装が選択されました。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHECKIF(expr) \
  <span class="hljs-meta-keyword">if</span> (expr)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが何につながるか見てみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">k_queue_append_list</span><span class="hljs-params">(struct k_queue *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">void</span> *head, <span class="hljs-keyword">void</span> *tail)</span>
</span>{<font></font>
  CHECKIF(head == <span class="hljs-literal">NULL</span> || tail == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-keyword">return</span> -EINVAL;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">k_spinlock_key_t</span> key = k_spin_lock(&amp;<span class="hljs-built_in">queue</span>-&gt;lock);
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">k_thread</span> *<span class="hljs-title">thread</span> = <span class="hljs-title">NULL</span>;</span>
  <span class="hljs-keyword">if</span> (head != <span class="hljs-literal">NULL</span>) {<font></font>
    thread = z_unpend_first_thread(&amp;<span class="hljs-built_in">queue</span>-&gt;wait_q);<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">V547</font></a><font style="vertical-align: inherit;"> [CWE-571]式 'head！= NULL'は常にtrueです。</font><font style="vertical-align: inherit;">queue.c 244 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザは、チェック</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（head！= NULL）が</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常にtrueを与える</font><font style="vertical-align: inherit;">と見なし</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">そして確かにそうです。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘッド</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポインター</font><font style="vertical-align: inherit;">がNULLの場合、関数の先頭でのチェックにより、関数は機能しなくなります。</font></font><br>
<br>
<pre><code class="cpp hljs">CHECKIF(head == <span class="hljs-literal">NULL</span> || tail == <span class="hljs-literal">NULL</span>) {
  <span class="hljs-keyword">return</span> -EINVAL;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、マクロは次のように展開されることを思い出してください。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (head == <span class="hljs-literal">NULL</span> || tail == <span class="hljs-literal">NULL</span>) {
  <span class="hljs-keyword">return</span> -EINVAL;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、PVS-Studioアナライザーはその観点から見て適切であり、正しい警告を発行します。</font><font style="vertical-align: inherit;">ただし、このチェックは削除できません。</font><font style="vertical-align: inherit;">彼女は必要です。</font><font style="vertical-align: inherit;">別のシナリオでは、マクロは次のように開きます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span>) {
  <span class="hljs-keyword">return</span> -EINVAL;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ポインタを再確認する必要があります。</font><font style="vertical-align: inherit;">もちろん、このバージョンのコードコンパイルでは、アナライザーは警告を生成しません。</font><font style="vertical-align: inherit;">ただし、コンパイルのデバッグバージョンに対して警告が表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今や読者が「半偽の」警告がどこから来たのかがはっきりしていることを願っています。</font><font style="vertical-align: inherit;">しかし、彼らには何も問題はありません。</font><font style="vertical-align: inherit;">PVS-Studioアナライザーは、誤ったアラートを抑制するためのさまざまなメカニズムを提供します。これは、ドキュメントに記載されています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ケース警告</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
でも結局、何か面白いものを見つけましたか？</font><font style="vertical-align: inherit;">それは成功でした、そして今、私たちは様々なエラーを調べます。</font><font style="vertical-align: inherit;">この場合、私はすぐに2つの点に注意したいと思います。</font></font><br>
<br>
<ol>
<li>       .  :   , , ,      Coverity. ,     PVS-Studio  -  ,               . </li>
<li>            . ,             «»      .      ,          .         GitHub,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a> PVS-Studio.</li>
</ol><br>
<b> N1, </b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">gen_prov_ack</span><span class="hljs-params">(struct prov_rx *rx, struct net_buf_simple *buf)</span>
</span>{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (link.tx.cb &amp;&amp; link.tx.cb) {<font></font>
    link.tx.cb(<span class="hljs-number">0</span>, link.tx.cb_data);<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V501</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-571]「&amp;&amp;」演算子の左側と右側に同じサブ式があります：link.tx.cb &amp;&amp; link.tx.cb pb_adv.c 377 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つは二重チェックされています同じ変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link.tx.cb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">どうやら、これはタイプミスであり、チェックされる2番目の変数は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link.tx.cb_dataである</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要が</font><i><font style="vertical-align: inherit;">あり</font></i><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN2、バッファの</font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">オーバーフロー</font></i><font style="vertical-align: inherit;">後で使用される</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">net_hostname_getを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検討してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(CONFIG_NET_HOSTNAME_ENABLE)</span>
<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">net_hostname_get</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">net_hostname_get</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">"zephyr"</span>;<font></font>
}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の場合、前処理時に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#else</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブランチに関連するオプションが</font><i><font style="vertical-align: inherit;">選択されました</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">つまり、前処理されたファイルでは、関数は次のように実装されます。</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">net_hostname_get</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">"zephyr"</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この関数は、7バイトの配列へのポインターを返します（行の終わりにある末端のゼロを考慮に入れます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、配列境界の出口につながるコードを考えます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">do_net_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
  ....<font></font>
  (<span class="hljs-keyword">void</span>)<span class="hljs-built_in">memcpy</span>(hostname, net_hostname_get(), MAX_HOSTNAME_LEN);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V512</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-119]「memcpy」関数を呼び出すと、「net_hostname_get（）」バッファーが範囲外になります。</font><font style="vertical-align: inherit;">log_backend_net.c 114 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前処理後、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAX_HOSTNAME_LENは</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のように展開されます。</font></font><br>
<br>
<pre><code class="cpp hljs">(<span class="hljs-keyword">void</span>)<span class="hljs-built_in">memcpy</span>(hostname, net_hostname_get(),
    <span class="hljs-keyword">sizeof</span>(<span class="hljs-string">"xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx"</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、データをコピーすると、範囲外の文字列リテラルが発生します。</font><font style="vertical-align: inherit;">これが未定義の動作につながるため、これがプログラムの実行にどのように影響するかを予測することは困難です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN3、潜在的なバッファオーバーラン</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">do_write_op_json</span><span class="hljs-params">(struct lwm2m_message *msg)</span>
</span>{
  <span class="hljs-keyword">u8_t</span> value[TOKEN_BUF_LEN];
  <span class="hljs-keyword">u8_t</span> base_name[MAX_RESOURCE_LEN];
  <span class="hljs-keyword">u8_t</span> full_name[MAX_RESOURCE_LEN];<font></font>
  ....<font></font>
  <span class="hljs-comment">/* combine base_name + name */</span>
  <span class="hljs-built_in">snprintf</span>(full_name, TOKEN_BUF_LEN, <span class="hljs-string">"%s%s"</span>, base_name, value);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V512</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-119]「snprintf」関数を呼び出すと、バッファ「full_name」がオーバーフローします。 lwm2m_rw_json.c 826 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マクロの値を代入すると、何が起こっているかは次のようになります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">u8_t</span> value[<span class="hljs-number">64</span>];
<span class="hljs-keyword">u8_t</span> base_name[<span class="hljs-number">20</span>];
<span class="hljs-keyword">u8_t</span> full_name[<span class="hljs-number">20</span>];<font></font>
....<font></font>
<span class="hljs-built_in">snprintf</span>(full_name, <span class="hljs-number">64</span>, <span class="hljs-string">"%s%s"</span>, base_name, value);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字列が形成される</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">full_name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
バッファの下に</font><font style="vertical-align: inherit;">割り当てられるのは20バイトだけです。この場合、文字列が形成される部分は、サイズが20バイトと64バイトのバッファーに格納されます。さらに、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snprintf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数に渡され</font><font style="vertical-align: inherit;">、配列が海外に出ないように設計され</font><font style="vertical-align: inherit;">た定数64 </font><font style="vertical-align: inherit;">は明らかに大きすぎます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードは、必ずしもバッファオーバーフローを引き起こすわけではありません。おそらく常に幸運であり、部分文字列は常に非常に小さいです。ただし、一般に、このコードは決してオーバーフローから保護されておらず、古典的なセキュリティ欠陥</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-119</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が含まれてい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN4、式は常にtrue</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">keys_set</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">size_t</span> len_rd, settings_read_cb read_cb,
                    <span class="hljs-keyword">void</span> *cb_arg)</span>
</span>{<font></font>
  ....<font></font>
  <span class="hljs-keyword">size_t</span> len;<font></font>
  ....<font></font>
  len = read_cb(cb_arg, val, <span class="hljs-keyword">sizeof</span>(val));
  <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) {<font></font>
    BT_ERR(<span class="hljs-string">"Failed to read value (err %zu)"</span>, len);
    <span class="hljs-keyword">return</span> -EINVAL;<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">V547</font></a><font style="vertical-align: inherit;"> [CWE-570]式 'len &lt;0'は常にfalseです。</font><font style="vertical-align: inherit;">符号なしの型の値が決して0未満になることはありません。keys.c 312 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は符号なしの型であるため、0未満にすることはできません。したがって、エラーステータスはまったく処理されません。</font><font style="vertical-align: inherit;">他の場所</font><font style="vertical-align: inherit;">では、</font><i><font style="vertical-align: inherit;">int</font></i><font style="vertical-align: inherit;">または</font><i><font style="vertical-align: inherit;">ssize_t</font></i><font style="vertical-align: inherit;">型</font><font style="vertical-align: inherit;">は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_cb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の結果を格納するために</font><font style="vertical-align: inherit;">使用さ</font><font style="vertical-align: inherit;">れます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
例：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span> <span class="hljs-title">mesh_x_set</span><span class="hljs-params">(....)</span>
</span>{
 <span class="hljs-keyword">ssize_t</span> len;<font></font>
 len = read_cb(cb_arg, out, read_len);<font></font>
 <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) {<font></font>
 ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意。</font></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_cb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の</font><font style="vertical-align: inherit;">すべてが悪い</font><font style="vertical-align: inherit;">よう</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">実際には、次のように宣言されています。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">u8_t</span> <span class="hljs-title">read_cb</span><span class="hljs-params">(<span class="hljs-keyword">const</span> struct bt_gatt_attr *attr, <span class="hljs-keyword">void</span> *user_data)</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タイプ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u8_t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unsigned charです。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この関数は常に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unsigned char</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">型の正の数のみを返します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この値を</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">型</font><font style="vertical-align: inherit;">または</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ssize_t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">型の符号付き変数に</font><i><font style="vertical-align: inherit;">入れると</font></i><font style="vertical-align: inherit;">、すべて同じで、値は常に正になります。</font><font style="vertical-align: inherit;">したがって、他の場所では、エラーステータスのチェックも機能しません。</font><font style="vertical-align: inherit;">しかし、私はこの問題の研究を掘り下げませんでした。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN5、非常に奇妙なもの</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">mntpt_prepare</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *mntpt)</span>
</span>{
  <span class="hljs-keyword">char</span> *cpy_mntpt;<font></font>
<font></font>
  cpy_mntpt = k_malloc(<span class="hljs-built_in">strlen</span>(mntpt) + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (cpy_mntpt) {<font></font>
    ((<span class="hljs-keyword">u8_t</span> *)mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;
    <span class="hljs-built_in">memcpy</span>(cpy_mntpt, mntpt, <span class="hljs-built_in">strlen</span>(mntpt));<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> cpy_mntpt;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V575</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-628] 'memcpy'関数は文字列全体をコピーしません。</font><font style="vertical-align: inherit;">端末のnullを保持するには、「strcpy / strcpy_s」関数を使用します。</font><font style="vertical-align: inherit;">shell.c 427</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/11e/bb5/367/11ebb53676d77d0d9418b626de856106.png" alt="奇妙なコード"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰かが</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strdup</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の類似物を作ろうとしましたが、</font><font style="vertical-align: inherit;">成功しませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アナライザーの警告から始めましょう。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memcpy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">が行をコピーするが、ターミナルゼロはコピーしない</font><font style="vertical-align: inherit;">と報告されており</font><font style="vertical-align: inherit;">、これは非常に疑わしいです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この端末0はここにコピーされているようです：</font></font><br>
<br>
<pre><code class="cpp hljs">((<span class="hljs-keyword">u8_t</span> *)mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、違います！</font><font style="vertical-align: inherit;">ここにタイプミスがあります。これは、ターミナルゼロがそれ自体にコピーされるためです。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cpy_mntpt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ではなく</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mntpt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配列に書き込むことに注意してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その結果、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mntpt_prepare</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">は、終端がゼロの不完全な文字列を返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、プログラマーは次のように書きたかったのです。</font></font><br>
<br>
<pre><code class="cpp hljs">((<span class="hljs-keyword">u8_t</span> *)cpy_mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それがなぜそれほど複雑だったのかはまだ明らかではありません！</font><font style="vertical-align: inherit;">このコードは、次のオプションに簡略化できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">mntpt_prepare</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *mntpt)</span>
</span>{
  <span class="hljs-keyword">char</span> *cpy_mntpt;<font></font>
<font></font>
  cpy_mntpt = k_malloc(<span class="hljs-built_in">strlen</span>(mntpt) + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (cpy_mntpt) {
    <span class="hljs-built_in">strcpy</span>(cpy_mntpt, mntpt);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> cpy_mntpt;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN6、検証前のポインターの逆参照</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bt_mesh_model_publish</span><span class="hljs-params">(struct bt_mesh_model *model)</span>
</span>{<font></font>
  ....<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bt_mesh_model_pub</span> *<span class="hljs-title">pub</span> = <span class="hljs-title">model</span>-&gt;<span class="hljs-title">pub</span>;</span><font></font>
  ....<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bt_mesh_msg_ctx</span> <span class="hljs-title">ctx</span> = {</span><font></font>
    .send_rel = pub-&gt;send_rel,<font></font>
  };<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (!pub) {
    <span class="hljs-keyword">return</span> -ENOTSUP;<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-476] </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">nullpubr</font></a><font style="vertical-align: inherit;">に対して検証される前に「pub」ポインタが使用されました。</font><font style="vertical-align: inherit;">チェック行：708、719。access.c 708 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非常に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的な</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーパターン。</font><font style="vertical-align: inherit;">まず、構造体のメンバーを初期化するためにポインターが逆参照されます。</font></font><br>
<br>
<pre><code class="cpp hljs">.send_rel = pub-&gt;send_rel,</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、このポインタがnullである可能性があるかどうかのチェックが行われます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN7-N9、検証前のポインター逆参照</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">net_tcp_accept</span><span class="hljs-params">(struct net_context *context, <span class="hljs-keyword">net_tcp_accept_cb_t</span> cb,
                   <span class="hljs-keyword">void</span> *user_data)</span>
</span>{<font></font>
  ....<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcp</span> *<span class="hljs-title">conn</span> = <span class="hljs-title">context</span>-&gt;<span class="hljs-title">tcp</span>;</span><font></font>
  ....<font></font>
  conn-&gt;accept_cb = cb;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!conn || conn-&gt;state != TCP_LISTEN) {
    <span class="hljs-keyword">return</span> -EINVAL;<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-476] nullptrに対して検証される前に「conn」ポインターが使用されました。</font><font style="vertical-align: inherit;">チェック行：1071、1073。tcp2.c 1071 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前のケースと同じ。</font><font style="vertical-align: inherit;">ここでは説明は不要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなエラーがさらに2つあります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 [CWE-476] nullptrに対して検証される前に、 'context-&gt; tcp'ポインターが使用されました。</font><font style="vertical-align: inherit;">チェック行：1512、1518。tcp.c 1512</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 [CWE-476] nullfsrで検証される前に「fsm」ポインタが使用されていました。</font><font style="vertical-align: inherit;">チェック行：365、382。fsm.c 365</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN10、誤ったチェック</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">x509_get_subject_alt_name</span><span class="hljs-params">( <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> **p,
                                      <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *end,
                                      mbedtls_x509_sequence *subject_alt_name)</span>
</span>{<font></font>
  ....<font></font>
    <span class="hljs-keyword">while</span>( *p &lt; end )<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span>( ( end - *p ) &lt; <span class="hljs-number">1</span> )
            <span class="hljs-keyword">return</span>( MBEDTLS_ERR_X509_INVALID_EXTENSIONS +<font></font>
                    MBEDTLS_ERR_ASN1_OUT_OF_DATA );<font></font>
    ....<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">V547</font></a><font style="vertical-align: inherit;"> [CWE-570]式 '（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">end-</font></a><font style="vertical-align: inherit;"> * p）&lt;1'は常にfalseです。</font><font style="vertical-align: inherit;">x509_crt.c 635 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
条件を詳しく見てみましょう。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* p &lt;終了</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（終了-* p）&lt;1</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは互いに矛盾しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（* p &lt;end）の場合、（end-* p）は常に1以上の値になります。</font><font style="vertical-align: inherit;">一般的に、ここで何か問題がありますが、正しい綴り方がわかりません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN11、到達不能コード</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">lv_disp_get_inactive_time</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">lv_disp_t</span> * disp)</span>
</span>{
    <span class="hljs-keyword">if</span>(!disp) disp = lv_disp_get_default();
    <span class="hljs-keyword">if</span>(!disp) {<font></font>
        LV_LOG_WARN(<span class="hljs-string">"lv_disp_get_inactive_time: no display registered"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(disp) <span class="hljs-keyword">return</span> lv_tick_elaps(disp-&gt;last_activity_time);<font></font>
<font></font>
    <span class="hljs-keyword">lv_disp_t</span> * d;
    <span class="hljs-keyword">uint32_t</span> t = UINT32_MAX;<font></font>
    d          = lv_disp_get_next(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">while</span>(d) {<font></font>
        t = LV_MATH_MIN(t, lv_tick_elaps(d-&gt;last_activity_time));<font></font>
        d = lv_disp_get_next(d);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> t;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V547</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-571]式 'disp'は常にtrueです。 lv_disp.c 148 </font><i><font style="vertical-align: inherit;">disp</font></i><font style="vertical-align: inherit;">がnullポインターの</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
場合、関数は終了し</font><font style="vertical-align: inherit;">ます。次に、逆に、</font><i><font style="vertical-align: inherit;">disp</font></i><font style="vertical-align: inherit;">ポインタが</font><font style="vertical-align: inherit;">nullで</font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">ない</font><font style="vertical-align: inherit;">ことを確認し</font><font style="vertical-align: inherit;">（これは常にそうです）、関数は再び作業を終了します。</font><font style="vertical-align: inherit;">
その結果、関数のコードの一部がまったく制御を取得することはありません。</font><b><font style="vertical-align: inherit;">フラグメントN12、奇妙な戻り値</font></b></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">size_t</span> <span class="hljs-title">put_end_tlv</span><span class="hljs-params">(struct lwm2m_output_context *out, <span class="hljs-keyword">u16_t</span> mark_pos,
        <span class="hljs-keyword">u8_t</span> *writer_flags, <span class="hljs-keyword">u8_t</span> writer_flag,
        <span class="hljs-keyword">int</span> tlv_type, <span class="hljs-keyword">int</span> tlv_id)</span>
</span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tlv_out_formatter_data</span> *<span class="hljs-title">fd</span>;</span>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">oma_tlv</span> <span class="hljs-title">tlv</span>;</span>
  <span class="hljs-keyword">u32_t</span> len = <span class="hljs-number">0U</span>;<font></font>
<font></font>
  fd = engine_get_out_user_data(out);<font></font>
  <span class="hljs-keyword">if</span> (!fd) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
  }<font></font>
<font></font>
  *writer_flags &amp;= ~writer_flag;<font></font>
<font></font>
  len = out-&gt;out_cpkt-&gt;offset - mark_pos;<font></font>
<font></font>
  <span class="hljs-comment">/* use stored location */</span><font></font>
  fd-&gt;mark_pos = mark_pos;<font></font>
<font></font>
  <span class="hljs-comment">/* set instance length */</span><font></font>
  tlv_setup(&amp;tlv, tlv_type, tlv_id, len);<font></font>
  len = oma_tlv_put(&amp;tlv, out, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>) - tlv.length;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1001</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「len」変数が割り当てられていますが、関数の最後で使用されていません。</font><font style="vertical-align: inherit;">lwm2m_rw_oma_tlv.c 338 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数には2つの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returnステートメント</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">含まれ</font><font style="vertical-align: inherit;">、どちらも0を返します。関数が常に0を返すのはおかしいです</font><font style="vertical-align: inherit;">。また、割り当て後に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数</font><font style="vertical-align: inherit;">が使用されないの</font><font style="vertical-align: inherit;">もおかしいです</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私はそれが実際に次のように書かれるべきであるという大きな疑いを持っています：</font></font><br>
<br>
<pre><code class="cpp hljs">  len = oma_tlv_put(&amp;tlv, out, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>) - tlv.length;
  <span class="hljs-keyword">return</span> len;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグメントN13-N16、同期エラー</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">nvs_startup</span><span class="hljs-params">(struct nvs_fs *fs)</span>
</span>{<font></font>
  ....<font></font>
  k_mutex_lock(&amp;fs-&gt;nvs_lock, K_FOREVER);<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (fs-&gt;ate_wra == fs-&gt;data_wra &amp;&amp; last_ate.len) {
    <span class="hljs-keyword">return</span> -ESPIPE;<font></font>
  }<font></font>
  ....<font></font>
end:<font></font>
  k_mutex_unlock(&amp;fs-&gt;nvs_lock);<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio警告：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数は「k_mutex_unlock」関数を呼び出さずに終了しました。</font><font style="vertical-align: inherit;">チェック行：620、549。nvs.c 620 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数がミューテックスのロックを解除せずに作業を終了する状況があります。</font><font style="vertical-align: inherit;">私の理解では、次のように書くのが正しいでしょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">nvs_startup</span><span class="hljs-params">(struct nvs_fs *fs)</span>
</span>{<font></font>
  ....<font></font>
  k_mutex_lock(&amp;fs-&gt;nvs_lock, K_FOREVER);<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (fs-&gt;ate_wra == fs-&gt;data_wra &amp;&amp; last_ate.len) {<font></font>
    rc = -ESPIPE;<font></font>
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
  ....<font></font>
end:<font></font>
  k_mutex_unlock(&amp;fs-&gt;nvs_lock);<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに3つのエラー：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1020関数は「k_mutex_unlock」関数を呼び出さずに終了しました。</font><font style="vertical-align: inherit;">チェック行：574、549。nvs.c 574</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1020関数は「k_mutex_unlock」関数を呼び出さずに終了しました。</font><font style="vertical-align: inherit;">チェック行：908、890。net_context.c 908</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1020関数は「k_mutex_unlock」関数を呼び出さずに終了しました。</font><font style="vertical-align: inherit;">チェック行：1194、1189。shell.c 1194</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
楽しんでいただけたでしょうか。</font><font style="vertical-align: inherit;">他のプロジェクトのチェックや他の興味深い出版物については</font><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブログ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">ご覧ください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
静的アナライザーを使用して、コードの作成段階でもエラーの数と潜在的な脆弱性を減らします。特に早期のエラー検出は、多くの場合時間と費用のかかるプログラムを更新する組み込みシステムに関連しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、PVS-Studioアナライザーを使用してプロジェクトを延期したり確認したりしないことをお勧めします。記事を参照してください：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CおよびC ++コードのPVS-Studioアナライザーによって生成された興味深い警告をすばやく確認するにはどうすればよいですか？</font></font></a><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事を英語圏の読者と共有したい場合は、翻訳へのリンクを使用してください：Andrey Karpov。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゼファーオペレーティングシステムのコードを確認します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja495274/index.html">ルートリークを修正する方法</a></li>
<li><a href="../ja495276/index.html">そして、Uptime Instituteでの運用の持続可能性監査にどのように合格したかを示します。</a></li>
<li><a href="../ja495278/index.html">データベース、カード、チェックリスト、またはなぜビジネスナレッジマネージャー</a></li>
<li><a href="../ja495280/index.html">Max Patrol SIEM。情報セキュリティイベント管理システムの概要</a></li>
<li><a href="../ja495282/index.html">XSD、JAXB、Spring Frameworkを使用したXML検証</a></li>
<li><a href="../ja495292/index.html">InterSystems IRIS 2020.1リリース</a></li>
<li><a href="../ja495294/index.html">パイソン主義者のためのマクロ。Yandexレポート</a></li>
<li><a href="../ja495296/index.html">フォレンジック、SQLインジェクション、長引く猫：オンラインステージNeoQUEST-2020のタスクNo. 3の分析</a></li>
<li><a href="../ja495298/index.html">モンテカルロClojureオプションの評価</a></li>
<li><a href="../ja495302/index.html">オンラインストアで4か月の売上を2.5倍に増やす方法-SEOプロモーションの事例</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>