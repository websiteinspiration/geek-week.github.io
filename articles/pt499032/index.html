<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤬 👩🏾‍🤝‍👨🏽 🤾🏾 Como usar o Prometheus para detectar anomalias no GitLab 📋 😉 🤷🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um dos recursos básicos da linguagem de consulta do Prometheus é a agregação em tempo real de séries temporais . Você também pode usar a linguagem de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como usar o Prometheus para detectar anomalias no GitLab</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos recursos básicos da linguagem de consulta do Prometheus é </font><font style="vertical-align: inherit;">a </font><font style="vertical-align: inherit;">agregação em </font><font style="vertical-align: inherit;">tempo real </font><font style="vertical-align: inherit;">de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">séries temporais</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Você também pode usar a linguagem de consulta do Prometheus para detectar anomalias nos dados de séries temporais.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">equipe do </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traduziu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um artigo do engenheiro da equipe de infraestrutura do GitLab</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , onde você encontrará exemplos de código que podem ser testados em seus sistemas.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que serve a detecção de anomalias?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Há quatro razões principais que determinam a importância da detecção de anomalias para o GitLab:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagnóstico de incidentes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : podemos detectar quais serviços foram além do escopo normal, reduzindo o tempo de detecção de incidentes (MTTD) e, consequentemente, oferecer uma solução mais rápida para o problema.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecção de degradação do desempenho</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : por exemplo, se uma regressão é introduzida em um serviço que faz com que ele acesse outro serviço com muita frequência, podemos detectar e corrigir rapidamente esse problema.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecção e eliminação de abuso</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : o GitLab fornece mecanismos de entrega e integração ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e hospedagem (páginas do GitLab) e um número limitado de usuários que podem usar esses mecanismos.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segurança</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : a detecção de anomalias é importante para detectar tendências incomuns nas séries temporais do GitLab.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por esses e outros motivos, o autor do artigo decidiu descobrir como configurar a definição de anomalias na série temporal do GitLab usando as regras e consultas do Prometheus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qual é o nível de agregação correto?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, as séries temporais devem ser corretamente agregadas. </font><font style="vertical-align: inherit;">No exemplo abaixo, usamos o contador http_requests_total padrão para recuperar dados, embora muitas outras métricas também o fizessem.</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa métrica de teste possui vários parâmetros: método, controlador, código de status (status_code), ambiente, além de parâmetros adicionados pelo próprio Prometheus, por exemplo, trabalho e instância. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora você precisa escolher o nível certo de agregação de dados. </font><font style="vertical-align: inherit;">Demais, de menos - tudo isso é importante para detectar anomalias. </font><font style="vertical-align: inherit;">Se os dados estiverem muito agregados, há dois problemas em potencial:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Você pode ignorar a anomalia porque a agregação oculta problemas que ocorrem em subconjuntos de seus dados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se você encontrar uma anomalia, é difícil relacioná-la a uma parte separada do seu sistema sem esforço adicional.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se os dados não forem agregados o suficiente, isso pode levar a um aumento no número de falsos positivos, bem como a uma interpretação incorreta dos dados válidos como errôneos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base em nossa experiência, o nível de agregação mais correto é o nível de serviço, ou seja, incluímos o rótulo de trabalho (trabalho) e ambiente (ambiente) e descartamos todos os outros rótulos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A agregação, que discutiremos ao longo do artigo, inclui: job - http_request, agregation - cinco minutos, que é calculado com base no trabalho e no ambiente em cinco minutos.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir do exemplo acima, é claro que, da série http_requests_total, os subconjuntos são selecionados no contexto de trabalho e ambiente, então seu número é considerado por cinco minutos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando o escore Z para detectar anomalias</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os princípios básicos da estatística podem ser aplicados para detectar anomalias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você souber a média e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o desvio padrão</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da série Prometheus, poderá usar qualquer amostra da série para calcular o escore z.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O escore Z é uma medida do spread relativo do valor observado ou medido, que mostra quantos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desvios padrão</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seu spread é relativo ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor médio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, o escore z = 0 significa que o escore z é idêntico ao valor médio no conjunto de dados com a distribuição padrão e o escore z = 1 significa que o desvio padrão = 1,0 da média.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assumimos que os dados básicos têm uma distribuição normal, o que significa que 99,7% das amostras têm um escore z de 0 a 3. Quanto mais o escore z for zero, menor a probabilidade de existir.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aplicamos essa propriedade para detectar anomalias na série de dados do Prometheus:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculamos a média e o desvio padrão da métrica usando dados com um tamanho de amostra grande. </font><font style="vertical-align: inherit;">Neste exemplo, usamos dados semanais. </font><font style="vertical-align: inherit;">Se assumirmos que os registros são avaliados uma vez por minuto, em uma semana teremos um pouco mais de 10.000 amostras.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podemos calcular a pontuação z para a consulta Prometheus assim que obtivermos a média e o desvio padrão para agregação.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base nos princípios estatísticos das distribuições normais, suponha que qualquer valor fora do intervalo de +3 a -3 seja uma anomalia. </font><font style="vertical-align: inherit;">Dessa forma, podemos criar um aviso sobre essas anomalias. </font><font style="vertical-align: inherit;">Por exemplo, receberemos um alerta quando nossa agregação ultrapassar esse intervalo por mais de cinco minutos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gráfico do número de solicitações por segundo para o serviço GitLab Pages por 48 horas. </font><font style="vertical-align: inherit;">O escore Z no intervalo de +3 a -3 é destacado em</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
verde.O escore Z pode ser difícil de interpretar nos gráficos, pois esse valor não possui uma unidade de medida. </font><font style="vertical-align: inherit;">Mas as anomalias neste gráfico são muito simples de determinar. </font><font style="vertical-align: inherit;">Tudo o que vai além da zona verde, que mostra um corredor de valores com um escore z de -3 a +3, será um valor anômalo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que fazer se a distribuição de dados não for normal</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assumimos que a distribuição dos dados é normal. </font><font style="vertical-align: inherit;">Caso contrário, nosso escore z será falso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos truques estatísticos para determinar a normalidade da distribuição dos dados, mas a melhor maneira é verificar se o escore z dos seus dados está no intervalo de -4,0 a +4,0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duas consultas do Prometheus que mostram escores z mínimos e máximos:</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se seus resultados estiverem na faixa de -20 a +20, isso significa que muitos dados foram usados ​​e os resultados estão distorcidos. </font><font style="vertical-align: inherit;">Lembre-se também de que você deve trabalhar com linhas agregadas. </font><font style="vertical-align: inherit;">As métricas que não têm uma distribuição normal incluem parâmetros como taxa de erro, atraso, comprimento da fila e assim por diante. </font><font style="vertical-align: inherit;">Mas muitas dessas métricas funcionarão melhor com limites de alerta fixos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecção estatística de anomalias de sazonalidade</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora o cálculo de escores z funcione bem com a distribuição normal de dados de séries temporais, existe um segundo método que pode fornecer resultados de detecção de anomalias ainda mais precisos. </font><font style="vertical-align: inherit;">Esse é o uso da sazonalidade estatística.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A sazonalidade é uma característica de uma métrica de série temporal quando essa métrica sofre alterações regulares e previsíveis que são repetidas em cada ciclo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gráfico de solicitações por segundo (RPS) de segunda a domingo por quatro semanas consecutivas O</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
gráfico acima ilustra o RPS (número de solicitações por segundo) por sete dias - de segunda a domingo, por quatro semanas consecutivas. </font><font style="vertical-align: inherit;">Esse intervalo de sete dias é chamado de "deslocamento", ou seja, o padrão que será usado para a medição. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada semana no gráfico é de uma cor diferente. </font><font style="vertical-align: inherit;">A sazonalidade dos dados é indicada pela seqüência nas tendências indicadas no gráfico - toda segunda-feira de manhã observamos um aumento semelhante no RPS e à noite na sexta-feira sempre observamos um decréscimo no RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando a sazonalidade em nossos dados de séries temporais, podemos prever com mais precisão a ocorrência de anomalias e sua detecção.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como usar a sazonalidade</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometeu usa vários mecanismos estatísticos diferentes para calcular a sazonalidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, faça um cálculo, adicionando uma tendência de crescimento para a semana aos resultados da semana anterior. A tendência de crescimento é calculada da seguinte forma: subtraia a média móvel da última semana da média móvel da semana passada.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; — job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira iteração acaba sendo um pouco "estreita" - usamos a janela de cinco minutos desta semana e da semana anterior para obter nossas previsões. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na segunda iteração, expandimos nossa cobertura, medindo a média do período de quatro horas da semana anterior e comparando-a com a semana atual.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, se tentarmos prever o valor da métrica às oito da manhã da segunda-feira, em vez da mesma janela de cinco minutos da semana anterior, consideraremos o valor médio da métrica das seis às dez da manhã da segunda-feira anterior.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solicitação indicou 166 horas, ou seja, duas horas a menos que uma semana inteira (7 * 24 = 168), já que queremos usar um período de quatro horas com base no horário atual, portanto, precisamos que o deslocamento seja duas horas a menos que uma semana inteira.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPS real (amarelo) e previsto (azul) em duas semanas</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Uma comparação do RPS real com nossa previsão mostra que nossos cálculos foram razoavelmente precisos. No entanto, este método tem uma desvantagem. </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, em 1º de maio, o GitLab foi usado menos do que o habitual às quartas-feiras, pois esse dia era de folga. Como a tendência estimada de crescimento depende de como o sistema foi usado na semana anterior, nossas previsões para a próxima semana, ou seja, na quarta-feira, 8 de maio, deram um RPS menor do que realmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse erro pode ser corrigido fazendo três previsões por três semanas consecutivas antes da quarta-feira, 1º de maio, ou seja, as três quartas-feiras anteriores. A solicitação permanece a mesma, mas o deslocamento é ajustado.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Há três previsões no gráfico para três semanas antes de 8 de maio, em comparação com o RPS real de quarta-feira, 8 de maio. Você pode ver que as duas previsões são muito precisas, mas a previsão para a semana de 1º de maio permanece imprecisa</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Além disso, não precisamos de três previsões, precisamos de uma previsão. O valor médio não é uma opção, pois será borrado pelos nossos dados RPS distorcidos de 1º de maio. Em vez disso, você precisa calcular a mediana. Prometheus não possui uma consulta mediana, mas podemos usar agregação quantil em vez da mediana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O único problema é que estamos tentando incluir três séries na agregação, e essas três séries são na verdade a mesma série em três semanas. Em outras palavras, eles têm os mesmos rótulos, por isso é difícil reuni-los.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para evitar confusão, criamos um rótulo chamado deslocamento e usamos a função de substituição de rótulo para adicionar um deslocamento a cada uma das três semanas. </font><font style="vertical-align: inherit;">Então, na agregação quantil, descartamos esses rótulos, e isso nos dá uma média de três.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, nossa previsão com uma mediana de três agregações se tornou mais precisa.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Previsão mediana versus RPS real</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como descobrir que nossa previsão é realmente precisa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar a precisão da previsão, podemos retornar ao z-score. </font><font style="vertical-align: inherit;">É usado para medir a discrepância da amostra com sua previsão em desvios-padrão. </font><font style="vertical-align: inherit;">Quanto maior o desvio padrão em relação à previsão, maior a probabilidade de um valor específico ser extraviado.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O intervalo de desvio projetado é de +1,5 a -1,5.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Você pode alterar nosso gráfico Grafana para usar uma previsão sazonal, em vez de uma média móvel semanal. </font><font style="vertical-align: inherit;">O intervalo de valores normais para uma hora específica do dia está sombreado em verde. </font><font style="vertical-align: inherit;">Tudo o que vai além da zona verde é considerado um desvio. </font><font style="vertical-align: inherit;">Nesse caso, o erro ocorreu na tarde de domingo, quando nosso provedor de nuvem teve alguns problemas de rede. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
É uma boa prática usar um escore z de ± 2 para previsões sazonais.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como configurar alertas com o Prometheus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você deseja configurar um alerta para eventos anormais, pode aplicar a regra do Prometheus bastante simples, que verifica se o escore z de um indicador está no intervalo entre +2 e -2.</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No GitLab, usamos uma regra de roteamento personalizada que envia um alerta pelo Slack quando detecta anomalias, mas não entra em contato com nossa equipe de suporte.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como detectar anomalias no GitLab usando o Prometheus</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus pode ser usado para detectar algumas anormalidades.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A agregação adequada é a chave para encontrar anomalias.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pontuação Z é efetiva se seus dados tiverem uma distribuição normal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sazonalidade estatística é um mecanismo poderoso para detectar anomalias.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduzido com suporte do </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainda útil</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Métodos de cache simples no IC do GitLab: um guia de imagens</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferramentas GitLab CE prontas e personalizadas no mercado MCS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nosso canal Telegram sobre transformação digital</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499014/index.html">23 perguntas difíceis para entrevistas em JavaScript</a></li>
<li><a href="../pt499016/index.html">Integração com ESIA para .Net: mais fácil do que parece</a></li>
<li><a href="../pt499018/index.html">6 aplicativos de esportes em casa</a></li>
<li><a href="../pt499020/index.html">Um estudo de um comportamento vago</a></li>
<li><a href="../pt499030/index.html">Monitorando o desempenho do MySQL para Grafana on isic em 20 minutos</a></li>
<li><a href="../pt499034/index.html">Como implantar refatoração perigosa para produzir com um milhão de usuários?</a></li>
<li><a href="../pt499036/index.html">Trabalho do fornecedor: uma seleção de materiais sobre protocolos, TI e infraestrutura de rede</a></li>
<li><a href="../pt499038/index.html">Minha experiência usando um monitor vertical</a></li>
<li><a href="../pt499040/index.html">Leia no fim de semana: uma seleção de materiais sobre a história do DNS, regulamentação de TI e hardware 1cloud.ru</a></li>
<li><a href="../pt499044/index.html">Notícias do mundo do OpenStreetMap No. 508 (04/07/2020/13/04/2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>