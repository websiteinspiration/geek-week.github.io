<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¨ üë©üèæ‚Äçü§ù‚Äçüë®üèΩ ü§æüèæ Como usar o Prometheus para detectar anomalias no GitLab üìã üòâ ü§∑üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um dos recursos b√°sicos da linguagem de consulta do Prometheus √© a agrega√ß√£o em tempo real de s√©ries temporais . Voc√™ tamb√©m pode usar a linguagem de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como usar o Prometheus para detectar anomalias no GitLab</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos recursos b√°sicos da linguagem de consulta do Prometheus √© </font><font style="vertical-align: inherit;">a </font><font style="vertical-align: inherit;">agrega√ß√£o em </font><font style="vertical-align: inherit;">tempo real </font><font style="vertical-align: inherit;">de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√©ries temporais</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode usar a linguagem de consulta do Prometheus para detectar anomalias nos dados de s√©ries temporais.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">equipe do </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traduziu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um artigo do engenheiro da equipe de infraestrutura do GitLab</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , onde voc√™ encontrar√° exemplos de c√≥digo que podem ser testados em seus sistemas.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que serve a detec√ß√£o de anomalias?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° quatro raz√µes principais que determinam a import√¢ncia da detec√ß√£o de anomalias para o GitLab:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagn√≥stico de incidentes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : podemos detectar quais servi√ßos foram al√©m do escopo normal, reduzindo o tempo de detec√ß√£o de incidentes (MTTD) e, consequentemente, oferecer uma solu√ß√£o mais r√°pida para o problema.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detec√ß√£o de degrada√ß√£o do desempenho</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : por exemplo, se uma regress√£o √© introduzida em um servi√ßo que faz com que ele acesse outro servi√ßo com muita frequ√™ncia, podemos detectar e corrigir rapidamente esse problema.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detec√ß√£o e elimina√ß√£o de abuso</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : o GitLab fornece mecanismos de entrega e integra√ß√£o ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e hospedagem (p√°ginas do GitLab) e um n√∫mero limitado de usu√°rios que podem usar esses mecanismos.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seguran√ßa</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : a detec√ß√£o de anomalias √© importante para detectar tend√™ncias incomuns nas s√©ries temporais do GitLab.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por esses e outros motivos, o autor do artigo decidiu descobrir como configurar a defini√ß√£o de anomalias na s√©rie temporal do GitLab usando as regras e consultas do Prometheus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qual √© o n√≠vel de agrega√ß√£o correto?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, as s√©ries temporais devem ser corretamente agregadas. </font><font style="vertical-align: inherit;">No exemplo abaixo, usamos o contador http_requests_total padr√£o para recuperar dados, embora muitas outras m√©tricas tamb√©m o fizessem.</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa m√©trica de teste possui v√°rios par√¢metros: m√©todo, controlador, c√≥digo de status (status_code), ambiente, al√©m de par√¢metros adicionados pelo pr√≥prio Prometheus, por exemplo, trabalho e inst√¢ncia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ precisa escolher o n√≠vel certo de agrega√ß√£o de dados. </font><font style="vertical-align: inherit;">Demais, de menos - tudo isso √© importante para detectar anomalias. </font><font style="vertical-align: inherit;">Se os dados estiverem muito agregados, h√° dois problemas em potencial:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode ignorar a anomalia porque a agrega√ß√£o oculta problemas que ocorrem em subconjuntos de seus dados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ encontrar uma anomalia, √© dif√≠cil relacion√°-la a uma parte separada do seu sistema sem esfor√ßo adicional.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se os dados n√£o forem agregados o suficiente, isso pode levar a um aumento no n√∫mero de falsos positivos, bem como a uma interpreta√ß√£o incorreta dos dados v√°lidos como err√¥neos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base em nossa experi√™ncia, o n√≠vel de agrega√ß√£o mais correto √© o n√≠vel de servi√ßo, ou seja, inclu√≠mos o r√≥tulo de trabalho (trabalho) e ambiente (ambiente) e descartamos todos os outros r√≥tulos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A agrega√ß√£o, que discutiremos ao longo do artigo, inclui: job - http_request, agregation - cinco minutos, que √© calculado com base no trabalho e no ambiente em cinco minutos.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir do exemplo acima, √© claro que, da s√©rie http_requests_total, os subconjuntos s√£o selecionados no contexto de trabalho e ambiente, ent√£o seu n√∫mero √© considerado por cinco minutos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando o escore Z para detectar anomalias</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os princ√≠pios b√°sicos da estat√≠stica podem ser aplicados para detectar anomalias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ souber a m√©dia e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o desvio padr√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da s√©rie Prometheus, poder√° usar qualquer amostra da s√©rie para calcular o escore z.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O escore Z √© uma medida do spread relativo do valor observado ou medido, que mostra quantos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desvios padr√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seu spread √© relativo ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor m√©dio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, o escore z = 0 significa que o escore z √© id√™ntico ao valor m√©dio no conjunto de dados com a distribui√ß√£o padr√£o e o escore z = 1 significa que o desvio padr√£o = 1,0 da m√©dia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assumimos que os dados b√°sicos t√™m uma distribui√ß√£o normal, o que significa que 99,7% das amostras t√™m um escore z de 0 a 3. Quanto mais o escore z for zero, menor a probabilidade de existir.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aplicamos essa propriedade para detectar anomalias na s√©rie de dados do Prometheus:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculamos a m√©dia e o desvio padr√£o da m√©trica usando dados com um tamanho de amostra grande. </font><font style="vertical-align: inherit;">Neste exemplo, usamos dados semanais. </font><font style="vertical-align: inherit;">Se assumirmos que os registros s√£o avaliados uma vez por minuto, em uma semana teremos um pouco mais de 10.000 amostras.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podemos calcular a pontua√ß√£o z para a consulta Prometheus assim que obtivermos a m√©dia e o desvio padr√£o para agrega√ß√£o.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base nos princ√≠pios estat√≠sticos das distribui√ß√µes normais, suponha que qualquer valor fora do intervalo de +3 a -3 seja uma anomalia. </font><font style="vertical-align: inherit;">Dessa forma, podemos criar um aviso sobre essas anomalias. </font><font style="vertical-align: inherit;">Por exemplo, receberemos um alerta quando nossa agrega√ß√£o ultrapassar esse intervalo por mais de cinco minutos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√°fico do n√∫mero de solicita√ß√µes por segundo para o servi√ßo GitLab Pages por 48 horas. </font><font style="vertical-align: inherit;">O escore Z no intervalo de +3 a -3 √© destacado em</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
verde.O escore Z pode ser dif√≠cil de interpretar nos gr√°ficos, pois esse valor n√£o possui uma unidade de medida. </font><font style="vertical-align: inherit;">Mas as anomalias neste gr√°fico s√£o muito simples de determinar. </font><font style="vertical-align: inherit;">Tudo o que vai al√©m da zona verde, que mostra um corredor de valores com um escore z de -3 a +3, ser√° um valor an√¥malo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que fazer se a distribui√ß√£o de dados n√£o for normal</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assumimos que a distribui√ß√£o dos dados √© normal. </font><font style="vertical-align: inherit;">Caso contr√°rio, nosso escore z ser√° falso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos truques estat√≠sticos para determinar a normalidade da distribui√ß√£o dos dados, mas a melhor maneira √© verificar se o escore z dos seus dados est√° no intervalo de -4,0 a +4,0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Duas consultas do Prometheus que mostram escores z m√≠nimos e m√°ximos:</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se seus resultados estiverem na faixa de -20 a +20, isso significa que muitos dados foram usados ‚Äã‚Äãe os resultados est√£o distorcidos. </font><font style="vertical-align: inherit;">Lembre-se tamb√©m de que voc√™ deve trabalhar com linhas agregadas. </font><font style="vertical-align: inherit;">As m√©tricas que n√£o t√™m uma distribui√ß√£o normal incluem par√¢metros como taxa de erro, atraso, comprimento da fila e assim por diante. </font><font style="vertical-align: inherit;">Mas muitas dessas m√©tricas funcionar√£o melhor com limites de alerta fixos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detec√ß√£o estat√≠stica de anomalias de sazonalidade</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora o c√°lculo de escores z funcione bem com a distribui√ß√£o normal de dados de s√©ries temporais, existe um segundo m√©todo que pode fornecer resultados de detec√ß√£o de anomalias ainda mais precisos. </font><font style="vertical-align: inherit;">Esse √© o uso da sazonalidade estat√≠stica.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A sazonalidade √© uma caracter√≠stica de uma m√©trica de s√©rie temporal quando essa m√©trica sofre altera√ß√µes regulares e previs√≠veis que s√£o repetidas em cada ciclo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√°fico de solicita√ß√µes por segundo (RPS) de segunda a domingo por quatro semanas consecutivas O</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
gr√°fico acima ilustra o RPS (n√∫mero de solicita√ß√µes por segundo) por sete dias - de segunda a domingo, por quatro semanas consecutivas. </font><font style="vertical-align: inherit;">Esse intervalo de sete dias √© chamado de "deslocamento", ou seja, o padr√£o que ser√° usado para a medi√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada semana no gr√°fico √© de uma cor diferente. </font><font style="vertical-align: inherit;">A sazonalidade dos dados √© indicada pela seq√º√™ncia nas tend√™ncias indicadas no gr√°fico - toda segunda-feira de manh√£ observamos um aumento semelhante no RPS e √† noite na sexta-feira sempre observamos um decr√©scimo no RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando a sazonalidade em nossos dados de s√©ries temporais, podemos prever com mais precis√£o a ocorr√™ncia de anomalias e sua detec√ß√£o.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como usar a sazonalidade</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometeu usa v√°rios mecanismos estat√≠sticos diferentes para calcular a sazonalidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, fa√ßa um c√°lculo, adicionando uma tend√™ncia de crescimento para a semana aos resultados da semana anterior. A tend√™ncia de crescimento √© calculada da seguinte forma: subtraia a m√©dia m√≥vel da √∫ltima semana da m√©dia m√≥vel da semana passada.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira itera√ß√£o acaba sendo um pouco "estreita" - usamos a janela de cinco minutos desta semana e da semana anterior para obter nossas previs√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na segunda itera√ß√£o, expandimos nossa cobertura, medindo a m√©dia do per√≠odo de quatro horas da semana anterior e comparando-a com a semana atual.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, se tentarmos prever o valor da m√©trica √†s oito da manh√£ da segunda-feira, em vez da mesma janela de cinco minutos da semana anterior, consideraremos o valor m√©dio da m√©trica das seis √†s dez da manh√£ da segunda-feira anterior.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solicita√ß√£o indicou 166 horas, ou seja, duas horas a menos que uma semana inteira (7 * 24 = 168), j√° que queremos usar um per√≠odo de quatro horas com base no hor√°rio atual, portanto, precisamos que o deslocamento seja duas horas a menos que uma semana inteira.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPS real (amarelo) e previsto (azul) em duas semanas</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Uma compara√ß√£o do RPS real com nossa previs√£o mostra que nossos c√°lculos foram razoavelmente precisos. No entanto, este m√©todo tem uma desvantagem. </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, em 1¬∫ de maio, o GitLab foi usado menos do que o habitual √†s quartas-feiras, pois esse dia era de folga. Como a tend√™ncia estimada de crescimento depende de como o sistema foi usado na semana anterior, nossas previs√µes para a pr√≥xima semana, ou seja, na quarta-feira, 8 de maio, deram um RPS menor do que realmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse erro pode ser corrigido fazendo tr√™s previs√µes por tr√™s semanas consecutivas antes da quarta-feira, 1¬∫ de maio, ou seja, as tr√™s quartas-feiras anteriores. A solicita√ß√£o permanece a mesma, mas o deslocamento √© ajustado.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H√° tr√™s previs√µes no gr√°fico para tr√™s semanas antes de 8 de maio, em compara√ß√£o com o RPS real de quarta-feira, 8 de maio. Voc√™ pode ver que as duas previs√µes s√£o muito precisas, mas a previs√£o para a semana de 1¬∫ de maio permanece imprecisa</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Al√©m disso, n√£o precisamos de tr√™s previs√µes, precisamos de uma previs√£o. O valor m√©dio n√£o √© uma op√ß√£o, pois ser√° borrado pelos nossos dados RPS distorcidos de 1¬∫ de maio. Em vez disso, voc√™ precisa calcular a mediana. Prometheus n√£o possui uma consulta mediana, mas podemos usar agrega√ß√£o quantil em vez da mediana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O √∫nico problema √© que estamos tentando incluir tr√™s s√©ries na agrega√ß√£o, e essas tr√™s s√©ries s√£o na verdade a mesma s√©rie em tr√™s semanas. Em outras palavras, eles t√™m os mesmos r√≥tulos, por isso √© dif√≠cil reuni-los.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para evitar confus√£o, criamos um r√≥tulo chamado deslocamento e usamos a fun√ß√£o de substitui√ß√£o de r√≥tulo para adicionar um deslocamento a cada uma das tr√™s semanas. </font><font style="vertical-align: inherit;">Ent√£o, na agrega√ß√£o quantil, descartamos esses r√≥tulos, e isso nos d√° uma m√©dia de tr√™s.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, nossa previs√£o com uma mediana de tr√™s agrega√ß√µes se tornou mais precisa.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Previs√£o mediana versus RPS real</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como descobrir que nossa previs√£o √© realmente precisa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar a precis√£o da previs√£o, podemos retornar ao z-score. </font><font style="vertical-align: inherit;">√â usado para medir a discrep√¢ncia da amostra com sua previs√£o em desvios-padr√£o. </font><font style="vertical-align: inherit;">Quanto maior o desvio padr√£o em rela√ß√£o √† previs√£o, maior a probabilidade de um valor espec√≠fico ser extraviado.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O intervalo de desvio projetado √© de +1,5 a -1,5.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Voc√™ pode alterar nosso gr√°fico Grafana para usar uma previs√£o sazonal, em vez de uma m√©dia m√≥vel semanal. </font><font style="vertical-align: inherit;">O intervalo de valores normais para uma hora espec√≠fica do dia est√° sombreado em verde. </font><font style="vertical-align: inherit;">Tudo o que vai al√©m da zona verde √© considerado um desvio. </font><font style="vertical-align: inherit;">Nesse caso, o erro ocorreu na tarde de domingo, quando nosso provedor de nuvem teve alguns problemas de rede. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â uma boa pr√°tica usar um escore z de ¬± 2 para previs√µes sazonais.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como configurar alertas com o Prometheus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ deseja configurar um alerta para eventos anormais, pode aplicar a regra do Prometheus bastante simples, que verifica se o escore z de um indicador est√° no intervalo entre +2 e -2.</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No GitLab, usamos uma regra de roteamento personalizada que envia um alerta pelo Slack quando detecta anomalias, mas n√£o entra em contato com nossa equipe de suporte.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como detectar anomalias no GitLab usando o Prometheus</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus pode ser usado para detectar algumas anormalidades.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A agrega√ß√£o adequada √© a chave para encontrar anomalias.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pontua√ß√£o Z √© efetiva se seus dados tiverem uma distribui√ß√£o normal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sazonalidade estat√≠stica √© um mecanismo poderoso para detectar anomalias.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduzido com suporte do </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainda √∫til</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©todos de cache simples no IC do GitLab: um guia de imagens</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferramentas GitLab CE prontas e personalizadas no mercado MCS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nosso canal Telegram sobre transforma√ß√£o digital</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499014/index.html">23 perguntas dif√≠ceis para entrevistas em JavaScript</a></li>
<li><a href="../pt499016/index.html">Integra√ß√£o com ESIA para .Net: mais f√°cil do que parece</a></li>
<li><a href="../pt499018/index.html">6 aplicativos de esportes em casa</a></li>
<li><a href="../pt499020/index.html">Um estudo de um comportamento vago</a></li>
<li><a href="../pt499030/index.html">Monitorando o desempenho do MySQL para Grafana on isic em 20 minutos</a></li>
<li><a href="../pt499034/index.html">Como implantar refatora√ß√£o perigosa para produzir com um milh√£o de usu√°rios?</a></li>
<li><a href="../pt499036/index.html">Trabalho do fornecedor: uma sele√ß√£o de materiais sobre protocolos, TI e infraestrutura de rede</a></li>
<li><a href="../pt499038/index.html">Minha experi√™ncia usando um monitor vertical</a></li>
<li><a href="../pt499040/index.html">Leia no fim de semana: uma sele√ß√£o de materiais sobre a hist√≥ria do DNS, regulamenta√ß√£o de TI e hardware 1cloud.ru</a></li>
<li><a href="../pt499044/index.html">Not√≠cias do mundo do OpenStreetMap No. 508 (04/07/2020/13/04/2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>