<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîè ‚ìÇÔ∏è üî∞ Kubernetes ConfigMaps: Nuances √† conna√Ætre üì¶ üç¥ üëåüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque : ce n'est pas un article de guide √† part enti√®re, mais plut√¥t un rappel / indice pour ceux qui utilisent d√©j√† ConfigMap dans Kubernetes ou q...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes ConfigMaps: Nuances √† conna√Ætre</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498970/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ce n'est pas un article de guide √† part enti√®re, mais plut√¥t un rappel / indice pour ceux qui utilisent d√©j√† ConfigMap dans Kubernetes ou qui pr√©parent simplement leur application pour y travailler.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_h/ly/ln/_hlylnaruzb2_b5zhbjpinrdphy.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte: De rsync √† ... Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-il arriv√© avant? √Ä l'√®re de ¬´l'administration classique¬ª, dans la version la plus simple, le fichier de configuration √©tait plac√© juste √† c√¥t√© des applications (ou dans le r√©f√©rentiel, si vous voulez). C'est simple: nous faisons la livraison √©l√©mentaire (CD) de notre code avec la config. M√™me une impl√©mentation conditionnelle de rsync peut √™tre appel√©e les rudiments d'un CD.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque l'infrastructure s'est d√©velopp√©e, diff√©rentes configurations ont √©t√© n√©cessaires pour diff√©rents environnements (d√©veloppement / stade / production). L'application a √©t√© form√©e pour comprendre quelle configuration utiliser, en les passant comme arguments pour d√©marrer ou comme variables d'environnement d√©finies dans l'environnement. Encore plus de CD est compliqu√© avec l'av√®nement de ce Chef / Marionnette / Ansible si utile. Les r√¥les apparaissent sur les serveurs et les environnements ne sont plus d√©crits √† diff√©rents endroits - nous arrivons √† IaC (Infrastructure en tant que code). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-ce qui a suivi? S'il √©tait possible de voir par lui-m√™me les avantages critiques de Kubernetes et m√™me de comprendre la n√©cessit√© de modifier les applications pour qu'elles fonctionnent dans cet environnement, la migration s'est produite. Sur le chemin, je m'attendais √† beaucoup de nuances et de diff√©rences dans la construction de l'architecture, mais quand j'ai r√©ussi √† faire face √† la partie principale, j'ai obtenu l'application tant attendue en cours d'ex√©cution dans K8s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois ici, nous pouvons toujours utiliser les configurations pr√©par√©es dans le r√©f√©rentiel √† c√¥t√© de l'application ou passer ENV au conteneur. </font><font style="vertical-align: inherit;">Cependant, en plus de ces m√©thodes, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont √©galement disponibles </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cette primitive K8s vous permet d'utiliser des mod√®les Go dans les configurations, c'est-√†-dire </font><font style="vertical-align: inherit;">les rendre comme des pages HTML et recharger l'application lors du changement de la configuration sans red√©marrage. </font><font style="vertical-align: inherit;">Avec ConfigMaps, il n'est plus n√©cessaire de conserver 3+ configurations pour diff√©rents environnements et de garder une trace de la pertinence de chacune. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une introduction g√©n√©rale √† ConfigMaps peut √™tre trouv√©e, par exemple, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et dans cet article, je vais me concentrer sur certaines fonctionnalit√©s de leur travail.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps simples</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä quoi ressemblaient les configurations dans Kubernetes? </font><font style="vertical-align: inherit;">Qu'ont-ils obtenu des mod√®les go? </font><font style="vertical-align: inherit;">Par exemple, voici un ConfigMap ordinaire pour une application d√©ploy√©e √† partir d'un graphique Helm:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: app<font></font>
data:<font></font>
  config.json: |<font></font>
    {<font></font>
      "welcome": {{ pluck .Values.global.env .Values.welcome | quote }},<font></font>
      "name": {{ pluck .Values.global.env .Values.name | quote }}<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, les valeurs substitu√©es </font></font><code>.Values.welcome</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>.Values.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seront extraites du fichier </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pourquoi exactement </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">Comment fonctionne le moteur de mod√®les Go? </font><font style="vertical-align: inherit;">Nous avons d√©j√† parl√© de ces d√©tails plus en d√©tail </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permet de s√©lectionner la ligne n√©cessaire sur la carte:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cat .helm/values.yaml <font></font>
welcome:<font></font>
  production: "Hello"<font></font>
  test: "Hey"<font></font>
name:<font></font>
  production: "Bob"<font></font>
  test: "Mike"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, vous pouvez prendre √† la fois des lignes sp√©cifiques et des fragments entiers de la configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, ConfigMap pourrait ressembler √† ceci:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {{ pluck .Values.global.env .Values.data | first | toJson | indent 4 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... et dans </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le contenu suivant:</font></font><br>
<br>
<pre><code class="plaintext hljs">data:<font></font>
  production:<font></font>
    welcome: "Hello"<font></font>
    name: "Bob"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Celui qui </font></font><code>global.env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est </font><font style="vertical-align: inherit;">impliqu√© ici </font><font style="vertical-align: inherit;">est le nom de l'environnement. </font><font style="vertical-align: inherit;">En rempla√ßant cette valeur pendant le d√©ploiement, vous pouvez rendre des ConfigMaps avec un contenu diff√©rent. </font></font><code>first</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√©cessaire ici parce que </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie une liste dont le premier √©l√©ment contient la valeur souhait√©e.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand il y a beaucoup de configurations</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ConfigMap peut contenir plusieurs fichiers de configuration:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {<font></font>
      <span class="hljs-attr">"welcome"</span>: {{ pluck .Values.global.env .Values.welcome | first | quote }},
      <span class="hljs-string">"name"</span>: {{ pluck .Values.global.env .Values.name | first | quote }}<font></font>
    }<font></font>
  database.yml: |<font></font>
    host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><font></font>
    db: app<font></font>
    user: app<font></font>
    password: app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez m√™me monter chaque configuration s√©par√©ment:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/config.json<font></font>
          subPath: config.json<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/database.yml<font></font>
          subPath: database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... ou r√©cup√©rez toutes les configurations √† la fois avec le r√©pertoire:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous modifiez la description de la ressource de d√©ploiement pendant le d√©ploiement, Kubernetes cr√©era un nouveau ReplicaSet, diminuant l'ancien √† 0 et augmentant le nouveau au nombre sp√©cifi√© de r√©plicas. </font><font style="vertical-align: inherit;">(Cela est vrai pour la strat√©gie de d√©ploiement </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>RollingUpdate</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De telles actions entra√Æneront la recr√©ation du pod avec une nouvelle description. </font><font style="vertical-align: inherit;">Par exemple: il y avait une image </font></font><code>image:my-registry.example.com:v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais est devenu - </font></font><code>image:my-registry.example.com:v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Et peu importe ce que nous avons chang√© exactement dans la description de notre d√©ploiement: l'essentiel est que cela a entra√Æn√© la recr√©ation du replicaSet (et, par cons√©quent, du pod). </font><font style="vertical-align: inherit;">Dans ce cas, la nouvelle version du fichier de configuration dans la nouvelle version de l'application est automatiquement mont√©e et il n'y aura aucun probl√®me.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©ponse au changement de ConfigMap</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cas de changements dans ConfigMap, quatre sc√©narios d'√©v√©nements peuvent suivre. </font><font style="vertical-align: inherit;">Consid√©rez-les:</font></font><br>
<br>
<ol>
<li> <b></b>:  ConfigMap,    subPath.<br>
<b></b>:       .</li>
<li> <b></b>:  ConfigMap,          pod.<br>
<b></b>:  pod     .</li>
<li> <b></b>:  ConfigMap    Deployment     -.<br>
<b></b>:   ,      ConfigMap‚Äô,   Deployment,   pod  ,   ‚Äî        .</li>
<li> <b></b>:  ConfigMap,   .<br>
<b></b>:    pod‚Äô   / pod‚Äô.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous analyserons plus en d√©tail.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sc√©nario 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seulement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corrig√© ConfigMap? </font><font style="vertical-align: inherit;">L'application ne red√©marrera pas. </font><font style="vertical-align: inherit;">Dans le cas d'un montage par, </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'y aura aucun changement jusqu'√† ce que le pod soit red√©marr√© manuellement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est simple: Kubernetes monte notre ConfigMap dans un pod d'une version sp√©cifique de la ressource. </font><font style="vertical-align: inherit;">Puisqu'il est mont√© avec </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aucune "influence" suppl√©mentaire sur la config n'est plus fournie.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sc√©nario 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous ne pouvez pas mettre √† jour le fichier sans recr√©er le pod? </font><font style="vertical-align: inherit;">D'accord, nous avons 6 r√©pliques dans le d√©ploiement, nous pouvons donc nous relayer manuellement pour tout faire </font></font><code>delete pod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ensuite, lors de la cr√©ation de nouveaux pods, ils ¬´r√©cup√®rent¬ª la nouvelle version de ConfigMap.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sc√©nario 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fatigu√© d'effectuer de telles op√©rations manuellement? </font><font style="vertical-align: inherit;">Une solution √† ce probl√®me est d√©crite dans les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conseils et astuces de Helm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Deployment<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      annotations:<font></font>
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}<font></font>
[...]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hachage de la configuration d'annotation rendue est simplement √©crit </font><font style="vertical-align: inherit;">dans le mod√®le pod ( </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les annotations sont des champs de valeurs-cl√©s arbitraires dans lesquels vous pouvez stocker vos valeurs. </font><font style="vertical-align: inherit;">Si vous les enregistrez dans le mod√®le du </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">futur pod, ces champs tomberont dans le ReplicaSet et le pod lui-m√™me. </font><font style="vertical-align: inherit;">Kubernetes remarquera que le mod√®le de pod a chang√© (parce que la configuration sha256 a chang√©) et d√©marrera </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dans lequel rien ne change, sauf cette annotation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous enregistrons la m√™me version de l'application et de la description du d√©ploiement et d√©clenchons essentiellement la recr√©ation du pod par la machine - de la m√™me mani√®re que nous le ferions manuellement </font></font><code>kubectl delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais d√©j√† ¬´correctement¬ª: automatiquement et avec </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sc√©nario 4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre que l'application sait d√©j√† comment surveiller les changements dans la configuration et recharger automatiquement? </font><font style="vertical-align: inherit;">Voici une caract√©ristique importante de ConfigMaps ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans Kubernetes, si la config est mont√©e avec </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, elle ne sera pas mise √† jour tant que le pod n'aura pas √©t√© red√©marr√© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(voir les trois premiers sc√©narios discut√©s ci-dessus)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais si vous montez ConfigMap en tant que r√©pertoire, sans </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, √† l'int√©rieur du conteneur, il y aura un r√©pertoire avec une configuration mise √† jour sans red√©marrer le pod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe d'autres fonctionnalit√©s utiles √† retenir:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un tel fichier de configuration mis √† jour √† l'int√©rieur du conteneur est mis √† jour avec un certain retard. </font><font style="vertical-align: inherit;">Cela est d√ª au fait que le fichier n'est pas mont√© exactement, mais l'objet Kubernetes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le fichier √† l'int√©rieur est un lien symbolique. </font><font style="vertical-align: inherit;">Exemple avec </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-6b4cb86569-22vqv -- ls -lha /app/configfiles <font></font>
total 20K    <font></font>
drwxr-xr-x    1 root     root        4.0K Mar  3 19:34 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
-rw-r--r--    1 root     root          42 Mar  3 19:34 config.json<font></font>
-rw-r--r--    1 root     root          47 Mar  3 19:34 database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et que se passera-t-il sans une </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fois mont√© par le r√©pertoire?</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:40 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:40 ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:40 ..data -&gt; ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mettez √† jour la configuration (via deploy ou </font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), attendez 2 minutes (temps de mise en cache apiserver) - et le tour est jou√©:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha --color /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:44 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:44 ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:44 ..data -&gt; ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez l'horodatage modifi√© dans le r√©pertoire cr√©√© par Kubernetes.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suivi des modifications</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et enfin - un exemple simple de la fa√ßon dont vous pouvez surveiller les changements dans la configuration.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous utiliserons une telle application Go</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span><font></font>
<font></font>
	<span class="hljs-string">"github.com/fsnotify/fsnotify"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// Config fo our application</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
	Welcome <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"welcome"`</span>
	Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> (<font></font>
	globalConfig *Config<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// LoadConfig - load our config!</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Config, error)</span></span> {<font></font>
	configFile, err := os.Open(path)<font></font>
<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to read configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	config := <span class="hljs-built_in">new</span>(Config)<font></font>
<font></font>
	decoder := json.NewDecoder(configFile)<font></font>
	err = decoder.Decode(&amp;config)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to parse configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">return</span> config, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ConfigWatcher - watches config.json for changes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigWatcher</span><span class="hljs-params">()</span></span> {<font></font>
	watcher, err := fsnotify.NewWatcher()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	<span class="hljs-keyword">defer</span> watcher.Close()<font></font>
<font></font>
	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> {
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> event, ok := &lt;-watcher.Events:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"event:"</span>, event)
				<span class="hljs-keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write {<font></font>
					log.Println(<span class="hljs-string">"modified file:"</span>, event.Name)<font></font>
				}<font></font>
				globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)<font></font>
				log.Println(<span class="hljs-string">"config:"</span>, globalConfig)
			<span class="hljs-keyword">case</span> err, ok := &lt;-watcher.Errors:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"error:"</span>, err)<font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
<font></font>
	err = watcher.Add(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	&lt;-done<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	log.Println(<span class="hljs-string">"Start"</span>)<font></font>
	globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">go</span> ConfigWatcher()
	<span class="hljs-keyword">for</span> {<font></font>
		log.Println(<span class="hljs-string">"config:"</span>, globalConfig)<font></font>
		time.Sleep(<span class="hljs-number">30</span> * time.Second)<font></font>
	}<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... en l'ajoutant avec une telle configuration:</font></font><br>
<br>
<pre><code class="json hljs">$ cat configfiles/config.json <font></font>
{<font></font>
  <span class="hljs-attr">"welcome"</span>: <span class="hljs-string">"Hello"</span>,
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Alice"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il est ex√©cut√©, le journal sera:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:18:22 config: &amp;{Hello Alice}<font></font>
2020/03/03 22:18:52 config: &amp;{Hello Alice}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous allons installer cette application dans Kubernetes, apr√®s avoir mont√© la configuration ConfigMap dans le pod au lieu du fichier image. </font><font style="vertical-align: inherit;">Un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemple de graphique Helm a √©t√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pr√©par√© sur GitHub </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">helm install -n habr-configmap --namespace habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Alice'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et modifiez uniquement ConfigMap:</font></font><br>
<br>
<pre><code class="bash hljs">-  production: <span class="hljs-string">"Alice"</span>
+  production: <span class="hljs-string">"Bob"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mettez √† jour le graphique Helm dans le cluster, par exemple, comme ceci:</font></font><br>
<br>
<pre><code class="bash hljs">helm upgrade habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Bob'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que va-t-il se passer?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les applications v1 et v2 ne red√©marrent pas, car </font><font style="vertical-align: inherit;">pour eux, aucun changement n'est intervenu dans le d√©ploiement - ils accueillent toujours Alice.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L'application v3 a red√©marr√©, relu la configuration et salu√© Bob.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'application v4 n'a pas red√©marr√©. </font><font style="vertical-align: inherit;">Comme ConfigMap est mont√© en tant que r√©pertoire, des changements dans la configuration ont √©t√© remarqu√©s et la configuration a √©t√© modifi√©e √† la vol√©e, sans red√©marrer le pod. </font><font style="vertical-align: inherit;">Oui, l'application a remarqu√© des changements dans notre exemple simple - voir le message d'√©v√©nement de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fsnotify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:19:15 event: "configfiles/config.json": CHMOD<font></font>
2020/03/03 22:19:15 config: &amp;{Hello Bob}<font></font>
2020/03/03 22:19:22 config: &amp;{Hello Bob}</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez voir comment une situation similaire - suivre les changements de ConfigMap - est r√©solue dans un projet plus adulte (et simplement ¬´r√©el¬ª), </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est √©galement utile de rappeler que tout ce qui pr√©c√®de dans l'article est √©galement vrai pour Secret'ov dans Kubernetes ( </font></font><code>kind: Secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">): ce n'est pas pour rien qu'ils sont si similaires √† ConfigMap ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prime! </font><font style="vertical-align: inherit;">Solutions tierces</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous √™tes int√©ress√© par le sujet du suivi des modifications dans les configurations, il existe d√©j√† des utilitaires pr√™ts √† l'emploi pour cela:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jimmidyson / configmap-reload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Envoie une requ√™te HTTP si le fichier a chang√©. </font><font style="vertical-align: inherit;">Le d√©veloppeur pr√©voit √©galement d'enseigner √† SIGHUP d'envoyer, mais le manque de validations √† partir d'octobre 2019 laisse ces plans en question;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stakater / Reloader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - surveille ConfigMap / Secrets et effectue une mise √† niveau progressive (comme son auteur l'appelle) sur les ressources qui leur sont associ√©es.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il sera commode de lancer de telles applications avec un sidecar-container aux applications existantes. </font><font style="vertical-align: inherit;">Cependant, si vous connaissez les fonctionnalit√©s de Kubernetes / ConfigMap et des configurations √† √©diter non pas "en direct" (√† travers </font></font><code>edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mais uniquement dans le cadre du d√©ploiement ... alors les capacit√©s de ces utilitaires peuvent sembler superflues, c'est-√†-dire </font><font style="vertical-align: inherit;">duplication des fonctions de base.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec l'av√®nement de ConfigMap dans Kubernetes, les configurations sont pass√©es √† la prochaine phase de d√©veloppement: l'utilisation d'un moteur de mod√®le leur a apport√© une flexibilit√© comparable au rendu des pages HTML. </font><font style="vertical-align: inherit;">Heureusement, de telles complications n'ont pas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remplac√© les</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solutions existantes, mais sont devenues leur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compl√©ment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par cons√©quent, pour les administrateurs (ou plut√¥t, m√™me les d√©veloppeurs) qui consid√®rent les nouvelles fonctionnalit√©s comme redondantes, de bons vieux fichiers sont toujours disponibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ceux qui utilisent d√©j√† ConfigMap'ami ou qui les regardent simplement, l'article donne un bref aper√ßu de leur essence et de leurs nuances d'utilisation. </font><font style="vertical-align: inherit;">Si vous avez vos propres trucs et astuces sur le sujet - je serai heureux de voir dans les commentaires.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez aussi dans notre blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fichiers locaux lors du portage d'une application vers Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª;</font></font></li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   Kubernetes  Helm:    </a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SSL-  Let's Encrypt  cert-manager  Kubernetes</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498944/index.html">T√©l√©gramme Chien ou comment ne pas faire de miroirs</a></li>
<li><a href="../fr498948/index.html">Il est temps pour les dragons. Auto-isolement avec des puzzles</a></li>
<li><a href="../fr498952/index.html">Nous invitons √† DINS JS EVENING: nous parlons de programmation orient√©e aspect et du framework API de composition Vuejs 3</a></li>
<li><a href="../fr498958/index.html">L'erreur n'est pas UIAlertController</a></li>
<li><a href="../fr498962/index.html">√Ä propos du multit√¢che: les fen√™tres sous contr√¥le</a></li>
<li><a href="../fr498974/index.html">Coronavirus: une dangereuse illusion d'ins√©curit√©</a></li>
<li><a href="../fr498976/index.html">Pr√©sentation de .NET 5.0 Preview 3</a></li>
<li><a href="../fr498978/index.html">Utilisation de Graylog et NLog pour collecter les journaux des applications C #. Exp√©rience personnelle</a></li>
<li><a href="../fr498982/index.html">Floppies for Dreamcast</a></li>
<li><a href="../fr498984/index.html">Stealth School: 5 types de gadgets dans les jeux furtifs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>