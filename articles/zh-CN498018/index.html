<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌸 🚱 🏣 微服务架构中的运营分析：帮助和提示Postgres FDW来帮助开发人员 🧛🏾 📞 👩🏼‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="就像这个世界上的所有事物一样，微服务架构也有其优缺点。使用它的某些过程变得更容易，而其他过程则更加复杂。为了改变的速度和更好的可伸缩性，必须做出牺牲。其中之一是分析的复杂性。如果在一个整体中所有操作分析都可以简化为用于分析副本的SQL查询，那么在多服务体系结构中，每个服务都有其自己的基础，并且似乎无...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>微服务架构中的运营分析：帮助和提示Postgres FDW来帮助开发人员</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/domclick/blog/498018/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">就像这个世界上的所有事物一样，微服务架构也有其优缺点。使用它的某些过程变得更容易，而其他过程则更加复杂。为了改变的速度和更好的可伸缩性，必须做出牺牲。其中之一是分析的复杂性。如果在一个整体中所有操作分析都可以简化为用于分析副本的SQL查询，那么在多服务体系结构中，每个服务都有其自己的基础，并且似乎无法放弃一个查询（或者可以放弃它吗？）。对于那些对我们如何解决公司的运营分析问题以及我们如何学会使用该解决方案感兴趣的人，欢迎您。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/lo/cj/zclocjwvmvs1k3f9hp1yr4wy698.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我的名字叫Pavel Sivash，在DomKlik中，我在一个团队中负责维护分析数据仓库。按照惯例，我们的活动可以归因于工程设计的日期，但实际上，任务的范围要广泛得多。有ETL / ELT标准用于日期工程，工具的支持和改编，以进行数据分析和开发自己的工具。特别是，对于运营报告，我们决定“假装”拥有完整的资料，并为分析师提供一个基础，使他们可以拥有所需的所有数据。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，我们考虑了不同的选择。可以构建一个完整的存储库-我们甚至尝试过，但是老实说，我们未能在建立和修改存储库的过程中让朋友在逻辑上进行足够频繁的更改（如果有人成功了，请在注释中写下如何做）。可以告诉分析人员：“人，学习python并获得分析提示”，但这是招聘人员的另一项要求，并且似乎应该避免这种情况。我们决定尝试使用FDW（外部数据包装器）技术：实际上，这是标准dblink，它在SQL标准中，但具有更方便的接口。在此基础上，我们做出了决定，最终定居下来，我们停止了。它的详细信息是另一篇文章的主题，或者可能不是，因为我想谈很多事情：从数据库方案的同步到访问控制和个人数据的匿名化。您还需要保留一点，即此解决方案不能替代实际的分析数据库和存储库，它只能解决特定的问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
顶级看起来像这样：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/eu/ta/ou/eutaouuz7zwuukzyqgifafovvis.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有一个PostgreSQL数据库，用户可以在其中存储其工作数据，最重要的是，所有服务的分析副本都通过FDW连接到该数据库。</font><font style="vertical-align: inherit;">这样就可以将查询写到多个数据库，无论它是什么：PostgreSQL，MySQL，MongoDB或其他（文件，API，如果突然没有合适的包装器，则可以编写自己的查询）。</font><font style="vertical-align: inherit;">好吧，一切似乎都很棒！</font><font style="vertical-align: inherit;">我们不同意吗？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果一切都如此迅速而简单地结束，那么可能就不会有文章了。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要的是清楚地了解postgres如何处理对远程服务器的请求。</font><font style="vertical-align: inherit;">这似乎是合乎逻辑的，但通常他们并不注意它：postgres将请求分为独立的部分，这些部分在远程服务器上独立执行，收集数据，最后的计算由自己完成，因此请求的速度将很大程度上取决于请求的编写方式。</font><font style="vertical-align: inherit;">还应注意：当数据来自远程服务器时，它们不再具有索引，没有什么可以帮助调度程序，因此，只有我们可以提供帮助和建议。</font><font style="vertical-align: inherit;">我想告诉您更多有关此的信息。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">简单的请求和计划</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了展示postgres如何在远程服务器上的600万行表上执行查询，让我们看一个简单的计划。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose  
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table;<font></font>
<font></font>
Aggregate  (cost=418383.23..418383.24 rows=1 width=8) (actual time=3857.198..3857.198 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..402376.14 rows=6402838 width=0) (actual time=4.874..3256.511 rows=6406868 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Remote SQL: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.986</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">3857.436</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用VERBOSE指令，您可以查看将发送到远程服务器的请求以及我们将收到的结果以进行进一步处理（RemoteSQL行）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们更进一步，为查询添加几个过滤器：一个过滤器是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">布尔</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段，一个</font><font style="vertical-align: inherit;">过滤器</font><font style="vertical-align: inherit;">是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">间隔中</font><font style="vertical-align: inherit;">的</font><b><font style="vertical-align: inherit;">时间戳</font></b><font style="vertical-align: inherit;">，一个</font><font style="vertical-align: inherit;">过滤器</font><font style="vertical-align: inherit;">是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=577487.69..577487.70 rows=1 width=8) (actual time=27473.818..25473.819 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..577469.21 rows=7390 width=0) (actual time=31.369..25372.466 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND (("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">5046843</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.665</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">27474.118</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是您编写查询时需要注意的时刻。</font><font style="vertical-align: inherit;">过滤器没有转移到远程服务器，这意味着要执行该过滤器，postgres扩展了全部600万行，只是稍后在本地过滤（过滤器行）并执行聚合。</font><font style="vertical-align: inherit;">成功的关键是编写一个请求，以便将筛选器传输到远程计算机，并且我们仅接收和汇总必要的行。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">那是一些布尔值</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用布尔字段，一切都很简单。</font><font style="vertical-align: inherit;">在原始请求中，问题出在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">语句</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果将其替换为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，那么将得到以下结果：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=508010.14..508010.15 rows=1 width=8) (actual time=19064.314..19064.314 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=100.00..507988.44 rows=8679 width=0) (actual time=33.035..18951.278 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: ((("table".meta -&gt;&gt; 'source'::text) = 'test'::text) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">3567989</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active)<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.834</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">19064.534</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如您所见，过滤器飞到了远程服务器，运行时间从27秒减少到19秒。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值得注意的是，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符</font><font style="vertical-align: inherit;">与</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算</font><font style="vertical-align: inherit;">符的</font><font style="vertical-align: inherit;">不同之处</font><font style="vertical-align: inherit;">在于它可以使用Null值。</font><font style="vertical-align: inherit;">这意味着</font><font style="vertical-align: inherit;">在过滤器中</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不为True</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将保留False和Null，而</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！= True</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将仅保留False。</font><font style="vertical-align: inherit;">因此，当替换</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is not</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符时，应使用OR运算符将两个条件传递给过滤器，例如</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WHERE（col！= True）OR（col为null）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
布尔值整理出来后，继续前进。</font><font style="vertical-align: inherit;">同时，将布尔值过滤器返回其原始形式，以独立考虑其他更改的影响。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间戳？</font><font style="vertical-align: inherit;">赫兹</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，通常必须尝试如何编写涉及远程服务器的查询，然后才寻找导致这种情况发生的原因的解释。关于此的很少信息可以在Internet上找到。因此，在实验中，我们发现带有固定日期的过滤器会突然跳到远程服务器，但是当我们想动态设置日期时，例如now（）或CURRENT_DATE，则不会发生这种情况。在我们的示例中，我们添加了一个过滤器，以便created_at列包含过去1个月内的确切数据（BETWEEN CURRENT_DATE-INTERVAL'7 month'AND CURRENT_DATE-INTERVAL'6 month'）。在这种情况下我们做了什么？</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta-&gt;&gt;<span class="hljs-string">'source'</span> = <span class="hljs-string">'test'</span>;<font></font>
<font></font>
Aggregate  (cost=306875.17..306875.18 rows=1 width=8) (actual time=4789.114..4789.115 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.007..0.008 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.002</span>.<span class="hljs-number">.0</span><span class="hljs-number">.002</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.306874</span><span class="hljs-number">.86</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">105</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">23.475</span>.<span class="hljs-number">.4681</span><span class="hljs-number">.419</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Filter: ((<span class="hljs-string">"table"</span>.is_active <span class="hljs-keyword">IS</span> <span class="hljs-literal">TRUE</span>) <span class="hljs-keyword">AND</span> ((<span class="hljs-string">"table"</span>.meta -&gt;&gt; <span class="hljs-string">'source'</span>::<span class="hljs-built_in">text</span>) = <span class="hljs-string">'test'</span>::<span class="hljs-built_in">text</span>))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">76934</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> is_active, meta <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.703</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">4789.379</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们提示调度程序提前在子查询中计算日期，然后将现成的变量传递给过滤器。</font><font style="vertical-align: inherit;">这个提示给我们带来了出色的结果，查询速度几乎快了6倍！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同样，在这里要小心一点很重要：子查询中的数据类型必须与我们要过滤的字段相同，否则调度程序将决定由于类型不同而必须首先获取所有数据并在本地对其进行过滤。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
按日期将过滤器恢复为其原始值。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">弗雷迪与 </font><font style="vertical-align: inherit;">杰森</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，布尔字段和日期已经加快了我们的查询速度，但是还有另外一种数据类型。</font><font style="vertical-align: inherit;">坦白说，尽管取得了成功，但对其进行过滤的斗争仍未结束。</font><font style="vertical-align: inherit;">因此，这就是我们设法通过</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段</font><font style="vertical-align: inherit;">将过滤器传递</font><font style="vertical-align: inherit;">给远程服务器的方法。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt <span class="hljs-keyword">BETWEEN</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span> 
<span class="hljs-keyword">AND</span> <span class="hljs-keyword">CURRENT_DATE</span> - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=245463.60..245463.61 rows=1 width=8) (actual time=6727.589..6727.590 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  -&gt;  Foreign Scan on fdw_schema."table"  (cost=1100.00..245459.90 rows=1478 width=0) (actual time=16.213..6634.794 rows=1360025 loops=1)<font></font>
        Output: "table".id, "table".is_active, "table".meta, "table".created_dt<font></font>
        Filter: (("table".is_active IS TRUE) AND ("table".created_dt &gt;= (('now'::cstring)::date - '7 mons'::interval)) AND ("table".created_dt &lt;= ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)))
        <span class="hljs-keyword">Rows</span> Removed <span class="hljs-keyword">by</span> Filter: <span class="hljs-number">619961</span>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> created_dt, is_active <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.747</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">6727.815</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
代替筛选运算符，必​​须使用</font><font style="vertical-align: inherit;">在另一个</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中</font><font style="vertical-align: inherit;">包含一个</font><b><font style="vertical-align: inherit;">jsonb</font></b><font style="vertical-align: inherit;">的运算符</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">7秒，而不是最初的29秒。到目前为止，这是将过滤器通过</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传输</font><font style="vertical-align: inherit;">到远程服务器</font><font style="vertical-align: inherit;">的唯一成功选择</font><font style="vertical-align: inherit;">，但是重要的是要考虑到一个限制：我们使用数据库版本9.6，但是我们计划在4月底完成最新的测试并移至版本12。</font><font style="vertical-align: inherit;">随着我们的更新，我们将写出它的影响方式，因为有许多希望带来的变化：json_path，新的CTE行为，下推（版本10中已有）。</font><font style="vertical-align: inherit;">我想尽快尝试。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决他</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们检查了每个更改如何分别影响请求的速度。</font><font style="vertical-align: inherit;">现在，让我们看看正确编写所有三个过滤器时会发生什么。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">explain</span> <span class="hljs-keyword">analyze</span> verbose
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">count</span>(<span class="hljs-number">1</span>)
<span class="hljs-keyword">FROM</span> fdw_schema.table 
<span class="hljs-keyword">WHERE</span> is_active = <span class="hljs-literal">True</span>
<span class="hljs-keyword">AND</span> created_dt &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'7 month'</span>) 
<span class="hljs-keyword">AND</span> created_dt &lt;(<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">CURRENT_DATE</span>::timestamptz - <span class="hljs-built_in">INTERVAL</span> <span class="hljs-string">'6 month'</span>)
<span class="hljs-keyword">AND</span> meta @&gt; <span class="hljs-string">'{"source":"test"}'</span>::jsonb;<font></font>
<font></font>
Aggregate  (cost=322041.51..322041.52 rows=1 width=8) (actual time=2278.867..2278.867 rows=1 loops=1)<font></font>
  Output: count(1)<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Result  (cost=0.00..0.02 rows=1 width=8) (actual time=0.010..0.010 rows=1 loops=1)<font></font>
          Output: ((('now'::cstring)::date)::timestamp <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'7 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  InitPlan <span class="hljs-number">2</span> (<span class="hljs-keyword">returns</span> $<span class="hljs-number">1</span>)<font></font>
    -&gt;  <span class="hljs-keyword">Result</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">0.00</span>.<span class="hljs-number">.0</span><span class="hljs-number">.02</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> width=<span class="hljs-number">8</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">0.003</span>.<span class="hljs-number">.0</span><span class="hljs-number">.003</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1</span> loops=<span class="hljs-number">1</span>)
          <span class="hljs-keyword">Output</span>: (((<span class="hljs-string">'now'</span>::cstring)::<span class="hljs-built_in">date</span>)::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone - <span class="hljs-string">'6 mons'</span>::<span class="hljs-built_in">interval</span>)<font></font>
  -&gt;  <span class="hljs-keyword">Foreign</span> <span class="hljs-keyword">Scan</span> <span class="hljs-keyword">on</span> fdw_schema.<span class="hljs-string">"table"</span>  (<span class="hljs-keyword">cost</span>=<span class="hljs-number">100.02</span>.<span class="hljs-number">.322041</span><span class="hljs-number">.41</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">25</span> width=<span class="hljs-number">0</span>) (actual <span class="hljs-built_in">time</span>=<span class="hljs-number">8.597</span>.<span class="hljs-number">.2153</span><span class="hljs-number">.809</span> <span class="hljs-keyword">rows</span>=<span class="hljs-number">1360025</span> loops=<span class="hljs-number">1</span>)
        <span class="hljs-keyword">Output</span>: <span class="hljs-string">"table"</span>.id, <span class="hljs-string">"table"</span>.is_active, <span class="hljs-string">"table"</span>.meta, <span class="hljs-string">"table"</span>.created_dt<font></font>
        Remote <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">FROM</span> fdw_schema.table <span class="hljs-keyword">WHERE</span> (is_active) <span class="hljs-keyword">AND</span> ((created_dt &gt;= $<span class="hljs-number">1</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((created_dt &lt; $<span class="hljs-number">2</span>::<span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">with</span> <span class="hljs-built_in">time</span> zone)) <span class="hljs-keyword">AND</span> ((meta @&gt; <span class="hljs-string">'{"source": "test"}'</span>::jsonb))<font></font>
Planning <span class="hljs-built_in">time</span>: <span class="hljs-number">0.820</span> ms<font></font>
Execution <span class="hljs-built_in">time</span>: <span class="hljs-number">2279.087</span> ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
是的，请求看起来更复杂，是强制执行的，但是执行速度为2秒，快10倍以上！</font><font style="vertical-align: inherit;">我们正在谈论一个相对较小的数据集的简单查询。</font><font style="vertical-align: inherit;">根据实际要求，我们获得了多达数百倍的增长。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总结一下：如果将PostgreSQL与FDW一起使用，请始终检查所有过滤器是否都已发送到远程服务器，您会很高兴的……至少直到从不同服务器进入表之间的联接为止。</font><font style="vertical-align: inherit;">但这是另一篇文章的故事。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
感谢您的关注！</font><font style="vertical-align: inherit;">我很高兴听到问题，评论以及关于您在评论中的经历的故事。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN498002/index.html">Z3袖珍指南</a></li>
<li><a href="../zh-CN498004/index.html">Docker容器中的工作站</a></li>
<li><a href="../zh-CN498006/index.html">选择专利律师</a></li>
<li><a href="../zh-CN498012/index.html">带有Qemu的Docker中的Mikrotik RouterOS</a></li>
<li><a href="../zh-CN498014/index.html">PyDERASN：随着我添加了大数据支持</a></li>
<li><a href="../zh-CN498020/index.html">关于适用于快速评估功能的视觉评估的一项指标</a></li>
<li><a href="../zh-CN498022/index.html">＃341移动开发人员的有趣材料摘要（4月13日至19日）</a></li>
<li><a href="../zh-CN498024/index.html">使用Houdini和Python单击鼠标即可构建城市</a></li>
<li><a href="../zh-CN498026/index.html">FOSS新闻第12号-2020年4月13日至19日免费和开源新闻的回顾</a></li>
<li><a href="../zh-CN498028/index.html">Python COVID-19大流行模拟</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>