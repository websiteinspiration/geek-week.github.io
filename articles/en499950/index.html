<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ£Ô∏è üë®‚Äçüé® üôÖ A lot of free RAM, NVMe Intel P4500 and everything slows down - the story of the unsuccessful addition of the swap partition üöç üè∏ üë®üèæ‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will talk about the situation that recently occurred with one of the servers in our VPS cloud, confusing me for several hours. I‚Äôve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>A lot of free RAM, NVMe Intel P4500 and everything slows down - the story of the unsuccessful addition of the swap partition</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499950/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article, I will talk about the situation that recently occurred with one of the servers in our VPS cloud, confusing me for several hours. </font><font style="vertical-align: inherit;">I‚Äôve been configuring and troubleshooting Linux servers for about 15 years, but this case does not fit into my practice at all - I made some false assumptions and slightly despaired before I could correctly determine the cause of the problem and solve it.</font></font></p><br>
<h2 id="preambula"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preamble</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We operate a medium-sized cloud, which we build on typical servers of the following config - 32 cores, 256 GB RAM and NVMe PCI-E Intel P4500 4TB. We really like this configuration, because it allows us not to think about the lack of IO, providing the correct restriction at the level of types of instances (instances) of the VM. Because the NVMe Intel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P4500</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> has impressive performance, we can simultaneously provide both full IOPS provision to machines and backup storage to a backup server with zero IOWAIT.</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We belong to the same old believers who do not use hyper-convergent SDNs and other stylish, fashionable, youth pieces for storing VM volumes, believing that the simpler the system, the easier it is to joke under the conditions of ‚Äúthe main guru went to the mountains‚Äù. </font><font style="vertical-align: inherit;">As a result, we store the VM volumes in QCOW2 format in XFS or EXT4, which is deployed on top of LVM2.</font></font></p><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are also forced to use QCOW2 by the product we use for orchestration - Apache CloudStack.</font></font></blockquote><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To perform a backup, we take a full volume image like an LVM2 snapshot (yes, we know that LVM2 snapshots are slow, but the Intel P4500 helps us out here too). We do </font></font><code>lvmcreate -s ..</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and use it to </font></font><code>dd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">send a backup to a remote server with ZFS storage. Here we are still slightly progressive - still ZFS can store data in a compressed form, and we can quickly restore it using </font></font><code>DD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or get individual VM volumes using </font></font><code>mount -o loop ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></p><br>
<blockquote>, ,       LVM2,       <code>RO</code>     QCOW2, ,    ,  XFS    ,   ,  .    ,  - ""   ,    - ,    .   XFS        <code>RO</code>   ,      LVM2.</blockquote><p>             ,    600-800 MB/s   ,   ‚Äî  10Gbit/s,       . </p><br>
<p>           8  .  ,       ,   ,      -,      , , 8 GB/,     -.</p><br>
<p>       ,    ‚Äî    Intel P4500,  NFS , ,  ZFS.</p><br>
<h2 id="istoriya-o-rezervnom-kopirovanii">   </h2><br>
<p>  -      SWAP  8 GB,   -  ""   <code>DD</code>   .        2xSATA SSD RAID1  2xSAS HDD RAID1    LSI  HP.  ,    ,   ,         " readonly",  SWAP-.       RAM      30-40% ,    SWAP  .</p><br>
<p><strong>   </strong>.     :</p><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
mkdir -p /mnt/backups/volumes<font></font>
<font></font>
DIR=/mnt/images-snap<font></font>
VOL=images/volume<font></font>
DATE=$(date <span class="hljs-string">"+%d"</span>)<font></font>
HOSTNAME=$(hostname)<font></font>
<font></font>
lvcreate -s -n <span class="hljs-variable">$VOL</span>-snap -l100%FREE <span class="hljs-variable">$VOL</span>
ionice -c3 dd iflag=direct <span class="hljs-keyword">if</span>=/dev/<span class="hljs-variable">$VOL</span>-snap bs=1M of=/mnt/backups/volumes/<span class="hljs-variable">$HOSTNAME</span>-<span class="hljs-variable">$DATE</span>.raw<font></font>
lvremove -f <span class="hljs-variable">$VOL</span>-snap</code></pre><br>
<p>   <code>ionice -c3</code>,      NVMe   ,   IO    :</p><br>
<pre><code class="bash hljs">cat /sys/block/nvme0n1/queue/scheduler<font></font>
[none] </code></pre><br>
<p>,     legacy-   SSD RAID-,    ,    <em>AS IS</em>.  ,     ,    <code>ionice</code>    .</p><br>
<p>    <code>iflag=direct</code>  <code>DD</code>.   direct IO   ,       IO  . , <code>oflag=direct</code>   ,       ZFS   .</p><br>
<p>          . </p><br>
<p><strong>  </strong>‚Ä¶  ,         ,      IOWAIT  50%.           :</p><br>
<pre><code class="plaintext hljs">Volume group "images" not found</code></pre><br>
<p>   "  Intel P4500", ,        ,       .  LVM2       LVM2:</p><br>
<pre><code class="bash hljs">vgcfgrestore images</code></pre><br>
<p>        :<br>
<img src="https://habrastorage.org/webt/e9/cx/jc/e9cxjcnwemlh8ffzylxr5-gmn0c.png"></p><br>
<p>    ‚Äî  ,    ,   VPS-  ,      .  ,   ‚Äî <code>iostat</code>   IOPS-   IOWAIT. ,   "  NVMe"  ,    . </p><br>
<h2 id="razbor-situacii-po-shagam">   </h2><br>
<p><strong> </strong>.          VPS-  128 GB RAM.    ,      32 GB   . VPS  ,       ,  SWAP- .</p><br>
<p><strong> </strong>.      <code>vm.swappiness</code>     - <code>60</code>.  SWAP    SAS HDD RAID1.</p><br>
<p><strong>  (  )</strong>.    <code>DD</code>     ,     RAM    NFS.  ,   <code>swappiness</code>,     VPS   ,      HDD RAID1.    ,  IOWAIT   ,     IO NVMe,    IO HDD RAID1.</p><br>
<p><strong>   </strong>.     32GB.   16 ,  ,       SWAP   .    <code>swappiness</code>    <code>5</code>   .</p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How could this not happen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Firstly, if SWAP were on an SSD RAID or NVMe device, and secondly, if there weren‚Äôt an NVMe device, but there would be a slower device that wouldn‚Äôt produce such a volume of data - ironically, the problem happened that NVMe is too fast.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, everything began to work as before - with zero IOWAIT.</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499928/index.html">Udalenka: what changed with COVID-19 and who is now even better than before</a></li>
<li><a href="../en499930/index.html">How I designed blocks and transactions on my Go blockchain</a></li>
<li><a href="../en499934/index.html">Whip effect and beer game: modeling and supply chain management</a></li>
<li><a href="../en499936/index.html">The main reason why Linux</a></li>
<li><a href="../en499944/index.html">Google Style Guide in C ++. Part 10</a></li>
<li><a href="../en499954/index.html">Storacle - decentralized file storage</a></li>
<li><a href="../en499960/index.html">JanusGraph graph DBMS experiment to solve the problem of finding suitable paths</a></li>
<li><a href="../en499962/index.html">Some facts about cascading classifiers, which are rarely seriously considered in scientific articles.</a></li>
<li><a href="../en499964/index.html">NASA has selected three firms that will participate in the program to create a ship for landing on the moon</a></li>
<li><a href="../en499966/index.html">Measuring the UVA UVB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>