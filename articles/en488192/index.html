<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¥üèΩ üßúüèº üïß Helm device and its pitfalls üìõ üôã üò™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Typhon freight hauler concept, Anton Swanepoel
 
 My name is Dmitry Sugrobov, I‚Äôm a developer at Leroy Merlin. In the article I‚Äôll tell you why Helm i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Helm device and its pitfalls</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/488192/"><img src="https://habrastorage.org/webt/vn/ta/1i/vnta1ig3umh8lzaeaemhnn4zvuw.jpeg"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typhon freight hauler concept, Anton Swanepoel</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
My name is Dmitry Sugrobov, I‚Äôm a developer at Leroy Merlin. </font><font style="vertical-align: inherit;">In the article I‚Äôll tell you why Helm is needed, how it simplifies working with Kubernetes, what has changed in the third version and how to use it to update applications in production without downtime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a compendium based on a speech at the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@Kubernetes Conference</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conference </font><font style="vertical-align: inherit;">- if you do not want to read, watch the video.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/w1PhTe9gnOI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why we use Kubernetes in production</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leroy Merlin is a leader in the DIY retail market in Russia and Europe. Our company has more than one hundred developers, 33,000 internal employees and a huge number of people visiting hypermarkets and the site. In order to make all of them happy, we decided to adhere to standard approaches in the industry. Develop new applications using microservice architecture; use containers for isolation of environments and proper delivery; and for orchestration use Kubernetes. The price of using orchestrators is rapidly getting cheaper: the number of engineers with technology is growing in the market, and providers are appearing to offer Kubernetes as a service.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything that Kubernetes does, of course, can be done in other ways, for example, by coating scripts with some Jenkins and docker-compose, but why complicate life if there is a ready-made and reliable solution? </font><font style="vertical-align: inherit;">Therefore, we came to Kubernetes and have been using it in production for a year now. </font><font style="vertical-align: inherit;">We now have twenty-four Kubernetes clusters, the oldest of which is over a year old, with about two hundred pods in it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curse a lot of YAML files in Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To run the microservice in Kubernetes, create at least five YAML files: for Deployment, Service, Ingress, ConfigMap, Secrets - and send it to the cluster. </font><font style="vertical-align: inherit;">For the next application, we will write the same package of jamliks, with the third - one more and so on. </font><font style="vertical-align: inherit;">We multiply the number of documents by the number of environments, we already get hundreds of files, and this is not taking into account dynamic environments.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ba9/848/18b/ba984818be4ba31829a8ca17367f4015.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adam Reese, a core maintainer Helm, introduced the concept of ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">development cycle at Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù, which looks like this:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy YAML - copy the YAML file.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paste YAML - paste it.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fix Indents - fix indents.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repeat - repeat again.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The option is working, but you have to copy YAML files many times. </font><font style="vertical-align: inherit;">To change this cycle, and came up with Helm.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is Helm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firstly, Helm is a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">package manager</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that helps you find and install the programs you need. To install, for example, MongoDB, you do not need to go to the official site and download binaries, just run the command </font></font><code>helm install stable/mongodb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secondly, Helm is a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">template engine</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that helps to parameterize files. Let's get back to the situation with YAML files in Kubernetes. It‚Äôs easier to write the same YAML file, add some placeholders into it, into which Helm will substitute the values. That is, instead of a large set of small boxes, there will be a set of templates (templates) into which the necessary values ‚Äã‚Äãwill be substituted at the right time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Third, Helm is a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deployment wizard</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . With it, you can install, roll back and update applications. Let's figure out how to do it.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9be/c3f/c96/9bec3fc96cd5cdc5586c3c4d58169f48.jpg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to use Helm to deploy native applications</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install Helm client on the computer, following the official </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instructions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Then create a set of YAML files. </font><font style="vertical-align: inherit;">Instead of specifying specific values, we will leave placeholders, which Helm will fill with information in the future. </font><font style="vertical-align: inherit;">A set of such files is called the Helm Chart. </font><font style="vertical-align: inherit;">It can be sent to the Helm console client in three ways:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">specify daddy with templates;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pack the archive in .tar and point to it;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">put the template in a remote repository and add a link to the repository in the Helm client.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Still need a file with values ‚Äã‚Äã- values.yaml. </font><font style="vertical-align: inherit;">Data from there will be substituted into the template. </font><font style="vertical-align: inherit;">Let's create it too.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c5e/7a2/5f9/c5e7a25f9b100fe55a67474c36433555.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second version of Helm has an additional server application - Tiller. </font><font style="vertical-align: inherit;">It hangs outside Kubernetes and waits for requests from the Helm client, and when called, substitutes the necessary values ‚Äã‚Äãin the template and sends it to Kubernetes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/593/7cc/6d2/5937cc6d2d2439593ff2b4d0b7b3f3e1.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Helm 3 is simpler: instead of processing templates on the server, information is now processed entirely on the side of the Helm client and sent directly to the Kubernetes API. </font><font style="vertical-align: inherit;">This simplification improves cluster security and facilitates a rollout scheme. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it all works.</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We start the team </font></font><code>helm install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Specify the name of the application release, give the path to values.yaml. </font><font style="vertical-align: inherit;">At the end, we indicate the repository in which the chart lies and the name of the chart. </font><font style="vertical-align: inherit;">In the example, these are ‚Äúlmru‚Äù and ‚Äúbestchart‚Äù, respectively.</font></font><br>
<br>
<pre><code class="plaintext hljs">helm install --name bestapp --values values.yaml lmru/bestchart
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The execution of the command is possible only once, when re-executing </font></font><code>install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it must be used </font><font style="vertical-align: inherit;">instead </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For simplicity, instead of two commands, you can execute a command </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with an additional key </font></font><code>--install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">At the first execution, Helm will send a command to install the release, and in the future will update it.</font></font><br>
<br>
<pre><code class="plaintext hljs">helm upgrade --install bestapp --values values.yaml lmru/bestchart
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pitfalls of deployment of new versions of the application with Helm</font></font></h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this point in the story, I play with the audience in ‚ÄúWho Wants to Be a Millionaire,‚Äù and we figure out how to get Helm to update the application version. </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Watch the video</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When I studied the work of Helm, I was surprised by the strange behavior when trying to update versions of running applications. I updated the application code, uploaded a new image to the docker-registers, sent a command to deploy, and nothing happened. Below are some not entirely successful ways to update applications. Studying each of them in more detail, you begin to understand the internal structure of the instrument and the reasons for this not obvious behavior. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method 1. Do not change the information since the last launch</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">official website</font></a><font style="vertical-align: inherit;"> says</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helm, ‚ÄúKubernetes charts are large and complex, so Helm is trying once again not to touch anything.‚Äù </font><font style="vertical-align: inherit;">Therefore, if you update the latest version of the application image in the docker registry and run the command </font></font><code>helm upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then nothing will happen. </font><font style="vertical-align: inherit;">Helm will think that nothing has changed and there is no need to send a command to update the application to Kubernetes.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hereafter, the latest tag is shown solely as an example. </font><font style="vertical-align: inherit;">When this tag is specified, Kubernetes will download the image from the docker registry each time, regardless of the imagePullPolicy parameter. </font><font style="vertical-align: inherit;">Using latest in production is undesirable and causes side effects.</font></font></blockquote><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method 2. Update LABEL in image</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As it is written in the same </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , "Helm will update the application only if it has changed since the last release." A logical option for this seems to be updating the LABEL label in the docker image itself. However, Helm does not look into the application images and has no idea about any changes in them. Accordingly, when updating labels in the Helm image, it does not recognize them, and the application update command in Kubernetes will not be received. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method 3. Use the key</font></font><code>--force</code></strong><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/639/0ec/d80/6390ecd8043360f6d66cc22f53e8623f.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We turn to the manuals and look for the desired key. The key is most appropriate in meaning </font></font><code>--force</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Despite the talking name, the behavior is different than expected. Instead of a forced application update, its real purpose is to restore a FAILED release. If you do not use this key, then you need to execute commands sequentially </font></font><code>helm delete &amp;&amp; helm install --replace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Instead, it is suggested that you use a key </font></font><code>--force</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that automates the sequential execution of these commands. More information in this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pull request</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In order to tell Helm to update the application version, unfortunately, this key will not work. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method 4. Change labels directly in Kubernetes</font></font></strong><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/106/4c9/47d/1064c947d8cb0b6bfe32b9b2e9632fb0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Updating a label directly in a cluster using a command </font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a bad idea. </font><font style="vertical-align: inherit;">This action will lead to inconsistency of information between the running application and what was initially sent to the deployment. </font><font style="vertical-align: inherit;">The behavior of Helm during the deployment in this case is different from its version: Helm 2 will not do anything, and Helm 3 will deploy a new version of the application. </font><font style="vertical-align: inherit;">To understand the reason, you need to understand how Helm works.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How is Helm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To determine if an application has changed since the last release, Helm can use:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">running application in Kubernetes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new values.yaml and current chart;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helm internal release information.</font></font></li>
</ul><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the most curious: where does Helm store internal release information?</font></font></b><div class="spoiler_text">  <code>helm history</code>,      ,    Helm.<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cfd/ca8/e1d/cfdca8e1d69f39039f37e7184268eb84.png"></div><br>
        .    :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/532/817/22f/53281722f6ddf995ba88d7f67723b639.png"></div><br>
   Helm       ,   Tiller (  ‚Äî kube-system),  ConfigMap,   ¬´OWNER=TILLER¬ª:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b91/5fe/9c4/b915fe9c416f1e6f388454a576e09cda.png"></div><br>
     Helm    ,     ,   .               .        ,   ,      .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/17c/674/aba/17c674aba6235391cf609ec1c4861839.png"></div><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second Helm, when it tries to understand whether an update is needed, uses only two sources of information: what it has been provided with now, and the internal release information that lies in ConfigMap.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/21d/af0/9b6/21daf09b6e0c94e80735fa57b40e1fba.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The third Helm uses the three-way merge strategy: in addition to that information, it also takes into account the application that is working right now in Kubernetes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/47c/870/fd2/47c870fd2c99e2d4effafeb38210d69e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this reason, the old version of Helm will not do anything, since it does not take into account the application information in the cluster, but Helm 3 will receive the changes and send the new application to the deploy. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Method 5. Use the key --recreate-pods</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Using the key, </font></font><code>--recreate-pods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can achieve what was originally planned to be obtained using the key </font></font><code>--force</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The containers will restart and, according to the imagePullPolicy: Always policy for the latest tag (more on that in the footnote above), Kubernetes will download and launch a new version of the image. This will not be done in the best way: not taking into account the StrategyType deployment, it will sharply turn off all old instances of the application and start launching new ones. During the restart, the system will not work, users will suffer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Kubernetes itself, a similar problem also existed for a long time. </font><font style="vertical-align: inherit;">And now, 4 years after the opening of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Issue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the problem was fixed, and starting with the 1.15 version of Kubernetes, the possibility of rolling-restart pods appears. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Helm just turns off all applications and launches new containers nearby. </font><font style="vertical-align: inherit;">In production, this cannot be done so as not to cause a simple application. </font><font style="vertical-align: inherit;">This is only necessary for development needs, it can only be done in stage environments.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to update the version of the application using Helm?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will change the values ‚Äã‚Äãsent to Helm. </font><font style="vertical-align: inherit;">As a rule, these are values ‚Äã‚Äãsubstituted in place of the image tag. </font><font style="vertical-align: inherit;">In the case of latest, often used for unproductive environments, the role of mutable information is the annotation, which is useless for Kubernetes itself, and for Helm will act as a signal for the need to update the application. </font><font style="vertical-align: inherit;">Options for filling in the annotation value:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Random value</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using the standard function - </font></font><code>{{ randAlphaNum 6 }}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a nuance: after each deployment using a chart with such a variable, the annotation value will be unique, and Helm will assume that there are changes. </font><font style="vertical-align: inherit;">It turns out that we will always restart the application, even if we have not changed its version. </font><font style="vertical-align: inherit;">This is not critical, as there will be no downtime, but still unpleasant.</font></font></li>
<li>  <strong>  </strong> ‚Äî <code>{{ .Release.Date }}</code>. <br>
        .</li>
<li>   ‚Äî  <strong> </strong>.  SHA   SHA     ‚Äî <code>{{ .Values.sha }}</code>. <br>
       Helm    ,   .   ,     . , Helm     ,  .</li>
</ol><br>
<h2>  </h2><br>
<ul>
<li>Helm     ,         Docker Registry    :      .</li>
<li> <code>--force</code>           .</li>
<li> <code>--recreate-pods</code>   ,     :    .    ,      .</li>
<li>     Kubernetes    <code>kubectl edit</code>  :  ,         Helm.</li>
<li>    Helm   . Issues   Helm   ,     .</li>
<li>        .     ,  .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thought from the category of "world peace", working in all areas of life: read the instructions before use, and not after. </font><font style="vertical-align: inherit;">Only with complete information will it be possible to build reliable systems and make users happy. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other related links:</font></font></strong><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducing </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helm</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Official site Helm</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helm repository on github</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">25 useful Kubernetes tools: deployment and management</font></font></a></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This talk was first made at the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@Kubernetes Conference</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by Mail.ru Cloud Solutions. </font><font style="vertical-align: inherit;">Watch a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> other performances and sign up for Telegram event announcements </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Around Kubernetes at Mail.ru Group</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488180/index.html">New Silence Bootloader</a></li>
<li><a href="../en488184/index.html">Powered by ZeroTier. A practical guide to building virtual networks. Part 2</a></li>
<li><a href="../en488186/index.html">My QA Engineer Path: Through Burnout to High Testing</a></li>
<li><a href="../en488188/index.html">Reforestation after fires: How nanoparticles protect tree microclones</a></li>
<li><a href="../en488190/index.html">Once again about emotional burnout</a></li>
<li><a href="../en488194/index.html">Why are we writing programs of such poor quality?</a></li>
<li><a href="../en488196/index.html">Android insets: dealing with fears and getting ready for Android Q</a></li>
<li><a href="../en488198/index.html">What are the Timlids afraid of and why should they stop doing this</a></li>
<li><a href="../en488200/index.html">The debate about the first programming language: the final decision</a></li>
<li><a href="../en488202/index.html">PVS-Studio is now in Chocolatey: checking Chocolatey from Azure DevOps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>