<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ––ğŸ¼ ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦ ğŸ¤¾ğŸ¼ K8S Multicluster Reise ğŸ•§ ğŸ™ŒğŸ½ ğŸ‘¨ğŸ¿â€ğŸ¤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! 
 
 Wir vertreten das Exness-Plattformteam. Zuvor haben unsere Kollegen bereits einen Artikel Ã¼ber produktionsbereite Bilder fÃ¼r k8s gesch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>K8S Multicluster Reise</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/exness/blog/501090/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir vertreten das Exness-Plattformteam. </font><font style="vertical-align: inherit;">Zuvor haben unsere Kollegen bereits einen Artikel Ã¼ber </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produktionsbereite Bilder fÃ¼r k8s geschrieben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Heute mÃ¶chten wir die Erfahrungen mit der Service-Migration in Kubernetes teilen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_w/_v/4y/_w_v4y4cimb9xplp-da3e-cnwx4.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZunÃ¤chst bieten wir Ihnen einige Zahlen an, um besser zu verstehen, was besprochen wird:</font></font><br>
<br>
<ul>
<li>    100+ ,    10      QA, DevOps  Scrum.   â€” Python, PHP, C++, Java  Golang.&nbsp;<br>
</li>
<li>    â€”  2000   .     Rancher v1.6      VMware.&nbsp;<br>
</li>
</ul><br>
<h4></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sie sagen, bleibt nichts fÃ¼r immer und Rancher hat lange genug die Beendigung des Supports fÃ¼r Version 1.6 angekÃ¼ndigt. </font><font style="vertical-align: inherit;">Ja, seit mehr als drei Jahren haben wir gelernt, wie man es kocht und auftretende Probleme lÃ¶st, aber immer hÃ¤ufiger sind wir mit Problemen konfrontiert, die niemals behoben werden kÃ¶nnen. </font><font style="vertical-align: inherit;">Rancher 1.6 verfÃ¼gt auÃŸerdem Ã¼ber ein verknÃ¶chertes System zur Erteilung von Rechten, in dem Sie entweder fast alles oder nichts tun kÃ¶nnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die eigene Virtualisierung bot zwar eine bessere Kontrolle Ã¼ber Datenspeicherung und -sicherheit, verursachte jedoch Betriebskosten, die mit dem stetigen Wachstum des Unternehmens, der Anzahl der Projekte und den Anforderungen fÃ¼r sie nur schwer zu ertragen waren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir wollten die IaC-Standards befolgen und bei Bedarf schnell, an jedem geografischen Ort und ohne Anbietersperre Strom beziehen und diese auch schnell aufgeben kÃ¶nnen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erste Schritte</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZunÃ¤chst wollten wir uns auf moderne Technologien und LÃ¶sungen verlassen, die es Teams ermÃ¶glichen, einen schnelleren Entwicklungszyklus zu erreichen und die Betriebskosten fÃ¼r die Interaktion mit einer Plattform zu minimieren, die Strom liefert.&nbsp; </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das erste, was uns in den Sinn kam, war natÃ¼rlich Kubernetes, aber wir waren nicht aufgeregt und haben ein wenig Ã¼ber das Thema der richtigen Wahl recherchiert. Wir haben nur OpenSource-LÃ¶sungen evaluiert und Kubernetes in einem unfairen Kampf bedingungslos besiegt.&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als nÃ¤chstes kam die Frage nach der Auswahl eines Tools zum Erstellen von Clustern. Wir haben die beliebtesten LÃ¶sungen verglichen: Kops, Kubespray, Kubeadm. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu Beginn schien uns Kubeadm zu kompliziert, eher eine Art Erfinder des "Fahrrads", und Kops mangelte es an FlexibilitÃ¤t. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und der Gewinner kam heraus:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/35e/1e6/e85/35e1e6e85e12e982649fd020862463cd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben begonnen, mit unserer eigenen Virtualisierung und AWS zu experimentieren, und versucht, eine ungefÃ¤hre Ã„hnlichkeit mit unserem vorherigen Ressourcenverwaltungsmuster herzustellen, bei dem jeder denselben â€Clusterâ€œ verwendet. </font><font style="vertical-align: inherit;">Und jetzt haben wir den ersten Cluster von 10 kleinen virtuellen Maschinen, von denen sich einige in AWS befinden. </font><font style="vertical-align: inherit;">Wir haben versucht, Teams dorthin zu migrieren, alles schien â€gutâ€œ zu sein und die Geschichte konnte beendet werden, aber ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erste Probleme</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansible ist das, worauf Kubespray basiert. Es ist nicht das Tool, mit dem IaC befolgt werden kann: Bei der Eingabe / Ausgabe der Knoten ist ein Fehler aufgetreten, und es waren einige Eingriffe erforderlich, und bei Verwendung verschiedener Betriebssysteme hat sich das Playbook verhalten auf veschiedenen Wegen. Mit der wachsenden Anzahl von Befehlen und Knoten im Cluster stellten wir fest, dass das Playbook immer lÃ¤nger dauerte. Am Ende lag unser Rekord bei 3,5 Stunden, und bei Ihnen? :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und es scheint, als wÃ¤re Kubespray nur Ansible, und auf den ersten Blick ist alles klar, aber: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/11e/593/7d7/11e5937d7576851ad38e8469502e6d7f.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Anfang des Weges gab es eine Aufgabe, KapazitÃ¤ten nur in AWS und Virtualisierung auszufÃ¼hren, aber dann, wie so oft, Ã¤nderten sich die Anforderungen.</font></font><br>
&nbsp;<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e4f/b1b/f10/e4fb1bf10754dc4ea192c0a05d2e524c.png"><img src="https://habrastorage.org/getpro/habr/post_images/e1d/eeb/7d5/e1deeb7d5c4b2392962fbe5b6a528388.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor diesem Hintergrund wurde deutlich, dass unser altes Muster, Ressourcen in einem Orchestrierungssystem zu kombinieren, nicht geeignet war - fÃ¼r den Fall, dass die Cluster weit entfernt sind und von verschiedenen Anbietern verwaltet werden.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AuÃŸerdem. Wenn alle Teams innerhalb desselben Clusters arbeiten, kÃ¶nnen verschiedene Dienste, bei denen NodeSelector falsch installiert ist, zum â€fremdenâ€œ Host eines anderen Teams fliegen und dort Ressourcen nutzen. Im Fall von Taint gab es stÃ¤ndige Aufrufe, dass dieser oder jener Dienst nicht funktioniert, nicht aufgrund des menschlichen Faktors korrekt verteilt. Ein weiteres Problem war die Berechnung der Kosten, insbesondere angesichts der Probleme bei der Verteilung der Dienste nach Knoten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine andere Geschichte betraf die Frage der Rechte der Mitarbeiter: Jedes Team wollte â€an der Spitzeâ€œ des Clusters stehen und es vollstÃ¤ndig verwalten, was zu einem vollstÃ¤ndigen Zusammenbruch fÃ¼hren kÃ¶nnte, da die Teams grÃ¶ÃŸtenteils unabhÃ¤ngig voneinander sind.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man ist</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angesichts des oben Gesagten und des Wunsches der Teams, unabhÃ¤ngiger zu sein, haben wir eine einfache Schlussfolgerung gezogen: ein Team - ein Cluster.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also haben wir einen zweiten: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/5ca/125/895/5ca125895d8571f18c41034f226c65d5.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dann einen dritten Cluster:&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/81b/7a9/f75/81b7a9f755d7be0798ec641ef8d444ae.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dann haben wir angefangen zu Ã¼berlegen: Nehmen wir an, in einem Jahr werden unsere Teams mehr als einen Cluster haben? Zum Beispiel in verschiedenen geografischen Gebieten oder unter der Kontrolle verschiedener Anbieter? Einige von ihnen mÃ¶chten in der Lage sein, schnell einen temporÃ¤ren Cluster fÃ¼r alle Tests bereitzustellen.&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/265/52e/0a5/26552e0a5bb71a6f82b3dd4f3226b768.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WÃ¼rde voll Kubernetes kommen! Es stellt sich heraus, dass dies eine Art MultiKubernetes ist.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig mÃ¼ssen wir alle diese Cluster irgendwie unterstÃ¼tzen, den Zugriff auf sie einfach steuern sowie neue erstellen und alte auÃŸer Betrieb nehmen kÃ¶nnen, ohne manuell eingreifen zu mÃ¼ssen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seit Beginn unserer Reise in die Welt von Kubernetes ist einige Zeit vergangen, und wir haben beschlossen, die verfÃ¼gbaren LÃ¶sungen erneut zu prÃ¼fen. Es stellte sich heraus, dass es bereits auf dem Markt ist - Rancher 2.2. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9a2/c00/e81/9a2c00e81c4d2a0daf2b6f0a7afe8c0a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der ersten Phase unserer Forschung haben Rancher Labs bereits die erste Version von Version 2 verÃ¶ffentlicht. Obwohl sie sehr schnell durch AusfÃ¼hren des Containers ohne externe AbhÃ¤ngigkeiten mit einigen Parametern oder mithilfe des offiziellen HELM-Diagramms ausgelÃ¶st werden konnte, schien sie uns grob, und wir wussten nicht, ob Verlassen Sie sich auf diese Entscheidung, ob sie entwickelt oder schnell aufgegeben wird. Das Cluster = Clicks-Paradigma selbst in der BenutzeroberflÃ¤che passte ebenfalls nicht zu uns, und wir wollten uns nicht an RKE binden, da dies ein ziemlich engstirniges Tool ist.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Rancher 2.2-Version hatte bereits ein effizienteres Erscheinungsbild und neben den vorherigen eine Reihe interessanter Funktionen, wie die Integration mit vielen externen Anbietern, einen zentralen Verteilungspunkt fÃ¼r Rechte und kubeconfig-Dateien, das Starten eines kubectl-Images mit Ihren Rechten in der BenutzeroberflÃ¤che sowie verschachtelte Namespaces, auch bekannt als Projekte.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Rancher 2 hat sich bereits eine Community gebildet, und der HashiCorp Terraform-Anbieter wurde gegrÃ¼ndet, um diese zu verwalten. Dies hat uns geholfen, alles zusammenzustellen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist passiert</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis haben wir einen kleinen Cluster, in dem Rancher gestartet wird, auf den alle anderen Cluster sowie viele damit verbundene Cluster zugreifen kÃ¶nnen. Der Zugriff auf jeden dieser Cluster kann so einfach erfolgen, dass ein Benutzer zum ldap-Verzeichnis hinzugefÃ¼gt wird, unabhÃ¤ngig davon, wo er sich befindet befindet und die Ressourcen, die der Anbieter verwendet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit gitlab-ci und Terraform wurde ein System erstellt, mit dem Sie einen Cluster einer beliebigen Konfiguration in Cloud-Anbietern oder unserer eigenen Infrastruktur erstellen und mit Rancher verbinden kÃ¶nnen. All dies erfolgt im IaC-Stil, wobei jeder Cluster von einem Repository beschrieben und sein Status versioniert wird. In diesem Fall sind die meisten Module Ã¼ber externe Repositorys verbunden, sodass nur Variablen Ã¼bertragen oder ihre benutzerdefinierte Konfiguration fÃ¼r Instanzen beschrieben werden mÃ¼ssen, wodurch der Prozentsatz der Code-Wiederholbarkeit verringert wird. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/eae/814/877/eae814877be3c3a957b6f75a2c657f58.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NatÃ¼rlich ist unsere Reise noch lange nicht zu Ende und es liegen noch viele interessante Aufgaben vor uns, z. B. ein einziger Arbeitspunkt mit den Protokollen und Metriken von Clustern, Service-Mesh, Gitops fÃ¼r die Verwaltung von Lasten in einem Multicluster und vieles mehr. Wir hoffen, dass Sie an unserer Erfahrung interessiert sind!&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Artikel wurde von A. Antipov, A. Ganush, Platform Engineers, verfasst.&nbsp;</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de500312/index.html">Schreiben einer JavaScript-Notizanwendung</a></li>
<li><a href="../de500314/index.html">PHP Digest Nr. 179 (21. April - 4. Mai 2020)</a></li>
<li><a href="../de500316/index.html">Neue Version des Apple & Google Contact Tracing Protocol</a></li>
<li><a href="../de500318/index.html">HP Elite Dragonfly - Was fÃ¼r ein Athena-Laptop bist du?</a></li>
<li><a href="../de500320/index.html">Eigene Spiel-Engines: ein wenig Forschung</a></li>
<li><a href="../de501092/index.html">Ãœber die Suche nach vielversprechendem Juni und "udalenka". Erfahrung als Redmadrobot Technical Support Manager</a></li>
<li><a href="../de501098/index.html">SmartLi Smart Battery-LÃ¶sungen fÃ¼r modulare USV</a></li>
<li><a href="../de501106/index.html">Der einfachste englische Wortsimulator mit Python und Balabolka</a></li>
<li><a href="../de501108/index.html">Nvidia Streaming Multiprozessor-Verlauf</a></li>
<li><a href="../de501110/index.html">Mobius und WWDC: mehr SpaÃŸ zusammen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>