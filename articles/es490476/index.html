<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤳 🔝 💇🏻 Sensor inalámbrico para abrir y cerrar con funcionalidad avanzada 📪 👆🏻 🐽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¡Doy la bienvenida a todos los lectores de Habr y especialmente a los lectores de la sección "Bricolaje o hágalo usted mismo"! Y si no se me ocurre al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sensor inalámbrico para abrir y cerrar con funcionalidad avanzada</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490476/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡Doy la bienvenida a todos los lectores de Habr y especialmente a los lectores de la sección "Bricolaje o hágalo usted mismo"! Y si no se me ocurre algo así, soy un arduino, puedo ... No toco el tema principal de la gestión de las cabinas de ascensor :). Después de pensarlo, por alguna razón, quería hacer un sensor de apertura y cierre. Este sensor, como el resto de mis manualidades que hago recientemente, está basado en chips de Nordic Semiconductor. El sensor decidió hacerlo en dos versiones, una en el chip nRF52840 y la segunda en el chip nRF52811.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/zu/u9/48/zuu948wn8duosrmce4hvtao1une.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para las versiones nRF52840 se utilizó el módulo de chip E73_2G4M08S1C empresa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EBYTE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , para el módulo de chip verciya nRF52811 MC50SFA empresa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MiNEW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hablando francamente, la búsqueda de chips nRF52811 asequibles seguía siendo una aventura. </font><font style="vertical-align: inherit;">Pero como resultado de esta aventura en el dispositivo, el módulo en el chip nRF52811 de MINEW y los bollos en forma de varias versiones de los chips soldados a estos módulos son nRF52810 y nRF52832. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cn/yx/4l/cnyx4lcnu6q_isgpvrszxy7c9wy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La funcionalidad principal del dispositivo es la detección de apertura y cierre basada en un interruptor de láminas. </font><font style="vertical-align: inherit;">El circuito del interruptor de láminas se vuelve a poner en fase con anti-rebote. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diagrama de circuito:</font></font><br>
<img src="https://habrastorage.org/webt/o7/io/x-/o7iox-c4oobmvx6zldll_m1vowu.png"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema Arduino :)</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/j4/au/cy/j4aucyctci1fdwtfdkbiz_exsyi.png"><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pensando en lo que sería apropiado diluir la funcionalidad principal de este sensor de apertura y cierre, decidí ver qué hay en el mercado al respecto. Como resultó casi nada, el sensor de apertura y cierre también es en África el sensor de apertura y cierre. La solución más "avanzada" se encontró en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REDMOND</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En su sensor BLE (por cierto, también en un chip de Nordic), además del interruptor de láminas, hay un sensor de temperatura y un botón capacitivo implementado en el chip TTP223. Pero por alguna razón, esto no me pareció una buena solución, qué tan útiles son las lecturas de temperatura cerca de la puerta o ventana (y qué evitó que el chip lo midiera) y en qué situaciones es apropiado usar el botón del sensor que cuelga en la ventana o puerta (bueno, excepto tal vez la entrada :)). Como resultado, decidí ampliar las funciones de seguridad de mi sensor.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fn/7v/y7/fn7vy79b2eivip0yber_90a_zew.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El criterio principal de selección fue el consumo de sensores adicionales, ya que se decidió utilizar una batería CR2032 en este sensor. Los ganadores entre los candidatos fueron dos sensores, el acelerómetro LIS2DW12 y el sensor de campo magnético DRV5032FB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LIS2DW12 es actualmente el acelerómetro más económico. En modo de bajo consumo, este acelerómetro consume 1 μA ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hoja de datos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). El sensor de campo magnético DRV5032FB también mostró excelentes características de consumo. Su consumo es de alrededor de 500nA ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hoja de datos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se decidió utilizar el acelerómetro en modo de sensor de choque y el sensor de campo magnético para su propósito previsto. Si estaba tranquilo acerca de la funcionalidad del sensor de choque, entonces usar un sensor de campo magnético sigue siendo una solución altamente experimental, pero es mejor que un sensor de temperatura.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/ni/64/sini6468k7gc4btzzjjwcaco8y8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La parte del software del proyecto se hizo para operar el sensor en la red Maysensors. Por ahora. Mysensors en la variante de trabajar en chips nórdicos (nRF24 (+ atmega 328, stm32f1), nRF51 y nRF52) en el nivel inferior utiliza el protocolo patentado nórdico - Enhanced ShockBurst (ESB), lo que garantiza la compatibilidad de los dispositivos en nRF24 y nRF51-52. Maysensors es un proyecto abierto de Arduino en torno al cual ya se ha formado una comunidad bastante grande en muchos países del mundo. Pero las buenas soluciones en los chips nRF52 son que no es necesario usar Maysensors (ESB). Es suficiente simplemente reemplazar el software basado en el protocolo Zigbee o BLE, ya que los chips son multiprotocolo ... Con respecto a BLE, me desviaré un poco, mira qué maravilloso Arduino NANO 33 Ble se puede hacer con el módulo E73_2G4M08S1C,El costo de mi NANO 33 es de $ 4.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ot/8f/vh/ot8fvhkkqsnzw_vhcqy7rubbgg0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El boceto para el sensor se realizó en Arduino. IDE de bibliotecas adicionales se utilizó la biblioteca para el acelerómetro LIS2DW12, un poco cambiado por mí en la parte de la configuración predeterminada de los registros, en mi versión funciona inmediatamente con la configuración de la versión más baja de consumo de energía ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disponible en mi git</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Describiré la lógica del programa. En el modo principal de operación, el sensor está en un sueño con interrupciones externas configuradas, solo 4 interrupciones. Hay dos configuraciones de interrupciones; las configuraciones reconfiguran las interrupciones durante la operación del programa, dependiendo del estado del interruptor de láminas. Si la puerta está abierta, las interrupciones para el sensor de choque y el sensor de campo magnético se desactivan. Tan pronto como se cierra la puerta, se activan las interrupciones para dos de estos sensores. También encontré el hecho de que durante la apertura hubo situaciones en las que el sensor de choque se activó antes del interruptor de láminas, provenía de vibraciones durante la apertura de la cerradura. Este problema se registró solo con la alta sensibilidad configurada del acelerómetro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para eliminar este problema, se introdujo una espera de 2 segundos cuando se activó el acelerómetro, durante el cual se monitorea el pin del interruptor de láminas. Si durante la espera se produce un cambio de nivel en el pin del interruptor de láminas, entonces el procesamiento posterior del evento por interrupción desde el acelerómetro se detiene y comienza el procesamiento del evento desde el interruptor de láminas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sensor tiene un modo de configuración. Cuando se presiona el botón de servicio, el sensor se activa tras la interrupción, el módulo de radio entra en modo de audición y espera los comandos entrantes del controlador UD. Si se recibe un comando, el sensor escribe un nuevo valor en la memoria y cambia al modo de funcionamiento inmediatamente para ir a dormir. Para enviar el siguiente comando, la activación del modo de configuración debe repetirse. Si en el modo de configuración el sensor no recibe nada en 30 segundos, también cambia al modo de operación después de este tiempo y se pone en modo de suspensión. Además del modo de configuración, desde el botón de servicio puede comenzar la presentación de los sensores del sensor y el restablecimiento de fábrica (el sensor olvida la red a la que se ha agregado, el registro del sensor después del restablecimiento debe realizarse nuevamente).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jn/1f/j3/jn1fj3ih6xil_iyk_c5abhzmg8q.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/u-/bt/gd/u-btgdierfsy0aqpvt2yhmimjic.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/gk/mr/ml/gkmrmlazpn6iwyxujq_82tk0ipc.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/do/en/m6/doenm6q7xz4ri8cxv57gipihkbq.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/er/x9/wu/erx9wumdn9jpozoie_o20c_kmqe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para programar el sensor en Arduino IDE, debe agregar soporte para las siguientes tarjetas: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sandeepmistry / arduino-nRF5 </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysensors / ArduinoBoards</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Libraries: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mysensor </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LIS2DW12</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Programmer: st-link, j-link.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programa de boceto</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> configMode = <span class="hljs-number">0</span>;
<span class="hljs-keyword">int8_t</span> int_status = <span class="hljs-number">0</span>;
<span class="hljs-keyword">bool</span> door_status = <span class="hljs-number">1</span>;
<span class="hljs-keyword">bool</span> check;
<span class="hljs-keyword">bool</span> magnet_status = <span class="hljs-number">1</span>;
<span class="hljs-keyword">bool</span> nosleep = <span class="hljs-number">0</span>;
<span class="hljs-keyword">bool</span> button_flag = <span class="hljs-number">0</span>;
<span class="hljs-keyword">bool</span> onoff = <span class="hljs-number">1</span>;
<span class="hljs-keyword">bool</span> flag_update_transport_param;
<span class="hljs-keyword">bool</span> flag_sendRoute_parent;
<span class="hljs-keyword">bool</span> flag_no_present;
<span class="hljs-keyword">bool</span> flag_nogateway_mode;
<span class="hljs-keyword">bool</span> flag_find_parent_process;
<span class="hljs-keyword">bool</span> flag_fcount;
<span class="hljs-keyword">bool</span> Ack_TL;
<span class="hljs-keyword">bool</span> Ack_FP;
<span class="hljs-keyword">bool</span> PRESENT_ACK;
<span class="hljs-keyword">bool</span> send_a;
<span class="hljs-keyword">bool</span> batt_flag;<font></font>
byte conf_vibro_set = <span class="hljs-number">2</span>;<font></font>
byte err_delivery_beat;<font></font>
byte problem_mode_count;<font></font>
<span class="hljs-keyword">uint8_t</span>  countbatt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> batt_cap;
<span class="hljs-keyword">uint8_t</span> old_batt_cap = <span class="hljs-number">100</span>;
<span class="hljs-keyword">uint32_t</span> BATT_TIME;
<span class="hljs-keyword">uint32_t</span> SLEEP_TIME = <span class="hljs-number">10800000</span>;
<span class="hljs-keyword">uint32_t</span> SLEEP_NOGW = <span class="hljs-number">60000</span>;
<span class="hljs-keyword">uint32_t</span> oldmillis;
<span class="hljs-keyword">uint32_t</span> newmillis;
<span class="hljs-keyword">uint32_t</span> previousMillis;
<span class="hljs-keyword">uint32_t</span> lightMillisR;
<span class="hljs-keyword">uint32_t</span> configMillis;
<span class="hljs-keyword">uint32_t</span> interrupt_time;
<span class="hljs-keyword">uint32_t</span> SLEEP_TIME_W;
<span class="hljs-keyword">uint32_t</span> axel_time;
<span class="hljs-keyword">uint32_t</span> axel_time0;
<span class="hljs-keyword">int16_t</span> myid;
<span class="hljs-keyword">int16_t</span> mypar;
<span class="hljs-keyword">int16_t</span> old_mypar = <span class="hljs-number">-1</span>;
<span class="hljs-keyword">bool</span> vibro = <span class="hljs-number">1</span>;
<span class="hljs-keyword">uint32_t</span> PIN_BUTTON_MASK;
<span class="hljs-keyword">uint32_t</span> AXEL_INT_MASK;
<span class="hljs-keyword">uint32_t</span> GERKON_INT_MASK;
<span class="hljs-keyword">uint32_t</span> MAGNET_INT_MASK;
<span class="hljs-keyword">float</span> ODR_1Hz6_LP_ONLY = <span class="hljs-number">1.6f</span>;
<span class="hljs-keyword">float</span> ODR_12Hz5 = <span class="hljs-number">12.5f</span>;
<span class="hljs-keyword">float</span> ODR_25Hz = <span class="hljs-number">25.0f</span>;
<span class="hljs-keyword">float</span> ODR_50Hz = <span class="hljs-number">50.0f</span>;
<span class="hljs-keyword">float</span> ODR_100Hz = <span class="hljs-number">100.0f</span>;
<span class="hljs-keyword">float</span> ODR_200Hz = <span class="hljs-number">200.0f</span>;
<span class="hljs-keyword">volatile</span> byte axelIntStatus = <span class="hljs-number">0</span>;
<span class="hljs-keyword">volatile</span> byte gerkIntStatus = <span class="hljs-number">0</span>;
<span class="hljs-keyword">volatile</span> byte magIntStatus = <span class="hljs-number">0</span>;
<span class="hljs-keyword">volatile</span> byte buttIntStatus = <span class="hljs-number">0</span>;
<span class="hljs-keyword">uint16_t</span> batteryVoltage;
<span class="hljs-keyword">int16_t</span> linkQuality;
<span class="hljs-keyword">int16_t</span> old_linkQuality;<font></font>
<font></font>
<span class="hljs-comment">//#define MY_DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> MY_DEBUG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_DISABLED_SERIAL</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_RADIO_NRF5_ESB</span>
<span class="hljs-keyword">int16_t</span> mtwr;
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_TRANSPORT_WAIT_READY_MS (mtwr)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MY_NRF5_ESB_PA_LEVEL (NRF5_PA_MAX)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;MySensors.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> {
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"app_gpiote.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"nrf_gpio.h"</span></span><font></font>
}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> APP_GPIOTE_MAX_USERS 1</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">app_gpiote_user_id_t</span> m_gpiote_user_id;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;LIS2DW12Sensor.h&gt;</span></span><font></font>
LIS2DW12Sensor *lis2;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DWS_CHILD_ID 0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> V_SENS_CHILD_ID 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> M_CHILD_ID 2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LEVEL_SENSIV_V_SENS_CHILD_ID 230</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIGNAL_Q_ID 250</span><font></font>
<font></font>
<span class="hljs-function">MyMessage <span class="hljs-title">dwsMsg</span><span class="hljs-params">(DWS_CHILD_ID, V_TRIPPED)</span></span>;
<span class="hljs-function">MyMessage <span class="hljs-title">mMsg</span><span class="hljs-params">(M_CHILD_ID, V_TRIPPED)</span></span>;
<span class="hljs-function">MyMessage <span class="hljs-title">vibroMsg</span><span class="hljs-params">(V_SENS_CHILD_ID, V_TRIPPED)</span></span>;
<span class="hljs-function">MyMessage <span class="hljs-title">conf_vsensMsg</span><span class="hljs-params">(LEVEL_SENSIV_V_SENS_CHILD_ID, V_VAR1)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SN <span class="hljs-meta-string">"DOOR &amp; WINDOW SENS"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SV <span class="hljs-meta-string">"1.12"</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">before</span><span class="hljs-params">()</span> </span>{<font></font>
  board_Init();<font></font>
  happy_init();<font></font>
  delay(<span class="hljs-number">500</span>);<font></font>
  batteryVoltage = hwCPUVoltage();<font></font>
  digitalWrite(BLUE_LED, LOW);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">presentation</span><span class="hljs-params">()</span>
</span>{<font></font>
  NRF_POWER-&gt;DCDCEN = <span class="hljs-number">0</span>;<font></font>
  wait(<span class="hljs-number">10</span>);<font></font>
<font></font>
  check = sendSketchInfo(SN, SV);<font></font>
  wait(<span class="hljs-number">30</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">30</span>);<font></font>
    check = sendSketchInfo(SN, SV);<font></font>
    wait(<span class="hljs-number">30</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(DWS_CHILD_ID, S_DOOR, <span class="hljs-string">"STATUS RS SENS"</span>);<font></font>
  wait(<span class="hljs-number">40</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">40</span>);<font></font>
    check = present(DWS_CHILD_ID, S_DOOR, <span class="hljs-string">"STATUS RS SENS"</span>);<font></font>
    wait(<span class="hljs-number">40</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(V_SENS_CHILD_ID, S_VIBRATION, <span class="hljs-string">"STATUS SHOCK SENS"</span>);<font></font>
  wait(<span class="hljs-number">50</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">50</span>);<font></font>
    check = present(V_SENS_CHILD_ID, S_VIBRATION, <span class="hljs-string">"STATUS SHOCK SENS"</span>);<font></font>
    wait(<span class="hljs-number">50</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(M_CHILD_ID, S_DOOR, <span class="hljs-string">"ANTI-MAGNET ALARM"</span>);<font></font>
  wait(<span class="hljs-number">60</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">60</span>);<font></font>
    check = present(M_CHILD_ID, S_DOOR, <span class="hljs-string">"ANTI-MAGNET ALARM"</span>);<font></font>
    wait(<span class="hljs-number">60</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(SIGNAL_Q_ID, S_CUSTOM, <span class="hljs-string">"SIGNAL %"</span>);<font></font>
  wait(<span class="hljs-number">70</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">70</span>);<font></font>
    check = present(SIGNAL_Q_ID, S_CUSTOM, <span class="hljs-string">"SIGNAL %"</span>);<font></font>
    wait(<span class="hljs-number">70</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = present(LEVEL_SENSIV_V_SENS_CHILD_ID, S_CUSTOM, <span class="hljs-string">"SENS LEVEL VIBRO"</span>);<font></font>
  wait(<span class="hljs-number">80</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">80</span>);<font></font>
    check = present(LEVEL_SENSIV_V_SENS_CHILD_ID, S_CUSTOM, <span class="hljs-string">"SENS LEVEL VIBRO"</span>);<font></font>
    wait(<span class="hljs-number">80</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
<font></font>
  check = send(conf_vsensMsg.<span class="hljs-built_in">set</span>(conf_vibro_set));<font></font>
  wait(<span class="hljs-number">90</span>);
  <span class="hljs-keyword">if</span> (!check) {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    wait(<span class="hljs-number">90</span>);<font></font>
    check = send(conf_vsensMsg.<span class="hljs-built_in">set</span>(conf_vibro_set));<font></font>
    wait(<span class="hljs-number">90</span>);<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (check) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
  NRF_POWER-&gt;DCDCEN = <span class="hljs-number">0</span>;<font></font>
  wait(<span class="hljs-number">10</span>);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<font></font>
  digitalWrite(BLUE_LED, HIGH);<font></font>
  config_Happy_node();<font></font>
  sensors_Init();<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (flag_update_transport_param == <span class="hljs-number">1</span>) {<font></font>
    update_Happy_transport();<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (flag_sendRoute_parent == <span class="hljs-number">1</span>) {<font></font>
    present_only_parent();<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (isTransportReady() == <span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (flag_find_parent_process == <span class="hljs-number">1</span>) {<font></font>
        find_parent_process();<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> (configMode == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> ((axelIntStatus == AXEL_INT) || (buttIntStatus == PIN_BUTTON) || (gerkIntStatus == GERKON_INT) || (magIntStatus == MAGNET_INT)) {<font></font>
          nosleep = <span class="hljs-number">1</span>;<font></font>
          newmillis = millis();<font></font>
          interrupt_time = newmillis - oldmillis;<font></font>
          BATT_TIME = BATT_TIME - interrupt_time;<font></font>
          <span class="hljs-keyword">if</span> (BATT_TIME &lt; <span class="hljs-number">60000</span>) {<font></font>
            BATT_TIME = SLEEP_TIME;<font></font>
            batteryVoltage = hwCPUVoltage();<font></font>
            batt_flag = <span class="hljs-number">1</span>;<font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> (gerkIntStatus == GERKON_INT) {<font></font>
            send_Gerkon();<font></font>
            axel_time = millis();<font></font>
            nosleep = <span class="hljs-number">0</span>;<font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> (magIntStatus == MAGNET_INT) {<font></font>
            send_Magnet();<font></font>
            nosleep = <span class="hljs-number">0</span>;<font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> (axelIntStatus == AXEL_INT) {
            <span class="hljs-keyword">if</span> (millis() - axel_time0 &gt;= <span class="hljs-number">2000</span>) {<font></font>
              send_Axel();<font></font>
              nosleep = <span class="hljs-number">0</span>;<font></font>
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">if</span> (digitalRead(GERKON_INT) == LOW) {<font></font>
                send_Gerkon();<font></font>
                axel_time = millis();<font></font>
                nosleep = <span class="hljs-number">0</span>;<font></font>
              }<font></font>
            }<font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> (buttIntStatus == PIN_BUTTON) {
            <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">0</span> &amp;&amp; button_flag == <span class="hljs-number">0</span>) {<font></font>
              button_flag = <span class="hljs-number">1</span>;<font></font>
              previousMillis = millis();<font></font>
              ledsOff();<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">0</span> &amp;&amp; button_flag == <span class="hljs-number">1</span>) {
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">0</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">1750</span>)) {
                <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">70</span>) {<font></font>
                  lightMillisR = millis();<font></font>
                  onoff = !onoff;<font></font>
                  digitalWrite(BLUE_LED, onoff);<font></font>
                }<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">1750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">2000</span>)) {<font></font>
                ledsOff();<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">2000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">3750</span>)) {
                <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">50</span>) {<font></font>
                  lightMillisR = millis();<font></font>
                  onoff = !onoff;<font></font>
                  digitalWrite(GREEN_LED, onoff);<font></font>
                }<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">3750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">4000</span>)) {<font></font>
                ledsOff();<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">4000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">5750</span>)) {
                <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">30</span>) {<font></font>
                  lightMillisR = millis();<font></font>
                  onoff = !onoff;<font></font>
                  digitalWrite(RED_LED, onoff);<font></font>
                }<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> (millis() - previousMillis &gt; <span class="hljs-number">5750</span>) {<font></font>
                ledsOff();<font></font>
              }<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">1</span> &amp;&amp; button_flag == <span class="hljs-number">1</span>) {
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &lt;= <span class="hljs-number">1750</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
              {<font></font>
                ledsOff();<font></font>
                blinky(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, BLUE_LED);<font></font>
                button_flag = <span class="hljs-number">0</span>;<font></font>
                buttIntStatus = <span class="hljs-number">0</span>;<font></font>
                presentation();<font></font>
                nosleep = <span class="hljs-number">0</span>;<font></font>
              }<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">2000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">3750</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
              {<font></font>
                ledsOff();<font></font>
                blinky(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, GREEN_LED);<font></font>
                configMode = <span class="hljs-number">1</span>;<font></font>
                button_flag = <span class="hljs-number">0</span>;<font></font>
                configMillis = millis();<font></font>
                interrupt_Init(<span class="hljs-number">1</span>);<font></font>
                NRF_POWER-&gt;DCDCEN = <span class="hljs-number">0</span>;<font></font>
                buttIntStatus = <span class="hljs-number">0</span>;<font></font>
                NRF5_ESB_startListening();<font></font>
                wait(<span class="hljs-number">50</span>);<font></font>
              }<font></font>
<font></font>
              <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">4000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">5750</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
              {<font></font>
                ledsOff();<font></font>
                blinky(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, RED_LED);
                <span class="hljs-comment">//new_device();</span><font></font>
              }<font></font>
<font></font>
              <span class="hljs-keyword">if</span> ((((millis() - previousMillis &gt; <span class="hljs-number">1750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">2000</span>)) || ((millis() - previousMillis &gt; <span class="hljs-number">3750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">4000</span>)) || ((millis() - previousMillis &gt; <span class="hljs-number">5750</span>))) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
              {<font></font>
                ledsOff();<font></font>
                nosleep = <span class="hljs-number">0</span>;<font></font>
                button_flag = <span class="hljs-number">0</span>;<font></font>
                buttIntStatus = <span class="hljs-number">0</span>;<font></font>
              }<font></font>
            }<font></font>
          }<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
          batteryVoltage = hwCPUVoltage();<font></font>
          BATT_TIME = SLEEP_TIME;<font></font>
          sendBatteryStatus(<span class="hljs-number">1</span>);<font></font>
          nosleep = <span class="hljs-number">0</span>;<font></font>
        }<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (millis() - configMillis &gt; <span class="hljs-number">30000</span>) {<font></font>
          blinky(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, GREEN_LED);<font></font>
          configMode = <span class="hljs-number">0</span>;<font></font>
          nosleep = <span class="hljs-number">0</span>;<font></font>
          interrupt_Init(<span class="hljs-number">0</span>);<font></font>
          NRF_POWER-&gt;DCDCEN = <span class="hljs-number">1</span>;<font></font>
          wait(<span class="hljs-number">50</span>);<font></font>
        }<font></font>
      }<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (buttIntStatus == PIN_BUTTON) {
        <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">0</span> &amp;&amp; button_flag == <span class="hljs-number">0</span>) {<font></font>
          button_flag = <span class="hljs-number">1</span>;<font></font>
          nosleep = <span class="hljs-number">1</span>;<font></font>
          previousMillis = millis();<font></font>
          ledsOff();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">0</span> &amp;&amp; button_flag == <span class="hljs-number">1</span>) {
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">0</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">1750</span>)) {
            <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">25</span>) {<font></font>
              lightMillisR = millis();<font></font>
              onoff = !onoff;<font></font>
              digitalWrite(GREEN_LED, onoff);<font></font>
            }<font></font>
          }<font></font>
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">1750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">2000</span>)) {<font></font>
            ledsOff();<font></font>
          }<font></font>
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">2000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">4000</span>)) {
            <span class="hljs-keyword">if</span> (millis() - lightMillisR &gt; <span class="hljs-number">25</span>) {<font></font>
              lightMillisR = millis();<font></font>
              onoff = !onoff;<font></font>
              digitalWrite(RED_LED, onoff);<font></font>
            }<font></font>
          }<font></font>
          <span class="hljs-keyword">if</span> (millis() - previousMillis &gt; <span class="hljs-number">4000</span>) {<font></font>
            ledsOff();<font></font>
          }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (digitalRead(PIN_BUTTON) == <span class="hljs-number">1</span> &amp;&amp; button_flag == <span class="hljs-number">1</span>) {
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &lt;= <span class="hljs-number">1750</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
          {<font></font>
            ledsOff();<font></font>
            blinky(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, BLUE_LED);<font></font>
            button_flag = <span class="hljs-number">0</span>;<font></font>
            buttIntStatus = <span class="hljs-number">0</span>;<font></font>
            check_parent();<font></font>
            nosleep = <span class="hljs-number">0</span>;<font></font>
          }<font></font>
          <span class="hljs-keyword">if</span> ((millis() - previousMillis &gt; <span class="hljs-number">2000</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">4000</span>) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
          {<font></font>
            ledsOff();<font></font>
            blinky(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, RED_LED);
            <span class="hljs-comment">//new_device();</span><font></font>
          }<font></font>
<font></font>
          <span class="hljs-keyword">if</span> ((((millis() - previousMillis &gt; <span class="hljs-number">1750</span>) &amp;&amp; (millis() - previousMillis &lt;= <span class="hljs-number">2000</span>)) || ((millis() - previousMillis &gt; <span class="hljs-number">4000</span>))) &amp;&amp; (button_flag == <span class="hljs-number">1</span>))<font></font>
          {<font></font>
            ledsOff();<font></font>
            nosleep = <span class="hljs-number">0</span>;<font></font>
            button_flag = <span class="hljs-number">0</span>;<font></font>
            buttIntStatus = <span class="hljs-number">0</span>;<font></font>
          }<font></font>
        }<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        check_parent();<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (_transportSM.failureCounter &gt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    _transportConfig.parentNodeId = loadState(<span class="hljs-number">101</span>);<font></font>
    _transportConfig.nodeId = myid;<font></font>
    _transportConfig.distanceGW = loadState(<span class="hljs-number">103</span>);<font></font>
    mypar = _transportConfig.parentNodeId;<font></font>
    nosleep = <span class="hljs-number">0</span>;<font></font>
    flag_fcount = <span class="hljs-number">1</span>;<font></font>
    err_delivery_beat = <span class="hljs-number">6</span>;<font></font>
    happy_node_mode();<font></font>
    gateway_fail();<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (nosleep == <span class="hljs-number">0</span>) {<font></font>
    oldmillis = millis();<font></font>
    axelIntStatus = <span class="hljs-number">0</span>;<font></font>
    buttIntStatus = <span class="hljs-number">0</span>;<font></font>
    gerkIntStatus = <span class="hljs-number">0</span>;<font></font>
    magIntStatus = <span class="hljs-number">0</span>;<font></font>
    sleep(SLEEP_TIME_W, <span class="hljs-literal">false</span>);<font></font>
    nosleep = <span class="hljs-number">1</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">blinky</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> pulses, <span class="hljs-keyword">uint8_t</span> repit, <span class="hljs-keyword">uint8_t</span> ledColor)</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>; x &lt; repit; x++) {
    <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {<font></font>
      wait(<span class="hljs-number">150</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pulses; i++) {
      <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) {<font></font>
        wait(<span class="hljs-number">40</span>);<font></font>
      }<font></font>
      digitalWrite(ledColor, LOW);<font></font>
      wait(<span class="hljs-number">10</span>);<font></font>
      digitalWrite(ledColor, HIGH);<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">board_Init</span><span class="hljs-params">()</span> </span>{<font></font>
  pinMode(PIN_BUTTON, INPUT_PULLUP);<font></font>
  pinMode(MAGNET_INT, INPUT);<font></font>
  pinMode(GERKON_INT, INPUT);<font></font>
  pinMode(AXEL_INT, INPUT);<font></font>
  pinMode(RED_LED, OUTPUT);<font></font>
  pinMode(GREEN_LED, OUTPUT);<font></font>
  pinMode(BLUE_LED, OUTPUT);<font></font>
  ledsOff();<font></font>
  NRF_POWER-&gt;DCDCEN = <span class="hljs-number">1</span>;<font></font>
  wait(<span class="hljs-number">5</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> MY_DEBUG</span>
  NRF_UART0-&gt;ENABLE = <span class="hljs-number">0</span>;<font></font>
  wait(<span class="hljs-number">5</span>);
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-comment">//NRF_NFCT-&gt;TASKS_DISABLE = 1;</span>
  <span class="hljs-comment">// NRF_NVMC-&gt;CONFIG = 1;</span>
  <span class="hljs-comment">// NRF_UICR-&gt;NFCPINS = 0;</span>
  <span class="hljs-comment">// NRF_NVMC-&gt;CONFIG = 0;</span>
  <span class="hljs-comment">// NRF_SAADC -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_PWM0  -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_PWM1  -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_PWM2  -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_TWIM1 -&gt;ENABLE = 0;</span>
  <span class="hljs-comment">// NRF_TWIS1 -&gt;ENABLE = 0;</span>
  NRF_RADIO-&gt;TXPOWER = <span class="hljs-number">8</span>;<font></font>
  wait(<span class="hljs-number">5</span>);<font></font>
<font></font>
  conf_vibro_set = loadState(<span class="hljs-number">230</span>);
  <span class="hljs-keyword">if</span> ((conf_vibro_set &gt; <span class="hljs-number">5</span>) || (conf_vibro_set == <span class="hljs-number">0</span>)) {<font></font>
    conf_vibro_set = <span class="hljs-number">2</span>;<font></font>
    saveState(<span class="hljs-number">230</span>, conf_vibro_set);<font></font>
  }<font></font>
<font></font>
  blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ledsOff</span><span class="hljs-params">()</span> </span>{<font></font>
  digitalWrite(RED_LED, HIGH);<font></font>
  digitalWrite(GREEN_LED, HIGH);<font></font>
  digitalWrite(BLUE_LED, HIGH);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">happy_init</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">//hwWriteConfig(EEPROM_NODE_ID_ADDRESS, 255); // ******************** checking the node config reset *************************</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (hwReadConfig(EEPROM_NODE_ID_ADDRESS) == <span class="hljs-number">0</span>) {<font></font>
    hwWriteConfig(EEPROM_NODE_ID_ADDRESS, <span class="hljs-number">255</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (loadState(<span class="hljs-number">100</span>) == <span class="hljs-number">0</span>) {<font></font>
    saveState(<span class="hljs-number">100</span>, <span class="hljs-number">255</span>);<font></font>
  }<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"EEPROM NODE ID: %d\n"</span>), hwReadConfig(EEPROM_NODE_ID_ADDRESS));<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"USER MEMORY SECTOR NODE ID: %d\n"</span>), loadState(<span class="hljs-number">100</span>));<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (hwReadConfig(EEPROM_NODE_ID_ADDRESS) == <span class="hljs-number">255</span>) {<font></font>
    mtwr = <span class="hljs-number">0</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    mtwr = <span class="hljs-number">11000</span>;<font></font>
    no_present();<font></font>
  }<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"MY_TRANSPORT_WAIT_MS: %d\n"</span>), mtwr);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">no_present</span><span class="hljs-params">()</span> </span>{<font></font>
  _coreConfig.presentationSent = <span class="hljs-literal">true</span>;<font></font>
  _coreConfig.nodeRegistered = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">interrupt_Init</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> start)</span> </span>{
  <span class="hljs-comment">//***</span>
  <span class="hljs-comment">//SET</span>
  <span class="hljs-comment">//NRF_GPIO_PIN_NOPULL</span>
  <span class="hljs-comment">//NRF_GPIO_PIN_PULLUP</span>
  <span class="hljs-comment">//NRF_GPIO_PIN_PULLDOWN</span>
  <span class="hljs-comment">//***</span><font></font>
  nrf_gpio_cfg_input(PIN_BUTTON, NRF_GPIO_PIN_PULLUP);<font></font>
  nrf_gpio_cfg_input(AXEL_INT, NRF_GPIO_PIN_NOPULL);<font></font>
  nrf_gpio_cfg_input(GERKON_INT, NRF_GPIO_PIN_NOPULL);<font></font>
  nrf_gpio_cfg_input(MAGNET_INT, NRF_GPIO_PIN_NOPULL);<font></font>
  APP_GPIOTE_INIT(APP_GPIOTE_MAX_USERS);<font></font>
  PIN_BUTTON_MASK = <span class="hljs-number">1</span> &lt;&lt; PIN_BUTTON;<font></font>
  AXEL_INT_MASK = <span class="hljs-number">1</span> &lt;&lt; AXEL_INT;<font></font>
  GERKON_INT_MASK = <span class="hljs-number">1</span> &lt;&lt; GERKON_INT;<font></font>
  MAGNET_INT_MASK = <span class="hljs-number">1</span> &lt;&lt; MAGNET_INT;
  <span class="hljs-comment">//  app_gpiote_user_register(p_user_id, pins_low_to_high_mask, pins_high_to_low_mask, event_handler)</span>
  <span class="hljs-keyword">if</span> (start == <span class="hljs-number">0</span>) {<font></font>
    app_gpiote_user_register(&amp;m_gpiote_user_id, AXEL_INT_MASK | GERKON_INT_MASK, GERKON_INT_MASK | MAGNET_INT_MASK | PIN_BUTTON_MASK, gpiote_event_handler);<font></font>
    wait(<span class="hljs-number">5</span>);<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (start == <span class="hljs-number">1</span>) {<font></font>
    app_gpiote_user_register(&amp;m_gpiote_user_id, GERKON_INT_MASK, GERKON_INT_MASK | MAGNET_INT_MASK | PIN_BUTTON_MASK, gpiote_event_handler);<font></font>
    wait(<span class="hljs-number">5</span>);<font></font>
  }<font></font>
  app_gpiote_user_enable(m_gpiote_user_id);<font></font>
  wait(<span class="hljs-number">5</span>);<font></font>
  axelIntStatus = <span class="hljs-number">0</span>;<font></font>
  buttIntStatus = <span class="hljs-number">0</span>;<font></font>
  gerkIntStatus = <span class="hljs-number">0</span>;<font></font>
  magIntStatus = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">gpiote_event_handler</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> event_pins_low_to_high, <span class="hljs-keyword">uint32_t</span> event_pins_high_to_low)</span>
</span>{<font></font>
  MY_HW_RTC-&gt;CC[<span class="hljs-number">0</span>] = (MY_HW_RTC-&gt;COUNTER + <span class="hljs-number">2</span>); <span class="hljs-comment">// Taken from d0016 example code, ends the sleep delay</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (PIN_BUTTON_MASK &amp; event_pins_high_to_low) {
    <span class="hljs-keyword">if</span> ((buttIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (axelIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (gerkIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (magIntStatus == <span class="hljs-number">0</span>)) {<font></font>
      buttIntStatus = PIN_BUTTON;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (AXEL_INT_MASK &amp; event_pins_low_to_high) {
      <span class="hljs-keyword">if</span> ((axelIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (buttIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (gerkIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (magIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (door_status == <span class="hljs-number">1</span>)) {<font></font>
        axelIntStatus = AXEL_INT;<font></font>
        axel_time0 = millis();<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> ((GERKON_INT_MASK &amp; event_pins_low_to_high) || (GERKON_INT_MASK &amp; event_pins_high_to_low)) {
      <span class="hljs-keyword">if</span> ((axelIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (buttIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (gerkIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (magIntStatus == <span class="hljs-number">0</span>)) {<font></font>
        gerkIntStatus = GERKON_INT;<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (MAGNET_INT_MASK &amp; event_pins_high_to_low) {
      <span class="hljs-keyword">if</span> ((axelIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (buttIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (gerkIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (magIntStatus == <span class="hljs-number">0</span>) &amp;&amp; (door_status == <span class="hljs-number">1</span>)) {<font></font>
        magIntStatus = MAGNET_INT;<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sensors_Init</span><span class="hljs-params">()</span> </span>{<font></font>
  Wire.begin();<font></font>
  wait(<span class="hljs-number">100</span>);<font></font>
  lis2 = <span class="hljs-keyword">new</span> LIS2DW12Sensor (&amp;Wire);<font></font>
  vibro_Init();<font></font>
  <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (digitalRead(GERKON_INT) == HIGH) {<font></font>
      door_status = <span class="hljs-number">1</span>;<font></font>
      interrupt_Init(<span class="hljs-number">0</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      door_status = <span class="hljs-number">0</span>;<font></font>
      interrupt_Init(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
    send(dwsMsg.<span class="hljs-built_in">set</span>(door_status));<font></font>
    wait(<span class="hljs-number">50</span>);<font></font>
<font></font>
    SLEEP_TIME_W = SLEEP_TIME;<font></font>
    axelIntStatus = <span class="hljs-number">0</span>;<font></font>
    buttIntStatus = <span class="hljs-number">0</span>;<font></font>
    gerkIntStatus = <span class="hljs-number">0</span>;<font></font>
    magIntStatus = <span class="hljs-number">0</span>;<font></font>
    sendBatteryStatus(<span class="hljs-number">0</span>);<font></font>
    wait(<span class="hljs-number">100</span>);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
    wait(<span class="hljs-number">100</span>);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
    wait(<span class="hljs-number">100</span>);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
    axel_time = millis();<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    interrupt_Init(<span class="hljs-number">0</span>);<font></font>
    blinky(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, RED_LED);<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">config_Happy_node</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (mtwr == <span class="hljs-number">0</span>) {<font></font>
    myid = getNodeId();<font></font>
    saveState(<span class="hljs-number">100</span>, myid);<font></font>
    mypar = _transportConfig.parentNodeId;<font></font>
    old_mypar = mypar;<font></font>
    saveState(<span class="hljs-number">101</span>, mypar);<font></font>
    saveState(<span class="hljs-number">102</span>, _transportConfig.distanceGW);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (mtwr != <span class="hljs-number">0</span>) {<font></font>
    myid = getNodeId();<font></font>
    <span class="hljs-keyword">if</span> (myid != loadState(<span class="hljs-number">100</span>)) {<font></font>
      saveState(<span class="hljs-number">100</span>, myid);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (isTransportReady() == <span class="hljs-literal">true</span>) {<font></font>
      mypar = _transportConfig.parentNodeId;<font></font>
      <span class="hljs-keyword">if</span> (mypar != loadState(<span class="hljs-number">101</span>)) {<font></font>
        saveState(<span class="hljs-number">101</span>, mypar);<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> (_transportConfig.distanceGW != loadState(<span class="hljs-number">102</span>)) {<font></font>
        saveState(<span class="hljs-number">102</span>, _transportConfig.distanceGW);<font></font>
      }<font></font>
      present_only_parent();<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (isTransportReady() == <span class="hljs-literal">false</span>)<font></font>
    {<font></font>
      no_present();<font></font>
      flag_fcount = <span class="hljs-number">1</span>;<font></font>
      err_delivery_beat = <span class="hljs-number">6</span>;<font></font>
      _transportConfig.nodeId = myid;<font></font>
      _transportConfig.parentNodeId = loadState(<span class="hljs-number">101</span>);<font></font>
      _transportConfig.distanceGW = loadState(<span class="hljs-number">102</span>);<font></font>
      mypar = _transportConfig.parentNodeId;<font></font>
      happy_node_mode();<font></font>
      gateway_fail();<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send_Axel</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (millis() - axel_time &gt;= <span class="hljs-number">5000</span>) {<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
    blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
<font></font>
    send_a = send(vibroMsg.<span class="hljs-built_in">set</span>(vibro));<font></font>
    wait(<span class="hljs-number">50</span>);
    <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">false</span>) {<font></font>
      send_a = send(vibroMsg.<span class="hljs-built_in">set</span>(vibro));<font></font>
      wait(<span class="hljs-number">100</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">true</span>) {<font></font>
      err_delivery_beat = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">1</span>) {<font></font>
        flag_nogateway_mode = <span class="hljs-number">0</span>;<font></font>
        CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: NORMAL GATEWAY MODE\n"</span>));<font></font>
        err_delivery_beat = <span class="hljs-number">0</span>;<font></font>
      }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (err_delivery_beat &lt; <span class="hljs-number">6</span>) {<font></font>
        err_delivery_beat++;<font></font>
      }<font></font>
      <span class="hljs-keyword">if</span> (err_delivery_beat == <span class="hljs-number">5</span>) {
        <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {<font></font>
          gateway_fail();<font></font>
          CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: LOST GATEWAY MODE\n"</span>));<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
    axel_time = millis();<font></font>
    axelIntStatus = <span class="hljs-number">0</span>;<font></font>
    nosleep = <span class="hljs-number">0</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    axelIntStatus = <span class="hljs-number">0</span>;<font></font>
    nosleep = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send_Gerkon</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (digitalRead(GERKON_INT) == HIGH) {<font></font>
    door_status = <span class="hljs-number">1</span>;<font></font>
    interrupt_Init(<span class="hljs-number">0</span>);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    door_status = <span class="hljs-number">0</span>;<font></font>
    interrupt_Init(<span class="hljs-number">1</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (door_status == <span class="hljs-number">1</span>) {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, GREEN_LED);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blinky(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  }<font></font>
  send_a = send(dwsMsg.<span class="hljs-built_in">set</span>(door_status));<font></font>
  wait(<span class="hljs-number">50</span>);
  <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">false</span>) {<font></font>
    send_a = send(dwsMsg.<span class="hljs-built_in">set</span>(door_status));<font></font>
    wait(<span class="hljs-number">100</span>);
    <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">false</span>) {<font></font>
      send_a = send(dwsMsg.<span class="hljs-built_in">set</span>(door_status));<font></font>
      wait(<span class="hljs-number">150</span>);<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">true</span>) {<font></font>
    err_delivery_beat = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">1</span>) {<font></font>
      flag_nogateway_mode = <span class="hljs-number">0</span>;<font></font>
      CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: NORMAL GATEWAY MODE\n"</span>));<font></font>
      err_delivery_beat = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (err_delivery_beat &lt; <span class="hljs-number">6</span>) {<font></font>
      err_delivery_beat++;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (err_delivery_beat == <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {<font></font>
        gateway_fail();<font></font>
        CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: LOST GATEWAY MODE\n"</span>));<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  gerkIntStatus = <span class="hljs-number">0</span>;<font></font>
  nosleep = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send_Magnet</span><span class="hljs-params">()</span> </span>{<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, BLUE_LED);<font></font>
  blinky(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, RED_LED);<font></font>
  send_a = send(mMsg.<span class="hljs-built_in">set</span>(magnet_status));<font></font>
  wait(<span class="hljs-number">50</span>);
  <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">false</span>) {<font></font>
    send_a = send(mMsg.<span class="hljs-built_in">set</span>(magnet_status));<font></font>
    wait(<span class="hljs-number">100</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (send_a == <span class="hljs-literal">true</span>) {<font></font>
    err_delivery_beat = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">1</span>) {<font></font>
      flag_nogateway_mode = <span class="hljs-number">0</span>;<font></font>
      CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: NORMAL GATEWAY MODE\n"</span>));<font></font>
      err_delivery_beat = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (err_delivery_beat &lt; <span class="hljs-number">6</span>) {<font></font>
      err_delivery_beat++;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (err_delivery_beat == <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">if</span> (flag_nogateway_mode == <span class="hljs-number">0</span>) {<font></font>
        gateway_fail();<font></font>
        CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: LOST GATEWAY MODE\n"</span>));<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  magIntStatus = <span class="hljs-number">0</span>;<font></font>
  nosleep = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">new_device</span><span class="hljs-params">()</span> </span>{<font></font>
  hwWriteConfig(EEPROM_NODE_ID_ADDRESS, <span class="hljs-number">255</span>);<font></font>
  saveState(<span class="hljs-number">100</span>, <span class="hljs-number">255</span>);<font></font>
  wdt_enable(WDTO_15MS);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update_Happy_transport</span><span class="hljs-params">()</span> </span>{<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: UPDATE TRANSPORT CONFIGURATION\n"</span>));<font></font>
  mypar = _transportConfig.parentNodeId;<font></font>
  <span class="hljs-keyword">if</span> (mypar != loadState(<span class="hljs-number">101</span>))<font></font>
  {<font></font>
    saveState(<span class="hljs-number">101</span>, mypar);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (_transportConfig.distanceGW != loadState(<span class="hljs-number">102</span>))<font></font>
  {<font></font>
    saveState(<span class="hljs-number">102</span>, _transportConfig.distanceGW);<font></font>
  }<font></font>
  present_only_parent();<font></font>
  wait(<span class="hljs-number">50</span>);<font></font>
  nosleep = <span class="hljs-number">0</span>;<font></font>
  flag_update_transport_param = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">present_only_parent</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (old_mypar != mypar) {<font></font>
    CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: SEND LITTLE PRESENT:) WITH PARENT ID\n"</span>));
    <span class="hljs-keyword">if</span> (_sendRoute(build(_msgTmp, <span class="hljs-number">0</span>, NODE_SENSOR_ID, C_INTERNAL, <span class="hljs-number">6</span>).<span class="hljs-built_in">set</span>(mypar))) {<font></font>
      flag_sendRoute_parent = <span class="hljs-number">0</span>;<font></font>
      old_mypar = mypar;<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      flag_sendRoute_parent = <span class="hljs-number">1</span>;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">happy_node_mode</span><span class="hljs-params">()</span> </span>{<font></font>
  _transportSM.findingParentNode = <span class="hljs-literal">false</span>;<font></font>
  _transportSM.transportActive = <span class="hljs-literal">true</span>;<font></font>
  _transportSM.uplinkOk = <span class="hljs-literal">true</span>;<font></font>
  _transportSM.pingActive = <span class="hljs-literal">false</span>;<font></font>
  _transportSM.failureCounter = <span class="hljs-number">0</span>;<font></font>
  _transportSM.uplinkOk = <span class="hljs-literal">true</span>;<font></font>
  _transportSM.failureCounter = <span class="hljs-number">0u</span>;<font></font>
  _transportSM.failedUplinkTransmissions = <span class="hljs-number">0u</span>;<font></font>
  transportSwitchSM(stReady);<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"TRANSPORT: %d\n"</span>), isTransportReady());<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">gateway_fail</span><span class="hljs-params">()</span> </span>{<font></font>
  flag_nogateway_mode = <span class="hljs-number">1</span>;<font></font>
  flag_update_transport_param = <span class="hljs-number">0</span>;<font></font>
  SLEEP_TIME_W = SLEEP_NOGW;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">check_parent</span><span class="hljs-params">()</span> </span>{<font></font>
  _transportSM.findingParentNode = <span class="hljs-literal">true</span>;<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: SEND FIND PARENT REQUEST, WAIT RESPONSE\n"</span>));<font></font>
  _sendRoute(build(_msg, <span class="hljs-number">255</span>, NODE_SENSOR_ID, C_INTERNAL, <span class="hljs-number">7</span>).<span class="hljs-built_in">set</span>(<span class="hljs-string">""</span>));<font></font>
  wait(<span class="hljs-number">1500</span>, C_INTERNAL, <span class="hljs-number">8</span>);
  <span class="hljs-keyword">if</span> (_msg.sensor == <span class="hljs-number">255</span>) {
    <span class="hljs-keyword">if</span> (mGetCommand(_msg) == <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">if</span> (_msg.type == <span class="hljs-number">8</span>) {<font></font>
        Ack_FP = <span class="hljs-number">1</span>;<font></font>
        CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: PARENT RESPONSE FOUND\n"</span>));<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (Ack_FP == <span class="hljs-number">1</span>) {<font></font>
    CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: FIND PARENT PROCESS\n"</span>));<font></font>
    Ack_FP = <span class="hljs-number">0</span>;<font></font>
    transportSwitchSM(stParent);<font></font>
    flag_nogateway_mode = <span class="hljs-number">0</span>;<font></font>
    flag_find_parent_process = <span class="hljs-number">1</span>;<font></font>
    problem_mode_count = <span class="hljs-number">0</span>;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    _transportSM.findingParentNode = <span class="hljs-literal">false</span>;<font></font>
    CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: PARENT RESPONSE NOT FOUND\n"</span>));<font></font>
    _transportSM.failedUplinkTransmissions = <span class="hljs-number">0</span>;<font></font>
    CORE_DEBUG(PSTR(<span class="hljs-string">"TRANSPORT: %d\n"</span>), isTransportReady());<font></font>
    nosleep = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (problem_mode_count &lt; <span class="hljs-number">9</span>) {<font></font>
      CORE_DEBUG(PSTR(<span class="hljs-string">"PROBLEM MODE COUNTER: %d\n"</span>), problem_mode_count);<font></font>
      problem_mode_count++;<font></font>
      SLEEP_TIME_W = SLEEP_TIME_W + SLEEP_TIME_W;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">find_parent_process</span><span class="hljs-params">()</span> </span>{<font></font>
  flag_update_transport_param = <span class="hljs-number">1</span>;<font></font>
  flag_find_parent_process = <span class="hljs-number">0</span>;<font></font>
  CORE_DEBUG(PSTR(<span class="hljs-string">"MyS: STANDART TRANSPORT MODE IS RESTORED\n"</span>));<font></font>
  err_delivery_beat = <span class="hljs-number">0</span>;<font></font>
  SLEEP_TIME_W = SLEEP_TIME;<font></font>
  nosleep = <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendBatteryStatus</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> start)</span> </span>{<font></font>
  batt_cap = battery_level_in_percent(batteryVoltage);<font></font>
  <span class="hljs-keyword">if</span> (start == <span class="hljs-number">1</span>) {
    <span class="hljs-comment">//if (batt_cap &lt; old_batt_cap) {</span>
    sendBatteryLevel(battery_level_in_percent(batteryVoltage), <span class="hljs-number">1</span>);<font></font>
    wait(<span class="hljs-number">1500</span>, C_INTERNAL, I_BATTERY_LEVEL);<font></font>
    old_batt_cap = batt_cap;<font></font>
    <span class="hljs-comment">// }</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    sendBatteryLevel(battery_level_in_percent(batteryVoltage), <span class="hljs-number">1</span>);<font></font>
    wait(<span class="hljs-number">1500</span>, C_INTERNAL, I_BATTERY_LEVEL);<font></font>
  }<font></font>
<font></font>
  linkQuality = calculationRxQuality();<font></font>
  <span class="hljs-keyword">if</span> (linkQuality != old_linkQuality) {<font></font>
    wait(<span class="hljs-number">10</span>);<font></font>
    sendSignalStrength(linkQuality);<font></font>
    wait(<span class="hljs-number">50</span>);<font></font>
    old_linkQuality = linkQuality;<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">sendSignalStrength</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int16_t</span> level, <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span> ack)</span>
</span>{
  <span class="hljs-keyword">return</span> _sendRoute(build(_msgTmp, GATEWAY_ADDRESS, SIGNAL_Q_ID, C_SET, V_VAR1,<font></font>
                          ack).<span class="hljs-built_in">set</span>(level));<font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">int16_t</span> <span class="hljs-title">calculationRxQuality</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">int16_t</span> nRFRSSI_temp = transportGetReceivingRSSI();
  <span class="hljs-keyword">int16_t</span> nRFRSSI = <span class="hljs-built_in">map</span>(nRFRSSI_temp, <span class="hljs-number">-85</span>, <span class="hljs-number">-40</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>);
  <span class="hljs-keyword">if</span> (nRFRSSI &lt; <span class="hljs-number">0</span>) {<font></font>
    nRFRSSI = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (nRFRSSI &gt; <span class="hljs-number">100</span>) {<font></font>
    nRFRSSI = <span class="hljs-number">100</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> nRFRSSI;<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">receive</span><span class="hljs-params">(<span class="hljs-keyword">const</span> MyMessage &amp; message)</span>
</span>{
  <span class="hljs-keyword">if</span> (message.sensor == LEVEL_SENSIV_V_SENS_CHILD_ID) {
    <span class="hljs-keyword">if</span> (message.type == V_VAR1) {<font></font>
      conf_vibro_set = message.getByte();<font></font>
      vibro_Init();<font></font>
      saveState(<span class="hljs-number">230</span>, conf_vibro_set);<font></font>
      wait(<span class="hljs-number">200</span>);<font></font>
      send(conf_vsensMsg.<span class="hljs-built_in">set</span>(conf_vibro_set));<font></font>
      wait(<span class="hljs-number">200</span>);<font></font>
      blinky(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, GREEN_LED);<font></font>
      configMode = <span class="hljs-number">0</span>;<font></font>
      nosleep = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vibro_Init</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">1</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_1Hz6_LP_ONLY;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">2</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_12Hz5;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">3</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_25Hz;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">4</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_100Hz;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (conf_vibro_set == <span class="hljs-number">5</span>) {<font></font>
    lis2-&gt;ODRTEMP = ODR_200Hz;<font></font>
  }<font></font>
  lis2-&gt;Enable_X();<font></font>
  wait(<span class="hljs-number">100</span>);<font></font>
  lis2-&gt;Enable_Wake_Up_Detection();<font></font>
  wait(<span class="hljs-number">100</span>);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una lista completa de archivos de proyecto está disponible en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">git</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como sistema UD, he estado usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Majordomo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durante mucho tiempo </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En este artículo describiré un ejemplo de cómo funciona el sensor en la red Maysensors a través del controlador UD. </font><font style="vertical-align: inherit;">En esta realización, los datos del sensor se envían a través de la puerta de enlace Maysensors al sistema UD. </font><font style="vertical-align: inherit;">Majordomo implementa el soporte para el protocolo Mysensors </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en un módulo separado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El módulo para descarga e instalación está disponible en el mercado de complementos del sistema UD en la sección "equipo". </font></font><br>
<img src="https://habrastorage.org/webt/22/ho/ia/22hoiaoqgc-wbzualelk3bhxks8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por el momento, la implementación de Majordomo UD es la más completa y compatible:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos los tipos de datos mesensores,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajar con OTA,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajar con varias redes a la vez en un módulo (multi-gate), </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soporte para dispositivos SmartSleep, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitar datos de sensores en la red cuando se inicia el módulo, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitud de confirmación de entrega del mensaje, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soporte para solicitudes de servicio, como recopilación de datos, latidos, presentación, reinicio,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajar con NodeManager</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, existen fallas, el soporte previamente agregado para puertas de enlace en serie, en el proceso del desarrollo natural del sistema, Majordomo ordenó una larga vida y actualmente no es compatible. </font><font style="vertical-align: inherit;">Ni siquiera tuve la oportunidad de probar este tipo de puertas en el Majordomo, ya que esta función no estaba disponible antes de que descubriera Mysensors. </font><font style="vertical-align: inherit;">El desarrollador del módulo prometió agregar esta característica nuevamente para septiembre de 2019, pero la caída del 19 ha pasado, y todavía no hay soporte para la serie de puertas de enlace :(. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
También puede usar las puertas de enlace mseps Mysensors con Majordomo, pero no a través del módulo Mysensors, sino a través del módulo MQTT.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mi sensor, los sensores de choque y de campo magnético solo transmiten una unidad cuando se activan, y esto resultó ser un pequeño problema. El módulo de dispositivos simples no admite este tipo de sensores, por supuesto, hay un sensor común, pero su personalización de la configuración es muy limitada. Al agregar un sensor, un problema incómodo era que cuando la siguiente unidad provenía del sensor, tenía que iniciar un temporizador inverso, de modo que después de un intervalo de tiempo especificado en el temporizador, el cero se escribe en la propiedad del objeto. Pero como todo funciona a través del método de "actualización de estado", luego registra el cero, el módulo de meysensors que recibe un nuevo estado envió un mensaje a la red con estos datos a mi dispositivo, y el punto es cero.La solución más simple me pareció agregar un nuevo método en el que el estado de la propiedad1 a la propiedad2 se transferirá y se iniciará un temporizador para escribir cero en la propiedad2. Un objeto creado en dispositivos simples funcionará con la propiedad2 y en el módulo Maysensors con la propiedad1.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/n0/ui/nen0uibfj0kw4wuupvbxr9z7zoo.png"><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;getProperty(<span class="hljs-string">'value2'</span>) == <span class="hljs-string">'1'</span>){
<span class="hljs-keyword">$this</span>-&gt;setProperty(<span class="hljs-string">'status'</span>,<span class="hljs-string">'1'</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuación, en el método de actualización de estado del objeto deseado, debe agregar un inicio de temporizador:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">if</span> (gg(<span class="hljs-string">"MysensorsSmoke03.status"</span>) == <span class="hljs-string">"1"</span>) {<font></font>
SetTimeOut(<span class="hljs-string">'AlarmShock'</span>,<span class="hljs-string">'sg("MysensorsSmoke03.status","0");'</span>,<span class="hljs-number">10</span>);<font></font>
}<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video con la operación del sensor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el sistema Majordomo y la aplicación Majordroid. </font><font style="vertical-align: inherit;">Le recomiendo que lo vea, siempre que sea posible, para mostrar el funcionamiento de la funcionalidad principal, y, por supuesto, sus me gusta y suscripciones serán especialmente valiosas para mi pequeño canal de inicio, pero al hacer clic en el timbre no se perderá un video con mis nuevos sensores;).</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/OmclWv2vLog" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La placa del dispositivo se realizó con el programa DeepTrace. </font><font style="vertical-align: inherit;">El desarrollo de este editor para el desarrollo de la electrónica una vez me permitió ampliar enormemente mis capacidades. </font><font style="vertical-align: inherit;">Noto que no soy un ingeniero electrónico profesional, mi experiencia en el desarrollo doméstico de placas base es de un año y medio o dos. </font><font style="vertical-align: inherit;">Para todos los que hacen sus dispositivos en el tablero, les recomiendo que intenten aprender algún tipo de editor, YouTube está lleno de manuales en video.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qh/qn/oc/qhqnocyny82yvitjx84lso-irzo.png"><br>
<br>
<img src="https://habrastorage.org/webt/dw/vi/ez/dwviez3dctkm_yuxfawnlto9lrm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El soporte para chips nRF5 en Maysensors se basa en la biblioteca Sandeep Mistry - arduino-nRF5. Pero esta biblioteca carece de soporte para los chips nRF52840, nRF52810 y los chips nRF52811 completamente nuevos. Tuve que bifurcar y agregar soporte para estos chips, se realizó una transferencia y adaptación desde el SDK nórdico. No había soporte para dispositivos blandos ya que no hay una necesidad particular de usar Mysensors, y no había soporte para Port1 para chips nRF52840. Más recientemente, mi investigación sobre este tema y la investigación de otro </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">miembro de la comunidad Maysensors se combinaron</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y, como resultado, el soporte para nRF52840 ya se obtuvo con port1, los pines se convirtieron en un mar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El caso para el sensor se desarrolló en el programa SolidWorks, también se dominó independientemente de las lecciones en YouTube hace aproximadamente un año. El caso fue impreso en una impresora ANYCUBIC FOTON SLA. La calidad y precisión de la impresión con la que estaba muy contento. Lo único negativo es una elección bastante pobre de resinas UV con las que pueden trabajar tales impresoras domésticas. Dimensiones del dispositivo en la carcasa: Largo 43 mm, Ancho 26 mm, Altura 12.5 mm. Dimensiones de la caja con imán: longitud 37 mm, ancho 11 mm, altura 12,5 mm. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/my/hm/97/myhm97dmggj8d7sdauhlx9oyk5c.png"><br>
<br>
<img src="https://habrastorage.org/webt/wz/9j/cy/wz9jcyajh87x1l7zlncvy_eb1sy.png"><br>
<br>
<img src="https://habrastorage.org/webt/e4/u-/rw/e4u-rwqymkdi701zplhs_b3kn-e.png"><br>
<br>
<img src="https://habrastorage.org/webt/r1/ve/h4/r1veh45ljjnvdwjlappikjgxr_g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El consumo del sensor en un sueño varió de 4 μA a 7 μA, dependiendo del chip seleccionado. El consumo en el modo de transferencia de datos fue de 8 mA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sensor usa una batería CR2032. Todas las mediciones fueron hechas por el "multifiler" chino :) en vista de la falta de un perfilador debido a su costo bastante elevado :(.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El dispositivo se puede repetir, use el boceto escrito o escriba el suyo. </font><font style="vertical-align: inherit;">Para repetir el sensor, todo lo que necesita se presenta en mi github ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gerberas, código, modelos de caja</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si alguien está listo para ayudar a escribir software bajo el protocolo ZIGBEE, con mucho gusto cooperaré. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si está interesado en este proyecto, vaya al grupo de telegramas, siempre habrá asistencia para dominar no solo el protocolo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maysensors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sino también </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zigbee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BLE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en nRF5, lo asesorarán de inmediato sobre todos los problemas de programación de nRF52 en Arduino IDE y no solo en él. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Carts chat donde vivo y personas como yo - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@MYSENSORS_RUS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno para todos!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490464/index.html">Sobre un intento fallido de fuerza bruta de derechos de autor o 68 mil millones de canciones que no cambiarán nada</a></li>
<li><a href="../es490466/index.html">Hoja de ruta de disciplinas matemáticas para el aprendizaje automático, parte 2 (probabilidades)</a></li>
<li><a href="../es490470/index.html">OWASP Moscú 2020/1</a></li>
<li><a href="../es490472/index.html">Mientras escribía una criptomoneda semi descentralizada en PHP. (Parte 1 - Coleccionar bibliotecas)</a></li>
<li><a href="../es490474/index.html">STM32 Parte 1: Lo básico</a></li>
<li><a href="../es490478/index.html">Estación de soldadura DIY DIY v2</a></li>
<li><a href="../es490480/index.html">O Tiling-wm en 2 palabras</a></li>
<li><a href="../es490484/index.html">Administrar sensores domésticos inteligentes con el Asistente de Google</a></li>
<li><a href="../es490490/index.html">Lectura de fin de semana: 10 materiales sobre los efectos del sonido en la salud, desde "higiene de ruido" hasta buen sueño y GTD</a></li>
<li><a href="../es490492/index.html">El robot de almacén aprende a clasificar cosas no estándar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>