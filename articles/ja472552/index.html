<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👰🏽 🧑🏽‍🤝‍🧑🏽 🏴‍☠️ 7つの命令によってロックされた63コア 🤔 🎷 ✌🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私は、誤ったロックのために多くのコアがアイドル状態になっている強力なマシンについて書く習慣があるようです。あ、はい。再びそれについて。 この物語は特に印象的です。実際、7つのチームのサイクルで1つのスレッドが数秒間スピンし、他の63のプロセッサの作業を停止するロックを保持している頻度はどれくらいです...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>7つの命令によってロックされた63コア</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472552/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は、</font><font style="vertical-align: inherit;">誤ったロックのために</font><font style="vertical-align: inherit;">多くのコアが</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">アイドル状態に</font></a><font style="vertical-align: inherit;">なって</font><font style="vertical-align: inherit;">いる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">強力なマシン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">について書く習慣があるようです</font><font style="vertical-align: inherit;">。あ、はい。再びそれについて。</font><font style="vertical-align: inherit;">
この物語は特に印象的です。実際、7つのチームのサイクルで1つのスレッドが数秒間スピンし、他の63のプロセッサの作業を停止するロックを保持している頻度はどれくらいですか？ひどい意味で、それはただ驚くべきことです。</font><font style="vertical-align: inherit;">
一般的な考えに反して、私は実際には64個の論理プロセッサーを備えたマシンを持っていないし、この特定の問題を見たことがない。しかし、私の友人がそれに遭遇し、</font><s><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">このオタクが私を引っ掛けて、</font></a></s><font style="vertical-align: inherit;">彼は助けを求めました、そして私は問題が非常に興味深いと決めました。彼は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ETWトレース</font></a><font style="vertical-align: inherit;">を送信しました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><s><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a></s><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Twitterの集合的な心が問題をすばやく解決できるように、十分な情報があります。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
友人の不満は非常に単純でした。彼は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">忍者</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してビルドを収集しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">通常、忍者は負荷を増やすという素晴らしい仕事をし、ダウンタイムを回避するために常にn + 2プロセスをサポートします。</font><font style="vertical-align: inherit;">しかし、ここで組み立て、次のように見えたの最初の17秒でCPU使用率：</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/708/9d6/808/7089d68083b016688e6ec980981f52a4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
場合は</font><font style="vertical-align: inherit;">、あなたが見て</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常に</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密接に（冗談）、あなたは合計CPU負荷は数秒で100％から0％に低下細い線を見ることができます。</font><font style="vertical-align: inherit;">わずか0.5秒で、負荷は64から2つまたは3つのスレッドに低下します。</font><font style="vertical-align: inherit;">以下は、これらの滝の1つを拡大した断片です。横軸に沿って秒がマークされています。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/14a/f7a/6c3/14af7a6c3dbdb7563fa6e316ad7a21e2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に考えたのは、忍者はプロセスを十分に速く作成できないということでした。私はこれを何度も見ましたが、通常はウイルス対策ソフトウェアの介入が原因です。しかし、チャートを終了時刻で並べ替えたところ、そのようなクラッシュ中にプロセスが完了していないことがわかりました。そのため、忍者は責任を負いません。</font><i><font style="vertical-align: inherit;">CPU Usage（Precise）</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
テーブルは、ダウンタイムの原因を特定するのに理想的です</font><font style="vertical-align: inherit;">。場所とタイムアウトを含む、ストリームの各開始の正確な記録を含む、すべてのコンテキストスイッチのログがそこに保存されます。</font><font style="vertical-align: inherit;">
トリックは、ダウンタイムに問題がないことです。この問題は、スレッドで実際に処理を実行したいが、アイドル状態になっている場合に発生します。したがって、ダウンタイムの特定の瞬間を選択する必要があります。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析する場合、スレッドが操作を再開したときにコンテキストの切り替えが発生することを理解することが重要です。プロセッサの負荷が低下し始めたときにこれらの場所を見ると、何も見つかりません。代わりに、システムが再び機能し始めた時期に注目してください。このトレースフェーズはさらに劇的です。 CPU負荷の低下には0.5秒かかりますが、使用されている1つのスレッドから全負荷までの逆のプロセスにはわずか12ミリ秒しかかかりません。以下のグラフはかなり拡大されていますが、アイドルから負荷への移行はほぼ垂直線です</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/d7f/cd4/cc6/d7fcd4cc68e55c5d6c7ff16cc8a5b32d.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。12ミリ秒にズームインすると、500のコンテキストスイッチが見つかりました。ここで徹底的な分析が必要です。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここ</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">記載</font></a><font style="vertical-align: inherit;">したコンテキストスイッチテーブルには多くの列があり</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">プロセスがフリーズしたとき、理由を見つけるために、新しいプロセス、新しいスレッド、新しいスレッドスタックなどでグループ化します（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで説明します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）が、これは何百もの停止したプロセスでは機能しません。</font><font style="vertical-align: inherit;">間違ったプロセスを調べた場合、それは前のプロセスによって準備されたものであることが明らかであり、長いチェーンをスキャンして、（おそらく）重要なロックを長時間保持している最初のリンクを見つけます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、プログラムで別の列レイアウトを試しました。</font></font><br>
<br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スイッチイン時間</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（コンテキスト切り替えが発生したとき）</font></font><br>
</li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">準備プロセス</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（待機後にロックを解放した人）</font></font><br>
</li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいプロセス</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（作業を開始した人）</font></font><br>
</li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後からの時間</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（新しいプロセスが待機していた時間）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、誰が誰を準備したか、そしてプロセスが作動する準備ができていた時間の長さをメモしたコンテキストスイッチの時系列リストを提供します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで十分であることがわかりました。</font><font style="vertical-align: inherit;">あなたがそれを読む方法を知っているなら、下の表はそれ自身のためにわかります。</font><font style="vertical-align: inherit;">最初のいくつかのコンテキストスイッチは重要ではありません。新しいプロセスの待ち時間（最後からの経過時間）は非常に短いためですが、強調表示された行（＃4）で興味深い部分が始まります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/0d7/106/72f/0d710672f2cafc1bd7a2953a42ea55dd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この行は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム（4）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cl.exeを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">準備した</font><font style="vertical-align: inherit;">ことを示してい</font><i><font style="vertical-align: inherit;">ます</font></i><i><font style="vertical-align: inherit;">（3032）</font></i><font style="vertical-align: inherit;"> 3.368秒待った人。</font><font style="vertical-align: inherit;">次の行は、0.1ミリ秒未満で</font><i><font style="vertical-align: inherit;">cl。Exe </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（3032）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cl.exe（16232）を</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">準備し</font><font style="vertical-align: inherit;">、3.367秒待機したことを示しています。</font><font style="vertical-align: inherit;">等。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
行＃7のように、いくつかのコンテキストスイッチは待機チェーンに含まれていませんが、システム内の他の作業を反映しているだけですが、一般にチェーンは何十もの要素に拡張されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、これらすべてのプロセスが同じロックの解放を待っていることを意味します。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム（4）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセス</font><font style="vertical-align: inherit;">がロックを解放すると（3,368秒間保持した後）、待機中のプロセスがロックを取得し、小さな処理を行ってロックを渡します。待機キューには約100のプロセスがあり、単一のロックの影響の度合いを示しています。</font><i><font style="vertical-align: inherit;">Ready Thread Stacksの</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
小規模な調査</font><font style="vertical-align: inherit;">により、ほとんどの期待は</font><i><font style="vertical-align: inherit;">KernelBase.dllWriteFile</font></i><font style="vertical-align: inherit;">からのものであることが明らかになり</font><i><font style="vertical-align: inherit;">ました</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この関数の呼び出し元をグループ化して表示するようにWPAに依頼しました。</font><font style="vertical-align: inherit;">このカタルシスの12ミリ秒で174のスレッドが</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteFileの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">待機を終了し</font><font style="vertical-align: inherit;">、平均1,184秒待機した</font><font style="vertical-align: inherit;">ことがわかります</font><i><font style="vertical-align: inherit;">。WriteFile</font></i><font style="vertical-align: inherit;">を待機している</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c63/a77/73d/c63a7773d08b42f2def485247d57e916.png"><br>
<i><font color="gray"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">174のスレッド、平均の待機時間は1,184秒</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
これは驚くべき遅れであり、実際、問題の規模全体ではありません。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KernelBase.dll！GetQueuedCompletionStatus</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの他の関数の多くのスレッドは、同じロックの解放を期待しています</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムの役割（4）</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、私はすべてのコンパイラプロセスと他の人が期待していたので、ビルドの進行が停止していることを知っていた</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のWriteFileを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するので、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム（4）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロックを開催しました。別の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ready Thread Id</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列</font><font style="vertical-align: inherit;">は、スレッド3276がシステムプロセスのロックを解放したことを示しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アセンブリのすべての「ハング」の間、スレッド3276は100％読み込まれているため、ロックを保持している間にCPUで何らかの処理が行われたことは明らかです。 CPU時間が費やされている場所を見つけるために、</font><font style="vertical-align: inherit;">ストリーム3276のCPU使用率</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（サンプル）グラフ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">見てみましょう</font><font style="vertical-align: inherit;">。CPU使用率データは驚くほど明確でした。ほとんどの場合、1つの関数</font><i><font style="vertical-align: inherit;">ntoskrnl.exe</font></i><font style="vertical-align: inherit;">の処理に時間がかかります</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！RtlFindNextForwardRunClear</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（番号の欄にサンプルの数を示す）： </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/0fc/0ce/2fc/0fc0ce2fc4485818ba45f9504f4c8181.png"><br>
<i><font color="gray"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font><font style="vertical-align: inherit;">コールスタックリードがRtlFindNextForwardRunClear NTOSKRNL.EXEする</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ビューのスレッドスタックを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スレッドIdが描く準備</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">することが確認さ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtfsCheckpointVolumeは</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3368を通じてロックを解除：</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a43/225/a97/a43225a974de7651a6b51dc04b339364.png"><br>
<i><font color="gray"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ExReleaseResourceLiteでNtfsCheckpointVolumeからのコールスタック</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
この時点で、時間が来たように私には思えましたTwitterで私のフォロワーの豊富な知識を使用するため、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この質問</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を投稿し</font><font style="vertical-align: inherit;">、完全なコールスタックを示しました。このような質問のあるツイートは、十分な情報を提供すると非常に効果的です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正解</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Caitlin Gadd</font></a><font style="vertical-align: inherit;">から</font><font style="vertical-align: inherit;">非常に迅速に</font><font style="vertical-align: inherit;">得られました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、他の多くの素晴らしいオファーと一緒に。</font><font style="vertical-align: inherit;">彼女はシステム回復機能をオフにしました-そして突然、ビルドは2倍から3倍速くなりました！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、待って、さらにはさらに良いです</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システム全体の実行を3秒以上ブロックすることは非常に印象的ですが</font><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU使用状況（サンプリング）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレス</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列を追加して</font><font style="vertical-align: inherit;">並べ替えると</font><font style="vertical-align: inherit;">、状況はさらに印象的に</font><font style="vertical-align: inherit;">なります。</font><font style="vertical-align: inherit;">これは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RtlFindNextForwardRunClear</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サンプルの</font><font style="vertical-align: inherit;">正確な場所を示してい</font><font style="vertical-align: inherit;">ます-そして、それらの99％が1つの命令</font><font style="vertical-align: inherit;">に</font><i><font style="vertical-align: inherit;">当てはまり</font></i><font style="vertical-align: inherit;">ます！</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/aec/1e3/9b6/aec1e39b65cddb3473242514e7cea1a9.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が取った</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTOSKRNL.EXE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntkrnlmp.pdbファイル</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（私の友人と同じバージョンを）し、それを実行した</font></font><code>dumpbin /disasm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブラへの関心の機能を表示します。</font><font style="vertical-align: inherit;">コードは起動時に移動するため、アドレスの最初の桁は異なりますが、最後の4つの16進値は同じです（ASLRの後で変更されません）。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RtlFindNextForwardRunClear：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
14006464F：4C 3B C3 cmp r8、rbx</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064652：73 0F jae 0000000140064663</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064654：41 39 28 cmp dword ptr [r8]、ebp</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064657：75 0A jne 0000000140064663</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064659：49 83 C0 04追加r8.4</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
14006465D：41 83 C1 20 add r9d、20h</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064661：EB EC jmp 000000014006464F</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... 4657の命令は、他のサンプルにある7つの命令のサイクルに含まれていることがわかります。</font><font style="vertical-align: inherit;">そのようなサンプルの数は右側に示されています：</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RtlFindNextForwardRunClear：</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
14006464F：4C 3B C3 cmp r8、rbx 4</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064652：73 0F jae 0000000140064663 41</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064654：41 39 28 cmp dword ptr [r8]、ebp     </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064657：75 0A jne 0000000140064663 7498</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064659：49 83 C0 04追加r8.4 2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
14006465D：41 83 C1 20 add r9d、20h 1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
140064661：EB EC jmp 000000014006464F 1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
読者のための演習として、特別な命令の実行を伴うスーパースカラープロセッサ上のサンプル数の解釈を残しておきましょう。ただし、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では</font><font style="vertical-align: inherit;">いくつかの優れたアイデアを見つけることができます。</font><font style="vertical-align: inherit;">この場合、32コアのAMD Ryzen Threadripper 2990WXがあります。</font><font style="vertical-align: inherit;">明らかに、一度に5つの命令を実行するMicro-Up Fusionのプロセッサ機能では、最も高価な命令の後の命令が選択の割り込みの大部分に分類されるため、実際には各サイクルをjneで完了することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、64個の論理プロセッサを備えたマシンは、システムプロセスで7つのコマンドのサイクルで停止する一方で、重要なNTFSロックを保持していることがわかります。これは、システム回復を無効にすることで修正されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コーダ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この特定のマシンでこのコードが正しく動作しなかった理由は明らかではありません。これはどういうわけか、ほとんど空の2 TBディスク上のデータの分散に関連していると思います。システムの回復を再びオンにすると、問題も再発しましたが、それほど深刻ではありませんでした。たぶん、空きスペースの巨大な断片を持つディスクにはある種の病理があるのでしょうか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Twitterの別のフォロワーは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O（n ^ 2）の実行</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を許可するWindows 7のボリュームシャドウコピーのバグについて言及しました</font><font style="vertical-align: inherit;">。このエラーはWindows 8で修正されたとされていますが、何らかの形で保存されている可能性があります。私のスタックトレースは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VspUpperFindNextForwardRunClearLimited</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（この16 MBの領域で使用されているビットを見つける）が</font><i><font style="vertical-align: inherit;">VspUpperFindNextForwardRunClearを</font></i><font style="vertical-align: inherit;">呼び出すことを</font><font style="vertical-align: inherit;">明確に示してい</font><font style="vertical-align: inherit;">ます</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（次の使用済みビットをどこでも検索しますが、指定された領域外の場合は返しません）。もちろん、これはデジャヴのある種の感覚を引き起こします。私が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最近言ったように</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、O（n ^ 2）はスケーラビリティが不十分なアルゴリズムの弱点です。ここで2つの要因が一致します。そのようなコードは、本番環境に入るには十分高速ですが、この本番環境を落とすには十分遅いです。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ファイル</font></a><font style="vertical-align: inherit;">が</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">大量に削除さ</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
れたときに同様の問題が発生するという報告がありましたが</font><font style="vertical-align: inherit;">、私たちのトレースは多くの削除を示していないため、問題は明らかにそうではありません。</font><font style="vertical-align: inherit;">
結論として、記事全体の最初からシステム全体のCPU負荷スケジュールを複製しますが、今回は問題のある</font><i><font style="vertical-align: inherit;">システム</font></i><font style="vertical-align: inherit;">によるCPU使用率を示しています</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（下の緑）。</font><font style="vertical-align: inherit;">そのような写真では、問題は完全に明白です。</font><font style="vertical-align: inherit;">システムプロセスは、上のグラフに技術的に表示されていますが、このスケールでは見落としがちです。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/4fb/ca1/9ff/4fbca19ffabb57dd7f17d40417eee0ca.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題はグラフにはっきりと表示されていますが、実際には何も証明されていません。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼らが言うように</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、相関関係は因果関係ではありません。</font><font style="vertical-align: inherit;">コンテキスト切り替えイベントの分析のみが、クリティカルなロックを保持しているのはこのストリームであることを示しています-そして、ランダムな相関関係だけでなく、実際の原因を見つけたことを確認できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お問い合わせ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いつものように、私はこの調査を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スレッドの名前をわかりやすく</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するための</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">呼び出しで</font></a><font style="vertical-align: inherit;">締めくくってい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。システムプロセスには数十のスレッドがあり、その多くは特別な目的を持っており、名前はありません。このトレースで</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最もビジー</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なシステムスレッドは</font><i><font style="vertical-align: inherit;">MiZeroPageThreadでした</font></i><font style="vertical-align: inherit;">。私は繰り返しスタックに突っ込んで、そのたびに、それが興味のないものであることを思い出しました。 VC ++コンパイラもそのスレッドに名前を付けません。スレッドの名前を変更するのにそれほど時間はかからず、本当に便利です。名前を付けてください。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">簡単</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。 Chromiumに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、プロセス内のストリーム名</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">リスト</font></a><font style="vertical-align: inherit;">するためのツールも含ま</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れています</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MicrosoftのNTFSチームの誰かがこのトピックについて話したい場合は、お知らせください。元のレポートの作成者と連絡を取り、ETWトレースを提供します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オリジナルの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Twitterスレッド</font></font></a><br>
</li>
<li><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Twitter</font></a><font style="vertical-align: inherit;">投稿のお知らせ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
</li>
<li><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ハッカーニュースでの</font></a><font style="vertical-align: inherit;">議論</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
</li>
<li><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Reddit</font></a><font style="vertical-align: inherit;">に関するディスカッション</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おそらく関連する</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Windows / NTFS</font></a><font style="vertical-align: inherit;"> tirade</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472536/index.html">Smart IdReader SDK-PythonとPHPのプロジェクトに埋め込み認識</a></li>
<li><a href="../ja472540/index.html">彼らは起きる！（n.-f.ストーリー、パート2、最後）</a></li>
<li><a href="../ja472542/index.html">米国：PG＆EがテスラLi-Ionドライブを構築します; NorthWesternはガスに依存しています</a></li>
<li><a href="../ja472544/index.html">Pornhubマーケティングの秘訣：今日の最も感動的なウェブサイトが伝えること</a></li>
<li><a href="../ja472548/index.html">市場に行った方法（そして特別なことを達成しなかった方法）</a></li>
<li><a href="../ja472556/index.html">社員の幸せの秘訣はオフィスの自然？</a></li>
<li><a href="../ja472560/index.html">ゲシュタルトテスト：ベイジアン理論と機械学習に基づくメーリングリスト最適化の新しいアプローチ</a></li>
<li><a href="../ja472562/index.html">財務動向：大企業はますます多くのITプロフェッショナルを必要としています</a></li>
<li><a href="../ja472566/index.html">作家フレアマンの個人的な地獄、または初恋の物語</a></li>
<li><a href="../ja472568/index.html">Apache Ignite Zeroデプロイメント：完全にゼロ？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>