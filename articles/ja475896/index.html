<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌸 🧘 💇🏼 フル機能のベアメタルI / Oリアクター 🌊 👨🏽 🌯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 

I / Oリアクター（シングルスレッドイベントループ）は、多くの一般的なソリューションで使用される高負荷のソフトウェアを作成するためのパターンです。
 

- Node.js
- Tor
- 伝染;感染
- クロム
- Memcached
- ...
 

 I/O , , 200 H...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>フル機能のベアメタルI / Oリアクター</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475896/"><p><img src="https://habrastorage.org/webt/2g/w7/vr/2gw7vrlwgzkro-gf3hkbj7jxqzu.png"></p><br>
<h1 id="vvedenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h1><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I / Oリアクター</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（シングルスレッド</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベントループ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）は、多くの一般的なソリューションで使用される高負荷のソフトウェアを作成するためのパターンです。</font></font></p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node.js</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tor</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">伝染;感染</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クロム</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memcached</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font></li>
</ul><br>
<p>      I/O     ,    ,  200      HTTP    40  /.</p><a name="habracut"></a><br>
<h1 id="predislovie"></h1><br>
<ul>
<li>        I/O ,        .</li>
<li>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>      .</li>
<li>        (<strong>:  PDF</strong>) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> C11</a>  Linux    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">GitHub</a>.</li>
</ul><br>
<h1 id="zachem-eto-nuzhno">  ?</h1><br>
<p>    -       ,        :  I/O        I/O       ,   " " (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">epoll</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">kqueue</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">IOCP</a>/etc).</p><br>
<p>          .     :      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>.               .</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a> (thread pool),        ,       :           ,   ,      ,    .</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   </a> ( ),   .          ,    (, )    I/O ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   </a>.        -:</p><br>
<p><img src="https://habrastorage.org/webt/rw/kb/yo/rwkbyokmirpu7hpd6yzc47-k4va.png"></p><br>
<p>      :</p><br>
<ul>
<li> I/O  <strong></strong>   <strong>  </strong>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">IP </a>    (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">TCP</a>,  )              <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">NIC</a> ( ).</li>
<li>  <strong>  </strong>    ,   <strong></strong>  IP  (TCP,  )        <strong></strong>  ( ).</li>
</ul><br>
<p> ,      I/O —    ,    ,      (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">" "</a>).     ,        .</p><br>
<h1 id="model-io-reaktora"> I/O </h1><br>
<p>I/O          .      -:</p><br>
<p><img src="https://habrastorage.org/webt/6j/v9/-m/6jv9-mplsvirwimvaej1zzyu2oa.png"></p><br>
<ul>
<li>,   —    ,        I/O .</li>
<li>  —  ,  I/O    ,     I/O .</li>
</ul><br>
<p> ,  I/O    ,            1 : 1 ,      .</p><br>
<h1 id="realizaciya"></h1><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>reactor.h</code></a>,   —  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>reactor.c</code></a>. <code>reactor.h</code>     :</p><br>
<div class="spoiler"><b class="spoiler_title">   reactor.h</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reactor</span> <span class="hljs-title">Reactor</span>;</span><font></font>
<font></font>
<span class="hljs-comment">/*
 *   ,    I/O   
 *    .
 */</span>
<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*Callback)</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> events)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/*
 *  `NULL`   , -`NULL`   `Reactor` 
 *  .
 */</span>
<span class="hljs-function">Reactor *<span class="hljs-title">reactor_new</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/*
 *   ,      
 *    I/O .
 *
 *    -1   , 0   .
 */</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_destroy</span><span class="hljs-params">(Reactor *reactor)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_register</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Reactor *reactor, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> interest,
                     Callback callback, <span class="hljs-keyword">void</span> *callback_arg)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_deregister</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Reactor *reactor, <span class="hljs-keyword">int</span> fd)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_reregister</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Reactor *reactor, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> interest,
                       Callback callback, <span class="hljs-keyword">void</span> *callback_arg)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/*
 *     - `timeout`.
 *
 *          
 * /    .
 */</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_run</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Reactor *reactor, <span class="hljs-keyword">time_t</span> timeout)</span></span>;</code></pre></div></div><br>
<p> I/O    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">epoll</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">-</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>GHashTable</code></a>,      <code>CallbackData</code> (        ).</p><br>
<div class="spoiler"><b class="spoiler_title"> Reactor  CallbackData</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reactor</span> {</span>
    <span class="hljs-keyword">int</span> epoll_fd;<font></font>
    GHashTable *table; <span class="hljs-comment">// (int, CallbackData)</span><font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span><font></font>
    Callback callback;<font></font>
    <span class="hljs-keyword">void</span> *arg;<font></font>
} CallbackData;</code></pre></div></div><br>
<p> ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>  .  <code>reactor.h</code>    <code>reactor</code>,   <code>reactor.c</code>  ,         .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,     .</p><br>
<p> <code>reactor_register</code>, <code>reactor_deregister</code>  <code>reactor_reregister</code>              -.</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REACTOR_CTL(reactor, op, fd, interest)                                 \
    <span class="hljs-meta-keyword">if</span> (epoll_ctl(reactor-&gt;epoll_fd, op, fd,                                   \
                  &amp;(struct epoll_event){.events = interest,                    \
                                        .data = {.fd = fd}}) == -1) {          \
        perror(<span class="hljs-meta-string">"epoll_ctl"</span>);                                                   \
        return -1;                                                             \
    }</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_register</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Reactor *reactor, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> interest,
                     Callback callback, <span class="hljs-keyword">void</span> *callback_arg)</span> </span>{<font></font>
    REACTOR_CTL(reactor, EPOLL_CTL_ADD, fd, interest)<font></font>
    g_hash_table_insert(reactor-&gt;table, int_in_heap(fd),<font></font>
                        callback_data_new(callback, callback_arg));<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_deregister</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Reactor *reactor, <span class="hljs-keyword">int</span> fd)</span> </span>{<font></font>
    REACTOR_CTL(reactor, EPOLL_CTL_DEL, fd, <span class="hljs-number">0</span>)<font></font>
    g_hash_table_remove(reactor-&gt;table, &amp;fd);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_reregister</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Reactor *reactor, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> interest,
                       Callback callback, <span class="hljs-keyword">void</span> *callback_arg)</span> </span>{<font></font>
    REACTOR_CTL(reactor, EPOLL_CTL_MOD, fd, interest)<font></font>
    g_hash_table_insert(reactor-&gt;table, int_in_heap(fd),<font></font>
                        callback_data_new(callback, callback_arg));<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre></div></div><br>
<p> ,  I/O      <code>fd</code>,     ,    <code>fd</code>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>       <code>void</code>.</p><br>
<div class="spoiler"><b class="spoiler_title">  reactor_run()</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">reactor_run</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Reactor *reactor, <span class="hljs-keyword">time_t</span> timeout)</span> </span>{
    <span class="hljs-keyword">int</span> result;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> *<span class="hljs-title">events</span>;</span>
    <span class="hljs-keyword">if</span> ((events = <span class="hljs-built_in">calloc</span>(MAX_EVENTS, <span class="hljs-keyword">sizeof</span>(*events))) == <span class="hljs-literal">NULL</span>)
        <span class="hljs-built_in">abort</span>();<font></font>
<font></font>
    <span class="hljs-keyword">time_t</span> start = time(<span class="hljs-literal">NULL</span>);<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">time_t</span> passed = time(<span class="hljs-literal">NULL</span>) - start;
        <span class="hljs-keyword">int</span> nfds =<font></font>
            epoll_wait(reactor-&gt;epoll_fd, events, MAX_EVENTS, timeout - passed);<font></font>
<font></font>
        <span class="hljs-keyword">switch</span> (nfds) {
        <span class="hljs-comment">// </span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span>:<font></font>
            perror(<span class="hljs-string">"epoll_wait"</span>);<font></font>
            result = <span class="hljs-number">-1</span>;
            <span class="hljs-keyword">goto</span> cleanup;
        <span class="hljs-comment">//  </span>
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<font></font>
            result = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">goto</span> cleanup;
        <span class="hljs-comment">//  </span>
        <span class="hljs-keyword">default</span>:
            <span class="hljs-comment">//   </span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; nfds; i++) {
                <span class="hljs-keyword">int</span> fd = events[i].data.fd;<font></font>
<font></font>
                CallbackData *callback =<font></font>
                    g_hash_table_lookup(reactor-&gt;table, &amp;fd);<font></font>
                callback-&gt;callback(callback-&gt;arg, fd, events[i].events);<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
cleanup:<font></font>
    <span class="hljs-built_in">free</span>(events);
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre></div></div><br>
<p> ,          :</p><br>
<p><img src="https://habrastorage.org/webt/5r/zj/wu/5rzjwuyiu4e3f-wfvtumltvuz3i.png"></p><br>
<h1 id="odnopotochnyy-server"> </h1><br>
<p>    I/O    ,    HTTP -,     .</p><br>
<div class="spoiler"><b class="spoiler_title">    HTTP</b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">HTTP</a> —   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,       .</p><br>
<p>HTTP      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">TCP</a>,     ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<h3 id="format-zaprosa"> </h3><br>
<pre><code class="plaintext hljs">&lt;&gt; &lt;URI&gt; &lt; HTTP&gt;CRLF<font></font>
&lt; 1&gt;CRLF<font></font>
&lt; 2&gt;CRLF<font></font>
&lt; N&gt;CRLF CRLF<font></font>
&lt;&gt;</code></pre><br>
<ul>
<li><code>CRLF</code> —     : <code>\r</code>  <code>\n</code>,    ,   .</li>
<li><code>&lt;&gt;</code> —   <code>CONNECT</code>, <code>DELETE</code>, <code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>, <code>PATCH</code>, <code>POST</code>, <code>PUT</code>, <code>TRACE</code>.       <code>GET</code>,  "   ".</li>
<li><code>&lt;URI&gt;</code> — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">y  </a>. ,  URI = <code>/index.html</code>,      .</li>
<li><code>&lt; HTTP&gt;</code> —   HTTP   <code>HTTP/X.Y</code>.        — <code>HTTP/1.1</code>.</li>
<li><code>&lt; N&gt;</code> —   -   <code>&lt;&gt;: &lt;&gt;</code>,     .</li>
<li><code>&lt;&gt;</code> — ,     .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">JSON</a>    .</li>
</ul><br>
<h3 id="format-otveta"> </h3><br>
<pre><code class="plaintext hljs">&lt; HTTP&gt; &lt; &gt; &lt; &gt;CRLF<font></font>
&lt; 1&gt;CRLF<font></font>
&lt; 2&gt;CRLF<font></font>
&lt; N&gt;CRLF CRLF<font></font>
&lt;&gt;</code></pre><br>
<ul>
<li><code>&lt; &gt;</code> —  ,    .       200 ( ).</li>
<li><code>&lt; &gt;</code> —    .    200 —  <code>OK</code>.</li>
<li><code>&lt; N&gt;</code> —    ,    .     <code>Content-Length</code> ( )  <code>Content-Type: text/html</code> (  ).</li>
<li><code>&lt;&gt;</code> —   .         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">HTML</a>.</li>
</ul></div></div><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://github.com/Hippolot/reactor-c/blob/master/" rel="nofollow"><code>http_server.c</code></a> ( )   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>common.h</code></a>,     :</p><br>
<div class="spoiler"><b class="spoiler_title">    common.h</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">/*
 *  ,    ,   
 *    .
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">on_accept</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> events)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/*
 *  ,    ,   
 *   HTTP .
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">on_send</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> events)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/*
 *  ,    ,   
 *    HTTP .
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">on_recv</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> events)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/*
 *      .
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set_nonblocking</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/*
 *     stderr     
 *  `EXIT_FAILURE`.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> noreturn <span class="hljs-keyword">void</span> <span class="hljs-title">fail</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, ...)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/*
 *    ,   
 * TCP .
 */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">new_server</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> reuse_port)</span></span>;</code></pre></div></div><br>
<p>    <code>SAFE_CALL()</code>    <code>fail()</code>.      ,    ,   <code>fail()</code>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SAFE_CALL(call, <span class="hljs-meta-keyword">error</span>)                                                 \
    do {                                                                       \
        <span class="hljs-meta-keyword">if</span> ((call) == <span class="hljs-meta-keyword">error</span>) {                                                   \
            fail(<span class="hljs-meta-string">"%s"</span>, #call);                                                 \
        }                                                                      \
    } while (false)</span></code></pre><br>
<p> <code>fail()</code>      ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>printf()</code></a>)       <code>EXIT_FAILURE</code>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> noreturn <span class="hljs-keyword">void</span> <span class="hljs-title">fail</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *format, ...)</span> </span>{<font></font>
    va_list args;<font></font>
    va_start(args, format);<font></font>
    <span class="hljs-built_in">vfprintf</span>(<span class="hljs-built_in">stderr</span>, format, args);<font></font>
    va_end(args);<font></font>
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">": %s\n"</span>, strerror(errno));
    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<font></font>
}</code></pre><br>
<p> <code>new_server()</code>    "" ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>socket()</code></a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>bind()</code></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>listen()</code></a>        .</p><br>
<div class="spoiler"><b class="spoiler_title">  new_server()</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">new_server</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> reuse_port)</span> </span>{
    <span class="hljs-keyword">int</span> fd;<font></font>
    SAFE_CALL((fd = socket(AF_INET, SOCK_STREAM | SOCK_NONBLOCK, IPPROTO_TCP)),<font></font>
              <span class="hljs-number">-1</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (reuse_port) {<font></font>
        SAFE_CALL(<font></font>
            setsockopt(fd, SOL_SOCKET, SO_REUSEPORT, &amp;(<span class="hljs-keyword">int</span>){<span class="hljs-number">1</span>}, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>)),
            <span class="hljs-number">-1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span> = {</span>.sin_family = AF_INET,<font></font>
                               .sin_port = htons(SERVER_PORT),<font></font>
                               .sin_addr = {.s_addr = inet_addr(SERVER_IPV4)},<font></font>
                               .sin_zero = {<span class="hljs-number">0</span>}};<font></font>
<font></font>
    SAFE_CALL(bind(fd, (struct sockaddr *)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr)), <span class="hljs-number">-1</span>);<font></font>
    SAFE_CALL(listen(fd, SERVER_BACKLOG), <span class="hljs-number">-1</span>);
    <span class="hljs-keyword">return</span> fd;<font></font>
}</code></pre></div></div><br>
<ul>
<li> ,           <code>SOCK_NONBLOCK</code>,    <code>on_accept()</code> ( )   <code>accept()</code>    .</li>
<li> <code>reuse_port</code>  <code>true</code>,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>SO_REUSEPORT</code></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>setsockopt()</code></a>,           (  " ").</li>
</ul><br>
<p>  <code>on_accept()</code>   ,     <code>EPOLLIN</code>,    ,      . <code>on_accept()</code>   ,           <code>on_recv()</code>  I/O .</p><br>
<div class="spoiler"><b class="spoiler_title">  on_accept()</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">on_accept</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> events)</span> </span>{
    <span class="hljs-keyword">int</span> incoming_conn;<font></font>
    SAFE_CALL((incoming_conn = accept(fd, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)), <span class="hljs-number">-1</span>);<font></font>
    set_nonblocking(incoming_conn);<font></font>
    SAFE_CALL(reactor_register(reactor, incoming_conn, EPOLLIN, on_recv,<font></font>
                               request_buffer_new()),<font></font>
              <span class="hljs-number">-1</span>);<font></font>
}</code></pre></div></div><br>
<p>  <code>on_recv()</code>   ,     <code>EPOLLIN</code>,    ,  ,  <code>on_accept()</code>,    .</p><br>
<p><code>on_recv()</code>       ,  HTTP     ,     <code>on_send()</code>   HTTP .    ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>close()</code></a>.</p><br>
<div class="spoiler"><b class="spoiler_title">  on_recv()</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">on_recv</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> events)</span> </span>{<font></font>
    RequestBuffer *buffer = arg;<font></font>
<font></font>
    <span class="hljs-comment">//      ,  recv  0  </span>
    <span class="hljs-keyword">ssize_t</span> nread;
    <span class="hljs-keyword">while</span> ((nread = recv(fd, buffer-&gt;data + buffer-&gt;size,<font></font>
                         REQUEST_BUFFER_CAPACITY - buffer-&gt;size, <span class="hljs-number">0</span>)) &gt; <span class="hljs-number">0</span>)<font></font>
        buffer-&gt;size += nread;<font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>) {<font></font>
        SAFE_CALL(reactor_deregister(reactor, fd), <span class="hljs-number">-1</span>);<font></font>
        SAFE_CALL(close(fd), <span class="hljs-number">-1</span>);<font></font>
        request_buffer_destroy(buffer);<font></font>
        <span class="hljs-keyword">return</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// read  ,   ,    </span>
    <span class="hljs-comment">// </span>
    <span class="hljs-keyword">if</span> (errno != EAGAIN &amp;&amp; errno != EWOULDBLOCK) {<font></font>
        request_buffer_destroy(buffer);<font></font>
        fail(<span class="hljs-string">"read"</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   HTTP   .   </span>
    <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">if</span> (request_buffer_is_complete(buffer)) {<font></font>
        request_buffer_clear(buffer);<font></font>
        SAFE_CALL(reactor_reregister(reactor, fd, EPOLLOUT, on_send, buffer),<font></font>
                  <span class="hljs-number">-1</span>);<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>  <code>on_send()</code>   ,     <code>EPOLLOUT</code>, ,  ,  <code>on_recv()</code>,    .    HTTP ,  HTML  , ,        <code>on_recv()</code>.</p><br>
<div class="spoiler"><b class="spoiler_title">  on_send()</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">on_send</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">uint32_t</span> events)</span> </span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *content = <span class="hljs-string">"&lt;img "</span>
                          <span class="hljs-string">"src=\"https://habrastorage.org/webt/oh/wl/23/"</span>
                          <span class="hljs-string">"ohwl23va3b-dioerobq_mbx4xaw.jpeg\"&gt;"</span>;
    <span class="hljs-keyword">char</span> response[<span class="hljs-number">1024</span>];
    <span class="hljs-built_in">sprintf</span>(response,
            <span class="hljs-string">"HTTP/1.1 200 OK"</span> CRLF <span class="hljs-string">"Content-Length: %zd"</span> CRLF <span class="hljs-string">"Content-Type: "</span>
            <span class="hljs-string">"text/html"</span> DOUBLE_CRLF <span class="hljs-string">"%s"</span>,
            <span class="hljs-built_in">strlen</span>(content), content);<font></font>
<font></font>
    SAFE_CALL(send(fd, response, <span class="hljs-built_in">strlen</span>(response), <span class="hljs-number">0</span>), <span class="hljs-number">-1</span>);<font></font>
    SAFE_CALL(reactor_reregister(reactor, fd, EPOLLIN, on_recv, arg), <span class="hljs-number">-1</span>);<font></font>
}</code></pre></div></div><br>
<p> ,   <code>http_server.c</code>,   <code>main()</code>   I/O   <code>reactor_new()</code>,      ,     <code>reactor_run()</code>    ,        .</p><br>
<div class="spoiler"><b class="spoiler_title"> http_server.c</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"reactor.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">static</span> Reactor *reactor;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"common.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
    SAFE_CALL((reactor = reactor_new()), <span class="hljs-literal">NULL</span>);<font></font>
    SAFE_CALL(<font></font>
        reactor_register(reactor, new_server(<span class="hljs-literal">false</span>), EPOLLIN, on_accept, <span class="hljs-literal">NULL</span>),
        <span class="hljs-number">-1</span>);<font></font>
    SAFE_CALL(reactor_run(reactor, SERVER_TIMEOUT_MILLIS), <span class="hljs-number">-1</span>);<font></font>
    SAFE_CALL(reactor_destroy(reactor), <span class="hljs-number">-1</span>);<font></font>
}</code></pre></div></div><br>
<p>,     .  (<code>chmod a+x compile.sh &amp;&amp; ./compile.sh</code>   )    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://127.0.0.1:18470</a>     ,   :</p><br>
<p><img src="https://habrastorage.org/webt/i0/za/5u/i0za5um7tbcnzqt2x7sp_vey0p8.png"></p><br>
<h1 id="zamer-proizvoditelnosti"> </h1><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="plaintext hljs">$ screenfetch<font></font>
 MMMMMMMMMMMMMMMMMMMMMMMMMmds+.        OS: Mint 19.1 tessa<font></font>
 MMm----::-://////////////oymNMd+`     Kernel: x86_64 Linux 4.15.0-20-generic<font></font>
 MMd      /++                -sNMd:    Uptime: 2h 34m<font></font>
 MMNso/`  dMM    `.::-. .-::.` .hMN:   Packages: 2217<font></font>
 ddddMMh  dMM   :hNMNMNhNMNMNh: `NMm   Shell: bash 4.4.20<font></font>
     NMm  dMM  .NMN/-+MMM+-/NMN` dMM   Resolution: 1920x1080<font></font>
     NMm  dMM  -MMm  `MMM   dMM. dMM   DE: Cinnamon 4.0.10<font></font>
     NMm  dMM  -MMm  `MMM   dMM. dMM   WM: Muffin<font></font>
     NMm  dMM  .mmd  `mmm   yMM. dMM   WM Theme: Mint-Y-Dark (Mint-Y)<font></font>
     NMm  dMM`  ..`   ...   ydm. dMM   GTK Theme: Mint-Y [GTK2/3]<font></font>
     hMM- +MMd/-------...-:sdds  dMM   Icon Theme: Mint-Y<font></font>
     -NMm- :hNMNNNmdddddddddy/`  dMM   Font: Noto Sans 9<font></font>
      -dMNs-``-::::-------.``    dMM   CPU: Intel Core i7-6700 @ 8x 4GHz [52.0°C]<font></font>
       `/dMNmy+/:-------------:/yMMM   GPU: NV136<font></font>
          ./ydNMMMMMMMMMMMMMMMMMMMMM   RAM: 2544MiB / 7926MiB<font></font>
             \.MMMMMMMMMMMMMMMMMMM</code></pre></div></div><br>
<p>   .   :    <code>./http_server</code>,   — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">wrk</a>.        :</p><br>
<pre><code class="plaintext hljs">$ wrk -c100 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive"<font></font>
Running 1m test @ http://127.0.0.1:18470<font></font>
  8 threads and 100 connections<font></font>
  Thread Stats   Avg      Stdev     Max   +/- Stdev<font></font>
    Latency   493.52us   76.70us  17.31ms   89.57%<font></font>
    Req/Sec    24.37k     1.81k   29.34k    68.13%<font></font>
  11657769 requests in 1.00m, 1.60GB read<font></font>
Requests/sec: 193974.70<font></font>
Transfer/sec:     27.19MB</code></pre><br>
<p>      11    ,   100 .  ,     ?</p><br>
<h1 id="mnogopotochnyy-server"> </h1><br>
<p>   , I/O      ,      .     :</p><br>
<div class="spoiler"><b class="spoiler_title"> http_server_multithreaded.c</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"reactor.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">static</span> Reactor *reactor;
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> omp threadprivate(reactor)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"common.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> omp parallel</span><font></font>
    {<font></font>
        SAFE_CALL((reactor = reactor_new()), <span class="hljs-literal">NULL</span>);<font></font>
        SAFE_CALL(reactor_register(reactor, new_server(<span class="hljs-literal">true</span>), EPOLLIN,<font></font>
                                   on_accept, <span class="hljs-literal">NULL</span>),
                  <span class="hljs-number">-1</span>);<font></font>
        SAFE_CALL(reactor_run(reactor, SERVER_TIMEOUT_MILLIS), <span class="hljs-number">-1</span>);<font></font>
        SAFE_CALL(reactor_destroy(reactor), <span class="hljs-number">-1</span>);<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a> :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> Reactor *reactor;
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> omp threadprivate(reactor)</span></code></pre><br>
<p>   ,    <code>new_server()</code>  <code>true</code>.  ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><code>SO_REUSEPORT</code></a>,      .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<h1 id="vtoroy-zahod"> </h1><br>
<p>    :</p><br>
<pre><code class="plaintext hljs">$ wrk -c100 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive"<font></font>
Running 1m test @ http://127.0.0.1:18470<font></font>
  8 threads and 100 connections<font></font>
  Thread Stats   Avg      Stdev     Max   +/- Stdev<font></font>
    Latency     1.14ms    2.53ms  40.73ms   89.98%<font></font>
    Req/Sec    79.98k    18.07k  154.64k    78.65%<font></font>
  38208400 requests in 1.00m, 5.23GB read<font></font>
Requests/sec: 635876.41<font></font>
Transfer/sec:     89.14MB</code></pre><br>
<p>    1    ~3.28 !        ~ ,   .</p><br>
<p>   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">perf</a>:</p><br>
<pre><code class="plaintext hljs">$ sudo perf stat -B -e task-clock,context-switches,cpu-migrations,page-faults,cycles,instructions,branches,branch-misses,cache-misses ./http_server_multithreaded<font></font>
<font></font>
 Performance counter stats for './http_server_multithreaded':<font></font>
<font></font>
     242446,314933      task-clock (msec)         #    4,000 CPUs utilized          <font></font>
         1 813 074      context-switches          #    0,007 M/sec                  <font></font>
             4 689      cpu-migrations            #    0,019 K/sec                  <font></font>
               254      page-faults               #    0,001 K/sec                  <font></font>
   895 324 830 170      cycles                    #    3,693 GHz                    <font></font>
   621 378 066 808      instructions              #    0,69  insn per cycle         <font></font>
   119 926 709 370      branches                  #  494,653 M/sec                  <font></font>
     3 227 095 669      branch-misses             #    2,69% of all branches        <font></font>
           808 664      cache-misses                                                <font></font>
<font></font>
      60,604330670 seconds time elapsed</code></pre><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a>,   <code>-march=native</code>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">PGO</a>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>,  <code>MAX_EVENTS</code>   <code>EPOLLET</code>      .   ,     ?</p><br>
<p>  352  :</p><br>
<pre><code class="plaintext hljs">$ wrk -c352 -d1m -t8 http://127.0.0.1:18470 -H "Host: 127.0.0.1:18470" -H "Accept-Language: en-US,en;q=0.5" -H "Connection: keep-alive"<font></font>
Running 1m test @ http://127.0.0.1:18470<font></font>
  8 threads and 352 connections<font></font>
  Thread Stats   Avg      Stdev     Max   +/- Stdev<font></font>
    Latency     2.12ms    3.79ms  68.23ms   87.49%<font></font>
    Req/Sec    83.78k    12.69k  169.81k    83.59%<font></font>
  40006142 requests in 1.00m, 5.48GB read<font></font>
Requests/sec: 665789.26<font></font>
Transfer/sec:     93.34MB</code></pre><br>
<p>  ,       ,       1    :</p><br>
<p><img src="https://habrastorage.org/webt/od/8c/lv/od8clvvdlprsdcmslba9fz_rmmq.png"></p><br>
<p>,              (     ).      TCP/IP  Linux?                .</p><br>
<hr><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  ,       I/O    ,       ,  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">TLS</a>  ..,      ().           I/O .</p><br>
<h1 id="nedostatki-io-reaktora"> I/O </h1><br>
<p> ,  I/O    ,  :</p><br>
<ul>
<li> I/O      , ..    .</li>
<li> ,      ,     ,     ,     .</li>
<li>     ,       ,      .</li>
</ul><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">I/O </a>,   ,       ,        API.     ,    .</p><br>
<h1 id="zaklyuchenie"></h1><br>
<p>            .</p><br>
<p>    ,                  . ,   ,   .</p><br>
<p>  !</p><br>
<h1 id="interesnye-proekty"> </h1><br>
<ul>
<li><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">libevent</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">libev</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">libuv</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">libevhtp</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">liburing</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">DPDK</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">netmap</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">PF_RING</a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Rust</a><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Mio</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Tokio</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">smoltcp</a></li>
</ul></li>
</ul><br>
<h1 id="chto-eschyo-pochitat">  ?</h1><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://linux.die.net/man/7/socket</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://stackoverflow.com/questions/1050222/what-is-the-difference-between-concurrency-and-parallelism</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">http://www.kegel.com/c10k.html</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://kernel.dk/io_uring.pdf</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://aturon.github.io/blog/2016/09/07/futures-design/</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://tokio.rs/blog/2019-10-scheduler/</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://www.artima.com/articles/io_design_patterns.html</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://habr.com/en/post/183832/</a></li>
</ul><br></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja475884/index.html">グラデーションのギザギザ線の問題を解決する</a></li>
<li><a href="../ja475886/index.html">Amazon AIは、ユーザーのわいせつなコンテンツへの取り組みを容易にします</a></li>
<li><a href="../ja475888/index.html">クラウドの顔認識の利点</a></li>
<li><a href="../ja475892/index.html">オフィスでのランチの注文を改善した方法（サーバーにアクセスできない場合）</a></li>
<li><a href="../ja475894/index.html">3パスプロトコル</a></li>
<li><a href="../ja475900/index.html">最新の6つのAzureコース</a></li>
<li><a href="../ja475902/index.html">ワークフローコア-.Net Coreのビジネスプロセスエンジン</a></li>
<li><a href="../ja475904/index.html">新しいマネージャーのための5つのメモ</a></li>
<li><a href="../ja475908/index.html">ロシアで最も人気のあるマイクロソフトコース10</a></li>
<li><a href="../ja475912/index.html">イーサネットネットワークの暗号化デバイスを評価および比較する方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>