<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💇🏽 🤜🏻 ☸️ FreeBSDでのpostfix + dovecot + mysql 👩‍🏫 🤵 🙍🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 長い間メールサーバーを勉強したかったのですが、手が届かなくなってしまい、なかなか正しい情報を見つけることができなかったので、なるべく詳細な出版物を書くことにしました。このパブリケーションでは、postfix、dovecot、mysql、postfixadminだけでなく、spamassas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>FreeBSDでのpostfix + dovecot + mysql</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476148/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長い間メールサーバーを勉強したかったのですが、手が届かなくなってしまい、なかなか正しい情報を見つけることができなかったので、なるべく詳細な出版物を書くことにしました。</font><font style="vertical-align: inherit;">このパブリケーションでは、postfix、dovecot、mysql、postfixadminだけでなく、spamassassin、clamav-milter（メールサーバー用のclamavの特別バージョン）、postgrey、およびスパムをSpamフォルダーに転送する可能性（dovecot-ピジョンホール）。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、作業に必要なパッケージをインストールします（postfix、dovecotおよびdovecot-pigeonholeはポートからインストールする必要があります。dovecot-sieveは原則としてパッケージからインストールできますが、新しいバージョンがポートにあり、このため、dovecotとdovecot-の間に互換性がない場合があります。ふるい）。</font><font style="vertical-align: inherit;">次のパッケージをインストールします。</font></font><br>
<br>
<pre><code class="plaintext hljs">pkg install apache24 php73 mod_php73 php73-extensions php73-mysqli php73-mbstring php73-openssl clamav-milter postgrey spamassassin mysql57-server openssl wget
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インストール後、必要なサービスを自動実行します。</font></font><br>
<br>
<pre><code class="plaintext hljs">#postfix  dovecot  ,      <font></font>
sysrc postfix_enable="YES"<font></font>
sysrc dovecot_enable="YES"<font></font>
<font></font>
sysrc mysql_enable="YES"<font></font>
sysrc apache24_enable="YES"<font></font>
<font></font>
sysrc spamd_flags="-u spamd -H /var/spool/spamd"<font></font>
sysrc spamd_enable="YES"<font></font>
<font></font>
sysrc postgrey_enable="YES"<font></font>
<font></font>
sysrc clamav_clamd_enable="YES"<font></font>
sysrc clamav_milter_enable="YES"<font></font>
sysrc clamav_freshclam_enable="YES"<font></font>
#freshclam        12 <font></font>
sysrc clamav_freshclam_flags="--daemon --checks=12"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスを実行します。</font></font><br>
<br>
<pre><code class="plaintext hljs">service apache24 start<font></font>
service mysql-server start<font></font>
#  spamassassin      <font></font>
sa-update<font></font>
sa-compile<font></font>
service sa-spamd start<font></font>
#   clamav  <font></font>
freshclam<font></font>
service clamav-clamd start<font></font>
service clamav-freshclam start<font></font>
service clamav-milter start<font></font>
#  postgrey    (/usr/local/etc/rc.d/postgrey),       ""   4-   ,    : ${postgrey_flags:=--inet=10023}     :<font></font>
: ${postgrey_flags:=--inet=10023 --auto-whitelist-clients=4}<font></font>
service postgrey start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
phpがApacheで動作し、postfixadminが正しく動作するために必要な行をhttpd.confに追加することを忘れないでください。</font></font><br>
<br>
<pre><code class="plaintext hljs">&lt;FilesMatch "\.php$"&gt;<font></font>
    SetHandler application/x-httpd-php<font></font>
&lt;/FilesMatch&gt;<font></font>
&lt;FilesMatch "\.phps$"&gt;<font></font>
    SetHandler application/x-httpd-php-source<font></font>
&lt;/FilesMatch&gt;<font></font>
<font></font>
&lt;IfModule dir_module&gt;<font></font>
    DirectoryIndex index.php<font></font>
&lt;/IfModule&gt;<font></font>
<font></font>
#         postfixadmin<font></font>
<font></font>
DocumentRoot "/usr/local/www/apache24/data/postfixadmin-3.2/public"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ディレクトリに移動してpostfixadminをダウンロードします</font></font><br>
<br>
<pre><code class="plaintext hljs">cd /usr/local/www/apache24/data
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
postfixadminをダウンロード（執筆時点では、現在のバージョンは3.2でした）</font></font><br>
<br>
<pre><code class="plaintext hljs">wget --no-check-certificate https://sourceforge.net/projects/postfixadmin/files/postfixadmin/postfixadmin-3.2/postfixadmin-3.2.tar.gz
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、アーカイブをこのディレクトリに解凍し、ディレクトリの所有者を変更する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">gzip -d postfixadmin-3.2.tar.gz<font></font>
tar -xvf postfixadmin-3.2.tar<font></font>
chown -R www:www /usr/local/www/apache24/data<font></font>
service apache24 restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、postfixadminのデータベースを準備し、mysql-secure-installationスクリプトを実行します（このスクリプトで作成するパスワードは、alter userコマンドを使用してmysqlで作成する必要があります）。mysqlの初期設定で、mysqlと入力して、データベースと権限を作成します。彼女のために：</font></font><br>
<br>
<pre><code class="plaintext hljs">mysql -p -r<font></font>
alter user 'root'@'localhost' identified by 'password123';<font></font>
create database postfix;<font></font>
grant all privileges on postfix.* to 'postfix'@'localhost' identified by 'password123';<font></font>
exit<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースを構成したら、config.inc.phpファイルを編集する必要があります。この例では、このファイルは/usr/local/www/apache24/data/postfixadmin-3.2/ディレクトリにあります。このファイルでは、いくつかの行を編集して、設定を変更した後、Apacheを再起動してください。/usr/local/www/apache24/data/postfixadmin-3.2ディレクトリにtemplates_cディレクトリを作成し、それにwww所有者を割り当てる必要もあります。</font></font><br>
<br>
<pre><code class="plaintext hljs">mkdir /usr/local/www/apache24/data/postfixadmin-3.2/templates_c<font></font>
chown -R www:www /usr/local/www/apache24/data/postfixadmin-3.2/templates_c<font></font>
<font></font>
$CONF['configured'] = true<font></font>
#       postfixadmin     .<font></font>
$CONF['setup_password'] = 'dd28fb2139a3bca426f02f60e6877fd5:13d2703c477b0ab85858e3ac5e076a0a7a477315';<font></font>
$CONF['default_language'] = 'ru'<font></font>
$CONF['database_type'] = 'mysqli';<font></font>
$CONF['database_host'] = 'localhost';<font></font>
$CONF['database_user'] = 'postfix';<font></font>
#          <font></font>
$CONF['database_password'] = 'password123';<font></font>
$CONF['database_name'] = 'postfix';<font></font>
<font></font>
service apache24 restart<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーを生成するには、postfix.orgで提案されている方法を使用します。独自の認証局を作成し、/ etc / sslディレクトリに移動してスクリプトを実行する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">cd /etc/ssl<font></font>
/usr/local/openssl/misc/CA.pl -newca<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトの実行中に、証明書の名前が要求されます。何も入力せずにEnterキーを押すと、スクリプトによって証明書のパスワードを作成するように求められます。その後、証明書を作成するための標準的な質問があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、秘密鍵（パスワードなし）と署名されていない公開鍵証明書を作成する必要があります（組織単位名（セクションなど）[]は、上記で作成した証明書で指定されているものとは異なる必要があります）：</font></font><br>
<br>
<pre><code class="plaintext hljs">openssl req -new -newkey rsa:4096 -nodes -keyout foo-key.pem -out foo-req.pem
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
公開鍵証明書に署名します（必要な日数を指定してください）：</font></font><br>
<br>
<pre><code class="plaintext hljs">openssl ca -out foo-cert.pem -days 365 -infiles foo-req.pem
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作成した証明書をこのディレクトリに残すか、より便利なディレクトリに転送します。証明書がこのディレクトリにあるという事実を考慮して、「postfix」および「dovecote」の設定が構成されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vmailユーザー</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
postfix、dovecot、dovecot-pigeonholeのインストールを開始する前に、ユーザーとグループ（グループは自動的に作成されます）vmail、およびメールが配置されるディレクトリを作成します。 </font></font><br>
<br>
<pre><code class="plaintext hljs">pw useradd -n vmail -s /usr/sbin/nologin -u 1000 -d /var/vmail
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メール用のディレクトリを作成し、vmailユーザーの所有者を設定します。</font></font><br>
<br>
<pre><code class="plaintext hljs">mkdir /var/vmail<font></font>
chown -R vmail:vmail /var/vmail<font></font>
chmod -R 744 /var/vmail<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postfix、dovecot、dovecot-pigeonhole</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前に書いたように、ポートからアプリケーションデータをアセンブルし、コマンドを実行してポートをダウンロードして解凍します。</font></font><br>
<br>
<pre><code class="plaintext hljs">portsnap fetch extract
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポートを解凍した後、dovecotディレクトリに移動し、ポートを構成し（mysqlのサポートに注意）、ビルドを実行します（BATCH = yesは、インストール中に質問しないようにmakeに指示します）。</font></font><br>
<br>
<pre><code class="plaintext hljs">cd /usr/ports/mail/dovecot<font></font>
make config<font></font>
make BATCH=yes install clean<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
postfixとdovecot </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-pigeonhole dovecot-pigeonholeでも</font><font style="vertical-align: inherit;">同じようにします</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">cd /usr/ports/mail/dovecot-pigeonhole<font></font>
make BATCH=yes install clean<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
postfix：ポート設定のmysqlサポートも確認してください</font></font><br>
<br>
<pre><code class="plaintext hljs">cd  /usr/ports/mail/postfix-sasl<font></font>
make config<font></font>
make BATCH=yes install clean<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dovecotを開始する前に、 "configs"をコピーします：</font></font><br>
<br>
<pre><code class="plaintext hljs"> cp -R /usr/local/etc/dovecot/example-config/*  /usr/local/etc/dovecot
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
postfixとdovecotをインストールしたら、サービスを開始します。</font></font><br>
<br>
<pre><code class="plaintext hljs">service postfix start<font></font>
service dovecot start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スパムをspamフォルダーに送信するためのモジュールがコンパイルされるディレクトリを作成することも必要です。私の場合、このディレクトリは/usr/local/etc/dovecot/conf.dフォルダーにあり、ディレクトリ名はdefです。このディレクトリとコンパイル用のコードを含むファイルを作成します指定されたvmailユーザーディレクトリの所有者を設定します。</font></font><br>
<br>
<pre><code class="plaintext hljs">mkdir /usr/local/etc/dovecot/conf.d/def<font></font>
touch /usr/local/etc/dovecot/conf.d/def/default.sieve<font></font>
chown -R vmail:vmail /usr/local/etc/dovecot/conf.d/def<font></font>
chmod -R 744 /usr/local/etc/dovecot/conf.d/def<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このファイルに行を配置します。</font></font><br>
<br>
<pre><code class="plaintext hljs">require "fileinto";<font></font>
if header :contains "X-Spam-Flag" "YES" {<font></font>
    fileinto "Junk";<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このセクションでは、コメントが含まれている「構成」の例を示します。spamassassinの「構成」のみを疑います。ネットワーク上に正しい説明が見つからなかったため（デフォルトでは「構成」のままにしました）、spamassassinをより適切に構成する方法をコメントに追加してください。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postfix</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、データベースからユーザー、ドメイン、クォータを取得するためのファイルを作成する必要があります。</font><font style="vertical-align: inherit;">データファイルと必要なファイルを格納するディレクトリを作成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">mkdir /usr/local/etc/postfix/mysql<font></font>
touch /usr/local/etc/postfix/mysql/relay_domains.cf<font></font>
touch /usr/local/etc/postfix/mysql/virtual_alias_maps.cf<font></font>
touch /usr/local/etc/postfix/mysql/virtual_alias_domain_maps.cf<font></font>
touch /usr/local/etc/postfix/mysql/virtual_mailbox_maps.cf<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのファイルの内容は、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
relay_domains.cfに</font><font style="vertical-align: inherit;">なります。</font></font><br>
<br>
<pre><code class="plaintext hljs">hosts = 127.0.0.1<font></font>
user = postfix<font></font>
password = password123<font></font>
dbname = postfix<font></font>
query = SELECT domain FROM domain WHERE domain='%s' and backupmx = '1'<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
virtual_alias_maps.cf</font></font><br>
<br>
<pre><code class="plaintext hljs">hosts = 127.0.0.1<font></font>
user = postfix<font></font>
password = password123<font></font>
dbname = postfix<font></font>
query = SELECT goto FROM alias WHERE address='%s' AND active ='1'<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
virtual_alias_domain_maps.cf</font></font><br>
<br>
<pre><code class="plaintext hljs">hosts = 127.0.0.1<font></font>
user = postfix<font></font>
password = password123<font></font>
dbname = postfix<font></font>
query = SELECT goto FROM alias,alias_domain WHERE alias_domain.alias_domain = '%d' and alias.address = CONCAT('%u', '@', alias_domain.target_domain) AND alias.active = '1'<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
virtual_mailbox_maps.cf</font></font><br>
<br>
<pre><code class="plaintext hljs">hosts = 127.0.0.1<font></font>
user = postfix<font></font>
password = password123<font></font>
dbname = postfix<font></font>
query = SELECT maildir FROM mailbox WHERE username='%s' AND  active = '1'<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
master.cf</font></font><br>
<br>
<pre><code class="plaintext hljs"># postfix  ,    dovecot   <font></font>
dovecot unix - n n - - pipe<font></font>
    flags=DRhu user=vmail:vmail argv=/usr/local/libexec/dovecot/deliver -f ${sender} -d ${recipient}<font></font>
<font></font>
#  smtpd     sasl,    ,  spamassassin   <font></font>
smtp      inet  n       -       n       -       -       smtpd<font></font>
  -o content_filter=spamassassin<font></font>
  -o smtpd_sasl_auth_enable=yes<font></font>
<font></font>
#  587     sasl<font></font>
submission inet n       -       n       -       -       smtpd<font></font>
 -o smtpd_sasl_auth_enable=yes<font></font>
<font></font>
#  smtp    SASL<font></font>
smtps     inet  n       -       n       -       -       smtpd<font></font>
  -o smtpd_sasl_auth_enable=yes<font></font>
  -o smtpd_tls_wrappermode=yes<font></font>
<font></font>
# Spamassassin<font></font>
spamassassin   unix  -       n       n       -       -       pipe<font></font>
   flags=DROhu user=vmail:vmail argv=/usr/local/bin/spamc -f -e<font></font>
   /usr/local/libexec/dovecot/deliver -f ${sender} -d ${user}@${nexthop}<font></font>
<font></font>
#628       inet  n       -       n       -       -       qmqpd<font></font>
pickup    unix  n       -       n       60      1       pickup<font></font>
cleanup   unix  n       -       n       -       0       cleanup<font></font>
qmgr      unix  n       -       n       300     1       qmgr<font></font>
#qmgr     unix  n       -       n       300     1       oqmgr<font></font>
tlsmgr    unix  -       -       n       1000?   1       tlsmgr<font></font>
rewrite   unix  -       -       n       -       -       trivial-rewrite<font></font>
bounce    unix  -       -       n       -       0       bounce<font></font>
defer     unix  -       -       n       -       0       bounce<font></font>
trace     unix  -       -       n       -       0       bounce<font></font>
verify    unix  -       -       n       -       1       verify<font></font>
flush     unix  n       -       n       1000?   0       flush<font></font>
proxymap  unix  -       -       n       -       -       proxymap<font></font>
proxywrite unix -       -       n       -       1       proxymap<font></font>
smtp      unix  -       -       n       -       -       smtp<font></font>
relay     unix  -       -       n       -       -       smtp<font></font>
        -o syslog_name=postfix/$service_name<font></font>
#       -o smtp_helo_timeout=5 -o smtp_connect_timeout=5<font></font>
showq     unix  n       -       n       -       -       showq<font></font>
error     unix  -       -       n       -       -       error<font></font>
retry     unix  -       -       n       -       -       error<font></font>
discard   unix  -       -       n       -       -       discard<font></font>
local     unix  -       n       n       -       -       local<font></font>
virtual   unix  -       n       n       -       -       virtual<font></font>
lmtp      unix  -       -       n       -       -       lmtp<font></font>
anvil     unix  -       -       n       -       1       anvil<font></font>
scache    unix  -       -       n       -       1       scache<font></font>
postlog   unix-dgram n  -       n       -       1       postlogd<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
main.cf</font></font><br>
<br>
<pre><code class="plaintext hljs">#       dovecot,      <font></font>
local_transport = dovecot<font></font>
<font></font>
#      ,  SMTP-      EHLO  SMTP <font></font>
smtpd_discard_ehlo_keywords = CONNECT GET POST<font></font>
<font></font>
#           <font></font>
smtpd_delay_reject = yes<font></font>
<font></font>
#    <font></font>
smtpd_helo_required = yes<font></font>
<font></font>
#     ,  <font></font>
disable_vrfy_command = yes<font></font>
<font></font>
#      <font></font>
broken_sasl_auth_clients = yes<font></font>
<font></font>
#  <font></font>
smtpd_sasl_security_options = noanonymous noactive nodictionary<font></font>
smtp_sasl_security_options = noanonymous noactive nodictionary<font></font>
<font></font>
# dovecot  (  cyrus)<font></font>
smtpd_sasl_type = dovecot<font></font>
smtp_sasl_type = dovecot<font></font>
<font></font>
#   <font></font>
smtpd_sasl_path = private/auth<font></font>
<font></font>
#  <font></font>
local_recipient_maps = $virtual_mailbox_maps $virtual_alias_maps<font></font>
<font></font>
#   ,   <font></font>
smtpd_reject_unlisted_recipient = yes<font></font>
<font></font>
#  <font></font>
message_size_limit = 10485760<font></font>
<font></font>
#     spamassassin<font></font>
spamassassin_destination_recipient_limit = 1<font></font>
<font></font>
#<font></font>
milter_default_action = accept<font></font>
milter_protocol = 2<font></font>
#   clamav<font></font>
smtpd_milters = unix:/var/run/clamav/clmilter.sock<font></font>
non_smtpd_milters = unix:/var/run/clamav/clmilter.sock<font></font>
<font></font>
<font></font>
#MYSQL<font></font>
relay_domains = mysql:/usr/local/etc/postfix/mysql/relay_domains.cf<font></font>
virtual_alias_maps = mysql:/usr/local/etc/postfix/mysql/virtual_alias_maps.cf, mysql:/usr/local/etc/postfix/mysql/virtual_alias_domain_maps.cf<font></font>
virtual_mailbox_maps = mysql:/usr/local/etc/postfix/mysql/virtual_mailbox_maps.cf<font></font>
<font></font>
# HELO<font></font>
smtpd_helo_restrictions = permit_sasl_authenticated, reject_non_fqdn_helo_hostname, reject_invalid_hostname<font></font>
<font></font>
#   <font></font>
smtpd_data_restrictions = permit_sasl_authenticated reject_unauth_pipelining, reject_multi_recipient_bounce<font></font>
<font></font>
#  <font></font>
smtpd_sender_restrictions = permit_sasl_authenticated reject_sender_login_mismatch,reject_unauthenticated_sender_login_mismatch, reject_non_fqdn_sender, reject_unknown_sender_domain<font></font>
<font></font>
#  (check_policy_service inet:127.0.0.1:10023  postgrey -      )<font></font>
smtpd_recipient_restrictions = permit_sasl_authenticated reject_non_fqdn_recipient, reject_unknown_recipient_domain, reject_multi_recipient_bounce, reject_unknown_client_hostname, reject_unauth_destination, check_policy_service inet:127.0.0.1:10023<font></font>
<font></font>
<font></font>
#  <font></font>
virtual_mailbox_base = /var/vmail<font></font>
<font></font>
#uid  gid vmail<font></font>
virtual_minimum_uid = 1000<font></font>
virtual_uid_maps = static:1000<font></font>
virtual_gid_maps = static:1000<font></font>
<font></font>
#  <font></font>
virtual_transport = devecot<font></font>
dovecot_destination_recipient_limit = 1<font></font>
<font></font>
<font></font>
# <font></font>
smtp_use_tls=yes<font></font>
smtp_tls_note_starttls_offer=yes<font></font>
# smtp_tls_security_level=encrypt       ssl,        ssl,    smtp_tls_security_level=may(    ssl,     )<font></font>
smtp_tls_security_level=encrypt<font></font>
smtp_tls_session_cache_database=btree:$data_directory/smtp_tls_session_cache<font></font>
smtp_tls_CAfile=/etc/ssl/demoCA/cacert.pem<font></font>
smtp_tls_key_file=/etc/ssl/foo-key.pem<font></font>
smtp_tls_cert_file=/etc/ssl/foo-cert.pem<font></font>
smtp_tls_session_cache_timeout=3600s<font></font>
smtp_tls_protocols=!TLSv1.2<font></font>
smtp_tls_loglevel=1<font></font>
<font></font>
# smtpd_tls_security_level=encrypt       ssl,        ssl,    smtpd_tls_security_level=may(    ssl,     )<font></font>
smtpd_tls_security_level=encrypt<font></font>
smtpd_use_tls=yes<font></font>
smtpd_tls_auth_only=yes<font></font>
smtpd_tls_loglevel=1<font></font>
smtpd_tls_received_header=yes<font></font>
smtpd_tls_session_cache_timeout=3600s<font></font>
smtpd_tls_session_cache_database=btree:$data_directory/smtpd_tls_session_cache<font></font>
smtpd_tls_key_file=/etc/ssl/foo-key.pem<font></font>
smtpd_tls_cert_file=/etc/ssl/foo-cert.pem<font></font>
smtpd_tls_CAfile= /etc/ssl/demoCA/cacert.pem<font></font>
smtpd_tls_protocols=!TLSv1.2<font></font>
<font></font>
#     <font></font>
tls_random_source=dev:/dev/urandom<font></font>
<font></font>
# <font></font>
compatibility_level = 2<font></font>
<font></font>
#   ,    ,      ,   <font></font>
soft_bounce = no<font></font>
<font></font>
#   UNIX       postfix<font></font>
mail_owner = postfix<font></font>
<font></font>
#     postfix(        )<font></font>
myhostname = $mydomain<font></font>
<font></font>
#      <font></font>
mydomain = virusslayer.su<font></font>
myorigin = $myhostname<font></font>
<font></font>
#   <font></font>
inet_interfaces = all<font></font>
<font></font>
#       <font></font>
mydestination = $mydomain, localhost, localhost.$mydomain<font></font>
<font></font>
#   550        <font></font>
unknown_local_recipient_reject_code = 550<font></font>
<font></font>
#    localhost<font></font>
mynetworks_style = host<font></font>
<font></font>
#       , -        <font></font>
mynetworks =<font></font>
<font></font>
#  ip<font></font>
inet_protocols = ipv4<font></font>
<font></font>
#  (   )<font></font>
alias_maps = hash:/etc/mail/aliases<font></font>
alias_database = dbm:/etc/mail/aliases.db<font></font>
<font></font>
#         <font></font>
smtpd_banner = $myhostname ESMTP $mail_name<font></font>
<font></font>
#      <font></font>
debug_peer_level = 2<font></font>
<font></font>
#      (   ,    yandex.ru gmail.ru mail.ru  ..)<font></font>
debug_peer_list = 127.0.0.1<font></font>
<font></font>
#  <font></font>
debugger_command =<font></font>
         PATH=/bin:/usr/bin:/usr/local/bin:/usr/X11R6/bin<font></font>
         ddd $daemon_directory/$process_name $process_id &amp; sleep 5<font></font>
<font></font>
#  sendmail<font></font>
sendmail_path = /usr/local/sbin/sendmail<font></font>
mailq_path = /usr/local/bin/mailq<font></font>
<font></font>
<font></font>
setgid_group = maildrop<font></font>
<font></font>
#   <font></font>
html_directory = /usr/local/share/doc/postfix<font></font>
manpage_directory = /usr/local/man<font></font>
sample_directory = /usr/local/etc/postfix<font></font>
readme_directory = /usr/local/share/doc/postfix<font></font>
meta_directory = /usr/local/libexec/postfix<font></font>
shlib_directory = /usr/local/lib/postfix<font></font>
queue_directory = /var/spool/postfix<font></font>
command_directory = /usr/local/sbin<font></font>
daemon_directory = /usr/local/libexec/postfix<font></font>
data_directory = /var/db/postfix<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドコット</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dovecot.conf</font></font><br>
<br>
<pre><code class="plaintext hljs">#     dovecot<font></font>
protocols = imap pop3<font></font>
<font></font>
#   <font></font>
listen = *, ::<font></font>
<font></font>
#        mysql<font></font>
dict {<font></font>
    quota = mysql:/usr/local/etc/dovecot/dovecot-dict-sql.conf.ext<font></font>
}<font></font>
<font></font>
#  <font></font>
!include conf.d/*.conf<font></font>
!include_try local.conf<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dovecot-dict-sql.conf.ext</font></font><br>
<br>
<pre><code class="plaintext hljs">connect = host=127.0.0.1 dbname=postfix user=postfix password=password123<font></font>
<font></font>
map {<font></font>
  pattern = priv/quota/storage<font></font>
  table = quota2<font></font>
  username_field = username<font></font>
  value_field = bytes<font></font>
}<font></font>
map {<font></font>
  pattern = priv/quota/messages<font></font>
  table = quota2<font></font>
  username_field = username<font></font>
  value_field = messages<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dovecot-sql.conf.ext</font></font><br>
<br>
<pre><code class="plaintext hljs">#    MYSQL<font></font>
driver = mysql<font></font>
connect = host=127.0.0.1 dbname=postfix user=postfix password=password123<font></font>
<font></font>
#    <font></font>
default_pass_scheme = MD5<font></font>
<font></font>
#  ,   <font></font>
user_query = SELECT '/var/mail/%d/%n/' AS  home, 'maildir:/var/vmail/%d/%n' AS mail, 1000 AS uid, 1000 AS gid, concat('*:bytes=',quota) as quota_rule FROM mailbox \<font></font>
    WHERE username ='%u' AND active = '1'<font></font>
<font></font>
password_query = SELECT username as user, password, '/var/vmail/%d/%n' as userdb_home, 'maildir:/var/vmail/%d/%n' as userdb_mail, 1000 as userdb_uid, \<font></font>
 1000 as userdb_gid, concat('*:bytes=',quota) AS userdb_quota_rule FROM mailbox WHERE username ='%u' AND active ='1'<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10-auth.conf</font></font><br>
<br>
<pre><code class="plaintext hljs">#   SSL<font></font>
disable_plaintext_auth = yes<font></font>
<font></font>
#  <font></font>
auth_realms = virusslayer.su<font></font>
auth_default_realm = virusslayer.su<font></font>
<font></font>
#    ( ,         ssl)<font></font>
auth_mechanisms = plain login<font></font>
<font></font>
#   ,  !include auth-sql.conf.ext,        mysql<font></font>
#!include auth-deny.conf.ext<font></font>
#!include auth-master.conf.ext<font></font>
<font></font>
#!include auth-system.conf.ext<font></font>
!include auth-sql.conf.ext<font></font>
#!include auth-ldap.conf.ext<font></font>
#!include auth-passwdfile.conf.ext<font></font>
#!include auth-checkpassword.conf.ext<font></font>
#!include auth-vpopmail.conf.ext<font></font>
#!include auth-static.conf.ext<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10-mail.conf</font></font><br>
<br>
<pre><code class="plaintext hljs">#   <font></font>
mail_location = maildir:/var/vmail/%d/%n<font></font>
<font></font>
#      <font></font>
namespace inbox {<font></font>
  inbox = yes<font></font>
}<font></font>
<font></font>
#uid  gid vmail<font></font>
mail_uid = 1000<font></font>
mail_gid = 1000<font></font>
<font></font>
# ,    quota<font></font>
mail_plugins = quota<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10-master.conf</font></font><br>
<br>
<pre><code class="plaintext hljs">#     ssl<font></font>
service imap-login {<font></font>
  inet_listener imap {<font></font>
    port = 143<font></font>
  }<font></font>
  inet_listener imaps {<font></font>
    port = 993<font></font>
    ssl = yes<font></font>
  }<font></font>
}<font></font>
<font></font>
service pop3-login {<font></font>
  inet_listener pop3 {<font></font>
    port = 110<font></font>
  }<font></font>
  inet_listener pop3s {<font></font>
    port = 995<font></font>
    ssl = yes<font></font>
  }<font></font>
}<font></font>
<font></font>
service submission-login {<font></font>
  inet_listener submission {<font></font>
    port = 587<font></font>
  }<font></font>
}<font></font>
<font></font>
#           (   ,       )<font></font>
service auth {<font></font>
  unix_listener auth-userdb {<font></font>
    mode = 0600<font></font>
    user = vmail<font></font>
    group = vmail<font></font>
  }<font></font>
  # Postfix smtp-auth<font></font>
  unix_listener /var/spool/postfix/private/auth {<font></font>
    mode = 0666<font></font>
    user = postfix<font></font>
    group = postfix<font></font>
  }<font></font>
}<font></font>
<font></font>
#  vmail  <font></font>
service dict {<font></font>
  unix_listener dict {<font></font>
    mode = 0660<font></font>
    user =  vmail<font></font>
    group = vmail<font></font>
    }<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10-ssl.conf</font></font><br>
<br>
<pre><code class="plaintext hljs"># ssl  (    sll  )<font></font>
ssl = required<font></font>
<font></font>
#  <font></font>
ssl_cert = &lt;/etc/ssl/foo-cert.pem<font></font>
ssl_key = &lt;/etc/ssl/foo-key.pem<font></font>
ssl_ca = &lt;/etc/ssl/demoCA/cacert.pem<font></font>
<font></font>
#   <font></font>
ssl_min_protocol = TLSv1.2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
15-lda.conf</font></font><br>
<br>
<pre><code class="plaintext hljs">quota_full_tempfail = no<font></font>
lda_mailbox_autosubscribe = yes<font></font>
protocol lda {<font></font>
 #      sieve,       <font></font>
  mail_plugins = $mail_plugins sieve quota<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
90-plugin.conf</font></font><br>
<br>
<pre><code class="plaintext hljs">#             "",       chown -R vmail:vmail<font></font>
#          ""<font></font>
plugin {<font></font>
  #setting_name = value<font></font>
  sieve = /usr/local/etc/dovecot/conf.d/def/default.sieve<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
auth-sql.conf.ext</font></font><br>
<br>
<pre><code class="plaintext hljs">#      MYSQL<font></font>
passdb {<font></font>
  driver = sql<font></font>
<font></font>
  # Path for SQL configuration file, see example-config/dovecot-sql.conf.ext<font></font>
  args = /usr/local/etc/dovecot/dovecot-sql.conf.ext<font></font>
}<font></font>
<font></font>
userdb {<font></font>
  driver = sql<font></font>
  args = /usr/local/etc/dovecot/dovecot-sql.conf.ext<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スパマサシン</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「config」spamassassinは次のように見えますが、データが不十分であることが</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
わかり</font><font style="vertical-align: inherit;">ます。「config」のデータを手伝ってください：</font><font style="vertical-align: inherit;">local.cf</font></font><br>
<br>
<pre><code class="plaintext hljs">rewrite_header Subject *****SPAM*****<font></font>
report_safe 0<font></font>
required_score 5.0<font></font>
use_bayes 1<font></font>
bayes_auto_learn 1<font></font>
ifplugin Mail::SpamAssassin::Plugin::Shortcircuit<font></font>
endif # Mail::SpamAssassin::Plugin::Shortcircuit<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スパムのある手紙とない手紙のトレーニングも行う必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">sa-learn --spam /path/spam/folder<font></font>
sa-learn --ham /path/ham/folder<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このセクションでは、pfに基づいてファイアウォール設定を指定し、自動実行にpfを追加して、ルールを含むファイルを指定します。</font></font><br>
<br>
<pre><code class="plaintext hljs">sysrc pf_enable="YES"<font></font>
sysrc pf_rules="/etc/0.pf"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ルールを含むファイルを作成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">ee /etc/0.pf
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてそれにルールを追加します：</font></font><br>
<br>
<pre><code class="plaintext hljs"># (   lo0)    ,    <font></font>
set skip on lo0<font></font>
<font></font>
#      deovecot, postfix, root<font></font>
pass in quick proto { tcp, udp } from any to any port {53,25,465,587,110,143,993,995} user {dovecot,postfix,root} flags S/SA modulate state<font></font>
pass out quick proto { tcp, udp } from any to any port {53,25,465,587,110,143,993,995} user {dovecot,postfix,root}<font></font>
<font></font>
#      root<font></font>
pass out quick proto {tcp,udp} from any to any user root<font></font>
<font></font>
#    <font></font>
pass in quick proto tcp from any to any port 80 flags S/SA modulate state<font></font>
<font></font>
#SSH<font></font>
pass in quick proto tcp from any to any port 22 flags S/SA modulate state<font></font>
<font></font>
#     clamav  spamd <font></font>
pass out quick proto {tcp,udp} from any to any user {clamav,spamd}<font></font>
<font></font>
#DNS  ICMP<font></font>
pass out quick proto {tcp,udp} from any to any port=53 keep state<font></font>
pass out quick proto icmp from any to any<font></font>
<font></font>
block from any to any fragment<font></font>
block from any to any<font></font>
block all<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコマンドでpfを実行できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">service pf start
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト中</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての可能な接続（STARTTLS、SLL）をテストするには、モバイルデバイスのクライアント（私の場合はios）“ MyOffice Mail”を使用できます。このアプリケーションには、メールサーバーへの接続を構成するための多くのパラメーターがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
spaassasinをテストするには、GTUBE署名を使用して、メッセージに次の行を追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが正しい場合、メッセージにはスパムのマークが付けられ、それに応じてスパムフォルダに移動さ​​れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ウイルス対策をテストするには、テキストファイルを含む電子メールを送信する必要があります。このファイルにはEICARシーケンスがあります。</font></font><br>
<br>
<pre><code class="plaintext hljs">X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手紙は当然、外部のメールボックスから送信する必要があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログをリアルタイムで表示するには、次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="plaintext hljs">tail -f /var/log/maillog
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、外部メールボックス（たとえば、yandex.ru、mail.ru、gmail.comなど）にメールを送信する正しいテストを行うには、リバースDNSゾーン（PTRレコード）を登録する必要があります。これは、プロバイダー（あなたは確かにあなた自身のDNSサーバーを持っていません）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、メールサーバーはかなり複雑なもののように思えるかもしれませんが、それを理解すれば、まったくそうではありません。構成に少し時間を費やしただけで、スパムやウイルスから保護された、かなり機能的なメールサーバーを入手できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSコメント付きで「コピーアンドペースト」する場合は、ロシア語のクラスログにrootユーザー（およびそれを必要とするユーザー）を追加する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">pw usermod root -L russian
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのアクションの後、ロシア語の文字が正しく表示されます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja476138/index.html">天文学者は、通信衛星SpaceX、OneWeb、その他の企業が天文学の未来を脅かしていると信じています</a></li>
<li><a href="../ja476140/index.html">7000語は知っているが耳で理解できない場合、リスニングを改善するにはどうすればよいですか？</a></li>
<li><a href="../ja476142/index.html">Javaでフローを制御するために例外の使用を避ける理由</a></li>
<li><a href="../ja476144/index.html">シークレットサンタをプレイするボットの例を使用して、ボットのチャットを作成する必要性と不要な方法</a></li>
<li><a href="../ja476146/index.html">データセンターを拡張する方法。Yandexレポート</a></li>
<li><a href="../ja476156/index.html">Apache Kafkaを使用した同期リクエスト/レスポンス</a></li>
<li><a href="../ja476160/index.html">教育ソフトウェアの誕生とその歴史：機械から最初のコンピューターまで</a></li>
<li><a href="../ja476162/index.html">最新のWebアプリケーションを作成します。プロジェクトの知識と仕事の準備。パート1</a></li>
<li><a href="../ja476164/index.html">「これもデータ分析です。」ミハイル・ゲルファンドとバイオインフォマティクスについて語る</a></li>
<li><a href="../ja476166/index.html">「リアルアイアンマン」は飛行速度の記録を塗り替えました</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>