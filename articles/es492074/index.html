<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕛 👨🏿‍🤝‍👨🏼 🗳️ Tengo que ir rápido. Sincronización rápida de correo electrónico IMAP ⚔️ 🎵 🤴🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¡Hola! Soy Ilya Hace dos años, me uní al cliente móvil IMAP. Las versiones anteriores de la aplicación descargaban la lista de cartas durante mucho ti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Tengo que ir rápido. Sincronización rápida de correo electrónico IMAP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492074/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡Hola! Soy Ilya Hace dos años, me uní al cliente móvil IMAP. Las versiones anteriores de la aplicación descargaban la lista de cartas durante mucho tiempo y gastaban mucho tráfico para actualizar el buzón. Surgió la pregunta sobre la optimización del trabajo con el protocolo y sobre las capacidades de este protocolo en general. No sabía nada sobre el protocolo y me puse a leer la documentación. Resulta que todo este tiempo el cliente usó el protocolo sin interrupción y no tuvo en cuenta las características de implementación. Estas características ayudaron a acelerar las descargas de correo de 2 a 3 veces. Sobre lo que es IMAP y cuáles son los chips para optimizarlo más adelante en mi artículo.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No me sumergiré en el protocolo demasiado profundamente. </font><font style="vertical-align: inherit;">Un artículo de la categoría "Me gustaría leer este artículo hace dos años". </font><font style="vertical-align: inherit;">Es poco probable que los gurús de IMAP encuentren nueva información por sí mismos. </font><font style="vertical-align: inherit;">Este artículo se basa en la descripción del protocolo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 3501</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conexión al servidor</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAP es un protocolo con estado. </font><font style="vertical-align: inherit;">Esto fue un descubrimiento para mí, antes de eso no había visto ni trabajado con tales protocolos. </font><font style="vertical-align: inherit;">Considere el esquema de trabajar con el servidor.&nbsp;</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/311/882/30f/31188230f96d5252e2a974ebe843786d.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vayamos en orden, y lo más importante, con ejemplos. </font><font style="vertical-align: inherit;">Primero debe crear una conexión con el servidor. </font><font style="vertical-align: inherit;">Para hacer esto, use la biblioteca openSSL.</font></font><br>
<br>
<pre><code class="bash hljs">openssl s_client -connect imap.server.com:993 -crlf&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Genial, la conexión está establecida y puede observar la respuesta correcta con una línea que comienza con la respuesta CAPACIDAD</font></font><br>
<br>
<pre><code class="bash hljs">OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE&nbsp; SPECIAL-USE AUTH=PLAIN AUTH=LOGIN]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hoja de trucos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conveniente </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">para</font></a><font style="vertical-align: inherit;"> cada CAPACIDAD </font><font style="vertical-align: inherit;">, donde todos los valores de CAPACIDAD posibles se escriben con enlaces al RFC. </font><font style="vertical-align: inherit;">Por ejemplo, IMAP4rev1 le dice al cliente que el servidor funciona de acuerdo con el estándar IMAP4, e IDLE le indica que puede suscribirse a los cambios que ocurren en el buzón.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autorización del servidor</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de conectarse al servidor, debe ir a su buzón. </font><font style="vertical-align: inherit;">Esto se hace usando el comando LOGIN.</font></font><br>
<br>
<pre><code class="bash hljs">a1 LOGIN email pass</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, pare, inicie sesión, entiendo, y a1 ¿qué es esto? </font><font style="vertical-align: inherit;">-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quizás lo preguntes. </font><font style="vertical-align: inherit;">Y esta es la etiqueta del equipo. </font><font style="vertical-align: inherit;">En interés del cliente, las etiquetas deben ser diferentes, ya que la respuesta llega con la misma etiqueta que la solicitud, lo que significa que puede coincidir con el análisis entre equipos. </font><font style="vertical-align: inherit;">El servidor también puede devolver una respuesta con un asterisco al principio, como * OK, esto se denomina respuesta sin etiquetar. </font><font style="vertical-align: inherit;">Básicamente, dicha respuesta se devuelve para los equipos que esperan varias entidades en la respuesta, por ejemplo, LIST.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicitud de lista de carpetas</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para solicitar una lista de letras en una carpeta, primero debe encontrar estas carpetas. </font><font style="vertical-align: inherit;">Esto se hace mediante el comando LIST. </font><font style="vertical-align: inherit;">Este comando devuelve una lista de carpetas en el servidor.</font></font><br>
<br>
<pre><code class="bash hljs">A2 LIST «» *<font></font>
* LIST (\HasNoChildren \Trash) «/» Trash<font></font>
* LIST (\HasNoChildren \Sent) «/» Sent<font></font>
* LIST (\HasNoChildren \Drafts) «/» Drafts<font></font>
* LIST (\HasNoChildren \Junk) «/» Junk<font></font>
* LIST (\HasNoChildren) «/» INBOX<font></font>
A2 OK List completed (0.001 + 0.000 + 0.001 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer parámetro en el comando es el espacio de nombres. Si el servidor admite el espacio de nombres, sus valores se pueden solicitar mediante la consulta NAMESPACE. El espacio de nombres estándar parece una cadena vacía. A continuación, entra en juego el parámetro comodines. Con él, podemos decirle al servidor qué carpetas debemos devolver. Por ejemplo, podemos obtener: una rama de árbol de carpetas, solo raíces, o simplemente todo, como en el ejemplo anterior. Es mejor no hacer esto, porque quién sabe cuántas carpetas tiene el usuario en la caja. Los autores del protocolo recomiendan utilizar "%"; en este caso, obtendrá todas las carpetas de nivel superior del buzón.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la respuesta, entendemos que esta es una respuesta sin etiquetar donde cada línea es su carpeta en el cuadro. </font><font style="vertical-align: inherit;">Primero, hay banderas por las cuales leemos la metainformación de la carpeta, por ejemplo, en el ejemplo todas las carpetas no tienen descendientes y algunas carpetas de propósito especial (como Papelera, Basura, etc.). </font><font style="vertical-align: inherit;">Luego viene el carácter separador de carpeta. </font><font style="vertical-align: inherit;">Este símbolo se usa para subcarpetas. </font><font style="vertical-align: inherit;">Por ejemplo, para un descendiente de la carpeta Papelera, el nombre se vería como "Papelera / Nueva carpeta". </font><font style="vertical-align: inherit;">Después de todas las carpetas, el servidor nos devolverá OK con la etiqueta que le asignamos al comando y el tiempo de ejecución de este comando.&nbsp;&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selección de carpeta</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, de acuerdo con el esquema, debemos seleccionar una carpeta desde la cual ajustaremos nuestros mensajes. </font><font style="vertical-align: inherit;">Esto se hace usando el comando SELECT.</font></font><br>
<br>
<pre><code class="bash hljs">4 SELECT INBOX<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 16337 EXISTS<font></font>
* 2 RECENT<font></font>
* OK [UNSEEN 6037] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 17412] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 21503] Highest<font></font>
4 OK [READ-WRITE] Select completed (0.015 + 0.000 + 0.014 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando selecciona una carpeta, se devuelve toda la información sobre ella. </font><font style="vertical-align: inherit;">Vamos en orden.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda con banderas que están permitidas dentro de la carpeta para letras.&nbsp;&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda con banderas que el cliente puede cambiar para siempre</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda con el número de letras en la carpeta</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La respuesta es con el número de cartas recientes, es decir, las que recibimos entre las selecciones de carpetas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda con la cantidad de mensajes no leídos</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, por ahora, detengámonos en esto. </font><font style="vertical-align: inherit;">El resto de la información no la necesitamos.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cartas de solicitud</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora lo más interesante es la solicitud de cartas. </font><font style="vertical-align: inherit;">Debe tener mucho cuidado aquí, especialmente en clientes móviles. </font><font style="vertical-align: inherit;">De acuerdo, es poco probable que cuando ingrese a la aplicación reciba miles de mensajes del servidor a su base de datos. </font><font style="vertical-align: inherit;">Además, no tiene sentido descargar la carta completa, ya que puede no ser práctico mostrar, por ejemplo, una lista de todas las cartas. </font><font style="vertical-align: inherit;">Por ejemplo, para mostrar rápidamente las cartas del usuario, solo le pediremos un "sobre". </font><font style="vertical-align: inherit;">En este sobre queremos ver: remitente, destinatario, asunto de la carta y fecha de envío. </font><font style="vertical-align: inherit;">Cargaremos las primeras 10 publicaciones.</font></font><br>
<br>
<pre><code class="bash hljs">5 FETCH 16337:16327 (ENVELOPE)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los dos puntos enumeran el segmento de los números de letras que queremos recibir, y entre paréntesis lo que queremos leer de estas letras, en este caso, el sobre de la letra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daré la respuesta en forma abreviada:</font></font><br>
<br>
<pre><code class="bash hljs">* 16334 FETCH (ENVELOPE (<span class="hljs-string">"Sat, 07 Sep 2019 23:07:48 +0000"</span> <span class="hljs-string">"Hello from Fabric.io"</span> ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((NIL NIL <span class="hljs-string">"me"</span> <span class="hljs-string">"me@mail"</span>)) NIL NIL NIL <span class="hljs-string">"&lt;5d7438441b07c_2d872ad30967b9646405c6@answers-notifier2012.mail&gt;"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Está claro que nada está claro. </font><font style="vertical-align: inherit;">Y es que el formato de sobre está dictado por </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 2822.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No lo consideraré en este artículo. </font><font style="vertical-align: inherit;">Este sobre tiene toda la información necesaria: fecha de recepción de la carta, asunto de la carta, remitente, destinatario e incluso Id. De mensaje. </font><font style="vertical-align: inherit;">Sus clientes usan para mostrar una conversación. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, pudimos mostrar al usuario información básica sobre la carta, pero ¿qué pasa con el cuerpo? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos descargar de inmediato todo el cuerpo de la carta, independientemente de su tamaño, por supuesto, esto no es por mucho tiempo, pero no obstante es costoso a través de la red y la memoria. </font><font style="vertical-align: inherit;">Por cierto, esto se hace con el mismo comando FETCH.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">6 FETCH 16337:16327 (BODY[])&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pruebe dicho comando en su bandeja de entrada, y comprenderá lo que quise decir con "costoso", incluso con 10 mensajes obtenemos una respuesta bastante voluminosa con absolutamente toda la información sobre la carta. Hablando de ella. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Con qué frecuencia descargaste la fuente de la carta en algún cliente que conoces para ver cómo se ve en su forma original? Si no, saquemos una carta de prueba. En él, agregué una imagen directamente a la carta y una imagen como archivo adjunto. Guárdelo en formato eml y luego ábralo con cualquier editor de texto. Dependiendo del cliente, recibirá diferentes fuentes de la carta, pero en general serán similares.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con el encabezado del correo electrónico:</font></font><br>
<br>
<pre><code class="bash hljs">Return-Path: &lt;myemail&gt;<font></font>
Delivered-To:myemail<font></font>
Received: from localhost (localhost [127.0.0.1])<font></font>
	byimap.server.com (imap.server.com) with ESMTP id 6C2BE2A0363<font></font>
	<span class="hljs-keyword">for</span> &lt;myemail&gt;; Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
X-Virus-Scanned: amavisd-new at imap.server.com<font></font>
Received: from imap.server.com ([127.0.0.1])<font></font>
	by localhost ( imap.server.com [127.0.0.1]) (amavisd-new, port 10026)<font></font>
	with ESMTP id abx8HQQT_k5A <span class="hljs-keyword">for</span> &lt;myemail&gt;;<font></font>
	Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
Mime-Version: 1.0<font></font>
Date: Sun, 08 Sep 2019 20:41:28 +0000<font></font>
Content-Type: multipart/mixed;<font></font>
&nbsp;boundary=»--=_Part_722_554093397.1567975288»<font></font>
Message-ID: &lt;9e4e3872e603eac2c20f26bb1d65548d&gt;<font></font>
From: <span class="hljs-string">"Me"</span> &lt;myemail&gt;<font></font>
Subject: Hey, Habr!<font></font>
To: myemail<font></font>
X-Priority: 3 (Normal)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toda la metainformación se describe en el encabezado de la carta, de quién, a quién, cuándo, tipo de contenido del mensaje, asunto y prioridad de la carta. </font><font style="vertical-align: inherit;">El campo de límite indica el límite de la letra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, entienda lo que esto significa.</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: multipart/related;<font></font>
&nbsp;boundary=»--=_Part_583_946112260.1567975288»<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: multipart/alternative;<font></font>
&nbsp;boundary=»--=_Part_881_599167713.1567975288»<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/plain; charset=«utf-8»<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/html; charset=«utf-8»<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=3D<span class="hljs-string">"Content-Type"</span> content=3D<span class="hljs-string">"t=
ext/html; charset=3Dutf-8"</span> /&gt;&lt;/head&gt;&lt;body&gt;&lt;div data-crea=3D<span class="hljs-string">"font-wrapper"</span>=<font></font>
&nbsp;style=3D«font-family: XO Tahion; font-size: 16px; direction: ltr»&gt; &lt;img =<font></font>
src=3D<span class="hljs-string">"cid:jua-uid-q1nz1guinitrcfd3-1567975257318"</span>&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;/div&gt; &lt;b=<font></font>
r&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<font></font>
----=_Part_881_599167713.1567975288--<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: image/jpeg; name=«2018-09-04 22.46.36.jpg»<font></font>
Content-Disposition: inline; filename=«2018-09-04 22.46.36.jpg»<font></font>
Content-ID: &lt;jua-uid-q1nz1guinitrcfd3-1567975257318&gt;<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada límite es el borde habitual de una pieza de escritura. </font><font style="vertical-align: inherit;">Comienzan con dos guiones "-". </font><font style="vertical-align: inherit;">El borde de cierre tiene estos dos guiones al final. </font><font style="vertical-align: inherit;">Se describe con más detalle en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC1341. A</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
esto se le puede llamar la parte principal de la letra, aquí se describen partes de la letra y sus tipos MIME.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acerca de los tipos MIME</font></font></b><div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un tipo MIME es un tipo de medio que se ha descrito en MIME ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extensiones multipropósito de correo de Internet)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para describir los tipos de contenido dentro de un mensaje de correo electrónico.&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multipart / mixed nos dice que la letra tiene una estructura mixta, es decir, diferentes partes de las letras pueden ser diferentes representaciones de esta o aquella información.&nbsp;</font></font></li>
</ul><br>
<ul>
<li>multipart/related  ,     ,     ,&nbsp;</li>
</ul><br>
<ul>
<li>multipart/alternative   ,       , ,   text/plain  text/html,       .&nbsp;</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No tenemos texto simple aquí, por lo que es más lógico tomar una representación html. En esta presentación html solo hay una imagen con el parámetro Content-Disposition: inline, es decir, se encuentra directamente en el cuerpo de la carta y no en los documentos adjuntos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El enlace a esta imagen no es muy simple. Se describe mediante el parámetro Content-ID, que es igual a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jua-uid-q1nz1guinitrcfd3-1567975257318</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este es un enlace a la siguiente parte de la carta, una imagen codificada en base-64. Para salvar mis nervios, no incluí todo el código base 64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La última parte de la carta tiene la forma&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: image/png; name=«2018-07-02 11.08.23 pm.png»<font></font>
Content-Disposition: attachment; filename=«2018-07-02 11.08.23 pm.png»<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
que ya tiene Content-Disposition no en línea, como la imagen de arriba, sino un archivo adjunto. </font><font style="vertical-align: inherit;">Esta imagen solo debe ir al panel de archivos adjuntos, por cierto, también está codificada en base-64 y tiene un gran tamaño. </font><font style="vertical-align: inherit;">Aquí queda claro que no debe volver a cargar todo el cuerpo de la carta si solo queremos mostrar información básica.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Regresar al protocolo</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de trabajar en las letras, debe cerrar la carpeta seleccionada y decir adiós al servidor. </font><font style="vertical-align: inherit;">Para cerrar la carpeta, necesitamos ingresar el comando CERRAR. </font><font style="vertical-align: inherit;">Si, es muy simple</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
7 CLOSE<font></font>
7 OK Close completed (0.001 + 0.000 secs).<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, si trabajó con la consola en paralelo conmigo y leyó el artículo, entonces podría haber sucedido un evento no tan agradable, el servidor podría cerrar su conexión por tiempo de espera. </font><font style="vertical-align: inherit;">Esto es completamente normal, y cada servidor tiene su propio tiempo de espera, por ejemplo, tenemos 30 minutos.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, se recomienda hacer el comando NOOP en segundo plano</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
1 OK NOOP completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Literalmente no hace nada, pero le permite mantener la conexión sin un tiempo de espera tanto como lo necesitemos. </font><font style="vertical-align: inherit;">Si actualmente selecciona una carpeta, NOOP puede funcionar como una solicitud periódica de cambios en esta carpeta&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
* 16472 EXPUNGE<font></font>
* 16471 EXPUNGE<font></font>
* 16472 EXISTS<font></font>
* 1 RECENT<font></font>
1 OK NOOP completed (0.004 + 0.000 + 0.003 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí, en la respuesta, se nos notifican dos mensajes eliminados, uno nuevo y que el número de mensajes en esta carpeta es 16 472. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
También noto que puede trabajar con solo una carpeta seleccionada, no hay trabajo paralelo aquí. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, al final, cierre la sesión con el servidor y le diremos adiós.</font></font><br>
<br>
<pre><code class="bash hljs">8 LOGOUT<font></font>
* BYE Logging out<font></font>
8 OK Logout completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos la triste respuesta BYE sin etiquetar, lo que significa que es hora de terminar el trabajo.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sincronización rápida con CONDSOTORE y QRESYNC</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede usar la operación NOOP para rastrear cambios en un cuadro en una carpeta seleccionada. Pero, ¿qué sucede si queremos averiguar qué ha cambiado en la carpeta mientras trabajábamos con otra? La opción más obvia es ordenar todas las letras en el almacenamiento local, ya sea un caché o una base de datos, y comparar con lo que devolverá el servidor. Por un lado, esta es realmente una solución, y en algunos servidores será literalmente la única verdadera. Por otro lado, queremos mostrar letras tan rápido como el protocolo generalmente lo permite. Afortunadamente, nuestro servidor admite extensiones de protocolo como CONDSTORE y QRESYNC, que se agregaron a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC7162</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El primero agrega un número especial de 63 bits al mensaje y a la carpeta, llamado secuencia de modulación, que aumenta con cada operación en esta letra. La secuencia de modulación más alta entre todos los mensajes se agrega a la carpeta. Como resultado, cada vez que se conecta a una carpeta en un servidor que admite CONDSTORE, podemos averiguar fácilmente si algo ha cambiado o no, simplemente comparando los valores de secuencia de mod para las carpetas locales y del servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, esta extensión agrega parámetros adicionales para los comandos STORE y FETCH: secuencia mod CHANGEDSINCE y secuencia mod UNCHANGEDSINCE, que le permiten realizar una operación si la secuencia mod de los mensajes transmitidos es mayor y menor que esta, respectivamente. Veamos un ejemplo.</font></font><br>
<br>
<pre><code class="bash hljs">FETCH 17221:17241 (UID) (CHANGEDSINCE 0)<font></font>
* OK [HIGHESTMODSEQ 22746] Highest<font></font>
* 17222 FETCH (UID 18319 MODSEQ (22580))<font></font>
* 17223 FETCH (UID 18320 MODSEQ (22601))<font></font>
* 17224 FETCH (UID 18324 MODSEQ (22607))<font></font>
* 17225 FETCH (UID 18325 MODSEQ (22604))<font></font>
* 17226 FETCH (UID 18326 MODSEQ (22608))<font></font>
* 17227 FETCH (UID 18327 MODSEQ (22614))<font></font>
* 17228 FETCH (UID 18328 MODSEQ (22613))<font></font>
* 17229 FETCH (UID 18336 MODSEQ (22628))<font></font>
* 17230 FETCH (UID 18338 MODSEQ (22628))<font></font>
* 17231 FETCH (UID 18340 MODSEQ (22628)<font></font>
* 17232 FETCH (UID 18341 MODSEQ (22628))<font></font>
* 17221 FETCH (UID 18318 MODSEQ (22583))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simulé una situación en la que entramos en el buzón y no sabíamos nada al respecto antes, es decir, nuestra secuencia de modulación local es 0. Como puede ver, el servidor generalmente nos devuelve todos los mensajes que están en el buzón, ya que antes no recibíamos nada y no sé nada sobre la caja. En respuesta a una solicitud de letras UID de CHANGEDSINCE, una respuesta sin etiquetar OK también viene con un HIGHESTMODESEQ que ahora guardaremos, y para cada mensaje nuestro MODSEQ. Realizaremos </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
algunas operaciones con el buzón: agregue nuevas letras, cambie las banderas. Hagamos una nueva solicitud pero con la secuencia mod anterior</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 17221:* (UID FLAGS) (CHANGEDSINCE 22746)<font></font>
* 17267 FETCH (UID 18378 FLAGS () MODSEQ (22753))<font></font>
* 17270 FETCH (UID 18381 FLAGS (\Seen) MODSEQ (22754))<font></font>
* 17271 FETCH (UID 18382 FLAGS () MODSEQ (22751))<font></font>
* 17273 FETCH (UID 18384 FLAGS () MODSEQ (22750))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
y ya vemos la diferencia, en lugar de generar 20 comunidades antiguas y nuevas que acaban de llegar (un asterisco en 17221: * significa tomar letras del número 17221 al máximo posible) recibimos letras cuyo MODSEQ es mayor que el anterior. Esto ayuda bastante bien a sincronizar una carpeta en la que no hemos estado durante algún tiempo y obtener una especie de reparto de las letras cambiadas, en lugar de intentar todas las posibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parecería, mucho mejor? Pero QRESYNC hace que la operación de sincronización sea aún más rápida, le permite especificar los parámetros MODSEQ y los UID de mensaje que conocemos justo durante la selección de la carpeta. Vamos a explicar con un ejemplo. Primero, QRESYNC debe habilitarse con el comando ENABLE.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 ENABLE QRESYNC<font></font>
* ENABLED QRESYNC<font></font>
1 OK Enabled (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (0 0))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18385] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22754] Highest<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como no sabíamos nada sobre la carpeta antes de eso, el servidor solo nos devuelve información sobre la carpeta, sin una pepita de sus cambios. Supongamos que preguntamos los primeros veinte mensajes y recordamos su UID y también HIGHESTMODESEQ. Dejamos la carpeta, nos enviamos un mensaje, eliminamos el mensaje, cambiamos las banderas y regresamos con la información anterior sobre la carpeta</font></font><br>
<br>
<pre><code class="bash hljs">1 CLOSE<font></font>
1 OK Close completed (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (1532079879 22754 18300:18385))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18386] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22757] Highest<font></font>
* VANISHED (EARLIER) 18380<font></font>
* 17269 FETCH (UID 18383 FLAGS () MODSEQ (22757))<font></font>
* 17271 FETCH (UID 18385 FLAGS () MODSEQ (22755))<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora, al elegir una carpeta modificada, obtenemos inmediatamente una pepita de cambios, en forma de una respuesta DESAPARECIDA (ANTERIOR) para los mensajes que se eliminaron, y FETCH para los mensajes que se agregaron o cambiaron. Ahora es aún más fácil sincronizar la carpeta si el usuario no la ha visitado durante mucho tiempo. Esta es una forma muy interesante si tiene un montón de mensajes almacenados localmente en la memoria caché y no desea compararlos con los mensajes en el servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer parámetro de esta solicitud es UIDVALIDITY, que se usa esencialmente para verificar que el uid que recibió anteriormente no cambió en la carpeta. Esto puede suceder si el servidor cambia la sesión uid de sesión a sesión para todos los mensajes o si la carpeta se ha eliminado y se ha creado una carpeta con el mismo nombre en su lugar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo parámetro es el HIGHESTMODSEQ que conocemos y el último es el intervalo de UID conocidos, se pueden escribir como dos puntos, si el intervalo es continuo o separado por una coma.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusión</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mi ejemplo, me encontré con una situación en la que la ignorancia del área temática conduce a un funcionamiento incorrecto y subóptimo de la aplicación. </font><font style="vertical-align: inherit;">No cubrí todas las opciones posibles para usar el protocolo con este artículo. </font><font style="vertical-align: inherit;">Pero espero que para el próximo desarrollador del cliente IMAP la información anterior sea útil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAP tiene un montón de cosas interesantes. </font><font style="vertical-align: inherit;">Los comandos para la sincronización rápida son solo el comienzo, de hecho, puede optimizar aún más los diferentes comandos IMAP, dependiendo de las capacidades del servidor, y hacer que trabajar con el correo sea más rápido, más económico en la red y la memoria, y en general más agradable. </font><font style="vertical-align: inherit;">Pero hablaré de esto más tarde.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es492058/index.html">ROS2 vs ROS1. Instalación de ROS2 en Ubuntu 18.04</a></li>
<li><a href="../es492060/index.html">¿Cómo resolver? "ECONNREFUSED - Conexión rechazada por el servidor"</a></li>
<li><a href="../es492062/index.html">Plantilla de servidor backend de Golang - parte 1 (servidor HTTP)</a></li>
<li><a href="../es492066/index.html">¿Por qué Event Sourcing es el antipatrón para la interacción de microservicios?</a></li>
<li><a href="../es492068/index.html">S7 Group abre un departamento "Tecnologías de la información en la aviación" en MIPT</a></li>
<li><a href="../es492076/index.html">Un ejemplo de arquitectura hexagonal en Java</a></li>
<li><a href="../es492078/index.html">Los materiales más importantes y útiles sobre el coronavirus COVID-19</a></li>
<li><a href="../es492082/index.html">Cómo simplificar la administración de dispositivos domésticos y asegurarlos (compartir ideas sobre Kauri Safe Smart Home)</a></li>
<li><a href="../es492086/index.html">Coronavirus vs negocio ruso de TI: ¿están las empresas listas para transferir empleados a una ubicación remota?</a></li>
<li><a href="../es492088/index.html">Probar el motor del juego Amazon Lumberyard. Enfoques y herramientas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>