<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€ğŸš’ ğŸ’ ğŸŒ ä½¿ç”¨JWTåœ¨.NET Core gRpcä¸­è¿›è¡Œèº«ä»½éªŒè¯ ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ½ ğŸ‘©ğŸ»â€ğŸ­ ğŸ‘©â€ğŸ’»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºä½¿ç”¨JWTçš„gRpcæœåŠ¡ä¸­APIèº«ä»½éªŒè¯çš„åŠŸèƒ½ã€‚æˆ‘å‡è®¾æ‚¨ç†Ÿæ‚‰åœ¨.NET Core WebAPIä¸­ä½¿ç”¨å®ƒä»¬çš„JWTå’ŒHTTPæ ‡å¤´ï¼Œå› æ­¤æˆ‘å°†ä¸è®¨è®ºè¿™äº›è¯¦ç»†ä¿¡æ¯ã€‚å½“æˆ‘å°è¯•åœ¨gRpcä¸­å®ç°èº«ä»½éªŒè¯æ—¶ï¼Œæˆ‘å‘ç°ä¸€ä¸ªäº‹å®ï¼Œå³å¤§å¤šæ•°ç¤ºä¾‹éƒ½æ˜¯ä½¿ç”¨æ§åˆ¶å°åº”ç”¨ç¨‹åºç¼–å†™çš„ã€‚æˆ‘è®¤ä¸ºï¼Œè¿™ä¸å¼€å‘äººå‘˜æ‰€ç”Ÿæ´»çš„ç°å®...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨JWTåœ¨.NET Core gRpcä¸­è¿›è¡Œèº«ä»½éªŒè¯</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499588/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºä½¿ç”¨JWTçš„gRpcæœåŠ¡ä¸­APIèº«ä»½éªŒè¯çš„åŠŸèƒ½ã€‚</font><font style="vertical-align: inherit;">æˆ‘å‡è®¾æ‚¨ç†Ÿæ‚‰åœ¨.NET Core WebAPIä¸­ä½¿ç”¨å®ƒä»¬çš„JWTå’ŒHTTPæ ‡å¤´ï¼Œå› æ­¤æˆ‘å°†ä¸è®¨è®ºè¿™äº›è¯¦ç»†ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">å½“æˆ‘å°è¯•åœ¨gRpcä¸­å®ç°èº«ä»½éªŒè¯æ—¶ï¼Œæˆ‘å‘ç°ä¸€ä¸ªäº‹å®ï¼Œå³å¤§å¤šæ•°ç¤ºä¾‹éƒ½æ˜¯ä½¿ç”¨æ§åˆ¶å°åº”ç”¨ç¨‹åºç¼–å†™çš„ã€‚</font><font style="vertical-align: inherit;">æˆ‘è®¤ä¸ºï¼Œè¿™ä¸å¼€å‘äººå‘˜æ‰€ç”Ÿæ´»çš„ç°å®ç›¸è·å¤ªè¿œã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œæˆ‘ä¸æƒ³æ¯æ¬¡è°ƒç”¨æœåŠ¡æ–¹æ³•æ—¶éƒ½åˆ›å»ºä¸€ä¸ªé€šé“ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä¹Ÿä¸æƒ³æ‹…å¿ƒéšæ¯ä¸ªè¯·æ±‚å‘é€ä»¤ç‰Œå’Œç”¨æˆ·ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">ç›¸åï¼Œæˆ‘å¸Œæœ›æ‹¥æœ‰ä¸€ä¸ªåŸºç¡€æ¶æ„çº§åˆ«ï¼Œå®ƒå°†ä¸ºæˆ‘è§£å†³æ‰€æœ‰è¿™äº›é—®é¢˜ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ‚¨å¯¹è¿™ä¸ªä¸»é¢˜æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå°†ä¼šæœ‰æ›´å¤šçš„å†…å®¹å¯ä¾›é€‰æ‹©ã€‚</font><font style="vertical-align: inherit;">æœ¬æ–‡ä¸­çš„æ‰€æœ‰ç¤ºä¾‹å‡å¯¹.NET Core 3.1æœ‰æ•ˆã€‚</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äºŒæ‰‹ä¾‹å­</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æ·±å…¥æ¢è®¨è¯¥ä¸»é¢˜ä¹‹å‰ï¼Œå€¼å¾—æè¿°ä¸€ä¸‹æœ¬æ–‡ä¸­ä½¿ç”¨çš„ç¤ºä¾‹ã€‚æ•´ä¸ªè§£å†³æ–¹æ¡ˆç”±ä¸¤ä¸ªåº”ç”¨ç¨‹åºç»„æˆï¼šç½‘ç«™å’ŒgRpcæœåŠ¡ï¼ˆä»¥ä¸‹ç§°ä¸ºAPIï¼‰ã€‚ä¸¤è€…éƒ½æ˜¯ç”¨.NET Core 3.1ç¼–å†™çš„ã€‚å¦‚æœç”¨æˆ·æœ‰æƒç™»å½•ï¼Œåˆ™å¯ä»¥ç™»å½•å¹¶æŸ¥çœ‹ä¸€äº›æ•°æ®ã€‚è¯¥ç½‘ç«™ä¸å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œå¹¶ä¸”åœ¨èº«ä»½éªŒè¯è¿‡ç¨‹ä¸­ä¾èµ–äºAPIã€‚ä¸ºäº†ä¸gRpcæœåŠ¡è¿›è¡Œé€šä¿¡ï¼Œç½‘ç«™éœ€è¦å…·æœ‰æœ‰æ•ˆçš„JWTä»¤ç‰Œï¼Œä½†æ˜¯è¯¥ä»¤ç‰Œä¸åº”ç”¨ç¨‹åºä¸­çš„ç”¨æˆ·èº«ä»½éªŒè¯æ— å…³ã€‚ Webåº”ç”¨ç¨‹åºåœ¨å…¶ä¸€ä¾§ä½¿ç”¨cookieã€‚ä¸ºäº†ä½¿APIçŸ¥é“å“ªä¸ªç”¨æˆ·å‘æœåŠ¡å‘å‡ºäº†è¯·æ±‚ï¼Œæœ‰å…³æ­¤ä¿¡æ¯çš„ä¿¡æ¯ä¸JWTä»¤ç‰Œä¸€èµ·å‘é€ï¼Œä½†ä¸æ˜¯åœ¨ä»¤ç‰Œæœ¬èº«ä¸­å‘é€ï¼Œè€Œæ˜¯ä¸é™„åŠ çš„HTTPæ ‡å¤´ä¸€èµ·å‘é€ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†æˆ‘åˆšæ‰è®¨è®ºçš„ç³»ç»Ÿçš„ç¤ºä¾‹æ¶æ„ï¼š</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/1-/a_/vn/1-a_vno-j3cfyv8ps49vdd_jv6m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œï¼Œæˆ‘åº”è¯¥æ³¨æ„ï¼Œå½“æˆ‘åšè¿™ä¸ªä¾‹å­æ—¶ï¼Œæˆ‘çš„ç›®æ ‡ä¸æ˜¯ä¸ºAPIå®ç°æœ€æ­£ç¡®çš„èº«ä»½éªŒè¯æ–¹æ³•ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ‚¨æƒ³äº†è§£ä¸€äº›æœ€ä½³å®è·µï¼Œè¯·æŸ¥çœ‹</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenID Connectè§„èŒƒ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">è™½ç„¶ï¼Œæœ‰æ—¶åœ¨æˆ‘çœ‹æ¥ï¼Œæœ€æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆä¸å¯ä»¥è§£å†³é—®é¢˜å¹¶èŠ‚çœæ—¶é—´å’Œé‡‘é’±çš„è§£å†³æ–¹æ¡ˆç›¸æ¯”å¯èƒ½æ˜¯å¤šä½™çš„ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨gRpcæœåŠ¡ä¸­å¯ç”¨JWTèº«ä»½éªŒè¯</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gRpcæœåŠ¡çš„é…ç½®ä¸.NET Core APIæ‰€éœ€çš„å¸¸è§„é…ç½®æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚</font><font style="vertical-align: inherit;">å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯HTTPå’ŒHTTPSåè®®æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚</font><font style="vertical-align: inherit;">ç®€è¦åœ°è¯´ï¼Œæ‚¨éœ€è¦åœ¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Startup.cs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–‡ä»¶ä¸­æ·»åŠ æ ‡å‡†çš„èº«ä»½éªŒè¯å’ŒæˆæƒæœåŠ¡ä»¥åŠ</font><i><font style="vertical-align: inherit;">Middlewe</font></i><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ·»åŠ ä¸­é—´ä»¶çš„ä½ç½®å¾ˆé‡è¦ï¼šæ‚¨éœ€è¦åœ¨è·¯ç”±å’Œç‚¹ä¹‹é—´ç²¾ç¡®æ·»åŠ ä¸­é—´ä»¶ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¼ºå°‘ä¸€äº›ä»£ç </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰ï¼š</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">...</span>)</span> {<font></font>
    app.UseRouting();<font></font>
    <font></font>
    app.UseAuthentication();<font></font>
    app.UseAuthorization();<font></font>
    <font></font>
    app.UseEndpoints(...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯æ³¨å†ŒæœåŠ¡çš„åœ°æ–¹å¹¶ä¸é‚£ä¹ˆé‡è¦ï¼Œåªéœ€å°†</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigureServicesï¼ˆï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–¹æ³•æ·»åŠ åˆ°æ–¹æ³•ä¸­</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯åœ¨è¿™é‡Œï¼Œæ‚¨éœ€è¦é…ç½®JWTä»¤ç‰Œæ£€æŸ¥ã€‚</font><font style="vertical-align: inherit;">å¯ä»¥åœ¨è¿™é‡Œå®šä¹‰å®ƒï¼Œä½†æ˜¯æˆ‘å»ºè®®å°†å…¶æ”¾å…¥å•ç‹¬çš„ç±»ä¸­ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œä»£ç å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">...</span>)</span> {<font></font>
    services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)<font></font>
        .AddJwtBearer(o =&gt; {<font></font>
            <span class="hljs-keyword">var</span> validator = <span class="hljs-keyword">new</span> JwtTokenValidator(...);<font></font>
            o.SecurityTokenValidators.Add(validator);<font></font>
        });<font></font>
    services.AddAuthorization();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JwtTokenValidator</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ç±»</font><font style="vertical-align: inherit;">æ˜¯å®šä¹‰éªŒè¯é€»è¾‘çš„ç±»ã€‚</font><font style="vertical-align: inherit;">æ‚¨éœ€è¦</font><font style="vertical-align: inherit;">ä½¿ç”¨æ­£ç¡®çš„è®¾ç½®</font><font style="vertical-align: inherit;">æ¥åˆ›å»º</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TokenValidationParameters</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç±»</font><font style="vertical-align: inherit;">ï¼Œå®ƒå°†å®Œæˆå…¶ä½™çš„JWTéªŒè¯å·¥ä½œã€‚</font><font style="vertical-align: inherit;">ä½œä¸ºå¥–åŠ±ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å¤„æ·»åŠ é¢å¤–çš„å®‰å…¨å±‚ã€‚</font><font style="vertical-align: inherit;">å› ä¸ºJWTæ˜¯ä¸€ç§ä¼—æ‰€å‘¨çŸ¥çš„æ ¼å¼ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å®ƒã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ‚¨æ‹¥æœ‰JWTï¼Œåˆ™å¯ä»¥è½¬åˆ°</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jwt.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶æŸ¥çœ‹ä¸€äº›ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">æˆ‘æ›´å–œæ¬¢ä¸ºJWTæ·»åŠ é¢å¤–çš„åŠ å¯†ï¼Œè¿™ä½¿è§£å¯†æ›´åŠ å›°éš¾ã€‚</font><font style="vertical-align: inherit;">éªŒè¯å™¨çš„å¤–è§‚å¦‚ä¸‹ï¼š</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">JwtTokenValidator</span> : <span class="hljs-title">ISecurityTokenValidator</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">CanReadToken</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> securityToken</span>)</span> =&gt; <span class="hljs-literal">true</span>;<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClaimsPrincipal <span class="hljs-title">ValidateToken</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> securityToken, TokenValidationParameters validationParameters, <span class="hljs-keyword">out</span> SecurityToken validatedToken</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">new</span> JwtSecurityTokenHandler();
        <span class="hljs-keyword">var</span> tokenValidationParameters = <span class="hljs-keyword">new</span> TokenValidationParameters<font></font>
        {<font></font>
            ValidateIssuer = <span class="hljs-literal">true</span>,<font></font>
            ValidateAudience = <span class="hljs-literal">true</span>,<font></font>
            ValidateLifetime = <span class="hljs-literal">true</span>,<font></font>
            ValidateIssuerSigningKey = <span class="hljs-literal">true</span>,<font></font>
            ValidIssuer = <span class="hljs-string">"your string"</span>,<font></font>
            ValidAudience = <span class="hljs-string">"your string"</span>,<font></font>
            IssuerSigningKey = <span class="hljs-keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(<span class="hljs-string">"your secrete code"</span>))<font></font>
        };<font></font>
        <font></font>
        <span class="hljs-keyword">var</span> claimsPrincipal = handler.ValidateToken(token, tokenValidationParameters, <span class="hljs-keyword">out</span> validatedToken);
        <span class="hljs-keyword">return</span> claimsPrincipal;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> CanValidateToken { <span class="hljs-keyword">get</span>; } = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> MaximumTokenSizeInBytes { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">int</span>.MaxValue;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™å°±æ˜¯APIæ–¹é¢çš„å…¨éƒ¨éœ€æ±‚ã€‚</font><font style="vertical-align: inherit;">æ ¹æ®æ‰€é€‰çš„HTTPæˆ–HTTPSåè®®ï¼Œå®¢æˆ·ç«¯è®¾ç½®å†å²è®°å½•ä¼šç¨é•¿ä¸€äº›ï¼Œå¹¶ä¸”ä¼šç•¥æœ‰ä¸åŒã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†æ¯ä¸ªè¯·æ±‚çš„HTTPæ ‡å¤´å‘é€åˆ°gRpcæœåŠ¡</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨å¯èƒ½ä»å®˜æ–¹æ–‡æ¡£ä¸­çŸ¥é“äº†è¿™ä¸€ç‚¹ï¼Œå®é™…ä¸Šï¼Œæ‚¨åªèƒ½åœ¨å“‘æ§åˆ¶å°ç¨‹åºä¸­ä½¿ç”¨å®ƒã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æ­¤å¤„</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çœ‹åˆ°</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">å®ƒ</font></a><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> channel = GrpcChannel.ForAddress(<span class="hljs-string">"https://localhost:5001"</span>);
<span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> Greeter.GreeterClient(channel);
<span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> client.SayHelloAsync(
    <span class="hljs-keyword">new</span> HelloRequest { Name = <span class="hljs-string">"World"</span> });<font></font>
Console.WriteLine(response.Message);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦å…·æœ‰é›†ä¸­å¼çš„é…ç½®å’ŒDIï¼Œè€Œè¿™å‡ ä¹æ˜¯æ²¡æœ‰è€ƒè™‘çš„ã€‚è¿™æ˜¯æ‚¨éœ€è¦åšçš„ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨é¡¹ç›®ä¸­æ·»åŠ å¿…è¦çš„NuGetåŒ…ã€‚</font><i><font style="vertical-align: inherit;">Grpc.Tools</font></i><font style="vertical-align: inherit;"> 
åŒ…</font><font style="vertical-align: inherit;">å°†å¸®åŠ©æ‚¨åœ¨æ„å»ºé¡¹ç›®æ—¶åˆ›å»ºåŸå‹ï¼Œè€Œ</font><i><font style="vertical-align: inherit;">Grpc.Net.ClientFactory</font></i><font style="vertical-align: inherit;">å°†å¸®åŠ©æ‚¨è®¾ç½®DIã€‚</font><font style="vertical-align: inherit;">
ä½¿ç”¨gRpcæ—¶ï¼Œå¦‚æœéœ€è¦åœ¨è¯·æ±‚-å“åº”é“¾ä¸­é—´çš„æŸä¸ªåœ°æ–¹å®ç°å¤„ç†ï¼Œåˆ™éœ€è¦ä½¿ç”¨ä»</font><i><font style="vertical-align: inherit;">Interceptor</font></i><font style="vertical-align: inherit;">ç»§æ‰¿çš„ç±»</font><font style="vertical-align: inherit;">ï¼Œ</font><i><font style="vertical-align: inherit;">è¯¥ç±»</font></i><font style="vertical-align: inherit;">æ˜¯</font><i><font style="vertical-align: inherit;">gRpc.Coreçš„</font></i><font style="vertical-align: inherit;">ä¸€éƒ¨åˆ†</font><font style="vertical-align: inherit;">ã€‚å¦‚æœéœ€è¦åœ¨æœåŠ¡</font><font style="vertical-align: inherit;">å†…éƒ¨</font><font style="vertical-align: inherit;">è®¿é—®</font><i><font style="vertical-align: inherit;">HttpContext.User.Identity</font></i><font style="vertical-align: inherit;">ï¼Œåˆ™å¯ä»¥æ·»åŠ </font><i><font style="vertical-align: inherit;">IHttpContextAccessor</font></i><font style="vertical-align: inherit;">æ¥å£</font></font><br>
<br>
<code>dotnet add package Grpc.Net.Client<br>
dotnet add package Google.Protobuf<br>
dotnet add package Grpc.Tools<br>
dotnet add package Grpc.Net.ClientFactory<br>
</code><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨çš„æœåŠ¡ï¼ˆè¿™éœ€è¦åœ¨æœåŠ¡ä¸­è¿›è¡Œå…¶ä»–æ³¨å†Œï¼‰ã€‚</font><font style="vertical-align: inherit;">æ‚¨éœ€è¦å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°Startup.csæ–‡ä»¶ä¸­ã€‚</font></font><br>
<br>
<pre><code class="cs hljs">services.AddTransient&lt;AuthHeadersInterceptor&gt;();<font></font>
services.AddHttpContextAccessor();<font></font>
<font></font>
<span class="hljs-keyword">var</span> httpClientBuilder = services.AddGrpcClient&lt;MygRpcService.MygRpcServiceClient&gt;(o =&gt; { o.Address = <span class="hljs-keyword">new</span> Uri(<span class="hljs-string">"grpc-endpoint-url"</span>); });<font></font>
httpClientBuilder.AddInterceptor&lt;AuthHeadersInterceptor&gt;();              <font></font>
httpClientBuilder.ConfigureChannel(o =&gt; o.Credentials = ChannelCredentials.Insecure);<font></font>
</code></pre><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AuthHeadersInterceptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ç±»</font><font style="vertical-align: inherit;">æ˜¯æˆ‘ä»¬è‡ªå·±çš„ç±»ï¼Œå®ƒæ˜¯ä»</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interceptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç±»æ´¾ç”Ÿçš„</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å®ƒä½¿ç”¨IHttpContextAccessorå¹¶æ³¨å†Œ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.AddHttpContextAccessorï¼ˆï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…è®¸æ‚¨æ‰§è¡Œæ­¤æ“ä½œã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPçš„é…ç½®åŠŸèƒ½</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ä»¥ä¸‹é…ç½®ï¼š</font></font><br>
<br>
<pre><code class="cs hljs">httpClientBuilder.ConfigureChannel(o =&gt; o.Credentials = ChannelCredentials.Insecure);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¿…é¡»é€šè¿‡HTTPè¿›è¡Œå·¥ä½œï¼Œä½†è¿™è¿˜ä¸å¤Ÿã€‚</font><font style="vertical-align: inherit;">æ‚¨è¿˜éœ€è¦ä»Configureï¼ˆï¼‰æ–¹æ³•ä¸­æ’é™¤æ­¤è¡Œã€‚</font></font><br>
<br>
<pre><code class="cs hljs">app.UseHttpsRedirection();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è€Œä¸”ï¼Œ</font><font style="vertical-align: inherit;">åœ¨åˆ›å»ºä»»ä½•gRpcé€šé“ä¹‹å‰ï¼Œ</font><font style="vertical-align: inherit;">æ‚¨ä»ç„¶éœ€è¦</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·³èˆä»¥</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å»ºç«‹ç‰¹æ®Šçš„è®¾ç½®ã€‚</font><font style="vertical-align: inherit;">åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æœŸé—´ï¼Œæ­¤æ“ä½œåªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘å°†å…¶æ·»åŠ åˆ°ä¸ä¸Šè¿°åˆ é™¤è¡Œå‡ ä¹ç›¸åŒçš„ä½ç½®ã€‚</font><font style="vertical-align: inherit;">ä»…åº”ä¸ºHTTPè°ƒç”¨ã€‚</font></font><br>
<br>
<pre><code class="cs hljs">AppContext.SetSwitch(<span class="hljs-string">"System.Net.Http.SocketsHttpHandler.Http2UnencryptedSupport"</span>, <span class="hljs-literal">true</span>);
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPSçš„é…ç½®åŠŸèƒ½</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨Windowså’ŒLinuxä¸Šä½¿ç”¨SSLä¼šé‡åˆ°ä¸€äº›å›°éš¾ã€‚</font><font style="vertical-align: inherit;">æ‚¨å¯èƒ½ä¼šåœ¨Windowsè®¡ç®—æœºä¸Šè¿›è¡Œå¼€å‘ï¼Œå¹¶ä½¿ç”¨åŸºäºLinuxçš„æ˜ åƒå°†å…¶éƒ¨ç½²åˆ°Docker / Kubernetesã€‚</font><font style="vertical-align: inherit;">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé…ç½®ä¸åƒè®¸å¤šæ–‡ç« ä¸­æ‰€æè¿°çš„é‚£æ ·ç®€å•ã€‚</font><font style="vertical-align: inherit;">æˆ‘å°†åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­æè¿°æ­¤é…ç½®ï¼Œåœ¨è¿™é‡Œæˆ‘ä»…æ¶‰åŠä»£ç ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬éœ€è¦é‡æ–°é…ç½®gRpcé€šé“ä»¥ä½¿ç”¨SSLå‡­æ®ã€‚</font><font style="vertical-align: inherit;">å¦‚æœéƒ¨ç½²åˆ°Dockerå¹¶åˆ¶ä½œåŸºäºLinuxçš„æ˜ åƒï¼Œåˆ™å¯èƒ½è¿˜éœ€è¦å°†HttpClienté…ç½®ä¸ºå…è®¸æ— æ•ˆè¯ä¹¦ã€‚</font><font style="vertical-align: inherit;">ä¸ºæ¯ä¸ªé€šé“åˆ›å»ºHttpClientã€‚</font></font><br>
<br>
<pre><code class="cs hljs">httpClientBuilder.ConfigureChannel(o =&gt;<font></font>
{<font></font>
    <span class="hljs-comment">// add SSL credentials</span>
    o.Credentials = <span class="hljs-keyword">new</span> SslCredentials();
    <span class="hljs-comment">// allow invalid/untrusted certificates</span>
    <span class="hljs-keyword">var</span> httpClientHandler = <span class="hljs-keyword">new</span> HttpClientHandler<font></font>
    {<font></font>
        ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator<font></font>
    };<font></font>
    <span class="hljs-keyword">var</span> httpClient = <span class="hljs-keyword">new</span> HttpClient(httpClientHandler);<font></font>
    o.HttpClient = httpClient;<font></font>
});<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ·»åŠ HTTPå¤´</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ ‡å¤´è¢«æ·»åŠ åˆ°æ‹¦æˆªå™¨ç±»ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interceptorçš„</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åç»§è€…</font><font style="vertical-align: inherit;">ï¼‰ä¸­ã€‚</font><font style="vertical-align: inherit;">gRpcä½¿ç”¨å…ƒæ•°æ®çš„æ¦‚å¿µï¼Œå®ƒä¸è¯·æ±‚ä¸€èµ·ä½œä¸ºæ ‡å¤´å‘é€ã€‚</font><font style="vertical-align: inherit;">æ‹¦æˆªå™¨ç±»åº”ä¸ºè°ƒç”¨ä¸Šä¸‹æ–‡æ·»åŠ å…ƒæ•°æ®ã€‚</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AuthHeadersInterceptor</span> : <span class="hljs-title">Interceptor</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AuthHeadersInterceptor</span>(<span class="hljs-params">IHttpContextAccessor httpContextAccessor</span>)</span><font></font>
    {<font></font>
        _httpContextAccessor = httpContextAccessor;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> AsyncUnaryCall&lt;TResponse&gt; AsyncUnaryCall&lt;TRequest, TResponse&gt;(TRequest request, ClientInterceptorContext&lt;TRequest, TResponse&gt; context, AsyncUnaryCallContinuation&lt;TRequest, TResponse&gt; continuation)<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> metadata = <span class="hljs-keyword">new</span> Metadata<font></font>
        {<font></font>
            {HttpHeaderNames.Authorization, <span class="hljs-string">$"Bearer &lt;JWT_TOKEN&gt;"</span>}<font></font>
        };<font></font>
        <span class="hljs-keyword">var</span> userIdentity = _httpContextAccessor.HttpContext.User.Identity;
        <span class="hljs-keyword">if</span> (userIdentity.IsAuthenticated)<font></font>
        {<font></font>
            metadata.Add(HttpHeaderNames.User, userIdentity.Name);<font></font>
        }<font></font>
        <span class="hljs-keyword">var</span> callOption = context.Options.WithHeaders(metadata);<font></font>
        context = <span class="hljs-keyword">new</span> ClientInterceptorContext&lt;TRequest, TResponse&gt;(context.Method, context.Host, callOption);<font></font>
        <font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.AsyncUnaryCall(request, context, continuation);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºè¿™ç§æƒ…å†µï¼Œå½“æ‚¨ä»…è°ƒç”¨gRpcæœåŠ¡æ—¶ï¼Œåªéœ€è¦è¦†ç›–</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncUnaryCall</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–¹æ³•</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å½“ç„¶ï¼ŒJWTä»¤ç‰Œå¯ä»¥ä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™å°±æ˜¯å…¨éƒ¨ã€‚</font><font style="vertical-align: inherit;">ç¨åï¼Œæˆ‘å°†ä½¿ç”¨æè¿°çš„ç”¨ä¾‹çš„ç®€å•ç¤ºä¾‹æ·»åŠ åˆ°ä»£ç çš„é“¾æ¥ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ‚¨è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·å†™ä¿¡ç»™æˆ‘ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä¼šå°½åŠ›å›ç­”ã€‚</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN499576/index.html">å¦‚ä½•åœ¨Yandex.Directå’ŒGoogle Adsä¸­ä½¿ç”¨å¦å®šå…³é”®å­—[å¹¶ä½¿æµç¨‹è‡ªåŠ¨åŒ–]</a></li>
<li><a href="../zh-CN499578/index.html">ä½¿ç”¨mTCPå †æ ˆçš„DOSç½‘ç»œ</a></li>
<li><a href="../zh-CN499582/index.html">Node.jsçš„Predator-Preyæ¨¡å‹</a></li>
<li><a href="../zh-CN499584/index.html">å·¥ä¸šè§¦æ‘¸æ˜¾ç¤ºå™¨FPM-215W</a></li>
<li><a href="../zh-CN499586/index.html">å¦‚ä½•é€šè¿‡ç§»åŠ¨åº”ç”¨ç¨‹åºä¸­çš„å¯¼èˆªè¿›è¡Œæ€è€ƒ</a></li>
<li><a href="../zh-CN499592/index.html">AIï¼šä¸æ˜å¤©ä¸–ç•Œäº’è¡¥</a></li>
<li><a href="../zh-CN499594/index.html">å¦‚ä½•é™åˆ¶HAProxyä¸­çš„è¯·æ±‚é¢‘ç‡ï¼šåˆ†æ­¥è¯´æ˜</a></li>
<li><a href="../zh-CN499598/index.html">ç„¶åæˆ‘ä»¬å°†å‘åŒ—èµ°ï¼ç”±äºå¤©æ°”åŸå› ï¼Œæ˜¯å¦å¯ä»¥èŠ‚çœæ•°æ®ä¸­å¿ƒçš„æ•£çƒ­ï¼Ÿ</a></li>
<li><a href="../zh-CN499600/index.html">å¦‚ä½•ä¸€èµ·å·¥ä½œï¼Œåˆ†å¼€å·¥ä½œ</a></li>
<li><a href="../zh-CN499602/index.html">åœ¨çº¿å¬å¼€ä¼šè®®ï¼šInnerSource Commonså³°ä¼šä½“éªŒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>