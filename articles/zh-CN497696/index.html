<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👲🏻 🍹 👩‍🎓 Ryuk勒索软件如何攻击企业 🤱 🍓 🤦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ryuk是过去几年中最知名的勒索软件之一。自从他于2018年夏季首次露面以来，他已经编制了令人印象深刻的受害者名单，尤其是在商业环境中，这是他攻击的主要目标。
 
 1.一般信息
 本文档包含对Ryuk勒索软件选项的分析，以及负责将恶意软件下载到系统的引导程序。
 
 Ryuk勒索软件于2018年夏...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ryuk勒索软件如何攻击企业</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497696/"><img src="https://habrastorage.org/webt/wc/6r/b3/wc6rb3xxu-e_aw_mg1pxcy_23yq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ryuk是过去几年中最知名的勒索软件之一。</font><font style="vertical-align: inherit;">自从他于2018年夏季首次露面以来，他已经编制</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了令人印象深刻的受害者名单</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，尤其是在商业环境中，这是他攻击的主要目标。</font></font><a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.一般信息</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本文档包含对Ryuk勒索软件选项的分析，以及负责将恶意软件下载到系统的引导程序。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ryuk勒索软件于2018年夏季首次出现。 Ryuk与其他勒索软件之间的区别之一是，它旨在攻击企业环境。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在2019年中，网络犯罪集团借助该加密货币攻击了许多西班牙公司。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x5/ax/et/x5axetxacru5kb7h6er1vagmdqy.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font></font><br>
</i><br>
<img src="https://habrastorage.org/webt/oc/kn/ee/ockneevf4elmwczdwsmimtsvnuk.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图</font></font><br>
</i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">1：El Confidencial摘录的Ryuk勒索软件攻击[1] </font></i><i><font style="vertical-align: inherit;">2：摘自ElPaís的Ryuk勒索软件攻击[2]</font></i></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
。今年，Ryuk攻击了不同国家的许多公司。如下图所示，德国，中国，阿尔及利亚和印度遭受的损失最大。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
比较网络攻击的数量，我们可以看到Ryuk感染了数百万用户，大量数据遭到了破坏，从而造成了严重的经济损失。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-p/4u/y-/-p4uy-fnectlv0mqwtvupfa--vc.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 3：琉球全球活动的例证。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/sq/oe/hm/sqoehmto6enrwgz6kjt4_sdpgz0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 4：16个国家受影响最严重Ryuk </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/qj/1_/d2/qj1_d2eze5bigcd0gqvvrwiw9ns.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 5：受到Ryuk勒索软件攻击的用户数（以百万计）</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
根据这种威胁的通常运行原理，加密后的此勒索软件会向受害者显示勒索通知，必须以比特币将勒索通知支付给指定地址，以恢复对加密文件的访问。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自首次出现以来，该恶意软件已经发生了变化。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在尝试于2020年1月发动攻击时，发现了本文档中分析的这种威胁的变体。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于其复杂性，该恶意软件通常归因于有组织的网络犯罪分子，也称为APT组。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ryuk代码的一部分与另一位著名的Hermes密码学家的代码和结构非常相似，具有许多相同的功能。这就是为什么Ryuk最初与北韩组织Lazarus有联系的原因，当时该组织涉嫌隶属于Hermes勒索软件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
随后，CrowdStrike的Falcon X注意到Ryuk实际上是由WIZARD SPIDER [4]创建的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有一些证据支持这一假设。首先，该勒索软件在exploit.in网站上进行了广告宣传，该网站是俄罗斯一个知名的恶意软件市场，以前与一些俄罗斯APT组织相关。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这一事实不包括拉撒路APT小组可以开发Ryuk的理论，例如这与小组的行为方式不符。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，Ryuk被吹捧为无法在俄罗斯，乌克兰和白俄罗斯语系统上运行的加密器。此行为由Ryuk的某些版本中的功能确定，在该功能中，它将检查运行此加密器的系统的语言，并在系统具有俄语，乌克兰语或白俄罗斯语的情况下停止其操作。最后，在对被WIZARD SPIDER小组入侵的机器进行专家分析时，发现了一些“伪像”，据说是Hermes勒索软件的变体，用于Ryuk的开发中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另一方面，专家加布里埃拉·尼古拉（Gabriela Nicolao）和卢西亚诺·马丁斯（Luciano Martins）提出，密码学家可能是由CryptoTech APT团队开发的[5]。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是由于在Ryuk出现前几个月，该小组在他们开发了新版Hermes勒索软件的同一站点的论坛上发布了信息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一些论坛用户想知道CryptoTech是否真的创建了Ryuk。</font><font style="vertical-align: inherit;">此后，该小组为自己辩护，并表示有证据表明他们开发了该加密器的100％。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.特点</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们从引导加载程序开始，引导加载程序的任务是识别它所在的系统，以便您可以运行“正确”版本的Ryuk加密器。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
引导加载程序哈希值如下：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MD5 A73130B0E379A989CBA3D695A157A495 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SHA256 EF231EE1A2481B7E627921468E79BB4369CCFAEB19A575748DD2B664ABC4F469 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此引导加载程序的功能之一是它不包含任何数据-该恶意软件的创建者未在其中包含任何信息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有时它们包含错误的数据，以使用户认为自己正在启动合法的应用程序。</font><font style="vertical-align: inherit;">但是，正如我们稍后将看到的，如果感染不涉及与用户的交互（例如该加密器的情况），那么攻击者就认为没有必要使用元数据。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rj/zx/yu/rjzxyuaec1nfxajxzwufks4hb0w.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font><font style="vertical-align: inherit;">6：</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
样本</font><i><font style="vertical-align: inherit;">元数据样本</font></i><font style="vertical-align: inherit;">以32位格式编译，因此可以在32位和64位系统上运行。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.渗透向量</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下载并启动Ryuk的样本通过远程连接进入了我们的系统，由于初步的RDP攻击，获得了访问参数。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pt/jd/bj/ptjdbj8ce7mgfuy8vowq8gogitm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 7：攻击注册表</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
攻击者设法远程登录系统。之后，他用我们的示例创建了一个可执行文件。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
启动之前，该可执行文件已被防病毒解决方案阻止。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ez/gj/gq/ezgjgq4iagc2lep3pebhom5cox0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 8：阻止样品</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/tg/zv/-k/tgzv-keet96r81465eywpeahn8a.jpeg"><br>
<img src="https://habrastorage.org/webt/c_/0j/wz/c_0jwzu0madpx1t-pmfdznt-xny.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 9：样本锁定</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
当恶意文件被阻止时，攻击者试图下载可执行文件的加密版本，该文件也遭到了阻止。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/za/f8/mh/zaf8mhwwbu4rr9u_elmazc9cmns.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 10：攻击者试图运行的一组示例</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
最后，他试图通过加密的控制台下载另一个恶意文件</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PowerShell以绕过防病毒保护。</font><font style="vertical-align: inherit;">但是他也被封锁了。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lw/4b/mj/lw4bmjqpqtkf1zrqhhe0zb-4rzm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font><font style="vertical-align: inherit;">11：PowerShell和阻塞恶意内容</font></font><br>
</i><br>
<img src="https://habrastorage.org/webt/eu/dj/he/eudjheox40zpaop3cphprkuc-5c.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font><font style="vertical-align: inherit;">12：PowerShell中包含被阻止的恶意内容</font></font><br>
 </i><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.引导程序</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
执行后，它将自述文件写入</font><font style="vertical-align: inherit;">Ryuk典型</font><font style="vertical-align: inherit;">的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">％temp％</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件夹</font><font style="vertical-align: inherit;">。该文件-赎金要求，包含电子邮件地址protonmail域，在该恶意软件家族中很常见：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">msifelabem1981@protonmail.com </font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/qt/pg/zm/qtpgzmcdohk4siulk9nuayvwhqm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/bk/wa/u9/bkwau9on8kixa8bsmiikectemqu.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 13：兑换要求</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
执行Bootloader时，您会看到它启动了几个具有随机名称的可执行文件。它们存储在一个隐藏的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PUBLIC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件夹中</font><font style="vertical-align: inherit;">，但是如果</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“显示隐藏的文件和文件夹”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项在操作系统中未激活，则</font><font style="vertical-align: inherit;">它们将保持隐藏状态。此外，与父文件（32位）不同，这些文件是64位的。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8b/ko/z3/8bkoz3_hgnilr-2i7sytnv5g2ik.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/fe/fb/z-/fefbz-5_yiuoiftotqmnei2hrvq.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 14：示例启动的可执行文件</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
如上图所示，Ryuk启动icacls.exe，它将用于修改所有ACL（访问控制列表），从而保证访问和更改标志。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它可以在所有用户下完全访问设备（/ T）上的所有文件，而不管是否有错误（/ C），并且不显示任何消息（/ Q）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mf/bt/nc/mfbtnclxe4usjepbuizjzknslmu.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。图15：示例启动的icacls.exe的执行选项</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
必须注意Ryuk检查运行的是哪个Windows版本。为此，它</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetVersionExW</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查版本</font><font style="vertical-align: inherit;">，在其中检查</font><b><font style="vertical-align: inherit;">lpVersionInformation</font></b><font style="vertical-align: inherit;">标志的值。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">显示Windows的当前版本是否晚于</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows XP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lc/iv/yv/lcivyvqvjmm8jximv35wbo_v8ps.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/g8/t_/da/g8t_dabeoemyz2v0u93a8ivfilk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
引导加载程序将写入本地用户文件夹（在本例中为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">％Public％</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件夹），具体取决于您运行的是Windows XP还是更高版本</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gg/gr/at/gggrateobojjggmubdykjordzy4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 17：检查操作系统版本</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
记录的文件是Ryuk。然后启动它，并传递其自己的地址作为参数。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hh/0f/ct/hh0fctenv0yqswmtw9rhmhjjwv0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 18：通过ShellExecute运行Ryuk Ryuk要做</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
的第一件事是获取输入参数。这次有两个输入参数（可执行文件本身和放置程序地址），用于删除它们自己的跟踪。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1r/wu/vo/1rwuvoxtlg3lmusyoiem1v-e3da.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/op/wf/f7/opwff7lstsb0iq-nbvfqipywy6y.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 19：创建流程</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您还可以看到，一旦他启动了可执行文件，他就会删除自己，因此在执行文件夹中没有任何痕迹。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tp/ui/af/tpuiafv8uy2rmzsuememmnkaxxa.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font><font style="vertical-align: inherit;">20：删除文件</font></font></i><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. RYUK</font></font></h4><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1存在</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ryuk与其他恶意软件一样，会尝试在系统中保留的时间尽可能长。如上所示，一种实现此目标的方法是秘密创建和运行可执行文件。为此，最常见的做法是修改</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CurrentVersion \ Run</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注册表项</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这种情况下，您可以看到为此目的，第一个可执行文件</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VWjRF.exe</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
（文件名是随机生成的）启动</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmd.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/8b/g2/sd8bg232guhntext0cy-exeh3be.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/nn/og/fo/nnogfoscybmwjhn9xnwd0gw7118.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 21：执行VWjRF.exe文件</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
然后，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运行</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令中输入</font><font style="vertical-align: inherit;">名称为“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">svchos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“因此，如果您想随时检查注册表项，鉴于此名称与svchost相似，您将不会轻易注意到此更改。感谢此密钥，Ryuk可以确保其在系统中的存在。如果系统尚未被感染，然后，当您重新启动系统时，该可执行文件将重试。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ta/my/42/tamy42jg8mihxlgmxgzfjzqvfui.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图22：该示例确保了注册表项的存在</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
我们还可以看到，该可执行文件停止了两个服务：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audioendpointbuilder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”，顾名思义，它与系统匹配音频，</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h-/28/g8/h-28g8z69elv6rzdsjo2xuvrok4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图23：示例停止系统音频</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">samss服务</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这是帐户管理服务。停止这两项服务是Ryuk的一个特点。在这种情况下，如果系统连接到SIEM系统，则加密器尝试停止向</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SIEM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发送</font><font style="vertical-align: inherit;">任何警告。因此，他捍卫了下一步，因为在执行Ryuk之后，某些SAM服务将无法正确启动其工作。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/fn/l1/wjfnl14it7llrkny9xpfvrs30di.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 24：该示例停止了Samss服务</font></font></i><br>
 <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2特权</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
通常，Ryuk从网络内部的水平移动开始，或者由另一个恶意程序（例如</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emotet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trickbot）启动</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，在特权升级的情况下，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Ryuk</font></a><font style="vertical-align: inherit;">会将这些提升的权限转移给加密器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
预先，作为实现过程的序幕，我们看到它运行</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImpersonateSelf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过程</font><font style="vertical-align: inherit;">，这意味着访问令牌的安全性内容将被传输到流中，在该流中将立即使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetCurrentThread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接收它</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9y/nm/ut/9ynmutmaqq2wovbdswheiipajcc.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 25：调用ImpersonateSelf</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
然后我们看到它将访问令牌与流关联。我们还看到，标志之一是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DesiredAccess</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，可以用来控制流将具有的访问。在这种情况下，edx将接收的值必须为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TOKEN_ALL_ACESS，</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">否则为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TOKEN_WRITE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ui/vc/a_/uivca_yeyyvr5m-hwyolmei6k3u.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/tm/gy/yg/tmgyygvshjspnungxwqitl_jqm0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 26：创建流令牌</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
然后将使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SeDebugPrivilege</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">还将进行调用以获取与流有关的Debug调试权限，其结果是，通过指定</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PROCESS_ALL_ACCESS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它将能够访问任何所需的进程。现在，假设加密器已经具有准备好的流，则仅保留进行到最后阶段。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/lf/ki/0mlfkifvdv7hk7rizfyus_7oco4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 27：调用SeDebugPrivilege和权限提升功能</font></font><br>
 </i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
一方面，我们有LookupPrivilegeValueW，它为我们提供了有关我们要提升的特权的必要信息。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ts/wd/db/tswddbwi0jyghyqjpniu6rphmpe.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 28：请求有关特权升级的信息</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
另一方面，我们具有</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AdjustTokenPrivileges</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它使我们能够获得对流的必要权限。在这种情况下，最重要的是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NewState。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其标志将授予特权。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ki/sx/pa/kisxpam9ymp6ivk8remgfwfx4aq.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/9m/0s/sa/9m0ssakqkkjd4wzm4wqfav-mn7g.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。图29：设置令牌的权限</font></font></i><br>
 <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.3部署</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
在本节中，我们将显示示例如何执行此报告中先前提到的部署过程。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实施过程以及升级的主要目标是获得卷</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">影副本的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问权限</font><font style="vertical-align: inherit;">。为此，他需要使用权限高于本地用户权限的流。一旦获得更高的权限，他将删除副本并更改其他进程，以使其无法返回到操作系统中的较早还原点。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
与这种类型的恶意软件通常一样，它使用</font><b><font style="vertical-align: inherit;">CreateToolHelp32Snapshot</font></b><font style="vertical-align: inherit;">完成实施</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此它将对当前正在运行的进程进行快照，并尝试使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenProcess</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问这些进程</font><font style="vertical-align: inherit;">。一旦他可以访问该流程，他还将使用其信息打开令牌以获取流程参数。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dc/do/xz/dcdoxzczq1ti1kf5fu_5y_rikc8.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
图</font><i><font style="vertical-align: inherit;">30：从计算机接收进程</font></i><font style="vertical-align: inherit;">我们可以使用CreateToolhelp32Snapshot在例程140002D9C中动态查看其如何接收正在运行的进程的列表。在收到它们之后，他浏览了该列表，尝试使用OpenProcess逐个打开进程，直到可以执行为止。在这种情况下，他能够打开的第一个进程是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ taskhost.exe”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k0/24/og/k024ogcd6ioxwnjbfuhjuefrce4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 31：动态执行过程以获得过程</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们可以看到他随后读取了该进程的令牌，因此它是</font><font style="vertical-align: inherit;">带有“ </font><b><font style="vertical-align: inherit;">20008</font></b><font style="vertical-align: inherit;"> ”的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenProcessToken </font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">。 32：读取进程令牌信息</font></i><font style="vertical-align: inherit;"> 
还可以验证将其嵌入到其中的进程不是</font><b><font style="vertical-align: inherit;">csrss.exe</font></b><font style="vertical-align: inherit;">，</font><b><font style="vertical-align: inherit;">explorer.exe，lsaas.exe</font></b><font style="vertical-align: inherit;">或不是具有一组</font><b><font style="vertical-align: inherit;">NT授权</font></b><font style="vertical-align: inherit;">权限</font><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">图。图33：被排除的进程</font></i><font style="vertical-align: inherit;"> 
我们可以动态地查看它如何首先使用</font><b><font style="vertical-align: inherit;">140002D9C中</font></b><font style="vertical-align: inherit;">的进程令牌信息进行</font><b><font style="vertical-align: inherit;">检查，</font></b><font style="vertical-align: inherit;">以查明其权限用于执行该进程的帐户是否为</font><b><font style="vertical-align: inherit;">NT AUTHORITY</font></b><font style="vertical-align: inherit;">帐户</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/8j/zl/kn/8jzlkngsiwxlyol93ozqx8ebjrm.jpeg"><br>
<i><font style="vertical-align: inherit;"></font></i><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/hr/xr/9k/hrxr9kefgjfbtsex5awxtlqmjcm.jpeg"><br>
<i><font style="vertical-align: inherit;"></font></i><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/4v/_v/-c/4v_v-cloz4ndee9gs0qbihghn9k.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 34：检查NT权限</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
然后，在该过程之外，它检查它是否不是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">csrss.exe，explorer.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lsaas.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/uy/gg/wauyggzhisvonm1cyqr3cahfdc0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 35：检查NT权限</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
在对进程进行快照，打开进程并确认没有排除任何进程后，他准备将要实现的进程记入内存。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为此，他首先在内存中保留一个区域（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），对其进行写入（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessmemory</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），然后创建一个流（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。为了使用这些功能，他使用了所选进程的PID，这些PID是他先前使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateToolhelp32Snapshot</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">获得的</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s7/zp/pl/s7zpplpua6q4w1mgpurwvgtzyxy.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 36：嵌入代码</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
在这里，我们可以动态观察它如何使用进程PID来调用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><b><font style="vertical-align: inherit;">。</font></b></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/k1/j-/7nk1j-saztq--oxfo2xwzyiowgk.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。图37：调用VirtualAllocEx </font></font></i><br>
 <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.4加密</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
在本节中，我们将研究与加密有关的本示例的一部分。在下图中，您可以看到两个名为“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary_EncodeString</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”和“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encode_Func</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”的</font><font style="vertical-align: inherit;">例程</font><font style="vertical-align: inherit;">，它们负责执行加密过程。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o5/iu/1r/o5iu1rimo3qfnbgpnl4mvwcpwug.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 38：加密过程</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
首先，我们可以看到它如何加载一个字符串，该字符串随后将用于反混淆所需的所有内容：导入，DLL，命令，文件和CSP。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/x6/te/dux6tehj_i7jcqkupvfdb3hlcfw.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 39：去模糊链</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下图显示了它在R4寄存器</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary中进行</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模糊处理的第一个导入</font><font style="vertical-align: inherit;">。稍后将使用它来加载必要的DLL。我们还可以在寄存器R12中看到另一行，该行与前一行一起用于执行去模糊处理。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/la/oo/to/laootohjrpgt3fa-yeetqz6rxzo.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 40：动态模糊处理</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
他继续加载命令，稍后将执行这些命令以禁用备份，还原点和安全启动模式。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/qt/le/ceqtleaezfngmfgtrlhpgxl-vbw.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 41：下载命令</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
然后加载将放置3个文件的位置：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows.bat，run.sct</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start.bat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ef/wj/9f/efwj9fcrtd5vai-3jjp6kblwsu0.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/jx/sg/sa/jxsgsaqyu0omqswv0-eseu5aeok.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/yq/g4/ur/yqg4urwb1wqlo52wgoocuccbi00.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/i2/fc/2t/i2fc2t2mcj6qrwau7gikqb4ohf4.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 42：文件位置</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这3个文件用于检查每个位置所具有的特权。如果所需的特权不可用，Ryuk将停止执行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它继续加载对应于三个文件的行。第一个</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DECRYPT_INFORMATION.html</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含还原文件所需的信息。第二个</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PUBLIC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含RSA公钥。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vf/w1/do/vfw1doq6ayau0i8pkniuc-rd5mk.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 43：字符串</font></font></i><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">DECRYPT </font></b><i><font style="vertical-align: inherit;">INFORMATION.html</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
第三，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNIQUE_ID_DO_NOT_REMOVE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，包含将在下一个例程中执行加密的加密密钥。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u_/1l/s1/u_1ls1stszk23gkrsh2mwonnvgi.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 44：唯一标识不要删除字符串</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
最后，它将加载所需的库以及所需的导入和CSP（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft增强RSA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AES密码提供程序</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7d/b9/q1/7db9q1wjr1k_y1bfsefiewsc-6g.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 45：下载库</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
完成所有去模糊处理后，他继续执行加密所需的操作：遍历所有逻辑驱动器，执行上一子例程中加载的内容，增强系统中的存在性，删除RyukReadMe.html文件，加密，枚举所有网络驱动器，切换到发现的设备及其加密。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这一切都始于下载“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmd.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”并编写RSA公钥。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_n/me/r-/_nmer-jvdpleozaujmoemqo7u9s.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 46：准备加密</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
然后</font><i><font style="vertical-align: inherit;">，</font></i><font style="vertical-align: inherit;">它使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetLogicalDrives</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检索所有逻辑驱动器，</font><font style="vertical-align: inherit;">并禁用所有备份，恢复点和安全启动模式。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fa/ov/f8/faovf8myihdrkrtulhzcu_50e8q.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 47：停用恢复工具</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
之后，他增强了他在系统中存在，正如我们上面看到的，和第一写入</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RyukReadMe.html</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文件</font><font style="vertical-align: inherit;">到</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TEMP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x8/7u/at/x87uatt-xtzmrn0un3-jqt5o0hw.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
图</font><i><font style="vertical-align: inherit;">48：发布回购通知</font></i><font style="vertical-align: inherit;">在下图中，你可以看到它是如何创建一个文件，下载的内容，并将其写入：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/5o/2n/vu5o2nliyrqgsmugbe9jpx0-1mc.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。图49：下载并记录文件内容</font></font></i><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
为了能够在所有设备上执行相同的操作，它使用</font><font style="vertical-align: inherit;">了上面显示的</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">icacls.exe</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bd/6a/qb/bd6aqbnkrrba-polrck91kh53w0.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 50：使用icalcls.exe</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，它开始加密文件，但“ * .exe”，“ * .dll”文件，系统文件和其他指定为加密白名单的位置除外。</font><font style="vertical-align: inherit;">为此，它使用导入：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptAcquireContextW</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（指示使用AES和RSA），</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptDeriveKey，CryptGenKey</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptDestroyKey</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">等。</font><font style="vertical-align: inherit;">还试图使用WNetEnumResourceW扩大对检测到的网络设备的影响，然后对其进行加密。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9j/yn/mj/9jynmjtzu26dwvfg3ugrthcxo0o.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font><font style="vertical-align: inherit;">51：系统文件加密</font></font></i><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.进口及相关标志</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下表列出了该示例使用的最相关的导入和标志：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/bn/he/ribnhe9istspdndifpecxgnzljc.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.国际奥委会</font></font></h4><br>
<img src="https://habrastorage.org/webt/bf/gu/cr/bfgucrrkqw-l2jurn09ovgljhas.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户\公共\ run.sct</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开始菜单\程序\启动\ start.bat AppData \漫游\ Microsoft \ Windows \开始</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">菜单\ ProgramsStartup \ start.bat</font></font></li>
</ul><br>
<br>
<img src="https://habrastorage.org/webt/ld/od/e2/ldode2_iiqa4jqw4ol46ch5dov4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由PandaLabs防病毒实验室专家编写的Ryuk勒索软件技术报告。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.参考</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.“ Everis y Prisa Radio sufren ungrave ciberataque que secuestra sus sistemas。” Https：// www。 elconfidencial.com/tecnologia/2019-11-04/everis-la-ser-ciberataque-ransomware-15_2312019 /，Publicada el 04/11/2019。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.“重要的西班牙国家病毒”。Https：//elpais.com/ tecnologia / 2019/11/04 / actualidad / 1572897654_ 251312.html，Publicada el 04/11/2019。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.“ VB2019文件：Shinigami的报仇：Ryuk恶意软件的长尾巴。” Https://securelist.com/ story-of-the-year-2019-cities-under-ransomware-siege / 95456 /，Publicada el 11 / </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12/2019 4.“与Ryuk进行大型游戏狩猎：另一种基于Lucrative的勒索软件。” Https：// www。 Popularstr.com/blog/big-game-hunting-with-ryuk-another-lucrative-targeted-ransomware/，Publicada el 01/10/2019。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5.“ VB2019文件：Shinigami的复仇：Ryuk恶意软件的长尾巴。” Https：// www。</font><font style="vertical-align: inherit;">virusbulletin.com/virusbulletin/2019/10/vb2019-paper-shinigamis-revenge-long-tail-r</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN497680/index.html">您的电报似乎正在流动</a></li>
<li><a href="../zh-CN497682/index.html">NVIDIA的Pavel Klemenkov：我们正在努力缩小数据科学家可以做的事情与他需要做的事情之间的差距。</a></li>
<li><a href="../zh-CN497684/index.html">炒作曲线：哪些IT技术处于巅峰状态，哪些将保持稳定的需求</a></li>
<li><a href="../zh-CN497686/index.html">杀菌细菌植入材料</a></li>
<li><a href="../zh-CN497688/index.html">Kubernetes夜校如何运作</a></li>
<li><a href="../zh-CN497700/index.html">从4月17日开始，每周在线备份，开发人员，安全和机器人</a></li>
<li><a href="../zh-CN497702/index.html">2020年您应注意的五个数据存储趋势</a></li>
<li><a href="../zh-CN497708/index.html">我们邀请您参加4月和5月的一系列Fujitsu网络研讨会</a></li>
<li><a href="../zh-CN497714/index.html">如何在macOS上保护进程和内核扩展</a></li>
<li><a href="../zh-CN497724/index.html">准备服务器以用Python发布Web应用程序</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>