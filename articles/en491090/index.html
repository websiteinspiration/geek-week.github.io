<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèá üÜñ üôçüèΩ Convert text documents to xml in C # üë∂üèΩ üß§ üïü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I had to deal with the need to get text from office documents ( docx, xlsx, rtf , doc, xls, odt and ods ). The task was complicated by the r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Convert text documents to xml in C #</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491090/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recently, I had to deal with the need to get text from office documents ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docx, xlsx, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rtf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , doc, xls, odt and ods</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">The task was complicated by the requirement to present the text in xml format without garbage with the structure most convenient for further parsing.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The decision to use </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interop</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> immediately fell away due to its cumbersome nature, largely redundancy, and the need to install </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS Office</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the server </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As a result, a solution was found and implemented on an internal project. </font><font style="vertical-align: inherit;">However, the search turned out to be so complicated and not trivial due to the lack of any generally accessible manuals that I decided to write a library in my spare time that would solve the specified task, and also create a kind of instruction to write so that the developers read she was able, at least superficially, to understand the issue.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before proceeding to the description of the solution found, I suggest that you familiarize yourself with some of the conclusions that were made as a result of my research:</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the .Net platform, there is no ready-made solution for working with all of the listed formats, which will force us to castilize our solution in some places.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not try to find a good manual on working with Microsoft OpenXML on the net: to deal with this library you will have to pretty red-eyed, smoke StackOverflow and play with the debugger.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes, I still managed to tame the dragon. </font></font></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I‚Äôll immediately make a reservation that at the moment the library is not yet ready, but it is actively being written (as much as free time allows). </font><font style="vertical-align: inherit;">It is assumed that separate posts for each format will be written and in parallel, together with their publication, the repository on the github will be updated, from where it will be possible to get the sources.</font></font></p><br>
<h2 id="rabota-s-xlsx-i-docx"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work with xlsx and docx</font></font></strong></h2><a name="habracut"></a><br>
<h3 id="xlsx"><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.xlsx</font></font></strong></h3><br>
<p>,     ,    ,  <em>docx</em>  <em>xlsx</em>   <em>zip-</em>,      xml.  ,       :     zip    . ,        : <code>\xl\worksheets</code>.</p><br>
<p>     excel , ,   -     ,      :</p><br>
<p><img src="https://habrastorage.org/webt/wu/0h/si/wu0hsi7jshuxcgbjb9gyqighmuk.png"></p><br>
<p>   ,   ,   ,   (  <code>&lt;f&gt;</code>)   (  <code>&lt;v&gt;</code>). ,       <code>shared</code>        sharedStrings.xml,    <code>\xl</code>.<br>
     :      .</p><br>
<p>,    -,   <strong><em>IConvertable</em></strong>:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.IO;
<span class="hljs-keyword">using</span> System.Text;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">ConverterToXml.Converters</span><font></font>
{<font></font>
    <span class="hljs-keyword">interface</span> <span class="hljs-title">IConvertable</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">string</span> <span class="hljs-title">Convert</span>(<span class="hljs-params">Stream stream</span>)</span>;
        <span class="hljs-function"><span class="hljs-keyword">string</span> <span class="hljs-title">ConvertByFile</span>(<span class="hljs-params">String path</span>)</span>;<font></font>
<font></font>
    }<font></font>
}</code></pre><br>
<p>   ,     : <code>string Convert(Stream stream)</code>     (   ,    -        ),   <code>string ConvertByFile(String path)</code>    .</p><br>
<p>  <code>XlsxToXml</code>,   <code>IConvertable</code>    Nuget <strong><em>DocumentFormat.OpenXml</em></strong> (  ,    2.10.0). </p><br>
<p>        <code>string SpreadsheetProcess(Stream memStream)</code>,     <code>string Convert(Stream stream)</code>.</p><br>
<pre><code class="cs hljs">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-title">Convert</span>(<span class="hljs-params">Stream memStream</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> SpreadsheetProcess(memStream);<font></font>
        }</code></pre><br>
<p> ,      <code>*string SpreadsheetProcess(Stream memStream)*</code>:</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">string</span> <span class="hljs-title">SpreadsheetProcess</span>(<span class="hljs-params">Stream memStream</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> (SpreadsheetDocument doc = SpreadsheetDocument.Open(memStream, <span class="hljs-literal">false</span>))<font></font>
            {<font></font>
                memStream.Position = <span class="hljs-number">0</span>;<font></font>
                StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-number">1000</span>);<font></font>
                sb.Append(<span class="hljs-string">"&lt;?xml version=\"1.0\"?&gt;&lt;documents&gt;&lt;document&gt;"</span>);<font></font>
                SharedStringTable sharedStringTable = doc.WorkbookPart.SharedStringTablePart.SharedStringTable; <font></font>
                <span class="hljs-keyword">int</span> sheetIndex = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">foreach</span> (WorksheetPart worksheetPart <span class="hljs-keyword">in</span> doc.WorkbookPart.WorksheetParts)<font></font>
                {<font></font>
                    WorkSheetProcess(sb, sharedStringTable, worksheetPart, doc, sheetIndex);<font></font>
                    sheetIndex++;<font></font>
                }<font></font>
                sb.Append(<span class="hljs-string">@"&lt;/document&gt;&lt;/documents&gt;"</span>);
                <span class="hljs-keyword">return</span> sb.ToString();<font></font>
            }<font></font>
        }</code></pre><br>
<p>,   <code>string SpreadsheetProcess(Stream memStream)</code>  :</p><br>
<ol>
<li><p>  <code>using</code>   excel  .    xlsx   <em>DocumentFormat.OpenXml</em>   <em>SpreadsheetDocument</em>.</p><br>
</li>
<li><p>        StringBuilder sb (  1000 .  StringBuilder  ,              . ,     ,         .</p><br>
</li>
<li><p>    shared  (    ).  ,    SpreadsheetDocument    :<br>
<code>SharedStringTable sharedStringTable = doc.WorkbookPart.SharedStringTablePart.SharedStringTable</code>.</p><br>
</li>
<li><p>  ,          </p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">foreach</span> (WorksheetPart worksheetPart <span class="hljs-keyword">in</span> doc.WorkbookPart.WorksheetParts)<font></font>
            {<font></font>
                WorkSheetProcess(sb, sharedStringTable, worksheetPart, doc, sheetIndex);<font></font>
                sheetIndex++;<font></font>
            }</code></pre><br>
<p>         <br>
<code>WorkSheetProcess(sb, sharedStringTable, worksheetPart, doc, sheetIndex);</code>:</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WorkSheetProcess</span>(<span class="hljs-params">StringBuilder sb, SharedStringTable sharedStringTable, WorksheetPart worksheetPart, SpreadsheetDocument doc,
        <span class="hljs-keyword">int</span> sheetIndex</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">string</span> sheetName = doc.WorkbookPart.Workbook.Descendants&lt;Sheet&gt;().ElementAt(sheetIndex).Name.ToString();<font></font>
        sb.Append(<span class="hljs-string">$"&lt;sheet name=\"<span class="hljs-subst">{sheetName}</span>\"&gt;"</span>);
        <span class="hljs-keyword">foreach</span> (SheetData sheetData <span class="hljs-keyword">in</span> worksheetPart.Worksheet.Elements&lt;SheetData&gt;())<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (sheetData.HasChildren)<font></font>
            {<font></font>
                <span class="hljs-keyword">foreach</span> (Row row <span class="hljs-keyword">in</span> sheetData.Elements&lt;Row&gt;())<font></font>
                {<font></font>
                    RowProcess(row, sb, sharedStringTable);<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        sb.Append(<span class="hljs-string">$"&lt;/sheet&gt;"</span>);<font></font>
    }</code></pre><br>
</li>
<li><p>,        :<br>
<code>string sheetName = doc.WorkbookPart.Workbook.Descendants&lt;Sheet&gt;().ElementAt(sheetIndex).Name.ToString();</code><br>
,       ,  .  ,           .   ,   ,  shift+F9(    ),   <code>doc</code>(    )-&gt;WorkbookPart-&gt;Workbook    Descendants(),        <code>Sheet</code>.         ,        (    ).        :<img src="https://habrastorage.org/webt/mi/rb/ek/mirbek__plrqys_9zvmovwhszng.png"><br>
</p><br>
</li>
<li><p>     <code>foreach</code>    ,     .    <code>sheetData</code>  - ,   ,       <code>RowProcess</code>:</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">foreach</span> (SheetData sheetData <span class="hljs-keyword">in</span> worksheetPart.Worksheet.Elements&lt;SheetData&gt;())<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (sheetData.HasChildren)<font></font>
            {<font></font>
                <span class="hljs-keyword">foreach</span> (Row row <span class="hljs-keyword">in</span> sheetData.Elements&lt;Row&gt;())<font></font>
                {<font></font>
                    RowProcess(row, sb, sharedStringTable);<font></font>
                }<font></font>
            }<font></font>
        }</code></pre><br>
</li>
<li><p>  <code>void RowProcess(Row row, StringBuilder sb, SharedStringTable sharedStringTable)</code>  :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RowProcess</span>(<span class="hljs-params">Row row, StringBuilder sb, SharedStringTable sharedStringTable</span>)</span><font></font>
    {<font></font>
        sb.Append(<span class="hljs-string">"&lt;row&gt;"</span>);
        <span class="hljs-keyword">foreach</span> (Cell cell <span class="hljs-keyword">in</span> row.Elements&lt;Cell&gt;())<font></font>
        {<font></font>
            <span class="hljs-keyword">string</span> cellValue = <span class="hljs-keyword">string</span>.Empty;<font></font>
            sb.Append(<span class="hljs-string">"&lt;cell&gt;"</span>);
            <span class="hljs-keyword">if</span> (cell.CellFormula != <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                cellValue = cell.CellValue.InnerText;<font></font>
                sb.Append(cellValue);<font></font>
                sb.Append(<span class="hljs-string">"&lt;/cell&gt;"</span>);
                <span class="hljs-keyword">continue</span>;<font></font>
            }<font></font>
            cellValue = cell.InnerText;<font></font>
            <span class="hljs-keyword">if</span> (cell.DataType != <span class="hljs-literal">null</span> &amp;&amp; cell.DataType == CellValues.SharedString)<font></font>
            {<font></font>
                sb.Append(sharedStringTable.ElementAt(Int32.Parse(cellValue)).InnerText);<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span><font></font>
            {<font></font>
                sb.Append(cellValue);<font></font>
            }<font></font>
            sb.Append(<span class="hljs-string">"&lt;/cell&gt;"</span>);<font></font>
        }<font></font>
        sb.Append(<span class="hljs-string">"&lt;/row&gt;"</span>);<font></font>
    }</code></pre><br>
<p>  <code>foreach (Cell cell in row.Elements&lt;Cell&gt;())</code>          :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">if</span> (cell.CellFormula != <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                cellValue = cell.CellValue.InnerText;<font></font>
                sb.Append(cellValue);<font></font>
                sb.Append(<span class="hljs-string">"&lt;/cell&gt;"</span>);
                <span class="hljs-keyword">continue</span>;<font></font>
            }</code></pre><br>
<p>  ,   ,    (<code>cellValue = cell.CellValue.InnerText;</code>)     .<br>
    ,   ,    <em>shared</em>:  ,            :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">if</span> (cell.DataType != <span class="hljs-literal">null</span> &amp;&amp; cell.DataType == CellValues.SharedString)<font></font>
            {<font></font>
                sb.Append(sharedStringTable.ElementAt(Int32.Parse(cellValue)).InnerText);<font></font>
            }</code></pre><br>
<p>  ,      .</p><br>
</li>
</ol><br>
<br>
<h3 id="docx"><strong>.docx</strong></h3><br>
<p>  ,    <em>word</em>             <em>excel-</em>.<br>
,        ,    ,  ,  ,  ,    .         , ,   ..,       , ,   ,  -       ,     ,  .</p><br>
<p>,        .          <em>zip</em>     .     .   <em>word</em>    <em>document</em>. ,     ,  ,   ,      . ,       :     -   .</p><br>
<p>  ,       <em>w:t</em>,    <em>w:r</em>,     <em>w:p</em>.   ,        docx,    .    :       ,     <em>w:numPr</em>,       (<em>w:ilvl</em>)  id ,     (<em>w:numId</em>).<br>
<img src="https://habrastorage.org/webt/ev/mw/a9/evmwa9h1h1hb1h50fdxqg9kpb8k.png"><br>
,   ,            , ,    (  ,     ),  ,    id ,   ,      .<br>
    ,       ,       :<br>
<img src="https://habrastorage.org/webt/qt/9t/c9/qt9tc9palxsu_6qdxtxwletzmam.png"><br>
 ,      .       <em>w:tr ()</em>  <em>w:tc().</em><br>
<img src="https://habrastorage.org/webt/fx/ah/rs/fxahrshoxihokxa8h6u6fxbfdci.png"><br>
</p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before I start coding, I want to pay attention to one very important nuance (yes, as in the joke about Petka and Vasily Ivanovich). When parsing lists, especially when it comes to nested lists, a situation may arise when the list items are separated by some kind of insertion of text, image, or anything else. Then the question arises, when do we put the closing tag of the list? My suggestion, smelling of crutching and bicycle building, comes down to adding a dictionary, the keys of which will be the id of the lists, and the value will correspond to the id of the paragraph (yes, it turns out each paragraph in the document has its own unique id), which is also the last in a list. Perhaps it‚Äôs written quite difficult, but I think when you look at the implementation, it will become somewhat clearer:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-title">Convert</span>(<span class="hljs-params">Stream memStream</span>)</span><font></font>
{<font></font>
    Dictionary&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">string</span>&gt; listEl = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">string</span>&gt;();
    <span class="hljs-keyword">string</span> xml = <span class="hljs-keyword">string</span>.Empty;<font></font>
    memStream.Position = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">using</span> (WordprocessingDocument doc = WordprocessingDocument.Open(memStream, <span class="hljs-literal">false</span>))<font></font>
    {<font></font>
        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-number">1000</span>); <font></font>
        sb.Append(<span class="hljs-string">"&lt;?xml version=\"1.0\"?&gt;&lt;documents&gt;&lt;document&gt;"</span>);<font></font>
        Body docBody = doc.MainDocumentPart.Document.Body;<font></font>
        CreateDictList(listEl, docBody);<font></font>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> element <span class="hljs-keyword">in</span> docBody.ChildElements)<font></font>
        {<font></font>
            <span class="hljs-keyword">string</span> type = element.GetType().ToString();
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                <span class="hljs-keyword">switch</span> (type)<font></font>
                {<font></font>
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"DocumentFormat.OpenXml.Wordprocessing.Paragraph"</span>:
                        <span class="hljs-keyword">if</span> (element.GetFirstChild&lt;ParagraphProperties&gt;() != <span class="hljs-literal">null</span>)<font></font>
                        {<font></font>
                            <span class="hljs-keyword">if</span> (element.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val != CurrentListID)<font></font>
                            {<font></font>
                                CurrentListID = element.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val;<font></font>
                                sb.Append(<span class="hljs-string">$"&lt;li id=\"<span class="hljs-subst">{CurrentListID}</span>\"&gt;"</span>);<font></font>
                                InList = <span class="hljs-literal">true</span>;<font></font>
                                ListParagraph(sb, (Paragraph)element);<font></font>
                            }<font></font>
                            <span class="hljs-keyword">else</span><font></font>
                            {<font></font>
                                ListParagraph(sb, (Paragraph)element);<font></font>
                            }<font></font>
                            <span class="hljs-keyword">if</span> (listEl.ContainsValue(((Paragraph)element).ParagraphId.Value))<font></font>
                            {<font></font>
                                sb.Append(<span class="hljs-string">$"&lt;/li id=\"<span class="hljs-subst">{element.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val}</span>\"&gt;"</span>);<font></font>
                            }<font></font>
                            <span class="hljs-keyword">continue</span>;<font></font>
                        }<font></font>
                        <span class="hljs-keyword">else</span><font></font>
                        {<font></font>
                            SimpleParagraph(sb, (Paragraph)element);<font></font>
                            <span class="hljs-keyword">continue</span>;<font></font>
                        }<font></font>
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"DocumentFormat.OpenXml.Wordprocessing.Table"</span>:<font></font>
                        Table(sb, (Table)element);<font></font>
                        <span class="hljs-keyword">continue</span>;<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (Exception e)<font></font>
            {<font></font>
                <span class="hljs-keyword">continue</span>;<font></font>
            }<font></font>
        }<font></font>
        sb.Append(<span class="hljs-string">@"&lt;/document&gt;&lt;/documents&gt;"</span>);<font></font>
        xml = sb.ToString();<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> xml;<font></font>
}</code></pre><br>
<ol>
<li><p><code>Dictionary&lt;int, string&gt; listEl = new Dictionary&lt;int, string&gt;();</code> ‚Äî            .</p><br>
</li>
<li><p><code>using (WordprocessingDocument doc = WordprocessingDocument.Open(memStream, false))</code> ‚Äî   <code>doc</code>  WordprocessingDocument,       word,     ( ,      OpenXML) .</p><br>
</li>
<li><p><code>StringBuilder sb = new StringBuilder(1000);</code> ‚Äî          xml.</p><br>
</li>
<li><p><code>Body docBody = doc.MainDocumentPart.Document.Body;</code> ‚Äî    ,       </p><br>
</li>
<li><p>  <code>CreateDictList(listEl, docBody);</code>,     foreach    ,       :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CreateDictList</span>(<span class="hljs-params">Dictionary&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">string</span>&gt; listEl, Body docBody</span>)</span><font></font>
{<font></font>
<span class="hljs-keyword">foreach</span>(<span class="hljs-keyword">var</span> el <span class="hljs-keyword">in</span> docBody.ChildElements)<font></font>
{<font></font>
    <span class="hljs-keyword">if</span>(el.GetFirstChild&lt;ParagraphProperties&gt;() != <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> key = el.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val;<font></font>
        listEl[key] = ((DocumentFormat.OpenXml.Wordprocessing.Paragraph)el).ParagraphId.Value;<font></font>
    }<font></font>
}<font></font>
}</code></pre><br>
<p><code>GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val;</code> ‚Äî            (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">https://docs.microsoft.com/ru-ru/office/open-xml/open-xml-sdk</a>     ),         .   ,          ,  ,    )</p><br>
</li>
<li><p> ,    ,   foreach     .           :   .  ,     ,        .      ,           (,   )  ,          .  ,          .      :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">string</span> type = element.GetType().ToString();
               <span class="hljs-keyword">try</span><font></font>
{<font></font>
<span class="hljs-keyword">switch</span> (type)<font></font>
{<font></font>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"DocumentFormat.OpenXml.Wordprocessing.Paragraph"</span>:<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (element.GetFirstChild&lt;ParagraphProperties&gt;() != <span class="hljs-literal">null</span>) <span class="hljs-comment">//  /  </span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (element.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val != CurrentListID)<font></font>
            {<font></font>
                CurrentListID = element.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val;<font></font>
                sb.Append(<span class="hljs-string">$"&lt;li id=\"<span class="hljs-subst">{CurrentListID}</span>\"&gt;"</span>);<font></font>
                InList = <span class="hljs-literal">true</span>;<font></font>
                ListParagraph(sb, (Paragraph)element);<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span> <span class="hljs-comment">//  </span><font></font>
            {<font></font>
                ListParagraph(sb, (Paragraph)element);<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span> (listEl.ContainsValue(((Paragraph)element).ParagraphId.Value))<font></font>
            {<font></font>
                sb.Append(<span class="hljs-string">$"&lt;/li id=\"<span class="hljs-subst">{element.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val}</span>\"&gt;"</span>);<font></font>
            }<font></font>
            <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> <span class="hljs-comment">//  </span><font></font>
        {<font></font>
            SimpleParagraph(sb, (Paragraph)element);<font></font>
            <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"DocumentFormat.OpenXml.Wordprocessing.Table"</span>:<font></font>
<font></font>
        Table(sb, (Table)element);<font></font>
        <span class="hljs-keyword">continue</span>;<font></font>
}<font></font>
}</code></pre><br>
<p> <code>try-catch</code>     ,       - ,      <code>switch-case</code> (  ,     ,   ).  ,     -     ,      .</p><br>
</li>
<li><p>    ,       <code>ListParagraph(sb, (Paragraph)element);</code> :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ListParagraph</span>(<span class="hljs-params">StringBuilder sb, Paragraph p</span>)</span><font></font>
{<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">var</span> level = p.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingLevelReference&gt;().Val;
<span class="hljs-comment">// id </span>
<span class="hljs-keyword">var</span> id = p.GetFirstChild&lt;ParagraphProperties&gt;().GetFirstChild&lt;NumberingProperties&gt;().GetFirstChild&lt;NumberingId&gt;().Val;<font></font>
sb.Append(<span class="hljs-string">$"&lt;ul id=\"<span class="hljs-subst">{id}</span>\" level=\"<span class="hljs-subst">{level}</span>\"&gt;&lt;p&gt;<span class="hljs-subst">{p.InnerText}</span>&lt;/p&gt;&lt;/ul id=\"<span class="hljs-subst">{id}</span>\" level=\"<span class="hljs-subst">{level}</span>\"&gt;"</span>);<font></font>
}</code></pre><br>
<p>            <code>&lt;ul&gt;</code>,     id    .</p><br>
</li>
<li><p> ,       ,       <code>SimpleParagraph(sb, (Paragraph)element);</code>:</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SimpleParagraph</span>(<span class="hljs-params">StringBuilder sb, Paragraph p</span>)</span><font></font>
{<font></font>
sb.Append(<span class="hljs-string">$"&lt;p&gt;<span class="hljs-subst">{p.InnerText}</span>&lt;/p&gt;"</span>);<font></font>
}</code></pre><br>
<p> ,       <code>&lt;p&gt;</code></p><br>
</li>
<li><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The table is processed in the method </font></font><code>Table(sb, (Table)element);</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font></p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Table</span>(<span class="hljs-params">StringBuilder sb, Table table</span>)</span><font></font>
{<font></font>
sb.Append(<span class="hljs-string">"&lt;table&gt;"</span>);
<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> row <span class="hljs-keyword">in</span> table.Elements&lt;TableRow&gt;())<font></font>
{<font></font>
sb.Append(<span class="hljs-string">"&lt;row&gt;"</span>);
<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> cell <span class="hljs-keyword">in</span> row.Elements&lt;TableCell&gt;())<font></font>
{<font></font>
sb.Append(<span class="hljs-string">$"&lt;cell&gt;<span class="hljs-subst">{cell.InnerText}</span>&lt;/cell&gt;"</span>);<font></font>
}<font></font>
sb.Append(<span class="hljs-string">"&lt;/row&gt;"</span>);<font></font>
}<font></font>
sb.Append(<span class="hljs-string">"&lt;/table&gt;"</span>);}</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The processing of such an element is quite trivial: we read the lines, break them into cells, take values ‚Äã‚Äãfrom the cells, wrap them in tags </font></font><code>&lt;cell&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which we pack in tags </font></font><code>&lt;row&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and put all this inside </font></font><code>&lt;table&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></p><br>
</li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this, I propose to consider the task as solved for documents of the docx and xlsx format. </font></font></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The source code can be viewed in the repository at the link</font></font></a></p><br>
<p><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Rtf</font></a><font style="vertical-align: inherit;"> conversion article</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491062/index.html">Angular: creating a custom form element and passing form state to it</a></li>
<li><a href="../en491076/index.html">Clever work with RabbitMQ in NestJS</a></li>
<li><a href="../en491084/index.html">saneex.c: try / catch / finally based on setjmp / longjmp (C99) faster than standard C ++ exceptions ¬π</a></li>
<li><a href="../en491086/index.html">Webix JavaScript library through the eyes of a beginner. Part 6. Server interaction</a></li>
<li><a href="../en491088/index.html">GitHub: New Open Source Library for OSINT</a></li>
<li><a href="../en491092/index.html">How Crash Bandicoot Hacked Playstation</a></li>
<li><a href="../en491094/index.html">Installing Firebird 3 on Modern Linux Versions: CentOS8 and Ubuntu 19</a></li>
<li><a href="../en491100/index.html">On Wanhao 5S, they printed a doll with a height of a person</a></li>
<li><a href="../en491102/index.html">How to develop a service when there are tough competitors around</a></li>
<li><a href="../en491104/index.html">How I found a hardware glitch on my Lenovo MiiX 2 10 tablet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>