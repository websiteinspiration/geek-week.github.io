<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø üë©üèª‚Äçüé® üòî Angular: Integration Testing (Shallow testing) üôç üé™ üöç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When the application grows, or it is very important for us that it works correctly with any refactoring, we begin to think about unit or e2e testing. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Angular: Integration Testing (Shallow testing)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/veeam/blog/486994/"><img src="https://habrastorage.org/webt/6q/1i/kq/6q1ikqijgoa4cfkq7fk7n2di1ey.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the application grows, or it is very important for us that it works correctly with any refactoring, we begin to think about unit or e2e testing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For several years of working with Angular - applications in the corporate segment, having caught many problems when refactoring and creating new functionality, tests do not seem like a waste of time, but the key to stability in the hands of programmers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, let's try to understand how to test the basic application on Angular and touch on a little theory.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the types of testing that application developers can do (in our case, frontend). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/hc/q_/wphcq_xxcqgyvvyvoyvjlbyvx3w.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Martin Fowler and Google Testing Blog)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Angular has such methods out of the box. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a closer look at the testing pyramid using the example of Angular applications. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unit testing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - isolated testing of class methods. We check the operation of the method, passing various combinations of parameters to the input, and compare the result with the expected one. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we have a component in which hex strings are converted to rgb, this information is displayed to the user, and also sent to the rest server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we start looking towards unit tests, then we can write many tests for each method in the component class.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we have a method rgbToHex (hex: string) =&gt; string, then to test a method with such a signature we need to do the following: expect (rgbToHex ('777')). ToBe ('rgb (119, 119, 119)') . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems great, but we have a problem due to the large number of functions that need to be covered, and we are too lazy to write tests. In addition, even writing unit tests for each method in a component, we do not guarantee the correctness of their joint work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, having made and tested the table output component, we can call it in the ‚Äúcalculator‚Äù component, but accidentally specify the wrong binding. Then the data will not fall into the tables, and fully working components will not work correctly. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1j/w3/jm/1jw3jm9muxpvatfvgf6_oqjn9ms.gif" alt="image"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integration testing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- testing a bunch of several components. From this stage we begin to test not just the class methods, but also their binding to html, i.e. click on the elements inside the component. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shallow testing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is often found in Angular notation </font><font style="vertical-align: inherit;">, which is essentially integration testing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At Shallow testing we will dwell in more detail below. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E2E</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (end-to-end) testing - a way to test the application completely to solve the problems of unit tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this approach, we write test scripts for a fully rendered application, i.e. all components and services are assembled together, and we reproduce user actions.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is very cool, but we may have the problem of dynamically changing stubs (usually a static json server on node.js), and to play different situations, we may need different data from the emulated server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example: we have a page with a list of users, one of the components of this panel is pagination. It should behave differently with different numbers of users. But if the data on the emulated server is set via json, then the number of users will always be one, and we will not be able to check all cases with a different number of pages.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we can conclude that if we want to flexibly change stubs and test not by methods, but by logical units of the interface, we need to use something in between e2e and unit-tests. </font><font style="vertical-align: inherit;">This is where shallow testing (integration testing) comes to the rescue. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Glossary:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mocks are objects for simulating responses in various use-cases.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stubs are the most stupid stubs without logic (you can read Martin).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Karma is a test runner built into angular (often advised to use jest instead, but not about that today).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jasmine is a framework for describing tests in the form of specs (see below).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spec - test file extension (specification description in BDD style).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is the name of the methods for tests in Jasmine.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xit is the name of the methods that will not run.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fit - if there are methods with the same name in specs, only they will be launched.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Shallow testing for Angular, as well as for other frameworks, is a unit-test approach, when a component of size large enough is rendered so that it can exist as a separate unit of ui with its own functionality. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we have a component for converting hex -&gt; rgb. We can render only this component, generate stubs for different situations, execute possible use-cases for this component from the point of view of end users and check the operation of the component. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to figure out an example (repository). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prepare the class for accessing the components of the component in accordance with PageObject and add a helper to the root of the project.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Helper - will help to search for elements in the components that have been selected for rendering. </font><font style="vertical-align: inherit;">This way we can make life easier if we use Angular Material: then elements of type select will create a list with option in a separate block, and searching for these elements can lead to boilerplates, and a wrapper in the form of a helper can help.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageObjectBase</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(private root: HTMLDivElement) { }
  <span class="hljs-comment">//    input  </span>
  _inputValue(cssSelector: string, <span class="hljs-attr">value</span>: string) { 
    <span class="hljs-keyword">if</span> (value) {
      <span class="hljs-keyword">this</span>.root.querySelector&lt;HTMLInputElement&gt;(cssSelector).value = value;
      <span class="hljs-keyword">this</span>.root.querySelector&lt;HTMLInputElement&gt;(cssSelector).dispatchEvent(<span class="hljs-keyword">new</span> Event(<span class="hljs-string">'input'</span>));<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.root.querySelector&lt;HTMLInputElement&gt;(cssSelector).value<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-comment">//          </span><font></font>
  _buttonClick(cssSelector: string) {<font></font>
    <span class="hljs-keyword">this</span>.root.querySelector&lt;HTMLButtonElement&gt;(cssSelector).dispatchEvent(<span class="hljs-keyword">new</span> Event(<span class="hljs-string">'click'</span>));<font></font>
  }<font></font>
<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PageObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a popular automated testing template. </font><font style="vertical-align: inherit;">Used to simplify support for written tests. </font><font style="vertical-align: inherit;">If we change the UI, then we don‚Äôt have to rewrite the tests, just change the element selectors.</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConverterFromHexPageObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PageObjectBase</span> </span>{<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(root: HTMLDivElement) {
    <span class="hljs-keyword">super</span>(root)<font></font>
  }<font></font>
<font></font>
  hex(text?: string) {<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._inputValue(<span class="hljs-string">'.input-hex'</span>, text);<font></font>
  }<font></font>
<font></font>
  rgb(text?: string) {<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._inputValue(<span class="hljs-string">'.input-rgb'</span>, text);<font></font>
  }<font></font>
<font></font>
  clear() {<font></font>
    <span class="hljs-keyword">this</span>._buttonClick(<span class="hljs-string">'.btn-clear'</span>)<font></font>
  }<font></font>
<font></font>
  calc() {<font></font>
    <span class="hljs-keyword">this</span>._buttonClick(<span class="hljs-string">'.btn-calc'</span>)<font></font>
  }<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and the tests themselves:</font></font><br>
<br>
<pre><code class="javascript hljs">
<span class="hljs-comment">// ,        api   </span>
<span class="hljs-keyword">const</span> urlToSave = <span class="hljs-string">'http://localhost:4200/save-hex'</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//  -   </span>
describe(<span class="hljs-string">'ConverterFromHexComponent'</span>, () =&gt; {
  <span class="hljs-keyword">let</span> component: ConverterFromHexComponent;
  <span class="hljs-keyword">let</span> fixture: ComponentFixture&lt;ConverterFromHexComponent&gt;;
  <span class="hljs-keyword">let</span> page: ConverterFromHexPageObject;
  <span class="hljs-keyword">let</span> httpTestingController: HttpTestingController;<font></font>
<font></font>
<font></font>
  <span class="hljs-comment">//      ,   </span>
  beforeEach(<span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    TestBed.configureTestingModule({<font></font>
      <span class="hljs-attr">imports</span>: [ConverterModule, HttpClientTestingModule]<font></font>
    })<font></font>
      .compileComponents();<font></font>
    httpTestingController = TestBed.get(HttpTestingController);<font></font>
  }));<font></font>
<font></font>
<font></font>
  <span class="hljs-comment">//  ,   </span>
  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    fixture = TestBed.createComponent(ConverterFromHexComponent);<font></font>
    component = fixture.componentInstance;<font></font>
    page = <span class="hljs-keyword">new</span> ConverterFromHexPageObject(fixture.nativeElement);<font></font>
    fixture.detectChanges();<font></font>
  });<font></font>
<font></font>
<font></font>
  <span class="hljs-comment">//    ,     http </span>
  afterEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
    httpTestingController.verify();<font></font>
  });<font></font>
<font></font>
  it(<span class="hljs-string">'should create'</span>, () =&gt; {<font></font>
    expect(component).toBeTruthy();<font></font>
  });<font></font>
<font></font>
  it(<span class="hljs-string">'should clear'</span>, <span class="hljs-keyword">async</span> () =&gt; {<font></font>
    page.hex(<span class="hljs-string">'112233'</span>); <span class="hljs-comment">//  input  </span>
    expect(page.hex()).toBe(<span class="hljs-string">'112233'</span>); <span class="hljs-comment">// ,    </span>
    <span class="hljs-keyword">await</span> page.clear(); <span class="hljs-comment">//      </span>
    fixture.detectChanges(); <span class="hljs-comment">//    </span>
    expect(page.hex()).toBe(<span class="hljs-string">''</span>); <span class="hljs-comment">// ,   clear </span><font></font>
  });<font></font>
<font></font>
  it(<span class="hljs-string">'should convert'</span>, <span class="hljs-keyword">async</span> () =&gt; {<font></font>
    page.hex(<span class="hljs-string">'123123'</span>);<font></font>
    expect(page.rgb()).toBe(<span class="hljs-string">''</span>);<font></font>
    page.calc();<font></font>
    <span class="hljs-keyword">const</span> req = httpTestingController.expectOne(urlToSave);<font></font>
    expect(req.request.method).toEqual(<span class="hljs-string">'POST'</span>);<font></font>
    expect(req.request.body.hex).toEqual(<span class="hljs-string">'123123'</span>);<font></font>
    req.flush({});<font></font>
    <span class="hljs-keyword">await</span> fixture.detectChanges();<font></font>
    expect(page.rgb()).toBe(<span class="hljs-string">'rgb(18, 49, 35)'</span>);<font></font>
  });<font></font>
<font></font>
  it(<span class="hljs-string">'should convert three-digit hex'</span>, <span class="hljs-keyword">async</span> () =&gt; {<font></font>
    page.hex(<span class="hljs-string">'567'</span>);<font></font>
    expect(page.rgb()).toBe(<span class="hljs-string">''</span>);<font></font>
    page.calc();<font></font>
    <span class="hljs-keyword">const</span> req = httpTestingController.expectOne(urlToSave);<font></font>
    expect(req.request.method).toEqual(<span class="hljs-string">'POST'</span>);<font></font>
    req.flush({});<font></font>
    <span class="hljs-keyword">await</span> fixture.detectChanges();<font></font>
    expect(page.rgb()).toBe(<span class="hljs-string">'rgb(85, 102, 119)'</span>);<font></font>
  });<font></font>
<font></font>
  it(<span class="hljs-string">'rgb should be empty when entered incorrectly hex'</span>, <span class="hljs-keyword">async</span> () =&gt; {<font></font>
    page.hex(<span class="hljs-string">'qw123we'</span>);<font></font>
    page.calc();<font></font>
    <span class="hljs-keyword">const</span> req = httpTestingController.expectNone(urlToSave);
    <span class="hljs-keyword">await</span> fixture.detectChanges();<font></font>
    expect(page.rgb()).toBe(<span class="hljs-string">''</span>);<font></font>
  });<font></font>
<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything seems to be simple, but here are some interesting notes for Angular Shallow testing:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Always check that there are no unreserved http requests, this will help you to understand exactly if there are any unnecessary requests for our functionality.</font></font></li>
<li>     PageObject ,      .</li>
<li>    json       ,      .</li>
<li>        ,       .</li>
<li>   .</li>
<li>    . </li>
<li>    ,    session, local, cookie    (  ).</li>
<li>      fake.js. </li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>. </li>
</ul><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  </a></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486978/index.html">Field Notes: One of the Biggest OpenSource Conferences FOSDEM 2020</a></li>
<li><a href="../en486980/index.html">Kim Dotcom: Caught, the most wanted person online. Part 1</a></li>
<li><a href="../en486982/index.html">How to learn front-end development, find your first job and not get bumps</a></li>
<li><a href="../en486984/index.html">Python Gateway at InterSystems IRIS</a></li>
<li><a href="../en486988/index.html">Pocket weather station</a></li>
<li><a href="../en486998/index.html">Cheap and fast check thermal printer printing</a></li>
<li><a href="../en487000/index.html">Citrus: Style Set for AvaloniaUI</a></li>
<li><a href="../en487002/index.html">Augmented Reality Marketing: What It Is and How It Works</a></li>
<li><a href="../en487004/index.html">Why more and more US states are returning network neutrality - discuss the course of events</a></li>
<li><a href="../en487006/index.html">Linux console utilities that can make your life easier</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>