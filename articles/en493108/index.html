<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍💼 🗒️ 🤚 Cloudflare selects AMD processors for tenth-generation edge servers 📀 ☘️ 🏛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="More than a billion unique IP addresses pass through the Cloudflare Network daily; It serves more than 11 million HTTP requests per second; it is loca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cloudflare selects AMD processors for tenth-generation edge servers</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493108/"><img src="https://habrastorage.org/getpro/habr/post_images/536/952/a76/536952a764f14e82b44b8765e9c63737.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More than a billion unique IP addresses pass through the Cloudflare Network daily; It serves more than 11 million HTTP requests per second; it is located at a distance of no more than 100 ms from 95% of the Internet population. Our network spans 200 cities in more than 90 countries, and our engineering team has built an extremely fast and reliable infrastructure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are very proud of our work and are committed to helping make the Internet better and safer. Cloudflare engineers, whose work is related to hardware, are well versed in servers and their components in order to understand and choose the best equipment to maximize its efficiency.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our software stack handles high-load computing and is very dependent on CPU speed, which is why our engineers have to constantly optimize the efficiency and reliability of Cloudflare at all levels of the stack. </font><font style="vertical-align: inherit;">On the server side, the easiest way is to increase computing power by adding CPU cores. </font><font style="vertical-align: inherit;">The more cores you can fit in a server, the more it can process data. </font><font style="vertical-align: inherit;">This is important for us, as the diversity of our products and customers grows over time, and the growth of requests requires servers to increase productivity. </font><font style="vertical-align: inherit;">To increase their productivity, we needed to increase the density of nuclei - and this is precisely what we have accomplished. </font><font style="vertical-align: inherit;">Below we provide details of processor data for servers that we have been deploying since 2015, including the number of cores:</font></font><br>
<a name="habracut"></a><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">---</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gen 6</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gen 7</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gen 8</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gen 9</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginning of work</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2015</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2017</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intel Xeon E5-2630 v3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intel Xeon E5-2630 v4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intel Xeon Silver 4116</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intel Xeon Platinum 6162</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Physical cores</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 10</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 12</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 24</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TDP</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 85W</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 85W</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 85W</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 150W</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TDP per core</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10.65W</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.50W</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.08W</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.25W</font></font></td>
</tr>
</tbody></table></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2018, we made a big leap in the total number of cores per server with the 9th generation. </font><font style="vertical-align: inherit;">The environmental impact was reduced by 33% compared with the 8th generation, which gave us the opportunity to increase the volume and computing power per rack. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thermal Design Power</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (TDP) </font><font style="vertical-align: inherit;">design requirements are </font><font style="vertical-align: inherit;">mentioned to emphasize that our energy efficiency has also grown over time. </font><font style="vertical-align: inherit;">This indicator is important for us: firstly, we want to emit less carbon into the atmosphere; </font><font style="vertical-align: inherit;">secondly, we want to make the best use of the energy of data centers. </font><font style="vertical-align: inherit;">But we know what we have to strive for.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our main defining metric is the number of requests per watt. We can increase the number of requests per second by adding cores, but we need to stay within our energy budget. We are limited by the power infrastructure of data centers, which, together with our selected energy distribution modules, gives us a certain upper limit for each server rack. Adding servers to a rack increases power consumption. Operating costs will increase dramatically if we go beyond limiting energy per rack and we have to add new racks. We need to increase computing power, remaining in the same energy range, which will increase the number of requests per watt - our key metric.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you might have guessed, we carefully studied energy consumption at the design stage. </font><font style="vertical-align: inherit;">The table above shows that we should not waste time deploying more energy-hungry CPUs, if the TDP per core is higher than the current generation - this will negatively affect our metric, the number of requests per watt. </font><font style="vertical-align: inherit;">We carefully examined the ready-to-operate systems for our Generation X on the market and made a decision. </font><font style="vertical-align: inherit;">We are moving from our circuit with 48 Intel Xeon Platinum 6162 cores and two sockets to a 48-core AMD EPYC 7642 with one socket.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/d3c/162/8f5/d3c1628f5dfb45681f0fb25abce76b3e.jpg"><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">---</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intel</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AMD</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xeon Platinum 6162</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPYC 7642</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microarchitecture</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Skylake” </font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> “Zen 2”</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codename</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Skylake SP”</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Rome” </font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Process technology</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">14nm</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7nm</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cores</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 24</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">48</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frequency</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.9 GHz</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4 GHz</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L3 cache / socket</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">24 x 1.375MiB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 x 16MiB</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memory / socket</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 channels, up to DDR4-2400</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 channels, up to DDR4-3200</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TDP</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x 150W</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">225W</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCIe / socket</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">48 lanes</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">128 lanes</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ISA</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-64</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-64</font></font></td>
</tr>
</tbody></table></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the specifications it is clear that the chip from AMD will allow us to leave the same number of cores, lowering TDP. </font><font style="vertical-align: inherit;">In the 9th generation, the TDP per core was 6.25 watts, and in the Xth generation it will be 4.69 watts. </font><font style="vertical-align: inherit;">A decrease of 25%. </font><font style="vertical-align: inherit;">Due to the increase in frequency, and, possibly, a simpler circuit with a single socket, we can assume that the AMD chip will prove to be better in business. </font><font style="vertical-align: inherit;">While we are conducting various tests and simulations to understand how much better AMD will perform.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the meantime, we note that TDP is a simplified metric from the manufacturer's specifications, which we used in the early stages of server design and CPU selection. </font><font style="vertical-align: inherit;">A quick Google search demonstrates that AMD and Intel have different approaches to the definition of TDP, which is why this specification is not reliable. </font><font style="vertical-align: inherit;">The actual power consumption of the CPU, and, more importantly, the power consumption of the server, is what we really use when making the final decision.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ecosystem preparedness</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the beginning of our journey to choosing the next processor, we studied a large assortment of CPUs from different manufacturers that were well suited for our software stack and services (written in C, LuaJIT and Go). We have already described in detail a set of tools for measuring speed </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in an article in our blog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In this case, we used the same set - it allows us to evaluate the effectiveness of the CPU in a reasonable time, after which our engineers can begin to adapt our programs to a specific processor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We tested various processors with a diverse number of cores, sockets and frequencies. Since this article describes why we settled on the AMD EPYC 7642, all of the graphics in this blog focus on how AMD processors perform compared to the Intel Xeon Platinum 6162 from</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">our 9th generation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The results correspond to measurements of the operation of one server with each processor variant - that is, with two 24-core processors from Intel, or with one 48-core processor from AMD (server for Intel with two sockets and server for AMD EPYC with one). </font><font style="vertical-align: inherit;">In the BIOS, we set the parameters corresponding to the working servers. </font><font style="vertical-align: inherit;">These are 3.03 GHz for AMD and 2.5 GHz for Intel. </font><font style="vertical-align: inherit;">Simplifying very much, we expect that with the same number of cores AMD will show results 21% better than Intel.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cryptography</font></font></h2><br>
<img src="https://habrastorage.org/getpro/habr/post_images/eb4/843/287/eb484328713741f6688d81c15a9c5920.png"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/598/82b/416/59882b416feabd9eea86ea9d99d1e1df.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks promising for AMD. </font><font style="vertical-align: inherit;">It works 18% better on public key cryptography. </font><font style="vertical-align: inherit;">With a symmetric key, it loses for the AES-128-GCM encryption options, but in general it shows itself comparable.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compression</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On edge servers, we compress a lot of data to save on bandwidth and increase the speed of content delivery. </font><font style="vertical-align: inherit;">We pass data through the zlib and brotli C libraries. </font><font style="vertical-align: inherit;">All tests took place on the blog.cloudflare.com HTML file in memory. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/fdc/bf7/ae1/fdcbf7ae1109d02a45b2ca40fe353376.png"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ccc/427/983/ccc427983ceb85dbf63bab614850692f.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AMD won an average of 29% when using gzip. </font><font style="vertical-align: inherit;">In the case of brotli, the results are even better on tests with quality 7, which we use for dynamic compression. </font><font style="vertical-align: inherit;">A sharp drop occurs on the brotli-9 test - we attribute this to the fact that Brotli consumes a lot of memory and overflows the cache. </font><font style="vertical-align: inherit;">However, AMD wins by a wide margin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many of our services are written in Go. </font><font style="vertical-align: inherit;">In the following graphs, we recheck the cryptography and compression rates on Go with RegExp on 32 KB lines using the strings library.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go cryptography</font></font></h3><br>
<img src="https://habrastorage.org/getpro/habr/post_images/78a/ab0/495/78aab0495309cefee6f30bac835ee961.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go compression</font></font></h3><br>
<img src="https://habrastorage.org/getpro/habr/post_images/f99/2cb/95d/f992cb95d4913a2d19808d4bd15b5b54.png"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/850/e7c/f55/850e7cf5586f693dd14d62f70510f681.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go regexp</font></font></h3><br>
<img src="https://habrastorage.org/getpro/habr/post_images/b58/798/6cb/b587986cbab94ca7087364a949f09aa4.png"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/444/e76/f72/444e76f72c1ec2e93c4cae0c5bd386f2.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go strings</font></font></h3><br>
<img src="https://habrastorage.org/getpro/habr/post_images/3e9/984/19a/3e998419adb450f598e0f3d82de01aa1.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AMD shows the best results in all tests with Go except the ECDSA P256 Sign, where it is 38% behind - which is strange, considering that it showed 24% better results in C. </font><font style="vertical-align: inherit;">It’s worth figuring out what’s going on there. </font><font style="vertical-align: inherit;">But in general, AMD does not win much, but still shows the best results.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luajit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We often use LuaJIT in the stack. </font><font style="vertical-align: inherit;">This is the glue holding all parts of Cloudflare. </font><font style="vertical-align: inherit;">And we are glad that AMD won here. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, tests show that EPYC 7642 performs better than two Xeon Platinum 6162. AMD loses on a pair of tests - for example, AES-128-GCM and Go OpenSSL ECDSA-P256 Sign - however, it wins on all others, on average by 25% .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Workload simulation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After our express tests, we ran the server through another set of simulations in which the synthetic load is applied to the software edge stack. Here we simulate a workload of scripts with various types of queries that can be found in real work. Requests vary in terms of data volume, HTTP or HTTPS protocols, WAF, Workers sources, and others from a variety of variables. Below is a comparison of the throughput of the two CPUs for the types of requests that we find most often.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/594/dbb/4cf/594dbb4cf570a1c22ff666d592884ef7.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The results on the diagram are measured by the basic indicators of the 9th generation of machines with Intel processors, normalized to a value of 1.0 along the x axis. </font><font style="vertical-align: inherit;">For example, taking simple requests of 10 KiB via HTTPS, we can see that AMD is 1.5 times better than Intel in terms of the number of requests per second. </font><font style="vertical-align: inherit;">On average, AMD performed 34% better for the given tests than Intel. </font><font style="vertical-align: inherit;">Considering that TDP for a single AMD EPYC 7642 is equal to 225 W, and for two Intel processors - 300 W, it turns out that in terms of “requests per watt” AMD shows 2 times better results than Intel!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this point, we were clearly leaning towards the option of a single socket for AMD EPYC 7642 as our future CPUs for Generation X. We were very interested to know how AMD EPYC servers behave in real work, and we immediately sent several servers to some from data centers.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Real work</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing, of course, was to prepare the server for work in real conditions. </font><font style="vertical-align: inherit;">All the machines in our fleet work with the same processes and services, which makes it a great opportunity to correctly compare performance. </font><font style="vertical-align: inherit;">As in most data centers, we have several generations of servers deployed, and we assemble our servers in clusters so that each class contains servers of approximately the same generation. </font><font style="vertical-align: inherit;">In some cases, this can result in utilization curves varying between clusters. </font><font style="vertical-align: inherit;">But not with us. </font><font style="vertical-align: inherit;">Our engineers have optimized CPU utilization for all generations so that regardless of whether the CPU has 8 cores on a particular machine or 24, CPU usage is usually no different from the rest.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9b9/ea2/a9b/9b9ea2a9b8b70ad4e6e8f3b4e72200a3.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The graph illustrates our comment on the similarity of utilization - there is no significant difference between the use of AMD CPUs in Gen X servers and the use of Intel processors in Gen 9 servers. This means that both test and core servers are loaded equally. Fine. This is exactly what we achieve in the work of our servers, and we need this for an honest comparison. The two graphs below show the number of requests processed by one CPU core and all the cores at the server level. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/075/8a6/91c/0758a691c0287281bd4c70bc1625d631.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Queries to the </font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/0a2/c5d/206/0a2c5d206c83c98cc06b910118a03a17.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server Queries to the server</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be seen that on average AMD processes 23% more requests. Not bad at all! We often wrote on our blog about ways to increase the performance of Gen 9. And here we have the same number of cores, but AMD is doing more work with less energy. Immediately from the specifications for the number of cores and TDP it can be seen that AMD delivers more speed with greater energy efficiency. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But, as we already mentioned, TDP is not a standard specification, and it is not the same for all manufacturers, so let's look at the real use of energy. By measuring the energy consumption of the server in parallel with the number of requests per second, we got the following graph:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/eac/f1a/a0f/eacf1aa0fcbee9f35c376bf52a7f37d1.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the number of requests per second spent per watt, the Gen X server on AMD processors is 28% more efficient. One could have expected more, given that AMD's TDP is 25% lower, however, it should be remembered that TDP is an ambiguous characteristic. We saw that AMD’s actual energy consumption almost coincides with the indicated TDP at a frequency well above the base; Intel doesn't have that. This is another reason why TDP is not a reliable estimate of energy consumption. Intel CPUs in our Gen 9 servers are integrated into the multicode system, while AMD CPUs work in standard 1U form factor servers. This does not speak in favor of AMD, since multinode servers should provide higher density with less power consumption per node, however AMD still outperformed Intel in terms of energy consumption per node.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In most comparisons on specifications, test simulations, and real-world performance, the 1P AMD EPYC 7642 configuration proved to be significantly better than the 2P Intel Xeon 6162. In some conditions, AMD can work 36% better, and we believe that by optimizing hardware and programs, we we can achieve such an improvement on an ongoing basis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that AMD won. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Additional graphs show the average delay and p99 delay in NGINX operation for 24 hours. </font><font style="vertical-align: inherit;">On average, AMD processes ran 25% faster. </font><font style="vertical-align: inherit;">At p99, it runs 20-50% faster depending on the time of day.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cloudflare’s hardware and performance engineers do a significant amount of testing and research to select the best server configuration for our customers. We like to work here because we can solve such grandiose tasks, and also help you solve your problems with services such as serverless edge-computing and an array of solutions to security problems, in particular, Magic Transit, Argo Tunnel and DDoS protection . All servers in the Cloudflare network are configured for reliable operation, and we are always trying to make each next generation of servers better than the previous one. We believe that AMD EPYC 7642 is the answer to the question about choosing processors for Gen X.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the Cloudflare Workers service, developers deploy their applications on our network, expanding around the world. We are proud to offer our customers the opportunity to concentrate on writing code while we work on security and reliability in the cloud. And today we are even more pleased to announce that their work will be deployed on our Gen X generation servers running second-generation AMD EPYC processors. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7de/304/54d/7de30454d5b87e7a32fceda1e3f7ca49.jpg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EPYC 7642 processors, codenamed “Rome” [Rome]</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Using AMD's EPYC 7642, we were able to increase our speed and facilitate the expansion of the network to new cities. Rome was not built in one day, but soon it will be closer to many of you.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the past couple of years, we have experimented with many x86 chips from Intel and AMD, as well as processors from ARM. </font><font style="vertical-align: inherit;">We expect that in the future, these CPU manufacturers will work together with us so that we can together build an improved Internet.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493096/index.html">Add a dark theme in iOS</a></li>
<li><a href="../en493098/index.html">Deploy ASA VPN Load-Balancing Cluster</a></li>
<li><a href="../en493100/index.html">How finding easy ways helps startups achieve aggressive growth</a></li>
<li><a href="../en493102/index.html">Global Automation Trends: RPA Development</a></li>
<li><a href="../en493106/index.html">How much is new in the Devil's Dozen?</a></li>
<li><a href="../en493110/index.html">How to delegate in remote work - a guide for team lead and more</a></li>
<li><a href="../en493112/index.html">How to start a new business in 6 months instead of 3 years</a></li>
<li><a href="../en493114/index.html">How Data Engineer Watched Data</a></li>
<li><a href="../en493116/index.html">“More interactivity!” or How was TeamLead Conf 2020</a></li>
<li><a href="../en493118/index.html">Overview of Memory Tagging Extension (Armv8.5-A)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>