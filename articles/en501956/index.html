<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë®üèª üò≠ üßùüèø Our experience working with data in etcd Kubernetes-cluster directly (without K8s API) üòÖ üë∏üèª ü§æ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="More and more often, customers turn to us with a request to provide access to the Kubernetes cluster for the possibility of accessing services within ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Our experience working with data in etcd Kubernetes-cluster directly (without K8s API)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/501956/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More and more often, customers turn to us with a request to provide access to the Kubernetes cluster for the possibility of accessing services within the cluster: in order to be able to connect directly to some database or service, to connect the local application with applications within the cluster ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/mh/du/rimhduzpzbuwtylhnil4dorhzw4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, there is a need to connect from your local machine to the service </font></font><code>memcached.staging.svc.cluster.local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We provide this opportunity with a VPN inside the cluster to which the client connects. To do this, we are announcing the subnets of pods, services, and push cluster DNS to the client. Thus, when the client tries to connect to the service </font></font><code>memcached.staging.svc.cluster.local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the request goes to the cluster‚Äôs DNS and in response receives the address of this service from the cluster service network or the pod address.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We configure K8s clusters using kubeadm, where the default service subnet is </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the pod network is </font></font><code>10.244.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Usually everything works well, but there are a couple of points:</font></font><a name="habracut"></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The subnet is </font></font><code>192.168.*.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">often used in office networks of clients, and even more often in home networks of developers. </font><font style="vertical-align: inherit;">And then we get conflicts: home routers work on this subnet and the VPN push these subnets from the cluster to the client.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have several clusters (production, stage, and / or several dev clusters). </font><font style="vertical-align: inherit;">Then in all of them by default there will be the same subnets for pods and services, which creates great difficulties for working with services in several clusters simultaneously.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For quite some time now we have adopted the practice of using different subnets for services and pods within the framework of one project - in general, so that all clusters are with different networks. </font><font style="vertical-align: inherit;">However, there are a large number of clusters in operation that I would not want to roll from scratch, since they run many services, stateful applications, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And then we asked ourselves: how would I change the subnet in an existing cluster?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Searching of decisions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most common practice is to recreate </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> services with the ClusterIP type. </font><font style="vertical-align: inherit;">Alternatively, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">they can also advise</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> this:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following process has a problem: after everything configured, the pods come up with the old IP as a DNS nameserver in /etc/resolv.conf. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since I still did not find the solution, i had to reset the entire cluster with kubeadm reset and init it again.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But this does not suit everyone ... Here are more detailed introductory notes for our case: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Used by Flannel;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There are clusters both in the clouds and on the iron;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I would like to avoid the repeated deployment of all services in the cluster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There is a need to do everything with a minimum of problems;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kubernetes version is 1.16.6 (however, further actions will be similar for other versions);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The main task is to </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">replace it </font><font style="vertical-align: inherit;">with a cluster deployed using kubeadm with a service subnet </font></font><code>172.24.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And it just so happened that for a long time it was interesting for us to see what and how in Kubernetes it is stored in etcd, what can be done with it at all ... So we thought: ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why not just update the data in etcd by replacing the old IP addresses (subnet) to new ones</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? ‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking for ready-made tools for working with data in etcd, we did not find anything that completely solves the task. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(By the way, if you know about any utilities for working with data directly in etcd, we will be grateful for the links.)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> However, </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">OpenShift </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etcdhelper</font></font></b><font style="vertical-align: inherit;"></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> became a good starting point </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(thanks to its authors!)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This utility is able to connect to etcd using certificates and read out the data using the commands </font></font><code>ls</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>dump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add etcdhelper</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following thought is logical: ‚ÄúWhat prevents to add this utility, adding the ability to write data to etcd?‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It has been translated into a modified version of etcdhelper with two new </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">features </font></font><code>changePodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">You </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can see</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> her </font><b><font style="vertical-align: inherit;">code </font></b><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">here</font></a></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What do the new features do? </font><font style="vertical-align: inherit;">Algorithm </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> create a deserializer;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compile a regular expression to replace CIDR;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we pass through all services with the ClusterIP type in the cluster:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decode the value from etcd to the Go object;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using a regular expression, replace the first two bytes of the address;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> assign the service an IP address from a new subnet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> create a serializer, convert the Go object to protobuf, write new data to etcd.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function </font></font><code>changePodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is essentially the same </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- only instead of editing the service specification we do it for the node and change it </font></font><code>.spec.PodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to a new subnet.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change serviceCIDR</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The plan for the implementation of the task is very simple, but involves downtime at the time of re-creation of all pods in the cluster. </font><font style="vertical-align: inherit;">After describing the main steps, we will also share our thoughts on how, in theory, this simple one can be minimized. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Preparatory actions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> installing the necessary software and assembling the patched etcdhelper;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup etcd and </font></font><code>/etc/kubernetes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Short action plan for changing serviceCIDR:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modifying apiserver and controller-manager manifests</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reissue of certificates;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ClusterIP services change in etcd;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> restart all pods in a cluster.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following is a complete sequence of actions in detail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Install etcd-client for data dump:</font></font><br>
<br>
<pre><code class="bash hljs">apt install etcd-client</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. We collect etcdhelper:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We put golang:</font></font><br>
<br>
<pre><code class="bash hljs">GOPATH=/root/golang<font></font>
mkdir -p <span class="hljs-variable">$GOPATH</span>/<span class="hljs-built_in">local</span>
curl -sSL https://dl.google.com/go/go1.14.1.linux-amd64.tar.gz | tar -xzvC <span class="hljs-variable">$GOPATH</span>/<span class="hljs-built_in">local</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"export GOPATH=\"<span class="hljs-variable">$GOPATH</span>\""</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export GOROOT="$GOPATH/local/go"'</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH="$PATH:$GOPATH/local/go/bin"'</span> &gt;&gt; ~/.bashrc</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We save ourselves </font></font><code>etcdhelper.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, load the dependencies, collect:</font></font><br>
<br>
<pre><code class="bash hljs">wget https://raw.githubusercontent.com/flant/examples/master/2020/04-etcdhelper/etcdhelper.go<font></font>
go get go.etcd.io/etcd/clientv3 k8s.io/kubectl/pkg/scheme k8s.io/apimachinery/pkg/runtime<font></font>
go build -o etcdhelper etcdhelper.go</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Make backup etcd:</font></font><br>
<br>
<pre><code class="bash hljs">backup_dir=/root/backup<font></font>
mkdir <span class="hljs-variable">${backup_dir}</span>
cp -rL /etc/kubernetes <span class="hljs-variable">${backup_dir}</span>
ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --key=/etc/kubernetes/pki/etcd/server.key --cert=/etc/kubernetes/pki/etcd/server.crt --endpoints https://192.168.199.100:2379 snapshot save <span class="hljs-variable">${backup_dir}</span>/etcd.snapshot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Change the service subnet in the Kubernetes control plane manifests. </font><font style="vertical-align: inherit;">In files </font></font><code>/etc/kubernetes/manifests/kube-apiserver.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">change the parameter </font></font><code>--service-cluster-ip-range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to a new subnet: </font></font><code>172.24.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instead </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Since we are changing the service subnet to which kubeadm issues certificates for apiserver (including), they must be reissued:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's look at which domains and IP addresses the current certificate is issued:</font></font><br>
<br>
<pre><code class="bash hljs">openssl x509 -noout -ext subjectAltName &lt;/etc/kubernetes/pki/apiserver.crt<font></font>
X509v3 Subject Alternative Name:<font></font>
    DNS:dev-1-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:apiserver, IP Address:192.168.0.1, IP Address:10.0.0.163, IP Address:192.168.199.100</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prepare the minimum config for kubeadm:</font></font><br>
<br>
<pre><code class="bash hljs">cat kubeadm-config.yaml<font></font>
apiVersion: kubeadm.k8s.io/v1beta1<font></font>
kind: ClusterConfiguration<font></font>
networking:<font></font>
  podSubnet: <span class="hljs-string">"10.244.0.0/16"</span>
  serviceSubnet: <span class="hljs-string">"172.24.0.0/16"</span><font></font>
apiServer:<font></font>
  certSANs:<font></font>
  - <span class="hljs-string">"192.168.199.100"</span> <span class="hljs-comment"># IP-  </span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's delete the old crt and key, because without this a new certificate will not be issued:</font></font><br>
<br>
<pre><code class="bash hljs">rm /etc/kubernetes/pki/apiserver.{key,crt}</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Re-issue certificates for the API server:</font></font><br>
<br>
<pre><code class="bash hljs">kubeadm init phase certs apiserver --config=kubeadm-config.yaml</code></pre></li>
<li> ,      :<br>
<br>
<pre><code class="bash hljs">openssl x509 -noout -ext subjectAltName &lt;/etc/kubernetes/pki/apiserver.crt<font></font>
X509v3 Subject Alternative Name:<font></font>
    DNS:kube-2-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:172.24.0.1, IP Address:10.0.0.163, IP Address:192.168.199.100</code></pre></li>
<li>    API-   :<br>
<br>
<pre><code class="bash hljs">docker ps | grep k8s_kube-apiserver | awk <span class="hljs-string">'{print $1}'</span> | xargs docker restart</code></pre></li>
<li>    <code>admin.conf</code>:<br>
<br>
<pre><code class="bash hljs">kubeadm alpha certs renew admin.conf</code></pre></li>
<li>    etcd:<br>
<br>
<pre><code class="bash hljs">./etcdhelper -cacert /etc/kubernetes/pki/etcd/ca.crt -cert /etc/kubernetes/pki/etcd/server.crt -key /etc/kubernetes/pki/etcd/server.key -endpoint https://127.0.0.1:2379 change-service-cidr 172.24.0.0/16 </code></pre><br>
<b>!</b>         ,      pod'  <code>/etc/resolv.conf</code>    CoreDNS (kube-dns),  kube-proxy   iptables     .         .</li>
<li>  ConfigMap'    <code>kube-system</code>:<br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubelet-config-1.16</code></pre><br>
‚Äî   <code>clusterDNS</code>   IP-  kube-dns: <code>kubectl -n kube-system get svc kube-dns</code>.<br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubeadm-config</code></pre><br>
‚Äî  <code>data.ClusterConfiguration.networking.serviceSubnet</code>   .</li>
<li>     kube-dns,    kubelet   :<br>
<br>
<pre><code class="bash hljs">kubeadm upgrade node phase kubelet-config &amp;&amp; systemctl restart kubelet</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It remains to restart all the pods in the cluster:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get pods --no-headers=<span class="hljs-literal">true</span> --all-namespaces |sed -r <span class="hljs-string">'s/(\S+)\s+(\S+).*/kubectl --namespace \1 delete pod \2/e'</span></code></pre></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minimized Downtime</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thoughts on how to minimize downtime:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After changing the manifestations of the control plane, create a new kube-dns service, for example, with a name </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and a new address </font></font><code>172.24.0.10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make </font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in etcdhelper, which will not modify the kube-dns service.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replace the address in all kubelets </font></font><code>ClusterDNS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a new one, while the old service will continue to work simultaneously with the new one.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wait for pods with applications to roll either by themselves for natural reasons, or at an agreed time.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delete the service </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and change it </font></font><code>serviceSubnetCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the kube-dns service.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This plan will minimize downtime up to ~ a minute - for the time the service is removed </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the subnet for the service is replaced </font></font><code>kube-dns</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modification podNetwork</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, we decided to see how to modify podNetwork using the resulting etcdhelper. </font><font style="vertical-align: inherit;">The sequence of actions is as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we fix configs in </font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we fix the manifest of kube-controller-manager;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we change podCIDR directly in etcd;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reboot all nodes of the cluster.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now more about these actions: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Modify ConfigMap in the namespace </font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubeadm-config</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- fixed </font></font><code>data.ClusterConfiguration.networking.podSubnet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on a new subnet </font></font><code>10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kube-proxy</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- we correct </font></font><code>data.config.conf.clusterCIDR: 10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Modify the controller-manager‚Äôs manifest:</font></font><br>
<br>
<pre><code class="bash hljs">vim /etc/kubernetes/manifests/kube-controller-manager.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- we correct </font></font><code>--cluster-cidr=10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Look at the current values </font></font><code>.spec.podCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.spec.podCIDRs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.InternalIP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.status.addresses</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for all nodes in the cluster:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get no -o json | jq <span class="hljs-string">'[.items[] | {"name": .metadata.name, "podCIDR": .spec.podCIDR, "podCIDRs": .spec.podCIDRs, "InternalIP": (.status.addresses[] | select(.type == "InternalIP") | .address)}]'</span></code></pre><br>
<pre><code class="json hljs">[<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.2"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.1.239"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.222"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.4.73"</span><font></font>
  }<font></font>
]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Replace podCIDR by making changes directly to etcd:</font></font><br>
<br>
<pre><code class="bash hljs">./etcdhelper -cacert /etc/kubernetes/pki/etcd/ca.crt -cert /etc/kubernetes/pki/etcd/server.crt -key /etc/kubernetes/pki/etcd/server.key -endpoint https://127.0.0.1:2379 change-pod-cidr 10.55.0.0/16</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Check that podCIDR has really changed:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get no -o json | jq <span class="hljs-string">'[.items[] | {"name": .metadata.name, "podCIDR": .spec.podCIDR, "podCIDRs": .spec.podCIDRs, "InternalIP": (.status.addresses[] | select(.type == "InternalIP") | .address)}]'</span></code></pre><br>
<pre><code class="json hljs">[<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.2"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.1.239"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.222"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.4.73"</span><font></font>
  }<font></font>
]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. In turn, we will reboot all nodes of the cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. If at least one node </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leaves the old podCIDR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then kube-controller-manager will not be able to start, and pods in the cluster will not be planned. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, changing podCIDR can be made easier (for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">like this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">But we wanted to learn how to work with etcd directly, because there are cases when editing Kubernetes objects in etcd is the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> possible option. </font><font style="vertical-align: inherit;">(For example, you can‚Äôt just change the field of Service without downtime </font></font><code>spec.clusterIP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The article considers the possibility of working with data in etcd directly, i.e. </font><font style="vertical-align: inherit;">bypassing the Kubernetes API. </font><font style="vertical-align: inherit;">Sometimes this approach allows you to do "tricky things." </font><font style="vertical-align: inherit;">The operations described in the text were tested on real K8s clusters. </font><font style="vertical-align: inherit;">However, their status of readiness for widespread use is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PoC (proof of concept)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Therefore, if you want to use a modified version of etcdhelper utility on your clusters, do it at your own peril and risk.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read also in our blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etcd 3.4.3: storage reliability and security research</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calico for the web at Kubernetes: getting to know and a bit of experience</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 entertaining system bugs in the operation of Kubernetes [and their solution]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">      Kubernetes</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501938/index.html">Prometheus, don't go: 6 alternative monitoring tools for Kubernetes</a></li>
<li><a href="../en501940/index.html">A bit about Neutralino.js</a></li>
<li><a href="../en501942/index.html">Kanban Method: Understanding Your Process as a Collective Learning Process</a></li>
<li><a href="../en501948/index.html">How a train travels from station to station: routing features</a></li>
<li><a href="../en501954/index.html">Whether VR awaits Microsoft Kinect or is it the future of gaming - let's talk together</a></li>
<li><a href="../en501960/index.html">Search scaling. Elasticsearch Its advantages and basic requirements for installation</a></li>
<li><a href="../en501964/index.html">What are industrial computers for?</a></li>
<li><a href="../en501968/index.html">MVI Architectural Template in Kotlin Multiplatform, Part 1</a></li>
<li><a href="../en501970/index.html">What do you need to create a good dungeon in RPG?</a></li>
<li><a href="../en501976/index.html">How to learn to test software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>