<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî≠ üåë üìÑ Comment l'informatique GPU m'a litt√©ralement sauv√© au travail. Exemple Python üíÇ üêõ üöµüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Aujourd'hui, nous abordons le sujet le plus pertinent - Python pour travailler avec le GPU. L'auteur consid√®re un exemple, trivial ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment l'informatique GPU m'a litt√©ralement sauv√© au travail. Exemple Python</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/505590/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, nous abordons le sujet le plus pertinent - Python pour travailler avec le GPU. </font><font style="vertical-align: inherit;">L'auteur consid√®re un exemple, trivial dans sa monstruosit√©, et d√©montre la solution, accompagn√© de nombreuses listes. </font><font style="vertical-align: inherit;">Bonne lecture!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/mv/xr/xbmvxrrximpm1_fchk6fsi9v5fg.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aucun de nous, sous une forme ou une autre, n'a contourn√© le battage m√©diatique r√©cent autour de l'informatique GPU. Avant de poursuivre la lecture, je vais vous expliquer: je ne suis pas un expert en GPU. Mon voyage dans le monde du GPU ne fait que commencer. Mais aujourd'hui, cette technologie a atteint une telle puissance que, arm√©e d'elle, vous pouvez r√©soudre beaucoup de probl√®mes. On m'a assign√© une t√¢che au travail, la machine y a pass√© des heures et aucun progr√®s n'√©tait visible. Mais, d√®s que j'ai pris le GPU - et le probl√®me a commenc√© √† √™tre r√©solu en quelques secondes. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La t√¢che, qui a pris environ 2 jours, a pu √™tre r√©solue en seulement 20 secondes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les sections suivantes, je d√©crirai cette t√¢che en d√©tail. </font><font style="vertical-align: inherit;">Nous discuterons √©galement comment et quand utiliser le GPU pour r√©soudre ces probl√®mes. </font><font style="vertical-align: inherit;">Donc, nous lisons attentivement - croyez-moi, vous ne le regretterez pas. </font><font style="vertical-align: inherit;">Tout d'abord, nous allons approfondir les d√©tails de la t√¢che, puis nous familiariser avec le GPU et, enfin, utiliser le GPU pour r√©soudre ce probl√®me. </font><font style="vertical-align: inherit;">J'utiliserai la biblioth√®que Python </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Numba</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU Nvidia Volta V100 16GB GPU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Description d√©taill√©e de la t√¢che</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le commerce de d√©tail, vous devez souvent rechercher des objets similaires ou proches. </font><font style="vertical-align: inherit;">On m'a donn√© une liste de postes, chacun √©tant repr√©sent√© par k attributs latents. </font><font style="vertical-align: inherit;">Donc, on m'a demand√© de trouver les 3 premiers postes les plus similaires √† chacun des postes de la liste. </font><font style="vertical-align: inherit;">La m√©trique de similitude dans ce probl√®me a √©t√© choisie comme similitude cosinus. </font><font style="vertical-align: inherit;">Voici √† quoi ressemblaient mes donn√©es. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s1/02/if/s102ifuqgnhoe_pv81htzopsye4.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Liste des √©l√©ments de donn√©es avec 64 caract√©ristiques latentes </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Complexit√© des t√¢ches</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On m'a donn√© une liste dans laquelle il y avait environ 10‚Åµ postes. </font><font style="vertical-align: inherit;">La recherche des 3 positions les plus similaires pour chacun d'eux n√©cessiterait de v√©rifier la similitude du cosinus avec chaque √©l√©ment de la liste. </font><font style="vertical-align: inherit;">Il en r√©sulterait n * k op√©rations, o√π n est le nombre de positions, et k sont les attributs de chaque position. </font><font style="vertical-align: inherit;">Il serait n√©cessaire d'obtenir le produit scalaire de cette position √† partir de chacune des positions restantes dans la liste.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">top_3_similar_items</span>(<span class="hljs-params">X,mindex</span>):</span> <span class="hljs-comment"># X   ,    -3 ,       'mindex'</span>
    SMALL = <span class="hljs-number">-9999.0</span> <span class="hljs-comment">#   ,         ( )</span>
    first_best_val = SMALL <span class="hljs-comment">#         </span>
    first_best_index = <span class="hljs-number">-1</span> <span class="hljs-comment">#       </span>
    second_best_val = SMALL <span class="hljs-comment">#        </span>
    second_best_index = <span class="hljs-number">-1</span> <span class="hljs-comment">#       </span>
    third_best_val = SMALL <span class="hljs-comment">#        </span>
    third_best_index = <span class="hljs-number">-1</span> <span class="hljs-comment">#       </span>
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(n): <span class="hljs-comment">#  n-  </span>
            <span class="hljs-keyword">if</span>(mindex==j):
                <span class="hljs-keyword">continue</span>
            tmp = np.dot(X[mindex],X[j])/(np.sqrt(np.sum(np.square(X[mindex]))) * np.sqrt(np.sum(np.square(X[j])))) <span class="hljs-comment">#   </span>
            <span class="hljs-keyword">if</span>(tmp&gt;=first_best_val):<font></font>
                third_best_val = second_best_val<font></font>
                third_best_index = second_best_index<font></font>
                second_best_val = first_best_val<font></font>
                second_best_index = first_best_index<font></font>
                first_best_val = tmp<font></font>
                first_best_index = j<font></font>
            <span class="hljs-keyword">elif</span>(tmp&gt;=second_best_val):<font></font>
                third_best_val = second_best_val<font></font>
                third_best_index = second_best_index<font></font>
                second_best_val = tmp<font></font>
                second_best_index = j<font></font>
            <span class="hljs-keyword">elif</span>(tmp&gt;third_best_val):<font></font>
                third_best_val = tmp<font></font>
                third_best_index = j<font></font>
    <span class="hljs-keyword">return</span> first_best_val,first_best_index,second_best_val,second_best_index,third_best_val,third_best_index <span class="hljs-comment">#   </span></code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code pour trouver trois positions qui sont aussi similaires que possible au</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Now, lorsque vous trouvez les 3 premiers similaires pour toutes les positions dans la liste, la complexit√© est multipli√©e par un autre n. </font><font style="vertical-align: inherit;">La complexit√© finale est O (n * n * k) = O (n¬≤k).</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">top_3_similar_all_items</span>(<span class="hljs-params">X</span>):</span> <span class="hljs-comment"># X   ,      3     </span>
    SMALL = <span class="hljs-number">-9999.99</span> <span class="hljs-comment">#   ,         ( )</span>
    first_best_index = np.zeros(n,dtype=int) <span class="hljs-comment">#        </span>
    first_best_val = np.zeros(n,dtype=float) <span class="hljs-comment">#       </span>
    second_best_index = np.zeros(n,dtype=int) <span class="hljs-comment">#        </span>
    second_best_val = np.zeros(n,dtype=float) <span class="hljs-comment">#       </span>
    third_best_index = np.zeros(n,dtype=int) <span class="hljs-comment">#        </span>
    third_best_val = np.zeros(n,dtype=float) <span class="hljs-comment">#       </span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):
        <span class="hljs-comment"># Initialisation</span><font></font>
        first_best_val[i] = SMALL<font></font>
        first_best_index[i] = <span class="hljs-number">-1</span><font></font>
        second_best_val[i] = SMALL<font></font>
        second_best_index[i] = <span class="hljs-number">-1</span><font></font>
        third_best_val[i] = SMALL<font></font>
        third_best_index[i] = <span class="hljs-number">-1</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(n):
            <span class="hljs-keyword">if</span>(i==j):
                <span class="hljs-keyword">continue</span>
            tmp = np.dot(X[i],X[j])/(np.sqrt(np.sum(np.square(X[i]))) * np.sqrt(np.sum(np.square(X[j])))) <span class="hljs-comment">#   </span>
            <span class="hljs-keyword">if</span>(tmp&gt;=first_best_val[i]):<font></font>
                third_best_val[i] = second_best_val[i]<font></font>
                third_best_index[i] = second_best_index[i]<font></font>
                second_best_val[i] = first_best_val[i]<font></font>
                second_best_index[i] = first_best_index[i]<font></font>
                first_best_val[i] = tmp<font></font>
                first_best_index[i] = j<font></font>
            <span class="hljs-keyword">elif</span>(tmp&gt;=second_best_val[i]):<font></font>
                third_best_val[i] = second_best_val[i]<font></font>
                third_best_index[i] = second_best_index[i]<font></font>
                second_best_val[i] = tmp<font></font>
                second_best_index[i] = j<font></font>
            <span class="hljs-keyword">elif</span>(tmp&gt;third_best_val[i]):<font></font>
                third_best_val[i] = tmp<font></font>
                third_best_index[i] = j<font></font>
    <span class="hljs-keyword">return</span> first_best_val,first_best_index,second_best_val,second_best_index,third_best_val,third_best_index <span class="hljs-comment">#   </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code pour trouver les trois positions les plus similaires pour chaque position dans la liste </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test run and time evaluation</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
J'ai ex√©cut√© le code, essayant de trouver les 3 positions les plus similaires √† partir d'un sous-ensemble contenant n = 10¬≥ positions avec k = 64. Il a fallu environ 17 pour terminer cette t√¢che avec Python secondes √† une vitesse moyenne de 3,7 * 10‚Å∂ op√©rations par seconde. </font><font style="vertical-align: inherit;">Le code a √©t√© bien optimis√© √† l'aide d'op√©rations et de tableaux Numpy. </font><font style="vertical-align: inherit;">Je note que toutes ces op√©rations sont effectu√©es s√©quentiellement sur le CPU.</font></font><br>
<br>
<pre><code class="python hljs">%time first_best_val,first_best_index,second_best_val,second_best_index,third_best_val,third_best_index = top_3_similar_all_items(X)</code></pre><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Courir pour n = 10¬≥ positions</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/z7/fr/p9/z7frp96r6jga71hy_eh5kqc6soo.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Conclusion: le temps qu'il a fallu pour n = 10¬≥ positions </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai augment√© le sous-ensemble de test √† n = 10‚Å¥ positions. Comme la complexit√© est O (n¬≤k), le temps d'ex√©cution a augment√© de 100 fois (puisque n a augment√© de 10 fois). Il a fallu 1700 secondes pour terminer le code = 28,33 minutes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1t/hz/we/1thzweestkdve12ggxihgenaisu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conclusion: le temps </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
n√©cessaire </font><font style="vertical-align: inherit;">pour traiter n = 10‚Å¥ positions </font><font style="vertical-align: inherit;">Ensuite, nous arrivons √† la plus importante: estimer le temps n√©cessaire pour traiter une liste compl√®te de 10‚Åµ positions. En comptant, on voit que la complexit√© temporelle augmente √† nouveau de 100 fois, puisque la complexit√© temporelle de l'algorithme est O (n¬≤k). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temps estim√© = 1700 * 100 secondes = 2834 minutes = 47,2 heures ~ 2 jours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh mon Dieu! Si longtemps!!!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous vous rendez probablement d√©j√† compte que j'ai r√©ussi √† tout faire tr√®s rapidement, en utilisant la puissance du GPU. </font><font style="vertical-align: inherit;">En fait, le gain de temps lors de l'utilisation d'un GPU est tout simplement choquant. </font><font style="vertical-align: inherit;">Je vais laisser les chiffres pour une collation, mais pour l'instant je vous sugg√®re de vous familiariser avec le monde du GPU.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Comparaison du CPU et du GPU</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'unit√© centrale de traitement (CPU) est, par essence, le cerveau de tout appareil informatique: elle ex√©cute les instructions enregistr√©es dans le programme, effectuant le contr√¥le, les op√©rations logiques ainsi que les op√©rations d'entr√©e / sortie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certes, les processeurs modernes n'ont toujours pas beaucoup de c≈ìurs, et la structure de base et le but du processeur - le traitement de calculs complexes -, en substance, n'ont pas chang√©. </font><font style="vertical-align: inherit;">En fait, le CPU est le mieux adapt√© pour r√©soudre les t√¢ches d'analyse ou d'interpr√©tation de la logique complexe contenue dans le code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä son tour, le processeur graphique (GPU) a des c≈ìurs logiques plus petits, qui sont cependant beaucoup plus grands (nous parlons de dispositifs logiques arithm√©tiques (ALU), d'√©l√©ments de contr√¥le et de m√©moire cache), qui sont con√ßus dans l'espoir d'un traitement parall√®le dans son ensemble. op√©rations identiques et relativement simples.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dv/rj/_r/dvrj_rfbqkiabwugkvilkoka3oo.png"><br>
 <blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le GPU a plus d'unit√©s logiques arithm√©tiques (ALU) qu'un CPU typique, donc la capacit√© de traiter des op√©rations simples en parall√®le a √©t√© am√©lior√©e</font></font></blockquote><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure: Comparer CPU et GPU ~ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source d'image</font></font></a></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Quand utiliser l'informatique GPU </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le CPU est mieux adapt√© aux t√¢ches lin√©aires complexes. Malgr√© le fait que les c≈ìurs de processeur sont plus puissants, les GPU vous permettent de traiter plus efficacement et plus rapidement les t√¢ches li√©es √† l'IA, au machine learning et au deep learning. Le GPU g√®re les charges de travail en parall√©lisant des op√©rations similaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'id√©e des op√©rations du point de vue du GPU: prenez, par exemple, l'op√©ration de recherche d'un mot dans un document. Cela peut √™tre fait de mani√®re s√©quentielle, en triant un par un tous les mots du document, soit en parall√®le, c'est-√†-dire ligne par ligne, soit en recherchant un mot sp√©cifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'id√©e des op√©rations du point de vue du CPU - il y a de telles op√©rations, par exemple, le calcul de la s√©rie de Fibonacci, qui ne peut pas √™tre parall√©lis√©. Apr√®s tout, vous ne pouvez trouver le nombre suivant qu'apr√®s avoir calcul√© les deux pr√©c√©dents. Ces op√©rations sont mieux adapt√©es au processeur.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä leur tour, des op√©rations telles que l'ajout et la multiplication de matrice sont facilement effectu√©es √† l'aide du GPU, car la plupart de ces op√©rations dans les cellules matricielles sont ind√©pendantes les unes des autres, sont de nature similaire et peuvent donc √™tre parall√©lis√©es.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. En bref sur CUDA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CUDA est une plateforme informatique parall√®le et un mod√®le d'API cr√©√©s par Nvidia. En utilisant cette API, vous pouvez utiliser un processeur prenant en charge les graphiques CUDA pour une large gamme de calculs. Cette approche est appel√©e GPGPU (informatique non sp√©cialis√©e sur GPU). Ici, ils sont d√©crits </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plus en d√©tail</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NUMBA</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Numba est un compilateur JIT gratuit qui traduit un sous-ensemble de Python et NumPy en code machine rapide √† l'aide de LLVM, cela se fait √† l'aide du package llvmlite en Python. Ce package offre un certain nombre d'options pour parall√©liser le code Python pour le CPU et le GPU, tandis que des changements minimes suffisent souvent dans le code lui-m√™me. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voir plus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travailler avec le processeur</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU Nvidia Volta V100 16 Go</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , j'ai utilis√© la biblioth√®que Numba. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©tails architecturaux ~ Flux, blocs et grilles</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
CUDA organise le calcul parall√®le en utilisant des abstractions telles que des flux, des blocs et des grilles. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flux</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Un flux CUDA est une cha√Æne d'instructions affect√©e venant / actuelle au c≈ìur CUDA (en fait, c'est juste un pipeline). √Ä la vol√©e, jusqu'√† 32 threads peuvent exister sur le m√™me c≈ìur CUDA (dans ce cas, tous les liens de ce pipeline sont remplis). Il s'agit de l'ex√©cution du noyau avec l'index donn√©. Chaque thread utilise son index pour acc√©der aux √©l√©ments du tableau de telle mani√®re que l'ensemble des threads disponibles traite l'ensemble des donn√©es ensemble. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloquer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Ceci est un groupe de threads. On ne peut pas en dire grand-chose sur l'ex√©cution des threads dans un bloc: ils peuvent √™tre ex√©cut√©s s√©quentiellement ou en parall√®le, ou sans ordre particulier. Vous pouvez coordonner des threads, par exemple, √† l'aide d'une fonction </font></font><code>_syncthreads()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui force un thread √† s'arr√™ter √† un certain point du noyau et √† attendre que tous les autres threads du m√™me bloc atteignent √©galement le m√™me point. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grille</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Il s'agit d'un groupe de blocs. Il n'y a pas de synchronisation entre les blocs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fu/q_/rm/fuq_rmemxkfpo8o9wkx4es362s8.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CUDA: threads, blocs, grilles ~ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mais o√π sont exactement ex√©cut√©s les threads, blocs et grilles? Dans le cas de l‚Äôarchitecture GPU G80 de Nvidia, les calculs sont apparemment r√©partis comme suit: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grille ‚Üí GPU: la grille enti√®re est trait√©e par un seul processeur GPU.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Block ‚Üí MP: le processeur GPU est organis√© comme une collection de multiprocesseurs, o√π chaque multiprocesseur est responsable du traitement d'un ou plusieurs blocs dans la grille. </font><font style="vertical-align: inherit;">Un bloc n'est jamais divis√© entre plusieurs d√©put√©s. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flux ‚Üí PP: chaque MP est subdivis√© en processeurs de flux (PP) et chaque PP traite un ou plusieurs threads dans un bloc. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai emprunt√© du mat√©riel √† cet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article tr√®s bien √©crit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Je recommande de le lire attentivement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Un programme simple pour ajouter des tableaux en Python en utilisant le GPU</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai dit au tout d√©but, l'essence de cet article est d'aider un large public √† comprendre la puissance du GPU et √† comprendre intuitivement comment utiliser le GPU pour les t√¢ches quotidiennes. Avant de commencer √† √©crire du code pour le GPU, vous devrez peut-√™tre effectuer des recherches pr√©liminaires. Pour ce faire, prenons un exemple de programme d'ajout de tableaux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous ayons deux tableaux, ¬´a¬ª et ¬´b¬ª de taille ¬´n¬ª. Nous voulons g√©n√©rer un tableau ¬´c¬ª de telle sorte que chaque √©l√©ment du tableau c soit la somme des √©l√©ments ayant les m√™mes indices des tableaux ¬´a¬ª et ¬´b¬ª. Mais dans ce cas, pour r√©soudre le probl√®me, nous n'utiliserons pas de calculs s√©quentiels, mais des calculs parall√®les qui sont effectu√©s √† l'aide du GPU.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous lancerons n threads / c≈ìurs. L'index sous lequel chaque thread sp√©cifique fonctionne peut √™tre d√©riv√© de la formule suivante: </font></font><br>
<br>
<code>index = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dans le cas d'une matrice √† deux dimensions, l'index contient deux composants, c'est-√†-dire une ligne et une colonne, qui peuvent √™tre affich√©es comme suit: </font><font style="vertical-align: inherit;">
Nous devons √©galement d√©terminer le nombre de threads par bloc, disons tpb et blocs par grille, disons bpg. Nous utiliserons pour eux des num√©ros standard. </font><font style="vertical-align: inherit;">
Il est important de noter ici un autre concept important: lorsque des calculs doivent √™tre effectu√©s sur le GPU, les donn√©es correspondantes doivent √™tre transf√©r√©es dans la m√©moire globale du GPU, et les r√©sultats des calculs peuvent ensuite √™tre retransf√©r√©s √† l'h√¥te. Ces op√©rations sont effectu√©es √† l'aide des fonctions </font><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">fournies dans la biblioth√®que Python Numba.</font></font><br>
<br>
<code>row = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x<br>
col = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>cuda.to_device()</code><font style="vertical-align: inherit;"></font><code>copy_to_host()</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici les impl√©mentations de cette solution pour le CPU et le GPU. </font><font style="vertical-align: inherit;">Voir les deux listes pour la diff√©rence.</font></font><br>
<br>
<pre><code class="python hljs">c = np.zeroes(n)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):<font></font>
    c[i] = a[i] + b[i]<font></font>
<span class="hljs-keyword">return</span> c</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Impl√©mentation s√©quentielle pour CPU.</font></font></i><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> cuda <span class="hljs-comment">#  Nvidia    GPU </span>
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np <font></font>
<font></font>
<span class="hljs-meta">@cuda.jit('void(float32[:], float32[:], float32[:])') #  Cuda </span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cuda_addition</span>(<span class="hljs-params">a,b,c</span>):</span>
    <span class="hljs-string">"""     ."""</span>
    i = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">if</span> i &gt; c.size:
        <span class="hljs-keyword">return</span>
    c[i] = a[i]+b[i] <span class="hljs-comment">#Perform the addition</span><font></font>
 <font></font>
<span class="hljs-comment">#   </span><font></font>
device = cuda.get_current_device()<font></font>
<font></font>
<span class="hljs-comment">#     </span>
d_a = cuda.to_device(a)  <span class="hljs-comment">#      GPU</span>
d_b = cuda.to_device(b)  <span class="hljs-comment">#      GPU</span><font></font>
d_c = cuda.device_array_like(a)<font></font>
<font></font>
tpb = device.WARP_SIZE       <span class="hljs-comment">#blocksize     ,   = 32</span>
bpg = int(np.ceil((n)/tpb))  <span class="hljs-comment">#   </span><font></font>
<font></font>
cuda_addition[bpg, tpb](d_a, d_b, d_c) <span class="hljs-comment">#  </span><font></font>
<font></font>
<span class="hljs-comment">#      </span><font></font>
c = d_c.copy_to_host()<font></font>
print(c)<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Impl√©mentation parall√®le pour GPU </font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Trouver les 3 positions les plus similaires pour chaque position dans la liste en utilisant le GPU</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir soigneusement √©tudi√© la th√©orie et la pratique, nous revenons √† la t√¢che d'origine: trouver les 3 premi√®res positions similaires pour chaque position dans la liste √† l'aide de calculs GPU. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, l'id√©e principale est que nous avons n positions, et nous allons d√©marrer n threads. </font><font style="vertical-align: inherit;">Chaque fil fonctionnera en parall√®le avec les autres et ind√©pendamment d'eux, en calculant les 3 positions les plus similaires pour chaque position dans la liste. </font><font style="vertical-align: inherit;">Chaque poste sera responsable d'un thread.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> cuda <span class="hljs-comment"># Nvidia's GPU Library</span>
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np 
<span class="hljs-keyword">import</span> math <span class="hljs-comment">#  , ,   , Numpy    GPU</span>
<span class="hljs-keyword">import</span> random<font></font>
<font></font>
<span class="hljs-comment">#                   </span>
<span class="hljs-meta">@cuda.jit('void(float32[:,:],float32[:],int32[:],float32[:],int32[:],float32[:],int32[:])') # CUDA Just-in-time Compiler</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cuda_dist</span>(<span class="hljs-params">X,first_best_val,first_best_index,second_best_val,second_best_index,third_best_val,third_best_index</span>):</span>
    <span class="hljs-string">"""     ."""</span>
    <span class="hljs-comment">#    </span><font></font>
    row = cuda.blockIdx.x * cuda.blockDim.x + cuda.threadIdx.x;<font></font>
    <span class="hljs-keyword">if</span> ((row &gt;= n)): <span class="hljs-comment">#      </span>
        <span class="hljs-keyword">return</span>
    first_best_val[row] = SMALL <span class="hljs-comment">#       </span>
    first_best_index[row] = <span class="hljs-number">-1</span> <span class="hljs-comment">#        </span>
    second_best_val[row] = SMALL <span class="hljs-comment">#       </span>
    second_best_index[row] = <span class="hljs-number">-1</span> <span class="hljs-comment">#        </span>
    third_best_val[row] = SMALL <span class="hljs-comment">#       </span>
    third_best_index[row] = <span class="hljs-number">-1</span> <span class="hljs-comment">#        </span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):
        <span class="hljs-keyword">if</span>(i==row): <span class="hljs-comment">#   </span>
            <span class="hljs-keyword">continue</span>
        <span class="hljs-comment">#     ,        numpy   GPU</span>
        tmp = <span class="hljs-number">0.0</span>
        magnitude1 = <span class="hljs-number">0.0</span>
        magnitude2 = <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(k):<font></font>
            tmp += X[row,j] * X[i,j]<font></font>
            magnitude1 += (X[row,j]* X[row,j])<font></font>
            magnitude2 += (X[i,j]* X[i,j])<font></font>
        tmp /= (math.sqrt(magnitude1)*math.sqrt(magnitude2)) <span class="hljs-comment">#    Dot_product(a,b) = a.b/(|a|*|b|)</span>
        <span class="hljs-keyword">if</span>(tmp&gt;=first_best_val[row]):<font></font>
            third_best_val[row] = second_best_val[row]<font></font>
            third_best_index[row] = second_best_index[row]<font></font>
            second_best_val[row] = first_best_val[row]<font></font>
            second_best_index[row] = first_best_index[row]<font></font>
            first_best_val[row] = tmp<font></font>
            first_best_index[row] = i<font></font>
        <span class="hljs-keyword">elif</span>(tmp&gt;=second_best_val[row]):<font></font>
            third_best_val[row] = second_best_val[row]<font></font>
            third_best_index[row] = second_best_index[row]<font></font>
            second_best_val[row] = tmp<font></font>
            second_best_index[row] = i<font></font>
        <span class="hljs-keyword">elif</span>(tmp&gt;third_best_val[row]):<font></font>
            third_best_val[row] = tmp<font></font>
            third_best_index[row] = i<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
device = cuda.get_current_device()<font></font>
<font></font>
d_x = cuda.to_device(X)<font></font>
d_first_val = cuda.device_array_like(first_val)<font></font>
d_first_index = cuda.device_array_like(first_index)<font></font>
d_second_val = cuda.device_array_like(second_val)<font></font>
d_second_index = cuda.device_array_like(second_index)<font></font>
d_third_val = cuda.device_array_like(third_val)<font></font>
d_third_index = cuda.device_array_like(third_index)<font></font>
<font></font>
<font></font>
tpb = device.WARP_SIZE       <span class="hljs-comment"># blocksize     </span>
bpg = int(np.ceil((n)/tpb))  <span class="hljs-comment">#   </span><font></font>
<font></font>
%time cuda_dist[bpg,tpb](d_x,d_first_val,d_first_index,d_second_val,d_second_index,d_third_val,d_third_index) <span class="hljs-comment">#  </span><font></font>
<font></font>
<span class="hljs-comment">#      </span><font></font>
first_val = d_first_val.copy_to_host()<font></font>
<span class="hljs-keyword">print</span> (first_val[:<span class="hljs-number">10</span>]) <span class="hljs-comment">#  10 </span>
<span class="hljs-comment">#      </span><font></font>
first_index = d_first_index.copy_to_host()<font></font>
<span class="hljs-keyword">print</span> (first_index[:<span class="hljs-number">10</span>]) <span class="hljs-comment">#  10 </span>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Impl√©mentation du GPU ~ Code pour trouver les 3 positions les plus similaires au </font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temps</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
pass√© Le temps total pass√© par le GPU pour trouver les 3 premi√®res positions similaires pour chaque position de la liste √©tait de 481 ms (0,5 seconde). </font><font style="vertical-align: inherit;">Il a fallu 20 secondes suppl√©mentaires pour copier les donn√©es de l'appareil vers l'h√¥te et de l'h√¥te vers l'appareil.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Conclusion</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La t√¢che, dont la solution sur le CPU prendrait environ 2 jours, sur le GPU a √©t√© r√©solue en 20,5 secondes. </font><font style="vertical-align: inherit;">Cela n'a √©t√© possible qu'en raison de la nature de la t√¢che. </font><font style="vertical-align: inherit;">La recherche des 3 postes les plus similaires pour ¬´A¬ª ne d√©pend pas de la recherche des 3 postes les plus similaires pour ¬´B¬ª. </font><font style="vertical-align: inherit;">Nous avons profit√© de ce fait et appliqu√© le parall√©lisme fourni par le GPU pour acc√©l√©rer le processus. </font><font style="vertical-align: inherit;">L'exemple illustre √©galement les types de t√¢ches les plus facilement r√©solus √† l'aide d'un puissant GPU.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Remerciements</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette √©tude a √©t√© r√©alis√©e sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Walmart Labs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MLP (plateforme d'apprentissage automatique) </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Merci √† Ayush Kumar d'avoir aid√© √† rationaliser le flux de travail.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr505558/index.html">Amazon DeepLens Deep Learning Camera. D√©ballage, connexion et d√©ploiement d'un projet</a></li>
<li><a href="../fr505560/index.html">Le deuxi√®me ensemble d'un programme de gestion de produits au centre CS: ce que disent les √©tudiants</a></li>
<li><a href="../fr505568/index.html">Transf√©rer des fichiers √† l'aide de tuyaux et d'autres petites choses sur Delphi</a></li>
<li><a href="../fr505574/index.html">Apprentissage renforc√© gr√¢ce √† des r√©seaux de neurones comp√©titifs</a></li>
<li><a href="../fr505580/index.html">Utilisation de feuilles de calcul et de logiciels informatiques pour la mod√©lisation de Newsvendor</a></li>
<li><a href="../fr505592/index.html">Programmation pour BK0010 avec Android</a></li>
<li><a href="../fr505594/index.html">Comment transformer un visiteur du site en client: un guide sur la cr√©ation de formulaires de prospects</a></li>
<li><a href="../fr505604/index.html">Vuln√©rabilit√© √† la d√©pendance</a></li>
<li><a href="../fr505608/index.html">Vuex - r√©soudre un vieux diff√©rend avec de nouvelles m√©thodes</a></li>
<li><a href="../fr505612/index.html">MK-61: historique, √©mulation, appareil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>