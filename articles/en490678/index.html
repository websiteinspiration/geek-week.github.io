<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👽 🤜🏿 🤴 Using RabbitMQ with MonsterMQ Part 5 🤳🏽 👩🏾‍🤝‍👩🏽 ✴️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous part, we improved our logging system. Instead of using the fanout type exchanger, we used the direct type exchanger, which allowed us ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Using RabbitMQ with MonsterMQ Part 5</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490678/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous part,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we improved our logging system. </font><font style="vertical-align: inherit;">Instead of using the fanout type exchanger, we used the direct type exchanger, which allowed us to selectively receive messages. </font><font style="vertical-align: inherit;">Despite the improvements, our system still has limitations, for example, we cannot receive messages based on several criteria. </font><font style="vertical-align: inherit;">For example, in our system, we might want to redirect messages based not only on the severity level of the message, but also on the message source. </font><font style="vertical-align: inherit;">For example, as in the </font><b><font style="vertical-align: inherit;">syslog</font></b><font style="vertical-align: inherit;"> unix tool</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which redirects messages not only depending on the severity level (info / warn / crit ..), but also depending on the source (auth / cron / kern ...). </font><font style="vertical-align: inherit;">This can give us additional flexibility, for example, we can receive only critical messages from 'cron', but also all messages from 'kern'. </font><font style="vertical-align: inherit;">To implement such a system, we have to get acquainted with a more complex type of exchanger - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">topic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Topic type exchanger</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Messages sent to the topic type exchanger should have a routing key, which is a set of words separated by dots. </font><font style="vertical-align: inherit;">Words can be arbitrary, but they are usually associated with some feature of the message. </font><font style="vertical-align: inherit;">Here are some examples of valid routing keys: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stock.usd.nyse</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nyse.vmw</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quick.orange.rabbit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The key is limited to 255 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The binding key should be specified in a similar way. </font><font style="vertical-align: inherit;">Message routing in the topic type exchanger is similar to direct exchanger routing - the message is sent to the queue with the binding key matching the routing key. </font><font style="vertical-align: inherit;">However, there are two differences:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> * (asterisk) in the binding key can only be replaced with one word </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> # (pound) in the binding key can be replaced by zero or more words </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This can be illustrated by the following image: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/671/37b/8c9/67137b8c9e4d338a879b92c2ac901807.png" alt="image"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(image taken from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">official RabbitMQ website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In this example, we will send messages that represent animals. </font><font style="vertical-align: inherit;">Message routing keys consist of three words (and two dots). </font><font style="vertical-align: inherit;">The first word represents speed, the second represents color, and the third represents species. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our example, two queues are connected to the exchanger: Q1 with the binding key </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"* .orange. *"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And Q2 with two binding keys </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"*. *. Rabbit"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"lazy. #"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These links will mean the following routing:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Q1 is interested in all orange animals. </font></font></li>
<li> Q2     (rabbit)   (lazy)  </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A message with the routing key </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“quick.orange.rabbit”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be delivered in both queues. A message with the key </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"lazy.orange.elephant"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will also be delivered to both. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, the message with the key </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“quick.orange.fox”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will only get in the first place, and with the key </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“lazy.brown.fox”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> only in the second. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Lazy.pink.rabbit"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be delivered a second time once, despite the fact that the routing key matches both binding keys. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Quick.brown.fox”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will not get into any queue, since the routing key does not match any of the binding keys. If you try to send messages with the number of words in the routing key smaller or larger (for example, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"orange"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“quick.orange.male.rabbit”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) than in the binding key the message will be discarded. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The topic type exchanger can behave like a fanout type exchanger if you specify </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as the binding key </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Or as direct if you do not specify </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* *</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the binding key </font><font style="vertical-align: inherit;">, but simply indicate a word.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Putting the code together</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will use the topic type exchanger for our logging system. </font><font style="vertical-align: inherit;">Let's start with the assumption that our message routing keys will look like </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"source.strict</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">" </font></b><font style="vertical-align: inherit;">The code will be almost the same as in the previous part, here is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">send.php</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $producer = \MonsterMQ\Client\Producer();<font></font>
<font></font>
   $producer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $producer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $producer-&gt;newTopicExchange(<span class="hljs-string">'topic-logs'</span>);<font></font>
<font></font>
   $routingKey = <span class="hljs-keyword">isset</span>($argv[<span class="hljs-number">1</span>]) &amp;&amp; !<span class="hljs-keyword">empty</span>($argv[<span class="hljs-number">1</span>]) ? $argv[<span class="hljs-number">1</span>] : <span class="hljs-string">'anonymous.info'</span>;<font></font>
<font></font>
   $message = implode(<span class="hljs-string">' '</span>, array_slice($argv, <span class="hljs-number">2</span>));<font></font>
   $message = <span class="hljs-keyword">empty</span>($message) ? <span class="hljs-string">"Hello World!"</span> : $message;<font></font>
<font></font>
   $producer-&gt;publish($message, $routingKey, <span class="hljs-string">'topic-logs'</span>);<font></font>
<font></font>
   <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n Sent {$message} \n"</span>;<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">worker-1.php</font></font></b><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $consumer = \MonsterMQ\Client\Consumer();<font></font>
<font></font>
   $consumer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $consumer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $producer-&gt;queue(<span class="hljs-string">'queue-1'</span>)-&gt;setExclusive()-&gt;declare();<font></font>
<font></font>
   $consumer-&gt;newTopicExchange(<span class="hljs-string">'topic-logs'</span>);<font></font>
<font></font>
   $bindingKeys = array_slice($argv, <span class="hljs-number">1</span>);
   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($bindingKeys)) {<font></font>
      file_put_contents(<span class="hljs-string">'php://stderr'</span>, <span class="hljs-string">"Usage: $argv[0] [binding_key]\n"</span>);
      <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);<font></font>
   }<font></font>
<font></font>
   <span class="hljs-keyword">foreach</span> ($bindingKeys <span class="hljs-keyword">as</span> $key) {<font></font>
      $producer-&gt;queue(<span class="hljs-string">'queue-1'</span>)-&gt;bind(<span class="hljs-string">'topic-logs'</span>, $key);<font></font>
   }<font></font>
<font></font>
   $consumer-&gt;consume(<span class="hljs-string">'queue-1'</span>);<font></font>
<font></font>
  <span class="hljs-keyword">echo</span> <span class="hljs-string">" \n Waiting for logs. To exit press CTRL+C\n"</span>;<font></font>
<font></font>
   $consumer-&gt;wait(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$message, $channelNumber</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$consumer</span>)</span>{
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n $message \n"</span>;<font></font>
   });<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">worker-2.php</font></font></b><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">try</span> {<font></font>
   $consumer = \MonsterMQ\Client\Consumer();<font></font>
<font></font>
   $consumer-&gt;connect(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">5672</span>);<font></font>
   $consumer-&gt;logIn(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'guest'</span>);<font></font>
<font></font>
   $producer-&gt;queue(<span class="hljs-string">'queue-2'</span>)-&gt;setExclusive()-&gt;declare();<font></font>
<font></font>
   $consumer-&gt;newTopicExchange(<span class="hljs-string">'topic-logs'</span>);<font></font>
<font></font>
   $bindingKeys = array_slice($argv, <span class="hljs-number">1</span>);
   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($bindingKeys)) {<font></font>
      file_put_contents(<span class="hljs-string">'php://stderr'</span>, <span class="hljs-string">"Usage: $argv[0] [binding_key]\n"</span>);
      <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);<font></font>
   }<font></font>
<font></font>
   <span class="hljs-keyword">foreach</span> ($bindingKeys <span class="hljs-keyword">as</span> $key) {<font></font>
      $producer-&gt;queue(<span class="hljs-string">'queue-2'</span>)-&gt;bind(<span class="hljs-string">'topic-logs'</span>, $key);<font></font>
   }<font></font>
<font></font>
   $consumer-&gt;consume(<span class="hljs-string">'queue-2'</span>);<font></font>
<font></font>
  <span class="hljs-keyword">echo</span> <span class="hljs-string">" \n Waiting for logs. To exit press CTRL+C\n"</span>;<font></font>
<font></font>
   $consumer-&gt;wait(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$message, $channelNumber</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$consumer</span>)</span>{
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n $message \n"</span>;<font></font>
   });<font></font>
} <span class="hljs-keyword">catch</span>(\<span class="hljs-built_in">Exception</span> $e) {<font></font>
   var_dump($e);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To receive only critical messages by the first worker, call</font></font><br>
<br>
<pre><code class="bash hljs">php worker-1.php <span class="hljs-string">"*.critical"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To bind the queue that the second worker uses, call the exchanger with two bind keys:</font></font><br>
<br>
<pre><code class="bash hljs">php worker-2.php <span class="hljs-string">"kern.*"</span> <span class="hljs-string">"*.critical"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To send a message, do something like:</font></font><br>
<br>
<pre><code class="bash hljs">php send.php <span class="hljs-string">"kern.critical"</span> <span class="hljs-string">"A critical kernel error"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Experiment with these programs.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490664/index.html">PHP: array_key_exists searches 500 times faster than in_array</a></li>
<li><a href="../en490668/index.html">The history of the transformation from product to project and vice versa (using the example of Goodness in the Moscow region)</a></li>
<li><a href="../en490670/index.html">How to make a car write tests from code for you</a></li>
<li><a href="../en490674/index.html">Habr Wickley # 41 / More autonomous cars, prof. Fortran, Yandex, the pain of the robot, how to block a competitor’s site</a></li>
<li><a href="../en490676/index.html">Unit testing, science and math</a></li>
<li><a href="../en490680/index.html">Avoiding downtime in a Kubernetes cluster with PodDisruptionBudgets</a></li>
<li><a href="../en490682/index.html">How a company from Eindhoven became a monopolist in the market of modern equipment for the production of microcircuits</a></li>
<li><a href="../en490684/index.html">Cable selection for structured cabling</a></li>
<li><a href="../en490686/index.html">News from the world of OpenStreetMap No. 500 (11.02.2020-17.02.2020)</a></li>
<li><a href="../en490690/index.html">We create the WEB address directory of PHP + LDAP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>