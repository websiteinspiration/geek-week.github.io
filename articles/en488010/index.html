<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöî üì£ ‚õ≤Ô∏è Domain Driven Design Tools üîü ‚ôÄÔ∏è üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The blue whale is a great example of how the design of a complex project went wrong. The whale looks like a fish, but it is a mammal: it feeds the cub...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Domain Driven Design Tools</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/488010/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The blue whale is a great example of how the design of a complex project went wrong. The whale looks like a fish, but it is a mammal: it feeds the cubs with milk, it has wool, and the bones of the forearm and hands with fingers are still preserved in the fins, like on land. He lives in the oceans, but cannot breathe underwater, so he regularly rises to the surface to swallow air, even when he is sleeping. The whale is the largest animal in the world, with the length of a nine-story house, and weighing like 75 Volkswagen Touareg cars, but not a predator, but feeds on plankton.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the developers worked on the whale, they did not begin to write everything from scratch, but used the experience from old projects. It seems to be cobbled together from incompatible parts of the code that were not tested, and all the design came down to choosing a framework and urgent ‚Äúcycling‚Äù already in production. As a result, the project turned out to be beautiful in appearance, but with pieces of dense legacy and crutches under the hood. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/to/9e/qb/to9eqb8yxhrfep8tl32q9augiv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To create projects that help businesses earn money, rather than looking like a marine animal that cannot breathe underwater, there is DDD. This is an approach that focuses not on tools or code, but on the study of the subject area, individual business processes and how code or tools work for business logic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is DDD and what tools are there in it, we will tell in an article based on the report</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artyom Malyshev</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The DDD approach in Python, tools, pitfalls, contract programming and product design around the problem being solved, and not the framework used, are all under the cut.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/LqTPRCLZffE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full presentation of the report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artem Malyshev</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proofit404</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - an independent developer, wrote in Python for 5 years, actively helped with Django Channels 1.0. </font><font style="vertical-align: inherit;">Later he focused on architectural approaches: he studied what tools Python architects lack and started a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dry-python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> project </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Co-founder of Drylabs.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Complexity</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is programming?</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programming is a constant struggle with the complexity that developers themselves create when they try to solve problems.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Complexity is divided into two types: introduced and natural. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The introduced one</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> extends along with programming languages, frameworks, OS, asynchrony model. </font><font style="vertical-align: inherit;">This is a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">technical challenge</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that does not apply to business. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Natural</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> complexity is hidden in the product and simplifies the life of users - for this people pay money.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good engineers should reduce the added complexity and increase the natural to increase the usefulness of the product.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But we programmers are complex people and we love to add technical complexity to projects. For example, we did not bother with coding standards, did not use linter, modular design practices and received a lot of style code in projects </font></font><code>if c==1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to work with such code? Read a lot of files, understand variables, conditions, and when and how it will all work. This code is hard to keep in mind - absolutely technical added complexity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another example of added complexity is my favorite ‚Äúcallback hell‚Äù. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pa/1h/s5/pa1hs5z7giwwav8wxyvbllgqdaw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we write in the framework of an event-oriented architecture (EDA) and choose a not-so-good modern framework, we get a code in which it is not clear what happens and when. It‚Äôs hard to read such a code - this is again the added complexity.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Programmers not only adore technical difficulties, but also argue which one is better:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncIO or Gevent;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL or MongoDB;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python or Go;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emacs or Vim;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabs or spaces;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The correct answer of a good programmer to all these questions: ‚ÄúIt makes no difference!‚Äù </font><font style="vertical-align: inherit;">Good developers do not argue over spherical horses in a vacuum, but solve business problems and work on the usefulness of the product. </font><font style="vertical-align: inherit;">Some of them have long established a set of practices that reduce the complexity introduced and help you think more about the business. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of them is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eric Evans</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In 2004, he wrote the book Domain Driven Design. </font><font style="vertical-align: inherit;">She ‚Äúshot‚Äù and gave an impulse to think more about the business, and push the technical details into the background.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v6/4p/kr/v64pkrz6lrqylss53fxhvojvock.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is DDD?</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First a solution to the problem, and then tools</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . First of all, Evans invested in the concept of DDD, that this is not a technology, but a philosophy. In philosophy, you first need to think about how to solve the problem, and only then, with the help of which tools. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work on models with subject matter experts and software developers.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We must communicate with people from business: look for a common language, build a model of the world within which our product will work and solve problems. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write software that explicitly expresses models</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The most important difference between DDD and simple collaboration in a team is that we should write software in the same style as we speak with domain experts. </font><font style="vertical-align: inherit;">All terminology, approaches to the discussion and decision-making should be stored in the source code so that even a non-technical person could understand what is happening there. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speak the same language with business</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">DDD is a philosophy about how to speak the same language with business experts in a specific field and apply terminology to this field. </font><font style="vertical-align: inherit;">We have a common language or dialect within the bound context, which we consider to be true. </font><font style="vertical-align: inherit;">We create boundaries around architectural solutions.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDD is not about technology.</font></font></blockquote><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the technical part, then - DDD.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The sculptor who carves the statue from stone does not read the manual on how to hold a hammer and chisel - he already knows how to work with them. To bring DDD into your project, master the technical part: learn Django to the end, read the tutorial and stop arguing whether to use PostgreSQL or MongoDB. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Most design patterns and patterns are technical noise.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Most of the patterns that we know and use are technical. They say how to reuse code, how to structure it, but they don‚Äôt say how to use it for users, businesses, and model the outside world. Therefore, factories or abstract classes are loosely bound to DDD.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first ‚Äúblue‚Äù book came out almost 20 years ago. People tried to write in this style, walked a rake, and realized that the philosophy is good, but in practice incomprehensible. Therefore, a second book appeared - "red", about how programmers think and write in DDD. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j3/nf/dd/j3nfdd-vnh3shjuuxvxrh7ogwj8.jpeg"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ‚Äúred‚Äù and ‚Äúblue‚Äù books are the pillars on which all DDD stands. </font></font></em><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note. The red and blue books are a unique source of information about DDD, but they are heavy. Books are not easy to read: in the original because of the complex language and terms, and in Russian due to poor translation. Therefore, start learning DDD with a </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">green</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> book. This is a simplified version of the first two with simpler examples and general descriptions. But it‚Äôs better than if the red and blue books beat off your desire to study and apply DDD. It is better to read in the original.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The red book skips the idea of ‚Äã‚Äãhow best to bring DDD into the project, how to structure the work around this approach. </font><font style="vertical-align: inherit;">A new terminology appears - ‚ÄúModel-Driven Design‚Äù, in which our model of the outside world is put in the first place. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bq/oj/65/bqoj653kebtxlaj7fkvbcx8xhq8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only place technology is chosen is Smart UI. </font><font style="vertical-align: inherit;">This is a layer between the outside world, the user and us (a reference to Robert Martin and his clean architecture with layers). </font><font style="vertical-align: inherit;">As you can see, everything goes to the model. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a model? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is the phantom pain of any architect. </font><font style="vertical-align: inherit;">Everyone thinks this is UML, but it is not.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A model is a set of classes, methods, and links between them that reflect the business scenarios in the program.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The model reflects a real object with all the necessary properties and functions. </font><font style="vertical-align: inherit;">This is a high-level toolkit for making decisions from the point of view of business cases. </font><font style="vertical-align: inherit;">Methods and classes, however, are a low-level toolkit for architectural solutions.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dry python</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To fill the model niche, I started a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dry-python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> project </font><font style="vertical-align: inherit;">that has grown into a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">collection of high-level architectural library</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for building Model Driven Design. </font><font style="vertical-align: inherit;">Each of the libraries is trying to close one circle in the architecture and does not interfere with the other. </font><font style="vertical-align: inherit;">Libraries can be used separately, or together if you get a taste. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/un/kb/am/unkbampyzrvkbwwjwd4amsiahuw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The sequence of the narrative corresponds to the chronology of the optimal addition of DDD to the project - by layers. </font><font style="vertical-align: inherit;">The first layer is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">services</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a description of business scenarios (processes) in our system. </font><font style="vertical-align: inherit;">The Stories library is responsible for this layer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stories</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Business scenarios are divided into three parts:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">specification</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a description of the business process;</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The state</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in which the business scenario may exist</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementation of</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> each step of the script.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These parts must not be mixed. </font><font style="vertical-align: inherit;">The Stories library separates these parts and draws a clear line between them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the introduction of DDD and Stories with an example. </font><font style="vertical-align: inherit;">For example, we have a project on Django with a mishmash of Django signals and obscure ‚Äúthick‚Äù models. </font><font style="vertical-align: inherit;">Add an empty services package to it. </font><font style="vertical-align: inherit;">Using the Stories library in parts, we rewrite this hash into a clear and understandable set of scripts in our project. </font></font><br>
<img src="https://habrastorage.org/webt/lo/r9/st/lor9stle7ok2tx_eiv4nx931abs.png"><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DSL specification. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The library allows you to write a specification and provides DSL for this. </font><font style="vertical-align: inherit;">This is a way to describe user actions step by step. </font><font style="vertical-align: inherit;">For example, to buy </font></font><code>subscription</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, I follow several steps: I will find an order, check the relevance of the price, check if the user can afford it. </font><font style="vertical-align: inherit;">This is a high level description. </font></font><br>
<img src="https://habrastorage.org/webt/pf/uy/rk/pfuyrkvzoktrxxjurabhbzfwmka.png"><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contract.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Below this class we will write a contract for the state of the business scenario. To do this, we denote the area of ‚Äã‚Äãvariables that arise in the business process, and for each variable we assign a set of validators. </font></font><br>
<img src="https://habrastorage.org/webt/e0/qy/de/e0qydendpyyrti651302r_6dxnm.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as someone tries to assign a variable to this area as part of the business process, a set of validators will be worked out. We will be sure that the state of the process at runtime is always working. But if not, it painfully falls and screams loudly about it. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stage of implementation of each step</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the same class, </font></font><code>subscription</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we write a set of methods whose names correspond to business steps. Each input method receives a state with which it can work, but does not have the right to modify it. The method may return some marker and report:</font></font><br>
<br>
<ul>
<li>  ,       ()   ;</li>
<li>  -   ,      .</li>
</ul><br>
<img src="https://habrastorage.org/webt/ny/pe/_-/nype_-46uz-nuannwmrcfsrhojq.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are more complex markers: they can confirm that the state is working, suggest deleting or changing some parts of the business process. You can also write in classes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Launch Story.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to run Story on execution? This is a business object that works as a method: we transfer data to the input, it validates them, interprets the steps. The running Story remembers the execution history, records the state that occurred in it in the business process, and tells us </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">who influenced this state</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<img src="https://habrastorage.org/webt/o7/e7/s5/o7e7s53zun6l9mprpqg-vkerp-s.png"><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug toolbar.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If we write in Django and use the debug panel, we can see what business scenarios were processed in each request and their status. </font></font><br>
<img src="https://habrastorage.org/webt/i8/td/aq/i8tdaqss6_wf7uk0e6sdifdqhau.png"><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py.test</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If we write in py.test, then for the fallen test we can see what business scripts were executed on each line and what went wrong. This is convenient - instead of picking in the code, we read the specification and understand what happened. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/pr/gc/4fprgcpruxp3bbpgcapv7rc44je.png"><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sentry.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Even better, when we get error 500. In a regular system, we put up with it and begin to investigate. In Sentry, a detailed report will appear on what the user did to make the mistake. It is convenient and pleasant when at 3 a.m. such information was collected for you. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qk/dy/js/qkdyjspvszlg7vzy803gfqmpt5k.png"><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ELK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Now we are actively working on a plugin that writes all this in Elasticsearch to the Kibana stack and builds competent indexes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/df/7i/7d/df7i7dk01va0ekvv7sxlkdhz9pg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we have a contract for the status of a business process. We know what is there, for example,</font></font><code>relation ID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report. </font><font style="vertical-align: inherit;">Instead of archaic research of what once happened there, we write a request in Kibana. </font><font style="vertical-align: inherit;">It will show all Stories that are related to a specific user. </font><font style="vertical-align: inherit;">Next, we examine the state within our business processes and business scenarios. </font><font style="vertical-align: inherit;">We do not write a single line of logging code, but the project is logged at the very level of abstraction at which we are interested to watch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But I want something higher level, for example, light objects. </font><font style="vertical-align: inherit;">Such objects contain literate data structures and methods that relate to the adoption of business decisions, and not to working with the database, for example. </font><font style="vertical-align: inherit;">Therefore, we move on to the next part of the Model-Driven architecture ‚Äî entities, agregates, and value objects.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oh/c4/hh/ohc4hhk6ru1lrn-ohyrp83byn1w.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entities, agregates and value objects</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How is all this interconnected? For example, a user places a product order and we bill. What is the root of aggregation, and what is a simple object? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/4g/kc/ml4gkcmc0-hajo2sk5apaklct6y.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All that is underlined is the root of aggregation. This is what I want to work with directly: important, valuable, holistic. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where to begin?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We will create an empty package in the project, where we will put our units. Aggregates are better written with something declarative, like </font></font><code>dataclasses</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>attrs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<img src="https://habrastorage.org/webt/7e/0z/dx/7e0zdxqhapwuerqxbs8zf6wocse.png"><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dataclasses</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If </font></font><code>dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we indicate </font><font style="vertical-align: inherit;">some kind of </font><font style="vertical-align: inherit;">aggregate, we will write an annotation on it using </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NewType</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the annotation we indicate an explicit reference, which is expressed in the type system. If it </font></font><code>dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äôs just a data structure (entity), then save it inside the aggregate.</font></font><br>
<img src="https://habrastorage.org/webt/9y/g3/fe/9yg3fe7qn2_xj6pas4m1hewhikc.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the context of Stories, only aggregates can lie. </font><font style="vertical-align: inherit;">Access to something embedded in them can only be obtained through public methods and high-level rules. </font><font style="vertical-align: inherit;">This allows you to logically and competently build a model over which we work together with experts from the subject area. </font><font style="vertical-align: inherit;">This is the same </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">single language</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xj/ov/7s/xjov7shv-7gsu-u0w6c6aejxkq8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem immediately arises - repositories. </font><font style="vertical-align: inherit;">I have a database that I work with through Django, a nearby microservice to which I send requests, there is JSON and an instance of the Django model. </font><font style="vertical-align: inherit;">To receive data and transfer it by hand, just to call or test the method beautifully? </font><font style="vertical-align: inherit;">Of course not. </font><font style="vertical-align: inherit;">Dry-python has a Mappers library that allows you to map high-level abstractions and domain aggregates to the places where we store them.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mappers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We add one more package to our project - a repository in which we will store ours </font></font><code>mappers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This is how we will transfer high-level business logic to the real world. </font></font><br>
<img src="https://habrastorage.org/webt/gt/w8/zu/gtw8zusqmldesc-5m-sanew8hxy.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we can describe how we map one </font></font><code>dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to a Django model. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Django ORM.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We compare the order model with the description of Django ORM - we look at the fields. </font></font><br>
<img src="https://habrastorage.org/webt/gw/cp/v8/gwcpv8rjs4cs592qvob0tu0t_rw.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we can rewrite some fields through the optional config. The following will happen: </font></font><code>mapper</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">during the declaration it will compare how the </font></font><code>dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">model is </font><font style="vertical-align: inherit;">written </font><font style="vertical-align: inherit;">. For example, annotations </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(in </font></font><code>Order dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is a field </font></font><code>cost</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with annotation </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) in the Django-model corresponds </font></font><code>integer field</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the option </font></font><code>nullable="true"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Here it will </font></font><code>dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offer to add </font></font><code>optional</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, or to remove</font></font><code>nullable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from </font></font><code>field</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Through Mappers, you can add functions that read or write something. Readers are functions that receive an aggregate at the input and return a reference to it. Writers do the opposite - return units. Under the hood, for example, there may be a request to the database through Django. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger Definitions</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The same operations can be carried out with microservices. You can write a part of the swagger diagram on them and check how much the swagger diagram of a particular service matches your domain models. Further, the returned request from the Request library will be transparently translated into </font></font><code>dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<img src="https://habrastorage.org/webt/sk/2k/rv/sk2krveeieqjqkd5gmcn1hxettc.png"><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraphQL queries.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GraphQL and microservices: GraphQL interface type schema works well against</font></font><code>dataclass</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. You can translate specific GraphQL queries into internal data structures. </font></font><br>
<img src="https://habrastorage.org/webt/th/om/j0/thomj0ho9pgvu-n8_w7uhkvlmz4.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why bother with the internal high-level data model inside the application? To illustrate the ‚Äúwhy,‚Äù I will tell an ‚Äúentertaining‚Äù story. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In one of our projects, web sockets worked through the Pusher service. We did not bother, we wrapped it in an interface so as not to call directly. This interface was tied in all the Stories and were satisfied. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But business requirements have changed. It turned out that the guarantees that Pusher provides for web sockets are not enough. For example, you need guaranteed message delivery and message history for the last 2 minutes. Therefore, we decided to move to the Ably Realtime service. It also has an interface - we will write an adapter and tie it everywhere, everything will be great. Not really.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The abstractions that Pusher uses (function arguments) are trapped in every business object. </font><font style="vertical-align: inherit;">I had to fix about 100 Stories, and fix the formation of the user channel to which we are sending something. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Back to the tests.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tests &amp; mocks</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How do you usually test this behavior with external services? </font><font style="vertical-align: inherit;">We‚Äôre wetting something, we are watching how a third-party library is called, and that‚Äôs all - we are sure that everything is fine. </font><font style="vertical-align: inherit;">But when the library changes, the argument formats change too. </font></font><br>
<img src="https://habrastorage.org/webt/zo/ey/34/zoey341uas00jfbgt0e5nld69ta.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can save a week rewriting thousands of tests and hundreds of business cases if you test the behavior of the internal model differently. </font><font style="vertical-align: inherit;">For example, something similar to integration testing: we write to the user stream, and already inside the adapter, Pusher or Ably we translate this stream into the name of the normal channel so as not to write it all into business logic.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dependencies</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In such a model architecture, many superfluous entities appear. </font><font style="vertical-align: inherit;">Previously, we took some kind of Django function and wrote it: request, response, minimum body movements. </font><font style="vertical-align: inherit;">Here you need to initialize the Mappers, put in Stories and initialize, process the request line of the HTTP request, see which answer to give. </font><font style="vertical-align: inherit;">All this results in 30-50 lines of boilerplate calling code Stories inside Django-view. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the other hand, we have already written interfaces and Mappers. </font><font style="vertical-align: inherit;">We can check their compatibility with a specific business case, for example, using the Dependencies library. </font><font style="vertical-align: inherit;">How? </font><font style="vertical-align: inherit;">Through the Dependency injection pattern, everything is declaratively glued to a minimal boilerplate. </font></font><br>
<img src="https://habrastorage.org/webt/w9/_5/th/w9_5thkcuryvswlpy39x8dpkoio.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we indicate the task to take a class in the services package, put three</font></font><code>mappers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, initialize the Stories object and give it to us. </font><font style="vertical-align: inherit;">With this approach, the number of boilerplate in the code is reduced enormously.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactoring map</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using everything I talked about, we developed a scheme by which we rewrote a large project from Django signals (implicit "callback hell") to Django using DDD. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first step without DDD</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . At first we did not have DDD - we wrote MVP. When they made their first money, they invited investors, and convinced them to switch to DDD. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stories without contracts.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We broke the project into logical business cases without data contracts. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contracts and aggregates</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Then, one by one, we dragged the data contract for each model, which can be traced in our architecture. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mappers</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mappers wrote to get rid of data warehouse templates. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dependency injection</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Get rid of gluing patterns.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If your project has outgrown MVP and it urgently needs to be changed in architecture so that it does not slip into legacy - look towards DDD.</font></font><br>
<br>
<blockquote>     legacy  Python-,     ,    ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Moscow Python Conf++</a> 27 .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>        Python       .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">unconference</a>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>, ,   Drylabs.<br>
<br>
  DDD    Python,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">TechLead Conf</a> ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    </a>   IT-,    DDD .   8 , Call for Papers   6 .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487996/index.html">How script drivers and server mothers take over IT</a></li>
<li><a href="../en488000/index.html">Tesla Plaid. Two options for three-motor drive layout</a></li>
<li><a href="../en488002/index.html">The case of one geek</a></li>
<li><a href="../en488006/index.html">At Moscow Python Conf ++, come talk to the language developers</a></li>
<li><a href="../en488008/index.html">Taming the beast: legacy code, tests and you</a></li>
<li><a href="../en488012/index.html">Parking for your cons</a></li>
<li><a href="../en488014/index.html">9. Fortinet Getting Started v6.0. Logging and Reporting</a></li>
<li><a href="../en488018/index.html">CAPTCHA, special case: we break a neural network with thirty lines of code</a></li>
<li><a href="../en488020/index.html">Vivaldi 2.11 - One Touch Beauty</a></li>
<li><a href="../en488024/index.html">Fantastic advisory locks and where they live</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>