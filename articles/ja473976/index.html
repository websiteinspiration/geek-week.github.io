<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛶 🤐 👨‍👩‍👧‍👧 AWS Elasticsearch：根本的に欠陥のある製品 ☕️ 🈚️ 🕑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nick Price 記事の翻訳
 
 現在、AWS Elasticsearchを使用して実装された大規模なロギングプロジェクトに取り組んでいます。数年間、大規模なElasticsearchバックボーンクラスターを使用してきたため、AWS実装の品質に完全に圧倒され、なぜ修正されなかったか、少なくとも...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>AWS Elasticsearch：根本的に欠陥のある製品</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473976/"><img src="https://habrastorage.org/webt/gr/2i/4f/gr2i4fdf6rxq5mh3uwosssdp4uq.jpeg"><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nick Price</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
記事の翻訳</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、AWS Elasticsearchを使用して実装された大規模なロギングプロジェクトに取り組んでいます。</font><font style="vertical-align: inherit;">数年間、大規模なElasticsearchバックボーンクラスターを使用してきたため、AWS実装の品質に完全に圧倒され、なぜ修正されなかったか、少なくとも改善されなかったのか理解できません。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elasticsearchは、明示的に作成した、またはデータの送信後に自動的に作成できるさまざまなインデックスにデータを格納します。</font><font style="vertical-align: inherit;">各インデックスのエントリは特定の数のシャードに分割され、クラスター内のノード間で分散されます（シャードの数がノードの数で均等に分割されていない場合は、可能な限り均等に分散されます）。</font><font style="vertical-align: inherit;">ElasticSearchには、基本的な断片とレプリカの断片という2つの主要なタイプの断片があります。</font><font style="vertical-align: inherit;">レプリカシャードは、ノードに障害が発生した場合のフォールトトレランスを提供し、ユーザーはレプリカシャードの数をインデックスごとに個別に設定できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準のElasticsearchの仕事</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elasticsearch-弾力性があります。非常に扱いにくい場合もありますが、一般的には、クラスターにノードを追加したり、ノードを削除したりできます。また、ノードの削除時に適切な数のレプリカがある場合、Elasticsearchはシャードを分散し、クラスター内のノードの負荷を分散します。これは通常は機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
高価なリクエストが実行されると、ノードの落下などが発生する場合がありますが、多数の設定が作業の維持に役立ちます。十分な数のシャードレプリカがある場合、ノードが落ちても、全体としての作業には影響しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
標準のElasticsearchには、X-Pack、監査機能、詳細なACL、モニタリング、アラートなど、多数のアドオンも用意されています。 X-Packのほとんどは、おそらく新しいSplunkライセンスポリシーに応じて、最近無料になりました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amazon Elasticsearch Work</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いつものように、AmazonはElasticsearchの一部のオープンソースコードを取得し、ハードフォークを作成して独自のサービスとして販売を開始し、Elasticsearchのメインバージョンで長年にわたって利用可能であった独自のバージョンの関数を徐々に導入しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Amazon製品には、RBACや監査など、多くのものが不足しています。これは、異なるチームからのログを受け入れ、それらを互いに分離したいためです。</font><font style="vertical-align: inherit;">現在のところ、Elasticsearchにアクセスできるユーザーはすべてのアクセス権を持っているため、他のユーザーのデータを誤って削除したり、ノード上でのデータの複製方法を変更したり、間違ったインデックステンプレートを追加してデータの受信を完全に停止したりできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはイライラさせられますが、これはサービスの最大の問題ではありません。シャードの再調整-Elasticsearchの中心的な概念はAWSの実装では機能せず、Elasticsearchのほぼすべての機能が無効になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、データがノードに追加されると、他のノードよりも多くのデータを入力できます。ロードされたレコードが同じサイズであること、またはシャードの数が常にクラスターのすべてのノードに均等に分散されることが保証されていないため、これは予想されたことです。 Elasticsearchはノード間でシャードのバランスを再調整できるため、これは重要ではありません。1つのノードが実際にいっぱいになると、他のノードはデータが満たされる代わりに喜んでデータの受信を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはAmazonではサポートされていません。一部のノードは、他のノードよりも（はるかに）満杯になる可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amazonでは、Elasticsearchクラスターの1つのノードに十分な空き容量がない場合</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><b><font style="vertical-align: inherit;">クラスター全体がデータの受信を</font></b><font style="vertical-align: inherit;">停止し、完全に停止します。 Amazonのソリューションは、インデックス作成テンプレートでシャードの数を定期的に変更し、以前に作成したデータを新しいインデックスに再インデックス化し、以前のインデックスを削除し、必要に応じてデータを古い構造に逆インデックス化するという悪夢をユーザーが体験できるようにすることです。これは完全に冗長であり、大量の計算コストに加えて、ダウンロードされたデータの未処理のコピーは、インデックスの再作成に必要になるため、分析されたレコードとともに保存する必要があります。そしてもちろん、これはAWSでの「通常の」作業に必要なメモリ量を2倍にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"おっとっと！クラスタ全体のインデックスを何度も再作成しなかったため、ノードがいっぱいになりました！何をすべきか？" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのオプションがあります。まず、必要な量のデータを削除してクラスターを元に戻し、何も崩れないことを期待してインデックスの再作成を開始します。削除したいもののバックアップがありますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のオプションは、クラスターにより多くのノードを追加するか、既存のノードをより大きなインスタンスサイズにサイズ変更することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、シャードを再調整できない場合、ノードを追加したり、変更を加えたりするにはどうすればよいですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Amazonのソリューションは、青緑色の配備です。それらは新しいクラスター全体を起動し、前のクラスターの内容全体を新しいクラスターにコピーしてから、古いクラスターを切り替えて破棄します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなサイズ変更タスクは、想像できるように、大規模なクラスターの場合、数日かかる場合があります。数兆個のレコードの複製には時間がかかる場合があります。</font><font style="vertical-align: inherit;">これにより、既存のクラスターに異常な負荷が発生し（おそらくすでに容量を超えている）、実際にクラスターが失敗する可能性があります。</font><font style="vertical-align: inherit;">AWSの30を超えるクラスターでいくつかの同様の操作を実行しましたが、自動モードでの正常な完了を一度だけ確認しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、クラスターのサイズを変更しようとしましたが、タスクは完了しませんでした。</font><font style="vertical-align: inherit;">それで？</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アマゾンの相互作用</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスターのサイズを変更するタスクが中断したため（そのような記事を処理しないことを選択したサービスの場合）、優先度が最も高いAWSテクニカルサポートへのチケットを開きます。もちろん、彼らはあなたのシャードの量やサイズについて不満を述べ、あなたがすでに500回読んだ「ベストプラクティス」へのリンクを親切に追加します。そして、あなたはそれが修正されるのを待ちます。そして待って。そして待って。前回、クラスターのサイズを変更しようとしてブロックされたため、深刻な誤動作が発生し、すべてをオンラインに戻すのに7日かかりました。彼らは数日でクラスター自体を復元しましたが、すべてが停止すると、Kibanaが実行されているノードがメインクラスターとの接続を失ったことは明らかです。 AWSサポートは、疑問に思っている間に何かを修正するためにさらに4日間を費やしました、Kibanaは機能しますか。彼らは問題を修正したかどうかさえ知りませんでした、そして私は彼らが彼ら自身のシステム間のコミュニケーションを回復したかどうかチェックしなければなりませんでした。それ以来、ノードがいっぱいになった場合にデータを削除する以外のことはやめました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWSでの組織のコストは莫大です。</font><font style="vertical-align: inherit;">これにより、さまざまな分野の専門家と定期的に会い、実装戦略について話し合い、さまざまな技術的な問題に対処する機会が得られます。</font><font style="vertical-align: inherit;">私たちは、Elasticsearchの代表とのアポイントメントをとり、その間、私はほとんどの会議でElasticsearchの基本を説明し、その製品の「癖」を説明しました。</font><font style="vertical-align: inherit;">エキスパートは、ノードがいっぱいになるとすべてが崩壊するという完全なショックを受けました。</font><font style="vertical-align: inherit;">派遣されたエキスパートが製品の作業の基本を知らない場合でも、サポートチームが実稼働クラスターを再開するのに7日間必要であることは当然のことです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結局のところ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が飛び込んだロギングプロジェクトには、現在取り組んでいるアーキテクチャエラーと設計上の弱い決定の共有があります。そしてもちろん、AWS Elasticsearchが元の製品とは異なることを期待していました。ただし、AWS Elasticsearchでは、多くの基本的な機能が無効になっている、または欠落しているため、発生するほとんどすべての問題が悪化しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使いやすく小さなクラスターの場合、AWS Elasticsearchは非常にうまく機能しますが、ペタバイトサイズのクラスターの場合、それは無限の悪夢でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AmazonのElasticsearch実装がシャードのバランスをとることができないのはなぜだろうと私は非常に興味があります。これは非常に基本的なElasticsearch機能です。メインのElasticsearchと比較した場合の制限にもかかわらず、適切に機能する場合は、大規模なクラスターには許容できる製品です。アマゾンがなぜそんなに壊れたものを提供しているのか、そしてなぜ彼らが2年以上にわたって状況を改善していないのか理解できません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他の人が示唆しているように、これは理にかなっているようですが、この動作はAWS実装の兆候であり、巨大なマルチテナントクラスターとして設計されており、エンドユーザーがスタンドアロンクラスターのように見えるように分離を提供しようとしています。暗号化されたデータのみや暗号化されたデータ転送などのオプションがあっても、これはもっともらしいようです。あるいは、おそらくそれらのツールと構成は、はるかに初期のアーキテクチャのレガシーにすぎません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、私の友人が述べたように、新しいノードをスピンしてすべてのデータを転送せずにクラスターにノードを追加または削除できない場合でも、「Elastic」と呼んでもおかしいです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
脚注：このテキストを書いたときに、2年前に多くの同様の主張を持つ投稿を見つけました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read.acloud.guru/things-you-should-know-before-using-awss-elasticsearch-service-7cd70c9afb4f</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja473956/index.html">ドラッグディーラーの電話会社からの秘密情報</a></li>
<li><a href="../ja473958/index.html">NICTの日本人が、1 Pbit / sの帯域幅で動作するファイバークラスターを紹介しました</a></li>
<li><a href="../ja473962/index.html">ダークモードは今どこにでもあります。とても便利ですか？（投稿の最後の投票）</a></li>
<li><a href="../ja473972/index.html">組み込み開発者の注文：Amazon FreeRTOSでバグを探す</a></li>
<li><a href="../ja473974/index.html">Intercom'19-Voximplantの通信自動化に関する会議が11月14日に開催されます</a></li>
<li><a href="../ja473978/index.html">そのような痛み、そのような痛み、サービスとしてのレジ2：0</a></li>
<li><a href="../ja473982/index.html">NB-IoT：それはどのように機能しますか？パート3：SCEF-オペレーターサービスへの単一のアクセスウィンドウ</a></li>
<li><a href="../ja473984/index.html">データサイエンスダイジェスト（2019年10月）</a></li>
<li><a href="../ja473986/index.html">「私の夢は、木々の間から人を見ることです」-現代の検索技術に関する「Lisa Alert」の創設者</a></li>
<li><a href="../ja473990/index.html">OpenGLを学んでください。レッスン7.2-テキストの描画</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>