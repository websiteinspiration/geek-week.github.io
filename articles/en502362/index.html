<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí™üèæ üßëüèª üßëüèæ‚Äçü§ù‚ÄçüßëüèΩ Learning Event Tracing for Windows: Theory and Practice üöç ‚≠êÔ∏è üéΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon. Recently, I needed to deal with the Windows trace service. This service appeared in Windows 2000, however, there were very few article...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Learning Event Tracing for Windows: Theory and Practice</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502362/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good afternoon. </font><font style="vertical-align: inherit;">Recently, I needed to deal with the Windows trace service. </font><font style="vertical-align: inherit;">This service appeared in Windows 2000, however, there were very few articles on this service on the Internet. So the idea of ‚Äã‚Äãwriting this article appeared. </font><font style="vertical-align: inherit;">So, let's begin! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Today I will try to talk about:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Windows Tracing Service Theory</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Creating Your ETW Session</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Using event tracing API to work with ETW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Using tracerpt and xperf to work with ETW</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Tracing Service Theory</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event Tracing for Windows (ETW) is a service that allows you to receive events from one or more event providers in real time or from a * .etl file for a certain time period. </font><font style="vertical-align: inherit;">Unclear? </font><font style="vertical-align: inherit;">Now let's figure it out! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to understand how ETW works, you need to understand the structure of this service. </font></font><br>
<br>
<img src="https://docs.microsoft.com/en-us/windows/win32/etw/images/etdiag2.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ETW architecture includes 4 elements</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">event providers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">event consumers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETW controllers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETW sessions (event tracing sessions)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The principle of operation is as follows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A number of event providers are registered in the system, i.e. </font><font style="vertical-align: inherit;">applications that can share their experiences with ETW sessions. </font><font style="vertical-align: inherit;">Also in this system there is a certain number of active ETW sessions that can consume events from one or more providers and provide them to the user either in real time or write all events from suppliers to a log file (* .etl). </font><font style="vertical-align: inherit;">And controllers control this whole movement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now we will consider each element of the architecture considered above in more detail to finally understand the principle of work!</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Providers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event providers are applications that contain event tracking tools. After the provider has registered, the controller can enable or disable event tracking in the provider. The provider determines its interpretation of on or off. Typically, an enabled provider generates events, but a disabled provider does not. This allows you to add event tracking to our application without requiring it to generate events all the time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One vendor can share their events with multiple ETW sessions at once.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each event consists of two elements: a header and data! </font><font style="vertical-align: inherit;">The event header includes information about the event: provider identifier, event identifier, timestamp, etc. </font><font style="vertical-align: inherit;">The rest of the data is determined by a specific provider: ETW receives any data and writes it to the buffer, and their interpretation is assigned to the consumers of information. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are four main types of providers: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MOF providers (classic) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
providers WPP </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
providers based on the manifest </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
providers TraceLogging. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event providers differ in the types of fields that they store in event payloads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event providers seem to be sorted out. </font><font style="vertical-align: inherit;">Move on!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controllers </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A controller is an application that is responsible for the operation of one or more ETW sessions. </font><font style="vertical-align: inherit;">It is the controller that determines the size and location of the log file, starts and stops event tracing sessions (ETW sessions), and allows providers to record events in the session. </font><font style="vertical-align: inherit;">As mentioned earlier, it is the controller that allows the provider to share their events!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consumers </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consumers are applications that receive and process events from one or more trace sessions at the same time. </font><font style="vertical-align: inherit;">Consumers can receive events stored in log files or from sessions that deliver events in real time. </font><font style="vertical-align: inherit;">As we already know, one ETW session can have several suppliers. </font><font style="vertical-align: inherit;">The question arises: will there be confusion? </font><font style="vertical-align: inherit;">How will events from the various ETW sessions relate to each other? </font><font style="vertical-align: inherit;">Events are sorted by the time they occur, i.e. </font><font style="vertical-align: inherit;">the system delivers events in chronological order!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETW Sessions</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event tracking sessions (ETW sessions) record events from one or more providers that the controller permits. </font><font style="vertical-align: inherit;">The session is also responsible for managing and flushing buffers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event Tracing supports up to 64 events tracing sessions running simultaneously. </font><font style="vertical-align: inherit;">Of these sessions, there are two special-purpose sessions. </font><font style="vertical-align: inherit;">The remaining sessions are available for general use. </font><font style="vertical-align: inherit;">Two special-purpose sessions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Global logger session</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NT Kernel Logger Session</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Global Logger event trace session records events that occur at the beginning of the operating system boot process, such as those generated by device drivers. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The NT Event Tracking Session Kernel Logger records predefined system events generated by the operating system, such as disk I / O events or page failures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, now let's get to practice !!!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating Your ETW Session</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before starting work, we need knowledge of several utilities, namely: a </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
list of providers available on a particular OS</font></font><br>
<br>
<pre><code class="bash hljs">logman query providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get full information about the provider</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp &lt; &gt; /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
list of all active ETW sessions</font></font><br>
<br>
<pre><code class="bash hljs">xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, for viewing files, it is advisable to have Notepad ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After looking at the list of providers on your computer (and there are more than 1000 on Windows 10), we will choose one of them for our session: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/6e/wm/hl6ewmoxww9guutq7rt9m_rnfug.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I chose Microsoft-Windows-WinINet (this service records all our actions when working in the Microsoft Edge browser). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Win + R -&gt; compmgmt.msc </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. "Performance" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. "Data Collector Sets" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. "Event Trace Sessions" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. ‚ÄúNew‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. ‚ÄúData Collector Set‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. Specify the name of the data collector </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8. ‚ÄúCreate manually (Advanced)‚Äù (Add manually (for experienced) ") </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gk/ec/_w/gkec_w2zlyy-m_jo25bm2bfgx38.png" alt="image"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
9. Add interesting us providers per session</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10. Specify the keywords of interest to us in the ‚ÄúKeywords (Any)‚Äù field - 0xFFFFFFFFFFFFFFFFFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11. Specify the logging level 0xFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
= </font></font><img src="https://habrastorage.org/webt/d7/yw/3w/d7yw3w3ondmdrmeb_avfvnafa7y.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12. Select the path where the session log file will be saved </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
13. Select the ‚Äú Start this data collector set now ‚Äù(‚Äú Run the group of data collectors now ‚Äù) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the session that we created works. Microsoft Edge needs some work to get the session to gather information about us! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After some time has passed, we go to the place where we saved the log file. We execute the following command there.</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">"   .etl"</span> -o -report -summary -lr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After executing this command, 4 files will be generated. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/e_/rp/upe_rph8_bnkvfuemiai0lquv0w.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are currently interested in dumpfile.xml. </font><font style="vertical-align: inherit;">You can open this file either through notepad ++, you can also do this in Excel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having carefully studied this file, you can see that this session collected almost all the information about our movement on the Internet !!! </font><font style="vertical-align: inherit;">You can read more about it here. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We study ETW and extract profits</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, and we move on. </font><font style="vertical-align: inherit;">We just created a session with a single event provider. </font><font style="vertical-align: inherit;">Received session data from the log file. </font><font style="vertical-align: inherit;">It's time to code!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using event tracing API to work with ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On habr there is an interesting article, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worst API ever created</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article you will find answers to many questions that you most likely will have when writing applications! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will code in C ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the simplest.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure and start an event tracking session</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, consider the general idea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To start a trace session, you must: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Set the structure EVENT_TRACE_PROPERTIES </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Start the session using StartTrace </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, enable the event providers </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Enable the providers using EnableTrace | EnableTraceEx | EnableTraceEx2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To stop the trace session, you must: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Before stopping the trace session, you must disable the providers using EnableTrace | EnableTraceEx | EnableTraceEx2, passing EVENT_CONTROL_CODE_DISABLE_PROVIDER </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) Call the ControlTrace function and pass it EVENT_TRACE_CONTROL_STOP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the example below, I am creating a session called MyEventTraceSession. </font><font style="vertical-align: inherit;">The log file in the current directory is called WriteThePuth.etl. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The event provider is Microsoft-Windows-Kernel-Process. </font><font style="vertical-align: inherit;">You can find out his GUID using</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp Microsoft-Windows-Kernel-Process /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Directly code:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-meta">#include &lt;windows.h&gt;</span>
<span class="hljs-meta">#include &lt;stdio.h&gt;</span>
<span class="hljs-meta">#include &lt;conio.h&gt;</span>
<span class="hljs-meta">#include &lt;strsafe.h&gt;</span>
<span class="hljs-meta">#include &lt;wmistr.h&gt;</span>
<span class="hljs-meta">#include &lt;evntrace.h&gt;</span>
<span class="hljs-meta">#include &lt;iostream&gt;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGFILE_PATH L"WriteThePuth.etl"</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGSESSION_NAME L"MyEventTraceSession"</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,     .</span>
<span class="hljs-comment">//      GUID .</span><font></font>
<font></font>
<span class="hljs-comment">// {AE44CB98-BD11-4069-8093-770EC9258A12}</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID SessionGuid =<font></font>
{ <span class="hljs-number">0xae44cb98</span>, <span class="hljs-number">0xbd11</span>, <span class="hljs-number">0x4069</span>, { <span class="hljs-number">0x80</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xe</span>, <span class="hljs-number">0xc9</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0x12</span> } };<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,   ,   </span>
<span class="hljs-comment">//    .</span><font></font>
<font></font>
<span class="hljs-comment">//{22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716} Microsoft-Windows-Kernel-Process</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID ProviderGuid =<font></font>
{ <span class="hljs-number">0xd22FB2CD6</span>, <span class="hljs-number">0x0E7B</span>, <span class="hljs-number">0x422B</span>, {<span class="hljs-number">0xA0</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x2F</span>, <span class="hljs-number">0xAD</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0xD0</span>, <span class="hljs-number">0xE7</span>, <span class="hljs-number">0x16</span> } };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wmain</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)</span><font></font>
{<font></font>
    setlocale(LC_ALL, <span class="hljs-string">"ru"</span>);<font></font>
    ULONG status = ERROR_SUCCESS;<font></font>
    TRACEHANDLE SessionHandle = <span class="hljs-number">0</span>;<font></font>
    EVENT_TRACE_PROPERTIES* pSessionProperties = NULL;<font></font>
    ULONG BufferSize = <span class="hljs-number">0</span>;<font></font>
    BOOL TraceOn = TRUE;<font></font>
<font></font>
    <font></font>
    BufferSize = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    pSessionProperties = (EVENT_TRACE_PROPERTIES*)malloc(BufferSize);<font></font>
    <span class="hljs-keyword">if</span> (NULL == pSessionProperties)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"Unable to allocate %d bytes for properties structure.\n"</span>, BufferSize);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    ZeroMemory(pSessionProperties, BufferSize);<font></font>
    pSessionProperties-&gt;Wnode.BufferSize = BufferSize;<font></font>
    pSessionProperties-&gt;Wnode.Flags = WNODE_FLAG_TRACED_GUID;<font></font>
    pSessionProperties-&gt;Wnode.ClientContext = <span class="hljs-number">1</span>; <span class="hljs-comment">//QPC clock resolution</span><font></font>
    pSessionProperties-&gt;Wnode.Guid = SessionGuid;<font></font>
    pSessionProperties-&gt;LogFileMode = EVENT_TRACE_FILE_MODE_SEQUENTIAL;<font></font>
    pSessionProperties-&gt;MaximumFileSize = <span class="hljs-number">1024</span>;  <span class="hljs-comment">// 1024 MB</span>
    pSessionProperties-&gt;LoggerNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES);<font></font>
    pSessionProperties-&gt;LogFileNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    StringCbCopy((LPWSTR)((<span class="hljs-keyword">char</span>*)pSessionProperties + pSessionProperties-&gt;LogFileNameOffset), <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH), LOGFILE_PATH);<font></font>
    <font></font>
<font></font>
    status = StartTrace((PTRACEHANDLE)&amp;SessionHandle, LOGSESSION_NAME, pSessionProperties);<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"StartTrace() failed with %lu\n"</span>, status);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  ,   ,      .</span><font></font>
<font></font>
    status = EnableTraceEx2(<font></font>
        SessionHandle,<font></font>
        (LPCGUID)&amp;ProviderGuid,<font></font>
        EVENT_CONTROL_CODE_ENABLE_PROVIDER,<font></font>
        TRACE_LEVEL_INFORMATION,<font></font>
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,<font></font>
        NULL<font></font>
        );<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"EnableTrace() failed with %lu\n"</span>, status);<font></font>
        TraceOn = FALSE;<font></font>
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   .    ,   </span>
    wprintf(L<span class="hljs-string">"Run the provider application. Then hit any key to stop the session.\n"</span>);<font></font>
    _getch();<font></font>
   <font></font>
<font></font>
cleanup:<font></font>
    <span class="hljs-keyword">if</span> (SessionHandle)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (TraceOn)<font></font>
        {<font></font>
            status = EnableTraceEx2(<font></font>
                SessionHandle,<font></font>
                (LPCGUID)&amp;ProviderGuid,<font></font>
                EVENT_CONTROL_CODE_DISABLE_PROVIDER,<font></font>
                TRACE_LEVEL_INFORMATION,<font></font>
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,<font></font>
                NULL<font></font>
                );<font></font>
        }<font></font>
<font></font>
        status = ControlTrace(SessionHandle, LOGSESSION_NAME, pSessionProperties, EVENT_TRACE_CONTROL_STOP);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
        {<font></font>
            wprintf(L<span class="hljs-string">"ControlTrace(stop) failed with %lu\n"</span>, status);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (pSessionProperties)<font></font>
    {<font></font>
        free(pSessionProperties);<font></font>
        pSessionProperties = NULL;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will analyze the above program in more detail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Set the EVENT_TRACE_PROPERTIES structure </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To configure an event trace session, you must use the EVENT_TRACE_PROPERTIES structure to specify session properties. The memory you allocate for the EVENT_TRACE_PROPERTIES structure must be large enough to also contain the names of the session and log files that follow the structure in memory. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Start the session using StartTrace </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After you specify the properties of the session, call the StartTrace function to start the session. If the function succeeds, the SessionHandle parameter will contain the session descriptor, and the LoggerNameOffset property will contain the session name offset.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Turn on providers using EnableTrace | EnableTraceEx | EnableTraceEx2 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To enable the providers whom you want to allow recording events in your session, call the EnableTrace function to enable classic providers, and the EnableTraceEx function to enable manifest-based providers. In other cases - EnableTraceEx2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Before stopping the trace session, you must disable providers using EnableTrace | EnableTraceEx | EnableTraceEx2 by passing EVENT_CONTROL_CODE_DISABLE_PROVIDER</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To stop the trace session after collecting events, call the ControlTrace function and pass EVENT_TRACE_CONTROL_STOP as the control code. To specify a session to stop, you can pass the event trace session descriptor obtained from an earlier call to the StartTrace function, or the name of a previously started session. Be sure to disconnect all providers before stopping the session. If you stop the session before turning off the provider for the first time, ETW will disconnect the provider and try to call the provider callback control function. If the application that started the session terminates without disconnecting the provider or calling the ControlTrace function, the provider remains turned on. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) To stop the trace session, call the ControlTrace function and pass it EVENT_TRACE_CONTROL_STOP</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we saw in the example above, using the Event Tracing API is not the easiest. </font><font style="vertical-align: inherit;">Depending on what you do, you can continue to write events providers or write event consumers. </font><font style="vertical-align: inherit;">However, both of these tasks are quite voluminous and will not be considered in this article! </font><font style="vertical-align: inherit;">Additional complexity is created by 4 types of event providers, and, accordingly, 4 options for writing events and 4 options for their consumption. </font><font style="vertical-align: inherit;">The work with the Event Tracing API is described in great detail and well on the official Microsoft Website </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using Event Tracing</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After working for some time with the Event Tracing API, I had a question: are there any utilities that will simplify my life?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using tracerpt and xperf to work with ETW</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this chapter, I will not consider these utilities from a theoretical point of view. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can use the Tracerpt command to analyze event trace logs, log files generated by the performance monitor, and real-time event trace providers. </font><font style="vertical-align: inherit;">It creates dump files, report files, and report schemas. </font><font style="vertical-align: inherit;">This utility has a large number of parameters, but the following "minimum" is suitable for starting work</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">" 1- .etl"</span> ... <span class="hljs-string">" n- .etl"</span> -o &lt;   &gt; -report &lt;    &gt; -summary&lt;    &gt; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The xperf.exe utility is a full-fledged controller. </font><font style="vertical-align: inherit;">It supports command line arguments for managing ETW providers and sessions. </font><font style="vertical-align: inherit;">Controllers can request the status of currently active sessions and receive lists of all providers registered in the system. </font><font style="vertical-align: inherit;">For example, to get all active sessions, use the following command:</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and to get a list of all providers registered in the system, use the command:</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Controllers have a few more key features. </font><font style="vertical-align: inherit;">They can update sessions and flush buffers to disk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all for now! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, in this article I did not address a number of interesting issues (for example, the consumption of events in real time or working with special-purpose sessions). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can read about it on the following sites: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Tracing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - official Microsoft documentation. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We study ETW and extract the benefits of </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Tracing for Windows on the evil side. </font><font style="vertical-align: inherit;">But this is not exactly the </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">worst API ever created</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502350/index.html">Reverse engineering the sound amplifier of a popular portable console - discussing the main findings</a></li>
<li><a href="../en502352/index.html">The digest of interesting materials for the mobile developer # 344 (May 12 - 17)</a></li>
<li><a href="../en502354/index.html">IaaS providers are fighting for the European market - discussing the situation and industry events</a></li>
<li><a href="../en502358/index.html">Implementation of MVP based on ApplicationController and IoC in a WinForms application</a></li>
<li><a href="../en502360/index.html">Grizzly Discharges or Super Drill</a></li>
<li><a href="../en502366/index.html">Compare the work of open source Python - libraries for the recognition of named entities</a></li>
<li><a href="../en502368/index.html">We pump the treadmill</a></li>
<li><a href="../en502370/index.html">Putting the game "Snake" on the breadboard. Part 1: state machines</a></li>
<li><a href="../en502372/index.html">Problems and principles of customization of the boxed version of Bitrix24</a></li>
<li><a href="../en502374/index.html">FT8 Communication Protocol - How It Works</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>