<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçü§ù‚Äçüë®üèø üõåüèæ üôåüèø Sensor de posi√ß√£o do interruptor da luz de emerg√™ncia üë®üèª‚ÄçüöÄ ü§õüèø üë®‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antes de todos que projetam um sistema aut√¥nomo de ilumina√ß√£o de emerg√™ncia, mais cedo ou mais tarde, surge o problema de ligar e desligar as luzes de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sensor de posi√ß√£o do interruptor da luz de emerg√™ncia</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492808/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de todos que projetam um sistema aut√¥nomo de ilumina√ß√£o de emerg√™ncia, mais cedo ou mais tarde, surge o problema de ligar e desligar as luzes de emerg√™ncia. </font><font style="vertical-align: inherit;">Como fazer isso da maneira mais conveniente e transparente, para n√£o estragar o design dos quartos com interruptores adicionais?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f4/90/kp/f490kpxmliwuhfpeeuf-lhmjhou.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma das solu√ß√µes sob o corte.</font></font><br>
<a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No mundo moderno, muitas coisas est√£o ligadas √† fonte de alimenta√ß√£o ininterrupta. A maioria dos tipos de atividade intelectual j√° √© inconceb√≠vel sem um computador e comunica√ß√µes operando 24 horas por dia, 7 dias por semana. Isso n√£o √© bom nem ruim, e voc√™ precisa viver com isso. Especialmente se o seu local de trabalho n√£o estiver em um escrit√≥rio moderno, repleto de UPS e geradores a diesel de reserva, mas em um apartamento de um pr√©dio residencial comum. E aconteceu que a confiabilidade do suprimento energ√©tico de moradias na maioria das cidades da ex-URSS deixa muito a desejar. Como resultado, o fio que conecta a tomada dom√©stica e a central el√©trica mais pr√≥xima tem o p√©ssimo h√°bito de quebrar periodicamente. Quando uma vez a cada seis meses, e quando e tr√™s vezes ao dia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â por isso que, ao iniciar os reparos em um novo apartamento, eu inicialmente coloquei a fia√ß√£o paralela no projeto para fornecimento ininterrupto de energia e ilumina√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu gostaria muito de ter √† minha disposi√ß√£o um gerador poderoso com o ICE, capaz de fornecer energia normal a todo o apartamento, mas tive que abandonar essa id√©ia. Em uma casa particular, a quest√£o n√£o teria sido levantada, mas um apartamento √© outro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro problema √© a remo√ß√£o dos gases de escape, que n√£o s√£o absolutamente suficientes para colocar no apartamento de uma casa com aquecimento central. Bem, voc√™ n√£o jogar√° fora a mangueira do lado de fora da janela, onde a fuma√ßa √© instantaneamente sugada pela janela do vizinho aberto mais pr√≥ximo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo problema √© o ru√≠do. Sim, os geradores modernos de quatro tempos do inversor, quando voc√™ os ouve na rua, podem parecer muito silenciosos. E se voc√™ pendurar um silenciador adicional, ficar√° completamente silencioso. Mas acredite em mim, em um ambiente desenergizado, o que significa um pr√©dio de apartamentos completamente silencioso, mesmo um estrondo t√£o silencioso ser√° perfeitamente aud√≠vel para todos os vizinhos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em suma, a id√©ia com o gerador morreu, t√£o claramente e n√£o nasceu. Das restantes op√ß√µes reais, apenas as pilhas permaneciam.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, permito-me uma narrativa simples de minhas prova√ß√µes emocionais e das decis√µes tomadas na primeira pessoa sem nenhuma pretens√£o √† verdade universal. </font><font style="vertical-align: inherit;">E imediatamente aviso que meus argumentos para algu√©m podem parecer pouco convincentes e que as decis√µes tomadas s√£o controversas. </font><font style="vertical-align: inherit;">Mas, no entanto, tudo o que √© descrito aqui √© atualmente implementado em hardware e executa as tarefas com √™xito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E se algu√©m estiver interessado no lado puramente pr√°tico da quest√£o e n√£o importa como cheguei a essa vida, ele pode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pular muitas cartas e ir direto para a descri√ß√£o da solu√ß√£o pronta.</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brevemente sobre como escolher o tipo de bateria</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E embora essa edi√ß√£o n√£o tenha nada a ver com o t√≥pico do artigo, eu gostaria de inserir aqui tamb√©m meus cinco centavos. Al√©m disso, que inevitavelmente surgem em tais declara√ß√µes discuss√µes muitas vezes carrega um monte </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de lulz</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> informa√ß√µes √∫teis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, no s√©culo do r√°pido desenvolvimento da energia alternativa, come√ßaram a surgir sistemas ininterruptos de fornecimento de energia fabricados industrialmente relativamente acess√≠veis para o lar, combinados com mini-usinas solares ou e√≥licas. Os mais avan√ßados deles usam baterias de √≠on de l√≠tio com um monte de "aprimoradores" eletr√¥nicos da efic√°cia de todo o sistema.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No meu caso, n√£o se pode falar em nenhuma mini-usina por motivos objetivos, e apenas a fonte de backup, renov√°vel a partir de uma tomada comum durante a "ilumina√ß√£o", foi interessante. Portanto, foi decidido cultivar coletivamente todo o material eletr√¥nico do apartamento UPS por conta pr√≥pria. E como minhas m√£os estavam completamente desamarradas, a primeira coisa que precisava ser decidida foi que tipo de bateria usar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo, pensei assim: ‚ÄúPor que n√£o o l√≠tio? </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juventude na moda elegante</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Selado, energeticamente eficiente, dur√°vel ". Mas quando olhei para os pre√ßos, meu fervor de l√≠tio diminuiu visivelmente. Uma pesquisa r√°pida em combina√ß√£o com a aritm√©tica escolar mostrou que mesmo 26650 bancos chineses "muito burros" com (√© claro) os mais honestos 5000 mAH custar√£o cinco vezes mais do que uma bateria √°cida da mesma intensidade energ√©tica. E se voc√™ escolher algo que n√£o esteja na parte inferior do pre√ßo classificado por pre√ßo, a diferen√ßa chegar√° facilmente de 8 a 10 vezes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E como voc√™ pode compensar uma diferen√ßa t√£o grande em valor? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, o l√≠tio armazena energia de forma mais eficiente a cada quilograma e metro c√∫bico, e uma bateria do tamanho de um bloco de cigarro dedica facilmente uma bateria de 10 kg de √°cido-chumbo. Mas esse fato √© t√£o importante para o uso estacion√°rio?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Claro, um bom "l√≠tio", mas com a abordagem correta, durar√° mais tempo. Mas dez vezes? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, do outro lado da balan√ßa, a potencial explos√£o de baterias de origem desconhecida, um algoritmo de carregamento mais complexo, problemas de descarte (todo sem-teto sabe onde usar uma bateria de chumbo para obter lucro, enquanto o l√≠tio √© muito mais complicado). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em resumo, pela soma dos fatores, decidi adiar a id√©ia de l√≠tio at√© a pr√≥xima itera√ß√£o. Talvez daqui a alguns anos algo mude, mas, por enquanto, o chumbo √© o nosso tudo.</font></font><br>
<br>
<blockquote>,      ,        .    ,    ,           ,           .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quanto √†s baterias de chumbo, tamb√©m existem v√°rias op√ß√µes. A op√ß√£o "certa" s√£o as baterias de reserva especializadas, usadas no no-break, nas esta√ß√µes de base celulares e em outros locais semelhantes onde √© necess√°rio que sejam capazes de receber e fornecer grandes correntes, ocasionalmente sofrer uma descarga forte e, de fato, trabalhar sem distrair as pessoas. a servi√ßo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra op√ß√£o "certa" s√£o as baterias de tra√ß√£o para carregadeiras el√©tricas ou, o que diabos, um submarino a diesel. Essas baterias t√™m alta durabilidade e boa toler√¢ncia a descargas profundas, sem tirar do propriet√°rio a oportunidade de "encher um pouco de √°gua".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, a op√ß√£o "errada" √© a bateria inicial da loja de carros mais pr√≥xima. Uma bateria assim pode ceder brevemente um quilowatt de energia √† montanha, mas qualquer descarga √© estressante para ela, como o trabalho para uma pessoa pregui√ßosa. E a gl√≥ria das baterias descart√°veis ‚Äã‚Äãest√° geralmente enraizada nas modernas baterias de c√°lcio: "descarregadas - troque".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, espero que ningu√©m duvide de qual op√ß√£o eu finalmente selecionei para implementa√ß√£o? Certo, terceiro. E as raz√µes aqui est√£o n√£o apenas no conhecido anf√≠bio verruga, mas tamb√©m em um c√°lculo pragm√°tico simples. As baterias iniciais s√£o v√°rias vezes mais baratas que todas as outras op√ß√µes, √†s vezes se aproximando do l√≠tio. E, em vez de sacudir uma bateria cara, voc√™ se sente muito mais livre em uma situa√ß√£o de indiferen√ßa saud√°vel, quando a substitui√ß√£o resulta em perdas na quantidade de comida consumida por algumas semanas. Al√©m disso, se voc√™ n√£o deixar essas baterias esgotarem antes de perder o pulso, a vida √∫til delas no papel de backups √© calculada por muitos anos. Voc√™ sempre pode colocar uma bateria com uma capacidade maior, ajustar o limite de descarga mais suavemente e ainda obter uma melhor rela√ß√£o pre√ßo / capacidade do que a bateria ‚Äúcerta‚Äù,sofrendo uma descarga profunda.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O principal nesta quest√£o √© fornecer ventila√ß√£o pelo menos no n√≠vel do ‚Äúorif√≠cio na parede‚Äù no local de instala√ß√£o das baterias. </font><font style="vertical-align: inherit;">Bem, organize a prote√ß√£o banal contra curtos-circuitos, porque a baixa tens√£o da fonte de corrente diminui a vigil√¢ncia e tudo pode terminar muito mal.</font></font><br>
<br>
<h3><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guerra atual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em um √∫nico apartamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s alguma garantia moral causada pela decis√£o final sobre o tipo de bateria, um novo motivo apareceu imediatamente para pensar com cuidado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deixe-me lembr√°-lo que, inicialmente, eu queria um gerador de corrente alternada de 230 V. No entanto, depois de me reconciliar com a realidade objetiva e mudar mentalmente para as baterias, a in√©rcia do pensamento j√° me levou ao conhecido mercado on-line chin√™s para escolher um conversor CC / CA adequado. E, no processo de estudar as caracter√≠sticas, o termo ‚Äúonda senoidal modificada‚Äù, que foi esquecida, surgiu primeiro e depois o senso comum come√ßou a levantar quest√µes desconfort√°veis.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ess√™ncia das perguntas foi a seguinte. Para cobrir todas as necessidades de energia do apartamento com uma bateria pequena, ainda n√£o funcionar√°. Caldeiras, microondas, m√°quina de lavar, um poderoso computador de mesa ainda ser√£o insuport√°veis ‚Äã‚Äãem termos de energia. E a geladeira, o cap√¥ e at√© o ventilador banal n√£o funcionar√£o adequadamente por causa dessa onda senoidal muito modificada. Obviamente, existem inversores com uma verdadeira onda senoidal, mas eles n√£o s√£o apenas mais caros, mas tamb√©m menos eficientes. E a quest√£o dos consumidores poderosos ainda n√£o est√° resolvida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quais consumidores permanecem dentro do or√ßamento? N√£o existem muitos deles: eletr√¥nicos de consumo, como laptops e telefones / tablets, um roteador, um servidor ARM, o clima √© uma TV e, √© claro, a ilumina√ß√£o. Al√©m disso, a mensagem inicial do artigo (e minha motiva√ß√£o pessoal) √© precisamente garantir o funcionamento da esta√ß√£o de trabalho de backup na forma de um laptop e o m√≠nimo de conforto dom√©stico, como luz no banheiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quase todos esses dispositivos exigem uma tens√£o constante de 5 a 21 V para sua opera√ß√£o e n√£o h√° necessidade objetiva de aumentar primeiro a tens√£o da bateria para 230 V CA, depois abaix√°-la e endireit√°-la novamente para mais ou menos o n√≠vel inicial. Nessas transforma√ß√µes, √© f√°cil perder at√© 50% de energia, o que eu n√£o sorri.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em resumo, foi assim que surgiu a ideia de usar uma rede de corrente cont√≠nua de baixa tens√£o como alternativa. </font><font style="vertical-align: inherit;">E ap√≥s um c√°lculo aproximado das perdas nos fios, os 12 (13,8) V iniciais se transformaram em 24 (27,6) V. mais pr√°ticos</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No come√ßo, eu queria tirar at√© 36 (41,4) B, mas depois de estudar as caracter√≠sticas de alguns componentes eletr√¥nicos que planejava usar para trabalhar com toda essa economia, tive que moderar meu apetite.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, em uma fia√ß√£o alternativa com uma se√ß√£o transversal de 3,5 mm </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 de</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cobre puro, a tens√£o foi aplicada em √∫ltima an√°lise a partir de duas baterias de carro conectadas em s√©rie.</font></font><br>
<br>
<blockquote>,        .           (   )   .                ,      .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para permitir aos consumidores nos quartos, mais uma tomada foi adicionada a cada bloco ‚Äúgrande‚Äù de tomadas. E para que ningu√©m confundisse uma tomada comum com uma de reserva, os produtos do tipo "americano" com contatos planos de diferentes larguras foram instalados como o √∫ltimo. Isso, em primeiro lugar, n√£o permitir√° que o aspirador seja conectado √† rede DC e, em segundo lugar, uma tomada diferente da europ√©ia, sempre usa a mesma polaridade ao usar o plugue ‚Äúcorreto‚Äù.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bl/sm/th/blsmthnmtxqcekbdftv8dfg3u2a.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para essas tomadas, foram feitos adaptadores para laptop, diminuindo a tens√£o para os 18-20 V desejados e equipados com os conectores correspondentes. </font><font style="vertical-align: inherit;">√â claro que os saltos foram feitos com as habituais cargas USB de cinco volts para cada pequena coisa. </font><font style="vertical-align: inherit;">Bem, apenas no caso, um par de pequenos conversores de 24/230 V foi comprado, com uma pot√™ncia de 50 e 200 watts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Casos para carregar com um plugue americano, os mesmos cabos de alimenta√ß√£o e placas prontas de conversores de pulso foram encomendados da China. </font><font style="vertical-align: inherit;">Um ferro de solda era necess√°rio apenas para conectar os fios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o falarei sobre a usina neste artigo, especialmente porque n√£o h√° nada de interessante, ent√£o irei direto a um dos problemas "inferiores", a saber, a quest√£o da utiliza√ß√£o da energia acumulada pela bateria para fins de ilumina√ß√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ilumina√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, ao conectar o apartamento em paralelo √† fia√ß√£o principal, foram desenhados fios de uma rede CC alternativa com tens√£o de 24 (27,6) V. Entre outras coisas, um la√ßo consistindo em um par desses fios foi enrolado em cada caixa de comuta√ß√£o e, em seguida, juntamente com os fios da rede de 230 V levou √†s luzes do teto (se houvesse v√°rias na sala, o fio alternativo levaria a apenas uma).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que fazer com a sa√≠da da rede DC no campo da l√¢mpada √© uma quest√£o de abordagem individual. Como fonte de luz, uma faixa regular de LED de 24 volts foi escolhida. Seus segmentos de diferentes comprimentos (na propor√ß√£o da √°rea da sala), dependendo do design dos acess√≥rios, eram montados diretamente em suas caixas ou colados nas superf√≠cies das quais brilhava bem e de onde n√£o seria muito impressionante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De qualquer forma, isso √© um problema mais est√©tico do que t√©cnico, e agora √© outra coisa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, na caixa de cada comutador, tenho um loop de um fio de fase de uma rede de 230 V para ligar a luz "comum" e um loop de ambos os fios de uma rede DC para ilumina√ß√£o de emerg√™ncia. Disto e dance.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final, o desafio diante de mim era criar um determinado dispositivo que pudesse separar tr√™s estados um do outro:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rede el√©trica OK ‚Üí apague as luzes de emerg√™ncia.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A rede CA est√° desenergizada, os contatos do interruptor est√£o fechados ‚Üí acenda a luz de emerg√™ncia. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A rede CA est√° desenergizada, os contatos do interruptor est√£o abertos ‚Üí apague a luz de emerg√™ncia.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consideramos que as a√ß√µes s√£o unilaterais, ou seja, desligar a ilumina√ß√£o j√° desligada n√£o muda nada. </font><font style="vertical-align: inherit;">Esses estados podem ser diferenciados entre si se as tarefas de determinar a opera√ß√£o da rede CA e a posi√ß√£o dos contatos do comutador forem resolvidas. </font><font style="vertical-align: inherit;">Ao mesmo tempo, tive as seguintes condi√ß√µes iniciais:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O gerenciamento da ilumina√ß√£o principal e da ilumina√ß√£o de emerg√™ncia deve ser completamente transparente a partir de um √≥rg√£o diretivo, sem ‚Äúfazenda coletiva‚Äù dos bot√µes adicionais.</font></font></li>
<li> ,  ,   ,        .</li>
<li>      ,        .</li>
<li>      ‚Äì    ,  .</li>
<li>-        .</li>
<li>        (    ),  .</li>
<li>      .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, a aus√™ncia de rede el√©trica CA nas caixas zero acabou sendo um erro de c√°lculo muito complicado do projeto. </font><font style="vertical-align: inherit;">Sem ele, a determina√ß√£o da presen√ßa de tens√£o na entrada do comutador se torna imposs√≠vel. </font><font style="vertical-align: inherit;">Tecnicamente, seria poss√≠vel usar o fio negativo de uma rede de corrente cont√≠nua como zero, mas isso contradiz o par√°grafo 5 completamente indestrut√≠vel dos meus termos de refer√™ncia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, existe uma alternativa para medir a tens√£o da rede. N√£o √© necess√°rio determinar a presen√ßa de tens√£o, basta determinar a presen√ßa de corrente no fio da fase com os contatos do interruptor fechados. Afinal, se houver corrente, haver√° tens√£o. Al√©m disso, a ‚Äúleitura‚Äù exata da corrente permite que a ilumina√ß√£o de emerg√™ncia seja ativada n√£o apenas no caso de falta de energia, mas tamb√©m no caso de queima de l√¢mpadas banais. Este m√©todo n√£o permite determinar o estado da rede CA quando o comutador est√° desligado, mas esse estado n√£o me incomoda, porque Quando o interruptor √© desligado, a ilumina√ß√£o de emerg√™ncia tamb√©m n√£o deve funcionar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Determinar a presen√ßa de corrente no fio √© bastante simples, especialmente se essa corrente estiver alternada. </font><font style="vertical-align: inherit;">Aqui voc√™ pode aplicar, por exemplo, um sensor Hall que detecta o campo magn√©tico ao redor do fio. </font><font style="vertical-align: inherit;">Mas voc√™ pode conviver com um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transformador de corrente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comum </font><font style="vertical-align: inherit;">, que consiste em um circuito magn√©tico de anel com um enrolamento. </font><font style="vertical-align: inherit;">Um fio de corrente alternada √© passado atrav√©s do anel, o que cria um campo magn√©tico no circuito magn√©tico. </font><font style="vertical-align: inherit;">Este campo, por sua vez, induz uma corrente secund√°ria no enrolamento, proporcional √† corrente prim√°ria no fio. </font><font style="vertical-align: inherit;">Assim, este dispositivo simples permite medir a for√ßa da corrente alternada em qualquer fio, sem quebr√°-lo e geralmente sem nenhuma conex√£o galv√¢nica com o circuito prim√°rio.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O trabalho das pin√ßas de corrente, uma ferramenta muito √∫til para qualquer eletricista, baseia-se no mesmo princ√≠pio.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se houver um transformador pr√≥ximo ao comutador, basta medir a tens√£o em seu enrolamento secund√°rio para descobrir se alguma corrente est√° fluindo no circuito da l√¢mpada. A presen√ßa de corrente, como eu disse, em uma primeira aproxima√ß√£o indica dois fatos: existe uma tens√£o na rede 230 V e o comutador est√° fechado. O primeiro desses fatos √© essencial para a opera√ß√£o do dispositivo de ativa√ß√£o da ilumina√ß√£o de emerg√™ncia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo "par√¢metro de entrada" do meu futuro dispositivo deve ser a posi√ß√£o dos contatos do comutador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ‚Äúbrainstorming‚Äù iniciado entre colegas de hobby trouxe v√°rias op√ß√µes para determinar a posi√ß√£o do comutador, que se resumia principalmente √† modifica√ß√£o do design, a fim de adicionar outro par de contatos a ele. Aqui o escopo da imagina√ß√£o √© bastante amplo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era poss√≠vel pegar um duplo em vez de um √∫nico interruptor e "paralelizar" mecanicamente suas metades para que elas se tornassem um todo. Essa op√ß√£o n√£o diferia na est√©tica externa e n√£o solucionava o problema naquelas salas em que a ilumina√ß√£o era de circuito duplo e o interruptor era duplo inicialmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outras op√ß√µes envolviam a introdu√ß√£o de um microinterruptor ou um interruptor reed com um √≠m√£ no mecanismo do comutador. Mas, depois de estudar os projetos dos disjuntores aplicados, essas op√ß√µes tamb√©m desapareceram. A base de cer√¢mica monol√≠tica de um bom comutador simplesmente n√£o deixa chance, mesmo para um microinterruptor compacto, e o √≠m√£ e a palheta n√£o funcionavam devido ao toque muito pequeno da tecla e √† histerese na curva de opera√ß√£o / libera√ß√£o do comutador de palheta.</font></font><br>
<br>
<blockquote> ¬´¬ª        ,     . , ,       ,  .  ,   ,    ,               .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em resumo, era necess√°rio criar um m√©todo que n√£o exigisse modifica√ß√£o do comutador. E este m√©todo foi encontrado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descrevi acima um transformador de corrente, que permite determinar a presen√ßa de corrente alternada em um fio sem ruptura e contato galv√¢nico. Mas qualquer transformador √© um dispositivo bidirecional (em contraste com o mesmo sensor Hall), seus enrolamentos prim√°rio e secund√°rio s√£o intercambi√°veis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se aplicarmos corrente alternada ao enrolamento secund√°rio de um transformador, ele induzir√° tens√£o nas extremidades do fio rosqueado no anel. E, o mais importante, a energia consumida pelo enrolamento da fonte depender√° de a corrente secund√°ria no fio encontrar seu caminho para o movimento circular.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E aqui fica mais interessante. </font><font style="vertical-align: inherit;">Um fio passa atrav√©s do anel, que √© imediatamente, em alguns cent√≠metros, conectado a um dos contatos do comutador. </font><font style="vertical-align: inherit;">Resta apenas fornecer a essa corrente um caminho de retorno do outro lado do comutador para obter um dispositivo para "detectar" a posi√ß√£o dos contatos. </font><font style="vertical-align: inherit;">E pela raz√£o de que essa corrente √© alternada, um capacitor convencional pode se tornar uma ponte para ela.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gs/tr/g1/gstrg12mwdwhgu0qmbnl3twrfjc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em princ√≠pio, para fechar este circuito sob certas condi√ß√µes, um capacitor n√£o √© necess√°rio. </font><font style="vertical-align: inherit;">Se uma corrente de frequ√™ncia suficientemente alta for "bombeada" para o transformador, a capacit√¢ncia perdida entre os fios ser√° suficiente para passar.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/up/yp/ws/upypwscprb9xjbrlaye26xfkry8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, o que √© necess√°rio para organizar esse detector:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transformador de corrente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Medidor de tens√£o de sa√≠da do transformador.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonte de corrente alternada de alta frequ√™ncia.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Medidor de corrente que flui atrav√©s do enrolamento de um transformador invertido.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mais dif√≠cil em termos de sele√ß√£o dos par√¢metros ideais √© um transformador, que no modo transformador de corrente deve fornecer uma tens√£o aceit√°vel com uma frequ√™ncia de 50 Hz e, no modo ativo de "detec√ß√£o" do estado do disjuntor, ter um coeficiente de transmiss√£o aceit√°vel a uma frequ√™ncia de centenas de KHz. </font><font style="vertical-align: inherit;">N√£o √© poss√≠vel simular esse elemento em um programa de modelagem de circuitos eletr√¥nicos, e mesmo com o c√°lculo matem√°tico tudo se tornou muito dif√≠cil. </font><font style="vertical-align: inherit;">Eu tive que pegar um ferro de soldar nas m√£os e passar horas dirigindo v√°rias op√ß√µes em busca dos melhores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O n√∫mero de voltas e a resist√™ncia ideal √† carga foram selecionados empiricamente e n√£o o fato de eu n√£o ter perdido a melhor rela√ß√£o. </font><font style="vertical-align: inherit;">Como resultado das experi√™ncias, a seguinte constru√ß√£o apareceu:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√∫cleo de ferrite com uma permeabilidade de 10.000, tamanho 10x6x4 mm.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enrolamento 30 voltas com fio esmaltado de 0,25 mm.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A carga ativa do enrolamento √© de 1 kOhm.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A permeabilidade magn√©tica √© bastante grande, provavelmente, faria sentido usar um anel para 5000 ou at√© 2000 unidades, mas em quantidades suficientes eu tinha esses an√©is. </font><font style="vertical-align: inherit;">Em geral, a permeabilidade nesse caso √© um valor de compromisso. </font><font style="vertical-align: inherit;">Muito baixo torna o transformador inadequado para opera√ß√£o a uma frequ√™ncia de 50 Hz e muito alto estraga tudo em frequ√™ncias acima de centenas de quilohertz. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
V√°rios experimentos confirmaram a realidade da ideia e os seguintes resultados foram obtidos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No modo de transformador de corrente, o coeficiente de transmiss√£o acabou por ser de cerca de um milivolt por watt de pot√™ncia de fluxo (tens√£o 220-230 V).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No modo apalpador, dependendo da frequ√™ncia e capacit√¢ncia do vazamento, a diferen√ßa de corrente nos contatos fechados e abertos do comutador alcan√ßou duas a tr√™s vezes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© tudo. </font><font style="vertical-align: inherit;">Ambos os valores s√£o mais que suficientes para uma fixa√ß√£o confi√°vel da corrente de fluxo e para determinar a posi√ß√£o dos contatos do interruptor. </font><font style="vertical-align: inherit;">Depende apenas da implementa√ß√£o espec√≠fica.</font></font><br>
<br>
<a name="Solution"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em ferro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao contr√°rio da maioria de seus outros projetos, aqui j√° nos est√°gios iniciais da delibera√ß√£o, foi decidido usar imediatamente o microcontrolador. </font><font style="vertical-align: inherit;">Com base nas necessidades e na experi√™ncia, a escolha recaiu sobre o ATtiny13A. </font><font style="vertical-align: inherit;">Este chip possui um ADC e pode usar uma fonte de refer√™ncia interna de 1,1 V em vez da tens√£o de alimenta√ß√£o. </font><font style="vertical-align: inherit;">Existe um PWM √≥timo para gerar um sinal sonoro. </font><font style="vertical-align: inherit;">E, que mais tarde se mostrou importante, existe uma EEPROM que permite armazenar dados de calibra√ß√£o.</font></font><br>
<br>
<blockquote>,          ¬´  ,       ,       - ¬´¬ª ,  ¬ª.<br>
<br>
      .         .           .   ,   ,  ,         .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui voc√™ precisa combinar pelo menos um gerador, um medidor de tens√£o e algum tipo de gatilho para armazenar o estado atual entre as medi√ß√µes. Em geral, qualquer esbo√ßo especulativo exigia pelo menos tr√™s casos apenas no "n√∫cleo", e o controlador era muito mais pr√°tico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tens√£o do transformador de corrente com uma carga de 10 a 20 W √© de 10 a 20 mV e √© muito pequena para fornec√™-la √† entrada DAC com um limite de 1,1 V. Portanto, al√©m do controlador, voc√™ tamb√©m precisa de um amplificador com um coeficiente de transfer√™ncia de cerca de 100 para aumentar a tens√£o de sinal m√≠nima. at√© centenas de milivolts.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, a tens√£o do sinal de sa√≠da de um transformador de corrente depende n√£o apenas da pot√™ncia da carga, mas tamb√©m de sua natureza. </font><font style="vertical-align: inherit;">Uma carga puramente ativa, como a l√¢mpada de Ilyich, por exemplo, produz uma onda senoidal de n√≠vel de milivolt. </font><font style="vertical-align: inherit;">Uma l√¢mpada LED da mesma pot√™ncia, com uma simples pulsa√ß√£o, produz rajadas curtas a volts e acima. </font><font style="vertical-align: inherit;">Poder√≠amos brincar disso, mas, primeiro, eu queria fazer um dispositivo universal e, em segundo lugar, no apartamento havia uma l√¢mpada com uma fonte de alimenta√ß√£o externa equipada com um circuito PFC (ou seja, com uma caracter√≠stica de consumo pr√≥xima a ativa).</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o atormentarei o leitor com op√ß√µes intermedi√°rias e darei imediatamente o diagrama final do dispositivo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vd/at/a-/vdata-spt78rd_pzv7s5awoobya.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, a tens√£o CC atrav√©s do regulador linear econ√¥mico LM2931-5.0 alimenta o controlador. Em termos de alojamento, funcionalidade e pinagem, esse estabilizador √© semelhante ao popular 78L05, mas difere dele em menor consumo intr√≠nseco (cerca de 500 ŒºA a uma carga de 10 mA) e maior toler√¢ncia a rajadas curtas de tens√£o de entrada. Se voc√™ planeja trabalhar com uma tens√£o n√£o superior a 20 V, pode usar um an√°logo ainda mais econ√¥mico do LP2950-5.0.</font></font><br>
<br>
<blockquote>   LP2950-5.0        30 .      24      .    -      ,     ,       ,     ,   .          50%,   100%.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O transformador n√£o √© mostrado no diagrama, mas seu enrolamento est√° conectado aos pinos TR1 e TR2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como elemento chave para alternar a carga, √© usado um transistor MOS de canal P de baixa corrente 2SJ196 (uma corrente de at√© 1 A deve ser suficiente para qualquer l√¢mpada de LED), mas qualquer outro adequado para a pinagem, a corrente m√°xima e a tens√£o de drenagem m√°xima podem ser usadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m do controlador e da chave dos elementos ativos, dois transistores s√£o usados. Um √© necess√°rio para controlar o obturador da chave, operando sob a tens√£o da fonte de emerg√™ncia. O segundo atua como um sinal de amplificador da sa√≠da do transformador de corrente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse ponto, voc√™ poderia usar amplificadores operacionais, mas em termos de detalhes o ganho era m√≠nimo e voc√™ teria que esquecer de trabalhar em frequ√™ncias acima de v√°rias centenas de quilohertz.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o √© o sinal amplificado do pr√≥prio transformador que √© alimentado ao ADC, mas seu envelope, que pode ser medido por uma √∫nica amostra e n√£o por "streaming" da digitaliza√ß√£o por algum tempo. Para isolar o envelope, s√£o utilizados dois diodos Schottky, conectados de acordo com o circuito de duplica√ß√£o de tens√£o. Essa inclus√£o forma um detector de amplitude cl√°ssico, no qual a queda de tens√£o nos pr√≥prios diodos √© amplamente compensada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O princ√≠pio de opera√ß√£o do sensor √© simples. Primeiro, considere o algoritmo de a√ß√µes necess√°rias para medir a corrente no fio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No modo de medi√ß√£o atual, o pino PB0 √© colocado no modo de sa√≠da e √© aterrado por um zero l√≥gico. Isso evita que quaisquer sinais do controlador sejam enviados para o ponto TR1. Em paralelo, as mesmas a√ß√µes s√£o realizadas no pino PB3, como resultado do qual a sa√≠da superior do capacitor C2 √© aterrada. Esse capacitor, juntamente com o resistor R1, cria um filtro passa-baixo com uma frequ√™ncia de corte de cerca de 1500 Hz. Gra√ßas a esse filtro, o papel de v√°rios ru√≠dos de alta frequ√™ncia na forma√ß√£o do sinal medido √© bastante reduzido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, um n√≠vel alto √© aplicado ao PB4 para alimentar o amplificador de sinal. Ap√≥s a conclus√£o dos transientes, uma corrente de 50 Hz da sa√≠da do transformador √© amplificada e chega ao retificador, onde carrega o capacitor C8.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A carga do capacitor C8 √© medida usando ADC1 e, a partir do valor de tens√£o obtido, √© tirada uma conclus√£o sobre a corrente ‚Äúprim√°ria‚Äù que flui atrav√©s do transformador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A detec√ß√£o ativa √© realizada de maneira diferente. Primeiro, o pino PB0 √© convertido em um solucionador de PWM e um sinal √© alimentado com uma frequ√™ncia de centenas de quilohertz para unidades de megahertz. Este sinal √© um pouco atenuado por um divisor resistivo e alimentado ao enrolamento do transformador de corrente no ponto TR1. O capacitor C1, junto com um bra√ßo do divisor R4, cria um filtro passa-baixo com uma frequ√™ncia de corte de cerca de 1,5 MHz, o que reduz o n√≠vel de harm√¥nicos de alta frequ√™ncia de pulsos retangulares.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de passar pelo enrolamento do transformador, o sinal da sonda do ponto TR2 chega ao mesmo amplificador e detector, da mesma forma, no final, carrega o capacitor C8 a uma tens√£o proporcional √† carga no circuito "externo" do transformador. Da mesma forma, a carga do capacitor √© medida usando o ADC do microcontrolador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora explica√ß√µes para alguns "soltos". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O resistor R5 √© projetado para limitar a tens√£o no port√£o do interruptor de energia, que para MOSFETs de baixa tens√£o geralmente n√£o deve exceder 20 V. No meu caso, a rede DC tem uma tens√£o de at√© 30 V, o que determinou a necessidade de um divisor 1: 3, obtido em conjunto com R3. Quando alimentado por uma fonte inferior a 20 V, o resistor R5 n√£o √© necess√°rio (substitu√≠do por um jumper).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os capacitores C4 e C5 s√£o conectados em paralelo para obter uma capacit√¢ncia de 2 ŒºF. Este par de capacitores √© digno de nota, pois deve transmitir igualmente bem os sinais das frequ√™ncias baixa e alta. Aqui seria poss√≠vel usar uma conex√£o paralela de um capacitor eletrol√≠tico de v√°rias microfarads e uma cer√¢mica de cem ou duas nanofarads, mas um "eletr√≥lito" de capacidade t√£o pequena n√£o gera ganho de tamanho quando comparado com a "cer√¢mica" de microfarads. √â verdade que n√£o era poss√≠vel comprar um capacitor de cer√¢mica em duas microfarads, ent√£o coloquei duas da mesma.</font></font><br>
<br>
<blockquote>,   50     2  ,      .   ,        .               .    100   , ,   .       .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os resistores R4 e R1 formam uma divis√£o de tens√£o, que iguala mais ou menos a tens√£o alternada de cinco volts na sa√≠da PWM com a tens√£o de sa√≠da do transformador de corrente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O capacitor C8, como mencionado anteriormente, acumula a tens√£o a ser medida. √â melhor se for um capacitor de alta qualidade com uma corrente de fuga m√≠nima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Men√ß√£o especial merece o ‚Äúpente‚Äù TP1 / TP2 de dois pinos conectado √† perna de reset do microcontrolador. Esses contatos s√£o usados ‚Äã‚Äãn√£o apenas para reiniciar, mas para entrar no modo de calibra√ß√£o, descrito abaixo. Simplesmente, ap√≥s a implementa√ß√£o de toda a lista de desejos, o controlador n√£o tinha mais pinos livres e a necessidade de adicionar um controle simples apareceu durante a depura√ß√£o do firmware. Ent√£o eu tive que usar o p√© de reset do controlador para esse fim.</font></font><br>
<br>
<blockquote> ¬´¬ª  AVR     RESET       GPIO.         ,       .         ,        .   ,        ,      ,      ,            RESET.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o circuito acabou sendo bastante simples e toda a "m√°gica" √© implementada no firmware do microcontrolador. No entanto, ap√≥s a fabrica√ß√£o do prot√≥tipo, descobriu-se que a capacit√¢ncia da fia√ß√£o para opera√ß√£o confi√°vel da "sonda" geralmente n√£o √© suficiente. A diferen√ßa de corrente atrav√©s do transformador simplesmente se compara ao n√≠vel de interfer√™ncia e a opera√ß√£o do circuito se torna n√£o confi√°vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, tive que abandonar o anel de ferrite pendurado livremente nos fios e adicionar um circuito de alta tens√£o diretamente √† placa em uma nova revis√£o do dispositivo, a fim de facilitar a tarefa de sondagem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O objetivo aqui √© adicionar um capacitor dedicado, ativado para que o caminho mais curto para fechar o caminho para a corrente de RF atrav√©s dos contatos do comutador.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/i-/_f/63/i-_f636miltufzwifkx4xaxnab0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O capacitor C10 deve ser projetado para uma tens√£o de pelo menos kilovolts, e sua capacit√¢ncia deve ser escolhida de acordo com um princ√≠pio de compromisso, para que a confiabilidade da opera√ß√£o seja suficiente para uso pr√°tico e que a corrente capacitiva perdida atrav√©s da l√¢mpada n√£o seja muito grande. </font><font style="vertical-align: inherit;">Na pr√°tica, voc√™ pode tentar "brincar" com essa denomina√ß√£o, se necess√°rio.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De qualquer forma, um interruptor equipado com esse sensor n√£o pode mais ser percebido como ideal. </font><font style="vertical-align: inherit;">Pelo contr√°rio, √© semelhante a um interruptor com um indicador; portanto, em primeiro lugar, pode causar luz dispersa ou tremula√ß√£o de l√¢mpadas LED de baixa qualidade e, em segundo lugar, pode causar um choque el√©trico, embora n√£o seja forte. </font><font style="vertical-align: inherit;">Portanto, voc√™ nunca precisa trabalhar com a fia√ß√£o de ilumina√ß√£o, contando apenas com o interruptor na parede, sempre desligue o ‚Äúinterruptor‚Äù na entrada.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, como eu ainda tinha que adicionar parte da rede CA √† placa, adicionei dois bloqueadores de fechamento l√°, o que n√£o permitir√° que a corrente de sondagem de alta frequ√™ncia passe para a fia√ß√£o. O valor pr√°tico da frequ√™ncia da tens√£o de sondagem pode atingir v√°rios MHz e eu, como radioamador, estou muito cansado da ideia de aumentar a quantidade de interfer√™ncia na rede com minhas pr√≥prias m√£os. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As bobinas L1 e L2 devem ser energizadas, enroladas com um fio de espessura percept√≠vel nos n√∫cleos do tipo haltere ou anel. Os choques de sinal no projeto axial do "resistor" n√£o podem ser usados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A volta principal do transformador de corrente agora √© um peda√ßo de fio rosqueado atrav√©s do anel e soldado aos pontos TR3 e TR4 na placa. √â melhor se esse fio estiver blindado enquanto conecta a tela ao TR5 e TR6 nos dois lados do anel.</font></font><br>
<br>
<blockquote> TR6       ,   .    -   ,           .          ,          .</blockquote><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo do firmware e o arquivo HEX montado s√£o anexados no final do artigo, juntamente com o circuito e o layout da placa de circuito impresso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O algoritmo do detector sintonizado √© simples. A cada tr√™s segundos, o controlador acorda do sono profundo, faz medi√ß√µes e, se necess√°rio, altera o estado da tecla de controle em uma dire√ß√£o ou outra. Assim, a rea√ß√£o a uma mudan√ßa na posi√ß√£o do comutador pode ter um atraso de at√© tr√™s segundos. N√£o √© muito conveniente, mas isso √© feito, em primeiro lugar, para economizar energia da fonte de backup e, em segundo lugar, para reduzir significativamente o intervalo de pesquisa, n√£o permite a dura√ß√£o dos transientes em diferentes est√°gios de medi√ß√£o. O intervalo m√≠nimo pode ser considerado igual a um segundo, mas o circuito estar√° no modo de consumo ativo quase o tempo todo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, em conclus√£o, sobre a configura√ß√£o. Devido ao fato de que diferentes sensores precisam trabalhar em condi√ß√µes completamente diferentes, de acordo com a corrente consumida pela l√¢mpada, o comprimento e outras caracter√≠sticas da fia√ß√£o, o n√≠vel de interfer√™ncia e similares, era imposs√≠vel colocar um conjunto universal de par√¢metros adaptativos no firmware. Portanto, cada sensor ap√≥s a instala√ß√£o requer uma √∫nica calibra√ß√£o no local. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sensor entra no modo de calibra√ß√£o cada vez que √© ligado, enquanto n√£o h√° dados de calibra√ß√£o ou ap√≥s o fechamento dos contatos TP1 e TP2. A entrada do primeiro est√°gio da calibra√ß√£o √© indicada por uma l√¢mpada de emerg√™ncia que pisca cinco vezes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de piscar cinco vezes, s√£o dados 7,5 segundos para colocar o interruptor na posi√ß√£o ‚Äúdesligado‚Äù, se j√° tiver sido ligado antes. Ap√≥s esse per√≠odo, o n√≠vel de interfer√™ncia sempre presente na rede CA √© medido. O valor obtido √© usado como ponto de partida para medi√ß√µes no ciclo de servi√ßo. Tamb√©m neste momento, o disjuntor √© detectado em diferentes frequ√™ncias para a sele√ß√£o subsequente da frequ√™ncia mais "contrastada".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, o segundo est√°gio de calibra√ß√£o come√ßa e a l√¢mpada de emerg√™ncia pisca duas vezes. S√£o necess√°rios 7,5 segundos para colocar o interruptor na posi√ß√£o "ligado" e, ap√≥s o tempo limite, o programa mede a corrente consumida pela l√¢mpada. Se a l√¢mpada tiver v√°rios n√≠veis de brilho, depois de ligar, voc√™ deve imediatamente mud√°-la para um m√≠nimo, para que no futuro o sensor funcione corretamente com qualquer um dos n√≠veis dispon√≠veis.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O in√≠cio do terceiro e √∫ltimo est√°gio de calibra√ß√£o √© marcado por tr√™s vezes piscando a luz de emerg√™ncia e requer que o interruptor permane√ßa no modo ‚Äúligado‚Äù e a rede de ilumina√ß√£o seja desenergizada em um n√≠vel mais alto (ou seja, com o disjuntor principal ou secund√°rio no painel) o mais tardar pelos mesmos 7,5 segundos Nesse caso, √© realizada uma segunda sonda do disjuntor j√° ativada em diferentes frequ√™ncias e, levando em considera√ß√£o os valores obtidos no primeiro est√°gio, a frequ√™ncia √© selecionada na qual a diferen√ßa de corrente atrav√©s do interruptor ligado e desligado √© m√°xima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A conclus√£o bem-sucedida da calibra√ß√£o √© indicada por um √∫nico piscar da l√¢mpada de emerg√™ncia e, se a rede de ilumina√ß√£o ap√≥s o terceiro est√°gio ainda estiver desenergizada, ligando a ilumina√ß√£o de emerg√™ncia no pr√≥ximo ciclo de opera√ß√£o de vota√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se os valores medidos de correntes e resist√™ncias em diferentes condi√ß√µes estiverem muito pr√≥ximos e n√£o puderem ser usados ‚Äã‚Äãpara uma detec√ß√£o confi√°vel, a calibra√ß√£o falhar√°. </font><font style="vertical-align: inherit;">Nesse caso, a l√¢mpada de ilumina√ß√£o de emerg√™ncia pisca duas vezes quando a posi√ß√£o do interruptor n√£o √© bem-sucedida ou tr√™s vezes quando o consumo padr√£o da l√¢mpada de ilumina√ß√£o √© muito baixo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso de falta de vontade persistente do sensor em calibrar com um piscar duplo no final, tente aumentar a capacidade do C10.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O dispositivo acabou sendo bastante simples, compacto o suficiente para caber em uma caixa de comuta√ß√£o, mas sem dizer que √© muito f√°cil de configurar. </font><font style="vertical-align: inherit;">Obviamente, ele n√£o se baseia no componente de uma "casa inteligente" moderna, porque n√£o possui 5G, controle de nuvem e at√© WiFi WiFi banal com GPS n√£o √© fornecido. </font><font style="vertical-align: inherit;">No entanto, oito desses dispositivos desempenham sua √∫nica fun√ß√£o e nada mais √© necess√°rio em condi√ß√µes de blecaute.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo fonte do firmware (Atmel Studio 7)</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> F_CPU 9600000 <span class="hljs-comment">//   (  : avrdude.exe -U lfuse:w:0x7a:m -U hfuse:w:0xff:m)</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/wdt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/sleep.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;util/delay.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/eeprom.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">//#define PROTEUS</span><font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-keyword">bool</span>; <span class="hljs-comment">//   </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> true  (0 == 0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> false (0 != 0)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_U10BIT 0b0000001111111111 <span class="hljs-comment">//      </span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INTERVAL         3   <span class="hljs-comment">//  , </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUR_MINIMAL_DIFF 50  <span class="hljs-comment">//      , LSB</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RES_MINIMAL_DIFF 50  <span class="hljs-comment">//      , LSB</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREQ_DIV_OFFSET  2   <span class="hljs-comment">//     </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREQ_MAXIMAL_DIV 6   <span class="hljs-comment">//     </span></span><font></font>
<font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>  EEPROM_cur_edge;<font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>  EEPROM_res_edge; <font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> EEPROM_frequency_dividor;<font></font>
<font></font>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur_edge, res_edge; <span class="hljs-comment">//   ,   EEPROM    </span>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> frequency_dividor; <span class="hljs-comment">//   ,   EEPROM    </span>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> clk = <span class="hljs-number">0</span>; <span class="hljs-comment">//   watchdog</span>
<span class="hljs-keyword">bool</span> tp_reset = <span class="hljs-literal">false</span>; <span class="hljs-comment">//   TP1  TP2</span><font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_vars</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">if</span>(MCUSR &amp; (<span class="hljs-number">1</span> &lt;&lt; EXTRF)) { <span class="hljs-comment">// ,       TP1  TP2</span>
    tp_reset = <span class="hljs-literal">true</span>;<font></font>
    MCUSR &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; EXTRF); <span class="hljs-comment">//  EXTRF       ,   </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_pins</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB0) | (<span class="hljs-number">1</span> &lt;&lt; PB1) | (<span class="hljs-number">1</span> &lt;&lt; PB2) | (<span class="hljs-number">1</span> &lt;&lt; PB4); <span class="hljs-comment">//       </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    watchdog</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_interrupts</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  sleep_enable(); <span class="hljs-comment">//   </span><font></font>
<font></font>
  WDTCR = (<span class="hljs-number">1</span> &lt;&lt; WDCE) | (<span class="hljs-number">1</span> &lt;&lt; WDE); <span class="hljs-comment">//  watchdog</span>
  WDTCR = (<span class="hljs-number">1</span> &lt;&lt; WDTIE) | WDTO_1S; <span class="hljs-comment">// watchdog      ,  1 </span><font></font>
<font></font>
  sei(); <span class="hljs-comment">//  </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_settings</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  cur_edge = eeprom_read_word(&amp;EEPROM_cur_edge); <span class="hljs-comment">//   </span>
  res_edge = eeprom_read_word(&amp;EEPROM_res_edge); <span class="hljs-comment">//   </span>
  frequency_dividor = eeprom_read_byte(&amp;EEPROM_frequency_dividor); <span class="hljs-comment">//   </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_load</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    PORTB |= (<span class="hljs-number">1</span> &lt;&lt; PB1);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    PORTB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB1);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">blink_load</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> count)</span> </span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {<font></font>
    _delay_ms(<span class="hljs-number">200</span>);<font></font>
    toggle_load(<span class="hljs-literal">true</span>);<font></font>
    _delay_ms(<span class="hljs-number">200</span>);<font></font>
    toggle_load(<span class="hljs-literal">false</span>);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   (   )</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  set_sleep_mode(SLEEP_MODE_PWR_DOWN);<font></font>
  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) sleep_cpu();<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_amp</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    PORTB |= (<span class="hljs-number">1</span> &lt;&lt; PB4); <span class="hljs-comment">//     PB4</span>
    _delay_ms(<span class="hljs-number">250</span>);      <span class="hljs-comment">//       200 .</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    PORTB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB4);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_lpf</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB3); <span class="hljs-comment">//  PB3    (  "0")     C2</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    DDRB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB3); <span class="hljs-comment">//  PB3    ( )   C2  </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_gen</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    TCCR0A |= (<span class="hljs-number">1</span> &lt;&lt; COM0A0) | (<span class="hljs-number">1</span> &lt;&lt; WGM01); <span class="hljs-comment">//    ( )    OC0A      OCR0A</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> PROTEUS</span>
    TCCR0B |= (<span class="hljs-number">1</span> &lt;&lt; CS00); <span class="hljs-comment">//    1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    TCCR0B |= (<span class="hljs-number">1</span> &lt;&lt; CS00) | (<span class="hljs-number">1</span> &lt;&lt; CS02); <span class="hljs-comment">//    1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    OCR0A = FREQ_DIV_OFFSET + frequency_dividor; <span class="hljs-comment">//   ,         OC0A</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    TCCR0A = <span class="hljs-number">0</span>; <span class="hljs-comment">//  </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_adc</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    DDRB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB2); <span class="hljs-comment">//  PB2    ( )</span>
    ADMUX = <span class="hljs-number">0b01</span> | (<span class="hljs-number">1</span> &lt;&lt; REFS0); <span class="hljs-comment">// PB2, 1.1v reference</span>
    ADCSRA = (<span class="hljs-number">1</span> &lt;&lt; ADPS0) | (<span class="hljs-number">1</span> &lt;&lt; ADPS1) | (<span class="hljs-number">1</span> &lt;&lt; ADPS2) | <span class="hljs-comment">//       = 128 (75 )</span>
             (<span class="hljs-number">1</span> &lt;&lt; ADIE) |  <span class="hljs-comment">//    </span>
             (<span class="hljs-number">1</span> &lt;&lt; ADEN);   <span class="hljs-comment">//  </span>
  } <span class="hljs-keyword">else</span> {<font></font>
    ADCSRA = <span class="hljs-number">0</span>; <span class="hljs-comment">//  </span>
    DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB2); <span class="hljs-comment">//  PB2    (  "0")   C8</span>
    _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//      C8</span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">do_adc</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  set_sleep_mode(SLEEP_MODE_ADC); <span class="hljs-comment">//   "" </span>
  <span class="hljs-keyword">do</span> {<font></font>
    sleep_cpu(); <span class="hljs-comment">//      ,      ,   </span>
  } <span class="hljs-keyword">while</span>(ADCSRA &amp; (<span class="hljs-number">1</span> &lt;&lt; ADSC)); <span class="hljs-comment">//        ,  </span><font></font>
<font></font>
  <span class="hljs-keyword">return</span> ADC;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*
//  
static void blink_bin(unsigned int value, unsigned char count) {
  for(unsigned char i = 0; i &lt; count; ++i) {
    _delay_ms(1000);
    toggle_load(true);
    if(value &amp; (1 &lt;&lt; (count - i - 1))) {
      _delay_ms(500);
    } else {
      _delay_ms(50);
    }
    toggle_load(false);
  }
}
*/</span><font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get_current</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur;<font></font>
<font></font>
  toggle_lpf(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">150</span>);<font></font>
  toggle_adc(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//    C8</span>
  cur = do_adc(); <span class="hljs-comment">//  </span>
  toggle_adc(<span class="hljs-literal">false</span>);<font></font>
  toggle_lpf(<span class="hljs-literal">false</span>);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> cur;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get_resistance</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> res;<font></font>
<font></font>
  toggle_gen(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">150</span>);<font></font>
  toggle_adc(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//    C8</span>
  toggle_gen(<span class="hljs-literal">false</span>); <span class="hljs-comment">//   ,   C8     </span>
  res = do_adc(); <span class="hljs-comment">//     </span>
  toggle_adc(<span class="hljs-literal">false</span>);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> MAX_U10BIT - res; <span class="hljs-comment">//      ,      </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">is_current</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (get_current() &gt;= cur_edge);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">is_toggled_on</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (get_resistance() &lt;= res_edge);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">do_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  toggle_amp(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span><font></font>
<font></font>
  <span class="hljs-keyword">if</span>(is_current()) {<font></font>
    toggle_load(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  ,  </span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(is_toggled_on()) {<font></font>
      toggle_load(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  ,  </span>
    } <span class="hljs-keyword">else</span> {<font></font>
      toggle_load(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  ,  </span><font></font>
    }<font></font>
  }<font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">first_on</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (frequency_dividor == <span class="hljs-number">0xff</span>); <span class="hljs-comment">//   EEPROM   0xFF,        FREQ_MAXIMAL_DIV</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">calibrate</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur_off, cur_on, res_off, res_on, res_on_tmp, res_off_array[FREQ_MAXIMAL_DIV + <span class="hljs-number">1</span>], diff, max_diff, frequency_dividor_tmp;<font></font>
<font></font>
  blink_load(<span class="hljs-number">5</span>); <span class="hljs-comment">//    ,    </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span><font></font>
<font></font>
  cur_off = get_current(); <span class="hljs-comment">//      ( )</span><font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">for</span>(frequency_dividor = <span class="hljs-number">0</span>; frequency_dividor &lt;= FREQ_MAXIMAL_DIV; ++frequency_dividor) {<font></font>
    res_off_array[frequency_dividor] = get_resistance();<font></font>
  }<font></font>
<font></font>
  blink_load(<span class="hljs-number">2</span>); <span class="hljs-comment">//     </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  cur_on = get_current(); <span class="hljs-comment">//     </span><font></font>
<font></font>
  blink_load(<span class="hljs-number">3</span>); <span class="hljs-comment">//     </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  <font></font>
  res_off = MAX_U10BIT;<font></font>
  res_on = MAX_U10BIT;<font></font>
  frequency_dividor_tmp = <span class="hljs-number">0</span>;<font></font>
  max_diff = <span class="hljs-number">0</span>;
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">for</span>(frequency_dividor = <span class="hljs-number">0</span>; frequency_dividor &lt;= FREQ_MAXIMAL_DIV; ++frequency_dividor) {<font></font>
    res_on_tmp = get_resistance();<font></font>
<font></font>
    <span class="hljs-comment">//   ,      </span>
    <span class="hljs-keyword">if</span>(res_off_array[frequency_dividor] &gt; res_on_tmp) {<font></font>
      diff = res_off_array[frequency_dividor] - res_on_tmp;<font></font>
      <span class="hljs-keyword">if</span>(diff &gt; max_diff) {<font></font>
        res_off = res_off_array[frequency_dividor];<font></font>
        res_on = res_on_tmp;<font></font>
        frequency_dividor_tmp = frequency_dividor;<font></font>
        max_diff = diff;<font></font>
      }    <font></font>
    }<font></font>
  }<font></font>
  frequency_dividor = frequency_dividor_tmp;<font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  </span><font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(cur_on &gt; cur_off + CUR_MINIMAL_DIFF) { <font></font>
    cur_edge = cur_off + (cur_on - cur_off) / <span class="hljs-number">2</span>; <span class="hljs-comment">//    ,     </span><font></font>
 <font></font>
    <span class="hljs-keyword">if</span>(res_on + RES_MINIMAL_DIFF &lt; res_off) {<font></font>
      res_edge = res_off - (res_off - res_on) / <span class="hljs-number">2</span>; <span class="hljs-comment">//    ,      </span><font></font>
<font></font>
      <span class="hljs-comment">//   </span><font></font>
      eeprom_write_word(&amp;EEPROM_cur_edge, cur_edge);<font></font>
      eeprom_write_word(&amp;EEPROM_res_edge, res_edge);<font></font>
      eeprom_write_byte(&amp;EEPROM_frequency_dividor, frequency_dividor);<font></font>
      <font></font>
      blink_load(<span class="hljs-number">1</span>); <span class="hljs-comment">//  </span>
    } <span class="hljs-keyword">else</span> {<font></font>
      blink_load(<span class="hljs-number">2</span>); <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">if</span>(first_on()) stop();<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blink_load(<span class="hljs-number">3</span>); <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">if</span>(first_on()) stop();<font></font>
  }<font></font>
}<font></font>
<font></font>
ISR(WDT_vect) {<font></font>
  WDTCR |= (<span class="hljs-number">1</span> &lt;&lt; WDTIE); <span class="hljs-comment">//    watchdog   ""    </span><font></font>
}<font></font>
<font></font>
EMPTY_INTERRUPT(ADC_vect); <span class="hljs-comment">//     ,     </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
  init_vars();<font></font>
  init_pins();       <font></font>
  init_interrupts(); <font></font>
  init_settings();<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(tp_reset || first_on()) {<font></font>
    calibrate(); <span class="hljs-comment">//          </span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {<font></font>
    set_sleep_mode(SLEEP_MODE_PWR_DOWN);<font></font>
    sleep_cpu(); <span class="hljs-comment">//   watchdog</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span>(++clk &gt;= INTERVAL) {<font></font>
      do_main(); <span class="hljs-comment">//  </span>
      clk = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquive com diagrama, fia√ß√£o e o projeto completo do Atmel Studio 7</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt492788/index.html">Cansado, mas: a Alemanha parou completamente a primeira onda de COVID-19</a></li>
<li><a href="../pt492798/index.html">As pessoas foram conversar na Internet, mas agora novamente sonham com o modo offline. O que est√° acontecendo?</a></li>
<li><a href="../pt492800/index.html">Fornecedor de IoT GSM em habita√ß√£o e servi√ßos p√∫blicos (parte 1)</a></li>
<li><a href="../pt492804/index.html">Sobre a quest√£o da replica√ß√£o da atividade social na Internet como chave para minimizar o aumento da incid√™ncia durante uma pandemia</a></li>
<li><a href="../pt492806/index.html">Como vincular o engajamento √† monetiza√ß√£o em jogos e aplicativos para celular</a></li>
<li><a href="../pt492810/index.html">[COVID-19] Sua tarefa √© suavizar o pico</a></li>
<li><a href="../pt492812/index.html">Tentando executar redes GAN no OpenVINO</a></li>
<li><a href="../pt492816/index.html">Dicas e truques do IntelliJ IDEA: 4. Sincronize e compartilhe configura√ß√µes</a></li>
<li><a href="../pt492820/index.html">.Net Core Api: obtendo dados em uma solicita√ß√£o de diferentes fontes</a></li>
<li><a href="../pt492822/index.html">Desenvolvedores de CSS - por que o mundo precisa deles?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>