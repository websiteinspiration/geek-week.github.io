<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëåüèΩ üó≥Ô∏è ‚õ¥Ô∏è Hist√≥ria de suporte de nuvem DNS ausente do Google Cloud üõ∏ ‚òùüèº üëÅ‚Äçüó®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De um editor de blog do Google: voc√™ j√° se perguntou como os engenheiros do Google Cloud Technical Solutions (TSE) lidam com suas chamadas de suporte ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hist√≥ria de suporte de nuvem DNS ausente do Google Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De um editor de blog do Google:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> voc√™ j√° se perguntou como os engenheiros do Google Cloud Technical Solutions (TSE) lidam com suas chamadas de suporte t√©cnico? A responsabilidade dos engenheiros de suporte t√©cnico do TSE √© detectar e resolver as fontes de problemas identificados pelos usu√°rios. Alguns desses problemas s√£o bastante simples, mas √†s vezes voc√™ encontra um recurso que requer a aten√ß√£o de v√°rios engenheiros de uma s√≥ vez. Neste artigo, um dos funcion√°rios do TSE nos falar√° sobre um problema muito complicado de sua pr√°tica recente - o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">caso de pacotes DNS ausentes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. No decorrer desta hist√≥ria, veremos como os engenheiros conseguiram resolver a situa√ß√£o e que coisas novas eles aprenderam no curso de eliminar o erro. Esperamos que esta hist√≥ria n√£o apenas conte sobre um erro profundamente enraizado, mas tamb√©m forne√ßa uma compreens√£o dos processos que ocorrem ao enviar uma solicita√ß√£o para dar suporte ao Google Cloud.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A solu√ß√£o de problemas √© uma ci√™ncia e uma arte. Tudo come√ßa com a constru√ß√£o de uma hip√≥tese sobre a causa do comportamento n√£o-padr√£o do sistema, ap√≥s o qual √© testado quanto √† for√ßa. No entanto, antes de formular uma hip√≥tese, devemos identificar claramente e formular com precis√£o o problema. Se a pergunta parecer vaga demais, voc√™ precisar√° analisar tudo corretamente; essa √© a "arte" da solu√ß√£o de problemas.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No contexto do Google Cloud, esses processos s√£o complicados √†s vezes, pois o Google Cloud est√° lutando para garantir a privacidade de seus usu√°rios. </font><font style="vertical-align: inherit;">Por esse motivo, os engenheiros do TSE n√£o t√™m acesso para editar seus sistemas, nem a capacidade de visualizar configura√ß√µes t√£o amplamente quanto os usu√°rios. </font><font style="vertical-align: inherit;">Portanto, para testar qualquer uma de nossas hip√≥teses, n√≥s (engenheiros) n√£o podemos modificar rapidamente o sistema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguns usu√°rios acreditam que vamos consertar tudo como se a mec√¢nica do servi√ßo de carro e simplesmente nos enviar o ID da m√°quina virtual, enquanto que, na realidade, o processo prossegue no formato de uma conversa: coletando informa√ß√µes, gerando e confirmando (ou refutando) hip√≥teses e, finalmente, resolvendo problemas s√£o constru√≠dos na comunica√ß√£o com o cliente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema em considera√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje temos uma hist√≥ria com um bom final. </font><font style="vertical-align: inherit;">Uma das raz√µes para a solu√ß√£o bem-sucedida do caso proposto √© uma descri√ß√£o muito detalhada e precisa do problema. </font><font style="vertical-align: inherit;">Abaixo, voc√™ pode ver uma c√≥pia do primeiro ticket (editado, a fim de ocultar informa√ß√µes confidenciais): </font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta mensagem possui muitas informa√ß√µes √∫teis para n√≥s:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VM especificada</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema est√° indicado - o DNS n√£o funciona</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â indicado onde o problema se manifesta - VM e cont√™iner</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As etapas que o usu√°rio executou para identificar o problema s√£o indicadas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O recurso foi registrado como "P1: Impacto Cr√≠tico - Servi√ßo Inutiliz√°vel na Produ√ß√£o", o que significa monitoramento constante da situa√ß√£o 24 horas por dia, 7 dias por semana, de acordo com o esquema "Siga o Sol" (o link pode ser lido em mais detalhes sobre as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prioridades das chamadas dos usu√°rios</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), com a transfer√™ncia de uma equipe de suporte t√©cnico para o outro em cada turno de fuso hor√°rio. </font><font style="vertical-align: inherit;">De fato, quando o problema chegou √† nossa equipe em Zurique, ela conseguiu circunavegar o mundo. </font><font style="vertical-align: inherit;">Nesse momento, o usu√°rio tomou medidas para reduzir as consequ√™ncias, no entanto, tinha medo de repetir a situa√ß√£o na produ√ß√£o, pois o principal motivo ainda n√£o foi encontrado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o bilhete chegou a Zurique, j√° t√≠nhamos as seguintes informa√ß√µes em m√£os:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conte√∫do </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conte√∫do </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O </font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arquivo pcap </font><font style="vertical-align: inherit;">compilado pelo comando</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com esses dados, est√°vamos prontos para iniciar a fase de ‚Äúinvestiga√ß√£o‚Äù e solu√ß√£o de problemas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nossos primeiros passos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, verificamos os logs e o status do servidor de metadados e garantimos que funcione corretamente. </font><font style="vertical-align: inherit;">O servidor de metadados responde com o endere√ßo IP 169.254.169.254 e, entre outras coisas, √© respons√°vel por controlar os nomes de dom√≠nio. </font><font style="vertical-align: inherit;">Tamb√©m verificamos duas vezes se o firewall funciona corretamente com a VM e n√£o bloqueia pacotes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi um problema estranho: o teste nmap refutou nossa principal hip√≥tese sobre a perda de pacotes UDP, portanto deduzimos mentalmente v√°rias outras op√ß√µes e maneiras de verific√°-las:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os pacotes desaparecem seletivamente? </font><font style="vertical-align: inherit;">=&gt; Verifique as regras do iptables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU √©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muito pequeno </font><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">=&gt; Verificar sa√≠da</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O problema afeta apenas pacotes UDP ou TCP? </font><font style="vertical-align: inherit;">=&gt; Afaste-se</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os pacotes de escava√ß√£o gerados s√£o retornados? </font><font style="vertical-align: inherit;">=&gt; Afaste-se</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O libdns funciona corretamente? </font><font style="vertical-align: inherit;">=&gt; Afaste-se </font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para verificar a transfer√™ncia de pacotes nas duas dire√ß√µes</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui decidimos telefonar para o usu√°rio para solucionar problemas ao vivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante a chamada, conseguimos verificar v√°rias coisas:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s v√°rias verifica√ß√µes, exclu√≠mos as regras do iptables da lista de motivos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verificamos interfaces de rede e tabelas de roteamento e verificamos novamente o MTU</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s achamos que </font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(TCP) est√° funcionando como deveria, mas </font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UDP) n√£o est√° funcionando</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tendo </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">executado enquanto trabalha </font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, descobrimos que os pacotes UDP est√£o sendo retornados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corremos </font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e vemos como o dig chama corretamente </font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, no entanto, o segundo √© interrompido pelo tempo limite</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, a mudan√ßa est√° prestes a terminar e somos for√ßados a transferir o problema para o pr√≥ximo fuso hor√°rio. O apelo, no entanto, despertou interesse em nossa equipe, e um colega sugere a cria√ß√£o do pacote DNS de origem com o m√≥dulo Python fragmentado.</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este fragmento cria um pacote DNS e envia a solicita√ß√£o ao servidor de metadados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O usu√°rio executa o c√≥digo, a resposta DNS √© retornada e o aplicativo o recebe, o que confirma a aus√™ncia de um problema no n√≠vel da rede. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a pr√≥xima "viagem de volta ao mundo", o apelo retorna √† nossa equipe e eu o traduzo completamente para mim, acreditando que ser√° mais conveniente para o usu√°rio se o apelo parar de circular de um lugar para outro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto isso, o usu√°rio concorda em fornecer um instant√¢neo da imagem do sistema. Esta √© uma not√≠cia muito boa: a capacidade de testar o sistema voc√™ mesmo acelera significativamente a solu√ß√£o de problemas, porque voc√™ n√£o precisa mais pedir ao usu√°rio para executar comandos, me enviar resultados e analis√°-los, eu posso fazer tudo sozinho!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os colegas est√£o come√ßando a me invejar um pouco. </font><font style="vertical-align: inherit;">No almo√ßo, discutimos o apelo, mas ningu√©m tem id√©ia do que est√° acontecendo. </font><font style="vertical-align: inherit;">Felizmente, o pr√≥prio usu√°rio j√° tomou medidas de mitiga√ß√£o e n√£o tem pressa, portanto, temos tempo para preparar o problema. </font><font style="vertical-align: inherit;">E como temos uma imagem, podemos realizar quaisquer testes que nos interessem. </font><font style="vertical-align: inherit;">Bem!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voltando um passo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma das perguntas mais populares em uma entrevista para um engenheiro de sistemas √©: "O que acontece quando voc√™ faz ping em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.google.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?" </font><font style="vertical-align: inherit;">A quest√£o √© elegante, porque o candidato precisa ser descrito do shell ao espa√ßo do usu√°rio, ao n√∫cleo do sistema e √† rede. </font><font style="vertical-align: inherit;">Eu sorrio: √†s vezes as perguntas da entrevista tamb√©m s√£o √∫teis na vida real ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu decido aplicar essa pergunta do eychar ao problema atual. </font><font style="vertical-align: inherit;">Grosso modo, quando voc√™ tenta determinar o nome DNS, acontece o seguinte:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O aplicativo chama a biblioteca do sistema, por exemplo libdns</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns verifica a configura√ß√£o do sistema que servidor DNS ele deve usar (no diagrama, √© 169.254.169.254, servidor de metadados)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns usa chamadas de sistema para criar um soquete UDP (SOKET_DGRAM) e enviar pacotes UDP com uma solicita√ß√£o DNS nas duas dire√ß√µes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando a interface sysctl, voc√™ pode configurar a pilha UDP no n√≠vel do kernel</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O kernel interage com o hardware para transmitir pacotes pela rede atrav√©s de uma interface de rede</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O hipervisor captura e passa o pacote para o servidor de metadados quando entra em contato com ele</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O servidor de metadados determina o nome DNS por sua bruxaria e retorna a resposta da mesma maneira</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deixe-me lembr√°-lo de quais hip√≥teses j√° conseguimos considerar: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hip√≥tese: Bibliotecas quebradas</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 1: execute strace no sistema, verifique se dig faz com que as chamadas de sistema corretas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: as chamadas corretas do sistema s√£o chamadas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 2: atrav√©s de srapy para verificar se podemos determinar os nomes ignorando as bibliotecas do sistema</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: podemos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 3: execute rpm ‚ÄìV nos arquivos da biblioteca libdns package e md5sum</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: o c√≥digo da biblioteca √© completamente id√™ntico ao c√≥digo no sistema operacional em funcionamento</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 4: monte a imagem do sistema raiz do usu√°rio na VM sem esse comportamento, execute chroot, veja se o DNS funciona</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: o DNS est√° funcionando corretamente</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o baseada em testes: o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problema n√£o est√° nas bibliotecas </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hip√≥tese: H√° um erro nas configura√ß√µes de DNS</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 1: verifique o tcpdump e verifique se os pacotes DNS foram enviados e retornados corretamente ap√≥s a execu√ß√£o do dig</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: os pacotes s√£o transmitidos corretamente</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 2: verifique novamente no servidor </font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: tudo est√° correto</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o baseada em teste: o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problema n√£o est√° na </font><b><font style="vertical-align: inherit;">hip√≥tese de</font></b><font style="vertical-align: inherit;"> configura√ß√£o do DNS </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Kernel danificado</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste: instale um novo kernel, verifique a assinatura, reinicie</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: comportamento semelhante</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o baseada em testes: o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kernel n√£o est√° danificado. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hip√≥tese: comportamento incorreto da rede do usu√°rio (ou da interface de rede do hipervisor)</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 1: verifique as configura√ß√µes do firewall</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: o firewall passa pacotes DNS no host e no GCP</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 2: interceptar tr√°fego e rastrear a corre√ß√£o da transfer√™ncia e retorno de consultas DNS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: tcpdump confirma o recebimento de pacotes de retorno pelo host</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o baseada em teste: o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problema n√£o est√° na rede </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hip√≥tese: o servidor de metadados n√£o funciona</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 1: verifique se h√° anomalias nos logs do servidor de metadados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: n√£o h√° anomalias nos logs</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste 2: ignore o servidor de metadados por </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado: a permiss√£o √© violada mesmo sem o uso de um servidor de metadados</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o baseada em teste: o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problema n√£o est√° no servidor de metadados </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> testamos todos os subsistemas, exceto as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configura√ß√µes de tempo de execu√ß√£o!</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mergulhando nas configura√ß√µes de tempo de execu√ß√£o do kernel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para configurar o tempo de execu√ß√£o do kernel, voc√™ pode usar as op√ß√µes de linha de comando (grub) ou a interface sysctl. </font><font style="vertical-align: inherit;">Eu olhei </font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e s√≥ pensei, encontrei algumas configura√ß√µes personalizadas. </font><font style="vertical-align: inherit;">Sentindo como se tivesse me agarrado a algo, rejeitei todas as configura√ß√µes que n√£o s√£o de rede ou n√£o-TCP, permanecendo fora das configura√ß√µes de montanha </font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Depois, virei para o local em que a VM tem permiss√µes de host e comecei a aplicar uma ap√≥s a outra, uma ap√≥s a outra, configura√ß√µes com uma VM quebrada, at√© chegar ao criminoso:</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√°, uma configura√ß√£o de quebra de DNS! Eu encontrei um instrumento de crime. Mas por que isso est√° acontecendo? Eu ainda precisava de um motivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A configura√ß√£o do tamanho base do buffer do pacote DNS ocorre </font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Um valor t√≠pico varia em algum lugar dentro de 200KiB; no entanto, se o servidor receber muitos pacotes DNS, voc√™ poder√° aumentar o tamanho do buffer. Se o buffer estiver cheio no momento em que um novo pacote chegar, por exemplo, porque o aplicativo n√£o o processa com rapidez suficiente, voc√™ come√ßar√° a perder pacotes. Nosso cliente aumentou corretamente o tamanho do buffer porque tinha medo de perda de dados, porque usou o aplicativo para coletar m√©tricas atrav√©s de pacotes DNS. O valor que ele definiu foi o m√°ximo poss√≠vel: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1 (se voc√™ definir 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o kernel retornar√° "ARGUMENTO INV√ÅLIDO").</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De repente, percebi por que o nmap e o scapy funcionavam corretamente: eles usavam soquetes brutos! Soquetes brutos s√£o diferentes dos soquetes regulares: eles funcionam ignorando o iptables e n√£o s√£o armazenados em buffer! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas por que "um buffer muito grande" est√° causando problemas? Obviamente, n√£o funciona como pretendido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste ponto, eu poderia reproduzir o problema em v√°rios n√∫cleos e distribui√ß√µes m√∫ltiplas. O problema j√° se manifestou no kernel 3.x e agora tamb√©m se manifestou no kernel 5.x. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, na inicializa√ß√£o</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O DNS parou de funcionar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comecei a procurar valores funcionais por meio de um algoritmo de busca bin√°ria simples e descobri que o sistema funciona com o 2147481343, mas esse n√∫mero era um conjunto de n√∫meros sem sentido para mim. Convidei o cliente para experimentar esse n√∫mero, e ele respondeu que o sistema funcionava com o google.com, mas ainda assim deu um erro em outros dom√≠nios, ent√£o continuei minha investiga√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu instalei o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dropwatch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , uma ferramenta que eu deveria ter usado antes: mostra onde exatamente o pacote entra no kernel. A fun√ß√£o era culpada </font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Eu baixei as fontes do kernel e adicionei v√°rias </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fun√ß√µes</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para rastrear onde o pacote fica especificamente. Encontrei rapidamente a condi√ß√£o certa</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e por algum tempo simplesmente o encarou, porque foi ent√£o que tudo finalmente se juntou em um quadro inteiro: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1, um n√∫mero sem sentido, um dom√≠nio ocioso ... Era um peda√ßo de c√≥digo em </font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nota:</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tem o tipo int</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© do tipo u16 (sem assinatura de dezesseis bits int) e armazena o tamanho do pacote</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© do tipo int e armazena o tamanho do buffer, que por defini√ß√£o √© igual ao valor em </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao se </font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aproximar de 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a soma do tamanho do pacote pode levar ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estouro inteiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">E como √© um int, seu valor se torna negativo; portanto, a condi√ß√£o se torna verdadeira quando deveria ser falsa (mais sobre isso pode ser encontrado por </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">refer√™ncia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O erro √© corrigido de uma maneira trivial: convertendo para </font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Apliquei o patch e reiniciei o sistema, ap√≥s o qual o DNS voltou a funcionar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gosto da vit√≥ria</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encaminhei minhas descobertas para o cliente e enviei o </font><font style="vertical-align: inherit;">patch do kernel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LKML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Estou satisfeito: cada pe√ßa do quebra-cabe√ßa se juntou em um √∫nico todo, posso explicar com precis√£o por que observamos o que observamos e, o mais importante, conseguimos encontrar uma solu√ß√£o para o problema trabalhando juntos! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale a pena reconhecer que o caso acabou sendo raro e, felizmente, essas chamadas complexas raramente s√£o recebidas de nossos usu√°rios.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt503096/index.html">Por que os gerentes querem que os trabalhadores reciclem?</a></li>
<li><a href="../pt503100/index.html">Cabe√ßa Internet</a></li>
<li><a href="../pt503106/index.html">Resumo de descoberta n√£o-padr√£o: genealogia de plantas predadoras, fungos no Twitter e g√°s hilariante de guano</a></li>
<li><a href="../pt503108/index.html">Oito cores do arco-√≠ris: sobre cores em termos de matem√°tica</a></li>
<li><a href="../pt503110/index.html">Epidemia digital: CoronaVirus vs CoViper</a></li>
<li><a href="../pt503118/index.html">David Yang - sobre n√£o invasividade, crises e terra arrasada</a></li>
<li><a href="../pt503126/index.html">Likbez sobre VPS: como configurar a √°rea de trabalho remota se voc√™ √© um usu√°rio Win</a></li>
<li><a href="../pt503128/index.html">Como incorporar o ColorPicker no JavaScript Gantt para alterar a cor das tarefas</a></li>
<li><a href="../pt503132/index.html">Parquet Apache de alta velocidade em Python com Apache Arrow</a></li>
<li><a href="../pt503134/index.html">Gerenciamento = Equipe + Produto. Revelamos a f√≥rmula deste ano: a mais √∫til sobre as pessoas e para as pessoas no DUMP 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>