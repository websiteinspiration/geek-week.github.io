<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üà≤ üë®üèΩ‚Äç‚öïÔ∏è üéë Keamanan Musim Semi - Contoh Aplikasi Web Otorisasi O2uth Melalui BitBucket üë∞üèª üôà ‚ÜóÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini, kami akan mempertimbangkan cara untuk mengotorisasi pengguna dalam aplikasi web pada Spring Boot menggunakan protokol OAuth2 menggun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Keamanan Musim Semi - Contoh Aplikasi Web Otorisasi O2uth Melalui BitBucket</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497588/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pada artikel ini, kami akan mempertimbangkan cara untuk mengotorisasi pengguna dalam aplikasi web pada Spring Boot menggunakan protokol OAuth2 menggunakan server otorisasi eksternal (menggunakan contoh Bitbucket).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang ingin kita dapatkan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalkan kita sedang mengembangkan aplikasi web aman yang memiliki akses ke sumber daya pengguna pada server eksternal, misalnya, sistem integrasi berkelanjutan, dan Bitbucket bertindak sebagai server eksternal, dan kami tidak ingin menyimpan nama pengguna dan kata sandi pengguna dari sistem eksternal. </font><font style="vertical-align: inherit;">Artinya, kita perlu memberi otorisasi kepada pengguna melalui Bitbucket untuk mendapatkan akses ke akun dan sumber dayanya, juga memeriksa bahwa dia adalah pengguna aplikasi kita dan membuatnya agar pengguna tidak mengungkapkan kepada kami kredensial dari Bitbucket kepada kami. </font><font style="vertical-align: inherit;">Saya ingin tahu bagaimana melakukan ini - selamat datang di kucing.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OAuth2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 adalah protokol otorisasi yang memungkinkan Anda untuk memberikan kepada pihak ketiga akses terbatas ke sumber daya yang dilindungi pengguna tanpa harus memberinya (nama pihak ketiga) nama pengguna dan kata sandi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 mendefinisikan 4 peran:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pemilik sumber daya </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Server sumber daya </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Server otorisasi </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Klien (aplikasi) </font></font></li>
</ul><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pemilik sumber daya</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah pengguna yang menggunakan aplikasi klien dan memungkinkannya mengakses akunnya yang dihosting di server sumber daya. Akses aplikasi ke akun dibatasi oleh izin yang diberikan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sumber daya server</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> host mengamankan akun pengguna. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server otorisasi</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mengotentikasi pemilik sumber daya dan mengeluarkan token akses. Server otorisasi dapat sekaligus menjadi server sumber daya. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplikasi klien</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah aplikasi yang ingin mengakses akun dan sumber daya pengguna. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kasus kami, aplikasi klien adalah aplikasi yang kami kembangkan, dan Bitbucket akan menjadi server otorisasi dan server sumber daya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuth2 mendukung empat jenis otorisasi: Kode Otorisasi, Implisit, Kredensial Kata Sandi Pemilik Sumber Daya, dan Kredensial Klien. </font><font style="vertical-align: inherit;">Kami tidak akan mempertimbangkan semuanya, kami tertarik pada jenis Kode Otorisasi. </font><font style="vertical-align: inherit;">Jenis Kode Otorisasi dioptimalkan untuk aplikasi server di mana kode sumber tidak tersedia untuk umum dan kode Rahasia Klien dapat dirahasiakan. </font><font style="vertical-align: inherit;">Jenis ini berfungsi atas dasar pengalihan, yaitu, pengguna akan diarahkan ke server otorisasi untuk mengonfirmasi identitasnya dan memungkinkan aplikasi untuk menggunakan akunnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proses otorisasi melalui Kode Otorisasi terdiri dari urutan dua permintaan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Permintaan Otorisasi </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Akses Permintaan Token </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permintaan otorisasi digunakan untuk mengonfirmasi identitas pengguna, serta meminta otorisasi aplikasi kami dari pengguna. </font><font style="vertical-align: inherit;">Permintaan ini adalah permintaan GET dengan parameter berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> response_type - nilainya harus sama dengan kode </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_id - nilai yang diperoleh saat mendaftarkan klien dengan penyedia OAuth2 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> redirect_uri - URL tempat pengguna akan dialihkan setelah otorisasi </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> scope - parameter opsional yang menunjukkan level akses yang diminta </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state - string yang dihasilkan secara acak untuk memverifikasi respons </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh permintaan:</font></font><br>
<br>
<pre><code class="plaintext hljs">GET https://server.example.com/authorize?response_type=code&amp;client_id=CLIENT_ID&amp;state=xyz&amp;redirect_uri=REDIRECT_URI
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika pengguna mengonfirmasi identitasnya dan memungkinkan aplikasi mengakses sumber dayanya, agen pengguna akan dialihkan ke URL panggilan balik yang ditentukan saat pendaftaran klien dengan kode parameter tambahan yang berisi kode otorisasi dan parameter status dengan nilai yang diteruskan dalam permintaan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh panggilan balik:</font></font><br>
<br>
<pre><code class="plaintext hljs">GET https://client.example.com/cb?code=AUTH_CODE_HERE&amp;state=xyz
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permintaan kode akses digunakan untuk menukar kode otorisasi yang diterima dengan kode akses ke sumber daya pengguna. </font><font style="vertical-align: inherit;">Permintaan ini adalah permintaan POST dengan parameter berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> grant_type - nilai harus berupa authorization_code </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kode - kode otorisasi yang diperoleh pada langkah sebelumnya </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> redirect_uri - harus cocok dengan URL yang ditentukan pada langkah sebelumnya </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_id - nilai yang diperoleh saat mendaftarkan klien dengan penyedia OAuth2 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> client_secret - nilai yang diperoleh saat mendaftarkan klien dengan penyedia OAuth2 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contoh permintaan:</font></font><br>
<br>
<pre><code class="plaintext hljs">POST https://server.example.com/token<font></font>
    grant_type=authorization_code&amp;<font></font>
    code=AUTH_CODE&amp;<font></font>
    redirect_uri=REDIRECT_URI&amp;<font></font>
    client_id=CLIENT_ID&amp;<font></font>
    client_secret=CLIENT_SECRET<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Respons server berisi kode akses dan masa pakainya:</font></font><br>
<br>
<pre><code class="plaintext hljs">{<font></font>
    "access_token": "2YotnFZFEjr1zCsicMWpAA",<font></font>
    "expires_in": 3600,<font></font>
    "refresh_token": "tGzv3JOkF0XG5Qx2TlKWIA"<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seluruh proses ini sudah terotomatisasi di Spring Security dan kami tidak perlu khawatir dengan implementasinya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registrasi pelanggan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama-tama, kami akan mendaftarkan aplikasi kami sebagai klien di Bitbucket untuk mendapatkan kunci (Kunci) dan kode akses (Rahasia Klien). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sn/gz/ba/sngzbaxdqi0wpbsua7eurx_wcis.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masukkan nama klien dan URL panggilan balik. </font><font style="vertical-align: inherit;">Kemudian kami mencatat apa yang akan tersedia untuk klien ini. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vk/y3/3z/vky33zq59j1qg1nvtwmtwxpwqni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nilai Key dan ClientSecret yang diperoleh disimpan di application.properties:</font></font><br>
<br>
<pre><code class="plaintext hljs">client_id=ZJsdANfWkJ7jcktw2x<font></font>
client_secret=28uUrJ9m43svbkcnXVNj8qeBjFtd8jaD<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan Keamanan Musim Semi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, mari kita mengatur Spring Security. </font><font style="vertical-align: inherit;">Agar OAuth2 berfungsi, Anda harus membuat objek ClientRegistration. </font><font style="vertical-align: inherit;">ClientRegistration menyimpan informasi tentang klien yang terdaftar pada penyedia OAuth2. </font><font style="vertical-align: inherit;">Di sini kita membutuhkan client_id dan client_secret yang diperoleh pada langkah sebelumnya. </font><font style="vertical-align: inherit;">Karena ada beberapa objek ClientRegistration tersebut secara umum, Spring Security menggunakan objek ClientRegistrationRepository untuk menyimpan dan mengaksesnya. </font><font style="vertical-align: inherit;">Mari kita ciptakan juga. </font><font style="vertical-align: inherit;">Kami juga menunjukkan bahwa hanya pengguna yang sah yang dapat memanggil permintaan apa pun dan mendefinisikan kembali UserService dengan implementasinya.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SecurityConfig.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${client_id}")</span>
    <span class="hljs-keyword">private</span> String clientId;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${client_secret}")</span>
    <span class="hljs-keyword">private</span> String clientSecret;<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClientRegistration <span class="hljs-title">clientRegistration</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> ClientRegistration<font></font>
                .withRegistrationId(<span class="hljs-string">"bitbucket"</span>)<font></font>
                .clientId(clientId)<font></font>
                .clientSecret(clientSecret)<font></font>
                .userNameAttributeName(<span class="hljs-string">"username"</span>)<font></font>
                .clientAuthenticationMethod(BASIC)<font></font>
                .authorizationGrantType(AUTHORIZATION_CODE)<font></font>
                .userInfoUri(<span class="hljs-string">"https://api.bitbucket.org/2.0/user"</span>)<font></font>
                .tokenUri(<span class="hljs-string">"https://bitbucket.org/site/oauth2/access_token"</span>)<font></font>
                .authorizationUri(<span class="hljs-string">"https://bitbucket.org/site/oauth2/authorize"</span>)<font></font>
                .redirectUriTemplate(<span class="hljs-string">"{baseUrl}/login/oauth2/code/{registrationId}"</span>)<font></font>
                .build();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> MyOAuth2UserService <span class="hljs-title">oAuth2userService</span><span class="hljs-params">(UserService userService)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyOAuth2UserService(userService);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ClientRegistrationRepository <span class="hljs-title">clientRegistrationRepository</span><span class="hljs-params">(List&lt;ClientRegistration&gt; registrations)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InMemoryClientRegistrationRepository(registrations);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Configuration</span>
    <span class="hljs-meta">@EnableWebSecurity</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{<font></font>
<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MyOAuth2UserService userService;<font></font>
<font></font>
        <span class="hljs-meta">@Autowired</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AuthConfig</span><span class="hljs-params">(MyOAuth2UserService userService)</span> </span>{
            <span class="hljs-keyword">this</span>.userService = userService;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
            http<font></font>
                    .authorizeRequests(authorizeRequests -&gt; authorizeRequests<font></font>
                            .anyRequest().authenticated()<font></font>
                    )<font></font>
                    .oauth2Login(oauth2Login -&gt; oauth2Login<font></font>
                            .userInfoEndpoint(userInfoEndpoint -&gt; userInfoEndpoint.userService(userService))<font></font>
                    );<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kustomisasi Layanan Pengguna</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring Security tidak hanya sepenuhnya mengimplementasikan proses otorisasi, tetapi juga menyediakan kemampuan untuk menyesuaikannya. Misalnya, kemungkinan mengkustomisasi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permintaan otorisasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">meminta kode akses</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , serta kemungkinan posting kustom memproses </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">respons terhadap permintaan kode akses</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Setelah otorisasi berhasil, Spring Security menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserInfo Endpoint</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk mengambil atribut pengguna dari server otorisasi. Secara khusus, implementasi antarmuka OAuth2UserService digunakan untuk ini.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan membuat implementasi layanan kami sendiri, sehingga setelah otorisasi pengguna di server otorisasi, kami juga memeriksa apakah dia adalah pengguna aplikasi kami, atau mendaftar jika pendaftaran terbuka untuk semua orang. </font><font style="vertical-align: inherit;">Secara default, Spring Security menggunakan implementasi DefaultOAuth2UserService. </font><font style="vertical-align: inherit;">Dia akan membentuk dasar dari implementasi kami.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MyOAuth2UserService.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyOAuth2UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OAuth2UserService</span>&lt;<span class="hljs-title">OAuth2UserRequest</span>, <span class="hljs-title">OAuth2User</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MISSING_USER_INFO_URI_ERROR_CODE = <span class="hljs-string">"missing_user_info_uri"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String INVALID_USER_INFO_RESPONSE_ERROR_CODE = <span class="hljs-string">"invalid_user_info_response"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String MISSING_USER_NAME_ATTRIBUTE_ERROR_CODE = <span class="hljs-string">"missing_user_name_attribute"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ParameterizedTypeReference&lt;Map&lt;String, Object&gt;&gt; PARAMETERIZED_RESPONSE_TYPE = <span class="hljs-keyword">new</span> ParameterizedTypeReference&lt;Map&lt;String, Object&gt;&gt;() {<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RestOperations restOperations;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Converter&lt;OAuth2UserRequest, RequestEntity&lt;?&gt;&gt; requestEntityConverter = <span class="hljs-keyword">new</span> OAuth2UserRequestEntityConverter();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyOAuth2UserService</span><span class="hljs-params">(UserService userService)</span> </span>{
        <span class="hljs-keyword">this</span>.userService = requireNonNull(userService);
        <span class="hljs-keyword">this</span>.restOperations = createRestTemplate();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2User <span class="hljs-title">loadUser</span><span class="hljs-params">(OAuth2UserRequest userRequest)</span> <span class="hljs-keyword">throws</span> OAuth2AuthenticationException </span>{<font></font>
        checkNotNull(userRequest, <span class="hljs-string">"userRequest cannot be null"</span>);
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUri())) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(MISSING_USER_INFO_URI_ERROR_CODE, <span class="hljs-string">"Missing required UserInfo Uri in UserInfoEndpoint for Client Registration: "</span> + userRequest.getClientRegistration().getRegistrationId(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());<font></font>
        }<font></font>
<font></font>
        String registrationId = userRequest.getClientRegistration().getRegistrationId();<font></font>
        String userNameAttributeName = userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName();<font></font>
        <span class="hljs-keyword">if</span> (!StringUtils.hasText(userNameAttributeName)) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(<font></font>
                    MISSING_USER_NAME_ATTRIBUTE_ERROR_CODE,<font></font>
                    <span class="hljs-string">"Missing required \"user name\" attribute name in UserInfoEndpoint for Client Registration: "</span> + registrationId, <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());<font></font>
        }<font></font>
<font></font>
        ResponseEntity&lt;Map&lt;String, Object&gt;&gt; response;<font></font>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// OAuth2UserRequestEntityConverter cannot return null values.</span>
            <span class="hljs-comment">//noinspection ConstantConditions</span>
            response = <span class="hljs-keyword">this</span>.restOperations.exchange(requestEntityConverter.convert(userRequest), PARAMETERIZED_RESPONSE_TYPE);<font></font>
        } <span class="hljs-keyword">catch</span> (OAuth2AuthorizationException ex) {<font></font>
            OAuth2Error oauth2Error = ex.getError();<font></font>
            StringBuilder errorDetails = <span class="hljs-keyword">new</span> StringBuilder();<font></font>
            errorDetails.append(<span class="hljs-string">"Error details: ["</span>);<font></font>
            errorDetails.append(<span class="hljs-string">"UserInfo Uri: "</span>).append(<font></font>
                    userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUri());<font></font>
            errorDetails.append(<span class="hljs-string">", Error Code: "</span>).append(oauth2Error.getErrorCode());
            <span class="hljs-keyword">if</span> (oauth2Error.getDescription() != <span class="hljs-keyword">null</span>) {<font></font>
                errorDetails.append(<span class="hljs-string">", Error Description: "</span>).append(oauth2Error.getDescription());<font></font>
            }<font></font>
            errorDetails.append(<span class="hljs-string">"]"</span>);<font></font>
            oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(INVALID_USER_INFO_RESPONSE_ERROR_CODE,
                    <span class="hljs-string">"An error occurred while attempting to retrieve the UserInfo Resource: "</span> + errorDetails.toString(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString(), ex);<font></font>
        } <span class="hljs-keyword">catch</span> (RestClientException ex) {<font></font>
            OAuth2Error oauth2Error = <span class="hljs-keyword">new</span> OAuth2Error(INVALID_USER_INFO_RESPONSE_ERROR_CODE,
                    <span class="hljs-string">"An error occurred while attempting to retrieve the UserInfo Resource: "</span> + ex.getMessage(), <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> OAuth2AuthenticationException(oauth2Error, oauth2Error.toString(), ex);<font></font>
        }<font></font>
<font></font>
        Map&lt;String, Object&gt; userAttributes = emptyIfNull(response.getBody());<font></font>
<font></font>
        Set&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();<font></font>
        authorities.add(<span class="hljs-keyword">new</span> OAuth2UserAuthority(userAttributes));<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (String authority : userRequest.getAccessToken().getScopes()) {<font></font>
            authorities.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(<span class="hljs-string">"SCOPE_"</span> + authority));<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">//     ,   </span>
        <span class="hljs-comment">//          ,</span>
        <span class="hljs-comment">//    </span><font></font>
        User user = findOrCreate(userAttributes);<font></font>
        userAttributes.put(MyOAuth2User.ID_ATTR, user.getId());<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MyOAuth2User(userNameAttributeName, userAttributes, authorities);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> User <span class="hljs-title">findOrCreate</span><span class="hljs-params">(Map&lt;String, Object&gt; userAttributes)</span> </span>{<font></font>
        String login = (String) userAttributes.get(<span class="hljs-string">"username"</span>);<font></font>
        String username = (String) userAttributes.get(<span class="hljs-string">"display_name"</span>);<font></font>
<font></font>
        Optional&lt;User&gt; userOpt = userService.findByLogin(login);<font></font>
        <span class="hljs-keyword">if</span> (!userOpt.isPresent()) {<font></font>
            User user = <span class="hljs-keyword">new</span> User();<font></font>
            user.setLogin(login);<font></font>
            user.setName(username);<font></font>
            <span class="hljs-keyword">return</span> userService.create(user);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> userOpt.get();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> RestTemplate <span class="hljs-title">createRestTemplate</span><span class="hljs-params">()</span> </span>{<font></font>
        RestTemplate restTemplate = <span class="hljs-keyword">new</span> RestTemplate();<font></font>
        restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> OAuth2ErrorResponseErrorHandler());
        <span class="hljs-keyword">return</span> restTemplate;<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes titik akhir</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saatnya membuat titik akhir untuk menguji kesehatan dari apa yang baru saja kita lakukan. </font><font style="vertical-align: inherit;">Titik akhir kami akan terdiri dari hanya satu permintaan, yang akan menyambut pengguna saat ini.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WelcomeEndpoint.java</font></font></b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta">@Path("/")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WelcomeEndpoint</span> </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;<font></font>
<font></font>
    <span class="hljs-meta">@GET</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">welcome</span><span class="hljs-params">()</span> </span>{<font></font>
        User currentUser = getCurrentUser();<font></font>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Welcome, %s! (user id: %s, user login: %s)"</span>,<font></font>
                currentUser.getName(), currentUser.getId(), currentUser.getLogin());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getCurrentUser</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> userService.findByLogin(getAuthenticatedUser().getName()).orElseThrow(() -&gt; <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"No user logged in."</span>));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Authentication <span class="hljs-title">getAuthentication</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> SecurityContextHolder.getContext().getAuthentication();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> MyOAuth2User <span class="hljs-title">getAuthenticatedUser</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> (MyOAuth2User) getAuthentication().getPrincipal();<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cek kesehatan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami meluncurkan aplikasi dan pergi ke alamat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: // localhost: 8080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan melihat bahwa kami dialihkan ke situs web Bitbucket untuk mengonfirmasi akun kami. </font><font style="vertical-align: inherit;">Masukkan nama pengguna dan kata sandi. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vn/g7/g5/vng7g5ick7pzzako7jzlwafgqeu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kita perlu mengizinkan aplikasi kita mengakses akun dan sumber daya kita. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k0/4g/hr/k04ghrn2luycrilhcghd5gdo-g0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salam pengguna mengandung atribut dari server otorisasi dan ID pengguna dalam aplikasi kami.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/ud/tl/reudtl-zj8py7cgal2rroct6nvu.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sumber</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode sumber lengkap untuk aplikasi ini ada di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi</font></font></h3><br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OAuth - Wikipedia</font></font></a> </li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi keamanan pegas</font></font></a> </li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kerangka Otorisasi OAuth 2.0</font></font></a> </li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id497574/index.html">Onkologi dalam konteks pandemi COVID-19: bagaimana cara menyelamatkan nyawa maksimal</a></li>
<li><a href="../id497578/index.html">AMD berkomitmen untuk mendapatkan pangsa pasar yang signifikan untuk pusat data</a></li>
<li><a href="../id497580/index.html">Karantina keras sangat sangat buruk</a></li>
<li><a href="../id497582/index.html">Habr menempati posisi pertama dalam peringkat hak digital pengguna</a></li>
<li><a href="../id497584/index.html">Dihitung sendiri: bagaimana Madrobot membawa skala pintar Picooc ke Rusia</a></li>
<li><a href="../id497590/index.html">Kami berurusan dengan algoritma runtuhnya fungsi gelombang</a></li>
<li><a href="../id497594/index.html">Penyimpanan data eksternal: dari zaman IBM 1311 hingga saat ini. Bagian 1</a></li>
<li><a href="../id497596/index.html">PHP panjang umur</a></li>
<li><a href="../id497602/index.html">Apakah Anda menganggap diri Anda sebagai penandatangan? Siapa yang bercanda</a></li>
<li><a href="../id497606/index.html">Sistem penyiraman taman otomatis untuk Home Assistant, ESP8266 dan MiFlora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>