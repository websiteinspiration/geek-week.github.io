<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∏üèΩ üíó ü•Ç Base de datos de primos de hasta cien mil millones en la rodilla üöÇ üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® üö∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El algoritmo m√°s conocido para encontrar todos los n√∫meros primos no mayores que uno dado es el tamiz de Erat√≥stenes . Funciona muy bien para n√∫meros ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Base de datos de primos de hasta cien mil millones en la rodilla</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504598/"><img src="https://habrastorage.org/webt/zd/6i/ot/zd6iot54oxpybjjvtfpznmgymem.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo m√°s conocido para encontrar todos los n√∫meros primos no mayores que uno dado es el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tamiz de Erat√≥stenes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Funciona muy bien para n√∫meros de hasta miles de millones, tal vez hasta decenas de miles de millones, si se escriben cuidadosamente. Sin embargo, todos los que les gusta divertirse con los n√∫meros primos saben que siempre quieres tener tantos como puedas. Una vez, para resolver un problema en un hackerrank, necesitaba una base de datos en memoria de primos de hasta cien mil millones. Con la optimizaci√≥n de memoria m√°xima, si representa n√∫meros impares en un tamiz de Erat√≥stenes con una matriz de bits, su tama√±o ser√° de aproximadamente 6 gigabytes, lo que no cabe en la memoria de mi computadora port√°til. Hay una modificaci√≥n del algoritmo que es mucho menos exigente en la memoria (dividiendo el rango original de n√∫meros en varias piezas y procesando una pieza a la vez):</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamiz segmentado de Erat√≥stenes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero es m√°s dif√≠cil de implementar, y el resultado completo no cabe en la memoria de todos modos. </font><font style="vertical-align: inherit;">A continuaci√≥n, traigo a su atenci√≥n un algoritmo que es casi tan simple como el tamiz de Erat√≥stenes, pero que ofrece una doble optimizaci√≥n por memoria (es decir, una base de datos de primos de hasta cien mil millones ocupar√° aproximadamente 3 gigabytes, que ya deber√≠an caber en la memoria de una computadora port√°til est√°ndar).</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, recordemos c√≥mo funciona el tamiz de Erat√≥stenes: en una serie de n√∫meros del 1 al N, los n√∫meros divisibles por dos se tachan, luego los n√∫meros divisibles por 3, y as√≠ sucesivamente. </font><font style="vertical-align: inherit;">Los n√∫meros restantes despu√©s de tachar ser√°n simples:</font></font><br>
<br>
<pre><code class="plaintext hljs">2 3 . 5 . 7 . 9 . 11 . 13 . 15 . 17 . 19 . 21 . 23 . 25 . 27  . 29  ...<font></font>
2 3 . 5 . 7 . . . 11 . 13 .  . . 17 . 19 .  . . 23 . 25 .  .  . 29  ...<font></font>
2 3 . 5 . 7 . . . 11 . 13 .  . . 17 . 19 .  . . 23 .  . .  .  . 29  ...<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo C #</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">EratospheneSieve</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span>[] Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EratospheneSieve</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> length</span>)</span><font></font>
    {<font></font>
        Data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">bool</span>[length];<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span>; i &lt; Data.Length; i++) Data[i] = <span class="hljs-literal">true</span>;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span>; i * i &lt; Length; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!Data[i]) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> d = i * i; d &lt; Length; d += i) Data[d] = <span class="hljs-literal">false</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Length =&gt; Data.Length;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> n</span>)</span> =&gt; Data[n];<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mi computadora port√°til, cuenta hasta 15 mil millones de segundos y consume un gigabyte de memoria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo que usaremos se llama </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wheel Factorization</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para comprender su esencia, escribimos n√∫meros naturales con una tableta de 30 piezas seguidas:</font></font><br>
<br>
<pre><code class="plaintext hljs"> 0  1  2  3  4  5 ... 26 27 28 29<font></font>
30 31 32 33 34 35 ... 56 57 58 59<font></font>
60 61 62 63 64 65 ... 86 87 88 89<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y tache todos los n√∫meros divisibles por 2, 3 y 5:</font></font><br>
<br>
<pre><code class="cs hljs">.  <span class="hljs-number">1</span> . . . . .  <span class="hljs-number">7</span> . . . <span class="hljs-number">11</span> . <span class="hljs-number">13</span> . . . <span class="hljs-number">17</span> . <span class="hljs-number">19</span> . . . <span class="hljs-number">23</span> . . . . . <span class="hljs-number">29</span>
. <span class="hljs-number">31</span> . . . . . <span class="hljs-number">37</span> . . . <span class="hljs-number">41</span> . <span class="hljs-number">43</span> . . . <span class="hljs-number">47</span> . <span class="hljs-number">49</span> . . . <span class="hljs-number">53</span> . . . . . <span class="hljs-number">59</span>
. <span class="hljs-number">61</span> . . . . . <span class="hljs-number">67</span> . . . <span class="hljs-number">71</span> . <span class="hljs-number">73</span> . . . <span class="hljs-number">77</span> . <span class="hljs-number">79</span> . . . <span class="hljs-number">83</span> . . . . . <span class="hljs-number">89</span><font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se puede ver que en cada fila los n√∫meros se tachan en las mismas posiciones. </font><font style="vertical-align: inherit;">Como tachamos solo n√∫meros compuestos (con la excepci√≥n, de hecho, de los n√∫meros 2, 3, 5), los n√∫meros primos solo pueden estar en posiciones sin marcar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como hay ocho n√∫meros de este tipo en cada fila, esto nos da la idea de representar cada treinta n√∫meros con un byte, cada uno de los ocho bits indicar√° la simplicidad del n√∫mero en la posici√≥n correspondiente. </font><font style="vertical-align: inherit;">¬°Esta coincidencia no solo es est√©ticamente hermosa, sino que tambi√©n simplifica enormemente la implementaci√≥n del algoritmo!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sc/kk/_9/sckk_9guzbjn14nmzo7djdiyvxm.png" alt="imagen"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n t√©cnica</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, nuestro objetivo es llegar a cien mil millones, por lo que ya no se puede prescindir de los n√∫meros de cuatro bytes. </font><font style="vertical-align: inherit;">Por lo tanto, nuestro algoritmo se ver√° as√≠:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        ...<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        ...<font></font>
    }<font></font>
    ...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para facilitar la implementaci√≥n, redondearemos la longitud al n√∫mero divisible m√°s cercano por 30. Luego</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ensure length divides by 30</span>
        length = (length + <span class="hljs-number">29</span>) / <span class="hljs-number">30</span> * <span class="hljs-number">30</span>; <font></font>
        Data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length/<span class="hljs-number">30</span>];<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; Data.Length * <span class="hljs-number">30L</span>;<font></font>
<font></font>
    ...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, necesitamos dos matrices: una traduce el √≠ndice 0..29 en el n√∫mero de bit, la segunda, por el contrario, el n√∫mero de bit en la posici√≥n treinta. </font><font style="vertical-align: inherit;">Usando estas matrices y un poco de aritm√©tica de bits, construimos una correspondencia uno a uno entre n√∫meros naturales y bits en la matriz de datos. </font><font style="vertical-align: inherit;">Para simplificar, usamos solo dos m√©todos: IsPrime (n), que le permite averiguar si el n√∫mero es primo, y ClearPrime (n), que establece el bit correspondiente a 0, marcando el n√∫mero n como compuesto:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] BIT_TO_INDEX = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>, <span class="hljs-number">29</span> };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] INDEX_TO_BIT = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] {
        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">1</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">2</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">3</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">4</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">5</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">6</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">7</span>,<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] Data;<font></font>
<font></font>
    ...<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> n == <span class="hljs-number">2</span> || n == <span class="hljs-number">3</span> || n == <span class="hljs-number">5</span>;
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> (Data[n / <span class="hljs-number">30</span>] &amp; (<span class="hljs-number">1</span> &lt;&lt; bit)) != <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<font></font>
        Data[n / <span class="hljs-number">30</span>] &amp;= (<span class="hljs-keyword">byte</span>)~(<span class="hljs-number">1</span> &lt;&lt; bit);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que si el n√∫mero es divisible por 2, 3 o 5, entonces el n√∫mero de bit ser√° -1, lo que significa que el n√∫mero es obviamente compuesto. </font><font style="vertical-align: inherit;">Bueno y, por supuesto, estamos procesando un caso especial n &lt;= 5. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, de hecho, el algoritmo en s√≠, que casi literalmente repite el tamiz de Erat√≥stenes:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        length = (length + <span class="hljs-number">29</span>) / <span class="hljs-number">30</span> * <span class="hljs-number">30</span>;<font></font>
        Data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length / <span class="hljs-number">30</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; Data.Length; i++) Data[i] = <span class="hljs-keyword">byte</span>.MaxValue;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">7</span>; i * i &lt; Length; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!IsPrime(i)) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> d = i * i; d &lt; Length; d += i) ClearPrime(d);<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consecuencia, toda la clase resultante:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiene este aspecto</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] BIT_TO_INDEX = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>, <span class="hljs-number">29</span> };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] INDEX_TO_BIT = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] {
        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">1</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">2</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">3</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">4</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">5</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">6</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">7</span>,<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ensure length divides by 30</span>
        length = (length + <span class="hljs-number">29</span>) / <span class="hljs-number">30</span> * <span class="hljs-number">30</span>;<font></font>
        Data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length / <span class="hljs-number">30</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; Data.Length; i++) Data[i] = <span class="hljs-keyword">byte</span>.MaxValue;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">7</span>; i * i &lt; Length; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!IsPrime(i)) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> d = i * i; d &lt; Length; d += i) ClearPrime(d);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; Data.Length * <span class="hljs-number">30L</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (n &gt;= Length) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Number too big"</span>);
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> n == <span class="hljs-number">2</span> || n == <span class="hljs-number">3</span> || n == <span class="hljs-number">5</span>;
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> (Data[n / <span class="hljs-number">30</span>] &amp; (<span class="hljs-number">1</span> &lt;&lt; bit)) != <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<font></font>
        Data[n / <span class="hljs-number">30</span>] &amp;= (<span class="hljs-keyword">byte</span>)~(<span class="hljs-number">1</span> &lt;&lt; bit);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo hay un peque√±o problema: ¬°este c√≥digo no funciona para n√∫meros mayores de aproximadamente 65 mil millones! </font><font style="vertical-align: inherit;">Cuando intenta iniciarlo con dichos n√∫meros, el programa se bloquea con un error:</font></font><br>
<br>
<pre><code class="plaintext hljs">Unhandled Exception: System.OverflowException: Array dimensions exceeded supported range.
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema es que en las matrices de C # no pueden tener m√°s de 2 ^ 31 elementos (aparentemente porque la implementaci√≥n interna utiliza un √≠ndice de matriz de cuatro bytes). </font><font style="vertical-align: inherit;">Una opci√≥n es crear, por ejemplo, una matriz larga [] en lugar de una matriz byte [], pero esto complicar√° un poco la aritm√©tica de bits. </font><font style="vertical-align: inherit;">Por simplicidad, iremos hacia el otro lado, creando una clase especial que simule la matriz deseada, sosteniendo dos matrices cortas en su interior. </font><font style="vertical-align: inherit;">Al mismo tiempo, le daremos la oportunidad de guardarnos en el disco para que pueda calcular los n√∫meros primos una vez y luego usar la base de datos nuevamente:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">class</span> <span class="hljs-title">LongArray</span><font></font>
    {<font></font>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">long</span> MAX_CHUNK_LENGTH = <span class="hljs-number">2</span>_000_000_000L;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] firstBuffer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] secondBuffer;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LongArray</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
        {<font></font>
            firstBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[Math.Min(MAX_CHUNK_LENGTH, length)];
            <span class="hljs-keyword">if</span> (length &gt; MAX_CHUNK_LENGTH) secondBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length - MAX_CHUNK_LENGTH];<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LongArray</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
        {<font></font>
            ...<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; firstBuffer.LongLength + (secondBuffer == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : secondBuffer.LongLength);<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span> <span class="hljs-keyword">this</span>[<span class="hljs-keyword">long</span> index]<font></font>
        {<font></font>
            <span class="hljs-keyword">get</span> =&gt; index &lt; MAX_CHUNK_LENGTH ? firstBuffer[index] : secondBuffer[index - MAX_CHUNK_LENGTH];
            <span class="hljs-keyword">set</span><font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (index &lt; MAX_CHUNK_LENGTH) firstBuffer[index] = <span class="hljs-keyword">value</span>; 
                <span class="hljs-keyword">else</span> secondBuffer[index - MAX_CHUNK_LENGTH] = <span class="hljs-keyword">value</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
        {<font></font>
            ...<font></font>
        }<font></font>
<font></font>
    }<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, combine todos los pasos en</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versi√≥n final del algoritmo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">Wheel235</span><font></font>
{<font></font>
    <span class="hljs-keyword">class</span> <span class="hljs-title">LongArray</span><font></font>
    {<font></font>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">long</span> MAX_CHUNK_LENGTH = <span class="hljs-number">2</span>_000_000_000L;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] firstBuffer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] secondBuffer;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LongArray</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
        {<font></font>
            firstBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[Math.Min(MAX_CHUNK_LENGTH, length)];
            <span class="hljs-keyword">if</span> (length &gt; MAX_CHUNK_LENGTH) secondBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length - MAX_CHUNK_LENGTH];<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LongArray</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span>(FileStream stream = File.OpenRead(file))<font></font>
            {<font></font>
                <span class="hljs-keyword">long</span> length = stream.Length;<font></font>
                firstBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[Math.Min(MAX_CHUNK_LENGTH, length)];
                <span class="hljs-keyword">if</span> (length &gt; MAX_CHUNK_LENGTH) secondBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[length - MAX_CHUNK_LENGTH];<font></font>
                stream.Read(firstBuffer, <span class="hljs-number">0</span>, firstBuffer.Length);
                <span class="hljs-keyword">if</span>(secondBuffer != <span class="hljs-literal">null</span>) stream.Read(secondBuffer, <span class="hljs-number">0</span>, secondBuffer.Length);<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; firstBuffer.LongLength + (secondBuffer == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : secondBuffer.LongLength);<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span> <span class="hljs-keyword">this</span>[<span class="hljs-keyword">long</span> index]<font></font>
        {<font></font>
            <span class="hljs-keyword">get</span> =&gt; index &lt; MAX_CHUNK_LENGTH ? firstBuffer[index] : secondBuffer[index - MAX_CHUNK_LENGTH];
            <span class="hljs-keyword">set</span><font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (index &lt; MAX_CHUNK_LENGTH) firstBuffer[index] = <span class="hljs-keyword">value</span>; 
                <span class="hljs-keyword">else</span> secondBuffer[index - MAX_CHUNK_LENGTH] = <span class="hljs-keyword">value</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span>(FileStream stream = File.OpenWrite(file))<font></font>
            {<font></font>
                stream.Write(firstBuffer, <span class="hljs-number">0</span>, firstBuffer.Length);
                <span class="hljs-keyword">if</span> (secondBuffer != <span class="hljs-literal">null</span>) stream.Write(secondBuffer, <span class="hljs-number">0</span>, secondBuffer.Length);<font></font>
            }<font></font>
        }<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] BIT_TO_INDEX = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>, <span class="hljs-number">23</span>, <span class="hljs-number">29</span> };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] INDEX_TO_BIT = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] {
        <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">1</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">2</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">3</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">4</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">5</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">6</span>,
        <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">7</span>,<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">private</span> LongArray Data;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> length</span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">// ensure length divides by 30</span>
        length = (length + <span class="hljs-number">29</span>) / <span class="hljs-number">30</span> * <span class="hljs-number">30</span>;<font></font>
        Data = <span class="hljs-keyword">new</span> LongArray(length / <span class="hljs-number">30</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">0</span>; i &lt; Data.Length; i++) Data[i] = <span class="hljs-keyword">byte</span>.MaxValue;<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> i = <span class="hljs-number">7</span>; i * i &lt; Length; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (!IsPrime(i)) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">long</span> d = i * i; d &lt; Length; d += i) ClearPrime(d);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Wheel235</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span><font></font>
    {<font></font>
        Data = <span class="hljs-keyword">new</span> LongArray(file);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Save</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> file</span>)</span> =&gt; Data.Save(file);<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> Length =&gt; Data.Length * <span class="hljs-number">30L</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (n &gt;= Length) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Number too big"</span>);
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> n == <span class="hljs-number">2</span> || n == <span class="hljs-number">3</span> || n == <span class="hljs-number">5</span>;
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> (Data[n / <span class="hljs-number">30</span>] &amp; (<span class="hljs-number">1</span> &lt;&lt; bit)) != <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearPrime</span>(<span class="hljs-params"><span class="hljs-keyword">long</span> n</span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> bit = INDEX_TO_BIT[n % <span class="hljs-number">30</span>];
        <span class="hljs-keyword">if</span> (bit &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<font></font>
        Data[n / <span class="hljs-number">30</span>] &amp;= (<span class="hljs-keyword">byte</span>)~(<span class="hljs-number">1</span> &lt;&lt; bit);<font></font>
    }<font></font>
<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtuvimos una clase que puede calcular n√∫meros primos que no superan los cien mil millones y guardar el resultado en el disco (tuve este c√≥digo en mi computadora port√°til durante 50 minutos; el tama√±o del archivo creado fue de aproximadamente 3 gigabytes, como se esperaba):</font></font><br>
<br>
<pre><code class="cs hljs">        <span class="hljs-keyword">long</span> N = <span class="hljs-number">100</span>_000_000_000L;<font></font>
        Wheel235 wheel = <span class="hljs-keyword">new</span> Wheel235(N);<font></font>
        wheel.Save(<span class="hljs-string">"./primes.dat"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego lea desde el disco y use:</font></font><br>
<br>
<pre><code class="cs hljs">        DateTime start = DateTime.UtcNow;<font></font>
        Wheel235 loaded = <span class="hljs-keyword">new</span> Wheel235(<span class="hljs-string">"./primes.dat"</span>);<font></font>
        DateTime end = DateTime.UtcNow;<font></font>
        Console.WriteLine(<span class="hljs-string">$"Database of prime numbers up to <span class="hljs-subst">{loaded.Length:N0}</span> loaded from file to memory  in <span class="hljs-subst">{end - start}</span>"</span>);
        <span class="hljs-keyword">long</span> number = <span class="hljs-number">98</span>_000_000_093L;<font></font>
        Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{number:N0}</span> is <span class="hljs-subst">{(loaded.IsPrime(number) ? <span class="hljs-string">"prime"</span> : <span class="hljs-string">"not prime"</span>)}</span>!"</span>);
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es504578/index.html">C√≥mo los estadounidenses se convierten en millonarios: principios de fuego</a></li>
<li><a href="../es504582/index.html">HackTheBox. Tutorial resuelto. Rociado de contrase√±a. De DnsAdmin a SYSTEM</a></li>
<li><a href="../es504586/index.html">Innovaciones de ES2020 que realmente me gustan</a></li>
<li><a href="../es504590/index.html">Arquitectura PHP pura. ¬øC√≥mo medirlo y controlarlo?</a></li>
<li><a href="../es504592/index.html">PuppetConf 2016. Kubernetes para administradores de sistemas. Parte 3</a></li>
<li><a href="../es504600/index.html">Lo que le espera a la aerol√≠nea despu√©s de la crisis: la opini√≥n de Warren Buffett</a></li>
<li><a href="../es504602/index.html">Telemetr√≠a ‚Üí m√©tricas libres de voltaje</a></li>
<li><a href="../es504604/index.html">¬øQu√© est√° sucediendo hoy en el mercado de servicios de video?</a></li>
<li><a href="../es504612/index.html">Es posible que no necesite Svelte para reducir su JavaScript</a></li>
<li><a href="../es504622/index.html">Lo que hace de Rust un lenguaje de programaci√≥n universal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>