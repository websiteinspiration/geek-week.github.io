<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äç‚öñÔ∏è ü•Ñ üòä Wulfric Ransomware is a cryptor that doesn't exist üë©‚Äç‚úàÔ∏è üë• üèáüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes one really wants to look into some kind of virus writer and ask: why and why? We will deal with the answer to the question ‚Äúhow‚Äù ourselves, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wulfric Ransomware is a cryptor that doesn't exist</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/drweb/blog/486908/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sometimes one really wants to look into some kind of virus writer and ask: why and why? We will </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deal</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the answer to the question ‚Äúhow‚Äù ourselves, but </font><font style="vertical-align: inherit;">it would be very interesting </font><font style="vertical-align: inherit;">to find out what the </font><font style="vertical-align: inherit;">malware creator </font><s><font style="vertical-align: inherit;">was</font></s><font style="vertical-align: inherit;"> guided by. Especially when we come across such "pearls". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The hero of today's article is an interesting copy of the cryptographer. He thought, apparently, as another ransomware, but its technical implementation is more like someone‚Äôs evil joke. We‚Äôll talk about this implementation today.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, it is practically impossible to trace the life cycle of this encoder - there are too few statistics on it, since, fortunately, it has not received distribution. </font><font style="vertical-align: inherit;">Therefore, we leave out of origin the origin, methods of infection, and other references. </font><font style="vertical-align: inherit;">We will only talk about our case of meeting with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wulfric Ransomware</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and how we helped the user save his files.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I. How it all began</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our anti-virus lab is often contacted by people who have been affected by cryptographers. </font><font style="vertical-align: inherit;">We provide assistance no matter what antivirus products they have installed. </font><font style="vertical-align: inherit;">This time we were approached by a person whose files were struck by an unknown encoder.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good afternoon! </font><font style="vertical-align: inherit;">Files on file storage (samba4) with passwordless entry were encrypted. </font><font style="vertical-align: inherit;">I suspect that the infection went from my daughter's computer (Windows 10 with native Windows Defender protection). </font><font style="vertical-align: inherit;">The daughter‚Äôs computer was not turned on after that. </font><font style="vertical-align: inherit;">Files are mainly encrypted .jpg and .cr2. </font><font style="vertical-align: inherit;">File extension after encryption: .aef.</font></font></blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We received from the user samples of encrypted files, a ransom note and a file, which is probably the key that the encryption author needs to decrypt the files. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all our leads:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">01c.aef (4481K) </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hacked.jpg (254K) </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hacked.txt (0K) </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">04c.aef (6540K) </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pass.key (0K) </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a look at the note. </font><font style="vertical-align: inherit;">How many bitcoins this time? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfer:</font></font></b><br>
<blockquote>,   !<br>
    .<br>
<br>
  0.05 BTC  -: 1ERtRjWAKyG2Edm9nKLLCzd8p1CjjdTiF<br>
    ,   pass.key  Wulfric@gmx.com    .<br>
<br>
       .<br>
<br>
      :<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">buy.blockexplorer.com</a> ‚Äî   <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.buybitcoinworldwide.com</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">localbitcoins.net</a><br>
<br>
 :<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">en.wikipedia.org/wiki/Bitcoin</a><br>
    - ,    Wulfric@gmx.com<br>
    ,          .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pathos wolf, designed to show the victim the seriousness of the situation. </font><font style="vertical-align: inherit;">However, it could have been worse. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nn/e9/_s/nne9_svoarapfsjf2yajkqb9c84.jpeg"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">1. -As a bonus, I will tell you how to protect your computer in the future. </font><font style="vertical-align: inherit;">‚ÄìSeems legit.</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">II. </font><font style="vertical-align: inherit;">Getting to work</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we looked at the structure of the sent sample. Oddly enough, it did not look like a file that suffered from an encryptor. We open the hex editor and look. The first 4 bytes contain the original file size, the next 60 bytes are filled with zeros. But the most interesting is at the end: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0u/ej/nq/0uejnqz2z2-r770dvhba1u90no0.jpeg"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 2 Analyze the damaged file. What immediately catches your eye?</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Everything turned out to be offensively simple: 0x40 bytes from the header were moved to the end of the file. To recover data, simply return them to the beginning. Access to the file was restored, but the name remained encrypted, and with it everything is more complicated. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4e/m3/ht/4em3htrjjmfvb4xwspngahu_61w.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 3. The encrypted name in Base64 looks like an incoherent character set.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Let's try to parse </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pass.key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sent by user. In it we see a 162-byte character sequence in ASCII. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n6/v0/c0/n6v0c0yosdvlv3gdh3ubgxj4ggy.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 4. 162 characters left on the victim's PC.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If you look closely, you will notice that the characters are repeated with a certain frequency. This may indicate the use of XOR, where repetitions are characteristic, the frequency of which depends on the length of the key. Having broken a line of 6 characters and performed with some variants of XOR sequences, we did not achieve any meaningful result. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/gp/vq/3cgpvqvoieizntwut0pk8g2pczo.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 5. See duplicate constants in the middle?</font></font></b> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We decided to google the constants, because yes, that‚Äôs also possible! And all of them eventually led to one algorithm - Batch Encryption. After studying the script, it became clear that our line is nothing but the result of its work. It should be mentioned that this is not an encryptor at all, but only an encoder replacing characters with 6-byte sequences. No keys or other secrets for you :( </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bv/ln/ej/bvlnejuy9fwyzjlofrrfi1rpuoi.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 6. A piece of the original algorithm of unknown authorship.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The algorithm would not work as it should, if not for one detail: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xk/oc/qz/xkocqz5aldw_y5sthecwwumvyqo.jpeg"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 7. Morpheus approved.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Using reverse substitution, we turn the string from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pass.key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> into text of 27 characters. Of particular note is the human (most likely) text 'asmodat'. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hj/0a/gd/hj0agdeqdmzzwzyob5skbrnr8rq.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 8. USGFDG = 7.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google will help us again. After a short search, we find an interesting project on GitHub - Folder Locker, written in .Net and using the 'asmodat' library from another account on the Gita. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/zz/qz/pnzzqzct6wwxs6gks6rwwjgrthk.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 9. Folder Locker interface. Be sure to check for malware.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The utility is an encryptor for Windows 7 and above, which is distributed open source. When encrypting, the password required for subsequent decryption is used. Allows you to work with individual files as well as with entire directories. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Her library uses the symmetric Rijndael encryption algorithm in CBC mode. It is noteworthy that the block size was chosen equal to 256 bits - in contrast to that adopted in the AES standard. In the latter, the size is limited to 128 bits.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our key is formed according to the PBKDF2 standard. </font><font style="vertical-align: inherit;">In this case, the password is SHA-256 from the line entered in the utility. </font><font style="vertical-align: inherit;">It remains only to find this line to form the decryption key. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, back to our already decoded </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pass.key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Remember that line with a set of numbers and the text 'asmodat'? </font><font style="vertical-align: inherit;">We try to use the first 20 bytes of the string as the password for the Folder Locker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Look, it works! </font><font style="vertical-align: inherit;">The code word came up, and everything was perfectly deciphered. </font><font style="vertical-align: inherit;">Judging by the password characters, this is a HEX representation of a specific word in ASCII. </font><font style="vertical-align: inherit;">Let's try to display the code word in text form. </font><font style="vertical-align: inherit;">We get ' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shadowwolf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '. </font><font style="vertical-align: inherit;">Already feeling the symptoms of lycanthropy? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take another look at the structure of the affected file, now knowing the mechanism of the locker:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">02 00 00 00 - name encryption mode;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">58 00 00 00 - length of the file name encrypted and encoded in base64;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40 00 00 00 - the size of the transferred title.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The encrypted name itself and the transferred title, respectively, are highlighted in red and yellow. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lc/4x/cn/lc4xcnocaus9bh9e3hgezu9_pka.jpeg"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">10. The encrypted name is highlighted in red, the transferred title is yellow. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now compare the encrypted and decrypted names in hexadecimal representation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The structure of the decrypted data:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">78 B9 B8 2E - garbage created by the utility (4 bytes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 00 00 00 - length of the decrypted name (12 bytes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">next comes the actual file name and padding with zeros to the desired block length (padding).</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/tt/ad/kj/ttadkjqsidbzxibbzfghqp60eee.jpeg"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">11. IMG_4114 looks much better.</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">III. </font><font style="vertical-align: inherit;">Conclusions and Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Returning to the beginning. We do not know what the author of Wulfric.Ransomware was guided by and what purpose he pursued. Of course, for the average user, the result of even such an encryptor will seem like a big disaster. Files do not open. All names are gone. Instead of the usual picture - a wolf on the screen. They make me read about bitcoins. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
True, this time under the guise of a ‚Äúterrible encoder‚Äù was hidden such an absurd and stupid attempt to extort, where an attacker uses ready-made programs and leaves the keys right at the scene of the crime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Speaking of keys. We didn‚Äôt have a malicious script or trojan to understand how this </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pass.key originated</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the mechanism for the appearance of the file on the infected PC remains unknown. </font><font style="vertical-align: inherit;">But, I remember, in his note, the author mentioned the uniqueness of the password. </font><font style="vertical-align: inherit;">So, the code word for decryption is as unique as the shadow wolf username is unique :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And yet, shadow wolf, why and why?</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486890/index.html">Self-development: how I did not sit on two chairs and found a third</a></li>
<li><a href="../en486892/index.html">Contact Picker API, or how to share your contacts with a browser</a></li>
<li><a href="../en486896/index.html">UID and Stalker Authorization on the MAG250</a></li>
<li><a href="../en486902/index.html">Protocol Oriented Programming in Swift 5.1</a></li>
<li><a href="../en486904/index.html">Showing developers the status of quality control of source code in SonarQube</a></li>
<li><a href="../en486912/index.html">Lowkiq. Why did we do it?</a></li>
<li><a href="../en486914/index.html">8. Fortinet Getting Started v6.0. Work with users</a></li>
<li><a href="../en486918/index.html">Emacs - 6 Productivity Tricks</a></li>
<li><a href="../en486920/index.html">How to make a step-by-step guide of your application (if your project is on Angular)</a></li>
<li><a href="../en486922/index.html">Scrum Community Meetup at Raiffeisenbank</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>