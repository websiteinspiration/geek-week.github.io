<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤝 🥂 📱 Panduan pengembangan layanan backend Python 🦄 🌐 💆🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hai, nama saya Alexander Vasin, saya pengembang backend di Edadil. Gagasan materi ini dimulai dengan fakta bahwa saya ingin mengurai tugas pengantar (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Panduan pengembangan layanan backend Python</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/499534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hai, nama saya Alexander Vasin, saya pengembang backend di Edadil. Gagasan materi ini dimulai dengan fakta bahwa saya ingin mengurai tugas pengantar ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya.Disk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ke dalam Sekolah </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">Pengembangan Backend</font></a><font style="vertical-align: inherit;"> Yandex. Saya mulai menggambarkan semua seluk-beluk pilihan teknologi tertentu, metodologi pengujian ... Ternyata tidak ada analisis sama sekali, tetapi panduan yang sangat rinci tentang cara menulis backend dengan Python. Dari ide aslinya, hanya persyaratan layanan yang tersisa, misalnya, yang nyaman untuk membongkar alat dan teknologi. Akibatnya, saya terbangun dengan seratus ribu karakter. Sangat banyak yang diperlukan untuk mempertimbangkan semuanya dengan sangat terperinci. Jadi, program untuk 100 kilobyte berikutnya: bagaimana membangun backend layanan, dari pilihan alat hingga penyebaran. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/sz/r2/pmszr288srjaplio0w_utpnb4ym.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ini adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perwakilan GitHub dengan aplikasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan yang menyukai longread (nyata) - tolong, di bawah kucing.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan mengembangkan dan menguji layanan REST API dengan Python, mengemasnya dalam wadah Docker yang ringan dan menggunakannya menggunakan Ansible.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat mengimplementasikan layanan REST API dengan berbagai cara menggunakan alat yang berbeda. </font><font style="vertical-align: inherit;">Solusi yang dijelaskan bukan satu-satunya yang tepat, saya memilih implementasi dan alat berdasarkan pengalaman dan preferensi pribadi saya.</font></font></blockquote><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang kita lakukan?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alat apa yang harus dipilih?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengembangan</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa Anda harus mulai dengan setup.py?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana cara menentukan versi ketergantungan?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basis data</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami merancang skema</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jelaskan skema dalam SQLAlchemy</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sesuaikan Alembic</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menghasilkan migrasi</font></font></a></li>
</ul></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aplikasi</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serialisasi data</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penangan</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / impor</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / warga</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / impor / $ import_id / warga negara / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / warga negara / ulang tahun</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / kota / stat / persentil / usia</font></font></a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengujian</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penangan</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / warga</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / impor</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / impor / $ import_id / warga negara / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / warga negara / ulang tahun</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / kota / stat / persentil / usia</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrasi</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Majelis</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyebarkan</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengujian Stres</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa lagi yang bisa dilakukan?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akhirnya</font></font></a></li>
</ul><br>
<a name="task"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang kita lakukan?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bayangkan bahwa toko suvenir online berencana untuk meluncurkan tindakan di berbagai wilayah. </font><font style="vertical-align: inherit;">Agar strategi penjualan efektif, analisis pasar diperlukan. </font><font style="vertical-align: inherit;">Toko memiliki pemasok yang secara teratur mengirim (misalnya, melalui pos) data bongkar dengan informasi tentang penduduk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita kembangkan layanan API Python REST yang akan menganalisis data yang disediakan dan mengidentifikasi permintaan hadiah dari penduduk dari berbagai kelompok umur di berbagai kota berdasarkan bulan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menerapkan penangan berikut dalam layanan:</font></font><br>
<br>
<ul>
<li> <code>POST /imports</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menambahkan unggahan baru dengan data;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengembalikan penghuni tempat pembuangan yang ditentukan;</font></font><br>
 </li>
<li> <code>PATCH /imports/$import_id/citizens/$citizen_id</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengubah informasi tentang penduduk (dan kerabatnya) dalam bongkar yang ditentukan;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens/birthdays</code><br>
  ,        ( ),   ;<br>
 </li>
<li> <code>GET /imports/$import_id/towns/stat/percentile/age</code><br>
 50-, 75-  99-   ( )      .<br>
 </li>
</ul><br>
<a name="tools"></a><h1>  ?</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, kami menulis layanan dalam Python menggunakan kerangka kerja yang umum, perpustakaan dan DBMS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 kuliah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kursus video, berbagai DBMS dan fiturnya dijelaskan. Untuk implementasi saya, saya memilih </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DBMS </font><font style="vertical-align: inherit;">, yang telah memantapkan dirinya sebagai solusi yang dapat diandalkan dengan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dokumentasi yang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sangat baik </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">di Rusia</font></a><font style="vertical-align: inherit;"> , komunitas Rusia yang kuat (Anda selalu dapat menemukan jawaban untuk pertanyaan dalam bahasa Rusia), dan bahkan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kursus gratis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Model relasional cukup fleksibel dan dipahami dengan baik oleh banyak pengembang. Meskipun hal yang sama dapat dilakukan pada DBMS NoSQL apa pun, pada artikel ini kami akan mempertimbangkan PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tujuan utama dari layanan ini - pengiriman data melalui jaringan antara database dan klien - tidak menyiratkan beban yang besar pada prosesor, tetapi membutuhkan kemampuan untuk memproses beberapa permintaan sekaligus. Dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 kuliah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dianggap pendekatan tidak sinkron. Ini memungkinkan Anda untuk secara efisien melayani banyak klien dalam proses OS yang sama (tidak seperti, misalnya, model pre-fork yang digunakan dalam Flask / Django, yang menciptakan beberapa proses untuk memproses permintaan dari pengguna, masing-masing dari mereka mengkonsumsi memori, tetapi sebagian besar waktu menganggur) ) Oleh karena itu, sebagai perpustakaan untuk menulis layanan, saya memilih </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asinkron </font><font style="vertical-align: inherit;">. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">Kuliah ke</font></a><font style="vertical-align: inherit;"> 
- </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">5 dari</font></a><font style="vertical-align: inherit;"> kursus video mengatakan bahwa </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">SQLAlchemy</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/or/rj/pn/orrjpnx6upvsipcqbsql7f36vzc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memungkinkan Anda untuk menguraikan kueri kompleks menjadi beberapa bagian, menggunakannya kembali, menghasilkan kueri dengan seperangkat bidang dinamis (misalnya, prosesor PATCH memungkinkan pembaruan sebagian penduduk dengan bidang arbitrer) dan fokus langsung pada logika bisnis. Pengemudi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpg dapat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menangani permintaan ini dan mentransfer data dengan tercepat </font><font style="vertical-align: inherit;">, dan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpgsa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> akan membantu mereka berteman </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alat favorit saya untuk mengelola keadaan basis data dan bekerja dengan migrasi adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ngomong-ngomong, saya baru-baru ini membicarakannya di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moscow Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Logika validasi dijelaskan secara ringkas oleh skema </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marshmallow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (termasuk cek untuk ikatan keluarga). Menggunakan modul </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp-spec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya menautkan aiohttp-handler dan skema untuk validasi data, dan bonusnya adalah menghasilkan dokumentasi dalam format </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan menampilkannya dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antarmuka grafis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk tes menulis, saya memilih </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lebih banyak tentangnya dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 kuliah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk debug dan profil proyek ini, saya menggunakan debugger PyCharm ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kuliah 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 kuliah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menjelaskan bagaimana komputer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (atau bahkan pada OS yang berbeda) dapat berjalan dikemas tanpa harus menyesuaikan lingkungan aplikasi untuk memulai dan mudah untuk menginstal / memperbarui / menghapus aplikasi di server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk penyebaran, saya memilih </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ini memungkinkan Anda untuk mendeskripsikan keadaan server dan layanannya secara deklaratif, bekerja melalui ssh dan tidak memerlukan perangkat lunak khusus.</font></font><br>
<br>
<a name="development"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengembangan</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memutuskan untuk memberi nama paket Python </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan menggunakan struktur berikut: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ly/wt/oxlywtje20xt5ceou8pbtfp8an8.png" width="550"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam file </font></font><code>analyzer/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">saya memposting informasi umum tentang paket: deskripsi ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docstring</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), versi, lisensi, kontak pengembang.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itu dapat dilihat dengan bantuan bawaan</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python<font></font>
&gt;&gt;&gt; import analyzer<font></font>
&gt;&gt;&gt; <span class="hljs-built_in">help</span>(analyzer)<font></font>
<font></font>
Help on package analyzer:<font></font>
<font></font>
NAME<font></font>
    analyzer<font></font>
<font></font>
DESCRIPTION<font></font>
      REST API,    .<font></font>
<font></font>
PACKAGE CONTENTS<font></font>
    api (package)<font></font>
    db (package)<font></font>
    utils (package)<font></font>
<font></font>
DATA<font></font>
    __all__ = (<span class="hljs-string">'__author__'</span>, <span class="hljs-string">'__email__'</span>, <span class="hljs-string">'__license__'</span>, <span class="hljs-string">'__maintainer__'</span>,...<font></font>
    __email__ = <span class="hljs-string">'alvassin@yandex.ru'</span>
    __license__ = <span class="hljs-string">'MIT'</span>
    __maintainer__ = <span class="hljs-string">'Alexander Vasin'</span><font></font>
<font></font>
VERSION<font></font>
    0.0.1<font></font>
<font></font>
AUTHOR<font></font>
    Alexander Vasin<font></font>
<font></font>
FILE<font></font>
    /Users/alvassin/Work/backendschool2019/analyzer/__init__.py</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket ini memiliki dua titik input - layanan REST API ( </font></font><code>analyzer/api/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) dan utilitas manajemen status basis data ( </font></font><code>analyzer/db/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">File dipanggil </font></font><code>__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">karena suatu alasan - pertama, nama seperti itu menarik perhatian, memperjelas bahwa file tersebut adalah titik masuk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kedua, berkat pendekatan ini ke titik masuk </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>     python -m</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># REST API</span>
$ python -m analyzer.api --<span class="hljs-built_in">help</span><font></font>
<font></font>
<span class="hljs-comment">#    </span>
$ python -m analyzer.db --<span class="hljs-built_in">help</span></code></pre><br>
<a name="setuppy"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa Anda harus mulai dengan setup.py?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ke depan, kami akan memikirkan cara mendistribusikan aplikasi: itu dapat dikemas ke dalam arsip zip (serta roda / telur), paket rpm, file pkg untuk macOS dan diinstal pada komputer jarak jauh, di mesin virtual, MacBook atau Docker- wadah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tujuan utama dari file </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>setup.py</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ini adalah untuk menggambarkan paket dengan aplikasi untuk </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
File harus berisi informasi umum tentang paket (nama, versi, penulis, dll.), Tetapi juga di dalamnya Anda dapat menentukan modul yang diperlukan untuk pekerjaan, dependensi “ekstra” (misalnya, untuk pengujian), titik masuk (misalnya, perintah yang dapat dieksekusi ) dan persyaratan untuk juru bahasa. </font><font style="vertical-align: inherit;">
Plugin Setuptools memungkinkan Anda untuk mengumpulkan artefak dari paket yang dijelaskan. Ada plugin bawaan: zip, egg, rpm, macOS pkg. Plugin yang tersisa didistribusikan melalui PyPI: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">wheel</font></a><font style="vertical-align: inherit;"> ,</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">distutils</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">setuptools</a></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada intinya, menggambarkan satu file, kita mendapatkan peluang besar. </font><font style="vertical-align: inherit;">Itulah sebabnya pengembangan proyek baru harus dimulai </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam fungsinya, </font></font><code>setup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modul dependen ditunjukkan oleh daftar:</font></font><br>
<br>
<pre><code class="python hljs">setup(..., install_requires=[<span class="hljs-string">"aiohttp"</span>, <span class="hljs-string">"SQLAlchemy"</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi saya menggambarkan dependensi dalam file terpisah </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang isinya digunakan </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Tampaknya lebih fleksibel bagi saya, ditambah ada rahasia: nanti akan memungkinkan Anda untuk membangun gambar Docker lebih cepat. </font><font style="vertical-align: inherit;">Dependensi akan ditetapkan sebagai langkah terpisah sebelum menginstal aplikasi itu sendiri, dan ketika membangun kembali wadah Docker, itu ada dalam cache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dapat membaca dependensi dari file </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, fungsinya ditulis:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perlu dicatat bahwa </font></font><code>setuptools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ketika default distribusi sumber perakitan hanya mencakup file perakitan </font></font><code>.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.cpp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Untuk file dependensi </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tekan tas, mereka harus ditentukan dengan jelas dalam file </font></font><code>MANIFEST.in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setup.py seluruhnya</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> importlib.machinery <span class="hljs-keyword">import</span> SourceFileLoader<font></font>
<font></font>
<span class="hljs-keyword">from</span> pkg_resources <span class="hljs-keyword">import</span> parse_requirements
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
module_name = <span class="hljs-string">'analyzer'</span><font></font>
<font></font>
<span class="hljs-comment"># ,     (   ), </span>
<span class="hljs-comment">#   __init__.py   machinery.</span><font></font>
module = SourceFileLoader(<font></font>
    module_name, os.path.join(module_name, <span class="hljs-string">'__init__.py'</span>)<font></font>
).load_module()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements<font></font>
<font></font>
setup(<font></font>
    name=module_name,<font></font>
    version=module.__version__,<font></font>
    author=module.__author__,<font></font>
    author_email=module.__email__,<font></font>
    license=module.__license__,<font></font>
    description=module.__doc__,<font></font>
    long_description=open(<span class="hljs-string">'README.rst'</span>).read(),<font></font>
    url=<span class="hljs-string">'https://github.com/alvassin/backendschool2019'</span>,<font></font>
    platforms=<span class="hljs-string">'all'</span>,<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Intended Audience :: Developers'</span>,
        <span class="hljs-string">'Natural Language :: Russian'</span>,
        <span class="hljs-string">'Operating System :: MacOS'</span>,
        <span class="hljs-string">'Operating System :: POSIX'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.8'</span>,
        <span class="hljs-string">'Programming Language :: Python :: Implementation :: CPython'</span><font></font>
    ],<font></font>
    python_requires=<span class="hljs-string">'&gt;=3.8'</span>,<font></font>
    packages=find_packages(exclude=[<span class="hljs-string">'tests'</span>]),<font></font>
    install_requires=load_requirements(<span class="hljs-string">'requirements.txt'</span>),<font></font>
    extras_require={<span class="hljs-string">'dev'</span>: load_requirements(<span class="hljs-string">'requirements.dev.txt'</span>)},<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-comment"># f-strings  setup.py   - </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-comment">#   ,     Python 3.8, </span>
            <span class="hljs-comment"># source distribution       </span>
            <span class="hljs-comment">#   Python.     </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-string">'{0}-api = {0}.api.__main__:main'</span>.format(module_name),
            <span class="hljs-string">'{0}-db = {0}.db.__main__:main'</span>.format(module_name)<font></font>
        ]<font></font>
    },<font></font>
    include_package_data=<span class="hljs-literal">True</span>
)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat menginstal proyek dalam mode pengembangan menggunakan perintah berikut (dalam mode yang dapat diedit, Python tidak akan menginstal seluruh paket dalam folder </font></font><code>site-packages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tetapi hanya membuat tautan, sehingga setiap perubahan yang dibuat pada file paket akan segera terlihat):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      extra- "dev"</span>
pip install -e <span class="hljs-string">'.[dev]'</span><font></font>
<font></font>
<span class="hljs-comment">#      </span>
pip install -e .</code></pre><br>
<a name="requirements"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana cara menentukan versi ketergantungan?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sangat bagus ketika pengembang secara aktif mengerjakan paket mereka - bug sedang diperbaiki secara aktif di dalamnya, fungsionalitas baru muncul dan umpan balik dapat diperoleh lebih cepat. Tetapi kadang-kadang perubahan dalam pustaka tergantung tidak kompatibel ke belakang dan dapat menyebabkan kesalahan dalam aplikasi Anda jika Anda tidak memikirkannya sebelumnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk setiap paket dependen, Anda dapat menentukan versi tertentu, misalnya </font></font><code>aiohttp==3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kemudian aplikasi akan dijamin akan dibangun secara khusus dengan versi pustaka dependen yang dengannya ia diuji. Tetapi pendekatan ini memiliki kelemahan - jika pengembang memperbaiki bug kritis dalam paket dependen yang tidak mempengaruhi kompatibilitas ke belakang, perbaikan ini tidak akan masuk ke dalam aplikasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada pendekatan untuk versi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semantic Versioning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang menyarankan pengiriman versi dalam format </font></font><code>MAJOR.MINOR.PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - meningkat ketika perubahan yang tidak kompatibel mundur ditambahkan;</font></font></li>
<li><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Meningkat ketika menambahkan fungsionalitas baru dengan dukungan untuk kompatibilitas mundur;</font></font></li>
<li><code>PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - meningkat ketika menambahkan perbaikan bug dengan dukungan kompatibilitas mundur.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika paket tergantung berikut pendekatan ini (yang penulis biasanya dilaporkan dalam file README dan CHANGELOG), itu sudah cukup untuk memperbaiki nilai </font></font><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan untuk membatasi nilai minimum untuk PATCH-versi: </font></font><code>&gt;= MAJOR.MINOR.PATCH, == MAJOR.MINOR.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Persyaratan seperti itu dapat diimplementasikan menggunakan operator </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ =</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Misalnya, ini </font></font><code>aiohttp~=3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan memungkinkan PIP untuk menginstal untuk </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versi 3.6.3, tetapi tidak 3.7. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda menentukan interval versi dependensi, ini akan memberikan satu keuntungan lagi - tidak akan ada konflik versi antara pustaka dependen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda mengembangkan pustaka yang memerlukan paket dependensi berbeda, maka izinkan untuk itu bukan satu versi spesifik, tetapi sebuah interval. </font><font style="vertical-align: inherit;">Maka akan jauh lebih mudah bagi pengguna perpustakaan Anda untuk menggunakannya (tiba-tiba aplikasi mereka membutuhkan paket ketergantungan yang sama, tetapi dari versi yang berbeda). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semantic Versioning hanyalah perjanjian antara penulis dan konsumen paket. </font><font style="vertical-align: inherit;">Itu tidak menjamin bahwa penulis menulis kode tanpa bug dan tidak dapat membuat kesalahan dalam versi baru paket mereka.</font></font><br>
<br>
<a name="db"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basis data</font></font></h2><br>
<a name="dbstructure"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami merancang skema</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deskripsi POST / import handler memberikan contoh pembongkaran dengan informasi tentang penduduk:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unggah Contoh</font></font></b>
                        <div class="spoiler_text"><pre><code class="json hljs">{
  <span class="hljs-attr">"citizens"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"26.12.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">2</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"01.04.1997"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">1</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"2"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">11</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"23.11.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"female"</span>,
      <span class="hljs-attr">"relatives"</span>: []<font></font>
    },<font></font>
    ...<font></font>
  ]<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pikiran pertama adalah untuk menyimpan semua informasi tentang penduduk dalam satu tabel </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, di mana hubungan tersebut akan diwakili oleh bidang </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bentuk daftar bilangan bulat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetapi metode ini memiliki beberapa kelemahan</font></font></b>
                        <div class="spoiler_text"><ol>
<li>   <code>GET /imports/$import_id/citizens/birthdays</code>   ,      ,     <code>citizens</code>   .          <code>relatives</code>    <code>UNNEST</code>.<br>
<br>
     ,  <b>    10- </b>:<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
    relations.citizen_id, <font></font>
    relations.relative_id, <font></font>
    date_part(<span class="hljs-string">'month'</span>, relatives.birth_date) <span class="hljs-keyword">as</span> relative_birth_month
<span class="hljs-keyword">FROM</span> (
	<span class="hljs-keyword">SELECT</span><font></font>
        citizens.import_id, <font></font>
        citizens.citizen_id,<font></font>
        <span class="hljs-keyword">UNNEST</span>(citizens.relatives) <span class="hljs-keyword">as</span> relative_id
	<span class="hljs-keyword">FROM</span> citizens
    <span class="hljs-keyword">WHERE</span> import_id = <span class="hljs-number">1</span>
) <span class="hljs-keyword">as</span> relations
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> citizens <span class="hljs-keyword">as</span> relatives <span class="hljs-keyword">ON</span>
    relations.import_id = relatives.import_id <span class="hljs-keyword">AND</span><font></font>
    relations.relative_id = relatives.citizen_id<font></font>
</code></pre><br>
 </li>
<li>    <b>    <code>relatives</code>   PostgreSQL</b>,   :    <code>relatives</code>     ,      .       (     )         .</li>
</ol></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, saya memutuskan untuk membawa semua data yang diperlukan untuk pekerjaan ke </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bentuk normal ketiga</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan struktur berikut diperoleh:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/pf/px/dipfpxxw142kafiect0yhrtt4uo.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tabel </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> terdiri dari kolom yang bertambah secara otomatis </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Diperlukan untuk membuat pemeriksaan kunci asing di tabel </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tabel </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">warga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menyimpan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data skalar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tentang penduduk (semua bidang kecuali informasi tentang hubungan keluarga). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sepasang ( </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">digunakan sebagai kunci utama </font><font style="vertical-align: inherit;">, menjamin keunikan penghuni </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam kerangka kerja </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kunci asing </font></font><code>citizens.import_id -&gt; imports.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memastikan bahwa bidang </font></font><code>citizens.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hanya berisi pembongkaran yang ada.</font></font><br>
 </li>
<li>  <b>relations</b>    <b> </b>. <br>
<br>
<b>     </b> (     ):           <code>citizens</code>  <code>relations</code>     .<br>
     (<code>import_id</code>, <code>citizen_id</code>, <code>relative_id</code>)  ,      <code>import_id</code>   <code>citizen_id</code>   c  <code>relative_id</code>. <br>
<br>
       : <code>(relations.import_id, relations.citizen_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>  <code>(relations.import_id, relations.relative_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>, ,        <code>citizen_id</code>   <code>relative_id</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Struktur ini memastikan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integritas data menggunakan PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , memungkinkan Anda untuk secara </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">efisien mendapatkan penghuni dengan kerabat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari database, tetapi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tunduk pada kondisi balapan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saat memperbarui informasi tentang penghuni dengan pertanyaan kompetitif (kami akan melihat lebih dekat pada implementasi penangan PATCH).</font></font><br>
<br>
<a name="do_sqlalchemy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jelaskan skema dalam SQLAlchemy</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bab 5,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saya berbicara tentang cara membuat kueri menggunakan SQLAlchemy, Anda perlu menjelaskan skema basis data menggunakan objek khusus: tabel diuraikan menggunakan </font></font><code>sqlalchemy.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan terikat ke registri </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang menyimpan semua meta-informasi tentang database. By the way, registri </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak hanya dapat menyimpan meta-informasi yang dijelaskan dalam Python, tetapi juga mewakili keadaan sebenarnya dari database dalam bentuk objek SQLAlchemy. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fitur ini juga memungkinkan Alembic untuk membandingkan kondisi dan membuat kode migrasi secara otomatis.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Omong-omong, setiap database memiliki skema penamaan kendala standar sendiri. </font><font style="vertical-align: inherit;">Agar Anda tidak membuang waktu menyebutkan batasan baru atau mencari / mengingat kendala apa yang akan Anda hapus, SQLAlchemy menyarankan menggunakan pola </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">penamaan konvensi penamaan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mereka dapat didefinisikan dalam registri </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat registri MetaData dan berikan pola penamaan padanya</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> MetaData<font></font>
<font></font>
convention = {<font></font>
    <span class="hljs-string">'all_column_names'</span>: <span class="hljs-keyword">lambda</span> constraint, table: <span class="hljs-string">'_'</span>.join([<font></font>
        column.name <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> constraint.columns.values()<font></font>
    ]),<font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-string">'ix'</span>: <span class="hljs-string">'ix__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'uq'</span>: <span class="hljs-string">'uq__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#  CHECK-constraint-</span>
    <span class="hljs-string">'ck'</span>: <span class="hljs-string">'ck__%(table_name)s__%(constraint_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'fk'</span>: <span class="hljs-string">'fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'pk'</span>: <span class="hljs-string">'pk__%(table_name)s'</span><font></font>
}<font></font>
metadata = MetaData(naming_convention=convention)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda menentukan pola penamaan, Alembic akan menggunakannya selama generasi migrasi otomatis dan akan memberi nama semua kendala sesuai dengan mereka. </font><font style="vertical-align: inherit;">Di masa depan, registri yang dibuat </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan diminta untuk menggambarkan tabel:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menggambarkan skema database dengan objek SQLAlchemy</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<font></font>
<font></font>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> (<font></font>
    Column, Date, Enum <span class="hljs-keyword">as</span> PgEnum, ForeignKey, ForeignKeyConstraint, Integer,<font></font>
    String, Table<font></font>
)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@unique</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gender</span>(<span class="hljs-params">Enum</span>):</span>
    female = <span class="hljs-string">'female'</span>
    male = <span class="hljs-string">'male'</span><font></font>
<font></font>
<font></font>
imports_table = Table(<font></font>
    <span class="hljs-string">'imports'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>)<font></font>
)<font></font>
<font></font>
citizens_table = Table(<font></font>
    <span class="hljs-string">'citizens'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, ForeignKey(<span class="hljs-string">'imports.import_id'</span>),<font></font>
           primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'town'</span>, String, nullable=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'street'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'building'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'apartment'</span>, Integer, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'name'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'birth_date'</span>, Date, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'gender'</span>, PgEnum(Gender, name=<span class="hljs-string">'gender'</span>), nullable=<span class="hljs-literal">False</span>),<font></font>
)<font></font>
<font></font>
relations_table = Table(<font></font>
    <span class="hljs-string">'relations'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'relative_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'citizen_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'relative_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
)<font></font>
</code></pre></div>
                    </div><br>
<a name="db_alembic"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sesuaikan Alembic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika skema database dijelaskan, perlu untuk menghasilkan migrasi, tetapi untuk ini Anda harus terlebih dahulu mengkonfigurasi Alembic, yang juga dibahas dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bab 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menggunakan perintah </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Anda harus melakukan langkah-langkah berikut:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instal Paket: </font></font><code>pip install alembic</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialize Alembic: </font></font><code>cd analyzer &amp;&amp; alembic init db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perintah ini akan membuat file konfigurasi </font></font><code>analyzer/alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan folder </font></font><code>analyzer/db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan konten berikut:</font></font><br>
 <ul>
<li> <code>env.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Dipanggil setiap kali Anda memulai Alembic. </font><font style="vertical-align: inherit;">Terhubung ke registri Alembic </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan deskripsi kondisi database yang diinginkan dan berisi instruksi untuk memulai migrasi.</font></font><br>
 </li>
<li><code>script.py.mako</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - templat berdasarkan migrasi yang dihasilkan.</font></font></li>
<li><code>versions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - folder tempat Alembic akan mencari (dan menghasilkan) migrasi.</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tentukan alamat database dalam file alembic.ini:</font></font><br>
<br>
<pre><code class="plaintext hljs">; analyzer/alembic.ini<font></font>
[alembic] <font></font>
sqlalchemy.url = postgresql://user:hackme@localhost/analyzer</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentukan deskripsi kondisi database (registri </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) yang </font><font style="vertical-align: inherit;">diinginkan </font><font style="vertical-align: inherit;">sehingga Alembic dapat menghasilkan migrasi secara otomatis:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/alembic/env.py</span>
<span class="hljs-keyword">from</span> analyzer.db <span class="hljs-keyword">import</span> schema<font></font>
target_metadata = schema.metadata</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic sudah dikonfigurasi dan sudah bisa digunakan, tetapi dalam kasus kami konfigurasi ini memiliki beberapa kelemahan:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilitas </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mencari </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di direktori kerja saat ini. </font><font style="vertical-align: inherit;">Anda </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dapat menentukan </font><font style="vertical-align: inherit;">jalur ke </font><font style="vertical-align: inherit;">argumen baris perintah, tetapi ini tidak nyaman: Saya ingin dapat memanggil perintah dari folder apa pun tanpa parameter tambahan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk mengonfigurasi Alembic agar berfungsi dengan database tertentu, Anda perlu mengubah file </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Akan jauh lebih mudah untuk menentukan pengaturan basis data untuk variabel lingkungan dan / atau argumen baris perintah, misalnya </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nama utilitas </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak berkorelasi sangat baik dengan nama layanan kami (dan pengguna mungkin sebenarnya tidak memiliki Python sama sekali dan tidak tahu apa-apa tentang Alembic). </font><font style="vertical-align: inherit;">Akan jauh lebih nyaman bagi pengguna akhir jika semua perintah layanan yang dapat dieksekusi memiliki awalan umum, misalnya </font></font><code>analyzer-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalah-masalah ini diselesaikan dengan pembungkus kecil. </font></font><code>analyzer/db/__main__.py:</code><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic menggunakan modul standar untuk memproses argumen baris perintah </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">argparse</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ini memungkinkan Anda untuk menambahkan argumen opsional </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan nilai default dari variabel lingkungan </font></font><code>ANALYZER_PG_URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    alembic.parser.add_argument(<font></font>
        <span class="hljs-string">'--pg-url'</span>, default=os.getenv(<span class="hljs-string">'ANALYZER_PG_URL'</span>, DEFAULT_PG_URL),<font></font>
        help=<span class="hljs-string">'Database URL [env var: ANALYZER_PG_URL]'</span><font></font>
    )<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#   sqlalchemy.url   Alembic</span>
    config.set_main_option(<span class="hljs-string">'sqlalchemy.url'</span>, options.pg_url)<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jalur ke file </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dapat dihitung relatif terhadap lokasi file yang dapat dieksekusi, dan bukan direktori kerja pengguna saat ini.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<font></font>
<font></font>
<font></font>
PROJECT_PATH = Path(__file__).parent.parent.resolve()<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#     (alembic.ini),   </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(options.config):<font></font>
        options.config = os.path.join(PROJECT_PATH, options.config)<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#      alembic   (,  alembic</span>
    <span class="hljs-comment">#   env.py,       )</span>
    alembic_location = config.get_main_option(<span class="hljs-string">'script_location'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(alembic_location):<font></font>
        config.set_main_option(<span class="hljs-string">'script_location'</span>,<font></font>
                               os.path.join(PROJECT_PATH, alembic_location))<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilitas untuk mengelola keadaan basis data</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> siap, ia dapat didaftarkan </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebagai perintah yang dapat dieksekusi dengan nama yang dapat dimengerti oleh pengguna akhir, misalnya </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Daftarkan perintah yang dapat dieksekusi di setup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup<font></font>
<font></font>
setup(..., entry_points={<font></font>
    <span class="hljs-string">'console_scripts'</span>: [
        <span class="hljs-string">'analyzer-db = analyzer.db.__main__:main'</span><font></font>
    ]<font></font>
})<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menginstal ulang modul, file akan dibuat </font></font><code>env/bin/analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan perintah </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan tersedia:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip install -e <span class="hljs-string">'.[dev]'</span></code></pre><br>
<a name="db_alembic_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menghasilkan migrasi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menghasilkan migrasi, diperlukan dua status: diinginkan (yang kami jelaskan dengan objek SQLAlchemy) dan nyata (database, dalam kasus kami, kosong). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memutuskan bahwa cara termudah untuk meningkatkan Postgres dengan Docker adalah menambahkan perintah </font></font><code>make postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang menjalankan sebuah wadah dengan PostgreSQL di port 5432 di latar belakang:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Naikkan PostgreSQL dan hasilkan migrasi</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ make postgres<font></font>
...<font></font>
$ analyzer-db revision --message=<span class="hljs-string">"Initial"</span> --autogenerate<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'imports'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'citizens'</span>
INFO  [alembic.autogenerate.compare] Detected added index <span class="hljs-string">'ix__citizens__town'</span> on <span class="hljs-string">'['</span>town<span class="hljs-string">']'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'relations'</span>
  Generating /Users/alvassin/Work/backendschool2019/analyzer/db/alembic/versions/d5f704ed4610_initial.py ...  <span class="hljs-keyword">done</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic umumnya melakukan pekerjaan yang baik dari pekerjaan rutin menghasilkan migrasi, tapi saya ingin menarik perhatian sebagai berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipe data pengguna yang ditentukan dalam tabel yang dibuat dibuat secara otomatis (dalam kasus kami - </font></font><code>gender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), tetapi kode untuk menghapusnya </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak dihasilkan. </font><font style="vertical-align: inherit;">Jika Anda menerapkan, memutar kembali, dan kemudian menerapkan migrasi lagi, ini akan menyebabkan kesalahan karena tipe data yang ditentukan sudah ada.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hapus tipe data gender dalam metode downgrade</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic <span class="hljs-keyword">import</span> op
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Enum<font></font>
<font></font>
GenderType = Enum(<span class="hljs-string">'female'</span>, <span class="hljs-string">'male'</span>, name=<span class="hljs-string">'gender'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span>():</span><font></font>
    ...<font></font>
    <span class="hljs-comment">#      GenderType   </span>
    op.create_table(<span class="hljs-string">'citizens'</span>, ...,<font></font>
                    Column(<span class="hljs-string">'gender'</span>, GenderType, nullable=<span class="hljs-literal">False</span>))<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
    op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
<font></font>
    <span class="hljs-comment">#       </span>
    GenderType.drop(op.get_bind())</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam metode ini, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beberapa tindakan terkadang dapat dihapus (jika kami menghapus seluruh tabel, Anda tidak dapat menghapus indeksnya secara terpisah):</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contohnya</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
op.drop_table(<span class="hljs-string">'relations'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      citizens,    </span>
<span class="hljs-comment">#    </span>
op.drop_index(op.f(<span class="hljs-string">'ix__citizens__town'</span>), table_name=<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'imports'</span>)</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat migrasi diperbaiki dan siap, kami menerapkannya:</font></font><br>
<br>
<pre><code class="bash hljs">$ analyzer-db upgrade head<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.runtime.migration] Running upgrade  -&gt; d5f704ed4610, Initial</code></pre><br>
<a name="application"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aplikasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum Anda mulai membuat penangan, Anda harus mengonfigurasi aplikasi aiohttp.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika Anda melihat aiohttp quickstart, Anda dapat menulis sesuatu seperti ini</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    logging.basicConfig(level=logging.DEBUG)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = web.Application()<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app.router.add_route(...)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    web.run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode ini menimbulkan sejumlah pertanyaan dan memiliki sejumlah kelemahan:</font></font><br>
<br>
<ul>
<li> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana cara mengkonfigurasi aplikasi? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minimal, Anda harus menentukan host dan port untuk menghubungkan klien, serta informasi untuk menghubungkan ke database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya benar-benar ingin menyelesaikan masalah ini dengan bantuan modul </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>ConfigArgParse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: ia memperluas yang standar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>argparse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan memungkinkan menggunakan argumen baris perintah, variabel lingkungan (sangat diperlukan untuk mengkonfigurasi wadah Docker) dan bahkan file konfigurasi (serta menggabungkan metode ini) untuk konfigurasi. </font><font style="vertical-align: inherit;">Dengan menggunakannya </font></font><code>ConfigArgParse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Anda juga dapat memvalidasi nilai parameter konfigurasi aplikasi.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contoh pemrosesan parameter menggunakan ConfigArgParse</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser, ArgumentDefaultsHelpFormatter<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.argparse <span class="hljs-keyword">import</span> positive_int<font></font>
<font></font>
parser = ArgumentParser(<font></font>
    <span class="hljs-comment">#        ANALYZER_,</span>
    <span class="hljs-comment">#  ANALYZER_API_ADDRESS  ANALYZER_API_PORT</span>
    auto_env_var_prefix=<span class="hljs-string">'ANALYZER_'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#     </span><font></font>
    formatter_class=ArgumentDefaultsHelpFormatter<font></font>
)<font></font>
<font></font>
parser.add_argument(<span class="hljs-string">'--api-address'</span>, default=<span class="hljs-string">'0.0.0.0'</span>,<font></font>
                    help=<span class="hljs-string">'IPv4/IPv6 address API server would listen on'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
parser.add_argument(<span class="hljs-string">'--api-port'</span>, type=positive_int, default=<span class="hljs-number">8081</span>,<font></font>
                    help=<span class="hljs-string">'TCP port API server would listen on'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#   ,     </span>
    <span class="hljs-comment">#  ,    </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#       </span><font></font>
    app = web.Application()<font></font>
    web.run_app(app, host=args.api_address, port=args.api_port)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div><br>
, <code>ConfigArgParse</code>,   <code>argparse</code>,           (     <code>-h</code>  <code>--help</code>).       :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python __main__.py --<span class="hljs-built_in">help</span><font></font>
usage: __main__.py [-h] [--api-address API_ADDRESS] [--api-port API_PORT]<font></font>
<font></font>
If an arg is specified <span class="hljs-keyword">in</span> more than one place, <span class="hljs-keyword">then</span> commandline values override environment variables <span class="hljs-built_in">which</span> override defaults.<font></font>
<font></font>
optional arguments:<font></font>
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><font></font>
  --api-address API_ADDRESS<font></font>
                        IPv4/IPv6 address API server would listen on [env var: ANALYZER_API_ADDRESS] (default: 0.0.0.0)<font></font>
  --api-port API_PORT   TCP port API server would listen on [env var: ANALYZER_API_PORT] (default: 8081)</code></pre></div>
                    </div></li>
<li>             — ,    «»     .          ,  <strong>     </strong>. <br>
<br>
    <code>os.environ.clear()</code>,  Python            (,      <code>asyncio</code>?),        ,   <code>ConfigArgParser</code>.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Callable
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
ENV_VAR_PREFIX = <span class="hljs-string">'ANALYZER_'</span><font></font>
<font></font>
parser = ArgumentParser(auto_env_var_prefix=ENV_VAR_PREFIX)<font></font>
parser.add_argument(<span class="hljs-string">'--pg-url'</span>, type=URL, default=URL(DEFAULT_PG_URL),<font></font>
                   help=<span class="hljs-string">'URL to use to connect to the database'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_environ</span>(<span class="hljs-params">rule: Callable</span>):</span>
    <span class="hljs-string">"""
      ,     
     rule
    """</span>
    <span class="hljs-comment">#   os.environ    tuple,    </span>
    <span class="hljs-comment"># os.environ   </span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> filter(rule, tuple(os.environ)):<font></font>
        os.environ.pop(name)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#      ANALYZER_</span>
    clear_environ(<span class="hljs-keyword">lambda</span> i: i.startswith(ENV_VAR_PREFIX))<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = create_app(args)<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li> <strong>   stderr/      .</strong><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> 9</a> ,    <code>logging.basicConfig()</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>   stderr</code></a>.<br>
<br>
       ,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a>   aiomisc.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    aiomisc</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiomisc.log <span class="hljs-keyword">import</span> basic_config<font></font>
<font></font>
basic_config(logging.DEBUG, buffered=<span class="hljs-literal">True</span>)    
</code></pre></div>
                    </div></li>
<li> <strong>  ,     </strong>    ?    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>fork</code></a>     ,           (,  Windows   ).<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<font></font>
<font></font>
<span class="hljs-keyword">import</span> forklib
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket
<span class="hljs-keyword">from</span> setproctitle <span class="hljs-keyword">import</span> setproctitle<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8081</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
    setproctitle(<span class="hljs-string">f'[Master] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span>
        setproctitle(<span class="hljs-string">f'[Worker] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
        app = Application()<font></font>
        run_app(app, sock=sock)<font></font>
<font></font>
    forklib.fork(os.cpu_count(), worker, auto_restart=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre></div>
                    </div></li>
<li>    <strong>   -    </strong>?  ,      (   —    )    ,      <code>nobody</code>.      —     .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pwd<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8085</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
<font></font>
    user = pwd.getpwnam(<span class="hljs-string">'nobody'</span>)<font></font>
    os.setgid(user.pw_gid)<font></font>
    os.setuid(user.pw_uid)<font></font>
<font></font>
    app = create_app(...)<font></font>
    run_app(app, sock=sock)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li>            <code>create_app</code>,         .</li>
</ul><br>
<a name="serialization"></a><h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua respons penangan yang berhasil akan dikembalikan dalam format JSON. </font><font style="vertical-align: inherit;">Akan lebih mudah bagi klien untuk menerima informasi tentang kesalahan dalam bentuk serial (misalnya, untuk melihat bidang mana yang tidak lulus validasi). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dokumentasi </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menawarkan metode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://docs.aio"><code>json_response</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang mengambil objek, membuat serialisasi dalam JSON, dan mengembalikan objek baru </font></font><code>aiohttp.web.Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan header </font></font><code>Content-Type: application/json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan data serial di dalamnya.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana cara membuat cerita bersambung data menggunakan json_response</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, View, run_app
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> json_response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> json_response({<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi ada cara lain: aiohttp memungkinkan Anda untuk mendaftarkan serializer yang sewenang-wenang untuk jenis data respons tertentu dalam registri </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Misalnya, Anda bisa menentukan serializer </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk objek-objek tipe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pemetaan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, itu akan cukup bagi pawang untuk mengembalikan objek </font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan data respons dalam parameter </font></font><code>body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">aiohttp akan menemukan serializer yang cocok dengan tipe data dan membuat serialisasi respons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain fakta bahwa serialisasi objek dideskripsikan di satu tempat, pendekatan ini juga lebih fleksibel - memungkinkan Anda untuk mengimplementasikan solusi yang sangat menarik (kami akan mempertimbangkan salah satu case use di handler </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara membuat cerita bersambung data menggunakan aiohttp.PAYLOAD_REGISTRY</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Mapping<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> PAYLOAD_REGISTRY, JsonPayload
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app, Application, Response, View<font></font>
<font></font>
PAYLOAD_REGISTRY.register(JsonPayload, (Mapping, MappingProxyType))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Response(body={<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penting untuk memahami bahwa </font></font><code>json_response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, seperti </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mereka menggunakan </font><font style="vertical-align: inherit;">metode </font><font style="vertical-align: inherit;">standar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>json.dumps</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang tidak dapat membuat serial tipe data yang kompleks, misalnya, </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atau </font></font><code>asyncpg.Record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>asyncpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengembalikan catatan dari database sebagai instance dari kelas ini). </font><font style="vertical-align: inherit;">Selain itu, beberapa objek kompleks mungkin berisi yang lain: dalam satu catatan dari database mungkin ada bidang tipe </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengembang Python telah mengatasi masalah ini: metode ini </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memungkinkan Anda menggunakan argumen </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk menentukan fungsi yang dipanggil saat perlu membuat serial objek yang tidak dikenal. </font><font style="vertical-align: inherit;">Fungsi ini diharapkan untuk melemparkan objek asing ke tipe yang dapat membuat serial modul json.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana cara memperpanjang JsonPayload untuk membuat serial objek yang sewenang-wenang</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, singledispatch
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.payload <span class="hljs-keyword">import</span> JsonPayload <span class="hljs-keyword">as</span> BaseJsonPayload
<span class="hljs-keyword">from</span> aiohttp.typedefs <span class="hljs-keyword">import</span> JSONEncoder<font></font>
<font></font>
<span class="hljs-meta">@singledispatch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span>(<span class="hljs-params">value</span>):</span>
    <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">f'Unserializable value: <span class="hljs-subst">{value!r}</span>'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(Record)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_asyncpg_record</span>(<span class="hljs-params">value: Record</span>):</span>
    <span class="hljs-string">"""
        , 
    asyncpg
    """</span>
    <span class="hljs-keyword">return</span> dict(value)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(date)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date</span>(<span class="hljs-params">value: date</span>):</span>
    <span class="hljs-string">"""
       date      —  
      .     
      ..
    """</span>
    <span class="hljs-keyword">return</span> value.strftime(<span class="hljs-string">'%d.%m.%Y'</span>)<font></font>
    <font></font>
 <font></font>
dumps = partial(json.dumps, default=convert)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonPayload</span>(<span class="hljs-params">BaseJsonPayload</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,
                 value: Any,
                 encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 dumps: JSONEncoder = dumps,
                 *args: Any,
                 **kwargs: Any</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        super().__init__(value, encoding, content_type, dumps, *args, **kwargs)</code></pre></div>
                    </div><br>
<a name="handlers"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penangan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aiohttp memungkinkan Anda menerapkan penangan dengan fungsi dan kelas asinkron. </font><font style="vertical-align: inherit;">Kelas lebih dapat diperluas: pertama, kode milik satu penangan dapat ditempatkan di satu tempat, dan kedua, kelas memungkinkan Anda menggunakan warisan untuk menyingkirkan duplikasi kode (misalnya, setiap penangan memerlukan koneksi basis data).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kelas Dasar Handler</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_urldispatcher <span class="hljs-keyword">import</span> View
<span class="hljs-keyword">from</span> asyncpgsa <span class="hljs-keyword">import</span> PG<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>(<span class="hljs-params">View</span>):</span><font></font>
    URL_PATH: str<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pg</span>(<span class="hljs-params">self</span>) -&gt; PG:</span>
        <span class="hljs-keyword">return</span> self.request.app[<span class="hljs-string">'pg'</span>]
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena sulit membaca satu file besar, saya memutuskan untuk membagi penangan menjadi file. </font><font style="vertical-align: inherit;">File kecil mendorong konektivitas yang lemah, dan jika, misalnya, ada impor cincin di dalam handler, itu berarti ada sesuatu yang salah dengan komposisi entitas.</font></font><br>
<br>
<a name="imports_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / impor</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang input menerima json dengan data tentang penghuni. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ukuran permintaan maksimum yang diizinkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam aiohttp dikendalikan oleh opsi </font></font><code>client_max_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=http://docs.aiohttp.org/en/stable/web_reference.html&amp;usg=ALkJrhg5YpAmK3ZbToTVk8QI3CO4BWb7iQ#aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 MB secara default</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Jika batas terlampaui, aiohttp akan mengembalikan respons HTTP dengan status 413: Request Entity Too Large Error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat yang sama, json yang benar dengan garis dan angka terpanjang akan berbobot ~ 63 megabita, sehingga pembatasan pada ukuran permintaan perlu diperluas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, Anda perlu </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memeriksa dan membatalkan registrasi data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Jika salah, Anda harus mengembalikan respons HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya membutuhkan dua skema </font></font><code>Marhsmallow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Yang pertama </font></font><code>CitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, memeriksa data dari masing-masing penduduk, dan juga membatalkan deserialisasi string selamat ulang tahun ke objek </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jenis data, format, dan ketersediaan semua bidang yang diperlukan;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurangnya bidang yang tidak dikenal;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tanggal lahir harus ditunjukkan dalam format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan tidak boleh penting dari masa depan;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Daftar kerabat masing-masing penduduk harus berisi pengidentifikasi unik dari penduduk yang ada dalam unggahan ini.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skema kedua </font></font><code>ImportSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,, memeriksa pembongkaran secara keseluruhan:</font></font><br>
<br>
<ul>
<li><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> setiap penduduk dalam bongkar muat harus unik;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ikatan keluarga harus dua arah (jika residen # 1 memiliki residen # 2 dalam daftar kerabat, maka residen # 2 juga harus memiliki kerabat # 1).</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika data benar, mereka harus ditambahkan ke database</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan yang unik baru </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menambahkan data, Anda perlu melakukan beberapa permintaan di tabel yang berbeda. </font><font style="vertical-align: inherit;">Untuk menghindari sebagian data yang ditambahkan sebagian dalam database jika terjadi kesalahan atau pengecualian (misalnya, ketika memutuskan koneksi klien yang tidak menerima respons penuh, aiohttp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=http://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan membuang pengecualian CancelledError</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda harus menggunakan transaksi</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penting untuk menambahkan data ke tabel di bagian-bagian</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , karena dalam satu permintaan ke PostgreSQL tidak boleh ada lebih dari 32.767 argumen. </font><font style="vertical-align: inherit;">Ada </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 bidang </font><font style="vertical-align: inherit;">dalam tabel </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Oleh karena itu, untuk 1 permintaan, hanya 32.767 / 9 = 3.640 baris dapat dimasukkan ke dalam tabel ini, dan dalam satu unggahan bisa ada hingga 10.000 penduduk.</font></font><br>
<br>
<a name="citizens_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / warga</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang mengembalikan semua penghuni untuk diturunkan dengan yang ditentukan </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Jika </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unggahan yang</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ditentukan </font><b><font style="vertical-align: inherit;">tidak ada</font></b><font style="vertical-align: inherit;"> , Anda harus mengembalikan respons HTTP 404: Not Found. </font><font style="vertical-align: inherit;">Perilaku ini tampaknya umum untuk penangan yang membutuhkan pembongkaran yang ada, jadi saya menarik kode verifikasi ke kelas yang terpisah.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kelas dasar untuk penangan dengan pembongkaran</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_exceptions <span class="hljs-keyword">import</span> HTTPNotFound
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, exists<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> imports_table<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseImportView</span>(<span class="hljs-params">BaseView</span>):</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> int(self.request.match_info.get(<span class="hljs-string">'import_id'</span>))<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_import_exists</span>(<span class="hljs-params">self</span>):</span><font></font>
        query = select([<font></font>
            exists().where(imports_table.c.import_id == self.import_id)<font></font>
        ])<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">await</span> self.pg.fetchval(query):
            <span class="hljs-keyword">raise</span> HTTPNotFound()
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mendapatkan daftar kerabat untuk setiap penduduk, Anda harus melakukan </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dari meja </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ke meja </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mengumpulkan bidang yang </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dikelompokkan oleh </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika penduduk tidak memiliki kerabat, maka ia </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan mengembalikan </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nilai </font><font style="vertical-align: inherit;">untuknya di lapangan </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan, sebagai hasil dari agregasi, daftar kerabat akan terlihat seperti </font></font><code>[NULL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memperbaiki nilai yang salah ini, saya menggunakan fungsi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_remove</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basis data menyimpan tanggal dalam format </font></font><code>YYYY-MM-DD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tetapi kami membutuhkan format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara teknis, Anda bisa memformat tanggal baik dengan kueri SQL atau di sisi Python pada saat serialisasi respons dengan </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(asyncpg mengembalikan nilai bidang </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebagai turunan dari kelas</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memilih serialisasi di sisi Python, mengingat bahwa itu </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adalah satu-satunya objek </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam proyek dengan format tunggal (lihat bagian </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Serialisasi Data"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terlepas dari kenyataan bahwa prosesor mengeksekusi dua permintaan (memeriksa keberadaan bongkar dan permintaan untuk daftar penduduk), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak perlu menggunakan transaksi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Secara default, PostgreSQL menggunakan tingkat isolasi, </font></font><code>READ COMMITTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan bahkan dalam satu transaksi semua perubahan ke yang lain, transaksi yang berhasil diselesaikan akan terlihat (menambahkan baris baru, mengubah yang sudah ada).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unggahan terbesar dalam tampilan teks dapat memakan waktu ~ 63 megabita - ini cukup banyak, terutama mengingat beberapa permintaan untuk menerima data dapat tiba pada saat yang bersamaan. </font><font style="vertical-align: inherit;">Ada cara yang agak menarik </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk mendapatkan data dari database menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kursor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan mengirimkannya ke klien dalam beberapa bagian</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk melakukan ini, kita perlu mengimplementasikan dua objek:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipe </font><font style="vertical-align: inherit;">objek </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang mengembalikan catatan dari database. </font><font style="vertical-align: inherit;">Pada panggilan pertama, terhubung ke database, membuka transaksi dan membuat kursor, selama iterasi lebih lanjut, ia mengembalikan catatan dari database. </font><font style="vertical-align: inherit;">Itu dikembalikan oleh pawang.</font></font><br>
 <br>
 <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pilih Kode Kueri</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> AsyncIterable
<span class="hljs-keyword">from</span> asyncpgsa.transactionmanager <span class="hljs-keyword">import</span> ConnectionTransactionContextManager
<span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> Select<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectQuery</span>(<span class="hljs-params">AsyncIterable</span>):</span>
    <span class="hljs-string">"""
    ,     PostgreSQL   
    ,  ,    
    """</span>
    PREFETCH = <span class="hljs-number">500</span><font></font>
<font></font>
    __slots__ = (<font></font>
        <span class="hljs-string">'query'</span>, <span class="hljs-string">'transaction_ctx'</span>, <span class="hljs-string">'prefetch'</span>, <span class="hljs-string">'timeout'</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query: Select,
                 transaction_ctx: ConnectionTransactionContextManager,
                 prefetch: int = None,
                 timeout: float = None</span>):</span><font></font>
        self.query = query<font></font>
        self.transaction_ctx = transaction_ctx<font></font>
        self.prefetch = prefetch <span class="hljs-keyword">or</span> self.PREFETCH<font></font>
        self.timeout = timeout<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.transaction_ctx <span class="hljs-keyword">as</span> conn:<font></font>
            cursor = conn.cursor(self.query, prefetch=self.prefetch,<font></font>
                                 timeout=self.timeout)<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
                <span class="hljs-keyword">yield</span> row
</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serializer </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang dapat beralih melalui generator asinkron, membuat serialisasi data dari generator asinkron ke JSON dan mengirim data ke klien di beberapa bagian. </font><font style="vertical-align: inherit;">Terdaftar </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebagai serializer objek </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode AsyncGenJSONListPayload</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> Payload<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># ,    JSON  asyncpg.Record  datetime.date</span>
dumps = partial(json.dumps, default=convert, ensure_ascii=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncGenJSONListPayload</span>(<span class="hljs-params">Payload</span>):</span>
    <span class="hljs-string">"""
       AsyncIterable,     
     JSON   
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 root_object: str = <span class="hljs-string">'data'</span>,
                 *args, **kwargs</span>):</span><font></font>
        self.root_object = root_object<font></font>
        super().__init__(value, content_type=content_type, encoding=encoding,<font></font>
                         *args, **kwargs)<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">self, writer</span>):</span>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<font></font>
            (<span class="hljs-string">'{"%s":['</span> % self.root_object).encode(self._encoding)<font></font>
        )<font></font>
<font></font>
        first = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> self._value:
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> first:
                <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b','</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                first = <span class="hljs-literal">False</span><font></font>
<font></font>
            <span class="hljs-keyword">await</span> writer.write(dumps(row).encode(self._encoding))<font></font>
<font></font>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b']}'</span>)</code></pre></div>
                    </div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lebih lanjut, dalam handler akan dimungkinkan untuk membuat objek </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, meneruskan kueri SQL dan fungsinya untuk membuka transaksi, dan mengembalikannya ke </font></font><code>Response body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode penangan</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/api/handlers/citizens.py</span>
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> aiohttp_apispec <span class="hljs-keyword">import</span> docs, response_schema<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.schema <span class="hljs-keyword">import</span> CitizensResponseSchema
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> citizens_table <span class="hljs-keyword">as</span> citizens_t
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> SelectQuery<font></font>
<font></font>
<span class="hljs-keyword">from</span> .query <span class="hljs-keyword">import</span> CITIZENS_QUERY
<span class="hljs-keyword">from</span> .base <span class="hljs-keyword">import</span> BaseImportView<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CitizensView</span>(<span class="hljs-params">BaseImportView</span>):</span>
    URL_PATH = <span class="hljs-string">r'/imports/{import_id:\d+}/citizens'</span><font></font>
<font></font>
<span class="hljs-meta">    @docs(summary='    ')</span>
<span class="hljs-meta">    @response_schema(CitizensResponseSchema())</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">await</span> self.check_import_exists()<font></font>
<font></font>
        query = CITIZENS_QUERY.where(<font></font>
            citizens_t.c.import_id == self.import_id<font></font>
        )<font></font>
        body = SelectQuery(query, self.pg.transaction())<font></font>
        <span class="hljs-keyword">return</span> Response(body=body)
</code></pre></div>
                    </div><br>
<code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mendeteksi </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serializer </font><font style="vertical-align: inherit;">terdaftar </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk objek-objek tipe </font><font style="vertical-align: inherit;">dalam registri </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kemudian serializer akan beralih di atas objek </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan mengirim data ke klien. Pada panggilan pertama, objek </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menerima koneksi ke database, membuka transaksi dan membuat kursor, selama iterasi lebih lanjut, ia akan menerima data dari database dengan kursor dan mengembalikannya baris demi baris. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendekatan ini memungkinkan untuk tidak mengalokasikan memori untuk seluruh jumlah data dengan setiap permintaan, tetapi memiliki kekhasan: aplikasi tidak akan dapat mengembalikan status HTTP yang sesuai ke klien jika kesalahan terjadi (setelah semua, status HTTP, header sudah dikirim ke klien, dan data sedang ditulis).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika pengecualian terjadi, tidak ada yang tersisa selain memutuskan koneksi. </font><font style="vertical-align: inherit;">Pengecualian, tentu saja, dapat diamankan, tetapi klien tidak akan dapat memahami dengan tepat kesalahan apa yang terjadi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sisi lain, situasi serupa mungkin muncul bahkan jika prosesor menerima semua data dari database, tetapi jaringan berkedip saat mentransmisikan data ke klien - tidak ada yang aman dari ini.</font></font><br>
<br>
<a name="update_citizen_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / impor / $ import_id / warga negara / $ citizen_id</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang menerima pengidentifikasi pembongkaran </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, residen </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, serta json dengan data baru tentang residen. </font><font style="vertical-align: inherit;">Dalam hal </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bongkar muat atau penduduk yang tidak ada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , respons HTTP harus dikembalikan </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data yang dikirimkan oleh klien harus </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diverifikasi dan deserialized</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jika salah, Anda harus mengembalikan respons HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Saya menerapkan skema Marshmallow </font></font><code>PatchCitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang memeriksa:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jenis dan format data untuk bidang yang ditentukan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tanggal lahir. </font><font style="vertical-align: inherit;">Itu harus ditentukan dalam format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan tidak bisa penting dari masa depan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Daftar kerabat masing-masing penduduk. </font><font style="vertical-align: inherit;">Itu harus memiliki pengidentifikasi unik untuk penduduk.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keberadaan kerabat yang ditunjukkan di lapangan </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak dapat diperiksa secara terpisah: jika </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">penduduk yang tidak ada </font><font style="vertical-align: inherit;">ditambahkan ke tabel, </font><font style="vertical-align: inherit;">PostgreSQL akan mengembalikan kesalahan </font></font><code>ForeignKeyViolationError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang dapat diproses dan status HTTP dapat dikembalikan </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Status apa yang harus dikembalikan jika klien mengirim </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data yang salah untuk penduduk atau pembongkaran yang tidak ada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? Secara semantik lebih tepat untuk memeriksa terlebih dahulu keberadaan bongkar dan penduduk (jika tidak ada, kembali </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) dan hanya kemudian apakah klien telah mengirim data yang benar (jika tidak, kembali </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Dalam praktiknya, seringkali lebih murah untuk memeriksa data terlebih dahulu, dan hanya jika mereka benar, akses database.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kedua opsi dapat diterima, tetapi saya memutuskan untuk memilih opsi kedua yang lebih murah, karena dalam hal apapun hasil operasi adalah kesalahan yang tidak mempengaruhi apa-apa (klien akan memperbaiki data dan kemudian juga mengetahui bahwa penduduk tidak ada). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika datanya benar, maka perlu </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memperbarui informasi tentang penduduk di basis data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Di handler, Anda perlu membuat beberapa query ke tabel yang berbeda. Jika terjadi kesalahan atau pengecualian, perubahan pada basis data harus dibatalkan, sehingga </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kueri harus dilakukan dalam transaksi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metode ini </font></font><code>PATCH</code> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memungkinkan Anda untuk mentransfer hanya beberapa bidang</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk penduduk.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang harus ditulis sedemikian rupa sehingga tidak macet saat mengakses data yang tidak ditentukan klien, dan juga tidak menjalankan kueri pada tabel di mana data tidak berubah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika klien menentukan bidang </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, perlu untuk mendapatkan daftar kerabat yang ada. Jika sudah berubah, tentukan catatan mana dari tabel yang </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">harus dihapus dan yang mana yang ditambahkan untuk membuat basis data sejalan dengan permintaan klien. Secara default, PostgreSQL menggunakan isolasi transaksi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code> READ COMMITTED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ini berarti bahwa sebagai bagian dari transaksi saat ini, perubahan akan terlihat oleh catatan yang ada (dan juga yang baru) dari transaksi yang diselesaikan lainnya. Ini dapat menyebabkan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kondisi balapan antara permintaan kompetitif</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalkan ada bongkar muat dengan penghuni</font></font><code>#1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>#2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>#3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tanpa kekerabatan. Layanan menerima dua permintaan secara bersamaan untuk mengubah penduduk # 1: </font></font><code><nobr>{"relatives": [2]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code><nobr>{"relatives": [3]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. aiohttp akan membuat dua penangan yang secara bersamaan menerima status residen saat ini dari PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap handler tidak akan mendeteksi hubungan terkait tunggal dan akan memutuskan untuk menambahkan hubungan baru dengan kerabat yang ditentukan. Akibatnya, penduduk # 1 memiliki bidang yang sama dengan kerabat </font></font><code>[2,3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/bk/mz/gobkmzuhzr47rfzgvtygkxb1stm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perilaku ini tidak bisa disebut jelas. Ada dua opsi yang diharapkan untuk memutuskan hasil balapan: untuk menyelesaikan hanya permintaan pertama, dan untuk yang kedua untuk mengembalikan respons HTTP </font></font><br>
<code>409: Conflict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(sehingga klien mengulangi permintaan), atau untuk mengeksekusi permintaan pada gilirannya (permintaan kedua akan diproses hanya setelah yang pertama selesai). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Opsi pertama dapat diterapkan dengan menyalakan mode isolasi</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>SERIALIZABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Jika selama pemrosesan permintaan seseorang sudah berhasil mengubah dan mengkomit data, pengecualian akan dilempar, yang dapat diproses dan status HTTP yang sesuai dikembalikan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kerugian dari solusi ini - sejumlah besar kunci di PostgreSQL, </font></font><code>SERIALIZABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan mengeluarkan pengecualian, bahkan jika pertanyaan kompetitif mengubah catatan penghuni dari pembongkaran yang berbeda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda juga dapat menggunakan mekanisme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kunci rekomendasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Jika Anda mendapatkan kunci seperti itu </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, permintaan kompetitif untuk pembongkaran yang berbeda akan dapat berjalan secara paralel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memproses permintaan kompetitif dalam satu unggahan, Anda dapat menerapkan perilaku salah satu opsi: fungsi </font></font><code>pg_try_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mencoba mendapatkan kunci dan</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mengembalikan hasil boolean segera (jika itu tidak mungkin untuk mendapatkan kunci - pengecualian dapat dilemparkan), tetapi </font></font><code>pg_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menunggu sampai </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sumber daya tersedia untuk diblokir (dalam hal ini, permintaan akan dieksekusi secara berurutan, saya memilih opsi ini). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, pawang harus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengembalikan informasi saat ini tentang penduduk yang diperbarui</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dimungkinkan untuk membatasi diri untuk mengembalikan data dari permintaannya kepada klien (karena kami mengembalikan respons kepada klien, itu berarti bahwa tidak ada pengecualian dan semua permintaan berhasil diselesaikan). Atau - gunakan kata kunci RETURNING dalam kueri yang memodifikasi database dan menghasilkan respons dari hasil. Tetapi kedua pendekatan ini tidak akan memungkinkan kami untuk melihat dan menguji kasus ini dengan ras negara.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak ada persyaratan beban tinggi untuk layanan ini, jadi saya memutuskan untuk meminta semua data tentang residen lagi dan mengembalikan klien hasil yang jujur ​​dari database. </font></font><br>
<br>
<a name="citizen_birthdays_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / warga negara / ulang tahun</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang menghitung jumlah hadiah yang akan diberikan oleh masing-masing penduduk bongkar kepada kerabatnya (urutan pertama). </font><font style="vertical-align: inherit;">Jumlahnya dikelompokkan berdasarkan bulan untuk diunggah dengan yang ditentukan </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dalam hal </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unggahan yang tidak ada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , respons HTTP harus dikembalikan </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada dua opsi implementasi:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dapatkan data untuk penghuni yang memiliki kerabat dari basis data, dan di sisi Python, gabungkan data berdasarkan bulan dan buat daftar untuk bulan-bulan yang tidak ada datanya di dalam basis data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kompilasi permintaan json di database dan tambahkan bertopik untuk bulan-bulan yang hilang.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memilih opsi pertama - secara visual terlihat lebih mudah dimengerti dan didukung. Jumlah ulang tahun di bulan tertentu dapat diperoleh dengan membuat </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dari tabel dengan ikatan keluarga ( </font></font><code>relations.citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- penduduk yang kami anggap sebagai hari ulang tahun kerabat) ke dalam tabel </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(berisi tanggal lahir dari mana Anda ingin mendapatkan bulan). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nilai bulan tidak boleh mengandung angka nol di depan. Bulan yang diperoleh dari lapangan </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menggunakan fungsi </font></font><code>date_part</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dapat berisi nol di depan. Untuk menghapusnya, saya tampil </font></font><code>cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk </font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam query SQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terlepas dari kenyataan bahwa pawang harus memenuhi dua permintaan (periksa keberadaan bongkar muat dan dapatkan informasi tentang ulang tahun dan hadiah), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transaksi tidak diperlukan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara default, PostgreSQL menggunakan mode READ COMMITTED, di mana semua catatan baru (ditambahkan oleh transaksi lain) dan yang sudah ada (dimodifikasi oleh transaksi lain) terlihat dalam transaksi saat ini setelah mereka berhasil diselesaikan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, jika unggahan baru ditambahkan pada saat menerima data, itu tidak akan memengaruhi yang sudah ada. </font><font style="vertical-align: inherit;">Jika pada saat penerimaan data, permintaan untuk mengubah penduduk dieksekusi, apakah data tersebut belum akan terlihat (jika transaksi mengubah data belum selesai), atau transaksi akan selesai sepenuhnya dan semua perubahan akan segera terlihat. </font><font style="vertical-align: inherit;">Integritas yang diperoleh dari basis data tidak akan dilanggar.</font></font><br>
<br>
<a name="town_age_stat_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / kota / stat / persentil / usia</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang menghitung persentil ke-50, ke-75 dan ke-99 dari usia (tahun penuh) penduduk menurut kota dalam sampel dengan import_id yang ditentukan. </font><font style="vertical-align: inherit;">Dalam hal </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unggahan yang tidak ada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , respons HTTP harus dikembalikan </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terlepas dari kenyataan bahwa prosesor mengeksekusi dua permintaan (memeriksa keberadaan bongkar dan mendapatkan daftar penduduk), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak perlu menggunakan transaksi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada dua opsi implementasi:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dapatkan usia penduduk dari database, dikelompokkan berdasarkan kota, dan kemudian di sisi Python menghitung persentil menggunakan numpy (yang ditentukan sebagai referensi dalam tugas) dan membulatkan hingga dua tempat desimal.</font></font></li>
<li>     PostgreSQL:  percentile_cont     ,             SQL-,  numpy   .</li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Opsi kedua membutuhkan lebih sedikit data untuk ditransfer antara aplikasi dan PostgreSQL, tetapi tidak memiliki perangkap yang sangat jelas: di PostgreSQL, pembulatan adalah matematika, ( </font></font><code>SELECT ROUND(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengembalikan 3), dan dalam Python - akuntansi, ke bilangan bulat terdekat ( </font></font><code>round(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengembalikan 2). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menguji handler, implementasinya harus sama di PostgreSQL dan Python (mengimplementasikan fungsi dengan pembulatan matematis di Python terlihat lebih mudah). </font><font style="vertical-align: inherit;">Perlu dicatat bahwa ketika menghitung persentil, numpy dan PostgreSQL dapat mengembalikan angka yang sedikit berbeda, tetapi mengingat pembulatannya, perbedaan ini tidak akan terlihat.</font></font><br>
<br>
<a name="testing"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengujian</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang perlu diperiksa dalam aplikasi ini? Pertama, bahwa pawang memenuhi persyaratan dan melakukan pekerjaan yang diperlukan dalam lingkungan sedekat mungkin dengan lingkungan pertempuran. Kedua, migrasi yang mengubah status database berfungsi tanpa kesalahan. Ketiga, ada sejumlah fungsi tambahan yang juga bisa dicakup dengan benar oleh tes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memutuskan untuk menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kerangka pytest karena</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fleksibilitas dan kemudahan penggunaannya. Ini menawarkan mekanisme yang kuat untuk mempersiapkan lingkungan untuk tes - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perlengkapan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yaitu, fungsi dengan dekorator</font></font><code>pytest.mark.fixture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang namanya dapat ditentukan oleh parameter dalam tes. </font><font style="vertical-align: inherit;">Jika pytest mendeteksi parameter dengan nama fixture dalam anotasi tes, itu akan menjalankan fixture ini dan meneruskan hasilnya dalam nilai parameter ini. </font><font style="vertical-align: inherit;">Dan jika fixture adalah generator, maka parameter tes akan mengambil nilai yang dikembalikan </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan setelah tes selesai, bagian kedua </font><font style="vertical-align: inherit;">fixture akan </font><font style="vertical-align: inherit;">dieksekusi, yang dapat menghapus sumber daya atau menutup koneksi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk sebagian besar tes, kita membutuhkan database PostgreSQL. </font><font style="vertical-align: inherit;">Untuk mengisolasi tes satu sama lain, Anda dapat membuat database terpisah sebelum setiap tes, dan menghapusnya setelah eksekusi.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat database fixture untuk setiap tes</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy_utils <span class="hljs-keyword">import</span> create_database, drop_database
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
PG_URL = os.getenv(<span class="hljs-string">'CI_ANALYZER_PG_URL'</span>, DEFAULT_PG_URL)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">postgres</span>():</span>
    tmp_name = <span class="hljs-string">'.'</span>.join([uuid.uuid4().hex, <span class="hljs-string">'pytest'</span>])<font></font>
    tmp_url = str(URL(PG_URL).with_path(tmp_name))<font></font>
    create_database(tmp_url)<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#      postgres  -</span>
        <span class="hljs-keyword">yield</span> tmp_url
    <span class="hljs-keyword">finally</span>:<font></font>
        drop_database(tmp_url)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_db</span>(<span class="hljs-params">postgres</span>):</span>
    <span class="hljs-string">"""
     ,  PostgreSQL
    """</span><font></font>
    engine = create_engine(postgres)<font></font>
    <span class="hljs-keyword">assert</span> engine.execute(<span class="hljs-string">'SELECT 1'</span>).scalar() == <span class="hljs-number">1</span>
    engine.dispose()</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modul </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlalchemy_utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> melakukan tugasnya dengan baik </font><font style="vertical-align: inherit;">, dengan mempertimbangkan fitur-fitur dari berbagai basis data dan driver. Sebagai contoh, PostgreSQL tidak mengizinkan eksekusi </font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam blok transaksi. Saat membuat database, itu </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menerjemahkan </font></font><code>psycopg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(yang biasanya mengeksekusi semua permintaan dalam transaksi) ke mode autocommit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fitur penting lainnya: jika setidaknya satu klien terhubung ke PostgreSQL, database tidak dapat dihapus, tetapi </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memutus semua klien sebelum menghapus database. Basis data akan berhasil dihapus bahkan jika beberapa tes dengan koneksi aktif terhenti.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami membutuhkan PostgreSQL di negara bagian yang berbeda: untuk menguji migrasi, kami membutuhkan database yang bersih, sementara penangan mengharuskan semua migrasi diterapkan. </font><font style="vertical-align: inherit;">Anda secara programatik dapat mengubah keadaan database menggunakan perintah Alembic, mereka membutuhkan objek konfigurasi Alembic untuk memanggil mereka.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat objek konfigurasi fixture Alembic</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> SimpleNamespace<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> make_alembic_config<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alembic_config</span>(<span class="hljs-params">postgres</span>):</span>
    cmd_options = SimpleNamespace(config=<span class="hljs-string">'alembic.ini'</span>, name=<span class="hljs-string">'alembic'</span>,<font></font>
                                  pg_url=postgres, raiseerr=<span class="hljs-literal">False</span>, x=<span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> make_alembic_config(cmd_options)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Harap dicatat bahwa perlengkapan </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memiliki parameter </font></font><code>postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memungkinkan tidak hanya untuk menunjukkan ketergantungan tes pada perlengkapan, tetapi juga ketergantungan antara perlengkapan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mekanisme ini memungkinkan Anda untuk secara fleksibel memisahkan logika dan menulis kode yang sangat ringkas dan dapat digunakan kembali.</font></font><br>
<br>
<a name="testing_handlers"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penangan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penangan penguji membutuhkan database dengan tabel dan tipe data yang dibuat. Untuk menerapkan migrasi, Anda harus secara terprogram memanggil perintah pemutakhiran Alembic. Untuk menyebutnya, Anda memerlukan objek dengan konfigurasi Alembic, yang telah kami tentukan dengan fixture </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Database dengan migrasi tampak seperti entitas yang sepenuhnya independen, dan dapat direpresentasikan sebagai fixture:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic.command <span class="hljs-keyword">import</span> upgrade<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrated_postgres</span>(<span class="hljs-params">alembic_config, postgres</span>):</span>
    upgrade(alembic_config, <span class="hljs-string">'head'</span>)
    <span class="hljs-comment">#  DSN  ,    </span>
    <span class="hljs-keyword">return</span> postgres</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika ada banyak migrasi dalam proyek, aplikasi mereka untuk setiap tes mungkin memakan waktu terlalu banyak. Untuk mempercepat proses, Anda bisa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">membuat database dengan migrasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sekali </font><font style="vertical-align: inherit;">dan kemudian </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menggunakannya sebagai templat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain database untuk penangan pengujian, Anda akan memerlukan aplikasi yang berjalan, serta klien yang dikonfigurasi untuk bekerja dengan aplikasi ini. Untuk membuat aplikasi ini mudah untuk diuji, saya menempatkan ciptaannya ke dalam fungsi </font></font><code>create_app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang mengambil parameter untuk dijalankan: database, port untuk REST API, dan lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Argumen untuk meluncurkan aplikasi juga dapat direpresentasikan sebagai fixture terpisah. Untuk membuatnya, Anda perlu menentukan port gratis untuk menjalankan aplikasi pengujian dan alamat ke basis data sementara yang dimigrasi.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menentukan port bebas, saya menggunakan fixture </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dari paket aiomisc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fixture standar </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">juga akan baik-baik saja, tetapi mengembalikan fungsi untuk menentukan port bebas, sementara </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segera mengembalikan nomor port. </font><font style="vertical-align: inherit;">Untuk aplikasi kami, kami hanya perlu menentukan satu port gratis, jadi saya memutuskan untuk tidak menulis baris kode tambahan dengan panggilan </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arguments</span>(<span class="hljs-params">aiomisc_unused_port, migrated_postgres</span>):</span>
    <span class="hljs-keyword">return</span> parser.parse_args(<font></font>
        [<font></font>
            <span class="hljs-string">'--log-level=debug'</span>,
            <span class="hljs-string">'--api-address=127.0.0.1'</span>,
            <span class="hljs-string">f'--api-port=<span class="hljs-subst">{aiomisc_unused_port}</span>'</span>,
            <span class="hljs-string">f'--pg-url=<span class="hljs-subst">{migrated_postgres}</span>'</span><font></font>
        ]<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua tes dengan penangan menyiratkan permintaan ke REST API; bekerja secara langsung dengan aplikasi </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak diperlukan. </font><font style="vertical-align: inherit;">Oleh karena itu, saya membuat satu perlengkapan yang meluncurkan aplikasi dan menggunakan pabrik </font></font><code>aiohttp_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">membuat dan mengembalikan klien uji standar yang terhubung ke aplikasi </font></font><code>aiohttp.test_utils.TestClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api_client</span>(<span class="hljs-params">aiohttp_client, arguments</span>):</span><font></font>
    app = create_app(arguments)<font></font>
    client = <span class="hljs-keyword">await</span> aiohttp_client(app, server_kwargs={
        <span class="hljs-string">'port'</span>: arguments.api_port<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> client
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang, jika Anda menentukan fixture dalam parameter pengujian </font></font><code>api_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, berikut ini akan terjadi:</font></font><br>
<br>
<ol>
<li> <code>postgres</code>    (  <code>migrated_postgres</code>).</li>
<li> <code>alembic_config</code>    Alembic,      (  <code>migrated_postgres</code>).</li>
<li> <code>migrated_postgres</code>   (  <code>arguments</code>).</li>
<li> <code>aiomisc_unused_port</code>    (  <code>arguments</code>).</li>
<li> <code>arguments</code>     (  <code>api_client</code>).</li>
<li> <code>api_client</code>          .</li>
<li> .</li>
<li> <code>api_client</code>     .</li>
<li> <code>postgres</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perlengkapan memungkinkan Anda untuk menghindari duplikasi kode, tetapi selain mempersiapkan lingkungan dalam pengujian, ada tempat potensial lain di mana akan ada banyak kode yang sama - permintaan aplikasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, membuat permintaan, kami berharap mendapatkan status HTTP tertentu. Kedua, jika statusnya sesuai dengan yang diharapkan, maka sebelum bekerja dengan data Anda harus memastikan bahwa mereka memiliki format yang benar. Mudah untuk membuat kesalahan di sini dan menulis penangan yang melakukan perhitungan yang benar dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengembalikan hasil yang benar, tetapi tidak lulus validasi otomatis karena format respons yang salah</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (misalnya, lupa untuk membungkus jawaban dalam kamus dengan kunci </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Semua cek ini dapat dilakukan di satu tempat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam modul</font></font><code>analyzer.testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Saya telah menyiapkan untuk setiap penangan fungsi pembantu yang memeriksa status HTTP, serta format respons menggunakan Marshmallow. </font></font><br>
<br>
<a name="test_citizens_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / warga</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memutuskan untuk memulai dengan penangan yang mengembalikan penghuni, karena sangat berguna untuk memeriksa hasil penangan lain yang mengubah keadaan database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sengaja tidak menggunakan kode yang menambahkan data ke database dari handler </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, meskipun tidak sulit untuk membuatnya menjadi fungsi yang terpisah. </font><font style="vertical-align: inherit;">Kode penangan memiliki properti untuk diubah, dan jika ada kesalahan dalam kode yang menambah database, ada kemungkinan bahwa tes akan berhenti berfungsi sebagaimana dimaksud dan secara implisit bagi pengembang akan berhenti menunjukkan kesalahan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk tes ini, saya mendefinisikan set data tes berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar dengan beberapa saudara. </font><font style="vertical-align: inherit;">Memeriksa bahwa untuk setiap penduduk daftar dengan pengidentifikasi kerabat akan dibentuk dengan benar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar dengan satu penduduk tanpa saudara. </font><font style="vertical-align: inherit;">Memeriksa bahwa bidang tersebut </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adalah daftar kosong (karena </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kueri SQL, daftar kerabat mungkin sama </font></font><code>[None]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar dengan seorang residen yang merupakan kerabat dari dirinya sendiri.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar kosong. </font><font style="vertical-align: inherit;">Periksa bahwa pawang memungkinkan untuk menambahkan pembongkaran kosong dan tidak mengalami kesalahan.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menjalankan tes yang sama secara terpisah pada setiap unggahan, saya menggunakan mekanisme pytest lain yang sangat kuat - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parameterisasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mekanisme ini memungkinkan Anda untuk membungkus fungsi tes di dekorator </font></font><code>pytest.mark.parametrize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan menjelaskan di dalamnya parameter apa yang harus diambil fungsi tes untuk setiap kasus uji individu.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara membuat parameter suatu tes</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
datasets = [<font></font>
    <span class="hljs-comment">#    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">3</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   </span><font></font>
    [<font></font>
        generate_citizen(relatives=[])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   ,    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, name=<span class="hljs-string">''</span>, gender=<span class="hljs-string">'male'</span>,<font></font>
                         birth_date=<span class="hljs-string">'17.02.2020'</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    [],<font></font>
]<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.mark.parametrize('dataset', datasets)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_citizens</span>(<span class="hljs-params">api_client, dataset</span>):</span>
    <span class="hljs-string">"""
        4 ,    
    """</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, tes akan menambahkan unggahan ke basis data, kemudian, menggunakan permintaan ke penangan, ia akan menerima informasi tentang penghuni dan membandingkan unggahan referensi dengan yang diterima. Tapi bagaimana Anda membandingkan penduduk? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap penduduk terdiri dari bidang skalar dan bidang </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- daftar pengidentifikasi kerabat. Daftar dengan Python adalah tipe yang diurutkan, dan ketika membandingkan urutan elemen dari setiap daftar tidak masalah, tetapi ketika membandingkan daftar dengan saudara kandung, urutannya tidak menjadi masalah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda membawa </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ke set sebelum perbandingan, maka ketika membandingkannya tidak berhasil menemukan situasi di mana salah satu penghuni di lapangan </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memiliki duplikat. Jika Anda mengurutkan daftar dengan pengenal kerabat, ini akan menghindari masalah urutan pengidentifikasi kerabat yang berbeda, tetapi pada saat yang sama mendeteksi duplikat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika membandingkan dua daftar dengan penghuni, satu mungkin menghadapi masalah yang sama: secara teknis, urutan penghuni dalam bongkar tidak penting, tetapi penting untuk mendeteksi jika ada dua penghuni dengan pengidentifikasi yang sama dalam satu bongkar dan tidak di yang lain. </font><font style="vertical-align: inherit;">Jadi, selain mengatur daftar dengan kerabat, kerabat untuk setiap penduduk perlu mengatur penghuni di setiap pembongkaran. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena tugas membandingkan penduduk akan muncul lebih dari sekali, saya menerapkan dua fungsi: satu untuk membandingkan dua penduduk, dan yang kedua untuk membandingkan dua daftar dengan penduduk:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bandingkan penduduk</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Iterable, Mapping<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_citizen</span>(<span class="hljs-params">citizen</span>):</span>
    <span class="hljs-string">"""
         
    """</span>
    <span class="hljs-keyword">return</span> {**citizen, <span class="hljs-string">'relatives'</span>: sorted(citizen[<span class="hljs-string">'relatives'</span>])}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizens</span>(<span class="hljs-params">left: Mapping, right: Mapping</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
      
    """</span>
    <span class="hljs-keyword">return</span> normalize_citizen(left) == normalize_citizen(right)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizen_groups</span>(<span class="hljs-params">left: Iterable, right: Iterable</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
          ,   
      
    """</span>
    left = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> left]<font></font>
    left.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])<font></font>
<font></font>
    right = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> right]<font></font>
    right.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])
    <span class="hljs-keyword">return</span> left == right
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memastikan bahwa pawang ini tidak mengembalikan penghuni bongkar muat lainnya, saya memutuskan untuk menambahkan bongkar muat tambahan dengan satu penghuni sebelum setiap tes.</font></font><br>
<br>
<a name="test_imports_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / impor</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya mendefinisikan kumpulan data berikut untuk menguji penangan:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data yang benar, diharapkan berhasil ditambahkan ke database.</font></font></b><br>
 <br>
<ul>
<li>    ( ).<br>
<br>
      .    ,     ,    insert    ,    .</li>
<li>   ( , ).<br>
<br>
,            .<br>
 </li>
<li>    .<br>
<br>
     ,       . :)<br>
 </li>
<li>    <br>
<br>
,  aiohttp             PostgreSQL    32 767  (    ).<br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empty unloading </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang harus memperhitungkan kasing seperti itu dan tidak jatuh, mencoba melakukan pemasukan kosong ke meja dengan penghuni.</font></font><br>
 </li>
</ul><br>
 </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data dengan kesalahan, mengharapkan respons HTTP 400: Permintaan Buruk.</font></font></b><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tanggal lahir salah (future tense).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citizen_id tidak unik dalam unggahan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hubungan kekerabatan ditunjukkan secara tidak benar (hanya ada dari satu penduduk ke penduduk lainnya, tetapi tidak ada umpan balik).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penduduk memiliki kerabat yang tidak ada dalam bongkar muat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ikatan keluarga tidak unik.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika prosesor bekerja dengan sukses dan data ditambahkan, Anda perlu membuat penghuni ditambahkan ke database dan membandingkannya dengan pembongkaran standar. </font><font style="vertical-align: inherit;">Untuk mendapatkan penghuni, saya menggunakan penangan yang sudah diuji </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan untuk perbandingan, sebuah fungsi </font></font><code>compare_citizen_groups</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="test_update_citizen_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / impor / $ import_id / warga negara / $ citizen_id</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Validasi data dalam banyak hal mirip dengan yang dijelaskan dalam penangan </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan beberapa pengecualian: hanya ada satu penduduk dan klien </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hanya</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dapat melewati </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">bidang-bidang yang ia inginkan</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memutuskan untuk menggunakan set berikut dengan data yang salah untuk memverifikasi bahwa pawang akan mengembalikan respons HTTP </font></font><code>400: Bad request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kolom ditentukan, tetapi memiliki tipe data dan / atau format yang salah</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tanggal lahir salah (waktu mendatang).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kolom </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">berisi kerabat yang tidak ada di pembongkaran.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penting juga untuk memverifikasi bahwa pawang memperbarui informasi tentang residen dan kerabatnya dengan benar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk melakukan ini, buat unggahan dengan tiga penduduk, dua di antaranya adalah kerabat, dan kirim permintaan dengan nilai baru untuk semua bidang skalar dan pengenal relatif baru di bidang tersebut </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memastikan bahwa pawang membedakan antara penghuni dengan muatan yang berbeda sebelum ujian (dan, misalnya, tidak mengubah penghuni dengan pengidentifikasi yang sama dari pembongkar yang lain), saya membuat pembongkaran tambahan dengan tiga penghuni yang memiliki pengidentifikasi yang sama.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang harus menyimpan nilai-nilai baru dari bidang skalar, menambahkan kerabat yang ditentukan baru dan menghapus hubungan dengan kerabat yang lama, tidak ditentukan. </font><font style="vertical-align: inherit;">Semua perubahan dalam hubungan keluarga harus bersifat bilateral. </font><font style="vertical-align: inherit;">Seharusnya tidak ada perubahan dalam pembongkaran lainnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena pawang seperti itu dapat mengalami kondisi balapan (ini dibahas di bagian Pengembangan), saya menambahkan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dua tes tambahan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Yang satu mereproduksi masalah dengan kondisi balapan (memperluas kelas penangan dan melepas kunci), yang kedua membuktikan bahwa masalah dengan kondisi balapan tidak direproduksi.</font></font><br>
<br>
<a name="test_citizen_birthdays_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / warga negara / ulang tahun</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menguji penangan ini, saya memilih dataset berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar di mana seorang penduduk memiliki satu kerabat dalam satu bulan dan dua kerabat di yang lain.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar dengan satu penduduk tanpa saudara. </font><font style="vertical-align: inherit;">Pastikan pawang tidak memperhitungkannya dalam perhitungan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar kosong. </font><font style="vertical-align: inherit;">Pastikan pawang tidak akan gagal dan akan mengembalikan kamus yang benar dengan 12 bulan sebagai tanggapan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar dengan seorang residen yang merupakan kerabat dari dirinya sendiri. </font><font style="vertical-align: inherit;">Memeriksa bahwa seorang penduduk akan membeli hadiah untuk bulan kelahirannya.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pawang harus mengembalikan semua bulan dalam respons, bahkan jika tidak ada ulang tahun pada bulan-bulan ini. </font><font style="vertical-align: inherit;">Untuk menghindari duplikasi, saya membuat fungsi di mana Anda dapat melewati kamus sehingga melengkapi dengan nilai-nilai untuk bulan yang hilang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memastikan bahwa pawang membedakan antara penghuni yang berbeda muatan, saya menambahkan pembongkaran tambahan dengan dua saudara. </font><font style="vertical-align: inherit;">Jika pawang salah menggunakannya dalam perhitungan, hasilnya akan salah dan pawang akan jatuh karena kesalahan.</font></font><br>
<br>
<a name="test_town_age_stat_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DAPATKAN / impor / $ import_id / kota / stat / persentil / usia</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keunikan dari tes ini adalah bahwa hasil kerjanya tergantung pada waktu saat ini: usia penduduk dihitung berdasarkan tanggal saat ini. </font><font style="vertical-align: inherit;">Untuk memastikan bahwa hasil tes tidak berubah dari waktu ke waktu, tanggal saat ini, tanggal lahir penduduk dan hasil yang diharapkan harus dicatat. </font><font style="vertical-align: inherit;">Ini akan membuatnya mudah untuk mereproduksi, bahkan tepi kasus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa tanggal perbaikan terbaik? </font><font style="vertical-align: inherit;">Pawang menggunakan fungsi PostgreSQL untuk menghitung usia penghuni </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>AGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang mengambil parameter pertama sebagai tanggal yang diperlukan untuk menghitung usia dan yang kedua sebagai tanggal dasar (ditentukan oleh konstanta </font></font><code>TownAgeStatView.CURRENT_DATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengganti tanggal dasar dalam handler dengan waktu pengujian</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@patch('analyzer.api.handlers.TownAgeStatView.CURRENT_DATE', new=CURRENT_DATE)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_ages</span>(<span class="hljs-params">...</span>):</span>
    ...</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menguji pawang, saya memilih set data berikut (untuk semua penduduk yang saya sebutkan satu kota, karena pawang mengumpulkan hasil berdasarkan kota):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar dengan beberapa warga yang ulang tahunnya besok (usia - beberapa tahun dan 364 hari). </font><font style="vertical-align: inherit;">Periksa apakah prosesor hanya menggunakan jumlah tahun penuh dalam perhitungan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar dengan penduduk yang berulang tahun hari ini (umur - tepatnya beberapa tahun). </font><font style="vertical-align: inherit;">Ini memeriksa kasus regional - usia penduduk yang ulang tahunnya hari ini tidak boleh dihitung sebagai dikurangi dengan 1 tahun.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bongkar kosong. </font><font style="vertical-align: inherit;">Pawang tidak boleh jatuh di atasnya.</font></font></li>
</ul><br><font style="vertical-align: inherit;"></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patokan </font><font style="vertical-align: inherit;">
untuk menghitung persentil - </font><font style="vertical-align: inherit;">dengan interpolasi linier, dan hasil patokan untuk pengujian saya hitung untuk mereka. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda juga perlu membulatkan nilai persentil pecahan ke dua tempat desimal. </font><font style="vertical-align: inherit;">Jika Anda menggunakan PostgreSQL untuk pembulatan di handler, dan Python untuk menghitung data referensi, Anda mungkin memperhatikan bahwa </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pembulatan dalam Python 3 dan PostgreSQL dapat memberikan hasil yang berbeda</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contohnya</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># Python 3<font></font>
round(2.5)<font></font>
&gt; 2<font></font>
<font></font>
-- PostgreSQL<font></font>
SELECT ROUND(2.5)<font></font>
&gt; 3<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faktanya adalah bahwa Python menggunakan pembulatan bank </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ke genap terdekat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan PostgreSQL </font><font style="vertical-align: inherit;">menggunakan </font><font style="vertical-align: inherit;">matematika (setengah-atas). </font><font style="vertical-align: inherit;">Dalam hal perhitungan dan pembulatan dilakukan dalam PostgreSQL, itu akan benar untuk menggunakan pembulatan matematis dalam tes juga. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada awalnya saya menggambarkan set data dengan tanggal lahir dalam format teks, tetapi itu tidak nyaman untuk membaca tes dalam format ini: setiap kali saya harus menghitung usia setiap penduduk dalam pikiran saya untuk mengingat apa yang diperiksa oleh set data tertentu. </font><font style="vertical-align: inherit;">Tentu saja, Anda dapat bertahan dengan komentar dalam kode, tetapi saya memutuskan untuk melangkah lebih jauh dan menulis fungsi </font></font><code>age2date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang memungkinkan Anda untuk menggambarkan tanggal lahir dalam bentuk usia: jumlah tahun dan hari.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Misalnya, seperti ini</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">age2date</span>(<span class="hljs-params">years: int, days: int = <span class="hljs-number">0</span>, base_date=CURRENT_DATE</span>) -&gt; str:</span><font></font>
    birth_date = copy(base_date).replace(year=base_date.year - years)<font></font>
    birth_date -= timedelta(days=days)<font></font>
    <span class="hljs-keyword">return</span> birth_date.strftime(BIRTH_DATE_FORMAT)<font></font>
<font></font>
<span class="hljs-comment">#    ?  ,     ?</span>
generate_citizen(birth_date=<span class="hljs-string">'17.02.2009'</span>)<font></font>
<font></font>
<span class="hljs-comment">#   11       </span>
generate_citizen(birth_date=age2date(years=<span class="hljs-number">11</span>))
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memastikan bahwa pawang membedakan antara penghuni yang berbeda muatan, saya menambahkan pembongkaran tambahan dengan satu penduduk dari kota lain: jika pawang salah menggunakannya, sebuah kota tambahan akan muncul dalam hasil dan tes akan pecah.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fakta yang menarik: ketika saya menulis tes ini pada tanggal 29 Februari 2020, saya tiba-tiba berhenti mengeluarkan muatan dengan penduduk </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">karena bug di Faker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2020 adalah tahun kabisat, dan tahun-tahun lain yang Faker pilih tidak selalu kabisat tahun di dalamnya juga bukan 29 Februari). </font><font style="vertical-align: inherit;">Ingatlah untuk mencatat tanggal dan kasus uji tepi!</font></font></blockquote><br>
<a name="test_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrasi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekilas tentang kode migrasi tampak jelas dan paling tidak rentan kesalahan, mengapa mengujinya? Ini adalah kesalahan yang sangat berbahaya: kesalahan migrasi yang paling berbahaya dapat memanifestasikan diri mereka pada saat yang paling tidak tepat. Bahkan jika mereka tidak merusak data, mereka dapat menyebabkan downtime yang tidak perlu. </font><font style="vertical-align: inherit;">Migrasi </font><i><font style="vertical-align: inherit;">awal yang</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ada di proyek </font><font style="vertical-align: inherit;">mengubah struktur database, tetapi tidak mengubah data. Kesalahan umum apa yang bisa dilindungi dari migrasi semacam itu?</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li>  <code>downgrade</code>           (     ,      ,     ).<br>
<br>
   ,        (--):         ,        —    .<br>
 </li>
<li>C   .</li>
<li>    ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagian besar kesalahan ini akan dideteksi oleh </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tes tangga</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Idenya - untuk menggunakan migrasi tunggal, secara konsisten melakukan metode </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk setiap migrasi. </font><font style="vertical-align: inherit;">Tes semacam itu cukup untuk ditambahkan ke proyek sekali, tidak memerlukan dukungan dan akan melayani dengan setia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi jika migrasi, selain struktur, akan mengubah data, maka akan perlu untuk menulis setidaknya satu tes terpisah, memeriksa apakah data benar mengubah metode </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan kembali ke keadaan awal di </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Untuk jaga-jaga: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proyek dengan contoh pengujian migrasi berbeda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang saya siapkan untuk </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laporan tentang Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di Moscow Python.</font></font><br>
<br>
<a name="build"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Majelis</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artefak terakhir yang akan kami gunakan dan yang ingin kami dapatkan sebagai hasil perakitan adalah gambar Docker. Untuk membangun, Anda harus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memilih gambar dasar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan Python. Gambar resmi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>python:latest</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">berbobot ~ 1 GB dan, jika digunakan sebagai gambar dasar, gambar dengan aplikasi akan sangat besar. Ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gambar berdasarkan OS Alpine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang ukurannya jauh lebih kecil. Tetapi dengan semakin banyak paket yang diinstal, ukuran gambar akhir akan tumbuh, dan sebagai hasilnya, bahkan gambar yang dikumpulkan berdasarkan Alpine tidak akan begitu kecil. Saya memilih </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snakepacker / python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sebagai gambar dasar </font><font style="vertical-align: inherit;">- beratnya sedikit lebih banyak daripada gambar Alpine, tetapi didasarkan pada Ubuntu, yang menawarkan banyak pilihan paket dan pustaka. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cara lain</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kurangi ukuran gambar dengan aplikasi</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - jangan masukkan dalam gambar akhir kompiler, pustaka dan file dengan header untuk perakitan, yang tidak diperlukan agar aplikasi berfungsi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk melakukan ini, Anda dapat menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perakitan multi-tahap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan gambar "berat" </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 1 GB, ~ 500 MB terkompresi), buat lingkungan virtual, instal semua dependensi dan paket aplikasi ke dalamnya. </font><font style="vertical-align: inherit;">Gambar ini diperlukan khusus untuk perakitan, dapat berisi kompiler, semua perpustakaan yang diperlukan dan file dengan header.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#   </span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/*</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menyalin lingkungan virtual yang sudah jadi ke gambar "ringan" </font></font><code>snakepacker/python:3.8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 100 MB, terkompresi ~ 50 MB), yang hanya berisi penerjemah dari versi Python yang diperlukan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penting: di lingkungan virtual, jalur absolut digunakan, sehingga harus disalin ke alamat yang sama saat dirakit di wadah kolektor.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#       builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengurangi waktu yang dibutuhkan untuk membangun gambar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , modul-modul yang bergantung pada aplikasi dapat diinstal sebelum diinstal di lingkungan virtual. </font><font style="vertical-align: inherit;">Kemudian Docker akan men-cache mereka dan tidak akan menginstal ulang jika belum berubah.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile sepenuhnya</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">###############      ################</span>
<span class="hljs-comment">#  — «» (~1 ,    ~500 )    </span>
<span class="hljs-comment">#    </span>
FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#      pip</span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
RUN /usr/share/python3/app/bin/pip install -U pip<font></font>
<font></font>
<span class="hljs-comment">#   ,  .   </span>
<span class="hljs-comment"># Docker   ,  requirements.txt  </span><font></font>
COPY requirements.txt /mnt/<font></font>
RUN /usr/share/python3/app/bin/pip install -Ur /mnt/requirements.txt<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/* \<font></font>
    &amp;&amp; /usr/share/python3/app/bin/pip check<font></font>
<font></font>
<span class="hljs-comment">###########################   ############################</span>
<span class="hljs-comment">#    «» (~100 ,    ~50 )   Python</span>
FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#         builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk kemudahan perakitan, saya menambahkan perintah </font></font><code>make upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang mengumpulkan gambar Docker dan mengunggahnya ke hub.docker.com.</font></font><br>
<br>
<a name="ci"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang setelah kode dilindungi dengan tes dan kita dapat membuat gambar Docker, saatnya untuk mengotomatiskan proses ini. Hal pertama yang terlintas dalam pikiran: jalankan tes untuk membuat permintaan kumpulan, dan saat menambahkan perubahan ke cabang master, kumpulkan gambar Docker baru dan unggah ke </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (atau </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paket GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , jika Anda tidak akan mendistribusikan gambar secara publik). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memecahkan masalah ini dengan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tindakan GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Untuk melakukan ini, perlu membuat file YAML di folder </font></font><code>.github/workflows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan menjelaskan di dalamnya alur kerja (dengan dua tugas: </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), yang saya beri nama </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tugas </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dijalankan setiap kali alur kerja dimulai </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">layanan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengambil sebuah wadah dengan PostgreSQL, menunggu sampai tersedia, dan diluncurkan </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam wadah </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tugas </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dilakukan hanya jika perubahan telah ditambahkan ke cabang </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan jika tugas </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">berhasil. </font><font style="vertical-align: inherit;">Itu mengumpulkan distribusi sumber oleh wadah </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lalu mengumpulkan dan memuat gambar Docker dengan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>docker/build-push-action@v1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deskripsi lengkap alur kerja</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">name: CI<font></font>
<font></font>
# Workflow      <font></font>
#   -  master<font></font>
on:<font></font>
  push:<font></font>
    branches: [ master ]<font></font>
  pull_request:<font></font>
    branches: [ master ]<font></font>
<font></font>
jobs:<font></font>
  #       workflow<font></font>
  test:<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    services:<font></font>
      postgres:<font></font>
        image: docker://postgres<font></font>
        ports:<font></font>
          - 5432:5432<font></font>
        env:<font></font>
          POSTGRES_USER: user<font></font>
          POSTGRES_PASSWORD: hackme<font></font>
          POSTGRES_DB: analyzer<font></font>
<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: test<font></font>
        uses: docker://snakepacker/python:all<font></font>
        env:<font></font>
          CI_ANALYZER_PG_URL: postgresql://user:hackme@postgres/analyzer<font></font>
        with:<font></font>
          args: /bin/bash -c "pip install -U '.[dev]' &amp;&amp; pylama &amp;&amp; wait-for-port postgres:5432 &amp;&amp; pytest -vv --cov=analyzer --cov-report=term-missing tests"<font></font>
<font></font>
  #    Docker-  <font></font>
  publish:<font></font>
    #        master<font></font>
    if: github.event_name == 'push' &amp;&amp; github.ref == 'refs/heads/master'<font></font>
    # ,   test   <font></font>
    needs: test<font></font>
    runs-on: ubuntu-latest<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: sdist<font></font>
        uses: docker://snakepacker/python:all<font></font>
        with:<font></font>
          args: make sdist<font></font>
<font></font>
      - name: build-push<font></font>
        uses: docker/build-push-action@v1<font></font>
        with:<font></font>
          username: ${{ secrets.REGISTRY_LOGIN }}<font></font>
          password: ${{ secrets.REGISTRY_TOKEN }}<font></font>
          repository: alvassin/backendschool2019<font></font>
          target: api<font></font>
          tags: 0.0.1, latest<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang, saat menambahkan perubahan ke master di tab Tindakan di GitHub, Anda dapat melihat peluncuran tes, perakitan dan pemuatan gambar Docker: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/qx/pm/r5qxpmy7mlttqniibfvxadvzitw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan saat membuat permintaan kumpulan di cabang master, hasil tugas juga akan ditampilkan di dalamnya </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/d9/nk/pzd9nkmxq7a75fnlcw2tx37i308.png"><br>
<br>
<a name="deployment"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyebarkan</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menyebarkan aplikasi pada server yang disediakan, Anda perlu menginstal Docker, Docker Compose, memulai wadah dengan aplikasi dan PostgreSQL dan menerapkan migrasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Langkah-langkah ini dapat diotomatisasi menggunakan sistem manajemen konfigurasi Ansible. Itu ditulis dalam Python, tidak memerlukan agen khusus (terhubung langsung melalui ssh), menggunakan template jinja dan memungkinkan secara deskriptif menggambarkan keadaan yang diinginkan dalam file YAML. Pendekatan deklaratif memungkinkan Anda untuk tidak memikirkan kondisi sistem saat ini dan tindakan yang diperlukan untuk membawa sistem ke kondisi yang diinginkan. Semua pekerjaan ini berada di pundak modul Ansible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansible memungkinkan Anda untuk mengelompokkan tugas-tugas terkait secara logis ke dalam </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peran</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan kemudian menggunakannya kembali. Kami membutuhkan dua peran:</font></font><code>docker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(menginstal dan mengkonfigurasi Docker) dan </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(menginstal dan mengkonfigurasi aplikasi). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peran</font></font><code>docker</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menambahkan repositori dengan Docker ke sistem, menginstal dan mengkonfigurasi paket </font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara opsional, Anda dapat mengatur REST API untuk secara otomatis melanjutkan setelah server reboot. Ubuntu memungkinkan Anda untuk menyelesaikan masalah ini dengan bantuan sistem inisialisasi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>systemd</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ini mengontrol unit yang mewakili berbagai sumber daya (daemon, soket, titik pemasangan, dan lainnya). Untuk menambahkan unit baru ke systemd, Anda harus menjelaskan konfigurasinya dalam file .service yang terpisah dan letakkan file ini di salah satu folder khusus, misalnya, di </font></font><code>/etc/systemd/system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kemudian unit dapat diluncurkan, serta memungkinkan pengisian otomatis untuknya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selama instalasi, itu akan secara otomatis membuat file dengan konfigurasi unit - Anda hanya perlu memastikan bahwa itu berjalan dan menyala ketika sistem dimulai. </font><font style="vertical-align: inherit;">Untuk Docker Compose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>  docker-compose@.service</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan dibuat oleh Ansible. </font><font style="vertical-align: inherit;">Simbol </font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam nama menunjukkan kepada systemd bahwa unit adalah templat. </font><font style="vertical-align: inherit;">Ini memungkinkan Anda untuk memulai layanan </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan parameter - misalnya, dengan nama layanan kami, yang akan diganti alih-alih </font></font><code>%i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam file konfigurasi unit:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=%i service with docker compose<font></font>
Requires=docker.service<font></font>
After=docker.service<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
RemainAfterExit=true<font></font>
WorkingDirectory=/etc/docker/compose/%i<font></font>
ExecStart=/usr/local/bin/docker-compose up -d --remove-orphans<font></font>
ExecStop=/usr/local/bin/docker-compose down<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peran akan</font></font><code>analyzer</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menghasilkan file dari templat </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di alamat </font></font><code>/etc/docker/compose/analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mendaftarkan aplikasi sebagai layanan yang diluncurkan secara otomatis </font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan menerapkan migrasi. </font><font style="vertical-align: inherit;">Saat peran sudah siap, Anda perlu menggambarkan buku pedoman.</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Gathering facts<font></font>
  hosts: all<font></font>
  become: yes<font></font>
  gather_facts: yes<font></font>
<font></font>
- name: Install docker<font></font>
  hosts: docker<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - docker<font></font>
<font></font>
- name: Install analyzer<font></font>
  hosts: api<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daftar host, serta variabel yang digunakan dalam peran, dapat ditentukan dalam file inventaris </font></font><code>hosts.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">[api]<font></font>
130.193.51.154<font></font>
<font></font>
[docker:children]<font></font>
api<font></font>
<font></font>
[api:vars]<font></font>
analyzer_image = alvassin/backendschool2019<font></font>
analyzer_pg_user = user<font></font>
analyzer_pg_password = hackme<font></font>
analyzer_pg_dbname = analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah semua file Ansible siap, jalankan:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ansible-playbook -i hosts.ini deploy.yml</code></pre><br>
<a name="load_testing"></a><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentang pengujian stres</font></font></b>
                        <div class="spoiler_text">,   ,     .      ,      -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>.     :      ,    —   ,         10 . ,         (, ,   CI-):           .<br>
<br>
,     ,      ,        10 .   ?  ,          ,   .  ,     ,       .<br>
<br>
          RPS,      :      . ,    ,     <code>import_id</code>,    <code>POST /imports</code>      .      . <br>
<br>
,       Python 3,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Locust</a>. <br>
<br>
   ,      <code>locustfile.py</code>     <code>locust</code>.         -     .<br>
<br>
 Locust   .    ,        .       <br>
 <code>self.round</code>           .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    locustfile.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># locustfile.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus<font></font>
<font></font>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, constant, task, TaskSet
<span class="hljs-keyword">from</span> locust.exception <span class="hljs-keyword">import</span> RescheduleTask<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.handlers <span class="hljs-keyword">import</span> (<font></font>
    CitizenBirthdaysView, CitizensView, CitizenView, TownAgeStatView<font></font>
)<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen, generate_citizens, url_for<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyzerTaskSet</span>(<span class="hljs-params">TaskSet</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.round = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_dataset</span>(<span class="hljs-params">self</span>):</span><font></font>
        citizens = [<font></font>
            <span class="hljs-comment">#     .   </span>
            <span class="hljs-comment"># PATCH-  relatives    </span>
            <span class="hljs-comment"># ,     - </span>
            <span class="hljs-comment"># (     ,    </span>
            <span class="hljs-comment"># ).</span>
            generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>]),<font></font>
            generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
            *generate_citizens(citizens_num=<span class="hljs-number">9998</span>, relations_num=<span class="hljs-number">1000</span>,<font></font>
                               start_citizen_id=<span class="hljs-number">3</span>)<font></font>
        ]<font></font>
        <span class="hljs-keyword">return</span> {citizen[<span class="hljs-string">'citizen_id'</span>]: citizen <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> citizens}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, method, path, expected_status, **kwargs</span>):</span>
        <span class="hljs-keyword">with</span> self.client.request(<font></font>
                method, path, catch_response=<span class="hljs-literal">True</span>, **kwargs<font></font>
        ) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">if</span> resp.status_code != expected_status:<font></font>
                resp.failure(<span class="hljs-string">f'expected status <span class="hljs-subst">{expected_status}</span>, '</span>
                             <span class="hljs-string">f'got <span class="hljs-subst">{resp.status_code}</span>'</span>)<font></font>
            logging.info(<font></font>
                <span class="hljs-string">'round %r: %s %s, http status %d (expected %d), took %rs'</span>,<font></font>
                self.round, method, path, resp.status_code, expected_status,<font></font>
                resp.elapsed.total_seconds()<font></font>
            )<font></font>
            <span class="hljs-keyword">return</span> resp<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_import</span>(<span class="hljs-params">self, dataset</span>):</span>
        resp = self.request(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/imports'</span>, HTTPStatus.CREATED,<font></font>
                            json={<span class="hljs-string">'citizens'</span>: list(dataset.values())})
        <span class="hljs-keyword">if</span> resp.status_code != HTTPStatus.CREATED:
            <span class="hljs-keyword">raise</span> RescheduleTask
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">'data'</span>][<span class="hljs-string">'import_id'</span>]<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_citizens</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizensView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_citizen</span>(<span class="hljs-params">self, import_id</span>):</span>
        url = url_for(CitizenView.URL_PATH, import_id=import_id, citizen_id=<span class="hljs-number">1</span>)<font></font>
        self.request(<span class="hljs-string">'PATCH'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/{citizen_id}'</span>,<font></font>
                     json={<span class="hljs-string">'relatives'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)]})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_birthdays</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizenBirthdaysView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/birthdays'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_town_stats</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(TownAgeStatView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/towns/stat/percentile/age'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @task</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">workflow</span>(<span class="hljs-params">self</span>):</span>
        self.round += <span class="hljs-number">1</span><font></font>
        dataset = self.make_dataset()<font></font>
<font></font>
        import_id = self.create_import(dataset)<font></font>
        self.get_citizens(import_id)<font></font>
        self.update_citizen(import_id)<font></font>
        self.get_birthdays(import_id)<font></font>
        self.get_town_stats(import_id)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><font></font>
    task_set = AnalyzerTaskSet<font></font>
    wait_time = constant(<span class="hljs-number">1</span>)</code></pre></div>
                    </div><br>
 100  c  ,  ,        :<br>
<br>
<img src="https://habrastorage.org/webt/qx/ri/b3/qxrib3jily9gzmexxhupu35tipa.png"><br>
<br>
       ,           ( — 95 ,  — ).        .<br>
<br>
<img src="https://habrastorage.org/webt/dn/px/fn/dnpxfn5ly7vttziqnnfpvvdsl9g.png"><br>
<br>
      —     Ansible       ~20.15  ~20.30    Locust.<br>
<br>
<img src="https://habrastorage.org/webt/om/1e/ok/om1eoknqvzqmyez-plpgykhz8io.png"></div>
                    </div><br>
<a name="whatelse"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa lagi yang bisa dilakukan?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Profiling aplikasi menunjukkan bahwa sekitar seperempat dari total waktu eksekusi permintaan dihabiskan untuk serialisasi dan deserializing JSON: ada banyak data yang dikirim dan diterima dari layanan. </font><font style="vertical-align: inherit;">Proses-proses ini dapat dipercepat secara signifikan menggunakan pustaka </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orjson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tetapi layanan harus dipersiapkan sedikit - </font></font><code>orjson</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ini bukan pengganti drop-in untuk modul standar. </font></font><code>json</code> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biasanya, produksi memerlukan beberapa salinan layanan untuk memastikan toleransi kesalahan dan mengatasi beban. </font><font style="vertical-align: inherit;">Untuk mengelola sekelompok layanan, Anda memerlukan alat yang menunjukkan apakah salinan layanan itu "hidup". </font><font style="vertical-align: inherit;">Masalah ini dapat diselesaikan oleh seorang pawang </font></font><code>/health</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang melakukan polling semua sumber daya yang dibutuhkan untuk bekerja, dalam kasus kami, sebuah database. </font><font style="vertical-align: inherit;">Jika</font></font><code>SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dieksekusi dalam waktu kurang dari satu detik, maka layanannya hidup. Jika tidak, Anda harus memperhatikannya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika aplikasi bekerja sangat intensif dengan jaringan, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uvloop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dapat dengan </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">keren</font></a><font style="vertical-align: inherit;"> meningkatkan kinerja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faktor penting adalah keterbacaan kode. Salah satu kolega saya, Yuri Shikanov, menulis modul </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">abu yang</font></a><font style="vertical-align: inherit;"> menggabungkan beberapa alat </font><font style="vertical-align: inherit;">untuk verifikasi otomatis dan desain kode, yang mudah ditambahkan ke </font></font><code>pre-commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kait Git, dibuat dengan file konfigurasi tunggal atau variabel lingkungan. Gray memungkinkan Anda untuk mengurutkan impor ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), mengoptimalkan ekspresi python sesuai dengan versi bahasa yang baru ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyupgrade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), menambahkan koma di akhir pemanggilan fungsi, impor, daftar, dll. (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add-trailing-koma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), dan juga mengutip ke satu bentuk ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menyatukan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<a name="final"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* * *</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu saja untuk saya: kami mengembangkan, ditutupi dengan tes, mengumpulkan dan menggunakan layanan, dan juga melakukan pengujian beban.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ucapan Terima Kasih</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya ingin mengucapkan terima kasih yang mendalam kepada orang-orang yang meluangkan waktu untuk mengambil bagian dalam menulis artikel ini, untuk meninjau kode, untuk memperkenalkan ide dan komentar saya: kepada Maria Zelenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zelma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Vladimir Solomatin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leenr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Anastasia Semenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">morkov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Yuri Shikanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dizballanze</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Mikhail Shushpanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mishush</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Pavel Mosein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pavkazzz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan terutama ke Dmitry Orlov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orlovdl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id499518/index.html">Konferensi video sekarang menjadi pasar dan teknologi baru. Longrid, bagian satu</a></li>
<li><a href="../id499522/index.html">Все нововведения Windows 10 2004 (20H1)</a></li>
<li><a href="../id499524/index.html">Quarkus: peningkatan aplikasi menggunakan contoh helloworld dari JBoss EAP Quickstart</a></li>
<li><a href="../id499528/index.html">Jembatan matematika "menakjubkan" yang melampaui Teorema Besar Fermat</a></li>
<li><a href="../id499532/index.html">Kata-kata dalam angka: analitik blog gratis dengan Yandex.Metrica</a></li>
<li><a href="../id499536/index.html">Growbox sebagai metode untuk mengenal diri sendiri</a></li>
<li><a href="../id499540/index.html">Cara kerja rendering game 3D: tekstur dan pemfilteran tekstur</a></li>
<li><a href="../id499542/index.html">Fakapov Cyan Teratas</a></li>
<li><a href="../id499544/index.html">Pelajari jaringan saraf di Google Sheets</a></li>
<li><a href="../id499546/index.html">Pengembangan firmware untuk kamera video analog EVR-Y2022F</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>