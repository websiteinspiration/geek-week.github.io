<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍏 👼 🔖 Hancurkan cerita dengan Patroni, atau Cara menjatuhkan kluster PostgreSQL 👨🏾‍⚖️ 🕴🏾 🐐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL tidak memiliki Ketersediaan Tinggi di luar kotak. Untuk mencapai HA, Anda perlu memasukkan sesuatu, mengatur - berusaha. Ada beberapa alat ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hancurkan cerita dengan Patroni, atau Cara menjatuhkan kluster PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/489206/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL tidak memiliki Ketersediaan Tinggi di luar kotak. Untuk mencapai HA, Anda perlu memasukkan sesuatu, mengatur - berusaha. Ada beberapa alat yang dapat membantu meningkatkan ketersediaan PostgreSQL, dan salah satunya adalah Patroni. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada pandangan pertama, menempatkan Patroni di lingkungan pengujian, Anda dapat melihat apa alat yang hebat itu dan bagaimana itu dengan mudah menangani upaya kami untuk memecah cluster. Namun dalam praktiknya, dalam lingkungan produksi, tidak semuanya selalu terjadi dengan begitu indah dan elegan. Data Egret mulai menggunakan Patroni pada akhir 2018 dan memperoleh beberapa pengalaman: cara mendiagnosisnya, mengonfigurasinya, dan kapan tidak mengandalkan pengarsipan otomatis sama sekali. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di HighLoad ++, Alexei Lesovsky menjelaskan secara rinci, menggunakan contoh dan analisis log, masalah khas yang muncul saat bekerja dengan Patroni, dan praktik terbaik untuk mengatasinya.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lqh1eJwVPtk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artikel tidak akan: Instruksi pemasangan Patroni dan contoh konfigurasi; </font><font style="vertical-align: inherit;">masalah di luar Patroni dan PostgreSQL; </font><font style="vertical-align: inherit;">cerita berdasarkan pengalaman orang lain, tetapi hanya masalah-masalah yang dipecahkan Egret Data untuk diri mereka sendiri.</font></font><br>
<a name="habracut"></a><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentang pembicara:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alexey Lesovsky (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lesovsky</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) dimulai sebagai administrator sistem (administrator sistem Linux), bekerja dalam pengembangan web (administrator database PostgreSQL). </font><font style="vertical-align: inherit;">Sejak 2014 dia telah bekerja di Data Egret. </font><font style="vertical-align: inherit;">Data Egret bergerak dalam bidang konsultasi di bidang PostgreSQL, membantu banyak, banyak perusahaan untuk menggunakan PostgreSQL dengan benar dan, tentu saja, telah memperoleh pengalaman luas dalam mengoperasikan basis data. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laporan yang menjadi dasar artikel ini disebut "Patroni Failure Stories atau Cara menabrak cluster PostgreSQL Anda", di sini adalah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tautan ke presentasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sebelum kamu memulai</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biarkan saya mengingatkan Anda apa itu Patroni, apa yang dimaksudkan dan apa yang bisa dilakukan. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni adalah templat untuk membuat HA di luar kotak.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jadi itu tertulis dalam dokumentasi dan dari sudut pandang saya - ini adalah klarifikasi yang sangat tepat. Artinya, Patroni bukan peluru perak yang dia atur dan itu akan menyelesaikan semua masalah. Diperlukan upaya agar mulai bekerja dan membawa manfaat. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni - layanan agen.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Itu diinstal pada setiap server dengan database dan merupakan semacam init-sistem untuk PostgreSQL: itu dimulai, berhenti, restart, mengubah konfigurasi dan topologi cluster. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni menyimpan "negara cluster" di DCS.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk menyimpan status cluster, tampilan saat ini, Anda perlu penyimpanan. </font><font style="vertical-align: inherit;">Patroni menyimpan status dalam sistem eksternal - repositori konfigurasi terdistribusi. </font><font style="vertical-align: inherit;">Ini bisa menjadi salah satu opsi: Etcd, Konsul, ZooKeeper atau Etcd Kubernetes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni AutoFile diaktifkan secara default. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda mendapatkan filer otomatis dari kotak, segera setelah menginstal Patroni. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus ada banyak hal lain, seperti: konfigurasi servis, membuat replika baru, membuat cadangan, dll. </font><font style="vertical-align: inherit;">Namun kali ini akan tetap berada di luar ruang lingkup laporan.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tujuan utama Patroni adalah untuk menyediakan pengarsipan otomatis yang andal.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni tidak harus memantau peralatan, mengirim pemberitahuan, melakukan hal-hal rumit tentang potensi pencegahan kecelakaan, dll. </font><font style="vertical-align: inherit;">Diperlukan bahwa cluster tetap operasional dan aplikasi dapat terus bekerja dengan database, terlepas dari perubahan apa pun dalam topologi cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi ketika kita mulai menggunakan Patroni dengan PostgreSQL, sistem kita menjadi sedikit lebih rumit. </font><font style="vertical-align: inherit;">Sekarang, di samping database itu sendiri, ketika master atau replika gagal, Patroni sendiri, penyimpanan negara-negara cluster, atau jaringan mungkin rusak. </font><font style="vertical-align: inherit;">Pertimbangkan semua pilihan karena mereka menjadi lebih rumit dalam hal betapa sulitnya memahami penyebabnya.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 1. DBMS dan DCS pada cluster yang sama</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertimbangkan kasus paling sederhana: kami mengambil cluster basis data dan menggunakan DCS pada cluster yang sama. </font><font style="vertical-align: inherit;">Kesalahan umum ini tidak hanya terkait dengan kesalahan penggunaan PostgreSQL dan Patroni. </font><font style="vertical-align: inherit;">Ini adalah kesalahan dalam konstruksi umum arsitektur - menggabungkan banyak komponen yang berbeda di satu tempat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, ada kegagalan. </font><font style="vertical-align: inherit;">Kami mulai mengerti apa yang terjadi. </font><font style="vertical-align: inherit;">Di sini kita tertarik ketika feylover terjadi, yaitu </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">titik waktu ketika negara cluster berubah.</font></font></strong><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kapan kegagalan itu terjadi?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faylover tidak selalu terjadi secara instan, tetapi dapat menghabiskan waktu. </font><font style="vertical-align: inherit;">Oleh karena itu, ia memiliki waktu mulai dan waktu akhir. </font><font style="vertical-align: inherit;">Semua acara dibagi menjadi "sebelum", "selama" dan "setelah" feylover. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama-tama, ketika feylover terjadi, kami mencari alasannya.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2<font></font>
pgdb-2 patroni: INFO: updated leader lock during promote<font></font>
pgdb-2 patroni: server promoting<font></font>
pgdb-2 patroni: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di atas adalah log Patroni standar, di mana ia melaporkan bahwa peran server telah berubah dan peran wizard telah berpindah dari yang lain ke simpul ini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa kegagalan itu terjadi?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, Anda perlu memahami peristiwa apa yang membuat peran master beralih dari satu node ke node lain, apa yang terjadi pada master lama.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: patroni.utils.RetryFailedError: 'Exceeded retry deadline'<font></font>
pgdb-2 patroni: ERROR: Error communicating with DCS<font></font>
pgdb-2 patroni: INFO: demoted self because DCS is not accessible and i was a leader<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, semuanya sederhana: </font></font><code>Error communicating with DCS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- kesalahan berinteraksi dengan sistem penyimpanan konfigurasi. </font><font style="vertical-align: inherit;">Sang master menyadari bahwa dia tidak bisa bekerja dengan DCS, dan mengatakan bahwa dia tidak bisa lagi menjadi seorang master dan mengundurkan diri. </font></font><code>demoted self</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">berbicara tentang ini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang mendahului feylover?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda melihat peristiwa yang mendahului feylover, Anda dapat melihat alasan yang menjadi masalah bagi penyihir untuk melanjutkan:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: ERROR: touch_member<font></font>
                ... python trace <font></font>
pgdb-2 patroni: socket.timeout: timed out <font></font>
pgdb-2 patroni: During handling of the above exception, another exception occurred:<font></font>
                ... python trace <font></font>
pgdb-2 patroni:   raise ReadTimeoutError(self, url, "Read timed out. (read timeout=%s)" % timeout_value) <font></font>
pgdb-2 patroni: urllib3.exceptions.ReadTimeoutError: HTTPConnectionPool(host='127.0.0.1', port=8500): Read timed out. (read timeout=3.3333333333333335) <font></font>
pgdb-2 patroni: During handling of the above exception, another exception occurred:<font></font>
                ... python trace <font></font>
pgdb-2 patroni:     raise MaxRetryError(_pool, url, error or ResponseError(cause)) <font></font>
pgdb-2 patroni: urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='127.0.0.1', port=8500): Max retries exceeded with url: /v1/kv/service/pgdb/members/pgdb-2?acquire=19598b72-c0d5-f066-5d24-09c1a9ad61ee&amp;dc=maindb (Caused by ReadTimeoutError("HTTPConnectionPool(host='127.0.0.1', port=8500): Read timed out. (read timeout=3.3333333333333335)",)) <font></font>
pgdb-2 patroni: INFO: no action.  i am the leader with the lock <font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Log patroni menunjukkan banyak kesalahan batas waktu yang berbeda. </font><font style="vertical-align: inherit;">Agen Patroni tidak dapat bekerja dengan DCS (dalam hal ini, itu adalah Konsul, port = 8500). </font><font style="vertical-align: inherit;">Patroni dan database berjalan pada host yang sama, dan server Consul berjalan pada host yang sama. </font><font style="vertical-align: inherit;">Setelah membuat beban di server, kami juga menciptakan masalah untuk server Konsul, karena itu mereka tidak dapat berkomunikasi secara normal.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semuanya kembali seperti semula</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah beberapa saat, ketika beban mereda, Patroni kami dapat berkomunikasi lagi dengan para agen, semuanya kembali:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2<font></font>
pgdb-2 patroni: INFO: updated leader lock during promote<font></font>
pgdb-2 patroni: server promoting<font></font>
pgdb-2 patroni: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Server pgdb-2 yang sama kembali menjadi master. </font><font style="vertical-align: inherit;">Ada "flip" kecil - dalam waktu yang relatif singkat ia mengundurkan diri dari dirinya sendiri sebagai seorang master, kemudian kembali mengambilnya sendiri. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini bisa dianggap positif palsu, atau fakta bahwa Patroni melakukan semuanya dengan benar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memutuskan untuk diri kami sendiri bahwa masalahnya adalah bahwa server Konsul berada pada perangkat keras yang sama dengan database. </font><font style="vertical-align: inherit;">Karenanya, setiap beban pada CPU dan disk (permintaan IO berat, file sementara, auto-vacuums, migrasi, cadangan, dll.) Juga mempengaruhi interaksi dengan cluster Konsul. </font><font style="vertical-align: inherit;">Kami memutuskan bahwa ini tidak boleh hidup pada peralatan yang sama dengan database, dan mengalokasikan cluster terpisah untuk Konsul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atau, Anda dapat memutar parameter </font></font><code>ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>loop_wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>retry_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, coba karena peningkatan mereka untuk bertahan hidup beban puncak jangka pendek. </font><font style="vertical-align: inherit;">Tetapi jika bebannya panjang, kita akan melampaui parameter ini, dan metode ini tidak akan berfungsi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 2. Pemadaman</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalah kedua mirip dengan yang pertama di mana kita lagi memiliki masalah berinteraksi dengan sistem DCS:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: ERROR: get_cluster <font></font>
maindb-1 patroni: Traceback (most recent call last):<font></font>
                ... python trace <font></font>
maindb-1 patroni: RetryFailedError: 'Exceeded retry deadline' <font></font>
maindb-1 patroni: ERROR: Error communicating with DCS <font></font>
maindb-1 patroni: INFO: closed patroni connection to the postgresql cluster <font></font>
maindb-1 patroni: INFO: postmaster pid=214121 <font></font>
... <font></font>
... <font></font>
maindb-1 patroni: INFO: demoted self because DCS is not accessible and i was a leader <font></font>
maindb-1 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni lagi mengatakan bahwa itu tidak dapat berinteraksi dengan DCS, sehingga master saat ini berhenti menjadi master dan memasuki mode replika. </font><font style="vertical-align: inherit;">Tuan tua menjadi replika:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: INFO: Lock owner: maindb-2; I am maindb-1 <font></font>
maindb-1 patroni: INFO: does not have lock <font></font>
maindb-1 patroni: INFO: running pg_rewind from maindb-2 <font></font>
maindb-1 patroni: INFO: running pg_rewind from user=postgres host=192.168.11.18 port=5432 ... <font></font>
maindb-1 patroni: servers diverged at WAL location 1FA/A38FF4F8 on timeline 6 <font></font>
maindb-1 patroni: rewinding from last common checkpoint at 1FA/A38FF450 on timeline 6 <font></font>
maindb-1 patroni: INFO: Lock owner: maindb-2; I am maindb-1 <font></font>
maindb-1 patroni: INFO: running pg_rewind from maindb-2 in progress <font></font>
maindb-1 patroni: Done!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini Patroni bekerja sebagaimana mestinya - diluncurkan </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk memundurkan log transaksi, kemudian terhubung ke master baru dan sudah mengejar ketinggalan dengan master baru.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang mendahului feylover?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita temukan hal pertama yang mendahului feylover - kesalahan yang menyebabkannya. </font><font style="vertical-align: inherit;">Log Patroni nyaman dalam hal ini: ia menulis pesan yang sama dengan interval tertentu. </font><font style="vertical-align: inherit;">Anda dapat dengan cepat menggulirnya dan melihat kapan log telah berubah. </font><font style="vertical-align: inherit;">Pada titik ini, beberapa masalah dimulai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam situasi normal, log Patroni terlihat seperti ini:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: INFO: Lock owner: maindb-1; I am maindb-1<font></font>
maindb-1 patroni: INFO: no action. i am the leader with the lock<font></font>
maindb-1 patroni: INFO: Lock owner: maindb-1; I am maindb-1<font></font>
maindb-1 patroni: INFO: no action. i am the leader with the lock</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pemilik kunci diperiksa, jika itu berubah, peristiwa dapat terjadi yang Patroni harus menanggapi. Dalam hal ini, semuanya beres dengan kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menggulir ke tempat di mana kesalahan mulai muncul, kita melihat bahwa pengarsipan otomatis terjadi. Karena kesalahan terkait dengan interaksi dengan DCS, kami juga melihat log Konsul - apa yang terjadi di sana. Kira-kira membandingkan waktu faylover dan waktu di log Konsul, kita melihat bahwa tetangga di cluster Konsul mulai meragukan keberadaan peserta lain:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-2 consul[11581]: serf: EventMemberFailed: maindb-1 192.168.11.19<font></font>
maindb-2 consul[11581]: [INFO] serf: EventMemberFailed: maindb-1 192.168.11.19<font></font>
maindb-2 consul[11581]: memberlist: Suspect maindb-1 has failed, no acks received<font></font>
maindb-2 consul[11581]: [INFO] memberlist: Suspect maindb-1 has failed, no acks received</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda melihat log agen Konsul lain, itu juga menunjukkan bahwa ada keruntuhan jaringan: semua anggota cluster Konsul saling meragukan. </font><font style="vertical-align: inherit;">Ini adalah dorongan untuk feylover. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita melihat entri yang lebih awal, kita akan melihat bahwa sistem Konsul untuk agen PostgreSQL memiliki kesulitan dengan komunikasi ( </font></font><code>deadline reached</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RPC failed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 consul: memberlist: Suspect lbs-4 has failed, no acks received<font></font>
maindb-1 consul: [ERR] yamux: keepalive failed: i/o deadline reached<font></font>
maindb-1 consul: yamux: keepalive failed: i/o deadline reached<font></font>
maindb-1 consul: [ERR] consul: "KVS.List" RPC failed to server 192.168.11.115:8300: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] http: Request GET /v1/kv/service/sam_prod/?recurse=1, error: rpc error making call: EOF from=192.168.11.19<font></font>
maindb-1 consul: [ERR] consul: "KVS.List" RPC failed to server 192.168.11.115:8300: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] agent: Coordinate update error: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] http: Request GET /v1/kv/service/sam_prod/?recurse=1, error: rpc error making call: EOF from=192.168.11.19</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jawaban paling sederhana adalah </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memperbaiki jaringan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mudah untuk dinasihati, tetapi keadaannya bisa berbeda, dan ini tidak selalu memungkinkan. </font><font style="vertical-align: inherit;">Sistem dapat hidup di pusat data, di mana kita tidak dapat memengaruhi peralatan. </font><font style="vertical-align: inherit;">Perlu opsi lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada opsi solusi tanpa bekerja dengan jaringan:</font></font><br>
<br>
<ul>
<li><strong> Consul-</strong> — <code>checks: []</code>.<br>
   ,     .    ,    Consul-    .           .</li>
<li><strong></strong> <code>raft_multiplier</code>.<br>
   Consul-,     5 (      staging-).         Consul-.  -   .</li>
<li><strong></strong> <code>renice -n -10 consul</code>.<br>
        .  renice   .          Consul-,             .</li>
<li><strong>   consul?</strong><br>
Consul-         . Patroni   Consul-    ,     :    - ,  Patroni      .   etcd,     ,    etcd   . Patroni      etcd-.    -  ,     ,   ,     Consul.</li>
<li><strong>  </strong> <code>ttl, loop_wait, retry_timeout</code>.<br>
     ,         .     Patroni       .</li>
</ul><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 3. Kehilangan simpul</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda menggunakan Patroni, maka Anda terbiasa dengan perintah daftar patronictl, yang menunjukkan keadaan cluster saat ini:</font></font><br>
<br>
<pre><code class="xml hljs">$ patronictl list<font></font>
<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
|     Cluster     |          Member         |     Host     |  Role  |  State  | Lag in MB |<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
| patroni_cluster | pg01.dev.zirconus.local | 10.202.1.101 |        | running |    0.0    |<font></font>
| patroni_cluster | pg03.dev.zirconus.local | 10.202.1.103 | Leader | running |    0.0    |<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekilas, kesimpulan seperti itu mungkin tampak normal - ada master, replika, tetapi tidak ada lag replikasi. </font><font style="vertical-align: inherit;">Tapi gambar ini normal sampai kita tahu bahwa di cluster ini harus ada 3 node, dan bukan 2.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa kegagalan itu terjadi?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memahami bahwa pengarsipan otomatis terjadi dan setelah itu satu replika menghilang. </font><font style="vertical-align: inherit;">Kita perlu mencari tahu mengapa dia menghilang, dan membawanya kembali. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mempelajari kembali log untuk memahami mengapa filer otomatis terjadi:</font></font><br>
<br>
<pre><code class="xml hljs">pg02 patroni[1425]: ERROR: failed to update leader lock<font></font>
pg02 patroni[1425]: INFO: demoted self because failed to update leader lock in DCS<font></font>
pg02 patroni[1425]: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pg02 patroni[1425]: INFO: Lock owner: None; I am pg02.dev.zirconus.local<font></font>
pg02 patroni[1425]: INFO: not healthy enough for leader race<font></font>
pg02 patroni[1425]: INFO: starting after demotion in progress</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Master pg02 tidak dapat memperbarui kunci master </font></font><code>ERROR: failed to update leader lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian replika db03 kedua menjadi master, semuanya tertata di sini:</font></font><br>
<br>
<pre><code class="xml hljs">pg03 patroni[9648]: INFO: promoted self to leader by acquiring session lock<font></font>
pg03 patroni[9648]: server promoting<font></font>
pg03 patroni[9648]: INFO: cleared rewind state after becoming the leader</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana dengan tuan tua?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pg02, memutuskan untuk menjadi replika, mulai dengan memutar ulang log transaksi. </font><font style="vertical-align: inherit;">Di sini kita perlu melihat log replika, yang tidak ada di cluster. </font><font style="vertical-align: inherit;">Buka log Patroni dan lihat bahwa selama proses menghubungkan ke cluster, muncul masalah di panggung </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="xml hljs">pg02 patroni[1425]: INFO: running pg_rewind from pg03<font></font>
pg02 patroni[1425]: INFO: running pg_rewind from user=postgres host=10.202.1.103 port=5432 ...<font></font>
pg02 patroni[1425]: servers diverged at WAL location 33F/68E6AD10 on timeline 28<font></font>
pg02 patroni[1425]: could not open file "/data/pgdb/11/pg_wal/0000001C0000033F00000059": No such file or directory<font></font>
pg02 patroni[1425]: could not find previous WAL record at 33F/59FFE368 pg02 patroni[1425]: Failure, exiting<font></font>
pg02 patroni[1425]: ERROR: Failed to rewind from healty master: pg03<font></font>
pg02 patroni[1425]: WARNING: Postgresql is not running.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk terhubung ke gugus, simpul harus meminta log transaksi dari penyihir dan menangkap penyihir darinya. </font><font style="vertical-align: inherit;">Dalam hal ini, tidak ada log transaksi ( </font></font><code>No such file or directory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), dan replika tidak dapat dimulai. </font><font style="vertical-align: inherit;">Dengan demikian, PostgreSQL berhenti dengan kesalahan. </font><font style="vertical-align: inherit;">Anda perlu memahami mengapa tidak ada log transaksi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat apa yang dimiliki master baru di WAL:</font></font><br>
<br>
<pre><code class="xml hljs">LOG: checkpoint complete:<font></font>
wrote 62928 buffers (16.0%); 0 WAL file(s) added, 0 removed, 23 recycled;<font></font>
write=12.872 s, sync=0.020 s, total=13.001 s;<font></font>
sync files=16, longest=0.009 s, average=0.001 s;<font></font>
distance=520220 kB, estimate=520220 kB</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ternyata ketika sedang berjalan </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sebuah pos pemeriksaan terjadi, dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beberapa log transaksi lama diganti namanya</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ketika master lama mencoba untuk terhubung ke master baru dan meminta log ini, mereka sudah berganti nama, mereka tidak ada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menurut stempel waktu, waktu antara peristiwa ini adalah 150 ms.</font></font><br>
<br>
<pre><code class="xml hljs">2019-08-26 00:06:11,369 LOG: checkpoint complete<font></font>
2019-08-26 00:06:11,517 INFO: running pg_rewind</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi ini sudah cukup untuk membuat replika tidak dapat terhubung dan menghasilkan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Awalnya, kami menggunakan slot replikasi. Solusi ini tampak baik bagi kami, meskipun pada tahap pertama operasi kami mematikan slot. Kami berpikir bahwa jika slot akan mengakumulasi banyak segmen, master bisa jatuh. Setelah beberapa saat menderita tanpa slot, kami menyadari bahwa kami membutuhkannya dan mengembalikannya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalahnya adalah bahwa ketika wizard memasuki keadaan replika, wizard menghapus slot dan wal-segmen bersama dengannya. Untuk meratakan masalah ini, kami meningkatkan parameter </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Secara default, itu sama dengan 8 segmen, kami </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">naik </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menjadi 1000</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Kami mengalokasikan 16 GB pada </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan sekarang, ketika beralih, kami selalu memiliki 16 GB log transaksi di semua node.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini juga berlaku untuk tugas pemeliharaan jangka panjang. </font><font style="vertical-align: inherit;">Katakanlah kita perlu memperbarui salah satu replika (perangkat lunak, OS, sesuatu yang lain), dan kami ingin mematikannya. </font><font style="vertical-align: inherit;">Ketika kami mematikan replika, slot juga dihapus untuk itu. </font><font style="vertical-align: inherit;">Jika Anda menggunakan nilai parameter kecil </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, maka dengan tidak adanya replika yang lama, itu akan meminta log transaksi yang bahkan mungkin tidak muncul di wizard - maka replika tidak akan dapat terhubung. </font><font style="vertical-align: inherit;">Karena itu, kami menyimpan banyak majalah.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 4. Kehilangan Data</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terjadi kegagalan pada basis produksi. </font><font style="vertical-align: inherit;">Kami memeriksa cluster: semuanya dalam urutan, semua replika sudah ada, tidak ada lag replikasi, dan tidak ada kesalahan dalam log juga. </font><font style="vertical-align: inherit;">Tetapi tim produk melaporkan bahwa tidak ada </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cukup data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam </font><strong><font style="vertical-align: inherit;">database</font></strong><font style="vertical-align: inherit;"> - mereka berada dalam satu sumber, tetapi tidak dalam database. </font><font style="vertical-align: inherit;">Anda perlu memahami apa yang terjadi pada mereka. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami segera menyadari bahwa ini adalah </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selai mereka, tetapi kami perlu mencari tahu alasannya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kapan kegagalan itu terjadi?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita selalu dapat menemukan di log ketika feylover terjadi, yang menjadi master baru, yang adalah master sebelum dan ketika dia ingin menjadi replika.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-1 patroni[17836]: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-1 patroni[17836]: server promoting<font></font>
pgdb-1 patroni[17836]: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-1 patroni[17836]: INFO: Lock owner: pgdb-1; I am pgdb-1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari log, kita dapat menentukan berapa banyak log transaksi telah hilang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti ini: wizard lama di-reboot, setelah di-restart oleh autorun, Patroni diluncurkan, yang kemudian meluncurkan PostgreSQL. </font><font style="vertical-align: inherit;">PostgreSQL memutuskan untuk menjadi anggota cluster Patroni dan meluncurkan proses </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang pada gilirannya menghapus bagian dari log transaksi, mengunduh yang baru, dan terhubung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni bekerja persis seperti yang dimaksudkan. </font><font style="vertical-align: inherit;">Cluster pulih: ada 3 node, setelah feylover 3 node dan kiri. </font><font style="vertical-align: inherit;">Tetapi sebagian data hilang, dan Anda perlu memahami bagian apa itu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temukan di log master lama saat itu terjadi </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni[4149]: INFO: running pg_rewind from pgdb-1<font></font>
pgdb-2 patroni[4149]: Lock owner: pgdb-1; I am pgdb-2<font></font>
pgdb-2 patroni[4149]: Deregister service pgdb/pgdb-2<font></font>
pgdb-2 patroni[4149]: running pg_rewind from pgdb-1 in progress<font></font>
pgdb-2 patroni[4149]: running pg_rewind from user=replica host=10.10.1.31 port=5432 ...<font></font>
pgdb-2 patroni[4149]: servers diverged at WAL location 0/5AD1BFD8 on timeline 66<font></font>
pgdb-2 patroni[4149]: rewinding from last common checkpoint at 0/59DD1070 on timeline 66<font></font>
pgdb-2 patroni[4149]: Done!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda perlu menemukan posisi dalam log transaksi, yang menghentikan master lama.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni[4149]: INFO: Local timeline=66 lsn=0/5BDA8EB8<font></font>
pgdb-2 patroni[4149]: INFO: master_timeline=67<font></font>
...<font></font>
pgdb-2 patroni[4149]: servers diverged at WAL location 0/5AD1BFD8 on timeline 66<font></font>
postgres=# select pg_wal_lsn_diff('0/5BDA8EB8','0/5AD1BFD8');<font></font>
pg_wal_lsn_diff<font></font>
----------------<font></font>
17354464</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, itu adalah tanda 0 / 5BDA8EB8. </font><font style="vertical-align: inherit;">Tanda kedua - 0 / 5AD1BFD8 - diperlukan untuk menemukan jarak dengan mana master lama berbeda dari yang baru. </font><font style="vertical-align: inherit;">Dengan menggunakan fungsi ini </font></font><code>pg_wal_lsn_diff </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, kami membandingkan dua tanda ini, kami mendapatkan 17 MB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apakah ada kehilangan data sebesar 17 MB, semua orang memutuskan sendiri. </font><font style="vertical-align: inherit;">Bagi sebagian orang, ini tidak signifikan, tetapi bagi seseorang itu tidak bisa diterima. </font><font style="vertical-align: inherit;">Masing-masing untuk dirinya sendiri menentukan sesuai dengan kebutuhan bisnis.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama-tama, Anda perlu memutuskan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apakah Patroni autostart selalu diperlukan setelah mem-boot ulang sistem</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Paling sering, kita harus pergi ke master lama, melihat betapa berbedanya itu dari keadaan saat ini, mungkin memeriksa segmen log transaksi. Anda perlu memahami apakah data ini bisa hilang, atau Anda perlu menjalankan wizard lama dalam mode mandiri untuk menarik data. Hanya setelah itu membuat keputusan apa yang harus dilakukan dengan data dan menghubungkan simpul ini sebagai replika ke cluster kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, ada parameter</font></font><code>maximum_lag_on_failover</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, secara default nilainya 1 Mb. Kerjanya seperti ini: jika replika adalah 1 MB di belakang lag replikasi, maka replika ini tidak mengambil bagian dalam pemilihan. Jika tiba-tiba terjadi failover, Patroni melihat di mana replika berada di belakang, dan replika yang berada di belakang sejumlah besar log transaksi tidak dapat menjadi master. Ini adalah fitur keamanan yang baik yang mencegah Anda kehilangan terlalu banyak data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi ada masalah: lag replikasi diperbarui pada interval tertentu, nilai </font></font><code>ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">standarnya adalah 30 detik. Sangat mungkin bahwa nilai lag replikasi untuk replika di DCS adalah satu, tetapi sebenarnya itu sama sekali berbeda atau tidak ada lag sama sekali. Ini bukan nilai waktu nyata, itu tidak selalu mencerminkan gambaran nyata dan tidak layak mengikat logika yang rumit untuk itu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Risiko "kerugian" selalu tetap:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam kasus terburuk: </font></font><code>maximum_lag_on_failover + ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam kasus rata-rata: </font></font><code>maximum_lag_on_failover + (loop_wait / 2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika Anda berencana untuk menerapkan Patroni dan mengevaluasi berapa banyak data yang Anda bisa kehilangan, pertimbangkan formula ini untuk secara kasar mewakili kemungkinan kerugian. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kabar baiknya adalah bahwa mungkin ada WAL dari proses latar belakang dalam "kerugian". </font><font style="vertical-align: inherit;">Data ini dapat dengan mudah diabaikan dan hilang, tidak ada masalah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti inilah tampilan log jika diatur </font></font><code>maximum_lag_on_failover</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, terjadi feylover dan Anda perlu memilih wizard baru:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-1 patroni[6202]: INFO: Lock owner: None; I am pgdb-1<font></font>
pgdb-1 patroni[6202]: INFO: not healthy enough for leader race<font></font>
pgdb-1 patroni[6202]: INFO: changing primary_conninfo and restarting in progress<font></font>
...<font></font>
pgdb-1 patroni[6202]: INFO: following a different leader because i am not the healthiest node<font></font>
pgdb-1 patroni[6202]: INFO: following a different leader because i am not the healthiest node</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Replika hanya melihat bahwa dia </font></font><code>not healthy enough for leader race</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan menolak untuk berpartisipasi dalam perlombaan kepemimpinan. </font><font style="vertical-align: inherit;">Oleh karena itu, ia hanya menunggu wizard baru untuk dipilih untuk terhubung dengannya. </font><font style="vertical-align: inherit;">Ini adalah tindakan tambahan terhadap kehilangan data.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 5. Drive</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tim produk menulis bahwa aplikasi tersebut memiliki masalah dalam bekerja dengan PostgreSQL. </font><font style="vertical-align: inherit;">Pada saat yang sama, Anda tidak dapat memasukkan master, karena tidak tersedia melalui SSH, tetapi pengarsipan otomatis tidak terjadi juga. </font><font style="vertical-align: inherit;">Kemudian tuan rumah secara paksa reboot dan dengan demikian meluncurkan auto-filer. </font><font style="vertical-align: inherit;">Meskipun dimungkinkan untuk membuat feylover manual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah reboot, kita pergi untuk melihat apa yang terjadi pada master. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_1/2u/rj/_12urj0aobgqg0pp2gkkuolhjog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami tahu sebelumnya tentang masalah dengan disk, dengan memantau kami tahu di mana harus menggali. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam log PostgreSQL, kita melihat yang berikut:</font></font><br>
<br>
<pre><code class="xml hljs">[COMMIT] LOG: duration: 1138.868 ms statement: COMMIT<font></font>
...<font></font>
[] WARNING: autovacuum worker started without a worker entry<font></font>
...<font></font>
[SELECT] LOG: temporary file: path "base/pgsql_tmp/pgsql_tmp11247.983", size 532996096<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di muka adalah semua indikator masalah dengan disk: melakukan yang berlangsung selama satu detik, autovacuum berjalan sangat lama dan aneh, dan file sementara pada disk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami melihat ke dalam sistem dmesg - log pesan kernel, dan melihat masalah dengan salah satu disk:</font></font><br>
<br>
<pre><code class="xml hljs">md/raid10:md2: sde3: rescheduling sector 351273392<font></font>
blk_update_request: I/O error, dev sde, sector 64404728<font></font>
md/raid10:md2: sde3: rescheduling sector 63161592<font></font>
blk_update_request: I/O error, dev sde, sector 64404760<font></font>
...<font></font>
md2 : active raid10 sda3[0] sdc3[2] sdd3[3] sdb3[1] sdh3[7] sdf3[5] sdg3[6]<font></font>
      15623340032 blocks super 1.2 512K chunks 2 near-copies [8/7] [UUUUUUU_]<font></font>
      bitmap: 58/59 pages [232KB], 131072KB chunk</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Subsistem disk pada server adalah perangkat lunak Raid 8 disk, tetapi satu hilang. </font><font style="vertical-align: inherit;">Garis </font></font><code>sda3[0] sdc3[2] sdd3[3] sdb3[1] sdh3[7] sdf3[5] sdg3[6]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak ada </font></font><code>sde[4]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Secara relatif, satu disk terjatuh, ini menyebabkan masalah disk, dan aplikasi mengalami masalah bekerja dengan cluster PostgreSQL.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, Patroni tidak akan dapat membantu, karena Patroni tidak memiliki tugas untuk memantau status server dan disk. </font><font style="vertical-align: inherit;">Selama masalah, Patroni terus berinteraksi dengan gugus DCS dan tidak melihat kesulitan. </font><font style="vertical-align: inherit;">Untuk situasi seperti itu, pemantauan eksternal diperlukan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah 6. Simulator klaster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah salah satu masalah aneh. </font><font style="vertical-align: inherit;">Saya mempelajarinya untuk waktu yang sangat lama, membaca kembali banyak log dan menyebutnya "Cluster simulator". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalahnya adalah bahwa tuan tua itu tidak bisa menjadi isyarat normal. </font><font style="vertical-align: inherit;">Patroni menjalankannya, menunjukkan bahwa simpul ini hadir sebagai replika, tetapi pada saat yang sama itu bukan replika normal, sekarang Anda akan melihat alasannya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya dimulai, seperti pada kasus sebelumnya, dengan masalah disk:</font></font><br>
<br>
<pre><code class="xml hljs">14:48:55.601 [COMMIT] LOG: duration: 1478.118 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1290.203 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1778.465 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1778.449 ms statement: COMMIT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada koneksi yang terputus:</font></font><br>
<br>
<pre><code class="xml hljs">14:48:58.078 [idle in transaction] LOG: could not send data to client: Broken pipe<font></font>
14:48:58.078 [idle] LOG: could not send data to client: Broken pipe<font></font>
14:48:58.078 [idle] FATAL: connection to client lost<font></font>
14:48:58.107 [idle in transaction] FATAL: connection to client lost</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada harapan yang panjang akan respons dan pemblokiran dari berbagai tingkat keparahan:</font></font><br>
<br>
<pre><code class="xml hljs">14:49:26.929 [UPDATE waiting] LOG: process 4298 acquired ExclusiveLock on tuple (2,10) of relation 52082 of database 50587 after 52487.463 ms<font></font>
14:49:26.929 [UPDATE waiting] STATEMENT: UPDATE sessions SET lastaccess='1565005714' WHERE sessionid=...<font></font>
14:49:27.929 [UPDATE waiting] LOG: process 4298 still waiting for ShareLock on transaction 364118337 after 1000.088 ms<font></font>
14:49:27.929 [UPDATE waiting] DETAIL: Process holding the lock: 4294. Wait queue: 4298.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, ada masalah yang jelas dengan disk, termasuk file sementara lagi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi yang paling misterius bagi saya - terbang </font></font><code>immediate shutdown request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">14:49:34.102 MSK 5335 @ from [] LOG: received immediate shutdown request<font></font>
14:49:34.689 [authentication] WARNING: terminating connection because of crash of another server process<font></font>
14:49:34.689 [authentication] DETAIL: The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL memiliki tiga mode mematikan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anggun ketika kita menunggu semua klien untuk memutuskan sendiri.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cepat, ketika kami memberitahu pelanggan untuk memutuskan sambungan, karena kami akan mematikan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segera, yang tidak memberi tahu klien bahwa perlu memutus sambungan, tetapi cukup mematikannya dan mengirim pesan RST ke semua klien (sinyal TCP bahwa koneksi terputus).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proses latar belakang PostgreSQL tidak saling mengirim sinyal permintaan shutdown, tetapi hanya meresponsnya. </font><font style="vertical-align: inherit;">Ini restart darurat, dan siapa yang mengirimnya tidak jelas. </font><font style="vertical-align: inherit;">Jika ya </font></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, maka saya akan melihatnya di log, tetapi tidak ada di sana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Memahami lebih jauh, saya melihat bahwa Patroni tidak menulis ke log untuk beberapa waktu - tidak ada pesan selama 54 detik. </font><font style="vertical-align: inherit;">Selama waktu ini, salah satu replika yang dibuat "mempromosikan" dan pengarsipan otomatis terjadi:</font></font><br>
<br>
<pre><code class="xml hljs">pgsql03 patroni: 14:48:25,000 INFO: Lock owner: pgsql03; I am pgsql03 <font></font>
pgsql03 patroni: 14:48:25,013 INFO: no action.  i am the leader with the lock <font></font>
pgsql03 patroni: 14:48:37,159 INFO: Lock owner: pgsql03; I am pgsql03 <font></font>
pgsql03 patroni: 14:49:31,155 WARNING: Exception hened during processing of request from 10.1.0.12 <font></font>
pgsql03 patroni: 14:49:31,297 WARNING: Exception hened during processing of request from 10.1.0.11 <font></font>
pgsql03 patroni: 14:49:31,298 WARNING: Exception hened during processing of request from 10.1.0.11</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni bekerja dengan sempurna lagi di sini, master lama tidak tersedia, jadi pemilihan master baru dimulai.</font></font><br>
<br>
<pre><code class="xml hljs">pgsql01 patroni: 14:48:57,136 INFO: promoted self to leader by acquiring session lock<font></font>
pgsql01 patroni: server promoting<font></font>
pgsql01 patroni: 14:48:57,214 INFO: cleared rewind state after becoming the leader<font></font>
pgsql01 patroni: 14:49:05,013 INFO: Lock owner: pgsql01; I am pgsql01<font></font>
pgsql01 patroni: 14:49:05,023 INFO: updated leader lock during promote</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pgsql01 menjadi pemimpin baru, dan hanya ada masalah dengan replika kedua. </font><font style="vertical-align: inherit;">Dia dengan jujur ​​mencoba mengkonfigurasi ulang:</font></font><br>
<br>
<pre><code class="xml hljs">pgsql02 patroni: 14:48:57,124 INFO: Could not take out TTL lock <font></font>
pgsql02 patroni: 14:48:57,137 INFO: following new leader after trying and failing to obtain lock <font></font>
pgsql02 patroni: 14:49:05,014 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:05,025 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:15,011 INFO: Lock owner: pgsql01; I am pgsql02<font></font>
pgsql02 patroni: 14:49:15,014 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:25,011 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:25,014 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:35,011 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:35,014 INFO: changing primary_conninfo and restarting in progress</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dia mencoba mengubah recovery.conf, restart PostgreSQL, sambungkan ke wizard baru. </font><font style="vertical-align: inherit;">Setiap 10 detik ada pesan yang dia coba, tetapi tidak bisa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sementara itu, sinyal langsung-shutdown yang sama terbang ke master lama. </font><font style="vertical-align: inherit;">Wizard memulai reboot darurat, pemulihan juga berhenti. </font><font style="vertical-align: inherit;">Replika tidak dapat terhubung ke master karena berada dalam mode shutdown.</font></font><br>
<br>
<pre><code class="xml hljs">14:49:34.293 [idle] LOG:  received replication command: IDENTIFY_SYSTEM <font></font>
WARNING:  terminating connection because of crash of another server process <font></font>
DETAIL:  The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory. <font></font>
14:49:35.232 FATAL:  could not receive data from WAL stream: server closed the connection unexpectedly             <font></font>
        This probably means the server terminated abnormally <font></font>
        before or while processing the request. <font></font>
14:49:35.232 LOG:  record with incorrect prev-link 142D46/315602C at 14CF/CF38C160 <font></font>
14:49:35.305 FATAL: could not connect to the primary server: FATAL: the database system is shutting down <font></font>
14:49:40.241 FATAL: could not connect to the primary server: FATAL: the database system is shutting down</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada titik tertentu, replika berhasil, tetapi replikasi tidak dimulai.</font></font><br>
<br>
<pre><code class="xml hljs">14:50:14.024 [] LOG:  record with incorrect prev-link 142D46/315602C at 14CF/CF38C160 <font></font>
14:50:14.028 [] LOG:  fetching timeline history file for timeline 72 from primary server <font></font>
14:50:14.104 [] FATAL:  could not start WAL streaming: ERROR:  requested starting point 14CF/CF000000 on timeline 71 is not in this server's history        <font></font>
DETAIL:  This server's history forked from timeline 71 at 14CF/CEC32E40. <font></font>
14:50:14.104 [] LOG:  new timeline 72 forked off current database system timeline 71 before current recovery point 14CF/CF38C160</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya punya satu hipotesis: dalam recovery.conf adalah alamat master lama. </font><font style="vertical-align: inherit;">Ketika master baru sudah muncul, replika kedua mencoba untuk terhubung ke master lama. </font><font style="vertical-align: inherit;">Ketika Patroni mulai pada replika kedua, simpul dimulai, tetapi tidak dapat terhubung melalui replikasi. </font><font style="vertical-align: inherit;">Jeda replikasi terbentuk yang terlihat seperti ini:</font></font><br>
<br>
<pre><code class="xml hljs">+-----------------+----------+--------------+--------+---------+-----------+<font></font>
|     Cluster     |  Member  |     Host     |  Role  |  State  | Lag in MB |<font></font>
+-----------------+----------+--------------+--------+---------+-----------+<font></font>
| patroni_cluster |  pgsql01 | 10.2.200.151 | Leader | running |       0.0 |<font></font>
| patroni_cluster |  pgsql02 | 10.2.200.152 |        | running |    9153.0 |<font></font>
| patroni_cluster |  pgsql03 | 10.2.200.153 |        | running |       0.0 |<font></font>
+-----------------+----------+--------------+--------+---------+-----------+</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yaitu, ketiga node berada di tempatnya, tetapi node kedua ada di belakang. </font><font style="vertical-align: inherit;">Replikasi tidak dapat dimulai karena log transaksi berbeda. </font><font style="vertical-align: inherit;">Log transaksi yang ditawarkan oleh wizard, ditunjukkan dalam recovery.conf, tidak cocok dengan simpul saat ini. </font><font style="vertical-align: inherit;">PostgreSQL melaporkan kesalahan setiap 5 detik</font></font><br>
<br>
<pre><code class="xml hljs">14:50:44.143 FATAL:  could not start WAL streaming: ERROR:  requested starting point 14CF/CF000000 on timeline 71 is not in this server's history        <font></font>
         DETAIL:  This server's history forked from timeline 71 at 14CF/CEC32E40. <font></font>
14:50:44.143 LOG:  new timeline 72 forked off current database system timeline 71 before current recovery point 14CF/ CF38C160</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini saya membuat kesalahan dan tidak menguji hipotesis saya bahwa kami terhubung ke master yang salah. </font><font style="vertical-align: inherit;">Saya baru saja memulai kembali Patroni pada replika. </font><font style="vertical-align: inherit;">Jujur, saya sudah mengakhiri itu dan berpikir bahwa saya harus mengulanginya, tetapi masih memutuskan untuk mencoba memulai kembali.</font></font><br>
<br>
<pre><code class="xml hljs">15:14:13.511 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:14:13.511 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pemulihan dimulai, dan bahkan basis data dibuka, ia siap menerima koneksi, replikasi dimulai:</font></font><br>
<br>
<pre><code class="xml hljs">15:14:17.072 LOG: record with incorrect prev-link 142D46/315602C at 14CF/CF38C160<font></font>
15:14:17.077 LOG: started streaming WAL from primary at 14CF/CF000000 on timeline 72<font></font>
15:14:17.536 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi semenit kemudian dia jatuh dengan kesalahan </font></font><code>terminating walreceiver process due to administrator command</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- replika mengatakan bahwa log transaksi tidak cocok untuknya.</font></font><br>
<br>
<pre><code class="xml hljs">15:15:27.823 FATAL: terminating walreceiver process due to administrator command<font></font>
15:15:27.895 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1<font></font>
15:15:27.895 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan saya tidak me-restart PostgreSQL, tetapi Patroni-lah yang di-restart dengan harapan akan meluncurkan database secara ajaib. </font><font style="vertical-align: inherit;">Replikasi dimulai lagi, tetapi database dibuka di tempat yang sama:</font></font><br>
<br>
<pre><code class="xml hljs">15:17:33.553 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:17:33.554 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Marka dalam log transaksi berbeda, mereka berbeda dari pada percobaan peluncuran sebelumnya - posisi log transaksi lebih awal:</font></font><br>
<br>
<pre><code class="xml hljs">15:17:37.299 LOG: invalid contrecord length 5913 at 14CF/CEFFF7B0<font></font>
15:17:37.304 LOG: started streaming WAL from primary at 14CF/CE000000 on timeline 72</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Replikasi berhenti lagi, dan pesan kesalahannya berbeda dan sekali lagi tidak terlalu informatif:</font></font><br>
<br>
<pre><code class="xml hljs">15:18:12.208 FATAL: terminating walreceiver process due to administrator command<font></font>
15:18:12.240 LOG: record with incorrect prev-link 60995000/589DF000 at 14CF/CEFFF7B0<font></font>
15:18:12.240 LOG: record with incorrect prev-link 60995000/589DF000 at 14CF/CEFFF7B0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk percobaan, dimulai lagi, pangkalan dibuka di tempat yang sama:</font></font><br>
<br>
<pre><code class="xml hljs">15:21:25.135 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:21:25.135 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian muncul ide bagi saya: bahwa jika saya me-restart PostgreSQL, pada titik ini pada wizard saat ini saya akan melakukan pos pemeriksaan untuk memindahkan titik dalam log transaksi sedikit ke depan dan pemulihan dimulai dari saat lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meluncurkan Patroni, membuat beberapa pos pemeriksaan pada master, beberapa titik restart pada replika ketika dibuka:</font></font><br>
<br>
<pre><code class="xml hljs">15:22:43.727 LOG: invalid record length at 14D1/BCF3610: wanted 24, got 0<font></font>
15:22:43.731 LOG: started streaming WAL from primary at 14D1/B000000 on timeline 72</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini berhasil - replikasi dimulai dari tempat yang berbeda dan tidak lagi rusak. </font><font style="vertical-align: inherit;">Tetapi bagi saya ini adalah salah satu masalah paling misterius yang masih saya pikirkan. </font><font style="vertical-align: inherit;">Terutama permintaan penutupan langsung yang aneh itu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari sini kita dapat menyimpulkan: Patroni dapat bekerja sesuai rencana dan tanpa kesalahan, tetapi ini bukan jaminan mutlak bahwa semuanya benar-benar teratur. </font><font style="vertical-align: inherit;">Setelah feylover, Anda selalu perlu mengecek apakah semuanya baik-baik saja dengan cluster: jumlah replika yang tepat, tidak ada jeda replikasi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ringkasan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berdasarkan ini dan banyak masalah serupa lainnya, saya merumuskan rekomendasi umum yang saya sarankan agar Anda ingat ketika mengoperasikan Patroni.</font></font><br>
<br>
<blockquote><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ketika Anda menggunakan Patroni, Anda harus memiliki pemantauan. </font><font style="vertical-align: inherit;">Anda selalu perlu tahu kapan file otomatis terjadi, karena jika Anda tidak tahu bahwa Anda memiliki file otomatis, Anda tidak mengontrol cluster.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;Setelah setiap feylover selalu periksa cluster. </font><font style="vertical-align: inherit;">Anda harus memastikan bahwa: replika selalu nomor saat ini; </font><font style="vertical-align: inherit;">tidak ada penundaan replikasi; </font><font style="vertical-align: inherit;">tidak ada kesalahan dalam log yang terkait dengan replikasi streaming, dengan Patroni, dengan sistem DCS.</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni adalah alat yang sangat bagus, tetapi tidak peduli bagaimana Anda mengatakan itu bukan peluru perak. </font><font style="vertical-align: inherit;">Otomasi dapat berhasil dengan sukses, tetapi pada saat yang sama objek otomasi dapat dalam kondisi setengah bekerja. </font><font style="vertical-align: inherit;">Bagaimanapun, Anda perlu memiliki ide tentang bagaimana PostgreSQL dan replikasi bekerja, bagaimana Patroni mengelola PostgreSQL, dan bagaimana interaksi antar node dipastikan. </font><font style="vertical-align: inherit;">Ini diperlukan untuk dapat memperbaiki masalah yang timbul dengan tangan Anda.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Langkah diagnostik</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kebetulan kami bekerja dengan klien yang berbeda, sebagian besar mereka tidak memiliki tumpukan ELK, dan Anda harus memilah log dengan membuka 2 tab dan 6 konsol: di satu tab Patroni untuk setiap node, di yang lain - log Konsul atau PostgreSQL. </font><font style="vertical-align: inherit;">Mendiagnosis semua ini sulit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya telah mengembangkan pendekatan berikut. </font><font style="vertical-align: inherit;">Saya selalu menonton ketika kegagalan terjadi. </font><font style="vertical-align: inherit;">Bagi saya itu semacam daerah aliran sungai. </font><font style="vertical-align: inherit;">Saya melihat apa yang terjadi sebelum, selama dan setelah feylover. </font><font style="vertical-align: inherit;">Failover memiliki dua cap waktu - mulai dan berakhir. </font><font style="vertical-align: inherit;">Dalam log, saya melihat apa yang mendahului feylover, yaitu, saya mencari alasan. </font><font style="vertical-align: inherit;">Ini memberikan pemahaman tentang gambar apa yang terjadi dan apa yang bisa dilakukan di masa depan sehingga feylover tidak terjadi dalam keadaan yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk ini, saya melihat:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pertama-tama, log Patroni.</font></font></li>
<li>  PostgreSQL   DCS    ,     Patroni.</li>
<li>  —     ,    .</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada banyak produk lain untuk pengarsipan otomatis: stolon, repmgr, pg_auto_failover, PAF. Saya mencoba semua 4 alat dan menurut saya Patroni adalah yang terbaik yang ada di pasaran saat ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apakah saya merekomendasikan Patroni? Jelas, ya, karena saya suka Patroni, saya pikir saya belajar cara memasaknya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda tertarik untuk melihat masalah lain apa yang ada dengan Patroni, selain yang dijelaskan dalam artikel, Anda selalu dapat membuka halaman </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/zalando/patroni/issues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ada banyak kisah berbeda. Terlepas dari kenyataan bahwa setengah dari mereka berasal dari pengguna yang buta huruf yang mengajukan pertanyaan bodoh tanpa repot-repot dengan pencarian sederhana, masalah menarik juga dibahas di sana dan, sebagai hasil dari diskusi, tugas untuk memperbaiki bug dibuka jika perlu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terima kasih kepada Zalando untuk mengembangkan proyek ini, dan juga kepada dua orang yang mulai mengerjakan produk ini: Alexander Kukushkin dan Alexey Klyukin. Terima kasih banyak untuk semua kontributor Patroni. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setelah laporan ini, kami mencatat wawancara singkat di mana Alex mencoba menyesuaikan laporannya ke dalam satu dewan dan memberi tahu mengapa harus berpartisipasi dan berbicara di konferensi. Ambil senjata dan datang untuk memeriksa pendekatan di Saint HighLoad ++.</font></font></i><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lnw02pCpgRw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<blockquote> HighLoad++   6-7 .      ,    .          ,        ( ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a>).      -  <strong></strong>     ,  ,     ,     .<br>
<br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Saint HighLoad++</a>!    ,  ,      PostgreSQL:   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>,     PostgreSQL    JSON    ;   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>   PostgreSQL 13,  ;   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="></a>     .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id489194/index.html">Bagaimana OpenShift mengubah struktur organisasi organisasi TI. Evolusi model organisasi ketika pindah ke PaaS</a></li>
<li><a href="../id489196/index.html">Asap Ajaib: Mikrokontroler vs. Regulator Linier</a></li>
<li><a href="../id489198/index.html">Bagaimana tidak menembak diri sendiri di kaki menggunakan Liquibase</a></li>
<li><a href="../id489200/index.html">Apa yang dicari startups untuk Y Combinator pada tahun 2020</a></li>
<li><a href="../id489204/index.html">Pandangan dari Dalam tentang Keandalan Layanan Facebook</a></li>
<li><a href="../id489210/index.html">Pengujian kinerja kode Linux dengan contoh-contoh</a></li>
<li><a href="../id489212/index.html">1C-Bitrix mencegah berhenti berlangganan buletin dengan persyaratan untuk mengirimkan data pribadi mereka</a></li>
<li><a href="../id489214/index.html">Pendekatan modern untuk menguji lokalisasi di iOS</a></li>
<li><a href="../id489218/index.html">Itu naif. Super: kode dan arsitektur gim sederhana</a></li>
<li><a href="../id489226/index.html">Metode untuk mengoptimalkan kueri LINQ di C # .NET</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>