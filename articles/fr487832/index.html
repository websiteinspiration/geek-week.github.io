<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍸 ⚔️ 🔸 Création de Minecraft en une semaine en C ++ et Vulkan 🐋 🤳🏽 👲🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je me suis fixé la tâche de recréer Minecraft à partir de zéro en une semaine en utilisant mon propre moteur en C ++ et Vulkan. J'ai été inspiré par H...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Création de Minecraft en une semaine en C ++ et Vulkan</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487832/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je me suis fixé la tâche de recréer Minecraft à partir de zéro en une semaine en utilisant mon propre moteur en C ++ et Vulkan. </font><font style="vertical-align: inherit;">J'ai été inspiré par </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hopson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui a fait de même avec C ++ et OpenGL. </font><font style="vertical-align: inherit;">À son tour, il a été inspiré par </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shane Beck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui a été inspiré par Minecraft, dont la source d'inspiration était Infiniminer, dont la création, vraisemblablement, a été inspirée par la vraie exploitation minière.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aa1/8b2/50c/aa18b250ce4120bd3a0dc94c01a63621.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le référentiel GitHub pour ce projet est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Chaque jour a sa propre balise git. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, je n'avais pas l'intention de recréer littéralement Minecraft. </font><font style="vertical-align: inherit;">Ce projet était censé être éducatif. </font><font style="vertical-align: inherit;">Je voulais en savoir plus sur l'utilisation de Vulkan dans quelque chose de plus compliqué que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vulkan-tutorial.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou la démo de Sasha Willem. </font><font style="vertical-align: inherit;">Par conséquent, l'accent est mis principalement sur la conception du moteur Vulkan, et non sur la conception du jeu.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tâches</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le développement sur Vulkan est beaucoup plus lent que sur OpenGL, donc je ne pouvais pas intégrer de nombreuses fonctionnalités de ce Minecraft dans le jeu. </font><font style="vertical-align: inherit;">Il n'y a pas de monstres, pas d'artisanat, pas de pierre rouge, pas de physique des blocs, etc. </font><font style="vertical-align: inherit;">Dès le début, les objectifs du projet étaient les suivants:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création d'un système de rendu de terrain</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brassage</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Éclairage</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création d'un système générateur de terrain</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le soulagement</font></font></li>
</ul><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Des arbres</font></font></li>
</ul><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biomes</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout de la possibilité de changer de terrain et de déplacer des blocs</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je devais trouver un moyen d'implémenter tout cela sans ajouter d'interface graphique au jeu, car je ne trouvais aucune bibliothèque d'interface graphique fonctionnant avec Vulkan et facile à intégrer.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bibliothèques</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, je n'allais pas écrire une application Vulkan à partir de zéro. </font><font style="vertical-align: inherit;">Pour accélérer le processus de développement, j'utiliserai autant que possible des bibliothèques prêtes à l'emploi. </font><font style="vertical-align: inherit;">À savoir:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VulkanWrapper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - mon propre wrapper C ++ pour l'API Vulkan</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour les fenêtres et les entrées utilisateur</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VulkanMemoryAllocator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour allouer de la mémoire Vulkan</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour vecteurs et matrices mathématiques</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour signaux / slots et ECS</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour les utilitaires de chargement d'images</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FastNoise</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pour générer du bruit 3D</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jour 1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le premier jour, j'ai préparé un passe-partout Vulkan et un squelette moteur. </font><font style="vertical-align: inherit;">La plupart du code était un passe-partout et je pouvais simplement le copier depuis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vulkan-tutorial.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il comprenait également une astuce avec le stockage des données de sommet dans le cadre d'un vertex shader. </font><font style="vertical-align: inherit;">Cela signifiait que je n'avais même pas à régler l'allocation de mémoire. </font><font style="vertical-align: inherit;">Un simple convoyeur qui ne peut faire qu'une seule chose: dessiner un triangle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le moteur est assez simple pour prendre en charge le rendu des triangles. </font><font style="vertical-align: inherit;">Il a une fenêtre et une boucle de jeu auxquelles les systèmes peuvent être connectés. </font><font style="vertical-align: inherit;">L'interface graphique est limitée par la fréquence d'images affichée dans le titre de la fenêtre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le projet est divisé en deux parties: </font></font><code>VoxelEngine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>VoxelGame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/875/3cd/190/8753cd190975239ad550e8c0c8b27d00.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jour 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai intégré la bibliothèque Vulkan Memory Allocator. </font><font style="vertical-align: inherit;">Cette bibliothèque prend en charge la plupart du passe-partout d'allocation de mémoire Vulkan: types de mémoire, tas de mémoire de périphérique et allocation secondaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que j'avais une allocation de mémoire, j'ai créé des classes pour les maillages et les tampons de vertex. </font><font style="vertical-align: inherit;">J'ai changé le rendu des triangles pour qu'il utilise la classe des maillages, et non les tableaux intégrés dans le shader. </font><font style="vertical-align: inherit;">Actuellement, les données de maillage sont transférées vers le GPU en rendant manuellement les triangles.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/627/28d/0fc/62728d0fce9015f2be4dad88f18c7b7a.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peu de choses ont changé</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3e jour</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai ajouté un système de rendu graphique. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce post a été</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pris comme base pour créer cette classe </font><font style="vertical-align: inherit;">, mais la classe est très simplifiée. Mon graphique de rendu contient uniquement les éléments essentiels pour gérer la synchronisation avec Vulkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique de rendu me permet de définir des </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nœuds</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et des </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bords</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Les nœuds sont le travail effectué par le GPU. Les nervures sont des dépendances de données entre les nœuds. Chaque nœud reçoit son propre tampon d'instructions, dans lequel il écrit. Le graphique est engagé dans des tampons de commande à double tampon et les synchronise avec les trames précédentes. Les bords sont utilisés pour insérer automatiquement des barrières de convoyeur avant et après l'écriture d'un nœud dans chaque tampon d'instructions. Les barrières de pipeline synchronisent l'utilisation de toutes les ressources et transfèrent la propriété entre les files d'attente. De plus, les bords insèrent des sémaphores entre les nœuds. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les nœuds et les bords forment un </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">graphe acyclique dirigé</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le graphique de rendu effectue ensuite un </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tri topologique.</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nœuds, ce qui conduit à la création d'une liste plate de nœuds triés de telle sorte que chaque nœud va après tous les nœuds dont il dépend. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le moteur a trois types de nœuds. </font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reçoit une image d'une chaîne tampon (swapchain), </font></font><code>TransferNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfère les données de la CPU vers le GPU et </font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournit une image d'une chaîne tampon à afficher. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque nœud peut implémenter </font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>postRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui sont exécutés dans chaque trame. </font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtient une image d'une chaîne de tampons pendant </font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournit cette image à temps </font></font><code>postRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai refactorisé le rendu triangle afin qu'il utilise un système de graphes de rendu, plutôt que de tout traiter moi-même. Il y a un bord entre </font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ainsi qu'entre </font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cela garantit que l'image de la chaîne tampon est correctement synchronisée lors de son utilisation pendant la trame.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/12b/d88/6ba/12bd886ba9b41891ae1e2d0ff47b9929.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je jure que le moteur a changé</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jour 4</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai créé une caméra et un système de rendu 3D. Jusqu'à présent, la caméra reçoit son propre pool de tampons et de descripteurs persistants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai ralenti ce jour-là parce que j'essayais de trouver la bonne configuration pour le rendu 3D avec Vulkan. La plupart des documents en ligne se concentrent sur le rendu à l'aide d'OpenGL, qui utilise des systèmes de coordonnées légèrement différents de Vulkan. Dans OpenGL, l'axe Z de l'espace de clip est spécifié comme </font></font><code>[-1, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le bord supérieur de l'écran est à </font></font><code>Y = 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dans Vulkan, l'axe Z est spécifié comme </font></font><code>[0, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le bord supérieur de l'écran est à </font></font><code>Y = -1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En raison de ces petites différences, les matrices de projection GLM standard ne fonctionnent pas correctement car elles sont conçues pour OpenGL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GLM a une option</font></font><code>GLM_FORCE_DEPTH_ZERO_TO_ONE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, éliminant le problème avec l'axe Z. Après cela, le problème avec l'axe Y peut être éliminé en changeant simplement le signe de </font></font><code>(1, 1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l' </font><font style="vertical-align: inherit;">élément de </font><font style="vertical-align: inherit;">matrice de projection (GLM utilise l'indexation à partir de 0). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous inversons l'axe Y, nous devons inverser les données du sommet, car avant cela, la direction négative de l'axe Y pointait vers le haut.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8d9/05d/464/8d905d4643a189400471c7e8d4fbd3f6.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant en 3D!</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5e jour</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai ajouté une entrée utilisateur et la possibilité de déplacer la caméra avec la souris. </font><font style="vertical-align: inherit;">Le système d'entrée est trop sophistiqué, mais il élimine les bizarreries de l'entrée GLFW. </font><font style="vertical-align: inherit;">En particulier, j'ai eu le problème de changer la position de la souris tout en la bloquant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'entrée du clavier et de la souris est essentiellement une enveloppe mince au-dessus de GLFW, ouverte via des gestionnaires de signaux </font></font><code>entt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juste pour comparaison - à peu près la même chose que Hopson a fait le premier jour de son projet.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Votre navigateur ne prend pas en charge la vidéo HTML5.</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels.webm" type="video/webm"></video></div></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6e jour</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai commencé à ajouter du code pour générer et rendre des blocs de voxels. </font><font style="vertical-align: inherit;">L'écriture du code de maillage a été facile car je l'ai déjà fait et connaissais des abstractions qui me permettaient de faire moins d'erreurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des abstractions était une classe de modèle </font></font><code>ChunkData&lt;T, chunkSize&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui définit un cube de type de la </font></font><code>T</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">taille </font></font><code>chunkSize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de chaque côté. </font><font style="vertical-align: inherit;">Cette classe stocke les données dans un tableau 1D et traite les données d'indexation avec une coordonnée 3D. </font><font style="vertical-align: inherit;">La taille de chaque bloc est de 16 x 16 x 16, donc les données internes sont un simple tableau d'une longueur de 4096. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre abstraction consiste à créer un itérateur de positions qui génère des coordonnées de </font></font><code>(0, 0, 0)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à</font></font><code>(15, 15, 15)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ces deux classes garantissent que les itérations avec les données de bloc sont effectuées dans un ordre linéaire pour augmenter la localité du cache. </font><font style="vertical-align: inherit;">La coordonnée 3D est toujours disponible pour les autres opérations qui en ont besoin. </font><font style="vertical-align: inherit;">Par exemple:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (glm::ivec3 pos : Chunk::Positions()) {
    <span class="hljs-keyword">auto</span>&amp; data = chunkData[pos];<font></font>
    glm::ivec3 offset = ...;<font></font>
    <span class="hljs-keyword">auto</span>&amp; neighborData = chunkData[pos + offset];<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai plusieurs tableaux statiques qui spécifient les décalages couramment utilisés dans le jeu. </font><font style="vertical-align: inherit;">Par exemple, il </font></font><code>Neighbors6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">définit 6 voisins avec lesquels le cube a des faces communes.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">array</span>&lt;glm::ivec3, 6&gt; Neighbors6 = {<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),    <span class="hljs-comment">//right</span>
        glm::ivec3(<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),   <span class="hljs-comment">//left</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),    <span class="hljs-comment">//top</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>),   <span class="hljs-comment">//bottom</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),    <span class="hljs-comment">//front</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>)    <span class="hljs-comment">//back</span>
    };</code></pre><br>
<code>Neighbors26</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- ce sont tous des voisins avec lesquels le cube a une face, une arête ou un sommet commun. </font><font style="vertical-align: inherit;">Autrement dit, il s'agit d'une grille 3x3x3 sans cube central. </font><font style="vertical-align: inherit;">Il existe également des tableaux similaires pour d'autres ensembles de voisins et pour des ensembles 2D de voisins. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe un tableau définissant les données nécessaires pour créer une face du cube. </font><font style="vertical-align: inherit;">Les directions de chaque face de ce tableau correspondent aux directions du tableau </font></font><code>Neighbors6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">array</span>&lt;FaceArray, 6&gt; NeighborFaces = {
    <span class="hljs-comment">//right face</span><font></font>
    FaceArray {<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<font></font>
    },<font></font>
    ...<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grâce à cela, le code de création de maillage est très simple. Il contourne simplement les données des blocs et ajoute une face lorsque le bloc est solide, mais pas son voisin. Le code vérifie simplement chaque face de chaque cube d'un bloc. Ceci est similaire à la méthode "naïve" décrite </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (glm::ivec3 pos : Chunk::Positions()) {<font></font>
    Block block = chunk.blocks()[pos];<font></font>
    <span class="hljs-keyword">if</span> (block.type == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; Chunk::Neighbors6.size(); i++) {<font></font>
        glm::ivec3 offset = Chunk::Neighbors6[i];<font></font>
        glm::ivec3 neighborPos = pos + offset;<font></font>
<font></font>
        <span class="hljs-comment">//<span class="hljs-doctag">NOTE:</span> bounds checking omitted</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> (chunk.blocks()[neighborPos].type == <span class="hljs-number">0</span>) {<font></font>
            Chunk::FaceArray&amp; faceArray = Chunk::NeighborFaces[i];<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> j = <span class="hljs-number">0</span>; j &lt; faceArray.size(); j++) {<font></font>
                m_vertexData.push_back(pos + faceArray[j]);<font></font>
                m_colorData.push_back(glm::i8vec4(pos.x * <span class="hljs-number">16</span>, pos.y * <span class="hljs-number">16</span>, pos.z * <span class="hljs-number">16</span>, <span class="hljs-number">0</span>));<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai remplacé </font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par </font></font><code>ChunkRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. J'ai également ajouté un tampon de profondeur pour que le maillage du bloc puisse s'afficher correctement. Il était nécessaire d'ajouter un bord supplémentaire au graphique de rendu entre </font></font><code>TransferNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>ChunkRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cette périphérie transfère la propriété des ressources de la famille de files d'attente entre la file d'attente de transfert et la file d'attente graphique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai changé le moteur afin qu'il puisse gérer correctement les événements de changement de fenêtre. Dans OpenGL, cela se fait simplement, mais de manière assez confuse dans Vulkan. Étant donné que la chaîne de tampons doit être créée explicitement et avoir une taille constante, lorsque vous redimensionnez la fenêtre, vous devez la recréer. Vous devez recréer toutes les ressources qui dépendent de la chaîne de mémoire tampon.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes les commandes qui dépendent de la chaîne de mémoire tampon (et maintenant ce sont toutes des commandes de dessin) doivent terminer l'exécution avant de détruire l'ancienne chaîne de mémoire tampon. </font><font style="vertical-align: inherit;">Cela signifie que l'ensemble du GPU sera inactif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez modifier le pipeline graphique pour fournir une fenêtre dynamique et un redimensionnement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une chaîne tampon ne peut pas être créée si la taille de la fenêtre est 0 sur l'axe X ou Y. Y compris lorsque la fenêtre est réduite. </font><font style="vertical-align: inherit;">Autrement dit, lorsque cela se produit, le jeu entier est interrompu et se poursuit uniquement lorsque la fenêtre se déplie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, le maillage est un simple échiquier tridimensionnel. </font><font style="vertical-align: inherit;">Les couleurs RVB du maillage sont définies en fonction de sa position XYZ multipliée par 16.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Votre navigateur ne prend pas en charge la vidéo HTML5.</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels2.webm" type="video/webm"></video></div></div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7e jour</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai fait le processus de jeu non pas un, mais plusieurs blocs à la fois. Plusieurs blocs et leurs maillages sont gérés par la bibliothèque ECS </font></font><code>entt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, j'ai refactorisé le rendu de bloc pour qu'il rende tous les blocs qui sont dans ECS. Je n'ai toujours qu'un bloc, mais je </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pourrais en</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ajouter de nouveaux si nécessaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai refactorisé le maillage afin que ses données puissent être mises à jour après sa création. Cela me permettra de mettre à jour le maillage des blocs à l'avenir lorsque j'ajouterai la possibilité d'ajouter et de supprimer des cubes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous ajoutez ou supprimez un cube, le nombre de sommets du maillage peut potentiellement augmenter ou diminuer. Le tampon de vertex précédemment sélectionné ne peut être utilisé que si le nouveau maillage est de la même taille ou plus petit. Mais si le maillage est plus grand, de nouveaux tampons de vertex doivent être créés.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le tampon de vertex précédent ne peut pas être supprimé immédiatement. Il peut y avoir des tampons d'instructions exécutés à partir de trames précédentes qui sont spécifiques à un objet particulier </font></font><code>VkBuffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le moteur doit conserver un tampon jusqu'à ce que ces tampons de commande soient terminés. Autrement dit, si nous dessinons un maillage dans un cadre </font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le GPU peut utiliser ce tampon avant le début du cadre </font></font><code>i + 2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le tampon ne peut pas être retiré du CPU tant que le GPU n'a pas fini de l'utiliser. J'ai donc changé le graphique de rendu pour qu'il suive la durée de vie des ressources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le nœud du graphe de rendu souhaite utiliser une ressource (tampon ou image), il doit alors appeler la méthode </font></font><code>sync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à l'intérieur de la méthode </font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cette méthode obtient un pointeur </font></font><code>shared_ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur une ressource. Cette</font></font><code>shared_ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">garantit que la ressource ne sera pas supprimée pendant l'exécution des tampons de commande. </font><font style="vertical-align: inherit;">(En termes de performances, cette solution n'est pas très bonne. Plus d'informations à ce sujet plus tard.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, le maillage du bloc est régénéré dans chaque cadre.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Votre navigateur ne prend pas en charge la vidéo HTML5.</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels3.webm" type="video/webm"></video></div></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout ce que j'ai fait en une semaine - j'ai préparé les bases du rendu du monde avec plusieurs blocs de voxels et je continuerai à travailler la deuxième semaine.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr487812/index.html">Test du spectre LED polonais Led E27</a></li>
<li><a href="../fr487814/index.html">La vitesse et la fiabilité sont plus élevées et le prix est plus bas. Nouveaux disques SSD Kingston KC2000</a></li>
<li><a href="../fr487822/index.html">AvitoTech On Tour: rencontre Android à Nizhny Novgorod</a></li>
<li><a href="../fr487824/index.html">Aperçu des lampes LED Spectrum Led GU10 d'Europe</a></li>
<li><a href="../fr487826/index.html">Vue d'ensemble des lampes LED de Poland Spectrum Led E14</a></li>
<li><a href="../fr487834/index.html">Semaine de sécurité 07: vulnérabilité de la pile Bluetooth Android</a></li>
<li><a href="../fr487836/index.html">Téléchargement interactif de fichiers sur le serveur à l'aide de RxJS</a></li>
<li><a href="../fr487838/index.html">Validation des données: une approche différente</a></li>
<li><a href="../fr487842/index.html">2 SIM pour un routeur de pays - est-ce beaucoup ou peu?</a></li>
<li><a href="../fr487844/index.html">L'odeur révèle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>