<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒ ğŸ‘ƒ ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘§ å¸¦æœ‰Kerasçš„é€’å½’ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰ âœğŸ¾ ğŸ§ğŸ¾ ğŸ¤²ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tensorflow.orgçš„ã€Šé€’å½’ç¥ç»ç½‘ç»œæŒ‡å—ã€‹çš„ç¿»è¯‘ã€‚è¯¥ææ–™è®¨è®ºäº†Keras / Tensorflow 2.0çš„å†…ç½®åŠŸèƒ½ä»¥å®ç°å¿«é€Ÿç½‘æ ¼åˆ’åˆ†ï¼Œä»¥åŠè‡ªå®šä¹‰å›¾å±‚å’Œå•å…ƒçš„å¯èƒ½æ€§ã€‚è¿˜è€ƒè™‘äº†ä½¿ç”¨CuDNNå†…æ ¸çš„æƒ…å†µå’Œå±€é™æ€§ï¼Œè¿™å¯ä»¥åŠ å¿«å­¦ä¹ ç¥ç»ç½‘ç»œçš„è¿‡ç¨‹ã€‚
 
 
 
 é€’å½’ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ˜¯ä¸€ç±»ç¥ç»ç½‘ç»œï¼Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>å¸¦æœ‰Kerasçš„é€’å½’ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487808/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tensorflow.orgçš„ã€Šé€’å½’ç¥ç»ç½‘ç»œæŒ‡å—ã€‹çš„ç¿»è¯‘ã€‚</font><font style="vertical-align: inherit;">è¯¥ææ–™è®¨è®ºäº†Keras / Tensorflow 2.0çš„å†…ç½®åŠŸèƒ½ä»¥å®ç°å¿«é€Ÿç½‘æ ¼åˆ’åˆ†ï¼Œä»¥åŠè‡ªå®šä¹‰å›¾å±‚å’Œå•å…ƒçš„å¯èƒ½æ€§ã€‚</font><font style="vertical-align: inherit;">è¿˜è€ƒè™‘äº†ä½¿ç”¨CuDNNå†…æ ¸çš„æƒ…å†µå’Œå±€é™æ€§ï¼Œè¿™å¯ä»¥åŠ å¿«å­¦ä¹ ç¥ç»ç½‘ç»œçš„è¿‡ç¨‹ã€‚</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/xt/_q/nj/xt_qnjgfjengqoqd4gizkq4j_wk.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€’å½’ç¥ç»ç½‘ç»œï¼ˆRNNï¼‰æ˜¯ä¸€ç±»ç¥ç»ç½‘ç»œï¼Œå¯ä»¥å¾ˆå¥½åœ°å»ºæ¨¡ä¸²è¡Œæ•°æ®ï¼Œä¾‹å¦‚æ—¶é—´åºåˆ—æˆ–è‡ªç„¶è¯­è¨€ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœç¤ºæ„æ€§åœ°è¡¨ç¤ºï¼ŒRNNå±‚ä½¿ç”¨å¾ªç¯</font></font><code>for</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éå†æ—¶é—´é¡ºåºçš„åºåˆ—ï¼ŒåŒæ—¶ä»¥å†…éƒ¨çŠ¶æ€å­˜å‚¨æœ‰å…³ä»–å·²ç»çœ‹åˆ°çš„æ­¥éª¤çš„ç¼–ç ä¿¡æ¯ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keras RNN APIçš„è®¾è®¡é‡ç‚¹æ˜¯ï¼š</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜“äºä½¿ç”¨</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å†…ç½®å±‚ï¼š</font></font><code>tf.keras.layers.RNN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><code>tf.keras.layers.LSTM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font></font><code>tf.keras.layers.GRU</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®©æ‚¨å¿«é€Ÿå»ºç«‹ä¸€ä¸ªé€’å½’çš„æ¨¡å‹ï¼Œè€Œæ— éœ€è¿›è¡Œå¤æ‚çš„é…ç½®è®¾ç½®ã€‚</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜“äºå®šåˆ¶</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šæ‚¨è¿˜å¯ä»¥å®šä¹‰è‡ªå·±çš„RNNå•å…ƒå±‚ï¼ˆå¾ªç¯çš„å†…éƒ¨ï¼‰</font></font><code>for</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰å…·æœ‰è‡ªå®šä¹‰è¡Œä¸ºï¼Œå¹¶å°†å…¶ä¸â€œ tf.keras.layers.RNNâ€çš„é€šç”¨å±‚ï¼ˆforå¾ªç¯æœ¬èº«ï¼‰ä¸€èµ·ä½¿ç”¨ã€‚</font><font style="vertical-align: inherit;">è¿™å°†ä½¿æ‚¨ä»¥æœ€å°‘çš„ä»£ç ä»¥çµæ´»çš„æ–¹å¼å¿«é€ŸåŸå‹åŒ–å„ç§ç ”ç©¶æ€è·¯ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®‰è£…</font></font></h2><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> absolute_import, division, print_function, unicode_literals<font></font>
<font></font>
<span class="hljs-keyword">import</span> collections
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<font></font>
<font></font>
<span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf<font></font>
<font></font>
<span class="hljs-keyword">from</span> tensorflow.keras <span class="hljs-keyword">import</span> layers</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å»ºç«‹ä¸€ä¸ªç®€å•çš„æ¨¡å‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keraså…·æœ‰ä¸‰ä¸ªå†…ç½®çš„RNNå±‚ï¼š</font></font><br>
<br>
<ol>
<li><code>tf.keras.layers.SimpleRNN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæ˜¯ä¸€ä¸ªå®Œå…¨è¿æ¥çš„RNNï¼Œå…¶ä¸­å‰ä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å‡ºåº”ä¼ é€’åˆ°ä¸‹ä¸€æ­¥ã€‚</font></font></li>
<li><code>tf.keras.layers.GRU</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œåœ¨æ–‡ç« â€œ </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ä½¿ç”¨RNNç¼–è§£ç å™¨ç ”ç©¶ç»Ÿè®¡æœºå™¨ç¿»è¯‘ä¸­çš„çŸ­è¯­â€ä¸­</font></a><font style="vertical-align: inherit;">é¦–æ¬¡æå‡º</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a></li>
<li><code>tf.keras.layers.LSTM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œé¦–å…ˆåœ¨æ–‡ç« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é•¿æœŸçŸ­æœŸè®°å¿†ä¸­æå‡º</font></font></a></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2015å¹´åˆï¼ŒKerasæ¨å‡ºäº†ç¬¬ä¸€ä¸ªå¯é‡ç”¨çš„å¼€æºPythonï¼ŒLSTMå’ŒGRUå®ç°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹æ˜¯</font></font><code>Sequential</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¨¡å‹</font><font style="vertical-align: inherit;">çš„ç¤ºä¾‹ï¼Œè¯¥</font><font style="vertical-align: inherit;">æ¨¡å‹é€šè¿‡å°†æ¯ä¸ªæ•´æ•°åµŒå¥—åœ¨64ç»´å‘é‡ä¸­ï¼Œç„¶åä½¿ç”¨layerå¤„ç†å‘é‡åºåˆ—æ¥å¤„ç†æ•´æ•°åºåˆ—</font></font><code>LSTM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = tf.keras.Sequential()
<span class="hljs-comment">#   Embedding      1000, </span>
<span class="hljs-comment">#     64.</span>
model.add(layers.Embedding(input_dim=<span class="hljs-number">1000</span>, output_dim=<span class="hljs-number">64</span>))<font></font>
<font></font>
<span class="hljs-comment">#   LSTM  128  .</span>
model.add(layers.LSTM(<span class="hljs-number">128</span>))<font></font>
<font></font>
<span class="hljs-comment">#   Dense  10    softmax.</span>
model.add(layers.Dense(<span class="hljs-number">10</span>))<font></font>
<font></font>
model.summary()</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¾“å‡ºå’ŒçŠ¶æ€</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é»˜è®¤æƒ…å†µä¸‹ï¼ŒRNNå±‚çš„è¾“å‡ºæ¯ä¸ªå…ƒç´ åŒ…å«ä¸€ä¸ªå‘é‡ã€‚æ­¤å‘é‡æ˜¯æœ€åä¸€ä¸ªRNNå•å…ƒçš„è¾“å‡ºï¼Œå…¶ä¸­åŒ…å«æœ‰å…³æ•´ä¸ªè¾“å…¥åºåˆ—çš„ä¿¡æ¯ã€‚æ­¤è¾“å‡ºçš„å°ºå¯¸</font></font><code>(batch_size, units)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå…¶ä¸­</font></font><code>units</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹åº”äº</font></font><code>units</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¼ é€’ç»™å›¾å±‚æ„é€ å‡½æ•°</font><font style="vertical-align: inherit;">çš„å‚æ•°</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæŒ‡å®šï¼Œåˆ™RNNå±‚è¿˜å¯ä»¥è¿”å›æ¯ä¸ªå…ƒç´ çš„æ•´ä¸ªè¾“å‡ºåºåˆ—ï¼ˆæ¯ä¸ªæ­¥éª¤ä¸€ä¸ªå‘é‡ï¼‰</font></font><code>return_sequences=True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚æ­¤è¾“å‡ºçš„å°ºå¯¸ä¸º</font></font><code>(batch_size, timesteps, units)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = tf.keras.Sequential()<font></font>
model.add(layers.Embedding(input_dim=<span class="hljs-number">1000</span>, output_dim=<span class="hljs-number">64</span>))<font></font>
<font></font>
<span class="hljs-comment">#  GRU  3D   (batch_size, timesteps, 256)</span>
model.add(layers.GRU(<span class="hljs-number">256</span>, return_sequences=<span class="hljs-literal">True</span>))<font></font>
<font></font>
<span class="hljs-comment">#  SimpleRNN  2D   (batch_size, 128)</span>
model.add(layers.SimpleRNN(<span class="hljs-number">128</span>))<font></font>
<font></font>
model.add(layers.Dense(<span class="hljs-number">10</span>))<font></font>
<font></font>
model.summary()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦å¤–ï¼ŒRNNå±‚å¯ä»¥è¿”å›å…¶æœ€ç»ˆå†…éƒ¨çŠ¶æ€ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿”å›çš„çŠ¶æ€å¯ä»¥ç¨åç”¨äºæ¢å¤RNNçš„æ‰§è¡Œæˆ–</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆå§‹åŒ–å¦ä¸€ä¸ªRNN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚æ­¤è®¾ç½®é€šå¸¸åœ¨ç¼–ç å™¨-è§£ç å™¨æ¨¡å‹ä¸­æŒ‰é¡ºåºä½¿ç”¨ï¼Œå…¶ä¸­ç¼–ç å™¨çš„æœ€ç»ˆçŠ¶æ€ç”¨äºè§£ç å™¨çš„åˆå§‹çŠ¶æ€ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†ä½¿RNNå›¾å±‚è¿”å›å…¶å†…éƒ¨çŠ¶æ€ï¼Œè¯·</font><font style="vertical-align: inherit;">åœ¨åˆ›å»ºå›¾å±‚æ—¶</font><font style="vertical-align: inherit;">å°†å‚æ•°è®¾ç½®</font></font><code>return_state</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºvalue </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚è¯·æ³¨æ„ï¼Œæœ‰</font></font><code>LSTM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2ä¸ªçŠ¶æ€å¼ é‡ï¼Œ</font></font><code>GRU</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åªæœ‰ä¸€ä¸ªã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦è°ƒæ•´å›¾å±‚çš„åˆå§‹çŠ¶æ€ï¼Œåªéœ€ä½¿ç”¨é™„åŠ å‚æ•°è°ƒç”¨è¯¥å›¾å±‚å³å¯</font></font><code>initial_state</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯·æ³¨æ„ï¼Œå°ºå¯¸å¿…é¡»ä¸å›¾å±‚å…ƒç´ çš„å°ºå¯¸åŒ¹é…ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºã€‚</font></font><br>
<br>
<pre><code class="python hljs">encoder_vocab = <span class="hljs-number">1000</span>
decoder_vocab = <span class="hljs-number">2000</span><font></font>
<font></font>
encoder_input = layers.Input(shape=(<span class="hljs-literal">None</span>, ))<font></font>
encoder_embedded = layers.Embedding(input_dim=encoder_vocab, output_dim=<span class="hljs-number">64</span>)(encoder_input)<font></font>
<font></font>
<span class="hljs-comment">#       </span><font></font>
output, state_h, state_c = layers.LSTM(<font></font>
    <span class="hljs-number">64</span>, return_state=<span class="hljs-literal">True</span>, name=<span class="hljs-string">'encoder'</span>)(encoder_embedded)<font></font>
encoder_state = [state_h, state_c]<font></font>
<font></font>
decoder_input = layers.Input(shape=(<span class="hljs-literal">None</span>, ))<font></font>
decoder_embedded = layers.Embedding(input_dim=decoder_vocab, output_dim=<span class="hljs-number">64</span>)(decoder_input)<font></font>
<font></font>
<span class="hljs-comment">#  2     LSTM    </span><font></font>
decoder_output = layers.LSTM(<font></font>
    <span class="hljs-number">64</span>, name=<span class="hljs-string">'decoder'</span>)(decoder_embedded, initial_state=encoder_state)<font></font>
output = layers.Dense(<span class="hljs-number">10</span>)(decoder_output)<font></font>
<font></font>
model = tf.keras.Model([encoder_input, decoder_input], output)<font></font>
model.summary()<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RNNå±‚å’ŒRNNå•å…ƒ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é™¤äº†å†…ç½®çš„RNNå±‚ä¹‹å¤–ï¼ŒRNN APIè¿˜æä¾›äº†å•å…ƒçº§APIã€‚</font><font style="vertical-align: inherit;">ä¸å¤„ç†è¾“å…¥åºåˆ—çš„æ•´ä¸ªåŒ…çš„RNNå±‚ä¸åŒï¼ŒRNNå•å…ƒä»…å¤„ç†ä¸€ä¸ªæ—¶é—´æ­¥ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥å•å…ƒä½äº</font></font><code>for</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RNNå±‚</font><font style="vertical-align: inherit;">çš„å¾ªç¯å†…</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ç”¨ä¸€å±‚åŒ…è£¹ä¸€ä¸ªå•å…ƒæ ¼å¯ä»¥</font></font><code>tf.keras.layers.RNN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºæ‚¨æä¾›ä¸€å±‚èƒ½å¤Ÿå¤„ç†åºåˆ—æ•°æ®åŒ…çš„å±‚ï¼Œä¾‹å¦‚ </font></font><code>RNN(LSTMCell(10))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»æ•°å­¦ä¸Šè®²ï¼Œ</font></font><code>RNN(LSTMCell(10))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ƒçš„ç»“æœä¸ç›¸åŒ</font></font><code>LSTM(10)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å®é™…ä¸Šï¼Œåœ¨TF v1.xå†…éƒ¨æ‰§è¡Œæ­¤å±‚åªæ˜¯åˆ›å»ºç›¸åº”çš„RNNå•å…ƒå¹¶å°†å…¶åŒ…è£…åœ¨RNNå±‚ä¸­ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œä½¿ç”¨åµŒå…¥å¼å±‚</font></font><code>GRU</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶</font></font><code>LSTM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…è®¸ä½¿ç”¨CuDNNï¼Œå®ƒå¯ä»¥ä¸ºæ‚¨æä¾›æ›´å¥½çš„æ€§èƒ½ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ‰ä¸‰ä¸ªå†…ç½®çš„RNNå•å…ƒï¼Œæ¯ä¸ªå•å…ƒå¯¹åº”äºå…¶è‡ªå·±çš„RNNå±‚ã€‚</font></font><br>
<br>
<ul>
<li><code>tf.keras.layers.SimpleRNNCell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒ¹é…å›¾å±‚</font></font><code>SimpleRNN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><code>tf.keras.layers.GRUCell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒ¹é…å›¾å±‚</font></font><code>GRU</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><code>tf.keras.layers.LSTMCell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒ¹é…å›¾å±‚</font></font><code>LSTM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å•å…ƒçš„æŠ½è±¡ä»¥åŠä¸€ä¸ªé€šç”¨çš„ç±»</font></font><code>tf.keras.layers.RNN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿å¾—ä¸ºæ‚¨çš„ç ”ç©¶å®ç°è‡ªå®šä¹‰RNNä½“ç³»ç»“æ„å˜å¾—éå¸¸å®¹æ˜“ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·¨æ‰¹æ¬¡ä¿å­˜çŠ¶æ€</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨å¤„ç†é•¿åºåˆ—ï¼ˆå¯èƒ½æ˜¯æ— å°½çš„ï¼‰æ—¶ï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·¨æ‰¹çŠ¶æ€</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¨¡å¼</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€šå¸¸ï¼ŒRNNå±‚çš„å†…éƒ¨çŠ¶æ€ä¼šéšç€æ¯ä¸ªæ–°çš„æ•°æ®åŒ…è€Œé‡ç½®ï¼ˆå³ï¼Œçœ‹åˆ°è¯¥å±‚çš„æ¯ä¸ªç¤ºä¾‹éƒ½å‡å®šä¸è¿‡å»æ— å…³ï¼‰ã€‚è¯¥å±‚å°†ä»…åœ¨å¤„ç†æ­¤å…ƒç´ æœŸé—´ä¿æŒçŠ¶æ€ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯ï¼Œå¦‚æœåºåˆ—å¾ˆé•¿ï¼Œå°†å®ƒä»¬åˆ†è§£æˆè¾ƒçŸ­çš„åºåˆ—ï¼Œç„¶åä¾æ¬¡å°†å®ƒä»¬ä¼ è¾“åˆ°RNNå±‚è€Œä¸é‡ç½®å±‚çŠ¶æ€ï¼Œå°†å¾ˆæœ‰ç”¨ã€‚å› æ­¤ï¼Œä¸€ä¸ªå±‚å¯ä»¥å­˜å‚¨æœ‰å…³æ•´ä¸ªåºåˆ—çš„ä¿¡æ¯ï¼Œå°½ç®¡ä¸€æ¬¡åªèƒ½çœ‹åˆ°ä¸€ä¸ªå­åºåˆ—ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨å¯ä»¥é€šè¿‡åœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½®`stateful = True`æ¥å®ç°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ‚¨å…·æœ‰åºåˆ—s = [t0ï¼Œt1ï¼Œ... t1546ï¼Œt1547]`ï¼Œåˆ™å¯ä»¥å°†å…¶æ‹†åˆ†ä¸ºï¼š</font></font><br>
<br>
<pre><code class="python hljs">s1 = [t0, t1, ... t100]<font></font>
s2 = [t101, ... t201]<font></font>
...<font></font>
s16 = [t1501, ... t1547]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œå¤„ç†ï¼š</font></font><br>
<br>
<pre><code class="python hljs">lstm_layer = layers.LSTM(<span class="hljs-number">64</span>, stateful=<span class="hljs-literal">True</span>)
<span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> sub_sequences:<font></font>
  output = lstm_layer(s)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½“æ‚¨æƒ³è¦æ¸…æ´çŠ¶æ€æ—¶ï¼Œè¯·ä½¿ç”¨</font></font><code>layer.reset_states()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ³¨æ„ï¼š</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡å®š</font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤ç¨‹åºåŒ…ä¸­çš„ç¤ºä¾‹æ˜¯</font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…ˆå‰ç¨‹åºåŒ…</font><font style="vertical-align: inherit;">ç¤ºä¾‹çš„å»¶ç»­</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">è¿™æ„å‘³ç€æ‰€æœ‰åŒ…éƒ½åŒ…å«ç›¸åŒæ•°é‡çš„å…ƒç´ ï¼ˆåŒ…å¤§å°ï¼‰ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œå¦‚æœè½¯ä»¶åŒ…åŒ…å«</font></font><code>[sequence_A_from_t0_to_t100, sequence_B_from_t0_to_t100]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œåˆ™ä¸‹ä¸€ä¸ªè½¯ä»¶åŒ…åº”åŒ…å«</font></font><code>[sequence_A_from_t101_to_t200, sequence_B_from_t101_to_t200]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼š</font></font><br>
<br>
<pre><code class="python hljs">paragraph1 = np.random.random((<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">50</span>)).astype(np.float32)<font></font>
paragraph2 = np.random.random((<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">50</span>)).astype(np.float32)<font></font>
paragraph3 = np.random.random((<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">50</span>)).astype(np.float32)<font></font>
<font></font>
lstm_layer = layers.LSTM(<span class="hljs-number">64</span>, stateful=<span class="hljs-literal">True</span>)<font></font>
output = lstm_layer(paragraph1)<font></font>
output = lstm_layer(paragraph2)<font></font>
output = lstm_layer(paragraph3)<font></font>
<font></font>
<span class="hljs-comment"># reset_states()      initial_state.</span>
<span class="hljs-comment">#  initial_state   ,      .</span>
lstm_layer.reset_states()</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŒå‘RNN</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºæ—¶é—´åºåˆ—ä»¥å¤–çš„åºåˆ—ï¼ˆä¾‹å¦‚æ–‡æœ¬ï¼‰ï¼Œå¦‚æœRNNæ¨¡å‹ä¸ä»…ä»å¤´åˆ°å°¾è¿›è¡Œå¤„ç†ï¼Œåä¹‹äº¦ç„¶ï¼Œé‚£ä¹ˆç»å¸¸ä¼šå‘ç”ŸRNNæ¨¡å‹å·¥ä½œå¾—æ›´å¥½çš„æƒ…å†µã€‚ä¾‹å¦‚ï¼Œè¦é¢„æµ‹å¥å­ä¸­çš„ä¸‹ä¸€ä¸ªå•è¯ï¼Œäº†è§£å•è¯å‘¨å›´çš„ä¸Šä¸‹æ–‡ï¼ˆè€Œä¸ä»…ä»…æ˜¯å•è¯å‰é¢çš„å•è¯ï¼‰é€šå¸¸å¾ˆæœ‰ç”¨ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kerasæä¾›äº†ä¸€ä¸ªç”¨äºåˆ›å»ºæ­¤ç±»åŒå‘RNNçš„ç®€å•APIï¼šåŒ…è£…å™¨</font></font><code>tf.keras.layers.Bidirectional</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = tf.keras.Sequential()<font></font>
<font></font>
model.add(layers.Bidirectional(layers.LSTM(<span class="hljs-number">64</span>, return_sequences=<span class="hljs-literal">True</span>), <font></font>
                               input_shape=(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>)))<font></font>
model.add(layers.Bidirectional(layers.LSTM(<span class="hljs-number">32</span>)))<font></font>
model.add(layers.Dense(<span class="hljs-number">10</span>))<font></font>
<font></font>
model.summary()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨å¼•æ“ç›–ä¸‹ï¼Œ</font><font style="vertical-align: inherit;">å°†å¤åˆ¶</font></font><code>Bidirectional</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¼ è¾“çš„RNNå±‚ï¼Œå¹¶å°†</font></font><code>go_backwards</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–°å¤åˆ¶çš„å±‚</font><font style="vertical-align: inherit;">çš„å­—æ®µç¿»è½¬</font><font style="vertical-align: inherit;">ï¼Œä»è€Œå°†ä»¥ç›¸åçš„é¡ºåºå¤„ç†è¾“å…¥æ•°æ®ã€‚</font><font style="vertical-align: inherit;">é»˜è®¤æƒ…å†µä¸‹</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼Œ` </font></font><code>Bidirectional</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RNNçš„è¾“å‡ºå°†æ˜¯å‰å‘å±‚çš„è¾“å‡ºä¸åå‘å±‚çš„è¾“å‡ºä¹‹å’Œã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ‚¨éœ€è¦å…¶ä»–åˆå¹¶è¡Œä¸ºï¼Œä¾‹å¦‚ </font><font style="vertical-align: inherit;">ä¸²è”ï¼Œè¯·åœ¨â€œåŒå‘â€åŒ…è£…æ„é€ å‡½æ•°ä¸­æ›´æ”¹â€œ merge_modeâ€å‚æ•°ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TensorFlow 2.0ä¸­çš„æ€§èƒ½ä¼˜åŒ–å’ŒCuDNNæ ¸å¿ƒ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨TensorFlow 2.0ä¸­ï¼Œå¦‚æœæœ‰å›¾å½¢å¤„ç†å™¨å¯ç”¨ï¼Œåˆ™é»˜è®¤çš„CuDNNå†…æ ¸å¯ä»¥ä½¿ç”¨å†…ç½®çš„LSTMå’ŒGRUå±‚ã€‚</font><font style="vertical-align: inherit;">è¿›è¡Œæ­¤æ›´æ”¹åï¼Œä»¥å‰çš„å›¾å±‚</font></font><code>keras.layers.CuDNNLSTM/CuDNNGRU</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å·²è¿‡æ—¶ï¼Œæ‚¨å¯ä»¥æ„å»ºæ¨¡å‹è€Œä¸å¿…æ‹…å¿ƒå°†åœ¨å…¶ä¸Šè¿è¡Œçš„è®¾å¤‡ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”±äºCuDNNå†…æ ¸æ˜¯åŸºäºæŸäº›å‡è®¾æ„å»ºçš„ï¼Œå› æ­¤è¿™æ„å‘³ç€</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœæ‚¨æ›´æ”¹å†…ç½®LSTMæˆ–GRUå±‚çš„é»˜è®¤è®¾ç½®ï¼Œåˆ™</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯¥å±‚</font><b><font style="vertical-align: inherit;">å°†æ— æ³•ä½¿ç”¨CuDNNå†…æ ¸å±‚</font></b><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ã€‚</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†åŠŸèƒ½</font></font><code>activation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»</font><font style="vertical-align: inherit;">æ›´æ”¹ä¸º</font></font><code>tanh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…¶ä»–ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†åŠŸèƒ½</font></font><code>recurrent_activation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»</font><font style="vertical-align: inherit;">æ›´æ”¹ä¸º</font></font><code>sigmoid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…¶ä»–ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”¨æ³•</font></font><code>recurrent_dropout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; 0ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†å…¶è®¾ç½®</font></font><code>unroll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºTrueï¼Œè¿™å°†å¯¼è‡´LSTM / GRUå°†å†…éƒ¨åˆ†è§£</font></font><code>tf.while_loop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºå±•å¼€çš„å¾ªç¯</font></font><code>for</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®¾ç½®</font></font><code>use_bias</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºFalseã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½“è¾“å…¥æ•°æ®ä¸æ­£ç¡®æ—¶ä½¿ç”¨é®ç½©ï¼ˆå¦‚æœé®ç½©ä¸æ­£ç¡®ä¸¥æ ¼å¯¹é½çš„æ•°æ®ç›¸åŒ¹é…ï¼Œåˆ™ä»å¯ä»¥ä½¿ç”¨CuDNNã€‚è¿™æ˜¯æœ€å¸¸è§çš„æƒ…å†µï¼‰ã€‚</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°½å¯èƒ½ä½¿ç”¨CuDNNå†…æ ¸</font></font></h3><br>
<pre><code class="python hljs">batch_size = <span class="hljs-number">64</span>
<span class="hljs-comment">#    MNIST    (batch_size, 28, 28).</span>
<span class="hljs-comment">#     (28, 28) (   ).</span>
input_dim = <span class="hljs-number">28</span><font></font>
<font></font>
units = <span class="hljs-number">64</span>
output_size = <span class="hljs-number">10</span>  <span class="hljs-comment">#   0  9</span><font></font>
<font></font>
<span class="hljs-comment">#  RNN </span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build_model</span>(<span class="hljs-params">allow_cudnn_kernel=True</span>):</span>
  <span class="hljs-comment"># CuDNN     ,     .</span>
  <span class="hljs-comment">#   `LSTM(units)`    CuDNN,</span>
  <span class="hljs-comment">#   RNN(LSTMCell(units))   non-CuDNN .</span>
  <span class="hljs-keyword">if</span> allow_cudnn_kernel:
    <span class="hljs-comment">#  LSTM      CuDNN.</span>
    lstm_layer = tf.keras.layers.LSTM(units, input_shape=(<span class="hljs-literal">None</span>, input_dim))
  <span class="hljs-keyword">else</span>:
    <span class="hljs-comment">#  LSTMCell  RNN    CuDNN.</span><font></font>
    lstm_layer = tf.keras.layers.RNN(<font></font>
        tf.keras.layers.LSTMCell(units),<font></font>
        input_shape=(<span class="hljs-literal">None</span>, input_dim))<font></font>
  model = tf.keras.models.Sequential([<font></font>
      lstm_layer,<font></font>
      tf.keras.layers.BatchNormalization(),<font></font>
      tf.keras.layers.Dense(output_size)]<font></font>
  )<font></font>
  <span class="hljs-keyword">return</span> model
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŠ è½½MNISTæ•°æ®é›†</font></font></h3><br>
<pre><code class="python hljs">mnist = tf.keras.datasets.mnist<font></font>
<font></font>
(x_train, y_train), (x_test, y_test) = mnist.load_data()<font></font>
x_train, x_test = x_train / <span class="hljs-number">255.0</span>, x_test / <span class="hljs-number">255.0</span>
sample, sample_label = x_train[<span class="hljs-number">0</span>], y_train[<span class="hljs-number">0</span>]</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ›å»ºæ¨¡å‹çš„å®ä¾‹å¹¶è¿›è¡Œç¼–è¯‘</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬é€‰æ‹©</font></font><code>sparse_categorical_crossentropy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº†æŸå¤±å‡½æ•°ã€‚</font><font style="vertical-align: inherit;">æ¨¡å‹çš„è¾“å‡ºå…·æœ‰ä¸€ä¸ªç»´åº¦</font></font><code>[batch_size, 10]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ¨¡å‹çš„ç­”æ¡ˆæ˜¯ä¸€ä¸ªæ•´æ•°å‘é‡ï¼Œæ¯ä¸ªæ•°å­—çš„èŒƒå›´æ˜¯0åˆ°9ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = build_model(allow_cudnn_kernel=<span class="hljs-literal">True</span>)<font></font>
<font></font>
model.compile(loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=<span class="hljs-literal">True</span>), <font></font>
              optimizer=<span class="hljs-string">'sgd'</span>,<font></font>
              metrics=[<span class="hljs-string">'accuracy'</span>])
</code></pre><br>
<pre><code class="python hljs">model.fit(x_train, y_train,<font></font>
          validation_data=(x_test, y_test),<font></font>
          batch_size=batch_size,<font></font>
          epochs=<span class="hljs-number">5</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æ²¡æœ‰CuDNNæ ¸å¿ƒçš„æƒ…å†µä¸‹å»ºç«‹æ–°æ¨¡å‹</font></font></h3><br>
<pre><code class="python hljs">slow_model = build_model(allow_cudnn_kernel=<span class="hljs-literal">False</span>)<font></font>
slow_model.set_weights(model.get_weights())<font></font>
slow_model.compile(loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=<span class="hljs-literal">True</span>), <font></font>
                   optimizer=<span class="hljs-string">'sgd'</span>, <font></font>
                   metrics=[<span class="hljs-string">'accuracy'</span>])<font></font>
slow_model.fit(x_train, y_train, <font></font>
               validation_data=(x_test, y_test), <font></font>
               batch_size=batch_size,<font></font>
               epochs=<span class="hljs-number">1</span>)  <span class="hljs-comment">#         .</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æ‚¨æ‰€è§ï¼Œä½¿ç”¨CuDNNæ„å»ºçš„æ¨¡å‹æ¯”ä½¿ç”¨å¸¸è§„TensorFlowæ ¸å¿ƒçš„æ¨¡å‹è¿›è¡Œè®­ç»ƒè¦å¿«å¾—å¤šã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…·æœ‰CuDNNæ”¯æŒçš„ç›¸åŒæ¨¡å‹å¯ç”¨äºå•å¤„ç†å™¨ç¯å¢ƒä¸­çš„è¾“å‡ºã€‚</font><font style="vertical-align: inherit;">æ³¨é‡Š</font></font><code>tf.device</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»…æŒ‡ç¤ºä½¿ç”¨çš„è®¾å¤‡ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ²¡æœ‰GPUï¼Œè¯¥æ¨¡å‹å°†é»˜è®¤åœ¨CPUä¸Šè¿è¡Œã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨åªéœ€è¦æ‹…å¿ƒæ­£åœ¨ä½¿ç”¨çš„ç¡¬ä»¶ã€‚</font><font style="vertical-align: inherit;">é‚£ä¸æ˜¯å¾ˆé…·å—ï¼Ÿ</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">with</span> tf.device(<span class="hljs-string">'CPU:0'</span>):<font></font>
  cpu_model = build_model(allow_cudnn_kernel=<span class="hljs-literal">True</span>)<font></font>
  cpu_model.set_weights(model.get_weights())<font></font>
  result = tf.argmax(cpu_model.predict_on_batch(tf.expand_dims(sample, <span class="hljs-number">0</span>)), axis=<span class="hljs-number">1</span>)<font></font>
  print(<span class="hljs-string">'Predicted result is: %s, target result is: %s'</span> % (result.numpy(), sample_label))<font></font>
  plt.imshow(sample, cmap=plt.get_cmap(<span class="hljs-string">'gray'</span>))
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…·æœ‰åˆ—è¡¨/å­—å…¸è¾“å…¥æˆ–åµŒå¥—è¾“å…¥çš„RNN</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åµŒå¥—ç»“æ„ä½¿æ‚¨å¯ä»¥ä¸€æ­¥ä¸€æ­¥åŒ…å«æ›´å¤šä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œè§†é¢‘å¸§å¯èƒ½åŒæ—¶åŒ…å«éŸ³é¢‘å’Œè§†é¢‘è¾“å…¥ã€‚</font><font style="vertical-align: inherit;">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®çš„ç»´åº¦å¯ä»¥æ˜¯ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">[batch, timestep, {\"video\": [height, width, channel], \"audio\": [frequency]}]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨å¦ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæ‰‹å†™æ•°æ®å¯ä»¥å…·æœ‰å½“å‰ç¬”ä½ç½®çš„xå’Œyåæ ‡ä»¥åŠå‹åŠ›ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">å› æ­¤æ•°æ®å¯ä»¥è¡¨ç¤ºå¦‚ä¸‹ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">[batch, timestep, {\"location\": [x, y], \"pressure\": [force]}]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹ä»£ç æ„å»ºäº†å¯ä¸è¿™ç§ç»“æ„åŒ–è¾“å…¥ä¸€èµ·ä½¿ç”¨çš„è‡ªå®šä¹‰RNNå•å…ƒçš„ç¤ºä¾‹ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®šä¹‰ä¸€ä¸ªæ”¯æŒåµŒå¥—è¾“å…¥/è¾“å‡ºçš„ç”¨æˆ·å•å…ƒ</font></font></h3><br>
<pre><code class="python hljs">NestedInput = collections.namedtuple(<span class="hljs-string">'NestedInput'</span>, [<span class="hljs-string">'feature1'</span>, <span class="hljs-string">'feature2'</span>])<font></font>
NestedState = collections.namedtuple(<span class="hljs-string">'NestedState'</span>, [<span class="hljs-string">'state1'</span>, <span class="hljs-string">'state2'</span>])<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NestedCell</span>(<span class="hljs-params">tf.keras.layers.Layer</span>):</span><font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, unit_1, unit_2, unit_3, **kwargs</span>):</span><font></font>
    self.unit_1 = unit_1<font></font>
    self.unit_2 = unit_2<font></font>
    self.unit_3 = unit_3<font></font>
    self.state_size = NestedState(state1=unit_1, <font></font>
                                  state2=tf.TensorShape([unit_2, unit_3]))<font></font>
    self.output_size = (unit_1, tf.TensorShape([unit_2, unit_3]))<font></font>
    super(NestedCell, self).__init__(**kwargs)<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">build</span>(<span class="hljs-params">self, input_shapes</span>):</span>
    <span class="hljs-comment"># #  input_shape  2 , [(batch, i1), (batch, i2, i3)]</span>
    input_1 = input_shapes.feature1[<span class="hljs-number">1</span>]<font></font>
    input_2, input_3 = input_shapes.feature2[<span class="hljs-number">1</span>:]<font></font>
<font></font>
    self.kernel_1 = self.add_weight(<font></font>
        shape=(input_1, self.unit_1), initializer=<span class="hljs-string">'uniform'</span>, name=<span class="hljs-string">'kernel_1'</span>)<font></font>
    self.kernel_2_3 = self.add_weight(<font></font>
        shape=(input_2, input_3, self.unit_2, self.unit_3),<font></font>
        initializer=<span class="hljs-string">'uniform'</span>,<font></font>
        name=<span class="hljs-string">'kernel_2_3'</span>)<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call</span>(<span class="hljs-params">self, inputs, states</span>):</span>
    <span class="hljs-comment">#     [(batch, input_1), (batch, input_2, input_3)]</span>
    <span class="hljs-comment">#     [(batch, unit_1), (batch, unit_2, unit_3)]</span><font></font>
    input_1, input_2 = tf.nest.flatten(inputs)<font></font>
    s1, s2 = states<font></font>
<font></font>
    output_1 = tf.matmul(input_1, self.kernel_1)<font></font>
    output_2_3 = tf.einsum(<span class="hljs-string">'bij,ijkl-&gt;bkl'</span>, input_2, self.kernel_2_3)<font></font>
    state_1 = s1 + output_1<font></font>
    state_2_3 = s2 + output_2_3<font></font>
<font></font>
    output = [output_1, output_2_3]<font></font>
    new_states = NestedState(state1=state_1, state2=state_2_3)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> output, new_states
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨åµŒå¥—çš„è¾“å…¥/è¾“å‡ºæ„å»ºRNNæ¨¡å‹</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªKerasæ¨¡å‹ï¼Œè¯¥æ¨¡å‹ä½¿ç”¨</font></font><code>tf.keras.layers.RNN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬åˆšåˆšå®šä¹‰</font><font style="vertical-align: inherit;">çš„å›¾å±‚</font><font style="vertical-align: inherit;">å’Œè‡ªå®šä¹‰å•å…ƒæ ¼ã€‚</font></font><br>
<br>
<pre><code class="python hljs">unit_1 = <span class="hljs-number">10</span>
unit_2 = <span class="hljs-number">20</span>
unit_3 = <span class="hljs-number">30</span><font></font>
<font></font>
input_1 = <span class="hljs-number">32</span>
input_2 = <span class="hljs-number">64</span>
input_3 = <span class="hljs-number">32</span>
batch_size = <span class="hljs-number">64</span>
num_batch = <span class="hljs-number">100</span>
timestep = <span class="hljs-number">50</span><font></font>
<font></font>
cell = NestedCell(unit_1, unit_2, unit_3)<font></font>
rnn = tf.keras.layers.RNN(cell)<font></font>
<font></font>
inp_1 = tf.keras.Input((<span class="hljs-literal">None</span>, input_1))<font></font>
inp_2 = tf.keras.Input((<span class="hljs-literal">None</span>, input_2, input_3))<font></font>
<font></font>
outputs = rnn(NestedInput(feature1=inp_1, feature2=inp_2))<font></font>
<font></font>
model = tf.keras.models.Model([inp_1, inp_2], outputs)<font></font>
<font></font>
model.compile(optimizer=<span class="hljs-string">'adam'</span>, loss=<span class="hljs-string">'mse'</span>, metrics=[<span class="hljs-string">'accuracy'</span>])unit_1 = <span class="hljs-number">10</span>
unit_2 = <span class="hljs-number">20</span>
unit_3 = <span class="hljs-number">30</span><font></font>
<font></font>
input_1 = <span class="hljs-number">32</span>
input_2 = <span class="hljs-number">64</span>
input_3 = <span class="hljs-number">32</span>
batch_size = <span class="hljs-number">64</span>
num_batch = <span class="hljs-number">100</span>
timestep = <span class="hljs-number">50</span><font></font>
<font></font>
cell = NestedCell(unit_1, unit_2, unit_3)<font></font>
rnn = tf.keras.layers.RNN(cell)<font></font>
<font></font>
inp_1 = tf.keras.Input((<span class="hljs-literal">None</span>, input_1))<font></font>
inp_2 = tf.keras.Input((<span class="hljs-literal">None</span>, input_2, input_3))<font></font>
<font></font>
outputs = rnn(NestedInput(feature1=inp_1, feature2=inp_2))<font></font>
<font></font>
model = tf.keras.models.Model([inp_1, inp_2], outputs)<font></font>
<font></font>
model.compile(optimizer=<span class="hljs-string">'adam'</span>, loss=<span class="hljs-string">'mse'</span>, metrics=[<span class="hljs-string">'accuracy'</span>])
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨éšæœºç”Ÿæˆçš„æ•°æ®ä¸Šè®­ç»ƒæ¨¡å‹</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”±äºæˆ‘ä»¬æ²¡æœ‰é€‚åˆè¯¥æ¨¡å‹çš„æ•°æ®é›†ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨Numpyåº“ç”Ÿæˆçš„éšæœºæ•°æ®è¿›è¡Œæ¼”ç¤ºã€‚</font></font><br>
<br>
<pre><code class="python hljs">input_1_data = np.random.random((batch_size * num_batch, timestep, input_1))<font></font>
input_2_data = np.random.random((batch_size * num_batch, timestep, input_2, input_3))<font></font>
target_1_data = np.random.random((batch_size * num_batch, unit_1))<font></font>
target_2_data = np.random.random((batch_size * num_batch, unit_2, unit_3))<font></font>
input_data = [input_1_data, input_2_data]<font></font>
target_data = [target_1_data, target_2_data]<font></font>
<font></font>
model.fit(input_data, target_data, batch_size=batch_size)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºå±‚ï¼Œ</font></font><code>tf.keras.layers.RNN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨åªéœ€è¦ç¡®å®šåºåˆ—ä¸­å•ä¸ªæ­¥éª¤çš„æ•°å­¦é€»è¾‘ï¼Œè¯¥å±‚</font></font><code>tf.keras.layers.RNN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†ä¸ºæ‚¨å¤„ç†åºåˆ—çš„è¿­ä»£ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯å¿«é€Ÿæ–°å‹RNNï¼ˆä¾‹å¦‚LSTMå˜ä½“ï¼‰åŸå‹çš„å¼ºå¤§æ–¹æ³•ã€‚</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»è¿‡éªŒè¯åï¼Œç¿»è¯‘ä¹Ÿå°†å‡ºç°åœ¨Tensorflow.orgä¸Šã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ‚¨æƒ³å‚ä¸å°†Tensorflow.orgç½‘ç«™çš„æ–‡æ¡£ç¿»è¯‘æˆä¿„è¯­ï¼Œè¯·ä»¥ä¸ªäººèº«ä»½æˆ–è¯„è®ºè”ç³»ã€‚</font><font style="vertical-align: inherit;">ä»»ä½•æ›´æ­£å’Œè¯„è®ºè¡¨ç¤ºèµèµã€‚</font></font></i></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN487798/index.html">æˆ‘ä»¬å¦‚ä½•ä»Oracle JDKå’ŒJava Web Startè¿ç§»åˆ°AdoptOpenJDKå’ŒOpenWebStart</a></li>
<li><a href="../zh-CN487800/index.html">ä¸ºä»€ä¹ˆé‡è¦çš„æ˜¯è¦å‘Šè¯‰ç”³è¯·äººé¢è¯•ä¸­å‡ºäº†ä»€ä¹ˆé—®é¢˜ï¼ˆä»¥åŠæ­£ç¡®çš„åšæ³•ï¼‰</a></li>
<li><a href="../zh-CN487802/index.html">ä¸é—´æ–­APC Smart UPSï¼Œä»¥åŠå¦‚ä½•çƒ¹é¥ª</a></li>
<li><a href="../zh-CN487804/index.html">Raiffeisenbankçš„æˆé•¿å›¢é˜Ÿèšä¼š</a></li>
<li><a href="../zh-CN487806/index.html">åˆ›å»ºä¸€ä¸ªå°çš„Deno API</a></li>
<li><a href="../zh-CN487812/index.html">æµ‹è¯•æ³¢å…°LEDå…‰è°±LED E27</a></li>
<li><a href="../zh-CN487814/index.html">é€Ÿåº¦å’Œå¯é æ€§æ›´é«˜ï¼Œä»·æ ¼æ›´ä½ã€‚æ–°çš„é‡‘å£«é¡¿KC2000å›ºæ€é©±åŠ¨å™¨</a></li>
<li><a href="../zh-CN487822/index.html">AvitoTechå·¡å›æ¼”å‡ºï¼šä¸‹è¯ºå¤«å“¥ç½—å¾·çš„Androidèšä¼š</a></li>
<li><a href="../zh-CN487824/index.html">æ¥è‡ªæ¬§æ´²çš„Spectrum Led GU10 LEDç¯æ¦‚è¿°</a></li>
<li><a href="../zh-CN487826/index.html">æ³¢å…°Spectrum Led E14çš„LEDç¯æ¦‚è¿°</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>