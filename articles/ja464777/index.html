<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛥️ ⤵️ 🧝 constがC / C ++コードを高速化しないのはなぜですか？ 😲 👩🏾‍🌾 🧝🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="数か月前、私はある投稿でこれが神話であると述べました。まるでconstがCおよびC ++でコンパイラの最適化を有効にするのに役立つかのようです。特に私自身が以前にこの神話を信じていたので、この声明は説明されるべきであると決めました。理論と人工的な例から始めて、実際のコードベースであるSQLiteに基...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>constがC / C ++コードを高速化しないのはなぜですか？</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/464777/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ck/cw/48/ckcw48o0aqklzf10gzhfqx8w3rw.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数か月前、私はある投稿で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これが神話で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あると述べました。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">まるでconstがCおよびC ++でコンパイラの最適化を有効にするのに役立つかのようです</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">特に私自身が以前にこの神話を信じていたので、この声明は説明されるべきであると決めました。</font><font style="vertical-align: inherit;">理論と人工的な例から始めて、実際のコードベースであるSQLiteに基づく実験とベンチマークに移ります。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">簡単なテスト</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が思ったように、でCコードを高速化する最も単純で最も明白な例から始めましょう</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">2つの関数宣言があるとします。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *x)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">constFunc</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> *x)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、コードには次の2つのバージョンがあるとします。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">byArg</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *x)</span>
</span>{
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, *x);<font></font>
  func(x);<font></font>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, *x);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">constByArg</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> *x)</span>
</span>{
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, *x);<font></font>
  constFunc(x);<font></font>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, *x);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行するに</font></font><code>printf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、プロセッサはポインタを介してメモリから値を取得する必要があります</font></font><code>*x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">明らかに、</font></font><code>constByArg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイラ</font></font><code>*x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は定数を</font><font style="vertical-align: inherit;">知っているため</font><font style="vertical-align: inherit;">、実行</font><font style="vertical-align: inherit;">をわずかに加速することができるため</font><font style="vertical-align: inherit;">、実行</font><font style="vertical-align: inherit;">後に値を再度ロードする必要はありません</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">正しく？</font><font style="vertical-align: inherit;">最適化を有効にしてGCCによって生成されたアセンブラコードを見てみましょう。</font></font><br>
<br>
<pre><code class="bash hljs">$ gcc -S -Wall -O3 test.c<font></font>
$ view test.s</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてここにアセンブラでの完全な結果があります</font></font><code>byArg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">byArg:<font></font>
.LFB23:<font></font>
    .cfi_startproc<font></font>
    pushq   %rbx<font></font>
    .cfi_def_cfa_offset 16<font></font>
    .cfi_offset 3, -16<font></font>
    movl    (%rdi), %edx<font></font>
    movq    %rdi, %rbx<font></font>
    leaq    .LC0(%rip), %rsi<font></font>
    movl    $1, %edi<font></font>
    xorl    %eax, %eax<font></font>
    call    __printf_chk@PLT<font></font>
    movq    %rbx, %rdi<font></font>
    call    func@PLT  # The only instruction that's different in constFoo<font></font>
    movl    (%rbx), %edx<font></font>
    leaq    .LC0(%rip), %rsi<font></font>
    xorl    %eax, %eax<font></font>
    movl    $1, %edi<font></font>
    popq    %rbx<font></font>
    .cfi_def_cfa_offset 8<font></font>
    jmp __printf_chk@PLT<font></font>
    .cfi_endproc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アセンブラコードの間の唯一の違いは、のために生成</font></font><code>byArg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><code>constByArg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それがある</font></font><code>constByArg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font></font><code>call constFunc@PLT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ソースコードのように、。</font><font style="vertical-align: inherit;">それ自体</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は違いを</font><font style="vertical-align: inherit;">もたらし</font><font style="vertical-align: inherit;">ません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、それはGCCでした。</font><font style="vertical-align: inherit;">多分私達はよりスマートなコンパイラを必要としています。</font><font style="vertical-align: inherit;">クランと言ってください。</font></font><br>
<br>
<pre><code class="cpp hljs">$ clang -S -Wall -O3 -emit-llvm test.c<font></font>
$ view test.ll</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが中間コードです。</font><font style="vertical-align: inherit;">これはアセンブラよりもコンパクトであり、両方の関数を省略して、「呼び出し以外は違いがない」という意味を理解できるようにします。</font></font><br>
<br>
<pre><code class="cpp hljs">; Function Attrs: nounwind uwtable<font></font>
define dso_local <span class="hljs-keyword">void</span> @byArg(i32*) local_unnamed_addr #<span class="hljs-number">0</span> {<font></font>
  %<span class="hljs-number">2</span> = load i32, i32* %<span class="hljs-number">0</span>, align <span class="hljs-number">4</span>, !tbaa !<span class="hljs-number">2</span>
  %<span class="hljs-number">3</span> = tail call i32 (i8*, ...) @<span class="hljs-built_in">printf</span>(i8* getelementptr inbounds ([<span class="hljs-number">4</span> x i8], [<span class="hljs-number">4</span> x i8]* @.str, i64 <span class="hljs-number">0</span>, i64 <span class="hljs-number">0</span>), i32 %<span class="hljs-number">2</span>)<font></font>
  tail call <span class="hljs-keyword">void</span> @func(i32* %<span class="hljs-number">0</span>) #<span class="hljs-number">4</span>
  %<span class="hljs-number">4</span> = load i32, i32* %<span class="hljs-number">0</span>, align <span class="hljs-number">4</span>, !tbaa !<span class="hljs-number">2</span>
  %<span class="hljs-number">5</span> = tail call i32 (i8*, ...) @<span class="hljs-built_in">printf</span>(i8* getelementptr inbounds ([<span class="hljs-number">4</span> x i8], [<span class="hljs-number">4</span> x i8]* @.str, i64 <span class="hljs-number">0</span>, i64 <span class="hljs-number">0</span>), i32 %<span class="hljs-number">4</span>)<font></font>
  ret <span class="hljs-keyword">void</span><font></font>
}<font></font>
<font></font>
; Function Attrs: nounwind uwtable<font></font>
define dso_local <span class="hljs-keyword">void</span> @constByArg(i32*) local_unnamed_addr #<span class="hljs-number">0</span> {<font></font>
  %<span class="hljs-number">2</span> = load i32, i32* %<span class="hljs-number">0</span>, align <span class="hljs-number">4</span>, !tbaa !<span class="hljs-number">2</span>
  %<span class="hljs-number">3</span> = tail call i32 (i8*, ...) @<span class="hljs-built_in">printf</span>(i8* getelementptr inbounds ([<span class="hljs-number">4</span> x i8], [<span class="hljs-number">4</span> x i8]* @.str, i64 <span class="hljs-number">0</span>, i64 <span class="hljs-number">0</span>), i32 %<span class="hljs-number">2</span>)<font></font>
  tail call <span class="hljs-keyword">void</span> @constFunc(i32* %<span class="hljs-number">0</span>) #<span class="hljs-number">4</span>
  %<span class="hljs-number">4</span> = load i32, i32* %<span class="hljs-number">0</span>, align <span class="hljs-number">4</span>, !tbaa !<span class="hljs-number">2</span>
  %<span class="hljs-number">5</span> = tail call i32 (i8*, ...) @<span class="hljs-built_in">printf</span>(i8* getelementptr inbounds ([<span class="hljs-number">4</span> x i8], [<span class="hljs-number">4</span> x i8]* @.str, i64 <span class="hljs-number">0</span>, i64 <span class="hljs-number">0</span>), i32 %<span class="hljs-number">4</span>)<font></font>
  ret <span class="hljs-keyword">void</span>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（タイプ）が機能するオプション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、ここに可用性が</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本当に重要な</font><font style="vertical-align: inherit;">コードがあります</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">localVar</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> x = <span class="hljs-number">42</span>;
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, x);<font></font>
  constFunc(&amp;x);<font></font>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, x);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">constLocalVar</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> x = <span class="hljs-number">42</span>;  <span class="hljs-comment">// const on the local variable</span>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, x);<font></font>
  constFunc(&amp;x);<font></font>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, x);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><code>localVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部で最適化された2つの命令を含むの</font><font style="vertical-align: inherit;">
アセンブラコード</font></font><code>constLocalVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs">localVar: <font></font>
.LFB25:<font></font>
    .cfi_startproc<font></font>
    subq    $<span class="hljs-number">24</span>, %rsp<font></font>
    .cfi_def_cfa_offset <span class="hljs-number">32</span>
    movl    $<span class="hljs-number">42</span>, %edx<font></font>
    movl    $<span class="hljs-number">1</span>, %edi<font></font>
    movq    %fs:<span class="hljs-number">40</span>, %rax<font></font>
    movq    %rax, <span class="hljs-number">8</span>(%rsp)<font></font>
    xorl    %eax, %eax<font></font>
    leaq    .LC0(%rip), %rsi<font></font>
    movl    $<span class="hljs-number">42</span>, <span class="hljs-number">4</span>(%rsp)<font></font>
    call    __printf_chk@PLT<font></font>
    leaq    <span class="hljs-number">4</span>(%rsp), %rdi<font></font>
    call    constFunc@PLT<font></font>
    movl    <span class="hljs-number">4</span>(%rsp), %edx  <span class="hljs-meta"># not in constLocalVar()</span><font></font>
    xorl    %eax, %eax<font></font>
    movl    $<span class="hljs-number">1</span>, %edi<font></font>
    leaq    .LC0(%rip), %rsi  <span class="hljs-meta"># not in constLocalVar()</span><font></font>
    call    __printf_chk@PLT<font></font>
    movq    <span class="hljs-number">8</span>(%rsp), %rax<font></font>
    xorq    %fs:<span class="hljs-number">40</span>, %rax<font></font>
    jne .L9<font></font>
    addq    $<span class="hljs-number">24</span>, %rsp<font></font>
    .cfi_remember_state<font></font>
    .cfi_def_cfa_offset <span class="hljs-number">8</span><font></font>
    ret<font></font>
.L9:<font></font>
    .cfi_restore_state<font></font>
    call    __stack_chk_fail@PLT<font></font>
    .cfi_endproc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LLVMミドルウェアは少しクリーンです。</font></font><code>load</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番目の呼び出し</font></font><code>printf()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が外部で最適化さ</font><font style="vertical-align: inherit;">れる前</font></font><code>constLocalVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs">; Function Attrs: nounwind uwtable<font></font>
define dso_local <span class="hljs-keyword">void</span> @localVar() local_unnamed_addr #<span class="hljs-number">0</span> {<font></font>
  %<span class="hljs-number">1</span> = alloca i32, align <span class="hljs-number">4</span>
  %<span class="hljs-number">2</span> = bitcast i32* %<span class="hljs-number">1</span> to i8*<font></font>
  call <span class="hljs-keyword">void</span> @llvm.lifetime.start.p0i8(i64 <span class="hljs-number">4</span>, i8* nonnull %<span class="hljs-number">2</span>) #<span class="hljs-number">4</span>
  store i32 <span class="hljs-number">42</span>, i32* %<span class="hljs-number">1</span>, align <span class="hljs-number">4</span>, !tbaa !<span class="hljs-number">2</span>
  %<span class="hljs-number">3</span> = tail call i32 (i8*, ...) @<span class="hljs-built_in">printf</span>(i8* getelementptr inbounds ([<span class="hljs-number">4</span> x i8], [<span class="hljs-number">4</span> x i8]* @.str, i64 <span class="hljs-number">0</span>, i64 <span class="hljs-number">0</span>), i32 <span class="hljs-number">42</span>)<font></font>
  call <span class="hljs-keyword">void</span> @constFunc(i32* nonnull %<span class="hljs-number">1</span>) #<span class="hljs-number">4</span>
  %<span class="hljs-number">4</span> = load i32, i32* %<span class="hljs-number">1</span>, align <span class="hljs-number">4</span>, !tbaa !<span class="hljs-number">2</span>
  %<span class="hljs-number">5</span> = call i32 (i8*, ...) @<span class="hljs-built_in">printf</span>(i8* getelementptr inbounds ([<span class="hljs-number">4</span> x i8], [<span class="hljs-number">4</span> x i8]* @.str, i64 <span class="hljs-number">0</span>, i64 <span class="hljs-number">0</span>), i32 %<span class="hljs-number">4</span>)<font></font>
  call <span class="hljs-keyword">void</span> @llvm.lifetime.end.p0i8(i64 <span class="hljs-number">4</span>, i8* nonnull %<span class="hljs-number">2</span>) #<span class="hljs-number">4</span>
  ret <span class="hljs-keyword">void</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから、</font></font><code>constLocalVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功し、再起動を無視し</font></font><code>*x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ていますが、奇妙な何かに気づいたことがあります。ボディに</font></font><code>localVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><code>constLocalVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じ挑戦</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">コンパイラがで</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変更さ</font></font><code>*x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ</font><font style="vertical-align: inherit;">て</font><font style="vertical-align: inherit;">い</font></font><code>constLocalVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ないことを理解できる場合、同じ関数呼び出しがで変更さ</font></font><code>*x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れて</font><font style="vertical-align: inherit;">いないことを理解できないのはなぜ</font></font><code>localVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その理由</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、Cで最適化として使用することが実際的でない</font><font style="vertical-align: inherit;">理由</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">Cでは、</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本的に2つの意味があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、変数が一部のデータの読み取り専用の仮名であることを意味している可能性があります。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または、変数が実際に定数であることを意味する場合があります。</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定数値をポインタから</font><font style="vertical-align: inherit;">解放し</font><font style="vertical-align: inherit;">てから書き込むと、未定義の動作が発生します。</font><font style="vertical-align: inherit;">一方、</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定数ではない値へのポインタで</font><font style="vertical-align: inherit;">あれば問題</font><font style="vertical-align: inherit;">ありません。</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、実装例を示します</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// x is just a read-only pointer to something that may or may not be a constant</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">constFunc</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> *x)</span>
</span>{
  <span class="hljs-comment">// local_var is a true constant</span>
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> local_var = <span class="hljs-number">42</span>;<font></font>
<font></font>
  <span class="hljs-comment">// Definitely undefined behaviour by C rules</span>
  doubleIt((<span class="hljs-keyword">int</span>*)&amp;local_var);
  <span class="hljs-comment">// Who knows if this is UB?</span>
  doubleIt((<span class="hljs-keyword">int</span>*)x);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doubleIt</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *x)</span>
</span>{<font></font>
  *x *= <span class="hljs-number">2</span>;<font></font>
}<font></font>
</code></pre><br>
<code>localVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数</font><font style="vertical-align: inherit;">へ</font><font style="vertical-align: inherit;">の</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポインタ</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">与えました</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。変数は元々なかっ</font><font style="vertical-align: inherit;">たため、うそつき</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">である</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことが判明し、UBを開始せずに変数を強制的に変更できます。したがって、コンパイラーは、</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数を</font><font style="vertical-align: inherit;">返した後</font><font style="vertical-align: inherit;">、同じ値を持つ</font><font style="vertical-align: inherit;">ことを想定できません</font><font style="vertical-align: inherit;">。変数inは</font></font><code>constLocalVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">確か</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">になので、コンパイラーが</font><font style="vertical-align: inherit;">変数</font><font style="vertical-align: inherit;">をアンバインド</font><font style="vertical-align: inherit;">して変数に書き込むの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今回</font><i><font style="vertical-align: inherit;">は</font></i><font style="vertical-align: inherit;"> UBであるため、</font><font style="vertical-align: inherit;">変更されないことをコンパイラーが想定することはできません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
関数</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">最初の例は、コンパイラーが本当にそうで</font><font style="vertical-align: inherit;">ある</font><font style="vertical-align: inherit;">かどうかを判断できないため、絶望的</font><font style="vertical-align: inherit;">です</font><font style="vertical-align: inherit;">。</font></font><code>constFunc()</code><font style="vertical-align: inherit;"></font><code>const</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>byArg()</code><font style="vertical-align: inherit;"></font><code>constByArg()</code><font style="vertical-align: inherit;"></font><code>*x</code><font style="vertical-align: inherit;"></font><code>const</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、矛盾はどこから来たのでしょうか？コンパイラが</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から呼び出されたときに引数を変更しない</font><font style="vertical-align: inherit;">と想定</font></font><code>constLocalVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できる場合、同じ最適化を呼び出しに適用できます</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">よね？番号。コンパイラは、</font></font><code>constLocalVar()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それが呼び出される</font><font style="vertical-align: inherit;">ことをまったく想定できません</font><font style="vertical-align: inherit;">。そうでない場合（たとえば、コードジェネレーターまたはマクロの追加結果の一部であるため）、</font></font><code>constFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UBを開始せずに静かにデータを変更できます。</font><font style="vertical-align: inherit;">、誰かがどこかで変更できるという事実に基づいている必要があります。つまり、コンパイラーはそれ</font><font style="vertical-align: inherit;">を最適化に</font><font style="vertical-align: inherit;">使用できません</font><font style="vertical-align: inherit;">。実際には、これは真実です。なぜなら、実際のCコードの多くには</font><font style="vertical-align: inherit;">、「私が何をしているのかわかっている」というスタイルの</font><font style="vertical-align: inherit;">拒否</font><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">含まれ</font><font style="vertical-align: inherit;">ているためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
上記の例と説明を数回読む必要があるかもしれません。不条理に聞こえることを心配しないでください-それはそうです。残念ながら、変数への書き込み</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は最悪の種類のUBです。ほとんどの場合、コンパイラーはUBになるかどうかさえ知りません。したがって、コンパイラが</font></font><code>const</code><font style="vertical-align: inherit;"></font><code>const</code><font style="vertical-align: inherit;"></font><code>const</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポインターを使用して別のスコープからデータを取得したり、ヒープにデータを配置したりする</font><font style="vertical-align: inherit;">など、コンパイラーが</font><font style="vertical-align: inherit;">最適化に</font><font style="vertical-align: inherit;">それを使用できない状況が数多く</font><font style="vertical-align: inherit;">あります。</font><font style="vertical-align: inherit;">さらに悪いことに、通常コンパイラがを使用できない状況では</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、これは必要ありません。</font><font style="vertical-align: inherit;">たとえば、自尊心のあるコンパイラは</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次のコードで何</font></font><code>x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が一定</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">なく</font><font style="vertical-align: inherit;">て</font><font style="vertical-align: inherit;">も</font><font style="vertical-align: inherit;">理解</font><font style="vertical-align: inherit;">でき</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> x = <span class="hljs-number">42</span>, y = <span class="hljs-number">0</span>;
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d\n"</span>, x, y);<font></font>
y += x;<font></font>
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d\n"</span>, x, y);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、次の</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理由により、最適化に</font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">ほとんど役に立ちません。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかの例外を除いて、一部のコードは合法的にコードを解くことができるため、コンパイラーはそれを無視することを強制され</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上記の例外のほとんどで、コンパイラーは変数が定数であることをまだ理解できます。</font></font><br>
</li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++で作成</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すると、関数のオーバーロードによるコード生成に影響を与える可能性があります。</font><font style="vertical-align: inherit;">同じ関数の</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オーバーロードを</font><font style="vertical-align: inherit;">持つことができ</font><font style="vertical-align: inherit;">、同時に</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コピーを少なくするなど、それらを（コンパイラーではなくプログラマーが）最適化することはできません。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *p)</span>
</span>{
  <span class="hljs-comment">// Needs to do more copying of data</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> *p)</span>
</span>{
  <span class="hljs-comment">// Doesn't need defensive copies</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> x = <span class="hljs-number">42</span>;
  <span class="hljs-comment">// const-ness affects which overload gets called</span><font></font>
  foo(&amp;x);<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方では、実際にはこれがC ++コードでしばしば適用されるとは思いません。</font><font style="vertical-align: inherit;">一方、それが本当に違いを生むためには、プログラマーはコンパイラーが利用できない仮定を行う必要があります。それは、それらが言語によって保証されていないためです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLite3を試す</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
十分な理論と十分に理解された例。</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このコードベースには</font><font style="vertical-align: inherit;">どのような影響が</font><font style="vertical-align: inherit;">ありますか？</font><font style="vertical-align: inherit;">SQLite DB（バージョン3.30.0）を試すことにしました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それは使用しています </font></font><code>const.</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは重要なコードベースです（200 KLOC以上）。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースとして、文字列値の処理で始まり、数値から日付への変換で終わる、いくつかのメカニズムが含まれています。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセッサの制限された負荷でテストできます。</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、開発者や開発に携わるプログラマーはすでに何年もかけて生産性を向上させてきたので、明らかなものを見落とさなかったと考えられます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニング</font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースコードの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
コピーを2つ作成しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">1つは通常モードでコンパイルされ、もう1つはハックを使用して前処理</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">されてアイドルコマンド</font><font style="vertical-align: inherit;">に変わります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> const</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（GNU）</font></font><code>sed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドでこれを各ファイルの上に追加できます</font></font><code>sed -i '1i#define const' *.c *.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLiteは、ビルド中にコードを生成するスクリプトを使用して、物事を少し複雑にします。</font><font style="vertical-align: inherit;">さいわい、コンパイラーは、</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">コードが混在している場合とそう</font><font style="vertical-align: inherit;">でない</font><font style="vertical-align: inherit;">場合とで大量のノイズを発生させる</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、スクリプトにすぐに気付き、構成して、私のアンチ</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font><font style="vertical-align: inherit;">を追加でき</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小さな変更はメモリスキーム全体に影響を与える可能性があるため、コンパイルされたコードを直接比較しても意味がありません。これにより、コード全体のポインタと関数呼び出しが変更されます。</font><font style="vertical-align: inherit;">そのため、</font></font><code>objdump -d libSQLite3.so.0.8.6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイナリのサイズと各命令のニーモニック名の形式で</font><font style="vertical-align: inherit;">逆アセンブルされたキャスト（</font><font style="vertical-align: inherit;">）を使用しました。</font><font style="vertical-align: inherit;">たとえば、次の関数：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-number">000000000005</span>d570 &lt;SQLite3_blob_read&gt;:
   <span class="hljs-number">5</span>d570:       <span class="hljs-number">4</span>c <span class="hljs-number">8</span>d <span class="hljs-number">05</span> <span class="hljs-number">59</span> a2 ff ff    lea    <span class="hljs-number">-0x5da7</span>(%rip),%r8        # <span class="hljs-number">577</span>d0 &lt;SQLite3BtreePayloadChecked&gt;
   <span class="hljs-number">5</span>d577:       e9 <span class="hljs-number">04</span> fe ff ff          jmpq   <span class="hljs-number">5</span>d380 &lt;blobReadWrite&gt;
   <span class="hljs-number">5</span>d57c:       <span class="hljs-number">0f</span> <span class="hljs-number">1f</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span>             nopl   <span class="hljs-number">0x0</span>(%rax)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
になる：</font></font><br>
<br>
<pre><code class="cpp hljs">SQLite3_blob_read   <span class="hljs-number">7l</span>ea <span class="hljs-number">5</span>jmpq <span class="hljs-number">4</span>nopl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイル時にSQLiteのビルド設定を変更しませんでした。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイルされたコード分析</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
libSQLite3.soの場合、バージョンc </font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">4,740,704 </font><font style="vertical-align: inherit;">バイトを占め、</font><font style="vertical-align: inherit;">4,736,712 </font><font style="vertical-align: inherit;">バイトを</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含ま</font><font style="vertical-align: inherit;">ないバージョンより約0.1％多くなりました</font><font style="vertical-align: inherit;">。どちらの場合も、1374個の関数がエクスポートされ（PLTの低レベルヘルパー関数は含まれません）、13個のキャストに違いがありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの変更は前処理ハックに関連しています。たとえば、変更された関数の1つを次に示します（SQLiteに固有の定義の一部を削除しました）。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LARGEST_INT64  (0xffffffff|(((int64_t)0x7fffffff)&lt;&lt;32))</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SMALLEST_INT64 (((int64_t)-1) - LARGEST_INT64)</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int64_t</span> <span class="hljs-title">doubleToInt64</span><span class="hljs-params">(<span class="hljs-keyword">double</span> r)</span></span>{
  <span class="hljs-comment">/*
  ** Many compilers we encounter do not define constants for the
  ** minimum and maximum 64-bit integers, or they define them
  ** inconsistently.  And many do not understand the "LL" notation.
  ** So we define our own static constants here using nothing
  ** larger than a 32-bit integer constant.
  */</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int64_t</span> maxInt = LARGEST_INT64;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int64_t</span> minInt = SMALLEST_INT64;<font></font>
<font></font>
  <span class="hljs-keyword">if</span>( r&lt;=(<span class="hljs-keyword">double</span>)minInt ){
    <span class="hljs-keyword">return</span> minInt;<font></font>
  }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( r&gt;=(<span class="hljs-keyword">double</span>)maxInt ){
    <span class="hljs-keyword">return</span> maxInt; <font></font>
  }<span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">int64_t</span>)r;<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
削除された</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合、これらの定数は- </font></font><code>static</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数に変わります。気にしない人が</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらの変数</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成する</font><font style="vertical-align: inherit;">必要がある理由がわかりません</font></font><code>static</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><code>static</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">との</font><font style="vertical-align: inherit;">両方を削除する</font><font style="vertical-align: inherit;">と</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、GCCは再びそれらを定数と見なし、同じ結果が得られます。そのような</font></font><code>static const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数の</font><font style="vertical-align: inherit;">ために</font><font style="vertical-align: inherit;">、13のうち3つの関数の変更は誤りであることがわかりましたが、私はそれらを修正しませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLiteは多くのグローバル変数を使用し、これらの実際の</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化の</font><font style="vertical-align: inherit;">ほとんどはこれに関連し</font><font style="vertical-align: inherit;">ています</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たとえば</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、比較を変数による比較と定数との比較で置き換える、またはループを1ステップで部分的にロールバックする（どのような最適化が行われたかを理解するために、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Radare</font></a><font style="vertical-align: inherit;">を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">）。いくつかの変更は言及する価値がありません。</font></font><code>SQLite3ParseUri()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">487の手順が含まれていますが</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1つの変更のみを行いました：次の2つの比較を行いました：</font></font><br>
<br>
<pre><code class="cpp hljs">test %al, %al<font></font>
je &lt;SQLite3ParseUri+<span class="hljs-number">0x717</span>&gt;<font></font>
cmp $<span class="hljs-number">0x23</span>, %al<font></font>
je &lt;SQLite3ParseUri+<span class="hljs-number">0x717</span>&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして交換：</font></font><br>
<br>
<pre><code class="cpp hljs">cmp $<span class="hljs-number">0x23</span>, %al<font></font>
je &lt;SQLite3ParseUri+<span class="hljs-number">0x717</span>&gt;<font></font>
test %al, %al<font></font>
je &lt;SQLite3ParseUri+<span class="hljs-number">0x717</span>&gt;</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベンチマーク</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQLiteにはパフォーマンスを測定するための回帰テストが付属しており、標準のSQLiteビルド設定を使用して、コードのバージョンごとに何百回も実行しました。</font><font style="vertical-align: inherit;">秒単位の実行時間：</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">constなし</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10,658</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10,803</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中央値</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,571</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,519</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,832</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,658</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平均</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,531</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,492</font></font><br>
</td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
個人的にはあまり違いはないと思います。</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラム全体から</font><font style="vertical-align: inherit;">外した</font><font style="vertical-align: inherit;">ので、目立った違いがあれば気づきやすかったです。</font><font style="vertical-align: inherit;">ただし、パフォーマンスが非常に重要な場合は、小さな加速でも満足できます。</font><font style="vertical-align: inherit;">統計分析をしましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はそのようなタスクにマンホイットニーU検定を使用するのが好きです。これは、グループの違いを特定するために設計された、よく知られたt検定に似ていますが、コンピューターで時間を測定するときに発生する複雑なランダム変動に対してより耐性があります（予測不可能なコンテキストスイッチ、エラーメモリのページなど）。</font><font style="vertical-align: inherit;">結果は次のとおりです。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">constなし</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中分類（平均ランク）</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">121.38</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">79.62</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マンホイットニーu</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2912</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-5.10</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">両側p値</font></font></td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-6</font></font></sup><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平均差はHLです</font></font><br>
</td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-0.056秒</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">95％信頼区間</font></font><br>
</td>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-0.077 ... -0.038秒。</font></font><br>
</td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストUでは、統計的に有意なパフォーマンスの違いが見つかりました。</font><font style="vertical-align: inherit;">しかし-驚き！</font><font style="vertical-align: inherit;">-高速バージョン</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、約60ミリ秒、つまり0.5％</font><font style="vertical-align: inherit;">なし</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">あることが判明しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">行われた「最適化」の数が少ないことは、コードの量を増やす価値がなかったようです。</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動ベクトル化などの主要な最適化</font><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">アクティブ化さ</font><font style="vertical-align: inherit;">れていることはほとんどありません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">もちろん、マイレージはコンパイラのさまざまなフラグ、またはそのバージョン、コードベース、またはその他に依存する場合があります。</font><font style="vertical-align: inherit;">でも、</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cが改善され</font><font style="vertical-align: inherit;">ても</font><font style="vertical-align: inherit;">気づかなかった</font><font style="vertical-align: inherit;">と言っても過言で</font><font style="vertical-align: inherit;">はないと思います。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それではconstは何のために必要ですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての欠点</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があるため</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">C / C ++はタイプセーフを提供するのに役立ちます。</font><font style="vertical-align: inherit;">特に、</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移動セマンティクスおよびと組み合わせて</font><font style="vertical-align: inherit;">適用</font><font style="vertical-align: inherit;">すると</font></font><code>std::unique_pointer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、明示的なポインターの所有権を実装できます。</font><font style="vertical-align: inherit;">ポインタの所有権の不確実性は、100 KLOCを超える古いC ++コードベースでは大きな問題でした</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。その解決策に</font><font style="vertical-align: inherit;">感謝</font><font style="vertical-align: inherit;">します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、以前は、</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイプセーフティの</font><font style="vertical-align: inherit;">用途</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">超えてい</font><font style="vertical-align: inherit;">ました。</font><font style="vertical-align: inherit;">コードが読みにくくなった</font><font style="vertical-align: inherit;">としても</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">できるだけ積極的に適用することが正しいと考えられていたと聞きました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">当時はそれは妥当に聞こえましたが、それ以来、それは真実ではないことに気付きました。</font></font><code>const</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生産性を上げるため</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">パフォーマンスが本当に重要な場合は、コードをリファクタリングしてさらに追加する必要があると聞きました</font></font><code>const</code><font style="vertical-align: inherit;"></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja464763/index.html">Linux上のサーバーのベンチマーク：オープンツールの選択</a></li>
<li><a href="../ja464765/index.html">FreePBX + GoIPの構成</a></li>
<li><a href="../ja464769/index.html">Badooが毎秒20万枚の写真を提供することを可能にした方法</a></li>
<li><a href="../ja464773/index.html">リッチインターネットアプリケーションの非同期Typescriptとそれと戦うデコレータ</a></li>
<li><a href="../ja464775/index.html">9月21日Badoo PHPミートアップ＃3：パフォーマンス</a></li>
<li><a href="../ja464779/index.html">快楽主義のミツバチについて、人々が彼らを働かせる方法とドローン</a></li>
<li><a href="../ja464781/index.html">スマートTV：CRTからHDR</a></li>
<li><a href="../ja464785/index.html">競争力のないビーラインのメリット</a></li>
<li><a href="../ja464787/index.html">上級モバイル開発者は推薦だけで来ると確信しています</a></li>
<li><a href="../ja464791/index.html">車のKubernetes：開発者が車載コンピューターにアクセスできるようにし、安全にする方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>