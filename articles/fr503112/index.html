<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛤️ 🙍🏽 👸🏾 Histoire de support DNS Cloud manquante de Google Cloud 👨🏼‍🏫 🤟🏽 🚠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="D'un éditeur de blog Google: vous êtes-vous déjà demandé comment les ingénieurs de Google Cloud Technical Solutions (TSE) gèrent vos appels au support...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Histoire de support DNS Cloud manquante de Google Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'un éditeur de blog Google:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous êtes-vous déjà demandé comment les ingénieurs de Google Cloud Technical Solutions (TSE) gèrent vos appels au support technique? La responsabilité des ingénieurs du support technique de TSE est de détecter et de résoudre les sources de problèmes identifiés par les utilisateurs. Certains de ces problèmes sont assez simples, mais parfois vous rencontrez un appel nécessitant l'attention de plusieurs ingénieurs à la fois. Dans cet article, l'un des employés de TSE nous parlera d'un problème très délicat de sa pratique récente - le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cas de paquets DNS manquants</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Au cours de cette histoire, nous verrons comment les ingénieurs ont réussi à résoudre la situation et quelles nouvelles choses ils ont apprises au cours de l'élimination de l'erreur. Nous espérons que cette histoire vous parlera non seulement d'un bogue profondément enraciné, mais qu'elle vous permettra également de comprendre les processus qui se produisent lors de la soumission d'une demande de prise en charge de Google Cloud.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Le dépannage est à la fois une science et un art. Tout commence par la construction d'une hypothèse sur la cause du comportement non standard du système, après quoi il est testé pour sa résistance. Cependant, avant de formuler une hypothèse, nous devons clairement identifier et formuler avec précision le problème. Si la question vous semble trop vague, vous devez tout analyser correctement; c'est "l'art" du dépannage.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le contexte de Google Cloud, ces processus sont parfois compliqués, car Google Cloud a du mal à garantir la confidentialité de ses utilisateurs. </font><font style="vertical-align: inherit;">Pour cette raison, les ingénieurs TSE n'ont ni accès à l'édition de vos systèmes, ni la possibilité d'afficher les configurations aussi largement que les utilisateurs. </font><font style="vertical-align: inherit;">Par conséquent, pour tester l'une de nos hypothèses, nous (ingénieurs) ne pouvons pas modifier rapidement le système. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certains utilisateurs croient que nous allons tout réparer comme si les mécaniciens du service automobile et nous envoyaient simplement l'identifiant de la machine virtuelle, alors qu'en réalité le processus se déroule dans un format de conversation: collecte d'informations, génération et confirmation (ou réfutation) d'hypothèses, et, finalement, résolution les problèmes reposent sur la communication avec le client.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Question à l'examen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, nous avons une histoire avec une bonne fin. </font><font style="vertical-align: inherit;">L'une des raisons de la solution réussie du cas proposé est une description très détaillée et précise du problème. </font><font style="vertical-align: inherit;">Ci-dessous vous pouvez voir une copie du premier ticket (édité, afin de cacher des informations confidentielles): </font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce message a beaucoup d'informations utiles pour nous:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VM spécifiée</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le problème est indiqué - DNS ne fonctionne pas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est indiqué où le problème se manifeste - VM et conteneur</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les étapes que l'utilisateur a suivies pour identifier le problème sont indiquées.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel a été enregistré comme «P1: Impact critique - Service inutilisable en production», ce qui signifie un suivi constant de la situation 24h / 24 et 7j / 7 selon le schéma «Follow the Sun» (le lien peut être lu plus en détail sur les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">priorités des appels des utilisateurs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), avec transmission par une équipe d'assistance technique à l'autre à chaque décalage de fuseau horaire. </font><font style="vertical-align: inherit;">En fait, au moment où le problème a atteint notre équipe à Zurich, elle a réussi à faire le tour du monde. </font><font style="vertical-align: inherit;">À ce moment, l'utilisateur a pris des mesures pour réduire les conséquences, cependant, il avait peur d'une répétition de la situation sur la production, car la raison principale n'était toujours pas trouvée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au moment où le billet est arrivé à Zurich, nous disposions déjà des informations suivantes:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenu </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenu </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le </font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier pcap </font><font style="vertical-align: inherit;">compilé par la commande</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec ces données, nous étions prêts à entamer la phase «d'investigation» et de dépannage.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos premiers pas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous avons vérifié les journaux et l'état du serveur de métadonnées et nous nous sommes assurés qu'il fonctionne correctement. </font><font style="vertical-align: inherit;">Le serveur de métadonnées répond avec l'adresse IP 169.254.169.254 et, entre autres, est responsable du contrôle des noms de domaine. </font><font style="vertical-align: inherit;">Nous avons également vérifié que le pare-feu fonctionne correctement avec VM et ne bloque pas les paquets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'était un problème étrange: le test nmap a réfuté notre hypothèse principale sur la perte de paquets UDP, nous avons donc mentalement déduit plusieurs autres options et façons de les vérifier:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les paquets disparaissent-ils sélectivement? </font><font style="vertical-align: inherit;">=&gt; Vérifier les règles iptables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU est-il</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trop petit </font><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">=&gt; Vérifier la sortie</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le problème affecte-t-il uniquement les paquets UDP ou TCP? </font><font style="vertical-align: inherit;">=&gt; Éloignez-vous</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les paquets de recherche générés sont-ils retournés? </font><font style="vertical-align: inherit;">=&gt; Éloignez-vous</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les libdns fonctionnent-ils correctement? </font><font style="vertical-align: inherit;">=&gt; Partez </font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour vérifier le transfert de paquets dans les deux sens</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous décidons de téléphoner à l'utilisateur pour le dépannage en direct. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'appel, nous parvenons à vérifier plusieurs choses:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Après plusieurs vérifications, nous excluons les règles iptables de la liste des raisons.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous vérifions les interfaces réseau et les tables de routage, et revérifions le MTU</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous constatons que </font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(TCP) fonctionne comme il se doit, mais </font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UDP) ne fonctionne pas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Après avoir </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exécuté pendant que cela fonctionne </font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous constatons que les paquets UDP sont retournés</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous courons </font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et voyons comment creuser correctement les appels </font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cependant, le second est interrompu par un timeout</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, le changement est sur le point de se terminer et nous sommes obligés de transférer le problème au fuseau horaire suivant. L'appel, cependant, a suscité l'intérêt de notre équipe, et un collègue suggère de créer le paquet DNS source avec le module Python scrapy.</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce fragment crée un paquet DNS et envoie la demande au serveur de métadonnées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilisateur exécute le code, la réponse DNS est renvoyée et l'application le reçoit, ce qui confirme l'absence de problème au niveau du réseau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après le prochain "tour du monde", l'appel revient à notre équipe, et je le traduis complètement sur moi-même, pensant qu'il sera plus pratique pour l'utilisateur si l'appel cesse de tourner d'un endroit à l'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En attendant, l'utilisateur s'engage à fournir un instantané de l'image système. C'est une très bonne nouvelle: la possibilité de tester le système vous-même accélère considérablement le dépannage, car vous n'avez plus besoin de demander à l'utilisateur d'exécuter des commandes, de m'envoyer des résultats et de les analyser, je peux tout faire moi-même!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des collègues commencent à m'envoyer un peu. </font><font style="vertical-align: inherit;">Au déjeuner, nous discutons de l'appel, mais personne n'a la moindre idée de ce qui se passe. </font><font style="vertical-align: inherit;">Heureusement, l'utilisateur lui-même a déjà pris des mesures d'atténuation et n'est pas pressé, nous avons donc le temps de préparer le problème. </font><font style="vertical-align: inherit;">Et puisque nous avons une image, nous pouvons effectuer tous les tests qui nous intéressent. </font><font style="vertical-align: inherit;">Bien!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revenir en arrière</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des questions les plus fréquemment posées lors d'un entretien avec un ingénieur système est: "Que se passe-t-il lorsque vous envoyez une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requête</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ping à </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">www.google.com</font></a><font style="vertical-align: inherit;"> ?" </font><font style="vertical-align: inherit;">La question est chic, car le candidat doit être décrit du shell à l'espace utilisateur, au cœur du système et plus loin au réseau. </font><font style="vertical-align: inherit;">Je souris: parfois les questions d'entrevue sont également utiles dans la vraie vie ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je décide d'appliquer cette question eychar au problème actuel. </font><font style="vertical-align: inherit;">En gros, lorsque vous essayez de déterminer le nom DNS, les événements suivants se produisent:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'application appelle la bibliothèque système, par exemple libdns</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns vérifie la configuration système du serveur DNS qu'il doit utiliser (dans le diagramme, c'est 169.254.169.254, serveur de métadonnées)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns utilise des appels système pour créer un socket UDP (SOKET_DGRAM) et envoyer des paquets UDP avec une requête DNS dans les deux sens</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À l'aide de l'interface sysctl, vous pouvez configurer la pile UDP au niveau du noyau</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le noyau interagit avec le matériel pour transmettre des paquets sur le réseau via une interface réseau</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'hyperviseur intercepte et transmet le paquet au serveur de métadonnées lorsqu'il entre en contact avec lui</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur de métadonnées détermine le nom DNS par sa sorcellerie et renvoie la réponse de la même manière</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permettez-moi de vous rappeler quelles hypothèses nous avons déjà réussi à considérer: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothèse: bibliothèques cassées</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: exécutez strace dans le système, vérifiez que dig provoque les appels système corrects</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: les appels système corrects sont appelés</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: via Srapy pour vérifier si nous pouvons déterminer les noms contournant les bibliothèques système</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: nous pouvons</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 3: exécutez rpm –V sur le package libdns et les fichiers de bibliothèque md5sum</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: le code de la bibliothèque est complètement identique au code du système d'exploitation qui fonctionne</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 4: montez l'image du système racine de l'utilisateur sur la machine virtuelle sans ce comportement, exécutez chroot, voyez si DNS fonctionne</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: DNS fonctionne correctement</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion basée sur des tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problème n'est pas dans les bibliothèques </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothèse: il y a une erreur dans les paramètres DNS</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: vérifiez tcpdump et voyez si les paquets DNS sont envoyés et retournés correctement après l'exécution de dig</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: les paquets sont transmis correctement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: revérifiez sur le serveur </font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: tout est correct</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion basée sur les tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problème n'est pas dans l' </font><b><font style="vertical-align: inherit;">hypothèse de</font></b><font style="vertical-align: inherit;"> configuration DNS </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: le noyau est endommagé</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test: installez un nouveau noyau, vérifiez la signature, redémarrez</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: comportement similaire</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion basée sur des tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> noyau n'est pas endommagé </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothèse: comportement incorrect du réseau utilisateur (ou de l'interface réseau de l'hyperviseur)</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: vérifiez les paramètres du pare-feu</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: le pare-feu transmet les paquets DNS sur l'hôte et GCP</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: intercepter le trafic et suivre l'exactitude du transfert et du retour des requêtes DNS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: tcpdump accuse réception des paquets de retour par l'hôte</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion basée sur des tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problème n'est pas dans le réseau </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypothèse: le serveur de métadonnées ne fonctionne pas</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: recherchez les anomalies dans les journaux du serveur de métadonnées</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: il n'y a aucune anomalie dans les journaux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: contournez le serveur de métadonnées via </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résultat: l'autorisation est violée même sans utiliser de serveur de métadonnées</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion basée sur les </font><font style="vertical-align: inherit;">tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problème n'est pas dans le serveur de métadonnées </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bottom line:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous avons testé tous les sous - </font><font style="vertical-align: inherit;">systèmes à l' </font><font style="vertical-align: inherit;">exception des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paramètres d'exécution!</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plonger dans les paramètres d'exécution du noyau</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour configurer le runtime du noyau, vous pouvez utiliser les options de ligne de commande (grub) ou l'interface sysctl. </font><font style="vertical-align: inherit;">J'ai regardé dedans </font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et je pense seulement, j'ai trouvé quelques paramètres personnalisés. </font><font style="vertical-align: inherit;">Me sentant comme si j'avais saisi quelque chose, j'ai rejeté tous les paramètres non réseau ou non TCP, restant des paramètres de la montagne </font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ensuite, je me suis tourné vers l'endroit où la machine virtuelle a les autorisations d'hôte et j'ai commencé à appliquer l'un après l'autre, l'un après l'autre les paramètres avec une machine virtuelle cassée, jusqu'à ce que j'atteigne le criminel:</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La voici, une configuration qui brise le DNS! J'ai trouvé un instrument du crime. Mais pourquoi cela se produit-il? J'avais encore besoin d'un motif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La définition de la taille de base de la mémoire tampon des paquets DNS s'effectue via </font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Une valeur typique varie quelque part au sein de 200 Ko, mais si votre serveur reçoit beaucoup de paquets DNS, vous pouvez augmenter la taille du tampon. Si le tampon est plein au moment où un nouveau paquet arrive, par exemple, parce que l'application ne le traite pas assez rapidement, alors vous commencerez à perdre des paquets. Notre client a correctement augmenté la taille du tampon car il craignait la perte de données, car il utilisait l'application pour collecter des métriques via des paquets DNS. La valeur qu'il a définie était le maximum possible: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1 (si vous définissez 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le noyau retournera «ARGUMENT INVALIDE»).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Du coup, j'ai compris pourquoi nmap et scapy fonctionnaient correctement: ils utilisaient des sockets raw! Les sockets brutes sont différentes des sockets ordinaires: elles fonctionnent en contournant les iptables, et elles ne sont pas mises en mémoire tampon! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais pourquoi «un tampon trop grand» cause-t-il des problèmes? Cela ne fonctionne évidemment pas comme prévu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce stade, j'ai pu reproduire le problème sur plusieurs cœurs et plusieurs distributions. Le problème s'est déjà manifesté dans le noyau 3.x et se manifeste désormais également dans le noyau 5.x. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En effet, au démarrage</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS a cessé de fonctionner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai commencé à rechercher des valeurs de travail via un simple algorithme de recherche binaire et j'ai constaté que le système fonctionnait avec 2147481343, mais ce nombre était un ensemble de nombres sans signification pour moi. J'ai invité le client à essayer ce numéro, et il a répondu que le système fonctionnait avec google.com, mais qu'il donnait toujours une erreur avec d'autres domaines, alors j'ai continué mon enquête. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai installé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dropwatch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un outil que j'aurais dû utiliser auparavant: il montre où exactement le paquet se trouve dans le noyau. La fonction était coupable </font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. J'ai téléchargé les sources du noyau et ajouté plusieurs </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonctions</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour suivre où le paquet se trouve spécifiquement. J'ai rapidement trouvé la bonne condition</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et pendant un certain temps le regarda simplement, car c'est alors que tout s'est finalement réuni dans une image entière: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1, un nombre sans signification, un domaine inactif ... C'était un morceau de code dans </font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque:</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a le type int</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est de type u16 (int 16 bits non signé) et stocke la taille du paquet</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est de type int et stocke la taille du tampon, qui par définition est égale à la valeur de </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l' </font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">approche de 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , l'addition de la taille du paquet peut entraîner un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">débordement d'entier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et comme il s'agit d'un entier, sa valeur devient négative, donc la condition devient vraie alors qu'elle devrait être fausse (plus d'informations à ce sujet peuvent être trouvées par </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">référence</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'erreur est corrigée de manière triviale: en lançant sur </font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">J'ai appliqué le correctif et redémarré le système, après quoi le DNS a recommencé à fonctionner.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Goût de la victoire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai transmis mes résultats au client et envoyé le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">correctif du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> noyau </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">LKML</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Je suis satisfait: chaque pièce du puzzle s'est réunie en un seul ensemble, je peux expliquer précisément pourquoi nous avons observé ce que nous avons observé, et surtout, nous avons pu trouver une solution au problème en travaillant ensemble! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de reconnaître que le cas s'est avéré rare, et heureusement, de tels appels complexes sont rarement reçus de la part des utilisateurs de notre part.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr503096/index.html">Pourquoi les gestionnaires veulent-ils que les travailleurs recyclent?</a></li>
<li><a href="../fr503100/index.html">Tête Internet</a></li>
<li><a href="../fr503106/index.html">Recueil de découvertes non standard: généalogie des plantes prédatrices, champignon sur Twitter et gaz hilarant du guano</a></li>
<li><a href="../fr503108/index.html">Huit couleurs de l'arc-en-ciel: sur la couleur en termes de mathématiques</a></li>
<li><a href="../fr503110/index.html">Épidémie numérique: CoronaVirus vs CoViper</a></li>
<li><a href="../fr503118/index.html">David Yang - sur la non-invasion, les crises et la terre brûlée</a></li>
<li><a href="../fr503126/index.html">Likbez sur VPS: comment configurer le bureau à distance si vous êtes un utilisateur Win</a></li>
<li><a href="../fr503128/index.html">Comment intégrer ColorPicker dans JavaScript Gantt pour changer la couleur des tâches</a></li>
<li><a href="../fr503132/index.html">Parquet Apache haute vitesse en Python avec flèche Apache</a></li>
<li><a href="../fr503134/index.html">Management = équipe + produit. Nous dévoilons la formule de cette année: la plus utile sur les gens et pour les gens à DUMP 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>