<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ§Ô∏è üôçüèΩ üë∏üèæ Histoire de support DNS Cloud manquante de Google Cloud üë®üèº‚Äçüè´ ü§üüèΩ üö†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="D'un √©diteur de blog Google: vous √™tes-vous d√©j√† demand√© comment les ing√©nieurs de Google Cloud Technical Solutions (TSE) g√®rent vos appels au support...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Histoire de support DNS Cloud manquante de Google Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'un √©diteur de blog Google:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous √™tes-vous d√©j√† demand√© comment les ing√©nieurs de Google Cloud Technical Solutions (TSE) g√®rent vos appels au support technique? La responsabilit√© des ing√©nieurs du support technique de TSE est de d√©tecter et de r√©soudre les sources de probl√®mes identifi√©s par les utilisateurs. Certains de ces probl√®mes sont assez simples, mais parfois vous rencontrez un appel n√©cessitant l'attention de plusieurs ing√©nieurs √† la fois. Dans cet article, l'un des employ√©s de TSE nous parlera d'un probl√®me tr√®s d√©licat de sa pratique r√©cente - le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cas de paquets DNS manquants</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Au cours de cette histoire, nous verrons comment les ing√©nieurs ont r√©ussi √† r√©soudre la situation et quelles nouvelles choses ils ont apprises au cours de l'√©limination de l'erreur. Nous esp√©rons que cette histoire vous parlera non seulement d'un bogue profond√©ment enracin√©, mais qu'elle vous permettra √©galement de comprendre les processus qui se produisent lors de la soumission d'une demande de prise en charge de Google Cloud.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Le d√©pannage est √† la fois une science et un art. Tout commence par la construction d'une hypoth√®se sur la cause du comportement non standard du syst√®me, apr√®s quoi il est test√© pour sa r√©sistance. Cependant, avant de formuler une hypoth√®se, nous devons clairement identifier et formuler avec pr√©cision le probl√®me. Si la question vous semble trop vague, vous devez tout analyser correctement; c'est "l'art" du d√©pannage.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le contexte de Google Cloud, ces processus sont parfois compliqu√©s, car Google Cloud a du mal √† garantir la confidentialit√© de ses utilisateurs. </font><font style="vertical-align: inherit;">Pour cette raison, les ing√©nieurs TSE n'ont ni acc√®s √† l'√©dition de vos syst√®mes, ni la possibilit√© d'afficher les configurations aussi largement que les utilisateurs. </font><font style="vertical-align: inherit;">Par cons√©quent, pour tester l'une de nos hypoth√®ses, nous (ing√©nieurs) ne pouvons pas modifier rapidement le syst√®me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certains utilisateurs croient que nous allons tout r√©parer comme si les m√©caniciens du service automobile et nous envoyaient simplement l'identifiant de la machine virtuelle, alors qu'en r√©alit√© le processus se d√©roule dans un format de conversation: collecte d'informations, g√©n√©ration et confirmation (ou r√©futation) d'hypoth√®ses, et, finalement, r√©solution les probl√®mes reposent sur la communication avec le client.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Question √† l'examen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, nous avons une histoire avec une bonne fin. </font><font style="vertical-align: inherit;">L'une des raisons de la solution r√©ussie du cas propos√© est une description tr√®s d√©taill√©e et pr√©cise du probl√®me. </font><font style="vertical-align: inherit;">Ci-dessous vous pouvez voir une copie du premier ticket (√©dit√©, afin de cacher des informations confidentielles): </font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce message a beaucoup d'informations utiles pour nous:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VM sp√©cifi√©e</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le probl√®me est indiqu√© - DNS ne fonctionne pas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est indiqu√© o√π le probl√®me se manifeste - VM et conteneur</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les √©tapes que l'utilisateur a suivies pour identifier le probl√®me sont indiqu√©es.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel a √©t√© enregistr√© comme ¬´P1: Impact critique - Service inutilisable en production¬ª, ce qui signifie un suivi constant de la situation 24h / 24 et 7j / 7 selon le sch√©ma ¬´Follow the Sun¬ª (le lien peut √™tre lu plus en d√©tail sur les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">priorit√©s des appels des utilisateurs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), avec transmission par une √©quipe d'assistance technique √† l'autre √† chaque d√©calage de fuseau horaire. </font><font style="vertical-align: inherit;">En fait, au moment o√π le probl√®me a atteint notre √©quipe √† Zurich, elle a r√©ussi √† faire le tour du monde. </font><font style="vertical-align: inherit;">√Ä ce moment, l'utilisateur a pris des mesures pour r√©duire les cons√©quences, cependant, il avait peur d'une r√©p√©tition de la situation sur la production, car la raison principale n'√©tait toujours pas trouv√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au moment o√π le billet est arriv√© √† Zurich, nous disposions d√©j√† des informations suivantes:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenu </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenu </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le </font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier pcap </font><font style="vertical-align: inherit;">compil√© par la commande</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec ces donn√©es, nous √©tions pr√™ts √† entamer la phase ¬´d'investigation¬ª et de d√©pannage.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos premiers pas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous avons v√©rifi√© les journaux et l'√©tat du serveur de m√©tadonn√©es et nous nous sommes assur√©s qu'il fonctionne correctement. </font><font style="vertical-align: inherit;">Le serveur de m√©tadonn√©es r√©pond avec l'adresse IP 169.254.169.254 et, entre autres, est responsable du contr√¥le des noms de domaine. </font><font style="vertical-align: inherit;">Nous avons √©galement v√©rifi√© que le pare-feu fonctionne correctement avec VM et ne bloque pas les paquets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'√©tait un probl√®me √©trange: le test nmap a r√©fut√© notre hypoth√®se principale sur la perte de paquets UDP, nous avons donc mentalement d√©duit plusieurs autres options et fa√ßons de les v√©rifier:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les paquets disparaissent-ils s√©lectivement? </font><font style="vertical-align: inherit;">=&gt; V√©rifier les r√®gles iptables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU est-il</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trop petit </font><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">=&gt; V√©rifier la sortie</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le probl√®me affecte-t-il uniquement les paquets UDP ou TCP? </font><font style="vertical-align: inherit;">=&gt; √âloignez-vous</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les paquets de recherche g√©n√©r√©s sont-ils retourn√©s? </font><font style="vertical-align: inherit;">=&gt; √âloignez-vous</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les libdns fonctionnent-ils correctement? </font><font style="vertical-align: inherit;">=&gt; Partez </font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour v√©rifier le transfert de paquets dans les deux sens</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous d√©cidons de t√©l√©phoner √† l'utilisateur pour le d√©pannage en direct. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'appel, nous parvenons √† v√©rifier plusieurs choses:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s plusieurs v√©rifications, nous excluons les r√®gles iptables de la liste des raisons.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous v√©rifions les interfaces r√©seau et les tables de routage, et rev√©rifions le MTU</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous constatons que </font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(TCP) fonctionne comme il se doit, mais </font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UDP) ne fonctionne pas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s avoir </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ex√©cut√© pendant que cela fonctionne </font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous constatons que les paquets UDP sont retourn√©s</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous courons </font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et voyons comment creuser correctement les appels </font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cependant, le second est interrompu par un timeout</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, le changement est sur le point de se terminer et nous sommes oblig√©s de transf√©rer le probl√®me au fuseau horaire suivant. L'appel, cependant, a suscit√© l'int√©r√™t de notre √©quipe, et un coll√®gue sugg√®re de cr√©er le paquet DNS source avec le module Python scrapy.</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce fragment cr√©e un paquet DNS et envoie la demande au serveur de m√©tadonn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilisateur ex√©cute le code, la r√©ponse DNS est renvoy√©e et l'application le re√ßoit, ce qui confirme l'absence de probl√®me au niveau du r√©seau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s le prochain "tour du monde", l'appel revient √† notre √©quipe, et je le traduis compl√®tement sur moi-m√™me, pensant qu'il sera plus pratique pour l'utilisateur si l'appel cesse de tourner d'un endroit √† l'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En attendant, l'utilisateur s'engage √† fournir un instantan√© de l'image syst√®me. C'est une tr√®s bonne nouvelle: la possibilit√© de tester le syst√®me vous-m√™me acc√©l√®re consid√©rablement le d√©pannage, car vous n'avez plus besoin de demander √† l'utilisateur d'ex√©cuter des commandes, de m'envoyer des r√©sultats et de les analyser, je peux tout faire moi-m√™me!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des coll√®gues commencent √† m'envoyer un peu. </font><font style="vertical-align: inherit;">Au d√©jeuner, nous discutons de l'appel, mais personne n'a la moindre id√©e de ce qui se passe. </font><font style="vertical-align: inherit;">Heureusement, l'utilisateur lui-m√™me a d√©j√† pris des mesures d'att√©nuation et n'est pas press√©, nous avons donc le temps de pr√©parer le probl√®me. </font><font style="vertical-align: inherit;">Et puisque nous avons une image, nous pouvons effectuer tous les tests qui nous int√©ressent. </font><font style="vertical-align: inherit;">Bien!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revenir en arri√®re</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des questions les plus fr√©quemment pos√©es lors d'un entretien avec un ing√©nieur syst√®me est: "Que se passe-t-il lorsque vous envoyez une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requ√™te</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ping √† </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">www.google.com</font></a><font style="vertical-align: inherit;"> ?" </font><font style="vertical-align: inherit;">La question est chic, car le candidat doit √™tre d√©crit du shell √† l'espace utilisateur, au c≈ìur du syst√®me et plus loin au r√©seau. </font><font style="vertical-align: inherit;">Je souris: parfois les questions d'entrevue sont √©galement utiles dans la vraie vie ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je d√©cide d'appliquer cette question eychar au probl√®me actuel. </font><font style="vertical-align: inherit;">En gros, lorsque vous essayez de d√©terminer le nom DNS, les √©v√©nements suivants se produisent:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'application appelle la biblioth√®que syst√®me, par exemple libdns</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns v√©rifie la configuration syst√®me du serveur DNS qu'il doit utiliser (dans le diagramme, c'est 169.254.169.254, serveur de m√©tadonn√©es)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns utilise des appels syst√®me pour cr√©er un socket UDP (SOKET_DGRAM) et envoyer des paquets UDP avec une requ√™te DNS dans les deux sens</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä l'aide de l'interface sysctl, vous pouvez configurer la pile UDP au niveau du noyau</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le noyau interagit avec le mat√©riel pour transmettre des paquets sur le r√©seau via une interface r√©seau</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'hyperviseur intercepte et transmet le paquet au serveur de m√©tadonn√©es lorsqu'il entre en contact avec lui</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur de m√©tadonn√©es d√©termine le nom DNS par sa sorcellerie et renvoie la r√©ponse de la m√™me mani√®re</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permettez-moi de vous rappeler quelles hypoth√®ses nous avons d√©j√† r√©ussi √† consid√©rer: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypoth√®se: biblioth√®ques cass√©es</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: ex√©cutez strace dans le syst√®me, v√©rifiez que dig provoque les appels syst√®me corrects</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: les appels syst√®me corrects sont appel√©s</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: via Srapy pour v√©rifier si nous pouvons d√©terminer les noms contournant les biblioth√®ques syst√®me</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: nous pouvons</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 3: ex√©cutez rpm ‚ÄìV sur le package libdns et les fichiers de biblioth√®que md5sum</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: le code de la biblioth√®que est compl√®tement identique au code du syst√®me d'exploitation qui fonctionne</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 4: montez l'image du syst√®me racine de l'utilisateur sur la machine virtuelle sans ce comportement, ex√©cutez chroot, voyez si DNS fonctionne</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: DNS fonctionne correctement</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion bas√©e sur des tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> probl√®me n'est pas dans les biblioth√®ques </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypoth√®se: il y a une erreur dans les param√®tres DNS</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: v√©rifiez tcpdump et voyez si les paquets DNS sont envoy√©s et retourn√©s correctement apr√®s l'ex√©cution de dig</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: les paquets sont transmis correctement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: rev√©rifiez sur le serveur </font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: tout est correct</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion bas√©e sur les tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> probl√®me n'est pas dans l' </font><b><font style="vertical-align: inherit;">hypoth√®se de</font></b><font style="vertical-align: inherit;"> configuration DNS </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: le noyau est endommag√©</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test: installez un nouveau noyau, v√©rifiez la signature, red√©marrez</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: comportement similaire</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion bas√©e sur des tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> noyau n'est pas endommag√© </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypoth√®se: comportement incorrect du r√©seau utilisateur (ou de l'interface r√©seau de l'hyperviseur)</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: v√©rifiez les param√®tres du pare-feu</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: le pare-feu transmet les paquets DNS sur l'h√¥te et GCP</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: intercepter le trafic et suivre l'exactitude du transfert et du retour des requ√™tes DNS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: tcpdump accuse r√©ception des paquets de retour par l'h√¥te</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion bas√©e sur des tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> probl√®me n'est pas dans le r√©seau </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypoth√®se: le serveur de m√©tadonn√©es ne fonctionne pas</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 1: recherchez les anomalies dans les journaux du serveur de m√©tadonn√©es</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: il n'y a aucune anomalie dans les journaux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test 2: contournez le serveur de m√©tadonn√©es via </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat: l'autorisation est viol√©e m√™me sans utiliser de serveur de m√©tadonn√©es</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion bas√©e sur les </font><font style="vertical-align: inherit;">tests: le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> probl√®me n'est pas dans le serveur de m√©tadonn√©es </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bottom line:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous avons test√© tous les sous - </font><font style="vertical-align: inherit;">syst√®mes √† l' </font><font style="vertical-align: inherit;">exception des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">param√®tres d'ex√©cution!</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plonger dans les param√®tres d'ex√©cution du noyau</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour configurer le runtime du noyau, vous pouvez utiliser les options de ligne de commande (grub) ou l'interface sysctl. </font><font style="vertical-align: inherit;">J'ai regard√© dedans </font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et je pense seulement, j'ai trouv√© quelques param√®tres personnalis√©s. </font><font style="vertical-align: inherit;">Me sentant comme si j'avais saisi quelque chose, j'ai rejet√© tous les param√®tres non r√©seau ou non TCP, restant des param√®tres de la montagne </font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ensuite, je me suis tourn√© vers l'endroit o√π la machine virtuelle a les autorisations d'h√¥te et j'ai commenc√© √† appliquer l'un apr√®s l'autre, l'un apr√®s l'autre les param√®tres avec une machine virtuelle cass√©e, jusqu'√† ce que j'atteigne le criminel:</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La voici, une configuration qui brise le DNS! J'ai trouv√© un instrument du crime. Mais pourquoi cela se produit-il? J'avais encore besoin d'un motif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La d√©finition de la taille de base de la m√©moire tampon des paquets DNS s'effectue via </font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Une valeur typique varie quelque part au sein de 200 Ko, mais si votre serveur re√ßoit beaucoup de paquets DNS, vous pouvez augmenter la taille du tampon. Si le tampon est plein au moment o√π un nouveau paquet arrive, par exemple, parce que l'application ne le traite pas assez rapidement, alors vous commencerez √† perdre des paquets. Notre client a correctement augment√© la taille du tampon car il craignait la perte de donn√©es, car il utilisait l'application pour collecter des m√©triques via des paquets DNS. La valeur qu'il a d√©finie √©tait le maximum possible: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1 (si vous d√©finissez 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le noyau retournera ¬´ARGUMENT INVALIDE¬ª).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Du coup, j'ai compris pourquoi nmap et scapy fonctionnaient correctement: ils utilisaient des sockets raw! Les sockets brutes sont diff√©rentes des sockets ordinaires: elles fonctionnent en contournant les iptables, et elles ne sont pas mises en m√©moire tampon! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais pourquoi ¬´un tampon trop grand¬ª cause-t-il des probl√®mes? Cela ne fonctionne √©videmment pas comme pr√©vu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce stade, j'ai pu reproduire le probl√®me sur plusieurs c≈ìurs et plusieurs distributions. Le probl√®me s'est d√©j√† manifest√© dans le noyau 3.x et se manifeste d√©sormais √©galement dans le noyau 5.x. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En effet, au d√©marrage</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS a cess√© de fonctionner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai commenc√© √† rechercher des valeurs de travail via un simple algorithme de recherche binaire et j'ai constat√© que le syst√®me fonctionnait avec 2147481343, mais ce nombre √©tait un ensemble de nombres sans signification pour moi. J'ai invit√© le client √† essayer ce num√©ro, et il a r√©pondu que le syst√®me fonctionnait avec google.com, mais qu'il donnait toujours une erreur avec d'autres domaines, alors j'ai continu√© mon enqu√™te. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai install√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dropwatch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un outil que j'aurais d√ª utiliser auparavant: il montre o√π exactement le paquet se trouve dans le noyau. La fonction √©tait coupable </font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. J'ai t√©l√©charg√© les sources du noyau et ajout√© plusieurs </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonctions</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour suivre o√π le paquet se trouve sp√©cifiquement. J'ai rapidement trouv√© la bonne condition</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et pendant un certain temps le regarda simplement, car c'est alors que tout s'est finalement r√©uni dans une image enti√®re: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1, un nombre sans signification, un domaine inactif ... C'√©tait un morceau de code dans </font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque:</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a le type int</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est de type u16 (int 16 bits non sign√©) et stocke la taille du paquet</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est de type int et stocke la taille du tampon, qui par d√©finition est √©gale √† la valeur de </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä l' </font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">approche de 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , l'addition de la taille du paquet peut entra√Æner un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©bordement d'entier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et comme il s'agit d'un entier, sa valeur devient n√©gative, donc la condition devient vraie alors qu'elle devrait √™tre fausse (plus d'informations √† ce sujet peuvent √™tre trouv√©es par </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©f√©rence</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'erreur est corrig√©e de mani√®re triviale: en lan√ßant sur </font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">J'ai appliqu√© le correctif et red√©marr√© le syst√®me, apr√®s quoi le DNS a recommenc√© √† fonctionner.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go√ªt de la victoire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai transmis mes r√©sultats au client et envoy√© le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">correctif du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> noyau </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">LKML</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Je suis satisfait: chaque pi√®ce du puzzle s'est r√©unie en un seul ensemble, je peux expliquer pr√©cis√©ment pourquoi nous avons observ√© ce que nous avons observ√©, et surtout, nous avons pu trouver une solution au probl√®me en travaillant ensemble! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de reconna√Ætre que le cas s'est av√©r√© rare, et heureusement, de tels appels complexes sont rarement re√ßus de la part des utilisateurs de notre part.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr503096/index.html">Pourquoi les gestionnaires veulent-ils que les travailleurs recyclent?</a></li>
<li><a href="../fr503100/index.html">T√™te Internet</a></li>
<li><a href="../fr503106/index.html">Recueil de d√©couvertes non standard: g√©n√©alogie des plantes pr√©datrices, champignon sur Twitter et gaz hilarant du guano</a></li>
<li><a href="../fr503108/index.html">Huit couleurs de l'arc-en-ciel: sur la couleur en termes de math√©matiques</a></li>
<li><a href="../fr503110/index.html">√âpid√©mie num√©rique: CoronaVirus vs CoViper</a></li>
<li><a href="../fr503118/index.html">David Yang - sur la non-invasion, les crises et la terre br√ªl√©e</a></li>
<li><a href="../fr503126/index.html">Likbez sur VPS: comment configurer le bureau √† distance si vous √™tes un utilisateur Win</a></li>
<li><a href="../fr503128/index.html">Comment int√©grer ColorPicker dans JavaScript Gantt pour changer la couleur des t√¢ches</a></li>
<li><a href="../fr503132/index.html">Parquet Apache haute vitesse en Python avec fl√®che Apache</a></li>
<li><a href="../fr503134/index.html">Management = √©quipe + produit. Nous d√©voilons la formule de cette ann√©e: la plus utile sur les gens et pour les gens √† DUMP 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>