<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚲 ⌛️ 🙅🏼 マルウェアがVisual Basicでサンドボックスを回避する方法 🍿 👨‍👩‍👦‍👦 🏴󠁧󠁢󠁷󠁬󠁳󠁿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="JSOC CERTでは毎日、お客様のAntiAPTソリューションの一部として機能するさまざまなサンドボックスからのイベントに遭遇し、Webおよび電子メールトラフィックからの何千ものファイルを通過させています。注目に値するのは、開発中の最新のサンドボックスシステムは、カーネルモードでのシステムコールや...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>マルウェアがVisual Basicでサンドボックスを回避する方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/473086/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSOC CERTでは毎日、お客様のAntiAPTソリューションの一部として機能するさまざまなサンドボックスからのイベントに遭遇し、Webおよび電子メールトラフィックからの何千ものファイルを通過させています。注目に値するのは、開発中の最新のサンドボックスシステムは、カーネルモードでのシステムコールやユーザーモードでのAPI関数を単にインターセプトするだけではないということです。彼らはますます独自のハイパーバイザー、ユーザーアクティビティをエミュレートするシステム、動的インストルメンテーション、コードのセクションに対するハッシュとクラスタリング、コードカバレッジの分析などを使用しています。このようなさまざまなテクノロジーは、ファイルがサンドボックスで機能せず、その「本当の顔」を示さない場合、これはおそらくAPTまたは仮想環境を検出する革新的なテクノロジーであり、IBコミュニティはまだ認識していません。だが…</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sc/cl/os/scclosmhrxygm1sxytg94as3z_i.jpeg"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
商用サンドボックスの動作の内部機能がわからないため、場合によっては、二重チェックを行います-テストに合格したサンプルを手動で分析します。最近、いくつかの商用サンドボックス（客観的な理由により、どのサンドボックスであるかはわかりません）が動的分析中に特定の悪意のあるファイルを検出しなかったことに何度か遭遇し、静的アナライザーもサイレントである場合、ファイルは完全にスキップされました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サンドボックススキャンは、ポニー、ロキ、ホークアイなどのよく知られたマルウェアファミリをバイパスすることに成功しました。一つだけがそれらを結びつけました-それらはVisual Basicで書かれたパッカーによってカバーされました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのHPEファミリは長い間新しいものではないため、「肯定的な」サンドボックスの評決は非常に憂鬱です。したがって、このパッカーの操作の一般的な原理と、長期にわたって私たちが行った観察について説明することにしました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッカーの作業の一般的なスキームは、条件付きで4つの段階に分けられ、下の図に示されています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/c9/of/fkc9of6pras7-cd55luw1l1mpai.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悪意のあるファイルのエントリポイントは、Visual Basicアプリケーションでは一般的です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/ia/he/vjiaheueiyapa2swzf8_cqrwzka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このパッカーのさまざまなバリアントに出会い、VBラッパーコードは頻繁に変更されましたが、実行されたタスクは同じでした：ステージ1コードへのコントロールの転送。以前のサンプルでは、​​コントロールはEnum *クラスのAPI関数（たとえば、EnumWindows、EnumCalendarInfoなど）を使用して転送されました。 e）コードのアドレスステージ1がパラメーターとして示されている。</font><font style="vertical-align: inherit;">最近、コントロールが直接転送されることが確認されています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージ1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントロールはコードステージ1を受け取ります。このコードは暗号化されていませんが、難読化されています。</font><font style="vertical-align: inherit;">難読化の方法はサンプルごとに異なりますが、一般的な操作アルゴリズムは変わりません。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージ2コードのデコードに必要なキーを生成する、多数の（ガベージを含む）命令を含むサイクル。</font><font style="vertical-align: inherit;">このコードフラグメントの特徴は、スリープ関数がないことですが、反復回数が多いため、実行に平均1〜2分かかります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">復号化（通常のXOR）とステージ2コードへの制御の転送。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下のスクリーンショットは、使用される難読化方法の例を示しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/--/p-/xl/--p-xlue_skm9loofz_wj3tmeic.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2段階</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ステージ2のコードの主なタスクは、環境をチェックし、デバッグ防止メソッドを実装することです。</font><font style="vertical-align: inherit;">コードの一部のセクションは暗号化され（実行前に復号化され、その後同じXORアルゴリズムで暗号化されて戻される）、署名による検出が困難になります。</font><font style="vertical-align: inherit;">復号化後、ステージ2のコードを手動分析で認識できる特徴的な特徴が表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eb/n8/oq/ebn8oqw9vqcysrl-c98pdfdrdjq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェックのリストは非常に大きく、パッカーのバージョンによって異なるため、スクリーンショットを使用してすべてのバージョンで見つかったいくつかのメソッドを示し、最後にリスト全体を表にリストします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1）GetTickCount +スリープ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在のタイムスタンプが取得され、Sleepが2秒間呼び出され、その後すぐに別のタイムスタンプが取得されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、マーク間の差がチェックされます（実際に2秒が経過したかどうか）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mp/ip/pj/mpippjhsogyg_uvk0eikkuehm_w.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2）SetErrorMode</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SetErrorMode API呼び出しの正しい操作を確認します。</font><font style="vertical-align: inherit;">この関数は、パラメーター0x800と0x0を使用して続けて2回呼び出されます。その後、2番目の呼び出しの結果がチェックされます。これは0x800に等しい必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gp/kr/vx/gpkrvxff7l4irukw4oqifs6ai4a.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3）SetLastError</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、SetLastErrorがパラメーター0x5で呼び出され、その後、TEBのLastエラーコードの値が正しく設定されている（つまり、0x5である）かどうかが確認されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3k/am/vh/3kamvhsb_z6nw8tlchtlcuhxa0q.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4）カーソルの動きを確認する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは、マウスが動くのを待つ無限ループに入ります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/aq/1w/wo/aq1wwopzjhbmihs8mxnmmkcxoma.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5）DbgBreakPointおよびDbgUiRemoteBreakin </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの関数は、デバッガーがプロセスに接続できないように変更されています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/aw/we/qd/awweqdnasj4ztgfjk1bdv-lcfw4.jpeg"><br>
<table border="1">
<tbody>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 装置</font></font><br>
 </p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> コメント</font></font><br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetTickCount +スリープ</font></font><br>
 </p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> タイムスタンプの確認</font></font><br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SetErrorMode</font></font><br>
 </p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 関数のチェックが正しく機能している</font></font><br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SetLastError</font></font><br>
 </p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 関数のチェックが正しく機能している</font></font><br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetCursorPos</font></font><br>
 </p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> カーソルの動きを確認する</font></font><br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DBブレークポイント</font></font><br>
 </p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> デバッガのアタッチを防ぐ機能の変更</font></font><br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DbgUiRemoteBreakin</font></font><br>
 </p><br>
 </td>
<td> <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> デバッガのアタッチを防ぐ機能の変更</font></font><br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> Hook Deletion<br>
 </p><br>
 </td>
<td> <p>   5    ntdll.dll  ,    <br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> NtSetInformationThread<br>
 </p><br>
 </td>
<td> <p>  0x11 (ThreadHideFromDebugger)<br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> GetThreadContext + check DR<br>
 </p><br>
 </td>
<td> <p>    DR0-DR3, DR6, DR7<br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> Check breakpoints<br>
 </p><br>
 </td>
<td> <p>   INT3 (0xCC), int 3 (0xCD 0x03)  ud2 (0x0F 0x0B)    <br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> cpuid (EAX=0x0)<br>
 </p><br>
 </td>
<td> <p>   EAX, ECX, EDX<br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> cpuid (EAX=0x40000000)<br>
 </p><br>
 </td>
<td> <p>   EAX, ECX, EDX<br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> cpuid (EAX=0x1)<br>
 </p><br>
 </td>
<td> <p>  31-  ECX<br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> PEB (BeingDebugged)<br>
 </p><br>
 </td>
<td> <p>   0x1<br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> PEB (NtGlobalFlag)<br>
 </p><br>
 </td>
<td> <p>   0x70<br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> NtQueryInformationProcess<br>
 </p><br>
 </td>
<td> <p>    ProcessDebugPort (0x7), ProcessDebugFlags (0x1F), ProcessDebugObjectHandle (0x1E)<br>
 </p><br>
 </td>
</tr>
<tr>
<td> <p> Process Name Check<br>
 </p><br>
 </td>
<td> <p>   «sample», «sandbox», «virus», «malware», «self.»<br>
 </p><br>
 </td>
</tr>
</tbody>
</table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ステージ2のすべての手法が完了すると、コマンドラインが特殊な形式に準拠しているかどうかがチェックされます。</font><font style="vertical-align: inherit;">チェックが失敗した場合、次のアクションが実行されます</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。1）CREATE_SUSPENDEDフラグを指定してCreateProcess関数が呼び出され、現在のプロセスが再開されます。</font><font style="vertical-align: inherit;">この場合、コマンドラインには必要な形式があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 2）GetContextThread関数とSetContextThread関数を使用して、エントリポイントをステージ1コードにある新しいものに変更します</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 3）手順1と2を繰り返します（長いサイクルとすべてのチェックを含む）。</font><font style="vertical-align: inherit;">今回は、コマンドラインチェックが成功し、プロセスは次のステップに進みます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3段階</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階で、メインウイルスの本体が復号化され、現在のプロセスに対してプロセスホローイングテクニックが実行されます。その後、メインウイルスのエントリポイントに制御が移ります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">学んだ教訓</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、またはこの場合のそのサンドボックスで問題が発生する原因を正確に述べることはできませんが、マルウェアによって記事で説明されている手法を使用する機能は、ベンダーによって長い間提供されてきたと思います。問題は、パッカーの作業の最初の段階での長い時間の遅延にのみあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最新のサンドボックスは大部分がAPT攻撃に対する保護システムの一部として位置付けられているという事実にもかかわらず、私たちの観察は、コミュニティによく知られている悪意のある家族でさえ、羨むべき不変性でインフラストラクチャに侵入していることを示唆しています。</font><font style="vertical-align: inherit;">サンドボックスをバイパスしたサンプルの武器庫にいくつかのアンチウイルスバイパステクニックがないという保証はないため、この一連の保護ソリューションだけに依存することはできません。</font><font style="vertical-align: inherit;">このような場合、エンドホストからの情報セキュリティイベントを含む適切に構築された監視プロセスにより、タイムリーな応答が保証され、潜在的な損傷を最小限に抑えることができます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja473072/index.html">Gazpromneftが企業クライアントのデジタルパスを作成する方法</a></li>
<li><a href="../ja473074/index.html">APSとは何か、なぜそれが「私たちが望む方法で生産計画を立てない」のか...</a></li>
<li><a href="../ja473078/index.html">microconfig.ioでマイクロサービス構成を簡単に管理</a></li>
<li><a href="../ja473082/index.html">マイクロサービスの作成方法と、迅速に作成しない理由</a></li>
<li><a href="../ja473084/index.html">「Ivan」はチャットボットの専門職です。または仮想アシスタントを使った創造的な実験</a></li>
<li><a href="../ja473088/index.html">下層土利用者による石油と金市場の流動性の神話</a></li>
<li><a href="../ja473090/index.html">PocketBook 632および632 Aquaのレビュー-E Ink搭載の小型旗艦6インチリーダー</a></li>
<li><a href="../ja473092/index.html">HabrによるAMA、＃13：ユーザーと企業にとって重要なニュース</a></li>
<li><a href="../ja473094/index.html">すばらしい開発者の物語、パート5：宇宙の秘密</a></li>
<li><a href="../ja473096/index.html">高度なデータ構造。パート1：方向性非循環グラフ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>