<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå∫ üë®üèº‚Äçüåæ üë®üèø‚Äçüè≠ Playstation Doom Polygons üíµ üòå üêù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sony PlayStation
  
 The story of the PlayStation began in 1988 when Nintendo and Sony began working together on an optional CD-ROM reader for the SNE...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Playstation Doom Polygons</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494398/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98b/897/f95/98b897f955dbdf31ff724bbe1a1841f4.png" alt="image"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sony PlayStation</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8f7/4aa/015/8f74aa015b0e95be13aac769990538a5.svg"></div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The story of the PlayStation began in 1988 when Nintendo and Sony began working together on an optional CD-ROM reader for the SNES console. Under the terms of the agreement, Sony was able to independently develop games for this platform and retained control of the Super Disc format - two unusual concessions by Nintendo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The project developed before the CES '91 exhibition, at which Sony announced a collaboration on Play Station. The next day, at the same exhibition, Nintendo, to the surprise of Sony, announced that it had instead entered into a partnership agreement with Philips (on much more favorable terms). The loyal and publicly humiliated Sony tried to appeal to the Sega board of directors, which immediately rejected the idea. In an interview with 2013, SEGA CEO Tom Kalinske recalled the decision of the council.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúThis is a stupid idea, Sony does not know how to develop equipment. </font><font style="vertical-align: inherit;">They do not know how to write software. </font><font style="vertical-align: inherit;">Why do we mess with them? ‚Äù </font><font style="vertical-align: inherit;">- SEGA Board of Directors</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And they were not mistaken, Sony really had little experience in working with games. </font><font style="vertical-align: inherit;">She almost did not show interest in them, with the exception of the initiative of one person - Ken Kutaragi. </font><font style="vertical-align: inherit;">From the moment he saw his daughter play at the Nintendo Famicom, Ken has been convincing Sony that he needs to enter this market. </font><font style="vertical-align: inherit;">Despite the recommendations of Sony vice presidents, he even developed for Nintendo the audio chip (SPC700) used in SNES.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most Sony executives considered this a risky bet, but Kutaragi found support in the person of Sony CEO Norio Oga. In June 1992, Ken was allowed to start creating a gaming system from scratch. To calm the board of directors, the ‚Äúfather of the PlayStation,‚Äù as they later called him, was transferred to the financially independent parent company Sony Music, and he began work on what would eventually become the ‚ÄúPlayStation‚Äù (already without a space in the name).</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, developers could not decide whether the architecture should focus on sprite 2D graphics or polygon 3D graphics. </font><font style="vertical-align: inherit;">However, the success of the Virtua Fighter game released in October 1993 by Sega on Japanese arcade machines destroyed all doubts: the PSX will follow the 3D path. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The culmination of the project came two years later, when Sony Computer Entertainment was created on December 3, 1994 and the console was released in Japan. </font><font style="vertical-align: inherit;">It gained instant success and was sold on the first day with a circulation of 100 thousand devices, 2 million devices after six months, and 102 million devices throughout their life.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b1/727/175/6b1727175f25b80b4309c920c0e23115.webp"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sony PSX (PS1, PlayStation). </font><font style="vertical-align: inherit;">Photo: Wikipedia</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/60b/97c/da3/60b97cda359e2e5c27a9028cc13aa22d.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The heart of the machine is the MIPS 32-bit RISC R3000A processor with a frequency of 33.8688 MHz </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[3]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in combination with 2 MB DRAM. It is noteworthy that this chip also has a Motion Decoder (MDEC), which provides video playback with a resolution of 320x240 at a frequency of 30 fps. Next to MDEC, we see the Geometry Transform Engine (GTE) coprocessor, used to perform fast fixed-point mathematical operations on vectors and matrices. The system as a whole is unable to work with floating point numbers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The GPU is a ‚Äúblack box‚Äù controlled by the central processor using ‚Äúcommands‚Äù. It has 1 MB VRAM, unavailable to the CPU. In many ways, his work resembles the work of the wonderful Immediate mode OpenGL: he draws textured polygons that can be ‚Äúshaded‚Äù using vertex colors. The graphics pipeline is fixed and cannot be programmed. There is no Z buffer (depth buffer). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The sound processing unit Sound Processing Unit (SPU), like the GPU, is a black box. It can process 24 channels, has 512 KB of SRAM for storing audio (in ADPCM format) and is capable of mixing CD-ROM audio tracks with its audio channels. The abbreviation SRAM does not mean ‚ÄúStatic RAM‚Äù, but ‚ÄúSound RAM‚Äù.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most daring decision of Sony engineers was the choice of data carrier. </font><font style="vertical-align: inherit;">They chose not cartridges, but a dual-speed CD-ROM module, which reduced the cost of games and significantly increased the available volume (up to about 650 MB). </font><font style="vertical-align: inherit;">The disadvantages are the low transfer rate (300 KB / s) and the monstrously large head installation time (300 ms). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is no blitter in the console. </font><font style="vertical-align: inherit;">The programming model of the machine was that the developers did not touch the "bare" iron. </font><font style="vertical-align: inherit;">However, there is a DMA controller for transmitting data from CD / DRAM to VRAM / SRAM.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video system</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the fact that the video system supports 24-bit color, very few games have used it (with the exception of Heart Of Darkness backgrounds </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[4]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">In practice, it can be said with good conscience that most games used 16-bit colors with a 1-bit mask.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><img width="300" height="353" src="https://habrastorage.org/getpro/habr/post_images/5ff/164/4dd/5ff1644dd75bfbad9af9b1d61190ebe1.webp"><br>
</td>
<td><img width="300" height="353" src="https://habrastorage.org/getpro/habr/post_images/5ef/828/585/5ef828585512c3315eef5d72087f27b2.png"></td>
</tr>
</tbody></table></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PSX color space with a depth of 15 bits per pixel</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A stunning feature of the video system is the organization of VRAM, which is completely dependent on the developer. 1 MB VRAM is considered an array of 1024 x 512 x 16 bits that could be freely used. The application of double or triple buffering is performed in a trivial way, because the area is simply enough to reserve, draw and transfer to the output system. Textures are also in VRAM, next to the frame buffers. To write to the frame buffer, GPU commands for rendering textured triangles / quadrangles are launched. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Textures can have various formats. There are two direct sources of 16-bit and 24-bit colors, as well as sources based on a palette called the Color Look Up Table (CLUT). 8-bit and 4-bit CLUTs are supported.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In terms of resolution, the console was limited to NTSC and PAL television standards. </font><font style="vertical-align: inherit;">For the US and Japan markets, the developer could choose a horizontal resolution of 256, 320, 384, 512, or 640 pixels. </font><font style="vertical-align: inherit;">The vertical resolution was either 240 pixels (when skipping every second raster line), or 480 pixels when alternating. </font><font style="vertical-align: inherit;">Both vertical modes operated at a frequency of 60 Hz. </font><font style="vertical-align: inherit;">The only difference between NTSC and PAL was an increased vertical resolution (256/512 instead of 240/480) and a lower refresh rate (50 Hz).</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTSC mode (60Hz) PAL (50Hz) Note</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
=================================================== ========</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 256 x 240 256 x 256 Non-interlaced</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 320 x 240 320 x 256 Non-interlaced</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 512 x 240 512 x 256 Non-interlaced</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 640 x 240 640 x 256 Non-interlaced</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4 256 x 480 256 x 512 Interleaved</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5 320 x 480 320 x 512 Interleaved</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6 512 x 480 512 x 512 Interleaved</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7 640 x 480 640 x 512 Interleaved</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8 384 x 240 384 x 256 Non-interlaced</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
9 384 x 480 384 x 512 Interleaved</font></font></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pay attention to the modes with a horizontal resolution of 384 pixels (8 and 9), which, judging by their id, were added later.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DOOM on PSX</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DOOM was ported to PSX by Williams Entertainment with support from id Software. </font><font style="vertical-align: inherit;">It took a team of five people a little less than a year </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[5] </font></font></sup><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[6]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to port the engine, change resources and modify the game so that everything worked ‚Äúonly‚Äù on 3.5 MB of RAM.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúThe graphics have been degraded: textures are reduced in size, sprites, monsters and weapons too. </font><font style="vertical-align: inherit;">[...] Sometimes we cut animation frames. " </font><font style="vertical-align: inherit;">- Harry Tisley</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The finished result was released on November 16, 1995. </font><font style="vertical-align: inherit;">It is considered the best console port of the game, and some aspects even surpass the PC version due to color tops and CD-quality music.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúSo far, this is the best DOOM!‚Äù </font><font style="vertical-align: inherit;">- John Romero</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Study plan</font></font></h2><br>
<div style="text-align:center;"><img width="290" height="301" src="https://habrastorage.org/getpro/habr/post_images/9de/26d/ce5/9de26dce56307a9b22370aa22c0c93e9.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the nature of development, the DOOM structure is based on a kernel that uses six subsystems for I / O. Most of the time I studied the three parts that I found most interesting, namely the CD-ROM-based file system, SPU-based audio, and GPU-based video, because they are unique to the PSX architecture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The DOOM source code for the PSX was never published, but it turned out to be no problem at all. Available information is enough.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first source is the awesome PSY-Q SDK, which was the ‚Äúofficial‚Äù tool used by PSX developers of the time. There is a lot of documentation on it, presented as a set of PDF files. Such an abundance of information only confirms all the good that I heard about the PSX's friendliness to developers. The library (i.e., libcd, libds) developed by Psygnosis is also well documented. It was very nice to see clear explanations, especially compared to the almost complete lack of information about other consoles (yes, I'm talking about SNES). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another source of information is the many external tools available today. ISOBuster allowed me to open the contents of the CD. PSound helped scan LCD files. The stunning ability of the no $ PSX emulator to trace GPU and SPU commands has become real gold.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But perhaps I was most impressed with the huge love of DOOM for PSX from the fan community. </font><font style="vertical-align: inherit;">A complete reverse engineering of the game was performed. </font><font style="vertical-align: inherit;">PSXDOOM-RE stands out especially because it is a C codebase that can be compiled using the PSY-Q SDK into a full-fledged PSX game. </font><font style="vertical-align: inherit;">The code is highly reliable because it was obtained by rewriting each function of the machine code in C.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The amazing world of CDs</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before starting to study the implementation of the file system, I took a short excursion to better understand the wonderful world of CDs.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For 20 years, from 1980 to 2000, several volumes of specifications have been released that reveal this topic. Together, they are called "Rainbow Books." The first book in the series, ‚ÄúRed Book,‚Äù contains specifications for an audio compact disk (CD). The ‚ÄúYellow Book‚Äù is a complement to the ‚ÄúRed Book‚Äù, it adds data specifications for CD-ROM and ISO-9600. The Orange Book has added specifications for CD-DA, CD-R (Recordable) and CR-WR (Rewritable). The White Book is dedicated to Video-CD (VCD). The Green Book talks about CD-Interactive (CD-I). The Blue Book presents Enhanced-CD (ECD) data for multimedia support. The Scarlet Book is dedicated to Super Audio (SACD), which adds high definition audio. The Purple Book lists the Double Density CD (DDCD) specification, which has increased disk capacity from 650 MB to 1.3 GB. Finally,Cyan Book details 9660 file system specifications</font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[7]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/52b/2f6/c60/52b2f6c605024780dcf141bcaf02a6a8.svg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rainbow Books contains everything we know about the CD. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an absolute minimum, we need to understand that PSX CDs usually consist of sectors, each of which contains 2048 bytes of data. </font><font style="vertical-align: inherit;">Sectors are grouped into tracks (which may be data or sound). </font><font style="vertical-align: inherit;">The tracks are grouped in session. </font><font style="vertical-align: inherit;">Information of data tracks can be arranged using the standard ISO-9660 file system, however, the game can also have hardcoded sector addresses.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inside the DOOM game CD</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/88b/62c/636/88b62c636572fe1c4617445525220c58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you look inside the CD-ROM using ISOBuster, you can see that DOOM consists of one session containing eight tracks </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[8]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Seven of them are CD-quality sound tracks played between missions and in the final scene. </font><font style="vertical-align: inherit;">The final track (# 7) even uses digitized demon voices. </font><font style="vertical-align: inherit;">Track number 6 is especially noteworthy because it seems to have been taken straight from the rave party. </font><font style="vertical-align: inherit;">It turns out that this is music played on the super-secret card 59 ‚ÄúClub DOOM‚Äù (a secret card accessible only from a secret card) </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[9]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Let me let you appreciate her insanity. </font><font style="vertical-align: inherit;">Before starting, check the sound volume.</font></font><br>
<br>
<div class="oembed"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://fabiensanglard.net/doom_psx/Track06.mp3</font></font></a></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The remaining track (number 1) is ISO-9660, which contains the game engine and most resources. </font><font style="vertical-align: inherit;">After exploring the many DOOM ports, I naively expected an engine called DOOM.EXE, a PSXDOOM.WAD resource file, and possibly a manifest. </font><font style="vertical-align: inherit;">I was very mistaken. </font><font style="vertical-align: inherit;">287 files </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[10] </font></font></sup><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[11] were</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> found on the track </font><font style="vertical-align: inherit;">, including 60 .WAD, 120 .IMG and countless .LCD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data is ordered by level (five files per card).</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File Name Description</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
=================================================== =====</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MAPDIR0 / MAP01.WAD Standard Geometry (BSP / Reject / ...)</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MAPDIR0 / MAPTEX01.IMG Textures of planes / walls</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MAPDIR0 / MAPSPR01.IMG All sprites created by THINGS</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MUSIC / MUSLEV1.LCD Playable Music</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNDMAPS1 / MAP01.LCD All sounds made by THINGS</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When asked why everything was arranged in a new way, Crash Bandicoot developer Andy Gavin partially answered in an interview with Ars Technica. </font><font style="vertical-align: inherit;">[ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Habr√©]</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúIt takes about 1/3 of a second to move the head to any point on the CD.‚Äù</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the fact that the head positioning speed was close to 300 ms (which is confirmed by the PSY-Q documentation </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[12]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), the developers at Williams Entertainment could not save the clear architecture of the DOOM engine, which stored all the resources in one file (for example, DOOM.WAD) and downloaded them on request. On the PSX, this would lead to a terrible frame rate. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The developers solved the problem by throwing a seemingly endless amount of bytes on the CD. All the resources necessary for the level were stored in five files containing the geometry of the map, texture. sprites, sound effects and music. This is very expensive, but it eliminated the need to access the CD during the game process. </font></font><br>
<br>
<b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interesting fact:</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the list of files on the data track there is a file called PSXDOOM.WAD (4 806 088 bytes), but it is used only for loading palettes and several menu images. </font><font style="vertical-align: inherit;">Probably more actively used in the development process. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Take the first map as an example: the total amount of downloaded data has been reduced from 4 MB to 900 KB.</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File Name Size (in bytes)  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
=====================================  	</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MAPDIR0 / MAP01.WAD 28 196</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MAPDIR0 / MAPTEX01.IMG 90 744</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MAPDIR0 / MAPSPR01.IMG 590 344</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MUSIC / MUSLEV1.LCD 61 232</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNDMAPS1 / MAP01.LCD 143 632</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
=====================================</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Total: 914,148</font></font></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Knowing that resources occupy 914 KB, you might think that there was a lot of unused DRAM left. But you need to remember that it also had to fit an executable file of 428 KB, as well as a stack that changes at run time. In fact, only about 1 MB of DRAM was available at runtime. </font></font><br>
<br>
<b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An interesting fact:</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> while examining the source code of PSXDOOM-RE, I found the P_LoadBlocks function, which tries to read from CD up to four times </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[13]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , after which it surrenders. This is one of the pleasures of working with easily scratched media.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did not expect the installation time of the CD-ROM head to affect the game architecture so much. Some games, like Crash Bandicoot, were created from scratch with a page system for streaming data from a CD at runtime. In the case of DOOM, the engine was not capable of this. The CD is not used during the game, with the exception of one particular song (yes, from the Club DOOM level). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The id Software guys have never been a fan of the trade-off between capacity and speed that CD-ROMs offered.</font></font><br>
<br>
<blockquote>¬´    - .     ,       CD.  - ,     Crash 'n Burn ‚Äî    ?    .  ,     CD      ,  3DO   .   -   CD- DOOM,        ‚Äû  DOOM‚Äú.           ,     .       .<br>
<br>
           ,     CD.       ¬ª. ‚Äî   (ATARI EXPLORER ONLINE, 22  1994 )</blockquote><br>
<b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An interesting fact:</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> events inside the DOOM game were triggered using "stretch marks." </font><font style="vertical-align: inherit;">When crossing a line with a special property, a special function was called. </font><font style="vertical-align: inherit;">In the "legacy" version of the engine there was no property that allowed you to play songs. </font><font style="vertical-align: inherit;">To play Club DOOM, a special linedef action was created (number 142)</font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [14]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It's amazing how much extra effort it took to create this level. </font><font style="vertical-align: inherit;">Probably the developers really liked to have fun on the raves.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Case of the Missing Archvile</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/daf/8fb/db9/daf8fbdb944deb32c8b6f398615a16ef.webp"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conducting research for my Game Engine Black Book, I couldn‚Äôt fully figure out this phrase by designer Harry Teesley:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúArchvile had twice as many frames of animation than any other monster, and we could not cram it into the PSX. </font><font style="vertical-align: inherit;">Neither his attack nor the resurrection effect could be lost. </font><font style="vertical-align: inherit;">He was too big. " </font><font style="vertical-align: inherit;">- Harry Tisley (designer) in an interview with doomworld.com</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was obvious that the problem was not the 650 megabyte capacity of the CD, but I did not understand what was the limiting factor - DRAM or VRAM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having figured out the limitations of the CD-ROM, I realized that the problem was not in storing the sprite on a CD or even transferring it from DRAM to VRAM. </font><font style="vertical-align: inherit;">The problem is to fit everything into DRAM. </font></font><br>
<br>
<b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interesting fact:</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ArchVile is completely removed from the source code of PSXDOOM-RE. </font><font style="vertical-align: inherit;">Even his #DEFINE is commented out </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[15]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CC_ZOMBIE  <span class="hljs-meta-string">"Zombieman"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CC_SHOTGUN  <span class="hljs-meta-string">"Shotgun Guy"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CC_HEAVY  <span class="hljs-meta-string">"Heavy Weapon Dude"</span></span><font></font>
...<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CC_HELL   <span class="hljs-meta-string">"Hell Knight"</span></span>
<span class="hljs-comment">//#define CC_ARCH "Arch-Vile"</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CC_SPIDER <span class="hljs-meta-string">"The Spider Mastermind"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CC_CYBER  <span class="hljs-meta-string">"The Cyberdemon"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CC_HERO   <span class="hljs-meta-string">"Our Hero"</span></span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPU Programming</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SPU chip only understands one format, namely ADPCM. </font><font style="vertical-align: inherit;">It is capable of mixing up to 24 channels (including the CD audio track) and has powerful audio manipulation functions.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To tame this beast, the DOOM PSX uses the libWESS library (Williams Entertainment Sound System), written by sound engineer Scott Patterson. </font><font style="vertical-align: inherit;">The library is quite powerful, it is able to recreate the MiDI system, in which a heavy bank of notes (called sound font) is controlled by a musical score that takes up little space. </font><font style="vertical-align: inherit;">It can also manipulate in real-time sound attributes such as volume, tone, note speed, and ADSR functions (Attack, Decay, Sustain, and Release). </font><font style="vertical-align: inherit;">All music played during gameplay is generated using libWESS. </font><font style="vertical-align: inherit;">With one exception, you guessed it, this is Club DOOM, which is played from CD track number 6.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WESS uses two proprietary file formats. </font><font style="vertical-align: inherit;">These are .WMD files containing music scores and sound effects, and .LCD files, which are PSX VAG format (no title) and contain ADPCM samples. </font><font style="vertical-align: inherit;">When DOOM starts, the libWESS library loads all sound effects (SFX, 89 pieces) and musical scores (19 pieces) stored in a small (55 KB) file called DOOMSND.WMD. </font><font style="vertical-align: inherit;">She also loads into the SRAM ‚Äúalways used‚Äù samples published by the character, doors, etc.</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MUSIC / DOOMSFX.LCD -&gt; SRAM</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MUSIC / DOOMSND.WMD -&gt; DRAM</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After loading the map, libWESS opens MUSIC / MUSLEV% .LCD, which contains the ADPCM samples used in the music of this card, and SNDMAPS% / MAP %%. LCD, which contains the ADPCM samples needed for enemies at this level. </font><font style="vertical-align: inherit;">All ADPCM samples are loaded directly into SRAM and do not take up space in DRAM.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DOOM on PSX: GPU</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the area of ‚Äã‚Äãvideo generation, Williams Entertainment needed to solve two problems: a small amount of VRAM (we will come back to this later) and the lack of correct texture mapping taking into account the perspective.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúAaron Siler and I worked on versions for the Nintendo 64 (this game was quite different) and for the Playstation. </font><font style="vertical-align: inherit;">These were the first versions that were not written on bare metal, because both Sony and Nintendo forced developers (at least third-party ones) to write APIs and did not give them documentation on hardware registers. </font><font style="vertical-align: inherit;">At first, the SGI culture particularly limited developers, but gradually Nintendo loosened its grip.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A funny story about developing a version for the Playstation: Aaron and I started with a different engine architecture, which rendered the world triangles because the console provided them with full hardware acceleration. </font><font style="vertical-align: inherit;">In the case of N64, this worked perfectly, because it had perspective-correct rendering with subpixel accuracy (the result of the influence of SGI), but on the Playstation affine texture mapping was performed with integer coordinates, so the large triangles of the walls and floor looked AWESOME. ‚Äù </font><font style="vertical-align: inherit;">- John Carmack (Game Engine Black Book: DOOM)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand how ‚Äúterrible‚Äù it looked, below I showed three walls rendered with affine and prospectively correct texturing.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98b/897/f95/98b897f955dbdf31ff724bbe1a1841f4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perspective Texturing</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/67f/f2a/602/67ff2a6028aea5b8a390b13ecdf23f5c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Affine (PSX)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Note that there is no problem with a straight wall, and as the angle of perspective increases, the distortion becomes more noticeable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same perception problem faced Rage Software developers when porting DOOM to SEGA Saturn.</font></font><br>
<br>
<blockquote>¬´    ,        id Software.      ,      WAD       Saturn,      ,  3D-.   ,           ,          3D-   .     ,    PC.  ,   ,      :  SH2    ,   PC,  68000     .<br>
<br>
   ,      ¬ª ‚Äî   ( DOOM  Saturn)   RetroGamer ‚Ññ134.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps, since the developers on PSX had more time, they were able to solve the problem of prospectively correct texture mapping by turning the GPU polygon renderer into line renderer.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"I said: backup everything (then there were no version control systems yet!), We will make the game completely different." </font><font style="vertical-align: inherit;">We used equipment that rendered triangles that represented columns or rows of one pixel wide, just like in the assembler code on a PC, and it worked great. </font><font style="vertical-align: inherit;">It turned out that the more common solution on the Playstation was tessellation of geometry along two axes, but I really liked that Doom seemed less "twitchy" than most games for the Playstation of that time. "- John Carmack (Game Engine Black Book: DOOM)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to the PSXDOOM-RE project </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[16],</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we can find out how it was implemented. </font><font style="vertical-align: inherit;">The rendering pipeline has been completely rewritten and divided into two stages. </font><font style="vertical-align: inherit;">This will be discussed in more detail below, but we can actually see that the R_Render_Wall rendering function transmits hard-coded drawing commands with a width of 1 pixel.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">R_Render_Wall</span><span class="hljs-params">(...)</span> </span>{<font></font>
  .<font></font>
  <span class="hljs-keyword">int</span> x1 = ... ; <span class="hljs-comment">// Left end of wall.</span>
  <span class="hljs-keyword">int</span> x2 = ... ; <span class="hljs-comment">// Right end of wall.</span><font></font>
  .<font></font>
  <span class="hljs-keyword">while</span>(x1 &lt; x2) {<font></font>
    .<font></font>
    setRGB0(wallpoly);<font></font>
<font></font>
    setXY3(wallpoly,<font></font>
      x1    , ypos1 - <span class="hljs-number">1</span>,<font></font>
      x1 + <span class="hljs-number">1</span>, ypos2 + <span class="hljs-number">1</span>,<font></font>
      x1    , ypos2 + <span class="hljs-number">1</span>);		<font></font>
<font></font>
    setUV3(wallpoly,<font></font>
         upos, v0,<font></font>
         upos, v1,<font></font>
         upos, v1);  <font></font>
    .<font></font>
    x1 += <span class="hljs-number">1</span>;<font></font>
  }<font></font>
}</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Walls are rendered in one pixel wide columns. </font><font style="vertical-align: inherit;">Check out the API, which resembles Immediate mode in OpenGL. </font></font></i><br>
<br>
<b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interesting fact:</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sony's hardware designer retained the MIPS processor‚Äôs i-cache, but disabled its d-cache to turn it into a 1K high-speed scratchpad. </font><font style="vertical-align: inherit;">Wall / plane rendering procedures used this scratchpad extensively.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VRAM GPU Management</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To learn how VRAM control is performed, I chose a curious way: I used the function of viewing real-time VRAM emulator no $ PSX. </font><font style="vertical-align: inherit;">This function displays the entire array of pixels 1024 x 512 x 16 bits (albeit in a distorted form). </font><font style="vertical-align: inherit;">The view function also shows the entire list of GPU instructions transmitted by the central processor in each frame.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/106/6e1/2c4/1066e12c443fa07e91e8f4793afe655d.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No $ PSX - God sent us an emulator that allows you to look inside the GPU. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A careful study of VRAM first frame allows you to learn a lot.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dfd/e98/57f/dfde9857f541f946c946445fc5feb1ea.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first frame of the game displayed with No $ PSX. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most obvious are two areas of 256 x 240 x 16 bit in the upper left corner, which are the frame buffers (therefore, the game uses double buffering). </font><font style="vertical-align: inherit;">It is worth noting that 256x240 is the lowest resolution possible on a PSX. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Under the frame buffers is a colorful set of pixels - the CLUT palette. </font><font style="vertical-align: inherit;">Note the shades of red, they mean that when the screen turns red when the player takes damage, pre-calculated palettes are used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the upper right corner we see textures that are strangely compressed horizontally and have ‚Äúwrong‚Äù colors. </font><font style="vertical-align: inherit;">It happened because textures use 8-bit indices of the CLUT described above.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's talk about fire in DOOM on PS1 again</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2018, I studied how the effect of fire was realized </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[17]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Habr√©]. </font><font style="vertical-align: inherit;">It was great to come back to him again when exploring the GPU commands. </font><font style="vertical-align: inherit;">Notice that no $ PSX marks the target area of ‚Äã‚Äãeach command in red. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stage 1: the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> flame is updated in RAM and loaded into VRAM (CpuToVram command).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d61/e16/8a1/d61e168a1b238160665e78c437c7b2d5.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stage 2: the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> flame texture is drawn four times along the screen (QuadTex command). </font><font style="vertical-align: inherit;">The flame texture has a width of 32 texels, but the GPU is used to draw it with a width of 64 pixels. </font><font style="vertical-align: inherit;">Bilinear filtering is not possible here, the nearest texels are sampled.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/08b/a2c/f1a08ba2c51a31bd57bcf9b45827bb23.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stage 3: the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Final DOOM plate (QuadTex command) is drawn on top of everything.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7de/30e/f5b/7de30ef5b64d978cf2f632cfe3ac82b4.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full frame, team by team</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A study of the commands transmitted in the frame showed that the engine is completely different from the PC version. In it, the world was circled from a short distance into the distance. First, all the walls are rendered. On the second pass, a vertical gap is filled between them (visplane) (including the sky). In the third (last) passage, sprites are rendered, starting with the farthest. All this was done with zero redrawing pixels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On PSX, rendering is a little more rude. Everything is rendered in one pass, performed starting from afar. The visplane system that the PC used to fill the void between the walls is not here. Thanks to a new concept called ‚Äúleaves,‚Äù the plane and walls are rendered in the order of the subsectors. Such operations in ‚Äútrue 3D‚Äù became possible due to the active use of the GPE matrix projection functions. Sprites are also rendered simultaneously with walls / planes without overlap and truncation checks, which results in a small amount of redrawing.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">R_RenderPlayerView</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  R_BSP();         <span class="hljs-comment">// Phase 1</span>
  R_RenderSKY();   <span class="hljs-comment">// Phase 2</span>
  <span class="hljs-keyword">for</span> (all subsectors from phase <span class="hljs-number">1</span>) {<font></font>
    R_RenderAll(subsector)<font></font>
  }<font></font>
  R_Render_Hud_Weapons();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at each step in detail, starting with the sky, which is first rendered using CopyRectRaw. no $ PSX shows VRAM at the time the frame is completed, but allows you to go back through the history of commands. Sky pixels are visible only because no $ PSX has problems perceiving this hack with columns of one pixel width (other emulators, such as ePSXe, can cope no better </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[18]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), but all these pixels will be rewritten. Notice that under the textures of the sky all the markers of the keys to the doors are collected in an atlas.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d1d/2ae/868/d1d2ae868238f0282a8495a4e2dd6afd.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the BSP is traversed in order from far to near. For each subsector, all walls / planes / sprites are rendered. If you are familiar with DOOM BSP, then probably remember that the doombsp compiler only kept solid segments of subsectors. To ensure the rendering of planes, a new concept of ‚Äúleaves‚Äù was added to the PSX version, in which BPS separation segments (invisible) were stored. These segments are projected into the screen space to generate plane boundaries. This is a much more ‚Äúclean‚Äù approach, because it allows you to get rid of hacks with screen space and bugs, for example, from the well-known ‚Äútrail of slug‚Äù.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/558/cde/f1d/558cdef1d6ef68f1272b1e260333fd3b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the next VRAM shot, planes from the same subsector as the wall we saw above are rendered as triangles 1 pixel high. </font><font style="vertical-align: inherit;">Also pay attention to the texture of the walls / planes, they all have the same size. </font><font style="vertical-align: inherit;">This feature simplifies the selection of VRAM textures and avoids fragmentation.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/be6/092/6ce/be60926ce5304a264da51ab38a3e2c6a.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are still in the same subsector. </font><font style="vertical-align: inherit;">Now sprites are rendered as quadrangles (Quad). </font><font style="vertical-align: inherit;">These sprites include enemies, shells, partially transparent walls.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/708/e06/cf6/708e06cf66400378617db2484694433c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For fun, we‚Äôll show plasma shells.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fb4/c5a/ebc/fb4c5aebca255019caa7d8c31140c136.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are approaching the end of the rendering commands. </font><font style="vertical-align: inherit;">Here, by mixing the rectangle, the weapon is rendered.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac2/061/da0/ac2061da0769c7e614503818d5e59755.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Last Step: Interface Rendering (HUD).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a34/be3/7e9/a34be37e93d0991d27b5d4fd8a3356c4.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VRAM overflow!</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/853/a77/9cc/853a779ccdc0280234e53ab3b6aea59a.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Working with the GPU was an exercise in allocating space in VRAM. In the case of frame buffers, CLUT, static content (interface), and even walls / planes, the task is elementary, because they all have the same size. But with sprites, things are a little more complicated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Due to the fact that sprites have different sizes, they lead to fragmentation. Moreover, textures can cover large areas of the screen and repeat, and sprites are often unique and an unpredictably large number of them may be required in each frame. In the worst case, a frame requires a certain number of sprites that cannot be placed in VRAM. This is called a Texture Cache Overflow, and this problem cannot be solved. When this happens, the game crashes and displays a cryptic error message </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[19]</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reminding some of us of the ominous ‚ÄúNo more visplanes‚Äù.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1fb/4a4/f9f/1fb4a4f9fecf0b6420b198b08ff2f84d.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The more sprites you see at the same time, the more VRAM is used.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The difference between PAL and NTSC</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In conclusion of the video chapter, I decided to see how NTSC is converted to PAL. </font><font style="vertical-align: inherit;">Unfortunately, like in many other games, the DOOM PSX did not take into account the increase in vertical resolution. </font><font style="vertical-align: inherit;">When playing DOOM on PS1 in Europe, you saw a vertically compressed image with noticeable black borders. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After I learned about the principles of VRAM, it‚Äôs hard for me to blame the developers. </font><font style="vertical-align: inherit;">If you look closely at the VRAM scheme in NTSC, you will notice that increasing the vertical resolution of the frame buffer violates the entire data allocation structure. </font><font style="vertical-align: inherit;">It would be impossible to store textures under it. </font><font style="vertical-align: inherit;">Or you would have to move CLUT to another location. </font><font style="vertical-align: inherit;">Too much cost with relatively little benefit, and even despite the fact that the black borders interfered with the game, I agree that it was not worth it.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acknowledgments</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to Eric Vazquez (author of PSXDOOM-RE), Samuel Villarreal (one of the developers of PSXDOOM-RE) and Dan Leslie (professional developer of games for PlayStation 1) for generously sharing their knowledge with me.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reference materials</font></font></b><div class="spoiler_text">[ 1] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">The Polygons Of Another World</a><br>
[ 2] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Game Engine Black Book: DOOM</a><br>
[ 3] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Everything You Have Always Wanted to Know about the Playstation</a><br>
[ 4] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">@gmontoir ‚Äî 'Heart of Darkness uses MDEC frames as background bitmaps'.</a><br>
[ 5] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Five years of DOOM, part 1</a><br>
[ 6] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Five years of DOOM, part 2</a><br>
[ 7] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://archive.vn/20121209124333/" rel="nofollow">The Great Books</a><br>
[ 8] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">DOOM PSX tracks</a><br>
[ 9] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">MAP59: Club Doom (PlayStation Doom)</a><br>
[10] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">PSXDOOM/tree.txt</a><br>
[11] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">PSXDOOM files</a><br>
[12] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">PSY-Q SDK, CD Hardware</a><br>
[13] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">P_LoadBlocks</a><br>
[14] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">Linedef #142 plays Club Doom</a><br>
[15] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">//#define CC_ARCH</a><br>
[16] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">PSXDOOM-RE Source code</a><br>
[17] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">How DOOM fire was done</a><br>
[18] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">DOOM on ePSXe</a><br>
[19] : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">I_Error('Texture Cache Overflow');</a></div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494380/index.html">Introduction to Strategic Product Management</a></li>
<li><a href="../en494384/index.html">Functional survey</a></li>
<li><a href="../en494390/index.html">3D printing cut auto-tuning costs by half</a></li>
<li><a href="../en494394/index.html">Xia Peysu: mother of Chinese computer science</a></li>
<li><a href="../en494396/index.html">Welcome Mat - now also in Russian</a></li>
<li><a href="../en494400/index.html">Coronavirus and the Internet</a></li>
<li><a href="../en494402/index.html">Stages of Strategic Maturity</a></li>
<li><a href="../en494406/index.html">Machine learning without a teacher. Excerpt from the book</a></li>
<li><a href="../en494408/index.html">The scheme for counterfeiting, restoring and checking fruits in a greengrocery. Excerpt from the book</a></li>
<li><a href="../en494410/index.html">Before it became mainstream: how we launched contactless delivery</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>