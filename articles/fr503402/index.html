<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏓 🍑 🌺 Comment se souvenir de tout le monde en personne ou une recherche efficace de visages dans une grande base de données 👩🏿‍⚕️ 🌅 ✌️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="À propos de moi
 

Bonjour, Habr! Mon nom est Pavel, je travaille en tant que directeur technique dans une entreprise engagée dans la production d'app...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment se souvenir de tout le monde en personne ou une recherche efficace de visages dans une grande base de données</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503402/"><h1 id="o-sebe"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À propos de moi</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font><font style="vertical-align: inherit;">Mon nom est Pavel, je travaille en tant que directeur technique dans une entreprise engagée dans la production d'appareils IoT. </font><font style="vertical-align: inherit;">Nous produisons beaucoup de choses - des contrôleurs de maison intelligente aux appareils de mesure intelligents sur notre protocole réseau de capteurs breveté.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ils agissent également en tant que directeur général de la société informatique. </font><font style="vertical-align: inherit;">Dans le passé, ACM ICPC demi-finaliste de la programmation de la Coupe du monde.</font></font></p><br>
<h1 id="motivaciya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Motivation</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'écris cet article car notre équipe a tué environ un mois pour trouver une solution (encore deux semaines pour implémenter et écrire des tests) pour stocker et trouver efficacement des personnes reconnues dans la base de données, afin de vous faire gagner du temps dans vos projets. </font><font style="vertical-align: inherit;">Spoiler: ils ne trouvaient rien de prêt à l'emploi comme un plug-in sympa pour le SGBD existant, mais les délais étaient flamboyants, nous avons donc écrit notre propre SGBD pour cette tâche même (stockant un grand nombre d'incorporation de visages). </font><font style="vertical-align: inherit;">Mon article ne prétend en aucun cas être un guide exhaustif, mais j'espère qu'il fournira un point de départ pour une étude plus approfondie et le développement de nos pensées.</font></font></p><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'incorporation est une cartographie à partir d'un vecteur discret de caractéristiques catégorielles dans un vecteur continu avec une dimension prédéterminée.</font></font></blockquote><a name="habracut"></a><br>
<h1 id="itak-s-chego-vsyo-nachinalos"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alors, où tout a commencé</font></font></h1><br>
<p>-        ,            ,     ,    /   ,             . ,   ,   ,  ,        . ""          87%,  ,  ,        .           ,       3 .              .          2-3   .         —   …          ,   ,  - "" (   )    6 .             . </p><br>
<h1 id="postanovka-zadachi"> </h1><br>
<p> ,    , :   (   )    ,   ,   ,           ,     ,   ,      .                      10  200     ,      .         ,       50  .    10. </p><br>
<p>,      +- ,          . </p><br>
<p>       , ,     ,             dlib,           .       C++,  BLAS,    Python      CPU.          .</p><br>
<p>    ,   dlib        ,              0.6,     .       128. </p><br>
<p>,  .  ,       ,     ,  ,   ,      . ,  ,    k  ,  k    ,    ,     -   -. ,   -,      -.</p><br>
<p>   . </p><br>
<h2 id="tupo-perebor"> </h2><br>
<p>  .      dlib            . </p><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_img_vector</span>(<span class="hljs-params">img</span>):</span>
    dets = detector(img, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">for</span> k, d <span class="hljs-keyword">in</span> enumerate(dets):<font></font>
        shape = sp(img, d)<font></font>
        <span class="hljs-keyword">return</span> facerec.compute_face_descriptor(img, shape)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_database</span>():</span><font></font>
    database = {}<font></font>
<font></font>
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> glob.glob(<span class="hljs-string">"_images/*"</span>):<font></font>
        identity = os.path.splitext(os.path.basename(file))[<span class="hljs-number">0</span>]<font></font>
        img = cv2.imread(file, <span class="hljs-number">1</span>)<font></font>
<font></font>
        database[identity] = get_img_vector(img)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> database<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">who_is_it</span>(<span class="hljs-params">img, shape, database</span>):</span><font></font>
    face_descriptor1 = facerec.compute_face_descriptor(img, shape)<font></font>
<font></font>
    min_dist = <span class="hljs-number">100</span>
    identity = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-keyword">for</span> (name, db_enc) <span class="hljs-keyword">in</span> database.items():<font></font>
        dist = distance.euclidean(db_enc, face_descriptor1)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> dist &lt; min_dist:<font></font>
            min_dist = dist<font></font>
            identity = name<font></font>
<font></font>
    print(min_dist)<font></font>
    <span class="hljs-keyword">if</span> min_dist &gt; <span class="hljs-number">0.57</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> str(identity)<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">global</span> sp<font></font>
    sp = dlib.shape_predictor(<span class="hljs-string">'weights/shape_predictor_face_landmarks.dat'</span>)
    <span class="hljs-keyword">global</span> facerec<font></font>
    facerec = dlib.face_recognition_model_v1(<span class="hljs-string">'weights/dlib_face_recognition_resnet_model_v1.dat'</span>)
    <span class="hljs-keyword">global</span> detector<font></font>
    detector = dlib.get_frontal_face_detector()<font></font>
<font></font>
    database = prepare_database()<font></font>
    webcam_face_recognizer(database)</code></pre><br>
<p>  <em>webcam_face_recognizer</em>        ( cv2- )       .    <em>who_is_it</em>,                 . ,  ,  , ,  !</p><br>
<p>,            1   .     (N*k),  N —      ,  k —   .          , ,      .     ,         ,           -           .    .</p><br>
<h2 id="matrica"></h2><br>
<p>     ,   ?</p><br>
<p>  — ,       ,            .     —   .  ,      ,          ,    L2   .</p><br>
<pre><code class="python hljs">
scores = np.linalg.norm(face_descriptor1 - np.asarray(database.items()), axis=<span class="hljs-number">1</span>)<font></font>
min_el_ind = scores.argmax()<font></font>
</code></pre><br>
<p>      , , ,    .</p><br>
<p>   ,     ,   nmslib.    HNSW    k  .          ,       .            :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> nmslib<font></font>
<font></font>
index = nmslib.init(method=<span class="hljs-string">'hnsw'</span>, space=<span class="hljs-string">'l2'</span>, data_type=nmslib.DataType.DENSE_VECTOR)<font></font>
<font></font>
<span class="hljs-keyword">for</span> idx, emb <span class="hljs-keyword">in</span> enumerate(database.items()):<font></font>
    index.addDataPoint(idx, emb)<font></font>
<font></font>
index_params = {<font></font>
    <span class="hljs-string">'indexThreadQty'</span>: <span class="hljs-number">5</span>,
    <span class="hljs-string">'skip_optimized_index'</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">'post'</span>: <span class="hljs-number">3</span>,
    <span class="hljs-string">'delaunay_type'</span>: <span class="hljs-number">2</span>,
    <span class="hljs-string">'M'</span>: <span class="hljs-number">100</span>,
    <span class="hljs-string">'efConstruction'</span>: <span class="hljs-number">2000</span><font></font>
}<font></font>
<font></font>
index.createIndex(index_params, print_progress=<span class="hljs-literal">True</span>)<font></font>
index.saveIndex(<span class="hljs-string">'./db/database.bin'</span>)</code></pre><br>
<p>  HNSW     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>.</p><br>
<p>    ""    .      ? </p><br>
<h2 id="klasterizaciya"></h2><br>
<p> ,    4 .     dlib ,         . </p><br>
<p><img src="https://www.techort.com/wp-content/uploads/2018/07/1531861000_682_you-and-brad-pitt-are-like-99-blog-of-the-company-rambler-group-habr.jpeg" alt="image"></p><br>
<p>    ,             .  , , .  . </p><br>
<h2 id="plagin-dlya-postgresql">  postgresql</h2><br>
<p>      -    ,     ,       (,     . )  . </p><br>
<p>:</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> postgresql<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup_db</span>():</span>
    db = postgresql.open(<span class="hljs-string">'pq://user:pass@localhost:5434/db'</span>)<font></font>
    db.execute(<span class="hljs-string">"create extension if not exists cube;"</span>)<font></font>
    db.execute(<span class="hljs-string">"drop table if exists vectors"</span>)<font></font>
    db.execute(<span class="hljs-string">"create table vectors (id serial, file varchar, vec_low cube, vec_high cube);"</span>)<font></font>
    db.execute(<span class="hljs-string">"create index vectors_vec_idx on vectors (vec_low, vec_high);"</span>)</code></pre><br>
<p>:</p><br>
<pre><code class="python hljs">query = <span class="hljs-string">"INSERT INTO vectors (file, vec_low, vec_high) VALUES ('{}', CUBE(array[{}]), CUBE(array[{}]))"</span>.format(<font></font>
            file_name,<font></font>
            <span class="hljs-string">','</span>.join(str(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> encodings[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>:<span class="hljs-number">64</span>]),
            <span class="hljs-string">','</span>.join(str(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> encodings[<span class="hljs-number">0</span>][<span class="hljs-number">64</span>:<span class="hljs-number">128</span>]),<font></font>
        )<font></font>
db.execute(query)</code></pre><br>
<p>:</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> postgresql
<span class="hljs-keyword">import</span> random<font></font>
<font></font>
db = postgresql.open(<span class="hljs-string">'pq://user:pass@localhost:5434/db'</span>)<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">100</span>):<font></font>
    t = time.time()<font></font>
    encodings = [random.random() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">128</span>)]<font></font>
<font></font>
    threshold = <span class="hljs-number">0.6</span>
    query = <span class="hljs-string">"SELECT file FROM vectors WHERE sqrt(power(CUBE(array[{}]) &lt;-&gt; vec_low, 2) + power(CUBE(array[{}]) &lt;-&gt; vec_high, 2)) &lt;= {} "</span>.format(
        <span class="hljs-string">','</span>.join(str(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> encodings[<span class="hljs-number">0</span>:<span class="hljs-number">64</span>]),
        <span class="hljs-string">','</span>.join(str(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> encodings[<span class="hljs-number">64</span>:<span class="hljs-number">128</span>]),<font></font>
        threshold,<font></font>
    ) + \<font></font>
            <span class="hljs-string">"ORDER BY sqrt(power(CUBE(array[{}]) &lt;-&gt; vec_low, 2) + power(CUBE(array[{}]) &lt;-&gt; vec_high, 2)) ASC LIMIT 1"</span>.format(
                <span class="hljs-string">','</span>.join(str(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> encodings[<span class="hljs-number">0</span>:<span class="hljs-number">64</span>]),
                <span class="hljs-string">','</span>.join(str(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> encodings[<span class="hljs-number">64</span>:<span class="hljs-number">128</span>]),<font></font>
            )<font></font>
    print(db.query(query))<font></font>
    print(<span class="hljs-string">'inset time'</span>, time.time() - t, <span class="hljs-string">'ind'</span>, i)</code></pre><br>
<p>    10^5     (4-  i5, 2,33 GHz)  0.034 .<br>
 ?   +-       (     ).       ,       ,  …  ,    . </p><br>
<h2 id="k-d-derevo">K-d </h2><br>
<p>-  ,   , " ",       . ,       . </p><br>
<p> ,    ,  ,   . </p><br>
<p>K-d  —           k- .      ,        ( ,     . .),           .</p><br>
<p>   , :</p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.</p><br>
<p>   (N)   ,    ,          ,        (N).    ,     ! </p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> "" ,   NDA. </p><br>
<p>    .       ,     . </p><br>
<h1 id="na-dannyy-moment">  </h1><br>
<p>       15   .   , . .            . </p><br>
<p>         —    . ,             ,       :) </p><br>
<p> k-tree    ,                (   ),     ,        ( -),        4-6 .        . </p><br>
<h1 id="podvodya-itogi"> </h1><br>
<p>  ,           .  —  1,5         ,      ,    , ,    ,   ,       .            ,         ,    . </p><br>
<p>       ,   ,              ,       .           ,    mail cloud.  ,   . </p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S'il existe d'autres options pour résoudre ce problème, je me ferai un plaisir de les lire dans les commentaires. </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et la morale de cette fable est la suivante: la foule est même tombée </font></font><del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le lion</font></font></del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solutions open source testées par le temps. </font><font style="vertical-align: inherit;">Apprenez les algorithmes, pasans :)</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr503386/index.html">Coach agile personne en bonne santé</a></li>
<li><a href="../fr503388/index.html">Numérisation de la panique: DIT de Moscou contre les Moscovites - une table ronde le 23 mai</a></li>
<li><a href="../fr503390/index.html">Pourquoi Intel parie-t-il sur le développement de puces pour le génie de Jim Keller?</a></li>
<li><a href="../fr503394/index.html">Expérience d'investissement en actions</a></li>
<li><a href="../fr503398/index.html">Comment créer rapidement une modélisation thématique d'un forum ou ce qui dérange les personnes atteintes de la maladie cœliaque</a></li>
<li><a href="../fr503404/index.html">Systèmes numériques sémantiques</a></li>
<li><a href="../fr503406/index.html">Sémantique et activité</a></li>
<li><a href="../fr503408/index.html">Boutique en ligne côté client Blazor: Partie 7 - Mise à jour pour publier la version 3.2.0 et affichage d'image ajouté</a></li>
<li><a href="../fr503410/index.html">Polygones Another World: Sega Genesis</a></li>
<li><a href="../fr503412/index.html">Project Loom: les threads virtuels Java sont proches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>