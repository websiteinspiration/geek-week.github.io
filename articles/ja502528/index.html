<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙏🏿 🤷🏼 💆🏻 ESP32の組み込みデバイス用のゲームのプログラミング 💪🏿 💘 👤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="パート0：動機
 前書き
 私は、世界の状況から脱出するために、自分の主なタスク以外で作業できる趣味のプロジェクトを探していました。主にゲームプログラミングに興味がありますが、組み込みシステムも好きです。今はゲーム会社で働いていますが、以前は主にマイクロコントローラーに従事していました。結局、自分の...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ESP32の組み込みデバイス用のゲームのプログラミング</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502528/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート0：動機</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は、世界の状況から脱出するために、自分の主なタスク以外で作業できる趣味のプロジェクトを探していました。</font><font style="vertical-align: inherit;">主にゲームプログラミングに興味がありますが、組み込みシステムも好きです。</font><font style="vertical-align: inherit;">今はゲーム会社で働いていますが、以前は主にマイクロコントローラーに従事していました。</font><font style="vertical-align: inherit;">結局、自分の道を変えてゲーム業界に入ることに決めましたが、それでも彼らと実験したいです。</font><font style="vertical-align: inherit;">では、両方の趣味を組み合わせてみませんか？</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid Go</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid Goをうろつい</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">てい</font><font style="vertical-align: inherit;">ました。</font><font style="vertical-align: inherit;">そのコアはESP32です。これは、標準のMK機能（SPI、I2C、GPIO、タイマーなど）を備えた非常に人気のあるマイクロコントローラーですが、WiFiとBluetoothも備えているため、IoTデバイスの作成に魅力的です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Goは、ESP32を多数の周辺機器で補完し、それをGameboy Colorに似たポータブルゲーム機に変えます：LCDディスプレイ、スピーカー、コントロールクロス、2つの主ボタンと4つの補助ボタン、バッテリー、SDカードリーダー。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどの人がOdroid Goを購入して</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">古い8ビットシステムの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">エミュレーター</font></a><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">実行します</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これが古いゲームをエミュレートできる場合、それはそれのために特別に設計されたネイティブゲームの起動にも対応します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44b/800/42e/44b80042e94aa2f2da9da2d2296461ad.jpg"></div><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">制限事項</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解像度320x240</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ディスプレイのサイズは320x240のみなので、同時に画面に表示される情報の量は非常に制限されています。作成するゲームと使用するリソースを慎重に検討する必要があります。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16ビットカラー</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ディスプレイは、ピクセルごとに16ビットカラーをサポートします。赤は5ビット、緑は6ビット、青は5ビットです。明らかな理由により、このような回路は通常RGB565と呼ばれます。人間の目は青や赤よりも緑のグラデーションをよりよく区別するため、緑は赤と青がもう1つ多くなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16ビットカラーとは、65,000色のみにアクセスできることを意味します。これを標準の24ビットカラー（1色あたり8ビット）と比較して、1600 </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">万</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">色を</font><font style="vertical-align: inherit;">提供し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPUの欠如</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GPUがないと、OpenGLのようなAPIを使用できません。現在、3Dゲームと同じGPUが2Dゲームのレンダリングに通常使用されています。オブジェクトの代わりに四角形が描画され、その上にビットテクスチャが重ねられます。 GPUを使用しない場合、CPUを使用して各ピクセルをラスタライズする必要がありますが、これは低速ですが単純です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画面解像度が320x240で16ビットカラーの場合、フレームバッファーの合計サイズは153,600バイトです。これは、少なくとも毎秒30回、ディスプレイに153,600バイトを送信する必要があることを意味します。これは最終的に問題を引き起こす可能性があるため、画面をレンダリングするときはよりスマートにする必要があります。たとえば、インデックス付きカラーをパレットに変換して、ピクセルごとに1バイトを格納する必要があるようにすることができます。これは、256色パレットのインデックスとして使用されます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 MB</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ESP32には520 KBの内部RAMが搭載されていますが、Odroid Goにはさらに4 MBの外部RAMが追加されています。ただし、一部はESP32 SDKによって使用されるため、このメモリのすべてを使用できるわけではありません（これについては後で詳しく説明します）。 ESP32は、考えられるすべての無関係な機能を無効にしてメイン機能を入力した後、4,494,848バイトを使用できると報告します。将来さらに多くのメモリが必要になった場合は、後で不要な関数のトリミングに戻ることができます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">80-240 MHzプロセッサ</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPUは、80 MHz、160 MHz、240 MHzの3つの速度で構成されています。最大240 MHzでさえ、私たちが慣れ親しんでいる最近のコンピューターの3ギガヘルツを超える電力とはかけ離れています。 80 MHzから始めて、どこまで行けるか見てみましょう。ゲームをバッテリー電源で動作させたい場合、電力消費は低くなければなりません。これを行うには、周波数を下げるとよいでしょう。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪いデバッグ</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組み込みデバイス（JTAG）でデバッガーを使用する方法はいくつかありますが、残念なことに、Odroid Goは必要な連絡先を提供しないため、通常のように、デバッガーでコードをステップ実行できません。</font><font style="vertical-align: inherit;">つまり、デバッグは困難なプロセスになる可能性があり、画面上でのデバッグ（色とテキストを使用）と、デバッグコンソールでの情報の表示（幸い、USB UARTから簡単にアクセスできる）を積極的に使用する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜすべてのトラブル？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のすべての制限を備えたこの弱いデバイス用のゲームを作成して、デスクトップPC用に何も書かないのはなぜですか？これには2つの理由があります：</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">制限は創造性を刺激し</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ます</font><strong><font style="vertical-align: inherit;">。</font></strong><font style="vertical-align: inherit;">それぞれに独自の制限がある特定の機器のセットを持つシステムで作業する場合、これらの制限の利点を最大限に活用する方法を考えさせられます。そこで、私たちは古いシステム、たとえばスーパーニンテンドーのゲームデベロッパーにアプローチしています（しかし、それでも私たちにとってははるかに簡単です）。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">低レベルの開発は楽しい</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常のデスクトップシステムのゲームをゼロから作成するには、標準の低レベルエンジンの概念であるレンダリング、物理、衝突認識を使用する必要があります。</font><font style="vertical-align: inherit;">しかし、これらすべてを組み込みデバイスに実装する場合は、LCDドライバーの作成など、低レベルのコンピューターの概念も扱う必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発はどれくらい低くなるのでしょうか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
低レベルで独自のコードを作成する場合、どこかに境界を描く必要があります。デスクトップ用のライブラリなしでゲームを作成しようとしている場合、境界はオペレーティングシステムまたはSDLのようなクロスプラットフォームAPIである可能性があります。私のプロジェクトでは、SPIドライバーやブートローダーなどの記述に線を引きます。彼らと一緒に楽しくよりも多くの苦痛。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ESP-IDFを使用します。これは本質的にESP32のSDKです。オペレーティングシステムが通常提供するユーティリティがいくつか提供されていると想定できますが、</font><font style="vertical-align: inherit;">オペレーティングシステム</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ESP32 </font><strong><font style="vertical-align: inherit;">では機能しません</font></strong><font style="vertical-align: inherit;">。厳密に言うと、このMKは</font><strong><font style="vertical-align: inherit;">リアルタイムオペレーティングシステム</font></strong><font style="vertical-align: inherit;">であるFreeRTOSを使用</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、これは実際のOSではありません。</font><font style="vertical-align: inherit;">これは単なるプランナーです。</font><font style="vertical-align: inherit;">ほとんどの場合、私たちはそれと対話しませんが、そのコアESP-IDFではそれを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP-IDFは、SPI、I2C、UARTなどのESP32ペリフェラル用のAPIとCランタイムライブラリを提供するため、printfなどの関数を呼び出すと、UARTを介してバイトを転送し、シリアルインターフェイスモニターに表示されます。</font><font style="vertical-align: inherit;">また、ゲームの起動ポイントを呼び出す前に、マシンの準備に必要なすべてのスタートアップコードを処理します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回の投稿では、自分に思えた面白い点や、難しい点などを解説した開発マガジンをお届けします。</font><font style="vertical-align: inherit;">私には計画がありません、そして多くの場合私は多くの間違いをするでしょう。</font><font style="vertical-align: inherit;">これはすべて私が興味をそそって作成したものです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート1：システムの構築</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Goのコードを書き始める前に、ESP32 SDKを構成する必要があります。</font><font style="vertical-align: inherit;">これには、ESP32を起動してメイン関数を呼び出すコードと、LCDドライバーを作成するときに必要な周辺コード（SPIなど）が含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espressifは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP-IDF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SDKを呼び出します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最新の安定バージョン</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v4.0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指示に従って（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再帰</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグを使用して</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">リポジトリを複製するか</font><font style="vertical-align: inherit;">、リリースページからzipをダウンロードします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の目標は、ビルド環境の正しいセットアップを証明するOdroid Goにインストールされた最小限のHello Worldスタイルのアプリケーションです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CまたはC ++</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP-IDFはC99を使用するため、ここでも選択します。</font><font style="vertical-align: inherit;">必要に応じて、C ++を使用することもできます（ESP32ツールチェーンにはC ++コンパイラがあります）が、ここではCに固執します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、私はCとその単純さが好きです。</font><font style="vertical-align: inherit;">C ++でコードをいくら書いても、それを楽しむ瞬間に到達することはできませんでした。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この人は私の考えをかなりうまくまとめています。</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、必要に応じて、いつでもC ++に切り替えることができます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小限のプロジェクト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDFはCMakeを使用してビルドシステムを管理します。 Makefileもサポートしていますが、v4.0では非推奨であるため、CMakeのみを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少なくとも、</font><font style="vertical-align: inherit;">プロジェクトの説明を</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含むCMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">、ゲームへのエントリポイントのソースファイルを</font><font style="vertical-align: inherit;">含む</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メイン</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォルダー</font><font style="vertical-align: inherit;">、および</font><font style="vertical-align: inherit;">ソースファイルをリストする</font><strong><font style="vertical-align: inherit;">main</font></strong><font style="vertical-align: inherit;">内の</font><font style="vertical-align: inherit;">別の</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">が</font><strong><font style="vertical-align: inherit;">必要</font></strong><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">
CMakeは、IDFとツールチェーンの検索場所を指示する環境変数を参照する必要があります。新しいターミナルセッションを開始するたびに再インストールしなければならないことに</font><strong><font style="vertical-align: inherit;">不満が</font></strong><font style="vertical-align: inherit;">あったため、</font><strong><font style="vertical-align: inherit;">export.sh</font></strong><font style="vertical-align: inherit;">スクリプトを</font><strong><font style="vertical-align: inherit;">記述し</font></strong><font style="vertical-align: inherit;">ました</font><font style="vertical-align: inherit;">。</font><strong><font style="vertical-align: inherit;">IDF_PATH</font></strong><font style="vertical-align: inherit;">と</font><strong><font style="vertical-align: inherit;">IDF_TOOLS_PATHを</font></strong><font style="vertical-align: inherit;">設定します</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および他の環境変数を設定するIDFエクスポートソースでもあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトユーザーが</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_TOOLS_PATH変数</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を設定する</font><strong><font style="vertical-align: inherit;">だけ</font></strong><font style="vertical-align: inherit;">で</font><strong><font style="vertical-align: inherit;">十分です</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="powershell hljs">IDF_PATH=<font></font>
IDF_TOOLS_PATH=<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -<span class="hljs-type">z</span> <span class="hljs-string">"<span class="hljs-variable">$IDF_PATH</span>"</span> ]<font></font>
then<font></font>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"IDF_PATH not set"</span>
	<span class="hljs-keyword">return</span><font></font>
fi<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -<span class="hljs-type">z</span> <span class="hljs-string">"<span class="hljs-variable">$IDF_TOOLS_PATH</span>"</span> ]<font></font>
then<font></font>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"IDF_TOOLS_PATH not set"</span>
	<span class="hljs-keyword">return</span><font></font>
fi<font></font>
<font></font>
<font></font>
export IDF_PATH<font></font>
export IDF_TOOLS_PATH<font></font>
<font></font>
source <span class="hljs-variable">$IDF_PATH</span>/export.sh</code></pre><br>
<strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルートの</font><strong><font style="vertical-align: inherit;">CMakeLists.txt</font></strong><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cmake hljs"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>)<font></font>
<font></font>
<span class="hljs-keyword">set</span>(COMPONENTS <span class="hljs-string">"esptool_py main"</span>)<font></font>
<font></font>
<span class="hljs-keyword">include</span>($ENV{IDF_PATH}/tools/cmake/<span class="hljs-keyword">project</span>.cmake)<font></font>
<font></font>
<span class="hljs-keyword">project</span>(game)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、ビルドシステムは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ ESP_IDF / components</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内にすべての可能なコンポーネントをビルドし</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。これにより、コンパイル時間が長くなります。</font><font style="vertical-align: inherit;">最小限のコンポーネントセットをコンパイルしてメイン関数を呼び出し、必要に応じて後で追加のコンポーネントを接続します。</font><font style="vertical-align: inherit;">これが</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COMPONENTS</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数の目的</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メイン</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cmake hljs">idf_component_register(<font></font>
	SRCS <span class="hljs-string">"main.c"</span>
    INCLUDE_DIRS <span class="hljs-string">""</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼がするすべてのこと-1秒に1回限り、シリアルインターフェイス "Hello World"がモニターに表示されます。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTaskDelay</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はFreeRTOS </font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">して遅延し</font><font style="vertical-align: inherit;">ます。</font><b><font style="vertical-align: inherit;">main.c</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ファイルは</font><font style="vertical-align: inherit;">非常にシンプルです。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;freertos/FreeRTOS.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;freertos/task.h&gt;</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello World!\n"</span>);<font></font>
		vTaskDelay(<span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの関数が呼び出されることに注意</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app_main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ない</font></font></em> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メイン</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数は</font><font style="vertical-align: inherit;">、必要な準備のためにIDFによって使用され、</font><strong><font style="vertical-align: inherit;">app_main</font></strong><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">をエントリポイントとして</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成し</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
タスクは、FreeRTOSが管理できる実行可能なブロックにすぎません。これについては心配する必要はありません（またはまったく心配しないでください）が、ゲームは1つのコアで実行され（ESP32には2つのコアがあります）、forループの反復ごとに、タスクが1秒間実行を遅らせることに注意してください。この遅延の間、FreeRTOSスケジューラは、実行を待機している他のコード（存在する場合）を実行する場合があります。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
両方のコアを使用できますが、ここでは1つに制限しましょう。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部品</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンポーネントのリストをHello Worldアプリケーションに必要な最小数（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esptool_py</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）に</font><strong><font style="vertical-align: inherit;">減らし</font></strong><font style="vertical-align: inherit;">ても、依存関係チェーンの構成により、不要な他のコンポーネントが収集されます。</font><font style="vertical-align: inherit;">これらのコンポーネントをすべて収集します。</font></font><br>
<br>
<pre><code class="cmake hljs">app_trace app_update bootloader bootloader_support cxx driver efuse esp32 esp_common esp_eth esp_event esp_ringbuf<font></font>
esp_rom esp_wifi espcoredump esptool_py freertos heap log lwip main mbedtls newlib nvs_flash partition_table pthread<font></font>
soc spi_flash tcpip_adapter vfs wpa_supplicant xtensa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それらの多くは非常に論理的です（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブートローダー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freertos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。ただし、ネットワーク機能を使用しないため、不要なコンポーネントが続きます：</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_eth、esp_wifi、lwip、mbedtls、tcpip_adapter、wpa_supplicant</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">残念ながら、これらのコンポーネントを組み立てる必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸い、リンカは十分にスマートであり、未使用のコンポーネントをゲームの既製のバイナリファイルに入れません。</font><font style="vertical-align: inherit;">これは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make size-componentsで</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">確認でき</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br>
<code><pre>Total sizes:
 DRAM .data size:    8476 bytes
 DRAM .bss  size:    4144 bytes
Used static DRAM:   12620 bytes ( 168116 available, 7.0% used)
Used static IRAM:   56345 bytes (  74727 available, 43.0% used)
      Flash code:   95710 bytes
    Flash rodata:   40732 bytes
Total image size:~ 201263 bytes (.bin may be padded larger)
Per-archive contributions to ELF file:
            Archive File DRAM .data &amp; .bss   IRAM Flash code &amp; rodata   Total
                  libc.a        364      8   5975      63037     3833   73217
              libesp32.a       2110    151  15236      15415    21485   54397
           libfreertos.a       4148    776  14269          0     1972   21165
                libsoc.a        184      4   7909        875     4144   13116
          libspi_flash.a        714    294   5069       1320     1386    8783
                libvfs.a        308     48      0       5860      973    7189
         libesp_common.a         16   2240    521       1199     3060    7036
             libdriver.a         87     32      0       4335     2200    6654
               libheap.a        317      8   3150       1218      748    5441
             libnewlib.a        152    272    869        908       99    2300
        libesp_ringbuf.a          0      0    906          0      163    1069
                liblog.a          8    268    488         98        0     862
         libapp_update.a          0      4    127        159      486     776
 libbootloader_support.a          0      0      0        634        0     634
                libhal.a          0      0    519          0       32     551
            libpthread.a          8     12      0        288        0     308
             libxtensa.a          0      0    220          0        0     220
                libgcc.a          0      0      0          0      160     160
               libmain.a          0      0      0         22       13      35
                libcxx.a          0      0      0         11        0      11
                   (exe)          0      0      0          0        0       0
              libefuse.a          0      0      0          0        0       0
         libmbedcrypto.a          0      0      0          0        0       0
     libwpa_supplicant.a          0      0      0          0        0       0</pre></code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何よりも、libcはバイナリのサイズに影響しますが、それで問題ありません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクト構成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDFでは、アセンブリ時にさまざまな機能を有効または無効にするために使用するコンパイル時の構成パラメーターを指定できます。</font><font style="vertical-align: inherit;">Odroid Goの追加機能を利用できるようにするパラメーターを設定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、</font><font style="vertical-align: inherit;">CMakeが必要な環境変数にアクセスできるように</font><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">export.sh</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のソーススクリプトを実行する必要があり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">さらに、すべてのCMakeプロジェクトと同様に、アセンブリフォルダーを作成し、そこからCMakeを呼び出す必要があります。</font></font><br>
<br>
<pre><code class="cmake hljs">source <span class="hljs-keyword">export</span>.sh<font></font>
mkdir build<font></font>
cd build<font></font>
cmake ..</code></pre><br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make menuconfig</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を実行</font><strong><font style="vertical-align: inherit;">する</font></strong><font style="vertical-align: inherit;">と、プロジェクト設定を構成できるウィンドウが開きます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラッシュメモリを最大16 MBまで拡張</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Goは、標準のフラッシュドライブ容量を16 MBに拡張します。</font><font style="vertical-align: inherit;">この機能を有効にするには、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリアルフラッシャー設定-&gt;フラッシュサイズ-&gt; 16MBに移動し</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部SPI RAMをオンにする</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SPI経由で接続された追加の4 MBの外部RAMにもアクセスできます。</font><font style="vertical-align: inherit;">あなたは、に行くことによって、それを有効にすることができます</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt;外部、SPI-接続されているRAMのサポートを- &gt; ESP32固有の-コンポーネントの設定</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、それを有効にするには、スペースバーを押します。</font><font style="vertical-align: inherit;">また、SPI RAMからメモリを明示的に割り当てることができるようにしたいと考えています。</font><font style="vertical-align: inherit;">これは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI RAM config-&gt; SPI RAMアクセス方法-&gt; heap_caps_mallocを使用してRAMを割り当て可能にする</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことで有効にできます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">周波数を下げる</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP32はデフォルトで160 MHzの周波数で動作しますが、80 MHzに下げて、最低のクロック周波数でどこまで行けるかを確認してみましょう。私たちはゲームをバッテリー電源で動作させたいので、周波数を下げると電力を節約できます。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンポーネント設定-&gt; ESP32固有-&gt; CPU周波数-&gt; 80MHzに移動</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">することで変更できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[ </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">保存]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を選択する</font><font style="vertical-align: inherit;">と、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルがプロジェクトフォルダのルートに保存されます</font><font style="vertical-align: inherit;">。このファイルはgitで作成できますが、重要ではないパラメーターが多数含まれています。これまでのところ、変更したばかりのパラメーターを除いて、標準パラメーターに満足しています。</font><strong><font style="vertical-align: inherit;">代わりにsdkconfig.defaults</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ファイルを作成できます</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上記で変更された値が含まれます。</font><font style="vertical-align: inherit;">他のすべてはデフォルトで設定されます。</font><font style="vertical-align: inherit;">ビルド中、IDFは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を読み取り</font><font style="vertical-align: inherit;">、設定した値を上書きし、他のすべてのパラメーターの標準を使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このようなルックスを：</font></font><br>
<br>
<pre><code class="cpp hljs"># Set flash size to <span class="hljs-number">16</span>MB<font></font>
CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y<font></font>
<font></font>
# Set CPU frequency to <span class="hljs-number">80</span>MHz<font></font>
CONFIG_ESP32_DEFAULT_CPU_FREQ_80=y<font></font>
<font></font>
# Enable SPI RAM <span class="hljs-keyword">and</span> allocate with heap_caps_malloc()<font></font>
CONFIG_ESP32_SPIRAM_SUPPORT=y<font></font>
CONFIG_SPIRAM_USE_CAPS_ALLOC=y</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、ゲームの元の構造は次のようになります。</font></font><br>
<br>
<code><pre>game
├── CMakeLists.txt
├── export.sh
├── main
│   ├── CMakeLists.txt
│   └── main.c
└── sdkconfig.defaults</pre></code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビルドしてフラッシュ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アセンブリとファームウェアのプロセス自体は非常に簡単です。</font><strong><font style="vertical-align: inherit;">make</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を実行</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">てコンパイルし（並列ビルドの</font><font style="vertical-align: inherit;">場合</font><font style="vertical-align: inherit;">は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-j4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-j8</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を追加</font><font style="vertical-align: inherit;">）、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flashで</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イメージをOdroid Goに書き込み、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニター</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">作成</font></strong><font style="vertical-align: inherit;">して</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステートメントからの出力を確認します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cmake hljs">make<font></font>
make flash<font></font>
make monitor</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1行で実行することもできます。</font></font><br>
<br>
<pre><code class="cmake hljs">make flash monitor</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果は特に印象的ではありませんが、プロジェクトの残りの部分の基礎になります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3c2/329/62f/3c232962f8e782c9220b25b7e3c0df5e.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP-IDFドキュメント：ビルドシステム</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeRTOSドキュメント：vTaskDelay</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート2：入力</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プレイヤーが押したボタンとOdroid Goの十字を読み取れるようにする必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボタン</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/106/142/ca2/106142ca2250eb9301215015b6f0bbad.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPIO</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Goには</font><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">選択</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開始</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メニュー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">音量の</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6つのボタンがあります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各ボタンは、個別の</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">汎用IO（GPIO）ピンに</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続されてい</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">GPIOピンは、入力（読み取り）または出力（書き込み）として使用できます。</font><font style="vertical-align: inherit;">ボタンの場合、読み取りが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、連絡先を入力として構成する必要があります。その後、それらのステータスを読み取ることができます。</font><font style="vertical-align: inherit;">内部の接点には2つの電圧（3.3Vまたは0V）のいずれかがありますが、IDF関数を使用してそれらを読み取ると、整数値に変換されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期化</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図で</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とマークされている要素</font><font style="vertical-align: inherit;">は、物理的なボタン自体です。押されていない場合、ESP32接点（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO13</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">など）は3.3 Vに接続されます。つまり、3.3 Vはボタンが</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">押されていない</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことを意味します</font><font style="vertical-align: inherit;">。ここでのロジックは、予想されるものの逆です。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO39に</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ボード上に物理的な抵抗があります。ボタンが押されていない場合、抵抗</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接点を高電圧に</font><strong><font style="vertical-align: inherit;">引き</font></strong><font style="vertical-align: inherit;">ます。ボタンが押されると、接点を</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">流れる</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電流が代わりにグランドに</font><strong><font style="vertical-align: inherit;">流れる</font></strong><font style="vertical-align: inherit;">ため、電圧0が接点から読み取られます</font><strong><font style="vertical-align: inherit;">IO13</font></strong><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO27</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO33</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP32の接点にはプルアップモード用に構成した内部抵抗があるため、抵抗はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを知って、GPIO APIを使用して6つのボタンを構成できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_A = GPIO_NUM_32;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_B = GPIO_NUM_33;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_START = GPIO_NUM_39;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_SELECT = GPIO_NUM_27;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_VOLUME = GPIO_NUM_0;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_MENU = GPIO_NUM_13;<font></font>
<font></font>
<span class="hljs-keyword">gpio_config_t</span> gpioConfig = {};<font></font>
<font></font>
gpioConfig.mode = GPIO_MODE_INPUT;<font></font>
gpioConfig.pull_up_en = GPIO_PULLUP_ENABLE;<font></font>
gpioConfig.pin_bit_mask =<font></font>
	  (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_A)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_B)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_START)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_SELECT)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_VOLUME)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_MENU);<font></font>
<font></font>
ESP_ERROR_CHECK(gpio_config(&amp;gpioConfig));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードの最初に指定された定数は、各回路接点に対応しています。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpio_config_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造体を使用して</font><font style="vertical-align: inherit;">、6つのボタンのそれぞれをプルアップ入力として構成します。以下の場合</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO13</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO27</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO33、</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我々はこれらの接点のプルアップ抵抗をオンにするためにIDFに依頼する必要があります。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO39</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我々は、彼らが物理的な抵抗を持っているので、これを行う必要はありませんが、我々は、設定を美しくするために、とにかくそれを行います。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_ERROR_CHECK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font><strong><font style="vertical-align: inherit;">esp_err_t</font></strong><font style="vertical-align: inherit;">を返すすべての関数の結果を自動的にチェックするIDFのヘルパーマクロ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ほとんどのIDF）、結果が</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_OK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と等しくないことを</font><strong><font style="vertical-align: inherit;">アサートし</font></strong><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">このマクロは、エラーが重大であり、実行を続行しても意味がない場合に、関数に使用すると便利です。</font><font style="vertical-align: inherit;">このゲームでは、入力のないゲームはゲームではないため、この説明は当てはまります。</font><font style="vertical-align: inherit;">このマクロをよく使用します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読書ボタン</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、すべての連絡先を構成し、最終的に値を読み取ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
番号ボタンは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpio_get_level</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数によって読み取られますが</font><font style="vertical-align: inherit;">、接点がプルアップされているため、受信した値を反転する必要があります。つまり、高信号は実際には「押されていない」ことを意味し、低信号は「押されている」ことを意味します。</font><font style="vertical-align: inherit;">反転は通常のロジックを保持します。1は「押された」、0-「押されていない」を意味します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> a = !gpio_get_level(BUTTON_PIN_A);
<span class="hljs-keyword">int</span> b = !gpio_get_level(BUTTON_PIN_B);
<span class="hljs-keyword">int</span> select = !gpio_get_level(BUTTON_PIN_SELECT);
<span class="hljs-keyword">int</span> start = !gpio_get_level(BUTTON_PIN_START);
<span class="hljs-keyword">int</span> menu = !gpio_get_level(BUTTON_PIN_MENU);
<span class="hljs-keyword">int</span> volume = !gpio_get_level(BUTTON_PIN_VOLUME);</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クロスピース（方向パッド）</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e8/d9e/a73/1e8d9ea7303257afd45846771726a275.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
十字の接続はボタンの接続とは異なります。</font><font style="vertical-align: inherit;">上ボタンと下ボタンは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アナログデジタルコンバーター（アナログデジタルコンバーター、ADC）の</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1つのピンに接続され</font><font style="vertical-align: inherit;">、左ボタンと右ボタンは別のADCピンに</font><font style="vertical-align: inherit;">接続さ</font><font style="vertical-align: inherit;">れます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの状態（高または低）のいずれかを読み取ることができるGPIOデジタル接点とは異なり、ADCは連続的なアナログ電圧（たとえば、0 Vから3.3 V）を離散的な数値（たとえば、0〜4095）に変換します。 ）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Goの設計者は、GPIOピンを節約するためにそれを行ったと思います（4つのデジタルピンではなく2つのアナログピンのみが必要です）。</font><font style="vertical-align: inherit;">いずれにせよ、これは構成とこれらの連絡先からの読み取りをわずかに複雑にします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接点</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35はスパイダーの</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y軸に接続され、接点</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><strong><font style="vertical-align: inherit;">スパイダーの</font></strong><font style="vertical-align: inherit;"> X軸に</font><strong><font style="vertical-align: inherit;">接続さ</font></strong><font style="vertical-align: inherit;">れます。十字の関節は数字ボタンよりも少し複雑であることがわかります。各軸には2つのスイッチ（</font><font style="vertical-align: inherit;">Y軸の場合は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、X軸の場合は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）があり、各</font><strong><font style="vertical-align: inherit;">スイッチ</font></strong><font style="vertical-align: inherit;">は一連の抵抗（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）に</font><font style="vertical-align: inherit;">接続されてい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「上」も「下」も押されない場合、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35ピンは</font></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を介してグラウンドにプルダウンされ</font><font style="vertical-align: inherit;">、値0 Vと見なされます。「左」も「右」も押されない場合は、</font><strong><font style="vertical-align: inherit;">IO34</font></strong><font style="vertical-align: inherit;">に連絡して</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ください。</font></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を介してグラウンドにプルダウンし、</font><font style="vertical-align: inherit;">値を0 Vまでカウントします</font><strong><font style="vertical-align: inherit;">。SW1 </font></strong><strong><font style="vertical-align: inherit;">が</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
押された</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（「上」）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で3.3 Vをカウントします</font><strong><font style="vertical-align: inherit;">。SW2 </font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">押された</font><strong><font style="vertical-align: inherit;">（「下」）</font></strong><font style="vertical-align: inherit;">場合、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で約1をカウントします。電圧の半分が抵抗</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2で</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">低下するため、65V </font><font style="vertical-align: inherit;">。</font><strong><font style="vertical-align: inherit;">SW3（「左」）が</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
押されると</font><font style="vertical-align: inherit;">、</font><strong><font style="vertical-align: inherit;">IO34</font></strong><font style="vertical-align: inherit;">で3.3 Vがカウントされます</font><strong><font style="vertical-align: inherit;">。SW4 </font></strong><strong><font style="vertical-align: inherit;">（「右」）が</font></strong><font style="vertical-align: inherit;">押されると</font><font style="vertical-align: inherit;">、</font><strong><font style="vertical-align: inherit;">IO34</font></strong><font style="vertical-align: inherit;">でも約1.65 Vがカウントされ</font><font style="vertical-align: inherit;">ます。これは</font><font style="vertical-align: inherit;">、抵抗</font><strong><font style="vertical-align: inherit;">R4の</font></strong><font style="vertical-align: inherit;">電圧が半分になるため</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">
どちらのケースも</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">分圧器の</font></a><font style="vertical-align: inherit;">例です</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">。</font></a></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">分圧器の2つの抵抗の抵抗が同じ場合（この場合は100K）、電圧降下は入力電圧の半分になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを知って、私たちはクロスピースを構成することができます：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">adc1_channel_t</span> DPAD_PIN_X_AXIS = ADC1_GPIO34_CHANNEL;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">adc1_channel_t</span> DPAD_PIN_Y_AXIS = ADC1_GPIO35_CHANNEL;<font></font>
<font></font>
ESP_ERROR_CHECK(adc1_config_width(ADC_WIDTH_BIT_12));<font></font>
ESP_ERROR_CHECK(adc1_config_channel_atten(DPAD_PIN_X_AXIS,ADC_ATTEN_DB_11));<font></font>
ESP_ERROR_CHECK(adc1_config_channel_atten(DPAD_PIN_Y_AXIS,ADC_ATTEN_DB_11));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ADCを12ビット幅に設定したため、0 Vは0として、3.3 Vは4095（2 ^ 12）として読み取られました。</font><font style="vertical-align: inherit;">減衰は、0 Vから3.3 Vの全電圧範囲を取得するために信号を減衰させる必要がないことを報告します。12 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビットでは、何も押されていない場合、上から左に押すと0が読み取られることが期待できます-4096、および右に押すと約2048が読み取られます（抵抗により電圧が半分になるため）。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クロスリーディング</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
十字を読むのはボタンより難しいです。なぜなら、私たちは生の値（0から4095まで）を読み取ってそれらを解釈する必要があるからです。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> ADC_POSITIVE_LEVEL = <span class="hljs-number">3072</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> ADC_NEGATIVE_LEVEL = <span class="hljs-number">1024</span>;<font></font>
<font></font>
<span class="hljs-keyword">uint32_t</span> dpadX = adc1_get_raw(DPAD_PIN_X_AXIS);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (dpadX &gt; ADC_POSITIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Left pressed</span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dpadX &gt; ADC_NEGATIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Right pressed</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">uint32_t</span> dpadY = adc1_get_raw(DPAD_PIN_Y_AXIS);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (dpadY &gt; ADC_POSITIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Up pressed</span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dpadY &gt; ADC_NEGATIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Down pressed</span>
}</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC_POSITIVE_LEVEL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC_NEGATIVE_LEVEL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はマージンのある値であり、常に正しい値を読み取るようにします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">投票</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボタンの値を取得するには、ポーリングまたは割り込みの2つのオプションがあります。入力処理関数を作成して、ボタンが押されたときにこれらの関数を呼び出すようにIDFに要求したり、必要なときにボタンの状態を手動でポーリングしたりできます。割り込み駆動の動作により、物事がより複雑になり、理解が困難になります。さらに、私は常にすべてを可能な限りシンプルにするよう努めています。必要に応じて、後で割り込みを追加できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6つのボタンと十字の4つの方向の状態を格納する構造を作成します。 10のブール値、10の整数、または10の符号なし整数の構造を作成できます。ただし、代わりに、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビットフィールド</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して構造を作成し</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>
{</span>
	<span class="hljs-keyword">uint16_t</span> a : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> b : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> volume : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> menu : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> select : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> start : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> left : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> right : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> up : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> down : <span class="hljs-number">1</span>;<font></font>
} Odroid_Input;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デスクトップシステム用にプログラミングする場合、ビットフィールドは別のマシンへの移植が不十分なため、通常は回避されますが、特定のマシン用にプログラミングするので、そのことを心配する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィールドの代わりに、合計サイズが10バイトの10個のブール値を持つ構造を使用できます。</font><font style="vertical-align: inherit;">別のオプションは</font><font style="vertical-align: inherit;">、個々のビットを設定、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリア</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、およびチェックできるビットシフトおよびビットマスキングマクロを</font><strong><font style="vertical-align: inherit;">備えた</font></strong><font style="vertical-align: inherit;"> 1つの</font><strong><font style="vertical-align: inherit;">uint16_t</font></strong><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">動作しますが、あまり美しくありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
単純なビットフィールドを使用すると、2バイトのデータと名前付きフィールドの両方のアプローチを利用できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、メインループ内の入力の状​​態をポーリングして、結果を表示できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
	Odroid_InitializeInput();<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		Odroid_Input input = Odroid_PollInput();<font></font>
<font></font>
		<span class="hljs-built_in">printf</span>(
			<span class="hljs-string">"\ra: %d  b: %d  start: %d  select: %d  vol: %d  menu: %d  up: %d  down: %d  left: %d  right: %d"</span>,<font></font>
			input.a, input.b, input.start, input.select, input.volume, input.menu,<font></font>
			input.up, input.down, input.left, input.right);<font></font>
<font></font>
		fflush(<span class="hljs-built_in">stdout</span>);<font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">250</span> / portTICK_PERIOD_MS);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
関数</font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">、新しい行を追加する代わりに、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ r</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して前の行を上書きします。</font><font style="vertical-align: inherit;">通常の状態では改行文字</font><strong><font style="vertical-align: inherit;">\ n</font></strong><font style="vertical-align: inherit;">によってリセットされるため、行を表示するに</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はfflushが</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要です</font><font style="vertical-align: inherit;">。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お使いのブラウザはHTML5ビデオをサポートしていません。</font></font><source src="https://austinmorlan.com/posts/embedded_game_programming_2/media/input.mp4" type="video/mp4"></video></div></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid Go Schematic</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP-IDFドキュメント：ADC</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP-IDFドキュメント：GPIO</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パート3：ディスプレイ</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Go LCDでピクセルをレンダリングできる必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LCDには頭脳があるため、画面に色を表示することは、入力ステータスを読み取るよりも困難になります。</font><font style="vertical-align: inherit;">画面は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ILI9341</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">によって制御されます</font><strong><font style="vertical-align: inherit;">-ILI9341-</font></strong><font style="vertical-align: inherit;">シングルチップ上の非常に人気のあるTFT LCDドライバー。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、LCDのピクセルを制御することによってコマンドに応答するILI9341と話しているのです。</font><font style="vertical-align: inherit;">この部分で「画面」または「ディスプレイ」と言うとき、私は実際にはILI9341を意味します。</font><font style="vertical-align: inherit;">ILI9341を扱っています。</font><font style="vertical-align: inherit;">LCDを制御します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LCDは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI（Serial Peripheral Interface）を</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介してESP32に接続されてい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SPIは、プリント基板上のデバイス間でデータを交換するために使用される標準プロトコルです。これには、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOSI（マスター</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力</font><strong><font style="vertical-align: inherit;">スレーブ入力）</font></strong><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISO（マスター入力スレーブ出力）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCK（クロック）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS（チップ選択）の</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4つの信号があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バス上の単一のマスターデバイスは、SCKとCSを制御してデータ転送を調整します。 1つのバス上に複数のデバイスがあり、それぞれに独自のCS信号があります。このデバイスのCS信号がアクティブになると、データを送受信できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP32がSPIマスター（マスター）になり、LCDがスレーブSPIスレーブになります。</font><font style="vertical-align: inherit;">必要なパラメーターでSPIバスを構成し、対応する接点を構成してLCDをバスに追加する必要があります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bc/60e/18c/7bc60e18c1b066ba7c22756464f92512.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f12/463/615/f124636158029efeab3259f299a2af36.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VSPI.XXXX</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は図の連絡先のラベルにすぎませ</font><strong><font style="vertical-align: inherit;">ん</font></strong><font style="vertical-align: inherit;">が、LCDとESP32の図の一部を見れば連絡先自体を確認できます。</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOSI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - &gt; VSPI.MOSI - &gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO23</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISO</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - &gt; VSPI.MISO - &gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO19</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - &gt; VSPI.SCK - &gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO18</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - &gt; VSPI.CS0 - &gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO5</font></font></strong></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我々はまた、持っている</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO14</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックライトをオンにするために使用されたGPIOピンである、とも</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO21</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に接続され、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">直流</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のピン</font><font style="vertical-align: inherit;">LCDを。この連絡先は、ディスプレイに送信する情報の種類を制御します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、SPIバスを構成します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_MISO = GPIO_NUM_19;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_MOSI = GPIO_NUM_23;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_SCLK = GPIO_NUM_18;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_CS = GPIO_NUM_5;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_DC = GPIO_NUM_21;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_BACKLIGHT = GPIO_NUM_14;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_WIDTH = <span class="hljs-number">320</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_HEIGHT = <span class="hljs-number">240</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_DEPTH = <span class="hljs-number">2</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">spi_bus_config_t</span> spiBusConfig = {};<font></font>
spiBusConfig.miso_io_num = LCD_PIN_MISO;<font></font>
spiBusConfig.mosi_io_num = LCD_PIN_MOSI;<font></font>
spiBusConfig.sclk_io_num = LCD_PIN_SCLK;<font></font>
spiBusConfig.quadwp_io_num = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Unused</span>
spiBusConfig.quadhd_io_num = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Unused</span><font></font>
spiBusConfig.max_transfer_sz = LCD_WIDTH * LCD_HEIGHT * LCD_DEPTH;<font></font>
<font></font>
ESP_ERROR_CHECK(spi_bus_initialize(VSPI_HOST, &amp;spiBusConfig, <span class="hljs-number">1</span>));</code></pre><br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_bus_config_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を使用してバスを構成します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">使用する連絡先と1回のデータ転送の最大サイズを伝達する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、すべてのフレームバッファーデータに対して1つのSPI送信を実行します。これは、LCDの幅（ピクセル単位）にその高さ（ピクセル単位）を掛けたものに、ピクセルあたりのバイト数を掛けたものです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幅は320、高さは240、色深度は2バイトです（ディスプレイはピクセルの色が16ビットであると想定しています）。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">spi_handle_t</span> gSpiHandle;<font></font>
<font></font>
<span class="hljs-keyword">spi_device_interface_config_t</span> spiDeviceConfig = {};<font></font>
spiDeviceConfig.clock_speed_hz = SPI_MASTER_FREQ_40M;<font></font>
spiDeviceConfig.spics_io_num = LCD_PIN_CS;<font></font>
spiDeviceConfig.queue_size = <span class="hljs-number">1</span>;<font></font>
spiDeviceConfig.flags = SPI_DEVICE_NO_DUMMY;<font></font>
<font></font>
ESP_ERROR_CHECK(spi_bus_add_device(VSPI_HOST, &amp;spiDeviceConfig, &amp;gSpiHandle));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バスを初期化したら、LCDデバイスをバスに追加して、バスとの通信を開始できるようにする必要があります。</font></font><br>
<br>
<ul>
<li><strong>clock_speed_hz</strong> —   - ,      SPI   40 ,     .        80 ,         .</li>
<li><strong>spics_io_num</strong> —    CS,  IDF     CS,        ( SD-     SPI).</li>
<li><strong>queue_size</strong> —     1,           (  ).</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -IDF SPIドライバーは通常、SPIデバイスからの読み取り中のタイミングの問題を回避するために送信に空のビットを挿入しますが、一方向送信を実行します（ディスプレイからは読み取りません）。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_DEVICE_NO_DUMMY</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、この一方向の送信を確認し、空のビットを挿入する必要がないことを報告します。</font></font></li>
</ul><br>
<br>
<pre><code class="cpp hljs">gpio_set_direction(LCD_PIN_DC, GPIO_MODE_OUTPUT);<font></font>
gpio_set_direction(LCD_PIN_BACKLIGHT, GPIO_MODE_OUTPUT);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ピンとバックライトピンをGPIOピンとして</font><font style="vertical-align: inherit;">設定する必要があり</font><font style="vertical-align: inherit;">ます。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DCを</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">切り替えた後</font><strong><font style="vertical-align: inherit;">、</font></strong><font style="vertical-align: inherit;">バックライトは常にオンになります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チーム</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LCDとの通信は、コマンドの形式です。</font><font style="vertical-align: inherit;">最初に、送信するコマンドを示すバイトを渡し、次にコマンドパラメータ（ある場合）を渡します。</font><font style="vertical-align: inherit;">ディスプレイは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信号が低い</font><font style="vertical-align: inherit;">場合、バイトがコマンドであることを理解します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">場合</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">直流</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信号がハイである場合、受信データは、以前に送信されたコマンドのパラメータを考えます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、ストリームは次のようになります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DCに</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">低い信号</font><font style="vertical-align: inherit;">を与えます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドの1バイトを送信します</font></font></li>
<li><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DCに</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高い信号</font><font style="vertical-align: inherit;">を与えます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドの要件に応じて、0バイト以上を送信します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順1〜4を繰り返す</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで私たちの親友は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ILI9341仕様</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">可能なすべてのコマンド、それらのパラメーター、およびそれらの使用方法がリストされています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68d/8d8/09c/68d8d809ceb9446142cd5c77bb78d0e2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメータのないコマンドの例は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Display ON</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">コマンドバイトは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x29</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ですが、パラメーターが指定されていません。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/35a/4e0/446/35a4e04466c22aa6746fe441f345c02f.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメータ付きのコマンドの例は、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列アドレスセット</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">コマンドバイトは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ですが、4つの必須パラメーターが指定されています。</font><font style="vertical-align: inherit;">このコマンドを使用するには、</font><font style="vertical-align: inherit;">低信号</font><font style="vertical-align: inherit;">を</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に送信し、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を送信し、</font><font style="vertical-align: inherit;">高信号</font><font style="vertical-align: inherit;">を</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DCに</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">送信してから</font><font style="vertical-align: inherit;">、4つのパラメーターのバイトを転送する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドコード自体は列挙で指定されます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span><font></font>
{<font></font>
	SOFTWARE_RESET = <span class="hljs-number">0x01</span>u,<font></font>
	SLEEP_OUT = <span class="hljs-number">0x11</span>u,<font></font>
	DISPLAY_ON = <span class="hljs-number">0x29</span>u,<font></font>
	COLUMN_ADDRESS_SET = <span class="hljs-number">0x2A</span>u,<font></font>
	PAGE_ADDRESS_SET = <span class="hljs-number">0x2B</span>u,<font></font>
	MEMORY_WRITE = <span class="hljs-number">0x2C</span>u,<font></font>
	MEMORY_ACCESS_CONTROL = <span class="hljs-number">0x36</span>u,<font></font>
	PIXEL_FORMAT_SET = <span class="hljs-number">0x3A</span>u,<font></font>
} CommandCode;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
代わりに、マクロ（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define SOFTWARE_RESET（0x01u）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">使用できます</font><font style="vertical-align: inherit;">が、デバッガーにはシンボルがなく、スコープもありません。</font><font style="vertical-align: inherit;">GPIOの連絡先で行ったように、整数の静的定数を使用することも可能ですが、列挙型のおかげで、関数または構造体のメンバーに渡されるデータが一目でわかります。これらの型は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandCode</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">型</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">それ以外の場合は、生の</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uint8_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">である</font><font style="vertical-align: inherit;">可能性があり</font><font style="vertical-align: inherit;">、コードを読み取っているプログラマに何も</font><strong><font style="vertical-align: inherit;">通知し</font></strong><font style="vertical-align: inherit;">ません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発売</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初期化中に、何かを描画できるようにさまざまなコマンドを渡すことができます。</font><font style="vertical-align: inherit;">各コマンドにはコマンドバイトがあり、これを</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドコード</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼び</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
配列を指定できるように、起動コマンドを格納するための構造を定義します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>
{</span><font></font>
	CommandCode code;<font></font>
	<span class="hljs-keyword">uint8_t</span> parameters[<span class="hljs-number">15</span>];
	<span class="hljs-keyword">uint8_t</span> length;<font></font>
} StartupCommand;</code></pre><br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はコマンドコードです。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parameters</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、コマンドパラメータ（存在する場合）の配列です。</font><font style="vertical-align: inherit;">これはサイズ15の静的配列です。これは、必要なパラメーターの最大数であるためです。</font><font style="vertical-align: inherit;">配列の静的な性質により、毎回コマンドごとに動的配列を割り当てることを心配する必要はありません。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">length</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配列内の</font><strong><font style="vertical-align: inherit;">パラメータの</font></strong><font style="vertical-align: inherit;">数</font><font style="vertical-align: inherit;">です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この構造を使用して、起動コマンドのリストを指定できます。</font></font><br>
<br>
<pre><code class="cpp hljs">StartupCommand gStartupCommands[] =<font></font>
{<font></font>
	<span class="hljs-comment">// Reset to defaults</span><font></font>
	{<font></font>
		SOFTWARE_RESET,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Landscape Mode</span>
	<span class="hljs-comment">// Top-Left Origin</span>
	<span class="hljs-comment">// BGR Panel</span><font></font>
	{<font></font>
		MEMORY_ACCESS_CONTROL,<font></font>
		{<span class="hljs-number">0x20</span> | <span class="hljs-number">0xC0</span> | <span class="hljs-number">0x08</span>},
		<span class="hljs-number">1</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// 16 bits per pixel</span><font></font>
	{<font></font>
		PIXEL_FORMAT_SET,<font></font>
		{<span class="hljs-number">0x55</span>},
		<span class="hljs-number">1</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Exit sleep mode</span><font></font>
	{<font></font>
		SLEEP_OUT,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Turn on the display</span><font></font>
	{<font></font>
		DISPLAY_ON,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメーターのないコマンド（例：</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOFTWARE_RESET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）は、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメーター</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期化子リストを</font><font style="vertical-align: inherit;">空（つまり1つのゼロ）に設定し、長さを0に設定します。パラメーターを持つコマンドは、パラメーターを入力して長さを指定します。</font><font style="vertical-align: inherit;">長さを自動的に設定し、数値を書き込まない場合（ミスをした場合やパラメーターが変更された場合など）は素晴らしいことですが、問題を起こす価値はないと思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのチームの目的は、2つを除いて名前から明らかです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORY_ACCESS_CONTROL</font></font></strong><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">横向き</font><strong><font style="vertical-align: inherit;">モード：</font></strong><font style="vertical-align: inherit;">デフォルトでは、ディスプレイは縦向き（240x320）を使用しますが、横向き（320x240）を使用します。</font></font></li>
<li><strong>Top-Left Origin:</strong>      (0,0)     ,    ( )         .</li>
<li><strong>BGR Panel:</strong>  ,        BGR.   ,    , ,   ,     .</li>
</ul><br>
<strong>PIXEL_FORMAT_SET</strong><br>
<br>
<ul>
<li><strong>16 bits per pixel:</strong>   16- .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ガンマなど、さまざまな側面を制御するために起動時に送信できるコマンドは他にもたくさんあります。必要なパラメーターは、LCD自体（ILI9341コントローラーではなく）の仕様に記載されており、アクセスできません。これらのコマンドを送信しない場合は、デフォルトの表示設定が使用され、完全に適しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一連の起動コマンドを準備したら、それらをディスプレイに転送し始めることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、1バイトのコマンドをディスプレイに送信する関数が必要です。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DCに</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">低信号</font><font style="vertical-align: inherit;">を送信する必要があるため、コマンドの送信はパラメーターの送信とは異なることを忘れないでください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BYTES_TO_BITS(value) ( (value) * 8 )</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCommandCode</span><span class="hljs-params">(CommandCode code)</span>
</span>{
	<span class="hljs-keyword">spi_transaction_t</span> transaction = {};<font></font>
<font></font>
	transaction.length = BYTES_TO_BITS(<span class="hljs-number">1</span>);<font></font>
	transaction.tx_data[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">uint8_t</span>)code;<font></font>
	transaction.flags = SPI_TRANS_USE_TXDATA;<font></font>
<font></font>
	gpio_set_level(LCD_PIN_DC, <span class="hljs-number">0</span>);<font></font>
	spi_device_transmit(gSpiHandle, &amp;transaction);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDFには</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_transaction_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造体</font><font style="vertical-align: inherit;">があり、SPIバスを介して何かを転送したいときにこの</font><font style="vertical-align: inherit;">構造体を設定し</font><font style="vertical-align: inherit;">ます。ペイロードのビット数を把握し、負荷自体を転送します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペイロードへのポインターを渡すか</font><font style="vertical-align: inherit;">、サイズがわずか4バイト</font><font style="vertical-align: inherit;">の内部struct </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造</font><font style="vertical-align: inherit;">体を使用できますが</font><font style="vertical-align: inherit;">、ドライバーが外部メモリにアクセスする必要が</font><strong><font style="vertical-align: inherit;">なくなり</font></strong><font style="vertical-align: inherit;">ます。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用する場合は</font><font style="vertical-align: inherit;">、フラグ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_TRANS_USE_TXDATAを</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定する必要があり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを送信する前に、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DCに</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">低信号</font><font style="vertical-align: inherit;">を送信して、</font><font style="vertical-align: inherit;">これがコマンドコードであることを示します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCommandParameters</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span>* data, <span class="hljs-keyword">int</span> length)</span>
</span>{
	<span class="hljs-keyword">spi_transaction_t</span> transaction = {};<font></font>
<font></font>
	transaction.length = BYTES_TO_BITS(length);<font></font>
	transaction.tx_buffer = data;<font></font>
	transaction.flags = <span class="hljs-number">0</span>;<font></font>
<font></font>
	gpio_set_level(LCD_PIN_DC, <span class="hljs-number">1</span>);<font></font>
	spi_device_transmit(SPIHANDLE, &amp;transaction);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメータの受け渡しはコマンドの送信に似ていますが、今回は独自のバッファ（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を使用し、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に高信号</font><font style="vertical-align: inherit;">を送信し</font><font style="vertical-align: inherit;">て、パラメータが送信されていることをディスプレイに伝えます。</font><font style="vertical-align: inherit;">さらに、</font><font style="vertical-align: inherit;">独自のバッファを渡すため</font><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_TRANS_USE_TXDATA</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フラグを設定しません</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、すべての起動コマンドを送信できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ARRAY_COUNT(value) ( sizeof(value) / sizeof(value[0]) )</span><font></font>
<font></font>
<span class="hljs-keyword">int</span> commandCount = ARRAY_COUNT(gStartupCommands);<font></font>
<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> commandIndex = <span class="hljs-number">0</span>; commandIndex &lt; commandCount; ++commandIndex)<font></font>
{<font></font>
	StartupCommand* command = &amp;gStartupCommands[commandIndex];<font></font>
<font></font>
	SendCommandCode(command-&gt;code);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (command-&gt;length &gt; <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		SendCommandData(command-&gt;parameters, command-&gt;length);<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
起動コマンドの配列を繰り返し走査し、最初にコマンドコードを渡し、次にパラメーター（ある場合）を渡します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フレーム描画</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
表示を初期化した後、描画を開始できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UPPER_BYTE_16(value) ( (value) &gt;&gt; 8u )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOWER_BYTE_16(value) ( (value) &amp; 0xFFu )</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Odroid_DrawFrame</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span>* buffer)</span>
</span>{
	<span class="hljs-comment">// Set drawing window width to (0, LCD_WIDTH)</span>
    <span class="hljs-keyword">uint8_t</span> drawWidth[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, UPPER_BYTE_16(LCD_WIDTH), LOWER_BYTE_16(LCD_WIDTH) };<font></font>
	SendCommandCode(COLUMN_ADDRESS_SET);<font></font>
	SendCommandParameters(drawWidth, ARRAY_COUNT(drawWidth));<font></font>
<font></font>
	<span class="hljs-comment">// Set drawing window height to (0, LCD_HEIGHT)</span>
    <span class="hljs-keyword">uint8_t</span> drawHeight[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, UPPER_BYTE_16(LCD_HEIGHT), LOWER_BYTE_16(LCD_HEIGHT) };<font></font>
	SendCommandCode(PAGE_ADDRESS_SET);<font></font>
	SendCommandParameters(drawHeight, ARRAY_COUNT(drawHeight));<font></font>
<font></font>
	<span class="hljs-comment">// Send the buffer to the display</span><font></font>
	SendCommandCode(MEMORY_WRITE);<font></font>
	SendCommandParameters(buffer, LCD_WIDTH * LCD_HEIGHT * LCD_DEPTH);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ILI9341には、画面の個々の部分を再描画する機能があります。これは、フレームレートの低下に気付いた場合に、将来的に役立つでしょう。この場合、画面の変更された部分のみを更新することができますが、今のところは、画面全体をもう一度再描画するだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フレームをレンダリングするには、レンダリングウィンドウを設定する必要があります。これを行うには</font><font style="vertical-align: inherit;">、ウィンドウ幅を指定した</font><strong><font style="vertical-align: inherit;">COLUMN_ADDRESS_SET</font></strong><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">とウィンドウ高さを</font><strong><font style="vertical-align: inherit;">指定</font></strong><font style="vertical-align: inherit;">し</font><font style="vertical-align: inherit;">た</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PAGE_ADDRESS_SET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンド</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">送信</font><font style="vertical-align: inherit;">します。各コマンドは、レンダリングを実行するウィンドウを表す4バイトのパラメーターを受け取ります。</font><strong><font style="vertical-align: inherit;">UPPER_BYTE_16</font></strong><font style="vertical-align: inherit;">および</font><strong><font style="vertical-align: inherit;">LOWER_BYTE_16</font></strong></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br>
<strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-これらは、16ビット値から上位バイトと下位バイトを抽出するための補助マクロです。</font><font style="vertical-align: inherit;">これらのコマンドのパラメーターでは、16ビット値を2つの8ビット値に分割する必要があるため、これを行います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レンダリングは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORY_WRITE</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドによって開始され、</font><strong><font style="vertical-align: inherit;">一度に</font></strong><font style="vertical-align: inherit;">フレームバッファーのすべて</font><font style="vertical-align: inherit;">の</font><strong><font style="vertical-align: inherit;">153,600</font></strong><font style="vertical-align: inherit;">バイトをディスプレイに送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フレームバッファをディスプレイに転送する方法は他にもあります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPIトランザクションの調整を担当する別のFreeRTOSタスク（タスク）を作成できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つのフレームではなく、複数のトランザクションでフレームを転送できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノンブロッキング送信を使用できます。この場合、送信が開始され、その後、他の操作を続行します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上記の方法を任意に組み合わせて使用​​できます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
とりあえず、最も単純な方法、つまり唯一のブロッキングトランザクションを使用します。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DrawFrameが</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出されると、</font><font style="vertical-align: inherit;">ディスプレイへの転送が開始され、転送が完了するまでタスクが一時停止します。</font><font style="vertical-align: inherit;">後でこの方法で適切なフレームレートを達成できないことがわかった場合は、この問題に戻ります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565とバイト順</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
典型的なディスプレイ（たとえば、コンピューターのモニター）のビット深度は24ビット（160万色）で、赤、緑、青ごとに8ビットです。ピクセルは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RRRRRRRRGGGGGGGGGBBBBBBBBB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">としてメモリに書き込まれます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid LCDのビット深度は16ビット（65,000色）です。5ビットの赤、6ビットの緑、5ビットの青です。ピクセルは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RRRRRGGGGGGGBBBBB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">としてメモリに書き込まれます</font><font style="vertical-align: inherit;">。このフォーマットは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれ</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAP_ENDIAN_16(value) ( (((value) &amp; 0xFFu) <span class="hljs-meta-string">&lt;&lt; 8u) | ((value) &gt;&gt; 8u)  )</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RGB565(red, green, blue) ( SWAP_ENDIAN_16( ((red) &lt;&lt; 11u) | ((green) &lt;&lt; 5u) | (blue) ) )</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RGB565形式で色を作成するマクロを定義します。 1バイトの赤、1バイトの緑、1バイトの青を渡します。彼は赤の上位5ビット、緑の上位6ビット、青の上位5ビットを取得します。ハイビットを選択したのは、ロービットよりも多くの情報が含まれているためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ESP32はデータを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リトルエンディアン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">順</font><font style="vertical-align: inherit;">で格納します。つまり、最下位バイトは下位メモリアドレスに格納されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、32ビット値</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[0xDE 0xAD 0xBE 0xEF]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[0xEF 0xBE 0xAD 0xDE]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">としてメモリに格納されます</font><font style="vertical-align: inherit;">。データをディスプレイに転送するとき、最下位バイトが最初に送信され、LCDが最上位バイトを最初に受信することを期待するため、これは問題になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マクロ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SWAP_ENDIAN_16を設定します。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイトをスワップし、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マクロで使用し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、RGB565で3つの原色のそれぞれがどのように記述されるか、およびバイト順を変更しない場合にESP32メモリに格納される方法です。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">赤</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
11111 | 000000 | 00000？-&gt; 11111000 00000000-&gt; 00000000 11111000 </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">緑</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
00000 | 111111 | 00000？-&gt; 00000111 11100000-&gt; 11100000 00000111 </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">青</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
00000 | 000000 | 11111？-&gt; 00000000 00011111-&gt; 00011111 00000000</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シンプルなデモを作成して、LCDの動作を観察できます。</font><font style="vertical-align: inherit;">フレームの先頭で、フレームバッファーを黒にフラッシュし、50x50の正方形を描画します。</font><font style="vertical-align: inherit;">四角で正方形を移動し、ボタン</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開始で</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その色を変更できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
	Odroid_InitializeInput();<font></font>
	Odroid_InitializeDisplay();<font></font>
<font></font>
	ESP_LOGI(LOG_TAG, <span class="hljs-string">"Odroid initialization complete - entering main loop"</span>);<font></font>
<font></font>
	<span class="hljs-keyword">uint16_t</span>* framebuffer = (<span class="hljs-keyword">uint16_t</span>*)heap_caps_malloc(<span class="hljs-number">320</span> * <span class="hljs-number">240</span> * <span class="hljs-number">2</span>, MALLOC_CAP_DMA);<font></font>
	assert(framebuffer);<font></font>
<font></font>
	<span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">int</span> y = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">uint16_t</span> color = <span class="hljs-number">0xffff</span>;<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		<span class="hljs-built_in">memset</span>(framebuffer, <span class="hljs-number">0</span>, <span class="hljs-number">320</span> * <span class="hljs-number">240</span> * <span class="hljs-number">2</span>);<font></font>
<font></font>
		Odroid_Input input = Odroid_PollInput();<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.left) { x -= <span class="hljs-number">10</span>; }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.right) { x += <span class="hljs-number">10</span>; }<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.up) { y -= <span class="hljs-number">10</span>; }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.down) { y += <span class="hljs-number">10</span>; }<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.a) { color = RGB565(<span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.b) { color = RGB565(<span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>); }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.start) { color = RGB565(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>); }<font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> row = y; row &lt; y + <span class="hljs-number">50</span>; ++row)<font></font>
		{<font></font>
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> col = x; col &lt; x + <span class="hljs-number">50</span>; ++col)<font></font>
			{<font></font>
				framebuffer[<span class="hljs-number">320</span> * row + col] = color;<font></font>
			}<font></font>
		}<font></font>
<font></font>
		Odroid_DrawFrame(framebuffer);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディスプレイのフルサイズ（320 x 240、ピクセルあたり2バイト（16ビットカラー））に従ってフレームバッファーを割り当てます。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heap_caps_malloc</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">してメモリに割り当てられるため、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Direct Memory Access（DMA）を</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用したSPIトランザクションに使用できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">DMAにより、SPIペリフェラルは、CPUの関与なしでフレームバッファーにアクセスできます。</font><font style="vertical-align: inherit;">DMAがない場合、SPIトランザクションにははるかに長い時間がかかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画面の境界の外でレンダリングが発生しないことを確認するチェックは実行しません。</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お使いのブラウザはHTML5ビデオをサポートしていません。</font></font><source src="https://austinmorlan.com/posts/embedded_game_programming_3/media/demo.mp4" type="video/mp4"></video></div></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
強い引き裂きが目立ちます。デスクトップアプリケーションでは、ティアリングを解消する標準的な方法は、複数のバッファを使用することです。たとえば、ダブルバッファリングの場合、フロントバッファとリアバッファの2つのバッファがあります。フロントバッファが表示されている間は</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、後方</font><font style="vertical-align: inherit;">から記録されます</font><font style="vertical-align: inherit;">。その後、彼らは場所を変えて、プロセスが繰り返されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP32には、2つのフレームバッファーを格納するためのDMA機能を持つ十分なRAMがないため（残念ながら、4 MBの外部SPI RAMにはDMA機能がありません）、このオプションは適していません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ILI9341には、</font><strong><font style="vertical-align: inherit;">VBLANK</font></strong><font style="vertical-align: inherit;">が発生し</font><strong><font style="vertical-align: inherit;">た</font></strong><font style="vertical-align: inherit;">ことを</font><strong><font style="vertical-align: inherit;">通知</font></strong><font style="vertical-align: inherit;">する信号（</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TE</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）があり</font><font style="vertical-align: inherit;">、描画されるまでディスプレイに書き込むことができます。しかし、Odroid（またはディスプレイモジュール）では、この信号は接続されていないため、アクセスできません。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらくまともな値が見つかるかもしれませんが、今のところは行いません。今のタスクは、単にピクセルを画面に表示することです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのソースコードは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">継続：ドライブ、バッテリー、サウンド</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid Go Schematic</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遊びに行きます</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP-IDFドキュメント：SPIマスター</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LCDドライバーデータシート</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja502518/index.html">木に登る方法</a></li>
<li><a href="../ja502520/index.html">製品分析に関するmitapレポートのビデオレポート</a></li>
<li><a href="../ja502522/index.html">内部に小さな変圧器を備えたガルバニック絶縁チップを開きます</a></li>
<li><a href="../ja502524/index.html">サイコは文明を作る</a></li>
<li><a href="../ja502526/index.html">JUG Ru Group＃2オンラインストリームウィーク</a></li>
<li><a href="../ja502532/index.html">IT部門（部門）の革命。必要ですか？</a></li>
<li><a href="../ja502536/index.html">MIUI 12の第一印象と主な機能</a></li>
<li><a href="../ja502538/index.html">NGINX Ingress Controllerの古いバージョンをビルドしてパッチを適用する方法</a></li>
<li><a href="../ja502540/index.html">Alpine.js-デートを続ける</a></li>
<li><a href="../ja502542/index.html">Yandexが質問に答え、ユーザーを1日2万時間節約できるように指導する方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>