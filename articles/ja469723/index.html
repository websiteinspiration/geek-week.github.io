<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📡 💙 🚋 Yandex.CloudとPythonのサーバーレス関数でAliceのステートフルスキルを作成する 🏛️ 😩 🤦🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ニュースから始めましょう。Yandex.Cloudは昨日、サーバーレスコンピューティングサービスYandex Cloud Functionsのリリースを発表しました。つまり、サービスのコード（Webアプリケーションやチャットボットなど）のみを記述し、クラウド自体が仮想マシンを作成および維持します。仮...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Yandex.CloudとPythonのサーバーレス関数でAliceのステートフルスキルを作成する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469723/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニュースから始めましょう。</font><font style="vertical-align: inherit;">Yandex.Cloudは昨日、サーバーレスコンピューティングサービス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex Cloud Functionsの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リリースを発表しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">つまり、サービスのコード（Webアプリケーションやチャットボットなど）のみを記述し、クラウド自体が仮想マシンを作成および維持します。仮想マシンは、開始時に仮想マシンを作成し、維持し、負荷が増加した場合はそれらを複製します。</font><font style="vertical-align: inherit;">まったく考える必要がなく、とても便利です。</font><font style="vertical-align: inherit;">そして、料金は計算中にのみ行きます。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ただし、一部がまったく支払いません。</font><font style="vertical-align: inherit;">これらは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アリスの外部スキルの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発者</font><font style="vertical-align: inherit;">、つまり彼女に組み込まれたチャットボットです。</font><font style="vertical-align: inherit;">開発者は誰でもそのようなスキルを記述、ホスト、登録できます。今日から、スキルをホストする必要すらありません。コードを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常にサーバーレスな関数の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形でクラウドにアップロードするだけ</font><font style="vertical-align: inherit;">です。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、いくつかのニュアンスがあります。</font><font style="vertical-align: inherit;">まず第一に、あなたのペットのコードはある種の依存関係を必要とするかもしれません、そしてそれらをクラウドに引っ張ることは簡単ではありません。</font><font style="vertical-align: inherit;">次に、通常のチャットボットはどこかに対話の状態を保存する必要があります（したがって、ステートフル）。</font><font style="vertical-align: inherit;">サーバーレス機能でこれを最も簡単に行う方法は？</font><font style="vertical-align: inherit;">第3に、アリスまたはゼロ以外のプロットを持つある種のボットのスキルをすばやく、汚い方法で書くにはどうすればよいでしょうか。</font><font style="vertical-align: inherit;">これらのニュアンスについては、実際には記事です。</font></font></p><br>
<img src="https://habrastorage.org/webt/zw/u9/xd/zwu9xdyjusoxljngms6bjjz02cq.png" alt="画像"><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">道徳的な訓練</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">せっかちな場合：関数をクラウドにアップロードする前に必要な依存関係をメイクファイルで収集し、ダイアログの状態をYandex Object Storage（S3 APIをサポート）に保存し、ダイアログを管理するために独自の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tgalice</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリを使用します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">結果は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのような</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモスキルです。</font><font style="vertical-align: inherit;">そして、これをもう少し詳しく分析します。</font></font></p><br>
<p>   :        ,      .  ,   -,        ;  —  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>.     .</p><br>
<p>   ,     ,   '<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  " "</a>'.     :</p><br>
<p>: !     " ".  "",  ,    .<br>
: <br>
: ,   <br>
: <br>
:      .   ,  .<br>
: <br>
: ,   .     —  .<br>
: 2002<br>
: !     .<br>
: <br>
: ! ,      —  ,     .<br>
: 18<br>
: , !   :  17 ,   .   , , !   : <code>   ,  ,  .</code></p><br>
<p>  ,              ,       .           , .. .              .   -  .   Object Storage,         . (..  ).      , ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a> - .   Object Storage (   S3),   Mongo    .</p><br>
<p>  —      Object Storage,   MongoDB,        ,  -  ,     Yandex Functions     .      .   (   heroku), ,  ,  -    ,      (make-). </p><br>
<h3>  -</h3><br>
<ol>
<li>:   -   .  ,  Windows , ,  ,    make-   .    ,    Python   3.6.</li>
<li>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a>. </li>
<li>  .: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://cloud.yandex.ru</a></li>
<li>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Object Storage</a>,     <code>{BUCKET NAME}</code>  <code>tgalice-test-cold-storage</code> (       <code>main.py</code>  ).       ,  —    .</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>,    <code>editor</code>,       <code>{KEY ID}</code>  <code>{KEY VALUE}</code> —       .   ,    .       .. -, ,   ,   — .</li>
<li>( )  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a> <code>yc</code>.      -,  CLI  ,       .</li>
<li> , ,   :          <code>make all</code>.    ( ,  , )   <code>dist</code>. </li>
<li>   Object Storage (  <code>{BUCKET NAME}</code>)      <code>dist.zip</code>.  ,       , ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">AWS CLI</a>.</li>
<li>    -    <code>yc</code>.       :</li>
</ol><br>
<pre><code class="plaintext hljs">yc serverless function version create\<font></font>
    --function-name=horoscope\<font></font>
    --environment=AWS_ACCESS_KEY_ID={KEY ID},AWS_SECRET_ACCESS_KEY={KEY VALUE}\<font></font>
    --runtime=python37\<font></font>
    --package-bucket-name={BUCKET NAME}\<font></font>
    --package-object-name=dist.zip\<font></font>
    --entrypoint=main.alice_handler\<font></font>
    --memory=128M\<font></font>
    --execution-timeout=3s</code></pre><br>
<p>       . </p><br>
<p>        ,      . </p><br>
<p><img src="https://habrastorage.org/webt/ux/f9/d3/uxf9d3wqso088fktufbfmsoumh8.jpeg"></p><br>
<h3>   </h3><br>
<p>Make-                  <code>dist.zip</code>,  :</p><br>
<pre><code class="plaintext hljs">mkdir -p dist/<font></font>
pip3 install -r requirements.txt --target dist/ <font></font>
cp main.py dist/main.py<font></font>
cp form.yaml dist/form.yaml<font></font>
cd dist &amp;&amp; zip --exclude '*.pyc' -r ../dist.zip ./*</code></pre><br>
<p> —   ,    <code>tgalice</code>.        <code>form.yaml</code>:</p><br>
<pre><code class="plaintext hljs">form_name: 'horoscope_form'<font></font>
start:<font></font>
  regexp: '|(|)'<font></font>
  suggests:<font></font>
    - <font></font>
fields:<font></font>
  - name: 'name'<font></font>
    question: ,   .<font></font>
  - name: 'year'<font></font>
    question:      .   ,  .<font></font>
    validate_regexp: '^[0-9]{4}$'<font></font>
    validate_message: ,   .     -  .<font></font>
  - name: 'month'<font></font>
    question: !     .<font></font>
    options:<font></font>
      - <font></font>
     ...<font></font>
      - <font></font>
    validate_message: ,   ,    . ,    ,   .<font></font>
  - name: 'day'<font></font>
    question: ! ,      -  ,     .<font></font>
    validate_regexp: '[0123]?\d$'<font></font>
    validate_message: ,   .       (, );     .</code></pre><br>
<p>             </p><br>
<pre><code class="plaintext hljs">class CheckableFormFiller(tgalice.dialog_manager.form_filling.FormFillingDialogManager):<font></font>
    SIGNS = {<font></font>
        '': '',<font></font>
        ...<font></font>
    }<font></font>
<font></font>
    def handle_completed_form(self, form, user_object, ctx):<font></font>
        response = tgalice.dialog_manager.base.Response(<font></font>
            text=', {}!   :  {} ,   {}. \n'<font></font>
                 '  , , !   : {}'.format(<font></font>
                form['fields']['name'],<font></font>
                2019 - int(form['fields']['year']),<font></font>
                self.SIGNS[form['fields']['month']],<font></font>
                random.choice(FORECASTS),<font></font>
            ),<font></font>
            user_object=user_object,<font></font>
        )<font></font>
        return response</code></pre><br>
<p>,   <code>FormFillingDialogManager</code>   "",     <code>handle_completed_form</code> ,  ,   .</p><br>
<p>        ,       ""       "".    <code>tgalice</code>   ,       :</p><br>
<pre><code class="plaintext hljs">dm = tgalice.dialog_manager.CascadeDialogManager(<font></font>
    tgalice.dialog_manager.GreetAndHelpDialogManager(<font></font>
        greeting_message=DEFAULT_MESSAGE,<font></font>
        help_message=DEFAULT_MESSAGE,<font></font>
        exit_message=' ,    " " !'<font></font>
    ),<font></font>
    CheckableFormFiller(`form.yaml`, default_message=DEFAULT_MESSAGE)<font></font>
)</code></pre><br>
<p><code>CascadeDialogManager</code>  :           ,    . </p><br>
<p>           <code>Response</code>,       ,        —    ;        ,   .       , <code>DialogConnector</code>,        Yandex Functions  :</p><br>
<pre><code class="plaintext hljs">...<font></font>
session = boto3.session.Session()<font></font>
s3 = session.client(<font></font>
    service_name='s3',<font></font>
    endpoint_url='https://storage.yandexcloud.net',<font></font>
    aws_access_key_id=os.environ['AWS_ACCESS_KEY_ID'],<font></font>
    aws_secret_access_key=os.environ['AWS_SECRET_ACCESS_KEY'],<font></font>
    region_name='ru-central1',<font></font>
)<font></font>
storage = tgalice.session_storage.S3BasedStorage(s3_client=s3, bucket_name='tgalice-test-cold-storage')<font></font>
connector = tgalice.dialog_connector.DialogConnector(dialog_manager=dm, storage=storage)<font></font>
alice_handler = connector.serverless_alice_handler</code></pre><br>
<p> ,        S3- Object Storage.     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  tgalice</a>.<br>
    <code>alice_handler</code> —  ,     .,    <code>--entrypoint=main.alice_handler</code>. </p><br>
<p>, ,  . Make-  , S3- Object Storage   ,    <code>tgalice</code>.              .</p><br>
<p>  ,     <code>tgalice</code>?   ,  JSON'           ,   .     ,    ,  ""   "",   NLU  .   ,     ,        yaml-,      . </p><br>
<p>    NLU,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Rasa</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">DeepPavlov</a>,         ,   serverless.     ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Aimylogic</a>.  tgalice,    -  . ,    .</p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   </a>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>!</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja469703/index.html">通常のアバロニア</a></li>
<li><a href="../ja469707/index.html">Scalaと連動するようにVSCodeを構成する</a></li>
<li><a href="../ja469709/index.html">Blitz Engine＆Battle Prime：ECSとネットワークコード</a></li>
<li><a href="../ja469717/index.html">光を輝かせて</a></li>
<li><a href="../ja469721/index.html">Dell OptiPlex 7070 Ultra：モニターをモノブロック化するモジュラーコンピューター</a></li>
<li><a href="../ja469725/index.html">ヒッチハイカーのための太陽系ガイド</a></li>
<li><a href="../ja469731/index.html">IRO.Mvc.MvcExceptionHandlerを使用したASP.NET例外の処理</a></li>
<li><a href="../ja469733/index.html">ラジコンカー：初めての購入-シャーシとパワートレイン</a></li>
<li><a href="../ja469735/index.html">任意の正の数からn次の根を計算するアルゴリズム</a></li>
<li><a href="../ja469737/index.html">木製おもちゃ、パート5-1991</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>