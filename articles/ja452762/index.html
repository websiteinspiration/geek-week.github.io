<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍣 🍰 👲🏼 MVCC-7。自動洗浄 👩🏿‍💼 🤲🏼 🐞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="分離に関する質問から始め、データを低レベルで整理することについて余談を述べ、行のバージョンとバージョンからスナップショットを取得する方法について詳しく説明しました。
 
 次に、ページ内のクリーニング（およびHOTの更新）、定期的なクリーニングを検討しましたが、今日は自動クリーニングについて説明しま...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>MVCC-7。自動洗浄</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/452762/"><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分離</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関する質問から始め、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データを低レベルで整理すること</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">について余談</font><font style="vertical-align: inherit;">を述べ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、行のバージョン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とバージョンから</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スナップショット</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を取得する方法</font><font style="vertical-align: inherit;">について詳しく説明</font><font style="vertical-align: inherit;">しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ページ内のクリーニング</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（およびHOTの更新）、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定期的なクリーニング</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を検討しましたが、今日は自動クリーニングについて説明します。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動クリーニング（autovacuum）</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはすでに、通常の状態での通常のクリーニング（誰も長期間トランザクションの範囲を保持していない場合）がその作業に対処する必要があると述べました。問題は、それをどのくらいの頻度で呼び出すかです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更するテーブルをあまり頻繁にクリーンアップしないと、必要以上に大きくなります。さらに、次のクリーニングでは、あまりにも多くの変更が蓄積されている場合、インデックスを数回通過することがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頻繁にテーブルをクリアすると、サーバーは有用な作業の代わりに、常にメンテナンスに従事します-これも良くありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
負荷は時間とともに変化する可能性があるため、定期的にスケジュールされたクリーニングを開始しても問題は解決しないことに注意してください。テーブルがより頻繁に更新され始めた場合は、より頻繁にクリーンアップする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動クリーニングは、テーブルの変更のアクティビティに応じて、クリーニングを開始できるまさにそのメカニズムです。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動クリーニングが</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
有効になっている場合（</font><em><font style="vertical-align: inherit;">autovacuum</font></em><font style="vertical-align: inherit;">構成パラメーター</font><font style="vertical-align: inherit;">）、autovacuumランチャープロセスが常にシステムに存在し、機能する予定です。autovacuumワーカーのワークプロセスは実際のクリーニングに関与し、そのいくつかのインスタンスは並行して機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動バキュームランチャープロセスは、アクティビティが存在するデータベースのリストをコンパイルします。アクティビティは統計情報によって決定され、収集するには、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">track_counts</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータを設定する必要があります</font><font style="vertical-align: inherit;">。</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">track_countsを</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オフにしないでください。オフに</font><em><font style="vertical-align: inherit;">する</font></em><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">、</font><em><font style="vertical-align: inherit;">自動</font></em><em><font style="vertical-align: inherit;">クリーニング</font></em><font style="vertical-align: inherit;">が機能しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一回</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_naptime</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動バキュームランチャープロセスは、リスト内の各データベースのワークフローを（ポストマスタープロセスを使用して）開始します。</font><font style="vertical-align: inherit;">つまり、データベースにアクティビティがある場合、ワークフローは</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_naptime</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の間隔でデータベースに入ります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを行うには、いくつかのアクティブなデータベース（N個）がある場合、ワークプロセスは</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_naptimeの</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N倍の頻度で</font><em><font style="vertical-align: inherit;">起動され</font></em><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ただし、同時に動作するワークフローの総数は、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_max_workers</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータによって制限されます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ワークフローが開始されると、ワークフローは指定されたデータベースに接続し、リストを作成して開始します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリーンアップが必要なすべてのテーブル、マテリアライズドビュー、トーストテーブル</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析が必要なすべてのテーブルとマテリアライズド表現（トーストテーブルは常にインデックスでアクセスされるため、分析されません）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、ワークフローは、選択されたオブジェクトをクリーンアップおよび/または分析し、クリーンアップが完了すると終了します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスが</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_naptime</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">意図されたすべての作業を完了していない場合、</font><font style="vertical-align: inherit;">autovacuumランチャープロセスは同じデータベースに別のワークフローを送信し、それらは一緒に動作します。</font><font style="vertical-align: inherit;">「一緒に」とは、2番目のプロセスがテーブルのリストを作成し、それに従うことを意味します。</font><font style="vertical-align: inherit;">したがって、異なるテーブルは並行して処理されますが、1つのテーブルのレベルでは並列処理は行われません。一方のワークプロセスがすでにテーブルで機能している場合、もう一方はスキップして先に進みます。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並列処理の必要性について長い間議論されてきましたが、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッチ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はまだ採用されていません。</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、「クリーニングが必要」と「分析が必要」の意味を詳しく見てみましょう。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリーニングが必要なテーブル</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「デッド」、つまり無関係なバージョンのストリングの数が設定されたしきい値を超える場合、クリーニングが必要であると考えられています。</font><font style="vertical-align: inherit;">無効なバージョンの数は、統計コレクターによって常に収集され、pg_stat_all_tablesテーブルに保存されます。</font><font style="vertical-align: inherit;">また、しきい値は2つのパラメータによって設定されます。</font></font><br>
<br>
<ul>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_threshold</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、絶対値（個数）を定義します。</font></font></li>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_scale_factor</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、テーブルの行の比率を決定します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最終的な式は次のとおりです</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。pg_stat_all_tables.n_dead_tup</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &gt; = </font><em><font style="vertical-align: inherit;">autovacuum_vacuum_threshold</font></em><font style="vertical-align: inherit;"> + </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_scale_factor</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> * pg_class.reltupesの</font><font style="vertical-align: inherit;">場合、クリーニングが必要です</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルト設定では、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_threshold</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 50および</font></font><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_scale_factor</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 0.2に</font><font style="vertical-align: inherit;">設定されています</font><font style="vertical-align: inherit;">。もちろん、ここでの主なパラメータは</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_scale_factorです</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -大きなテーブルで重要なのは彼です（つまり、起こり得る問題がテーブルに関連付けられています）。 20％の値は非常に過大に見積もられているようで、おそらく大幅に減らす必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適なパラメーター値は、サイズと変更の性質に応じて、テーブルごとに異なる場合があります。</font><font style="vertical-align: inherit;">全体として適切な値を確立し、必要に応じて、ストレージパラメータを使用して、いくつかのテーブルのレベルで特別な方法でパラメータを設定することは理にかなっています。</font></font><br>
<br>
<ul>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_threshold</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toast.autovacuum_vacuum_threshold</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></li>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_scale_factor</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toast.autovacuum_vacuum_scale_factor</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
混乱しないようにするために、これは、変更の量または強度によって特に目立つ少数のテーブルに対してのみ、かつグローバルに設定された値が適切でない場合にのみ行う必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、自動クリーニングをテーブルレベルで無効にすることができます（ただし、これが必要になる理由を考えるのは困難です）。</font></font><br>
<br>
<ul>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_enabled</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toast.autovacuum_enabled</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、前回、自動クリーニングを無効にしてvacテーブルを作成し、デモ目的で手動クリーニングを管理しました。</font><font style="vertical-align: inherit;">ストレージパラメータは次のように変更できます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> vac <span class="hljs-keyword">SET</span> (autovacuum_enabled = <span class="hljs-keyword">off</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のすべてを形式化するには、現在クリーンアップする必要があるテーブルを示すビューを作成します。</font><font style="vertical-align: inherit;">テーブルレベルでオーバーライドできる場合、パラメーターの現在の値を返す関数を使用します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> get_value(param <span class="hljs-type">text</span>, reloptions <span class="hljs-type">text</span>[], relkind "char")
<span class="hljs-keyword">RETURNS</span> <span class="hljs-type">float</span>
<span class="hljs-keyword">AS</span> $$<span class="pgsql">
  <span class="hljs-keyword">SELECT</span> coalesce(
    <span class="hljs-comment">--    ,   </span>
    (<span class="hljs-keyword">SELECT</span> option_value
     <span class="hljs-keyword">FROM</span>   pg_options_to_table(reloptions)
     <span class="hljs-keyword">WHERE</span>  option_name = <span class="hljs-keyword">CASE</span>
              <span class="hljs-comment">--  toast-   </span>
              <span class="hljs-keyword">WHEN</span> relkind = <span class="hljs-string">'t'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'toast.'</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-string">''</span>
            <span class="hljs-keyword">END</span> || param
    ),
    <span class="hljs-comment">--     </span>
    current_setting(param)
  )::<span class="hljs-type">float</span>;
$$</span> <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">sql</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてここにビューがあります：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> need_vacuum <span class="hljs-keyword">AS</span>
  <span class="hljs-keyword">SELECT</span> st.schemaname || <span class="hljs-string">'.'</span> || st.relname tablename,<font></font>
         st.n_dead_tup dead_tup,<font></font>
         get_value(<span class="hljs-string">'autovacuum_vacuum_threshold'</span>, c.reloptions, c.relkind) +<font></font>
         get_value(<span class="hljs-string">'autovacuum_vacuum_scale_factor'</span>, c.reloptions, c.relkind) * c.reltuples<font></font>
         max_dead_tup,<font></font>
         st.last_autovacuum<font></font>
  <span class="hljs-keyword">FROM</span>   pg_stat_all_tables st,<font></font>
         pg_class c<font></font>
  <span class="hljs-keyword">WHERE</span>  c.oid = st.relid
  <span class="hljs-keyword">AND</span>    c.relkind <span class="hljs-keyword">IN</span> (<span class="hljs-string">'r'</span>,<span class="hljs-string">'m'</span>,<span class="hljs-string">'t'</span>);
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析が必要なテーブル</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動分析では、状況はほぼ同じです。</font><font style="vertical-align: inherit;">pg_stat_all_tables.n_mod_since_analyze&gt; =：分析は、行の（最後の分析以降）に変更バージョンの数は、2つの同様のパラメータで設定された閾値を超えているため、これらのテーブルのために必要であると考えられる</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_analyze_threshold</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> + </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_analyze_scale_factor</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> * pg_class.reltupesを。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトの</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動分析</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定は少し異なります：</font><em><font style="vertical-align: inherit;">autovacuum_analyze_threshold</font></em><font style="vertical-align: inherit;"> = 50および</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_analyze_scale_factor</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 0.1。</font><font style="vertical-align: inherit;">また、個々のテーブルのストレージパラメータのレベルで定義することもできます。</font></font><br>
<br>
<ul>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_analyze_threshold</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></li>
<li><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_analyze_scale_factor</font></font></em></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トーストテーブルは分析されないため、対応するパラメーターはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析用のビューを作成しましょう：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> need_analyze <span class="hljs-keyword">AS</span>
  <span class="hljs-keyword">SELECT</span> st.schemaname || <span class="hljs-string">'.'</span> || st.relname tablename,<font></font>
         st.n_mod_since_analyze mod_tup,<font></font>
         get_value(<span class="hljs-string">'autovacuum_analyze_threshold'</span>, c.reloptions, c.relkind) +<font></font>
         get_value(<span class="hljs-string">'autovacuum_analyze_scale_factor'</span>, c.reloptions, c.relkind) * c.reltuples<font></font>
         max_mod_tup,<font></font>
         st.last_autoanalyze<font></font>
  <span class="hljs-keyword">FROM</span>   pg_stat_all_tables st,<font></font>
         pg_class c<font></font>
  <span class="hljs-keyword">WHERE</span>  c.oid = st.relid
  <span class="hljs-keyword">AND</span>    c.relkind <span class="hljs-keyword">IN</span> (<span class="hljs-string">'r'</span>,<span class="hljs-string">'m'</span>);
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験では、次のパラメータ値を設定します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> autovacuum_naptime = ‘<span class="hljs-number">1</span>s’; <span class="hljs-comment">--    </span>
=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> autovacuum_vacuum_scale_factor = <span class="hljs-number">0.03</span>;  <span class="hljs-comment">-- 3%</span>
=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> autovacuum_vacuum_threshold = <span class="hljs-number">0</span>;<font></font>
=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> autovacuum_analyze_scale_factor = <span class="hljs-number">0.02</span>; <span class="hljs-comment">-- 2%</span>
=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> autovacuum_analyze_threshold = <span class="hljs-number">0</span>;
</code></pre><pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pg_reload_conf();
</code></pre><pre><code class="plaintext hljs"> pg_reload_conf<font></font>
----------------<font></font>
 t<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、前回使用したのと同様のテーブルを作成し、そこに1000行を挿入します。</font><font style="vertical-align: inherit;">自動クリーニングはテーブルレベルで無効になっているため、自分でオンにします。</font><font style="vertical-align: inherit;">これを行わないと、自動クリーニングが間違ったタイミングで機能する可能性があるため、例は再現できません。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> autovac(<font></font>
  id <span class="hljs-type">serial</span>,<font></font>
  s <span class="hljs-type">char</span>(<span class="hljs-number">100</span>)<font></font>
) <span class="hljs-keyword">WITH</span> (autovacuum_enabled = <span class="hljs-keyword">off</span>);<font></font>
=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> autovac <span class="hljs-keyword">SELECT</span> g.id,<span class="hljs-string">'A'</span> <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>,<span class="hljs-number">1000</span>) g(id);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クリーニングに対する私たちの見解は次のとおりです。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> need_vacuum <span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'public.autovac'</span>;
</code></pre><pre><code class="plaintext hljs">   tablename    | dead_tup | max_dead_tup | last_autovacuum <font></font>
----------------+----------+--------------+-----------------<font></font>
 public.autovac |        0 |            0 | <font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意すべき点が2つあります。</font><font style="vertical-align: inherit;">まず、max_dead_tup = 0ですが、1000行の3％は30行です。</font><font style="vertical-align: inherit;">実際のところ、INSERTはそれ自体を更新しないため、テーブルに関する統計はまだありません。</font><font style="vertical-align: inherit;">テーブルが分析されるまで、pg_class.reltuples = 0なのでゼロは残ります。しかし、分析のために2番目のビューを見てみましょう：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> need_analyze <span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'public.autovac'</span>;
</code></pre><pre><code class="plaintext hljs">   tablename    | mod_tup | max_mod_tup | last_autoanalyze <font></font>
----------------+---------+-------------+------------------<font></font>
 public.autovac |    1000 |           0 | <font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルが1000行を変更（追加）し、これがゼロより大きいため、自動分析が機能するはずです。</font><font style="vertical-align: inherit;">これをチェックして：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> autovac <span class="hljs-keyword">SET</span> (autovacuum_enabled = <span class="hljs-keyword">on</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し間を置いた後、テーブルが分析され、max_mod_tupのゼロの代わりに正しい20行が表示されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> need_analyze <span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'public.autovac'</span>;
</code></pre><pre><code class="plaintext hljs">   tablename    | mod_tup | max_mod_tup |       last_autoanalyze        <font></font>
----------------+---------+-------------+-------------------------------<font></font>
 public.autovac |       0 |          20 | 2019-05-21 11:59:48.465987+03<font></font>
(1 row)<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> reltuples, relpages <span class="hljs-keyword">FROM</span> pg_class <span class="hljs-keyword">WHERE</span> relname = <span class="hljs-string">'autovac'</span>;
</code></pre><pre><code class="plaintext hljs"> reltuples | relpages <font></font>
-----------+----------<font></font>
      1000 |       17<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動クリーニングに戻る：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> need_vacuum <span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'public.autovac'</span>;
</code></pre><pre><code class="plaintext hljs">   tablename    | dead_tup | max_dead_tup | last_autovacuum<font></font>
----------------+----------+--------------+-----------------<font></font>
 public.autovac |        0 |           30 |<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、Max_dead_tupはすでに修正されています。注意すべき2番目のポイントは、dead_tup = 0です。統計は、テーブルに行の無効なバージョンがないことを示しています...これはtrueです。テーブルにはまだクリーンアップするものはありません。したがって、追加専用モードでのみ使用されるテーブルはクリアされないため、可視性マップは更新されません。これにより、インデックススキャンのみを使用することができなくなります（インデックスのみのスキャン）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（次回に、遅かれ早かれクリーニングが追加専用テーブルに到達することがわかりますが、これが発生することは非常にまれです。）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際の結論：インデックススキャンのみを使用することが重要な場合は、手動クリーニングを呼び出す必要がある場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、自動クリーニングを再びオフにして、31行を更新します-しきい値よりも1つ多くなります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> autovac <span class="hljs-keyword">SET</span> (autovacuum_enabled = <span class="hljs-keyword">off</span>);<font></font>
=&gt; <span class="hljs-keyword">UPDATE</span> autovac <span class="hljs-keyword">SET</span> s = <span class="hljs-string">'B'</span> <span class="hljs-keyword">WHERE</span> id &lt;= <span class="hljs-number">31</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> need_vacuum <span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'public.autovac'</span>;
</code></pre><pre><code class="plaintext hljs">   tablename    | dead_tup | max_dead_tup | last_autovacuum <font></font>
----------------+----------+--------------+-----------------<font></font>
 public.autovac |       31 |           30 | <font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、自動クリーニングのトリガー条件が満たされました。</font><font style="vertical-align: inherit;">自動クリーニングをオンにすると、しばらくすると、テーブルが処理されたことがわかります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> autovac <span class="hljs-keyword">SET</span> (autovacuum_enabled = <span class="hljs-keyword">on</span>);<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> need_vacuum <span class="hljs-keyword">WHERE</span> tablename = <span class="hljs-string">'public.autovac'</span>;
</code></pre><pre><code class="plaintext hljs">   tablename    | dead_tup | max_dead_tup |        last_autovacuum        <font></font>
----------------+----------+--------------+-------------------------------<font></font>
 public.autovac |        0 |           30 | 2019-05-21 11:59:52.554571+03<font></font>
(1 row)<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">負荷制御</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クリーニングはページごとに機能するため、他のプロセスをブロックしませんが、それでもシステムに負荷をかけ、パフォーマンスに顕著な影響を与える可能性があります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常のクリーニングの規制</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クリーニングの強度を制御できるようにするために、システムへの影響を制御するために、プロセスは作業と期待の間で切り替わります。クリーニングは</font><font style="vertical-align: inherit;">、従来の作業単位の</font><font style="vertical-align: inherit;">およそ</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_limitを</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行し</font><font style="vertical-align: inherit;">、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_delay</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;msで</font><font style="vertical-align: inherit;">スリープ状態に</font><em><font style="vertical-align: inherit;">なり</font></em><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルト設定では、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_limit</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 200、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_delay</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 0が</font><font style="vertical-align: inherit;">設定されています</font><font style="vertical-align: inherit;">。最後のゼロは、実際には（通常の）クリーニングがスリープ状態にならないことを意味するため、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_limit</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の特定の値は</font><font style="vertical-align: inherit;">何の役割も果たしません。これは、管理者が手動でVACUUMを起動する必要がある場合、おそらくできるだけ早くクリーンアップを実行したいという理由で行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、スリープ時間をまだ設定している場合は、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_limit</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作業量は、バッファキャッシュ内のページを処理するコストで構成されます。</font><font style="vertical-align: inherit;">各ページアクセスは次のように評価されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファーキャッシュでページが見つかった場合、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_page_hit</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 1;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">見つからない場合、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_page_miss</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 10;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それが見つからず、ダーティページをバッファから押し出す必要がある場合は、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_page_dirty</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 20です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、</font><font style="vertical-align: inherit;">デフォルト</font><font style="vertical-align: inherit;">の</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_limit</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定で</font><font style="vertical-align: inherit;">は、キャッシュから200ページ、ディスクから20ページ、または押し出し付きの10ページを一度に処理できます。</font><font style="vertical-align: inherit;">これらは条件付きの数値であることは明らかですが、より正確に選択することは意味がありません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動洗浄の規制</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動洗浄中の負荷制御は、通常の洗浄と同様に機能します。ただし、手動</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリーニング</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クリーニングを異なる強度で機能させるために</font><font style="vertical-align: inherit;">、</font><em><font style="vertical-align: inherit;">自動</font></em><font style="vertical-align: inherit;">プロセスには独自のパラメーター</font><em><font style="vertical-align: inherit;">autovacuum_vacuum_cost_limit</font></em><font style="vertical-align: inherit;">および</font><em><font style="vertical-align: inherit;">autovacuum_vacuum_cost_delayがあり</font></em><font style="vertical-align: inherit;">ます。これらのパラメータの値が-1の場合、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_limit</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および/または</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_delayの</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font><em><font style="vertical-align: inherit;">が使用され</font></em><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_cost_limit</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = -1（つまり、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vacuum_cost_limit</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 200 </font><font style="vertical-align: inherit;">の値が使用されます</font><font style="vertical-align: inherit;">）および</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_cost_delay</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> = 20ms。これらの数値を持つ最新の機器では、自動クリーニングは非常にゆっくりと機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バージョン12では、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_vacuum_cost_delay</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の値は</font><font style="vertical-align: inherit;">2msに減少します。これは、より適切な最初の近似と見なすことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、これらのパラメーターによって設定された制限はすべてのワークプロセスに共通であることに注意してください。</font><font style="vertical-align: inherit;">つまり、同時に動作するワークプロセスの数を変更しても、総負荷は一定のままです。</font><font style="vertical-align: inherit;">したがって、タスクが</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動クリーニングの</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンスを向上させることである場合、ワークフローを追加するときは、</font><em><font style="vertical-align: inherit;">autovacuum_vacuum_cost_limitを</font></em><font style="vertical-align: inherit;">増やす価値が</font><em><font style="vertical-align: inherit;">あり</font></em><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリ使用量と監視</font></font></h2><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我々が使用するメモリサイズの掃除のように、見えた</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のmaintenance_work_mem</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">清掃するストレージ識別子の行バージョンを。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動クリーニングもまったく同じです。ただし</font><font style="vertical-align: inherit;">、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_max_workers</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に大きな値</font><font style="vertical-align: inherit;">を設定すると、多数の同時プロセスが発生する可能性があり</font><font style="vertical-align: inherit;">ます。さらに、すべてのメモリが即座に完全に割り当てられ、必要ではありません。したがって、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動クリーニング</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワークフローでは、</font><em><font style="vertical-align: inherit;">autovacuum_work_mem</font></em><font style="vertical-align: inherit;">パラメーターを使用して独自の制限を設定できます</font><font style="vertical-align: inherit;">。デフォルトでは、このパラメーターは-1です。つまり、使用されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに述べたように、クリーニングは最小限のメモリで機能します。しかし、インデックスがテーブルに作成される場合、小さな値</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenance_work_mem</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、インデックスの再スキャンを引き起こす可能性があります。自動クリーニングについても同様です。理想的には、</font><font style="vertical-align: inherit;">繰り返されるスキャンが発生しない</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum_work_memの</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最小値を選択する必要</font><font style="vertical-align: inherit;">があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クリーニングを監視するために、VERBOSEパラメーター（ただし、自動クリーニングには指定できない）またはpg_stat_progress_vacuumビュー（ただし、現在の情報のみを表示）を使用できることがわかりました。したがって、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動クリーンアップ</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を監視する主な方法は</font><em><font style="vertical-align: inherit;">log_autovacuum_min_duration</font></em><font style="vertical-align: inherit;">パラメータ</font><font style="vertical-align: inherit;">で、サーバーのメッセージログに情報を表示します。デフォルトではオフです（-1に設定）。このパラメーターを有効にし（値0の場合、すべての自動クリーニングの開始に関する情報が表示されます）、理由を確認する理由があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力は次のようになります。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> log_autovacuum_min_duration = <span class="hljs-number">0</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> pg_reload_conf();
</code></pre><pre><code class="plaintext hljs"> pg_reload_conf <font></font>
----------------<font></font>
 t<font></font>
(1 row)<font></font>
</code></pre><br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">UPDATE</span> autovac <span class="hljs-keyword">SET</span> s = <span class="hljs-string">'C'</span> <span class="hljs-keyword">WHERE</span> id &lt;= <span class="hljs-number">31</span>;
</code></pre><br>
<pre><code class="plaintext hljs">student$ tail -n 7 /var/log/postgresql/postgresql-11-main.log
</code></pre><pre><code class="plaintext hljs">2019-05-21 11:59:55.675 MSK [9737] LOG:  automatic vacuum of table "test.public.autovac": index scans: 0<font></font>
	pages: 0 removed, 18 remain, 0 skipped due to pins, 0 skipped frozen<font></font>
	tuples: 31 removed, 1000 remain, 0 are dead but not yet removable, oldest xmin: 4040<font></font>
	buffer usage: 78 hits, 0 misses, 0 dirtied<font></font>
	avg read rate: 0.000 MB/s, avg write rate: 0.000 MB/s<font></font>
	system usage: CPU: user: 0.00 s, system: 0.00 s, elapsed: 0.00 s<font></font>
2019-05-21 11:59:55.676 MSK [9737] LOG:  automatic analyze of table "test.public.autovac" system usage: CPU: user: 0.00 s, system: 0.00 s, elapsed: 0.00 s<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要な情報はすべてここにあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、メモリのサイズを増やすのではなく、一度に処理されるデータが少なくなるようにクリーニングのしきい値を下げる必要があることを思い出してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のビューを使用してクリーンアップする必要があるテーブルのリストの長さを監視することも意味があります。</font><font style="vertical-align: inherit;">リストの長さが長くなると、自動クリーニングには作業を行う時間がなく、設定を変更する必要があることを示します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">続くこと</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452750/index.html">OpenLiteSpeed内外のNextcloud：リバースプロキシの構成</a></li>
<li><a href="../ja452752/index.html">自家製ビッグデータ。パート1. AWSクラスターでのSparkストリーミングの実践</a></li>
<li><a href="../ja452754/index.html">最も人気のあるDockerイメージの19％にrootパスワードがない</a></li>
<li><a href="../ja452756/index.html">Unityでタワーディフェンスを作成する：敵</a></li>
<li><a href="../ja452760/index.html">ビタミンD。飲むか飲まないか、それが問題です。（または、私が処方されていない分析にどのように合格したかについての物語）</a></li>
<li><a href="../ja452764/index.html">[ピーター]セルゲイメルニコフとJUG.ruとの出会い-超光速のプロファイリング：理論と実践</a></li>
<li><a href="../ja452766/index.html">プログレッシブストリーミングテクノロジー、またはフリーズなしでネットワーク経由で4kビデオを視聴する方法</a></li>
<li><a href="../ja452768/index.html">海外進出を決意した場合の商品デザイン</a></li>
<li><a href="../ja452772/index.html">Goの5つの高度なテスト手法</a></li>
<li><a href="../ja452774/index.html">Dell XPS 13 9380：本格的なビジネス向けの信頼性が高く非常にコンパクトなノートパソコン</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>