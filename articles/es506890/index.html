<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçü§ù‚Äçüë®üèø üë®üèø‚Äçüéì üë≥üèø Huevo de Pascua en ionCube: ¬øun intento de los desarrolladores de barrer la basura debajo de la alfombra? üñ±Ô∏è üíÖüèæ ‚öìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un desarrollador web sabe que los scripts creados con fines comerciales pueden dar un paseo por la red con derechos de autor sobrescritos; Es posible ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Huevo de Pascua en ionCube: ¬øun intento de los desarrolladores de barrer la basura debajo de la alfombra?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/506890/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/kc/lp/mo/kclpmoxrvrfvypeaomwmvyezwhu.jpeg"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un desarrollador web sabe que los scripts creados con fines comerciales pueden dar un paseo por la red con derechos de autor sobrescritos; </font><font style="vertical-align: inherit;">Es posible que el script comience a revenderse en nombre de otra persona. </font><font style="vertical-align: inherit;">Para ocultar el c√≥digo fuente del script y evitar su cambio, se utilizan ofuscadores, minificadores, etc. </font><font style="vertical-align: inherit;">Una de las herramientas m√°s antiguas y famosas para cifrar scripts en PHP es ionCube. </font><font style="vertical-align: inherit;">Introducido en 2002, contin√∫a monitoreando el desarrollo de PHP y declara soporte para las √∫ltimas versiones de la plataforma. </font><font style="vertical-align: inherit;">Como mostrar√© en este art√≠culo, ionCube est√° lejos de estar bien con el soporte de PHP 7 ...</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El modelo para usar encriptadores PHP es tal que el programador vende un script encriptado, y el comprador del script debe instalar un m√≥dulo de extensi√≥n en su servidor que permita la ejecuci√≥n de los scripts encriptados. </font><font style="vertical-align: inherit;">El script encriptado por ionCube se parece a esto:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">//0059b</span>
<span class="hljs-comment">// 10.2 72</span>
<span class="hljs-comment">// </span>
<span class="hljs-comment">// IONCUBE ONLINE ENCODER EVALUATION</span>
<span class="hljs-comment">// THIS FILE IS LICENSED TO BE USED FOR ENCODER TESTING</span>
<span class="hljs-comment">// PURPOSES ONLY AND SHOULD NOT BE DISTRIBUTED</span>
<span class="hljs-comment">// </span>
<span class="hljs-keyword">if</span>(!extension_loaded(<span class="hljs-string">'ionCube Loader'</span>)){$__oc=strtolower(substr(php_uname(),<span class="hljs-comment">//skipped</span><font></font>
<font></font>
<span class="hljs-meta">?&gt;</span><font></font>
HR+cPn5yR+EksbFLjyZwm7EQh7Q0Y6YO6pLddgsuLRlBWUC5JWhAm3KcPBcRdP9D0zkMmdPNk5VG<font></font>
rMP1GxIwsA5NinHkQjWqG2pHL5nIZUvatUW+XMas3Knjf4wz9+DJoq47N1qZLDXwVzpOOupqa+Y4<font></font>
k8PPXt8WNYXL4gbJnVu6NrqBqqwOrtlHUE9Sc30fMfAAEDTAVfa7ADHT2egTb5xxy9RGlDCjGlma<font></font>
RxoL1LvxvYcfe48f44x/H+GVTM7dPaYyy9DozcJjt3l8EDxcD73d67cWOtDgQGixQEmBlYJO7Cvh<font></font>
IAfeCBywIrDMgWfCC80uEIX+WtSmt/PuI7OXMgsNG3yVZu2HXJvXFRmXvc6748uxr+Zh0uZnAqeL<font></font>
pkJB5K9H5qbMr4YM/Aig+<span class="hljs-number">7</span>MhwVG3KJ0kQCEhKxJe7+<span class="hljs-number">7</span>Un/jSGcwQ8HKa/<span class="hljs-number">90</span>ePzH2EXazm3T87pf2<font></font>
hXL/exl4L7hutt/MfDGjculaEOCaoDLlUJjJqeXJL3kFDUsiPFfEL/BwAYUqe2pJAMjWXn7YIUt7<font></font>
Y1DdTUD4ob/<span class="hljs-number">5</span>fwE9wQwfG6PfDLPFkrGVKFpkBa95sRuA7qgtXATacXAVzsfYMxZgbwF3RcI5IxQo<font></font>
HTgnCg57vWmM/u6swJrgkz+<span class="hljs-number">747</span>DWZRS1TfJZnKbdbmWIHAW11HG2FloKdWWSIronfqnuXTI/j2/R
<span class="hljs-number">9</span>hX1Uim6mQowBwjS5zHZY8WFU9xE1KgETkCTsaDZODg9NYTICKs5aAdujzAtzxLWSicHZCfmpgzd<font></font>
FRhqYTYE1B9wktZsItkssDaq+xlyTZ+<span class="hljs-number">0</span>LGnXAC6eaH7npS7w3NRBRj9ySVTRYPXBraVuJViMIX+U
<span class="hljs-number">4</span>IzHJDFSNiT818GtS7erlLKcbGn4OZ40Ee3XEiicFzVrOfOvH0rJT3LZgVqY+KMtjqaQike2P4Dd<font></font>
A0SOuqOlFgQitYoo</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los usuarios </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">han notado durante mucho tiempo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que cuando se carga el m√≥dulo ionCube Loader, aparecen dos funciones globales con nombres muy extra√±os en PHP: </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;y </font></font><code>_dyuweyrj4r</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si llama a una de estas funciones, PHP imprimir√° uno de los dos aforismos chinos y completar√° la ejecuci√≥n: </font><font style="vertical-align: inherit;">
se puede ver que la l√≠nea de salida no depende de la funci√≥n llamada y se selecciona al azar. </font><font style="vertical-align: inherit;">
Surge la pregunta: ¬øpor qu√© se necesitan estas funciones y qu√© hacen?</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(); echo 'Hmm..';"</b><br>
A rat who gnaws at a cat's tail invites destruction.<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(); echo 'Hmm..';"</b><br>
Do good, reap good; do evil, reap evil.<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4r(); echo 'Hmm..';"</b><br>
Do good, reap good; do evil, reap evil.</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Experimentos simples</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, veamos qu√© par√°metros </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toma: </font><font style="vertical-align: inherit;">
parece que toma dos n√∫meros, pero no importa qu√© n√∫meros imprima los mismos aforismos.</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(1,2,3);"</b><br>
PHP Warning: _dyuweyrj4() expects at most 2 parameters, 3 given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4('foo', 'bar');"</b><br>
PHP Warning: _dyuweyrj4() expects parameter 1 to be int, string given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(1, 'bar');"</b><br>
PHP Warning: _dyuweyrj4() expects parameter 2 to be int, string given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(1, 2);"</b><br>
A rat who gnaws at a cat's tail invites destruction.</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√∫squeda de uso</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En un foro indonesio fangoso, logro encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un ejemplo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que estaba repleto en 2013 </font><font style="vertical-align: inherit;">&nbsp;, muy probablemente, obtenido por alg√∫n desensamblador de c√≥digo de bytes PHP:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tconnect</span>(<span class="hljs-params"> </span>)
</span>{<font></font>
    $__tmp = _dyuweyrj4( <span class="hljs-number">21711392</span>, <span class="hljs-number">920173696</span> );
    <span class="hljs-keyword">return</span> $__tmp[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tvariable</span>(<span class="hljs-params"> </span>)
</span>{<font></font>
    $__tmp = _dyuweyrj4( <span class="hljs-number">21720496</span>, <span class="hljs-number">920165136</span> );
    <span class="hljs-keyword">return</span> $__tmp[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© es interesante en pares de n√∫meros (21711392, 920173696) y (21720496, 920165136)? </font><font style="vertical-align: inherit;">Un investigador atento notar√° que el XOR de los n√∫meros en cada par da 932443808. Intentemos llamar </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un par de n√∫meros que dan el resultado de XOR 932443808: ¬° </font><font style="vertical-align: inherit;">
No se imprimi√≥ nada!</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(0, 932443808);"</b></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(932443808, 0);"</b></code><br>
<br>
<img src="https://habrastorage.org/webt/ap/ed/c8/apedc8vzemybnk6fcmzhfj3tiwu.png"><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zambullirse en el depurador</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/kz/cy/_i/kzcy_i1kqfmexamdktae0lwhuuu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que se est√° intentando leer en la direcci√≥n </font></font><code>[ecx+40h]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, adem√°s, </font></font><code>ecx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;es igual </font></font><code>0x3793f6a0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;al n√∫mero que pasamos a la funci√≥n. Esto significa que la funci√≥n espera recibir el valor de la direcci√≥n en la memoria de proceso de PHP como par√°metro, y </font></font><code>[ecx+40h]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;agregar√° uno </font><font style="vertical-align: inherit;">a la palabra d en la direcci√≥n </font><font style="vertical-align: inherit;">(el comando </font></font><code>inc dword ptr [eax]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;es visible justo debajo del punto de cach√©). Intentemos pasar esa direcci√≥n: para esto, prestamos atenci√≥n a que la direcci√≥n en la que se carga el m√≥dulo php.exe principal no cambie hasta que Windows se reinicie. En mi caso lo es </font></font><code>0x00980000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Al abrir php.exe en la IDA, observamos qu√© datos est√°n disponibles para reescribir: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/04/v4/fo/04v4foanwlcng6m_k0xopymi4ja.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
como experimento, intentemos reescribir el primer puntero en la estructura </font></font><code>cli_sapi_module</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Hay un enlace a √©l desde </font></font><code>main+22</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; al descargar php.exe en la direcci√≥n, </font></font><code>0x00980000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;este enlace se ubicar√° en</font></font><code>0x00982d63</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Entonces, </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;necesitamos pasar un valor </font><font style="vertical-align: inherit;">a la funci√≥n </font><font style="vertical-align: inherit;">que sea menor </font></font><code>0x40</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es decir </font></font><code>0x00982d23</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
Crash de nuevo; pero en otra funci√≥n dentro de ioncube_loader_win_7.3.dll. M√°s interesante a√∫n, la direcci√≥n en la que se ley√≥ el puntero nulo </font><font style="vertical-align: inherit;">&nbsp;- no tiene nada que ver con el valor pasado a la funci√≥n. (Es ir√≥nico que la comprobaci√≥n del puntero nulo - </font><font style="vertical-align: inherit;">&nbsp;se realice inmediatamente </font><b><font style="vertical-align: inherit;">despu√©s de</font></b><font style="vertical-align: inherit;"> &nbsp;acceder a este puntero). Despu√©s de mirar la memoria en la direcci√≥n </font><font style="vertical-align: inherit;">, encontramos la estructura all√≠ </font><font style="vertical-align: inherit;">, es decir. definici√≥n de la funci√≥n Es m√°s conveniente mirar dentro de √©l a trav√©s de la Ventana Inmediata: </font><font style="vertical-align: inherit;">
como puede ver, el puntero nulo que caus√≥ el bloqueo es el campo </font><font style="vertical-align: inherit;">&nbsp;en la definici√≥n de la funci√≥n</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(0x00982d23, 0x00982d23 ^ 0x3793f6a0);"</b></code><br>
<br>
<img src="https://habrastorage.org/webt/kq/vd/n7/kqvdn7plaxnkhddfyucx_ktd_jk.png"><br>
<br><font style="vertical-align: inherit;"></font><code>0x14c32820+0x78</code><font style="vertical-align: inherit;"></font><code>test ebx, ebx</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>0x14c32820</code><font style="vertical-align: inherit;"></font><code>_zend_op_array</code><font style="vertical-align: inherit;"></font><br>
<br>
<code><b>(_zend_op_array*)0x14c32820</b><br>
0x14c32820 {type=0x01 '\x1' arg_flags=0x14c32821 "" fn_flags=0x00000100 ...}<br>
&nbsp; &nbsp; type: 0x01 '\x1'<br>
&nbsp; &nbsp; arg_flags: 0x14c32821 ""<br>
&nbsp; &nbsp; fn_flags: 0x00000100<br>
&nbsp; &nbsp; function_name: 0x06f66850 {gc={refcount=0x00000001 u={type_info=0x000001c6 } } h=0xacaf1bdb len=0x0000000a ...}<br>
&nbsp; &nbsp; scope: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; prototype: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; num_args: 0x00000000<br>
&nbsp; &nbsp; required_num_args: 0x00000000<br>
&nbsp; &nbsp; arg_info: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; cache_size: 0x131183d0<br>
&nbsp; &nbsp; last_var: 0x06ee0e98<br>
&nbsp; &nbsp; T: 0x00000000<br>
&nbsp; &nbsp; last: 0x00000000<br>
&nbsp; &nbsp; opcodes: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; run_time_cache: 0x00000000 {???}<br>
&nbsp; &nbsp; static_variables: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; vars: 0x00000000 {???}<br>
&nbsp; &nbsp; refcount: 0x600df45e {???}<br>
&nbsp; &nbsp; last_live_range: 0x88008c00<br>
&nbsp; &nbsp; last_try_catch: 0x00000001<br>
&nbsp; &nbsp; live_range: 0x00000100 {var=??? start=??? end=??? }<br>
&nbsp; &nbsp; try_catch_array: 0x14c2d958 {try_op=0x00000001 catch_op=0x000001c6 finally_op=0xddab5409 ...}<br>
&nbsp; &nbsp; filename: 0x14c1a538 {gc={refcount=0x00000001 u={type_info=0x14c00668 } } h=0x00000000 len=0x00000001 ...}<br>
&nbsp; &nbsp; line_start: 0x00000000<br>
&nbsp; &nbsp; line_end: 0x00000002<br>
&nbsp; &nbsp; doc_comment: 0x00000002 {gc={refcount=??? u={type_info=??? } } h=??? len=??? ...}<br>
&nbsp; &nbsp; last_literal: 0x714beccc<br>
&nbsp; &nbsp; literals: 0x71180110 {php7.dll!zif_xmlwriter_write_pi(_zend_execute_data *, _zval_struct *)} {value={lval=0x3314ec83 ...} ...}<br>
&nbsp; &nbsp; reserved: 0x14c3288c {0x06ee0bc0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}<br>
<br>
<b>((_zend_op_array*)0x14c32820)-&gt;function_name</b><br>
0x06f66850 {gc={refcount=0x00000001 u={type_info=0x000001c6 } } h=0xacaf1bdb len=0x0000000a ...}<br>
&nbsp; &nbsp; gc: {refcount=0x00000001 u={type_info=0x000001c6 } }<br>
&nbsp; &nbsp; h: 0xacaf1bdb<br>
&nbsp; &nbsp; len: 0x0000000a<br>
&nbsp; &nbsp; val: 0x06f66860 "_dyuweyrj4"<br>
<br>
<b>&amp;((_zend_op_array*)0)-&gt;reserved[3]</b><br>
0x00000078 {???}</code><br>
<br><font style="vertical-align: inherit;"></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Aparentemente, este campo es utilizado por ionCube Loader para algunos de sus prop√≥sitos internos. </font><font style="vertical-align: inherit;">Para verificar, ejecutemos el archivo desde una l√≠nea</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span> _dyuweyrj4(<span class="hljs-number">0x00982d23</span>, <span class="hljs-number">0x00982d23</span> ^ <span class="hljs-number">0x3793f6a0</span>);</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a trav√©s de su </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">codificador PHP en l√≠nea</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">(El resultado del cifrado se da al comienzo de la publicaci√≥n). Desafortunadamente, esto no ayuda: sigue </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;siendo cero. </font><font style="vertical-align: inherit;">Pero nos aseguramos de que la funci√≥n de ejecuci√≥n (sin nombre) </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ahora </font><font style="vertical-align: inherit;">est√© completa </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<code><b>executor_globals.current_execute_data-&gt;func-&gt;op_array</b><br>
{type=0x02 '\x2' arg_flags=0x14a72141 "" fn_flags=0x08000000 ...}<br>
&nbsp; &nbsp; type: 0x02 '\x2'<br>
&nbsp; &nbsp; arg_flags: 0x14a72141 ""<br>
&nbsp; &nbsp; fn_flags: 0x08000000<br>
&nbsp; &nbsp; function_name: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; scope: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; prototype: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; num_args: 0x00000000<br>
&nbsp; &nbsp; required_num_args: 0x00000000<br>
&nbsp; &nbsp; arg_info: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; cache_size: 0x00000004<br>
&nbsp; &nbsp; last_var: 0x00000000<br>
&nbsp; &nbsp; T: 0x00000001<br>
&nbsp; &nbsp; last: 0x00000005<br>
&nbsp; &nbsp; opcodes: 0x14a72280 {handler=0x999fc7ce op1={constant=0x00000000 var=0x00000000 num=0x00000000 ...} op2={constant=...} ...}<br>
&nbsp; &nbsp; run_time_cache: 0x14a74018 {0x14c27ba0}<br>
&nbsp; &nbsp; static_variables: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; vars: 0x00000000 {???}<br>
&nbsp; &nbsp; refcount: 0x14a74030 {0x00000002}<br>
&nbsp; &nbsp; last_live_range: 0x00000000<br>
&nbsp; &nbsp; last_try_catch: 0x00000000<br>
&nbsp; &nbsp; live_range: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; try_catch_array: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; filename: 0x14a66230 {gc={refcount=0x00000001 u={type_info=0x00000006 } } h=0x00000000 len=0x00000032 ...}<br>
&nbsp; &nbsp; line_start: 0x00200001<br>
&nbsp; &nbsp; line_end: 0x00000001<br>
&nbsp; &nbsp; doc_comment: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; last_literal: 0x00000005<br>
&nbsp; &nbsp; literals: 0x14a66280 {value={lval=0x0716a738 dval=5.875681226702e-316#DEN counted=0x0716a738 {gc={refcount=0x00000001 ...} } ...} ...}<br>
&nbsp; &nbsp; reserved: 0x14a721ac {0x00000000, 0x00000000, 0x00000000, 0x14a6b200, 0x00000000, 0x00000000}</code><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bug expulsado con un error</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como podemos ver, solo est√° </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;lleno de funciones cifradas. (Esta no es su √∫nica caracter√≠stica distintiva: en la impresi√≥n anterior, tambi√©n puede notar en </font></font><code>line_start=0x00200001</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;lugar de un n√∫mero de l√≠nea plausible). Por otro lado, el puntero al </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que entra en la funci√≥n bloqueada se toma del que </font></font><code>execute_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se pas√≥ en el </font></font><code>_dyuweyrj4</code>&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primer par√°metro impl√≠cito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;, por lo que </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;siempre corresponde a la funci√≥n llamada , a saber, en s√≠ mismo </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Esta funci√≥n no est√° encriptada y, por lo tanto </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;, siempre ser√° cero. Concluimos de esto: una llamada </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;con los par√°metros "correctos" </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inevitablemente conduce a un bloqueo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;(y con los equivocados, como vimos, a la prensa de los aforismos chinos). Lo mejor de esto es que el bloqueo resultante no es intencional, sino que se llama utilizando un puntero nulo antes de verificarlo. Tal error en el c√≥digo capturar√≠a cualquier herramienta de an√°lisis est√°tico; pero aparentemente, no usan nada como esto en ionCube. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© sucede si soluciono un error en ioncube_loader_win_7.3.dll configurando una comprobaci√≥n de puntero antes de usarlo? Para esto, es m√°s conveniente usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x64dbg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j1/mh/zd/j1mhzdzqh5k-lgme_k8awtppxw0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
comenzamos </font></font><code>php -r "_dyuweyrj4(0x00982d23, 0x00982d23 ^ 0x3793f6a0);"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;con el cargador de ionCube parcheado y ... obtenemos el bloqueo en un lugar nuevo, nuevamente cuando usamos el puntero nulo de </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/al/nx/jialnxbvufmj0dvqgc2s19thaxs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso significa que no ten√≠a sentido la verificaci√≥n (incorrecta) de un puntero nulo: en la siguiente funci√≥n llamada, se usa el mismo puntero sin verificaci√≥n. </font><font style="vertical-align: inherit;">Llegamos a la conclusi√≥n de que una vulnerabilidad potencial que nos permitir√≠a modificar la memoria del proceso PHP en una direcci√≥n arbitraria y escapar del entorno limitado, por ejemplo, las funciones de llamada que no est√°n permitidas por el administrador del servidor, se cierra en ionCube Loader por una secuencia de errores que conducen al cach√© php.exe no deseado .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© quiso decir el autor?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creo que inicialmente </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;apareci√≥ para vincular una serie formalmente correcta de </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encubrimientos </font><font style="vertical-align: inherit;">a funciones cifradas </font><font style="vertical-align: inherit;">, porque ionCube Loader est√° lejos de ser el √∫nico m√≥dulo de extensi√≥n que se arrastrar√° en estas matrices. (Uno de los casos comunes en los que las extensiones entran en </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciones es almacenarlos en cach√© </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entre ejecuciones del mismo script; el otro es desensambladores PHP, como el resultado del foro indonesio). Como argumento, </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;obtuve un puntero a </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;uno cifrado funciones, y pas√≥ el control al descifrador, con el cual ionCube Loader reemplaza la funci√≥n est√°ndar </font></font><code>zend_execute_ex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El √∫nico escenario en el que </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;podr√≠a llamarse es si el m√≥dulo de extensi√≥n extra√±o almacena en cach√© "</font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encubrimientos por separado de la funci√≥n cifrada, y luego intenta </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejecutar estos. En este caso, una llamada </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;con un puntero a la </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;funci√≥n cifrada se convertir√° en un descifrado y el lanzamiento de esta funci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al cambiar a PHP 7 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;ABI de las funciones de extensi√≥n </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">cambi√≥</font></a><font style="vertical-align: inherit;"> : en lugar de cuatro par√°metros impl√≠citos </font></font><code>ht, return_value_ptr, this_ptr, return_value_used</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;, Se utiliza la estructura </font></font><code>_zend_execute_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Aqu√≠, los programadores de ionCube est√°n confundidos porque </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;ahora reciben dos punteros para </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: uno a trav√©s del campo </font></font><code>_zend_execute_data.func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el segundo por el par√°metro pasado expl√≠citamente. El primero corresponde a la </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">segunda, la funci√≥n cifrada que necesita ser llamada. Y aqu√≠ vemos otro error: incrementar el campo </font></font><code>refcount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;funci√≥n encriptada, </font></font><code>_dyuweyrj4</code>&nbsp;<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se olvida por completo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y adem√°s funciona solo con los suyos </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Naturalmente, un intento de llamar a una funci√≥n de extensi√≥n, como si fuera una funci√≥n cifrada de PHP, conduce a un bloqueo, ¬°y es bueno que no </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;cause </font><font style="vertical-align: inherit;">una recursi√≥n infinita, porque </font><font style="vertical-align: inherit;">trata de llamarse a s√≠ misma! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Surge la pregunta: ¬øc√≥mo el control de calidad en ionCube perdi√≥ la funci√≥n que nunca pudo funcionar como estaba previsto? </font><font style="vertical-align: inherit;">El hecho de que no se incluy√≥ en el plan de prueba tambi√©n es evidente porque en la versi√≥n de 64 bits de ionCube Loader los par√°metros </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;siguen siendo de 32 bits; esto significa que el puntero a la </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;funci√≥n cifrada se trunca a 32 bits incluso antes del incremento </font></font><code>refcount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y ese bloqueo, lo cual captamos el primero, garantizado que suceda con cualquier llamada </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/gu/ab/cg/guabcgmwuqoopx1ar80sjpz6keq.png"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/de/0y/l-/de0yl-6ppopvisr_a80b4yuhjj8.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es506872/index.html">Book Spring Boot 2: mejores pr√°cticas para profesionales</a></li>
<li><a href="../es506874/index.html">De la vida de un programador: empresarios</a></li>
<li><a href="../es506880/index.html">Joel Spolsky: c√≥mo comenz√≥ la era de Stack Overflow</a></li>
<li><a href="../es506886/index.html">Life hack for bit</a></li>
<li><a href="../es506888/index.html">Ordenar hoja de trucos para Data Science</a></li>
<li><a href="../es506896/index.html">La interpretaci√≥n m√°s realista de la mec√°nica cu√°ntica.</a></li>
<li><a href="../es506902/index.html">Hogar inteligente en una ciudad inteligente</a></li>
<li><a href="../es506906/index.html">Las paradojas de los agujeros negros revelan la conexi√≥n fundamental entre la energ√≠a y el orden</a></li>
<li><a href="../es506908/index.html">La mejor ciencia. Media de mayo diez: desesperaci√≥n de los peces de acuario, voces de trastornos mentales y muchas veces COVID</a></li>
<li><a href="../es506916/index.html">¬øQu√© es una malla de servicio?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>