<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕵🏻 🏫 👨🏾‍✈️ マルチスレッドバックアップアプリケーションの作成経験 🍭 👩🏽‍🎤 🏇🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="現時点では、マルチスレッドアプリケーションを使用しているユーザーを驚かせることはありませんが、この記事では興味深いアイデアを見つけることができると思います。私のJavaの研究はこの特定のプロジェクトから始まったので、場所によってはかなり間違っていたり、大きな自転車を作ったりするかもしれませんが、誰か...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>マルチスレッドバックアップアプリケーションの作成経験</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459478/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現時点では、マルチスレッドアプリケーションを使用しているユーザーを驚かせることはありませんが、この記事では興味深いアイデアを見つけることができると思います。</font><font style="vertical-align: inherit;">私のJavaの研究はこの特定のプロジェクトから始まったので、場所によってはかなり間違っていたり、大きな自転車を作ったりするかもしれませんが、誰かがJavaの初心者の経験に興味を持っていただければ幸いです。</font><font style="vertical-align: inherit;">アプリケーションのいくつかの機能は次のとおりです。</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップのサイズに関係なく、メモリ内で排他的に動作します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップ全体をメモリにロードしません</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップ/復元操作をキャンセルできます</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カットの下では、アプリケーションのアーキテクチャ、および発生した主な問題とその解決策が検討されます。</font></font></p><a name="habracut"></a><br>
<h2 id="obzor-prilozheniya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションの概要</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションとの通信はWeb UIを介して行われますが、将来的には必要に応じてREST APIを追加できるようになります。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションは次のことができます。</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップを作成して1つ以上のストレージにアップロードする</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストレージからロードしてバックアップを復元する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのストレージからバックアップを削除します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定期的にバックアップを作成する</font></font></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在サポートされているリポジトリ：</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルファイルシステム（Dockerではサポートされていません）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドロップボックス</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在サポートされているデータベース：</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特別なアプリケーションから、私は注意することができます：</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスター構成での正しい作業</font></font></li>
<li>           .         .   ,   ,    /     .</li>
<li> —    Windows,    Linux.</li>
<li>         .</li>
</ol><br>
<p>   Web UI,    .</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/vl/qg/n5/vlqgn5f58ub5jhxixeeg2uq-oa8.png" title=" "></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/oj/o5/uj/ojo5uj_raxkwd1btsjrktiowifo.png" title=" "></a></p></div></div><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/wn/6p/bk/wn6pbkcqg4qu_9btgrvnqm3l7x0.png" title="  "></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/wu/9a/4k/wu9a4ky7icuiyqdxeiii9xbu5d8.png" title="  "></a></p></div></div><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/1d/zb/6s/1dzb6scvtua5v3m_3l11lch4rgm.png" title=" "></a></p></div></div><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/gj/9f/w0/gj9fw0onqw7f0lf7ycw05aphinc.png" title=" "></a></p></div></div><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/sy/jz/y6/syjzy68wqxgi8smgq74giqstgu0.png" title="  "></a></p></div></div><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/hk/pw/tg/hkpwtg3kf7c5ho3f7ae7_uos7v0.png" title="  "></a></p></div></div><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/al/dt/su/aldtsuel4amtjlvbbbusccxddh0.png" title="  "></a></p></div></div><br>
<hr><br>
<h2 id="arhitektura"></h2><br>
<p>     3  — <em>DatabaseBackup</em>, <em>Processor</em>, <em>Storage</em>,        <em> </em>.    .</p><br>
<h3 id="databasebackup">DatabaseBackup</h3><br>
<p>       plain-text .</p><br>
<p> :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DatabaseBackup</span> </span>{
    <span class="hljs-function">InputStream <span class="hljs-title">createBackup</span><span class="hljs-params">(DatabaseSettings databaseSettings, Integer id)</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">restoreBackup</span><span class="hljs-params">(InputStream in, DatabaseSettings databaseSettings, Integer id)</span></span>;<font></font>
}</code></pre><br>
<p>     <strong>InputStream</strong>,    ,       ,     /   .  <em>DatabaseSettings</em>    Web UI    ,      .     — <code>id</code> —    .</p><br>
<p>   :</p><br>
<ol>
<li>        .</li>
<li> <code>restoreBackup()</code>      ,           .</li>
</ol><br>
<div class="spoiler"><b class="spoiler_title">  PostgreSQL ( )</b><div class="spoiler_text"><p>    PostgreSQL    :</p><br>
<ol>
<li><code>createBackup()</code>:   <em>pg_dump</em>,           .        (. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html#getInputStream--</a>).  /       ,       ,         .     ,        <em></em> ,       ,                . ,    ,   Java   deadlock     - ,     stdout  stderr .     ,       ,      I/O            .</li>
<li><code>restoreBackup()</code>:   <em>psql</em>,       InputStream        psql (. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html#getOutputStream--</a>).   ,  plain-text PostgreSQL  —     DDL  DML ,    psql.</li>
</ol><br>
<p> ,       ,     GitHub     . </p></div></div><br>
<h3 id="processor">Processor</h3><br>
<p>         .           .  : , .</p><br>
<p> :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Processor</span> </span>{
    <span class="hljs-function">InputStream <span class="hljs-title">process</span><span class="hljs-params">(InputStream in)</span></span>;<font></font>
<font></font>
    <span class="hljs-function">InputStream <span class="hljs-title">deprocess</span><span class="hljs-params">(InputStream in)</span></span>;<font></font>
<font></font>
    <span class="hljs-function">ProcessorType <span class="hljs-title">getType</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// ProcessorType -  Enum,    </span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">getPrecedence</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
}</code></pre><br>
<p>    —    ,        .       ,     ,    . </p><br>
<h3 id="storage">Storage</h3><br>
<p>       ,      .  : Dropbox,   .</p><br>
<p> :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Storage</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">uploadBackup</span><span class="hljs-params">(InputStream in, StorageSettings storageSettings, String backupName, Integer id)</span></span>;<font></font>
<font></font>
    <span class="hljs-function">InputStream <span class="hljs-title">downloadBackup</span><span class="hljs-params">(StorageSettings storageSettings, String backupName, Integer id)</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deleteBackup</span><span class="hljs-params">(StorageSettings storageSettings, String backupName, Integer id)</span></span>;<font></font>
}</code></pre><br>
<p>      —         ,     . ,      —    ,              .  <em>StorageSettings</em>    Web UI        .</p><br>
<hr><br>
<h3 id="koncepciya-taskov"> </h3><br>
<p>        ,        ,    .       .          ,   —  <strong>Future</strong> (. Java <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Future</a>).       Future (,    ,  Future      ).</p><br>
<p>  .          — ,    .</p><br>
<h4 id="zapusk-zadach"> </h4><br>
<p><strong> :</strong></p><br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">startBackupTask</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Task.RunType runType, <span class="hljs-meta">@NotNull</span> List&lt;String&gt; storageSettingsNameList, <span class="hljs-meta">@Nullable</span> List&lt;ProcessorType&gt; processors,
                                <span class="hljs-meta">@NotNull</span> DatabaseSettings databaseSettings)</span> </span>{<font></font>
        Objects.requireNonNull(runType);<font></font>
        Objects.requireNonNull(storageSettingsNameList);<font></font>
        Objects.requireNonNull(processors);<font></font>
        Objects.requireNonNull(databaseSettings);<font></font>
<font></font>
        BackupProperties backupProperties =<font></font>
                backupPropertiesManager.initNewBackupProperties(storageSettingsNameList, processors, databaseSettings.getName());<font></font>
        Task task = tasksManager.initNewTask(Task.Type.CREATE_BACKUP, runType, backupProperties.getId());<font></font>
        Integer taskId = task.getId();<font></font>
<font></font>
        Future future = tasksStarterExecutorService.submit(() -&gt; {<font></font>
            tasksManager.updateTaskState(taskId, Task.State.CREATING);<font></font>
            logger.info(<span class="hljs-string">"Creating backup..."</span>);<font></font>
<font></font>
            <span class="hljs-keyword">try</span> (InputStream backupStream = databaseBackupManager.createBackup(databaseSettings, taskId)) {
                <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
                }<font></font>
<font></font>
                tasksManager.updateTaskState(taskId, Task.State.APPLYING_PROCESSORS);<font></font>
                logger.info(<span class="hljs-string">"Applying processors on created backup. Processors: {}"</span>, processors);<font></font>
<font></font>
                <span class="hljs-keyword">try</span> (InputStream processedBackupStream = backupProcessorManager.process(backupStream, processors)) {
                    <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
                    }<font></font>
<font></font>
                    tasksManager.updateTaskState(taskId, Task.State.UPLOADING);<font></font>
                    logger.info(<span class="hljs-string">"Uploading backup..."</span>);<font></font>
<font></font>
                    backupLoadManager.uploadBackup(processedBackupStream, backupProperties, taskId);<font></font>
                    <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
                    }<font></font>
<font></font>
                    tasksManager.updateTaskState(taskId, Task.State.COMPLETED);<font></font>
                    logger.info(<span class="hljs-string">"Creating backup completed. Backup properties: {}"</span>, backupProperties);<font></font>
                }<font></font>
            } <span class="hljs-keyword">catch</span> (IOException ex) {<font></font>
                logger.error(<span class="hljs-string">"Error occurred while closing input stream of created backup"</span>, ex);<font></font>
            } <span class="hljs-keyword">catch</span> (RuntimeException ex) {<font></font>
                logger.error(<span class="hljs-string">"Error occurred while creating backup. Backup properties: {}"</span>, backupProperties, ex);<font></font>
                errorTasksManager.addErrorTask(taskId);<font></font>
            } <span class="hljs-keyword">catch</span> (InterruptedException ex) {<font></font>
                tasksManager.setInterrupted(taskId);<font></font>
                logger.error(<span class="hljs-string">"Backup creating task was interrupted. Task ID: {}"</span>, taskId);<font></font>
            } <span class="hljs-keyword">finally</span> {<font></font>
                futures.remove(taskId);<font></font>
            }<font></font>
        });<font></font>
<font></font>
        futures.put(taskId, future);<font></font>
        <span class="hljs-keyword">return</span> task;<font></font>
    }</code></pre><br>
<p>   3     :   -&gt;   -&gt;   .        ID    ,        ,    .   ,    <em>InterruptedException</em>        <em>RuntimeException</em>   .</p><br>
<p>        :</p><br>
<pre><code class="java hljs">tasksStarterService.startBackupTask(Task.RunType.USER, storageSettingsNameList, processors, databaseSettings);</code></pre><br>
<p>     :       (   —  ).        Web UI   ,    .        —  ,   ,  ,    . </p><br>
<p>           <strong>BackupProperties</strong>.       ,  ,     ,     .            .</p><br>
<p>       :</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "backup_tasks")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Task</span> </span>{
    <span class="hljs-comment">/**
     * Identifier of each backup task. Identifier is generated by PostgreSQL database after saving of entity.
     */</span>
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@Column(insertable = false, updatable = false)</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Integer id;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Backup task type.
     * &lt;p&gt;
     * Type is set at the very start of any task and can't be changed.
     *
     * <span class="hljs-doctag">@see</span> Type
     */</span>
    <span class="hljs-meta">@Enumerated(EnumType.STRING)</span>
    <span class="hljs-meta">@Column(updatable = false)</span>
    <span class="hljs-keyword">private</span> Type type;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Who initiated a task: user or server.
     * &lt;p&gt;
     * We need to know it to show on front only these tasks that was started by user.
     *
     * <span class="hljs-doctag">@see</span> RunType
     */</span>
    <span class="hljs-meta">@Enumerated(EnumType.STRING)</span>
    <span class="hljs-meta">@Column(updatable = false)</span>
    <span class="hljs-keyword">private</span> RunType runType;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Backup task state.
     * &lt;p&gt;
     * State is updated with every new step in task being executed.
     *
     * <span class="hljs-doctag">@see</span> Task.State
     */</span>
    <span class="hljs-meta">@Enumerated(EnumType.STRING)</span>
    <span class="hljs-keyword">private</span> State state;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Whether task has been interrupted or not.
     * &lt;p&gt;
     * Default is {<span class="hljs-doctag">@literal</span> false}.
     */</span>
    <span class="hljs-meta">@Column(insertable = false)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> interrupted;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Identifier of {<span class="hljs-doctag">@link</span> BackupProperties}.
     * &lt;p&gt;
     * We need to know backup ID to be able to handle occurred errors.
     */</span>
    <span class="hljs-meta">@Column(updatable = false)</span>
    <span class="hljs-keyword">private</span> Integer backupPropertiesId;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Start time of the task.
     */</span>
    <span class="hljs-meta">@Column(updatable = false)</span>
    <span class="hljs-keyword">private</span> LocalDateTime date;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> RunType {<font></font>
        USER,<font></font>
        INTERNAL<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> State {<font></font>
        PLANNED,<font></font>
        CREATING,<font></font>
        RESTORING,<font></font>
        DELETING,<font></font>
        APPLYING_PROCESSORS,<font></font>
        APPLYING_DEPROCESSORS,<font></font>
        DOWNLOADING,<font></font>
        UPLOADING,<font></font>
        COMPLETED,<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> Type {<font></font>
        CREATE_BACKUP {<font></font>
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">"CREATE BACKUP"</span>;<font></font>
            }<font></font>
        },<font></font>
        RESTORE_BACKUP {<font></font>
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">"RESTORE BACKUP"</span>;<font></font>
            }<font></font>
        },<font></font>
        DELETE_BACKUP {<font></font>
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-string">"DELETE BACKUP"</span>;<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// getters &amp; setters...</span><font></font>
<font></font>
}</code></pre><br>
<p> ,         :<br>
<img src="https://habrastorage.org/webt/bm/um/cy/bmumcyhyapjg4ono73qo8kiquom.png" alt="バックアッププロセス" title="バックアッププロセス"></p><br>
<hr><br>
<p>     .       ,              .</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">startRestoreTask</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Task.RunType runType, <span class="hljs-meta">@NotNull</span> BackupProperties backupProperties, <span class="hljs-meta">@NotNull</span> String storageSettingsName,
                                 <span class="hljs-meta">@NotNull</span> DatabaseSettings databaseSettings)</span> </span>{<font></font>
        Objects.requireNonNull(runType);<font></font>
        Objects.requireNonNull(backupProperties);<font></font>
        Objects.requireNonNull(storageSettingsName);<font></font>
        Objects.requireNonNull(databaseSettings);<font></font>
<font></font>
        Task task = tasksManager.initNewTask(Task.Type.RESTORE_BACKUP, runType, backupProperties.getId());<font></font>
        Integer taskId = task.getId();<font></font>
<font></font>
        Future future = tasksStarterExecutorService.submit(() -&gt; {<font></font>
            tasksManager.updateTaskState(taskId, Task.State.DOWNLOADING);<font></font>
            logger.info(<span class="hljs-string">"Downloading backup..."</span>);<font></font>
<font></font>
            <span class="hljs-keyword">try</span> (InputStream downloadedBackup =<font></font>
                         backupLoadManager.downloadBackup(backupProperties.getBackupName(), storageSettingsName, taskId)) {<font></font>
                <span class="hljs-keyword">if</span> (Thread.interrupted() || downloadedBackup == <span class="hljs-keyword">null</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
                }<font></font>
<font></font>
                tasksManager.updateTaskState(taskId, Task.State.APPLYING_DEPROCESSORS);<font></font>
                logger.info(<span class="hljs-string">"Deprocessing backup..."</span>);<font></font>
<font></font>
                <span class="hljs-keyword">try</span> (InputStream deprocessedBackup = backupProcessorManager.deprocess(downloadedBackup, backupProperties.getProcessors())) {
                    <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
                    }<font></font>
<font></font>
                    tasksManager.updateTaskState(taskId, Task.State.RESTORING);<font></font>
                    logger.info(<span class="hljs-string">"Restoring backup..."</span>);<font></font>
<font></font>
                    databaseBackupManager.restoreBackup(deprocessedBackup, databaseSettings, taskId);<font></font>
                    <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
                    }<font></font>
<font></font>
                    tasksManager.updateTaskState(taskId, Task.State.COMPLETED);<font></font>
                    logger.info(<span class="hljs-string">"Restoring backup completed. Backup properties: {}"</span>, backupProperties);<font></font>
                }<font></font>
            } <span class="hljs-keyword">catch</span> (IOException ex) {<font></font>
                logger.error(<span class="hljs-string">"Error occurred while closing input stream of downloaded backup"</span>, ex);<font></font>
            } <span class="hljs-keyword">catch</span> (RuntimeException ex) {<font></font>
                logger.info(<span class="hljs-string">"Error occurred while restoring backup. Backup properties: {}"</span>, backupProperties, ex);<font></font>
                errorTasksManager.addErrorTask(taskId);<font></font>
            } <span class="hljs-keyword">catch</span> (InterruptedException ex) {<font></font>
                tasksManager.setInterrupted(taskId);<font></font>
                logger.error(<span class="hljs-string">"Task was interrupted. Task ID: {}"</span>, taskId);<font></font>
            } <span class="hljs-keyword">finally</span> {<font></font>
                futures.remove(taskId);<font></font>
            }<font></font>
        });<font></font>
<font></font>
        futures.put(taskId, future);<font></font>
        <span class="hljs-keyword">return</span> task;<font></font>
    }</code></pre><br>
<p>   3     :     -&gt;      plain-text  -&gt;  .</p><br>
<p>   :</p><br>
<pre><code class="java hljs">tasksStarterService.startRestoreTask(Task.RunType.USER, backupProperties, storageSettingsName, databaseSettings);</code></pre><br>
<p>     :<br>
<img src="https://habrastorage.org/webt/hr/_m/bk/hr_mbkvfkszhyhj6ebi1q_wa1nc.png" alt="  " title="  "></p></div></div><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Task <span class="hljs-title">startDeleteTask</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Task.RunType runType, <span class="hljs-meta">@NotNull</span> BackupProperties backupProperties)</span> </span>{<font></font>
        Objects.requireNonNull(runType);<font></font>
        Objects.requireNonNull(backupProperties);<font></font>
<font></font>
        Task task = tasksManager.initNewTask(Task.Type.DELETE_BACKUP, runType, backupProperties.getId());<font></font>
        Integer taskId = task.getId();<font></font>
<font></font>
        Future future = tasksStarterExecutorService.submit(() -&gt; {<font></font>
            <span class="hljs-keyword">try</span> {<font></font>
                logger.info(<span class="hljs-string">"Deleting backup started. Backup properties: {}"</span>, backupProperties);<font></font>
                tasksManager.updateTaskState(taskId, Task.State.DELETING);<font></font>
<font></font>
                backupLoadManager.deleteBackup(backupProperties, taskId);<font></font>
                <span class="hljs-keyword">if</span> (Thread.interrupted()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
                }<font></font>
<font></font>
                tasksManager.updateTaskState(taskId, Task.State.COMPLETED);<font></font>
                logger.info(<span class="hljs-string">"Deleting backup completed. Backup properties: {}"</span>, backupProperties);<font></font>
            } <span class="hljs-keyword">catch</span> (RuntimeException ex) {<font></font>
                logger.error(<span class="hljs-string">"Error occurred while deleting backup. Backup properties: {}"</span>, backupProperties, ex);<font></font>
                errorTasksManager.addErrorTask(taskId);<font></font>
            } <span class="hljs-keyword">catch</span> (InterruptedException ex) {<font></font>
                tasksManager.setInterrupted(taskId);<font></font>
                logger.error(<span class="hljs-string">"Task was interrupted. Task ID: {}"</span>, taskId);<font></font>
            } <span class="hljs-keyword">finally</span> {<font></font>
                futures.remove(taskId);<font></font>
            }<font></font>
        });<font></font>
<font></font>
        futures.put(taskId, future);<font></font>
        <span class="hljs-keyword">return</span> task;<font></font>
    }</code></pre><br>
<p>    :      ,     .</p><br>
<p>   :</p><br>
<pre><code class="java hljs">tasksStarterService.startDeleteTask(Task.RunType.USER, backupProperties);</code></pre><br>
<p>     :<br>
<img src="https://habrastorage.org/webt/y4/ca/yp/y4cayp76w4v0tx8umvzcp6flzd4.png" alt="  " title="  "></p></div></div><br>
<hr><br>
<h3 id="otmena-taskov"> </h3><br>
<p>   ?  ,   ,   .   ,    ,   Future,    try-catch :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">try</span> {<font></font>
    ...<font></font>
} <span class="hljs-keyword">catch</span> (InterruptedException ex) {<font></font>
    ...<font></font>
    tasksManager.setInterrupted(taskId);<font></font>
}</code></pre><br>
<p>     ,     ,   :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">if</span> (Thread.interrupted()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
}</code></pre><br>
<p> ,   ,          JVM.</p><br>
<p>  JVM    :</p><br>
<ol>
<li>New</li>
<li>Runnable</li>
<li>Timed waiting</li>
<li>Waiting</li>
<li>Blocked</li>
<li>Terminated</li>
</ol><br>
<p>    Waiting  Timed waiting.     <em>Waiting</em>  <code>Object.wait()</code>, <code>Thread.join()</code>  .     <em>Timed waiting</em> (.. ,     )  <code>Object.wait(timeout)</code>, <code>Thread.join(timeout)</code>, <code>Thread.sleep(sleeping)</code>  .</p><br>
<p>   ,     <em>   </em> Waiting  Timed waiting     <em>   </em>,   ,   <strong>InterruptedException</strong>.</p><br>
<p>    .   ,   -    ,  ,    .       ,    ? </p><br>
<p>  —        <code>Thread.interrupted()</code>  <code>Thread.currentThread.isInterrupted()</code>.     ,       <code>currentThread.isInterrupted(boolean ClearInterrupted)</code>,    <code>true</code>,  ,     ,   —  <code>false</code>,    .         .   InterruptedException,     —    .</p><br>
<p>      —   .        I/O ,     I/O .   —   ,     <code>read()</code>  <code>write(int b)</code>  I/O      - ,   ,   I/O   .  , Java    — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">InterruptedIOException</a>. ,   read/write      ,       <em>PipedInputStream</em>.    ,     ,     read/write  ,       InterruptedIOException.   ,       read()     —   InputStream    .         ,      . ,       IOException    .  ,          ,    .</p><br>
<p>   ,        ,        ,           .</p><br>
<p>  ,   .         upload()   .  ,       .     —  ,   -  ,    .    ,        Future.            ,        Future   .<br>
   :</p><br>
<pre><code class="java hljs">backupLoadManager.uploadBackup(processedBackupStream, backupProperties, taskId); &lt;-   ,      
<span class="hljs-keyword">if</span> (Thread.interrupted()) { <span class="hljs-comment">//      ,      - ,   </span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InterruptedException();<font></font>
}</code></pre><br>
<p> ,     <strong>InterruptedException</strong>  <strong>InterruptedIOException</strong>  :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">try</span> {<font></font>
    ...<font></font>
} <span class="hljs-keyword">catch</span> (InterruptedException e) { <span class="hljs-comment">//  InterruptedIOException</span><font></font>
    ...<font></font>
    <span class="hljs-comment">// re-interrupt the thread</span><font></font>
    Thread.currentThread().interrupt();<font></font>
}</code></pre><br>
<p>,    ,       ?<br>
         <em>CancelTask</em>,    ID   ,    ,      .   ?  :</p><br>
<ol>
<li>      .      ,   Future    .  ,        -  ,  Future      . </li>
<li>    ,   Future   -  .</li>
</ol><br>
<p>     :<br>
      <em>cancel_tasks</em> (    ),        Future   .  Future   —   ,  revert      .         (  ,     Future  ) —     .          ,    ,     PostgreSQL .</p><br>
<p><strong> CancelTasksWatcher:</strong></p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment">/**
 * This class scans for tasks to cancel and tries to cancel them.
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CancelTasksWatcher</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(CancelTasksWatcher.class);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Duration cancelTimeout = Duration.ofMinutes(<span class="hljs-number">10</span>);
    <span class="hljs-keyword">private</span> CancelTasksManager cancelTasksManager;
    <span class="hljs-keyword">private</span> TasksStarterService tasksStarterService;
    <span class="hljs-keyword">private</span> TasksManager tasksManager;<font></font>
<font></font>
    <span class="hljs-comment">// spring setters...</span><font></font>
<font></font>
    <span class="hljs-comment">/**
     * This watcher wakes up every time 10 seconds passed from the last completion, checks if there are any tasks to cancel and tries to
     * cancel each task.
     * &lt;p&gt;
     * Since there are can be working more that one instance of the program, {<span class="hljs-doctag">@literal</span> Future} instance of task can belong to different
     * servers. We can't get access to {<span class="hljs-doctag">@literal</span> Future} if it's not in memory of the server where task cancellation request was accepted.
     * So the purpose of this watcher is to be able cancel tasks that works in the other instance of program. Each server has this watcher
     * checking for available cancellation requests and if any, the watcher tries to cancel corresponding {<span class="hljs-doctag">@literal</span> Future}.
     * If cancellation is successful task will be also reverted.
     * &lt;p&gt;
     * If task cancellation request timeout exceeded, then it means a server that had requested {<span class="hljs-doctag">@literal</span> Future} instances has been
     * shutdown, so all {<span class="hljs-doctag">@literal</span> Future} instances lost and task can't be canceled. In such case task cancellation request will be ignored.
     *
     * <span class="hljs-doctag">@see</span> TasksStarterService#getFuture(Integer)
     * <span class="hljs-doctag">@see</span> TasksManager#revertTask(Task)
     */</span>
    <span class="hljs-meta">@Scheduled(fixedDelay = 10 * 1000)</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">watchTasksToCancel</span><span class="hljs-params">()</span> </span>{<font></font>
        Iterable&lt;CancelTask&gt; cancelTasks = cancelTasksManager.findAll();<font></font>
<font></font>
        Iterable&lt;Task&gt; tasks = tasksManager.findAllById(StreamSupport.stream(cancelTasks.spliterator(), <span class="hljs-keyword">false</span>)<font></font>
                .map(CancelTask::getTaskId).collect(Collectors.toList()));<font></font>
        Map&lt;Integer, Task&gt; tasksAsMap = StreamSupport.stream(tasks.spliterator(), <span class="hljs-keyword">false</span>)<font></font>
                .collect(Collectors.toMap(Task::getId, Function.identity()));<font></font>
<font></font>
        List&lt;Integer&gt; taskIdsForDeleting = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (CancelTask cancelTask : cancelTasks) {<font></font>
            Integer taskId = cancelTask.getTaskId();<font></font>
<font></font>
            Task task = tasksAsMap.get(taskId);<font></font>
            <span class="hljs-keyword">if</span> (task == <span class="hljs-keyword">null</span>) {<font></font>
                logger.error(<span class="hljs-string">"Can't cancel task: no such entity with ID {}"</span>, taskId);<font></font>
                taskIdsForDeleting.add(taskId);<font></font>
                <span class="hljs-keyword">continue</span>;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-comment">// timeout exceeded, that is server shutdown and lost all Future instances, so task can't be canceled</span>
            <span class="hljs-keyword">if</span> (LocalDateTime.now(ZoneOffset.UTC).isAfter(cancelTask.getPutTime().plus(cancelTimeout))) {<font></font>
                logger.error(<span class="hljs-string">"Can't cancel task: timeout exceed. Task ID: {}"</span>, taskId);<font></font>
                taskIdsForDeleting.add(taskId);<font></font>
                <span class="hljs-keyword">continue</span>;<font></font>
            }<font></font>
<font></font>
            tasksStarterService.getFuture(taskId).ifPresent(future -&gt; {<font></font>
                logger.info(<span class="hljs-string">"Canceling task with ID {}"</span>, taskId);<font></font>
<font></font>
                <span class="hljs-keyword">boolean</span> canceled = future.cancel(<span class="hljs-keyword">true</span>);
                <span class="hljs-keyword">if</span> (canceled) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">// give time to properly handle interrupt</span>
                        Thread.sleep(<span class="hljs-number">10000</span>);<font></font>
                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                        <span class="hljs-comment">// should not happen</span><font></font>
                    }<font></font>
                    tasksManager.revertTask(task);<font></font>
                }<font></font>
<font></font>
                taskIdsForDeleting.add(taskId);<font></font>
<font></font>
                logger.info(<span class="hljs-string">"Task canceled: {}. Task ID: {}"</span>, canceled, taskId);<font></font>
            });<font></font>
        }<font></font>
<font></font>
        cancelTasksManager.deleteByTaskIdIn(taskIdsForDeleting);<font></font>
    }<font></font>
}</code></pre></div></div><br>
<hr><br>
<h4 id="obrabotka-oshibok"> </h4><br>
<p>   ,    ,   Future,    try-catch :</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">try</span> {<font></font>
    ...<font></font>
} <span class="hljs-keyword">catch</span> (RuntimeException e) {<font></font>
    ...<font></font>
    errorTasksManager.addErrorTask(taskId);<font></font>
}</code></pre><br>
<p>    <em>RuntimeException</em>   ,     Future  ,         . </p><br>
<p> <code>addErrorTask(taskId)</code>        ,   ID ,    .<br>
     ?       ,    ,        ,   .</p><br>
<p>     :<br>
                 ,        ,       .  —  PostgreSQL <code>select for update</code>,   select   <code>skip locked</code>      . ,  ,    <code>revertTask()</code>,               .</p><br>
<p><strong> ErrorTasksWatcher</strong>:</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment">/**
 * This class scans for erroneous tasks and handles them depending on their state.
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorTasksWatcher</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(ErrorTasksWatcher.class);<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer nRows = <span class="hljs-number">10</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> TasksManager tasksManager;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> ErrorTasksManager errorTasksManager;<font></font>
<font></font>
    <span class="hljs-comment">// spring setters...</span><font></font>
<font></font>
    <span class="hljs-comment">/**
     * This watcher wakes up every time 1 minute passed from the last completion, checks backup states periodically and handles erroneous
     * tasks if any.
     * &lt;p&gt;
     * The watcher handles at most N tasks as described by {<span class="hljs-doctag">@link</span> #nRows} constant and skips already locked tasks.
     * When retrieving error tasks from database pessimistic lock is set. It allows safely run more than one copy of program, as no other
     * watcher can pick up already being handled error tasks.
     * &lt;p&gt;
     * If the server shutdowns while rows was locked, transaction will be rolled back and lock released, so these entities can be picked
     * up by the other running server.
     */</span>
    <span class="hljs-meta">@Scheduled(fixedDelay = 60 * 1000)</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">watchErrorTasks</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">for</span> (ErrorTask errorTask : errorTasksManager.findFirstNAndLock(nRows)) {
            <span class="hljs-keyword">if</span> (!errorTask.isErrorHandled()) {<font></font>
                Integer backupTaskId = errorTask.getTaskId();<font></font>
<font></font>
                Optional&lt;Task&gt; optionalTask = tasksManager.findById(backupTaskId);<font></font>
                <span class="hljs-keyword">if</span> (!optionalTask.isPresent()) {<font></font>
                    logger.info(<span class="hljs-string">"Can't handle erroneous task: no corresponding backup task entity. Backup task ID: {}"</span>, backupTaskId);
                    <span class="hljs-keyword">continue</span>;<font></font>
                }<font></font>
<font></font>
                tasksManager.revertTask(optionalTask.get());<font></font>
                errorTask.setErrorHandled(<span class="hljs-keyword">true</span>);<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p><strong> <code>revertTask(Task)</code>:</strong></p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="java hljs">    <span class="hljs-comment">/**
     * This function reverts erroneous task by its entity.
     * &lt;p&gt;
     * Use this function only after canceling related {<span class="hljs-doctag">@literal</span> Future}.
     * &lt;p&gt;
     * If the task was of the type {<span class="hljs-doctag">@link</span> Task.Type#CREATE_BACKUP} then related {<span class="hljs-doctag">@link</span> BackupProperties} will be deleted.
     *
     * <span class="hljs-doctag">@param</span> task the entity
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">revertTask</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Task task)</span> </span>{<font></font>
            Objects.requireNonNull(task);<font></font>
<font></font>
            Task.State state = task.getState();<font></font>
<font></font>
            <span class="hljs-keyword">switch</span> (state) {
                <span class="hljs-keyword">case</span> DOWNLOADING:
                <span class="hljs-keyword">case</span> APPLYING_DEPROCESSORS:
                <span class="hljs-keyword">case</span> RESTORING:
                <span class="hljs-keyword">case</span> DELETING: {<font></font>
                    logger.info(<span class="hljs-string">"Handling broken operation. Operation: {}. No extra actions required"</span>, state.toString());
                    <span class="hljs-keyword">break</span>;<font></font>
                }<font></font>
                <span class="hljs-keyword">case</span> CREATING:
                <span class="hljs-keyword">case</span> APPLYING_PROCESSORS: {<font></font>
                    logger.info(<span class="hljs-string">"Handling broken operation. Operation: {}. Delete backup properties..."</span>, state.toString());<font></font>
<font></font>
                    Integer backupPropertiesID = task.getBackupPropertiesId();<font></font>
<font></font>
                    <span class="hljs-keyword">if</span> (!backupPropertiesManager.existsById(backupPropertiesID)) {<font></font>
                        logger.error(<span class="hljs-string">"Can't revert task: no related backup properties. Task info: {}"</span>, task);
                        <span class="hljs-keyword">return</span>;<font></font>
                    }<font></font>
<font></font>
                    backupPropertiesManager.deleteById(backupPropertiesID);<font></font>
                    <span class="hljs-keyword">break</span>;<font></font>
                }<font></font>
                <span class="hljs-keyword">case</span> UPLOADING: {<font></font>
                    logger.info(<span class="hljs-string">"Handling broken operation. Operation: {}. Deleting backup from storage..."</span>, state);<font></font>
<font></font>
                    Integer backupPropertiesId = task.getBackupPropertiesId();<font></font>
                    Optional&lt;BackupProperties&gt; optionalBackupProperties = backupPropertiesManager.findById(backupPropertiesId);<font></font>
                    <span class="hljs-keyword">if</span> (!optionalBackupProperties.isPresent()) {<font></font>
                        logger.error(<span class="hljs-string">"Can't revert task: no related backup properties. Task info: {}"</span>, task);
                        <span class="hljs-keyword">return</span>;<font></font>
                    }<font></font>
<font></font>
                    tasksStarterService.startDeleteTask(Task.RunType.INTERNAL, optionalBackupProperties.get());<font></font>
                    backupPropertiesManager.deleteById(backupPropertiesId);<font></font>
                    <span class="hljs-keyword">break</span>;<font></font>
                }<font></font>
                <span class="hljs-keyword">default</span>: {<font></font>
                    logger.error(<span class="hljs-string">"Can't revert task: unknown state. Task info: {}"</span>, task);<font></font>
                }<font></font>
            }<font></font>
        }</code></pre><br>
<p>  :</p><br>
<ol>
<li>    <em>DOWNLOADING</em>, <em>APPLYING_DEPROCESSORS</em>, <em>RESTORING</em>, <em>DELETING</em> —    .      ,       .</li>
<li>    <em>CREATING</em>, <em>APPLYING_PROCESSORS</em> —  ,       .      BackupProperties  ,       ( BackupProperties   Web UI    ).</li>
<li>    <em>UPLOADING</em> —       .        BackupProperties   ,       .       .</li>
</ol></div></div><br>
<p>,    .         ,    ? ,   ,    Future (  1),     ,          InputStream (  2). ,      2,   1            2    ?</p><br>
<p> ,     ,    ,       .      Future (    1)     :</p><br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> Throwable t, <span class="hljs-meta">@NotNull</span> Integer taskId)</span> </span>{<font></font>
        logger.error(<span class="hljs-string">"Exception caught. Task ID: {}"</span>, taskId, t);<font></font>
<font></font>
        Optional&lt;Future&gt; optionalFuture = tasksStarterService.getFuture(taskId);<font></font>
        <span class="hljs-keyword">if</span> (!optionalFuture.isPresent()) {<font></font>
            logger.error(<span class="hljs-string">"Can't cancel the Future of task with ID {}: no such Future instance"</span>, taskId);<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">boolean</span> canceled = optionalFuture.get().cancel(<span class="hljs-keyword">true</span>);
            <span class="hljs-keyword">if</span> (!canceled) {<font></font>
                logger.error(<span class="hljs-string">"Error canceling the Future of task with ID {}"</span>, taskId);<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                logger.info(<span class="hljs-string">"Task canceled. Task ID: {}"</span>, taskId);<font></font>
                errorTasksManager.setError(taskId);<font></font>
            }<font></font>
        }<font></font>
    }</code></pre><br>
<p>  ,     ,      ID  ,   ,    Future   -  ,  ID     .</p><br>
<p>   ,          ,     ,     ,         ,          .</p><br>
<p><strong>  ,   :</strong></p><br>
<p>,   ,        ,    .       —       Future.</p><br>
<p>  ,      ,    ,      I/O ,          —     /   .     ,      .       :</p><br>
<ol>
<li> ,  .     ,      —     .</li>
<li>    —     Future   ,   .  , /   ,  ,     (  ,     —    IOException  ,        ,   ).</li>
</ol><br>
<p> ,   —            (   ID       ,  ,    ),        .</p><br>
<hr><br>
<p> ,    ,        .      ,    ,             .</p><br>
<h3 id="plany-na-buduschee">  </h3><br>
<ol>
<li> Web UI:   ,   .     ,     </li>
<li>   </li>
<li>    </li>
<li>   </li>
<li>   </li>
</ol><br>
<h3 id="zaklyuchenie"></h3><br>
<p>  :</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong>GitHub</strong></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><strong>Docker Hub</strong></a></li>
</ul><br>
<p>  ,   !           ,       GitHub!<br>
</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459462/index.html">YandexのSEO。すべて検索しますか？</a></li>
<li><a href="../ja459464/index.html">Lua in Moscow 2019：Roberto Jerusalemへのインタビュー</a></li>
<li><a href="../ja459470/index.html">パート4：RISC-RISC-VでLinuxを引き続き実行する</a></li>
<li><a href="../ja459472/index.html">Heroku + Docker + Spring Boot</a></li>
<li><a href="../ja459474/index.html">1秒で完全に入力されたテキストを作成する方法：たくさん書く人のためのWordのマクロ</a></li>
<li><a href="../ja459480/index.html">Vivaldi：ブラウザはどのようにしてお金を稼ぐのですか？</a></li>
<li><a href="../ja459482/index.html">カテゴリツリーを倒した方法</a></li>
<li><a href="../ja459484/index.html">世代Arduino。現代の学生が発明したもの</a></li>
<li><a href="../ja459488/index.html">ローグライクのコンテキストでの特別なゲームモード</a></li>
<li><a href="../ja459490/index.html">CRMベンダーの汚いトリック：車輪のない車を購入しますか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>