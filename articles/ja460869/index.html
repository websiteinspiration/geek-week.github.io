<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐻 👩🏿‍⚕️ 🕶️ YOLOv3を使用したiOSでのリアルタイムオブジェクト認識 🌧️ 🚂 💴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="みなさん、こんにちは！
 
 この記事では、物体の検出と認識（物体の検出）の問題をリアルタイムで解決する小さなプログラムを作成します。プログラムは、iOSプラットフォーム用のSwiftプログラミング言語で記述されます。オブジェクトを検出するために、YOLOv3と呼ばれるアーキテクチャを持つ畳み込みニ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>YOLOv3を使用したiOSでのリアルタイムオブジェクト認識</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460869/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/gr/ah/g9/grahg9mh7movhc2fcbn7m-yfoxu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
みなさん、こんにちは！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、物体の検出と認識（物体の検出）の問題をリアルタイムで解決する小さなプログラムを作成します。</font><font style="vertical-align: inherit;">プログラムは、iOSプラットフォーム用のSwiftプログラミング言語で記述されます。</font><font style="vertical-align: inherit;">オブジェクトを検出するために、YOLOv3と呼ばれるアーキテクチャを持つ畳み込みニューラルネットワークを使用します。</font><font style="vertical-align: inherit;">この記事では、CoreMLフレームワークを使用してニューラルネットワークをiOSで操作する方法、YOLOv3ネットワークとは何か、このネットワークの出力を使用および処理する方法について少し理解します。</font><font style="vertical-align: inherit;">また、プログラムの動作を確認し、YOLOv3のいくつかのバリエーションであるYOLOv3-tinyとYOLOv3-416を比較します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースは記事の最後にありますので、誰もがデバイスでニューラルネットワークの動作をテストすることができます。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクト検出</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、画像内のオブジェクトを検出するタスク（オブジェクト検出）が何であるか、および今日これに使用されているツールについて簡単に理解します。多くの人がこのトピックに精通していることを理解していますが、私はそれについて少し自分自身に話すことを許可しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、コンピュータビジョンの分野における多くのタスクは、畳み込みニューラルネットワーク（畳み込みニューラルネットワーク）（以下、CNN）の助けを借りて解決されています。それらの構造により、画像から特徴をうまく抽出します。 CNNは、分類、認識、セグメンテーションなどで使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクト認識のための一般的なCNNアーキテクチャ：</font></font><br>
<br>
<ul>
<li><b>R-CNN.</b>        .     .            .          .</li>
<li><b>Fast R-CNN.</b>      R-CNN,    ,        CNN,       .         .</li>
<li><b>Faster R-CNN.</b>      ,   selective search          «».</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヨロ。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前のものとはまったく異なる動作原理では、リージョンをまったく使用していません。</font><font style="vertical-align: inherit;">最速。</font><font style="vertical-align: inherit;">詳細については、記事で説明します。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原則としてYOLOに似ていますが、特徴を抽出するためのネットワークとしてVGG16を使用します。</font><font style="vertical-align: inherit;">また、非常に高速で、リアルタイム作業に適しています。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能ピラミッドネットワーク（FPN）。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シングルショット検出器などの別のタイプのネットワークは、特徴抽出の機能により、SSDで認識される小さなオブジェクトよりも優れています。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RetinaNet。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPN + ResNetの組み合わせを使用し、エラー（焦点損失）の特別な機能のおかげで、より高い精度（精度）が得られます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、YOLOアーキテクチャー、つまり最新の変更であるYOLOv3を使用します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜYOLOなのか？</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/i4/fy/lq/i4fylqlbpgsp-mu3w6k96zd5e1u.jpeg"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
YOLOまたはYou Only Look Onceは現在CNNで非常に人気のあるアーキテクチャであり、画像内の複数のオブジェクトを認識するために使用されます。それに関するより完全な情報は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークで入手できます。同じ場所に、このネットワークの理論と数学的要素が詳細に説明されている出版物を見つけることができ、トレーニングのプロセスも説明されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他と比較したこのアーキテクチャの主な特徴は、ほとんどのシステムがCNNを画像の異なる領域に数回適用することです; YOLOでは、CNNは一度に画像全体に一度に適用されます。ネットワークは画像を一種のグリッドに分割し、境界ボックスと各セクションに目的のオブジェクトが存在する可能性を予測します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチの利点は、ネットワークが画像全体を一度に見て、オブジェクトを検出して認識するときにコンテキストを考慮することです。</font><font style="vertical-align: inherit;">YOLOは、R-CNNよりも1000倍高速で、Fast R-CNNよりも約100倍高速です。</font><font style="vertical-align: inherit;">この記事では、オンライン処理のためにモバイルデバイスでネットワークを立ち上げるため、これが私たちにとって最も重要な品質です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーキテクチャの比較の詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらをご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YOLOv3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
YOLOv3は、YOLOアーキテクチャの改良版です。</font><font style="vertical-align: inherit;">106の畳み込み層で構成され、前作のYOLOv2と比較して小さなオブジェクトをよりよく検出します。</font><font style="vertical-align: inherit;">YOLOv3の主な機能は、出力に3つのレイヤーがあり、それぞれが異なるサイズのオブジェクトを検出するように設計されていることです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下の図は、その概略構造を示しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/rf/_j/clrf_jqzkt1qfszivfchhxkujv4.png"></div><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YOLOv3-tiny</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -YOLOv3アーキテクチャのクロップバージョンは、より少ないレイヤーで構成されます（出力レイヤーは2つしかありません）。</font><font style="vertical-align: inherit;">小さいオブジェクトをより予測しやすく、小さいデータセット用に設計されています。</font><font style="vertical-align: inherit;">ただし、切り詰められた構造のため、ネットワークの重みは少量のメモリ（約35 MB）を占有し、より高いFPSを生成します。</font><font style="vertical-align: inherit;">したがって、このようなアーキテクチャは、モバイルデバイスでの使用に適しています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">物体認識のためのプログラムを書いています</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
楽しい部分が始まります！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートフォンのカメラを使用して、画像内のさまざまなオブジェクトをリアルタイムで認識するアプリケーションを作成してみましょう。</font><font style="vertical-align: inherit;">すべてのコードはSwift 4.2プログラミング言語で記述され、iOSデバイスで実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このチュートリアルでは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COCO</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データセットで</font><font style="vertical-align: inherit;">事前</font><font style="vertical-align: inherit;">トレーニングさ</font><font style="vertical-align: inherit;">れたスケールを備えた既製のネットワークを使用します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">80種類のクラスがあります。</font><font style="vertical-align: inherit;">したがって、ニューロンは80の異なるオブジェクトを認識することができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DarknetからCoreMLへ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オリジナルYOLOv3アーキテクチャを使用して実装されて</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダークネットの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フレームワークを</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
iOSでは、バージョン11.0以降、</font><font style="vertical-align: inherit;">機械学習モデルをデバイスで直接実行できる</font><font style="vertical-align: inherit;">素晴らしい</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CoreML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリ</font><font style="vertical-align: inherit;">があります。ただし、1つの制限があります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムは、iOS 11以降を実行しているデバイスでのみ実行できます。</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
問題は、CoreMLが</font><i><font style="vertical-align: inherit;">.coreml</font></i><font style="vertical-align: inherit;">モデルの特定の形式のみを理解することです</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 Tensorflow、Keras、XGBoostなどの最も一般的なライブラリでは、CoreML形式に直接変換することが可能です。しかし、Darknetにはそのような可能性はありません。保存およびトレーニングされたモデルをDarknetからCoreMLに変換するには、さまざまなオプションを使用できます。たとえば、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Darknet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ONNX</font></a><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">保存し</font><font style="vertical-align: inherit;">てから、ONNXからCoreMLに変換できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より簡単な方法を使用し、YOLOv3のKeras実装を使用します。アクションのアルゴリズムは次のとおりです。Darknetの重みをKerasモデルにロードし、Keras形式で保存して、これからCoreMLに直接変換します。</font></font><br>
<br>
<ol>
<li><b> Darknet.</b>     Darknet-YOLOv3 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.        : YOLOv3-416  YOLOv3-tiny.     cfg  weights. </li>
<li><b> Darknet  Keras.</b>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,       : <br>
<br>
<pre><code class="bash hljs">python convert.py yolov3.cfg yolov3.weights yolo.h5</code></pre><br>
 yolov3.cfg  yolov3.weights   Darknet.          <i>.h5</i> —      YOLOv3   Keras.</li>
<li><b> Keras  CoreML.</b>   .  ,      CoreML     python (    coremltools  ):<br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> coremltools<font></font>
coreml_model = coremltools.converters.keras.convert(<font></font>
    <span class="hljs-string">'yolo.h5'</span>,<font></font>
    input_names=<span class="hljs-string">'image'</span>,<font></font>
    image_input_names=<span class="hljs-string">'image'</span>,<font></font>
    input_name_shape_dict={<span class="hljs-string">'image'</span>: [<span class="hljs-literal">None</span>, <span class="hljs-number">416</span>, <span class="hljs-number">416</span>, <span class="hljs-number">3</span>]}, <span class="hljs-comment">#     </span>
    image_scale=<span class="hljs-number">1</span>/<span class="hljs-number">255.</span>)<font></font>
<font></font>
coreml_model.input_description[<span class="hljs-string">'image'</span>] = <span class="hljs-string">'Input image'</span><font></font>
<font></font>
coreml_model.save(<span class="hljs-string">'yolo.mlmodel'</span>)</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の手順は、YOLOv3-416とYOLOv3-tinyの2つのモデルで実行する必要があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これをすべて行うと、yolo.mlmodelとyolo-tiny.mlmodelという2つのファイルができます。</font><font style="vertical-align: inherit;">これで、アプリケーション自体のコードを書き始めることができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iOSアプリの作成</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのアプリケーションコードについては説明しませんが、記事の最後に記載されているリポジトリリンクで確認できます。ここでは、3つのUIViewController-a（OnlineViewController、PhotoViewController、SettingsViewController）があるとだけ言います。 1つ目は、カメラの出力と各フレームのオブジェクトのオンライン検出です。 2番目では、写真を撮るか、ギャラリーから写真を選択して、これらの画像でネットワークをテストできます。 3番目の設定には設定が含まれています。YOLOv3-416またはYOLOv3-tinyモデルを選択し、しきい値IoU（和集合の交差）とオブジェクト信頼度（現在の画像セクションにオブジェクトが存在する確率）を選択できます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CoreMLへのモデルの読み込み</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
トレーニング済みモデルをDarknet形式からCoreMLに変換すると、拡張子</font><i><font style="vertical-align: inherit;">.mlmodelの</font></i><font style="vertical-align: inherit;">ファイルができます。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私の場合、</font><font style="vertical-align: inherit;">モデルYOLOv3-416とYOLOv3-tiny用に、それぞれ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yolo.mlmodel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yolo-tiny.mlmodelの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2つのファイルを作成しまし</font><font style="vertical-align: inherit;">た。</font><font style="vertical-align: inherit;">これで、これらのファイルをXcodeのプロジェクトにロードできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ModelProviderクラスを作成します。これは、実行のためにニューラルネットワークを非同期的に呼び出すための現在のモデルとメソッドを格納します。</font><font style="vertical-align: inherit;">モデルのロードは次のように実行されます。</font></font><br>
<br>
<pre><code class="swift hljs">  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">loadModel</span><span class="hljs-params">(type: YOLOType)</span></span> {
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">self</span>.model = <span class="hljs-keyword">try</span> <span class="hljs-type">YOLO</span>(type: type)<font></font>
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-built_in">assertionFailure</span>(<span class="hljs-string">"error creating model"</span>)<font></font>
    }<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
YOLOクラスは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.mlmodel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルの</font><font style="vertical-align: inherit;">ロード</font><font style="vertical-align: inherit;">とモデル出力の処理を</font><font style="vertical-align: inherit;">直接担当し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">モデルファイルをダウンロードします。</font></font><br>
<br>
<pre><code class="swift hljs">    <span class="hljs-keyword">var</span> url: <span class="hljs-type">URL?</span> = <span class="hljs-literal">nil</span>
    <span class="hljs-keyword">self</span>.type = type
    <span class="hljs-keyword">switch</span> type {
    <span class="hljs-keyword">case</span> .v3_Tiny:<font></font>
      url = <span class="hljs-type">Bundle</span>.main.url(forResource: <span class="hljs-string">"yolo-tiny"</span>, withExtension:<span class="hljs-string">"mlmodelc"</span>)
      <span class="hljs-keyword">self</span>.anchors = tiny_anchors
    <span class="hljs-keyword">case</span> .v3_416:<font></font>
      url = <span class="hljs-type">Bundle</span>.main.url(forResource: <span class="hljs-string">"yolo"</span>, withExtension:<span class="hljs-string">"mlmodelc"</span>)
      <span class="hljs-keyword">self</span>.anchors = anchors_416<font></font>
    }<font></font>
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> modelURL = url <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-type">YOLOError</span>.modelFileNotFound<font></font>
    }<font></font>
    <span class="hljs-keyword">do</span> {<font></font>
      model = <span class="hljs-keyword">try</span> <span class="hljs-type">MLModel</span>(contentsOf: modelURL)<font></font>
    } <span class="hljs-keyword">catch</span> <span class="hljs-keyword">let</span> error {
      <span class="hljs-built_in">print</span>(error)
      <span class="hljs-keyword">throw</span> <span class="hljs-type">YOLOError</span>.modelCreationError<font></font>
    }<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全なModelProviderコード。</font></font></b><div class="spoiler_text"><pre><code class="swift hljs"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> CoreML<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">protocol</span> <span class="hljs-title">ModelProviderDelegate</span>: <span class="hljs-title">class</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">show</span><span class="hljs-params">(predictions: [YOLO.Prediction]?,
            stat: ModelProvider.Statistics,
            error: YOLOError?)</span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@available</span>(macOS <span class="hljs-number">10.13</span>, iOS <span class="hljs-number">11.0</span>, tvOS <span class="hljs-number">11.0</span>, watchOS <span class="hljs-number">4.0</span>, *)
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelProvider</span> </span>{<font></font>
  <font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Statistics</span> </span>{
    <span class="hljs-keyword">var</span> timeForFrame: <span class="hljs-type">Float</span>
    <span class="hljs-keyword">var</span> fps: <span class="hljs-type">Float</span><font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared = <span class="hljs-type">ModelProvider</span>(modelType: <span class="hljs-type">Settings</span>.shared.modelType)<font></font>
  <font></font>
  <span class="hljs-keyword">var</span> model: <span class="hljs-type">YOLO!</span>
  <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">ModelProviderDelegate?</span><font></font>
  <font></font>
  <span class="hljs-keyword">var</span> predicted = <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> timeOfFirstFrameInSecond = <span class="hljs-type">CACurrentMediaTime</span>()<font></font>
  <font></font>
  <span class="hljs-keyword">init</span>(modelType type: <span class="hljs-type">YOLOType</span>) {<font></font>
    loadModel(type: type)<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reloadModel</span><span class="hljs-params">(type: YOLOType)</span></span> {<font></font>
    loadModel(type: type)<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">loadModel</span><span class="hljs-params">(type: YOLOType)</span></span> {
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">self</span>.model = <span class="hljs-keyword">try</span> <span class="hljs-type">YOLO</span>(type: type)<font></font>
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-built_in">assertionFailure</span>(<span class="hljs-string">"error creating model"</span>)<font></font>
    }<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">predict</span><span class="hljs-params">(frame: UIImage)</span></span> {
    <span class="hljs-type">DispatchQueue</span>.global().async {
      <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">let</span> startTime = <span class="hljs-type">CACurrentMediaTime</span>()
        <span class="hljs-keyword">let</span> predictions = <span class="hljs-keyword">try</span> <span class="hljs-keyword">self</span>.model.predict(frame: frame)
        <span class="hljs-keyword">let</span> elapsed = <span class="hljs-type">CACurrentMediaTime</span>() - startTime
        <span class="hljs-keyword">self</span>.showResultOnMain(predictions: predictions, elapsed: <span class="hljs-type">Float</span>(elapsed), error: <span class="hljs-literal">nil</span>)<font></font>
      } <span class="hljs-keyword">catch</span> <span class="hljs-keyword">let</span> error <span class="hljs-keyword">as</span> <span class="hljs-type">YOLOError</span> {
        <span class="hljs-keyword">self</span>.showResultOnMain(predictions: <span class="hljs-literal">nil</span>, elapsed: -<span class="hljs-number">1</span>, error: error)<font></font>
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">self</span>.showResultOnMain(predictions: <span class="hljs-literal">nil</span>, elapsed: -<span class="hljs-number">1</span>, error: <span class="hljs-type">YOLOError</span>.unknownError)<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">showResultOnMain</span><span class="hljs-params">(predictions: [YOLO.Prediction]?,
                                elapsed: Float, error: YOLOError?)</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> delegate = <span class="hljs-keyword">self</span>.delegate {
      <span class="hljs-type">DispatchQueue</span>.main.async {
        <span class="hljs-keyword">let</span> fps = <span class="hljs-keyword">self</span>.measureFPS()<font></font>
        delegate.show(predictions: predictions,<font></font>
                      stat: <span class="hljs-type">ModelProvider</span>.<span class="hljs-type">Statistics</span>(timeForFrame: elapsed,<font></font>
                                                     fps: fps),<font></font>
                      error: error)<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">measureFPS</span><span class="hljs-params">()</span></span> -&gt; <span class="hljs-type">Float</span> {<font></font>
    predicted += <span class="hljs-number">1</span>
    <span class="hljs-keyword">let</span> elapsed = <span class="hljs-type">CACurrentMediaTime</span>() - timeOfFirstFrameInSecond
    <span class="hljs-keyword">let</span> currentFPSDelivered = <span class="hljs-type">Double</span>(predicted) / elapsed
    <span class="hljs-keyword">if</span> elapsed &gt; <span class="hljs-number">1</span> {<font></font>
      predicted = <span class="hljs-number">0</span>
      timeOfFirstFrameInSecond = <span class="hljs-type">CACurrentMediaTime</span>()<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-type">Float</span>(currentFPSDelivered)<font></font>
  }<font></font>
  <font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニューラルネットワークの出力の処理</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
次に</font><b><font style="vertical-align: inherit;">、ニューラルネットワーク</font></b><font style="vertical-align: inherit;">の出力を処理し、対応する境界ボックスを取得する方法を説明します。</font><font style="vertical-align: inherit;">Xcodeでは、モデルファイルを選択すると、それらが何であるかを確認し、出力レイヤーを確認できます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/m_/3b/vz/m_3bvzkroynfyfkpv1fal-ydf_k.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YOLOv3-tinyの出入り。</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0l/nl/hy/0lnlhydblax7trhpzdte8bojc0y.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">入口と出口YOLOv3-416。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上の画像を見るとわかるように、さまざまなオブジェクトの境界ボックスがそれぞれ予測される、YOLOv3-416用に3つ、YOLOv3-tiny出力用に2つあります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、これは通常の数値の配列です。それを解析する方法を理解しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
YOLOv3モデルは、画像を異なるグリッドに分割するための出力として3つのレイヤーを使用します。これらのグリッドのセルサイズには、8、16、32の値があります。入力に416x416ピクセルの画像があるとすると、出力マトリックス（グリッド）のサイズは52x52になります。 、26x26および13x13（416/8 = 52、416 / 16 = 26および416/32 = 13）。</font><font style="vertical-align: inherit;">YOLOv3-tinyの場合、すべては同じですが、3つのグリッドの代わりに、16と32の2つがあります。つまり、26x26と13x13の次元の行列です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロードされたCoreMLモデルを開始した後、出力にMLMultiArrayクラスの2つ（または3つ）のオブジェクトを取得します。これらのオブジェクトの形状プロパティを見ると、次の画像が表示されます（YOLOv3-tinyの場合）。</font></font><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mo stretchy=&quot;false&quot;>[</mo><mn>1</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>255</mn><mo>,</mo><mn>26</mn><mo>,</mo><mn>26</mn><mo stretchy=&quot;false&quot;>]</mo><mspace linebreak=&quot;newline&quot; /><mo stretchy=&quot;false&quot;>[</mo><mn>1</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>255</mn><mo>,</mo><mn>13</mn><mo>,</mo><mn>13</mn><mo stretchy=&quot;false&quot;>]</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="97.25ex" height="6.009ex" viewBox="0 -809.3 41871.4 2587.3" role="img" focusable="false" style="vertical-align: -4.13ex; max-width: 778px;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(17514,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-31" x="278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-31" x="1224" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="1724" y="0"></use><g transform="translate(2169,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-35" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-35" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="3671" y="0"></use><g transform="translate(4116,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-36" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="5117" y="0"></use><g transform="translate(5562,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-36" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5D" x="6563" y="0"></use></g><g transform="translate(17514,-1433)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5B" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-31" x="278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-31" x="1224" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="1724" y="0"></use><g transform="translate(2169,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-32"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-35" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-35" x="1001" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="3671" y="0"></use><g transform="translate(4116,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-33" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="5117" y="0"></use><g transform="translate(5562,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-33" x="500" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5D" x="6563" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mo stretchy="false">[</mo><mn>1</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>255</mn><mo>,</mo><mn>26</mn><mo>,</mo><mn>26</mn><mo stretchy="false">]</mo><mspace linebreak="newline"></mspace><mo stretchy="false">[</mo><mn>1</mn><mo>,</mo><mn>1</mn><mo>,</mo><mn>255</mn><mo>,</mo><mn>13</mn><mo>,</mo><mn>13</mn><mo stretchy="false">]</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1">[1, 1, 255, 26, 26]\\ [1, 1, 255, 13, 13]</script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
予想通り、マトリックスの次元は26x26と13x13になりますが、255という数字はどういう意味ですか？前述のように、出力層は52x52、26x26、13x13のマトリックスです。実際、この行列の各要素は数値ではなく、ベクトルです。つまり、出力層は3次元マトリックスです。このベクトルの次元はB x（5 + C）です。Bはセル内のバウンディングボックスの数、Cはクラスの数です。 5という数字はどこから来たのですか？その理由は、ボックスaごとに、オブジェクト（オブジェクトの信頼度）が予測される確率は1つの数値であり、残りの4つは、予測されたボックスaのx、y、幅、高さです。次の図は、このベクトルの略図を示しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3d/j3/rl/3dj3rlk_te-4x-pthae9mreq7k0.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力レイヤー（機能マップ）の概略図。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
80クラスでトレーニングされたネットワークでは、パーティショングリッドのセルごとに3つの境界ボックス-aが予測されます。それぞれのセルについて、80クラスの確率+オブジェクト信頼度+このボックス-aの位置とサイズに関与する4つの数値が予測されます。</font><font style="vertical-align: inherit;">合計：3 x（5 + 80）= </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
255。MLMultiArrayクラスからこれらの値を取得するには、データ配列とアドレス演算への生のポインターを使用することをお勧めします。</font></font><br>
<br>
<pre><code class="swift hljs">    <span class="hljs-keyword">let</span> pointer = <span class="hljs-type">UnsafeMutablePointer</span>&lt;<span class="hljs-type">Double</span>&gt;(<span class="hljs-type">OpaquePointer</span>(out.dataPointer)) <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">if</span> out.strides.<span class="hljs-built_in">count</span> &lt; <span class="hljs-number">3</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-type">YOLOError</span>.strideOutOfBounds<font></font>
    }<font></font>
    <span class="hljs-keyword">let</span> channelStride = out.strides[out.strides.<span class="hljs-built_in">count</span>-<span class="hljs-number">3</span>].intValue
    <span class="hljs-keyword">let</span> yStride = out.strides[out.strides.<span class="hljs-built_in">count</span>-<span class="hljs-number">2</span>].intValue
    <span class="hljs-keyword">let</span> xStride = out.strides[out.strides.<span class="hljs-built_in">count</span>-<span class="hljs-number">1</span>].intValue
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">offset</span><span class="hljs-params">(ch: Int, x: Int, y: Int)</span></span> -&gt; <span class="hljs-type">Int</span> { <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">return</span> ch * channelStride + y * yStride + x * xStride<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、255要素のベクトルを処理する必要があります。</font><font style="vertical-align: inherit;">ボックスごとに、80クラスの確率分布を取得する必要があります。これは、softmax関数を使用して行うことができます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソフトマックスとは</font></font></b><div class="spoiler_text">   <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>x</mi></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.227ex" height="1.581ex" viewBox="0 -555.6 528.5 680.6" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.29ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-78" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="double-struck">x</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-2">\mathbb x</script>  K     ,    <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>x</mi></mrow><mi>i</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.027ex" height="1.866ex" viewBox="0 -555.6 872.8 803.6" role="img" focusable="false" aria-hidden="true" style="vertical-align: -0.576ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-69" x="747" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="double-struck">x</mi></mrow><mi>i</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-3">\mathbb x_i</script>        [0,1]     1.<p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>&amp;#x03C3;</mi><mo stretchy=&quot;false&quot;>(</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi mathvariant=&quot;double-struck&quot;>x</mi></mrow><msub><mo stretchy=&quot;false&quot;>)</mo><mi>i</mi></msub><mo>=</mo><mfrac><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mi>i</mi></msub></mrow></msup><mrow><munderover><mo>&amp;#x2211;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>K</mi></mrow></munderover><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msub><mi>x</mi><mi>k</mi></msub></mrow></msup></mrow></mrow></mfrac></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="18.157ex" height="6.438ex" viewBox="0 -1416.7 7817.5 2771.8" role="img" focusable="false" aria-hidden="true" style="vertical-align: -3.148ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-3C3" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-28" x="572" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-78" x="962" y="0"></use><g transform="translate(1490,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-69" x="550" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-3D" x="2502" y="0"></use><g transform="translate(3280,0)"><g transform="translate(397,0)"><rect stroke="none" width="4019" height="60" x="0" y="220"></rect><g transform="translate(1402,676)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,362)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-69" x="809" y="-213"></use></g></g><g transform="translate(60,-956)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJSZ1-2211" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-4B" x="1494" y="675"></use><g transform="translate(1056,-287)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-6B" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-3D" x="521" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-31" x="1300" y="0"></use></g><g transform="translate(2596,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,288)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-6B" x="809" y="-213"></use></g></g></g></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>σ</mi><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mi mathvariant="double-struck">x</mi></mrow><msub><mo stretchy="false">)</mo><mi>i</mi></msub><mo>=</mo><mfrac><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>x</mi><mi>i</mi></msub></mrow></msup><mrow><munderover><mo>∑</mo><mrow class="MJX-TeXAtom-ORD"><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>K</mi></mrow></munderover><mrow class="MJX-TeXAtom-ORD"><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><msub><mi>x</mi><mi>k</mi></msub></mrow></msup></mrow></mrow></mfrac></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-4">\sigma(\mathbb{x})_i = \frac{e^{x_i}}{\sum_{k=1}^{K}{e^{x_k}}} </script></p> K —  .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SwiftのSoftmax関数：</font></font><br>
<br>
<pre><code class="swift hljs"> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">softmax</span><span class="hljs-params">(<span class="hljs-number">_</span> x: <span class="hljs-keyword">inout</span> [Float])</span></span> {
    <span class="hljs-keyword">let</span> len = vDSP_Length(x.<span class="hljs-built_in">count</span>)
    <span class="hljs-keyword">var</span> <span class="hljs-built_in">count</span> = <span class="hljs-type">Int32</span>(x.<span class="hljs-built_in">count</span>)<font></font>
    vvexpf(&amp;x, x, &amp;<span class="hljs-built_in">count</span>)
    <span class="hljs-keyword">var</span> sum: <span class="hljs-type">Float</span> = <span class="hljs-number">0</span>
    vDSP_sve(x, <span class="hljs-number">1</span>, &amp;sum, len)<font></font>
    vDSP_vsdiv(x, <span class="hljs-number">1</span>, &amp;sum, &amp;x, <span class="hljs-number">1</span>, len)<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
境界ボックスの座標とサイズを取得するには、式を使用する必要があります。</font></font><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display"><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>x</mi><mo>=</mo><mi>&amp;#x03C3;</mi><mo stretchy=&quot;false&quot;>(</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x005E;</mo></mover></mrow><mo stretchy=&quot;false&quot;>)</mo><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub><mspace linebreak=&quot;newline&quot; /><mi>y</mi><mo>=</mo><mi>&amp;#x03C3;</mi><mo stretchy=&quot;false&quot;>(</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>y</mi><mo stretchy=&quot;false&quot;>&amp;#x005E;</mo></mover></mrow><mo stretchy=&quot;false&quot;>)</mo><mo>+</mo><msub><mi>c</mi><mi>y</mi></msub><mspace linebreak=&quot;newline&quot; /><mi>w</mi><mo>=</mo><msub><mi>p</mi><mi>w</mi></msub><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>w</mi><mo stretchy=&quot;false&quot;>&amp;#x005E;</mo></mover></mrow></mrow></msup><mspace linebreak=&quot;newline&quot; /><mi>h</mi><mo>=</mo><msub><mi>p</mi><mi>h</mi></msub><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>h</mi><mo stretchy=&quot;false&quot;>&amp;#x005E;</mo></mover></mrow></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="97.25ex" height="13.759ex" viewBox="0 -809.3 41871.4 5924.1" role="img" focusable="false" style="vertical-align: -11.88ex; max-width: 778px;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(17939,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-3D" x="850" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-3C3" x="1906" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-28" x="2479" y="0"></use><g transform="translate(2868,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5E" x="63" y="-7"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-29" x="3441" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2B" x="4052" y="0"></use><g transform="translate(5053,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-63" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-78" x="613" y="-213"></use></g></g><g transform="translate(18009,-1433)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-79" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-3D" x="775" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-3C3" x="1831" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-28" x="2404" y="0"></use><g transform="translate(2793,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-79" x="1" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5E" x="60" y="-6"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-29" x="3354" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2B" x="3965" y="0"></use><g transform="translate(4966,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-63" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-79" x="613" y="-213"></use></g></g><g transform="translate(18815,-3084)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-77" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-3D" x="994" y="0"></use><g transform="translate(2050,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-77" x="712" y="-213"></use></g><g transform="translate(3160,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-77" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5E" x="225" y="28"></use></g></g></g><g transform="translate(18987,-4811)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-68" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-3D" x="854" y="0"></use><g transform="translate(1910,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-68" x="712" y="-213"></use></g><g transform="translate(2921,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-68" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5E" x="-2" y="279"></use></g></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>x</mi><mo>=</mo><mi>σ</mi><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mover><mi>x</mi><mo stretchy="false">^</mo></mover></mrow><mo stretchy="false">)</mo><mo>+</mo><msub><mi>c</mi><mi>x</mi></msub><mspace linebreak="newline"></mspace><mi>y</mi><mo>=</mo><mi>σ</mi><mo stretchy="false">(</mo><mrow class="MJX-TeXAtom-ORD"><mover><mi>y</mi><mo stretchy="false">^</mo></mover></mrow><mo stretchy="false">)</mo><mo>+</mo><msub><mi>c</mi><mi>y</mi></msub><mspace linebreak="newline"></mspace><mi>w</mi><mo>=</mo><msub><mi>p</mi><mi>w</mi></msub><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mover><mi>w</mi><mo stretchy="false">^</mo></mover></mrow></mrow></msup><mspace linebreak="newline"></mspace><mi>h</mi><mo>=</mo><msub><mi>p</mi><mi>h</mi></msub><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><mrow class="MJX-TeXAtom-ORD"><mover><mi>h</mi><mo stretchy="false">^</mo></mover></mrow></mrow></msup></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-5">x = \sigma(\hat x) + c_x\\y=\sigma(\hat y)+c_y\\w=p_we^{\hat w}\\h=p_he^{\hat h} </script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どこ </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x005E;</mo></mover></mrow><mo>,</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>y</mi><mo stretchy=&quot;false&quot;>&amp;#x005E;</mo></mover></mrow><mo>,</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>w</mi><mo stretchy=&quot;false&quot;>&amp;#x005E;</mo></mover></mrow><mo>,</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>h</mi><mo stretchy=&quot;false&quot;>&amp;#x005E;</mo></mover></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.737ex" height="3.009ex" viewBox="0 -1024.6 3761.7 1295.7" role="img" focusable="false" style="vertical-align: -0.63ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5E" x="63" y="-7"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="572" y="0"></use><g transform="translate(1017,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-79" x="1" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5E" x="60" y="-6"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="1578" y="0"></use><g transform="translate(2023,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-77" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5E" x="191" y="-6"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="2740" y="0"></use><g transform="translate(3185,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-68" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-5E" x="10" y="245"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mrow class="MJX-TeXAtom-ORD"><mover><mi>x</mi><mo stretchy="false">^</mo></mover></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mover><mi>y</mi><mo stretchy="false">^</mo></mover></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mover><mi>w</mi><mo stretchy="false">^</mo></mover></mrow><mo>,</mo><mrow class="MJX-TeXAtom-ORD"><mover><mi>h</mi><mo stretchy="false">^</mo></mover></mrow></math></span></span><script type="math/tex" id="MathJax-Element-6">\hat x, \hat y, \hat w, \hat h</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -予測されたx、y座標、幅、高さ </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>&amp;#x03C3;</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.469ex" height="2.634ex" viewBox="0 -809.3 1924 1134.2" role="img" focusable="false" style="vertical-align: -0.755ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-3C3" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-28" x="572" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-78" x="962" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-29" x="1534" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>σ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-7">\sigma(x)</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> シグモイド関数であり、 </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>w</mi></msub><mo>,</mo><msub><mi>p</mi><mi>h</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.05ex" height="1.884ex" viewBox="-38.5 -540.2 2605 811.3" role="img" focusable="false" style="vertical-align: -0.63ex; margin-left: -0.089ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-77" x="712" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-2C" x="1110" y="0"></use><g transform="translate(1555,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMATHI-68" x="712" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>p</mi><mi>w</mi></msub><mo>,</mo><msub><mi>p</mi><mi>h</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-8">p_w, p_h</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-3つのボックスのアンカーの値。</font><font style="vertical-align: inherit;">これらの値はトレーニング中に決定され、Helpers.swiftファイルで設定されます。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> anchors1: [<span class="hljs-type">Float</span>] = [<span class="hljs-number">116</span>,<span class="hljs-number">90</span>,  <span class="hljs-number">156</span>,<span class="hljs-number">198</span>,  <span class="hljs-number">373</span>,<span class="hljs-number">326</span>] <span class="hljs-comment">//    </span>
<span class="hljs-keyword">let</span> anchors2: [<span class="hljs-type">Float</span>] = [<span class="hljs-number">30</span>,<span class="hljs-number">61</span>,  <span class="hljs-number">62</span>,<span class="hljs-number">45</span>,  <span class="hljs-number">59</span>,<span class="hljs-number">119</span>] <span class="hljs-comment">//    </span>
<span class="hljs-keyword">let</span> anchors3: [<span class="hljs-type">Float</span>] = [<span class="hljs-number">10</span>,<span class="hljs-number">13</span>,  <span class="hljs-number">16</span>,<span class="hljs-number">30</span>,  <span class="hljs-number">33</span>,<span class="hljs-number">23</span>] <span class="hljs-comment">//    </span>
</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ng/zf/pv/ngzfpvvch8bhnkdapz6url5ok-w.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">境界ボックスの位置の計算の概略図。</font></font></i><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力レイヤーを処理するための完全なコード。</font></font></b><div class="spoiler_text"><pre><code class="swift hljs">  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">process</span><span class="hljs-params">(output out: MLMultiArray, name: String)</span></span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">Prediction</span>] {
    <span class="hljs-keyword">var</span> predictions = [<span class="hljs-type">Prediction</span>]()
    <span class="hljs-keyword">let</span> grid = out.shape[out.shape.<span class="hljs-built_in">count</span>-<span class="hljs-number">1</span>].intValue
    <span class="hljs-keyword">let</span> gridSize = <span class="hljs-type">YOLO</span>.inputSize / <span class="hljs-type">Float</span>(grid)
    <span class="hljs-keyword">let</span> classesCount = labels.<span class="hljs-built_in">count</span>
    <span class="hljs-built_in">print</span>(out.shape)
    <span class="hljs-keyword">let</span> pointer = <span class="hljs-type">UnsafeMutablePointer</span>&lt;<span class="hljs-type">Double</span>&gt;(<span class="hljs-type">OpaquePointer</span>(out.dataPointer))
    <span class="hljs-keyword">if</span> out.strides.<span class="hljs-built_in">count</span> &lt; <span class="hljs-number">3</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-type">YOLOError</span>.strideOutOfBounds<font></font>
    }<font></font>
    <span class="hljs-keyword">let</span> channelStride = out.strides[out.strides.<span class="hljs-built_in">count</span>-<span class="hljs-number">3</span>].intValue
    <span class="hljs-keyword">let</span> yStride = out.strides[out.strides.<span class="hljs-built_in">count</span>-<span class="hljs-number">2</span>].intValue
    <span class="hljs-keyword">let</span> xStride = out.strides[out.strides.<span class="hljs-built_in">count</span>-<span class="hljs-number">1</span>].intValue
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">offset</span><span class="hljs-params">(ch: Int, x: Int, y: Int)</span></span> -&gt; <span class="hljs-type">Int</span> {
      <span class="hljs-keyword">return</span> ch * channelStride + y * yStride + x * xStride<font></font>
    }<font></font>
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> ..&lt; grid {
      <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> ..&lt; grid {
        <span class="hljs-keyword">for</span> box_i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> ..&lt; <span class="hljs-type">YOLO</span>.boxesPerCell {
          <span class="hljs-keyword">let</span> boxOffset = box_i * (classesCount + <span class="hljs-number">5</span>)
          <span class="hljs-keyword">let</span> bbx = <span class="hljs-type">Float</span>(pointer[offset(ch: boxOffset, x: x, y: y)])
          <span class="hljs-keyword">let</span> bby = <span class="hljs-type">Float</span>(pointer[offset(ch: boxOffset + <span class="hljs-number">1</span>, x: x, y: y)])
          <span class="hljs-keyword">let</span> bbw = <span class="hljs-type">Float</span>(pointer[offset(ch: boxOffset + <span class="hljs-number">2</span>, x: x, y: y)])
          <span class="hljs-keyword">let</span> bbh = <span class="hljs-type">Float</span>(pointer[offset(ch: boxOffset + <span class="hljs-number">3</span>, x: x, y: y)])
          <span class="hljs-keyword">let</span> confidence = sigmoid(<span class="hljs-type">Float</span>(pointer[offset(ch: boxOffset + <span class="hljs-number">4</span>, x: x, y: y)]))
          <span class="hljs-keyword">if</span> confidence &lt; confidenceThreshold {
            <span class="hljs-keyword">continue</span><font></font>
          }<font></font>
          <span class="hljs-keyword">let</span> x_pos = (sigmoid(bbx) + <span class="hljs-type">Float</span>(x)) * gridSize
          <span class="hljs-keyword">let</span> y_pos = (sigmoid(bby) + <span class="hljs-type">Float</span>(y)) * gridSize
          <span class="hljs-keyword">let</span> width = exp(bbw) * <span class="hljs-keyword">self</span>.anchors[name]![<span class="hljs-number">2</span> * box_i]
          <span class="hljs-keyword">let</span> height = exp(bbh) * <span class="hljs-keyword">self</span>.anchors[name]![<span class="hljs-number">2</span> * box_i + <span class="hljs-number">1</span>]
          <span class="hljs-keyword">for</span> <span class="hljs-built_in">c</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> ..&lt; <span class="hljs-number">80</span> {<font></font>
            classes[<span class="hljs-built_in">c</span>] = <span class="hljs-type">Float</span>(pointer[offset(ch: boxOffset + <span class="hljs-number">5</span> + <span class="hljs-built_in">c</span>, x: x, y: y)])<font></font>
          }<font></font>
          softmax(&amp;classes)<font></font>
          <span class="hljs-keyword">let</span> (detectedClass, bestClassScore) = argmax(classes)
          <span class="hljs-keyword">let</span> confidenceInClass = bestClassScore * confidence
          <span class="hljs-keyword">if</span> confidenceInClass &lt; confidenceThreshold {
            <span class="hljs-keyword">continue</span><font></font>
          }<font></font>
          predictions.append(<span class="hljs-type">Prediction</span>(classIndex: detectedClass,<font></font>
                                  score: confidenceInClass,<font></font>
                                  rect: <span class="hljs-type">CGRect</span>(x: <span class="hljs-type">CGFloat</span>(x_pos - width / <span class="hljs-number">2</span>),<font></font>
                                               y: <span class="hljs-type">CGFloat</span>(y_pos - height / <span class="hljs-number">2</span>),<font></font>
                                               width: <span class="hljs-type">CGFloat</span>(width),<font></font>
                                               height: <span class="hljs-type">CGFloat</span>(height))))<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> predictions<font></font>
  }<font></font>
</code></pre><br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非最大抑制</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
画像内で見つかったすべてのオブジェクトのバウンディングボックスの座標とサイズ、および対応する確率を受け取ったら、それらを図の上に描画し始めることができます。</font><font style="vertical-align: inherit;">ただし、問題が1つあります。</font><font style="vertical-align: inherit;">このような状況は、1つのオブジェクトに対して、かなり高い確率で複数のボックスが予測される場合に発生する可能性があります。</font><font style="vertical-align: inherit;">この場合はどうしますか？</font><font style="vertical-align: inherit;">ここでは、非最大抑制と呼ばれるかなり単純なアルゴリズムが役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アルゴリズムは次のとおりです。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトに属する可能性が最も高い境界ボックスを探しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このオブジェクトに属するすべての境界ボックスを調べます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の境界ボックスとの交差（IoU）上の交差が指定されたしきい値より大きい場合、それらを削除します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IoUは単純な式を使用して計算されます。</font></font><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>IoU</mtext><mo>=</mo><mfrac><mtext>&amp;#x41F;&amp;#x43B;&amp;#x43E;&amp;#x449;&amp;#x430;&amp;#x434;&amp;#x44C; &amp;#x43F;&amp;#x435;&amp;#x440;&amp;#x435;&amp;#x441;&amp;#x435;&amp;#x447;&amp;#x435;&amp;#x43D;&amp;#x438;&amp;#x44F;</mtext><mtext>&amp;#x43F;&amp;#x43B;&amp;#x43E;&amp;#x449;&amp;#x430;&amp;#x434;&amp;#x44C; &amp;#x43E;&amp;#x431;&amp;#x44A;&amp;#x435;&amp;#x434;&amp;#x438;&amp;#x43D;&amp;#x435;&amp;#x43D;&amp;#x438;&amp;#x44F;</mtext></mfrac></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.208ex" height="5.759ex" viewBox="0 -1508.9 11714.4 2479.7" role="img" focusable="false" style="vertical-align: -2.255ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-49"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-6F" x="361" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-55" x="862" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://habr.com/ru/post/460869/&amp;usg=ALkJrhjJGI-wfwhmVZ4ShNebBeJyYL61aQ#MJMAIN-3D" x="1890" y="0"></use><g transform="translate(2668,0)"><g transform="translate(397,0)"><rect stroke="none" width="8527" height="60" x="0" y="220"></rect><g transform="translate(91,676)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text><g transform="translate(645,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(1076,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(1506,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(2206,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(2637,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(3075,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(3717,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(4202,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(4584,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(5015,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(5398,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(5780,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(6163,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(6596,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(6979,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(7463,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(7947,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g></g><g transform="translate(60,-729)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text><g transform="translate(484,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(914,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(1345,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(2045,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(2475,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(2913,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(3556,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(3987,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(4425,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(4870,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(5253,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(5691,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(6176,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(6660,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(7042,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(7527,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g><g transform="translate(8011,0)"><text font-family="STIXGeneral,'Arial Unicode MS',serif" stroke="none" transform="scale(53.819) matrix(1 0 0 -1 0 0)"></text></g></g></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtext>IoU</mtext><mo>=</mo><mfrac><mtext> </mtext><mtext> </mtext></mfrac></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-9">\text{IoU} = \frac{\text{ }}{\text{ }}</script></p><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IoUの計算。</font></font></b><div class="spoiler_text"><pre><code class="swift hljs">  <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IOU</span><span class="hljs-params">(a: CGRect, b: CGRect)</span></span> -&gt; <span class="hljs-type">Float</span> {
    <span class="hljs-keyword">let</span> areaA = a.width * a.height
    <span class="hljs-keyword">if</span> areaA &lt;= <span class="hljs-number">0</span> { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> }
    <span class="hljs-keyword">let</span> areaB = b.width * b.height
    <span class="hljs-keyword">if</span> areaB &lt;= <span class="hljs-number">0</span> { <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> }
    <span class="hljs-keyword">let</span> intersection = a.intersection(b)
    <span class="hljs-keyword">let</span> intersectionArea = intersection.width * intersection.height
    <span class="hljs-keyword">return</span> <span class="hljs-type">Float</span>(intersectionArea / (areaA + areaB - intersectionArea))<font></font>
  }<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非最大抑制。</font></font></b><div class="spoiler_text"><pre><code class="swift hljs">  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">nonMaxSuppression</span><span class="hljs-params">(boxes: <span class="hljs-keyword">inout</span> [Prediction], threshold: Float)</span></span> {
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> i &lt; boxes.<span class="hljs-built_in">count</span> {
      <span class="hljs-keyword">var</span> j = i + <span class="hljs-number">1</span>
      <span class="hljs-keyword">while</span> j &lt; boxes.<span class="hljs-built_in">count</span> {
        <span class="hljs-keyword">let</span> iou = <span class="hljs-type">YOLO</span>.<span class="hljs-type">IOU</span>(a: boxes[i].rect, b: boxes[j].rect)
        <span class="hljs-keyword">if</span> iou &gt; threshold {
          <span class="hljs-keyword">if</span> boxes[i].score &gt; boxes[j].score {
            <span class="hljs-keyword">if</span> boxes[i].classIndex == boxes[j].classIndex {<font></font>
              boxes.remove(at: j)<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
              j += <span class="hljs-number">1</span><font></font>
            }<font></font>
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> boxes[i].classIndex == boxes[j].classIndex {<font></font>
              boxes.remove(at: i)<font></font>
              j = i + <span class="hljs-number">1</span>
            } <span class="hljs-keyword">else</span> {<font></font>
              j += <span class="hljs-number">1</span><font></font>
            }<font></font>
          }<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
          j += <span class="hljs-number">1</span><font></font>
        }<font></font>
      }<font></font>
      i += <span class="hljs-number">1</span><font></font>
    }<font></font>
  }<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、ニューラルネットワーク予測の結果を直接操作することは、完了したと見なすことができます。</font><font style="vertical-align: inherit;">次に、カメラからフッテージを取得し、画面に画像を表示し、予測された境界ボックスをレンダリングするための関数とクラスを記述する必要があります。</font><font style="vertical-align: inherit;">この記事ではこのすべてのコードについては説明しませんが、リポジトリで表示できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、オンライン画像を処理するときに、境界ボックスに少しスムージングを追加したことにも言及する価値があります。この場合、過去30フレームにわたる予測された正方形の位置とサイズの通常の平均化です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムをテストする</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、アプリケーションをテストします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一度お知らせします。アプリケーションには3つのViewControllerがあり、1つは写真またはスナップショットの処理用、1つはオンラインビデオストリームの処理用、3つ目はネットワークのセットアップ用です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目から始めましょう。</font><font style="vertical-align: inherit;">その中で、YOLOv3-tinyまたはYOLOv3-416の2つのモデルのいずれかを選択し、信頼しきい値とIoUしきい値を選択できます。また、オンラインアンチエイリアスを有効または無効にすることもできます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sb/zq/tz/sbzqtzy6hai51objkormfzvtbuq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、訓練されたニューロンが実際の画像でどのように機能するかを見てみましょう。このために、ギャラリーから写真を撮り、それをネットワークに渡します。</font><font style="vertical-align: inherit;">下の写真は、異なる設定でのYOLOv3-tinyの結果を示しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nr/j3/fj/nrj3fjpw0yvxgl2cigujbcb-1p4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YOLOv3-tinyのさまざまな動作モード。左の図は、通常の操作モードを示しています。真ん中-しきい値IoU = 1、つまり非最大抑制が欠落しているかのように。右側は、オブジェクト信頼度の低いしきい値です。可能なすべての境界ボックスが表示されます。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
以下はYOLOv3-416の結果です。 YOLOv3-tinyと比較して、結果のフレームがより正確であるだけでなく、画像内の小さなオブジェクトが認識されていることがわかります。これは、3番目の出力レイヤーの処理に対応しています。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wc/nj/xq/wcnjxqeygnuriffqpatmtvevyfo.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YOLOv3-416を使用して処理された画像。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オンライン操作モードがオンになると、各フレームが処理されて予測</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が行われ、iPhone XSでテストが実行された</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ので、両方のネットワークオプションで結果はかなり受け入れられました。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">YOLOv3-tinyは平均30〜32 fps、YOLOv3-416-23〜25 fpsを生成します。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストされたデバイスは非常に生産的であるため、以前のモデルでは結果が異なる場合があります。その場合、もちろんYOLOv3-tinyを使用することが推奨されます。</font><font style="vertical-align: inherit;">もう1つの重要な点：yolo-tiny.mlmodel（YOLOv3-tiny）のサイズは約35 MBですが、yolo.mlmodel（YOLOv3-tiny）のサイズは約250 MBで、これは非常に大きな違いです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、ニューラルネットワークを利用して画像内のオブジェクトを認識できるiOSアプリケーションが作成されました。</font><font style="vertical-align: inherit;">CoreMLライブラリの操作方法と、それを使用してさまざまな事前トレーニング済みモデルを実行する方法を確認しました（ちなみに、これを使用してトレーニングすることもできます）。</font><font style="vertical-align: inherit;">オブジェクト認識の問題は、YOLOv3ネットワークを使用して解決されました。</font><font style="vertical-align: inherit;">iPhone XSでは、このネットワーク（YOLOv3-tiny）は、毎秒約30フレームの周波数で画像を処理できます。これは、リアルタイムで動作するのに十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完全なアプリケーションコードは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHubで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">確認できます</font><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460859/index.html">IThink＃3ハリコフでの会議-WWDC 2019に基づく</a></li>
<li><a href="../ja460861/index.html">JavaScript字句スコープとクロージャー</a></li>
<li><a href="../ja460863/index.html">Cloudflareクラッシュの詳細2019年7月2日</a></li>
<li><a href="../ja460865/index.html">月の人々。出典</a></li>
<li><a href="../ja460867/index.html">自動的にRealmオブジェクト構造に変換するSourcery</a></li>
<li><a href="../ja460873/index.html">Turokが選ばれる理由：N64向けのDinosaur Hunterは時代を先取りしています</a></li>
<li><a href="../ja460875/index.html">QIWIでMVVM内のViewとViewModelの間の相互作用の一般的なスタイルに到達した方法</a></li>
<li><a href="../ja460877/index.html">Kubernetes Dailymotionアドベンチャー：クラウド+オンプレミスでインフラストラクチャを構築する</a></li>
<li><a href="../ja460879/index.html">DUMP Kazan 2019-タタールスタン開発者会議。報告の申し込みを受け付けます</a></li>
<li><a href="../ja460881/index.html">DLPシステムでのOCRテクノロジーの適用の難しさ、またはOCRの準備方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>