<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍞 👨🏾‍🤝‍👨🏼 👸🏻 必要なのはURLだけです 😞 🧑‍🤝‍🧑 💈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="VKontakteユーザーは毎日100億のメッセージを交換します。写真、コミック、ミーム、その他の添付ファイルを互いに送信します。を使用して画像をアップロードするためのiOSアプリケーションをどのように思いついたかをURLProtocol説明し、独自の方法を実装する方法を段階的に説明します。
 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>必要なのはURLだけです</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vk/blog/467605/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/g6/l2/us/g6l2usvzzisf7ezfubycuyoty08.jpeg" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VKontakteユーザーは毎日100億のメッセージを交換します。</font><font style="vertical-align: inherit;">写真、コミック、ミーム、その他の添付ファイルを互いに送信します。</font><font style="vertical-align: inherit;">を使用して画像をアップロードするためのiOSアプリケーションをどのように思いついたかを</font></font><b><code>URLProtocol</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明し、独自の方法を実装する方法を段階的に説明します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1年半ほど前、iOS用のVKアプリケーションの新しいメッセージセクションの開発が本格化しました。これは完全にSwiftで書かれた最初のセクションです。これは</font></font><code>vkm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メインアプリケーションのデバイスについて何も知らない</font><font style="vertical-align: inherit;">別のモジュール</font><font style="vertical-align: inherit;">（VKメッセージ）にあります。別のプロジェクトで実行することもできます。メッセージの読み取りと送信の基本機能は引き続き機能します。メインアプリケーションでは、対応するContainer View Controllerを介してメッセージコントローラーが追加され、たとえば、会話のリストや会話内のメッセージが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージはVKontakteモバイルアプリケーションの最も人気のあるセクションの1つなので、時計のように機能することが重要です。プロジェクト中</font></font><code>messages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードのすべての行のために戦います。</font><font style="vertical-align: inherit;">メッセージがアプリケーションにどのようにきちんと組み込まれているかを常に気に入っており、すべてが同じままであることを確認するよう努めています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セクションに新しい機能を徐々に追加して、次のタスクに取り組みました。メッセージに添付された写真が最初に下書きで表示され、送信後にメッセージの一般的なリストに表示されることを確認する必要がありました。</font><font style="vertical-align: inherit;">で動作するモジュールを追加するだけで済みます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>PHImageManager</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、追加の条件によりタスクがより困難になりました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0l/7t/hm/0l7thmey5vyyonmpbt5wicd-vjm.gif" alt="画像"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像を選択すると、ユーザーはそれを処理できます。フィルターの適用、回転、トリミングなど。VKアプリケーションでは、この機能は別のコンポーネントに実装されます</font></font><code>AssetService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">今、メッセージプロジェクトから彼と一緒に働くことを学ぶ必要がありました。</font></font><br>
<br>
<blockquote> ,   ,  .     ,    .  ,    messages    .   AssetService,       !  .     messages,   -   ,      ,   .       ,      ,  … (  ).         .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/7i/ze/q8/7izeq8h2gkpsgj2qybfro74kobc.jpeg" alt="画像"></div><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この決定は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちの好みで</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はあり</font><i><font style="vertical-align: inherit;">ませんでした</font></i><font style="vertical-align: inherit;">。新しいエンティティが表示され、メッセージコンポーネントがからの画像を操作するときに知っておく必要があります</font></font><code>AssetService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。開発者は、このシステムがどのように機能するかを理解するために、追加の作業を行う必要もあります。最後に、追加の暗黙的なリンクがメインプロジェクトのコンポーネントに表示されました。メッセージセクションが引き続き独立したモジュールとして機能するように、これを回避しようとしています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトがどのような種類の画像が選択されたか、どのように保存するか、特別な読み込みとレンダリングが必要かどうかについて、プロジェクトがまったく何も知らないように、問題を解決したかったのです。さらに、私たちはインターネットから従来の画像をダウンロードする機能をすでに持っています。それらは追加のサービスを通じてダウンロードされるのではなく、単に</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、実際には、2種類の画像に違いはありません。</font><font style="vertical-align: inherit;">ローカルに保存されるものもあれば、サーバーに保存されるものもあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、非常にシンプルなアイデアを思い付きました。ローカルアセットもロードするように学習できるとしたらどう</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でしょうか。</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanosの</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指</font><font style="vertical-align: inherit;">を1回クリック</font><font style="vertical-align: inherit;">するだけで、すべての問題を解決できるようです。それについて何も知る必要がなく</font></font><code>AssetService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、新しいデータタイプを追加し、無駄にエントロピーを増やし、新しいタイプの画像を読み込む方法を学び、データキャッシュを処理します。</font><font style="vertical-align: inherit;">計画のようだ。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なのはURLだけです</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアイデアを検討し、</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルアセットの読み込みに使用する</font><font style="vertical-align: inherit;">形式を決定することにし</font><font style="vertical-align: inherit;">ました。</font></font><br>
<br>
<pre><code class="json hljs">asset:<span class="hljs-comment">//?id=123&amp;width=1920&amp;height=1280</span></code></pre><br><font style="vertical-align: inherit;"></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我々は、プロパティの値を使用する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>localIdentifier</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>PHObject</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、所望の大きさの画像をロードするために、我々は、パラメータを転送する</font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。また、のようないくつかのより多くのパラメータを追加</font></font><code>crop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>filter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>rotate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">処理された画像データで動作します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらを処理</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するために</font><font style="vertical-align: inherit;">、以下</font><font style="vertical-align: inherit;">を作成します</font></font><code>AssetURLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AssetURLProtocol</span>: <span class="hljs-title">URLProtocol</span> </span>{<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのタスクは、画像をアップロードして、</font></font><code>AssetService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでに使用可能なデータを戻すことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、ほぼ完全に作業を</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルとに</font><font style="vertical-align: inherit;">委任でき</font><font style="vertical-align: inherit;">ます</font></font><code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージ内では、最も一般的な</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、異なるフォーマットでのみ</font><font style="vertical-align: inherit;">操作でき</font><font style="vertical-align: inherit;">ます。また、画像をロードするための既存のメカニズムを再利用することも可能</font></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">データベースでシリアル化し、標準のを介してデータキャッシュを実装するのは非常に簡単</font><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
うまくいきましたか？この記事を読んで、ギャラリーからVKontakteアプリケーションのメッセージに写真を添付できる場合は、はい:)</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bm/6j/tb/bm6jtb7mkd489czjvwhzpy-dpo0.jpeg" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
独自のを実装する方法を明確</font></font><code>URLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にするために、これを例として検討することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指定した座標でマップスナップショットのリストを表示する必要があるリストを使用して、単純なアプリケーションを実装するというタスクを設定します。</font><font style="vertical-align: inherit;">スナップショットをロードするには、の標準</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>MKMapSnapshotter</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>MapKit</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタムを介してデータをロードします</font></font><code>URLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">結果は次のようになります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l1/bg/s8/l1bgs8g0xzehoxt49oddmmtbuoe.gif" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、のデータ読み込みメカニズムを実装します</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">地図のスナップショットを表示するには、ポイントの座標、つまり緯度と経度（</font></font><code>latitude</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>longitude</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を知っている必要があり</font><font style="vertical-align: inherit;">ます。</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情報をロード</font><font style="vertical-align: inherit;">するカスタム形式を定義</font><font style="vertical-align: inherit;">します。</font></font><br>
<br>
<pre><code class="json hljs">map:<span class="hljs-comment">//?latitude=59.935634&amp;longitude=30.325935</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、を実装します</font></font><code>URLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これにより、このようなリンクが処理され、目的の結果が生成されます。</font></font><code>MapURLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本クラスから継承</font><font style="vertical-align: inherit;">するクラス</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成します</font></font><code>URLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その名前にもかかわらず、それ</font></font><code>URLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は抽象的</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">はありますが、クラスです。</font><font style="vertical-align: inherit;">恥ずかしがらないでください。ここでは他の概念で運用し</font></font><code>URLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">てい</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これ</font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">プロトコルを</font><font style="vertical-align: inherit;">表しており、</font><font style="vertical-align: inherit;">OOPの用語とは関係ありません。</font><font style="vertical-align: inherit;">だから</font></font><code>MapURLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapURLProtocol</span>: <span class="hljs-title">URLProtocol</span> </span>{<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルが機能しない</font><font style="vertical-align: inherit;">必須のメソッドをいくつか再定義し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1。 </font></font><code>canInit(with:)</code></h3><br>
<pre><code class="swift hljs"><span class="hljs-keyword">override</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span> <span class="hljs-title">canInit</span>(<span class="hljs-title">with</span> <span class="hljs-title">request</span>: <span class="hljs-title">URLRequest</span>) -&gt; <span class="hljs-title">Bool</span> </span>{
   <span class="hljs-keyword">return</span> request.url?.scheme == <span class="hljs-string">"map"</span> 
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルが処理できる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>canInit(with:)</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要求のタイプを示すため</font><font style="vertical-align: inherit;">
のメソッドが</font><font style="vertical-align: inherit;">必要です</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この例では、プロトコルが</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキーマ</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">指定する</font><font style="vertical-align: inherit;">リクエストのみを処理すると</font><font style="vertical-align: inherit;">します</font></font><code>map</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">リクエストを開始する前</font></font><code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、セッションに登録されているすべてのプロトコルを通過し</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">このメソッドを呼び出します。</font><font style="vertical-align: inherit;">このメソッドで返され</font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、要求の処理に使用される</font><font style="vertical-align: inherit;">最初の登録済みプロトコル</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2。 </font></font><code>canonicalRequest(for:)</code></h4><br>
<pre><code class="swift hljs"><span class="hljs-keyword">override</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span> <span class="hljs-title">canonicalRequest</span>(<span class="hljs-title">for</span> <span class="hljs-title">request</span>: <span class="hljs-title">URLRequest</span>) -&gt; <span class="hljs-title">URLRequest</span> </span>{
   <span class="hljs-keyword">return</span> request <font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッドは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>canonicalRequest(for:)</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、クエリを正規の形式に減らすことを目的としています。</font><font style="vertical-align: inherit;">ドキュメントには、プロトコルの実装自体が、この概念の定義として何を考慮すべきかを決定すると書かれています。</font><font style="vertical-align: inherit;">ここでは、スキームを正規化したり、必要に応じてヘッダーをリクエストに追加したりできます。このメソッドが機能するための唯一の要件は、このメソッドがキャッシュされた回答の検索にも使用されるため、すべての着信リクエストが常に同じ結果になることです。への要求に応じて</font></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3。 </font></font><code>startLoading()</code></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッド</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>startLoading()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、必要なデータをロードするためのすべてのロジックを記述しています。</font><font style="vertical-align: inherit;">この例では、</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト</font><font style="vertical-align: inherit;">を解析し、</font><font style="vertical-align: inherit;">そのパラメーター</font></font><code>latitude</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">との</font><font style="vertical-align: inherit;">値に基づいて</font><font style="vertical-align: inherit;">、目的のマップスナップショット</font></font><code>longitude</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を参照</font></font><code>MKMapSnapshotter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">してロードする必要があります。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startLoading</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url = request.url,
        <span class="hljs-keyword">let</span> components = <span class="hljs-type">URLComponents</span>(url: url, resolvingAgainstBaseURL: <span class="hljs-literal">false</span>),
        <span class="hljs-keyword">let</span> queryItems = components.queryItems <span class="hljs-keyword">else</span> {<font></font>
            fail(with: .badURL)<font></font>
            <span class="hljs-keyword">return</span><font></font>
    }<font></font>
    <font></font>
    load(with: queryItems)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">load</span><span class="hljs-params">(with queryItems: [URLQueryItem])</span></span> {
    <span class="hljs-keyword">let</span> snapshotter = <span class="hljs-type">MKMapSnapshotter</span>(queryItems: queryItems)<font></font>
    snapshotter.start(<font></font>
        with: <span class="hljs-type">DispatchQueue</span>.global(qos: .background),<font></font>
        completionHandler: handle<font></font>
    )<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handle</span><span class="hljs-params">(snapshot: MKMapSnapshotter.Snapshot?, error: Error?)</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> snapshot = snapshot,
        <span class="hljs-keyword">let</span> data = snapshot.image.jpegData(compressionQuality: <span class="hljs-number">1</span>) {<font></font>
        complete(with: data)<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error = error {<font></font>
        fail(with: error)<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを受信した後、プロトコルを正しくシャットダウンする必要があります。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">complete</span><span class="hljs-params">(with data: Data)</span></span> {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url = request.url, <span class="hljs-keyword">let</span> client = client <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span><font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">let</span> response = <span class="hljs-type">URLResponse</span>(<font></font>
        url: url,<font></font>
        mimeType: <span class="hljs-string">"image/jpeg"</span>,<font></font>
        expectedContentLength: data.<span class="hljs-built_in">count</span>,<font></font>
        textEncodingName: <span class="hljs-literal">nil</span><font></font>
    )<font></font>
    <font></font>
    client.urlProtocol(<span class="hljs-keyword">self</span>, didReceive: response, cacheStoragePolicy: .allowed)<font></font>
    client.urlProtocol(<span class="hljs-keyword">self</span>, didLoad: data)<font></font>
    client.urlProtocolDidFinishLoading(<span class="hljs-keyword">self</span>)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、タイプのオブジェクトを作成します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>URLResponse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このオブジェクトには、リクエストに応答するための重要なメタデータが含まれています。次に、型オブジェクトに対して3つの重要なメソッドを実行します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>URLProtocolClient</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>client</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このタイプの</font><font style="vertical-align: inherit;">プロパティに</font><font style="vertical-align: inherit;">は、</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルの</font><font style="vertical-align: inherit;">各エンティティが含まれてい</font><font style="vertical-align: inherit;">ます。</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルと全体の</font><font style="vertical-align: inherit;">間のプロキシとして機能し、</font></font><code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらのメソッドを呼び出すときに、データで何を行う必要があるかについて結論を出します：キャッシュ、</font></font><code>completionHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト</font><font style="vertical-align: inherit;">への送信</font><font style="vertical-align: inherit;">、プロトコルのシャットダウンの処理など。これらのメソッドの呼び出しの順序と数プロトコルの実装によって異なる場合があります。たとえば、ネットワークからデータをバッチでダウンロードし、定期的に通知</font></font><code>URLProtocolClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して、インターフェースでのデータ読み込みの進行状況を表示できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロトコルの操作でエラーが発生した場合、それも正しく処理され、これについて通知される必要があります</font></font><code>URLProtocolClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fail</span><span class="hljs-params">(with error: Error)</span></span> {<font></font>
    client?.urlProtocol(<span class="hljs-keyword">self</span>, didFailWithError: error)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><code>completionHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト</font><font style="vertical-align: inherit;">
の</font><font style="vertical-align: inherit;">実行時に</font><font style="vertical-align: inherit;">送信されるのはこのエラーであり</font><font style="vertical-align: inherit;">、そこで</font><font style="vertical-align: inherit;">エラーは</font><font style="vertical-align: inherit;">処理され、美しいメッセージがユーザーに表示されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4。 </font></font><code>stopLoading()</code></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッド</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>stopLoading()</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、何らかの理由でプロトコルが完了したときに呼び出されます。</font><font style="vertical-align: inherit;">これは、正常に完了したか、エラーが完了したか、要求がキャンセルされたかのいずれかです。</font><font style="vertical-align: inherit;">これは、占有されているリソースを解放したり、一時データを削除したりするのに適した場所です。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">stopLoading</span><span class="hljs-params">()</span></span> { }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルの</font><font style="vertical-align: inherit;">実装が</font><font style="vertical-align: inherit;">完了し、アプリケーションのどこでも使用できます。</font><font style="vertical-align: inherit;">プロトコルを適用する場所になるために、さらにいくつか追加します。</font></font><br>
<br>
<h4><code>URLImageView</code></h4><br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLImageView</span>: <span class="hljs-title">UIImageView</span> </span>{
    <span class="hljs-keyword">var</span> task: <span class="hljs-type">URLSessionDataTask?</span>
    <span class="hljs-keyword">var</span> taskId: <span class="hljs-type">Int?</span><font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">render</span><span class="hljs-params">(url: URL)</span></span> {
        <span class="hljs-built_in">assert</span>(task == <span class="hljs-literal">nil</span> || task?.taskIdentifier != taskId)<font></font>
        <font></font>
        <span class="hljs-keyword">let</span> request = <span class="hljs-type">URLRequest</span>(url: url)<font></font>
        <font></font>
        task = session.dataTask(with: request, completionHandler: complete)<font></font>
        taskId = task?.taskIdentifier<font></font>
        <font></font>
        task?.resume()<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">complete</span><span class="hljs-params">(data: Data?, response: URLResponse?, error: Error?)</span></span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.taskId == task?.taskIdentifier,
            <span class="hljs-keyword">let</span> data = data,
            <span class="hljs-keyword">let</span> image = <span class="hljs-type">UIImage</span>(data: data) {<font></font>
            didLoadRemote(image: image)<font></font>
        }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">didLoadRemote</span><span class="hljs-params">(image: UIImage)</span></span> {
        <span class="hljs-type">DispatchQueue</span>.main.async {
            <span class="hljs-keyword">self</span>.image = image<font></font>
        }<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">prepareForReuse</span><span class="hljs-params">()</span></span> {<font></font>
        task?.cancel()<font></font>
        taskId = <span class="hljs-literal">nil</span>
        image = <span class="hljs-literal">nil</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは単純なクラスであるheir </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>UIImageView</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">であり、類似の実装であり、おそらく任意のアプリケーションにあります。ここでは</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メソッドに</font></font><code>render(url:)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">アップロードして、プロパティに書き込みます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>image</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。便利なのは、</font></font><code>http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>https</code> <code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とカスタム</font><font style="vertical-align: inherit;">画像の両方で、絶対に任意の画像をアップロードできることです</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像のダウンロード要求を満たすには、オブジェクトタイプも必要です</font></font><code>URLSession</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> config: <span class="hljs-type">URLSessionConfiguration</span> = {
    <span class="hljs-keyword">let</span> <span class="hljs-built_in">c</span> = <span class="hljs-type">URLSessionConfiguration</span>.ephemeral
    <span class="hljs-built_in">c</span>.protocolClasses = [
        <span class="hljs-type">MapURLProtocol</span>.<span class="hljs-keyword">self</span><font></font>
    ]<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">c</span><font></font>
}()<font></font>
<font></font>
<span class="hljs-keyword">let</span> session = <span class="hljs-type">URLSession</span>(<font></font>
    configuration: config,<font></font>
    delegate: <span class="hljs-literal">nil</span>,<font></font>
    delegateQueue: <span class="hljs-literal">nil</span>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、セッション構成が特に重要です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>URLSessionConfiguration</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちにとって重要な特性が1つ</font><font style="vertical-align: inherit;">あり</font><font style="vertical-align: inherit;">ます- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>protocolClasses</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ここでは</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、この構成のセッションが処理できるプロトコル</font><font style="vertical-align: inherit;">タイプのリストを</font><font style="vertical-align: inherit;">確認</font><font style="vertical-align: inherit;">でき</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">デフォルトでは、セッションは</font></font><code>http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>https</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルの</font><font style="vertical-align: inherit;">処理をサポートして</font><font style="vertical-align: inherit;">おり、カスタムサポートが必要な場合は、それらを指定する必要があります。</font><font style="vertical-align: inherit;">この例では、を示します</font></font><code>MapURLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あとは、マップスナップショットを表示するビューコントローラーを実装するだけです。</font><font style="vertical-align: inherit;">そのソースコードは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果は次のとおりです。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ed/gf/c8/edgfc8crekglljfq33hfggic520.gif" alt="画像"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャッシングはどうですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてがうまく機能しているように見えますが、1つの重要な点を除いて、リストを前後にスクロールすると、白い点が画面に表示されます。</font><font style="vertical-align: inherit;">スナップショットはどのような方法でもキャッシュされていないようで、メソッドを呼び出すたびに</font></font><code>render(url:)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を介してデータをリロードします</font></font><code>MKMapSnapshotter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これには時間がかかるため、読み込み時にこのようなギャップが生じます。</font><font style="vertical-align: inherit;">すでに作成されたスナップショットが再度ダウンロードされないように、データキャッシュメカニズムを実装する価値があります。</font><font style="vertical-align: inherit;">ここでは</font></font><code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、このために提供されているキャッシュスルーのメカニズムがすでに存在</font><font style="vertical-align: inherit;">するフォースを使用し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>URLCache</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロセスをより詳細に検討し、キャッシュでの作業を2つの重要な段階（読み取りと書き込み）に分割します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読書</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キャッシュされたデータを正しく読み取るには、</font></font><code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかの重要な質問への回答を得る必要があり</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。1.どのURLCacheを使用する必要がありますか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
もちろん、すでに準備はできていますが</font></font><code>URLCache.shared</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常に使用できるわけではありません。開発者が彼のエッセンスを作成して使用したい場合があるからです</font></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。セッション構成に</font></font><code>URLSessionConfiguration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font><font style="vertical-align: inherit;">この質問に答える</font><font style="vertical-align: inherit;">プロパティ</font><font style="vertical-align: inherit;">があります</font></font><code>urlCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。リクエストに対する応答の読み取りと記録の両方に使用されます。</font></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらの目的のために、既存の構成で</font><font style="vertical-align: inherit;">いくつか</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">示し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> config: <span class="hljs-type">URLSessionConfiguration</span> = {
    <span class="hljs-keyword">let</span> <span class="hljs-built_in">c</span> = <span class="hljs-type">URLSessionConfiguration</span>.ephemeral
    <span class="hljs-built_in">c</span>.urlCache = <span class="hljs-type">ImageURLCache</span>.current
    <span class="hljs-built_in">c</span>.protocolClasses = [
        <span class="hljs-type">MapURLProtocol</span>.<span class="hljs-keyword">self</span><font></font>
    ]<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">c</span>
}()</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.キャッシュデータを使用する必要がありますか、それとも再度ダウンロードする必要がありますか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
この質問に対する答えは、</font></font><code>URLRequest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これから完了する</font><font style="vertical-align: inherit;">要求によって異なり</font><font style="vertical-align: inherit;">ます。リクエストを作成するとき</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、引数にキャッシュポリシー</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">指定すること</font><font style="vertical-align: inherit;">に加えて、機会</font><font style="vertical-align: inherit;">があります</font></font><code>cachePolicy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> request = <span class="hljs-type">URLRequest</span>(<font></font>
    url: url,<font></font>
    cachePolicy: .returnCacheDataElseLoad,<font></font>
    timeoutInterval: <span class="hljs-number">30</span>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルト値が使用され</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>.useProtocolCachePolicy</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。これもドキュメントに記載されています。つまり、このオプションでは、リクエストに対するキャッシュされた応答を見つけてその関連性を判断するタスクは、完全に</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-protocolの</font><font style="vertical-align: inherit;">実装にあり</font><font style="vertical-align: inherit;">ます。しかし、もっと簡単な方法があります。値を設定</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>.returnCacheDataElseLoad</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すると、次のエンティティを作成するときに、エンティティ</font></font><code>URLProtocol</code> <code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自体の作業の一部になり</font><font style="vertical-align: inherit;">ます。</font></font><code>urlCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドを使用して、現在のリクエストに対してキャッシュされた応答をリクエストし</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>cachedResponse(for:)</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。キャッシュされたデータがある場合、タイプオブジェクト</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>CachedURLResponse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は初期化時にすぐに転送</font></font><code>URLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">され、プロパティに格納されます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>cachedResponse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>(<font></font>
    request: <span class="hljs-type">URLRequest</span>,<font></font>
    cachedResponse: <span class="hljs-type">CachedURLResponse?</span>,<font></font>
    client: <span class="hljs-type">URLProtocolClient?</span>) {
    <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>(<font></font>
        request: request,<font></font>
        cachedResponse: cachedResponse,<font></font>
        client: client<font></font>
    )<font></font>
}</code></pre><br>
<code>CachedURLResponse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ（</font></font><code>Data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）とそれらのメタ情報</font><font style="vertical-align: inherit;">（</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を含む単純なクラスです</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>URLResponse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メソッドを少しだけ変更して、その</font></font><code>startLoading</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部のこのプロパティの値を確認するだけで、すぐにこのデータでプロトコルを終了できます。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startLoading</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> cachedResponse = cachedResponse {<font></font>
        complete(with: cachedResponse.data)<font></font>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url = request.url,
            <span class="hljs-keyword">let</span> components = <span class="hljs-type">URLComponents</span>(url: url, resolvingAgainstBaseURL: <span class="hljs-literal">false</span>),
            <span class="hljs-keyword">let</span> queryItems = components.queryItems <span class="hljs-keyword">else</span> {<font></font>
                fail(with: .badURL)<font></font>
                <span class="hljs-keyword">return</span><font></font>
        }<font></font>
        <font></font>
        load(with: queryItems)<font></font>
    }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記録</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キャッシュ内のデータを見つけるには、そこにデータを置く必要があります。</font><font style="vertical-align: inherit;">この作業も完全に行われてい</font></font><code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">必要なのは、キャッシュポリシー設定を使用して、プロトコルの最後にデータをキャッシュすることを彼女に伝えることだけです</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>cacheStoragePolicy</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、次の値を持つ単純な列挙です。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">StoragePolicy</span> </span>{
    <span class="hljs-keyword">case</span> allowed
    <span class="hljs-keyword">case</span> allowedInMemoryOnly
    <span class="hljs-keyword">case</span> notAllowed<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、キャッシュはメモリ内とディスク上で許可され、メモリ内でのみ許可されるか、または禁止されます。</font><font style="vertical-align: inherit;">この例では、メモリとディスクでのキャッシュが許可されていることを示しています。</font></font><br>
<br>
<pre><code class="swift hljs">client.urlProtocol(<span class="hljs-keyword">self</span>, didReceive: response, cacheStoragePolicy: .allowed)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、いくつかの簡単な手順に従って、マップのスナップショットをキャッシュする機能をサポートしました。</font><font style="vertical-align: inherit;">そして、アプリケーションの作業は次のようになります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l1/bg/s8/l1bgs8g0xzehoxt49oddmmtbuoe.gif" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、ホワイトスポットはもうありません。カードは一度ロードされ、キャッシュから再利用されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必ずしも簡単ではない</font></font></h2><br><font style="vertical-align: inherit;"></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-protocolを</font><font style="vertical-align: inherit;">
実装するときに</font><font style="vertical-align: inherit;">、一連の落下に遭遇しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つ目は</font><font style="vertical-align: inherit;">、リクエストへの応答をキャッシュ</font></font><code>URL Loading System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とき</font><font style="vertical-align: inherit;">の相互作用の内部実装に関連していました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ドキュメントで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></a><font style="vertical-align: inherit;"></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">スレッドの安全性</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">も関わらず</font><font style="vertical-align: inherit;">、メソッドの処理</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>cachedResponse(for:)</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>storeCachedResponse(_:for:)</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリへの応答の読み取り/書き込みのために状態の競合が発生する可能性があるため、</font></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この点</font><font style="vertical-align: inherit;">をサブクラスで</font><font style="vertical-align: inherit;">考慮する必要があります。</font></font><code>URLCache.shared</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この問題を</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">すると解決</font><font style="vertical-align: inherit;">されると予想し</font><font style="vertical-align: inherit;">ていましたが、間違っていることが判明しました。</font><font style="vertical-align: inherit;">これを修正</font><font style="vertical-align: inherit;">するために、指定されたメソッドを別のキューで同期的に実行する</font></font><code>ImageURLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">相続人</font></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">である</font><font style="vertical-align: inherit;">、別のキャッシュを使用</font><font style="vertical-align: inherit;">します。</font><font style="vertical-align: inherit;">楽しいボーナスとして、他のエンティティとは別にできます</font></font><code>URLCache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> メモリとディスクのキャッシュ容量を調整します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> accessQueue = <span class="hljs-type">DispatchQueue</span>(<font></font>
   label: <span class="hljs-string">"image-urlcache-access"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">cachedResponse</span><span class="hljs-params">(<span class="hljs-keyword">for</span> request: URLRequest)</span></span> -&gt; <span class="hljs-type">CachedURLResponse?</span> {
   <span class="hljs-keyword">return</span> <span class="hljs-type">ImageURLCache</span>.accessQueue.sync {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.cachedResponse(<span class="hljs-keyword">for</span>: request)<font></font>
   }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">storeCachedResponse</span><span class="hljs-params">(<span class="hljs-number">_</span> response: CachedURLResponse, <span class="hljs-keyword">for</span> request: URLRequest)</span></span> {
   <span class="hljs-type">ImageURLCache</span>.accessQueue.sync {
      <span class="hljs-keyword">super</span>.storeCachedResponse(response, <span class="hljs-keyword">for</span>: request)<font></font>
   }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の問題はiOS 9を搭載したデバイスでのみ再現されました。</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルの</font><font style="vertical-align: inherit;">ロードを開始および終了するメソッドは</font><font style="vertical-align: inherit;">異なるスレッドで実行できるため、まれに不愉快なクラッシュが発生する可能性があります。</font><font style="vertical-align: inherit;">この問題を解決するには、現在のスレッドをメソッドに保存し、</font></font><code>startLoading</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このスレッドで直接ダウンロード完了コードを実行します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">var</span> thread: <span class="hljs-type">Thread!</span><font></font>
<font></font>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startLoading</span><span class="hljs-params">()</span></span> {
   <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url = request.url,
      <span class="hljs-keyword">let</span> components = <span class="hljs-type">URLComponents</span>(url: url, resolvingAgainstBaseURL: <span class="hljs-literal">false</span>),
      <span class="hljs-keyword">let</span> queryItems = components.queryItems <span class="hljs-keyword">else</span> {<font></font>
         fail(with: .badURL)<font></font>
         <span class="hljs-keyword">return</span><font></font>
   }<font></font>
<font></font>
   thread = <span class="hljs-type">Thread</span>.current<font></font>
<font></font>
   <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> cachedResponse = cachedResponse {<font></font>
      complete(with: cachedResponse)<font></font>
   } <span class="hljs-keyword">else</span> {<font></font>
      load(request: request, url: url, queryItems: queryItems)<font></font>
   }<font></font>
}</code></pre><br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handle</span><span class="hljs-params">(snapshot: MKMapSnapshotter.Snapshot?, error: Error?)</span></span> {<font></font>
    thread.execute {<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> snapshot = snapshot,
            <span class="hljs-keyword">let</span> data = snapshot.image.jpegData(compressionQuality: <span class="hljs-number">0.7</span>) {
            <span class="hljs-keyword">self</span>.complete(with: data)<font></font>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error = error {
            <span class="hljs-keyword">self</span>.fail(with: error)<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLプロトコルが役立つのはいつですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、iOSアプリケーションのほぼすべてのユーザーが、何らかの方法で</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルを</font><font style="vertical-align: inherit;">介して機能する要素に遭遇し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ギャラリーからメディアをダウンロードするだけでなく、さまざまな</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロトコルの</font><font style="vertical-align: inherit;">実装</font><font style="vertical-align: inherit;">により、マップや投票を表示したり、参加者の写真で構成されたチャットアバターを表示したりできます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5v/jz/sl/5vjzsliedpi6l9qt6qhnaloi1l8.jpeg" alt="画像"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/p0/g4/rz/p0g4rzbdjqqbx3oc-ochol6ilwy.jpeg" alt="画像"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/n4/1e/mb/n41embtawargx2zofdmevlyq_nk.jpeg" alt="画像"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/j4/dn/gj/j4dngjkluh5gyxb3od9vwkse9zu.jpeg" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のソリューションと同様に、ソリューションに</font></font><code>URLProtocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は長所と短所があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">欠点 </font></font><code>URLProtocol</code></h3><br>
<ul>
<li><b>  </b> —   <code>URL</code>        .   ,     .           .       <code>URLBuilder</code>’,    <code>URL</code>    .             ,     .   ,     -  <code>URL</code>,       <code>URLBuilder</code>,    .</li>
<li><b> </b> —     , -  ,  <code>URLProtocol</code>,  . ,   .   ,  ,      ,    stack trace’    .</li>
</ul><br>
<h3> URLProtocol</h3><br>
<ul>
<li><b>  </b> —  ,      ,      ,   :     ,   .       <code>URL</code> —     .</li>
<li><b> </b> —    <code>URL</code>-        .         .</li>
<li><b>  </b> —       ,      ,   <code>URL</code>-.       <code>URL</code>, <code>URLSession</code>, <code>URLSessionDataTask</code>.</li>
<li><b> </b> —    <code>URL</code>-   <code>URL</code>-,             <code>URL Loading System</code>.</li>
<li><b>*  API</b> —      .     ,        API,   -  ,   <code>URL</code>-.       ,       API         ,  .         <code>URL</code>-      <code>http</code>/<code>https</code>.</li>
</ul><br>
<code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-protocolは万能薬ではなく、すべてのタスクに適しているわけではありません。</font><font style="vertical-align: inherit;">これには長所と短所があります。</font><font style="vertical-align: inherit;">しかし、それでも、次に指定されたパラメーターに従って何かをロードし、操作を非同期で実行し、最終データをキャッシュする必要がある場合は、チェックするだけで、突然このアプローチが問題の解決に役立ちます。</font><font style="vertical-align: inherit;">問題を解決するために必要なのはこれだけ</font></font><code>URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの完全なソースコードは、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">GitHubで</font></a><font style="vertical-align: inherit;">確認でき</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></a></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja467589/index.html">2019年にGDPRについて知っておくべきこと</a></li>
<li><a href="../ja467591/index.html">新しい証明は、piなどの数値の近似を解決します</a></li>
<li><a href="../ja467593/index.html">（関連なし、修理済み）注。Tele2が新規加入者の個人アカウントへのアクセスを共有する方法</a></li>
<li><a href="../ja467597/index.html">Vowpal Wabbitによるビッグデータ製品ガイドラインのパーソナライズ</a></li>
<li><a href="../ja467599/index.html">OpenGLを使用した3Dレンダリング</a></li>
<li><a href="../ja467609/index.html">React Nativeでのモバイルアプリケーションの作成</a></li>
<li><a href="../ja467611/index.html">画像輪郭検出アルゴリズム</a></li>
<li><a href="../ja467615/index.html">Pythonラッパーを作成して狂わないようにする方法</a></li>
<li><a href="../ja467617/index.html">Kaspresso：待っていた自動テストフレームワーク</a></li>
<li><a href="../ja467619/index.html">Aquafor投手は、水処理用のフィルターを設計できない方法の良い例です</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>