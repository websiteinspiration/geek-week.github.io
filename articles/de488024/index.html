<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏾 🌃 🤙 Fantastische Beratungsschlösser und wo sie leben 👩🏻‍🤝‍👨🏼 🚉 👍🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL verfügt über einen sehr praktischen Mechanismus für Beratungssperren . Sie sind auch Beratungssperren . Wir bei Tensor verwenden sie an vie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fantastische Beratungsschlösser und wo sie leben</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/488024/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL verfügt über einen sehr praktischen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mechanismus für Beratungssperren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Sie sind auch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beratungssperren</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wir bei Tensor verwenden sie an vielen Stellen im System, aber nur wenige Menschen verstehen im Detail, wie genau sie funktionieren und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">welche Probleme bei Misshandlung auftreten können</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zi/sc/ak/ziscak3l-89wfdsjqhytpmkjalg.png"><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lesen Sie mehr über Schlösser</font></font></b><div class="spoiler_text">   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">    PostgreSQL</a>.</div></div><br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorteile von Empfehlungsschlössern</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der grundlegende Unterschied zwischen diesem Mechanismus und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„normalen“ Sperren auf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tabellen-, Seiten- und Datensatzebene besteht darin, dass es mehrere Hauptmerkmale gibt.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Benutzerdefinierte ID-Sperre</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Normale" Sperren in PG sind immer an ein bestimmtes Datenbankobjekt (Tabelle, Datensatz, Datenseite) und den Prozess gebunden, der die Verbindung bedient. </font><font style="vertical-align: inherit;">Beratungssperren sind ebenfalls ein Prozess, aber anstelle eines realen Objekts kann ein abstrakter Bezeichner als </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(bigint)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder als </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(integer, integer) festgelegt werden</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Übrigens bedeutet das Anhängen jeder Sperre an einen Prozess, dass Sie durch Benennen </font></font><code>pg_terminate_backend(pid)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder korrekte Vervollständigung der Verbindung von der Clientseite aus alle von ihr auferlegten Sperren entfernen können.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CAS Auf Sperrerfassung prüfen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CAS ist ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compare-and-Set</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dh die Überprüfung der Erfassungsfähigkeit und die Erfassung des Schlosses selbst erfolgt als eine atomare Operation, und offensichtlich kann sich niemand zwischen ihnen verkeilen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das heißt, wenn Sie zuerst eine Überprüfungsanforderung an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks stellen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das Ergebnis </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">anzeigen</font></a><font style="vertical-align: inherit;"> und dann entscheiden, ob </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">gesperrt werden</font></a><font style="vertical-align: inherit;"> soll oder nicht, kann niemand garantieren, dass zwischen diesen Vorgängen niemand das </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">gewünschte</font></a><font style="vertical-align: inherit;"> Objekt übernehmen kann. </font><font style="vertical-align: inherit;">Wenn Sie jedoch </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_try_advisory_lock verwenden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , erhalten Sie diese Sperre entweder sofort oder die Funktion kehrt einfach zurück </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No-Capture ohne Ausnahmen und Erwartungen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Modell gibt es „normale“ Sperren. </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„Wenn Sie bereits nach einer Sperre gefragt haben, warten Sie. Wenn Sie nicht wollen warten ( </font></font><code>NOWAIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>statement_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>lock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - hier ist eine Ausnahme "</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dieser Ansatz stört die Transaktion erheblich, da Sie dann entweder einen Block </font></font><code>BEGIN-EXCEPTION-END</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für die Verarbeitung </font><font style="vertical-align: inherit;">implementieren </font><font style="vertical-align: inherit;">oder </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Transaktion </font><font style="vertical-align: inherit;">zurücksetzen ( </font><font style="vertical-align: inherit;">) müssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die einzige Möglichkeit, dieses Verhalten zu vermeiden, besteht darin, das </font></font><code>SELECT ... SKIP LOCKED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit Version 9.5 gelieferte </font><font style="vertical-align: inherit;">Design zu verwenden </font><font style="vertical-align: inherit;">. Leider sind bei dieser Methode die Optionen "hatten überhaupt nichts zu blockieren" und "war, aber bereits blockiert" nicht mehr zu unterscheiden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Empfohlene Sperren, die durch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Try-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktionen </font><font style="vertical-align: inherit;">verursacht werden </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> kehren einfach zurück </font></font><code>TRUE/FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nicht verwirren </font></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font><font style="vertical-align: inherit;">- die erste Funktion </font><b><font style="vertical-align: inherit;">wartet,</font></b><font style="vertical-align: inherit;"> bis sie eine Sperre erhält, und die zweite Funktion kehrt einfach sofort zurück, </font><font style="vertical-align: inherit;">wenn es "jetzt" nicht möglich ist, sie zu erfassen.</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>FALSE</code><font style="vertical-align: inherit;"></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sperren innerhalb und nach der Transaktion</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie oben erwähnt, sind Objektsperren an den Prozess „angehängt“ und existieren nur als Teil der aktuellen Transaktion darin. </font><font style="vertical-align: inherit;">Auch nur aufzuzwingen - wird nicht gelingen:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> tbl;
<span class="hljs-comment">-- ERROR:  LOCK TABLE can only be used in transaction blocks</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dementsprechend werden am Ende der Transaktion alle ihr auferlegten Sperren entfernt. </font><font style="vertical-align: inherit;">Im Gegensatz dazu wurden Beratungsschlösser ursprünglich mit der Fähigkeit entwickelt, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlösser</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu </font><b><font style="vertical-align: inherit;">halten und außerhalb des Umfangs einer Transaktion</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-number">1</span>);
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> pid = pg_backend_pid() <span class="hljs-keyword">AND</span> locktype = <span class="hljs-string">'advisory'</span>;</code></pre><br>
<pre><code class="plaintext hljs">-[ RECORD 1 ]------+--------------<font></font>
locktype           | advisory<font></font>
database           | 263911484<font></font>
relation           |<font></font>
page               |<font></font>
tuple              |<font></font>
virtualxid         |<font></font>
transactionid      |<font></font>
classid            | 0 &lt;--  int4 #1    int8<font></font>
objid              | 1 &lt;--  int4 #2    int8<font></font>
objsubid           | 1<font></font>
virtualtransaction | 416/475768<font></font>
pid                | 29264<font></font>
mode               | ExclusiveLock<font></font>
granted            | t<font></font>
fastpath           | f</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber bereits ab Version 9.1 sind </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xact-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Versionen von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beratungsfunktionen erschienen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mit denen Sie das Verhalten von „normalen“ Sperren implementieren können, die automatisch freigegeben werden, wenn die Transaktion, die sie auferlegt hat, abgeschlossen ist.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendungsbeispiele in VLSI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie bei jeder anderen Sperre dient die Beratung dazu, die Einzigartigkeit der Verarbeitung einer Ressource sicherzustellen. </font><font style="vertical-align: inherit;">In unserem Land sind solche Ressourcen normalerweise entweder die gesamte Tabelle oder ein bestimmter Datensatz der Tabelle, der aus irgendeinem Grund nicht "gesperrt" werden möchte.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeiter-Monoverarbeitung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Notwendigkeit, einige Daten in der Datenbank zu verarbeiten, durch ein externes Ereignis ausgelöst wird, die Verarbeitung mehrerer Prozesse jedoch redundant ist oder zu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einer Race-Bedingung führen kann</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ist es sinnvoll, jeweils nur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einen Prozess</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für diese Daten </font><b><font style="vertical-align: inherit;">zu verwenden</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem Zweck versuchen wir, die Tabellenkennung als ersten Parameter und die spezifische Anwendungsverarbeitungs-ID als zweiten Parameter zu verwenden:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_try_advisory_lock(
  <span class="hljs-string">'processed_table'</span>::regclass::<span class="hljs-keyword">oid</span>
, <span class="hljs-number">-1</span> <span class="hljs-comment">--   worker'</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir zurückkehren </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, hält bereits jemand anderes ein solches Schloss in der Hand, und speziell dieser Prozess muss nichts tun, aber es ist am besten, einfach leise zu enden. </font><font style="vertical-align: inherit;">So funktioniert beispielsweise der Prozess der dynamischen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berechnung der Warenkosten in einem Lager</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für jedes einzelne Kundenschema isoliert.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gleichzeitige Warteschlangenverarbeitung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt ist die Aufgabe „das Gegenteil“ - wir möchten, dass die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aufgaben in einer Warteschlangentabelle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> so schnell wie möglich verarbeitet werden, multithreaded, fehlertolerant und sogar aus unterschiedlichen Geschäftslogiken (wir haben nicht die Leistung einer) - zum Beispiel wie unser Operator über die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Übermittlung der elektronischen Berichterstattung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> an Regierungsbehörden oder den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OFD-Dienst</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da es sich bei den "verarbeitenden" BLs um unterschiedliche Server handelt, kann kein Mutex mehr aufgehängt werden. Es ist nicht sicher, einen speziellen Prozesskoordinator für die Verteilung von Aufgaben auszuwählen, "stirbt" er - und alles wird steigen. Und so stellt sich heraus, dass es am effizientesten ist, Aufgaben direkt auf Datenbankebene zu verteilen, und es gibt eine solche Methode - in der Antike wurde das Modell von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dmitry Koterov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ehrlich ausspioniert </font><font style="vertical-align: inherit;">und dann kreativ modifiziert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall wird die Tabellen-ID und die PK eines bestimmten Datensatzes gesperrt:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  queue_table<font></font>
<span class="hljs-keyword">WHERE</span>
  pg_try_advisory_lock(<span class="hljs-string">'queue_table'</span>::regclass::<span class="hljs-keyword">oid</span>, pk_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk_id<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das heißt, der Prozess erhält von der Tabelle den ersten Datensatz, der von seinen konkurrierenden Brüdern noch nicht blockiert wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn PK jedoch nicht aus </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Ganzzahl)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sondern aus </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Ganzzahl, Ganzzahl) besteht</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (wie beispielsweise bei derselben Kostenberechnung), können Sie diesem Paar direkt eine Sperre auferlegen - es ist unwahrscheinlich, dass ein Schnittpunkt mit dem "Konkurrenten" auftritt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wichtig! </font><font style="vertical-align: inherit;">Vergessen Sie nicht, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ihre Warteschlangentabelle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> regelmäßig </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">ordnungsgemäß zu pflegen</font></a><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exklusive Dokumentenverarbeitung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wird überall in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentenverwaltungslösungen verwendet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In einem verteilten Websystem kann zwar ein und dasselbe Dokument zur Anzeige durch verschiedene Benutzer gleichzeitig geöffnet werden, es kann jedoch immer nur von nur einem Dokument verarbeitet werden (Status ändern usw.).</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traditionelle Themen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wo ohne sie! </font><font style="vertical-align: inherit;">Fast alles läuft auf eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sache hinaus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><font style="vertical-align: inherit;">Sie haben nicht freigeschaltet, was sie gesperrt haben</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mehrfachüberlagerung eines Hinweisschlosses</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , wie sie sagen:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn mehrere Blockierungsanforderungen gleichzeitig empfangen werden, häufen sie sich. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn eine Ressource also dreimal blockiert wurde, muss sie dreimal entsperrt werden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um in anderen Sitzungen verfügbar zu sein.</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setzen Sie zu viele Schlösser gleichzeitig</font></font></h4><br>
<img src="https://habrastorage.org/webt/c-/q5/19/c-q519tdomjwjhoofqaljskvcxa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tausende von ihnen! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lesen Sie das Handbuch noch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einmal </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sowohl empfohlene als auch reguläre Sperren werden im gemeinsam genutzten Speicherbereich gespeichert, dessen Größe durch die Konfigurationsparameter </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und bestimmt wird </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es ist wichtig, dass dieser Speicher ausreichend ist, da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Server sonst </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keine</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sperre </font><font style="vertical-align: inherit;">ausstellen </font><u><font style="vertical-align: inherit;">kann</font></u></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Daher ist die Anzahl der empfohlenen Sperren, die ein Server ausgeben kann, je nach Serverkonfiguration normalerweise auf Zehntausende oder Hunderttausende begrenzt.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn eine Situation auftritt, in der Sie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mehrere tausend Beratungssperren festlegen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> möchten </font><font style="vertical-align: inherit;">(auch wenn Sie diese später korrekt entfernen), sollten Sie </font><font style="vertical-align: inherit;">im Allgemeinen genau </font><font style="vertical-align: inherit;">überlegen, wo Sie ausgeführt werden, wenn der Server hochfährt.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lecks beim Filtern von Datensätzen</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier nehmen wir die vorherige Anfrage und fügen eine harmlose Bedingung wie Paritätsprüfungs-ID - hinzu </font></font><code>AND pk_id % 2 = 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beide Bedingungen</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für jeden Eintrag </font><font style="vertical-align: inherit;">werden überprüft </font><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">Als Ergebnis wurde es </font></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abgeschlossen, die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sperre wurde überlagert und dann wurde der Datensatz</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nach Parität </font><b><font style="vertical-align: inherit;">gefiltert</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x1/vo/jc/x1vojcx77r-yh1i_j4ygddkfqrg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oder eine Option aus dem Handbuch:</font></font><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">12345</span>; <span class="hljs-comment">-- ok</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">12345</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>; <span class="hljs-comment">-- !</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist alles - die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blockierung bleibt bestehen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber wir sind uns dessen nicht bewusst. </font><font style="vertical-align: inherit;">Es wird im schlimmsten Fall mit den richtigen Anfragen behandelt - </font></font><code>pg_advisory_unlock_all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh, verwirrt!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klassiker des Genres ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwirren Sie </font><font style="vertical-align: inherit;">und </font><font style="vertical-align: inherit;">fragen Sie sich, warum es lange funktioniert. </font><font style="vertical-align: inherit;">Aber weil die Nicht-Try-Version </font><b><font style="vertical-align: inherit;">wartet</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">
Verwirren Sie </font><font style="vertical-align: inherit;">und </font><font style="vertical-align: inherit;">und fragen Sie sich, wohin die Sperre ging - und sie "endete" mit der Transaktion. </font><font style="vertical-align: inherit;">Und die Transaktion bestand aus einer Anfrage, denn nirgends wurde sie "explizit" deklariert, ja.</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_try_advisory_<i><b>xact</b></i>_lock</code><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeite durch pgbouncer</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist für viele eine separate Schmerzquelle, wenn die Arbeit mit der Datenbank aus Gründen der Leistung </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Transaktionsmodus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> über </font><b><font style="vertical-align: inherit;">pgbouncer erfolgt</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies bedeutet, dass zwei Ihrer benachbarten Transaktionen, die auf derselben Verbindung zur Datenbank ausgeführt werden (die tatsächlich den pgbouncer durchläuft), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in verschiedenen "physischen" Verbindungen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf der </font><font style="vertical-align: inherit;">Basisseite ausgeführt werden können </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Und sie haben ihre eigenen Schlösser ... Jedes hat </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ec/l6/h0/ecl6h02_l0hbh4kspdrba2g0a5c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ein paar Möglichkeiten:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder arbeiten Sie über eine direkte Verbindung zur Datenbank</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder erfinden Sie einen Algorithmus, sodass sich alle Beratungssperren nur innerhalb der Transaktion befinden (xact)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist alles für jetzt.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de488010/index.html">Domain Driven Design Tools</a></li>
<li><a href="../de488012/index.html">Parken für Ihre Nachteile</a></li>
<li><a href="../de488014/index.html">9. Fortinet Erste Schritte v6.0. Protokollierung und Berichterstellung</a></li>
<li><a href="../de488018/index.html">CAPTCHA, Sonderfall: Wir unterbrechen ein neuronales Netzwerk mit dreißig Codezeilen</a></li>
<li><a href="../de488020/index.html">Vivaldi 2.11 - One Touch Beauty</a></li>
<li><a href="../de488026/index.html">Schmuck, Formlabs 3D-Drucker und Umweltschutz</a></li>
<li><a href="../de488028/index.html">So starten Sie ein Spiel in UE4</a></li>
<li><a href="../de488030/index.html">So organisieren Sie Skins in Symfony</a></li>
<li><a href="../de488034/index.html">Was kann in 48 Stunden getan werden? Interview mit dem Gewinner des BioHack 2019 Bioinformatik-Hackathons</a></li>
<li><a href="../de488036/index.html">Die Domain corp.com steht zum Verkauf. Es ist gefährlich für Hunderttausende von Unternehmenscomputern, auf denen Windows ausgeführt wird</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>