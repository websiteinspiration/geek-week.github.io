<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👉🏾 🍹 👢 Packer, Terraform dan Ansible: penyebaran cluster Kubernetes dalam satu jam 🆖 📎 🧑🏾‍🤝‍🧑🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hai, nama saya Andrey Schukin, saya membantu perusahaan besar memigrasi layanan dan sistem ke Cloud CROC. Bersama dengan rekan-rekan dari Southbridge,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Packer, Terraform dan Ansible: penyebaran cluster Kubernetes dalam satu jam</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/492616/"><img src="https://habrastorage.org/webt/0m/2c/zt/0m2cztx1saqv1v7e8a3mrliht_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hai, nama saya Andrey Schukin, saya membantu perusahaan besar memigrasi layanan dan sistem ke Cloud CROC. Bersama dengan rekan-rekan dari Southbridge, yang menjalankan kursus Kubernetes di pusat pelatihan Slerm, kami baru-baru ini mengadakan webinar untuk pelanggan kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memutuskan untuk mengambil materi dari kuliah yang sangat baik oleh Pavel Selivanov dan menulis posting untuk mereka yang baru mulai bekerja dengan alat penyedia cloud dan tidak tahu harus mulai dari mana. Oleh karena itu, saya akan berbicara tentang tumpukan teknologi yang digunakan dalam pelatihan dan produksi CROC Cloud kami. Mari kita bicara tentang pendekatan modern untuk manajemen infrastruktur, tentang sekelompok Packer, komponen Terraform dan Ansible, serta tentang alat Kubeadm yang akan kita instal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di bawah potongan akan banyak teks dan konfigurasi. </font><font style="vertical-align: inherit;">Ada banyak materi, jadi saya menambahkan navigasi posting. </font><font style="vertical-align: inherit;">Kami juga menyiapkan repositori kecil di mana kami meletakkan semua yang kami butuhkan untuk penempatan pelatihan kami. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jangan beri nama ayam. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kue panggang lebih sehat daripada yang digoreng. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kita mulai oven. </font><font style="vertical-align: inherit;">Packer </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform - infrastruktur sebagai kode </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luncurkan </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struktur </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">Terraform </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">Cluster Kubernetes </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository dengan semua file</font></font></a><br>
 <a name="habracut"></a><br>
<a name="1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jangan memberi nama untuk ayam</font></font></h2><br>
<img src="https://habrastorage.org/webt/j0/0w/v1/j00wv1h7pcevviakk2iocfleqjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada banyak konsep manajemen infrastruktur yang berbeda. Salah satunya disebut Hewan peliharaan vs. Sapi, yaitu, "hewan peliharaan melawan ternak." Konsep ini menggambarkan dua pendekatan yang bertentangan dengan infrastruktur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bayangkan kita punya anjing favorit. Kami merawatnya, membawanya ke dokter hewan, menyisir bulu, dan secara umum itu unik bagi kami di antara banyak anjing lain.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kasus lain, kami memiliki kandang ayam. Kami juga merawat ayam, memberi makan, memanaskan, dan mencoba menciptakan kondisi yang paling nyaman. Namun demikian, ayam adalah sumber daya yang agak tidak berwajah bagi kita, yang memenuhi fungsinya bertelur, dan paling baik kita menunjuk mereka sebagai "bubuk hitam yang selalu mematuk semen". Jika ayam berhenti bertelur atau mematahkan cakarnya, maka kemungkinan besar ia hanya akan memberi kita kaldu yang lezat untuk makan siang. Faktanya, kita tidak peduli dengan nasib seekor ayam, tetapi tentang kandang ayam secara keseluruhan sebagai jalur produksi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di IT, pendekatan yang serupa mulai diterapkan segera setelah alat muncul yang menurunkan ambang masuk untuk para insinyur dan memungkinkan untuk menyebarkan dan memelihara cluster kompleks dalam mode otomatis penuh.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelumnya, kami memiliki sejumlah kecil server yang dipantau, disetel secara manual, dan dijaga dengan berbagai cara. Dalam pemantauan, log dari server Cthulhu, Aylith, dan Dagon menyala. Tradisi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian virtualisasi dengan kuat memasuki kehidupan kita, dan nama-nama dari karya Lovecraft dan Star Trek memberi jalan kepada "vlg-vlt-vault01.company.ru" yang lebih utilitarian. Ada banyak server, tetapi kami masih meningkatkan layanan lebih atau kurang secara manual, menghilangkan masalah pada setiap mesin jika perlu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang pendekatan untuk memelihara infrastruktur sepenuhnya bertepatan dengan pemrograman. </font><font style="vertical-align: inherit;">Kami menambahkan level abstraksi lain dan berhenti menghiraukan node individual. </font><font style="vertical-align: inherit;">Masing-masing memiliki indeks berwajah bukannya nama, dan dalam kasus masalah mesin virtual hanya membunuh dan bangkit dari snapshot yang berfungsi. </font><font style="vertical-align: inherit;">Ada alat yang memungkinkan Anda untuk menerapkan pendekatan ini. </font><font style="vertical-align: inherit;">Dalam kasus kami, alat pertama adalah CROC Cloud, yang kedua adalah Terraform.</font></font><br>
<br>
<a name="2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kue panggang lebih sehat daripada digoreng</font></font></h2><br>
<img src="https://habrastorage.org/webt/hs/pp/oa/hsppoaujv0lhrk0u3dt6ust0rry.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam manajemen infrastruktur ada perbedaan antara dua pendekatan. Panggang, yaitu, "digoreng dengan dipanggang". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendekatan Fried menyiratkan bahwa Anda memiliki gambar OS vanilla, misalnya, CentOS 7. Kemudian, setelah menggunakan OS, kami menggunakan sistem manajemen konfigurasi untuk membawa sistem ke status target. Misalnya, menggunakan Ansible, Chef, Puppet atau SaltStack.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya berfungsi dengan baik, terutama ketika tidak ada banyak server. Ketika ada kebutuhan untuk penyebaran besar-besaran, kami dihadapkan dengan masalah kinerja. Ratusan server secara serentak mulai melahap sumber daya jaringan, CPU, RAM dan IOPS dalam proses menggulirkan banyak paket baru. Apalagi proses ini bisa ditunda untuk waktu yang agak lama. Singkatnya, sirkuit ini benar-benar operasional, tetapi tidak begitu menarik dari sudut pandang meminimalkan waktu henti selama kecelakaan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendekatan Baked menyiratkan bahwa Anda memiliki gambar OS "dipanggang" yang sudah jadi yang telah Anda instal semua paket yang diperlukan, mengkonfigurasi konfigurasi dan yang lainnya. </font><font style="vertical-align: inherit;">Pada output, kami memiliki template snapshot abstrak, dipertajam untuk kinerja beberapa fungsi. </font><font style="vertical-align: inherit;">Menyebarkan infrastruktur dari gambar yang dipanggang tersebut membutuhkan waktu lebih sedikit dan mengurangi waktu henti seminimal mungkin. </font><font style="vertical-align: inherit;">Ideologi yang sangat mirip digunakan dalam gambar Docker multi-layer, di mana tidak ada yang menjulurkan tangannya dengan tidak perlu. </font><font style="vertical-align: inherit;">Memaku wadah - mengangkat yang baru.</font></font><br>
<br>
<a name="3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memulai oven. </font><font style="vertical-align: inherit;">Packer</font></font></h2><br>
<img src="https://habrastorage.org/webt/xw/mr/im/xwmrimtkl-6qvfcrae3xo4zdf7q.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam infrastruktur kami, kami menggunakan beberapa produk Hashicorp, beberapa di antaranya ternyata sangat sukses. Mari mulai sihir kita dengan menyiapkan dan membuat gambar menggunakan alat Packer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packer menggunakan JSON Template, yaitu file template yang berisi deskripsi tentang apa yang perlu diperoleh sebagai mesin virtual (baked) virtual (VM). Setelah membuat templat, file ditransfer ke Packer, dan izin yang diperlukan untuk membuat server di cloud dikonfigurasikan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packer memungkinkan Anda untuk meningkatkan VM secara lokal di KVM, VirtualBox, Vagrant, AWS, GCP, Alibaba Cloud, OpenStack, dll. Lebih mudah untuk bekerja dengan Packer di CROC Cloud, karena mengimplementasikan antarmuka AWS, yaitu, semua alat yang ditulis untuk AWS, bekerja dengan CROC Cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah mengatur templat yang diperlukan, Packer menaikkan VM CROC di Cloud, menunggunya untuk memulai, dan kemudian "provider" memasuki work - provisioner: utilitas yang harus menyelesaikan persiapan gambar. </font><font style="vertical-align: inherit;">Dalam kasus kami, ini Ansible, meskipun Packer dapat bekerja dengan opsi lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika VM siap, Packer membuat gambarnya dan menempatkannya di CROC Cloud sehingga VM lain dapat diluncurkan dari gambar yang sama.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Struktur Base.json</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di awal file ada bagian di mana variabel dinyatakan:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"variables" : {<font></font>
 "source_ami_name": "{{env SOURCE_AMI_NAME}}",<font></font>
 "ami_name": "{{env AMI_NAME}}",<font></font>
 "instance_type": "{{env INSTANCE_TYPE}}",<font></font>
 "kubernetes_version": "{{env KUBERNETES_VERSION}}",<font></font>
 "docker_version": "{{env DOCKER_VERSION}}",<font></font>
 "subnet_id": "",<font></font>
 "availability_zone": "",<font></font>
},</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Set utama dari variabel-variabel ini akan ditetapkan dari file settings.json. </font><font style="vertical-align: inherit;">Dan variabel yang sering berubah lebih mudah diatur dari konsol saat memulai Packer dan membuat gambar baru. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikut ini adalah bagian Builders:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"builders" : [<font></font>
 {<font></font>
  "type": "amazon-ebs",<font></font>
  "region": "croc",<font></font>
  "skip_region_validation": true,<font></font>
  "custom_endpoint_ec2": "https://api.cloud.croc.ru",<font></font>
  "source_ami": "",<font></font>
  "source_ami_filter": {<font></font>
   "filters": {<font></font>
    "name": "{{user `source_ami_name`}}"<font></font>
    "state": "available",<font></font>
    "virtualization-type": "kvm-virtio"<font></font>
     },<font></font>
...</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cloud target dan metode startup VM dijelaskan di sini. Harap dicatat bahwa dalam hal ini tipe amazon-ebs dideklarasikan, tetapi untuk Packer bekerja dengan CROC Cloud, alamat yang sesuai di custom_endpoint_ec2 diatur. Infrastruktur kami memiliki API yang hampir sepenuhnya kompatibel dengan Amazon Web Services, jadi jika Anda memiliki pengembangan siap pakai untuk platform ini, maka untuk sebagian besar Anda hanya perlu menentukan titik masuk API khusus - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api.cloud.croc.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam contoh kami.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perlu dicatat bagian source_ami_filter secara terpisah. </font><font style="vertical-align: inherit;">Di sini gambar awal VM diatur, di mana perubahan yang diperlukan akan dibuat. </font><font style="vertical-align: inherit;">Namun, Packer membutuhkan AMI untuk gambar ini, yaitu pengidentifikasi acaknya. </font><font style="vertical-align: inherit;">Karena pengidentifikasi ini jarang diketahui sebelumnya dan berubah dengan setiap pembaruan, sumber AMI ditetapkan bukan sebagai nilai spesifik, tetapi sebagai variabel source_ami_filter. </font><font style="vertical-align: inherit;">Dalam hal ini, parameter penentu filter adalah nama gambar. </font><font style="vertical-align: inherit;">Nama ini diatur dalam variabel melalui file settings.json. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, pengaturan VM didefinisikan: jenis instance, prosesor, ukuran memori, ruang yang dialokasikan, dll ditentukan:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"instance_type": "{{user `instance_type`}}",<font></font>
"launch_block_device_mappings": [<font></font>
 {<font></font>
  "device_name": "disk1",<font></font>
  "volume_type": "io1",<font></font>
  "volume_size": "8",<font></font>
  "iops": "1000",<font></font>
  "delete_on_termination": "true"<font></font>
 }<font></font>
],</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikut ini di base.json adalah parameter untuk menghubungkan ke VM ini:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"availability_zone": "{{user `availability_zone`}}",<font></font>
"subnet_id": "{{user `subnet_id`}}",<font></font>
"associate_public_ip_address": true,<font></font>
"ssh_username": "ec2-user",<font></font>
"ami_name": "{{user `ami_name`}}"<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penting untuk mencatat parameter subnet_id di sini. </font><font style="vertical-align: inherit;">Itu harus ditetapkan secara manual, karena tanpa menentukan subnet VM di CROC Cloud tidak mungkin dibuat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parameter lain yang memerlukan persiapan sebelumnya adalah associate_public_ip_address. </font><font style="vertical-align: inherit;">Anda perlu memilih alamat IP putih, karena setelah membuat VM Packer akan mulai menerapkan pengaturan yang diperlukan melalui Ansible. </font><font style="vertical-align: inherit;">Dalam hal ini, Ansible terhubung ke VM melalui SSH, yang memerlukan alamat IP putih atau VPN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagian terakhir adalah Penyedia:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"provisioners": [<font></font>
 {<font></font>
  "type": "ansible",<font></font>
  "playbook_file": "playbook.yml",<font></font>
  "extra_arguments": [<font></font>
   "--extra-vars",<font></font>
   "kubernetes_version={{user `kubernetes_version`}}",<font></font>
   "--extra-vars",<font></font>
   "docker_version={{user `docker_version`}}"<font></font>
   ]<font></font>
  }<font></font>
]</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah penyedia, yaitu utilitas yang digunakan Packer untuk mengkonfigurasi server. </font><font style="vertical-align: inherit;">Dalam hal ini, penyedia jenis yang mungkin digunakan. </font><font style="vertical-align: inherit;">Berikut ini adalah parameter playbook_file, yang menentukan peran yang Mungkin dan host di mana peran yang ditentukan akan diterapkan. </font><font style="vertical-align: inherit;">Opsi tambahan extra_arguments disajikan di bawah ini, yang, ketika memulai Ansible, mengirimkan versi Kubernetes dan Docker.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Persiapan Cloud CROC</font></font></h3><br>
 <img src="https://habrastorage.org/webt/23/_s/uo/23_suoef0us5ia6kjgn8xteomba.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain file konfigurasi kami, kami perlu melakukan beberapa hal dari sisi panel kontrol cloud agar semua keajaiban bekerja. </font><font style="vertical-align: inherit;">Kita perlu memilih IP putih dan membuat subnet yang berfungsi, yang akan kita gunakan saat menggunakan.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klik Sorot Alamat. </font><font style="vertical-align: inherit;">Packer akan menemukan alamat IP putih yang diinginkan sendiri.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klik Buat Subnet dan tentukan subnet dan mask. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salin ID subnet. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masukkan nilai ini ke dalam parameter subnet_id dari perintah startup Packer. </font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/24/0w/gp/240wgpvzi8oyy6ixwzdj8cougqk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian jalankan Packer. </font><font style="vertical-align: inherit;">Dia menemukan gambar VM asli, menyebarkannya di CROC Cloud, dan melakukan peran Ansible di atasnya. </font><font style="vertical-align: inherit;">VM baru dapat dilihat di CROC Cloud di bagian "Mesin Virtual". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/aj/ui/olajuiprqljv50bi2opn4xlqcvs.png"> <br>
 <br>
<img src="https://habrastorage.org/webt/rq/0d/ri/rq0drint5cwvddjxbd7czcyfp9a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menyelesaikan pekerjaan, Packer menghapus VM dari cloud dan meninggalkan gambar yang sudah jadi di tempatnya, yang dapat ditemukan di bagian "Templates". </font><font style="vertical-align: inherit;">Seluruh infrastruktur Kubernetes akan dibuat dari gambar ini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mungkin</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti disebutkan sebelumnya, parameter playbook dilewatkan dalam parameter penyedia Ansible. </font><font style="vertical-align: inherit;">File playbook.yml itu sendiri terlihat seperti ini:</font></font><br>
<br>
<pre><code class="plaintext hljs">- hosts: all<font></font>
  become: true<font></font>
<font></font>
  roles:<font></font>
  | - base</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Transfer file ke Ansible bahwa pada semua host perlu untuk memenuhi peran basis. </font><font style="vertical-align: inherit;">Jika ada peran lain, Anda dapat menambahkannya ke file yang sama dengan daftar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peran dasar memungkinkan Anda untuk mendapatkan cluster yang siap pakai dengan satu perintah. </font><font style="vertical-align: inherit;">File main.yml menunjukkan apa sebenarnya peran ini:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menambahkan repositori Docker ke templat sistem. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menambahkan repositori Kubernet ke templat sistem. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instal paket yang diperlukan. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat direktori untuk mengkonfigurasi daemon Docker. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengkonfigurasi mesin sesuai dengan file konfigurasi daemon.json.j2. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memuat kernel br_netfilter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Termasuk opsi yang diperlukan untuk br_netfilter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Termasuk komponen Docker dan Kubelet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menjalankan Docker di VM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menjalankan perintah yang mengunduh gambar Docker yang diperlukan agar Kubernet berfungsi.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, paket yang diinstal diatur dalam file main.yml dari direktori vars. </font><font style="vertical-align: inherit;">Dalam kasus kami, kami memasang paket docker-ce, serta tiga paket yang diperlukan agar Kubernet berfungsi: kubelet, kubeadm, dan kubectl.</font></font><br>
<br>
<a name="4"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform - infrastruktur sebagai kode</font></font></h2><br>
<img src="https://habrastorage.org/webt/o4/um/wi/o4umwitq-qh_zpwr0thmcmejis0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraform adalah alat yang sangat fungsional dari HashiCorp untuk orkestrasi cloud. Ini memiliki bahasa HCL spesifiknya sendiri, yang sering digunakan dalam produk lain dari perusahaan, misalnya, di HashiCorp Vault and Consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prinsip dasarnya mirip dengan semua sistem manajemen konfigurasi. Anda cukup menunjukkan status target dalam format yang diinginkan, dan sistem menghitung algoritma cara mencapai ini. Hal lain adalah bahwa, tidak seperti Ansible yang sama, yang berfungsi sebagai kotak hitam pada buku pedoman yang kompleks, Terraform dapat mengeluarkan rencana tindakan masa depan dalam bentuk yang nyaman untuk dianalisis. Ini penting ketika merencanakan perubahan infrastruktur yang kompleks. Setelah merencanakan tindakan yang diperlukan, jalankan perintah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terraform apply</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan Terraform akan menggunakan infrastruktur yang dijelaskan dalam file.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti Packer, alat ini mendukung AWS, GCP, Alibaba Cloud, Azure, OpenStack, VMware, dll.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menggambarkan proyek tersebut</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Direktori Terraform memiliki serangkaian file dengan ekstensi .tf. </font><font style="vertical-align: inherit;">File-file ini menjelaskan komponen-komponen infrastruktur yang dengannya kami akan bekerja. </font><font style="vertical-align: inherit;">Hancurkan proyek menjadi modul fungsional. </font><font style="vertical-align: inherit;">Struktur seperti itu membuatnya lebih mudah untuk mengontrol versi dan merakit setiap proyek dari blok nyaman yang sudah jadi. </font><font style="vertical-align: inherit;">Untuk opsi kami, struktur berikut ini cocok:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">network.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">security_groups.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tpl</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Struktur file main.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita mulai dengan file main.tf, di mana akses ke cloud dikonfigurasi. </font><font style="vertical-align: inherit;">Secara khusus, beberapa parameter diumumkan yang mengonfigurasi Terraform agar berfungsi dengan CROC Cloud:</font></font><br>
<br>
<pre><code class="plaintext hljs">provider "aws" {<font></font>
 endpoints {<font></font>
  ec2 = "https://api.cloud.croc.ru"<font></font>
 }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, file tersebut menjelaskan bahwa Terraform harus secara independen membuat kunci pribadi dan mengunggah bagian publiknya ke semua server. </font><font style="vertical-align: inherit;">Kunci pribadi itu sendiri dikeluarkan pada akhir Terraform:</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "tls_private_key" "ssh" {<font></font>
 algorithm = "RSA"<font></font>
}<font></font>
resource "aws_key_pair" "kube" {<font></font>
 key_name = "terraform"<font></font>
 public_key = "${tls_private_key.ssh.public_key_openssh}"<font></font>
}<font></font>
output "ssh" {<font></font>
value = "${tls_private_key.ssh.private_key_pem}"<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Struktur file network.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File ini menjelaskan komponen-komponen jaringan yang diperlukan untuk memulai VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">data "aws_availability_zones" "az" {<font></font>
 state = "available"<font></font>
}<font></font>
resource "aws_vpc" "kube" {<font></font>
 cidr_block = "${var.vpc_cidr}"<font></font>
}<font></font>
resource "aws_eip" "master" {<font></font>
 count = "1"<font></font>
 vpc = true<font></font>
}<font></font>
resource "aws_subnet" "private" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 count = "${length(data.aws_availability_zones.az.names)}"<font></font>
 cidr_block = "${var.private_subnet_cidr_list[count.index]}"<font></font>
 availability_zone = "${data.aws_availability_zones.az.names[count.index]}"<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraform menggunakan dua jenis komponen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sumber daya - apa yang perlu dibuat;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data - apa yang perlu Anda dapatkan.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal ini, parameter data menunjukkan bahwa Terraform harus menerima zona ketersediaan cloud yang ditentukan, yang berada dalam keadaan tersedia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sumber daya parameter pertama menjelaskan pembuatan cloud pribadi virtual, dan parameter berikutnya menjelaskan pembuatan Alamat IP Elastis. Untuk kluster Kubernetes, kami memesan alamat IP ini melalui Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lebih jauh, di setiap zona aksesibilitas, dan saat ini CROC memiliki dua layanan cloud, subnetnya sendiri dibuat. Sumber daya tipe aws_subnet dideklarasikan, dan ID dari aws_vpc yang dihasilkan dilewatkan sebagai bagian dari parameter ini. Namun, karena ID sumber daya ini masih belum diketahui, kami menentukan parameter aws_vpc.kube.id, yang merujuk pada sumber daya yang dibuat dan menggantikan nilai dari bidang ID.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena jumlah subnet yang dibuat ditentukan oleh jumlah zona ketersediaan cloud dan angka ini dapat berubah seiring waktu, parameter ini ditetapkan melalui variabel panjang (data.aws_available_zones.az.names), yaitu panjangnya daftar zona akses yang diterima melalui parameter data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dua parameter terakhir adalah cidr_block (subnet yang dialokasikan) dan zona ketersediaan tempat subnet ini dibuat. </font><font style="vertical-align: inherit;">Parameter terakhir juga ditetapkan melalui variabel yang mengambil nilai dari daftar data sesuai dengan indeks loop yang dinyatakan oleh </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[count.index]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Struktur file Security_groups.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grup keamanan adalah semacam firewall untuk cloud, yang dapat dibuat bukan di dalam VM itu sendiri, tetapi oleh cloud. </font><font style="vertical-align: inherit;">Dalam hal ini, firewall menjelaskan dua aturan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aturan pertama membuat grup keamanan yang disebut kubus. </font><font style="vertical-align: inherit;">Grup keamanan ini diperlukan untuk memungkinkan semua lalu lintas keluar dari node Kubernetes, memungkinkan node untuk secara bebas mengakses Internet. </font><font style="vertical-align: inherit;">Lalu lintas masuk ke simpul Kubernetes dari subnet dari simpul itu sendiri juga diizinkan. </font><font style="vertical-align: inherit;">Dengan demikian, node Kubernetes dapat bekerja di antara mereka sendiri tanpa batasan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aturan kedua membuat grup keamanan ssh. </font><font style="vertical-align: inherit;">Ini memungkinkan koneksi SSH dari alamat IP apa pun ke port 22 dari kluster Kubernetes VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_security_group" "kube" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "kubernetes"<font></font>
 # Allow all outbound<font></font>
 egress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
 # Allow all internal<font></font>
 ingress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["${var.vpc_cidr}"]<font></font>
 }<font></font>
}<font></font>
resource "aws_security_group" "ssh" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "ssh"<font></font>
<font></font>
 # Allow all inbound<font></font>
 ingress {<font></font>
  from_port = 22<font></font>
  to_port = 22<font></font>
  protocol = "tcp"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Master node. </font><font style="vertical-align: inherit;">Struktur file Master.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File master.tf menjelaskan pembuatan beberapa templat dan instance. </font><font style="vertical-align: inherit;">Secara khusus, instance master Kubernetes sedang dibuat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Variabel ami mengatur AMI dari gambar sumber untuk VM. </font><font style="vertical-align: inherit;">Berikut ini menjelaskan jenis VM dan subnet di mana ia dibuat. </font><font style="vertical-align: inherit;">Saat mendefinisikan subnet, sebuah siklus lagi digunakan untuk membuat VM di setiap zona ketersediaan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, grup keamanan yang digunakan dan kunci yang ditentukan dalam file main.tf dideklarasikan. </font><font style="vertical-align: inherit;">Bidang user_data berisi eksekusi satu set skrip cloud-init, yang hasilnya akan diimplementasikan dalam VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_instance" "master" {<font></font>
 count = "1"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"<font></font>
 disable_api_termination = false<font></font>
 instance_initiated_shutdown_behavior = "terminate"<font></font>
 source_dest_check = false<font></font>
 subnet_id = "${aws_subnet.private.*.id[count.index % length(data.aws_availability_zones.az.names)]}"<font></font>
 associate_public_ip_address = true<font></font>
 vpc_security_group_ids = [<font></font>
  "${aws_security_group.ssh.id}",<font></font>
  "${aws_security_group.kube.id}",<font></font>
 ]<font></font>
 key_name = "${aws_key_pair.kube.key_name}"<font></font>
 user_data = "${data.template_cloudinit_config.master.rendered}"<font></font>
 monitoring = "true"<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Master node. </font><font style="vertical-align: inherit;">Cloud init</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloud-init</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah alat yang dikembangkan Canonical. </font><font style="vertical-align: inherit;">Ini memungkinkan Anda untuk secara otomatis mengeksekusi dalam infrastruktur cloud seperangkat perintah tertentu setelah memulai VM. </font><font style="vertical-align: inherit;">Terraform memiliki mekanisme untuk </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengintegrasikannya menggunakan templat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena tidak mungkin untuk "memanggang" semua yang diperlukan dalam VM, setelah memulai, tergantung pada jenisnya, ia harus bergabung dengan cluster Kubernetes atau menginisialisasi cluster Kubernetes. </font><font style="vertical-align: inherit;">Dalam templat file cloud-init yang disebut master.tpl, beberapa tindakan dilakukan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. File konfigurasi untuk Kubeadm direkam:</font></font><br>
<br>
<pre><code class="plaintext hljs">#cloud-config<font></font>
<font></font>
    write_files:<font></font>
    - path: etc/kubernetes/kubeadm.conf<font></font>
      owner: root:root<font></font>
      content:<font></font>
    ...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Serangkaian perintah dijalankan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alamat IP dari wizard ditulis ke file konfigurasi yang dihasilkan;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master di cluster Kubernetes diinisialisasi dengan perintah init kubeadm;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di kluster Kubernetes, jaringan overlay Calico diinstal dengan perintah Kubectl apply.</font></font></li>
</ul><br>
 <pre><code class="plaintext hljs">runcmd:<font></font>
         - sed -i "s/CONTROL_PLANE_IP/$(curl http://169.254.169.254/latest/meta-data-local-ipv4)/g" /etc/kubernetes/kubeadm.conf<font></font>
         - kubeadm init --config /etc/kubernetes/kubeadm.conf<font></font>
         - mkdir -p $HOME/.kube<font></font>
         - sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<font></font>
         - sudo chown $(id -u):$(id -g) $HOME/.kube/config<font></font>
         - kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah mengeksekusi perintah ketika memulai VM, klaster Kubernet yang berfungsi diperoleh dari satu node master. </font><font style="vertical-align: inherit;">Node yang tersisa akan bergabung dengan master node ini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node biasa. </font><font style="vertical-align: inherit;">node.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File node.tf mirip dengan file master.tf. </font><font style="vertical-align: inherit;">Sumber daya juga dibuat di sini, yang dalam hal ini disebut simpul. </font><font style="vertical-align: inherit;">Satu-satunya perbedaan adalah bahwa node master dibuat dalam satu instance, dan jumlah node yang bekerja dibuat melalui variabel nodes_count:</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "aws_instance" "node" {<font></font>
 count = "${var.nodes_count}"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File cloud-init untuk node yang bekerja mengeksekusi hanya satu perintah - kubeadm join. </font><font style="vertical-align: inherit;">Perintah ini menempel mesin jadi ke kluster Kubernetes menggunakan token otorisasi yang kami kirim.</font></font><br>
<br>
<a name="5"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luncurkan Terraform</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat diluncurkan, Terraform menggunakan beberapa modul:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modul AWS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modul template;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modul TLS bertanggung jawab untuk pembuatan kunci. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modul-modul ini harus diinstal pada mesin lokal:</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform init terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bersama dengan perintah ini, direktori di mana semua file yang diperlukan berada ditunjukkan. </font><font style="vertical-align: inherit;">Saat menginisialisasi, Terraform mengunduh semua modul yang ditentukan, setelah itu Anda perlu menjalankan perintah rencana terraform:</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform plan -var-file terraform/vars/dev.tfvars terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Harap dicatat bahwa selain direktori dengan file Terraform, file var diindikasikan, yang berisi nilai-nilai variabel yang digunakan dalam file Terraform. </font><font style="vertical-align: inherit;">Direktori vars dapat berisi beberapa file .tfvars, yang memungkinkan Anda untuk mengelola berbagai jenis infrastruktur dengan satu set file Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File dev.tfvars sendiri berisi variabel-variabel penting berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_version (versi yang dapat diinstal dari Kubernetes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_ami (gambar AMI yang dibuat Packer). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah mengatur nilai-nilai yang diperlukan dari variabel, jalankan perintah rencana terraform, setelah itu Terraform akan menyajikan daftar tindakan yang diperlukan untuk mencapai keadaan yang dijelaskan dalam file Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah memeriksa daftar ini, terapkan perubahan yang diajukan: </font></font><br>
<br>
<code>terraform apply -auto-approve -var-file terraform/vars/dev.tfvars terraform/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari perintah rencana terraform, dibedakan dengan adanya kunci - setujui otomatis, yang menghilangkan kebutuhan untuk mengonfirmasi perubahan yang dibuat. </font><font style="vertical-align: inherit;">Anda dapat menghilangkan kunci ini, tetapi setiap tindakan perlu dikonfirmasi secara manual.</font></font><br>
<br>
<a name="6"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Struktur Cluster Kubernetes</font></font></h2><br>
<img src="https://habrastorage.org/webt/zs/i-/c3/zsi-c326-ips2acfurg_trunzhm.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cluster Kubernetes terdiri dari node master yang melakukan fungsi manajemen dan node kerja yang menjalankan aplikasi yang diinstal dalam cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Empat komponen diinstal pada master node yang memastikan pengoperasian sistem ini:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETCD, mis. Basis Data Kubernetes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API Server, yang melaluinya kami menyimpan informasi di Kubernetes dan mendapatkan informasi darinya;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manajer Pengendali</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penjadwal </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dua komponen tambahan dipasang pada node yang bekerja:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kube-proxy (bertanggung jawab untuk membuat aturan jaringan di kluster Kubernetes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubelet (bertanggung jawab untuk mengirim perintah ke daemon Docker untuk menjalankan aplikasi di kluster Kubernetes). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antara node, plug-in jaringan Calico berfungsi.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagram Alur Kerja Cluster</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/oz/ew/f3/ozewf310dnhdmnx2gg4ozhzb1rc.png"><br>
,      Kubernetes    replicaset.<br>
<br>
<ol>
<li>     API-,     ETCD.        .</li>
<li>API-      .</li>
<li>Controller-manager   API-   ,    «»,    .</li>
<li>Scheduler       .       ETCD  API-.</li>
<li>Kubelet  API-  Docker    .</li>
<li>Docker   .</li>
<li>Kubelet   API-   ,     .</li>
</ol><br>
 ,    Kubernetes  ,      .       ,           ,     YAML-.  ,   ,    API-.       .<br>
</div></div><br>
<a name="7"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm</font></font></h2><br>
<img src="https://habrastorage.org/webt/wd/sw/cu/wdswcujzvnx4ynnrbi_ec9c1gr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elemen terakhir yang layak disebut adalah Kubeadm. </font><font style="vertical-align: inherit;">Menyebarkan sekelompok Kubernet baru selalu merupakan proses yang melelahkan. </font><font style="vertical-align: inherit;">Pada setiap tahap, ada risiko kesalahan karena faktor manusia, dan banyak tugas yang sangat rutin dan panjang. </font><font style="vertical-align: inherit;">Misalnya, menuangkan sertifikat untuk enkripsi TLS di antara node dan tetap memperbaruinya. </font><font style="vertical-align: inherit;">Di sinilah utilitas untuk otomatisasi template dasar datang untuk menyelamatkan. </font><font style="vertical-align: inherit;">Trik Kubeadm adalah bahwa ia secara resmi disertifikasi untuk bekerja dengan Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini memungkinkan Anda untuk:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instal, konfigurasikan, dan jalankan semua komponen cluster utama</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengelola sertifikat, termasuk memutarnya dan menulis yang baru;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengelola versi komponen klaster (pemutakhiran dan penurunan versi). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat yang sama, Kubeadm bukanlah sistem manajemen kluster Kubernetes yang lengkap, tetapi merupakan jenis blok bangunan yang memungkinkan Anda untuk mengkonfigurasi Kubernetes pada node di mana utilitas Kubeadm berjalan. </font><font style="vertical-align: inherit;">Ini berarti bahwa sistem orkestrasi diperlukan yang akan menjalankan semua VM yang diperlukan, mengkonfigurasinya dan menjalankan Kubeadm pada semua node. </font><font style="vertical-align: inherit;">Untuk keperluan inilah Terraform digunakan.</font></font><br>
<br>
<a name="8"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositori dengan semua file</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kami meletakkan semua file dan konfigurasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> di satu tempat, sehingga akan lebih nyaman bagi Anda. </font><font style="vertical-align: inherit;">Jika Anda tidak memiliki cloud pribadi, tetapi Anda ingin melalui semua langkah ini sendiri dan menguji penerapannya dalam praktik, kirimkan kepada kami di cloud@croc.ru. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan memberi Anda versi demo untuk tes dan memberi saran tentang semua masalah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan segera akan ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slurm baru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , di mana Anda dapat membuat cluster Anda sendiri. </font><font style="vertical-align: inherit;">Kode promo CROC memiliki diskon 10%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagi mereka yang sudah bekerja dengan Kubernetes, ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kursus lanjutan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Diskonnya sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kolega, Habraparser memecah markup kode. </font><font style="vertical-align: inherit;">Silakan ambil sumbernya dari GitHub dari tautan di atas.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id492600/index.html">Panduan Semi-Ilmiah untuk Hosting Router WiFi</a></li>
<li><a href="../id492604/index.html">Bekerja dengan View asynchronous menggunakan coroutine</a></li>
<li><a href="../id492606/index.html">Masalah Toolkit dalam proyek besar</a></li>
<li><a href="../id492608/index.html">Fitur fitur pengiriman dalam proyek besar</a></li>
<li><a href="../id492612/index.html">Lampu langit-langit dekoratif Leek Celebrity</a></li>
<li><a href="../id492628/index.html">Interval kepercayaan untuk jumlah pasien dengan coronavirus (perhitungan kematian)</a></li>
<li><a href="../id492632/index.html">Usaha kecil yang dikarantina: panik adalah musuh akal</a></li>
<li><a href="../id492636/index.html">Apa artinya menjadi efektif?</a></li>
<li><a href="../id492638/index.html">Menskalakan aplikasi Redux dengan bebek</a></li>
<li><a href="../id492642/index.html">Buat arsitektur yang skalabel dan tangguh dengan layanan microser dinamis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>