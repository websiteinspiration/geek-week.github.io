<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤽🏾 🏂🏻 📴 Xiaomi Gateway (EU-Version - Lumi.gateway.mieu01) gehackt 👎🏻 🙍🏾 🌁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Xiaomi Zigbee Gateway Hack
 
 In diesem Artikel möchte ich Ihnen meine Best Practices und Erfolge beim Parsen des Xiaomi Gateways (Version mit Euro-Pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Xiaomi Gateway (EU-Version - Lumi.gateway.mieu01) gehackt</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494296/"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xiaomi Zigbee Gateway Hack</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In diesem Artikel möchte ich Ihnen meine Best Practices und Erfolge beim Parsen des Xiaomi Gateways (Version mit Euro-Plug mit I take.ru) mitteilen. </font><font style="vertical-align: inherit;">Ich werde Ihnen erklären, wie Sie alternative Software darauf installieren, wie Sie ein Gateway mit einer gelöschten Software wiederherstellen und sogar ein Gateway mit einem gelöschten U-Boot wiederbeleben. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--------- VIELE BILDER -------------</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/aa/to/qs/aatoqssn86dgak8fgyoirmaiyae.png"><br>
<a name="habracut"></a><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zunächst erkläre ich Ihnen, wie Sie eine Verbindung zur Gateway-Karte herstellen und den Root erhalten. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst einige Details zum Gateway. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Artikel beschreibt die Version des Gateways, das auf dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imx6ull-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prozessor </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">basiert</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige technische Daten der Platine:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wifi RTL8723BS - der Treiber davon wird aus irgendeinem Grund separat geladen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU IMX6ULL</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM 256 mb</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM 256 mb</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZIgbee-Modul basierend auf JN5169.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der Karte werden die Service-Groschen P2 und P4 angezeigt. Idealerweise werden sie unter den Pogopins hergestellt, sind aber leichter zu löten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
P2 ist Wart 0 des Prozessors, auf dem alle Serviceinformationen angezeigt werden, das Uboot-Bootlog und die Systemverwaltung. Sie können jeden USB-Uart-Adapter verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
P4 - USB OTG, mit dem Firmware auf nand hochgeladen wird. (Als vollwertiges OTG konnte ich es bis zum Ende nicht starten, wenn es verbunden war, das Gerät wird erkannt, aber anscheinend fehlt etwas anderes). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/zf/wn/iazfwn64giouka5exv5urahv-1w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die chinesische USB-Adapterplatine ist ideal für die Spitznamen P4 geeignet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/na/ty/7a/naty7aswx3muah3ityxjrswxq_s.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem alles gelötet und verbunden ist, müssen Sie zuerst root werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe gemäß dieser Anweisung </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Link zum Handbuch) gearbeitet,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aber mit einer kleinen Klarstellung nach Punkt 5 müssen Sie den </font><b><font style="vertical-align: inherit;">Startbefehl</font></b><font style="vertical-align: inherit;"> eingeben</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andernfalls sitzt das System und wartet auf einen Befehl. Die Anweisungen wurden wahrscheinlich in der Hoffnung geschrieben, dass jeder Linux versteht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus irgendeinem Grund wurde der SSH-Server nicht gemäß den Anweisungen eingeschaltet und nur durch manuelles Starten des Befehls zum Starten von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/init.d/dropbear start eingeschaltet.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Im nächsten Schritt, nach Erhalt des Stammverzeichnisses, kopierte ich den Inhalt des Systems mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinScp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (wir wählen den SCP-Modus beim Erstellen der Verbindung). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Außerdem müssen Sie das gesamte System sichern, falls die Experimente zu traurigen Konsequenzen führen (wie ich, aber ich habe nicht gesichert). Der </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flash-Speicher des Gateways ist in vier Abschnitte unterteilt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lx/kb/qs/lxkbqs0mfj1ggqsaz5hftqbyzpw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie sich herausstellte, gibt es auch nicht viel freien Speicherplatz, während im Speicher viele verschiedene doppelte Dateien vorhanden sind.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ci/sl/5m/cisl5mcfvpafxdna0tzjs2w7iko.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich ein paar Stunden gespielt hatte, änderte ich etwas in der Software und das Gateway wurde nicht mehr geladen :) </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nun wollen wir herausfinden, wie wir dieses Stück Eisen wiederbeleben und alles damit füllen können. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Führen Sie Aktionen nur aus, wenn Sie einen Stein haben!</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Der Imx6ULL-Prozessor enthält alle Informationen in offener Form. Alle Datenkarten und Referenzhandbücher sind nach der Registrierung auf der Website des Herstellers verfügbar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
U-Boot wurde immer noch auf mich geladen ... Aber während ich versuchte, mich zu erholen, habe ich versehentlich einen zusätzlichen Befehl kopiert und das Nand vollständig gelöscht. Und U-Boot war, wie sich herausstellte, in Nanda. Und er hat einen Ziegelstein bekommen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Prozessor unterstützt verschiedene Startmodi. Im Referenzhandbuch werden alle beschrieben.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nu/dq/qb/nudqqbeastlqyzr8ttgb4cpahti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Entwicklungsplatinen haben normalerweise Schalter, aber es gibt nichts Vergleichbares. Das Datenblatt beschreibt, um welche Art von Prozessor es sich handelt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/ca/nx/xbcanxw13rmesy3gosochuueqio.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dann machten die Chinesen auch ein sehr schönes Geschenk. Sie brachten sie an einen sehr bequemen Ort und hätten sie fast signiert.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf der Platine neben dem Prozessor sind zwei Widerstände gelötet, an denen die Boot-Mode-Pins gerade passen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/mq/ak/vjmqakv9dquslukw8leus3myyra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese beiden Widerstände sind nur Schalter für den Startmodus. Standardmäßig ist sie auf nand eingestellt. Wenn Sie sie jedoch jeweils zur Seite verschieben, erhalten Sie den seriellen Startmodus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mein Gateway in den seriellen Startmodus versetzt. In gewisser Weise ist dieser Modus bequemer, um verschiedene Firmware zu testen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Hochladen der Firmware wird ein proprietäres Dienstprogramm von NXP mfgtools verwendet. Das einzige, was darin enthalten ist, ist die Erstellung eines Profils für den Prozessor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laden Sie </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">mfgtools</font></a><font style="vertical-align: inherit;"> herunter</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Das Archiv ist bereits vorbereitete Version mit allen notwendigen Einstellungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir verbinden das Gateway über USB. Im seriellen Startmodus versucht das Gateway, die Firmware über die USB-Schnittstelle herunterzuladen, und ein neues HID-Gerät wird auf dem Computer angezeigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mfgtools informiert Sie wiederum darüber, dass ein neues Gerät angezeigt wird. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/dc/hg/xbdchgif-86a8uy3htahr8_xey4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Manchmal sieht der Computer es nicht, mit was er verbunden ist kann ich nicht sagen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem das Dienstprogramm es gesehen hat, klicken Sie auf Start, und der Download der Firmware beginnt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Dienstprogramm formatiert das nand und überflutet das neue ubut, den neuen Kernel, dtb und rootfs. Die Rootfs im Archiv wurden von einem Freund Aleksandr Faronov zusammengestellt, der einen sauberen Linux-Build auf Yocto zusammenstellte. Die Abschnitte U-Boot, Kernel und DTB wurden aus der nativen Firmware des Gateways entfernt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser Linux-Assembly wird nur ein sauberes System gestartet, es wird nichts mehr geben (</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigby funktioniert auch noch nicht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem das Dienstprogramm in meinem Fall funktioniert, wird das Gateway nichts tun und auch laden, da wir den Prozessor im seriellen Startmodus zurückrufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher muss ihm ein bootfähiges U-Boot-Image zugewiesen werden. </font><font style="vertical-align: inherit;">Im Archiv mit mfgtools gibt es ein zusätzliches Dienstprogramm uuu, das das U-Boot-Laden im Ram des Boards durchführt. Gehen wir zu dem Ordner, der es enthält. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir schließen mfgtools und verbinden das Gateway wieder mit einem neuen. Das HID-Gerät sollte erneut erkannt werden. Danach führen wir den Befehl aus.</font></font><br>
<br>
<pre><code class="plaintext hljs">uuu u-boot-small.imx</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Board wird geladen, aber da es keine Umgebung hat, wird es nach dem Laden von U-Boot aufstehen. </font><font style="vertical-align: inherit;">In der Gateway-Konsole führen wir zwei Befehle aus und registrieren ENV zum Laden.</font></font><br>
<br>
<pre><code class="plaintext hljs">setenv bootargs 'console=ttymxc0,115200 ubi.mtd=3 root=ubi0:rootfs rootfstype=ubifs cma=96M mtdparts=gpmi-nand:3m(boot),7m(kernel),1m(dtb),-(rootfs)'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
und starten Sie den Boot- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boot</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das Gateway wird von Nanda und von der von uns hochgeladenen Firmware geladen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9v/oi/n5/9voin5jgztxajypsqjkol1ki-p0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Großen und Ganzen ist das alles. </font><font style="vertical-align: inherit;">In mfgtools im Ordner \ Profiles \ Linux \ OS Firmware \ files befinden sich alle Firmware-Dateien, durch die Sie jedes kompatible System laden können. </font><font style="vertical-align: inherit;">Ich habe versucht, openwrt herunterzuladen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wf/qy/ye/wfqyyekyy177yvbh0uczs_aryoq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das System wird geladen, aber ich habe immer noch nicht herausgefunden, wie ich den richtigen Kern einsetzen und wo ich ihn bekommen kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe, dass wir durch gemeinsame Anstrengungen dieses Gateway weiterhin zu seiner logischen Schlussfolgerung bringen können.) </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sicherung der Gateway-Verzeichnisse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegramm zur Diskussion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de494284/index.html">Hausgemachtes Antiseptikum aus dem, was in der Apotheke ist. Wir machen Alkohol aus Wodka ohne Mondschein auf altmodische Weise</a></li>
<li><a href="../de494286/index.html">Embox RTOS auf Raspberry Pi</a></li>
<li><a href="../de494290/index.html">#YAMYWork. Eine Entscheidung, die richtig sein kann</a></li>
<li><a href="../de494292/index.html">Wrike: 5 Jahre bei OKR</a></li>
<li><a href="../de494294/index.html">3D-Druck für die Öl- und Gasindustrie sowie die Schifffahrtsindustrie zertifiziert</a></li>
<li><a href="../de494298/index.html">Gesandter für die Kleinen</a></li>
<li><a href="../de494300/index.html">Delegieren der RDP-Sitzungsverwaltung</a></li>
<li><a href="../de494302/index.html">Tagesziele als Teammanagement-Tool</a></li>
<li><a href="../de494304/index.html">30 UX-Tipps in Augmented Reality</a></li>
<li><a href="../de494306/index.html">Kein Geld. Bei wem?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>