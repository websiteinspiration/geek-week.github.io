<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💃 ♏️ 👨🏿‍🚀 我们继续分析工业交换机的漏洞：我们执行没有密码的任意代码 👨‍👨‍👧‍👧 💙 ✍️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在实证研究2019中，我们回顾了Moxa工业交换机管理协议。这次我们将继续本主题，并详细分析我们的专家确定的FL SWITCH 3xxx，FL SWITCH 4xxx和FL SWITCH 48xx系列模型的Phoenix Contact交换机中的漏洞CVE-2018-10731。在设备的Web界面中...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>我们继续分析工业交换机的漏洞：我们执行没有密码的任意代码</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/493944/"><img src="https://habrastorage.org/webt/wk/gg/bb/wkggbbfxuzftoyyqhtjr0hh6x6o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在实证研究2019中，我们回顾了Moxa工业交换机管理协议。</font><font style="vertical-align: inherit;">这次我们将继续本主题，并详细分析我们的专家确定的FL SWITCH 3xxx，FL SWITCH 4xxx和FL SWITCH 48xx系列模型的Phoenix Contact交换机中的漏洞CVE-2018-10731。</font><font style="vertical-align: inherit;">在设备的Web界面中检测到此漏洞，可以在不知道设备凭据的情况下执行任意代码，在CVSS版本3等级中，该漏洞的等级为10分之9。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一眼</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上面提到的设备正在运行Linux，您可以使用Web界面对其进行配置。与许多其他家用和工业IoT设备一样，Web界面由许多处理用户HTTP请求的CGI应用程序组成。在我们的案例中，CGI应用程序积极使用cgic库，该库有助于处理HTTP请求，并且该库的功能内置</font></font><code>libipinfusionweb.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在设备文件系统中</font><font style="vertical-align: inherit;">的共享库</font><font style="vertical-align: inherit;">中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在处理HTTP请求时，Web服务器将用户请求数据作为一组环境变量传递给CGI应用程序。它们的初始处理由</font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">函数执行</font></font><code>libipinfusionweb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。接下来，该函数</font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用</font></font><code>cgiMain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CGI应用程序</font><font style="vertical-align: inherit;">的函数，在该函数</font><font style="vertical-align: inherit;">中对请求进行进一步处理。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eu/hm/yd/euhmydlkhy2r76pkvmiurftmv3a.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图1.处理HTTP请求</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
在其工作过程中，库的主要功能会</font></font><code>libipinfusionweb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用一个函数</font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">该函数</font><font style="vertical-align: inherit;">根据传递的Cookie值确定用户是否已通过系统中的身份验证。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/-a/tl/ra-atlrdqdebpr4qgh855ykd5f8.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图2.主</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
函数的</font><i><font style="vertical-align: inherit;">伪代码片段该</font></i><font style="vertical-align: inherit;">函数使用该函数</font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接收Cookie参数</font></font><code>c_session</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的值</font></font><code>cookies_get_value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并将其存储在变量中</font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。变量本身</font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个长度为0x80的单字节字符数组，并且距离堆栈的开头距离为0xE0。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2s/m7/ti/2sm7tilkgmlwt5ahmjz742yonxu.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图3. get_login_user函数的伪代码片段</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
但是，在函数代码</font></font><code>cookies_get_value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中可以看出，</font></font><code>cgiCookieString</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">函数</font><font style="vertical-align: inherit;">接收</font><font style="vertical-align: inherit;">的Cookie参数</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">值的最大长度为0x400字节。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/uz/xv/jtuzxvss3ihvfbtjp0vnq0ytr4c.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图4. cookies_get_value函数的伪代码的一部分</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
因此，当传递长度超过0xE0（224）个字符的Cookie参数时，该函数会</font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将此参数的值保存到其堆栈中，结果</font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将覆盖</font><font style="vertical-align: inherit;">该变量后面的堆栈上的所有信息</font><font style="vertical-align: inherit;">，包括地址返回函数。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：当一个函数调用另一个函数时，返回地址存储在堆栈中。</font><font style="vertical-align: inherit;">当被调用函数完成其工作时，控制权将转移到该地址。</font><font style="vertical-align: inherit;">因此，如果重写此地址，则可以控制程序执行过程。</font><font style="vertical-align: inherit;">例如，攻击者可以使用位于程序地址空间中的恶意shellcode的地址替换此地址。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请注意，返回地址的重写是在验证身份验证之前进行的，这使得有可能利用此漏洞的攻击者不知道设备的凭据。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开发</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们研究了几种方法来证明利用此漏洞的可能性。最简单的方法是将有效载荷代码写到堆栈上（0x400-0xE0 =剩下800字节，对于代码来说足够了），然后用代码地址重写返回地址。从理论上讲，此选项是可行的，因为易受攻击的交换机的处理器不支持NX位功能（也就是说，它允许执行位于包括堆栈在内的任何位置的代码），但实际上存在严重限制。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
易受攻击的交换处理器具有MIPS架构；该体系结构中的许多处理器指令都以包含零字节的字节序列进行编码。缓冲区内容被写到第一个零字节（由于使用了该功能）</font></font><code>strcpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），因此仅需要使用不包含空字节的操作数，这是不可能的，因为任何有效载荷都将使用这些字节中的至少几个字节。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同样，在构建</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROP链</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时，我们将不得不面对空字节的限制：ROP小工具的地址不应包含零，这会使它们的搜索变得非常复杂。总的来说，我们只能使用由strcpy函数复制的一个零。这限制了完整ROP链的创建，此外，我们所需的小工具非常少。但是，在libipinfusionweb库中搜索期间，发现以下代码片段：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/am/xs/u5/amxsu5zw9x3p9-0tfzjtu-geal8.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图5. libipinfusionweb库的可执行代码片段</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设寄存器$ s0的内容受到控制，此代码片段使您可以使用一个函数执行OS命令</font></font><code>mysystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（该函数最初没有名称，但是我们将其重命名，因为它与Linux中的系统功能非常相似）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于我们正在重写get_login_user函数的返回地址，因此该函数将执行到最后。在get_login_user函数的结尾中，您可以看到寄存器$ s0的值从堆栈上先前保存的值中恢复（从堆栈顶部偏移0xD8）。但是，在这一点上，堆栈的这个区域已经在我们的控制之下，也就是说，实际上，我们可以实现对寄存器$ s0内容的控制，从而可以使用函数执行任意OS命令</font></font><code>mysystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e3/k7/d9/e3k7d9mryjtpuojvi62ho7weooy.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图6. get_login_user函数可执行代码的片段</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
因此，为了成功演示此漏洞的利用，我们需要将</font></font><code>Cookie c_session</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含以下内容</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">长行</font><font style="vertical-align: inherit;">作为参数发送</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS字符串命令，该命令随后将传递给mysystem函数；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该命令在堆栈上的地址；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新的返回地址（图5中所示代码段的地址）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最终的有效负载应如下所示：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uz/zv/xp/uzzvxpf4lv9zws3zpnmjgdzqcyq.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图7.有效负载</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
至此，我们已经在设备上安装了一个外壳，该外壳使用了需要管理员权限才能运行的漏洞。</font><font style="vertical-align: inherit;">因此，我们能够获得有助于我们运营的其他信息：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">被研究设备上的ASLR被禁用-因此，所使用的小工具的地址和OS命令将始终相同。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/wi/84/v3/wi84v3-p-susaji9zxkzat8yrdq.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图8.被调查设备上的ASLR状态</font></font></i><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">堆栈可能位于的内存地址范围。</font><font style="vertical-align: inherit;">为了计算确切的地址，我们遍历了该范围内的所有地址。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为有效负载，我们实现了Web外壳的加载，这是具有以下内容的CGI应用程序：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">eval</span> <span class="hljs-variable">$HTTP_CMD</span> 2&gt;&amp;1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于根据CGI协议，HTTP头的内容以名称为HTTP_ &lt;Header Name&gt;的环境变量的形式传输到CGI应用程序，因此此shell </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将</font><font style="vertical-align: inherit;">使用命令</font><font style="vertical-align: inherit;">执行CMD HTTP头的内容。</font><font style="vertical-align: inherit;">下图显示了使用已加载的shell成功执行和执行ls命令的结果。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/az/lp/um/azlpumbjd1xgx9r6q3xqhihtiqy.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图9.成功执行和执行ls命令的结果</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们已经展示了利用此漏洞的能力。</font><font style="vertical-align: inherit;">正如我们已经提到的，其操作不需要知道密码，因此即使未经身份验证的攻击者也可以执行该操作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
入侵工业网络交换机可能会损害整个生产。</font><font style="vertical-align: inherit;">违反网络交互可能会对过程产生不利影响，直到过程完全停止。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有关漏洞和PoC的信息已转移到发布了更正的固件版本1.34的供应商，并且将标识符CVE-2018-10731分配给了漏洞本身。</font></font><br>
<br>
<blockquote><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">寻找一个人</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您希望这样做，我们只是在寻找我们团队中的专家。</font><font style="vertical-align: inherit;">我们从事过程控制系统（大型工业/能源/运输设施等）的安全性分析。</font><font style="vertical-align: inherit;">在每个项目中，我们都在寻找停止或破坏这些对象运行的方法。</font><font style="vertical-align: inherit;">每次我们找到许多影响制造过程的方法，探索工业硬件和软件，分析专有网络协议。</font><font style="vertical-align: inherit;">我们发现并报告了许多zirodey，编写了报告（不是根据GOST的报告），并且做得更多。</font><font style="vertical-align: inherit;">有时间时，我们不仅在会议上在IB上演讲。</font><font style="vertical-align: inherit;">链接到空缺：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hh.ru/vacancy/36371389</font></font></a></blockquote><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vyacheslav Moskvin </font><b><font style="vertical-align: inherit;">发布</font></b><font style="vertical-align: inherit;">，Positive Technologies</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN493932/index.html">Google调查概述。为什么它不适合进行认真的研究</a></li>
<li><a href="../zh-CN493934/index.html">谁，如何以及在什么上探索了世界海洋-我们分析了NOAA基地</a></li>
<li><a href="../zh-CN493938/index.html">如何在AWS中削减成本</a></li>
<li><a href="../zh-CN493940/index.html">天然冠状病毒2019-nCoV治疗方案</a></li>
<li><a href="../zh-CN493942/index.html">20分钟内即可感染基本病毒，或者为什么要使用防病毒软件</a></li>
<li><a href="../zh-CN493948/index.html">我是如何用即兴材料在家中制作KN95防毒面具的。详细说明</a></li>
<li><a href="../zh-CN493950/index.html">神经网络计算器，用于增加和减少不是很大的数字</a></li>
<li><a href="../zh-CN493952/index.html">如何评估智力？谷歌方法</a></li>
<li><a href="../zh-CN493954/index.html">PostgreSQL的 向大型表添加非空约束</a></li>
<li><a href="../zh-CN493960/index.html">在VMware Workstation中的Linux上配置XPrinter标签打印机</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>