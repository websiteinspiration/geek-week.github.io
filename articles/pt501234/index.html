<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë©‚Äçüëß‚Äçüë¶ üíáüèΩ üò° Roteamento r√°pido e NAT no Linux üç≠ üçé üë®‚Äçüëß‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como os endere√ßos IPv4 est√£o esgotados, muitos operadores de telecomunica√ß√µes enfrentam a necessidade de organizar o acesso de seus clientes √† rede us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Roteamento r√°pido e NAT no Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como os endere√ßos IPv4 est√£o esgotados, muitos operadores de telecomunica√ß√µes enfrentam a necessidade de organizar o acesso de seus clientes √† rede usando a convers√£o de endere√ßos. </font><font style="vertical-align: inherit;">Neste artigo, mostrarei como obter o desempenho no n√≠vel NAT de grau de operadora em servidores b√°sicos.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de hist√≥ria</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O t√≥pico de ficar sem espa√ßo de endere√ßo IPv4 n√£o √© mais novo. Em algum momento, as listas de espera apareceram no RIPE, depois houve trocas nas quais eles trocaram blocos de endere√ßos e conclu√≠ram transa√ß√µes pelo aluguel. Gradualmente, as operadoras de telecomunica√ß√µes come√ßaram a fornecer servi√ßos de acesso √† Internet atrav√©s da tradu√ß√£o de endere√ßos e portas. Algu√©m n√£o conseguiu obter endere√ßos suficientes para fornecer um endere√ßo "branco" a cada assinante, enquanto algu√©m come√ßou a economizar dinheiro, recusando-se a comprar endere√ßos no mercado secund√°rio. Os fabricantes de equipamentos de rede apoiaram essa ideia, pois essa funcionalidade geralmente requer m√≥dulos ou licen√ßas de expans√£o adicionais. Por exemplo, com o Juniper na linha de roteadores MX (exceto os mais recentes MX104 e MX204), o NAPT pode ser executado em um cart√£o de servi√ßo MS-MIC separado, o Cisco ASR1k requer uma licen√ßa GN,no Cisco ASR9k, um m√≥dulo A9K-ISM-100 separado e uma licen√ßa A9K-CGN-LIC para ele. Em geral, o prazer custa muito dinheiro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iptables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa de executar o NAT n√£o requer recursos de computa√ß√£o especializados; os processadores de uso geral instalados, por exemplo, em qualquer roteador dom√©stico, podem resolv√™-lo. </font><font style="vertical-align: inherit;">Em uma escala de operadora, esse problema pode ser resolvido usando servidores comuns executando o FreeBSD (ipfw / pf) ou GNU / Linux (iptables). </font><font style="vertical-align: inherit;">N√£o consideraremos o FreeBSD, porque </font><font style="vertical-align: inherit;">Recusei-me a usar este sistema operacional por um longo tempo, ent√£o vamos nos concentrar no GNU / Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ativar a tradu√ß√£o de endere√ßos n√£o √© nada dif√≠cil. </font><font style="vertical-align: inherit;">Primeiro voc√™ precisa escrever a regra em iptables na tabela nat:</font></font><br>
<br>
<pre><code class="bash hljs">iptables -t nat -A POSTROUTING -s 100.64.0.0/10 -j SNAT --to &lt;pool_start_addr&gt;-&lt;pool_end_addr&gt; --persistent
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sistema operacional carregar√° o m√≥dulo nf_conntrack, que monitorar√° todas as conex√µes ativas e executar√° as convers√µes necess√°rias. </font><font style="vertical-align: inherit;">Existem v√°rias sutilezas. </font><font style="vertical-align: inherit;">Em primeiro lugar, como estamos falando de NAT na escala da transportadora, √© necess√°rio aumentar o tempo limite, porque, com os valores padr√£o, o tamanho da tabela de convers√£o aumentar√° rapidamente para valores catastr√≥ficos. </font><font style="vertical-align: inherit;">Abaixo est√° um exemplo das configura√ß√µes que eu usei nos meus servidores:</font></font><br>
<br>
<pre><code class="bash hljs">net.ipv4.ip_forward = 1<font></font>
net.ipv4.ip_local_port_range = 8192 65535<font></font>
<font></font>
net.netfilter.nf_conntrack_generic_timeout = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_established = 600<font></font>
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 45<font></font>
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30<font></font>
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close = 10<font></font>
net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300<font></font>
net.netfilter.nf_conntrack_udp_timeout = 30<font></font>
net.netfilter.nf_conntrack_udp_timeout_stream = 60<font></font>
net.netfilter.nf_conntrack_icmpv6_timeout = 30<font></font>
net.netfilter.nf_conntrack_icmp_timeout = 30<font></font>
net.netfilter.nf_conntrack_events_retry_timeout = 15<font></font>
net.netfilter.nf_conntrack_checksum=0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E segundo, como o tamanho padr√£o da tabela de convers√£o n√£o foi projetado para funcionar nas condi√ß√µes de um operador de telecomunica√ß√µes, ele deve ser aumentado:</font></font><br>
<br>
<pre><code class="plaintext hljs">net.netfilter.nf_conntrack_max = 3145728
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Tamb√©m √© necess√°rio aumentar o n√∫mero de buckets para uma tabela de hash que armazena todas as tradu√ß√µes (esta √© uma op√ß√£o do m√≥dulo nf_conntrack): </font></font><br>
<br>
<pre><code class="plaintext hljs">options nf_conntrack hashsize=1572864
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s essas manipula√ß√µes simples, √© obtida uma constru√ß√£o completamente funcional, que pode converter um grande n√∫mero de endere√ßos de clientes em um pool externo. No entanto, o desempenho desta solu√ß√£o √© ruim. Nas minhas primeiras tentativas de usar o GNU / Linux para NAT (por volta de 2013), consegui obter um desempenho de cerca de 7Gbit / s a ‚Äã‚Äã0.8Mpps por servidor (Xeon E5-1650v2). Desde ent√£o, muitas otimiza√ß√µes diferentes foram feitas na pilha de rede do kernel GNU / Linux, o desempenho de um servidor no mesmo hardware aumentou quase para 18-19 Gbit / s a ‚Äã‚Äã1,8-1,9 Mpps (esses eram os valores limite), mas a necessidade de volume de tr√°fego, processado por um √∫nico servidor, cresceu muito mais r√°pido. Como resultado, foram desenvolvidos esquemas de balanceamento de carga para diferentes servidores, mas tudo isso aumentou a complexidade da instala√ß√£o,manuten√ß√£o e manuten√ß√£o da qualidade dos servi√ßos prestados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nftables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atualmente, o uso de DPDK e XDP √© uma dire√ß√£o moderna na ‚Äútransfer√™ncia de pacotes‚Äù de software. </font><font style="vertical-align: inherit;">Muitos artigos foram escritos sobre esse assunto, muitas apresenta√ß√µes diferentes foram feitas, produtos comerciais aparecem (por exemplo, SKAT da VasExperts). </font><font style="vertical-align: inherit;">Mas nas condi√ß√µes de recursos limitados de programadores de operadoras de telecomunica√ß√µes, √© bastante problem√°tico cortar algum tipo de "compartilhamento" com base nessas estruturas. </font><font style="vertical-align: inherit;">Operar essa solu√ß√£o no futuro ser√° muito mais dif√≠cil, em particular, ser√° necess√°rio desenvolver ferramentas de diagn√≥stico. </font><font style="vertical-align: inherit;">Por exemplo, um tcpdump normal com DPDK simplesmente n√£o funciona e n√£o "v√™" pacotes enviados de volta aos fios usando XDP. </font><font style="vertical-align: inherit;">Em meio a toda a conversa sobre novas tecnologias para enviar o encaminhamento de pacotes ao espa√ßo do usu√°rio, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">relat√≥rios</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">artigos</font></a><font style="vertical-align: inherit;"> passaram despercebidos</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pablo Neira Ayuso, mantenedor do iptables, sobre o desenvolvimento de descarga de fluxo em nftables. Vejamos esse mecanismo com mais detalhes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A id√©ia principal √© que, se o roteador passou pacotes de uma sess√£o nos dois lados do fluxo (a sess√£o TCP mudou para o estado ESTABLISHED), n√£o √© necess√°rio passar pacotes subseq√ºentes desta sess√£o por todas as regras de firewall, porque todas essas verifica√ß√µes ter√£o o mesmo fim transferindo o pacote para o roteamento. Sim, e na verdade a escolha da rota n√£o precisa ser executada - j√° sabemos qual interface e qual host deve encaminhar os pacotes dentro desta sess√£o. Resta apenas salvar essas informa√ß√µes e us√°-las no roteamento em um est√°gio inicial do processamento de pacotes. Ao executar o NAT, √© necess√°rio salvar adicionalmente informa√ß√µes sobre altera√ß√µes nos endere√ßos e portas convertidos pelo m√≥dulo nf_conntrack. Sim, √© claro, nesse caso, v√°rios polisadores e outras regras estat√≠sticas da informa√ß√£o no iptables param de funcionar,mas como parte da tarefa de um NAT permanente separado ou, por exemplo, de uma borda, isso n√£o √© t√£o importante, porque os servi√ßos s√£o distribu√≠dos pelos dispositivos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para usar esta fun√ß√£o, precisamos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use um kernel novo. </font><font style="vertical-align: inherit;">Apesar do fato de que a funcionalidade em si apareceu no kernel 4.16, por algum tempo ficou muito "crua" e regularmente chamada de p√¢nico do kernel. </font><font style="vertical-align: inherit;">Tudo se estabilizou em dezembro de 2019, quando os kernels LTS 4.19.90 e 5.4.5 foram lan√ßados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reescreva as regras do iptables no formato nftables usando uma vers√£o bastante recente do nftables. </font><font style="vertical-align: inherit;">Funciona bem na vers√£o 0.9.0</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se tudo estiver claro em princ√≠pio com o primeiro par√°grafo, o principal √© n√£o esquecer de incluir o m√≥dulo na configura√ß√£o durante a montagem (CONFIG_NFT_FLOW_OFFLOAD = m), ent√£o o segundo par√°grafo exige explica√ß√£o. </font><font style="vertical-align: inherit;">As regras do nftables s√£o descritas de maneira bem diferente da do iptables. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A documenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> revela quase todos os pontos; tamb√©m existem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conversores de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> regras </font><font style="vertical-align: inherit;">especiais </font><font style="vertical-align: inherit;">do iptables para o nftables. </font><font style="vertical-align: inherit;">Portanto, darei apenas um exemplo de configura√ß√£o de NAT e descarregamento de fluxo. </font><font style="vertical-align: inherit;">Uma pequena legenda para um exemplo: &lt;i_if&gt;, &lt;o_if&gt; s√£o as interfaces de rede pelas quais o tr√°fego passa; na realidade, pode haver mais de duas. </font><font style="vertical-align: inherit;">&lt;pool_addr_start&gt;, &lt;pool_addr_end&gt; - o endere√ßo inicial e final do intervalo de endere√ßos "brancos". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A configura√ß√£o do NAT √© muito simples:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table nat {<font></font>
        chain postrouting {<font></font>
                <span class="hljs-built_in">type</span> nat hook postrouting priority 100;<font></font>
                oif &lt;o_if&gt; snat to &lt;pool_addr_start&gt;-&lt;pool_addr_end&gt; persistent<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A descarga de fluxo √© um pouco mais complicada, mas compreens√≠vel:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table inet filter {<font></font>
        flowtable fastnat {<font></font>
                hook ingress priority 0<font></font>
                devices = { &lt;i_if&gt;, &lt;o_if&gt; }<font></font>
        }<font></font>
<font></font>
        chain forward {<font></font>
                <span class="hljs-built_in">type</span> filter hook forward priority 0; policy accept;<font></font>
                ip protocol { tcp , udp } flow offload @fastnat;<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa, de fato, √© toda a configura√ß√£o. </font><font style="vertical-align: inherit;">Agora todo o tr√°fego TCP / UDP ir√° para a tabela fastnat e ser√° processado muito mais rapidamente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resultados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para deixar claro o qu√£o "mais r√°pido" isso √©, anexarei uma captura de tela da carga em dois servidores reais, com o mesmo hardware (Xeon E5-1650v2), igualmente configurado, usando o mesmo kernel do Linux, mas executando o NAT no iptables (NAT4) e no nftables (NAT5). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y7/ov/c7/y7ovc7nkxxoply2apwjtur9tj-m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o h√° gr√°fico de pacotes por segundo na captura de tela, mas no perfil de carregamento desses servidores, o tamanho m√©dio dos pacotes √© de cerca de 800 bytes; portanto, os valores v√£o para 1,5Mpps. </font><font style="vertical-align: inherit;">Como voc√™ pode ver, a margem de desempenho do servidor com nftables √© enorme. </font><font style="vertical-align: inherit;">Atualmente, esse servidor processa at√© 30Gbit / s a ‚Äã‚Äã3Mpps e √© claramente capaz de executar as limita√ß√µes f√≠sicas da rede de 40Gbps, enquanto possui recursos livres de CPU. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que este material seja √∫til para os engenheiros de rede que tentam melhorar o desempenho de seus servidores.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt501220/index.html">An√°lise: uma empresa pode ter muito dinheiro?</a></li>
<li><a href="../pt501222/index.html">Aplica√ß√£o do COBIT ao desenvolver uma estrat√©gia de TI</a></li>
<li><a href="../pt501224/index.html">O que redes neurais podem "cantar" e executar death metal</a></li>
<li><a href="../pt501226/index.html">Pesquisa r√°pida de arquivos</a></li>
<li><a href="../pt501232/index.html">Como um especialista em TI pode ganhar mais com seu conhecimento</a></li>
<li><a href="../pt501236/index.html">Ent√£o, o que √© isso, ‚Äúdobrar prote√≠nas‚Äù?</a></li>
<li><a href="../pt501240/index.html">Auditoria de Seguran√ßa do Site</a></li>
<li><a href="../pt501246/index.html">Gr√°ficos Covid-19 corretos</a></li>
<li><a href="../pt501248/index.html">Hall da fama do local de trabalho JavaScript, parte 2</a></li>
<li><a href="../pt501250/index.html">Novamente sobre sensores BLE, temperatura e Xiaomi - parte 2 - MQTT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>