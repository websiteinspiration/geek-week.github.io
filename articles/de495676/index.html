<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüî¨ üç† üëù ETL-Prozess zum Abrufen von E-Mail-Daten in Apache Airflow üê® üë®üèø‚Äçüíª ‚õπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unabh√§ngig davon, wie viel Technologie sich entwickelt, erstreckt sich eine Reihe veralteter Ans√§tze immer √ºber die Entwicklung. Dies kann auf einen r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ETL-Prozess zum Abrufen von E-Mail-Daten in Apache Airflow</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495676/"><p><img src="https://habrastorage.org/webt/cx/yn/eu/cxyneu50gykw40yttazrj3zaacq.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unabh√§ngig davon, wie viel Technologie sich entwickelt, erstreckt sich eine Reihe veralteter Ans√§tze immer √ºber die Entwicklung. </font><font style="vertical-align: inherit;">Dies kann auf einen reibungslosen √úbergang, den menschlichen Faktor, technologische Bed√ºrfnisse oder etwas anderes zur√ºckzuf√ºhren sein. </font><font style="vertical-align: inherit;">Im Bereich der Datenverarbeitung sind Datenquellen in diesem Teil am wichtigsten. </font><font style="vertical-align: inherit;">Egal wie wir davon getr√§umt haben, dies loszuwerden, bis jetzt wurden einige der Daten in Instant Messenger und E-Mail gesendet, ganz zu schweigen von archaischeren Formaten. </font><font style="vertical-align: inherit;">Ich lade Sie ein, eine der Optionen f√ºr Apache Airflow zu k√ºrzen, die zeigt, wie Sie Daten aus E-Mails entnehmen k√∂nnen.</font></font></p><a name="habracut"></a><br>
<h2 id="predystoriya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrund</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Viele Daten werden immer noch per E-Mail √ºbertragen, angefangen bei der zwischenmenschlichen Kommunikation bis hin zu den Standards der Interaktion zwischen Unternehmen. Es ist gut, wenn Sie eine Schnittstelle schreiben k√∂nnen, um die Daten abzurufen, oder Personen ins B√ºro bringen, die diese Informationen an bequemere Quellen weitergeben. Oft besteht eine solche M√∂glichkeit jedoch einfach nicht. Die spezielle Aufgabe bestand darin, das bekannte CRM-System mit dem Data Warehouse und anschlie√üend mit dem OLAP-System zu verbinden. Historisch gesehen war die Verwendung dieses Systems f√ºr unser Unternehmen in einem einzigen Gesch√§ftsbereich praktisch. Daher wollte wirklich jeder in der Lage sein, auch Daten von diesem Drittanbieter-System zu verarbeiten. Zun√§chst wurde nat√ºrlich die M√∂glichkeit untersucht, Daten von einer offenen API abzurufen. Leider,Die API deckte nicht den Empfang aller erforderlichen Daten ab und war in einfachen Worten etwas schief, und der technische Support wollte oder konnte sich nicht treffen, um umfassendere Funktionen bereitzustellen. Dieses System bot jedoch die M√∂glichkeit, die fehlenden Daten regelm√§√üig per E-Mail in Form eines Links zum Entladen des Archivs zu empfangen.</font></font></p><br>
<p> ,      ,           . ,          ,       .</p><br>
<h2 id="apache-airflow">Apache Airflow</h2><br>
<p>  ETL      Apache Airflow.    ,    ,  ,        ,   . </p><br>
<p>Apache Airflow ‚Äî  ,    ,    ETL (Extract-Transform-Loading)    Python.    Airflow    ,    ‚Äî  ,    ‚Äî    .      Python ,              .         ,      .    :</p><br>
<ul>
<li> ‚Äî        ,       ;</li>
<li> ‚Äî             ;</li>
<li> ‚Äî    , ,       (  );</li>
<li> ..</li>
</ul><br>
<p> Apache Airflow      .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.</p><br>
<h2 id="huk-dlya-polucheniya-dannyh">   </h2><br>
<p>  ,      ,      : </p><br>
<ul>
<li>   ;</li>
<li>  ;</li>
<li>   .</li>
</ul><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> airflow.hooks.base_hook <span class="hljs-keyword">import</span> BaseHook
<span class="hljs-keyword">import</span> imaplib
<span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IMAPHook</span>(<span class="hljs-params">BaseHook</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, imap_conn_id</span>):</span>
        <span class="hljs-string">"""
           IMAP hook      

           :param imap_conn_id:          
           :type imap_conn_id:        string
        """</span><font></font>
        self.connection = self.get_connection(imap_conn_id)<font></font>
        self.mail = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authenticate</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">""" 
              
        """</span><font></font>
        mail = imaplib.IMAP4_SSL(self.connection.host)<font></font>
        response, detail = mail.login(user=self.connection.login, password=self.connection.password)<font></font>
        <span class="hljs-keyword">if</span> response != <span class="hljs-string">"OK"</span>:
            <span class="hljs-keyword">raise</span> AirflowException(<span class="hljs-string">"Sign in failed"</span>)
        <span class="hljs-keyword">else</span>:<font></font>
            self.mail = mail<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_last_mail</span>(<span class="hljs-params">self, check_seen=True, box=<span class="hljs-string">"INBOX"</span>, condition=<span class="hljs-string">"(UNSEEN)"</span></span>):</span>
        <span class="hljs-string">"""
                 , 
              

            :param check_seen:          
            :type check_seen:       bool
            :param box:              
            :type box:              string
            :param condition:         
            :type condition:        string
        """</span><font></font>
        self.authenticate()<font></font>
        self.mail.select(mailbox=box)<font></font>
        response, data = self.mail.search(<span class="hljs-literal">None</span>, condition)<font></font>
        mail_ids = data[<span class="hljs-number">0</span>].split()<font></font>
        logging.info(<span class="hljs-string">"    : "</span> + str(mail_ids))<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mail_ids:<font></font>
            logging.info(<span class="hljs-string">"   "</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><font></font>
<font></font>
        mail_id = mail_ids[<span class="hljs-number">0</span>]<font></font>
<font></font>
        <span class="hljs-comment">#    </span>
        <span class="hljs-keyword">if</span> len(mail_ids) &gt; <span class="hljs-number">1</span>:
            <span class="hljs-comment">#   </span>
            <span class="hljs-keyword">for</span> id <span class="hljs-keyword">in</span> mail_ids:<font></font>
                self.mail.store(id, <span class="hljs-string">"+FLAGS"</span>, <span class="hljs-string">"\\Seen"</span>)<font></font>
<font></font>
            <span class="hljs-comment">#  </span>
            mail_id = mail_ids[<span class="hljs-number">-1</span>]<font></font>
<font></font>
        <span class="hljs-comment">#     </span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> check_seen:<font></font>
            self.mail.store(mail_id, <span class="hljs-string">"-FLAGS"</span>, <span class="hljs-string">"\\Seen"</span>)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> mail_id</code></pre><br>
<p> : ,     ,    ‚Äî  .    ,         .    ,         ,   ‚Äî   .  ,      .</p><br>
<p>     :           .  ,     ,       .     ,  ,   :      ,      ,     ,      ..   ,       ,            .</p><br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download_from_url</span>(<span class="hljs-params">self, url, path, chunk_size=<span class="hljs-number">128</span></span>):</span>
        <span class="hljs-string">"""
               

            :param url:               
            :type url:               string
            :param path:               
            :type path:              string
            :param chunk_size:          
            :type chunk_size:        int
        """</span>
        r = requests.get(url, stream=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">with</span> open(path, <span class="hljs-string">"wb"</span>) <span class="hljs-keyword">as</span> fd:
            <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> r.iter_content(chunk_size=chunk_size):<font></font>
                fd.write(chunk)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download_mail_href_attachment</span>(<span class="hljs-params">self, mail_id, path</span>):</span>
        <span class="hljs-string">"""
                   

            :param mail_id:          
            :type mail_id:          string
            :param path:              
            :type path:             string
        """</span>
        response, data = self.mail.fetch(mail_id, <span class="hljs-string">"(RFC822)"</span>)<font></font>
        raw_email = data[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]<font></font>
        raw_soup = raw_email.decode().replace(<span class="hljs-string">"\r"</span>, <span class="hljs-string">""</span>).replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">""</span>)<font></font>
        parse_soup = BeautifulSoup(raw_soup, <span class="hljs-string">"html.parser"</span>)<font></font>
        link_text = <span class="hljs-string">""</span><font></font>
<font></font>
        <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> parse_soup.find_all(<span class="hljs-string">"a"</span>, href=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>):<font></font>
            link_text = a[<span class="hljs-string">"href"</span>]<font></font>
<font></font>
        self.download_from_url(link_text, path)</code></pre><br>
<p> ,       .      imap_conn_id. Apache Airflow    (, ,    ),       .      </p><br>
<p><img src="https://habrastorage.org/webt/3q/ud/9v/3qud9viwwaxbsfl22bn75gllfp8.png"></p><br>
<h3 id="sensor-dlya-ozhidaniya-dannyh">   </h3><br>
<p>         ,       .   ,    ,   ,     ,            ,   ,       (API, ,    ..).  .  CRM    ,        UUID.       SIP-   ,    UUID,        .         , ,     . , ,     ,     .        .</p><br>
<p> ,       ,      ,      .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> airflow.sensors.base_sensor_operator <span class="hljs-keyword">import</span> BaseSensorOperator
<span class="hljs-keyword">from</span> airflow.utils.decorators <span class="hljs-keyword">import</span> apply_defaults
<span class="hljs-keyword">from</span> my_plugin.hooks.imap_hook <span class="hljs-keyword">import</span> IMAPHook<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MailSensor</span>(<span class="hljs-params">BaseSensorOperator</span>):</span>
<span class="hljs-meta">    @apply_defaults</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, conn_id, check_seen=True, box=<span class="hljs-string">"Inbox"</span>, condition=<span class="hljs-string">"(UNSEEN)"</span>, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.conn_id = conn_id<font></font>
        self.check_seen = check_seen<font></font>
        self.box = box<font></font>
        self.condition = condition<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">poke</span>(<span class="hljs-params">self, context</span>):</span><font></font>
        conn = IMAPHook(self.conn_id)<font></font>
        mail_id = conn.get_last_mail(check_seen=self.check_seen, box=self.box, condition=self.condition)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> mail_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span></code></pre><br>
<h3 id="poluchaem-i-ispolzuem-dannye">   </h3><br>
<p>        ,   .     ‚Äî    ,      PythonOperator</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> airflow.models <span class="hljs-keyword">import</span> DAG<font></font>
<font></font>
<span class="hljs-keyword">from</span> airflow.operators.python_operator <span class="hljs-keyword">import</span> PythonOperator
<span class="hljs-keyword">from</span> airflow.sensors.my_plugin <span class="hljs-keyword">import</span> MailSensor
<span class="hljs-keyword">from</span> my_plugin.hooks.imap_hook <span class="hljs-keyword">import</span> IMAPHook<font></font>
<font></font>
start_date = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>)<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
args = {<font></font>
    <span class="hljs-string">"owner"</span>: <span class="hljs-string">"example"</span>,
    <span class="hljs-string">"start_date"</span>: start_date,
    <span class="hljs-string">"email"</span>: [<span class="hljs-string">"home@home.ru"</span>],
    <span class="hljs-string">"email_on_failure"</span>: <span class="hljs-literal">False</span>,
    <span class="hljs-string">"email_on_retry"</span>: <span class="hljs-literal">False</span>,
    <span class="hljs-string">"retry_delay"</span>: timedelta(minutes=<span class="hljs-number">15</span>),
    <span class="hljs-string">"provide_context"</span>: <span class="hljs-literal">False</span>,<font></font>
}<font></font>
<font></font>
dag = DAG(<font></font>
    dag_id=<span class="hljs-string">"test_etl"</span>,<font></font>
    default_args=args,<font></font>
    schedule_interval=<span class="hljs-string">"@hourly"</span>,<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
mail_check_sensor = MailSensor(<font></font>
    task_id=<span class="hljs-string">"check_new_emails"</span>,<font></font>
    poke_interval=<span class="hljs-number">10</span>,<font></font>
    conn_id=<span class="hljs-string">"mail_conn_id"</span>,<font></font>
    timeout=<span class="hljs-number">10</span>,<font></font>
    soft_fail=<span class="hljs-literal">True</span>,<font></font>
    box=<span class="hljs-string">"my_box"</span>,<font></font>
    dag=dag,<font></font>
    mode=<span class="hljs-string">"poke"</span>,<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_mail</span>():</span>
    imap_hook = IMAPHook(<span class="hljs-string">"mail_conn_id"</span>)<font></font>
    mail_id = imap_hook.get_last_mail(check_seen=<span class="hljs-literal">True</span>, box=<span class="hljs-string">"my_box"</span>)
    <span class="hljs-keyword">if</span> mail_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">raise</span> AirflowException(<span class="hljs-string">"Empty mailbox"</span>)<font></font>
<font></font>
    conn.download_mail_href_attachment(mail_id, <span class="hljs-string">"./path.zip"</span>)<font></font>
<font></font>
prepare_mail_data = PythonOperator(task_id=<span class="hljs-string">"prepare_mail_data"</span>, default_args=args, dag=dag, python_callable= prepare_mail)<font></font>
<font></font>
<span class="hljs-comment">#    </span><font></font>
...<font></font>
<font></font>
<span class="hljs-comment">#    </span><font></font>
mail_check_sensor &gt;&gt; prepare_mail_data<font></font>
prepare_data &gt;&gt; ...<font></font>
<span class="hljs-comment">#    </span></code></pre><br>
<p>,       mail.ru,        ,   ..     2016  , , , .    ,          -     .  ,                (UNSEEN). </p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusammenfassend haben wir die folgende Reihenfolge: Wir pr√ºfen, ob es neue Buchstaben gibt, die die Bedingungen erf√ºllen, falls vorhanden, und laden dann das Archiv √ºber den Link aus dem letzten Buchstaben herunter. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter den letzten Punkten wird weggelassen, dass dieses Archiv entpackt wird, die Daten aus dem Archiv bereinigt und verarbeitet werden und infolgedessen das Ganze weiter in die ETL-Pipeline des Prozesses geht, aber dies geht bereits √ºber den Rahmen des Artikels hinaus. </font><font style="vertical-align: inherit;">Wenn es sich als interessant und n√ºtzlich herausstellte, werde ich gerne weiterhin ETL-L√∂sungen und deren Teile f√ºr Apache Airflow beschreiben.</font></font><br>
</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de495644/index.html">TS Total Sight. Tool zur Ereigniserfassung, Vorfallanalyse und Automatisierung von Bedrohungsreaktionen</a></li>
<li><a href="../de495646/index.html">Was f√ºr stressfreie Podcasts am Wochenende zu h√∂ren sind</a></li>
<li><a href="../de495658/index.html">Wo Sie Audio f√ºr maschinelles Lernen erhalten: Eine Auswahl offener Bibliotheken, die unter Creative Commons lizenziert sind</a></li>
<li><a href="../de495670/index.html">Migration von einem nahtlosen Data Lake zu einem verteilten Data Mesh</a></li>
<li><a href="../de495674/index.html">Erkundung elektromagnetischer Felder mit einem SDR-Empf√§nger und OpenCV</a></li>
<li><a href="../de495678/index.html">Wettbewerb VK Sup. Track ML. 4. Platz. Wie?</a></li>
<li><a href="../de495682/index.html">API Reverse f√ºr seine Android-Anwendung</a></li>
<li><a href="../de495684/index.html">5 Gr√ºnde, warum die Interaktion mit Ihren Endbenutzern Ihren Code verbessert</a></li>
<li><a href="../de495686/index.html">Pers√∂nliches Las Vegas oder ein Spiel in der Browser-Erweiterung</a></li>
<li><a href="../de495688/index.html">Active Directory-basierte OSE-Benutzersynchronisierung f√ºr Zimbra Collaboration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>