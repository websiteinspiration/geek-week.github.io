<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòâ üë©üèæ‚Äçüöí üåì Mobile application reference service ‚õ∫Ô∏è üíÆ üõÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ruslan Aromatov, chief developer, ICD
 
 
 
 Good afternoon, Khabrovites! I work as a backend developer at Moscow Credit Bank, and this time I would l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mobile application reference service</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mkb/blog/495694/"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ruslan Aromatov, chief developer, ICD</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/5t/g1/ym/5tg1ymifdzcvcag27twgbiwwu9c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Good afternoon, Khabrovites! </font><font style="vertical-align: inherit;">I work as a backend developer at Moscow Credit Bank, and this time I would like to talk about how we organized the delivery of runtime content to our MKB Online mobile application. </font><font style="vertical-align: inherit;">This article can be useful to those who are engaged in the design and development of front-servers for mobile applications, in which it is necessary to constantly deliver a variety of updates, whether bank documents, geolocation points, updated icons, etc. without updating the application itself in stores. </font><font style="vertical-align: inherit;">Those who develop mobile applications, it will not hurt either. </font><font style="vertical-align: inherit;">The article does not contain code examples, only some discussion on the topic.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think that any developer of mobile applications has encountered the problem of updating some part of the content of their application. For example, change the user agreement clause, the icon or the coordinates of the store of a customer who has suddenly moved. It seems that it could be easier? We rebuild the application and put it in the store. Customers are updated, everyone is happy. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But this simple scheme does not work for one simple reason - not all clients are updated. And judging by the statistics, there are a lot of such clients.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of a banking application, failure to deliver relevant information can cost both money and customer dissatisfaction. For example, on the first day of the next month, card tariffs are changed, new bonus program rules are included, or new types of payment recipients are added. And if the client launches the application at exactly 0 hours 01 minutes, then he should see the updated content. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúElementary!‚Äù - you say. - "Download this data from the server and you will be happy."</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
And you will be right. We do so. </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's it, we disagree</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, not all so simple. We have applications for both iOS and android. Each platform has several different versions that have different functionality and api.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, it may happen that we need to update the file for an android application with api version higher than 27, but not touch iOS and earlier versions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out even more interesting when, for example, we need to update the icons of payment recipients or add new items with new icons. We draw each instance of the icon in seven different resolutions for each specific type of screen: for android we have 4 of them (hdpi, xhdpi, xxhdpi, xxxhdpi) and 3 for iOS (1x, 2x, 3x). Which one should I send to a specific application? </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Well then send the file parameters that are needed by a particular application."</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correctly! Nobody knows about which file the application needs, except for the application.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, this is not all. In applications, there are quite a few files that are interconnected. For example, payee lists (one json file) are associated with details of payees (another json file). And if we receive the first file and for some reason cannot receive the second, then the customers will not be able to pay for the service. And this is not very good, frankly.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second case: we update the entire set of icons of payment recipients (and there are more than a hundred of them) when entering the payment page. Depending on the speed of the Internet, it can take from 10 seconds to several minutes. What should be the correct page behavior? For example, you can simply display the previous version of the icons, and download new ones in the background, then cache and only show new ones the next time the client visits the page. Somehow not really, right? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another option is to dynamically replace already downloaded icons with new ones. Not too pretty, right? And if some icon does not download at all? Then we will see a beautiful series of new icons with a piece of the old design in the middle.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/js/xh/ml/jsxhmlu5zzyaecxj2cflqquao_m.png" alt="Operation icons"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Then download the entire set of icons in one archive at application startup."</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nice thought. No really. But there is a nuance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It often happens that a designer redraws only a couple of hundreds of icons, and you only need to replace them. They weigh 200 bytes, and the entire archive we have 200 kilobytes. Is it that the client will have to re-pump what he already has? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we have not yet calculated the cost of such work on the server. Let's say 10,000 clients per hour come to us (this is the average value, it happens more). Application start initiates background updating of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">directories</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(yes, you now know what we call it). </font><font style="vertical-align: inherit;">If one client needs to update 1 kilobyte, then in an hour the server will give more than 10 megabytes. </font><font style="vertical-align: inherit;">Pennies, right? </font><font style="vertical-align: inherit;">And if the set of updates weighs 1 megabyte? </font><font style="vertical-align: inherit;">in this case, we will have to give already 10 gigabytes. </font><font style="vertical-align: inherit;">At some point, we come to the conclusion that traffic should be considered. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then you need to learn to understand which files have changed and which are not, and download only the necessary ones. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Right. </font><font style="vertical-align: inherit;">But how to understand which files have changed and which have not? </font><font style="vertical-align: inherit;">We consider a hash for this. </font><font style="vertical-align: inherit;">Thus, a certain file cache appears in the application, which contains a set of reference files. </font><font style="vertical-align: inherit;">These files are used as resources as needed. </font><font style="vertical-align: inherit;">And on the server side, we were eventually born ...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Directory Service</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, this is a regular web service that sends files via http taking into account all the requirements of the application. It consists of a number of docker containers, inside which a java application works with the jetty web server on board. The backend is the Tarantool database on the vinyl engine (there wasn‚Äôt any painful choice - there was just the whole binding for this database; you can read about this in my previous article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Smart cache service based on ZeroMQ and Tarantool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) with master-slave replication. To manage files there is a service web interface, also completely self-written.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ou/si/-4/ousi-4e4g3npwjc8qv-i-_kut34.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The technical implementation details in the topic of this article are not particularly significant. </font><font style="vertical-align: inherit;">It could be php + apache + mysql, C # + IIS + MSSQL, or any other bundle, including without a database at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The diagram below shows how the service we called Woodside works. </font><font style="vertical-align: inherit;">Mobile clients through the balancer go to instances of web services, and those, in turn, get the necessary files from the database.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hq/tj/dk/hqtjdkoi5irwtcpgsbyuhh3tlz0.png" alt="Scheme of work"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But in this article I will only talk about the structure of the reference system, and how we use them in applications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Files necessary in applications, we divide into 3 different types.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Files that must always be in the application, and independent of the type of operating system. </font><font style="vertical-align: inherit;">For example, this is a pdf file with a banking service agreement.</font></font></li>
<li>-,    ,         ( ) . ,   .</li>
<li>,          ,     .    - ,           ,        .               ,    .</li>
</ol><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3g/h6/8r/3gh68rnwu2sqbc2n5xvvnruyqiu.png" alt="Affiliate program"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first 2 types of files in the form of archives are immediately put into the application assembly - a fresh release by default includes the newest set of directories. They fall into the automatic update system, which runs in the background when the application starts, and works as follows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. The directory service automatically receives part of the data from various places: databases, related services, network balls - this is some important general banking information that is updated by other departments. The other part is directories created within our team via the web interface and containing files intended only for mobile applications.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. According to the schedule (or by the button), the service runs through all the files of all directories, and on their basis forms a set of index files (inside json) both for files of the first type (2 versions for iOS and android), and for resource files of the second type (7 versions for each type of screen). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks something like this:</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"43"</span>,
  <span class="hljs-attr">"date"</span>: <span class="hljs-string">"04 Apr 2020 12:31:59"</span>,
  <span class="hljs-attr">"os"</span>: <span class="hljs-string">"android"</span>,
  <span class="hljs-attr">"screen"</span>: <span class="hljs-string">"any"</span>,
  <span class="hljs-attr">"hashType"</span>: <span class="hljs-string">"md5"</span>,
  <span class="hljs-attr">"ts"</span>: <span class="hljs-number">1585992719</span>,
  <span class="hljs-attr">"files"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"id"</span>: <span class="hljs-string">"WBRbDUlWhhhj"</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"action-in-rhythm-of-life.json"</span>,
      <span class="hljs-attr">"dir"</span>: <span class="hljs-string">"actions"</span>,
      <span class="hljs-attr">"ts"</span>: <span class="hljs-number">1544607853</span>,
      <span class="hljs-attr">"hash"</span>: <span class="hljs-string">"68c589c4fa8a44ded4d897c3d8b24e5c"</span><font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"id"</span>: <span class="hljs-string">"o3K4mmPOOnxu"</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"banks.json"</span>,
      <span class="hljs-attr">"dir"</span>: <span class="hljs-string">"banks"</span>,
      <span class="hljs-attr">"ts"</span>: <span class="hljs-number">1583524710</span>,
      <span class="hljs-attr">"hash"</span>: <span class="hljs-string">"c136d7be420b31f65627f4200c646e0b"</span><font></font>
    }<font></font>
  ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The indexes contain information on all files of a given type, on the basis of which the mechanism for updating directories on applications is built. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Applications at startup, the first thing they download is index files in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ new</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">inside their file cache. And in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ current</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">they have indexes for the current set of files along with the files themselves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Based on the new and old index files (with the participation of all current files from which the hash is considered), lists of files are created that need to be updated or deleted, and the need for updating is generally established. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. After that, to the </font><b><font style="vertical-align: inherit;">/ new</font></b><font style="vertical-align: inherit;"> directory</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applications download the necessary files from the server via a direct link (the file id in the index is responsible for this). In this case, the presence and hashes of files already in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ new</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory are taken into account </font><font style="vertical-align: inherit;">, because this can be a resume. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. As soon as the entire set of files is received in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ new</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">, they are checked against the index file (sometimes it happened that the files were not completely downloaded). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. If the check was successful, the entire file tree is moved with the replacement in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ current</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">. Fresh index file becomes current.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8. If the verification is unsuccessful, file transfers will not occur, and the application will continue to use the current set of directories. The next time the application starts, the update mechanism will try to fix it. If we have a global crash when moving files, then we are forced to roll back to the very first version of the directories that came with the assembly. So far there have been no precedents. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But why is it so difficult?</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In reality, not very difficult. But the fact is that we constantly have to experiment and find compromises between the number of constantly updated files and load times, between saving traffic and speed. An important role in choosing a file type is played when exactly it is needed in the application. Suppose, if the icon should be displayed immediately on the main page after the login, then the application can load such a file in runtime immediately, and not put it in a long update mechanism. Now the total size of the archive with only the main files is 12 megabytes, not including screen-dependent resources. And since the update is essentially an atomic operation, we must wait until it is over. This can take up to several minutes in cases where the connection is poor and there are many new files.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An important point is saving traffic. </font><font style="vertical-align: inherit;">There were times when we completely utilized a 100 megabit channel after thick updates. </font><font style="vertical-align: inherit;">I had to expand to 300. So far, enough. </font><font style="vertical-align: inherit;">On average, metrics show that usually clients download from 25 to 50 gigabytes per hour during the day (this is because we have quite large files that are updated daily). </font><font style="vertical-align: inherit;">There is still room for further development in terms of economy, but business is also on the alert - all the time they are adding a variety of new beauties. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In conclusion, I can add that the front servers themselves also use the service, which at startup download the data necessary for processing client requests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And how do you deliver content updates to applications?</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495684/index.html">5 reasons why interacting with your end users improves your code</a></li>
<li><a href="../en495686/index.html">Personal Las Vegas, or a game in the browser extension</a></li>
<li><a href="../en495688/index.html">Active Directory Based Zimbra Collaboration OSE User Synchronization</a></li>
<li><a href="../en495690/index.html">Web Audio API Concepts</a></li>
<li><a href="../en495692/index.html">DIY and Open Source to help doctors</a></li>
<li><a href="../en495696/index.html">How Prince of Persia Creator Overcomes Apple II's Memory Limits</a></li>
<li><a href="../en495698/index.html">Client-server architecture in pictures</a></li>
<li><a href="../en495700/index.html">Doom Boy ESP32</a></li>
<li><a href="../en495702/index.html">We study the Mediastreamer2 VoIP engine. Part 1</a></li>
<li><a href="../en495704/index.html">Monitoring network equipment over SNMPv3 in Zabbix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>