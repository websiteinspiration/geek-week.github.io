<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äç‚öïÔ∏è üë®üèø‚Äçüåæ ü¶ä Desarrollo de firmware para una videoc√°mara anal√≥gica EVR-Y2022F ‚öìÔ∏è üòÄ üë∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En un art√≠culo anterior, se examin√≥ el dispositivo de una c√°mara de video anal√≥gica con gran detalle para crear su propio firmware. Como ya se mencion...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Desarrollo de firmware para una videoc√°mara anal√≥gica EVR-Y2022F</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499546/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En un art√≠culo anterior, se examin√≥ el dispositivo de una c√°mara de video anal√≥gica con gran detalle para crear su propio firmware. Como ya se mencion√≥, la c√°mara tiene un microcontrolador de origen desconocido. Es mucho m√°s rico que los AVR habituales: tiene dos voltajes de suministro de 3.3V y 1.8V, y adem√°s, tiene una funci√≥n DSP. Llegu√© a esta conclusi√≥n cuando pens√© en la implementaci√≥n del algoritmo de enfoque autom√°tico. Sin embargo, no prefer√≠ MK complejos como STM32 y otros, solo porque nunca trabaj√© con ellos. Definitivamente tom√© la decisi√≥n de usar uno de los AVR MK para implementar mi firmware. Por lo tanto, ya en esta etapa comenc√© a darme cuenta de que la implementaci√≥n de la funci√≥n de enfoque autom√°tico no ser√° muy f√°cil de manejar, o m√°s bien, imposible.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mi elecci√≥n recay√≥ en el ATmega128 MK, ya que fue √©l quien cay√≥ en mi brazo. El ATmega8 MK obviamente no ser√° suficiente en t√©rminos de la cantidad de conclusiones, especialmente porque, por si acaso, decid√≠ reservar un puerto MK completo para la entrada del flujo de video digital desde el procesador de video. En primer lugar, descubr√≠ qu√© funciones estar√°n en mi propio firmware, en particular, las funciones que no estaban en el firmware original, y qu√© funciones tendr√°n que ser descuidadas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consideremos una variante del algoritmo de enfoque autom√°tico para analizar una transmisi√≥n de video digital. Me las arregl√© para descubrir que los datos del flujo de video son una alternancia de bytes sincronizados con los pulsos "CK". Los bytes del flujo de video codifican los niveles de los componentes Y, Cr, Cb de la se√±al de video con gradaci√≥n de 8 bits (256 niveles). Es decir, la salida de video digital del procesador de video de esta c√°mara est√° multiplexada por componentes. La informaci√≥n sobre el brillo (Y) est√° contenida en cada segundo byte de la transmisi√≥n de video, y la informaci√≥n sobre el color es dos veces menos frecuente. Es decir, la informaci√≥n sobre la se√±al de diferencia de color del Cr rojo est√° contenida en cada cuarto byte, as√≠ como la informaci√≥n sobre la se√±al de diferencia de color del azul. Por lo tanto, el flujo representa la siguiente secuencia: Cb0, Y0, Cr0, Y1, Cb2, Y2, Cr2, Y3, Cb4, Y4, Cr4, Y5, ... Es decir,Mientras que la informaci√≥n sobre el brillo de cada p√≠xel viene sin espacios, la informaci√≥n sobre el color de los p√≠xeles viene en secuencia en componentes. Este adelgazamiento se debe a las propiedades de insensibilidad al color de los peque√±os detalles y a una reducci√≥n en la banda de color en la se√±al de video. Estas propiedades se utilizan en televisi√≥n anal√≥gica y digitalizaci√≥n de video. La "compresi√≥n" anterior (submuestreo de color) tiene una relaci√≥n de componentes de 4: 2: 2.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que funcione el algoritmo de enfoque autom√°tico, es suficiente analizar solo el componente de brillo, que tambi√©n es f√°cil de lograr interceptando el flujo de video "byte por byte". Si la frecuencia CK es de aproximadamente 18 MHz, entonces CK / 2 es de 9 MHz, lo que parece ser bastante alcanzable para el ATmega128 MK. Los pulsos de sincronizaci√≥n horizontal y vertical permiten al controlador "contar" y analizar cualquier √°rea de la imagen. Quiz√°s, para el algoritmo de enfoque autom√°tico, es suficiente analizar solo el centro del r√°ster. Obviamente, cuanto mejor sea el enfoque, m√°s n√≠tida ser√° la imagen y, por lo tanto, m√°s amplia ser√° la banda de frecuencia de la se√±al de video (m√°s componentes de RF). Es decir, es posible (incluso necesario) aplicar el algoritmo de Transformaci√≥n r√°pida de Fourier (FFT) a fragmentos de un flujo de video digital y analizar los componentes de RF. En este caso, debe girar el foco de enfoque cada vez,utilizando el m√©todo de "media divisi√≥n" como m√©todo de optimizaci√≥n matem√°tica. Por lo tanto, puede lograr el mejor resultado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No me molest√© con la funci√≥n de enfoque autom√°tico, considerando que era imposible en MK con una arquitectura simple, aunque, en cualquier caso, reserv√© un puerto para video digital. En lugar de enfoque autom√°tico, decid√≠ implementar una serie de otras funciones que no estaban disponibles en el firmware original. Pero para esto, la c√°mara de video tendr√° que limitarse a condiciones estacionarias, lo cual es t√≠pico para la video vigilancia. Se supone que la c√°mara podr√° girar posteriormente en el plano horizontal y vertical utilizando mecanismos especiales, tanto autom√°tica como manualmente. Cuando la c√°mara apunta autom√°ticamente a un objeto espec√≠fico, cuyas coordenadas esf√©ricas se almacenar√°n previamente en la memoria del dispositivo de control, las "coordenadas" del zoom y el enfoque tambi√©n cambiar√°n, que tambi√©n se preseleccionar√°n y almacenar√°n en la memoria.La gesti√≥n se puede organizar de acuerdo con el protocolo PELCO-D, adem√°s, en la especificaci√≥n de este protocolo hay un equipo especial para este negocio. Las coordenadas del zoom y el enfoque, por supuesto, se "emparejar√°n" para una distancia espec√≠fica. Es decir, un objeto que se ubicar√° a una distancia dada estar√° enfocado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de comenzar a escribir un programa de firmware, debe pensar qu√© perif√©ricos de MK y qu√© conclusiones estar√°n involucradas. Luego, debe pensar en c√≥mo colocar y arreglar la placa con su propio MK dentro de la c√°mara. Y para que fuera lo m√°s conveniente y f√°cil de mantener posible. Decid√≠ usar una placa con MK, cuyas conclusiones se enrutar√°n completamente hacia el lado izquierdo y derecho. La placa se ubicar√° en la parte inferior de la c√°mara, donde hay poco espacio, y se mantendr√° en una conexi√≥n desmontable. Al mismo tiempo, habr√° "pines" del conector en la placa, y habr√° enchufes de acoplamiento en los lados de la c√°mara. Para las tomas de respuesta, decid√≠ hacer dos placas adaptadoras m√°s, del tama√±o del lado de la c√°mara. Las l√°minas de estas tarjetas van al lado superior de la c√°mara, directamente a la placa principal. Se supone que cada l√°mina se conectar√° al punto deseado en el tablero principal de la c√°mara.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante el desarrollo de la placa con MK, tuve la idea de complementar la videoc√°mara con un reloj (RTC), y destaqu√© la l√≠nea I2C, colocada en la placa RTC DS1307 (ya s√© qu√© demonios) con cuarzo y una bater√≠a y, por si acaso, EEPROM 24AA512, que eran manualmente. Tambi√©n en la placa en el borde superior hay conectores para conectar programadores SPI y JTAG. En la placa base original, MK tiene una frecuencia de cuarzo de 12 MHz. Es lo mismo para mi. En general, es mejor poner cuarzo a 11.0592 MHz para una operaci√≥n clara de UART. Las distancias entre los "peines" de las articulaciones desmontables las calcul√© cuidadosamente de antemano. Decid√≠ alimentar a MK con el "Krenka" de cinco voltios, que se atornillar√° al marco debajo de la placa principal (tambi√©n servir√° como disipador de calor). La energ√≠a se tomar√° del voltaje de entrada de 12V inmediatamente despu√©s del fusible FB801, como se muestra en la figura.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pk/rs/q8/pkrsq8mtjjredo8w2mfne5goziy.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 1. Gesti√≥n de energ√≠a del microcontrolador.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mientras dibujaba tableros en "SprintLayout", me preguntaba el prop√≥sito de cada pin del MK, que sale "al conector". El resultado es una imagen as√≠. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bm/95/xg/bm95xgf-akgycofwc_mdsjp8rki.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 2. Bocetos de placas de circuito impreso adicionales.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Para decirte la verdad, dibuj√© las tablas laterales (a lo largo de los bordes) en la etapa de escribir este art√≠culo. Pero, de hecho, los hice con un cortador. Result√≥ no ser la opci√≥n m√°s exitosa. Y el tablero en s√≠ con MK se hizo torcidamente. De alguna manera atornill√© las placas auxiliares laterales a los lados del marco de la c√°mara, soldando tuercas fundentes a la superficie de cobre de la PCB. El hecho es que hay muy poco espacio en los costados, y la tapa de la c√°mara est√° pr√°cticamente "apretada" de forma consecutiva. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las siguientes figuras muestran la distribuci√≥n de las conclusiones de la MK, as√≠ como su prop√≥sito.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cc/ry/d2/ccryd2b_viknimo-w0asy0j8fuy.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 3. El prop√≥sito de las conclusiones del microcontrolador.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hay muchos puntos para comentar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el programador SPI (STK200 +), la salida "PEN" era innecesaria. La activaci√≥n se realiza mediante "RESET", como de costumbre. Pero en lugar de "MISO" y "MOSI", el MK tiene una interfaz separada (PDI / PDO), y la l√≠nea "CLK" se combina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voltaje de referencia para el ADC, eleg√≠ los mismos 5V, desde los cuales se alimenta el MK. Intent√© obtener 3.3V por separado (como en el circuito original), pero al mismo tiempo hubo dificultades. Y para cambiar al voltaje de referencia de 5V, debe cambiar ligeramente el circuito, como se muestra en la figura. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mn/od/wr/mnodwrbakf5xlxkq1qskzeuhmkc.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 4. Traducci√≥n de los botones en el voltaje de referencia de 5V.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Es decir, debe soldar un lado de la resistencia R505 desde el lado de suministro de 3.3V y, en su lugar, aplicarle 5V desde la l√≠nea de alimentaci√≥n MK.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De las conclusiones de MK, que se usan solo dentro del tablero dise√±ado, solo tres est√°n involucradas. Una se√±al de pulso de 1 Hz con RTC llega a PB7 para actualizar la hora. Los pines PD0 y PD1 se asignan al bus I2C. Se implementar√° mediante programaci√≥n utilizando la biblioteca CVAVR "i2c.h", a pesar de que una interfaz de hardware i2c (TWI) est√° conectada a estas salidas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El pin MC "RESET" se emite, pero el restablecimiento MK se producir√° por s√≠ solo sin una cadena de restablecimiento externo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se entendi√≥ que los pulsos de reloj HD y VD llegar√≠an al MK a trav√©s de puertos de interrupci√≥n externos para la precisi√≥n de la lectura del campo de video. Sin embargo, excluyendo la funci√≥n de enfoque autom√°tico, ya no son necesarios. Las se√±ales de los interruptores de l√≠mite de zoom y enfoque llegan a puertos vecinos de interrupciones externas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El puerto "A" MK est√° reservado para la transmisi√≥n de video digital. El puerto "C" est√° totalmente reservado para SD.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El pin PD4 se utiliza para cambiar TX / RX RS-485. No hubo conmutaci√≥n en el circuito original: la segunda y tercera patas del chip MAX485 estaban en el suelo. El MK original solo pod√≠a recibir datos para controlar la c√°mara a trav√©s de PELCO-D. Decid√≠ hacer una peque√±a actualizaci√≥n. La idea era esta. Si la videoc√°mara cuelga alto y en una carcasa cerrada, simplemente ser√° imposible actualizar r√°pidamente el firmware. Y seguramente surgir√° tal necesidad: eliminar varios errores y mejorar la funcionalidad se convertir√° en una pr√°ctica habitual por primera vez. Por lo tanto, se me ocurri√≥ la idea de implementar un gestor de arranque para MK, y ya lo utilizo para actualizar el firmware de forma remota a trav√©s de RS-485. Y en este caso, un intercambio bidireccional es muy deseable. Sobre el gestor de arranque ser√° una parte separada de este art√≠culo. Y para conectar el MAX485 (2 y 3 patas) a este pin MK,necesitas hacer un peque√±o cambio en el primer y segundo tablero. Estas placas est√°n conectadas por un cable de bucle, en cuyos conectores hay un contacto "IRL" no utilizado para el control de la luz de fondo. En la segunda placa (principal), debe soldar la resistencia R520 y soldar en lugar de un cable que atraviese la placa adaptadora al ATmega128 MK a la salida correspondiente. Y en la primera placa, debe soldar y doblar 2 y 3 patas de U202, soldarlas y sacarlas del cableado a la salida libre de 1 conector J302. Estas operaciones para cambiar el circuito se muestran en la figura.que pasar√° por la placa adaptadora al ATmega128 MK a la salida correspondiente. Y en la primera placa, debe soldar y doblar 2 y 3 patas de U202, soldarlas y sacarlas del cableado a la salida libre de 1 conector J302. Estas operaciones para cambiar el circuito se muestran en la figura.que pasar√° por la placa adaptadora al ATmega128 MK a la salida correspondiente. Y en la primera placa, debe soldar y doblar 2 y 3 patas de U202, soldarlas y sacarlas del cableado a la salida libre de 1 conector J302. Estas operaciones para cambiar el circuito se muestran en la figura.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qu/20/oe/qu20oe_mzvupcc4mpsbtg4omwma.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 5. Organizaci√≥n de la l√≠nea TRX para controlar el TX / RX MAX485.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hay dos interfaces UART a bordo del ATmega128. En este caso, debe usar la segunda interfaz (pines 27, 28), ya que la primera interfaz en los pines (pines 2, 3) se combina con la interfaz para el programador SPI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el tablero, est√°n involucradas casi todas las conclusiones del MK. Las conclusiones del puerto "G" resultaron no ser utilizadas. Por cierto, fue posible implementar el reloj mediante programaci√≥n sobre la base de MK. Proporciona un modo de suspensi√≥n con el uso de una bater√≠a para contar el tiempo cuando la alimentaci√≥n principal est√° apagada. Incluso hay conclusiones para conectar un cuarzo separado de baja frecuencia. Sin embargo, no me molest√© con esto, abofeteando el DS1307.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La figura siguiente muestra el prop√≥sito de cada salida de la placa con MK. Adem√°s, se marca condicionalmente qu√© y en qu√© lado de la placa principal se soldar√°n los cables de cada pin. Tambi√©n es necesario hacer algunos comentarios. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i0/fd/df/i0fddfrritx4bjzwqgsfl3bu1r4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 6. Asignaci√≥n de conclusiones de un pago adicional con MK.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las se√±ales de los interruptores de l√≠mite de zoom y enfoque llegan no solo a los puertos de interrupci√≥n, sino tambi√©n a las entradas ADC. El hecho es que incluso en la etapa del estudio de SD, not√© tal caracter√≠stica. Si el mecanismo de zoom o enfoque est√° en "cero", la se√±al de salida del remolque puede tomar un estado "intermedio". Para capturar mejor estos casos raros, decid√≠ usar el ADC. Por supuesto, este no es un enfoque muy competente, pero al hacerlo r√°pidamente sal√≠ del problema que a veces surg√≠a en la etapa de inicializaci√≥n de mi firmware de prueba. Por lo tanto, aument√© la estabilidad del algoritmo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las se√±ales SDA / SCL del I2C se conectan al conector, por si acaso, y no se usan fuera de esta placa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los nombres de cada pin para el control de la ID se firman de acuerdo con la conexi√≥n real. La conexi√≥n de datos, mirando hacia el futuro, finalmente se corrigi√≥ en la etapa de depuraci√≥n. Hubo mucha confusi√≥n, pero los errores fueron solo en la alternancia de fases precisas para revertir, y no en su orden. Las alternancias "4-1-2-3" (para el zoom) y "2-3-4-1" (para el enfoque) son lo mismo, as√≠ como "1-2-3-4", que y fue tomado como base. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final del art√≠culo </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(para no deshonrar)</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se presentan dos fotos. La primera es la vista inferior de la videoc√°mara con una vista de la placa de circuito adicional. La segunda es una vista desde arriba desde arriba en la placa principal de una c√°mara de video con un MK est√°ndar sellado (microprocesador, para ser m√°s precisos), un mont√≥n de puentes de alambre y otros mocos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escrib√≠ el programa (firmware) junto con sus pruebas preliminares en el programa ISIS 7 Professional (Proteus). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mt/qr/f7/mtqrf7iej-6e3adbtcg-bgghokq.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 7. Vista del proyecto en Proteus.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
En lugar de los chips √∫nicos del generador de caracteres y el procesador de video (que, por supuesto, no est√°n en Proteus), instal√© depuradores SPI. Con la ayuda de ellos, es conveniente controlar los bytes que MK env√≠a por SPI. Pero la reacci√≥n real a estos bytes se controla directamente en el hardware. Con Proteus, puede monitorear y depurar comandos PELCO-D provenientes de un DVR real. Para hacer esto, como opci√≥n, debe conectar el DVR al puerto COM de la computadora a trav√©s del adaptador unidireccional m√°s simple RS485-&gt; RS232. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego comenc√© a desarrollar y modelar. Excel ayud√≥ mucho con esto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero debe decidir sobre los temporizadores y su configuraci√≥n. Un temporizador: para realizar la rotaci√≥n del motor paso a paso y la implementaci√≥n de operaciones repetidas de los botones mientras los mantiene presionados. Al mantener presionado este o aquel bot√≥n durante la configuraci√≥n a trav√©s del men√∫, se excluir√° el funcionamiento de la SD. Y cuando mantiene presionado uno de los botones de control de zoom o enfoque fuera del men√∫, la SD gira con el par√°metro de tiempo correspondiente. Por lo tanto, no hay conflictos. Planeaba usar el segundo temporizador para implementar PWM para la SD, pero con el tiempo decid√≠ abandonarlo. De hecho, en mi caso, cuando no hay enfoque autom√°tico, no hay necesidad de PWM. Adem√°s, el mecanismo de transmisi√≥n tiene una estructura helicoidal, por lo tanto, en reposo, no puede "retener" la SD por corriente continua, el mecanismo no se arrastrar√° a ninguna parte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, debe revisar el alfabeto de los caracteres del generador de caracteres, de acuerdo con la hoja de datos, y compararlo con el alfabeto ASCII est√°ndar. El alfabeto del generador de caracteres consta de 128 caracteres, que es la mitad del tama√±o del √∫ltimo. Por ejemplo, los caracteres cir√≠licos en el generador de caracteres est√°n completamente ausentes, pero hay caracteres especiales que son caracter√≠sticos de su aplicaci√≥n (sol, reloj de arena, hombrecito, nota, tel√©fono, etc.). Hice una matriz de "smb [256]" de 256 elementos, coloc√°ndolo en la EEPROM MK. La notaci√≥n smb [i] = adr significa que en la direcci√≥n adr en el generador de caracteres hay un car√°cter con el c√≥digo ASCII i. Y si el s√≠mbolo i no est√° en el alfabeto del generador de caracteres, entonces el valor del elemento de matriz se refiere al "espacio" con la direcci√≥n 0x7E. Es decir, casi la mitad de los elementos en la matriz tienen un valor de "0x7E". Esta matriz se presenta en forma de tabla en la figura a continuaci√≥n.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yo/_b/_g/yo_b_gqswkjfk1smuefynrwgs0e.png"><br>
<i>. 8.    ASCII    PD6464A.</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, debe considerar c√≥mo procesar los botones a trav√©s del ADC. De acuerdo con la ley de Ohm, es f√°cil calcular los valores de voltaje en la entrada del ADC cuando hace clic en un bot√≥n. Despu√©s de eso, es f√°cil calcular los l√≠mites de los intervalos, cuya mitad ser√°n los mismos valores de tensi√≥n. En total, se obtienen seis intervalos: cinco de ellos corresponden a cada bot√≥n y uno a la ausencia de presi√≥n (no se presiona ning√∫n bot√≥n). A nivel de hardware, el ADC MK analiza peri√≥dicamente el valor de voltaje de los botones. El temporizador para anti-rebote se puede implementar en funci√≥n del c√°lculo de los ciclos de reloj ADC, lo cual hice. En la etapa de depuraci√≥n, esta parte del programa tuvo sus dificultades. Creo que no vale la pena escribir detalles. Para lograr el trabajo claro de esta funcionalidad, tuve que jugar mucho tiempo. La funci√≥n de reconocimiento de botones se coloca en la secci√≥n de interrupci√≥n de ADC, y en su salida est√° el n√∫mero de bot√≥n,bandera de depresi√≥n y bandera de liberaci√≥n. El procesamiento adicional de los botones ocurre en el ciclo del programa principal. La frecuencia de sondeo de los botones (frecuencia ADC) fue 12000/128 = 93,75 (kHz), donde 128 es el m√°ximo divisor posible.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego compil√© una matriz de valores de registro UART UBRR1 de la configuraci√≥n UART, dependiendo de una u otra velocidad de transmisi√≥n PELCO-D, que se puede seleccionar de la lista en la configuraci√≥n a trav√©s del men√∫. </font><font style="vertical-align: inherit;">Estos valores pueden calcularse usando la f√≥rmula de la hoja de datos en el MK, y tambi√©n pueden obtenerse usando el autoconfigurador AVR Wizard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces comenc√© a modelar el men√∫. </font><font style="vertical-align: inherit;">Esta es la etapa principal y larga de escribir un programa. </font><font style="vertical-align: inherit;">En principio, no iba a repetir el men√∫ del firmware est√°ndar, excepto por esto, decid√≠ complicarlo a una estructura jer√°rquica (secci√≥n en la secci√≥n). </font><font style="vertical-align: inherit;">A continuaci√≥n se muestra una descripci√≥n del modelo y las definiciones del men√∫ que hice para m√≠.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No puedo leer</font></font></b>
                        <div class="spoiler_text">     .<br>
          .<br>
      .<br>
          .<br>
       ¬´MENU¬ª.<br>
<br>
    ¬´¬ª    .<br>
    ¬´¬ª  ¬´¬ª       .<br>
  ¬´¬ª       .<br>
  ¬´¬ª       .<br>
  (   )   ,         .<br>
   ¬´ ¬ª,     .<br>
<br>
   :<br>
 ‚Äî ;<br>
 ‚Äî ;<br>
 ‚Äî ;<br>
 ‚Äî .<br>
<br>
    ,   ,   .<br>
    &lt;&gt;.<br>
     .<br>
         "&lt;..&gt;".<br>
      ¬´¬ª.<br>
      ,   .<br>
        ( ) .<br>
    "&lt;..&gt;"      .<br>
        ,    .<br>
           .<br>
<br>
      .<br>
     .<br>
        .<br>
     "&lt;‚Ä¢&gt;" ( ).<br>
     "&lt; &gt;" ().<br>
      ¬´¬ª.<br>
<br>
    .<br>
           .<br>
     ¬´l*l¬ª (,   ¬´l¬ª).<br>
     ¬´l l¬ª (,   ¬´l¬ª).<br>
        ¬´¬ª.<br>
<br>
  ,       .<br>
     .<br>
           .<br>
            .<br>
       : ¬´000¬ª, ¬´00¬ª, ¬´0¬ª.<br>
        .<br>
         : ": ".<br>
  ‚Äî      (    )       .<br>
 ,   ,     ¬´¬ª  ¬´¬ª.<br>
    ¬´¬ª     1.<br>
    ¬´¬ª     1.<br>
<br>
         .<br>
         .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, la navegaci√≥n por el men√∫ es algo similar a la navegaci√≥n por archivos y carpetas a trav√©s de "Total Commander". El c√≥digo de implementaci√≥n para este modelo de men√∫ no es muy complicado, pero es muy engorroso. Hay dos variables clave: el n√∫mero de la p√°gina activa y el n√∫mero de la posici√≥n activa en la p√°gina. Para ambas variables, dos funciones "switch-case" funcionan entre s√≠. Este par de funciones est√° involucrado en el proceso de presionar los botones "Izquierda", "Derecha" y "Men√∫". En cada lugar (para cada bot√≥n, p√°gina y elemento actual) se registran ciertas acciones. Cada p√°gina de men√∫ tiene una funci√≥n que implementa la visualizaci√≥n de la p√°gina en la pantalla con todas las inscripciones y par√°metros. Antes de implementar las funciones de salida de la p√°gina, las model√© previamente en Excel, como dicen, "por celdas".Por lo tanto, las coordenadas de las celdas de cada s√≠mbolo en el campo de la pantalla se presentan con mayor claridad, y esta informaci√≥n es necesaria en la etapa de programaci√≥n. En la siguiente figura, como ejemplo, ofrec√≠ la vista de la p√°gina 9, en la que se selecciona la velocidad de transmisi√≥n PELCO-D de la lista. El elemento de interfaz en la p√°gina es un bot√≥n de radio. Adem√°s, el primer p√°rrafo &lt;..&gt; es salir de esta secci√≥n.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c0/s1/uy/c0s1uyuaoh9dawm-bqpf5g4pmjg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 9. Modelado del OSD en Excel.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Tambi√©n hice una matriz que refleja el n√∫mero de puntos en cada p√°gina. Se utiliza en el procesamiento de presionar los botones Arriba y Abajo. Esto se hace para reducir el c√≥digo y evitar el uso de la funci√≥n switch-case.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las pulsaciones virtuales repetidas mientras se mantienen presionados los botones se implementan en el cuerpo de la interrupci√≥n del temporizador mediante la funci√≥n de "cambio de caja", que funciona en una variable entera, que es una bandera. El valor del indicador es √∫nico para cada acci√≥n de un bot√≥n en una p√°gina espec√≠fica y un elemento de men√∫ espec√≠fico. Se asigna a la bandera como un n√∫mero de serie solo en aquellos lugares donde se necesitan clics virtuales. Al mismo tiempo, dentro de la funci√≥n "interruptor de caja" (en el cuerpo de la interrupci√≥n del temporizador) se colocan copias de las funciones que implementan las acciones de los botones. Para ahorrar memoria, fue posible colocar "accesos directos" (enlaces) en llamadas regulares a la funci√≥n de procesamiento de botones. Es a√∫n m√°s razonable, pero en ese momento no ten√≠a la paciencia para pensar en c√≥mo hacerlo mejor, porque quer√≠a terminar el proyecto lo antes posible. Y la memoria en ATmega128 result√≥ ser bastante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, implement√© "bibliotecas" para trabajar con un procesador de video, generador de caracteres y RTC DS1307 con las funciones necesarias. Despu√©s de eso, determin√© las direcciones de EEPROM MK para almacenar esta o aquella informaci√≥n. Los primeros 32 bytes est√°n reservados para almacenar informaci√≥n de configuraci√≥n del men√∫. Los siguientes 32 bytes est√°n reservados para almacenar texto que se puede mostrar en la pantalla o cambiar usando el comando est√°ndar ‚ÄúPelco-D Write Char. A la pantalla. " Los siguientes 256 bytes del √°rea EEPROM est√°n reservados para el alfabeto (conversi√≥n de un car√°cter de ASCII a una direcci√≥n para un generador de caracteres, como se mencion√≥ anteriormente). Finalmente, los siguientes 128 bytes est√°n reservados para almacenar "presets" (plantillas) de zoom / enfoque. Introduje esta caracter√≠stica debido a la falta de enfoque autom√°tico. Escrib√≠ sobre esto al comienzo del art√≠culo. Un total de 32 plantillas. Las coordenadas del zoom o foco est√°n codificadas en dos bytes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por separado, vale la pena escribir sobre la implementaci√≥n de la gesti√≥n de SD. La rotaci√≥n de la SD se logra llamando a las funciones StepF () y StepZ () en el bloque de interrupci√≥n del temporizador. La velocidad de rotaci√≥n est√° determinada por la configuraci√≥n de este temporizador. Y la implementaci√≥n de las funciones anteriores implementa la promoci√≥n de enfoque o zoom (respectivamente) en un paso m√≠nimo. Durante la rotaci√≥n del objetivo zoom y el enfoque, se controlan sus posiciones finales. La posici√≥n del enfoque m√°ximo y la posici√≥n del zoom m√≠nimo se representan en el programa mediante constantes (280 y -600, respectivamente). Pero la posici√≥n del foco m√≠nimo y la posici√≥n del zoom m√°ximo, en forma de variables F_min y Z_max (m√°s precisamente, funciones). Este enfoque fue facilitado por un √°rea de trabajo no rectangular con una esquina inferior derecha cortada. Para calcular los valores de F_min y Z_max, se utilizan las funciones definidas por partes F_min (Z) y Z_max (F). Adem√°s,cuando el zoom SD gira en la direcci√≥n positiva en Z (coordenada del zoom)&gt; 500, el enfoque SD gira simult√°neamente en la misma direcci√≥n si este √∫ltimo tiene coordenadas &lt;(- 180). Es decir, la posici√≥n de zoom m√°xima, en principio, no est√° limitada por la posici√≥n de enfoque actual, sino que est√° limitada a 600. Simplemente sucede que dos SD giran simult√°neamente cuando se alcanza el borde angular correspondiente de la regi√≥n pentagonal, y el movimiento en esta etapa ocurre a lo largo del "lado cortado" (si se interpreta gr√°ficamente) ) Desde el punto de vista de la mec√°nica, esto es equivalente al proceso descrito en el art√≠culo anterior, cuando, en ausencia de SD y al mover manualmente los nodos de zoom y enfoque, el nodo de zoom al final de la ruta "tira" del nodo de enfoque. Debido al hecho de que la coordenada de zoom domina la coordenada de enfoque (por eso considero la dependencia de F (Z),pero no viceversa), no comenc√© a implementar un procedimiento similar de "desplazamiento" del zoom en la funci√≥n Step_F ().</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el firmware original, la velocidad de cambiar el zoom y el enfoque ten√≠a valores fijos. Esto no siempre es conveniente. En mi firmware, proporcion√© cuatro valores de zoom y velocidades de enfoque (independientemente), que se pueden seleccionar tanto a trav√©s del men√∫ como usando el comando PELCO-D asignado a esta funci√≥n. Estos cuatro valores se preseleccionan en la etapa de depuraci√≥n por conveniencia, luego se ingresan en el firmware.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La funci√≥n de inicializaci√≥n de BD init_MR () es necesaria para vincular la mec√°nica del zoom y enfocar el sistema de coordenadas. Se realiza una vez cada vez que enciende la videoc√°mara. El algoritmo de su trabajo es aproximadamente el siguiente. En primer lugar, se supone que el zoom o el foco est√°n en el punto cero, y se intenta atrapar el rebote de la se√±al de los interruptores de l√≠mite mediante funciones de interrupci√≥n externas. Notar√© de inmediato que si el zoom o el foco est√°n "en cero" (en el l√≠mite de la partici√≥n del avance √≥ptico), la se√±al a la salida del avance tiene un estado "intermedio" entre el "0" l√≥gico y el "1". Tales casos son muy poco probables, pero no se pueden descartar. Sin embargo, la funci√≥n de interrupci√≥n no interpreta una se√±al como rebote. Es por eso que llegu√© a usar el ADC MK, activando se√±ales desde los interruptores de l√≠mite y zoom en sus dos canales libres. Entonces,El primer paso es la "digitalizaci√≥n" de las se√±ales de los interruptores de l√≠mite con una precisi√≥n de 8 bits. Esto se hace usando una sola conversi√≥n de anal√≥gico a digital. Vale la pena recordar que el voltaje de referencia en nuestro caso es 5V, y el nivel l√≥gico "1" del interruptor de l√≠mite es 3.3V. Para un "0" l√≥gico, el valor de ADC ser√° cero, y para un "1" - 3.3 / 5 * 255 = 168. Si el valor de la se√±al de uno u otro trailer cae dentro del rango, digamos, de 2 a 165 (se toma un intervalo difuso), esto significa que el nodo correspondiente ya est√° "en cero", y el procedimiento de inicializaci√≥n para este nodo se puede detener. De lo contrario, por el valor l√≥gico de la se√±al del trailer ("0" o "1"), necesita determinar en qu√© parte (mitad) se encuentra el nodo. El sentido de rotaci√≥n de la SD depender√° de esto. De una forma u otra, la SD debe girarse en esta direcci√≥n,para que el nodo correspondiente se mueva hacia el "cero" (interruptor de l√≠mite). Por lo tanto, la rotaci√≥n del motor se inicia con el c√°lculo simult√°neo del n√∫mero de pasos hasta que se alcanza el interruptor de l√≠mite. Tan pronto como se alcanza el interruptor de l√≠mite correspondiente, que determina la funci√≥n de interrupci√≥n externa de acuerdo con la diferencia en el nivel l√≥gico, habr√° una rotaci√≥n inversa del motor. Girar√° en la direcci√≥n opuesta en el mismo n√∫mero de pasos, volviendo as√≠ a su posici√≥n original. El valor del n√∫mero de pasos para cada BD con el signo correspondiente se copiar√° a las variables correspondientes antes de salir de la funci√≥n de inicializaci√≥n. El procedimiento descrito anteriormente ocurre independientemente para enfocar y hacer zoom dentro de la misma funci√≥n (no a su vez).La velocidad de rotaci√≥n del accionamiento del motor en la etapa de inicializaci√≥n est√° determinada por una constante separada y corresponde a la velocidad m√°xima para una rotaci√≥n correcta y segura del SM.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere el ejemplo donde, antes de encender la c√°mara, el zoom estaba en la regi√≥n negativa y el foco estaba en la regi√≥n positiva. La figura muestra esquem√°ticamente la trayectoria del punto (Z; F) durante el procedimiento de inicializaci√≥n del motor paso a paso. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1p/59/6d/1p596dlrqriwqff1jh4jfrtvu-8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 10. El proceso de inicializaci√≥n del zoom y el enfoque.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
El punto A es la posici√≥n inicial del zoom y el enfoque. El movimiento de ambos nodos ocurre en la direcci√≥n de "cero" con la misma velocidad (velocidad de inicializaci√≥n). En el punto B, el foco llega a cero, ya que estaba m√°s cerca de cero que el zoom. Entonces el enfoque se invierte. En el punto C, el foco completa el proceso de inicializaci√≥n, volviendo a su posici√≥n original. Al mismo tiempo, el zoom todav√≠a se mueve hacia su "cero". En el punto D, alcanza su "cero" y vuelve a su posici√≥n original (punto A).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de la funci√≥n de inicializaci√≥n init_MR (), hay una funci√≥n goto_zf (z, f). </font><font style="vertical-align: inherit;">Basado en el nombre, est√° destinado a cambiar de un preset a otro, sobre el que escrib√≠ al principio del art√≠culo. </font><font style="vertical-align: inherit;">La velocidad de rotaci√≥n del motor paso a paso durante la transici√≥n es la misma que durante la inicializaci√≥n. </font><font style="vertical-align: inherit;">El proceso de transici√≥n en zoom y enfoque se lleva a cabo simult√°neamente. </font><font style="vertical-align: inherit;">Es decir, si se requiere ir desde el punto (z1; f1) al punto (z2; f2), se inicia la rotaci√≥n simult√°nea de dos SD. </font><font style="vertical-align: inherit;">Si, por ejemplo, | f2-f1 | &lt;| z2-z1 |, el foco SD se detendr√° antes. </font><font style="vertical-align: inherit;">Esto se demuestra en la figura a continuaci√≥n. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fb/-y/ya/fb-yyanbovlb6i3pe6rxsfh0ax8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. </font><font style="vertical-align: inherit;">11. El proceso de cambiar el zoom y el enfoque al elegir un preset.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante todo el tiempo de operaci√≥n del motor paso a paso durante el paso del limitador de marca cero, la coordenada correspondiente se pone a cero. </font><font style="vertical-align: inherit;">Y esto a pesar del hecho de que, en teor√≠a, esto no se puede hacer. </font><font style="vertical-align: inherit;">Sin embargo, en la pr√°ctica, todav√≠a hay un error de 1-2 pasos de la SD.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena agregar que, a diferencia del firmware original, en mi caso, al controlar el zoom y el enfoque (tanto desde los botones como a trav√©s de PELCO-D), proporcion√© la posibilidad de un movimiento paso a paso. Esto funciona de la siguiente manera. Cuando hace clic en cualquiera de los 4 botones para controlar el zoom o el foco, la SD correspondiente se gira un paso, minimizando as√≠ el movimiento del nodo de zoom o foco. Si no suelta el bot√≥n, la rotaci√≥n normal del motor paso a paso comenzar√° despu√©s de un corto per√≠odo de tiempo. Este retraso se selecciona emp√≠ricamente de antemano. Esta caracter√≠stica es similar a las presiones virtuales repetidas mientras se mantiene presionado el bot√≥n. Gracias a esta funci√≥n, se elimina el problema de "pegar" el bot√≥n al controlar el zoom o enfocar el dispositivo remoto PELCO-D a trav√©s de una mala conexi√≥n a Internet. M√°s precisamente, la oportunidad surge como grosera,y afinar el zoom o el enfoque.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El int√©rprete de los comandos PELCO-D se realiza con la misma analog√≠a que en el dispositivo para conmutar cargas a trav√©s de PTZ. Anteriormente dediqu√© un peque√±o art√≠culo separado sobre Habr√© a este dispositivo simple. A diferencia del firmware original, los comandos de control de zoom y enfoque se refieren completamente a presionar los botones correspondientes. Es decir, es posible "subir" el men√∫ utilizando los botones de zoom y enfoque PELCO-D. Y para acceder de forma remota al men√∫ a trav√©s de PELCO-D, o m√°s bien, presionar el bot√≥n "MEN√ö", compar√© el bot√≥n de apertura de apertura con √©l, porque esta funci√≥n no se usa en este modelo de c√°mara. Por lo tanto, hay cinco comandos b√°sicos de PELCO-D para presionar, as√≠ como cinco comandos b√°sicos para soltar botones. Adem√°s, como ya escrib√≠ casualmente en todo el art√≠culo, se procesan comandos adicionales: "Establecer preajuste", "Borrar preajuste","Ir a Preset", "Escribir Char. A la pantalla "," Borrar pantalla "," Establecer velocidad de zoom "," Establecer velocidad de enfoque ".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fecha y la hora con RTC se muestran en la esquina inferior izquierda de la imagen por analog√≠a con las c√°maras VHS antiguas, si esta opci√≥n est√° activada en el men√∫. Adem√°s, en el men√∫ puede seleccionar el formato de salida, que tambi√©n proporcion√© por adelantado. Tambi√©n en la pantalla junto a la fecha y la hora es posible mostrar el d√≠a de la semana. Adem√°s del reloj, las coordenadas actuales del zoom y el foco se muestran en la pantalla como informaci√≥n adicional. Esta opci√≥n es necesaria principalmente en la etapa de depuraci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Te contar√© sobre las funciones del men√∫ que implement√©. Con el tiempo, si es necesario, se revisar√° el men√∫: algunas funciones pueden eliminarse y otras agregarse. La estructura del men√∫ que dibuj√© en SPlan, con vistas de p√°gina, se muestra en la figura a continuaci√≥n. Flechas rojas: ingrese a la secci√≥n. Flechas azules: salga de la secci√≥n. No dibuj√© flechas azules en cada p√°gina del men√∫, dibuj√© solo dos, por ejemplo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rl/vs/mp/rlvsmpdeoixbmwlg-jmf2uwj51m.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. 12. La estructura del men√∫ en pantalla.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algunas secciones de mi men√∫ son un poco como las secciones del original. En primer lugar, estas son las dos primeras secciones: balance de blancos y exposici√≥n. En la tercera secci√≥n, puede especificar la direcci√≥n de la c√°mara PELCO-D y seleccionar la velocidad de datos (velocidad de transmisi√≥n) de la lista. La cuarta secci√≥n est√° dedicada a la fecha y la hora. Puede configurar la fecha, la hora, el d√≠a de la semana, elegir uno de los cuatro formatos de visualizaci√≥n y elegir un m√©todo de visualizaci√≥n. La quinta secci√≥n: trabajar con ajustes preestablecidos (plantillas) de zoom y enfoque, donde puede llamarlo por n√∫mero, as√≠ como borrar o sobrescribir. Tambi√©n en esta secci√≥n del men√∫, puede elegir una de las cuatro velocidades para cambiar el enfoque o el zoom. La quinta secci√≥n le permite editar los par√°metros del procesador de video, ubicado en el byte 9 de la categor√≠a 3. Este es el nivel y la inversi√≥n del componente de r√°faga de la se√±al de video y la duplicaci√≥n de video. La √∫ltima secci√≥n del men√∫ es para depurar.Al usarlo, puede escribir en el procesador de video cualquier valor de cualquier byte en cualquier categor√≠a. El valor se puede establecer en forma decimal y binaria.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora dir√© algunas palabras sobre el gestor de arranque. Como ya escrib√≠, el cargador de arranque es necesario para flashear remotamente la videoc√°mara a trav√©s de RS-485. Inicialmente, pens√© en implementar completamente el gestor de arranque yo mismo. Sin embargo, para ahorrar tiempo, decid√≠ hacerlo con uno de los descargadores ya implementados que se pueden encontrar en Internet. Adem√°s, nunca los he usado, teniendo una idea de ellos solo a nivel te√≥rico. Uno de los criterios importantes para elegir un gestor de arranque es el soporte RS-485. Por lo general, los descargadores AVR funcionan en UART RS-232. Y el cargador de arranque con soporte RS-485 solo difiere en que se asigna una salida adicional en el lado MK para cambiar el transceptor RS-485 (por ejemplo, MAX485) durante la transferencia de datos desde el MK a la PC. Cuando parpadea MK, el gestor de arranque transmite informaci√≥n sobre la grabaci√≥n exitosa o no exitosa a la computadora. Primer gestor de arranqueque encontr√© le permite grabar no solo la memoria FLASH de MK con firmware, sino tambi√©n EEPROM. Adem√°s de escribir, tambi√©n puede leer datos. Pero este proyecto con el c√≥digo fuente del ensamblador fue bastante confuso y no lo entend√≠. Adem√°s, el √©nfasis principal de este gestor de arranque apuntaba a la capacidad de flashear m√∫ltiples dispositivos individualmente, sin desconectarlos de la red RS-485, accediendo a cada dispositivo en una direcci√≥n que estaba conectada previamente. No necesito tales funciones funcionales, ya que uso una topolog√≠a diferente de la red RS-485, y es posible cambiar r√°pidamente la videoc√°mara de DVR a PC. El segundo gestor de arranque es el alem√°n Chip45. El c√≥digo fuente no est√° en el dominio p√∫blico, se puede comprar al autor. En cambio, hay varios cientos de archivos HEX para diferentes AVR MK, diferentes interfaces UART (si hay varios, como en mi caso),RS-485 o RS-232 para elegir. En resumen, para todas las ocasiones. Al mismo tiempo, el autor se√±ala que en el caso de RS-485, el pin de conmutaci√≥n TX / RX es fijo y corresponde al pin XCK UART de la interfaz del controlador, que pr√°cticamente no se usa en UART. En mi caso, el pin 30 del XCK de la segunda interfaz UART del Atmega128 MK es PORTD.5 ‚Äã‚Äãy se utiliza para activar los interruptores de l√≠mite de enfoque y zoom. En principio, esta funci√≥n no es necesaria porque, como lo han demostrado los estudios, los interruptores de l√≠mite siempre est√°n activos, como ya escrib√≠. Y si es necesario, puede transferir esta funci√≥n a cualquier otra salida libre MK. Pero, de todos modos, este gestor de arranque tampoco me impresion√≥, especialmente porque me encontr√© con un gestor de arranque m√°s interesante llamado "AVR Universal Bootloader" de dise√±o chino. Al igual que Chip45, solo puede escribir y solo en la memoria FLASH de MK.Pero √©l tiene una gran cantidad de posibilidades y, por lo tanto, decid√≠ permanecer en √©l. Viene como un proyecto AVR Studio con c√≥digo fuente C. Debido al hecho de que trabajo en CodeVisionAVR, tuve que instalar AVR Studio junto con WinAVR. Para obtener el archivo HEX del firmware del cargador de arranque, debe compilar el proyecto haciendo cambios preliminares en el c√≥digo fuente a la configuraci√≥n de su propio dispositivo y necesita el suyo propio. La compilaci√≥n del proyecto consiste en lanzar un archivo bat (archivo por lotes), en el que se escriben los comandos de compilaci√≥n. Por lo tanto, no es necesario abrir un proyecto en AVR Studio. Los cambios en el c√≥digo fuente pueden hacerse manualmente (a nivel del programador) o usando el configurador. El papel de este √∫ltimo es una ventana adicional de la utilidad que funciona con el gestor de arranque, que tambi√©n est√° adjunto.En el configurador, puede especificar el pin MK para la conmutaci√≥n TX / RX RS-485, el pin MK para el LED parpadeante de control, el pin MK para ingresar al cargador de arranque, la forma en que se ingresa el cargador de arranque, el nombre y la frecuencia MK, etc., no se pueden enumerar. Adem√°s, el programa HyperTerminal conocido est√°ndar puede actuar como una utilidad para cargar un programa de usuario en MK, es decir, para trabajar con el gestor de arranque. Utiliza el protocolo Xmodem para descargar firmware. Y para trabajar de manera conveniente y visual con el gestor de arranque a trav√©s del terminal de texto, se proporciona la funci√≥n especial "Modo detallado" en el configurador. Pero a pesar del atractivo del hiperterminal, decid√≠ usar la utilidad que ven√≠a con el gestor de arranque. El hecho es que con la conveniente funci√≥n Verbose activada en el configurador, trabajando a trav√©s del terminal, me encontr√© con la siguiente situaci√≥n.A veces sucedi√≥ cuando el tr√°fico de datos en la l√≠nea "colision√≥" (ambos dispositivos en modo TX), como resultado de lo cual el MAX485 en la videoc√°mara se calent√≥ mucho y fall√≥, o mejor dicho, no completamente, sino solo la secci√≥n RX (transmitiendo datos a trav√©s de RS-485 a la c√°mara) . Debido a esto, abandon√© HyperTerminal. Y hay un inconveniente m√°s. HyperTerminal no funciona con archivos de texto HEX y solo acepta un archivo binario. Por lo tanto, tendr√≠a que aplicar una conversi√≥n adicional de hexadecimal a bin. Despu√©s de generar el archivo HEX del cargador de arranque, lo cos√≠ en el MK usando el programa PonyProg y el programador SPI habitual. Como resultado, el gestor de arranque funciona de la siguiente manera. Cuando enciende la videoc√°mara, el gestor de arranque se activa inmediatamente. Espera una conexi√≥n de la utilidad por un segundo, luego el firmware principal comienza a funcionar. Si la conexi√≥n se establece con √©xito,entonces comienza el proceso de flasheo. Al mismo tiempo, el otro extremo de la l√≠nea RS-485 debe desconectarse del DVR de antemano y conectarse a la PC a trav√©s del adaptador USB RS485 &lt;-&gt; RS232 o RS485 &lt;-&gt;. Por cierto, sobre los adaptadores. Surgi√≥ la pregunta de c√≥mo hacer un adaptador de este tipo, ya que los adaptadores adquiridos son caros. Buscando en Internet, encontr√© un simple circuito adaptador RS485 &lt;-&gt; RS232. Se muestra en la figura a continuaci√≥n. Consiste principalmente en los conocidos microcircuitos MAX232 y MAX485, y TX / RX se conmuta mediante la se√±al de la tercera salida del conector del puerto COM de la computadora a trav√©s de un circuito de diodo zener. Es decir, el MAX485 es conmutado por el tr√°fico de datos que transmite la PC. Todo es simple e ingenioso.RS232 o RS485 &lt;-&gt; USB. Por cierto, sobre los adaptadores. Surgi√≥ la pregunta de c√≥mo hacer un adaptador de este tipo, ya que los adaptadores adquiridos son caros. Buscando en Internet, encontr√© un simple circuito adaptador RS485 &lt;-&gt; RS232. Se muestra en la figura a continuaci√≥n. Consiste principalmente en los conocidos microcircuitos MAX232 y MAX485, y TX / RX se conmuta mediante la se√±al de la tercera salida del conector del puerto COM de la computadora a trav√©s de un circuito de diodo zener. Es decir, el MAX485 es conmutado por el tr√°fico de datos que transmite la PC. Todo es simple e ingenioso.RS232 o RS485 &lt;-&gt; USB. Por cierto, sobre los adaptadores. Surgi√≥ la pregunta de c√≥mo hacer un adaptador de este tipo, ya que los adaptadores adquiridos son caros. Buscando en Internet, encontr√© un simple circuito adaptador RS485 &lt;-&gt; RS232. Se muestra en la figura a continuaci√≥n. Consiste principalmente en los conocidos microcircuitos MAX232 y MAX485, y TX / RX se conmuta mediante la se√±al de la tercera salida del conector del puerto COM de la computadora a trav√©s de un circuito de diodo zener. Es decir, el MAX485 es conmutado por el tr√°fico de datos que transmite la PC. Todo es simple e ingenioso.Consiste principalmente en los conocidos microcircuitos MAX232 y MAX485, y TX / RX se conmuta mediante la se√±al de la tercera salida del conector del puerto COM de la computadora a trav√©s de un circuito de diodo zener. Es decir, el MAX485 es conmutado por el tr√°fico de datos que transmite la PC. Todo es simple e ingenioso.Consiste principalmente en los conocidos microcircuitos MAX232 y MAX485, y TX / RX se conmuta mediante la se√±al de la tercera salida del conector del puerto COM de la computadora a trav√©s de un circuito de diodo zener. Es decir, el MAX485 es conmutado por el tr√°fico de datos que transmite la PC. Todo es simple e ingenioso.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dg/_j/xg/dg_jxg5vy5h-i32yee8szg8urho.png"><br>
<i>. 13.   RS-232 &lt;-&gt; RS-485.</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de dominar el gestor de arranque, en mi tiempo libre, decid√≠ investigar la √≥ptica de la videoc√°mara. M√°s precisamente, me result√≥ interesante qu√© combinaciones de valores de zoom y enfoque producir√°n im√°genes enfocadas a diferentes distancias de la lente al sujeto. Perm√≠tame recordarle que la regi√≥n de varios valores mutuos de zoom y enfoque se describe mediante una regi√≥n pentagonal (casi rectangular). Por ejemplo, tome la distancia de la lente al sujeto 10 cm. El argumento (a lo largo del eje de abscisas) del zoom tiene un rango de valores de -600 a 600. Es necesario seleccionar el valor de enfoque en cada valor de zoom en el que el sujeto frente a la lente en la imagen de video estar√° enfocado. Entonces necesitas hacer una mesa. Por supuesto, no tiene sentido ordenar los 1200 valores de zoom, es suficiente tomar unas pocas docenas de valores con un cierto paso igual. Como tal paso, eleg√≠ el valor 50.En cada valor de zoom con este paso (-600, -550, -500, ...) seleccion√© el valor de enfoque y grab√© los resultados de la medici√≥n. Hice un procedimiento similar con otras distancias desde la lente hasta el sujeto: 50 cm, 1 m, 10 m, 100 m. El resultado fue una familia de curvas que mostr√© en Excel.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5o/_4/qi/5o_4qikxragcwmdaeespjactaoi.png"><br>
<i>. 14.  Z-F   .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mirando los gr√°ficos, quiero hacer muchos comentarios. Con el zoom m√≠nimo, los valores de enfoque son ligeramente inferiores al "medio" (cero) para casi cualquier distancia. La curva rosa para una distancia de 10 cm termina con un valor de zoom de aproximadamente 250, que corresponde al valor de enfoque m√≠nimo. Esta curva tiene un car√°cter decreciente y es convexa hacia arriba. La curva roja para una distancia de 1 m tiene una forma completamente diferente. En primer lugar, no es mon√≥tono, y en segundo lugar, en lo que respecta a la propiedad de convexidad, hay un punto de inflexi√≥n. Las curvas para distancias de 10 my 100 m son de naturaleza similar, las √∫ltimas, por cierto, pr√°cticamente coinciden, lo que ya sab√≠a de antemano. Por lo tanto, las distancias medidas de 10 y 100 metros, por supuesto, tom√© aproximadamente. Lo que balancea la curva azul para una distancia de medio metro: inicialmente no iba a tomar medidas sobre ella.Seleccion√© esta distancia aproximadamente en base al principio de que lo m√°s cerca posible con un fragmento de la curva correspondiente se aproxima al l√≠mite de la esquina de la regi√≥n (corte). Y as√≠ sucedi√≥: este borde pr√°cticamente toca un fragmento de la curva. En general, vale la pena se√±alar que la mitad superior de la regi√≥n (valores de enfoque positivos) pr√°cticamente no se usa. La excepci√≥n se encuentra a una gran distancia del sujeto a la lente y con el zoom m√°s grande. Y, sin embargo, para casi todas las distancias (excepto la m√°s cercana, menos de medio metro), con un zoom bajo (150 o menos), los valores de enfoque son casi los mismos. En t√©rminos generales, todos los hechos de medici√≥n establecidos deben tener una interpretaci√≥n te√≥rica, basada en las leyes de la √≥ptica. Pero en este momento, no tengo idea de los dispositivos de lentes de este tipo. M√°ximo,Lo que encontr√© en el campo de la √≥ptica es la construcci√≥n de un simple telescopio refractor de dos lentes. Y en el caso de esta videoc√°mara, no entend√≠ la mec√°nica de la √≥ptica. En la salida, solo dos nodos m√≥viles no est√°n disponibles: el nodo de enfoque (responsable del enfoque) y el nodo de zoom. Y no s√© cu√°ntas lentes totales hay dentro. Supongo que dos est√°n conectados con estos nodos m√≥viles. Tambi√©n vale la pena se√±alar que al ajustar el enfoque, el zoom tambi√©n cambia visualmente ligeramente, incluso si el nodo correspondiente est√° fijo.conectado a estos nodos m√≥viles. Tambi√©n vale la pena se√±alar que al ajustar el enfoque, el zoom tambi√©n cambia visualmente ligeramente, incluso si el nodo correspondiente est√° fijo.conectado a estos nodos m√≥viles. Tambi√©n vale la pena se√±alar que al ajustar el enfoque, el zoom tambi√©n cambia visualmente ligeramente, incluso si el nodo correspondiente est√° fijo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final del art√≠culo, pasamos a las pruebas pr√°cticas de la videoc√°mara. Decid√≠ no tomar muchas fotos fijas, pero inmediatamente cargu√© todo el video. Grab√© la captura de video a trav√©s del dispositivo, el sonido se escribi√≥ por separado en la grabadora de audio. La resoluci√≥n original es 720 por 576. Despu√©s de subir el video a YouTube, su calidad ha cambiado notablemente.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/H4agAlZlWW8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando enciende la c√°mara, lo primero que sucede es la inicializaci√≥n de los motores paso a paso del zoom y el enfoque en el fondo de la imagen de video. Esta imagen es en blanco y negro y sin AGC, ya que el procedimiento de inicializaci√≥n del procesador de video a√∫n no ha pasado. En la parte inferior izquierda, la fecha y hora actuales mostrar√°n la fecha y hora de compilaci√≥n del firmware actual de la c√°mara. En el c√≥digo fuente del firmware, cre√© las variables correspondientes que se encuentran en direcciones fijas en el c√≥digo HEX. Se supone que en la etapa de compilaci√≥n, m√°s precisamente despu√©s de eso, se ejecutar√° autom√°ticamente un programa que toma los valores de las variables de la hora del sistema y las inserta en el archivo HEX en las direcciones deseadas. Adem√°s, todav√≠a es necesario contar las sumas de verificaci√≥n. Quiz√°s haya una manera m√°s simple. En el ejemplo en el video, estas variables son iguales a cero, ya que a√∫n no he implementado esta funci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de la inicializaci√≥n de la SD, el procesador de video se inicializa y se muestra inmediatamente un saludo en el fondo de la imagen de video. Al ajustar el zoom y el enfoque, sus coordenadas se muestran en la parte inferior derecha. En el video, demuestro el uso de la funci√≥n de guardar y recuperar plantillas (preajustes) de zoom y enfoque en varias partes de la imagen. Al borrar un preset, las variables correspondientes adquieren el valor 0xFFFF, que corresponde a un valor de -1. Esta funci√≥n, en principio, es superflua, se puede excluir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la √∫ltima secci√≥n del men√∫, que se utiliza para la depuraci√≥n, demuestro el registro del byte 3. de categor√≠a 9. Las funciones correspondientes a este byte se encuentran en la secci√≥n anterior del men√∫, escrib√≠ sobre ellas muchas veces. Debido al hecho de que el estado actual del byte no se lee del procesador de video, lo configur√© manualmente en "48" como uno de los aceptables. Despu√©s de eso, cambio los bits individuales de este byte, mostrando as√≠ las funciones "Mirror" y "Inverse Burst". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al ajustar el nivel de "R√°faga" en la pen√∫ltima secci√≥n del men√∫, notar√° un peque√±o error de firmware que es f√°cil de solucionar. De las otras deficiencias, a veces, al actualizar el tiempo, se producen brechas en los caracteres. Creo que esto se debe a la instalaci√≥n "torcida" de la electr√≥nica dentro de la videoc√°mara.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, al operar la c√°mara, se encontraron inconvenientes menores asociados con la navegaci√≥n del men√∫. </font><font style="vertical-align: inherit;">Por lo tanto, es muy posible que la revisi√≥n necesaria se realice con el tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√≠, casi lo olvido. </font><font style="vertical-align: inherit;">Como promet√≠, traigo dos fotograf√≠as de en qu√© se convirti√≥ el relleno de la videoc√°mara despu√©s del desarrollo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m-/0-/ah/m-0-ahq2z2xqxpr988ndcfae5uu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. </font><font style="vertical-align: inherit;">15. Una vista actualizada de la videoc√°mara en la parte inferior. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/gs/8_/bw/gs8_bwxf2yy1mqyrt2gmbgzoyu8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Higo. </font><font style="vertical-align: inherit;">16. Una vista actualizada de la videoc√°mara dentro de la parte superior.</font></font></i><br>
<br></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es499534/index.html">Gu√≠a de desarrollo del servicio backend de Python</a></li>
<li><a href="../es499536/index.html">Growbox como m√©todo de conocerse</a></li>
<li><a href="../es499540/index.html">C√≥mo funciona la renderizaci√≥n de juegos en 3D: texturizado y filtrado de texturas</a></li>
<li><a href="../es499542/index.html">Top Fakapov Cyan</a></li>
<li><a href="../es499544/index.html">Aprende redes neuronales en Hojas de c√°lculo de Google</a></li>
<li><a href="../es499548/index.html">M√°scara: ¬øcuidar a los dem√°s o una ilusi√≥n de seguridad?</a></li>
<li><a href="../es499550/index.html">Soluciones de ecosistema de c√≥digo bajo</a></li>
<li><a href="../es499556/index.html">Servidor de juegos en MS Orleans - Parte 3: Resumen</a></li>
<li><a href="../es499560/index.html">Corrector de dise√±o Xswitcher para Linux: paso dos</a></li>
<li><a href="../es499562/index.html">Art√≠culo infructuoso sobre la aceleraci√≥n de la reflexi√≥n.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>