<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤰 🧑🏼‍🤝‍🧑🏻 😚 Widget di Android. Fitur yang jarang ditemukan 👩🏾‍🤝‍👩🏼 🌎 🏀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! Nama saya Alexander Khakimov, saya seorang pengembang android di FINCH. 
 
 Apakah kebetulan desain Anda untuk iOS, dan Anda harus menyesu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Widget di Android. Fitur yang jarang ditemukan</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492166/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo, Habr! </font><font style="vertical-align: inherit;">Nama saya Alexander Khakimov, saya seorang pengembang android di FINCH. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apakah kebetulan desain Anda untuk iOS, dan Anda harus menyesuaikannya untuk android? </font><font style="vertical-align: inherit;">Jika demikian, apakah desainer Anda sering menggunakan widget? </font><font style="vertical-align: inherit;">Sayangnya, widget adalah kasus yang jarang terjadi bagi banyak pengembang, karena jarang ada orang yang bekerja dengannya </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pembuatan widget</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk membuat widget, Anda perlu tahu:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fitur komponen widget.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fitur menampilkan widget di kotak layar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fitur pembaruan widget.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan menganalisis setiap item secara terpisah.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fitur komponen widget</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengembang mana pun yang telah bekerja dengan RemoteViews setidaknya satu kali sudah familiar dengan item ini. </font><font style="vertical-align: inherit;">Jika Anda salah satunya, jangan ragu untuk beralih ke poin berikutnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RemoteViews dirancang untuk menggambarkan dan mengelola hierarki Tampilan yang merupakan bagian dari proses di aplikasi lain. </font><font style="vertical-align: inherit;">Menggunakan manajemen hierarki, Anda dapat mengubah properti atau memanggil metode yang dimiliki oleh View, yang merupakan bagian dari aplikasi lain. </font><font style="vertical-align: inherit;">RemoteViews mencakup sekumpulan komponen terbatas dari pustaka komponen android.widget standar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lihat di dalam widget berfungsi dalam proses terpisah (biasanya ini adalah layar beranda), oleh karena itu, untuk mengubah UI widget, gunakan ekstensi BroadcastReceiver - AppWidgetProvider, yang berfungsi di aplikasi kami.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fitur menampilkan widget di "kisi" layar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebenarnya, poin ini tidak begitu rumit, jika Anda melihat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pedoman resmi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
 <blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setiap widget harus menetapkan minWidth dan minHeight, yang menunjukkan jumlah ruang minimum yang harus dikonsumsi secara default. </font><font style="vertical-align: inherit;">Saat pengguna menambahkan widget ke layar Beranda, umumnya akan menempati lebih dari lebar minimum dan tinggi yang Anda tentukan. </font><font style="vertical-align: inherit;">Layar Beranda Android menawarkan pengguna kotak ruang yang tersedia tempat mereka dapat menempatkan widget dan ikon. </font><font style="vertical-align: inherit;">Kisi ini dapat bervariasi menurut perangkat; </font><font style="vertical-align: inherit;">misalnya, banyak handset menawarkan kisi 4x4, dan tablet dapat menawarkan kisi yang lebih besar, 8x7.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menerjemahkan ke dalam bahasa Rusia: setiap widget harus mengatur lebar minimum dan tinggi sendiri untuk menunjukkan ruang minimum yang akan ditempati secara default. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6r/p-/ux/6rp-uxyfekjzwlpantqmxkdfaio.png" alt="gambar"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contoh pengaturan widget saat membuat di Android Studio</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Widget yang ditambahkan ke layar Beranda biasanya akan memakan lebih banyak ruang daripada lebar minimum dan tinggi layar yang Anda tetapkan. Layar Beranda Android memberi pengguna kisi ruang yang tersedia tempat widget dan ikon dapat ditemukan. Kisi ini dapat beragam menurut perangkat; misalnya, banyak ponsel menawarkan kisi 4x4, dan tablet dapat menawarkan kisi 8x4 besar.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari sini menjadi jelas bahwa kisi perangkat dapat berupa apa saja, dan ukuran sel dapat bervariasi, tergantung pada ukuran kisi. </font><font style="vertical-align: inherit;">Dengan demikian, konten widget harus dirancang dengan mempertimbangkan fitur-fitur ini. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lebar minimum dan tinggi widget untuk jumlah kolom dan baris tertentu dapat dihitung menggunakan rumus: </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
minSideSizeDp = 70 × n - 30, di mana n adalah jumlah baris atau kolom </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. Saat ini, kisi minimum maksimum yang dapat Anda atur adalah 4x4. </font><font style="vertical-align: inherit;">Ini memastikan bahwa widget Anda akan ditampilkan di semua perangkat.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fitur pembaruan widget</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena AppWidgetProvider pada dasarnya merupakan perpanjangan dari BroadcastReceiver, Anda dapat melakukan hal yang sama dengannya seperti dengan BroadcastReceiver biasa. AppWidgetProvider hanya mem-parsing bidang yang sesuai dari Intent yang diterima di onReceive dan memanggil metode intersepsi dengan ekstra yang diterima. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kesulitan muncul dengan frekuensi memperbarui konten - intinya adalah perbedaan dalam operasi internal widget di iOS dan Android. Faktanya adalah bahwa data pada widget iOS diperbarui ketika widget menjadi terlihat oleh pengguna. Di Android, acara seperti itu tidak ada. Kami tidak dapat mengetahui kapan pengguna melihat widget.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk widget di Android, metode pembaruan yang disarankan adalah pembaruan timer. </font><font style="vertical-align: inherit;">Pengaturan timer diatur oleh update parameter widgetPeriodMillis. </font><font style="vertical-align: inherit;">Sayangnya, pengaturan ini tidak memungkinkan memperbarui widget lebih dari sekali setiap 30 menit. </font><font style="vertical-align: inherit;">Di bawah ini saya akan membicarakan hal ini lebih terinci.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kasing widget</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya kita akan berbicara tentang kasus yang kita miliki di FINCH dalam aplikasi lotre besar dengan aplikasi Stoloto untuk partisipasi dalam lotere negara. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tugas aplikasi ini adalah untuk menyederhanakan dan membuat transparan bagi pengguna pilihan lotre dan pembelian tiket. </font><font style="vertical-align: inherit;">Oleh karena itu, fungsi widget yang diperlukan cukup sederhana: perlihatkan game yang direkomendasikan pengguna untuk dibeli dan ketuk untuk pergi ke yang sesuai. </font><font style="vertical-align: inherit;">Daftar gim ditentukan di server dan diperbarui secara berkala. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kasus kami, desain widget menyertakan dua status:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk pengguna yang berwenang</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk pengguna yang tidak sah</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seorang pengguna yang berwenang perlu menunjukkan data profilnya: status dompet internal, jumlah tiket yang menunggu undian dan jumlah kemenangan yang hilang. </font><font style="vertical-align: inherit;">Untuk masing-masing elemen ini, transisi ke layar di dalam aplikasi disediakan, berbeda dari yang lain. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rp/d2/6i/rpd26ixtdxfjopibvmgaaczfkco.png" alt="gambar"><br>
<br>
<img src="https://habrastorage.org/webt/dk/yy/qx/dkyyqxqcnopxezwhknrmqbuedgu.png" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang mungkin Anda perhatikan, fitur lain untuk pengguna yang berwenang adalah tombol "segarkan", tetapi lebih lanjut tentang itu nanti. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengimplementasikan tampilan dua negara, dengan mempertimbangkan desain, saya menggunakan RemoteAdapter sebagai implementasi RemoteViewsService untuk menghasilkan kartu konten. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan sekarang sedikit kode dan bagaimana semuanya bekerja di dalamnya. </font><font style="vertical-align: inherit;">Jika Anda sudah memiliki pengalaman dengan widget, maka Anda tahu bahwa setiap pembaruan data widget dimulai dengan metode onUpdate:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onUpdate</span><span class="hljs-params">(
        context: <span class="hljs-type">Context</span>,
        appWidgetManager: <span class="hljs-type">AppWidgetManager</span>,
        appWidgetIds: <span class="hljs-type">IntArray</span>
    )</span></span> {<font></font>
        injector.openScope(<span class="hljs-keyword">this</span>, *arrayOf(<span class="hljs-keyword">this</span>))
        <span class="hljs-comment">// update each of the widgets with the remote adapter</span><font></font>
        appWidgetIds<font></font>
            .forEach {<font></font>
                updateWidget(context, appWidgetManager, it)<font></font>
          }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami sedang menulis pembaruan untuk setiap instance widget kami.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateWidget</span><span class="hljs-params">(
        context: <span class="hljs-type">Context</span>,
        appWidgetManager: <span class="hljs-type">AppWidgetManager</span>,
        appWidgetId: <span class="hljs-type">Int</span>
    )</span></span> {
<span class="hljs-comment">// remoteViews   widgetId</span>
        <span class="hljs-keyword">val</span> remoteViews = RemoteViews(<font></font>
            context.packageName,<font></font>
            R.layout.app_widget_layout<font></font>
...<font></font>
<span class="hljs-comment">//        </span><font></font>
...<font></font>
<span class="hljs-comment">//    remoteViews</span><font></font>
updateRemoteAdapter(context, remoteViews, appWidgetId)<font></font>
 <font></font>
<span class="hljs-comment">//   remoteViews </span><font></font>
appWidgetManager.updateAppWidget(appWidgetId, remoteViews)<font></font>
<span class="hljs-comment">// collection view  </span><font></font>
appWidgetManager.notifyAppWidgetViewDataChanged(<font></font>
            appWidgetId,<font></font>
            R.id.lvWidgetItems<font></font>
        )<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Memperbarui adaptor.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateRemoteAdapter</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, remoteViews: <span class="hljs-type">RemoteViews</span>, appWidgetId: <span class="hljs-type">Int</span>)</span></span> {
<span class="hljs-comment">//   RemoteViewsService   RemoteAdapter   </span>
        <span class="hljs-keyword">val</span> adapterIntent = Intent(context, StolotoAppWidgetRemoteViewsService::<span class="hljs-keyword">class</span>.java).apply {<font></font>
            putExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, appWidgetId)<font></font>
        }<font></font>
        remoteViews.setRemoteAdapter(R.id.lvWidgetItems, adapterIntent)<font></font>
// actionIntent  pendingIntent      <font></font>
        <span class="hljs-keyword">val</span> actionIntent = Intent(context, StolotoAppWidgetProvider::<span class="hljs-keyword">class</span>.java).apply {<font></font>
            action = WIDGET_CLICK_ACTION<font></font>
            putExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, appWidgetId)<font></font>
        }<font></font>
        <span class="hljs-keyword">val</span> pendingIntent = PendingIntent.getBroadcast(<font></font>
            context, <span class="hljs-number">0</span>, actionIntent,<font></font>
            PendingIntent.FLAG_UPDATE_CURRENT<font></font>
        )<font></font>
<span class="hljs-comment">// pendingIntent      </span><font></font>
        remoteViews.setPendingIntentTemplate(R.id.lvWidgetItems, pendingIntent)<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menulis implementasi layanan kami. </font><font style="vertical-align: inherit;">Di dalamnya, penting bagi kami untuk menunjukkan implementasi antarmuka RemoteViewsService mana yang digunakan untuk menghasilkan konten.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StolotoAppWidgetRemoteViewsService</span> : <span class="hljs-type">RemoteViewsService</span></span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onGetViewFactory</span><span class="hljs-params">(intent: <span class="hljs-type">Intent</span>)</span></span>: RemoteViewsFactory =<font></font>
        StolotoAppWidgetRemoteViewsFactory(<font></font>
            <span class="hljs-keyword">this</span>.applicationContext,<font></font>
            intent<font></font>
        )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini sebenarnya adalah pembungkus tipis di atas Adaptor. </font><font style="vertical-align: inherit;">Berkat dia, kami dapat mengaitkan data kami dengan tampilan pengumpulan jarak jauh. </font><font style="vertical-align: inherit;">RemoteViewsFactory menyediakan metode untuk menghasilkan RemoteViews untuk setiap item dalam dataset. </font><font style="vertical-align: inherit;">Konstruktor tidak memiliki persyaratan - semua yang saya lakukan adalah melewati konteks di dalamnya. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikutnya, beberapa kata tentang metode utama:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onCreate - membuat adaptor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getLoadingView - metode ini menyarankan untuk mengembalikan View, yang akan ditampilkan oleh sistem alih-alih daftar item saat sedang dibuat. </font><font style="vertical-align: inherit;">Jika Anda tidak membuat apa pun di sini, maka sistem menggunakan beberapa Tampilan default.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getViewAt - metode ini menyarankan untuk membuat item daftar. </font><font style="vertical-align: inherit;">Di sinilah standar penggunaan RemoteViews.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onDataSetChanged dipanggil ketika permintaan diterima untuk memperbarui data dalam daftar. </font><font style="vertical-align: inherit;">Itu </font><font style="vertical-align: inherit;">Dalam metode ini, kami menyiapkan data untuk daftar. </font><font style="vertical-align: inherit;">Metode ini dipertajam dengan eksekusi kode yang panjang dan berat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onDestroy dipanggil ketika daftar terakhir yang digunakan adaptor dihapus (satu adaptor dapat digunakan oleh beberapa daftar).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RemoteViewsFactory hidup ketika semua instance daftar masih hidup, jadi kami dapat menyimpan data saat ini di dalamnya, misalnya, daftar item saat ini.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapkan daftar data yang akan kami tampilkan:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> widgetItems = ArrayList&lt;WidgetItem&gt;()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat membuat adaptor, kami mulai memuat data. </font><font style="vertical-align: inherit;">Di sini Anda dapat dengan aman melakukan tugas-tugas sulit, termasuk berjalan dengan tenang ke jaringan yang menghalangi arus.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {<font></font>
        updateDataSync()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat memanggil perintah untuk memperbarui data, kami juga memanggil updateDataSync ()</font></font><br>
<br>
<pre><code class="kotlin hljs">   <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDataSetChanged</span><span class="hljs-params">()</span></span> {<font></font>
        updateDataSync()<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di dalam updateDataSync, semuanya juga sederhana. </font><font style="vertical-align: inherit;">Kami menghapus daftar item saat ini. </font><font style="vertical-align: inherit;">Unduh profil dan data permainan.</font></font><br>
<br>
<pre><code class="kotlin hljs"> <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateDataSync</span><span class="hljs-params">()</span></span> {<font></font>
        widgetItems.clear()<font></font>
        updateProfileSync()<font></font>
        updateGamesSync()<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lebih menarik di sini</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateProfileSync</span><span class="hljs-params">()</span></span> {</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena penting bagi kami untuk menampilkan profil hanya kepada pengguna yang berwenang, kami perlu mengunduh informasi profil hanya dalam kasus ini:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> isUserFullAuth = isUserFullAuthInteractor<font></font>
            .execute()<font></font>
            .blockingGet()<font></font>
        <span class="hljs-keyword">if</span> (isUserFullAuth) {
            <span class="hljs-keyword">val</span> profile = getWidgetProfileInteractor<font></font>
                .execute()<font></font>
                .onErrorReturn {<font></font>
                    WidgetProfile()<font></font>
<span class="hljs-comment">//           </span><font></font>
                }<font></font>
                .blockingGet()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Model WidgetProfile disusun dari sumber yang berbeda, sehingga logika tanda terima dan nilai defaultnya diatur sedemikian rupa sehingga nilai dompet negatif menunjukkan data atau masalah yang salah dengan tanda terima mereka. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk logika bisnis, kurangnya data dompet sangat penting, oleh karena itu, dalam kasus dompet yang salah, model profil tidak akan dibuat dan ditambahkan ke daftar item.</font></font><br>
<br>
<pre><code class="kotlin hljs">  <span class="hljs-keyword">if</span> (profile.walletAmount &gt;= <span class="hljs-number">0L</span>) {<font></font>
                widgetItems.add(<font></font>
                    WidgetItem.Profile(<font></font>
                        wallet = profile.walletAmount.toMoneyFormat(),<font></font>
                        waitingTickets = <span class="hljs-keyword">if</span> (profile.waitingTicketsCount &gt;= <span class="hljs-number">0</span>) profile.waitingTicketsCount.toString() <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>,<font></font>
                        unpaidPrizeAmount = <span class="hljs-keyword">if</span> (profile.unpaidPrizeAmount &gt;= <span class="hljs-number">0</span>) profile.unpaidPrizeAmoount.toMoneyFormat() <span class="hljs-keyword">else</span> <span class="hljs-string">""</span><font></font>
                    )<font></font>
                )<font></font>
            }<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metode updateGamesSync () menggunakan getWidgetGamesInteractor dan menambahkan satu set game yang relevan dengan widget ke daftar widgetItems. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum melanjutkan ke pembuatan kartu, pertimbangkan model WidgetItem lebih terinci. </font><font style="vertical-align: inherit;">Ini diimplementasikan melalui kelas tertutup kotlin, yang membuat model lebih fleksibel, dan bekerja dengannya lebih nyaman.</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">sealed</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WidgetItem</span> </span>{<font></font>
 <font></font>
    <span class="hljs-keyword">data</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Profile</span></span>(
        <span class="hljs-keyword">val</span> wallet: String,
        <span class="hljs-keyword">val</span> waitingTickets: String,
        <span class="hljs-keyword">val</span> unpaidPrizeAmount: String<font></font>
    ) : WidgetItem()<font></font>
 <font></font>
    <span class="hljs-keyword">data</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Game</span></span>(
        <span class="hljs-keyword">val</span> id: String,
        <span class="hljs-keyword">val</span> iconId: <span class="hljs-built_in">Int</span>,
        <span class="hljs-keyword">val</span> prizeValue: String,
        <span class="hljs-keyword">val</span> date: String<font></font>
    ) : WidgetItem()<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat RemoteViews dan tentukan respons mereka melalui FillInIntent</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewAt</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: RemoteViews {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (<span class="hljs-keyword">val</span> item = widgetItems[position]) {
            <span class="hljs-keyword">is</span> WidgetItem.Profile -&gt; {<font></font>
              RemoteViews(<font></font>
                        context.packageName,<font></font>
                        R.layout.item_widget_user_profile<font></font>
                    ).apply {<font></font>
                        setTextViewText(R.id.tvWidgetWalletMoney, item.wallet)<font></font>
                        setTextViewText(R.id.tvWidgetUnpaidCount, item.unpaidPrizeAmount)<font></font>
                        setTextViewText(R.id.tvWidgetWaitingCount, item.waitingTickets)<font></font>
                        setOnClickFillInIntent(<font></font>
                            R.id.llWidgetProfileWallet, Intent().putExtra(<font></font>
                                StolotoAppWidgetProvider.KEY_PROFILE_OPTIONS,<font></font>
                                StolotoAppWidgetProvider.VALUE_USER_WALLET<font></font>
                            )<font></font>
                        )<font></font>
                        setOnClickFillInIntent(<font></font>
                            R.id.llWidgetProfileUnpaid, Intent().putExtra(<font></font>
                                StolotoAppWidgetProvider.KEY_PROFILE_OPTIONS,<font></font>
                                StolotoAppWidgetProvider.VALUE_UNPAID_PRIZE<font></font>
                            )<font></font>
                        )<font></font>
                        setOnClickFillInIntent(<font></font>
                            R.id.llWidgetProfileWaiting, Intent().putExtra(<font></font>
                                StolotoAppWidgetProvider.KEY_PROFILE_OPTIONS,<font></font>
                                StolotoAppWidgetProvider.VALUE_WAITING_TICKETS<font></font>
                            )<font></font>
                        )<font></font>
                    }<font></font>
 <font></font>
            <span class="hljs-keyword">is</span> WidgetItem.Game -&gt; {<font></font>
                RemoteViews(<font></font>
                    context.packageName,<font></font>
                    R.layout.item_widget_game<font></font>
                ).apply {<font></font>
                    setImageViewResource(R.id.ivWidgetGame, item.iconId)<font></font>
                    setTextViewText(R.id.tvWidgetGamePrize, item.prizeValue)<font></font>
                    setTextViewText(R.id.tvWidgetGameDate, item.date)<font></font>
                    setOnClickFillInIntent(<font></font>
                        R.id.llWidgetGame, Intent().putExtra(<font></font>
                            StolotoAppWidgetProvider.KEY_GAME_CLICK, item.id<font></font>
                        )<font></font>
                    )<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metode setOnClickFillInIntent menetapkan maksud viewId yang ditentukan, yang akan dikombinasikan dengan induk PendingIntent untuk menentukan perilaku ketika mengklik pada tampilan dengan viewId ini. </font><font style="vertical-align: inherit;">Dengan cara ini kami dapat menanggapi klik pengguna di WidgetProvider kami.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pembaruan widget manual</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Waktu pembaruan setengah jam ditetapkan untuk widget kami. Anda dapat memperbaruinya lebih sering, misalnya, melalui menari dengan WorkManager, tetapi mengapa memuat jaringan dan baterai Anda? Perilaku seperti itu pada tahap awal pengembangan tampak memadai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya berubah ketika "bisnis" memperhatikan bahwa ketika pengguna melihat widget, data yang tidak relevan ditampilkan di atasnya: "Di sini di iPhone saya, saya membuka widget dan ada data segar paling profil saya." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Situasinya biasa: iOS menghasilkan kartu baru untuk SETIAP tampilan widget, karena untuk ini mereka memiliki layar khusus, dan Android pada dasarnya tidak memiliki acara untuk widget tersebut. Saya harus memperhitungkan bahwa beberapa lotere diadakan setiap 15 menit sekali, jadi widget harus memberikan informasi terkini - Anda ingin berpartisipasi dalam beberapa jenis undian, tetapi sudah terlewati.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk keluar dari situasi yang tidak menyenangkan ini dan menyelesaikan masalah dengan memperbarui data, saya mengusulkan dan menerapkan solusi yang telah teruji oleh waktu - tombol "perbarui". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambahkan tombol ini ke tata letak tata letak dengan daftar dan inisialisasi perilakunya ketika updateWidget dipanggil.</font></font><br>
<br>
<pre><code class="kotlin hljs">...
<span class="hljs-comment">// Intent   AppWidgetManager.ACTION_APPWIDGET_UPDATE</span>
<span class="hljs-keyword">val</span> intentUpdate = Intent(context, StolotoAppWidgetProvider::<span class="hljs-keyword">class</span>.java)<font></font>
intentUpdate.action = AppWidgetManager.ACTION_APPWIDGET_UPDATE<font></font>
<font></font>
//    <font></font>
<span class="hljs-keyword">val</span> ids = AppWidgetManager.getInstance(context)<font></font>
   .getAppWidgetIds(ComponentName(context, StolotoAppWidgetProvider::<span class="hljs-keyword">class</span>.java))<font></font>
intentUpdate.putExtra(AppWidgetManager.EXTRA_APPWIDGET_IDS, ids)<font></font>
<font></font>
//  intent  PendingIntent,  PendingIntent.getBroadcast()<font></font>
<span class="hljs-keyword">val</span> pendingUpdate = PendingIntent.getBroadcast(<font></font>
   context,<font></font>
   appWidgetId,<font></font>
   intentUpdate,<font></font>
   PendingIntent.FLAG_UPDATE_CURRENT<font></font>
)<font></font>
//  pendingIntent      ‘’<font></font>
remoteViews.setOnClickPendingIntent(R.id.ivWidgetRefresh, pendingUpdate)<font></font>
…</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perkembangan pertama menunjukkan gambar yang menyedihkan: dari menekan tombol "perbarui" ke pembaruan aktual, beberapa detik bisa berlalu. </font><font style="vertical-align: inherit;">Meskipun widget dihasilkan oleh aplikasi kita, sebenarnya widget itu berada di bawah kendali sistem dan berkomunikasi dengan aplikasi kita melalui siaran. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu </font><font style="vertical-align: inherit;">ketika Anda mengklik tombol "perbarui" widget kami, rantai dimulai:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dapatkan Intent di 'aksi' penyedia onReceive.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AppWidgetManager.ACTION_APPWIDGET_UPDATE. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panggil Update untuk semua widget yang ditentukan dalam niat-e.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Online untuk data baru.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refresh data lokal dan tampilkan kartu daftar baru.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, memperbarui widget tidak terlihat bagus, karena dengan mengklik tombol kami melihat widget yang sama selama beberapa detik. </font><font style="vertical-align: inherit;">Tidak jelas apakah data diperbarui. </font><font style="vertical-align: inherit;">Bagaimana mengatasi masalah respons visual? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, saya menambahkan bendera isWidgetLoading dengan akses global melalui interaktor. </font><font style="vertical-align: inherit;">Peran parameter ini cukup sederhana - jangan tampilkan tombol segarkan saat data widget dimuat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kedua, saya membagi proses pemuatan data di pabrik menjadi tiga tahap:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">enum</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadingStep</span> </span>{<font></font>
   START,<font></font>
   MIDDLE,<font></font>
   END<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MULAI - mulai mengunduh. </font><font style="vertical-align: inherit;">Pada tahap ini, keadaan semua tampilan adaptor dan bendera unduhan global berubah menjadi "memuat". </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TENGAH - tahap pemuatan data utama. </font><font style="vertical-align: inherit;">Setelah diunduh, bendera unduhan global diletakkan dalam status "dimuat", dan data yang diunduh ditampilkan di adaptor. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AKHIR - akhir unduhan. </font><font style="vertical-align: inherit;">Adaptor tidak perlu mengubah data adaptor pada langkah ini. </font><font style="vertical-align: inherit;">Langkah ini diperlukan untuk memproses tahapan pembaruan tampilan dengan benar di WidgetProvider. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat lebih detail seperti apa tampilan tombol di provider:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">if</span> (isFullAuthorized &amp;&amp; !widgetLoadingStateInteractor.isWidgetLoading) {<font></font>
   remoteViews.setViewVisibility(R.id.ivWidgetRefresh, View.VISIBLE)<font></font>
...<font></font>
<span class="hljs-comment">//     ,    </span><font></font>
...   <font></font>
} <span class="hljs-keyword">else</span> {<font></font>
   remoteViews.setViewVisibility(<font></font>
       R.id.ivWidgetRefresh,<font></font>
       <span class="hljs-keyword">if</span> (isFullAuthorized) View.INVISIBLE <span class="hljs-keyword">else</span> View.GONE <span class="hljs-comment">//       .</span><font></font>
   )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang mari kita lihat apa yang terjadi di adaptor:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateDataSync</span><span class="hljs-params">()</span></span> {
   <span class="hljs-keyword">when</span> (loadingStep) {<font></font>
       START -&gt; {<font></font>
           widgetItems.forEach { it.isLoading = <span class="hljs-literal">true</span> }<font></font>
           widgetLoadingStateInteractor.isWidgetLoading = <span class="hljs-literal">true</span><font></font>
           loadingStep = MIDDLE<font></font>
           widgetManager.updateWidgets()<font></font>
       }<font></font>
       MIDDLE -&gt; {<font></font>
           widgetItems.clear()<font></font>
           updateProfileSync()<font></font>
           updateGamesSync()<font></font>
           widgetLoadingStateInteractor.isWidgetLoading = <span class="hljs-literal">false</span><font></font>
           loadingStep = END<font></font>
           widgetManager.updateWidgets()<font></font>
       }<font></font>
       END -&gt; {<font></font>
           loadingStep = START<font></font>
       }<font></font>
   }<font></font>
}</code></pre><br>
<img src="https://habrastorage.org/webt/bq/ah/hg/bqahhgnwugy10345-bcegnupxo8.png" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Logika kerja: </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di akhir langkah MULAI dan TENGAH, saya memanggil metode updateWidgets untuk memperbarui kondisi tampilan yang dikelola oleh penyedia.</font></font></li>
<li>   START     «»   ,    MIDDLE.</li>
<li>         MIDDLE,    «».</li>
<li>   MIDDLE,          END. </li>
<li>      ,   END,    «».        ,    END   loadingStep  START.</li>
</ol><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan bantuan implementasi seperti itu, saya mencapai kompromi antara persyaratan "bisnis" untuk melihat data yang relevan pada widget dan kebutuhan untuk "menarik" pembaruan terlalu sering. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semoga artikel ini bermanfaat bagi Anda. </font><font style="vertical-align: inherit;">Jika Anda memiliki pengalaman membuat widget untuk Android, maka beri tahu kami tentang hal itu di komentar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semoga berhasil</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id492150/index.html">Terapkan sepenuhnya. Di-in-js</a></li>
<li><a href="../id492154/index.html">Peluncuran ExoMars tertunda ke jendela peluncuran berikutnya pada tahun 2022</a></li>
<li><a href="../id492156/index.html">Dikurangkan. Ingin. Melakukan</a></li>
<li><a href="../id492162/index.html">Antarmuka Mata. Laporkan dalam Yandex</a></li>
<li><a href="../id492164/index.html">Gerbang menuju langit, atau kota masa depan</a></li>
<li><a href="../id492168/index.html">Pekerjaan depan pada pengembangan backend portal terbesar pada perangkat lunak open source: berbagi pengalaman</a></li>
<li><a href="../id492172/index.html">Cadangan tipis sistem file Linux. Cara membuat salinan kerja dari DBMS MySQL tiga terabyte dalam 20 detik</a></li>
<li><a href="../id492174/index.html">Monitor Kelembaban Tanah DIY Nirkabel</a></li>
<li><a href="../id492178/index.html">Jalur tujuh ribu piksel: evolusi resolusi monitor dan persyaratan kami</a></li>
<li><a href="../id492182/index.html">Dasar-dasar Keamanan Informasi di Tim Microsoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>