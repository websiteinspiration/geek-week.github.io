<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙏 🌲 🕚 OdnoklassnikiでのAndroidテストのスケーリング 🌉 😅 👨🏼‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは！私の名前はロマン・イヴァニツキーです。私はオドノクラスニキテスト自動化チームで働いています。 OKは7000万人以上のユーザーがいる巨大なサービスです。モバイルデバイスについて話す場合、大多数はAndroidを実行しているスマートフォンでOK.RUを使用しています。このため、Androi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>OdnoklassnikiでのAndroidテストのスケーリング</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/497726/"><img src="https://habrastorage.org/webt/dp/ei/lm/dpeilmobnwcglrby0p_rtptmgv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こんにちは！私の名前はロマン・イヴァニツキーです。私はオドノクラスニキテスト自動化チームで働いています。 OKは7000万人以上のユーザーがいる巨大なサービスです。モバイルデバイスについて話す場合、大多数はAndroidを実行しているスマートフォンでOK.RUを使用しています。このため、Androidアプリケーションのテストには非常に真剣に取り組んでいます。この記事では、私たちの会社における自動テストの開発のストーリーをお伝えします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012年、オドノクラッシニキは、ユーザー数の積極的な増加とユーザー機能の数の増加を経験しています。</font><font style="vertical-align: inherit;">ビジネス目標を達成するために、リリースサイクルを短縮する必要がありましたが、これはすべての機能が手動でテストされたという事実によって妨げられました。</font><font style="vertical-align: inherit;">この問題の解決策はそれ自体で生まれました-自動テストが必要です。</font><font style="vertical-align: inherit;">したがって、2012年にOdnoklassnikiにテスト自動化チームが現れ、最初のステップはテストの作成を開始することでした。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ちょっとした歴史</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odnoklassnikiでの最初の自動テストはSeleniumで書かれました。その発売により、Jenkins、Selenium GridとSelenium Hub、およびSelenium Nodeのセットが発生しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クイックソリューション、クイックスタート、クイック収益-完璧。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時間の経過とともに、テス​​トの数が増加し、補助サービス（起動サービス、レポートサービス、テストデータサービスなど）が登場しました。 2014年末までに、約15〜20分で1000回のテストが行​​われました。これは、テストの数が増えることは明らかであり、テストの実行にかかる時間が増えるため、私たちには適していませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当時、自動テストインフラストラクチャは次のようになっています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/ou/7s/2qou7sruwzlvihxfhhq2fdcd9qm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、Seleniumノードの量が200以上の場合、ハブは負荷に対応できませんでした。</font><font style="vertical-align: inherit;">現在、この問題はすでに研究されており、そのため、Zaleniumなどのツールや、誰もがお気に入りのSelenoidが登場しました。</font><font style="vertical-align: inherit;">しかし、2014年には標準的なソリューションがなかったため、独自のソリューションを作成することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスが満たす必要のある最小要件を定義しました。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケーラビリティ。</font><font style="vertical-align: inherit;">Selenium Hubの制限に依存したくありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安定。</font><font style="vertical-align: inherit;">2014年、Selenium Hubは安定した動作で有名ではありませんでした。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォールトトレランス。</font><font style="vertical-align: inherit;">データセンターやサーバーに障害が発生した場合でも、テストプロセスを継続できる必要があります。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、コーディネーターとノードマネージャーで構成されるSelenium Gridをスケーリングするためのソリューションが登場しました。これは外見上、標準のSelenium Gridと非常に似ていますが、独自の機能を備えています。</font><font style="vertical-align: inherit;">これらの機能については、後で詳しく説明します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コーディネーター</font></font></h3><br>
<img src="https://habrastorage.org/webt/s0/gu/ib/s0guibehaq2q0zpa5vi40jc9un4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、これはリソースブローカーです（リソースはブラウザーとして理解されます）。テストにはリソースのリクエストを送信するための外部APIがあります。これらのクエリは、実行するタスクとしてデータベースに保存されます。コーディネーターは、クラスターの構成に関するすべてを知っています-どのノードマネージャーが存在するか、これらのノードマネージャーが提供できるリソースのタイプ、リソースの総数、タスクに現在関与しているリソースの数。同時に、彼はリソースを監視します-活動、安定性、そしてその場合責任者に通知します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コーディネーターの機能は、すべてのノードマネージャーをいわゆるファームに統合することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがファームの外観です。リソースの半分以上が使用されており、すべてのノードがオンラインです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/ar/ib/tiariberzr9rt2lpau2vfohpcoa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードをオフラインで表示したり、特定の割合でローテーションに入れたりすることもできます。これは、特定のノードの負荷を減らす必要がある場合に必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各ファームは、サービスと呼ばれる論理ユニットで他のファームと組み合わせることができます。同時に、1つのファームを複数の異なるサービスに含めることができます。まず、制限を設定し、各特定のサービスが使用するリソースに優先順位を付けることができます。 2つ目は、構成を簡単に管理できることです。サービスにオンザフライでノードマネージャーの数を追加したり、構成から更新などのノードマネージャーとやり取りできるように、それらをファームから削除したりすることができます。 。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/rj/fc/wvrjfcs7gh4e3fsf6kjloe1uh_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コーディネーターのAPIは非常に単純です。現在使用されているリソースの量に対してサービスをリクエストし、その制限を取得して、一部のリソースを開始または停止することができます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノードマネージャー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、コーディネーターからタスクを受け取り、必要に応じていくつかのリソースを起動するという2つのことをうまく実行できるサービスです。</font><font style="vertical-align: inherit;">デフォルトでは、リソースの起動ごとに分離されるように設計されています。つまり、以前の起動が後続のテストの起動に影響を与えることはありません。</font><font style="vertical-align: inherit;">応答として、コーディネーターは一連のホストと1組の上げられたポートを使用します。</font><font style="vertical-align: inherit;">たとえば、Seleniumサーバーが起動されたホストとそのポート。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p8/xa/43/p8xa43yokgfpxyumwpmagx4ilpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストでは、次のようになります。ノードマネージャサービスが実行されており、リソースライフサイクル全体を管理します。</font><font style="vertical-align: inherit;">彼はブラウザを拾い上げて完成させ、閉じるのを忘れないようにしています。</font><font style="vertical-align: inherit;">相互の分離を保証するために、これはすべてサービスユーザーに代わって行われます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インタラクション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストは、上記のインフラストラクチャと次のように相互作用します。必要なリソースのリクエストでコーディネーターに対処し、コーディネーターはこのタスクを実行が必要なものとして保存します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ノードマネージャーはタスクコーディネーターに切り替えます。タスクを受け取ると、彼はリソースを開始します。その後、彼はコーディネーターに起動の結果を送信し、失敗した起動もコーディネーターに報告されます。テストはリソース要求の結果を受け取り、成功した場合、リソースの直接操作を開始します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/np/sf/fenpsf31k75tnpnxgwtw5mjymro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチの利点は、リソースを直接操作できるようになるため、コーディネーターの負荷を軽減できることです。短所-コーディネーターとの相互作用のロジックをテストフレームワーク内に実装する必要がありますが、これは許容されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、3つのデータセンターで800を超えるブラウザーを並行して実行できます。</font><font style="vertical-align: inherit;">コーディネーターにとって、これは制限ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォールトトレランスは、さまざまなデータセンターのDNSファイアウォールの背後にある複数のコーディネーターインスタンスの起動によって保証されます。</font><font style="vertical-align: inherit;">これにより、データセンターまたはサーバーに問題が発生した場合に、作業インスタンスへのアクセスが保証されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、最初に設定されたすべての要件を満たすソリューションが得られました。</font><font style="vertical-align: inherit;">2015年から着実に稼働しており、その効果は実証済みです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アンドロイド</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Androidでのテストに関しては、通常2つの主要なアプローチがあります。 1つはWebDriverを使用することです。これがSelendroidとAppiumの動作方法です。 2つ目は、ネイティブツールを使用して、Robotium、UI Automator、またはEspressoを実装したことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのアプローチの基本的な類似点は、デバイスとブラウザを取得することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに多くの違いがありますが、主なものは、テスト済みのAPKをインストールする必要があることです。これにより、ログ、スクリーンショットなどの形式でアーティファクトを取得します。また、テストはCIではなくデバイス自体で実行されるという事実。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2015年、OdnoklassnikiはAndroidアプリケーションを自動テストでカバーするようになりました。 Linuxマシンを1つ選択し、USB経由で実際のデバイスを1つ接続して、Robotiumでテストの作成を開始しました。このシンプルなソリューションにより、すばやく結果を得ることができました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時間の経過とともに、テス​​トの数とデバイスの数は増加しました。管理タスクを解決するために、デバイスマネージャーが作成されました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-adb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（Android Debug Bridge）コマンドの</font><font style="vertical-align: inherit;">ラッパーで</font><font style="vertical-align: inherit;">、http apiインターフェースがそれらを実行できるようにします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがデバイスマネージャーの最初のAPIの外観です。その助けを借りて、デバイスのリストの取得、APKのインストール/アンインストール、テストの実行、結果の取得を行うことができます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/j5/pc/raj5pcnmij6_km7w1zla73xzix4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、複数のデバイスが接続されているADBサーバーでは、起動時にテスト結果が低下することがわかりました。安定性の向上に役立つソリューションは、Dockerを使用して各ADBサーバーを分離することで見つかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファームの準備ができました-電話を接続できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/lh/gr/rblhgrqkdhtp6xgue6ysjzkjcx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの人がこの写真に精通しています。 Androidファームに従事していると、毎日地獄にいるようだと聞きました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/lo/sh/ybloshbgsavgewkhufosue3gqzi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Androidエミュレータが助けになりました。その使用は2つの要因によるものでした。1つ目は、その時点ですでに必要なレベルの安定性に達していたこと、もう1つは、テストで特に鉄に依存する機能がないことです。さらに、このエミュレータは当時の既存のインフラストラクチャに適切に投影されていました。次のステップは、ノードマネージャに新しいタイプのリソースを起動するように教えることでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Androidエミュレーターを実行するには何が必要ですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、一連のユーティリティを備えたAndroid SDKが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、AVD-Android Virtual Device-を作成する必要があります。これは、Androidエミュレーターの構成方法、それが持つアーキテクチャー、使用するコアの数、Googleサービスを利用できるかどうかなどです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/az/6e/gtaz6ejxanl2ppil-8niyzhkvjc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、作成したAVDの名前を選択し、パラメーターを設定します。たとえば、ADBを起動するポートを転送して開始する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、このようなスキームには特殊性があります。システムでは、1つの特定のAVDで1つのインスタンスエミュレータのみを実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題の解決策は、メモリに格納されている基本的なAVDを作成することでした。これにより、別の場所にコピーすることが可能になりました。</font><font style="vertical-align: inherit;">Androidエミュレーターの起動中に、ベースAVDがメモリにマップされた一時ディレクトリにコピーされ、その後起動しました。</font><font style="vertical-align: inherit;">このようなスキームはすぐに機能しましたが、面倒でした。</font><font style="vertical-align: inherit;">これまでのところ、この問題は読み取り専用オプションによって解決されており、1つのAVDから無制限の数量でAndroidエミュレーターを実行できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AVDを使用した結果に基づいて、いくつかの社内推奨事項を作成しました。</font></font><br>
<br>
<ol>
<li>  86  ,  ARM  .     dev/kvm  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Linux  HAXM-  Mac  Windows</a></li>
<li>GPU-  .     ,    .  ,          ,   ,    Android-  </li>
<li> .       </li>
<li>   ,         localhost,        </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AndroidでテストするDockerイメージについては、AgodaとSelenoidを強調したいのですが、それらはAndroidエミュレーターの機能を最大限に利用しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それらの違いは、デフォルトのSelenoidには</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Agodaがあり、「クリーン」エミュレータを使用していることです。さらに、Selenoidには、より多くのコミュニティサポートがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2018年末にCloudNode-Managerが作成され、コーディネーターに連絡してタスクを受け取り、クラウド内のコマンドを使用して起動されます。アイアンマシンの代わりに、このサービスは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1クラウドの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースを使用します</font><font style="vertical-align: inherit;">-Odnoklassniki独自のプライベートクラウド。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DeviceManagerにコーディネーターとの連携方法を教えることで、スケーリングを達成することができました。これを行うには、デバイスマネージャーAPIを変更して、デバイスタイプ（仮想/実数）を要求する機能を追加する必要がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、1台のマシンから250台のエミュレータでADBインストールを実行しようとした場合に起こります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/ab/td/lkabtdmlsx7-1x6ne200l5jgi10.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アテンダントはすぐにこれに反応し、インシデントを開始しました-マシンは発信トラフィックでギガビットネットワークインターフェイスをロードしました。この複雑さは、サーバーのスループットを増やすことで解決されました。この問題で大変なことになったとは言えませんが、忘れてはいけません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
成功は、デバイスマネージャー、コーディネーター、スケーリングであると思われます。ファーム全体でテストを実行できます。原則として、プルリクエストごとに実行でき、開発者はすぐにフィードバックを受け取ります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uk/zl/l_/ukzll_cniqi00nxoiy67osju6do.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、すべてがそれほどバラ色ではありません。これまでのところ、テストの品質について何も言われていないことに気づいたかもしれません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/he/4k/srhe4kzvbock0mcztvh88d2s_98.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが私たちの打ち上げの様子です。そして最も興味深いのは、発売の間に完全に異なるテストが当てはまる可能性があるということです。これらは不安定な滝でした。そして、私も開発者もテスターもこれらの結果を信頼していませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題にどのように対処しましたか？彼らはRobotiumからEspressoにすべてをコピーしただけで、それは良くなりました...実際、違います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を解決するために、Espressoですべてを書き直しただけでなく、写真のアップロード、投稿の作成、友達への追加など、あらゆる種類のアクションにAPIの使用を開始し、すばやくログイン</font><font style="vertical-align: inherit;">し、希望の画面に直接移動できる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディップリンク</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">まし</font></a><font style="vertical-align: inherit;">た、そしてもちろん、すべてのテストケースを分析しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストの実行は次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/zg/lo/m2zglocfnlq8e31pgwew1czj-ic.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
赤いテストが残っていることに気付くかもしれませんが、これらは本番環境で実行されるエンドツーエンドのテストであることを覚えておくことが重要です。アプリケーションのメインブランチに含めることができるテストの数には制限があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで安定したテストとスケーリングができました。ただし、テストインフラストラクチャは依然としてテストに強く結びついています。同時に、エンドツーエンドのテストが期待されているため、CIはビジーであり、他のアセンブリはキューに入れられ、空きエージェントを待機しています。さらに、並列開始を処理するための明確なスキームはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の理由は、QueueRunner（CIをブロックせずにテストを非同期で実行できるサービス）の開発の原動力となりました。</font><font style="vertical-align: inherit;">動作するには、テストとテストAPK、および一連のテストが必要です。</font><font style="vertical-align: inherit;">必要なデータを受け取ったら、実行の実行をキューに整理し、必要なリソースを割り当てて解放することができます。</font><font style="vertical-align: inherit;">QueueRunnerは実行結果をJiraとStashにダウンロードし、メールとメッセンジャーで送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunnerにはテストフローがあり、テストのライフサイクルを監視します。</font><font style="vertical-align: inherit;">現在使用しているデフォルトのフローは、5つのステップで構成されています。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">受信デバイス。</font><font style="vertical-align: inherit;">この時点で、Devicemanagerはコーディネーターを介して実デバイスまたは仮想デバイスを要求します。</font></font></li>
<li> .        APK  ,    –  ,           .</li>
<li>,      </li>
<li> </li>
<li>    </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、5つの簡単なステップが、サービスのテストライフサイクル全体になります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ke/pd/yg/kepdyglhyclwq8ogfg4thqparxy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunnerにはどのようなメリットがありますか？まず、すべての可能なリソースを最大限に使用します。ファーム全体にスケーリングして、すばやく結果を得ることができます。次に、ボーナスで、テストのシーケンスを制御する機会を得ました。たとえば、最初に最も長いテストまたは最も問題のあるテストを実行して、テストの実行を待つ時間を短縮できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunnerでは、スマートな再トレイを作成することもできます。すべてのデータをデータベースに保存しているため、いつでもテストの履歴を確認できます。たとえば、テストの成功と失敗の比率を確認し、原則としてテストを再開する価値があるかどうかを判断できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunnerとDevicemanagerにより、リソースの量に適応できるようになりました。エミュレータを使用することで、ファーム全体にスケーリングできるようになりました。つまり、ほぼ無制限の数の仮想デバイスで、さらに多くのテストを実行する機会が得られましたが、何らかの理由でリソースが利用できない場合、サービスはそれらが返ってくるのを待ち、起動の損失はありません。私たちは利用可能なリソースのみを使用するため、しばらくしても結果は得られますが、CIはブロックされません。そして最も重要なのは、テストインフラストラクチャとテストが分離されたことです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Androidでテストを実行するには、テストAPKとテストのリストを提供する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、仮想マシン上のSeleniumファームからクラウドでのAndroidテストの開始まで、長い道のりを歩んできました。</font><font style="vertical-align: inherit;">ただし、このパスはまだ完了していません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発工程</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストインフラストラクチャが開発プロセスとどのように関連しているか、そしてテスターと開発者がそれをどのように見ているかを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Androidチームは標準のGitFlowを使用しています。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rf/p9/ot/rfp9ot5imowggxpkdgyekbym2ao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各機能には独自のブランチがあります。主な開発は、開発ブランチで行われます。新しいスーパー機能を作成することを決定した開発者は、独自のブランチで開発を開始しますが、他の開発者は他のブランチで並行して作業できます。世界で最も美しく、最高のコードの準備ができており、できるだけ早くユーザーに公開する必要があると開発者が考えた場合、開発者はプルリクエストを作成し、ユニットが自動的に組み立てられ、ユニットテストとコンポーネントテストが実行されます。同時に、APKがアセンブルされてQueueRunnerに送信され、エンドツーエンドのテストが実行されます。その後、テストの実行結果が開発者に送られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、開発で機能ブランチを作成した後、多くのコミットが行われた可能性が高いです。</font><font style="vertical-align: inherit;">これは、開発が以前の状態ではない可能性があることを意味します。</font><font style="vertical-align: inherit;">したがって、最初にマージが発生します-開発を現在の機能ブランチにマージします。ビルド、ユニットテスト、コンポーネントテスト、エンドツーエンド、およびこれらの結果に基づいてレポートを作成するのは、この時期尚早な状態です。</font><font style="vertical-align: inherit;">したがって、開発の現在のバージョンで機能がどのように動作するかを理解し、問題がなければユーザーに送信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/qs/2m/ogqs2mqcef0dwn-lyaxugjzhrca.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">報告</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これがStashのレポートのようなものです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/61/7b/qi/617bqiddnqointrhxigp3g2o904.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボットは最初にテストが開始したことを書き込み、テストが合格するとメッセージを更新し、合格した数、落下した数、既知のエラーの数、およびフレーキーテストの数を追加します。彼は同じことをJiraで記述し、起動の比較へのリンクを追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、2つの起動の比較の様子です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/kf/62/likf62ljuom4erhqvkxvoq4o-li.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、機能ブランチの現在の実行が、開発の最後の実行と比較されます。これには、実行中のテストの数、マッチングの問題、ドロップされたテスト、ある状態で別の状態に切り替えられた不安定な不安定なテストに関する情報が含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少なくとも1つの単体テストまたはエンドツーエンドテストのしきい値を超えると、マージがブロックされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストが安定して落下するかどうかを理解するために、落下のトレーストレースのハッシュを比較します。それらが事前に桁をクリアされる前に、行番号のみが残ります。</font><font style="vertical-align: inherit;">ハッシュが一致する場合、これは同じ落下です。それらが異なる場合、おそらく落下は異なります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、インフラストラクチャに合わせて拡張できる安定したフォールトトレラントソリューションを実装しました。</font><font style="vertical-align: inherit;">次に、結果として得られたインフラストラクチャがAndroidテストに適合しました。</font><font style="vertical-align: inherit;">これには、実際のデバイスと仮想デバイスの両方を操作するのに役立つデバイスマネージャーと、インフラストラクチャとテストを分離し、テストの期間中CIをブロックしないのに役立つQueueRunnerが役立ちました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2016年の1週間のテスト実行時間のように見えました-50分以上から。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j9/0-/bk/j90-bkvotdp0g3zmlpphaskbmnu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが現在の外観です。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gi/0h/zy/gi0hzyeoygzkwphzp74vpph21q8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このグラフは、平均的な営業日の2時間に実行された実行を示しています。</font><font style="vertical-align: inherit;">実行時間は最大15分に短縮され、実行数は著しく増加しました。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja497700/index.html">4月17日からのバッキングとDevOps、セキュリティ、ロボットに関する毎週のオンラインmitap</a></li>
<li><a href="../ja497702/index.html">2020年に注目すべきデータストレージの5つのトレンド</a></li>
<li><a href="../ja497708/index.html">4月と5月に開催される一連の富士通ウェビナーにご参加ください</a></li>
<li><a href="../ja497714/index.html">macOSのプロセスとカーネル拡張を保護する方法</a></li>
<li><a href="../ja497724/index.html">PythonでWebアプリを公開するためのサーバーの準備</a></li>
<li><a href="../ja497728/index.html">チップを「燃やす」ことの危険性</a></li>
<li><a href="../ja497730/index.html">便利なBDD：SpecFlow + TFS</a></li>
<li><a href="../ja497736/index.html">10の新しい内燃機関のレビュー</a></li>
<li><a href="../ja497738/index.html">Swiftで自分をテストする：パズル愛好家のためのパズル</a></li>
<li><a href="../ja497740/index.html">自動車メーカーは、完全無人車両が登場するまでには非常に長い時間をかけると認めています</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>