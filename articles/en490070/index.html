<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∑üèº üçô üë©üèª‚Äçü§ù‚Äçüë®üèΩ As I wrote my messenger üíÄ üë®üèæ‚Äçüíº üßòüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One evening, after another frustrating day, filled with attempts to balance the game, I decided that I urgently needed a rest. I‚Äôll switch to another ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>As I wrote my messenger</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490070/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One evening, after another frustrating day, filled with attempts to balance the game, I decided that I urgently needed a rest. </font><font style="vertical-align: inherit;">I‚Äôll switch to another project, do it quickly, return the self-esteem that has rolled down during the development of the game, and I will take the game by storm with renewed vigor! </font><font style="vertical-align: inherit;">The main thing is to choose a nice and relaxing project ... Write your own messenger? </font><font style="vertical-align: inherit;">Ha! </font><font style="vertical-align: inherit;">How hard can it be? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><img src="https://habrastorage.org/webt/_b/cw/av/_bcwavbn-h0r3vgv8zzhdkaq09y.jpeg"></td>
<td><img src="https://habrastorage.org/webt/97/4x/qd/974xqd470ltfwu6gge0hfnaqry4.jpeg"></td>
</tr>
</tbody></table></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brief Background</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For almost a year before starting work on the messenger, he had been working on the online multiplayer Line Tower Wars game. </font><font style="vertical-align: inherit;">Programming went well, everything else (balance and visual in particular) was not very good. </font><font style="vertical-align: inherit;">Suddenly it turned out that making a game and making a fun game (fun for someone other than himself) are two different things. </font><font style="vertical-align: inherit;">After a year of ordeal, I needed to get distracted, so I decided to try my hand at something else. </font><font style="vertical-align: inherit;">The choice fell on mobile development, namely Flutter. </font><font style="vertical-align: inherit;">I heard a lot of good things about Flutter, and I liked the dart after a short experiment. </font><font style="vertical-align: inherit;">I decided to write my own messenger. </font><font style="vertical-align: inherit;">Firstly, it‚Äôs good practice to implement both client and server. </font><font style="vertical-align: inherit;">Secondly, there will be something significant to put in the portfolio to look for work, I'm just in the process.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scheduled Functionality</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Private and group chats</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending text, images and videos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audio and video calls</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirmation of receipt and reading (ticks from Votsap)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Prints ..."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Search by QR code and geolocation</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking ahead, I can proudly (and with relief) say that almost everything planned has been implemented, and that has not yet been implemented - will be implemented in the near future.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/393246625" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Language selection</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did not think for a long time with the choice of language. </font><font style="vertical-align: inherit;">At first, it was tempting to use the dart for both the client and the server, but a more detailed inspection showed that there are not many drivers for darts available, and those that are not inspire much confidence. </font><font style="vertical-align: inherit;">Although I will not vouch to talk about the current moment, the situation may have improved. </font><font style="vertical-align: inherit;">So my choice fell on C #, with which I worked in Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He started with thinking over architecture. </font><font style="vertical-align: inherit;">Of course, considering that 3 and a half people will most likely use my messenger, one would not have to bother with architecture in general. </font><font style="vertical-align: inherit;">You take and do as in countless tutorials. </font><font style="vertical-align: inherit;">Here is the node, here is the mongo, here are the web sockets. </font><font style="vertical-align: inherit;">Done. </font><font style="vertical-align: inherit;">And Firebase is around here. </font><font style="vertical-align: inherit;">But it‚Äôs not interesting. </font><font style="vertical-align: inherit;">I decided to make a messenger that can easily scale horizontally, as if I expect millions of simultaneous clients. </font><font style="vertical-align: inherit;">However, since I had no experience in this area, I had to learn everything in practice by the method of errors and again errors.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The final architecture looks like this</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/xp/jc/n7/xpjcn7otuw8am5jv9yztpp1sgyu.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I do not claim that such an architecture is super cool and reliable, but it is viable and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in theory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> should withstand heavy loads and scale horizontally, but I don‚Äôt really understand how to check. </font><font style="vertical-align: inherit;">And I hope that I did not miss some obvious moment that is known to everyone except me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below is a detailed description of the individual components.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frontend server</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even before I started making the game, I was fascinated by the concept of an asynchronous single-threaded server. </font><font style="vertical-align: inherit;">Effectively and without potential race'ov - what else can you ask for. </font><font style="vertical-align: inherit;">In order to understand how such servers are arranged, I began to delve into the </font></font><code>asyncio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">python language </font><font style="vertical-align: inherit;">module </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The solution I saw seemed very elegant. </font><font style="vertical-align: inherit;">In short, the pseudo-code solution looks like this.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-comment">//  ,      ,    </span>
<span class="hljs-comment">//       .      socket.Receive</span>
<span class="hljs-comment">//     , :</span>
<span class="hljs-keyword">var</span> bytesReceived = Completer&lt;<span class="hljs-keyword">object</span>&gt;();<font></font>
selector.Register(<font></font>
    socket,<font></font>
    SocketEvent.Receive,<font></font>
    () =&gt; bytesReceived.Complete(<span class="hljs-literal">null</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">await</span> bytesReceived.Future;<font></font>
<font></font>
<span class="hljs-keyword">int</span> n = socket.Receive(...); <span class="hljs-comment">//   </span><font></font>
<font></font>
<span class="hljs-comment">// selector -     poll.   </span>
<span class="hljs-comment">//        (Receive </span>
<span class="hljs-comment">//  ), ,    ,  .</span>
<span class="hljs-comment">//   completer,      ,</span>
<span class="hljs-comment">//        , ,     .</span>
<span class="hljs-comment">//     ,       .</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using this simple technique, we can serve a large number of sockets in a single thread. </font><font style="vertical-align: inherit;">We never block a stream while waiting for bytes to be received or sent. </font><font style="vertical-align: inherit;">The stream is always busy with useful work. </font><font style="vertical-align: inherit;">Concurrency, in a word. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Frontend servers are implemented that way. </font><font style="vertical-align: inherit;">They are all single-threaded and asynchronous. </font><font style="vertical-align: inherit;">Therefore, for maximum performance, you need to run as many servers on one machine as it has cores (4 in the picture). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Frontend server reads the message from the client and, based on the message code, sends it to one of the topics in Kafka.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A small footnote for those who are not familiar with kafa</font></font></b><div class="spoiler_text">   ,          RabbitMQ.    .       ,              (   authentication backend     authentication, ).  ?      -  ,         (partition).      ,      .      ,   ,       . ,             ( ,   ,  ,     (headers)).<br>
<br>
  ?     ?      .   (consumer)         (  consumer'),    ( )      . , ,      ,    2 ,       .   3 ‚Äî     2.                .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The frontend server sends a message to the kafka without a key (when there is no key, the kafka simply sends messages to the party in turn). The message is pulled from the topic by one of the corresponding backend servers. The server processes the message and ... what next? And what further depends on the type of message. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the most common case, a request-response cycle occurs. For example, for a registration request, we just need to give the client an answer ( </font></font><code>Success</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code>EmailAlreadyInUse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, etc). But to a message containing an invitation to an existing chat of new members (Vasya, Emil and Julia), we need to respond immediately with three different types of messages. The first type - you need to notify the inviter about the outcome of the operation (suddenly a server error occurred). The second type - you need to notify all current members of the chat that there are now such and such new members in the chat. The third is to send invitations to Vasya, Emil and Yulia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Okay, that doesn‚Äôt sound very difficult, but in order to send a message to any client we need to: 1) find out which frontend server this client is connected to (we don‚Äôt choose which server the client will connect to, the balancer decides for us); 2) send a message from the backend server to the desired frontend server; 3) in fact, send a message to the client.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To implement points 1 and 2, I decided to use a separate topic ("frontend servers" topic). Separation of authentication, session, and call topics into partitions serves as a parallelization mechanism. We see that the session server is heavily loaded? We just add a couple of new partition and session servers, and Kafka will redistribute the load for us, unloading the existing session servers. Separation of the "frontend servers" topic into the partition serves as a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">routing</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mechanism </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each frontend server corresponds to one part of the "frontend servers" topic (with the same index as the server itself). That is, server 0 - partition 0, and so on. Kafka makes it possible to subscribe not only to a specific topic, but also to a specific part of a certain topic. All frontend servers on start-ups subscribe to the corresponding partition. Thus, the backend server is able to send a message to a specific frontend server by sending a message to a specific partition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Okay, now when the client joins, you just need to save somewhere a pair of UserId - Frontend Server Index. In case of disconnect - delete. For these purposes, any of the many in-memory key-value databases will do. I chose a radish.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How it looks in practice. </font><font style="vertical-align: inherit;">First of all, after the connection is established, client Andrey sends a message to the server </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The Frontend server receives the message and forwards it to the session topic, preliminarily adding the ‚ÄúFrontend Server‚Äù header: {index}. </font><font style="vertical-align: inherit;">One of the backend session servers will receive a message, read the authorization token, determine what kind of user has joined, read the index added by the frontend server and write UserId - Index to the radish. </font><font style="vertical-align: inherit;">From this moment, the client is considered online, and now we know through which frontend server (and, accordingly, through which part of the "frontend servers" topic) we can "reach out" to it when other clients send messages to Andrey. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* In fact, the process is a little more complicated than I described. </font><font style="vertical-align: inherit;">You can find it in the source code.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frontend server pseudo code</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-comment">// Frontend Server 6</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">// Consume from "Frontend Servers" topic, partition 6</span>
    <span class="hljs-keyword">var</span> messageToClient = consumer.Consume();
    <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {<font></font>
        relayMessageToClient(messageToClient);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> callbacks = selector.Poll();
    <span class="hljs-keyword">while</span> (callbacks.TryDequeue(<span class="hljs-keyword">out</span> callback)) {<font></font>
        callback();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
    <span class="hljs-keyword">while</span> (!callAtQueue.IsEmpty &amp;&amp; callAtQueue.PeekPriority() &lt;= now) {<font></font>
        callAtQueue.Dequeue()();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (messagesToRelayToBackendServers.TryDequeue(<span class="hljs-keyword">out</span> messageFromClient)) {
        <span class="hljs-comment">// choose topic</span><font></font>
        producer.Produce(topic, messageFromClient);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are a few tricks here. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><code>relayMessageToClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It will be a mistake to simply take the socket you want and immediately start sending a message to it, because maybe we are </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">already</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sending some other message to the client. If we start sending bytes without checking if the socket is currently busy, the messages will be mixed. As in many other places where orderly data processing is required, the trick is to use a queue, namely, a queue from Completers ( </font></font><code>TaskCompletionSource</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in C #).</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-keyword">async</span> <span class="hljs-title">relayMessageToClient</span>(<span class="hljs-params">message</span>)</span> {
    <span class="hljs-comment">// find client</span>
    <span class="hljs-keyword">await</span> client.ReadyToSend();
    <span class="hljs-keyword">await</span> sendMessage(client, message);<font></font>
    client.CompleteSend();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> {
    <span class="hljs-comment">// ...</span>
    sendMessageQueue = <span class="hljs-keyword">new</span> LinkedList&lt;Completer&lt;<span class="hljs-keyword">object</span>&gt;&gt;();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">async</span> Future <span class="hljs-title">ReadyToSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = Completer&lt;<span class="hljs-keyword">object</span>&gt;();
	<span class="hljs-keyword">if</span> (sendMessageQueue.IsEmpty) {<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	} <span class="hljs-keyword">else</span> {
	    <span class="hljs-keyword">var</span> prevSendMessage = sendMessageQueue.Last;<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	    <span class="hljs-keyword">await</span> prevSendMessage.Future;<font></font>
	}<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CompleteSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = sendMessageQueue.RemoveFirst();<font></font>
	sendMessage.Complete(<span class="hljs-literal">null</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the queue is not empty, then the socket is already occupied at the moment. Create a new one </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, add it to the queue and </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous one</font></font></i> <code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Thus, when the previous message is sent, it </font></font><code>CompleteSend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will complete </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which will cause the server to start sending the next message. Such a queue also allows smoothly propagate exceptions. Suppose an error occurred while sending a message to a client. In this case, we need to complete, with the exception of sending not only this message, but also all messages that are currently waiting in the queue (hang on </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'ah). If we do not, then they will continue to hang, and we will receive a memory leak. For brevity, the code that does this is not shown here. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2)</font></font><code>selector.Poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Actually, it‚Äôs not even a trick, but just an attempt to smooth out the shortcomings of the method implementation </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>selector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- just a wrapper over this method). Depending on the OS under the hood, this method uses either </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. But this is not important here. The important thing is how this method works with the lists that we feed it to the input (list of sockets for reading, writing, error checking). This method takes lists, polls sockets and leaves only those sockets in the lists that are ready to perform the required operation. All other sockets are thrown from the lists. ‚ÄúKicking‚Äù occurs through</font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(that is, all subsequent elements are shifted, which is inefficient). Plus, since we need to poll all registered sockets every iteration of the cycle, such a ‚Äúcleansing‚Äù is generally harmful, we have to re-fill the lists every time. We can get around all these problems using a custom one </font></font><code>List</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whose </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">does not remove the item from the list, but simply marks it as deleted. The class </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is my implementation of such a list. </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only works with the method </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and is not suitable for anything else. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3)</font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In most cases, the frontend server, having sent the client message to the backend server, expects a response (confirmation that the operation was successful, or an error if something went wrong). If he does not wait for an answer within a configurable period of time, he sends an error to the client so that he does not wait for an answer that will never come. </font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is a priority queue. Immediately after the server sends the message to Kafka, it does something like this:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
callAtQueue.Enqueue(callback, now + config.WaitForReplyMSec);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the callback, waiting for a response is canceled and the server error sending begins. If a response from the backend server is received, the callback does nothing. </font><font style="vertical-align: inherit;">There is no way to </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
use </font></font><code>await Task.WhenAny(answerReceivedTask, Task.Delay(x))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it, since the code after it </font></font><code>Task.Delay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is executed on the thread from the pool. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, in fact, everything about frontend servers. A slight correction is required here. In fact, the server is not </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fully</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">single threaded. Of course, kafka under the hood uses threads, but I mean the application code. The fact is that sending a message to the topic of kafka (produce) may not succeed. In the event of a failure, Kafka repeats sending a certain configurable number of times, but, if repeated departures fail, Kafka abandons this business as hopeless. You can check whether the message was sent successfully or not in </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which we pass to the method </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kafka calls this handler in the producer's I / O thread (the thread that sends messages). We must make sure that the message was sent successfully, and if not, cancel waiting for a response from the backend server (the response will not come because the request was not sent) and send an error to the client. That is, we can‚Äôt avoid interacting with another thread.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* When writing an article, I suddenly realized that we can not pass </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the method </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or simply ignore all the kafka errors (the error will still be sent to the client by the timeout that I described earlier) - then all our code will be single-threaded. </font><font style="vertical-align: inherit;">Now I‚Äôm thinking how to do it better.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why, in fact, kafka, not rabbit?</font></font></b><div class="spoiler_text">,        ,   ,  , ,   RabbitMQ?        .  , ,   .     ?    ,         frontend .   ,     backend ,      ,          .    ,       ,     .   ,       error-prone.  ,     <code>basicGet</code> ,    ,   ,      .     .      <code>basicGet</code>,      ,       .          .<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backend server</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compared to the frontend server, there are practically no interesting points here. </font><font style="vertical-align: inherit;">All backend servers work the same way. </font><font style="vertical-align: inherit;">At the startup, the server subscribes to the topic (authentication, session or call depending on the role), and the kafka assigns one or more partitions to it. </font><font style="vertical-align: inherit;">The server receives the message from Kafka, processes and usually sends one or more messages in response. </font><font style="vertical-align: inherit;">Almost real code:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">long</span> lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">var</span> consumeResult = consumer.Consume(<font></font>
            TimeSpan.FromMilliseconds(config.Consumer.PollTimeoutMSec)<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (consumeResult != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> workUnit = <span class="hljs-keyword">new</span> WorkUnit() {<font></font>
                ConsumeResult = consumeResult,<font></font>
            };<font></font>
<font></font>
            LinkedList&lt;WorkUnit&gt; workUnits;<font></font>
            <span class="hljs-keyword">if</span> (partitionToWorkUnits.ContainsKey(consumeResult.Partition)) {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition];<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition] =<font></font>
                    <span class="hljs-keyword">new</span> LinkedList&lt;WorkUnit&gt;();<font></font>
            }<font></font>
<font></font>
            workUnits.AddLast(workUnit);<font></font>
<font></font>
            handleWorkUnit(workUnit);<font></font>
        }<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (<font></font>
            DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - lastCommitTime &gt;=<font></font>
            config.Consumer.CommitIntervalMSec<font></font>
        ) {<font></font>
            commitOffsets();<font></font>
	    lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What kind of offsets to commit?</font></font></b><div class="spoiler_text">       .   ‚Äî   (offset)    (0, 1  ).         0.        <code>TopicPartitionOffset</code>.    (consume)   ,   <code>ConsumeResult</code>, ,   ,   <code>TopicPartitionOffset</code>.     ?<br>
<br>
  at least once delivery,  ,              (    ).     ,           (commited) . ,  consumer         16,  ,  16 ,   ,      ,   .     -  consumer'     consumer'        ,    16 + 1 (   + 1).    17   .        N ,       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I disabled auto-commit and commit myself. This is necessary because </font></font><code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where the message processing is actually carried out, this is a </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method, therefore there is no guarantee that message 5 will be processed before message 6. Kafka stores only one commited offset (and not a set of offset), respectively, before committing the offset 6, we need to make sure that all previous messages have been processed too. In addition, one backend server can consume messages from several partitions at the same time, and, therefore, must make sure that it commits the correct offset to the corresponding partition. For this, we use a hash map of the form partition: work units. Here's what the code looks like </font></font><code>commitOffsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(real code this time):</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commitOffsets</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">foreach</span> (LinkedList&lt;WorkUnit&gt; workUnits <span class="hljs-keyword">in</span> partitionToWorkUnits.Values) {<font></font>
        WorkUnit lastFinishedWorkUnit = <span class="hljs-literal">null</span>;<font></font>
        LinkedListNode&lt;WorkUnit&gt; workUnit;<font></font>
        <span class="hljs-keyword">while</span> ((workUnit = workUnits.First) != <span class="hljs-literal">null</span> &amp;&amp; workUnit.Value.IsFinished) {<font></font>
            lastFinishedWorkUnit = workUnit.Value;<font></font>
            workUnits.RemoveFirst();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (lastFinishedWorkUnit != <span class="hljs-literal">null</span>) {<font></font>
            offsets.Add(lastFinishedWorkUnit.ConsumeResult.TopicPartitionOffset);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (offsets.Count &gt; <span class="hljs-number">0</span>) {<font></font>
        consumer.Commit(offsets);<font></font>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> offset <span class="hljs-keyword">in</span> offsets) {<font></font>
            logger.Debug(<font></font>
                <span class="hljs-string">"{Identifier}: Commited offset {TopicPartitionOffset}"</span>,<font></font>
                identifier,<font></font>
                offset<font></font>
            );<font></font>
        }<font></font>
        offsets.Clear();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, we iterate over the units, find the last unit completed by this moment, after which </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there are no incomplete ones</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and commit the corresponding offset. </font><font style="vertical-align: inherit;">Such a loop allows us to avoid "holey" commits. </font><font style="vertical-align: inherit;">For example, if we currently have 4 units ( </font></font><code>0: Finished, 1: Not Finished, 2: Finished, 3: Finished</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), we can commit only the 0th unit, because if we commit the 3rd immediately, this can lead to the potential loss of the 1st, if the server dies right now.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkUnit</span> {
    <span class="hljs-keyword">public</span> ConsumeResult&lt;Null, <span class="hljs-keyword">byte</span>[]&gt; ConsumeResult { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> finished = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsFinished =&gt; finished == <span class="hljs-number">1</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Finish</span>(<span class="hljs-params"></span>)</span> {<font></font>
        Interlocked.Increment(<span class="hljs-keyword">ref</span> finished);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
<code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as was said, the </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method, and it, accordingly, is completely wrapped in </font></font><code>try-catch-finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In </font></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">he calls the necessary service, and in </font></font><code>finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>workUnit.Finish()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The services are pretty trivial. </font><font style="vertical-align: inherit;">Here, for example, what code is executed when the user sends a new message:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;ServiceResult&gt; <span class="hljs-title">createShareItem</span>(<span class="hljs-params">CreateShareItemMessage msg</span>)</span> {
    <span class="hljs-keyword">byte</span>[] message;
    <span class="hljs-keyword">byte</span>[] messageToPals1 = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">int</span>?[] partitions1 = <span class="hljs-literal">null</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  UserId  .</span>
    <span class="hljs-keyword">long</span>? userId = hashService.ValidateSessionIdentifier(msg.SessionIdentifier);
    <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> shareItem = <span class="hljs-keyword">new</span> ShareItemModel(<font></font>
            requestIdentifier: msg.RequestIdentifier,<font></font>
            roomIdentifier: msg.RoomIdentifier,<font></font>
            creatorId: userId,<font></font>
            timeOfCreation: <span class="hljs-literal">null</span>,<font></font>
            type: msg.ShareItemType,<font></font>
            content: msg.Content<font></font>
        );<font></font>
<font></font>
        <span class="hljs-comment">//      null,</span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">long</span>? timeOfCreation = <span class="hljs-keyword">await</span> storageService.CreateShareItem(shareItem);
        <span class="hljs-keyword">if</span> (timeOfCreation != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//      .</span>
            List&lt;<span class="hljs-keyword">long</span>&gt; pals = <span class="hljs-keyword">await</span> inMemoryStorageService.GetRoomPals(<font></font>
                msg.RoomIdentifier<font></font>
            );<font></font>
            <span class="hljs-keyword">if</span> (pals == <span class="hljs-literal">null</span>) {
            	<span class="hljs-comment">//     -       .</span>
                pals = <span class="hljs-keyword">await</span> storageService.GetRoomPals(msg.RoomIdentifier);
                <span class="hljs-keyword">await</span> inMemoryStorageService.SaveRoomPals(msg.RoomIdentifier, pals);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-comment">//    ,  .</span><font></font>
            pals.Remove(userId.Value);<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (pals.Count &gt; <span class="hljs-number">0</span>) {
            	<span class="hljs-comment">//  ack,  ,    </span>
                <span class="hljs-comment">//    .</span>
                <span class="hljs-keyword">await</span> storageService.CreateAck(<font></font>
                    msg.RequestIdentifier, userId.Value, msg.RoomIdentifier,<font></font>
                    timeOfCreation.Value, pals<font></font>
                );<font></font>
<font></font>
                <span class="hljs-comment">// in -  UserId, out -   frontend ,</span>
                <span class="hljs-comment">//    .  -   -</span>
                <span class="hljs-comment">//   null.</span>
                partitions1 = <span class="hljs-keyword">await</span> inMemoryStorageService.GetUserPartitions(pals);<font></font>
<font></font>
                List&lt;<span class="hljs-keyword">long</span>&gt; onlinePals = getOnlinePals(pals, partitions1);<font></font>
<font></font>
                <span class="hljs-comment">//    ,       .</span>
                <span class="hljs-comment">//         .</span>
                <span class="hljs-keyword">if</span> (onlinePals.Count &gt; <span class="hljs-number">0</span>) {<font></font>
                    messageToPals1 = converterService.EncodeNewShareItemMessage(<font></font>
                        userId.Value, timeOfCreation.Value, onlinePals, shareItem<font></font>
                    );<font></font>
                    nullRepeatedPartitions(partitions1);<font></font>
                    <span class="hljs-comment">// -         </span>
                    <span class="hljs-comment">// frontend ,    null' .</span><font></font>
                }<font></font>
            }<font></font>
<font></font>
            message = converterService.EncodeSuccessfulShareItemCreationMessage(<font></font>
                msg.RequestIdentifier, timeOfCreation.Value<font></font>
            );<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            message = converterService.EncodeMessage(<font></font>
                MessageCode.RoomNotFound, msg.RequestIdentifier<font></font>
            );<font></font>
        }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        message = converterService.EncodeMessage(<font></font>
            MessageCode.UserNotFound, msg.RequestIdentifier<font></font>
        );<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServiceResult(<font></font>
        message: message, <span class="hljs-comment">//    .</span>
        messageToPals1: messageToPals1, <span class="hljs-comment">//  -    .</span><font></font>
        partitions1: partitions1<font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Database</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most of the functionality of services called by backend servers is simply adding new data to the database and processing existing ones. Obviously, how the database is organized and how we operate on it is very important for the messenger, and here I would like to say that I approached the issue of choosing a database very carefully after carefully studying all the options, but this is not so. I just chose CockroachDb because it promises a lot with a minimum of effort and has postgres compatible syntax (I worked with postgres before). There were thoughts of using Cassandra, but in the end I decided to dwell on something familiar. I had never worked with Kafka, or with Rabbit, or with Flutter and Dart, or with WebRtc, so I decided not to drag Cassandra as well, because I was afraid to drown in a whole host of new technologies for me.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of all the parts of my project, database design is the thing that I doubt the most. I‚Äôm not sure that the decisions I made are really </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">good</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decisions. Everything works, but could be done better. For example, there are tables ShareRooms (as I call chats) and ShareItems (as I call messages). So all the users entering a room are recorded in the jsonb field of this room. This is convenient, but obviously very slow, so I will probably redo it using foreign keys. Or, for example, the ShareItems table stores </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> messages. Which is also convenient, but since ShareItems is one of the most loaded tables (persistent </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), it might be worth creating a new table for each room or something like that. Kokroach scatters records on different nodes, accordingly, you need to carefully think over which record will go in order to achieve maximum performance, but I did not. In general, as can be understood from all of the above, databases are not my strongest point. Right now I‚Äôm generally testing everything for postgres, and not kokroach, because there is less load on my working machine, it is already so poor from loads it will take off soon. Fortunately, the code for postgres and kokroach differs quite a bit, so switching is not difficult.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I am in the process of studying how the cocroach actually works (how the mapping occurs between SQL and key-value (the cocroach uses RocksDb under the hood), how it distributes data between nodes, replicates, etc.). It was, of course, worthwhile to study cocroach before using it, but better late than never.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think that the base will undergo big changes when I become better at understanding this issue. Right now, the Acks table is haunting me. In this table, I store data about who has not yet received and who has not yet read the message (to show the user checkmarks). It is easy to notify the user that his message has been read if the user is online now, but if not, we need to save this information in order to notify the user later. And since group chats are available, it‚Äôs not enough just to store the flag, you need data about individual users. So here we directly ask for the use of bit strings (one line for users who have not yet received, the second - for those who have not yet read). Especially kokroach support </font></font><code>bit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>bit varying</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. However, I never figured out how to implement this business, given that the composition of the rooms can constantly change. In order for bit strings to retain their meaning, users in the room must remain in the same order, which is quite difficult to do when, for example, some user leaves the room. There are options here. Perhaps it‚Äôs worth writing -1 instead of deleting the user from the jsonb field so that order is preserved, or using some versioning method, so that we know that this bit string refers to the order of users, which was then then, and not on the current order of users. I'm still in the process of thinking about how to better implement this business, but for the time being, those who have not yet received and have not read the users are also just jsonb fields. Given that the Acks table is written with each message, the amount of data is large.Although the record, of course, is deleted when the message is received and read by everyone.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flutter</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For a long time I worked on the server side and used simple console clients for the test, so I did not even create a Flutter project. </font><font style="vertical-align: inherit;">And when I created it, I thought that the server part was a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complex</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> part, and the application is like that, garbage, I'll figure it out in a couple of days. </font><font style="vertical-align: inherit;">While working on the server, I created Hello Worlds for flutter a couple of times to get a feel for the framework, and since the messenger doesn‚Äôt need any intricate UI, I thought it was completely ready. </font><font style="vertical-align: inherit;">So the UI, really, is garbage, but the implementation of the functionality gave me problems (and it will still deliver, since not everything is ready).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">State management</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most popular topic. There are a thousand ways to manage your condition, and the recommended approach is changed every six months. Now the mainstream is provider. Personally, I chose 2 ways for myself: bloc and redux. Bloc (Business Logic Component) for managing local state and redux for managing global. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloc is not some kind of library (although, of course, there is also a library that reduces boilerplate, but I do not use it). Bloc is a stream-based approach. In general, dart is a pretty nice language, and streams are generally so sweet. The essence of this approach is that we push the entire business logic into services, and we communicate between the UI and services through a controller that provides us with various streams. Did the user click the ‚Äúfind contact‚Äù button? Using</font></font><code>sink</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(the other end of the stream) we send an event to the controller </font></font><code>SearchContactsEvent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the controller will call the desired service, wait for the result and return the list of users back to the UI through the stream too. UI waits for results using </font></font><code>StreamBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(widget that is rebuilt every time new data arrives in the stream it is subscribed to). That, in fact, is all. In some cases, we need to update the UI without any user involvement (for example, when a new message arrived), but this is also easily done through streams. In fact, a simple MVC with streams, no magic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compared to some other approaches, bloc requires more boilerplate, but, in my opinion, it is better to use native solutions without the participation of third-party libraries, unless using a third-party solution gives some </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">significant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advantages. </font><font style="vertical-align: inherit;">The more abstractions on top, the more difficult it is to understand what the error is when an error occurs. </font><font style="vertical-align: inherit;">I do not consider the advantages of the provider to be significant enough to switch to it. </font><font style="vertical-align: inherit;">But I have little experience in this area, so it is likely that I will change the camp in the future. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, about redux, and so everyone knows everything, so there‚Äôs nothing to say. </font><font style="vertical-align: inherit;">Moreover, I cut it out of the application :) I used it to manage my account, but then, realizing that in this case there are no special advantages over the block, I cut it out so as not to drag too much. </font><font style="vertical-align: inherit;">But in general I consider redux a useful thing for managing global state.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most excruciating part</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What should I do if the user sent a message, but before it was sent, the Internet connection was lost? What should I do if the user received a read confirmation, but he closed the application before the corresponding record in the database was updated? What should I do if the user invited his friend to the room, but before the invitation was sent, his battery died? Have you ever asked similar questions? Here I am. Before. But in the development process I began to wonder. Since the connection can disappear at any time, and the phone turns off at any time, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">everything</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> must be </font><b><font style="vertical-align: inherit;">confirmed</font></b><font style="vertical-align: inherit;"> . Not fun. Therefore, the very first message that the client sends to the server ( </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if you remember) is not just </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúHello I am online‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it is</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Hello I am online and here are unconfirmed rooms, here are unconfirmed acks, here are unconfirmed room membership operations, and here are last received messages per room</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">" </font></i><font style="vertical-align: inherit;">And the server responds with a similar sheet: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúWhile you were offline, such and such your messages were read by such and such users, and they also invited Petya to this room, and Sveta left this room, and you were invited to this room, but to these two rooms have 40 new posts</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">‚Äù </font></i><font style="vertical-align: inherit;">I would really like to know how similar things are done in other messengers, because my implementation does not shine with grace.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Images</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, you can send text, text + images and just images. </font><font style="vertical-align: inherit;">Video upload has not yet been implemented. </font><font style="vertical-align: inherit;">Images are compressed a bit and saved in Firebase storage. </font><font style="vertical-align: inherit;">The message itself contains links. </font><font style="vertical-align: inherit;">Upon receipt of the message, the client downloads images, generates thumbnails and saves everything to the file system. </font><font style="vertical-align: inherit;">File paths are written to the database. </font><font style="vertical-align: inherit;">By the way, thumbnail generation is the only code executed on a separate thread, since it is a compute-heavy operation. </font><font style="vertical-align: inherit;">I just start one worker-stream, feed it an image and in return I get a thumbnail. </font><font style="vertical-align: inherit;">The code is extremely simple, since dart provides convenient abstractions for working with streams.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThumbnailGeneratorService</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThumbnailGeneratorService</span> </span>{<font></font>
  SendPort _sendPort;<font></font>
  final Queue&lt;Completer&lt;Uint8List&gt;&gt; _completerQueue =<font></font>
      Queue&lt;Completer&lt;Uint8List&gt;&gt;();<font></font>
<font></font>
  ThumbnailGeneratorService() {<font></font>
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    Isolate.spawn(startWorker, receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((data) {<font></font>
      <span class="hljs-keyword">if</span> (data is SendPort) {<font></font>
        _sendPort = data;<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> completer = _completerQueue.removeFirst();<font></font>
        completer.complete(data);<font></font>
      }<font></font>
    });<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> startWorker(SendPort sendPort) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    sendPort.send(receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((imageBytes) {<font></font>
      Image image = decodeImage(imageBytes);<font></font>
      Image thumbnail = copyResize(image, <span class="hljs-attr">width</span>: min(image.width, <span class="hljs-number">200</span>));<font></font>
<font></font>
      sendPort.send(Uint8List.fromList(encodePng(thumbnail)));<font></font>
    });<font></font>
  }<font></font>
<font></font>
  Future&lt;Uint8List&gt; generate(Uint8List imageBytes) {<font></font>
    <span class="hljs-keyword">var</span> completer = Completer&lt;Uint8List&gt;();<font></font>
    _completerQueue.add(completer);<font></font>
    <font></font>
    _sendPort.send(imageBytes);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> completer.future;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firebase auth is also used, but only for authorization of access to Firebase storage (so that the user cannot, say, fill in the profile picture to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">someone else</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">All other authorization is done through my servers.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Message format</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You are probably horrified here, as I use regular byte arrays. Json disappears because efficiency is required, and I did not know about protobuf when I started. Using arrays requires a lot of care because one index is wrong and things go awry. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first 4 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are the length of the message. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next byte</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the message code. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next 16 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are the request identifier (uuid). </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next 40 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the authorization token. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rest of the message</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Message Length</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">required, since I do not use http or web sockets, or some other protocol that provides separation of one message from another. My frontend servers only see byte streams, and they need to know where one message ends and another begins. There are several ways to separate messages (for example, use some kind of character never found in messages as a separator), but I preferred to specify the length, since this method is the easiest, although it entails overhead, as most messages are missing and one byte to indicate the length. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The message code</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is just one of the members of the enum</font></font><code>MessageCode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Routing is carried out according to the code, and since we can extract the code from the array without preliminary deserialization, the frontend server decides in which topic of the kafka to send a message instead of delegating this responsibility to someone else. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Request ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">present in most posts, but not in all. It performs 2 functions: by this identifier, the client establishes the correspondence between the sent request and the received response (if the client sent messages A, B, C in this order, this does not mean that the answers will also come in order). The second function is to avoid duplicates. As mentioned earlier, kafka guarantees at least once delivery. That is, in rare cases, messages can still be duplicated. By adding the RequestIdentifier column with a unique constraint to the desired database table, we can avoid inserting a duplicate. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Authorization Token</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is a UserId (8 bytes) + 32 bytes HmacSha256 signature. </font><font style="vertical-align: inherit;">I don't think it's worth using Jwt here. </font><font style="vertical-align: inherit;">Jwt is about 7-8 times larger for what? </font><font style="vertical-align: inherit;">My users do not have any claims, so a simple hmac signature is fine. </font><font style="vertical-align: inherit;">Authorization through other services is not and is not planned.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audio and video calls</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's funny that I deliberately put off the implementation of audio and video calls, because I was sure that I won‚Äôt be able to solve the problems, but in fact it turned out to be one of the easiest features to implement. </font><font style="vertical-align: inherit;">At least the basic functionality. </font><font style="vertical-align: inherit;">In general, just adding WebRtc to the application and getting the first video session took only a few hours, and, miraculously, the first test was successful. </font><font style="vertical-align: inherit;">Before that, I thought that the code that worked the first time was a myth. </font><font style="vertical-align: inherit;">Usually the first test of a new feature always fails due to some kind of stupid error like ‚Äúadded a service, but did not register it in a DI container‚Äù.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not very brief about WebRtc for the uninitiated</font></font></b><div class="spoiler_text">WebRtc ‚Äî  ,   peer-to-peer    , ,    peer-to-peer  ,     .   - ,     ,      .      ,      .<br>
<br>
          (peer-to-peer),     <i></i> ,  3   (     <i></i> ,  3  .           3 ).<br>
<br>
    ‚Äî stun .   stun  ,    ‚Äî  Source IP  Source Port      ,    <i></i> .    ?        - .       IP .      - , ,    ,   Source IP  Source Port    IP  -        NAT  [ Source IP | Source Port | Router External IP | Router Port ].     - ,   Dest IP  Dest Port     Router External IP  Router Port  NAT, ,    Source IP ‚Äî Source Port     ,   .   , ,       ,      , ,    ,      NAT .       stun     NAT .     stun     Router External IP ‚Äî Router Port.   ‚Äî <i></i>   .     ,  ¬´¬ª    NAT (NAT traversal)  ,      NAT  ,     stun .<br>
*  NAT ,      . ,     ,  WebRtc    .<br>
<br>
  ‚Äî turn.  ,       ,   peer-to-peer . Fallback .    , ,  ,  ,   ,   peer-to-peer     .    turn  ‚Äî coturn,      .<br>
<br>
  ‚Äî .    <i> </i>  ,    .       ,    .   ‚Äî           .       .    ,          , ,     :)       ‚Äî   .<br>
<br>
 WebRtc  3   : offer, answer  candidate.    offer     ,    answer,       .    , ,  ,    ,       .    (     )   ,  .<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebRtc technology itself establishes a connection and is engaged in transferring flows back and forth, but this is not a framework for creating full-fledged calls. By call, I mean a communication session with the ability to cancel, reject and accept the call, as well as hang up. Plus, you need to let the caller know if the other side is already taken. And also to implement little things like "wait for an answer to the call N seconds, then reset." If you simply implement WebRtc in the application in a bare form, then with an incoming call, the camera and video will spontaneously turn on, which, of course, is unacceptable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In its pure form, WebRtc usually means sending candidates to the other party as soon as possible so that negotiations begin as quickly as possible, which is logical. In my tests, candidates to the receiving party generally </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">always</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">started to come even before offer comes. Such ‚Äúearly‚Äù candidates cannot be discarded, they must be remembered, so that later, when the offer arrives and </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is created, add them to the connection. The fact that candidates may begin to arrive even before the offer, as well as some other reasons, make the implementation of full-fledged calls a non-trivial task. What to do if several users call us at once? We will receive candidates from all, and although we can separate candidates from one user from another, it becomes unclear which candidates to reject, because we do not know whose offer will come earlier. There will also be problems if candidates begin to come to us and then an offer at the moment when we </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ourselves</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> call someone.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After testing several options with a bare WebRtc, I came to the conclusion that in this form it would be problematic and fraught with memory leaks to try to make calls, so I decided to add another stage to the WebRtc negotiation process. I call this stage </font></font><code>Inquire - Grant/Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea is very simple, but it took me quite a while to reach it. The caller even before creating the stream and </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(and generally before executing </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">any</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code related to WebRtc) sends a message through the signal server to the other side </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. On the receiving side, it is checked whether the user is in some other communication session at the moment (simple </font></font><code>bool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">field). If it is, then a message is sent back.</font></font><code>Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and in this way we let the caller know that the user is busy, and the receiver - that such and such a phone called while he was busy with another conversation. If the user is currently free, then it is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reserved</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">session identifier is sent </font><font style="vertical-align: inherit;">in the message </font><font style="vertical-align: inherit;">, and this identifier is set as the identifier of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> session. If the user is reserved, he will reject all </font></font><code>Inquire/Offer/Candidate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">messages with session identifiers other than the current one. After the reservation, the receiver sends a message through the signal server to the caller </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is worth saying that this process is not visible to the receiving user, since there is no call yet. And the main thing here is not to forget to hang up a timeout on the receiving side. Suddenly we will reserve a session, and no offer will follow.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The caller receives </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and this is where WebRtc begins with offers, candidates, and this is it for everyone. </font><font style="vertical-align: inherit;">Offer flies to the receiver, and he, upon receipt, displays a screen with the buttons Answer / Reject. </font><font style="vertical-align: inherit;">But candidates, as usual, are not expecting anyone. </font><font style="vertical-align: inherit;">They again begin to arrive even earlier than the offer, because there is no reason to wait for the user to answer the call. </font><font style="vertical-align: inherit;">He may not answer, but reject or wait until the timeout expires - then the candidates will simply be thrown out.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Current status and future plans</font></font></h2><br>
<ul>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Private and group chats</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending text, images</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and videos</font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audio and video calls</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirmation of receipt and reading</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Prints ..."</font></font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Search by QR code and geolocation</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Searching by QR code is, unexpectedly, quite problematic to implement, because almost all the plugins for the code scan that I tried refuse to start or do not work correctly. </font><font style="vertical-align: inherit;">But I think the problems will be solved here. </font><font style="vertical-align: inherit;">And for the implementation of the search for geolocation, I have not yet taken up. </font><font style="vertical-align: inherit;">In theory, there should not be any special problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notifications in progress, as well as sending videos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What else needs to be done?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh, a lot. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firstly,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there are no tests. Colleagues used to write tests, so I completely relaxed. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secondly,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inviting users to an existing chat and leaving the chat is currently not possible. Server code is ready for this, client code is not. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thirdly,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> if the error handling on the server is more or less, then there is no error handling on the client. It is not enough just to make a log entry; you need to retry the operation. Now, for example, the mechanism for re-sending messages is not implemented. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fourth, the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server does not ping the client, so disconnect is not detected if, for example, the client has lost the Internet. Disconnect is detected only when the client closes the application. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fifth,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indexes are not used in the database.</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sixth,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimization. The code has a huge number of places where something like is written </font></font><code>// @@TODO: Pool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Most arrays are just </font></font><code>new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that. The backend server creates many arrays of fixed length, so here you can and should use the pool. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seventh,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there are many places on the client where the code </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ends, although this is not necessary. Sending images, for example, therefore seems slow because the code</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It saves pictures to the file system and generates thumbnails before displaying the message, although none of this needs to be done. Or, for example, if you open the application and during your absence they sent images to you, the startup will be slow, because again all these images are downloaded, saved to the system, thumbnails are generated, and only after that the startup ends and you are thrown from the splash screen on home screen. All these redundant </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'s were made for easier debugging, but, of course, you need to get rid of unnecessary waiting before release. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eighth</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UI is now half ready, because I have not decided how I want to see it. Therefore, now everything is not intuitive, half of the buttons are unclear what they are doing. And the buttons are often not pressed the first time, because now they are just icons with </font></font><code>GestureDetector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and without padding, so it‚Äôs not always possible to get into them. Plus in some places pixel overflow is not fixed. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninth,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> now it‚Äôs even impossible to Sign-in to an account, only Sign Up. Therefore, if you uninstall the application and reinstall it, you won‚Äôt be able to log into your account :) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenth,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the verification code is not sent to the mail. Now the code is generally always the same, again because it's easier to debug. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eleventh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The single-responsibility principle is violated in many places. Need a refactor. The classes responsible for interacting with the database (both on the client and on the server) are generally very bloated, because they are engaged in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> database operations. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Twelfth, the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> frontend server now always expects a response from the backend server, even if the message does not imply sending a response (for example, a message with a code </font></font><code>IsTyping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and some WebRtc-related messages). Therefore, without waiting for an answer, he writes an error to the console, although this is not an error. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thirteenth,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> full images do not open on tap. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One hundred million fifths</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">some messages that need to be sent in batches are sent separately. The same applies to some database operations. Instead of executing a single command, the commands are executed in a loop with </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(brr ..). </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One hundred million sixths,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> some values ‚Äã‚Äãare hardcoded, instead of being configurable. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One hundred and one million sevenths</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">logging on the server is now only to the console, and on the client in general, directly to the widget. On the main screen there is a Logs tab, where all the logs on tap are dropped. The fact is that my working machine refuses to run both the emulator and everything necessary for the server (kafka, database, radish and all servers). Debit with a connected device also did not work out, everything just tightly hung in half the cases, because the computer could not cope with the loads. Therefore, you have to make a build every time, drop it onto the device, install and test like this. To see the logs, I drop them right into the widget. Perversion, I know, but there is no choice. For the same reason, many methods return </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They are (to catch the exception and throw into the widget), although they should not. If you look at the code, you will see an ugly </font></font><code>_logError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method in many classes that does this. This, of course, will also go to the trash. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One hundred million and eight,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no sounds. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One hundred million and ninth,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you need to use caching more. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One hundred million tenths, a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lot of repetitive code. For example, many actions first of all check the validity of the token, and if it is not valid, they send an error. I think you need to implement a simple middleware-pipeline. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And a lot of little things, like concatenating strings instead of using </font></font><code>StringBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'a,</font></font><code>Dispose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not everywhere is called where it should, and so on and so on. </font><font style="vertical-align: inherit;">In general, the normal state of the project is under development. </font><font style="vertical-align: inherit;">All of the above can be solved, but there is one fundamental problem that I did not think about until the last moment, because it got out of my head - the messenger should work even when the application is not open, and mine does not work. </font><font style="vertical-align: inherit;">To be honest, the solution to this problem has not yet crossed my mind. </font><font style="vertical-align: inherit;">Here, apparently, you can not do without the native code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would rate the readiness of the project at 70%.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Six months have passed since the start of work on the project. </font><font style="vertical-align: inherit;">Combined with part-time work and took long breaks, but still it took a decent amount of time and energy. </font><font style="vertical-align: inherit;">I plan to implement all the declared features + add something unusual like tic-tac-toe or drafts right in the room. </font><font style="vertical-align: inherit;">For no reason, just because it's interesting. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have any questions, write. </font><font style="vertical-align: inherit;">Mail is on github.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490054/index.html">17 surprises for my first year using the Tesla Model 3</a></li>
<li><a href="../en490056/index.html">Black Box: forget about logging</a></li>
<li><a href="../en490060/index.html">Search knowledge graph: building from multiple sources</a></li>
<li><a href="../en490066/index.html">From China to the South Pole: Joining forces to solve the neutrino mass puzzle</a></li>
<li><a href="../en490068/index.html">Falsification of randomness and transformation by sorting pseudo-random sequences</a></li>
<li><a href="../en490076/index.html">Sports classification of e-sports disciplines</a></li>
<li><a href="../en490080/index.html">How competitors can easily block your site</a></li>
<li><a href="../en490082/index.html">Genetic Code Analysis I</a></li>
<li><a href="../en490084/index.html">Understanding the ECMAScript Specification, Part 1</a></li>
<li><a href="../en490086/index.html">Beginner Surf Guide or Programmer's Life in Portugal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>