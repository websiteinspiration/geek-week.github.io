<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßíüèª üë©‚Äçüë¶ üßö Website development in pascal (backend) üîç üíÖüèø üí©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will talk about why, why, and how I started making sites in Pascal: Delphi / FPC. 
 Probably the ‚ÄúPascal site‚Äù is associated with so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Website development in pascal (backend)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491272/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article I will talk about why, why, and how I started making sites in Pascal: Delphi / FPC. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probably the ‚ÄúPascal site‚Äù is associated with something like:</font></font><br>
<br>
<pre><code class="delphi">writeln('Content-type: text/html');</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But no, everything is much more interesting! </font><font style="vertical-align: inherit;">However, the source code of a real site (almost all) is available on GitHub.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What for?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, I‚Äôm never a professional web developer - I make games. A game, especially an online one, needs a website. Therefore, it so happened that I began to make more sites for my games. Using CGI on Perl - in the early / mid 2000s it was popular. Everything was fine until a problem arose. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2013, we started holding online tournaments for the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spectromancer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game. </font><font style="vertical-align: inherit;">To do this, I made a tournament page on the game‚Äôs website, which shows who to play with, current results, etc. At the start of the tournament, the players page was updated and ... did not load. People pressed F5, further exacerbating the problem. It turned out that even 4-5 requests per second to a CGI script, launched as a separate Perl process, significantly slow down the server, and&gt; 10 requests per second make it completely inaccessible.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs good that this stress test took place during the rehearsal tournament: later on I already used the updated static page for tournaments. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, when the need arose to make </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this site for a new game</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the question arose - on what? </font><font style="vertical-align: inherit;">Brake CGI on Perl is not an option. </font><font style="vertical-align: inherit;">FastCGI in Perl? </font><font style="vertical-align: inherit;">I can not imagine how to write and debug a multithreaded program in Perl, I had enough problems with ordinary scripts. </font><font style="vertical-align: inherit;">Node.js? </font><font style="vertical-align: inherit;">Probably it would be the best choice, if not for some hostility to JS. </font><font style="vertical-align: inherit;">And since the game itself and its server are written in Pascal (actually Delphi, but FPC is also good), the idea arose - should we make the site in the same language? </font><font style="vertical-align: inherit;">This will simplify integration with the game server. </font><font style="vertical-align: inherit;">‚ÄúTrying is not torture!‚Äù </font><font style="vertical-align: inherit;">I thought, and decided to give it a try.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I chose SimpleCGI (SCGI) as the interface: it is somewhat simpler than FastCGI, and the advantages of the latter are irrelevant for me - there is no need to distribute the backend to different servers, everything runs on the same server. </font><font style="vertical-align: inherit;">So the task boiled down to the development of a certain SCGI framework that processes requests from the server and generates HTML pages in response from certain prefabricated templates. </font><font style="vertical-align: inherit;">The result is such a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">module framework</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It consists of the following parts:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Main loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : accepts incoming connections, reads requests and puts them in a queue for processing. </font><font style="vertical-align: inherit;">Writes ready-made responses to processed requests to connection sockets and closes them.</font></font></li>
<li><b>  (N )</b>:    ,         .   worker' ‚Äî      . </li>
<li><b>  </b>:    HTML- (   )    .     .</li>
<li><b>  </b>:      (  CGI.pm  Perl).  ,    ..</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A very convenient feature of Perl scripts is that it is very easy to make small changes to the site: just edited the script code and that‚Äôs it. No need to compile, deploy. Of course, pascal is a compiled language, it won‚Äôt work out like that, but still I wanted to be able to make changes whenever possible without restarting the process. Therefore, I tried to make the template system flexible enough.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
She works like that. The templates files are in the ‚Äútemplates‚Äù folder: they are loaded when the process starts and also reloaded when changed - this way you can change dynamic content without restarting the process. Each file can have one or more templates. Together, they form a dictionary (or hash) of templates: {"name" -&gt; "value"}. This is a static dictionary of templates - it is common to all requests and its contents remain unchanged (until the contents of the files change). There is another one - a dynamic dictionary, it is created empty for each request and filled with dynamic data handler - for example, from a database. Combining static and dynamic data, the final result is formed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example template declaration:</font></font><br>
<br>
<pre><code class="xml">#NEWSFEED_ITEM:<font></font>
&lt;div class=NewsHeader&gt;<font></font>
 &lt;a href='/$LANG_LC/forum/thread/$NEWS_ID'&gt;&lt;IF_NEWS_PINNED&gt;[TOP] &nbsp;&lt;/IF_NEWS_PINNED&gt;$NEWS_DATE &nbsp; $NEWS_TITLE&lt;/a&gt;<font></font>
&lt;/div&gt;<font></font>
&lt;div class=NewsText&gt;$NEWS_TEXT<font></font>
 &lt;div align=right&gt;<font></font>
  &lt;a href='/$LANG_LC/forum/thread/$NEWS_ID'&gt;$COMMENTS&lt;/a&gt;<font></font>
 &lt;/div&gt;<font></font>
&lt;/div&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a static template for writing in the news feed with the name NEWSFEED_ITEM, inside it contains the inclusion of several other templates, for example NEWS_TEXT - a dynamic template containing news text downloaded from the database. </font><font style="vertical-align: inherit;">The translation is that all substrings of the form $ TEMPLATE_NAME are recursively replaced with the value of this template. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you can also notice a pseudotag for conditional translation: &lt;IF_TEMPLATE_NAME&gt; - during the translation, such tags are deleted and their contents are left or also deleted, depending on the value of the specified template. </font><font style="vertical-align: inherit;">I specifically chose this format of conditions - in the form of HTML tags, so that when editing in a text editor syntax highlighting works and it is easy to see a paired tag. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The feed generation code using this template looks something like this:</font></font><br>
<br>
<pre><code class="delphi"><font></font>
    result:='';<font></font>
    //       NEWSFEED_ITEM      result<font></font>
    for i:=0 to n-1 do begin<font></font>
      id:=StrToIntDef(sa[i*c],0);<font></font>
      title:=sa[i*c+1];<font></font>
      cnt:=StrToIntDef(sa[i*c+2],1)-1;<font></font>
      flags:=StrToIntDef(sa[i*c+3],0);<font></font>
      //     <font></font>
      db.Query('SELECT msg,created FROM messages WHERE topic=%d ORDER BY id LIMIT 1', <font></font>
        [id]);<font></font>
      if db.lastErrorCode&lt;&gt;0 then continue;<font></font>
      text:=db.Next;<font></font>
      date:=db.NextDate;<font></font>
      //    ( temp)<font></font>
      temp.Put('NEWS_ID',id,true);<font></font>
      temp.Put('NEWS_DATE',FormatDate(date,true),true);<font></font>
      temp.Put('NEWS_TITLE',title,true);<font></font>
      temp.Put('NEWS_PINNED',flags and 4&gt;0,true);<font></font>
      comLink:='$LNK_READ_MORE | ';<font></font>
      if cnt&gt;0 then comLink:=comLink+inttostr(cnt)+' $LNK_COMMENTS'<font></font>
        else comLink:=comLink+'$LNK_LEAVE_COMMENT';<font></font>
      temp.Put('NEWS_TEXT',text,true);<font></font>
      temp.Put('COMMENTS',comLink,true);<font></font>
      //   <font></font>
      result:=result+BuildTemplate('#NEWSFEED_ITEM');<font></font>
    end;<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Localization</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Templates are also convenient to use for localization. </font><font style="vertical-align: inherit;">To do this, use the global (in the context of the request) clientLang variable. </font><font style="vertical-align: inherit;">It works like this: if the request handler finds out that the client needs a page in Russian, he writes the value ‚ÄúRU‚Äù in clientLang, after which the template translator, finding $ TEMPLATE_NAME in the text, always tries to apply $ TEMPLATE_NAME_RU first. </font><font style="vertical-align: inherit;">Thus, for localization it is only necessary for each template with text to create its version for another language:</font></font><br>
<br>
<pre><code class="plaintext">#TITLE_NEWS:News<font></font>
#TITLE_NEWS_RU:<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of using a framework</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simple site code example:</font></font><br>
<br>
<pre><code class="delphi">program website;<font></font>
uses SysUtils, SCGI;<font></font>
<font></font>
//    <font></font>
function IndexPage:AnsiString; stdcall;<font></font>
 begin<font></font>
   result:=FormatHeaders('text/html')+BuildTemplate('#INDEX.HTM');<font></font>
 end;<font></font>
<font></font>
begin<font></font>
 SetCurrentDir(ExtractFileDir(ParamStr(0)));<font></font>
 SCGI.Initialize; //  <font></font>
 AddHandler('/',IndexPage); //     '/'<font></font>
 SCGI.RunServer; //      <font></font>
end.<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wrote the described framework in the process of creating the real site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">astralheroes.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at the end of 2015. </font><font style="vertical-align: inherit;">As it usually happens, the first pancake came out a little lumpy - the code turned out to be somewhat messy and confusing, the next site is getting better. </font><font style="vertical-align: inherit;">Nevertheless, I am satisfied with the process and the result: the site works well, is easily debugged and updated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Findings:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I expected that compared to compact Perl, the site code is very bloated, but no - the same functionality written in Pascal takes only about twice as much as in Perl. </font><font style="vertical-align: inherit;">But it looks more clear.</font></font></li>
<li> ! Perl ‚Äî  ,    -   100 , ,    .      - -  ‚Äî    .  Delphi      .</li>
<li>     Perl.   -,       ,     ,      .  -,          Perl,       ,     .</li>
<li>    :    ,     ,   .    .</li>
<li> .         ,  ,    (    ),      ,         . ,        ,      ‚Äî      .     .<br>
<br>
             ,           .          ‚Äî      . ,         :<br>
<br>
<img src="https://habrastorage.org/webt/ha/tm/xk/hatmxk0csqkmgbofbwug-e3qcew.png"><br>
<br>
       ,    ‚Äî   .     ,    .</li>
</ul><br>
<h3>    ?</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sources on GitHub: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Cooler2/ApusEngineExamples</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Note that there is a submodule in the repository, so it's better to clone with the " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--recursive</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">parameter </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The site project is in the file: ‚ÄúAH-Website \ Backend \ src \ website.dpr‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is not a complete copy of the current site: it is clear that I cannot publish the contents of the database with the data of the players, I also do not publish CGI scripts, since they not related to the topic. Nevertheless, the project is being assembled, launched and working, fully demonstrating the work of the framework. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The publication of the site code, as well as the engine code that it uses, was made possible thanks to the support I received </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on Patreon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">I express my gratitude to all those who supported me and urge you to join - there is still a lot of interesting things ahead :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for your attention!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491260/index.html">Text normalization in speech recognition tasks</a></li>
<li><a href="../en491262/index.html">An eye for an eye. Biometrics Issues</a></li>
<li><a href="../en491264/index.html">Introduction to SSD. Part 4. Physical</a></li>
<li><a href="../en491266/index.html">SurfingAttack: compromising smartphones with sound assistants [+ video]</a></li>
<li><a href="../en491268/index.html">Monte Carlo Methods for Markov Chains (MCMC). Introduction</a></li>
<li><a href="../en491276/index.html">How I circumvented the ban on Messages API through the Vkontakte documentation</a></li>
<li><a href="../en491278/index.html">CLRium # 7: Reports, Practice, Mentors</a></li>
<li><a href="../en491280/index.html">The story of how I developed a programming language</a></li>
<li><a href="../en491282/index.html">How to increase team productivity (and reduce errors) using rallies</a></li>
<li><a href="../en491284/index.html">Analysis: what is fundamental analysis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>