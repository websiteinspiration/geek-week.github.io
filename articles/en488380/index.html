<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💃 👰🏿 👨🏿‍💻 The easiest start in STM through "one place" 🤞🏾 👩🏻‍🤝‍👨🏾 🍔</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably, the time of religious wars of AVR against STM has already passed, but no, no, yes, there are outbreaks of clashes between the two camps. Alm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The easiest start in STM through "one place"</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488380/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probably, the time of religious wars of AVR against STM has already passed, but no, no, yes, there are outbreaks of clashes between the two camps. Almost any publication on AVR crafts will definitely have a comment like “Yes, how much you can shag your grandmother, it’s high time to switch to STM”, then the variations on the subject of price, number of legs and timers. If the STMshcher is more advanced, there will certainly be an indication that there is no DMA in the AVR and will not, therefore the AVR should die. Why a simple blink-voltmeter-thermometer DMA, a mountain of 16 bit timers, 100 legs and a 12 bit ADC, no one usually explains. Why do we need such a harvester in a device that Tiny13 can easily take out, which at the same time is not loaded even on a third of its resources, no one will understand. You just have to switch to STM32, and that's it. For here.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And I must say, people have a craving for novelty. But really, can I try? What if you like it? Here are just the Reference Manual for the popular STM32F103C8T6, on which the most massive 1126-page Blue tablet is based, somehow it doesn’t really have a “quick start”. Even a separate utility, so hated by the elders “kalokub”, and that must be studied, what's what. Yes, and having delved into Cube, it is unlikely to start in 5 minutes, the footcloth generated by him is not the most accessible reading matter for the night, it’s just to get into the forehead, which not everyone can talk about there.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Numerous articles, similar to this one, about quick and easy start in STM deserve a separate discussion. For all such articles, at first I was very confused by one circumstance. Nowhere is there a detailed explanation of what we are actually writing here. A bunch of screenshots of how to create a project, then immediately a wall of code, do it like this! And what is there, why is it, why is it so, where to get all these seemingly understandable words from, no one delves into it, because the forces ran out when writing a manual on installing Cale and Cuba, and on launching the project. Only after some time, individual for each, does the understanding of what is happening and why come. In turn, I propose a way to start not from the beginning, like everyone else, but from the end. Now we will do the opposite, do not configure the controller, write code and debut it, but immediately proceed to the debug,and record our actions in the form of code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we install Keil as a free (up to 32KB code) environment. We will not describe this action, this is on the Internet, and the installer’s step-by-step must be mastered by the person who goes to STM. We start the project: Project-New uVision Project, create a folder and a project file. The controller selection window opens, enter 103C8 into the search and agree on the only selected model. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we get to the library selection window:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4v/ox/yf/4voxyfdppukch2gamrnsguvzbfk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we put three daws: CMSIS-CORE, Device-Startup and Device-GPIO. This set is quite enough to bounce a leg, lighting the LED. Then you still have to configure, you can’t get anywhere from this. Alt + F7 launches the settings window located Project-Options for Target, where on the “Output” tab you need to check the “Create HEX-File” checkbox to create a firmware file that we will upload to the controller. Next, in the “Debug” tab, we select ST-Link, which, in fact, will load the firmware and debut: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kd/uw/6l/kduw6ltbrav_uadgbbrp93w5oke.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the “Setting” button next to the programmer’s selection window, we get to the “Cortex-M Target Driver Setup” window, where in the “ Flash Download "put a daw" Reset and Run ".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the project tree, right-click on the “Source Group 1” folder, in the wizard that opens, create the main.c file, in which we will soon write the code. In the opened main.c, right-click on the first and most important inclusion: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qc/zp/ju/qczpjupur2s0vqx-reffsuzy5qo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add the code consisting of main and endless while:</font></font><br>
<br>
<pre><code class="plaintext hljs">#include "stm32f10x.h"                  // Device header<font></font>
int main(){<font></font>
	while(1){<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oddly enough, this is all for now, this is a ready-made and understandable program that correctly compiles and loads into the controller. We press F7 and we see that the firmware has been successfully assembled, there are no errors or warings. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4b/bs/d3/4bbsd3ca51m6nmrx4gon6a_rwyw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From this moment on, the controller is fully accessible to us, we can enter it under the debug line and twist-twist it in all directions, and it will respond. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Ctrl + F5 keys lead us into debug, and the “System Viewer Windows” button allows you to launch the windows for controlling the register registers and controlling the legs of the GPIO. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1e/ri/u1/1eriu1hhnribtydyhsaq-i36lr4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, I suggest that you still use the Reference Manual, especially since you do not even need to download it, it is available by clicking in the “Books” tab of the “View” menu:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fx/4j/hm/fx4jhmgymzqzczhfcqto1wusr2m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I propose to use the following reasoning. From the pinout on the Blue Tablet, it can be seen that the LED hangs on the leg of port 13. Numerous Internet resources and discussions always mention that before you do something in STM, you need to enable something, otherwise, set the clock. Without further ado, we write in the search box of the pdf reader what we need, namely, enable port C: “PORT C CLOCK ENABLE”. We </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qf/lh/vs/qflhvsoyc3fhyds54-clxwq0eqo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get </font><font style="vertical-align: inherit;">into the following picture: </font><font style="vertical-align: inherit;">From this we can conclude that the clocking of port C is enabled in the IOPCEN register. With this knowledge, we go to the RCC tab in debug mode, and enter this name in the search bar: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z0/x4/3q/z0x43qbnbga_-q0voxoajotxuqs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mark the required checkbox with a checkmark, and from this moment we consider port C enabled.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, remembering the long-suffering AVR, we will look for the setting of the actual pin. In order for it to work, it is necessary to explain what exactly we want from it. And we want to jump with foot number 13 of port C, for this we need to set the mode of its operation. In the search bar in the Referense Manual we drive in “Port bit configuration”, which expresses our desire to read where the leg settings are hidden. The search leads us to a table from which it follows that in order to assign a leg as an output, it is necessary to configure the MODE and CNF registers: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/c4/ot/odc4oti0osjwy9qvuax79slsqv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From table No. 20 it is clear that for assigning a leg as a Push-Pull output, it is necessary to reset the registers CNF0 and CNF1, and the pair state MODE0 and MODE1 are described in table No. 21, I will choose the upper option, up to 10MHz, MODE0 = 1, MODE1 = 0. This is what I will do in the GPIOC window for the registers CNF13 and MODE13</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-n/x5/y3/-nx5y33grvntsdchwf7emhxlgnc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have configured the clock and mode of operation of the port. It's time to find out exactly how to jump a leg. In English, set the port bit is written as “Port bit set”, and we will look for this phrase in the manual: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nw/l8/r2/nwl8r2ne5djl9o3hmpwxg2eigg0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Search leads us to a page with a table, which clearly shows that the BSRR register, consisting of BS and BR pairs, is responsible for setting the status of the port leg , Bit set and Bit reset, respectively. We find these registers in the GPIOC window in debug mode and enjoy the control of leg number 13 directly by poking jackdaws with the mouse into the corresponding checkboxes:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ob/vj/c3/obvjc3gnvzem1sh6tecfly7quyk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An LED on the blue pill board hangs between the leg and the VCC, therefore controlling it back to the register name. The Bit Set (BS13 register) extinguishes it, and the Bit Reset (BR13 register) ignites it. These are registers of atomic operations, they are reset after setting the checkbox. It is possible to control the foot through the ODR register (clause 9.2.4 Port output data register (GPIOx_ODR) in the reference manual), it clearly shows what the installation and resetting of the jackdaw leads to. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nv/rd/ou/nvrdouc1ano_fn8gdpdplk2v5rq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A green and dimming green LED indicates that everything is working correctly. It remains only to write all this in the form of code in the main.c. This is where the very raisins appear, which distinguishes this method of comprehending the STM controller through debug from the others that the entire Internet is littered with. I suggest just rewriting what we see in the debug window into code. Example:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/f9/ww/kqf9wwqdt2ydqoz9ovv1f9k2xt0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Set the port operation mode and enable clocking; </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/a-/fk/iua-fkaw0im1tjbpxqm4kwpruio.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They turned on the port leg, waited, turned it off, and so on:</font></font><br>
<br>
<pre><code class="plaintext hljs">#include "stm32f10x.h"                  // Device header<font></font>
<font></font>
int main(){<font></font>
	RCC-&gt;APB2ENR=0x00000010;			//  <font></font>
	GPIOC-&gt;CRH=0x44144444;			//   Push-Pull  10MHz<font></font>
	int i;								//     / <font></font>
	while(1){<font></font>
		GPIOC-&gt;ODR=0x00002000;		//  LED,      <font></font>
		i=2000000;					//    <font></font>
		while (i) i--;					// <font></font>
		GPIOC-&gt;ODR=0x00000000;		//  LED<font></font>
		i=2000000;					//  <font></font>
		while (i) i--;					<font></font>
	}<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, this method is far from the best and not correct, but in my opinion the most understandable and simple. In addition, he introduces to working with a datasheet (reference manual) and does not scare away, like reading mana and writing multi-page footcloths of code for Blink. Yes, there are no layers of abstractions, much has been missed, but I think you can forgive this for the elementary start. Reading mana and correct work with registers is then, now we have a blinking LED and we basically understand how and what we did, and most importantly, where all these abbreviations came from. If I had been shown this way of studying STM before, perhaps I would not have collected over 9000 different programmers for AVR in which there was no debug, but would have taken up on the Cortex right away. Indeed, in AVR there is no intelligible and accessible debug, but anyway, it's too early to forget Tiny13. She takes out her tasks.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488368/index.html">What I learned while working on my first large-scale project</a></li>
<li><a href="../en488370/index.html">TDD for microcontrollers. Part 2: How spies get rid of addictions</a></li>
<li><a href="../en488374/index.html">Telegram + 1C + Webhooks + Apache + Self-Signed Certificate</a></li>
<li><a href="../en488376/index.html">When the principle "to hell with everything, take it and do it!" not working: procrastinator notes</a></li>
<li><a href="../en488378/index.html">Briefly about naming in JS</a></li>
<li><a href="../en488382/index.html">I add 3-25 seconds delay to sites that I visit</a></li>
<li><a href="../en488386/index.html">Cases for applying network anomaly analysis tools: attacks through browser plug-ins</a></li>
<li><a href="../en488388/index.html">Relogin and HTTP Basic Auth</a></li>
<li><a href="../en488390/index.html">How to make Telegram bot friends with OpenId Connect</a></li>
<li><a href="../en488392/index.html">Production-ready images for k8s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>