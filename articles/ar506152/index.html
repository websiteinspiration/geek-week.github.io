<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¦ ğŸšº ğŸ‹ Ø¬Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ù…Ù† ÙØ¦Ø© "Ø£Ø¬Ù†Ø¨ÙŠØ©" Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… jmx Ùˆ javaassist Ùƒ javaagent ğŸ˜” ğŸ–²ï¸ ğŸ§“ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ÙŠÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚ Java EE ÙŠØ¯ÙˆØ± ÙÙŠ Ø­Ø§ÙˆÙŠØ© WildFly. Ù†Ø¸Ø§Ù… Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ¨Ø§Ø¯Ù„. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹ ØŒ ÙØ¦Ø© WMS - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª. 
 
 Ù‡Ù†Ø§Ùƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© ØŒ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ø¬Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ Ù…Ù† ÙØ¦Ø© "Ø£Ø¬Ù†Ø¨ÙŠØ©" Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… jmx Ùˆ javaassist Ùƒ javaagent</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506152/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÙŠÙˆØ¬Ø¯ ØªØ·Ø¨ÙŠÙ‚ Java EE ÙŠØ¯ÙˆØ± ÙÙŠ Ø­Ø§ÙˆÙŠØ© WildFly. </font><font style="vertical-align: inherit;">Ù†Ø¸Ø§Ù… Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ¨Ø§Ø¯Ù„. </font><font style="vertical-align: inherit;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø¦Ø¹ ØŒ ÙØ¦Ø© WMS - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ù‡Ù†Ø§Ùƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© ØŒ Ù…Ù† ÙˆÙ‚Øª Ù„Ø¢Ø®Ø± Ù„Ø¯Ù‰ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù„Ø¯ÙŠÙ†Ø§ Ø±ØºØ¨Ø© ÙÙŠ Ù…Ø¹Ø±ÙØ© Ù…Ø¯Ø© ØªØ´ØºÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø£Ùˆ ØªÙ„Ùƒ ÙÙŠ Ø£ÙŠ ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø£Ø®Ø° Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø®Ø·ÙˆØ§Øª ØŒ ÙˆÙ†Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ø¥Ø·Ø§Ø± Ù…Ø¹ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© / Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· / ÙˆØ£Ø®ÙŠØ±Ù‹Ø§ ØŒ ÙˆÙ†ÙƒØªØ¨ Ø¥Ù„Ù‰ Ù…Ù„Ù Ù…Ù†ÙØµÙ„.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ø£ÙˆÙ„ Ù…Ø§ ÙŠØªØ¨Ø§Ø¯Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø°Ù‡Ù† Ù‡Ùˆ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø´ÙŠØ¡ Ù…Ø«Ù„:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">processStep</span><span class="hljs-params">(Object object)</span></span>{
<span class="hljs-keyword">long</span> __metricStartTime = System.currentTimeMillis();
<span class="hljs-keyword">try</span>{
 <span class="hljs-comment">//   </span>
}<span class="hljs-keyword">catch</span>(Exception e){
<span class="hljs-keyword">throw</span> e;<font></font>
}<span class="hljs-keyword">finally</span> {
<span class="hljs-keyword">long</span> __metricsEndTime = System.currentTimeMillis() - __metricStartTime;<font></font>
log.debug(<span class="hljs-keyword">this</span>.getClass().getName()+<span class="hljs-string">"|processStep|"</span>+__metricsEndTime);<font></font>
}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† __metricStartTime ØŒ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† __metricsEndTime Ø¨Ø¹Ø¶ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metress.dropwizard.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">ÙˆÙ„ÙƒÙ† Ù‡Ø°Ø§ Ø³ÙŠÙƒÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ Ù…Ù†ÙØµÙ„Ù‹Ø§ ØŒ Ù…Ù† Ø£Ø¬Ù„ Ø§Ù„Ø¨Ø³Ø§Ø·Ø© ØŒ Ø£Ø³ØªØ®Ø¯Ù… ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ / ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø© ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØºÙŠÙŠØ± Ø§Ù„ÙØ¦Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙŠØ± Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ classLoader Ù„Ù‡Ø§.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø®ÙŠØ§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© / Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· / ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØŒ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø³ÙŠØ¦ Ù‡Ùˆ Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø¹Ø±Ù Ù…Ù‚Ø¯Ù…Ù‹Ø§ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªØ­ØªØ§Ø¬Ù‡Ø§ Ù„ØªØ­Ù„ÙŠÙ„ Ø³Ø±Ø¹Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ± ØŒ Ø¹Ù„ÙŠÙƒ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ø¥ØµØ¯Ø§Ø± Ø›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ÙØµÙ„ Ù„Ø¯ÙŠÙ†Ø§ ~ 10 ÙƒÙŠÙ„Ùˆ. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ø§ÙŠØª ÙƒÙˆØ¯ ØŒ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø¬Ø§ÙØ§ Ø³ÙƒØ³ÙŠ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ù…Ø² ØŒ Ù‚Ù…Øª Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙƒÙŠÙ„ Ù…Ù† Ø®Ù„Ø§Ù„ Ù‚Ø±Ø§Ø¡Ø© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ÙŠØ¨Ø¯Ùˆ Ø±Ù…Ø² Ø§Ù„Ù…ØµØ¯Ø± ÙƒÙ…Ø§ ÙŠÙ„ÙŠ:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Agent</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">premain</span><span class="hljs-params">(String agentArgs, Instrumentation instrumentation)</span> </span>{<font></font>
        instrumentation.addTransformer(<span class="hljs-keyword">new</span> ClassTransformer());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ù†ÙƒØªØ¨ ClassTransformer Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ø§. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ÙŠØ¬Ø¨ Ø£Ù† ØªØ­Ø¯Ø¯ ÙØ¦Ø© Ø§Ù„Ù…Ø­ÙˆÙ„Ø§Øª Ù„Ø¯ÙŠÙ†Ø§ Ø§Ù„ÙØ¦Ø© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ±Ù‡Ø§ ØŒ ÙˆØ£ÙŠ ÙØ¦Ø© ÙŠÙ…ÙƒÙ† ØªØ®Ø·ÙŠÙ‡Ø§. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ø°Ù„Ùƒ ØŒ Ù‚Ù…Øª Ø¨Ø¥Ù†Ø´Ø§Ø¡ ØªÙƒÙˆÙŠÙ† json Ø£Ø¯Ø±Ø¬ ÙÙŠÙ‡ Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªÙŠ Ø£Ø±ØºØ¨ ÙÙŠ ØªØ´ÙƒÙŠÙ„ Ø´ÙŠØ¡ Ù…Ø«Ù„Ù‡Ø§:</font></font><br>
<br>
<pre><code class="json hljs">{
<span class="hljs-attr">"settings"</span> : <font></font>
[<font></font>
{<font></font>
	<span class="hljs-attr">"PackageName"</span> 	: <span class="hljs-string">"com.ltm.scm.wms.utils.voice"</span>,
	<span class="hljs-attr">"className"</span> : <span class="hljs-string">"VoiceProcessor"</span>,
	<span class="hljs-attr">"Methods"</span> : [<span class="hljs-string">"completeTask"</span>, <span class="hljs-string">"processException"</span>]<font></font>
}<font></font>
,<font></font>
{<font></font>
	<span class="hljs-attr">"PackageName"</span> : <span class="hljs-string">"com.ltm.scm.wms.utils.voice.dao"</span>,
	<span class="hljs-attr">"className"</span> : <span class="hljs-string">"VoiceDAO"</span>,
	<span class="hljs-attr">"Methods"</span> : [<span class="hljs-string">"isCompleteTask"</span>, <span class="hljs-string">"getLocationType"</span>]<font></font>
},<font></font>
{<font></font>
	<span class="hljs-attr">"PackageName"</span> : <span class="hljs-string">"com.ssaglobal.scm.wms.service.drfmanagement"</span>,
	<span class="hljs-attr">"className"</span> : <span class="hljs-string">"RFInquiryP1S1"</span>,
	<span class="hljs-attr">"Methods"</span> : [<span class="hljs-string">"processStep"</span>]<font></font>
},<font></font>
{<font></font>
	<span class="hljs-attr">"PackageName"</span> : <span class="hljs-string">"ru.ltm.vc.service"</span>,
	<span class="hljs-attr">"className"</span> : <span class="hljs-string">"*"</span>,
	<span class="hljs-attr">"Methods"</span> : [<span class="hljs-string">"*"</span>]<font></font>
},<font></font>
{<font></font>
	<span class="hljs-attr">"PackageName"</span> : <span class="hljs-string">"ru.ltm.vc.controller"</span>,
	<span class="hljs-attr">"className"</span> : <span class="hljs-string">"*"</span>,
	<span class="hljs-attr">"Methods"</span> : [<span class="hljs-string">"*"</span>]<font></font>
}<font></font>
]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* - Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ Ø§Ù„Ø­Ø²Ù…Ø© Ùˆ / Ø£Ùˆ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨ ÙÙŠ Ø§Ù„ÙØµÙ„. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø«ÙˆØ§Ø¨Øª Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØµÙ</font></font></b><br>
<br>
<pre><code class="java hljs">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String METRICS_START_TIME_FIELD_SRC = <span class="hljs-string">"public static long __metricStartTime;"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String METRICS_START_TIME_FIELD_INITIALIZE_SRC = <span class="hljs-string">"System.currentTimeMillis()"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CLASS_METRICS_FIELD_SRC = <span class="hljs-string">"public static final ru.ltm.agent.jmx.ClassesMetricsProfiler metricsProfiler;"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CLASS_METRICS_FIELD_INITIALIZE_SRC = <span class="hljs-string">"new ru.ltm.agent.jmx.ClassesMetricsProfiler()"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String METRICS_START_TIME_VAR_SRC = <span class="hljs-string">"__metricStartTime"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String METRICS_START_TIME_VAR_INITIALIZE_SRC = <span class="hljs-string">"__metricStartTime = System.currentTimeMillis();"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String METRICS_END_TIME_VAR_SRC = <span class="hljs-string">"\", System.currentTimeMillis() - __metricStartTime);"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JMX_METHOD = <span class="hljs-string">"metricsProfiler.mark2(\""</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CATCH_BLOCK_SRC = <span class="hljs-string">"{ System.out.println($e); throw $e; }"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCEPTION_TYPE_SRC = <span class="hljs-string">"java.lang.Exception"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PACKAGE_DEV = <span class="hljs-string">"/"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DOT = <span class="hljs-string">"."</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String INFOR_HOME = <span class="hljs-string">"c:\\Infor\\"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String,Set&lt;Settings&gt;&gt; CLASSES_TO_INSTRUMENT = ClassRegistry.getInstance().getClasses();<font></font>
<font></font>
</code></pre><br>
<pre><code class="java hljs"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] transform(ClassLoader loader, String className, Class redefiningClass, ProtectionDomain domain, <span class="hljs-keyword">byte</span>[] bytes) <span class="hljs-keyword">throws</span> IllegalClassFormatException {<font></font>
        String clazzName = className.replace(PACKAGE_DEV,DOT);<font></font>
        <span class="hljs-keyword">if</span> (CLASSES_TO_INSTRUMENT.containsKey(clazzName)) {<font></font>
            Set&lt;Settings&gt; methodsToInstrument = CLASSES_TO_INSTRUMENT.get(clazzName);<font></font>
            <span class="hljs-keyword">return</span> transformClass(redefiningClass, bytes, methodsToInstrument);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ø§Ù„ØªØ­ÙˆÙŠÙ„:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] transformClass(Class classToTransform, <span class="hljs-keyword">byte</span>[] b, Set&lt;Settings&gt; methodsToInstrument) {<font></font>
        ClassPool pool = ClassPool.getDefault();<font></font>
        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();<font></font>
        pool.appendClassPath(<span class="hljs-keyword">new</span> LoaderClassPath(classLoader));<font></font>
        CtClass.debugDump = INFOR_HOME;<font></font>
        CtClass cl = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {<font></font>
            cl = pool.makeClass(<span class="hljs-keyword">new</span> java.io.ByteArrayInputStream(b));<font></font>
            CtField metricsField = CtField.make(CLASS_METRICS_FIELD_SRC, cl);<font></font>
            cl.addField(metricsField, CtField.Initializer.byExpr(CLASS_METRICS_FIELD_INITIALIZE_SRC));<font></font>
<font></font>
            CtField starTimeField = CtField.make(METRICS_START_TIME_FIELD_SRC, cl);<font></font>
            cl.addField(starTimeField, CtField.Initializer.byExpr(METRICS_START_TIME_FIELD_INITIALIZE_SRC));<font></font>
            CtBehavior[] methods = cl.getDeclaredBehaviors();<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; methods.length; i++) {
                <span class="hljs-keyword">if</span> (methods[i].isEmpty() == <span class="hljs-keyword">false</span>) {<font></font>
                    changeMethod(methods[i], cl, methodsToInstrument);<font></font>
                }<font></font>
            }<font></font>
            b = cl.toBytecode();<font></font>
        } <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
            e.printStackTrace();<font></font>
        } <span class="hljs-keyword">finally</span> {<font></font>
            cl.debugWriteFile(INFOR_HOME);<font></font>
            <span class="hljs-keyword">if</span> (cl != <span class="hljs-keyword">null</span>) {<font></font>
                cl.detach();<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> b;<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
String CtClass.debugDump = INFOR_HOME ØŒ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ù†Ø¸Ø± Ø¥Ù„Ù‰ Ø§Ù„ÙØµÙ„ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¬Ù…ÙŠØ¹Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„. </font><font style="vertical-align: inherit;">debugDump- Ù…ÙƒØ§Ù† Ø­ÙØ¸ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙØµÙ„.</font></font><br>
<br>
<pre><code class="java hljs">  CtField metricsField = CtField.make(CLASS_METRICS_FIELD_SRC, cl);<font></font>
            cl.addField(metricsField, CtField.Initializer.byExpr(CLASS_METRICS_FIELD_INITIALIZE_SRC));<font></font>
            CtField starTimeField = CtField.make(METRICS_START_TIME_FIELD_SRC, cl);<font></font>
            cl.addField(starTimeField, CtField.Initializer.byExpr(METRICS_START_TIME_FIELD_INITIALIZE_SRC));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ØªØ¶ÙŠÙ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ø·ÙˆØ± Ø­Ù‚Ù„ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CLASS_METRICS_FIELD_SRC - Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯ ("public static final ru.ltm.agent.jmx.ClassesMetricsProfiler metricsProfile") Ùˆ CLASS_METRICS_FIELD_INITIALIZE_SRC - "new ru.ltm.agof.jmx. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ø«ÙˆØ§Ø¨Øª Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØµÙ Ø§Ù„ØªÙŠ Ø­Ø¯Ø¯ØªÙ‡Ø§ Ø£Ø¹Ù„Ø§Ù‡. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ø·Ø±ÙŠÙ‚Ø© ØªØ¶ÙŠÙ try / catch / Ø£Ø®ÙŠØ±Ø§:</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">changeMethod</span><span class="hljs-params">(CtBehavior method, CtClass ctClass, Set&lt;Settings&gt; methodsToInstrument)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-keyword">for</span> (Object settingObj : methodsToInstrument.toArray()){<font></font>
            Settings settings  = (Settings) settingObj;<font></font>
            List&lt;String&gt; methods = settings.getMethodsToInstrument();<font></font>
            <span class="hljs-keyword">if</span> (methods.contains(method.getName()) ||<font></font>
                    ( settings.getMethodsToInstrument().get(<span class="hljs-number">0</span>).equalsIgnoreCase(<span class="hljs-string">"*"</span>) &amp;&amp;<font></font>
                            !method.getName().equalsIgnoreCase(<span class="hljs-string">"&lt;clinit&gt;"</span>) &amp;&amp;<font></font>
                            !method.getName().startsWith(<span class="hljs-string">"lambda$"</span>)) ){<font></font>
<font></font>
                String metricName = ctClass.getPackageName() + DOT + ctClass.getSimpleName() + DOT + method.getName();<font></font>
                method.insertBefore(METRICS_START_TIME_VAR_INITIALIZE_SRC);<font></font>
                CtClass etype = ClassPool.getDefault().get(EXCEPTION_TYPE_SRC);<font></font>
                method.addCatch(<span class="hljs-string">"{ throw $e; }"</span> , etype);<font></font>
                method.insertAfter( JMX_METHOD + metricName + METRICS_END_TIME_VAR_SRC,<span class="hljs-keyword">true</span>);<font></font>
<font></font>
<font></font>
            }<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JMX_METHOD - Ø¶Ø¹ ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ø­Ø¨ÙˆØ¨ jmx. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø© Ù‡ÙŠ Ø´ÙŠØ¡ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø¨ÙŠÙ„: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2w/sd/fo/2wsdfotlwbp8wlvhlxbfvjd19yg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ÙŠÙ…ÙƒÙ† Ù‚ÙŠØ§Ø³ Ø£ÙŠ ÙØ¦Ø© Ø£Ùˆ Ø­Ø²Ù…Ø© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø² ÙŠØ¯ÙˆÙŠÙ‹Ø§</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ØªÙ„ØºØ±Ø§Ù ØŒ Ù†Ø³Ø­Ø¨ ØµÙ†Ø§Ø¯ÙŠÙ‚ jmx ÙˆÙ†Ø®Ø±Ø¬Ù‡Ø§ Ø¥Ù„Ù‰ grafana ØŒ ÙˆØ´ÙŠØ¡ Ù…Ø«Ù„ Ù‡Ø°Ø§ ÙŠØ¨Ø¯Ùˆ ÙƒÙ…Ø§ ÙŠÙ„ÙŠ: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kh/fp/ja/khfpjadnefo9ipmbyvdmgglrya0.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©</font></font></b></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar506140/index.html">Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª ØªØ­Ø¬ÙŠÙ… PostgreSQL. Ø£Ù„ÙŠÙƒØ³ÙŠ Ù„ÙŠØ³ÙˆÙØ³ÙƒÙŠ</a></li>
<li><a href="../ar506144/index.html">Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ù…Ù†ØµØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ± 1C Ùˆ Client Communicator</a></li>
<li><a href="../ar506146/index.html">Ù…Ø§Ø°Ø§ ÙŠÙØ¹Ù„ Ù…Ø­Ù„Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆÙƒÙŠÙ ÙŠØµØ¨Ø­ ÙˆØ§Ø­Ø¯Ø§</a></li>
<li><a href="../ar506148/index.html">Ø¹Ù„Ù… Ø¥Ø¯Ø±Ø§Ùƒ Ø§Ù„Ù„ÙˆÙ† ÙŠØ­ÙˆÙ„ Ø¹Ù„Ø§Ù‚ØªÙ†Ø§ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª</a></li>
<li><a href="../ar506150/index.html">Ø§Ù†Ø·Ù„Ù‚ Ø¥Ù„Ù‰ SETI: Ø§Ù„Ø­ÙˆØ³Ø¨Ø© Ø§Ù„Ø·ÙˆØ¹ÙŠØ© Ù„Ù„Ù…ØªØ´ÙƒÙƒÙŠÙ† ÙˆØ§Ù„Ù…ØªÙØ§Ø¦Ù„ÙŠÙ† ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©</a></li>
<li><a href="../ar506158/index.html">useSWR Ù‡ÙŠ Ù…ÙƒØªØ¨Ø© React Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</a></li>
<li><a href="../ar506164/index.html">#nodesigndev: ØªØµÙ…ÙŠÙ… Ø¨Ø£ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†</a></li>
<li><a href="../ar506166/index.html">ØªÙƒÙˆÙŠÙ† Ø´Ø¨ÙƒØ© Ø¹ØµØ¨ÙŠØ© Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©</a></li>
<li><a href="../ar506168/index.html">Ø¯Ù„ÙŠÙ„ Ø±Ø§Ø¦Ø¹ Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Google: ÙƒÙŠÙÙŠØ© Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ÙˆÙ…Ø¹Ø±ÙØ© ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª</a></li>
<li><a href="../ar506170/index.html">Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ø±Ø¯Ø©. Ø§Ù„Ø¬Ø²Ø¡ 1: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>