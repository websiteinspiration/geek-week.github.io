<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚓 👨🏽‍🔧 🧑🏿‍🤝‍🧑🏼 Linux上的快速路由和NAT 🦖 😈 ❣️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="随着IPv4地址耗尽，许多电信运营商面临着使用地址转换来组织其客户对网络的访问的需求。在本文中，我将告诉您如何在商用服务器上获得电信级NAT级别的性能。
 
 一点历史
 耗尽IPv4地址空间的话题不再是新话题。在某个时候，等待名单出现在RIPE中，然后有一些交易所，他们在这些交易所上交换地址块并完...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linux上的快速路由和NAT</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">随着IPv4地址耗尽，许多电信运营商面临着使用地址转换来组织其客户对网络的访问的需求。</font><font style="vertical-align: inherit;">在本文中，我将告诉您如何在商用服务器上获得电信级NAT级别的性能。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一点历史</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
耗尽IPv4地址空间的话题不再是新话题。在某个时候，等待名单出现在RIPE中，然后有一些交易所，他们在这些交易所上交换地址块并完成租金交易。逐渐地，电信运营商开始通过地址和端口的转换来提供Internet访问服务。某人没有设法获得足够的地址来给每个订户一个“白色”地址，而某人通过拒绝在二级市场上购买地址而开始省钱。网络设备制造商支持这一想法，因为此功能通常需要其他扩展模块或许可证。例如，在MX路由器阵容中使用瞻博网络（最新的MX104和MX204除外），NAPT可以在单独的MS-MIC服务卡上执行，Cisco ASR1k需要GN许可证，在Cisco ASR9k上，有一个单独的A9K-ISM-100模块和一个A9K-CGN-LIC许可证。一般来说，享乐要花很多钱。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iptables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
执行NAT的任务不需要专门的计算资源；例如，安装在任何家庭路由器中的通用处理器都可以解决该问题。</font><font style="vertical-align: inherit;">从运营商的角度来看，可以使用运行FreeBSD（ipfw / pf）或GNU / Linux（iptables）的商用服务器解决此问题。</font><font style="vertical-align: inherit;">我们不会考虑FreeBSD，因为 </font><font style="vertical-align: inherit;">我拒绝长时间使用此操作系统，因此让我们关注GNU / Linux。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
打开地址转换一点都不困难。</font><font style="vertical-align: inherit;">首先，您需要在nat表的iptables中编写规则：</font></font><br>
<br>
<pre><code class="bash hljs">iptables -t nat -A POSTROUTING -s 100.64.0.0/10 -j SNAT --to &lt;pool_start_addr&gt;-&lt;pool_end_addr&gt; --persistent
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
操作系统将加载nf_conntrack模块，该模块将监视所有活动的连接并执行必要的转换。</font><font style="vertical-align: inherit;">有几个微妙之处。</font><font style="vertical-align: inherit;">首先，由于我们是在运营商规模上谈论NAT，因此有必要收紧超时时间，因为使用默认值，转换表的大小将迅速增长到灾难性的值。</font><font style="vertical-align: inherit;">以下是我在服务器上使用的设置的示例：</font></font><br>
<br>
<pre><code class="bash hljs">net.ipv4.ip_forward = 1<font></font>
net.ipv4.ip_local_port_range = 8192 65535<font></font>
<font></font>
net.netfilter.nf_conntrack_generic_timeout = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_established = 600<font></font>
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 45<font></font>
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30<font></font>
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close = 10<font></font>
net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300<font></font>
net.netfilter.nf_conntrack_udp_timeout = 30<font></font>
net.netfilter.nf_conntrack_udp_timeout_stream = 60<font></font>
net.netfilter.nf_conntrack_icmpv6_timeout = 30<font></font>
net.netfilter.nf_conntrack_icmp_timeout = 30<font></font>
net.netfilter.nf_conntrack_events_retry_timeout = 15<font></font>
net.netfilter.nf_conntrack_checksum=0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
其次，由于转换表的默认大小不是为在电信运营商的条件下工作而设计的，因此必须增加它：</font></font><br>
<br>
<pre><code class="plaintext hljs">net.netfilter.nf_conntrack_max = 3145728
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 还需要增加存储所有转换的哈希表的存储桶数（这是nf_conntrack模块的一个选项）： </font></font><br>
<br>
<pre><code class="plaintext hljs">options nf_conntrack hashsize=1572864
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
经过这些简单的操作，即可获得一个完全正常的构造，该构造可以将大量客户端地址转换为外部池。但是，此解决方案的性能很差。在我第一次尝试将GNU / Linux用于NAT时（大约在2013年），我能够以每服务器0.8Mpps的速度（Xeon E5-1650v2）获得大约7Gbit / s的性能。自那时以来，在GNU / Linux内核网络堆栈中进行了许多不同的优化，同一硬件上的一台服务器的性能在1.8-1.9 Mpps（这些是极限值）下已几乎提高到18-19 Gbit / s，但是对于流量的需求，由单个服务器处理，增长速度更快。结果，开发了适用于不同服务器的负载平衡方案，但这增加了设置的复杂性，服务并保持所提供服务的质量。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">耐用品</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如今，在软件“数据包传输”中，DPDK和XDP的使用已成为一种流行的方向。</font><font style="vertical-align: inherit;">关于此主题的文章很多，进行了许多不同的演示，出现了商业产品（例如，来自VasExperts的SKAT）。</font><font style="vertical-align: inherit;">但是，在电信运营商的程序员资源有限的情况下，在这些框架的基础上削减某种“份额”是很成问题的。</font><font style="vertical-align: inherit;">将来要操作这种解决方案将更加困难，特别是，有必要开发诊断工具。</font><font style="vertical-align: inherit;">例如，带有DPDK的常规tcpdump不能正常工作，它也不会“看到”使用XDP发送回线路的数据包。</font><font style="vertical-align: inherit;">在所有关于将数据包转发输出到用户空间的新技术的讨论中，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">报告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">文章</font></a><font style="vertical-align: inherit;">都没有引起注意。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iptables维护者Pablo Neira Ayuso，致力于发展nftable中的流量分流。让我们更详细地研究这种机制。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主要思想是，如果路由器在流的两侧传递了一个会话的数据包（TCP会话进入ESTABLISHED状态），则无需通过所有防火墙规则传递此会话的后续数据包，因为通过将数据包进一步传送到路由，所有这些检查将在同一端。是的，实际上不需要选择路由-我们已经知道在该会话中哪个接口和哪个主机应该转发数据包。仅保留此信息并将其用于数据包处理的早期阶段进行路由。执行NAT时，有必要另外保存有关由nf_conntrack模块转换的地址和端口的更改的信息。是的，当然，在这种情况下，iptables中的各种聚合器和其他信息统计规则将停止工作，但是作为单独的独立NAT或例如边界的任务的一部分，这并不是很重要，因为服务是跨设备分布的。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组态</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要使用此功能，我们需要：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用新的内核。</font><font style="vertical-align: inherit;">尽管该功能本身出现在4.16内核中，但相当一段时间以来，它还是“原始的”，经常被称为内核恐慌。</font><font style="vertical-align: inherit;">LTS内核4.19.90和5.4.5于2019年12月发布时，一切都趋于稳定。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用较新版本的nftables以nftables格式重写iptables规则。</font><font style="vertical-align: inherit;">在0.9.0版中正常工作</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果第一段在原则上说清楚，最主要的是不要忘记在组装过程中将模块包括在配置中（CONFIG_NFT_FLOW_OFFLOAD = m），那么第二段需要说明。</font><font style="vertical-align: inherit;">nftables规则与iptables中的描述完全不同。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该文档</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">揭示了几乎所有的要点，还有</font><font style="vertical-align: inherit;">从iptables到nftables的</font><font style="vertical-align: inherit;">特殊</font><font style="vertical-align: inherit;">规则</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换器</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，我仅举一个设置NAT和流量卸载的示例。</font><font style="vertical-align: inherit;">一个小例子：&lt;i_if&gt;，&lt;o_if&gt;是流量通过的网络接口，实际上可以有两个以上。</font><font style="vertical-align: inherit;">&lt;pool_addr_start&gt;，&lt;pool_addr_end&gt;-“白色”地址范围的开始和结束地址。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NAT配置非常简单：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table nat {<font></font>
        chain postrouting {<font></font>
                <span class="hljs-built_in">type</span> nat hook postrouting priority 100;<font></font>
                oif &lt;o_if&gt; snat to &lt;pool_addr_start&gt;-&lt;pool_addr_end&gt; persistent<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
流量卸载有点复杂，但可以理解：</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table inet filter {<font></font>
        flowtable fastnat {<font></font>
                hook ingress priority 0<font></font>
                devices = { &lt;i_if&gt;, &lt;o_if&gt; }<font></font>
        }<font></font>
<font></font>
        chain forward {<font></font>
                <span class="hljs-built_in">type</span> filter hook forward priority 0; policy accept;<font></font>
                ip protocol { tcp , udp } flow offload @fastnat;<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实际上，这就是整个设置。</font><font style="vertical-align: inherit;">现在，所有TCP / UDP流量都将进入fastnat表，并且处理速度将大大提高。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了清楚地知道这是“快得多”，我将在两个相同硬件的真实服务器（至强E5-1650v2）上使用相同的Linux内核，但在iptables（NAT4）和nftable（NAT5）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y7/ov/c7/y7ovc7nkxxoply2apwjtur9tj-m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
屏幕截图中没有每秒的数据包图，但是在这些服务器的负载配置文件中，平均数据包大小约为800字节，因此值高达1.5Mpps。</font><font style="vertical-align: inherit;">如您所见，具有nftable的服务器的性能裕度非常大。</font><font style="vertical-align: inherit;">当前，该服务器以3Mpps的速度处理高达30Gbit / s的速度，并且显然能够在没有可用CPU资源的情况下遇到40Gbps网络的物理限制。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我希望这些材料对试图提高服务器性能的网络工程师有用。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN501220/index.html">解析：公司可以有太多钱吗？</a></li>
<li><a href="../zh-CN501222/index.html">制定IT战略时应用COBIT</a></li>
<li><a href="../zh-CN501224/index.html">什么神经网络可以“唱歌”并执行死亡金属</a></li>
<li><a href="../zh-CN501226/index.html">快速文件搜索</a></li>
<li><a href="../zh-CN501232/index.html">IT专家如何才能从他的知识中获得更多收益</a></li>
<li><a href="../zh-CN501236/index.html">那么，“蛋白质折叠”到底是什么呢？</a></li>
<li><a href="../zh-CN501240/index.html">现场安全审核</a></li>
<li><a href="../zh-CN501244/index.html">程序员不必解决业务问题</a></li>
<li><a href="../zh-CN501246/index.html">正确的Covid-19图形</a></li>
<li><a href="../zh-CN501248/index.html">JavaScript工作场所名人堂，第2部分</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>