<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏁 🕤 👨🏼‍✈️ 正如Sports.ru写的所见即所得编辑器 ⚾️ 🧑🏿‍🤝‍🧑🏻 🔯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在2018年中，Sports.ru考虑过将新的WYSIWYG文本编辑器用于用户帖子。自2019年6月以来，该编辑器一直处于beta模式。在这段时间内，我们解决了与整个服务的体系结构设计以及基于ProseMirror库的浏览器中编辑器本身的实现相关的许多问题，并决定分享我们的经验。
 
 
 
 目录...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>正如Sports.ru写的所见即所得编辑器</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sports_ru/blog/492228/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在2018年中，Sports.ru考虑过将新的</font></font><abbr title="你所看到的就是你得到的"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WYSIWYG</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文本编辑器用于用户帖子。</font><font style="vertical-align: inherit;">自2019年6月以来，该编辑器一直处于beta模式。</font><font style="vertical-align: inherit;">在这段时间内，我们解决了与整个服务的体系结构设计以及基于</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProseMirror</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库的浏览器中编辑器本身的实现相关的许多问题</font><font style="vertical-align: inherit;">，并决定分享我们的经验。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wc/2p/ag/wc2pagubhgtlo-bvev4wjyfmrsk.png"><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目录</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.引言</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1。</font><font style="vertical-align: inherit;">为什么需要所见即所得</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2。</font><font style="vertical-align: inherit;">开发人员面临的任务描述</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.如何选择工具</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.发生了什么</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1 </font><font style="vertical-align: inherit;">服务架构</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2。</font><font style="vertical-align: inherit;">挑战是什么</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Beta测试结果</font></font></a><br>
<br>
<a name="Intro"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.简介</font></font></h2><br>
<a name="Why"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1。</font><font style="vertical-align: inherit;">为什么需要所见即所得</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sports.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是有关体育的媒体，每月有2000万用户。我们与经典媒体的主要区别在于社区和</font></font><abbr title="用户生成内容"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">教资会</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。用户内容-评分，评论，聊天，帖子-不仅可以补充社论的价值，而且可以为用户相互交流提供平台。每个月，我们的用户撰写近一万篇文章。最好的与编辑的内容一起提交到网站的主页，发送到移动应用程序，社交网络。用户内容约占Sports.ru页上所有阅读内容的40％。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们希望成为体育作家最方便的平台，以帮助创建内容并将其交付给感兴趣的受众。我们使用</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">TinyMCE</font></a><font style="vertical-align: inherit;">编辑器</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">已有</font></a><font style="vertical-align: inherit;"> 10年了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-最后，它变得过时了，它不再适合于团队和习惯于现代编辑的用户。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ff/ub/ig/ffubigpbednsp8phz7btg-icbm8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font><font style="vertical-align: inherit;">1.基于TinyMCE的旧编辑器的界面</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
博客作者定期收到有关以下投诉的信息：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我写了很长时间，然后不小心合上了标签，一切都消失了。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">写长篇文章很不方便；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">令人讨厌的是，要插入每张图片，您必须先将其上传到图片托管。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
团队也有自己的抱怨：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在TinyMCE中，您不能直接从文件上传图像，只能将链接附加到图像，并且由于用户无法将图像上传到我们的存储，如果链接失效，我们将无能为力。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编辑和格式化文本的可能性不均衡。</font><font style="vertical-align: inherit;">一方面，没有足够的样式，例如，文本中的内部标题。</font><font style="vertical-align: inherit;">另一方面，可以以任何组合使用可用的工具。</font><font style="vertical-align: inherit;">结果，职位看起来不统一（在Sports.ru，开始执行设计系统，用户职位应与其保持一致）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内容是用HTML创建和存储的，因此很难在不同客户端上管理帖子中的样式，仅更改帖子的布局即可。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来是一个关于我们如何解决在前端侧创建新编辑器的问题的故事。</font><font style="vertical-align: inherit;">的确，关于产品，设计和后端部件也将有所涉及，因为如果没有这些，将很难理解为什么要在前端做出特定的决定。</font></font><br>
<br>
<a name="Task"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2。</font><font style="vertical-align: inherit;">开发人员面临的任务说明</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
简而言之，我们最初借鉴的论点是：在Sports.ru上博客是一种痛苦。</font><font style="vertical-align: inherit;">原则上，可能不做一个新的编辑器，而只是添加自动保存功能，并可以将图片上传到自己的存储中-这样，来自用户和员工的大部分投诉都将消失。</font><font style="vertical-align: inherit;">但是我仍然不想在旧技术上支持该工具，而是创建一个可以轻松开发和扩展的新的现代编辑器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了不方便的界面之外，旧编辑器的主要技术问题之一是，帖子的内容立即保存为HTML字符串，并且帖子外观的更改要么需要后端开发人员的干预，要么在运行时在客户端上实现（例如，广告单元的放置）在帖子的正文中）。除其他事项外，我们的任务是将数据与其表示分离，从而将布局和界面保留在客户端代码中，并使用服务器代码中的数据。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为榜样，我们采用了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Medium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，有时还利用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Doc的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">想法</font><font style="vertical-align: inherit;">。除了解决已经发现的问题外，我们还决定添加一些新功能，使使用编辑器更加舒适：</font></font><br>
<br>
<ul>
<li>  WYSIWYG, .. what you see is what you get (. « ,   »,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>),           ,     .     ,      ;</li>
<li>  (      ,       ,      ,   ,    ; ,           )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同时，编辑者本人不应与Sports.ru的功能联系在一起，因为Sports.ru虽然是我们公司的旗舰项目，但仍然不是唯一的项目。该公司还开发了国际体育媒体</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tribuna</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这是一个针对博彩爱好者Betting </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的社交网络，</font><font style="vertical-align: inherit;">最近还成立了自己的从事广告项目的制作工作室。开发在线编辑器非常昂贵，以至于不想在具有不同排版和样式的另一个站点上重复使用此代码，并拥有自己的一组编辑和格式化工具。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们有很多文本内容，在开始创建新的帖子编辑器之前，我们考虑了如何存储此内容。 TinyMCE没有给我们选择的余地，而内容只能存储为HTML，如上所述，这不适合团队使用。结果，我们想出了自己的格式来存储符合我们要求的文本数据，并将其称为结构化主体。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结构化主体是反映内容结构的一系列对象。在这种情况下，内容分为独立块的元素，例如，段落，列表，图片。元素存储有关其类型和属性的信息。例如，字幕块描述了文本中的标题，它必须包含文本和级别字段。因此，文本包含该标题的文本，级别包含级别（从1到4）。例如，由一个二级头组成的结构化主体可能看起来像这样：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> structuredBody = [<font></font>
    {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;    <span class="hljs-attr">type</span>: <span class="hljs-string">'subtitle'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-attr">value</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    <span class="hljs-attr">text</span>: <span class="hljs-string">'    '</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-attr">level</span>: <span class="hljs-number">2</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },<font></font>
    },<font></font>
];<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
向结构化主体的过渡使我们能够开始分离业务逻辑，数据及其表示的过程。最终，我们希望服务器和客户端仅交换数据。以及如何以及为什么将这些数据显示给最终用户，每个客户将独立确定。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
格式化主体格式的内容存储在JSON中，并且为了验证其内容，我们创建了一个</font><font style="vertical-align: inherit;">称为结构化主体架构</font><font style="vertical-align: inherit;">的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSON</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模式。此图描述了所有有效元素及其属性。因此，我们可以确定在需要结构化主体的任何地方都使用一组键和值。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
而且，它允许不同的团队使用相同的服务来处理这种格式的内容。例如，用于从用于显示内容的结构化主体生成HTML的服务或用于创建内容的编辑器。这显着降低了开发和支持与内容的创建和显示有关的服务的整个核心的成本。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假定新编辑者应仅接受结构化主体格式的输入和输出内容。这里必须要考虑到一个微妙的问题：由于以前的帖子是立即以HTML格式保存的，因此数据库中的HTML字符串已传输给客户端以供显示（在下文中，除非另有说明，否则客户端仅指浏览器）。现在，我们希望将所有帖子的内容存储在结构化的正文中，但是客户只能处理HTML。因此，除了转移到新编辑器的任务之外，同时实现了一种新的任务，即为客户显示一种新的方式来显示帖子以直接从结构化主体读取。我们认为最好零食大象，所以首先需要完全放弃TinyMCE，然后才采用显示帖子以供阅读的逻辑。此外，并非所有旧帖子都设法将内容转换为新格式，这意味着这些帖子将始终仅以HTML格式存储，因此有必要保留它们的阅读能力。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总计：部分帖子（已成功转移到新格式的所有新旧帖子）将以两种格式存储-HTML和结构化正文-直到实现了用于阅读的新显示逻辑，其余的（大部分是旧的和非常旧的）帖子）将仅保留在HTML中。</font></font><br>
<br>
<a name="How"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.如何选择工具</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
考虑到上述功能和限制，我们必须实现在客户端上编辑和创建帖子的功能。与往常一样，您可以采用现成的解决方案，也可以提出自己的解决方案。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们检查了用于创建所见即所得编辑器的现成库以及它们是否适合我们。我们选择了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slate</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Draft.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProseMirror</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了将内容存储在数据结构中之外，对我们来说，关键时刻还在于能够使用Vue或纯JS，因为我们已经开始使用Vue + Vuex将网站迁移到新的技术堆栈中。另外，如有必要，我想借助新模块（第三方或自写）扩展成品库的功能。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标签。</font><font style="vertical-align: inherit;">1.通过Sports.ru的最重要参数比较审阅的库，</font></font></i><br>
<img src="https://habrastorage.org/webt/fw/hf/xa/fwhfxa6ozwkyfdpdj8t6j5lcbuy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
从表中可以看出，ProseMirror完全符合我们的要求，因此我们不再考虑编写自己的库以编辑文本内容的想法，而是开始更详细地研究该库。</font><font style="vertical-align: inherit;">还有一个相当流行的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quill</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它并没有进入我们的比较，只是因为我们在选择工具的阶段诚实地忘记了它。</font><font style="vertical-align: inherit;">根据我们的关键要求，它也可以通过，但是确实如此。</font><font style="vertical-align: inherit;">在另</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一篇文章中，</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们已经讨论了ProseMirror是什么以及如何使用它</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="What"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.发生了什么事</font></font></h2><br>
<a name="Architecture"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1。</font><font style="vertical-align: inherit;">服务架构</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
客户端上的内容编辑器本身远非如此。</font><font style="vertical-align: inherit;">您需要将编辑器放置在现有项目中，将其显示在网页上的某个位置，还要考虑与后端的交互，解决同时支持两个编辑器（您不能立即放弃旧的编辑器）并以两种格式（HTML和结构化格式）存储内容的问题身体）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有这些任务可以分为与前端，后端及其集成相关的任务。</font><font style="vertical-align: inherit;">尽管我们还提到了后端任务的两个重要方面，但我们主要关注前端和集成问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
编辑器的前端服务可以分为几个级别：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于创建和编辑帖子的网页；</font></font></li>
<li>Vue-app,    .  ,  ,   Vue,         -, , , ,       ..,    ,         ,      ;</li>
<li>WYSIWYG-   ProseMirror,      Vue.      ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>;</li>
<li>SB2HTML –    HTML  structured body,    .    , structured body –       ,    .      ,   ,     ,      .    Sports.ru     HTML  structured body,  -     HTML  .       HTML    Node.Js,        JS-   .<br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
保存帖子的过程如图2所示。</font><font style="vertical-align: inherit;">2.具有结构化正文格式的帖子内容及其元数据将传输到后端。</font><font style="vertical-align: inherit;">后端将内容发送到SB2HTML服务，在响应中接收就绪的HTML，将所有这些都放入数据库中，并告诉客户端帖子已成功保存，或报告错误。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/of/fp/j8/offpj883_eq2swjl-ogb6jxprks.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font><font style="vertical-align: inherit;">2.在所见即所得编辑器中创建或编辑时用于保存帖子的方案</font></font></i><br>
<br>
<a name="Difficulties"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2。</font><font style="vertical-align: inherit;">您遇到了什么困难？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有许多困难，它们经常在最意想不到的时刻不断出现。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就像我们已经说过的那样，内容编辑器位于表单内部，它使您可以输入创建帖子所必需的其他数据，例如标题，注释等。对于注释，应该可以从文件中或通过Internet链接下载图像。但是对于内容，我们还希望根据相同的规则从文件中加载图像，并通过引用加载图像。这里我们面临一个难题：一方面，帖子的内容在编辑时与外部表单隔离开来，并由ProseMirror工具提供服务，但另一方面，我想观察</font><abbr title="Don't Repeat Yourself"><font style="vertical-align: inherit;">DRY</font></abbr><font style="vertical-align: inherit;">原理</font></font><abbr title="不要重复自己"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且不要重复相同的代码。我们按以下方式解决了这一问题：我们将在Vue表单级别的对象中将图像加载为一组方法，并将该对象作为参数之一传递给WYSIWYG编辑器的构造函数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在ProseMirror模型中定义了描述内容的实体（节点和片段）。但是，仅索引用于事务来确定应用此事务的字符范围（从文档的开头和父节点的开头开始都对索引进行计数）。字符索引是ProseMirror的核心概念之一，但是在编辑和设置文本格式时，考虑ProseMirror模型中的实体要方便得多。因此，为了舒适地处理内容，我们编写了助手来简化与交易文档的交互。在工作开始之后，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出现</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Tiptap</font></a><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">，它是一组类似的帮助程序。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一个问题是，在创建方案的阶段，我们意识到我们已经拥有一种批准的用于存储内容的内部格式-可以满足我们需求的结构化主体，并且ProseMirror将内容以其自己的格式存储在故事中。切换到ProseMirror格式既困难又不切实际。我们发现自己处于一种情况，即一种格式的数据通过API到达客户端，而另一种格式则需要显示。当有必要保存修改或创建的内容时，会发生类似情况。为此，我们实现了一个转换器，可以来回转换格式。他们为他编写了一个简单的测试，该测试以结构化正文格式获取一篇帖子的内容，将其转换为ProseMirror格式，然后返回并已将原始版本与收到的帖子进行了比较。事实证明，这一过程既快速又轻松。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将来，随着文档方案的更改，并且通常变得更加复杂，很明显，最细微的更改都可能导致编辑器中的错误，并且这样的测试似乎覆盖面很差。结果，我不得不用两种小型转换器方法对几乎所有节点和品牌组合进行测试。现在，如果没有这些测试，就无法确定电路的下一个变化是否会破坏某些东西。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一个问题再次与对旧技术和新技术的向后兼容性的需求有关。我们的WYSIWYG编辑器仅在浏览器（台式机和移动版）中实现。因此，为了在客户端上编辑内容，使用格式结构体以JSON形式给出，但是，浏览器中的阅读文章仅从HTML执行。同时，大多数移动应用程序已切换为直接从结构化主体显示用户帖子。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于移动应用程序，必须提供客户端无法处理结构化主体中某些元素的情况。例如，如果将新元素添加到结构化主体，则仅在应用程序的较新版本中实现其显示。由于并非所有用户都同时更新其应用程序，因此有必要为旧版本提供计划“ B”：与其从结构化主体中创建HTML，不如为所需元素插入现成的HTML片段。结构化主体方案中未提供每个元素的HTML片段的存在，因为该结构的初衷是拒绝将数据存储在HTML中。但是最后，我们得出的结论是，我们需要两种结构化的主体方案-一种用于显示，另一种用于编辑。方案之间的区别是用于编辑的结构化主体仅包含文章的内容，并且为了显示，我们添加了一些其他元素。特别是，将帖​​子保存在SB2HTML服务中时，将为每个元素创建一个HTML片段，并且仅将其添加到结构化正文中以显示该帖子。另外，结构化主体还在内容中显示广告空间以供显示。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当我们在浏览器中打开要编辑的内容时，基本上不会遇到未知元素，因为所有帖子都是以相同的方式创建和显示的。但是他们决定也预见将来会有这样的情况。为此，我们向ProseMirror模式添加了一个默认的stub元素。我们将此元素命名为unsupportedBlock。存根将显示在不支持的项目的位置。我们将其样式化为带有文本的灰色矩形，指出该元素不受支持并且无法编辑。保存帖子后，此类元素在结构化主体中保持不变。用户可以更改其相对于其他元素的位置，但是无法更改或编辑未知元素的内部内容。但是，用户可以删除这样的元素，然后，当然，它不会保存在最终文档中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所描述的所有问题都与实现所见即所得编辑器本身的困难有关。但是，尽管它以beta模式存在，但我们不能放弃TinyMCE上的旧编辑器，而被迫支持这两种编辑器，从而提供它们之间的向后兼容性。例如，您可以在WYSIWYG编辑器中创建一个帖子，保存，然后在TinyMCE中对其进行编辑，保存，然后在WYSIWYG中再次打开，依此类推。结果，在所见即所得中打开时，我们看到的内容与之前在TinyMCE中保存的内容相同。为了实现向后兼容，必须将HTML内容提交给TinyMCE，我们已经学会了如何从结构化主体创建HTML内容并在保存帖子的同时将其保存到数据库。当通过TinyMCE保存帖子时，服务器上创建的内容将通过HTML2SB服务运行，结果，我们可以保存新鲜的HTML和结构化的正文。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTML2SB与SB2HTML的功能相反，即将SB2HTML的内容从HTML转换为结构化主体。</font><font style="vertical-align: inherit;">按时间顺序，此服务首先出现，因为在创建所见即所得编辑器之前，以结构化主体格式获取帖子内容的唯一方法是直接从HTML解析。</font><font style="vertical-align: inherit;">HTML2SB是帖子编辑器的后端基础结构的一部分，但是在放弃TinyMCE之后，就不再需要它了。</font></font><br>
<br>
<a name="Results"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Beta结果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，所见即所得编辑器已向所有用户提供Beta版，并将很快成为Sports.ru帖子的主要编辑者。</font><font style="vertical-align: inherit;">我们已经收到了用于创建和编辑帖子的工具，该工具可以满足我们的大多数要求：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编辑器的界面变得清晰，简洁，现代，撰写长帖子变得更加容易；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，您可以从文件中下载图像并通过链接立即将其下载到我们的存储库中；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加了从主要社交网络和视频托管网站嵌入嵌入的选项；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">清理文本格式样式；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移动应用程序已经切换到显示结构化正文中的帖子，并且可以设置自己的内容样式。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然，编辑器尚未完全调试，我们会定期检测到新的错误。</font><font style="vertical-align: inherit;">以下更新即将发布：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自动保存;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所见即所得版本，用于具有扩展权限的用户（管理员，专职编辑器）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过移动浏览器创建和编辑帖子；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有关多个用户并行编辑文档的消息；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提示和入职；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运动队，比赛和阵容的统计小部件。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在撰写本文时，已经通过Beta版编辑器发布了13,000多个帖子，约占Sports.ru在2019年6月至2020年2月（含）期间用户文本总数的20％。通过新编辑器创建和发布的帖子所占的份额正在稳步增长。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/2i/4b/ad2i4b4dubgv9--l-vl7ghh6cnw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。 3.在新编辑器中创建和发布的用户帖子的比例</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
似乎通过新编辑器创建和发布的用户帖子所占比例的有机增长表明用户对更新感到满意，这一点也得到了Beta测试发布公告中的反馈的肯定（其中一些如图4所示）。</font><font style="vertical-align: inherit;">因此，在接下来的几个月中，我们计划将帖子的创建工作完全转移给新编辑，以便仅专注于其支持和发展。&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
顺便说一句，您将向我们的所见即所得编辑器中添加什么功能？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k-/bm/nz/k-bmnzzgoh5wi-nvq516-pca8uk.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图。</font><font style="vertical-align: inherit;">4.用户在发布所见即所得编辑器更新的帖子中发表评论&nbsp;</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN492216/index.html">在构建阶段在.Net应用程序中保存值</a></li>
<li><a href="../zh-CN492218/index.html">要记住的图标设计规则</a></li>
<li><a href="../zh-CN492220/index.html">熊猫的5个鲜为人知的秘密</a></li>
<li><a href="../zh-CN492222/index.html">撰写的CTFZone Quals 2019：鸡肉</a></li>
<li><a href="../zh-CN492226/index.html">托管Kubernetes的价格比较（2020）</a></li>
<li><a href="../zh-CN492232/index.html">Smartcalls如何成为Voximplant Kit的品牌-品牌重塑和杀手features</a></li>
<li><a href="../zh-CN492234/index.html">研究：为什么人们准备减少在社会项目中的收入</a></li>
<li><a href="../zh-CN492242/index.html">M5Stack及其联系人</a></li>
<li><a href="../zh-CN492244/index.html">冠状病毒清除期：家庭“逮捕”或机会时机？</a></li>
<li><a href="../zh-CN492246/index.html">冠状病毒：对社会，经济和医学的可能影响</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>