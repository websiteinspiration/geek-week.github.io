<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♻️ 👲🏻 👩🏻‍💻 単純な<img>タグはどのようにしてビジネスのリスクになる可能性がありますか？ 🧗 👩🏼‍🚀 ⚗️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="実際の例による安全性は常に興味深いものです。
 
 今日はSSRF攻撃について説明します。サーバーがimgタグを介してインターネットに任意のリクエストを送信するように強制できます。
 
 
 
 そのため、私は最近2つのプロジェクトで同時に侵入テストに従事しましたが、そのうちの2つでこの脆弱性が明ら...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>単純な<img>タグはどのようにしてビジネスのリスクになる可能性がありますか？</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470996/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際の例による安全性は常に興味深いものです。</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日はSSRF攻撃について説明します。サーバーがimgタグを介してインターネットに任意のリクエストを送信するように強制できます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c1a/e7e/e3d/c1ae7ee3d053f0809e9d22c320924a18.jpg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、私は最近2つのプロジェクトで同時に侵入テストに従事しましたが、そのうちの2つでこの脆弱性が明らかになりました。</font><font style="vertical-align: inherit;">スクリーンショットはレポートから直接取得されるため、不要な情報はすべて塗りつぶされます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">攻撃の説明</font></font></h3><br>
<a name="habracut"></a><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">攻撃名：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーは、PDFドキュメントの生成中にインターネットに任意のリクエストを送信します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PDFは、すべての外部リソースとともに完全にレンダリングされたHTMLページからサーバー側で生成されます。</font><font style="vertical-align: inherit;">ドキュメントには、ユーザーが入力したデータが含まれていました。</font><font style="vertical-align: inherit;">適切なフィルタリングがなければ、サーバーレンダリングで外部リソースを置き換えることができます。</font><font style="vertical-align: inherit;">この場合、それを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it-band.by/10gb.blob</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルとします</font><font style="vertical-align: inherit;">（サイズは10 Gbと思われます）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最悪のシナリオ：</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のPDFドキュメントを一度にレンダリングするためにシステムがレンダリング用に100ギガバイトのデータをダウンロードする必要がある場合、Ddosは内部から攻撃します。</font><font style="vertical-align: inherit;">その結果、ネットワークまたはメモリリソースが不足し、システムがダウンする可能性があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪意のあるユーザーがサーバーをプラットフォームとして使用して、他のリソースを攻撃する可能性があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪意のあるユーザーは、直接攻撃のために内部サーバーの外部IPアドレスを取得し、Webアプリケーションファイアウォール（WAF）とバランサーをバイパスします。</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リスク評価（可能性*影響）：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中（5）*高（7）=高（35）（両方のシステムで、リスクは高と評価されましたが、比率は異なります）</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">興味深いもの：</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1つのシステムはwkhtmltopdfを使用してhtml2pdfをレンダリングし、2番目はFirefoxを実行し、そこにページをロードしてスクリーンショットを撮りました。</font><font style="vertical-align: inherit;">いずれの場合も、両方のシステムがすぐに両方のページをレンダリングし、そこですべてのコードを実行してから、そこからPDFを作成します。</font></font></li>
<li> XSS     ,     escape-    html purifying,    iframe, scripts, css, forms   .  html purifying     <code>img src="https://it-band.by/10Gb.blob?t=12345.1"/</code>  html .</li>
</ol><br>
<h3>      </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）そのようなファイルをローカルで作成し、後で全体または一部を埋めようとします。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b8e/526/93f/b8e52693f2ad426797e6782d1ab8e157.jpg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）最初に、脆弱なユーザーフィールドを見つける必要があります。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム1. imgタグは1つだけ挿入できました</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/22e/ca3/6df/22eca36dfe17b1291627cca7f1192f5d.jpg" alt="画像"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/226/53e/ccc/22653eccc53b3ea8ed3940c6b9ef7309.jpg" alt="画像"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。システム2.一度に約20個のタグを挿入できました</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c1d/fbf/5fb/c1dfbf5fb9f33837714bb2c9521000fc.jpg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
。3）次に、PDFドキュメントを生成します。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム1.生成されたPDF </font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/54a/f8f/ad9/54af8fad96135721b3989753d39c44ff.jpg" alt="画像"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム2.生成されたPDF</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a00/76f/ded/a0076fded6ad1a8688d856ffa751544b.jpg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
4）次に、サーバーにアクセスして、大きな10Gb.blobファイルに対する要求があったかどうかを確認します。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム1.サーバーのIPアドレスとソフトウェアを取得します。PDFドキュメントの生成に使用されたnmapは、見つかったIPアドレスによって、これまで誰も見たことのない別の開いているポートを示しました。</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/df7/0ee/24b/df70ee24b6efad45cbe9553b8bdf392b.jpg" alt="画像"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム2.サーバーが10ギガバイトのファイルを20個ダウンロードしようとしたことがわかります。また、サーバーの1つのアドレスと使用されているFirefoxのバージョンも取得します。</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/3e6/c80/aa0/3e6c80aa0358911d5c9bd00e79209901.jpg" alt="画像"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合計。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どちらのシステムでも、エラーはすでに修正されています。最初のシステムでは、htmlの浄化ではなく、ユーザーデータの処理中とPDFドキュメントの生成中の両方でエスケープが行われます。 2番目のシステムでは、ユーザーデータの処理中に外部リソースへの絶対リンクが切断されます。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事の出版に着くまでに、さらに2つのシステムのケースが追加されました。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
別のシステム（システム3と呼びましょう）は、このタイプの脆弱性のチェックを、HTMLインジェクションとCSSインジェクションの2か所で同時に通過しませんでした。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム3.ライブ画像13 Mb（合計260Mb）を20回ダウンロードするHTMLインジェクション</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/fca/8f2/5bd/fca8f25bd0092de64280c0d0cc6d6020.jpg" alt="画像"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム3. CSSインジェクション</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/df2/cfb/584/df2cfb584b9ed09f2d1250c63a70086a.jpg" alt="画像"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム3. PDFをレンダリングしたときに攻撃サーバーで表示されるもの（13Mb画像の20回のダウンロードはすべて成功）</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a80/ed7/18b/a80ed718b82bb5c5862c0c7ea343942b.jpg" alt="画像"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムが得たもの3：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1）レンダリングを行うサーバーのアドレスとレンダリングに使用するサーバーのアドレスを取得します。この場合、HeadlessChrome。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）1つのPDFドキュメントの生成に約5分かかりましたが、その後クロムが単純に落ちました。そのような要求を10K実行するとしたら、しばらくの間、生成サーバーは原則として他のユーザーからの要求への応答を停止します。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム4。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでのSSRF攻撃は、imgタグではなくXSSを介して行われました。私のお気に入りのペイロードがレンダリング中にサーバーで実行され、サーバーがPDFドキュメントの生成中に任意のJavascriptコードを起動しました。以前のケースと比較して、他のシステムへのより複雑な攻撃をここで実行できます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/28a/5ac/d5b/28a5acd5ba920b65add4b1b51819a0a2.jpg" alt="画像"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システム4.サーバー側で実行される任意のJSコードを使用してレンダリングされたPDF</font></font></i><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/55f/f3c/8b2/55ff3c8b29a5d6cd83e1c5736bd0a480.jpg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
メッセージ1.システムには、着信ファイアウォールのルールだけでなく、発信ファイアウォールのルールの開発、または外部アクセスがまったくない個別のネットワークセグメントまたはサーバーを備えたインフラストラクチャの開発が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前提2.最小の脆弱性を見つける場合でも、その使用とビジネスへの影響の最悪のシナリオを常に探す必要があります。</font><font style="vertical-align: inherit;">ビジネスはリスクでのみ機能することができますが、残念ながら技術的な側面は彼らにとってほとんど関心がありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の情報は、教育と教育の目的でのみ提供されており、システムの実行方法は必要ありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denis Koloshko、CISSP、ペネトレーションテスター</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja470978/index.html">アナリストの市場調査：どこで調査し、どのツールを使用し、どのくらい稼いでいるか</a></li>
<li><a href="../ja470980/index.html">銀行セクターのソフトウェアロボット（RPA）が解決する課題</a></li>
<li><a href="../ja470984/index.html">PVS-Studioを使用したTravis CI、Buddy、AppVeyorでのコミットとプルリクエストの分析</a></li>
<li><a href="../ja470988/index.html">モスクワのSlerm DevOpsの登録が開始されました</a></li>
<li><a href="../ja470994/index.html">退屈なオタクの観点からのJavaScript継承：コンストラクターファクトリー</a></li>
<li><a href="../ja470998/index.html">木製おもちゃ、パート10-1996</a></li>
<li><a href="../ja471000/index.html">木のおもちゃ、最後の部分-1997</a></li>
<li><a href="../ja471004/index.html">木のおもちゃ-天井に釘付けされたままのエピローグ</a></li>
<li><a href="../ja471006/index.html">1か月あたり500ドル：無条件のベーシックインカムの受給者は何にお金を使いますか？</a></li>
<li><a href="../ja471008/index.html">監視について話そう：10月23日の会議でNew Relicを使ったDevops Deflopeポッドキャストのライブ録音</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>