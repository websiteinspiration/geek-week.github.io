<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧓🏻 ↙️ ☑️ 滚动条失败 👩🏼‍🤝‍👨🏻 ⏹️ 😑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近发布了Windows终端的新版本。一切都会好起来的，但是她的滚动条的性能仍有很多不足之处。因此，是时候向他稍加黏附并演奏手鼓了。
 
 用户通常会对新版本的任何应用程序做什么？没错，正是测试人员没有做的。因此，在将终端短暂用于预期目的之后，我开始使用它进行可怕的事情。好吧，好吧，我只是将咖啡洒在...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>滚动条失败</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/493040/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/b6/xe/uj/b6xeuj-pps_cnuo5ky22sr0yl5o.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近发布了Windows终端的新版本。</font><font style="vertical-align: inherit;">一切都会好起来的，但是她的滚动条的性能仍有很多不足之处。</font><font style="vertical-align: inherit;">因此，是时候向他稍加黏附并演奏手鼓了。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用户通常会对新版本的任何应用程序做什么？</font><font style="vertical-align: inherit;">没错，正是测试人员没有做的。</font><font style="vertical-align: inherit;">因此，在将终端短暂用于预期目的之后，我开始使用它进行可怕的事情。</font><font style="vertical-align: inherit;">好吧，好吧，我只是将咖啡洒在键盘上，并在擦拭时不小心夹住了&lt;Enter&gt;键。</font><font style="vertical-align: inherit;">结局是什么？</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/ev/at/tqevatebkqh9qhtc7meqb8gd9y8.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
是的，它看起来并不令人印象深刻，但不要急于向我扔石头。</font><font style="vertical-align: inherit;">注意右侧。</font><font style="vertical-align: inherit;">首先尝试找出她的问题所在。</font><font style="vertical-align: inherit;">这是提示的屏幕截图：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/33/g5/nz/33g5nz7ix7fpgot21hpt-flsw0m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然，文章的标题是一个严重的破坏者。 :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，滚动条存在问题。越过下边框，移至新行很多次了，通常希望滚动条出现，然后可以向上滚动。但是，直到我们编写带有输出内容的命令后，这种情况才会发生。我们只说行为很奇怪。但是，如果滚动条可以正常工作，这可能并不是那么重要。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
经过一些测试，我发现切换到新行不会增加缓冲区。这仅使命令输出。因此，上述</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whoami</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅会使缓冲区增加一行。因此，随着时间的流逝，我们将失去很多历史，尤其是在</font><i><font style="vertical-align: inherit;">清除</font></i><font style="vertical-align: inherit;">之后</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我想到的第一件事就是使用我们的分析仪，看看它说了什么：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/dt/op/hfdtop2yyl-2hnm0fdzu2bg6jmo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结论当然是令人印象深刻的，因此，我将利用过滤和裁剪除包含</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内容之外的所有内容的强大功能</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/kb/k9/nh/kbk9nhstx9w90yxa5q8sm542fvk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我不能说有很多消息...好吧，也许那与缓冲区有关吗？</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ym/u0/jsymu0ehvgbwmldkhi30tkr8duw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析仪没有失败，发现了一些有趣的东西。</font><font style="vertical-align: inherit;">我在上面强调了此警告。</font><font style="vertical-align: inherit;">让我们看看那里出了什么问题：</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V501</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在'-'运算符的左侧和右侧有相同的子表达式：bufferHeight-bufferHeight TermControl.cpp 592</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(bufferHeight - bufferHeight); <span class="hljs-comment">// &lt;=  </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该代码带有注释：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“设置ScrollViewer的高度以及我们用来伪造滚动高度的网格。” </font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然，模拟滚动高度是很好的，但是为什么我们将最大值设置为0？</font><font style="vertical-align: inherit;">转到</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，很明显该代码不是很可疑。</font><font style="vertical-align: inherit;">不要误会我的意思：从变量中减去一个变量当然是可疑的，但是我们在输出中得到的是零，这不会损害我们。</font><font style="vertical-align: inherit;">无论如何，我尝试在“ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大值”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段中指定</font><font style="vertical-align: inherit;">默认值（1）：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/my/pz/-r/mypz-rza0bhmadv3_q32c5oklkc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
滚动条出现了，但是它也不起作用：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/_n/ii/xg/_niixgvkmgqfoy_fmiyaouu6rog.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果有的话，我将&lt;Enter&gt;固定了30秒。显然这不是问题，所以让它保持原样，除非将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">替换</font><font style="vertical-align: inherit;">为0：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(<span class="hljs-number">0</span>); <span class="hljs-comment">// &lt;=   </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们并不是特别接近解决问题。在没有更好的报价的情况下，请放进购物袋。起初，我们可以在更改的行上设置一个断点，但是我怀疑它是否可以以某种方式帮助我们。因此，我们首先需要找到负责视口相对于缓冲区偏移的片段。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于本地（最可能是其他）滚动条的工作原理。我们有一个大缓冲区来存储所有输出。为了与之交互，在屏幕上使用了某种抽象画法（在本例中为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewport）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用这两个原语，我们可以了解问题所在。换行不会增加缓冲区，因此，我们无处可去。因此，问题就出在其中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有了这种平常的知识，我们继续英勇的背囊。</font><font style="vertical-align: inherit;">在对该函数进行了一些漫步之后，我提请注意此片段：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在配置完上面的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之后</font><font style="vertical-align: inherit;">，我们配置了各种回调函数并</font><font style="vertical-align: inherit;">为新创建的窗口</font><font style="vertical-align: inherit;">执行</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__connection.Start（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">之后将调用上述lambda。</font><font style="vertical-align: inherit;">由于这是我们第一次向缓冲区写入内容，因此建议从此处开始调试。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们在lambda中设置一个断点，然后查看</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_terminal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/0z/lz/rb/0zlzrbnxlr94nbnb2jkgnmmf1sq.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们有两个对我们极为重要的变量</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_mutableViewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。在它们上放置断点，并找到它们的变化点。没错，使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我会</font><i><font style="vertical-align: inherit;">作弊</font></i><font style="vertical-align: inherit;">一点，并将断点放在变量本身上，而不是变量的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顶部</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段上</font><font style="vertical-align: inherit;">（我们只需要它）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在单击&lt;F5&gt;，没有任何反应...好吧，让我们按几十次&lt;Enter&gt;。什么都没有发生。显然，在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer上，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们过分</font><i><font style="vertical-align: inherit;">鲁</font></i><font style="vertical-align: inherit;"> set地设置了一个断点，而</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仍然如预期那样保留在缓冲区的顶部，并且其大小并未增加。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这种情况下，输入命令以更新顶点是有意义的。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">之后，我们编写了一段非常有趣的代码：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我指出了我们停下来的地方。</font><font style="vertical-align: inherit;">如果您查看有关该片段的评论，很显然我们比以往任何时候都更接近解决方案。</font><font style="vertical-align: inherit;">正是在这个地方，可见部分相对于缓冲区发生了移动，我们有了滚动的机会。</font><font style="vertical-align: inherit;">观察了一下行为之后，我注意到了一个有趣的观点：移至新行时，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">的值等于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">视口</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的值</font><font style="vertical-align: inherit;">，因此我们没有忽略它，没有任何效果。</font><font style="vertical-align: inherit;">另外，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newViewTop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量也存在类似的问题</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，让我们将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的值增加</font><font style="vertical-align: inherit;">一，然后看看发生了什么：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y + <span class="hljs-number">1</span> &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y + <span class="hljs-number">1</span> - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以及启动结果：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/6g/7d/xc/6g7dxcp_8o_uw-jzmlx6qxy6xjy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
奇迹！</font><font style="vertical-align: inherit;">我输入了数量，滚动条起作用了。</font><font style="vertical-align: inherit;">没错，直到我们介绍一些内容为止……为了演示该文件，我将附上gif：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/ed/8y/cled8yrho-rrvtihhjf7uoo7ybq.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
显然，我们正在做一些额外的跳转到新的一行。</font><font style="vertical-align: inherit;">然后让我们尝试使用X坐标来限制过渡，我们只会在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为0 </font><font style="vertical-align: inherit;">时移动直线</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (   proposedCursorPosition.X == <span class="hljs-number">0</span><font></font>
      &amp;&amp; proposedCursorPosition.Y == _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    proposedCursorPosition.Y++;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Update Cursor Position</span><font></font>
  ursor.SetPosition(proposedCursorPosition);<font></font>
<font></font>
  <span class="hljs-keyword">const</span> COORD cursorPosAfter = cursor.GetPosition();<font></font>
<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....);<font></font>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上面写的片段将移动</font><font style="vertical-align: inherit;">光标</font><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">坐标</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">然后我们更新光标位置。</font><font style="vertical-align: inherit;">从理论上讲，这应该起作用。发生了什么事？</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/7i/kc/xs/7ikcxsonvzc4h99f-6obibt1o8u.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
好吧，当然更好。</font><font style="vertical-align: inherit;">但是，存在的问题是我们移动输出点，但不移动缓冲区。</font><font style="vertical-align: inherit;">因此，我们看到同一命令的两个调用。</font><font style="vertical-align: inherit;">当然，似乎我知道自己在做什么，但事实并非如此。</font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
至此，我决定检查缓冲区的内容，因此回到了开始调试的地方：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我在与上次相同的位置设置了一个断点，然后开始查看</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量的内容</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">让我们从我在屏幕上看到的内容开始：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ha/ll/4c/hall4czp0c9scl5ybzmduvpa2iy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当我按&lt;Enter&gt;键时，</font><font style="vertical-align: inherit;">
您认为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字符串中会有什么</font><font style="vertical-align: inherit;">？</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字符串</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ LONG description”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们现在看到的整个缓冲区。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整个缓冲区，但没有第一行。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我不会疲倦-整个缓冲区，但是没有第一行。</font><font style="vertical-align: inherit;">这是一个很大的问题，因为正是由于这个原因，我们正在失去历史性的，有目的的。</font><font style="vertical-align: inherit;">这是我们的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帮助</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">输出片段</font><font style="vertical-align: inherit;">在换行后的</font><font style="vertical-align: inherit;">样子</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/rc/n8/d9/rcn8d94h6tyf1qtscqyqvfvtn24.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我用箭头标记了</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ LONG DESCRIPTOIN”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所在的位置</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">也许然后用一行偏移量覆盖缓冲区？</font><font style="vertical-align: inherit;">如果没有每次打喷嚏都调用此回调，则此方法有效。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
调用它时，我至少发现了三种情况，</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当我们输入任何字符时；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当我们穿越历史时；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当我们执行命令时。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
问题是仅在执行命令时才需要移动缓冲区，或者输入&lt;Enter&gt;。</font><font style="vertical-align: inherit;">在其他情况下，这样做不是一个好主意。</font><font style="vertical-align: inherit;">因此，我们需要以某种方式确定内部需要转移的内容。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/yo/ij/pbyoijjc9y4dezbt9wizjxrwnb0.png" alt="图片18"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本文试图说明PVS-Studio如何熟练地发现导致我注意到的错误的有缺陷的代码。</font><font style="vertical-align: inherit;">关于从自身中减去变量的主题的信息极大地激励了我，因此我积极编写了本书。</font><font style="vertical-align: inherit;">但是，正如您所看到的，我的喜悦还为时过早，结果一切都变得更加复杂。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所以我决定停下来。</font><font style="vertical-align: inherit;">一个人仍然可以度过几个晚上，但是我做的时间越长，出现的问题就越多。</font><font style="vertical-align: inherit;">我所能做的就是希望Windows终端开发人员在修复此错误时祝您好运。</font><font style="vertical-align: inherit;">:)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我希望我不会让读者失望，因为我还没有完成研究，对我来说，在项目内部进行漫步很有趣。作为补偿，我建议使用#WindowsTerminal促销代码，由于该代码，您将在一周内而不是一个月内收到PVS-Studio的演示版。如果您实际上没有尝试过PVS-Studio静态分析仪，那么这就是一个很好的理由。只需</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在下载页面</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的“消息”字段中输入“ #WindowsTerminal” </font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另外，借此机会，我想提醒您，很快将有一个在Linux和macOS下运行的C＃分析器版本。现在，您可以注册进行初步测试。</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您想与讲英语的读者分享这篇文章，请使用以下链接：Maxim Zvyagintsev。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无法滚动的小滚动条</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN493026/index.html">产品测试：Canary部署</a></li>
<li><a href="../zh-CN493032/index.html">5. Check Point Maestro常见问题（FAQ）</a></li>
<li><a href="../zh-CN493034/index.html">COVID-19：预测冠状病毒患者的数量</a></li>
<li><a href="../zh-CN493036/index.html">我一遍又一遍，我想混淆：两层石墨烯的操纵</a></li>
<li><a href="../zh-CN493038/index.html">关于分布式团队的企业文化</a></li>
<li><a href="../zh-CN493042/index.html">在线广告和营销的市场受众数据部分。部分。1.立法变更</a></li>
<li><a href="../zh-CN493046/index.html">如何计划咖啡馆的开业，或为开店而写自己的规划师</a></li>
<li><a href="../zh-CN493050/index.html">搜索不是找到的东西</a></li>
<li><a href="../zh-CN493052/index.html">问题</a></li>
<li><a href="../zh-CN493060/index.html">远程工作是向项目经理展示的机会</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>