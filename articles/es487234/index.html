<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüåæ üóÑÔ∏è üë©üèº‚Äçüíª ¬øHierro u optimizaci√≥n? Badoo, Avito y Mamba: sobre el rendimiento de PHP üà∏ ü§¥ üõå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El problema de rendimiento de PHP para Badoo es uno de los m√°s importantes. La calidad del backend de PHP depende directamente de la cantidad de recur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>¬øHierro u optimizaci√≥n? Badoo, Avito y Mamba: sobre el rendimiento de PHP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/487234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El problema de rendimiento de PHP para Badoo es uno de los m√°s importantes. La calidad del backend de PHP depende directamente de la cantidad de recursos que gastamos en desarrollo y operaci√≥n, la velocidad del servicio y la impresi√≥n que causa en los usuarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, en el tema de la tercera reuni√≥n de la comunidad de desarrolladores de PHP en nuestra oficina, realizamos el rendimiento del backend e invitamos a colegas de Avito y Mamba a discutir. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t-/p7/se/t-p7sef1pbww8vboigkup6ditzu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le√≠ en la transcripci√≥n de la escena, en la que tuve la suerte de ser moderador: c√≥mo se organiza la infraestructura de las tres compa√±√≠as, c√≥mo medimos la productividad y en qu√© m√©tricas nos enfocamos, qu√© herramientas usamos, c√≥mo hacemos una elecci√≥n entre hardware y optimizaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y el 15 de febrero, ven al </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√≥ximo Badoo PHP Meetup</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : discute Legacy.</font></font><br>
<a name="habracut"></a><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/kWBm0C9A8oo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe> <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hemos descifrado solo la parte de la discusi√≥n, que nos pareci√≥ la m√°s interesante. </font><font style="vertical-align: inherit;">La versi√≥n completa est√° disponible en video. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Expertos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Jefe de Unidad de Desarrollo en Core Services Avito</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pmurzakov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, PHP Timlid en Badoo </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mipxtx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Director de TI de Mamba</font></font></li>
</ul><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuente una historia sobre la optimizaci√≥n de su pr√°ctica: el gran √©xito o el gran fracaso es algo interesante para compartir. </font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tengo una par√°bola </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aproximadamente una vez cada seis meses observamos las m√©tricas y buscamos lo que se ralentiza, no funciona bien, lo que debe optimizarse. </font><font style="vertical-align: inherit;">Una vez que notamos nuestro contenedor de dependencia de Symfony, que creci√≥ a 52,000 l√≠neas. </font><font style="vertical-align: inherit;">Decidimos que √©l, el sinverg√ºenza, ten√≠a la culpa de todo: 20 ms de gastos generales por cada solicitud. </font><font style="vertical-align: inherit;">Lo aserramos </font><font style="vertical-align: inherit;">Lo redujimos. </font><font style="vertical-align: inherit;">De alguna manera tratamos de separarlo, pero nada ayud√≥. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego result√≥ que tenemos anti-spam que necesita ir a 20 bases de datos para cumplir con todas las solicitudes necesarias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las soluciones que vienen primero no siempre son las correctas. </font><font style="vertical-align: inherit;">Observe mejor los rastros, registros y puntos de referencia de sus solicitudes, y no se rompa directamente. </font><font style="vertical-align: inherit;">Aqu√≠ hay una historia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos un ecosistema bastante grande en PHP, por lo que peri√≥dicamente hacemos la optimizaci√≥n. </font><font style="vertical-align: inherit;">Estamos creciendo, estamos alcanzando cierto nivel en la CPU, entendemos que necesitamos comprar hardware u optimizarlo. </font><font style="vertical-align: inherit;">Considere los argumentos a favor y en contra de cada opci√≥n y decida. </font><font style="vertical-align: inherit;">Muy a menudo, a favor de la optimizaci√≥n, porque el hierro necesita mucho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En uno de estos puntos, identificamos a todo un grupo que se dedicaba a buscar varias cosas no √≥ptimas en los scripts PHP y a optimizarlo. </font><font style="vertical-align: inherit;">Esto sucedi√≥ literalmente "gota a gota": aqu√≠ encontraron un porcentaje, all√≠ encontraron un porcentaje, varias personas encontraron un porcentaje en un mes. </font><font style="vertical-align: inherit;">En alg√∫n momento, nuestro sishnik estaba cerca</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einstein_man</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Decidi√≥ ver qu√© pod√≠a hacer: fue por la noche, lanz√≥ Perf, encontr√≥ un par de problemas en las extensiones de PHP y aceler√≥ todo en un par de noches en un 13%.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tengo dos historias Uno sobre el archivo, el otro sobre el s√∫per desarrollador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre el fracaso. Tenemos muchos microservicios, incluido PHP. Todos trabajan en Kubernetes. Trabaj√© en uno de estos microservicios. Hubo una utilizaci√≥n significativa de la CPU: pasaron una semana optimizando y encontrando problemas. Result√≥ que uno de los desarrolladores agreg√≥ Xdebug a las im√°genes base para calcular las pruebas de cobertura de c√≥digo en su (otro) servicio, ¬°despu√©s de lo cual todos los microservicios en producci√≥n trabajaron con Xdebug durante un cuarto! Despu√©s de un cuarto, descubrimos esto, arreglamos im√°genes b√°sicas y comenzamos a atrapar regalos inesperados: volv√≠ a lanzar mi servicio y comenz√≥ a funcionar m√°s r√°pido. En cada implementaci√≥n, nuestra imagen de servicio se reconstruye y ahora sin Xdebug.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Historia del √©xito. Tenemos muchos microservicios, y se hicieron cada vez m√°s. En esta situaci√≥n, el n√∫mero de llamadas RPC se convierte en un problema. Por ejemplo, en una tarjeta de anuncio, y esta es una de las p√°ginas m√°s frecuentes en Avito, alrededor de 30 microservicios est√°n involucrados en el procesamiento de una p√°gina. Adem√°s, todo esto no se hizo de manera muy expl√≠cita: parece que est√° llamando a alg√∫n tipo de abstracci√≥n, y bajo este se realizan cinco llamadas RPC a otros servicios de forma secuencial.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con los a√±os, la tarjeta de anuncio ha sido muy degradada. </font><font style="vertical-align: inherit;">Un desarrollador fuerte luch√≥ por un cuarto, optimiz√≥ y sac√≥ todas las llamadas de RPC. </font><font style="vertical-align: inherit;">Cuando pudo hacer esto, los paraleliz√≥ a trav√©s de la solicitud m√∫ltiple de Guzzle, y en lugar de 30 solicitudes s√≠ncronas consecutivas, recibi√≥ las mismas 30 solicitudes, pero paralelas, lo que aceler√≥ enormemente el trabajo. </font><font style="vertical-align: inherit;">Despu√©s de esta refactorizaci√≥n, el tiempo de respuesta de la tarjeta es igual al tiempo de respuesta m√°ximo de cualquiera de los servicios. </font><font style="vertical-align: inherit;">Pero necesitaba un trimestre entero para optimizar / reescribir el c√≥digo de visualizaci√≥n de la tarjeta de anuncio.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√≠ganos, ¬øcu√°l es el tama√±o de su cl√∫ster de PHP, c√≥mo est√° configurado?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos alrededor de 15,000 RPS. </font><font style="vertical-align: inherit;">Un grupo de 80 servidores FPM comprados hace varios a√±os. </font><font style="vertical-align: inherit;">En cada cl√∫ster, FPM (hasta 50 ni√±os como m√°ximo) se inicia en est√°tica. </font><font style="vertical-align: inherit;">Carg√≥ alrededor de diez en el pico en horario estelar. </font><font style="vertical-align: inherit;">El tiempo de respuesta promedio es de 100 ms, e intentamos mantenerlo (cuando excede los 100 ms, comenzamos la b√∫squeda de piezas de frenado). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos nuestro propio sistema de monitoreo de desempe√±o. </font><font style="vertical-align: inherit;">Dispersamos muchos contadores en el c√≥digo, alrededor de 120 por solicitud. </font><font style="vertical-align: inherit;">Monitoreamos muchos eventos que ocurren dentro del c√≥digo en PHP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo es est√°ndar con nosotros: nginx, PHP-FPM. Aproximadamente 600 servidores con FPM. Si hablar sobre PHP, entonces, probablemente, hay alrededor de 300 servidores m√°s para diversos fines, como script, back-office y otros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De las caracter√≠sticas de configuraci√≥n, hay dos. En primer lugar, tenemos un proxy BMA: este es un proxy para dispositivos m√≥viles. Es decir, antes de que una solicitud llegue a nginx, llega a un proxy especial que mantiene una conexi√≥n persistente y env√≠a solicitudes a nginx. La segunda caracter√≠stica: a veces es necesario desactivar el opcache de la CLI (lo tenemos activado en las m√°quinas de secuencias de comandos). Una vez que no lo apagamos y perdimos el 30% de la CPU en esto. Despu√©s de darse cuenta de su error, se sorprendieron de cu√°nto puede ahorrar con una configuraci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos parches PHP, pero casi no est√°n relacionados con el rendimiento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay un punto con el bloqueo APCu competitivo: cuando necesita escribir mucho en la misma clave. </font><font style="vertical-align: inherit;">La arquitectura interna de APCu est√° construida de tal manera que hay un bloqueo global de teclas, y durante la grabaci√≥n intensiva, comienzan los frenos. </font><font style="vertical-align: inherit;">Por lo tanto, tenemos una extensi√≥n personalizada all√≠ que resuelve este problema. </font><font style="vertical-align: inherit;">Esto solo se relaciona en parte con el rendimiento, ya que afecta el tiempo de respuesta, pero no el consumo de CPU.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos alrededor de 2 millones de solicitudes por minuto (~ 33 kRPS). </font><font style="vertical-align: inherit;">Una aplicaci√≥n monol√≠tica escrita en PHP se ha escrito durante m√°s de 11 a√±os. </font><font style="vertical-align: inherit;">Est√° en una fase de r√°pido crecimiento. </font><font style="vertical-align: inherit;">Cuando la compa√±√≠a comenz√≥, hab√≠a 65 LXC en 65 servidores f√≠sicos. </font><font style="vertical-align: inherit;">En cada contenedor con la aplicaci√≥n, se ejecuta PHP-FPM, nginx y software auxiliar para m√©tricas y registros. </font><font style="vertical-align: inherit;">Nada especial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con los a√±os, nunca hemos agregado hierro para un monolito. </font><font style="vertical-align: inherit;">Estamos aumentando la asistencia, la cantidad de anuncios, la cantidad de transacciones de usuarios, y constantemente optimizamos, mejoramos el c√≥digo, optimizamos el software. </font><font style="vertical-align: inherit;">El consumo de CPU y memoria ha disminuido en los √∫ltimos a√±os: 65 contenedores para un monolito ahora son suficientes para nosotros.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo se mide el rendimiento? </font><font style="vertical-align: inherit;">¬øQu√© herramienta mides el tiempo de respuesta del cliente?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos un sistema de recopilaci√≥n de registros. </font><font style="vertical-align: inherit;">Registra dos indicadores: el tiempo desde el inicio de FPM hasta la funci√≥n de apagado y hasta el final del script. </font><font style="vertical-align: inherit;">La segunda m√©trica es necesaria para ver qu√© sucede despu√©s de la funci√≥n de apagado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Medimos JS. </font><font style="vertical-align: inherit;">Esto, de hecho, es m√°s o menos m√©trico; los canales de red a menudo se violan. </font><font style="vertical-align: inherit;">Como resultado, la carga en alg√∫n lugar del interior de Rusia comienza a disminuir. </font><font style="vertical-align: inherit;">Por lo tanto, nos vemos as√≠: "Oh, salt√≥, significa que en alg√∫n lugar algo se cay√≥". </font><font style="vertical-align: inherit;">Adem√°s, la publicidad de terceros distorsiona mucho la m√©trica. </font><font style="vertical-align: inherit;">Y, lo m√°s importante, vienen los spammers, y esto generalmente es alg√∫n tipo de aleatoriedad.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, sol√≠amos usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinba</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de Badoo de manera </font><font style="vertical-align: inherit;">muy activa </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Me gusta ella ahora. </font><font style="vertical-align: inherit;">La mayor√≠a de las m√©tricas fueron recopiladas por √©l, pero luego cambiaron al protocolo StatsD. </font><font style="vertical-align: inherit;">Ahora estamos tomando medidas desde diferentes puntos: desde el frente, desde los servidores frente a la aplicaci√≥n, desde nginx y desde la propia aplicaci√≥n PHP. </font><font style="vertical-align: inherit;">Tenemos un equipo de rendimiento dedicado. </font><font style="vertical-align: inherit;">Comenz√≥ con el desempe√±o del frente, pero luego cambi√≥ a retroceso. </font><font style="vertical-align: inherit;">Desde el frente, recopila no solo JS, CSS y otras estad√≠sticas, sino tambi√©n el tiempo de respuesta del servidor. </font><font style="vertical-align: inherit;">En primer lugar, nos centramos en el tiempo de respuesta de la aplicaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo es similar a lo que nos dijeron los muchachos. </font><font style="vertical-align: inherit;">Usando el cl√°sico Pinba para PHP, medimos el tiempo de ejecuci√≥n de un script PHP en t√©rminos de PHP. </font><font style="vertical-align: inherit;">Pero tambi√©n tenemos, por ejemplo, Pinba para nginx, que mide el tiempo de respuesta desde el punto de vista de nginx. </font><font style="vertical-align: inherit;">Tambi√©n recopilamos m√©tricas en el cliente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que estamos mirando </font><font style="vertical-align: inherit;">Por un lado, el tiempo de respuesta. </font><font style="vertical-align: inherit;">No est√° relacionado con la planificaci√≥n de recursos. </font><font style="vertical-align: inherit;">Si es malo, necesita ser mejorado, porque es, de hecho, la calidad del servicio. </font><font style="vertical-align: inherit;">Otra cosa es que necesita planificar de alguna manera el hierro. </font><font style="vertical-align: inherit;">Nuestros equipos de ITOps y monitoreo monitorean todo el hardware. </font><font style="vertical-align: inherit;">Hay algunas barras en la red, en el disco. </font><font style="vertical-align: inherit;">Hay algunos valores despu√©s de los cuales se produce la alerta, y estamos haciendo algo. </font><font style="vertical-align: inherit;">Como ha demostrado la pr√°ctica, generalmente optimizamos para la CPU: nos encontramos con ella.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nosotros, la aplicaci√≥n PHP se mide a s√≠ misma y en register_shutdown_function () arroja m√©tricas. </font><font style="vertical-align: inherit;">Cada LXC tiene un servidor StatsD, que recopila estas m√©tricas y las env√≠a a trav√©s de los recopiladores al cl√∫ster Graphite (incluido ClickHouse), donde se almacenan los datos. </font><font style="vertical-align: inherit;">Este es un autodiagn√≥stico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n en cada contenedor hay nginx, es decir, nginx + PHP-FPM. </font><font style="vertical-align: inherit;">Con nginx, recopilamos m√©tricas externas relacionadas con el tiempo de ejecuci√≥n de una aplicaci√≥n PHP. </font><font style="vertical-align: inherit;">Tambi√©n se enfrentan a servidores separados (los llamamos avi-http) nginx, que realiza un enrutamiento b√°sico, que tambi√©n recopila m√©tricas de nivel superior, como el tiempo de respuesta, la cantidad de 500 c√≥digos de respuesta y otros.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© herramientas tienes para una pista de rendimiento? </font><font style="vertical-align: inherit;">¬øQu√© usas con m√°s frecuencia?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escribimos nuestra propia herramienta. Cuando Pinba acaba de salir, en 2012, hace mucho tiempo, era un m√≥dulo para MySQL que recibi√≥ algo como esto a trav√©s de UDP. Fue dif√≠cil sacar los gr√°ficos; no estaba muy optimizado para el rendimiento. Y no se nos ocurri√≥ nada mejor que escribir nuestra propia cosa llamada Better Than Pinba. Es solo un servidor de contador que los acepta desde un cliente PHP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dispersamos muchos temporizadores en el c√≥digo: cada vez que queremos medir algo, establecemos el inicio y la parada del temporizador en el c√≥digo. El m√≥dulo mismo calcular√° el tiempo de ejecuci√≥n del contador, agregar√° los contadores acumulados en un paquete y los enviar√° al demonio. La interfaz en s√≠ extraer√° todo lo que necesita y crear√° gr√°ficos conectados en el contador deseado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno de los problemas de Pinba era la falta de su propia interfaz: era necesario transferir datos a RRD (entonces hab√≠a tanta oscuridad). </font><font style="vertical-align: inherit;">Por lo tanto, escribimos nuestra propia interfaz. </font><font style="vertical-align: inherit;">Cada vez que vemos lo que salt√≥, podemos instalar el script. </font><font style="vertical-align: inherit;">En el script, todos los contadores agregados nos son enviados, los cuales nos son enviados. </font><font style="vertical-align: inherit;">Podemos ver d√≥nde creci√≥ el contador, o si aument√≥ el tiempo de respuesta en el contador, o si aument√≥ el n√∫mero de contadores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se puede ver cuando el rendimiento cae. </font><font style="vertical-align: inherit;">Estamos empezando a cavar de esta manera. </font><font style="vertical-align: inherit;">Antes de PHP 7, usamos XHProf, luego dej√≥ de construir con nosotros. </font><font style="vertical-align: inherit;">Por lo tanto, cambiamos a Xdebug. </font><font style="vertical-align: inherit;">Xdebug solo tocamos cuando el problema es visible.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es una creencia com√∫n de que XHProf no se construir√° en PHP 7. </font><font style="vertical-align: inherit;">Esto es cierto, pero solo en parte. </font><font style="vertical-align: inherit;">Si toma XHProf del asistente, realmente no lo har√°. </font><font style="vertical-align: inherit;">Pero si en GitHub cambia a una rama llamada Experimental (o algo as√≠), entonces todo funciona bien para PHP 7, listo para la producci√≥n. </font><font style="vertical-align: inherit;">Comprobado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, me cambi√©. </font><font style="vertical-align: inherit;">No funcion√≥ para m√≠.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quiero agregar sobre Pinba. </font><font style="vertical-align: inherit;">Te has convertido en profetas hasta cierto punto. </font><font style="vertical-align: inherit;">Tambi√©n nosotros, en alg√∫n momento, perdimos productividad. </font><font style="vertical-align: inherit;">Hicimos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinba2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que es muy r√°pido. </font><font style="vertical-align: inherit;">Se puede usar como reemplazo de Pinba.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo es modesto con nosotros. </font><font style="vertical-align: inherit;">Acabamos de tomar la direcci√≥n del rendimiento en el trabajo: recopilamos m√©tricas, como el tiempo de respuesta. </font><font style="vertical-align: inherit;">Usamos StatsD. </font><font style="vertical-align: inherit;">Todav√≠a no usamos perfiladores de forma regular, pero estoy seguro de que algunos equipos los usan en sus microservicios escritos en PHP. </font><font style="vertical-align: inherit;">En mi opini√≥n, incluso alguien transmite New Relic. </font><font style="vertical-align: inherit;">Pero en el contexto de la aplicaci√≥n monol√≠tica principal, hasta ahora solo nos estamos acercando a esto.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La historia del hierro se controla en Grafana, Zabbix. </font><font style="vertical-align: inherit;">En cuanto a la parte de PHP, tenemos Pinba, tenemos un mont√≥n de temporizadores; </font><font style="vertical-align: inherit;">Construimos gr√°ficos convenientes en ellos. </font><font style="vertical-align: inherit;">Usamos XHProf, en producci√≥n lo manejamos para una parte de las solicitudes. </font><font style="vertical-align: inherit;">Siempre tenemos nuevos perfiles XHProf disponibles. </font><font style="vertical-align: inherit;">Tenemos liveprof: esta es nuestra herramienta, puedes leer sobre ella, incluso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en mi art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Todo sucede autom√°ticamente, solo tienes que mirar. </font><font style="vertical-align: inherit;">Usamos phpspy. </font><font style="vertical-align: inherit;">No siempre se inicia con nosotros: cuando alguien quiere ver algo, entra al auto y se quita el perfil. </font><font style="vertical-align: inherit;">En principio, como es el caso con Perf.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
XHProf tiene la misma historia. </font><font style="vertical-align: inherit;">Una vez lo usamos hace mucho tiempo: fue una iniciativa personal de un par de desarrolladores y, de hecho, no despeg√≥. </font><font style="vertical-align: inherit;">√âl dej√≥ de coleccionar. </font><font style="vertical-align: inherit;">Recopilamos un mont√≥n de m√©tricas de llamadas de enrutadores, controladores, varios modelos. </font><font style="vertical-align: inherit;">Alrededor del 60-70% de la red interna del centro de datos est√° ocupada por paquetes UDP con m√©tricas. </font><font style="vertical-align: inherit;">Por el momento, esto es suficiente para nosotros. </font><font style="vertical-align: inherit;">Ahora buscaremos nuevos lugares para la optimizaci√≥n.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desde que hemos llegado al punto del hierro: ¬øhay alguien sistem√°ticamente involucrado en la planificaci√≥n de capacidad en su empresa? </font><font style="vertical-align: inherit;">¬øC√≥mo se construye este proceso?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una aplicaci√≥n monol√≠tica ejecuta al menos 65 LXC durante al menos cinco a√±os. </font><font style="vertical-align: inherit;">Optimizamos el c√≥digo, lo mejoramos: tiene suficientes recursos. </font><font style="vertical-align: inherit;">Nuestra planificaci√≥n de capacidad principal se dirige a Kubernetes, donde se escriben alrededor de 400 microservicios m√°s o menos vivos en PHP / Go. </font><font style="vertical-align: inherit;">Poco a poco estamos cortando piezas del monolito, pero todav√≠a est√° creciendo. </font><font style="vertical-align: inherit;">No podemos detenerlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, PHP es un lenguaje genial. </font><font style="vertical-align: inherit;">Implementa r√°pidamente la l√≥gica empresarial.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, ITOps y los equipos de monitoreo se aseguran de que haya suficientes recursos. </font><font style="vertical-align: inherit;">Si comenzamos a acercarnos al valor umbral, los colegas lo notan. </font><font style="vertical-align: inherit;">Probablemente son los principales responsables de la planificaci√≥n de la capacidad global. </font><font style="vertical-align: inherit;">La parte PHP tiene el recurso principal de la CPU, por lo que lo seguimos nosotros mismos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos fijamos el list√≥n: no debemos "comer" m√°s del 60% del grupo. </font><font style="vertical-align: inherit;">60%, y no 95%, porque tenemos hypertreading, que adem√°s extrae m√°s del procesador de lo que puede exprimir sin √©l. </font><font style="vertical-align: inherit;">Por esto, pagamos por el hecho de que despu√©s del 50% de nuestro consumo de CPU podemos crecer de una manera impredecible, porque los n√∫cleos hiper le√≠dos no son del todo honestos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realizamos un despliegue y vemos que algo ha fallado con nosotros, como la planificaci√≥n de la capacidad. </font><font style="vertical-align: inherit;">A simple vista! </font><font style="vertical-align: inherit;">Tenemos un cierto margen de productividad que nos permite hacer esto. </font><font style="vertical-align: inherit;">Tratamos de mantenerlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, hacemos una optimizaci√≥n post factum. </font><font style="vertical-align: inherit;">Cuando vemos que algo se ha ca√≠do, retrocedemos si todo est√° completamente mal. </font><font style="vertical-align: inherit;">Pero esto pr√°cticamente no sucede. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O simplemente vemos que "aqu√≠ no es √≥ptimo, ahora arreglaremos todo r√°pidamente y todo funcionar√° como deber√≠a". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nos molestamos especialmente: es muy dif√≠cil y el escape no ser√° muy grande.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est√°s hablando de microservicios. </font><font style="vertical-align: inherit;">¬øC√≥mo interact√∫an? </font><font style="vertical-align: inherit;">¬øEs REST o est√° utilizando protocolos binarios?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kafka se utiliza para enviar eventos entre servicios, JSON-RPC se utiliza para garantizar la interacci√≥n entre los servicios, pero no es completa, sino su versi√≥n simplificada, de la que no podemos deshacernos. </font><font style="vertical-align: inherit;">Hay implementaciones m√°s r√°pidas: el mismo protobuf, gRPC. </font><font style="vertical-align: inherit;">Esto est√° en nuestros planes, pero ciertamente no es una prioridad. </font><font style="vertical-align: inherit;">Con m√°s de 400 microservicios, es dif√≠cil portarlos todos al nuevo protocolo. </font><font style="vertical-align: inherit;">Hay toneladas de otros lugares para optimizar. </font><font style="vertical-align: inherit;">Definitivamente no estamos a la altura ahora.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosotros como tales no tenemos microservicios. </font><font style="vertical-align: inherit;">Hay servicios, tambi√©n est√° Kafka, su propio protocolo sobre el protobuf de Google. </font><font style="vertical-align: inherit;">Probablemente, usar√≠amos gRPC, porque es genial, tiene soporte para todos los idiomas, la capacidad de unir f√°cilmente diferentes piezas. </font><font style="vertical-align: inherit;">Pero cuando lo necesit√°bamos, el gRPC a√∫n no estaba all√≠. </font><font style="vertical-align: inherit;">Pero hab√≠a un protobuf, y lo tomamos. </font><font style="vertical-align: inherit;">Adem√°s, se agregaron diferentes cosas para que no se tratara solo de serializaci√≥n, sino de un protocolo completo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampoco tenemos microservicios. </font><font style="vertical-align: inherit;">Hay servicios escritos principalmente en C. Utilizamos JSON-RPC porque es conveniente. </font><font style="vertical-align: inherit;">Acaba de abrir el socket cuando depura su c√≥digo y r√°pidamente escribi√≥ lo que quer√≠a. </font><font style="vertical-align: inherit;">Algo ha vuelto a ti. </font><font style="vertical-align: inherit;">Protobuf es m√°s dif√≠cil porque necesitas usar algunas herramientas adicionales. </font><font style="vertical-align: inherit;">Hay una peque√±a sobrecarga, pero creemos que debe pagar por conveniencia, y este no es un gran precio.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tienes grandes bases de datos. </font><font style="vertical-align: inherit;">Cuando necesita cambiar el circuito en uno de ellos, ¬øc√≥mo lo hace? </font><font style="vertical-align: inherit;">¬øAlg√∫n tipo de migraciones? </font><font style="vertical-align: inherit;">Si estas migraciones tardan varios d√≠as, ¬øc√≥mo afecta esto al rendimiento?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disponemos de mesas grandes, monol√≠ticas. </font><font style="vertical-align: inherit;">Hay un fragmento </font><font style="vertical-align: inherit;">El fragmento se altera bastante r√°pido, porque hay muchos cambios paralelos a la vez. </font><font style="vertical-align: inherit;">Una mesa grande con perfiles alter√≥ unas tres horas. </font><font style="vertical-align: inherit;">Utilizamos herramientas Perkonovskie que no lo tienen para leer y escribir. </font><font style="vertical-align: inherit;">Adem√°s, implementamos la modificaci√≥n para que el c√≥digo sea compatible con ambos estados. </font><font style="vertical-align: inherit;">Despu√©s de alterar, tambi√©n implementamos: la implementaci√≥n es m√°s r√°pida que la aplicaci√≥n de cualquier esquema.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos el almacenamiento m√°s grande (lo llamamos "puntos"): esta es una gran base de datos fragmentada. </font><font style="vertical-align: inherit;">Si tomamos la tabla "Usuario", entonces ella tiene muchos fragmentos. </font><font style="vertical-align: inherit;">No le dir√© exactamente cu√°ntas tablas habr√° en un servidor: la idea es que hay muchas peque√±as. </font><font style="vertical-align: inherit;">Cuando cambiamos el circuito, de hecho, solo hacemos un cambio. </font><font style="vertical-align: inherit;">En cada mesa peque√±a, sucede r√°pidamente. </font><font style="vertical-align: inherit;">Hay otros repositorios, ya hay otros enfoques. </font><font style="vertical-align: inherit;">Si hay una base enorme, hay herramientas perconianas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, utilizamos diferentes cosas seg√∫n las necesidades. </font><font style="vertical-align: inherit;">El cambio m√°s frecuente es un cambio en esta enorme base puntual fragmentada, en la que ya tenemos un proceso construido. </font><font style="vertical-align: inherit;">Todo funciona de manera muy simple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La misma aplicaci√≥n monol√≠tica que sirve a la mayor√≠a del tr√°fico se implementa de cinco a seis veces al d√≠a. </font><font style="vertical-align: inherit;">Casi cada dos horas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En t√©rminos de trabajar con la base de datos, este es un tema aparte. </font><font style="vertical-align: inherit;">Hay migraciones, se mueven autom√°ticamente. </font><font style="vertical-align: inherit;">Esta es una revisi√≥n de DBA. </font><font style="vertical-align: inherit;">Hay una opci√≥n para omitir la migraci√≥n y rodar manualmente. </font><font style="vertical-align: inherit;">La migraci√≥n pasar√° autom√°ticamente a la fase de prueba al probar el c√≥digo. </font><font style="vertical-align: inherit;">Pero en la producci√≥n, si hay alg√∫n tipo de migraci√≥n dudosa que utiliza muchos recursos, el DBA lo iniciar√° manualmente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo debe ser tal que funcione con las estructuras de bases de datos antiguas y nuevas. </font><font style="vertical-align: inherit;">A menudo hacemos m√∫ltiples viajes para implementar funciones. </font><font style="vertical-align: inherit;">Para dos o tres despliegues, es posible obtener el estado deseado. </font><font style="vertical-align: inherit;">Del mismo modo, hay grandes bases de datos, bases de datos fragmentadas. </font><font style="vertical-align: inherit;">Si contamos para todos los microservicios, definitivamente hay entre 100 y 150 implementaciones por d√≠a.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Me gustar√≠a saber cu√°l es el tiempo de respuesta est√°ndar para usted que est√° siguiendo. </font><font style="vertical-align: inherit;">¬øCu√°ndo comprende lo que necesita para optimizar a√∫n m√°s, o cu√°l es el momento de terminar? </font><font style="vertical-align: inherit;">¬øExiste un valor de "promedio hospitalario"?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No. </font><font style="vertical-align: inherit;">Depende del punto final. </font><font style="vertical-align: inherit;">Nos fijamos en todo por separado. </font><font style="vertical-align: inherit;">Tratando de entender cu√°n cr√≠tico es esto. </font><font style="vertical-align: inherit;">Algunos puntos finales generalmente se solicitan en segundo plano. </font><font style="vertical-align: inherit;">Esto no afecta al usuario de ninguna manera, incluso si el tiempo de respuesta es de 20 s. </font><font style="vertical-align: inherit;">Esto suceder√° en el fondo, no hay diferencia. </font><font style="vertical-align: inherit;">Lo principal es que algunas cosas importantes se hagan r√°pidamente. </font><font style="vertical-align: inherit;">Quiz√°s 200 ms todav√≠a est√° bien, pero un peque√±o aumento ya importa.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos cambiando de renderizado HTML a solicitudes API. </font><font style="vertical-align: inherit;">Aqu√≠, de hecho, la API responde mucho m√°s r√°pido que la respuesta HTML grande y pesada. </font><font style="vertical-align: inherit;">Por lo tanto, es dif√≠cil distinguir, por ejemplo, un valor de 100 ms. </font><font style="vertical-align: inherit;">Nos centramos en 200 ms. </font><font style="vertical-align: inherit;">Luego sucedi√≥ PHP 7, y comenzamos a centrarnos en 100 ms. </font><font style="vertical-align: inherit;">Este es el "promedio para el hospital". </font><font style="vertical-align: inherit;">Esta es una m√©trica muy vaga, lo que sugiere que es hora de al menos mirar all√≠. </font><font style="vertical-align: inherit;">Y, por lo tanto, nos enfocamos en la implementaci√≥n y saltamos el tiempo de respuesta despu√©s de eso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hicimos un boceto de uno de los equipos de rendimiento. Los colegas midieron cu√°nto m√°s gana una empresa al acelerar la carga de la p√°gina en varios escenarios. Calculamos cu√°nto m√°s compradores, transacciones, llamadas, transiciones, etc. est√°n sucediendo. Seg√∫n estos datos, se puede entender que en alg√∫n momento, la aceleraci√≥n deja de tener sentido. Por ejemplo, si el tiempo de respuesta de una de las p√°ginas de 90 ms se aceler√≥ a 70 ms, esto dio + 2% de compradores. Y si acelera de 70 ms a 60 ms, entonces ya hay m√°s 0.1% de compradores, que generalmente se incluye en el error. Al igual que con los chicos, todo depende mucho de la p√°gina con la que estamos trabajando. En general, el percentil 75 de Avito, unos 75 ms. En mi opini√≥n, esto es lento. Ahora estamos buscando lugares para optimizar. Antes de la transici√≥n a los microservicios, todo sucedi√≥ mucho m√°s r√°pido para nosotros y estamos tratando de optimizar el rendimiento.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5j/tw/ig/5jtwigxel1bcp3pbmmvhdxdslhu.jpeg"><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y la eterna pregunta: ¬øhierro u optimizaci√≥n? </font><font style="vertical-align: inherit;">¬øC√≥mo entender si vale la pena comprar hardware o si es mejor invertir en optimizaci√≥n? </font><font style="vertical-align: inherit;">Donde esta la frontera</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mi opini√≥n: un verdadero programador es la optimizaci√≥n. </font><font style="vertical-align: inherit;">Me parece que en grandes empresas como Badoo, la m√≠a, Yandex, hay muchos desarrolladores de diferentes niveles. </font><font style="vertical-align: inherit;">Hay desarrolladores junior / pasantes y desarrolladores l√≠deres. </font><font style="vertical-align: inherit;">Me parece que el n√∫mero de lugares para la optimizaci√≥n / revisi√≥n siempre se agrega all√≠. </font><font style="vertical-align: inherit;">El hierro es el √∫ltimo paso. </font><font style="vertical-align: inherit;">Para un monolito en 65 LXC, no hemos agregado hierro durante mucho tiempo. </font><font style="vertical-align: inherit;">Utilizaci√≥n de la CPU: 20%. </font><font style="vertical-align: inherit;">Ya estamos pensando en transferirlos al cl√∫ster de Kubernetes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realmente me gusta la posici√≥n de Semyon. Pero tengo un punto de vista completamente opuesto. En primer lugar, mirar√≠a el hierro. ¬øEs posible soltar hierro y ser√° m√°s barato? Si es as√≠, entonces es m√°s f√°cil resolver el problema con el hierro. El desarrollador puede hacer algo m√°s, √∫til en este momento. El tiempo del desarrollador cuesta dinero. El hierro tambi√©n cuesta dinero, por lo que debe comparar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cu√°l de estos es m√°s importante no est√° claro. Si ambos cuestan lo mismo, entonces el hardware gana, porque el desarrollador podr√° hacer algo en este momento. Espec√≠ficamente, en t√©rminos del backend de PHP, no podemos hacer esto. La optimizaci√≥n nos cuesta mucho m√°s barato que comprar hierro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A punto de parar. </font><font style="vertical-align: inherit;">En t√©rminos de planificaci√≥n, tenemos alg√∫n tipo de barra. </font><font style="vertical-align: inherit;">Si reducimos el consumo de CPU por debajo, entonces nos detenemos. </font><font style="vertical-align: inherit;">Por otro lado, tambi√©n existe la calidad del servicio. </font><font style="vertical-align: inherit;">Si vemos que el tiempo de respuesta no nos conviene en alg√∫n lugar, entonces debemos optimizarlo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me parece que todo depende del tama√±o del equipo y del proyecto. </font><font style="vertical-align: inherit;">Cuanto m√°s peque√±o es el proyecto, m√°s f√°cil es comprar hardware, porque el salario del desarrollador es constante y el c√≥digo que funciona, los usuarios que trabajan con √©l, son muy diferentes. </font><font style="vertical-align: inherit;">Si hay pocos usuarios, entonces es m√°s f√°cil comprar hardware y confiar al desarrollador el trabajo para desarrollar el proyecto. </font><font style="vertical-align: inherit;">Si hay muchos usuarios, un desarrollador puede compensar la mayor parte del costo de los servidores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo realmente depende de la escala. </font><font style="vertical-align: inherit;">Si tiene mil servidores y la optimizaci√≥n lleva al hecho de que no necesita otros mil servidores, entonces es claramente mejor optimizar. </font><font style="vertical-align: inherit;">Si tiene un servidor, puede comprar con seguridad dos o tres servidores m√°s y obtener un puntaje de optimizaci√≥n. </font><font style="vertical-align: inherit;">Si el comando es peque√±o, inicie los servidores comprados. </font><font style="vertical-align: inherit;">Si el equipo es grande y tiene dos o tres centros de datos, comprar seis centros de datos ya no es tan barato, ni tan r√°pido.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como tenemos un mitap de PHP, esta frase deber√≠a sonar: ¬øpor qu√© necesitamos PHP, ya que tenemos tales problemas todo el tiempo? </font><font style="vertical-align: inherit;">¬°Reescribamos Go, C, C #, Rust, Node.js! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øCrees que el enfoque de reescritura generalmente est√° justificado? </font><font style="vertical-align: inherit;">¬øHay alg√∫n problema para la soluci√≥n que valga la pena hacer e invertir en este momento?</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, PHP es un muy buen lenguaje. Realmente le permite resolver problemas comerciales. El es lo suficientemente r√°pido. Todos los problemas de rendimiento son problemas de errores, errores, c√≥digo heredado (algunos c√≥digos recortados, cosas no √≥ptimas que se habr√≠an disparado en otro idioma de la misma manera). Al portarlos sin formato a Golang, Java, Python, obtienes el mismo rendimiento. Todo el problema es que hay mucho legado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La introducci√≥n de un nuevo idioma, en mi opini√≥n, tiene sentido para ampliar la pila y las oportunidades de empleo. Ahora es bastante dif√≠cil encontrar buenos desarrolladores de PHP. Si introducimos Golang en el techradar, entonces podemos contratar gophers. Hay pocos shniks PHP y pocos gophers en el mercado, y juntos ya hay muchos de ellos. Por ejemplo, tuvimos un experimento. Tomamos desarrolladores de C # que est√°n listos para aprender nuevos lenguajes, simplemente ampliamos la pila de contrataci√≥n. Si les decimos a las personas que les ense√±aremos a escribir en PHP, dicen que es mejor no hacerlo. Y si les ofrecemos aprender a escribir en PHP, Go y aun as√≠ les prometemos la oportunidad de escribir en Python, la gente estar√° m√°s dispuesta a responder. Para m√≠, esta es una extensi√≥n de las oportunidades de empleo. En otros idiomas, hay algunas cosas que realmente faltan en PHP. Pero en general, PHP es s√∫per suficiente para resolver problemas de negocios e implementar grandes proyectos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probablemente estoy completamente de acuerdo con Semyon. </font><font style="vertical-align: inherit;">Reescribir simplemente no tiene sentido. </font><font style="vertical-align: inherit;">PHP es un lenguaje bastante productivo. </font><font style="vertical-align: inherit;">Si lo compara con otros lenguajes no compilados con script, entonces probablemente ser√° casi el m√°s r√°pido. </font><font style="vertical-align: inherit;">¬øReescribir en algunos idiomas como Go y otros? </font><font style="vertical-align: inherit;">Estos son otros idiomas, tienen otros problemas. </font><font style="vertical-align: inherit;">Todav√≠a es m√°s dif√≠cil escribir sobre ellos: no es tan r√°pido y hay muchos matices.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, hay cosas que son dif√≠ciles o inconvenientes de escribir en PHP. </font><font style="vertical-align: inherit;">Algunas cosas multiproceso y multiproceso son mejores para escribir en otro idioma. </font><font style="vertical-align: inherit;">Un ejemplo de una tarea donde la no utilizaci√≥n de PHP est√° justificada es, en principio, cualquier almacenamiento. </font><font style="vertical-align: inherit;">Si este es un servicio que almacena mucho en la memoria, entonces PHP probablemente no sea el mejor lenguaje, porque tiene una sobrecarga de memoria muy grande debido a la escritura din√°mica. </font><font style="vertical-align: inherit;">Resulta que guardas un int de 4 bytes y se consumen 50 bytes. </font><font style="vertical-align: inherit;">Por supuesto, exagero, pero a√∫n as√≠ esta sobrecarga es muy grande. </font><font style="vertical-align: inherit;">Si tiene alg√∫n tipo de almacenamiento, es mejor escribirlo en otro idioma compilado con escritura est√°tica. </font><font style="vertical-align: inherit;">Al igual que algunas cosas que requieren ejecuci√≥n de subprocesos m√∫ltiples.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPor qu√© se considera que PHP no es muy r√°pido? Porque es din√°mico. La traducci√≥n Go es una soluci√≥n al problema de traducir c√≥digo de tipeo din√°mico a est√°tico. Debido a esto, todo sucede m√°s r√°pido. Espec√≠ficamente para Go, en mi plan hay tareas de un flujo de datos espec√≠fico. Por ejemplo, si hay alg√∫n tipo de flujo de datos que necesita convertirse a formatos m√°s convenientes, esto es lo ideal. Criado por un demonio, recibe un flujo de datos en la entrada, emite otro. Poco recuerdo come. PHP consume mucha memoria en este caso: debe asegurarse cuidadosamente de que se limpie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Transfer to Go es una transferencia a microservicios, porque no recortar√°s todo el c√≥digo. </font><font style="vertical-align: inherit;">No lo tomar√° ni lo reescribir√° en su totalidad. </font><font style="vertical-align: inherit;">La traducci√≥n a microservicios es una tarea m√°s profunda que la traducci√≥n de un idioma a otro. </font><font style="vertical-align: inherit;">Es necesario resolverlo primero, y luego pensar en qu√© idioma escribir. </font><font style="vertical-align: inherit;">La parte m√°s dif√≠cil es aprender a microservicios.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semyon Kataev, Avito</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No es necesario utilizar Go en microservicios. Muchos servicios est√°n escritos en PHP y tienen un tiempo de respuesta aceptable. El equipo que los apoya decidi√≥ por s√≠ mismos que necesitaban escribir la l√≥gica empresarial muy r√°pidamente e introducir funciones. En realidad, a veces lo hacen m√°s r√°pido que los gophers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos una tendencia a contratar gophers, traducir a Go. Pero todav√≠a tenemos la mayor parte del c√≥digo escrito en PHP, por lo que ser√° por al menos unos a√±os m√°s. No hay una carrera real, no decidimos que Go sea mejor o peor. Seis lanzamientos se implementan en el monolito diariamente. Nuestro chat "Avito Deploy" tiene una lista de tareas que se implementan. Se implementan al menos 20 tareas por d√≠a en cada versi√≥n: al menos cinco o seis versiones por d√≠a, aproximadamente 80 tareas que las personas han realizado en estas tareas. Todo esto se hace en PHP.</font></font><br>
<br>
<blockquote>      ?       -,    ?</blockquote><br>
<h3> , </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es muy dif√≠cil. Hay un momento psicol√≥gico: lanc√© una nueva funci√≥n, ya est√°. Lanzamos una nueva caracter√≠stica gigantesca: ¬°eres s√∫per joven! Cuando un gerente o desarrollador dice que elimin√≥ una funci√≥n (desmantelada), no recibe dicho reconocimiento. Su obra no es visible. Por ejemplo, un equipo puede recibir una bonificaci√≥n por la implementaci√≥n exitosa de nuevas caracter√≠sticas, pero no he visto ning√∫n premio por funcionalidad muerta o experimental. Y el resultado de esto puede ser realmente colosal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un mont√≥n de caracter√≠sticas heredadas que nadie ya est√° usando realmente ralentiza el desarrollo. Hay cientos de casos en los que una nueva persona ingresa a una empresa y refactores de un c√≥digo muerto que nunca se llama porque no sabe que es un c√≥digo muerto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos tratando de negociar de alguna manera con los gerentes, descubrir por golog qu√© tipo de caracter√≠stica era, con los analistas consideramos cu√°nto dinero trae, qui√©n lo necesita, y solo despu√©s de eso tratamos de reducirlo. </font><font style="vertical-align: inherit;">Este es un proceso complicado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Buylov, Mamba </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cortamos el c√≥digo muerto cuando llegamos a √©l. </font><font style="vertical-align: inherit;">Y est√° lejos de ser siempre posible cortarlo r√°pidamente. </font><font style="vertical-align: inherit;">Primero escribe un c√≥digo, luego otro, encima de un tercero, y luego debajo de todo resulta que esta caracter√≠stica no es necesaria. </font><font style="vertical-align: inherit;">Ella saca una gran cantidad de dependencias, que tambi√©n deben repararse. </font><font style="vertical-align: inherit;">Esto no siempre es posible, y los gerentes deben informarlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El gerente establece la tarea, usted la eval√∫a. </font><font style="vertical-align: inherit;">Dices: "Sabes, hombre, har√© esto durante seis meses. </font><font style="vertical-align: inherit;">¬øEst√°s listo para tolerar medio a√±o? </font><font style="vertical-align: inherit;">√âl dice: "No, pensemos qu√© se debe cortar, qu√© se puede dejar. </font><font style="vertical-align: inherit;">Lo que es fundamentalmente necesario y lo que se necesita para jugar ". </font><font style="vertical-align: inherit;">As√≠ es como va.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Murzakov, Badoo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando un desarrollador recibe una funci√≥n, eval√∫a lo dif√≠cil que es en t√©rminos de desarrollo, lo dif√≠cil que es en t√©rminos de rendimiento. Si ve que uno u otro, aclara con el gerente de producto si esto es realmente necesario, si podemos eliminar algo en alguna parte. A veces sucede que los cambios no son cr√≠ticos, y los gerentes hacen concesiones r√°pidamente cuando descubren que esto es complicado o est√° consumiendo recursos. Simplemente sucede: dices "elimin√©moslo", y eso es todo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sucede que una caracter√≠stica se va, y despu√©s de eso notamos que no funcionar√° tan bien como nos gustar√≠a. Y luego, nuevamente, puedes hablar con el gerente. A menudo todo termina con √©xito.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No hay un proceso integrado para eliminar funciones. Esto se hace espor√°dicamente. Vemos que hay alguna caracter√≠stica, venimos y ofrecemos desactivarla. Lo apagamos, miramos lo que da y lo cortamos. Otra cosa es el c√≥digo muerto. Tenemos una extensi√≥n especial, incluso una infraestructura completa, para la detecci√≥n de c√≥digo muerto. Vemos este c√≥digo muerto. Estamos tratando de cortarlo lentamente. Otra pregunta es si est√° realmente muerta y la solicitud nunca ingresa, entonces no afecta el rendimiento de ninguna manera. Afecta la capacidad de soporte. La gente lo lee constantemente, aunque puede que no lo lean. No hay una conexi√≥n particular con el rendimiento.</font></font><br>
<br>
<blockquote><i>15      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Badoo PHP Meetup</a>. ,      : SuperJob, ManyChat, , Badoo  FunCorp    . <br>
<br>
,   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">YouTube-</a>. ,       - .<br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a>,     .</i><br>
</blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es487234/">https://habr.com/ru/post/es487234/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es487224/index.html">¬øCu√°nto tiempo puede durar una construcci√≥n a largo plazo, que est√° destinada a convertirse en una obra maestra?</a></li>
<li><a href="../es487226/index.html">Haga su insignia: el complemento de mierda no le importa OFFZONE</a></li>
<li><a href="../es487228/index.html">Frontend mitap Facebook y AvitoTech</a></li>
<li><a href="../es487230/index.html">Notas de vida de EE. UU.</a></li>
<li><a href="../es487232/index.html">La impronta inmune en la infancia: el origen de la protecci√≥n contra virus</a></li>
<li><a href="../es487238/index.html">C√≥mo dise√±ar equipos de protecci√≥n de red el√©ctrica</a></li>
<li><a href="../es487242/index.html">Resumen de eventos de TI de febrero</a></li>
<li><a href="../es487246/index.html">La Autoridad de Certificaci√≥n de Tensor puede comprometer las claves privadas del cliente</a></li>
<li><a href="../es487248/index.html">Un poco m√°s sobre pruebas incorrectas</a></li>
<li><a href="../es487250/index.html">Mezcla alfa retardada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>