<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìº ‚õìÔ∏è ‚å®Ô∏è Repeat Power BI cohort analysis with Python üëµüèª üå™Ô∏è üèóÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear readers! The reason for writing this publication was a webinar, which I looked at Youtube. He was dedicated to a cohort analysis ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Repeat Power BI cohort analysis with Python</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501492/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good afternoon, dear readers! </font><font style="vertical-align: inherit;">The reason for writing this publication was a webinar, which I looked at Youtube. </font><font style="vertical-align: inherit;">He was dedicated to a cohort analysis of sales. </font><font style="vertical-align: inherit;">The author used the Power BI Desktop platform to work with data. </font><font style="vertical-align: inherit;">I will not provide a link to the specified video so that this article is not regarded as an advertisement, but in the course of the narration I will try to make spoilers to the original source in order to better explain the logic of my own decision. </font><font style="vertical-align: inherit;">This webinar gave me the idea that it would be interesting to repeat the possibilities of DAX formulas with the functions of the Pandas library.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two points that I want to focus on. Firstly, this material is intended for beginner analysts who are just taking their first steps in using the Python programming language. Ideal if readers are familiar with the Power BI BI analytics platform. Secondly, since DAX calculations served as a source of inspiration, I will ‚Äúcopy‚Äù the author‚Äôs algorithms as far as possible, and there will inevitably be a departure from the main programming paradigms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the introduction, that's all. Let's hit the road!</font></font><br>
<br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will carry out all calculations in the JupyterLab environment. The laptop solutions can be found at ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data is loaded into Power BI using the Power Query tool (in fact, it is a visual editor that generates queries in the M language). When developing, you should adhere to the following rule: all data preprocessing should be done using Power Query, and metrics should be calculated using Power Pivot. Since our main library is Pandas, we immediately use its capabilities.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment">#   </span>
path_to_data = <span class="hljs-string">"C:/Users/Pavel/Documents/Demo/"</span>
<span class="hljs-comment"># </span>
df = pd.read_csv(os.path.join(path_to_data, <span class="hljs-string">"ohortAnalysis_2016_2018.csv"</span>), sep=<span class="hljs-string">";"</span>, parse_dates=[<span class="hljs-string">"date"</span>], dayfirst=<span class="hljs-literal">True</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will test the lines of code at runtime in order to establish the most time-consuming sections in the future. To set the full path to the read file, use the os library. To simplify the process of developing a laptop, you can do without it. The dataset itself is randomly composed. There are 1,048,575 lines in the CSV file. Reading data with the read_csv () function is usually straightforward. It is enough to specify the column separator and the column with dates, if any, in the array. If the information was uploaded with some "features", then you may need to configure additional parameters, for example, specifying the encoding for each column.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The head () function will often be used in the case to visually monitor the progress of data transformation. All errors cannot be cut off, but obvious flaws can be fixed on the spot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After loading the data into the model, the author of the webinar sorts the data array. This is done in order to add an auxiliary column with indexes. In our case, this column will not be used, but the data will also be sorted in order to more conveniently control the correct calculation of the fields in the tables.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment">#  ,      </span>
df.sort_values([<span class="hljs-string">"user_id"</span>,<span class="hljs-string">"date"</span>], inplace = <span class="hljs-literal">True</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/t7/ek/x9/t7ekx9mfwh5z7cahruxyrvlvetq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the next step, the solution on the Power BI platform proposes to create an auxiliary table, the data from which will be pulled into the main array. Creating a table is done using the SUMMARIZE () function. It creates a pivot table with aggregated totals for selected groups: </font></font><code> df_groupby_user = SUMMARIZE(df;df[user_id];"first_date_transaction";MIN(df[date]);"total_amount_user";SUM(df[amount]);"count_transaction_user";COUNT(df[amount]))</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Pandas library has its counterpart - the groupby () function. To apply groupby () it is enough to specify the necessary data frame, groupable columns, at the end list the columns for which aggregation functions will be applied. The result obtained is reduced to the format of the usual data frame by the reset_index () function. In conclusion, rename the fields.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment">#       user_id. </span>
df_groupby_user = df.groupby(by = [<span class="hljs-string">"user_id"</span>]).agg({<span class="hljs-string">"date"</span>: <span class="hljs-string">"min"</span>, <span class="hljs-string">"amount"</span>: [<span class="hljs-string">"sum"</span>,<span class="hljs-string">"count"</span>]})<font></font>
df_groupby_user.reset_index(inplace = <span class="hljs-literal">True</span>)
<span class="hljs-comment"># </span>
new_columns = [<span class="hljs-string">"user_id"</span>,<span class="hljs-string">"first_date_transaction"</span>, <span class="hljs-string">"total_amount_user"</span>,<span class="hljs-string">"count_transaction_user"</span>]<font></font>
df_groupby_user.columns = new_columns</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the ‚Äúfirst purchase date‚Äù metric, the number of transactions per customer and the total amount of customer purchases for the entire period are calculated. The measurements did not find their application in the laptop, but we will not remove them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We return to the webinar. The new metric "year-month of first purchase" is calculated. DAX formula: </font></font><code> first_transaction = FORMAT(df_groupby_user[first_date_transaction];"YYYY-MM")</code><br>
<br>
<img src="https://habrastorage.org/webt/4l/3n/xo/4l3nxosdn2pddiqx3pffvtrniec.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python uses the syntax dt.strftime ('% Y-% m'). You will find a detailed explanation of how it works in online publications regarding working with date and time in Python. At this step, something else is important. Pay attention to the time of the operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not at all pandas-like performance (24.8 sec.). The line of code is slower than all the previous ones. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This piece of listing becomes the first candidate for possible refactoring.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment">#  -</span>
df_groupby_user[<span class="hljs-string">"first_transaction"</span>] = df_groupby_user[<span class="hljs-string">"first_date_transaction"</span>].dt.strftime(<span class="hljs-string">'%Y-%m'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is time to return to the webinar again. </font><font style="vertical-align: inherit;">There is a union of tables by a key field. </font><font style="vertical-align: inherit;">Then the necessary fields are pulled into the main table using the RELATED () function. </font><font style="vertical-align: inherit;">Pandas does not have this feature. </font><font style="vertical-align: inherit;">But there is merge (), join (), concat (). </font><font style="vertical-align: inherit;">In this case, it is best to apply the first option.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment"># </span>
df_final = pd.merge(df, df_groupby_user, how = <span class="hljs-string">"left"</span>, on = <span class="hljs-string">"user_id"</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the data with the date of the first transaction fell into the main table, you can calculate the delta. </font><font style="vertical-align: inherit;">We use the apply construct (lambda x: ...) to clearly demonstrate how resource-intensive this process is (39.7 sec.). </font><font style="vertical-align: inherit;">Here is another candidate for code rewriting.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment">#   "    "</span>
df_final[<span class="hljs-string">"delta_days"</span>] = df_final[<span class="hljs-string">"date"</span>] - df_final[<span class="hljs-string">"first_date_transaction"</span>]<font></font>
df_final[<span class="hljs-string">"delta_days"</span>] = df_final[<span class="hljs-string">"delta_days"</span>].apply(<span class="hljs-keyword">lambda</span> x: x.days)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main table already has a delta by day, so you can divide the column data into cohorts. Principle: 0 (that is, the first sale to the customer) - cohort 0; values ‚Äã‚Äãgreater than 0, but less than or equal to 30 are 30; values ‚Äã‚Äãgreater than 30, but less than or equal to 90 are 90, etc. For these purposes, in DAX, you can use the CEILING () function. It rounds the number up to the nearest integer, a multiple of the value from the second parameter.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/mu/rh/sdmurhtsdqarznw92jwbklpvjvs.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Python, I did not find a similar mathematical function, although I planned to find it in the math module (maybe I searched poorly). Therefore, I had to go around and apply the cut () function. After spreading the data into cohorts, NaN was mapped to numerical values ‚Äã‚Äãof 0. We cannot solve this problem by using the fillna () function, since we are dealing with categorical data. First you need to add a new value to the category. At the end of this code listing, change the data type to int. This is done so that in the future, when constructing a pivot table using a data frame, the new cohort does not appear at the end of a series of values.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment">#  . </span>
cut_labels_days = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range (<span class="hljs-number">30</span>, <span class="hljs-number">1230</span>, <span class="hljs-number">30</span>)]<font></font>
cut_bins_days = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range (<span class="hljs-number">0</span>, <span class="hljs-number">1230</span>, <span class="hljs-number">30</span>)]<font></font>
df_final[<span class="hljs-string">"cohort_days"</span>] = pd.cut(df_final[<span class="hljs-string">"delta_days"</span>], bins = cut_bins_days, labels=cut_labels_days, right = <span class="hljs-literal">True</span>)<font></font>
%%time<font></font>
<span class="hljs-comment">#     .   fillna   !</span>
df_final[<span class="hljs-string">"cohort_days"</span>] = df_final[<span class="hljs-string">"cohort_days"</span>].cat.add_categories([<span class="hljs-number">0</span>])<font></font>
df_final[<span class="hljs-string">"cohort_days"</span>].fillna(<span class="hljs-number">0</span>, inplace = <span class="hljs-literal">True</span>)<font></font>
%%time<font></font>
<span class="hljs-comment">#     .   fillna   !</span>
df_final[<span class="hljs-string">"cohort_days"</span>] = df_final[<span class="hljs-string">"cohort_days"</span>].cat.add_categories([<span class="hljs-number">0</span>])<font></font>
df_final[<span class="hljs-string">"cohort_days"</span>].fillna(<span class="hljs-number">0</span>, inplace = <span class="hljs-literal">True</span>)
<span class="hljs-comment">#    .    ,  "0"        ,     </span>
<span class="hljs-comment">#    .</span>
df_final[<span class="hljs-string">"cohort_days"</span>] = df_final[<span class="hljs-string">"cohort_days"</span>].astype(int)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the pivot_table () function, we get the desired pivot table. We get quite a lot of cohorts, so the result cannot be completely displayed on the screen. To avoid this, when solving a real case, you can take a shorter time interval for analysis or enlarge the ranges of values ‚Äã‚Äãof the cohorts themselves.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment">#  </span>
df_pivot_table = pd.pivot_table(df_final, values=[<span class="hljs-string">"amount"</span>], index=[<span class="hljs-string">"first_transaction"</span>], columns=[<span class="hljs-string">"cohort_days"</span>], aggfunc=np.sum, fill_value = <span class="hljs-number">0</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/e2/dn/u-/e2dnu-fry4n2hd4fl7_coqm_5mo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Power BI, you need to use the Matrix tool to build such a visualization. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sx/qh/gh/sxqhghd3km7lwdo-aycsry8xnn4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next stage is plotting. The nuance of the situation is that we need the amount on an accrual basis. In Power BI, just select the required 'Quick action' menu item and the necessary DAX formula will be automatically generated. With the Pandas library, the situation is a little more complicated. We double-sequentially group the existing data frame and apply the cumsum () function. Since the result will still be used, we will make a copy of the data frame to build the graph. The accumulated sales values ‚Äã‚Äãwere quite large, so we divide the values ‚Äã‚Äãby 1,000,000 and round the result to two digits after the decimal point.</font></font><br>
<br>
<pre><code class="python hljs">%%time
<span class="hljs-comment">#     amount</span>
df_pivot_table_cumsum = df_final.groupby(by = [<span class="hljs-string">"first_transaction"</span>,<span class="hljs-string">"cohort_days"</span>]).agg({<span class="hljs-string">"amount"</span>: [<span class="hljs-string">"sum"</span>]}).groupby(level=<span class="hljs-number">0</span>).cumsum().reset_index()<font></font>
df_pivot_table_cumsum.columns = [<span class="hljs-string">"first_transaction"</span>,<span class="hljs-string">"cohort_days"</span>,<span class="hljs-string">"cumsum_amount"</span>]<font></font>
%%time<font></font>
<span class="hljs-comment">#     </span><font></font>
df_pivot_table_cumsum_chart = copy.deepcopy(df_pivot_table_cumsum)<font></font>
<span class="hljs-comment">#     ,       Y.</span>
df_pivot_table_cumsum_chart[<span class="hljs-string">"cumsum_amount"</span>]=round(df_pivot_table_cumsum_chart[<span class="hljs-string">"cumsum_amount"</span>]/<span class="hljs-number">1000000</span>, <span class="hljs-number">2</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We use the capabilities of the library to build the graph. A diagram is built in just one line of code, but the result is not impressive. This graph clearly loses to visualizations on any BI platform. You can connect the Plotly library and conjure with add-ons, but this is a completely different labor costs compared to the approach shown in the video.</font></font><br>
<br>
<pre><code class="python hljs">%%time<font></font>
df_pivot_table_cumsum_chart.pivot(index=<span class="hljs-string">"cohort_days"</span>, columns=<span class="hljs-string">"first_transaction"</span>, values=<span class="hljs-string">"cumsum_amount"</span>).plot(figsize = (<span class="hljs-number">15</span>,<span class="hljs-number">11</span>))</code></pre><br>
<img src="https://habrastorage.org/webt/ya/2f/sj/ya2fsjju2epd-vvcn96gms0i5rm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let us make brief conclusions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In terms of calculations, the Pandas library may well replace Power Pivot (DAX). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The feasibility of such a replacement remains outside the conversation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DAX, like the Python library functions, does a good job of performing operations on entire fields of a table. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In terms of speed, simplicity and ease of visualization design, Power BI is superior to Pandas. </font><font style="vertical-align: inherit;">In my opinion, the built-in graphs (as well as those created using the matplotlib, seaborn libraries) are appropriate to apply in two cases: express analysis of a number of data for outliers, local minima / maxima, or preparing slides for presentation. </font><font style="vertical-align: inherit;">The development of graphical control panels is best left to BI solutions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all. </font><font style="vertical-align: inherit;">All health, good luck and professional success!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501480/index.html">Deno v1.0: Secure Runtime for JavaScript and TypeScript. Feature Overview</a></li>
<li><a href="../en501482/index.html">Alien Centaurs</a></li>
<li><a href="../en501484/index.html">The programmer must decide</a></li>
<li><a href="../en501488/index.html">Way from Middle to Senior</a></li>
<li><a href="../en501490/index.html">What's New Expected in Python 3.9</a></li>
<li><a href="../en501494/index.html">Not a Gram for the soul: the story of the failed cryptocurrency Durov</a></li>
<li><a href="../en501496/index.html">Comet Lake, completion of the iteration</a></li>
<li><a href="../en501498/index.html">How much C ++ code needs to be written to parse the Authorization HTTP header using easy_parser from RESTinio?</a></li>
<li><a href="../en501500/index.html">Visual hack: what threatens and how to protect yourself from spying</a></li>
<li><a href="../en501502/index.html">New Lab Digital Synthesis Continues Harris Book and Helps Make FPGA Video Game</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>