<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚐 👩🏻‍🏭 🐨 从OpenVPN迁移到WireGuard，将网络加入一个L2网络 👦🏻 🚵🏾 ❗️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我想分享在三个地理位置遥远的公寓中组合网络的经验，在每个公寓中，带有OpenWRT的路由器用作通向一个公用网络的网关。选择将L3与子网路由和L2与桥接之间的网络组合在一起的方法时，当网络的所有节点都在同一子网上时，首选第二种方法，因为它计划在正在创建的网络中使用透明技术，因此第二种方法更难以配置，但...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>从OpenVPN迁移到WireGuard，将网络加入一个L2网络</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486864/"><img src="https://habrastorage.org/webt/sk/lb/nc/sklbncaul8kfwr65yuroz8eteki.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我想分享在三个地理位置遥远的公寓中组合网络的经验，在每个公寓中，带有OpenWRT的路由器用作通向一个公用网络的网关。</font><font style="vertical-align: inherit;">选择将L3与子网路由和L2与桥接之间的网络组合在一起的方法时，当网络的所有节点都在同一子网上时，首选第二种方法，因为它计划在正在创建的网络中使用透明技术，因此第二种方法更难以配置，但是却提供了更多的机会。局域网唤醒和DLNA。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1部分：背景</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初选择OpenVPN作为执行此任务的协议，因为首先，它可以创建可以轻松添加到网桥的Tap设备，其次，OpenVPN支持TCP协议操作，这也很重要，因为所有公寓都没有专用的IP地址，我无法使用STUN，因为由于某种原因，我的提供商阻止了UDP通过其网络传入的连接，而TCP允许我将VPN服务器的端口转发至使用SSH租用VPS。是的，这种方法带来了很大的负担，因为数据已被加密两次，但是我不想将VPS输入到我的专用网络中，因为存在第三方控制它的风险，因此，在家庭网络上拥有这样的设备是非常不希望的，因此决定以高额开销来支付安全性。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了在计划部署服务器的路由器上转发端口，使用了sshtunnel程序。我不会描述其配置的复杂性-这很容易做到，我只是注意到它的任务是将TCP端口1194从路由器转发到VPS。接下来，在tap0设备上配置OpenVPN服务器，该设备缠绕在br-lan桥中。在检查了与您刚刚从笔记本电脑创建的服务器的连接之后，很明显，端口转发的想法已经奏效，尽管我实际上不在现场，但我的笔记本电脑已成为路由器网络的成员。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事情仍然很小：有必要在不同的公寓中分配IP地址，以免它们冲突，并将路由器配置为OpenVPN客户端。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
选择了以下路由器IP地址和DHCP服务器范围：</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">射程</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.80</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的服务器</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有一定范围的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.101</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.149</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在公寓2号路由器</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.150</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有一定范围的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.151</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.10.199</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第3号公寓路由器</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还需要通过在其配置中添加以下几行，将这些地址分配给OpenVPN服务器的客户端路由器：</font></font><br>
<br>
<pre><code class="plaintext hljs">ifconfig-pool-persist /etc/openvpn/ipp.txt 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并将以下行添加到/etc/openvpn/ipp.txt文件中：</font></font><br>
<br>
<pre><code class="plaintext hljs">flat1_id 192.168.10.100<font></font>
flat2_id 192.168.10.150<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
其中flat1_id和flat2_id是在创建用于连接到OpenVPN的证书时指定的设备名称</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，在路由器上配置了OpenVPN客户端，两个路由器上的tap0设备都添加到了br-lan网桥。在这个阶段，似乎一切都井然有序，因为所有三个网络都可以互相看到并整体运作。但是，事实证明这不是一个非常令人愉快的细节：有时设备无法从其路由器获取IP地址，随之而来的是所有后果。由于某些原因，某些公寓中的路由器没有时间及时响应DHCPDISCOVER，并且设备未收到其地址。我意识到我需要在每个路由器的tap0中过滤此类请求，但是事实证明，如果iptables是网桥的一部分，则iptables不能与该设备一起使用，而ebtables应该可以帮助我。不幸的是，它不在我的固件中，我不得不为每个设备重建映像。完成此操作并将此类行添加到每个路由器的/etc/rc.local后，问题得以解决：</font></font><br>
<br>
<pre><code class="bash hljs">ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A INPUT --<span class="hljs-keyword">in</span>-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-destination-port 67:68 -j DROP<font></font>
ebtables -A FORWARD --out-interface tap0 --protocol ipv4 --ip-protocol udp --ip-source-port 67:68 -j DROP<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种配置持续了三年。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2部分：WireGuard简介</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近，在Internet上，他们开始越来越多地谈论WireGuard，欣赏其配置的简单性，高传输速度，低ping和可比的安全性。搜索有关他的其他信息表明，他们既不支持作为桥接成员，也不支持与TCP一起工作，这使我认为对于我而言，OpenVPN仍然没有其他选择。所以我推迟了认识WireGuard。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
几天前，通过资源，一种或另一种方式与IT连接，有消息传出，WireGuard最终将从5.6版开始包含在Linux内核中。新闻文章一如既往地赞扬WireGuard。我再次投入了寻找替代旧式OpenVPN的方法。这次我碰到</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这篇文章</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。它讨论了使用GRE在L3上构建以太网隧道的问题。这篇文章给了我希望。尚不清楚如何处理UDP协议。通过搜索，我找到了有关将socat与SSH隧道结合使用以转发UDP端口的文章，但是，他们指出，这种方法仅在单连接模式下有效，也就是说，无法使用多个VPN客户端。我想到了在VPS上安装VPN服务器并为客户端设置GRE的想法，但事实证明，GRE不支持加密，这将导致以下事实：如果第三方访问服务器，则我网络之间的所有流量都在他们的手中原则上不适合我。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同样，根据以下方案，通过在VPN上使用VPN来做出过度加密的决定：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一级VPN：</font></font></b><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font><font style="vertical-align: inherit;">内部地址为192.168.30.1 </font><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器</font></font></i><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font><font style="vertical-align: inherit;">内部地址为192.168.30.2 </font><i><font style="vertical-align: inherit;">的</font></i><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">客户端</font></i><b><font style="vertical-align: inherit;">MK2</font></b><font style="vertical-align: inherit;">是</font><font style="vertical-align: inherit;">内部地址为192.168.30.3 </font><i><font style="vertical-align: inherit;">的</font></i><font style="vertical-align: inherit;"> VPS </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">客户端</font></font></i><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">MK3</font></b><font style="vertical-align: inherit;">是</font><font style="vertical-align: inherit;">内部地址为192.168.30.3 </font><i><font style="vertical-align: inherit;">的</font></i><font style="vertical-align: inherit;"> VPS </font><i><font style="vertical-align: inherit;">客户端</font></i></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font><b><font style="vertical-align: inherit;">第二级VPN：</font></b><b><font style="vertical-align: inherit;">MS</font></b><font style="vertical-align: inherit;">是</font><i><font style="vertical-align: inherit;">服务器</font></i><font style="vertical-align: inherit;">具有外部地址192.168.30.2和内部192.168.31.1的</font><b><font style="vertical-align: inherit;">MK2</font></b><font style="vertical-align: inherit;">是</font><i><font style="vertical-align: inherit;">一个</font></i><b><font style="vertical-align: inherit;">MS </font></b><i><font style="vertical-align: inherit;">客户端</font></i><font style="vertical-align: inherit;">，其地址为192.168.30.2并具有内部IP 192.168.31.2 </font><b><font style="vertical-align: inherit;">MK3</font></b><font style="vertical-align: inherit;">是</font><i><font style="vertical-align: inherit;">一个</font></i><b><font style="vertical-align: inherit;">MS </font></b><i><font style="vertical-align: inherit;">客户端</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地址为192.168.30.2，内部IP为192.168.31.3 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公寓1中的路由器-服务器，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公寓2中的</font><font style="vertical-align: inherit;">路由器</font><font style="vertical-align: inherit;">，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公寓3中的路由器</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*设备配置在本文结尾处的扰流器中发布。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在网络192.168.31.0/24的节点之间执行ping操作，是时候继续建立GRE隧道了。在此之前，为了不失去对路由器的访问权限，值得设置SSH隧道以转发VPS上的22个端口，例如，第2套公寓的路由器将在第10022个VPS端口上可用，而在第11122个端口上将可用VPS路由器来自3号公寓。最好使用相同的sshtunnel配置转发，因为如果隧道掉线，它将恢复隧道。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
隧道已配置，您可以通过转发的端口连接到SSH：</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@_VPS -p 10022</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，禁用OpenVPN：</font></font><br>
<br>
<pre><code class="bash hljs">/etc/init.d/openvpn stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，从公寓2在路由器上配置GRE隧道：</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.1 <span class="hljs-built_in">local</span> 192.168.31.2<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并将创建的接口添加到网桥：</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将在路由器服务器上执行类似的过程：</font></font><br>
<br>
<pre><code class="bash hljs">ip link add grelan0 <span class="hljs-built_in">type</span> gretap remote 192.168.31.2 <span class="hljs-built_in">local</span> 192.168.31.1<font></font>
ip link <span class="hljs-built_in">set</span> grelan0 up
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并且，还将创建的接口添加到网桥：</font></font><br>
<br>
<pre><code class="bash hljs">brctl addif br-lan grelan0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从这一刻开始，Ping开始成功进入新网络，而我满意地将要喝咖啡。</font><font style="vertical-align: inherit;">然后，为了评估网络另一端的工作方式，我尝试通过SSH连接到2号公寓中的一台计算机，但是ssh客户端冻结，而没有提示输入密码。</font><font style="vertical-align: inherit;">我尝试通过telnet连接到这台计算机，并连接到端口22，我看到一条线，从中可以了解到正在建立连接，SSH服务器正在响应，仅出于某种原因不提供我登录。</font></font><br>
<br>
<pre><code class="bash hljs">$ telnet 192.168.10.110 22<font></font>
SSH-2.0-OpenSSH_8.1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我尝试通过VNC连接到它并看到黑屏。我向自己保证这是一台远程计算机，因为我可以从内部地址的这套公寓轻松地连接到路由器。但是，我决定通过路由器连接到此计算机的SSH，很惊讶地发现连接成功并且远程计算机可以正常工作，但是它也无法连接到我的计算机。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我从网桥上卸下了grelan0设备，并在2号公寓的路由器上运行OpenVPN，并确保网络再次按预期工作并且连接不会中断。当我进行搜索时，我会遇到一些论坛，在该论坛上人们会抱怨同样的问题，建议他们提高MTU。但是，我无法提高第一级VPN（wg0）的MTU：如果MTU高于1420（会自动设置），则会开始中断，但与此同时，在wg0之上工作的第二级VPN wg1在MTU 1600上也可以正常工作。这足以安装gretap设备的MTU为1500，因此该接口的MTU值与计划将gretap添加到其中的br-lan桥相同。据我了解，网桥将MTU设置为等于所有设备上可用值中的较小者。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我在3号公寓的路由器上进行了类似的配置，唯一的区别是服务器在服务器上添加了第二个gretap接口，名为grelan1，该接口也已添加到br-lan网桥中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一切正常。</font><font style="vertical-align: inherit;">现在，您可以在启动时放置gretap程序集。</font><font style="vertical-align: inherit;">为此，请执行以下操作：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将这些行放在单元2的路由器上的/etc/rc.local中：</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.2<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将此添加到单元3中的路由器的/etc/rc.local中：</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并在服务器路由器上：</font></font><br>
<br>
<pre><code class="plaintext hljs">ip link add grelan0 type gretap remote 192.168.31.2 local 192.168.31.1<font></font>
ip link set dev grelan0 mtu 1500<font></font>
ip link set grelan0 up<font></font>
brctl addif br-lan grelan0<font></font>
<font></font>
ip link add grelan1 type gretap remote 192.168.31.3 local 192.168.31.1<font></font>
ip link set dev grelan1 mtu 1500<font></font>
ip link set grelan1 up<font></font>
brctl addif br-lan grelan1<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重新启动客户端路由器后，我发现由于某种原因它们没有连接到服务器。</font><font style="vertical-align: inherit;">连接到他们的SSH（幸运的是，我为此预先配置了sshtunnel）后，发现WireGuard出于某种原因正在为端点创建路由，但这是不正确的。</font><font style="vertical-align: inherit;">因此，对于192.168.30.2，路由表指示了通过pppoe-wan接口（即，通过Internet）的路由，尽管到该路由的路由应该已经通过wg0接口进行了路由。</font><font style="vertical-align: inherit;">删除此路由后，恢复了连接。</font><font style="vertical-align: inherit;">我在某处找不到有关如何使WireGuard不创建这些路由的说明。</font><font style="vertical-align: inherit;">而且，我什至不知道，功能是OpenWRT还是WireGuard本身。</font><font style="vertical-align: inherit;">不用长时间解决这个问题，我只是在此路由器上添加了一行到由计时器循环的脚本中以删除此路由：</font></font><br>
<br>
<pre><code class="bash hljs">route del 192.168.30.2
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总结一下</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我还没有完全拒绝使用OpenVPN，因为有时我需要从笔记本电脑或手机连接到新网络，并且通常无法在它们上安装gretap设备，但是尽管如此，我还是获得了公寓之间数据传输速度的优势并且，例如，现在使用VNC不会带来任何不便。</font><font style="vertical-align: inherit;">Ping略有下降，但变得更加稳定：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用OpenVPN时：</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=133 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=125 ms<font></font>
<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19006ms<font></font>
rtt min/avg/max/mdev = 124.722/126.152/136.907/3.065 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用WireGuard时：</font></font><br>
<br>
<pre><code class="plaintext hljs">[r0ck3r@desktop ~]$ ping -c 20 192.168.10.110<font></font>
PING 192.168.10.110 (192.168.10.110) 56(84) bytes of data.<font></font>
64 bytes from 192.168.10.110: icmp_seq=1 ttl=64 time=124 ms<font></font>
...<font></font>
64 bytes from 192.168.10.110: icmp_seq=20 ttl=64 time=124 ms<font></font>
--- 192.168.10.110 ping statistics ---<font></font>
20 packets transmitted, 20 received, 0% packet loss, time 19003ms<font></font>
rtt min/avg/max/mdev = 123.954/124.423/126.708/0.675 ms<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPS之前的高ping（大约61.5 ms）对它的影响更大，</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是速度显着提高。</font><font style="vertical-align: inherit;">因此，在带有路由器服务器的公寓中，我的Internet连接速度为30 Mbit / s，在其他公寓中为5 Mbit / s。</font><font style="vertical-align: inherit;">同时，根据iperf，在使用OpenVPN时，我无法实现网络之间的数据传输速率超过3.8 Mb / s，而WireGuard将其“抽取”到相同的5 Mb / s。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS上的WireGuard配置</font></font></b><div class="spoiler_text"><code>[Interface]<br>
Address = 192.168.30.1/24<br>
ListenPort = 51820<br>
PrivateKey = &lt;___VPS&gt;<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_1_&gt;<br>
AllowedIPs = 192.168.30.2/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_2&gt;<br>
AllowedIPs = 192.168.30.3/32<br>
<br>
[Peer]<br>
PublicKey = &lt;__VPN_2_3&gt;<br>
AllowedIPs = 192.168.30.4/32</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MS上的WireGuard配置（添加到/ etc / config / network）</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.2/24'<font></font>
        option private_key '__VPN_1_'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option route_allowed_ips '1'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_'<font></font>
        option listen_port '51821'<font></font>
        list addresses '192.168.31.1/24'<font></font>
        option auto '1'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_2'<font></font>
        list allowed_ips '192.168.31.2'<font></font>
<font></font>
config wireguard_wg1ip link add grelan0 type gretap remote 192.168.31.1 local 192.168.31.3<font></font>
        option public_key '__VPN_2_3'<font></font>
        list allowed_ips '192.168.31.3'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK2上的WireGuard配置（添加到/ etc / config / network）</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.3/24'<font></font>
        option private_key '__VPN_1_2'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_2'<font></font>
        list addresses '192.168.31.2/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK3上的WireGuard配置（添加到/ etc / config / network）</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">#VPN   - <font></font>
config interface 'wg0'<font></font>
        option proto 'wireguard'<font></font>
        list addresses '192.168.30.4/24'<font></font>
        option private_key '__VPN_1_3'<font></font>
        option auto '1'<font></font>
<font></font>
config wireguard_wg0<font></font>
        option public_key '__VPN_1_VPS'<font></font>
        option endpoint_port '51820'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.30.0/24'<font></font>
        option endpoint_host 'IP__VPS'<font></font>
<font></font>
#VPN   - <font></font>
config interface 'wg1'<font></font>
        option proto 'wireguard'<font></font>
        option private_key '__VPN_2_3'<font></font>
        list addresses '192.168.31.3/24'<font></font>
        option auto '1'<font></font>
        option listen_port '51821'<font></font>
        option mtu '1600'<font></font>
<font></font>
config wireguard_wg1<font></font>
        option public_key '__VPN_2_'<font></font>
        option endpoint_host '192.168.30.2'<font></font>
        option endpoint_port '51821'<font></font>
        option persistent_keepalive '25'<font></font>
        list allowed_ips '192.168.31.0/24'<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在所描述的第二层VPN配置中，我为WireGuard客户端指定了51821端口，原则上这是没有必要的，因为客户端将通过任何免费的非特权端口建立连接，但是我这样做是为了阻止所有路由器的wg0接口上的所有传入连接。到端口51821的UDP传入连接。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我希望本文对某人有用。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">另外，我想共享我的脚本，当网络上出现新设备时，该脚本会在电话中向我发送一个PUSH通知到WirePusher应用程序。</font><font style="vertical-align: inherit;">这是脚本的链接：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/r0ck3r/device_discover</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置OpenVPN服务器和客户端</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN服务器</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client-to-client<font></font>
<font></font>
ca /etc/openvpn/server/ca.crt<font></font>
cert /etc/openvpn/server/vpn-server.crt<font></font>
dh /etc/openvpn/server/dh.pem<font></font>
key /etc/openvpn/server/vpn-server.key<font></font>
<font></font>
dev tap<font></font>
ifconfig-pool-persist /etc/openvpn/ipp.txt 0<font></font>
keepalive 10 60<font></font>
proto tcp4<font></font>
server-bridge 192.168.10.1 255.255.255.0 192.168.10.80 192.168.10.254<font></font>
status /var/log/openvpn-status.log<font></font>
verb 3<font></font>
comp-lzo</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN客户端</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">client<font></font>
tls-client<font></font>
dev tap<font></font>
proto tcp<font></font>
remote VPS_IP 1194 # Change to your router's External IP<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
<font></font>
ca client/ca.crt<font></font>
cert client/client.crt<font></font>
key client/client.key<font></font>
dh client/dh.pem<font></font>
<font></font>
comp-lzo<font></font>
persist-tun<font></font>
persist-key<font></font>
verb 3</code></pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生成使用easy-rsa的证书</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN486864/">https://habr.com/ru/post/zh-CN486864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN486844/index.html">Facebook Webhook处理的演变：从零到每秒25,000</a></li>
<li><a href="../zh-CN486850/index.html">新预留的座位-如胶囊旅馆</a></li>
<li><a href="../zh-CN486858/index.html">创建一个成熟的Viberbot。第二部分-首次联系或“ conversion_started”</a></li>
<li><a href="../zh-CN486860/index.html">ATX12VO-吃一种新方法</a></li>
<li><a href="../zh-CN486862/index.html">运动设计可帮助您与人建立联系的5个原因</a></li>
<li><a href="../zh-CN486866/index.html">同步信号：纳米技术中的生物马达</a></li>
<li><a href="../zh-CN486868/index.html">为什么和为谁做Slime Agile</a></li>
<li><a href="../zh-CN486870/index.html">我们如何摆脱欺诈</a></li>
<li><a href="../zh-CN486872/index.html">的Linux 键盘设定</a></li>
<li><a href="../zh-CN486874/index.html">冠状病毒2019-nCoV：低死亡率，高死亡率</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>