<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≥üèø üôã üåÅ Orchestrator for MySQL: why a fail-safe project cannot be built without it üöÑ üî∞ üÜí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Any major project started with a pair of servers. First, there was one DB server, then slaves were added to it to scale the reading. And here - stop! ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Orchestrator for MySQL: why a fail-safe project cannot be built without it</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/citymobil/blog/501994/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Any major project started with a pair of servers. </font><font style="vertical-align: inherit;">First, there was one DB server, then slaves were added to it to scale the reading. </font><font style="vertical-align: inherit;">And here - stop! </font><font style="vertical-align: inherit;">One master, but many slaves; </font><font style="vertical-align: inherit;">if one of the slaves leaves, then everything will be fine, but if the master leaves, it will be bad: downtime, admins in the soap raise the server. </font><font style="vertical-align: inherit;">What to do? </font><font style="vertical-align: inherit;">Reserve the master. </font><font style="vertical-align: inherit;">My colleague Pavel has already written an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about this </font><font style="vertical-align: inherit;">, I will not repeat it. </font><font style="vertical-align: inherit;">Instead, I'll tell you why you definitely need an Orchestrator for MySQL!</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the main question: ‚ÄúHow will we switch the code to a new machine when the wizard leaves?‚Äù</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The scheme with VIP (Virtual IP) I like the most, we‚Äôll talk about it below. </font><font style="vertical-align: inherit;">It is the simplest and most obvious, although it has an obvious limitation: the master, which we will reserve, must be in the L2 segment with a new machine, that is, you can forget about the second DC. </font><font style="vertical-align: inherit;">And, in a good way, if you follow the rule that large L2 is evil, because L2 is only per rack, and between the racks L3, and such a scheme has even more restrictions.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can register a DNS name in the code and resolve it through / etc / hosts. </font><font style="vertical-align: inherit;">In fact, there will be no resolution. </font><font style="vertical-align: inherit;">Advantage of the scheme: there is no restriction characteristic of the first method, that is, it is possible to organize cross-DCs as well. </font><font style="vertical-align: inherit;">But then the obvious question arises, how quickly through Puppet-Ansible will we deliver the change to / etc / hosts.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can change the second method a bit: on all web servers we put caching DNS, through which the code will go to the master database. </font><font style="vertical-align: inherit;">You can register TTL 60 for this DNS entry. </font><font style="vertical-align: inherit;">It seems that with proper implementation, the method is good.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schema with service discovery involving Consul and etcd.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An interesting option with </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It is necessary to wrap all traffic to MySQL through ProxySQL, ProxySQL can determine who the master is now. </font><font style="vertical-align: inherit;">By the way, about one of the options for using this product can be found in my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The author of Orchestrator, while working on Github, first implemented the first scheme with VIP, and then redesigned it with c consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Typical infrastructure scheme:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/76b/1d1/aa6/76b1d1aa670440b7abab79d7af3e3c4d.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will immediately describe the obvious situations to consider:</font></font><br>
<br>
<ul>
<li>VIP-           .  :  ,    , Orchestrator    failover      ;    ,   VIP   .  .</li>
<li>            .     ifdown,     ‚Äî ifup vip.       ,    failover       ,    splitbrain.</li>
<li> ,  Orchestrator   ,    VIP /    ,         VIP,    arping  ,   VIP  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All slaves should have read_only = 1, and as soon as you promote the slave to the master, it should have read_only = 0.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not forget that any slave that we have chosen for this can become a master (Orchestrator has a whole mechanism of preference, which slave should be considered as a candidate for a new master in the first place, which one in the second, and which slave should not be selected at all under any circumstances master). </font><font style="vertical-align: inherit;">If the slave becomes a master, then the slave load will remain on it and the master load will be added, this must be taken into account.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why do you absolutely need Orchestrator if you don‚Äôt have one?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator has a very user-friendly graphical interface that displays the entire topology (see screenshot below).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator can track which slaves are behind, and where replication is generally broken (we have scripts for sending SMS to Orchestrator).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator tells you which slides have a GTID errant error.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Orchestrator Interface:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f9/44a/bfc/4f944abfc03d26710c2164369c185893.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is a GTID errant? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two basic requirements for Orchestrator to work:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is necessary that pseudo GTID is enabled on all machines in the MySQL cluster, we have GTID enabled.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is necessary that everywhere there is one type of binlogs, you can statement. </font><font style="vertical-align: inherit;">We had such a configuration in which Row was on the master and on most of the slaves, and the Mixed mode remained historically on two. </font><font style="vertical-align: inherit;">As a result, Orchestrator simply did not want to connect these slaves to the new master.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remember that the most important thing in a production slave is its consistency with the master! </font><font style="vertical-align: inherit;">If you have the Global Transaction ID (GTID) enabled on both the master and the slave, you can use the gtid_subset function to find out if the same data change requests are actually executed on these machines. </font><font style="vertical-align: inherit;">Read more about this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, Orchestrator shows you through a GTID errant error that there are transactions on the slave that are not on the wizard. </font><font style="vertical-align: inherit;">Why it happens?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read_only = 1 is not enabled on the slave, someone connected and executed a request for data change.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Super_read_only = 1 is not enabled on the slave, then the administrator, having mixed up the server, went in and executed a request there.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you took into account both of the previous paragraphs, there is one more trick: in MySQL, the request for flush binlogs also falls into the binlog, so when you flush the first time, a GTID errant will appear on the wizard and on all slaves. </font><font style="vertical-align: inherit;">How to avoid this? </font><font style="vertical-align: inherit;">In perona-5.7.25-28, the binlog_skip_flush_commands = 1 setting appeared, which forbids writing flush to binlogs. </font><font style="vertical-align: inherit;">There is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bug in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mysql.com </font><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I summarize all of the above. </font><font style="vertical-align: inherit;">If you do not want to use Orchestrator in failover mode yet, put it in surveillance mode. </font><font style="vertical-align: inherit;">Then you will always have before your eyes a map of the interaction of MySQL machines and clear information about what type of replication on each machine, whether the slaves are behind, and most importantly - how much consistency they have with the master!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The obvious question is: ‚ÄúHow should Orchestrator work?‚Äù He must select a new master from the current slaves, and then reconnect all the slaves to it (this is what GTID is for; if you use the old mechanism with binlog_name and binlog_pos, then switching the slave from the current master to the new one is simply impossible!). Before Orchestrator came to us, I once had to do all this manually. The old master crashed due to a buggy Adaptec controller, it had about 10 slaves. I needed to transfer the VIP from the master to one of the slaves and reconnect all the other slaves to it. How many consoles I had to open, how many simultaneous commands to enter ... I had to wait until 3 a.m., remove the load from all the slaves, except two, make the first car out of two masters, immediately hook up the second car to it,therefore, pick up all the other slaves to the new master and return the load. In general, the horror ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How does Orchestrator work when it enters failover mode? This is most easily shown by the example of a situation where we want to make a master a more powerful, more modern machine than now.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/577/a97/07d/577a9707d589865d8c5318281c418758.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The figure shows the middle of the process. </font><font style="vertical-align: inherit;">What has already been done up to this point? </font><font style="vertical-align: inherit;">We said that we want to make some kind of slave a new master, Orchestrator just started reconnecting all the other slaves to it, and the new master acts as a transit machine. </font><font style="vertical-align: inherit;">With this scheme, no errors occur, all the slaves work, Orchestrator removes the VIP from the old master, transfers it to the new one, makes read_only = 0 and forgets about the old master. </font><font style="vertical-align: inherit;">All! </font><font style="vertical-align: inherit;">The downtime of our service is the VIP transfer time, it is 2-3 seconds. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all for today, thank you all. </font><font style="vertical-align: inherit;">Soon there will be a second article about Orchestrator. </font><font style="vertical-align: inherit;">In the famous Soviet film ‚ÄúThe Garage,‚Äù one hero said, ‚ÄúI wouldn‚Äôt go into intelligence with him!‚Äù </font><font style="vertical-align: inherit;">So, Orchestrator, I‚Äôd go with you to scout!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501984/index.html">What to see in quarantine? A selection of materials from Technostream (part 4)</a></li>
<li><a href="../en501986/index.html">Secrets of the incredible success of Apple AirPods</a></li>
<li><a href="../en501988/index.html">How does the VK message screen render?</a></li>
<li><a href="../en501990/index.html">Useful post: 4 events to solve the problems of the second day in OpenShift and create operators</a></li>
<li><a href="../en501992/index.html">How to organize testing in order to accelerate and stabilize product releases. Part 1</a></li>
<li><a href="../en501996/index.html">Zen Go (Pocket Version)</a></li>
<li><a href="../en501998/index.html">Expensive price of styles. Yandex Report</a></li>
<li><a href="../en502000/index.html">12 Data Engineering Online Courses</a></li>
<li><a href="../en502004/index.html">Kanban Method: Understanding Your Process as a Collective Knowledge Process - Part 1 (recipes)</a></li>
<li><a href="../en502008/index.html">Programming to the masses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>