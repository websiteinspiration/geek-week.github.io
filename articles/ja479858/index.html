<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â–¶ï¸ ğŸ¥— ğŸ¤¹ğŸ½ LD_PRELOADã‚’æ¢ã—ã¦ã„ã¾ã™ ğŸ‘©â€âš•ï¸ ğŸ›€ğŸ½ ğŸ§™ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã“ã®ãƒ¡ãƒ¢ã¯2014å¹´ã«æ›¸ã‹ã‚Œã¾ã—ãŸãŒã€ç§ã¯ãƒãƒ–ã§å¼¾åœ§ã‚’å—ã‘ãŸã ã‘ã§ã€å½¼å¥³ã¯å…‰ã‚’è¦‹ã¾ã›ã‚“ã§ã—ãŸã€‚ç¦æ­¢æœŸé–“ä¸­ã€ç§ã¯ãã‚Œã‚’å¿˜ã‚Œã¦ã„ã¾ã—ãŸãŒã€ä»Šã¯è‰ç¨¿ã«ãã‚Œã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚å‰Šé™¤ã™ã‚‹ã“ã¨ã ã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€èª°ã‹ãŒé‡å®ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
 
 
 
 ä¸€èˆ¬çš„ã«ã€é‡‘æ›œæ—¥ã®å°ã•ãªç®¡ç†è€…ã¯ã€ã€Œå«ã¾ã‚Œã¦ã„ã‚‹ã€LD_...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>LD_PRELOADã‚’æ¢ã—ã¦ã„ã¾ã™</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479858/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®ãƒ¡ãƒ¢ã¯2014å¹´ã«æ›¸ã‹ã‚Œã¾ã—ãŸãŒã€ç§ã¯ãƒãƒ–ã§å¼¾åœ§ã‚’å—ã‘ãŸã ã‘ã§ã€å½¼å¥³ã¯å…‰ã‚’è¦‹ã¾ã›ã‚“ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">ç¦æ­¢æœŸé–“ä¸­ã€ç§ã¯ãã‚Œã‚’å¿˜ã‚Œã¦ã„ã¾ã—ãŸãŒã€ä»Šã¯è‰ç¨¿ã«ãã‚Œã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">å‰Šé™¤ã™ã‚‹ã“ã¨ã ã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€èª°ã‹ãŒé‡å®ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o1/8i/wf/o18iwf72_dlx0j9-qjr8zni5unq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€èˆ¬çš„ã«ã€é‡‘æ›œæ—¥ã®å°ã•ãªç®¡ç†è€…ã¯ã€ã€Œå«ã¾ã‚Œã¦ã„ã‚‹ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’æ¤œç´¢ã™ã‚‹ãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦èª­ã‚“ã§ã„ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.é–¢æ•°ç½®æ›ã«æ…£ã‚Œã¦ã„ãªã„äººã®ãŸã‚ã®å°ã•ãªä½™è«‡</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ®‹ã‚Šã¯ç›´æ¥</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ãƒ†ãƒƒãƒ—2ã«</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€²ã‚€ã“ã¨ãŒã§ã</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¤å…¸çš„ãªä¾‹ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  srand (time(<span class="hljs-literal">NULL</span>));
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">5</span>; i++){
    <span class="hljs-built_in">printf</span> (<span class="hljs-string">"%d\n"</span>, rand()%<span class="hljs-number">100</span>);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ•ãƒ©ã‚°ãªã—ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">$ gcc ./ld_rand.c -o ld_rand
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦ã€äºˆæƒ³é€šã‚Šã€100æœªæº€ã®5ã¤ã®ä¹±æ•°ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ./ld_rand<font></font>
53<font></font>
93<font></font>
48<font></font>
57<font></font>
20<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ã‹ã—ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒãªãã€å‹•ä½œã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãŸã¨ãˆã°ã€ç‹¬è‡ªã®é–¢æ•°ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨ã—ã¦ç‹¬è‡ªã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rand</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;<font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ gcc -shared -fPIC ./o_rand.c -o ld_rand.so
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦ä»Šã€ç§ãŸã¡ã®ãƒ©ãƒ³ãƒ€ãƒ ãªé¸æŠã¯ã‹ãªã‚Šäºˆæ¸¬å¯èƒ½ã§ã™ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs"># LD_PRELOAD=$PWD/ld_rand.so ./ld_rand<font></font>
42<font></font>
42<font></font>
42<font></font>
42<font></font>
42<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åˆã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã€ã“ã®ãƒˆãƒªãƒƒã‚¯ã¯ã•ã‚‰ã«å°è±¡çš„ã«è¦‹ãˆã¾ã™ </font></font><br>
<br>
<pre><code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_rand.so
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãŸã¯äº‹å‰å®Ÿè¡Œ</font></font><br>
<br>
<pre><code class="plaintext hljs"># echo "$PWD/ld_rand.so" &gt; /etc/ld.so.preload
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã®ã‚³ãƒ¼ãƒ‰ã®1è¡Œã¯å¤‰æ›´ã—ã¦ã„ã¾ã›ã‚“ãŒã€ãã®å‹•ä½œã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å°ã•ãªé–¢æ•°ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚ã•ã‚‰ã«ã€åŸ·ç­†ã®æ™‚ç‚¹ã§ã¯ã€å½ã®</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ãƒ³ãƒ‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã•ãˆå­˜åœ¨ã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç§ãŸã¡ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå½ã®</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ãƒ³ãƒ‰ã‚’</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨ã—ãŸã®ã¯</font><font style="vertical-align: inherit;">ãªãœã§ã™ã‹ï¼Ÿæ‰‹é †ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã™ã‚‹ã¨ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å¿…è¦ãªé–¢æ•°ã‚’å«ã‚€ç‰¹å®šã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ldd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚‰ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs"># ldd ./ld_rand<font></font>
        linux-vdso.so.1 (0x00007ffc8b1f3000)<font></font>
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fe3da8af000)<font></font>
        /lib64/ld-linux-x86-64.so.2 (0x00007fe3daa7e000)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ãƒªã‚¹ãƒˆã¯OSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ãã“ã«ã¯</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libc.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«</font><i><font style="vertical-align: inherit;">ãŒ</font></i><font style="vertical-align: inherit;">å¿…è¦ã§ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¨ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãªã©ã®åŸºæœ¬æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã®ã¯ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™</font><font style="vertical-align: inherit;">ã€‚ç§ãŸã¡ã®</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ãƒ³ãƒ‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚‚ãã®1ã¤ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs"># nm -D /lib/x86_64-linux-gnu/libc.so.6 | grep " rand$"<font></font>
000000000003aef0 T rand<font></font>
</code></pre><br><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">LD_PRELOAD</font></i><font style="vertical-align: inherit;"> 
ã‚’ä½¿ç”¨ã™ã‚‹ã¨ãã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚»ãƒƒãƒˆãŒå¤‰æ›´ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†</font></font><i><font style="vertical-align: inherit;"></font></i><br>
<br>
<pre><code class="plaintext hljs"># LD_PRELOAD=$PWD/ld_rand.so ldd ./ld_rand<font></font>
        linux-vdso.so.1 (0x00007ffea52ae000)<font></font>
        /scripts/c/ldpreload/ld_rand.so (0x00007f690d3f9000)<font></font>
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f690d230000)<font></font>
        /lib64/ld-linux-x86-64.so.2 (0x00007f690d405000)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã¯å¿…è¦ã¨ã—ã¾ã›ã‚“ãŒã€</font><font style="vertical-align: inherit;">
å¤‰æ•°</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOADã‚’</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¨­å®šã™ã‚‹ã¨ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld_rand.soãŒå¼·åˆ¶çš„</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã«èª­ã¿è¾¼ã¾</font><font style="vertical-align: inherit;">ã‚Œã‚‹ã“ã¨ãŒ</font><i><font style="vertical-align: inherit;">ã‚ã‹ã‚Š</font></i><font style="vertical-align: inherit;">ã¾ã™</font><font style="vertical-align: inherit;">ã€‚ãã—ã¦ã€ç§ãŸã¡ã®</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é–¢æ•°ã¯</font><i><font style="vertical-align: inherit;">libc.so</font></i><font style="vertical-align: inherit;">ã‹ã‚‰</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ˆã‚Šã‚‚æ—©ããƒ­ãƒ¼ãƒ‰ã•</font><font style="vertical-align: inherit;">ã‚Œã‚‹</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŸã‚</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ãƒœãƒ¼ãƒ«ã‚’æ”¯é…ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OKã€ãƒã‚¤ãƒ†ã‚£ãƒ–é–¢æ•°ã®ç½®ãæ›ãˆã«æˆåŠŸã—ã¾ã—ãŸãŒã€ãã®æ©Ÿèƒ½ãŒç¶­æŒã•ã‚Œã€ã„ãã¤ã‹ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•ã€‚ãƒ©ãƒ³ãƒ€ãƒ ã‚’å¤‰æ›´ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
 <font></font>
<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(*orig_rand_f_type)</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<font></font>
 <font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rand</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">/*    */</span>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Evil injected code\n"</span>);<font></font>
  <font></font>
  orig_rand_f_type orig_rand;<font></font>
  orig_rand = (orig_rand_f_type)dlsym(RTLD_NEXT,<span class="hljs-string">"rand"</span>);
  <span class="hljs-keyword">return</span> orig_rand();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã“ã§ã¯ã€ã€Œã‚¢ãƒ‰ã‚ªãƒ³ã€ã¨ã—ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’1è¡Œã ã‘å°åˆ·ã—ã€å…ƒã®</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é–¢æ•°ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ã“ã®é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹ã«</font><font style="vertical-align: inherit;">ã¯ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dlsym</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŒå¿…è¦</font><i><font style="vertical-align: inherit;">ã§ã™ã€‚</font></i><font style="vertical-align: inherit;">ã“ã‚Œã¯</font><font style="vertical-align: inherit;">ã€å‹•çš„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¹ã‚¿ãƒƒã‚¯ã§</font><i><font style="vertical-align: inherit;">ãƒ©ãƒ³ãƒ‰</font></i><font style="vertical-align: inherit;">ã‚’è¦‹ã¤ã‘ã‚‹</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é–¢æ•°</font><font style="vertical-align: inherit;">ã§ã™ã€‚</font><font style="vertical-align: inherit;">ãã®å¾Œã€ã“ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ãã®å€¤ã‚’è¿”ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã—ãŸãŒã£ã¦ã€</font><i><font style="vertical-align: inherit;">ãƒ“ãƒ«ãƒ‰</font></i><font style="vertical-align: inherit;">æ™‚ã«</font><i><font style="vertical-align: inherit;">ã€Œ-ldlã€</font></i><font style="vertical-align: inherit;">ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="plaintext hljs">$ gcc -ldl -shared -fPIC ./o_rand_evil.c -o ld_rand_evil.so
</code></pre><br>
<pre><code class="plaintext hljs">$ LD_PRELOAD=$PWD/ld_rand_evil.so ./ld_rand<font></font>
Evil injected code<font></font>
66<font></font>
Evil injected code<font></font>
28<font></font>
Evil injected code<font></font>
93<font></font>
Evil injected code<font></font>
93<font></font>
Evil injected code<font></font>
95<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦ã€ç§ãŸã¡ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€</font><font style="vertical-align: inherit;">ã„ãã¤ã‹ã®ã‚ã„ã›ã¤ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ãŸå¾Œ</font><font style="vertical-align: inherit;">ã€ã€Œãƒã‚¤ãƒ†ã‚£ãƒ–ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">randã‚’</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨ã—</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.å°â€‹â€‹éº¦ç²‰æ¤œç´¢</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ½œåœ¨çš„ãªè„…å¨ã‚’çŸ¥ã£ã¦ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ãŒ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Ÿè¡Œã•</font><font style="vertical-align: inherit;">ã‚ŒãŸã“ã¨ã‚’ç™ºè¦‹ã—ãŸã„ã¨æ€ã„</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ¤œå‡ºã™ã‚‹ãŸã‚ã®æœ€è‰¯ã®æ–¹æ³•ã¯ãã‚Œã‚’ã‚«ãƒ¼ãƒãƒ«ã«æŠ¼ã—è¾¼ã‚€ã“ã¨ã§ã‚ã‚‹ã“ã¨ã¯æ˜ã‚‰ã‹ã§ã™ãŒã€ç§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç©ºé–“ã§ã®å®šç¾©ã«æ­£ç¢ºã«èˆˆå‘³ã‚’æŒã£ã¦ã„ã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«ã€æ¤œå‡ºã¨åé§ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒšã‚¢ã«ãªã‚Šã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1ã€‚</font><font style="vertical-align: inherit;">ç°¡å˜ãªã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‰è¿°ã®ã‚ˆã†ã«ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã€</font><font style="vertical-align: inherit;">ã¾ãŸã¯</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/ld.so.preload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ã“ã¨ã§ã€</font><font style="vertical-align: inherit;">ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æŒ‡å®š</font><i><font style="vertical-align: inherit;">ã§ã</font></i><font style="vertical-align: inherit;">ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æœ€ã‚‚å˜ç´”ãª2ã¤ã®æ¤œå‡ºå™¨ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1ã¤ç›®ã¯ã€è¨­å®šã•ã‚ŒãŸç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">char</span>*  pGetenv = getenv(<span class="hljs-string">"LD_PRELOAD"</span>);<font></font>
  pGetenv != <span class="hljs-literal">NULL</span> ?
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (getenv) [+]\n"</span>):
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (getenv) [-]\n"</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2ã¤ç›®ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  open(<span class="hljs-string">"/etc/ld.so.preload"</span>, O_RDONLY) != <span class="hljs-number">-1</span> ?
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (open) [+]\n"</span>):
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (open) [-]\n"</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒ­ãƒ¼ãƒ‰ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_rand.so<font></font>
$ echo "$PWD/ld_rand.so" &gt; /etc/ld.so.preload<font></font>
<font></font>
$ ./detect_base_getenv<font></font>
LD_PRELOAD (getenv) [+]<font></font>
$ ./detect_base_open<font></font>
LD_PRELOAD (open) [+]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥é™ã€[+]ã¯æ¤œå‡ºãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ãŸãŒã£ã¦ã€[-]ã¯ãƒã‚¤ãƒ‘ã‚¹æ¤œå‡ºã‚’æ„å‘³ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®ã‚ˆã†ãªæ¤œå‡ºå™¨ã¯ã©ã‚Œã»ã©åŠ¹æœçš„ã§ã™ã‹ï¼Ÿ</font><font style="vertical-align: inherit;">ã¾ãšã€ç’°å¢ƒå¤‰æ•°ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">char</span>* (*orig_getenv)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *) = <span class="hljs-literal">NULL</span>;
<span class="hljs-function"><span class="hljs-keyword">char</span>* <span class="hljs-title">getenv</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name)</span>
</span>{
    <span class="hljs-keyword">if</span>(!orig_getenv) orig_getenv = dlsym(RTLD_NEXT, <span class="hljs-string">"getenv"</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">"LD_PRELOAD"</span>) == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">return</span> orig_getenv(name);<font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ gcc -shared -fpic -ldl ./ld_undetect_getenv.c -o ./ld_undetect_getenv.so<font></font>
$ LD_PRELOAD=./ld_undetect_getenv.so ./detect_base_getenv<font></font>
LD_PRELOAD (getenv) [-]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŒæ§˜ã«ã€ç§ãŸã¡ã¯</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ªãƒ¼ãƒ—ãƒ³</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒã‚§ãƒƒã‚¯ã‚’å–ã‚Šé™¤ã</font><i><font style="vertical-align: inherit;">ã¾ã™</font></i><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">int</span> (*orig_open)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*, <span class="hljs-keyword">int</span> oflag) = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">int</span> oflag, ...)</span>
</span>{
    <span class="hljs-keyword">char</span> real_path[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">if</span>(!orig_open) orig_open = dlsym(RTLD_NEXT, <span class="hljs-string">"open"</span>);<font></font>
    realpath(path, real_path);<font></font>
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(real_path, <span class="hljs-string">"/etc/ld.so.preload"</span>) == <span class="hljs-number">0</span>){<font></font>
        errno = ENOENT;<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> orig_open(path, oflag);<font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ gcc -shared -fpic -ldl ./ld_undetect_open.c -o ./ld_undetect_open.so<font></font>
$ LD_PRELOAD=./ld_undetect_open.so ./detect_base_open<font></font>
LD_PRELOAD (open) [-]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¯ã„ã€ã“ã“ã§ã¯</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open64</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stat</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãªã©ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ä»–ã®æ–¹æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™</font><font style="vertical-align: inherit;">ãŒã€å®Ÿéš›ã«ã¯ã€ãã‚Œã‚‰ã‚’æ¬ºããŸã‚ã«åŒã˜5ã€œ10è¡Œã®ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2ã€‚</font><font style="vertical-align: inherit;">å…ˆã¸</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸Šè¨˜ã§ã¯</font><font style="vertical-align: inherit;">ã€</font><i><font style="vertical-align: inherit;">LD_PRELOAD</font></i><font style="vertical-align: inherit;">å€¤ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getenvï¼ˆï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨</font><font style="vertical-align: inherit;">ã—ã¾ã—ãŸãŒã€</font><i><font style="vertical-align: inherit;">ENV</font></i><font style="vertical-align: inherit;">å¤‰æ•°</font><font style="vertical-align: inherit;">ã«åˆ°é”ã™ã‚‹ãŸã‚ã®ã‚ˆã‚Šã€Œä½ãƒ¬ãƒ™ãƒ«ã€ã®æ–¹æ³•ã‚‚ã‚ã‚Š</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä¸­é–“é–¢æ•°ã¯ä½¿ç”¨ã—ã¾ã›ã‚“</font><font style="vertical-align: inherit;">ãŒã€ç’°å¢ƒã®ã‚³ãƒ”ãƒ¼ãŒä¿å­˜ã•ã‚Œ</font><font style="vertical-align: inherit;">ã¦ã„ã‚‹</font><i><font style="vertical-align: inherit;">**ç’°å¢ƒ</font></i><font style="vertical-align: inherit;">é…åˆ—ã‚’å‚ç…§ã—</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> **environ;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">char</span> env[] = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">if</span> (environ != <span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i] != <span class="hljs-literal">NULL</span>; i++)<font></font>
    {<font></font>
      <span class="hljs-keyword">char</span> * pch;<font></font>
      pch = <span class="hljs-built_in">strstr</span>(environ[i],env);
      <span class="hljs-keyword">if</span>(pch != <span class="hljs-literal">NULL</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (**environ) [+]\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
      }<font></font>
    }<font></font>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (**environ) [-]\n"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã“ã§ã¯ãƒ¡ãƒ¢ãƒªã‹ã‚‰ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ãŸã‚ã€ãã®ã‚ˆã†ãªå‘¼ã³å‡ºã—ã‚’å‚å—ã™ã‚‹ã“ã¨ã¯ã§ããšã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">undetect_getenv</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ä¾µå…¥ã®åˆ¤åˆ¥ã‚’å¦¨å®³ã—ãªããªã‚Šã¾ã—ãŸã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">$ LD_PRELOAD=./ld_undetect_getenv.so ./detect_environ<font></font>
LD_PRELOAD (**environ) [+]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å•é¡Œã¯è§£æ±ºã•ã‚ŒãŸã‚ˆã†ã«è¦‹ãˆã¾ã™ã‹ï¼Ÿ</font><font style="vertical-align: inherit;">ã¾ã å§‹ã¾ã£ãŸã°ã‹ã‚Šã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®èµ·å‹•å¾Œã€</font><font style="vertical-align: inherit;">ã‚¯ãƒ©ãƒƒã‚«ãƒ¼ã¯ãƒ¡ãƒ¢ãƒªå†…</font><font style="vertical-align: inherit;">ã®</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤‰æ•°ã®å€¤ã‚’</font><font style="vertical-align: inherit;">å¿…è¦ã¨ã—ãªããªã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€å‘½ä»¤ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€</font><font style="vertical-align: inherit;">å¤‰æ•°</font><font style="vertical-align: inherit;">ã‚’èª­ã¿å–ã£ã¦å‰Šé™¤ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚‚ã¡ã‚ã‚“ã€ãƒ¡ãƒ¢ãƒªå†…ã®é…åˆ—ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã¯å°‘ãªãã¨ã‚‚æ‚ªã„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã§ã™ãŒã€ã“ã‚Œã¯æœ¬å½“ã«ç§ãŸã¡ã‚’æœ¬å½“ã«æœ›ã‚“ã§ã„ãªã„äººã‚’æœ¬å½“ã«æ­¢ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€å½ã®é–¢æ•°</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initï¼ˆï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®é–¢æ•°</font><font style="vertical-align: inherit;">ã§ã¯ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ</font><font style="vertical-align: inherit;">ã—ã¦ã€ãƒªãƒ³ã‚«ãƒ¼ã«æ¸¡ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> **environ;
<span class="hljs-keyword">char</span> *evil_env;
<span class="hljs-keyword">int</span> (*orig_execve)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> argv[], <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> envp[]) = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//    init</span>
<span class="hljs-comment">//      </span>
<span class="hljs-comment">//   - </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evil_init</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">//     LD_PRELOAD</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ldpreload = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">int</span> len = <span class="hljs-built_in">strlen</span>(getenv(ldpreload));<font></font>
  evil_env = (<span class="hljs-keyword">char</span>*) <span class="hljs-built_in">malloc</span>(len+<span class="hljs-number">1</span>);
  <span class="hljs-built_in">strcpy</span>(evil_env, getenv(ldpreload));<font></font>
<font></font>
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">char</span> env[] = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">if</span> (environ != <span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i] != <span class="hljs-literal">NULL</span>; i++) {
      <span class="hljs-keyword">char</span> * pch;<font></font>
      pch = <span class="hljs-built_in">strstr</span>(environ[i],env);
      <span class="hljs-keyword">if</span>(pch != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">//    LD_PRELOAD</span><font></font>
        unsetenv(env);<font></font>
        <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">execve</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> argv[], <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> envp[])</span>
</span>{
  <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>, k = <span class="hljs-number">-1</span>, ret = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">char</span>** new_env;
  <span class="hljs-keyword">if</span>(!orig_execve) orig_execve = dlsym(RTLD_NEXT,<span class="hljs-string">"execve"</span>);<font></font>
<font></font>
  <span class="hljs-comment">//       LD_PRELOAD</span>
  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; envp[i]; i++){
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(envp[i], <span class="hljs-string">"LD_PRELOAD"</span>)) k = i;<font></font>
  }<font></font>
  <span class="hljs-comment">//  LD_PRELOAD     ,   </span>
  <span class="hljs-keyword">if</span>(k == <span class="hljs-number">-1</span>){<font></font>
    k = i;<font></font>
    i++;<font></font>
  }<font></font>
  <span class="hljs-comment">//   </span>
  new_env = (<span class="hljs-keyword">char</span>**) <span class="hljs-built_in">malloc</span>((i+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*));<font></font>
<font></font>
  <span class="hljs-comment">//   ,   LD_PRELOAD</span>
  <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; i; j++) {
    <span class="hljs-comment">//    LD_PRELOAD</span>
    <span class="hljs-keyword">if</span>(j == k) {<font></font>
      new_env[j] = (<span class="hljs-keyword">char</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">256</span>);
      <span class="hljs-built_in">strcpy</span>(new_env[j], <span class="hljs-string">"LD_PRELOAD="</span>);
      <span class="hljs-built_in">strcat</span>(new_env[j], evil_env);<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> new_env[j] = (<span class="hljs-keyword">char</span>*) envp[j];<font></font>
  }<font></font>
  new_env[i] = <span class="hljs-literal">NULL</span>;<font></font>
  ret = orig_execve(path, argv, new_env);<font></font>
  <span class="hljs-built_in">free</span>(new_env[k]);
  <span class="hljs-built_in">free</span>(new_env);
  <span class="hljs-keyword">return</span> ret;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®Ÿè¡Œã€ç¢ºèªï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">$ gcc -shared -fpic -ldl -Wl,-init,evil_init  ./ld_undetect_environ.c -o ./ld_undetect_environ.so<font></font>
$ LD_PRELOAD=./ld_undetect_environ.so ./detect_environ<font></font>
LD_PRELOAD (**environ) [-]<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3ã€‚</font><font style="vertical-align: inherit;">/ proc / self /</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãŸã ã—ã€ãƒ¡ãƒ¢ãƒªã¯</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã‚’æ¤œå‡ºã§ãã‚‹æœ€å¾Œã®å ´æ‰€ã§ã¯ãªãã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc /</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚‚ã‚ã‚Š</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">æ˜ç™½ãª</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc / {PID} / environ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®Ÿéš›ã«ã¯ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¤œå‡ºã•</font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚Œ</font><i><font style="vertical-align: inherit;">ãªã„</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">** environ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc / self / environã®</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Š</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">å•é¡Œã¯ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unsetenvï¼ˆenvï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã®ã€Œé–“é•ã£ãŸã€å‹•ä½œã§ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evil_init</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">//     LD_PRELOAD</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ldpreload = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">int</span> len = <span class="hljs-built_in">strlen</span>(getenv(ldpreload));<font></font>
  evil_env = (<span class="hljs-keyword">char</span>*) <span class="hljs-built_in">malloc</span>(len+<span class="hljs-number">1</span>);
  <span class="hljs-built_in">strcpy</span>(evil_env, getenv(ldpreload));<font></font>
 <font></font>
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">char</span> env[] = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">if</span> (environ != <span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i] != <span class="hljs-literal">NULL</span>; i++) {
      <span class="hljs-keyword">char</span> * pch;<font></font>
      pch = <span class="hljs-built_in">strstr</span>(environ[i],env);
      <span class="hljs-keyword">if</span>(pch != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">//    LD_PRELOAD </span>
        <span class="hljs-comment">//unsetenv(env);</span>
        <span class="hljs-comment">//  unset    </span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; environ[i][j] != <span class="hljs-string">'\0'</span>; j++) environ[i][j] = <span class="hljs-string">'\0'</span>;
        <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="plaintext hljs">$ gcc -shared -fpic -ldl -Wl,-init,evil_init  ./ld_undetect_environ_2.c -o ./ld_undetect_environ_2.so<font></font>
$ (LD_PRELOAD=./ld_undetect_environ_2.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD<font></font>
$<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ã‹ã—ã€ãã‚ŒãŒè¦‹ã¤ã‹ã‚‰ãšã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc / self / environ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã«ã€Œå•é¡Œã®ã‚ã‚‹ã€ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãšã€ä»¥å‰ã®ã€Œå¤‰è£…ã€ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">$ (LD_PRELOAD=./ld_undetect_environ.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD<font></font>
LD_PRELOAD=./ld_undetect_environ.so<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cat</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯åŒã˜</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openï¼ˆï¼‰</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</font><font style="vertical-align: inherit;">ãŸã‚ã€è§£æ±ºç­–ã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³2.1ã§ã™ã§ã«è¡Œã‚ã‚ŒãŸã‚‚ã®ã¨åŒæ§˜ã§ã™ãŒã€ã“ã“ã§ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’å«ã‚€è¡Œãªã—ã§çœŸã®ãƒ¡ãƒ¢ãƒªå€¤ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;limits.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFFER_SIZE 256</span><font></font>
<font></font>
<span class="hljs-keyword">int</span> (*orig_open)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*, <span class="hljs-keyword">int</span> oflag) = <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">char</span> *soname = <span class="hljs-string">"fakememory_preload.so"</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">char</span> *<span class="hljs-title">sstrstr</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *sub)</span>
</span>{
  <span class="hljs-keyword">int</span> i, found;
  <span class="hljs-keyword">char</span> *ptr;<font></font>
  found = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(ptr = str; *ptr != <span class="hljs-string">'\0'</span>; ptr++) {<font></font>
    found = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; found == <span class="hljs-number">1</span> &amp;&amp; sub[i] != <span class="hljs-string">'\0'</span>; i++){
      <span class="hljs-keyword">if</span>(sub[i] != ptr[i]) found = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(found == <span class="hljs-number">1</span>)
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(found == <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">return</span> ptr + i;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">fakeMaps</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *original_path, <span class="hljs-keyword">char</span> *fake_path, <span class="hljs-keyword">char</span> *pattern)</span>
</span>{
  <span class="hljs-keyword">int</span> fd;
  <span class="hljs-keyword">char</span> buffer[BUFFER_SIZE];
  <span class="hljs-keyword">int</span> bytes = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">int</span> wbytes = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-keyword">pid_t</span> pid = getpid();<font></font>
<font></font>
  <span class="hljs-keyword">int</span> fh;
  <span class="hljs-keyword">if</span> ((fh=orig_open(fake_path,O_CREAT|O_WRONLY))==<span class="hljs-number">-1</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD: Cannot open write-file [%s] (%d) (%s)\n"</span>, fake_path, errno, strerror(errno));
    <span class="hljs-built_in">exit</span> (<span class="hljs-number">42</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>((fd=orig_open(original_path, O_RDONLY))==<span class="hljs-number">-1</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD: Cannot open read-file.\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">42</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">do</span><font></font>
  {<font></font>
    <span class="hljs-keyword">char</span> t = <span class="hljs-number">0</span>;<font></font>
    bytes = read(fd, &amp;t, <span class="hljs-number">1</span>);<font></font>
    buffer[k++] = t;<font></font>
    <span class="hljs-comment">//printf("%c", t);</span>
    <span class="hljs-keyword">if</span>(t == <span class="hljs-string">'\0'</span>) {
      <span class="hljs-comment">//printf("\n");</span><font></font>
  <font></font>
      <span class="hljs-keyword">if</span>(!sstrstr(buffer, <span class="hljs-string">"LD_PRELOAD"</span>)) {
        <span class="hljs-keyword">if</span>((wbytes = write(fh,buffer,k))==<span class="hljs-number">-1</span>) {
          <span class="hljs-comment">//printf("write error\n");</span><font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">//printf("writed %d\n", wbytes);</span><font></font>
        }<font></font>
      }<font></font>
      k = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">while</span>(bytes != <span class="hljs-number">0</span>);<font></font>
    <font></font>
  close(fd);<font></font>
  close(fh);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">int</span> oflag, ...)</span>
</span>{
  <span class="hljs-keyword">char</span> real_path[PATH_MAX], proc_path[PATH_MAX], proc_path_0[PATH_MAX];
  <span class="hljs-keyword">pid_t</span> pid = getpid();
  <span class="hljs-keyword">if</span>(!orig_open)<font></font>
  orig_open = dlsym(RTLD_NEXT, <span class="hljs-string">"open"</span>);<font></font>
  realpath(path, real_path);<font></font>
  <span class="hljs-built_in">snprintf</span>(proc_path, PATH_MAX, <span class="hljs-string">"/proc/%d/environ"</span>, pid);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(real_path, proc_path) == <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">snprintf</span>(proc_path, PATH_MAX, <span class="hljs-string">"/tmp/%d.fakemaps"</span>, pid);<font></font>
    realpath(proc_path_0, proc_path);<font></font>
    <font></font>
    fakeMaps(real_path, proc_path, soname);<font></font>
    <span class="hljs-keyword">return</span> orig_open(proc_path, oflag);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> orig_open(path, oflag);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦ã“ã®æ®µéšã¯å®Œäº†ã—ã¾ã—ãŸï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">$ (LD_PRELOAD=./ld_undetect_proc_environ.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD<font></font>
$<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã«æ˜ã‚‰ã‹ãªå ´æ‰€ã¯</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc / self / maps</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã™ã€‚</font><font style="vertical-align: inherit;">ãã‚Œã‚’é•·å¼•ã‹ã›ã¦ã‚‚æ„å‘³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">è§£æ±ºç­–ã¯å‰ã®è§£æ±ºç­–ã¨ã¾ã£ãŸãåŒã˜ã§ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libc.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld.soã®</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é–“ã®è¡Œã‚’å·®ã—å¼•ã„ãŸã‚‚ã®</font><font style="vertical-align: inherit;">ã§ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4ã€‚</font><font style="vertical-align: inherit;">ãƒãƒ§ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯å˜ç´”ã§ã‚ã‚‹ãŸã‚ã€ç‰¹ã«æ°—ã«å…¥ã‚Šã¾ã—ãŸã€‚</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‹ã‚‰ç›´æ¥ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸé–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹</font><font style="vertical-align: inherit;">ã¨ã€ŒNEXTã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’</font><font style="vertical-align: inherit;">æ¯”è¼ƒã—ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LIBC <span class="hljs-meta-string">"/lib/x86_64-linux-gnu/libc.so.6"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{
  <span class="hljs-keyword">void</span> *libc = dlopen(LIBC, RTLD_LAZY); <span class="hljs-comment">// Open up libc directly</span>
  <span class="hljs-keyword">char</span> *syscall_open = <span class="hljs-string">"open"</span>;
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">void</span> *(*libc_func)();
  <span class="hljs-keyword">void</span> *(*next_func)();<font></font>
  <font></font>
  libc_func = dlsym(libc, syscall_open);<font></font>
  next_func = dlsym(RTLD_NEXT, syscall_open);<font></font>
  <span class="hljs-keyword">if</span> (libc_func != next_func) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (syscall - %s) [+]\n"</span>, syscall_open);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Libc address: %p\n"</span>, libc_func);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Next address: %p\n"</span>, next_func);<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (syscall - %s) [-]\n"</span>, syscall_open);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€Œopenï¼ˆï¼‰ã€</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦</font><font style="vertical-align: inherit;">ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_undetect_open.so<font></font>
$ ./detect_chokepoint<font></font>
LD_PRELOAD (syscall - open) [+]<font></font>
Libc address: 0x7fa86893b160<font></font>
Next address: 0x7fa868a26135<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åé§ã¯ã•ã‚‰ã«ç°¡å˜ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ã¾ã—ãŸï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">#define _GNU_SOURCE<font></font>
#include &lt;stdio.h&gt;<font></font>
#include &lt;stdlib.h&gt;<font></font>
#include &lt;string.h&gt;<font></font>
#include &lt;dlfcn.h&gt;<font></font>
<font></font>
extern void * _dl_sym (void *, const char *, void *);<font></font>
void * dlsym (void * handle, const char * symbol)<font></font>
{<font></font>
  return _dl_sym (handle, symbol, dlsym);<font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs"># LD_PRELOAD=./ld_undetect_chokepoint.so ./detect_chokepoint<font></font>
LD_PRELOAD (syscall - open) [-]<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.5ã€‚</font><font style="vertical-align: inherit;">ã‚·ã‚¹ã‚³ãƒ¼ãƒ«</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã‚Œã ã‘ã§ã™ãŒã€ãã‚Œã§ã‚‚ã‚«ãƒ¬ã‚¤ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’ç›´æ¥ã‚«ãƒ¼ãƒãƒ«ã«é€ã‚‹ã¨ã€ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ãŒå›é¿ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸‹ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚‚ã¡ã‚ã‚“ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾å­˜ã—ã¦ã„ã¾ã™</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆ</font><i><font style="vertical-align: inherit;">x86_64</font></i><font style="vertical-align: inherit;">ï¼‰ã€‚</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld.so.preload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’å®Ÿè£…ã—ã¦</font><i><font style="vertical-align: inherit;">é–‹å§‹</font></i><font style="vertical-align: inherit;">ã‚’æ¤œå‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFFER_SIZE 256</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">syscall_open</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">long</span> oflag)</span>
</span>{
    <span class="hljs-keyword">int</span> fd = <span class="hljs-number">-1</span>;<font></font>
    __asm__ (<font></font>
             <span class="hljs-string">"mov $2, %%rax;"</span> <span class="hljs-comment">// Open syscall number</span>
             <span class="hljs-string">"mov %1, %%rdi;"</span> <span class="hljs-comment">// Address of our string</span>
             <span class="hljs-string">"mov %2, %%rsi;"</span> <span class="hljs-comment">// Open mode</span>
             <span class="hljs-string">"mov $0, %%rdx;"</span> <span class="hljs-comment">// No create mode</span>
             <span class="hljs-string">"syscall;"</span>       <span class="hljs-comment">// Straight to ring0</span>
             <span class="hljs-string">"mov %%eax, %0;"</span> <span class="hljs-comment">// Returned file descriptor</span>
             :<span class="hljs-string">"=r"</span> (fd)<font></font>
             :<span class="hljs-string">"m"</span> (path), <span class="hljs-string">"m"</span> (oflag)<font></font>
             :<span class="hljs-string">"rax"</span>, <span class="hljs-string">"rdi"</span>, <span class="hljs-string">"rsi"</span>, <span class="hljs-string">"rdx"</span><font></font>
             );<font></font>
    <span class="hljs-keyword">return</span> fd;<font></font>
 }<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    syscall_open(<span class="hljs-string">"/etc/ld.so.preload"</span>, O_RDONLY) &gt; <span class="hljs-number">0</span> ?
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (open syscall) [+]\n"</span>):
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (open syscall) [-]\n"</span>);<font></font>
        <font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ ./detect_syscall<font></font>
LD_PRELOAD (open syscall) [+]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦ã€ã“ã®å•é¡Œã«ã¯è§£æ±ºç­–ãŒã‚ã‚Šã¾ã™ã€‚</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”·æ€§</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‹ã‚‰ã®æŠœç²‹</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<blockquote>ptrace â€”  ,         ,       .               .<br>
<br>
    ,    fork(2),        PTRACE_TRACEME,   ()   exec(3).   ,          PTRACE_ATTACH.<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒˆãƒ¬ãƒ¼ã‚¹ã™ã‚‹ã¨ã€ã‚·ã‚°ãƒŠãƒ«ãŒç„¡è¦–ã•ã‚Œã‚‹å ´åˆã§ã‚‚ã€ã‚·ã‚°ãƒŠãƒ«ãŒå—ä¿¡ã•ã‚Œã‚‹ãŸã³ã«å­ãƒ—ãƒ­ã‚»ã‚¹ãŒåœæ­¢ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ï¼ˆä¾‹å¤–ã¯SIGKILLã§ã‚ã‚Šã€é€šå¸¸ã®æ–¹æ³•ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚ï¼‰waitï¼ˆ2ï¼‰ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã€è¦ªãƒ—ãƒ­ã‚»ã‚¹ã«é€šçŸ¥ã•ã‚Œã€ãã®å¾Œã€é–‹å§‹ã™ã‚‹å‰ã«å­ãƒ—ãƒ­ã‚»ã‚¹ã®å†…å®¹ã‚’è¡¨ç¤ºãŠã‚ˆã³å¤‰æ›´ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãã®å¾Œã€è¦ªãƒ—ãƒ­ã‚»ã‚¹ã¯å­ãŒä½œæ¥­ã‚’ç¶šè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚å ´åˆã«ã‚ˆã£ã¦ã¯ã€å­ã«é€ä¿¡ã•ã‚ŒãŸä¿¡å·ã‚’ç„¡è¦–ã™ã‚‹ã‹ã€ä»£ã‚ã‚Šã«åˆ¥ã®ä¿¡å·ã‚’é€ä¿¡ã—ã¾ã™ï¼‰ã€‚</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ãŸãŒã£ã¦ã€è§£æ±ºç­–ã¯ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¿½è·¡ã—ã€å„ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®å‰ã«ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ã—ã€å¿…è¦ã«å¿œã˜ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒˆãƒ©ãƒƒãƒ—é–¢æ•°ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;limits.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ptrace.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/reg.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/user.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;asm/unistd.h&gt;</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__x86_64__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REG_SYSCALL ORIG_RAX</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REG_SP rsp</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REG_IP rip </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-keyword">long</span> NOHOOK = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">evil_open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">long</span> oflag, <span class="hljs-keyword">long</span> cflag)</span> 
</span>{
    <span class="hljs-keyword">char</span> real_path[PATH_MAX], maps_path[PATH_MAX];
    <span class="hljs-keyword">long</span> ret;
    <span class="hljs-keyword">pid_t</span> pid;<font></font>
    pid = getpid();<font></font>
    realpath(path, real_path);<font></font>
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(real_path, <span class="hljs-string">"/etc/ld.so.preload"</span>) == <span class="hljs-number">0</span>)<font></font>
    {<font></font>
        errno = ENOENT;<font></font>
        ret = <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
        NOHOOK = <span class="hljs-number">1</span>; <span class="hljs-comment">// Entering NOHOOK section</span><font></font>
        ret = open(path, oflag, cflag);<font></font>
    }<font></font>
    <span class="hljs-comment">// Exiting NOHOOK section</span>
    NOHOOK = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> ret;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">pid_t</span> program;
    <span class="hljs-comment">//   </span><font></font>
    program = fork();<font></font>
    <span class="hljs-keyword">if</span>(program != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">int</span> status;
        <span class="hljs-keyword">long</span> syscall_nr;
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> <span class="hljs-title">regs</span>;</span>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">if</span>(ptrace(PTRACE_ATTACH, program) != <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to attach to the program.\n"</span>);
            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
        }<font></font>
        waitpid(program, &amp;status, <span class="hljs-number">0</span>);
        <span class="hljs-comment">//   SYSCALLs</span>
        ptrace(PTRACE_SETOPTIONS, program, <span class="hljs-number">0</span>, PTRACE_O_TRACESYSGOOD);
        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {<font></font>
            ptrace(PTRACE_SYSCALL, program, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
            waitpid(program, &amp;status, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span>(WIFEXITED(status) || WIFSIGNALED(status)) <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(WIFSTOPPED(status) &amp;&amp; WSTOPSIG(status) == SIGTRAP|<span class="hljs-number">0x80</span>) {
                <span class="hljs-comment">//    </span>
                syscall_nr = ptrace(PTRACE_PEEKUSER, program, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>)*REG_SYSCALL);
                <span class="hljs-keyword">if</span>(syscall_nr == __NR_open) {
                    <span class="hljs-comment">//      </span>
                    NOHOOK = ptrace(PTRACE_PEEKDATA, program, (<span class="hljs-keyword">void</span>*)&amp;NOHOOK);
                    <span class="hljs-comment">//  </span>
                    <span class="hljs-keyword">if</span>(!NOHOOK) {<font></font>
                        <font></font>
                        <span class="hljs-comment">//    </span>
                        <span class="hljs-comment">//   regs </span>
                        ptrace(PTRACE_GETREGS, program, <span class="hljs-number">0</span>, &amp;regs);
                        <span class="hljs-comment">// Push return address on the stack</span>
                        regs.REG_SP -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>);
                        <span class="hljs-comment">//      </span>
                        ptrace(PTRACE_POKEDATA, program, (<span class="hljs-keyword">void</span>*)regs.REG_SP, regs.REG_IP);
                        <span class="hljs-comment">//  RIP   evil_open</span>
                        regs.REG_IP = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) evil_open;
                        <span class="hljs-comment">//    </span>
                        ptrace(PTRACE_SETREGS, program, <span class="hljs-number">0</span>, &amp;regs);<font></font>
                    }<font></font>
                }<font></font>
                ptrace(PTRACE_SYSCALL, program, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
                waitpid(program, &amp;status, <span class="hljs-number">0</span>);<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> {<font></font>
        sleep(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç§ãŸã¡ã¯ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ./detect_syscall<font></font>
LD_PRELOAD (open syscall) [+]<font></font>
$ LD_PRELOAD=./ld_undetect_syscall.so ./detect_syscall<font></font>
LD_PRELOAD (open syscall) [-]<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ 0-0 = 5 </font></font></b><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Charles Hubain </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Chokepoint </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ValdikSS </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Philippe Teuwen </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">derhass</font></a><font style="vertical-align: inherit;"> 
ã«</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ„Ÿè¬ã—</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br><font style="vertical-align: inherit;"></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja479844/index.html">UXãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã®ãƒãƒ¼ãƒ ã‚’é›†ã‚ã€æ¡ç”¨ãƒŸã‚¹ã«ã‚ˆã‚Š700ä¸‡äººã‚’å¤±ã†</a></li>
<li><a href="../ja479848/index.html">2019å¹´ç¬¬4è±¡é™ã«ç™»å ´ï¼GartnerãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ‡ã‚ªä¼šè­°åˆ†æãƒ¬ãƒãƒ¼ãƒˆãŒ5å¹´é–“ã§ã©ã®ã‚ˆã†ã«å¤‰åŒ–ã™ã‚‹ã‹</a></li>
<li><a href="../ja479850/index.html">Windows Server Core 2019ã«Exchange 2019ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹</a></li>
<li><a href="../ja479852/index.html">å†…éƒ¨ã§ã®ãƒ“ãƒ‡ã‚ªé€šè©±ï¼š1æ—¥ã‚ãŸã‚Šæ•°ç™¾ä¸‡ã‹ã‚‰1ã¤ã®ä¼šè­°ã®100äººã®å‚åŠ è€…ã¾ã§</a></li>
<li><a href="../ja479854/index.html">12æœˆ12æ—¥ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¸ãƒ£ãƒãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆ</a></li>
<li><a href="../ja479860/index.html">ç”Ÿå‘½ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®ãƒˆãƒ”ãƒƒã‚¯ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ãƒ‘ãƒ¼ãƒˆ2</a></li>
<li><a href="../ja479862/index.html">ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’ç™»éŒ²ã™ã‚‹ã¨ãã«15000ãƒ«ãƒ¼ãƒ–ãƒ«ã‚’ç¯€ç´„ã™ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja479864/index.html">WinForms + Cï¼ƒã§ã®ã‚²ãƒ¼ãƒ 16ï¼ˆãƒ‘ãƒ¼ãƒˆ2ï¼‰</a></li>
<li><a href="../ja479870/index.html">ç§ãŸã¡ã¯ã€å¤–å‡ºå…ˆã§ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ä»•äº‹ç”¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¾ã™ã€‚PHP NNã®2ç•ªç›®ã®ãƒŸã‚¿ãƒƒãƒ—ã§ä½•ãŒèµ·ã“ã‚‹ã‹</a></li>
<li><a href="../ja479874/index.html">ã©ã®ã‚ˆã†ã«ã—ã¦ThoughtWorksã¾ãŸã¯æ¨¡ç¯„çš„ãªã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã«å…¥ã‚Šã¾ã—ãŸã‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>