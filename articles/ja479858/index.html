<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>▶️ 🥗 🤹🏽 LD_PRELOADを探しています 👩‍⚕️ 🛀🏽 🧙🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="このメモは2014年に書かれましたが、私はハブで弾圧を受けただけで、彼女は光を見ませんでした。禁止期間中、私はそれを忘れていましたが、今は草稿にそれを見つけました。削除することだと思っていましたが、誰かが重宝するかもしれません。
 
 
 
 一般的に、金曜日の小さな管理者は、「含まれている」LD_...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>LD_PRELOADを探しています</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479858/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このメモは2014年に書かれましたが、私はハブで弾圧を受けただけで、彼女は光を見ませんでした。</font><font style="vertical-align: inherit;">禁止期間中、私はそれを忘れていましたが、今は草稿にそれを見つけました。</font><font style="vertical-align: inherit;">削除することだと思っていましたが、誰かが重宝するかもしれません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o1/8i/wf/o18iwf72_dlx0j9-qjr8zni5unq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に、金曜日の小さな管理者は、「含まれている」</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を検索するトピックについて読んでいます</font><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.関数置換に慣れていない人のための小さな余談</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残りは直接</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ2に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">進むことができ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
古典的な例から始めましょう：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  srand (time(<span class="hljs-literal">NULL</span>));
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">5</span>; i++){
    <span class="hljs-built_in">printf</span> (<span class="hljs-string">"%d\n"</span>, rand()%<span class="hljs-number">100</span>);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フラグなしでコンパイルします。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ gcc ./ld_rand.c -o ld_rand
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、予想通り、100未満の5つの乱数が得られます。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ./ld_rand<font></font>
53<font></font>
93<font></font>
48<font></font>
57<font></font>
20<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、プログラムのソースコードがなく、動作を変更する必要があるとします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、独自の関数プロトタイプを使用して独自のライブラリを作成してみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rand</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;<font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ gcc -shared -fPIC ./o_rand.c -o ld_rand.so
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして今、私たちのランダムな選択はかなり予測可能です：</font></font><br>
<br>
<pre><code class="plaintext hljs"># LD_PRELOAD=$PWD/ld_rand.so ./ld_rand<font></font>
42<font></font>
42<font></font>
42<font></font>
42<font></font>
42<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初にライブラリをエクスポートすると、このトリックはさらに印象的に見えます </font></font><br>
<br>
<pre><code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_rand.so
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または事前実行</font></font><br>
<br>
<pre><code class="plaintext hljs"># echo "$PWD/ld_rand.so" &gt; /etc/ld.so.preload
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、プログラムを通常モードで実行します。プログラム自体のコードの1行は変更していませんが、その動作はライブラリの小さな関数に依存しています。さらに、執筆の時点では、偽の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランド</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さえ存在していませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのプログラムが偽の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランドを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用したのは</font><font style="vertical-align: inherit;">なぜですか？手順を見ていきましょう。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションが起動すると、プログラムに必要な関数を含む特定のライブラリがロードされます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ldd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してそれらを見ることができます</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs"># ldd ./ld_rand<font></font>
        linux-vdso.so.1 (0x00007ffc8b1f3000)<font></font>
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fe3da8af000)<font></font>
        /lib64/ld-linux-x86-64.so.2 (0x00007fe3daa7e000)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリストはOSのバージョンによって異なる場合がありますが、そこには</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libc.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル</font><i><font style="vertical-align: inherit;">が</font></i><font style="vertical-align: inherit;">必要です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">システムコールと、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの基本機能を提供するのはこのライブラリです</font><font style="vertical-align: inherit;">。私たちの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ランド</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もその1つです。</font><font style="vertical-align: inherit;">これを確認してください：</font></font><br>
<br>
<pre><code class="plaintext hljs"># nm -D /lib/x86_64-linux-gnu/libc.so.6 | grep " rand$"<font></font>
000000000003aef0 T rand<font></font>
</code></pre><br><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">LD_PRELOAD</font></i><font style="vertical-align: inherit;"> 
を使用するときにライブラリのセットが変更されるかどうかを見てみましょう</font></font><i><font style="vertical-align: inherit;"></font></i><br>
<br>
<pre><code class="plaintext hljs"># LD_PRELOAD=$PWD/ld_rand.so ldd ./ld_rand<font></font>
        linux-vdso.so.1 (0x00007ffea52ae000)<font></font>
        /scripts/c/ldpreload/ld_rand.so (0x00007f690d3f9000)<font></font>
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f690d230000)<font></font>
        /lib64/ld-linux-x86-64.so.2 (0x00007f690d405000)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラム自体は必要としませんが、</font><font style="vertical-align: inherit;">
変数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOADを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定すると、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld_rand.soが強制的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に読み込ま</font><font style="vertical-align: inherit;">れることが</font><i><font style="vertical-align: inherit;">わかり</font></i><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。そして、私たちの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数は</font><i><font style="vertical-align: inherit;">libc.so</font></i><font style="vertical-align: inherit;">から</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">よりも早くロードさ</font><font style="vertical-align: inherit;">れる</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ボールを支配します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OK、ネイティブ関数の置き換えに成功しましたが、その機能が維持され、いくつかのアクションが追加されていることを確認する方法。ランダムを変更します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
 <font></font>
<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(*orig_rand_f_type)</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;<font></font>
 <font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rand</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">/*    */</span>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Evil injected code\n"</span>);<font></font>
  <font></font>
  orig_rand_f_type orig_rand;<font></font>
  orig_rand = (orig_rand_f_type)dlsym(RTLD_NEXT,<span class="hljs-string">"rand"</span>);
  <span class="hljs-keyword">return</span> orig_rand();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、「アドオン」として、テキストを1行だけ印刷し、元の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数へのポインターを作成します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この関数のアドレスを取得するに</font><font style="vertical-align: inherit;">は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dlsym</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が必要</font><i><font style="vertical-align: inherit;">です。</font></i><font style="vertical-align: inherit;">これは</font><font style="vertical-align: inherit;">、動的ライブラリスタックで</font><i><font style="vertical-align: inherit;">ランド</font></i><font style="vertical-align: inherit;">を見つける</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリの関数</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">その後、この関数を呼び出してその値を返します。</font><font style="vertical-align: inherit;">したがって、</font><i><font style="vertical-align: inherit;">ビルド</font></i><font style="vertical-align: inherit;">時に</font><i><font style="vertical-align: inherit;">「-ldl」</font></i><font style="vertical-align: inherit;">を追加する必要があります</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="plaintext hljs">$ gcc -ldl -shared -fPIC ./o_rand_evil.c -o ld_rand_evil.so
</code></pre><br>
<pre><code class="plaintext hljs">$ LD_PRELOAD=$PWD/ld_rand_evil.so ./ld_rand<font></font>
Evil injected code<font></font>
66<font></font>
Evil injected code<font></font>
28<font></font>
Evil injected code<font></font>
93<font></font>
Evil injected code<font></font>
93<font></font>
Evil injected code<font></font>
95<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私たちのプログラムは、</font><font style="vertical-align: inherit;">いくつかのわいせつなアクションを実行した後</font><font style="vertical-align: inherit;">、「ネイティブ」</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">randを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.小​​麦粉検索</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
潜在的な脅威を知って、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プリロードが</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行さ</font><font style="vertical-align: inherit;">れたことを発見したいと思い</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">検出するための最良の方法はそれをカーネルに押し込むことであることは明らかですが、私はユーザー空間での定義に正確に興味を持っていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、検出と反駁のソリューションはペアになります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1。</font><font style="vertical-align: inherit;">簡単なことから始めましょう</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前述のように、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数を使用して、</font><font style="vertical-align: inherit;">または</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/ld.so.preload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルに書き込むことで、</font><font style="vertical-align: inherit;">ロードするライブラリを指定</font><i><font style="vertical-align: inherit;">でき</font></i><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最も単純な2つの検出器を作成しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つ目は、設定された環境変数を確認することです。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">char</span>*  pGetenv = getenv(<span class="hljs-string">"LD_PRELOAD"</span>);<font></font>
  pGetenv != <span class="hljs-literal">NULL</span> ?
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (getenv) [+]\n"</span>):
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (getenv) [-]\n"</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つ目は、ファイルのオープンを確認することです。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  open(<span class="hljs-string">"/etc/ld.so.preload"</span>, O_RDONLY) != <span class="hljs-number">-1</span> ?
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (open) [+]\n"</span>):
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (open) [-]\n"</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライブラリをロード：</font></font><br>
<br>
<pre><code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_rand.so<font></font>
$ echo "$PWD/ld_rand.so" &gt; /etc/ld.so.preload<font></font>
<font></font>
$ ./detect_base_getenv<font></font>
LD_PRELOAD (getenv) [+]<font></font>
$ ./detect_base_open<font></font>
LD_PRELOAD (open) [+]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以降、[+]は検出が成功したことを示します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、[-]はバイパス検出を意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような検出器はどれほど効果的ですか？</font><font style="vertical-align: inherit;">まず、環境変数を見てみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">char</span>* (*orig_getenv)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *) = <span class="hljs-literal">NULL</span>;
<span class="hljs-function"><span class="hljs-keyword">char</span>* <span class="hljs-title">getenv</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name)</span>
</span>{
    <span class="hljs-keyword">if</span>(!orig_getenv) orig_getenv = dlsym(RTLD_NEXT, <span class="hljs-string">"getenv"</span>);
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">"LD_PRELOAD"</span>) == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">return</span> orig_getenv(name);<font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ gcc -shared -fpic -ldl ./ld_undetect_getenv.c -o ./ld_undetect_getenv.so<font></font>
$ LD_PRELOAD=./ld_undetect_getenv.so ./detect_base_getenv<font></font>
LD_PRELOAD (getenv) [-]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、私たちは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オープン</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックを取り除き</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">int</span> (*orig_open)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*, <span class="hljs-keyword">int</span> oflag) = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">int</span> oflag, ...)</span>
</span>{
    <span class="hljs-keyword">char</span> real_path[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">if</span>(!orig_open) orig_open = dlsym(RTLD_NEXT, <span class="hljs-string">"open"</span>);<font></font>
    realpath(path, real_path);<font></font>
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(real_path, <span class="hljs-string">"/etc/ld.so.preload"</span>) == <span class="hljs-number">0</span>){<font></font>
        errno = ENOENT;<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> orig_open(path, oflag);<font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ gcc -shared -fpic -ldl ./ld_undetect_open.c -o ./ld_undetect_open.so<font></font>
$ LD_PRELOAD=./ld_undetect_open.so ./detect_base_open<font></font>
LD_PRELOAD (open) [-]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、ここでは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open64</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stat</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">など、ファイルにアクセスする他の方法を使用できます</font><font style="vertical-align: inherit;">が、実際には、それらを欺くために同じ5〜10行のコードが必要です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2。</font><font style="vertical-align: inherit;">先へ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記では</font><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">LD_PRELOAD</font></i><font style="vertical-align: inherit;">値を取得するために</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">getenv（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">しましたが、</font><i><font style="vertical-align: inherit;">ENV</font></i><font style="vertical-align: inherit;">変数</font><font style="vertical-align: inherit;">に到達するためのより「低レベル」の方法もあり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">中間関数は使用しません</font><font style="vertical-align: inherit;">が、環境のコピーが保存され</font><font style="vertical-align: inherit;">ている</font><i><font style="vertical-align: inherit;">**環境</font></i><font style="vertical-align: inherit;">配列を参照し</font><font style="vertical-align: inherit;">ます。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> **environ;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">char</span> env[] = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">if</span> (environ != <span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i] != <span class="hljs-literal">NULL</span>; i++)<font></font>
    {<font></font>
      <span class="hljs-keyword">char</span> * pch;<font></font>
      pch = <span class="hljs-built_in">strstr</span>(environ[i],env);
      <span class="hljs-keyword">if</span>(pch != <span class="hljs-literal">NULL</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (**environ) [+]\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
      }<font></font>
    }<font></font>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (**environ) [-]\n"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここではメモリから直接データを読み取るため、そのような呼び出しを傍受することはできず、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">undetect_getenv</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は侵入の判別を妨害しなくなりました。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ LD_PRELOAD=./ld_undetect_getenv.so ./detect_environ<font></font>
LD_PRELOAD (**environ) [+]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は解決されたように見えますか？</font><font style="vertical-align: inherit;">まだ始まったばかりです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムの起動後、</font><font style="vertical-align: inherit;">クラッカーはメモリ内</font><font style="vertical-align: inherit;">の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変数の値を</font><font style="vertical-align: inherit;">必要としなくなります。つまり、命令を実行する前に、</font><font style="vertical-align: inherit;">変数</font><font style="vertical-align: inherit;">を読み取って削除できます。</font><font style="vertical-align: inherit;">もちろん、メモリ内の配列を編集することは少なくとも悪いプログラミングスタイルですが、これは本当に私たちを本当に望んでいない人を本当に止めることができるでしょうか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、偽の関数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">init（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成する必要があります。この関数</font><font style="vertical-align: inherit;">では、インストールされている</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をインターセプト</font><font style="vertical-align: inherit;">して、リンカーに渡します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span> **environ;
<span class="hljs-keyword">char</span> *evil_env;
<span class="hljs-keyword">int</span> (*orig_execve)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> argv[], <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> envp[]) = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-comment">//    init</span>
<span class="hljs-comment">//      </span>
<span class="hljs-comment">//   - </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evil_init</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">//     LD_PRELOAD</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ldpreload = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">int</span> len = <span class="hljs-built_in">strlen</span>(getenv(ldpreload));<font></font>
  evil_env = (<span class="hljs-keyword">char</span>*) <span class="hljs-built_in">malloc</span>(len+<span class="hljs-number">1</span>);
  <span class="hljs-built_in">strcpy</span>(evil_env, getenv(ldpreload));<font></font>
<font></font>
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">char</span> env[] = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">if</span> (environ != <span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i] != <span class="hljs-literal">NULL</span>; i++) {
      <span class="hljs-keyword">char</span> * pch;<font></font>
      pch = <span class="hljs-built_in">strstr</span>(environ[i],env);
      <span class="hljs-keyword">if</span>(pch != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">//    LD_PRELOAD</span><font></font>
        unsetenv(env);<font></font>
        <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">execve</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> argv[], <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> envp[])</span>
</span>{
  <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>, k = <span class="hljs-number">-1</span>, ret = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">char</span>** new_env;
  <span class="hljs-keyword">if</span>(!orig_execve) orig_execve = dlsym(RTLD_NEXT,<span class="hljs-string">"execve"</span>);<font></font>
<font></font>
  <span class="hljs-comment">//       LD_PRELOAD</span>
  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; envp[i]; i++){
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strstr</span>(envp[i], <span class="hljs-string">"LD_PRELOAD"</span>)) k = i;<font></font>
  }<font></font>
  <span class="hljs-comment">//  LD_PRELOAD     ,   </span>
  <span class="hljs-keyword">if</span>(k == <span class="hljs-number">-1</span>){<font></font>
    k = i;<font></font>
    i++;<font></font>
  }<font></font>
  <span class="hljs-comment">//   </span>
  new_env = (<span class="hljs-keyword">char</span>**) <span class="hljs-built_in">malloc</span>((i+<span class="hljs-number">1</span>)*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*));<font></font>
<font></font>
  <span class="hljs-comment">//   ,   LD_PRELOAD</span>
  <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; i; j++) {
    <span class="hljs-comment">//    LD_PRELOAD</span>
    <span class="hljs-keyword">if</span>(j == k) {<font></font>
      new_env[j] = (<span class="hljs-keyword">char</span>*) <span class="hljs-built_in">malloc</span>(<span class="hljs-number">256</span>);
      <span class="hljs-built_in">strcpy</span>(new_env[j], <span class="hljs-string">"LD_PRELOAD="</span>);
      <span class="hljs-built_in">strcat</span>(new_env[j], evil_env);<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> new_env[j] = (<span class="hljs-keyword">char</span>*) envp[j];<font></font>
  }<font></font>
  new_env[i] = <span class="hljs-literal">NULL</span>;<font></font>
  ret = orig_execve(path, argv, new_env);<font></font>
  <span class="hljs-built_in">free</span>(new_env[k]);
  <span class="hljs-built_in">free</span>(new_env);
  <span class="hljs-keyword">return</span> ret;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行、確認：</font></font><br>
<br>
<pre><code class="plaintext hljs">$ gcc -shared -fpic -ldl -Wl,-init,evil_init  ./ld_undetect_environ.c -o ./ld_undetect_environ.so<font></font>
$ LD_PRELOAD=./ld_undetect_environ.so ./detect_environ<font></font>
LD_PRELOAD (**environ) [-]<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3。</font><font style="vertical-align: inherit;">/ proc / self /</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、メモリは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スプーフィングを検出できる最後の場所ではなく、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc /</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もあり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">明白な</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc / {PID} / environ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から始めましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検出さ</font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ</font><i><font style="vertical-align: inherit;">ない</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">** environ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc / self / environの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユニバーサルソリューションがあり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">問題は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unsetenv（env）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の「間違った」動作です</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しいオプション</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">evil_init</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-comment">//     LD_PRELOAD</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ldpreload = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">int</span> len = <span class="hljs-built_in">strlen</span>(getenv(ldpreload));<font></font>
  evil_env = (<span class="hljs-keyword">char</span>*) <span class="hljs-built_in">malloc</span>(len+<span class="hljs-number">1</span>);
  <span class="hljs-built_in">strcpy</span>(evil_env, getenv(ldpreload));<font></font>
 <font></font>
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">char</span> env[] = <span class="hljs-string">"LD_PRELOAD"</span>;
  <span class="hljs-keyword">if</span> (environ != <span class="hljs-literal">NULL</span>)
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i] != <span class="hljs-literal">NULL</span>; i++) {
      <span class="hljs-keyword">char</span> * pch;<font></font>
      pch = <span class="hljs-built_in">strstr</span>(environ[i],env);
      <span class="hljs-keyword">if</span>(pch != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">//    LD_PRELOAD </span>
        <span class="hljs-comment">//unsetenv(env);</span>
        <span class="hljs-comment">//  unset    </span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; environ[i][j] != <span class="hljs-string">'\0'</span>; j++) environ[i][j] = <span class="hljs-string">'\0'</span>;
        <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="plaintext hljs">$ gcc -shared -fpic -ldl -Wl,-init,evil_init  ./ld_undetect_environ_2.c -o ./ld_undetect_environ_2.so<font></font>
$ (LD_PRELOAD=./ld_undetect_environ_2.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD<font></font>
$<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それが見つからず、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc / self / environ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に「問題のある」データが含まれているとします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、以前の「変装」を試してください。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ (LD_PRELOAD=./ld_undetect_environ.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD<font></font>
LD_PRELOAD=./ld_undetect_environ.so<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cat</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は同じ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してファイルを開く</font><font style="vertical-align: inherit;">ため、解決策はセクション2.1ですでに行われたものと同様ですが、ここで一時ファイルを作成し、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LD_PRELOAD</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を含む行なしで真のメモリ値をコピーします</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;limits.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFFER_SIZE 256</span><font></font>
<font></font>
<span class="hljs-keyword">int</span> (*orig_open)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>*, <span class="hljs-keyword">int</span> oflag) = <span class="hljs-literal">NULL</span>;
<span class="hljs-keyword">char</span> *soname = <span class="hljs-string">"fakememory_preload.so"</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">char</span> *<span class="hljs-title">sstrstr</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *sub)</span>
</span>{
  <span class="hljs-keyword">int</span> i, found;
  <span class="hljs-keyword">char</span> *ptr;<font></font>
  found = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(ptr = str; *ptr != <span class="hljs-string">'\0'</span>; ptr++) {<font></font>
    found = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; found == <span class="hljs-number">1</span> &amp;&amp; sub[i] != <span class="hljs-string">'\0'</span>; i++){
      <span class="hljs-keyword">if</span>(sub[i] != ptr[i]) found = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span>(found == <span class="hljs-number">1</span>)
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>(found == <span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">return</span> ptr + i;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">fakeMaps</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *original_path, <span class="hljs-keyword">char</span> *fake_path, <span class="hljs-keyword">char</span> *pattern)</span>
</span>{
  <span class="hljs-keyword">int</span> fd;
  <span class="hljs-keyword">char</span> buffer[BUFFER_SIZE];
  <span class="hljs-keyword">int</span> bytes = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">int</span> wbytes = <span class="hljs-number">-1</span>;
  <span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-keyword">pid_t</span> pid = getpid();<font></font>
<font></font>
  <span class="hljs-keyword">int</span> fh;
  <span class="hljs-keyword">if</span> ((fh=orig_open(fake_path,O_CREAT|O_WRONLY))==<span class="hljs-number">-1</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD: Cannot open write-file [%s] (%d) (%s)\n"</span>, fake_path, errno, strerror(errno));
    <span class="hljs-built_in">exit</span> (<span class="hljs-number">42</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span>((fd=orig_open(original_path, O_RDONLY))==<span class="hljs-number">-1</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD: Cannot open read-file.\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">42</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">do</span><font></font>
  {<font></font>
    <span class="hljs-keyword">char</span> t = <span class="hljs-number">0</span>;<font></font>
    bytes = read(fd, &amp;t, <span class="hljs-number">1</span>);<font></font>
    buffer[k++] = t;<font></font>
    <span class="hljs-comment">//printf("%c", t);</span>
    <span class="hljs-keyword">if</span>(t == <span class="hljs-string">'\0'</span>) {
      <span class="hljs-comment">//printf("\n");</span><font></font>
  <font></font>
      <span class="hljs-keyword">if</span>(!sstrstr(buffer, <span class="hljs-string">"LD_PRELOAD"</span>)) {
        <span class="hljs-keyword">if</span>((wbytes = write(fh,buffer,k))==<span class="hljs-number">-1</span>) {
          <span class="hljs-comment">//printf("write error\n");</span><font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">//printf("writed %d\n", wbytes);</span><font></font>
        }<font></font>
      }<font></font>
      k = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">while</span>(bytes != <span class="hljs-number">0</span>);<font></font>
    <font></font>
  close(fd);<font></font>
  close(fh);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">int</span> oflag, ...)</span>
</span>{
  <span class="hljs-keyword">char</span> real_path[PATH_MAX], proc_path[PATH_MAX], proc_path_0[PATH_MAX];
  <span class="hljs-keyword">pid_t</span> pid = getpid();
  <span class="hljs-keyword">if</span>(!orig_open)<font></font>
  orig_open = dlsym(RTLD_NEXT, <span class="hljs-string">"open"</span>);<font></font>
  realpath(path, real_path);<font></font>
  <span class="hljs-built_in">snprintf</span>(proc_path, PATH_MAX, <span class="hljs-string">"/proc/%d/environ"</span>, pid);<font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(real_path, proc_path) == <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">snprintf</span>(proc_path, PATH_MAX, <span class="hljs-string">"/tmp/%d.fakemaps"</span>, pid);<font></font>
    realpath(proc_path_0, proc_path);<font></font>
    <font></font>
    fakeMaps(real_path, proc_path, soname);<font></font>
    <span class="hljs-keyword">return</span> orig_open(proc_path, oflag);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> orig_open(path, oflag);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてこの段階は完了しました：</font></font><br>
<br>
<pre><code class="plaintext hljs">$ (LD_PRELOAD=./ld_undetect_proc_environ.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD<font></font>
$<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に明らかな場所は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ proc / self / maps</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">それを長引かせても意味がありません。</font><font style="vertical-align: inherit;">解決策は前の解決策とまったく同じです</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ファイルからデータをコピーして、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libc.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld.soの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">間の行を差し引いたもの</font><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4。</font><font style="vertical-align: inherit;">チョークポイントからのオプション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このソリューションは単純であるため、特に気に入りました。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から直接ロードされた関数のアドレス</font><font style="vertical-align: inherit;">と「NEXT」アドレスを</font><font style="vertical-align: inherit;">比較します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LIBC <span class="hljs-meta-string">"/lib/x86_64-linux-gnu/libc.so.6"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{
  <span class="hljs-keyword">void</span> *libc = dlopen(LIBC, RTLD_LAZY); <span class="hljs-comment">// Open up libc directly</span>
  <span class="hljs-keyword">char</span> *syscall_open = <span class="hljs-string">"open"</span>;
  <span class="hljs-keyword">int</span> i;
  <span class="hljs-keyword">void</span> *(*libc_func)();
  <span class="hljs-keyword">void</span> *(*next_func)();<font></font>
  <font></font>
  libc_func = dlsym(libc, syscall_open);<font></font>
  next_func = dlsym(RTLD_NEXT, syscall_open);<font></font>
  <span class="hljs-keyword">if</span> (libc_func != next_func) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (syscall - %s) [+]\n"</span>, syscall_open);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Libc address: %p\n"</span>, libc_func);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Next address: %p\n"</span>, next_func);<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (syscall - %s) [-]\n"</span>, syscall_open);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライブラリにインターセプト</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「open（）」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をロードして</font><font style="vertical-align: inherit;">チェックします。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_undetect_open.so<font></font>
$ ./detect_chokepoint<font></font>
LD_PRELOAD (syscall - open) [+]<font></font>
Libc address: 0x7fa86893b160<font></font>
Next address: 0x7fa868a26135<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
反駁はさらに簡単であることが判明しました：</font></font><br>
<br>
<pre><code class="plaintext hljs">#define _GNU_SOURCE<font></font>
#include &lt;stdio.h&gt;<font></font>
#include &lt;stdlib.h&gt;<font></font>
#include &lt;string.h&gt;<font></font>
#include &lt;dlfcn.h&gt;<font></font>
<font></font>
extern void * _dl_sym (void *, const char *, void *);<font></font>
void * dlsym (void * handle, const char * symbol)<font></font>
{<font></font>
  return _dl_sym (handle, symbol, dlsym);<font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs"># LD_PRELOAD=./ld_undetect_chokepoint.so ./detect_chokepoint<font></font>
LD_PRELOAD (syscall - open) [-]<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.5。</font><font style="vertical-align: inherit;">シスコール</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それだけですが、それでもカレイです。</font><font style="vertical-align: inherit;">システムコールを直接カーネルに送ると、インターセプトプロセス全体が回避されます。</font><font style="vertical-align: inherit;">以下のソリューションはもちろん、アーキテクチャに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">依存しています</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font><i><font style="vertical-align: inherit;">x86_64</font></i><font style="vertical-align: inherit;">）。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ld.so.preload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を実装して</font><i><font style="vertical-align: inherit;">開始</font></i><font style="vertical-align: inherit;">を検出してみましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUFFER_SIZE 256</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">syscall_open</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">long</span> oflag)</span>
</span>{
    <span class="hljs-keyword">int</span> fd = <span class="hljs-number">-1</span>;<font></font>
    __asm__ (<font></font>
             <span class="hljs-string">"mov $2, %%rax;"</span> <span class="hljs-comment">// Open syscall number</span>
             <span class="hljs-string">"mov %1, %%rdi;"</span> <span class="hljs-comment">// Address of our string</span>
             <span class="hljs-string">"mov %2, %%rsi;"</span> <span class="hljs-comment">// Open mode</span>
             <span class="hljs-string">"mov $0, %%rdx;"</span> <span class="hljs-comment">// No create mode</span>
             <span class="hljs-string">"syscall;"</span>       <span class="hljs-comment">// Straight to ring0</span>
             <span class="hljs-string">"mov %%eax, %0;"</span> <span class="hljs-comment">// Returned file descriptor</span>
             :<span class="hljs-string">"=r"</span> (fd)<font></font>
             :<span class="hljs-string">"m"</span> (path), <span class="hljs-string">"m"</span> (oflag)<font></font>
             :<span class="hljs-string">"rax"</span>, <span class="hljs-string">"rdi"</span>, <span class="hljs-string">"rsi"</span>, <span class="hljs-string">"rdx"</span><font></font>
             );<font></font>
    <span class="hljs-keyword">return</span> fd;<font></font>
 }<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    syscall_open(<span class="hljs-string">"/etc/ld.so.preload"</span>, O_RDONLY) &gt; <span class="hljs-number">0</span> ?
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (open syscall) [+]\n"</span>):
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LD_PRELOAD (open syscall) [-]\n"</span>);<font></font>
        <font></font>
}<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ ./detect_syscall<font></font>
LD_PRELOAD (open syscall) [+]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、この問題には解決策があります。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">男性</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からの抜粋</font><font style="vertical-align: inherit;">：</font></font><br>
<blockquote>ptrace —  ,         ,       .               .<br>
<br>
    ,    fork(2),        PTRACE_TRACEME,   ()   exec(3).   ,          PTRACE_ATTACH.<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トレースすると、シグナルが無視される場合でも、シグナルが受信されるたびに子プロセスが停止します。</font><font style="vertical-align: inherit;">（例外はSIGKILLであり、通常の方法で機能します。）wait（2）が呼び出されると、親プロセスに通知され、その後、開始する前に子プロセスの内容を表示および変更できます。</font><font style="vertical-align: inherit;">その後、親プロセスは子が作業を続行できるようにします。場合によっては、子に送信された信号を無視するか、代わりに別の信号を送信します）。</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、解決策はプロセスを追跡し、各システムコールの前にプロセスを停止し、必要に応じてスレッドをトラップ関数にリダイレクトすることです。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;limits.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ptrace.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/reg.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/user.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;asm/unistd.h&gt;</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__x86_64__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REG_SYSCALL ORIG_RAX</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REG_SP rsp</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REG_IP rip </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-keyword">long</span> NOHOOK = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">evil_open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">long</span> oflag, <span class="hljs-keyword">long</span> cflag)</span> 
</span>{
    <span class="hljs-keyword">char</span> real_path[PATH_MAX], maps_path[PATH_MAX];
    <span class="hljs-keyword">long</span> ret;
    <span class="hljs-keyword">pid_t</span> pid;<font></font>
    pid = getpid();<font></font>
    realpath(path, real_path);<font></font>
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(real_path, <span class="hljs-string">"/etc/ld.so.preload"</span>) == <span class="hljs-number">0</span>)<font></font>
    {<font></font>
        errno = ENOENT;<font></font>
        ret = <span class="hljs-number">-1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
        NOHOOK = <span class="hljs-number">1</span>; <span class="hljs-comment">// Entering NOHOOK section</span><font></font>
        ret = open(path, oflag, cflag);<font></font>
    }<font></font>
    <span class="hljs-comment">// Exiting NOHOOK section</span>
    NOHOOK = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> ret;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">pid_t</span> program;
    <span class="hljs-comment">//   </span><font></font>
    program = fork();<font></font>
    <span class="hljs-keyword">if</span>(program != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">int</span> status;
        <span class="hljs-keyword">long</span> syscall_nr;
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> <span class="hljs-title">regs</span>;</span>
        <span class="hljs-comment">//    </span>
        <span class="hljs-keyword">if</span>(ptrace(PTRACE_ATTACH, program) != <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to attach to the program.\n"</span>);
            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
        }<font></font>
        waitpid(program, &amp;status, <span class="hljs-number">0</span>);
        <span class="hljs-comment">//   SYSCALLs</span>
        ptrace(PTRACE_SETOPTIONS, program, <span class="hljs-number">0</span>, PTRACE_O_TRACESYSGOOD);
        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {<font></font>
            ptrace(PTRACE_SYSCALL, program, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
            waitpid(program, &amp;status, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span>(WIFEXITED(status) || WIFSIGNALED(status)) <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(WIFSTOPPED(status) &amp;&amp; WSTOPSIG(status) == SIGTRAP|<span class="hljs-number">0x80</span>) {
                <span class="hljs-comment">//    </span>
                syscall_nr = ptrace(PTRACE_PEEKUSER, program, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>)*REG_SYSCALL);
                <span class="hljs-keyword">if</span>(syscall_nr == __NR_open) {
                    <span class="hljs-comment">//      </span>
                    NOHOOK = ptrace(PTRACE_PEEKDATA, program, (<span class="hljs-keyword">void</span>*)&amp;NOHOOK);
                    <span class="hljs-comment">//  </span>
                    <span class="hljs-keyword">if</span>(!NOHOOK) {<font></font>
                        <font></font>
                        <span class="hljs-comment">//    </span>
                        <span class="hljs-comment">//   regs </span>
                        ptrace(PTRACE_GETREGS, program, <span class="hljs-number">0</span>, &amp;regs);
                        <span class="hljs-comment">// Push return address on the stack</span>
                        regs.REG_SP -= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>);
                        <span class="hljs-comment">//      </span>
                        ptrace(PTRACE_POKEDATA, program, (<span class="hljs-keyword">void</span>*)regs.REG_SP, regs.REG_IP);
                        <span class="hljs-comment">//  RIP   evil_open</span>
                        regs.REG_IP = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>) evil_open;
                        <span class="hljs-comment">//    </span>
                        ptrace(PTRACE_SETREGS, program, <span class="hljs-number">0</span>, &amp;regs);<font></font>
                    }<font></font>
                }<font></font>
                ptrace(PTRACE_SYSCALL, program, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
                waitpid(program, &amp;status, <span class="hljs-number">0</span>);<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> {<font></font>
        sleep(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはチェックします：</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ./detect_syscall<font></font>
LD_PRELOAD (open syscall) [+]<font></font>
$ LD_PRELOAD=./ld_undetect_syscall.so ./detect_syscall<font></font>
LD_PRELOAD (open syscall) [-]<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ 0-0 = 5 </font></font></b><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Charles Hubain </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Chokepoint </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ValdikSS </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Philippe Teuwen </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">derhass</font></a><font style="vertical-align: inherit;"> 
に</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
感謝し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br><font style="vertical-align: inherit;"></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja479844/index.html">UXデザイナーのチームを集め、採用ミスにより700万人を失う</a></li>
<li><a href="../ja479848/index.html">2019年第4象限に登場！Gartnerミーティングソリューションのビデオ会議分析レポートが5年間でどのように変化するか</a></li>
<li><a href="../ja479850/index.html">Windows Server Core 2019にExchange 2019をインストールする</a></li>
<li><a href="../ja479852/index.html">内部でのビデオ通話：1日あたり数百万から1つの会議の100人の参加者まで</a></li>
<li><a href="../ja479854/index.html">12月12日モーニングジャバダイジェスト</a></li>
<li><a href="../ja479860/index.html">生命モデリングのトピックのバリエーション。パート2</a></li>
<li><a href="../ja479862/index.html">ソフトウェアを登録するときに15000ルーブルを節約する方法</a></li>
<li><a href="../ja479864/index.html">WinForms + C＃でのゲーム16（パート2）</a></li>
<li><a href="../ja479870/index.html">私たちは、外出先でフレームワークと仕事用プロファイルを変更します。PHP NNの2番目のミタップで何が起こるか</a></li>
<li><a href="../ja479874/index.html">どのようにしてThoughtWorksまたは模範的なインタビューに入りましたか</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>