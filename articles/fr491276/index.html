<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔶 ◾️ 🙅🏼 Comment j'ai contourné l'interdiction de l'API Messages via la documentation de Vkontakte 🧝🏾 🚵🏻 🦇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à toute la communauté Habro. Pour moi, ce premier article est écrit sous une certaine euphorie, alors ne jugez pas cet article trop strictemen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai contourné l'interdiction de l'API Messages via la documentation de Vkontakte</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491276/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour à toute la communauté Habro. </font><font style="vertical-align: inherit;">Pour moi, ce premier article est écrit sous une certaine euphorie, alors ne jugez pas cet article trop strictement pour la partie littéraire. </font><font style="vertical-align: inherit;">Mais bon, moins de mots et passez aux choses sérieuses.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment tout a commencé</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous savons tous que VC possède une API, et je suis sûr que la plupart des gens ont essayé de l'utiliser à leurs propres fins. </font><font style="vertical-align: inherit;">Personnellement, j'ai beaucoup de projets liés à cela: des morceaux de 5 robots puissants, la compilation de jeux de données à grande échelle à partir de publications de groupe, etc. </font><font style="vertical-align: inherit;">Et il n'est pas surprenant que mes amis m'aient demandé à quelques reprises de télécharger des chansons à partir des pièces jointes du dialogue, des photos ou d'enregistrer le texte de la correspondance avec une personne dans un fichier séparé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais une fois que «ça» est arrivé, et à partir de ce moment, la mise en œuvre de ces petites requêtes a cessé d'être une tâche triviale: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c41/913/d6c/c41913d6cfb47f8acff5c3145502c4e5.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc, il y a quelques jours, pour me débarrasser de ce problème une fois pour toutes, j'ai décidé d'écrire mon wrapper via des requêtes http, faisant semblant d'être un utilisateur régulier, de sorte que avoir le même outil puissant que l'API officielle pour la section des messages.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous allons passer aux choses sérieuses</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai donc commencé avec une autorisation. </font><font style="vertical-align: inherit;">Armé du renifleur https et de Firefox, j'ai pu passer par toutes les «étapes» d'autorisation et obtenir les cookies finaux. </font><font style="vertical-align: inherit;">Désormais, il ne restait plus qu'à comprendre comment les requêtes étaient faites. </font><font style="vertical-align: inherit;">Il a été constaté que la plupart des données sont reçues par une demande POST de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://vk.com/wkview.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , seuls les paramètres des différentes situations changent à chaque fois. </font><font style="vertical-align: inherit;">J'ai réussi à écrire des fonctions pour pomper absolument tous les types d'investissements, mais nous n'entrerons pas dans les détails, car à un moment tout a radicalement changé.</font></font><br>
<blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lien vers le fichier pour recevoir les cookies d'autorisation (je l'ai écrit uniquement pour l'authentification à deux facteurs, car cela coûte la plupart des gens)</font></font></a></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Découverte inattendue</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je travaillais sur un ordinateur portable lorsqu'un ami est venu me voir et m'a demandé ce que je faisais. Comme je ne pouvais pas lui expliquer rapidement tout le problème sur mes doigts, j'ai ouvert la documentation officielle sur la section des messages, et j'ai été stupéfait quand j'ai vu ce qui est sous la description principale de ces méthodes "interdites": </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e14/077/91c/e1407791c9c79301b94f9f73c58fe5dd.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Non, vous me comprenez bien, je ne suis pas le premier il suffit de voir cette opportunité. Je l'ai utilisé plusieurs fois avec d'autres méthodes, mais je ne pouvais même pas penser que la fonction "exemple de demande" resterait avec les méthodes de la section des messages. Et encore plus fort a été ma surprise quand j'ai brouillé le trafic. Ce n'étaient que des demandes d'API ordinaires, uniquement sur le site, qui n'avaient que des noms de paramètres légèrement différents dans le formulaire Web et avaient une sorte d'ID de hachage.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/39d/68c/a1b/39d68ca1b65fec086d6f3be18578ef91.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En quelques minutes, j'ai réalisé que l'ID de hachage n'est qu'une chaîne située dans l'attribut de hachage de données de la balise de bouton, et après quelques minutes, j'essayais déjà de mettre en œuvre l'émulation des «demandes de test» et je ne croyais pas complètement que cela fonctionnerait. </font><font style="vertical-align: inherit;">Après tout, bien sûr, ces demandes ont une sorte de limite sur le nombre ou quelque chose comme ça. </font><font style="vertical-align: inherit;">Mais quelle n'a pas été ma surprise quand ce script de 30 lignes (sans compter la réception des cookies), qui était écrit sur mes genoux, a pu pomper mille et un millier de photos des pièces jointes du dialogue en 4 minutes.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2f8/d30/555/2f8d3055586c0d8a63f6898c1173319e.jpg" alt="image"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'applique le code utilisé</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> requests, pickle, re, json<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">'cookies_vk_auth.pickle'</span>, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> handle:<font></font>
    cookies_final = pickle.load(handle)<font></font>
<font></font>
session = requests.Session()<font></font>
peer_id = int(input(<span class="hljs-string">'  :  '</span>))<font></font>
<font></font>
response = session.get(<span class="hljs-string">f'https://vk.com/dev/messages.getHistoryAttachments'</span>, cookies=cookies_final)<font></font>
hash_data =  re.findall(<span class="hljs-string">r'data-hash="(\S*)"'</span>, response.text)[<span class="hljs-number">0</span>]<font></font>
<font></font>
session = requests.Session()<font></font>
response = session.post(<span class="hljs-string">f'https://vk.com/dev'</span>,<font></font>
            data=<span class="hljs-string">f'act=a_run_method&amp;al=1&amp;hash=<span class="hljs-subst">{hash_data}</span>&amp;method=messages.getHistoryAttachments&amp;param_count=20&amp;param_max_forwards_level=45&amp;param_media_type=photo&amp;param_peer_id=<span class="hljs-subst">{peer_id}</span>&amp;param_photo_sizes=0&amp;param_preserve_order=0&amp;param_v=5.103'</span>, cookies=cookies_final)<font></font>
<font></font>
count=<span class="hljs-number">20</span><font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">200</span>):<font></font>
    response_json = json.loads(json.loads(response.text[<span class="hljs-number">4</span>:])[<span class="hljs-string">'payload'</span>][<span class="hljs-number">1</span>][<span class="hljs-number">0</span>])[<span class="hljs-string">'response'</span>][<span class="hljs-string">'items'</span>]<font></font>
<font></font>
    <span class="hljs-keyword">for</span> photo <span class="hljs-keyword">in</span> response_json:<font></font>
        ph = photo[<span class="hljs-string">'attachment'</span>][<span class="hljs-string">'photo'</span>][<span class="hljs-string">'sizes'</span>][<span class="hljs-number">-1</span>][<span class="hljs-string">'url'</span>]<font></font>
        r = session.get(ph, timeout=<span class="hljs-number">10</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> r.status_code == <span class="hljs-number">200</span>:
            <span class="hljs-keyword">with</span> open(<span class="hljs-string">f'D://dev/'</span>+str(ph.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">-1</span>]), <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
                f.write(r.content)<font></font>
<font></font>
    m_id = photo[<span class="hljs-string">'message_id'</span>]<font></font>
    response = session.post(<span class="hljs-string">f'https://vk.com/dev'</span>,<font></font>
            data=<span class="hljs-string">f'act=a_run_method&amp;al=1&amp;hash=<span class="hljs-subst">{hash_data}</span>&amp;method=messages.getHistoryAttachments&amp;param_count=20&amp;param_start_from=<span class="hljs-subst">{m_id}</span>&amp;param_max_forwards_level=45&amp;param_media_type=photo&amp;param_peer_id=<span class="hljs-subst">{peer_id}</span>&amp;param_photo_sizes=0&amp;param_preserve_order=0&amp;param_v=5.103'</span>, cookies=cookies_final)
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'étais tellement impressionné qu'à ce stade, j'ai décidé de me calmer et d'essayer de mettre en œuvre une autre méthode (tout d'un coup, je me suis trompé). </font><font style="vertical-align: inherit;">J'ai repris la méthode History et le résultat était similaire. </font><font style="vertical-align: inherit;">Seulement, j'ai dû définir un délai de 0,1 seconde pour que le serveur ne donne pas d'erreur sur trop de requêtes. </font><font style="vertical-align: inherit;">(Si quelqu'un répète, n'oubliez pas que lorsque vous modifiez la méthode, vous devez également modifier l'URL de la documentation, d'où proviennent les données de hachage). </font><font style="vertical-align: inherit;">Autrement dit, cette méthode a vraiment permis d'accéder à la section des messages via la documentation officielle, en utilisant uniquement le mot de passe et la connexion utilisateur. </font><font style="vertical-align: inherit;">Pour plus de fiabilité, j'ai essayé de faire les mêmes étapes sur un autre compte et j'ai obtenu le même résultat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résumer</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc, je pense que tout le monde a déjà réalisé qu'il s'agit d'une violation de la protection de nos données personnelles, qui est suspendue dans la documentation depuis un an et on ne sait pas combien de personnes l'ont déjà utilisée. </font><font style="vertical-align: inherit;">De plus, cet écart est très important et doit être comblé prochainement. </font><font style="vertical-align: inherit;">Et pour prouver une fois de plus que cela ne devrait pas fonctionner de cette façon, je citerai les développeurs VK eux-mêmes:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous prévoyez de commencer à développer un messager, après le 15 février 2019, vous devrez obtenir un accès test dans Support, ce qui implique le travail des méthodes de la section Messages avec les clés des administrateurs de votre application autonome.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, même pour obtenir un jeton d'une application interne qui aura accès à la correspondance de l'utilisateur, vous avez besoin d'une autorisation personnelle de VK, et encore moins d'un accès avec un mot de passe et une connexion normaux. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mon opinion personnelle</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'interdiction de la section des messages n'a apporté aucun changement fondamental à la sécurité des utilisateurs. </font><font style="vertical-align: inherit;">Il vient de désigner la frontière et de couper un groupe de "sous-hackers" qui, sans même comprendre ce qu'ils faisaient, pourraient avoir un accès complet aux données. </font><font style="vertical-align: inherit;">Pour le reste des gens, plus expérimentés en programmation, accéder à la correspondance n'est qu'une question de temps. </font><font style="vertical-align: inherit;">Et dans la première partie de l'article, j'ai prouvé par mon propre exemple, après avoir créé un programme de pompage de pièces jointes, que l'émergence d'une bibliothèque qui peut prétendre être un utilisateur n'est pas loin. </font><font style="vertical-align: inherit;">Peut-être que j'y arriverai moi-même jusqu'à la fin, et les développeurs VK doivent être préparés à cela et trouver des moyens de reconnaître une activité utilisateur trop suspecte si la confidentialité de nos données est vraiment importante pour eux.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><div class="spoiler_text">       ,      )     ,       .<br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491262/index.html">Oeil pour oeil. Problèmes de biométrie</a></li>
<li><a href="../fr491264/index.html">Introduction au SSD. Partie 4. Physique</a></li>
<li><a href="../fr491266/index.html">SurfingAttack: compromettre les smartphones avec des assistants sonores [+ vidéo]</a></li>
<li><a href="../fr491268/index.html">Méthodes de Monte Carlo pour les chaînes de Markov (MCMC). introduction</a></li>
<li><a href="../fr491272/index.html">Développement de site web en pascal (backend)</a></li>
<li><a href="../fr491278/index.html">CLRium # 7: Rapports, pratique, mentors</a></li>
<li><a href="../fr491280/index.html">L'histoire de la façon dont j'ai développé un langage de programmation</a></li>
<li><a href="../fr491282/index.html">Comment augmenter la productivité de l'équipe (et réduire les erreurs) à l'aide de rallyes</a></li>
<li><a href="../fr491284/index.html">Analyse: qu'est-ce que l'analyse fondamentale</a></li>
<li><a href="../fr491286/index.html">Réseaux IPv6 uniquement dans le gouvernement américain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>