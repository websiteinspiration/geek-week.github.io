<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æ üåñ üéå The tale of how I automated the apartment using Node-RED. Part II üìï üë©‚Äçüëß‚Äçüëß ü§õüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The long-awaited continuation of the post about the automation of the apartment . In this part I will talk about lighting, a multimedia system and sec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The tale of how I automated the apartment using Node-RED. Part II</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/489774/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The long-awaited </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">continuation of the post about the automation of the apartment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In this part I will talk about lighting, a multimedia system and security sensors.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/89/pw/1w/89pw1w8yo0rpgru9rx1cckulooc.png"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lighting</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To control the lighting, several components are used:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">motorized curtains;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dimmable lighting.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shine</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The light in the rooms is divided into two zones. </font><font style="vertical-align: inherit;">I use ikeev LED dimmable lamps. </font><font style="vertical-align: inherit;">I use three modules for control: </font></font><br>
<img src="https://habrastorage.org/webt/4h/94/fp/4h94fp3qxcxmwpmqqi2kmeecuuo.jpeg" alt="Built-in dimmer FIBARO Dimmer 2"><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Built-in dimmer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FIBARO Dimmer 2</font></font></a></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/tn/sh/7ntnshtkobrl2nsbrlijuj5ujre.jpeg" alt="Built-in double relay FIBARO Double Switch 2x1.5kW"><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Built-in dual relay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FIBARO Double Switch 2x1.5kW</font></font></a></font><br>
<br>
<img src="https://habrastorage.org/webt/av/ju/nz/avjunzs_vw57crfbzkqcrlsc-sa.jpeg" alt="Built-in Relay FIBARO Single Switch 2.5kW"><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Built-in relay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FIBARO Single Switch 2.5kW</font></font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dimmer can automatically choose a dimming method (on the leading and trailing edges of the phase) and calibrate for minimum and maximum brightness. </font><font style="vertical-align: inherit;">Since I had a three-wire system in advance for all the sockets, I did not have to use a bypass. </font><font style="vertical-align: inherit;">LED lamps do not flicker and do not light when there is no voltage. </font><font style="vertical-align: inherit;">For dimmable modules, I use ringer switches so that you can adjust the brightness. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9v/f7/dl/9vf7dlpauw3strd9emtimu-ct7w.png" alt="     "><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Three-wire dimmer wiring diagram</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's how it works:</font></font><br>
<br>
<ul>
<li>  -    ,       (     ).</li>
<li>      -    ,          ‚Äî    .         .      ,      .</li>
<li>      ,   ,   .        ‚Äî   .</li>
<li>   ,         .    ,    1% .</li>
<li>      ,    15   .</li>
<li>    ,   .</li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/yj/wi/w2/yjwiw2pdfhu75m12gjyckm77l4e.png" alt="  "></a><br>
<font color="#909090">  </font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/ll/46/nj/ll46nj_cya6jsqp5psnpvs1mzbc.png" alt="  "></a><br>
<font color="#909090">  </font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/dl/9h/jp/dl9hjpmwyo23zbxv7drmykp9sfm.png" alt="  "></a><br>
<font color="#909090">  </font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/kg/cl/md/kgclmdshmkmuagjrnidhbh40mhu.png" alt="  "></a><br>
<font color="#909090">  </font><br>
<br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I wrote earlier, all the windows of my apartment overlook a busy avenue with bright lights. To solve the problem of bright light from lamps at night or in the summer from the bright sun, I use motorized roller blinds. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first I wanted to buy ready-made kits, but the prices were very high, and I did not like the color scheme. This idea had to be discarded and assemble several sets on their own. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of the 220 V engines, the choice was small: either French Somfy or Chinese Dooya. Somfy is quieter, but also more expensive, so the choice fell on Dooya DM35S engines. I ordered them along with fasteners on the "Aliexpress". The engine has two limit switches that adjust the maximum and minimum position. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qj/yw/06/qjyw064wkqndni2rppwdvzzkdz0.jpeg" alt="  "><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Engine with mounts</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next problem was the pipe for winding curtains. According to the rules of the mail message, you can send a parcel no longer than 180 cm, and one of the windows I have is more than 2 meters. In the nearest construction market, I found an aluminum pipe of the desired diameter - 50 mm. After installing the engines in the pipes, it remains to find blackout curtains. I ordered the fabric in my sizes from "Aliexpress" after agreeing with the seller that he would send me only the fabric, without mechanisms. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5j/cy/pm/5jcypmbghomntcc_bolirecpmya.jpeg" alt="  "><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fixed assembled curtain The</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
curtains are controlled using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FIBARO Roller Shutter 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Z-Wave blind control module. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Louver </font></a></font><br>
<br>
<img src="https://habrastorage.org/webt/p-/yn/u2/p-ynu2giqo5wktxhwyb3h7onz0u.jpeg" alt="  "><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">control module</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The module is built into the socket. For such modules, it is advisable to immediately lay deep sockets to push the module, wires and switch. The module has enough settings, including response to alarms, calculation of power consumption, calibration with limit switches. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/bc/ub/owbcubpc-6tca4tltprsmlj8s74.jpeg" alt=" "><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembled switch</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Curtains are installed in each room and in the kitchen. You can control the curtains either by the switches located next to them, or by using an interface or script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Curtains are lowered automatically when dusk sets in and the lights turn on on the street. They rise according to the programmed time for each room on weekdays and weekends. If it is dark outside, the light starts to turn on smoothly in the room where the curtain is lowered.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Working days and weekends are calculated according to the downloaded production calendar. </font><font style="vertical-align: inherit;">You can reconfigure the time the next day for each room using the telegram command. </font><font style="vertical-align: inherit;">Before folding the curtains according to the ‚Äúalarm clock‚Äù, a telegram message arrives with the ability to confirm, cancel and reschedule for 30 minutes. </font><font style="vertical-align: inherit;">If the action does not follow, the curtains automatically fold. </font><font style="vertical-align: inherit;">On bright days, the curtains automatically set their position depending on the lighting in the room and the time of day, and also check whether the light is on or not. </font><font style="vertical-align: inherit;">Upon receipt of the ‚ÄúVacation‚Äù command, all curtains in all rooms are lowered. </font><font color="#909090"><font style="vertical-align: inherit;">Curtain </font></font><font color="#909090"><font style="vertical-align: inherit;">Management Scenario Curtain Management Scenario</font></font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/-w/j0/na/-wj0na6ajgmspxvn9ul-vfxesri.png" alt="  "></a><br>
<font color="#909090"><font style="vertical-align: inherit;"></font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/vj/1h/6z/vj1h6z5-dl53n-44smy6edp89iq.png" alt="  "></a><br>
<font color="#909090"><font style="vertical-align: inherit;"></font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/dsvjkFMLkcQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work example</font></font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multimedia system</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have many multimedia devices with various remotes in the living room, and I wanted to control them with one button. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the Internet, I found separate IR codes for turning on and off the amplifier, TV and HDMI splitter. Using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pronto_broadlink</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Python script </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">,</font></a><font style="vertical-align: inherit;"> they were transcoded to base64, and then converted to an array of bytes and written to the IR code base. Therefore, now it is not necessary to know what state the device is in now: you can simply send the signal again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since my amplifier is quite old and does not know how to process a 4K picture via HDMI, I bought an HDMI splitter. It allows you to split the video and audio signal into two separate HDMI: one of them is connected to the amplifier, the second to the TV. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/u_/4y/ydu_4yehplzjy-aqnc_lohuxbwo.jpeg" alt="   "><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amplifier and other devices</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment I have two sources of audio and video: a desktop computer and a server. From the interface, you can turn on all devices for playback with one button, only in one case the signal reception will be configured on the splitter from the server, and in the second - from the computer. In the future, it is planned to connect game consoles to the splitter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everyone leaves the house, all multimedia devices are turned off. </font><font color="#909090"><font style="vertical-align: inherit;">Media control scene</font></font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/6e/li/w3/6eliw3ospeig-4jdz0vzibq3scq.png" alt="  "></a><br>
<font color="#909090"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The presence system operates on 6 motion sensors and a front door opening sensor. </font><font style="vertical-align: inherit;">If, after opening and closing the door, not a single occupancy sensor has triggered, a message will be sent to Telegram at a certain interval with confirmation. </font><font style="vertical-align: inherit;">If no actions are taken within two minutes or the ‚ÄúOk‚Äù button is pressed, the system switches to the ‚ÄúOut of home‚Äù mode. </font><font style="vertical-align: inherit;">If movement occurs at this time, the command is canceled and the message is deleted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I tried using BLE, but in my case it did not work very stable and depended heavily on the phone transmitter. </font><font color="#909090"><font style="vertical-align: inherit;">Automatic presence detection</font></font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/r_/if/x8/r_ifx8nmt01pioisfqkdalu35x8.png" alt="  "></a><br>
<font color="#909090"><font style="vertical-align: inherit;"></font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Safety sensors</font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gidrolock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
locking devices are installed on the water pipes </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">When the control wire is shorted to phase, the actuator closes the tap; when disconnected, it opens. </font><font style="vertical-align: inherit;">Both drives are connected to a </font><font style="vertical-align: inherit;">dry contact </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Philio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> built-in relay </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ys/tx/3i/ystx3iuuvzjpm_yso_wthzk_g5u.jpeg" alt=" Gidrolock"><br>
<font color="#909090"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Gidrolock</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Relay </font><font color="#909090"><font style="vertical-align: inherit;">drive is</font></font><font style="vertical-align: inherit;"> controlled by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NEO Coolcam</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Z-Wave sensors </font><font style="vertical-align: inherit;">located in the areas of potential leaks. </font><font style="vertical-align: inherit;">All sensors are directly in association with the relay, so that water shuts off without the participation of the controller. </font><font style="vertical-align: inherit;">To prevent the tap from becoming soured, every two weeks at night it automatically opens and closes. </font><font color="#909090"><font style="vertical-align: inherit;">Drive Automation Diagram</font></font><font style="vertical-align: inherit;"> 
When </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Philio Smokes a Sensor</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/d6/oi/wi/d6oiwiu4axhpwaizc46i4ongyeq.png" alt="  "></a><br>
<font color="#909090"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the ventilation is turned off so as not to inflate the fire. </font><font style="vertical-align: inherit;">At the same time, a message is sent to the telegram chat, and the sensor squeaks disgustingly.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other sensors and devices</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 in 1 Multisensor Aeotec Multisensor 6</font></font></a></li>
<li><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">NEO Coolcam</font></a><font style="vertical-align: inherit;"> Opening </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor</font></font></a></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Authorize server</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This module is a simple implementation of an authorization service. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two http-methods: one will check if the request came from the internal network and if so, it will authorize the user by issuing him a JWT token. </font><font style="vertical-align: inherit;">The JWT token is encrypted using RSA 256, the private key must be registered in the file next to it. </font><font style="vertical-align: inherit;">If the request is not from the internal network, the user will be redirected to the login page, where he must enter the login and password and log in. </font><font style="vertical-align: inherit;">Since separation into users is not supposed, the login file and password in encrypted form (SHA 512) are nearby in the configuration file.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT server</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The MQTT server is implemented using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aedes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> component </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The server rises on two ports: internal, for communication with the server, without authorization, and external, which implements WebSocket. </font><font style="vertical-align: inherit;">All front-end clients connect via a socket and pass authentication during authorization, subscribing to the topic, and publishing any message. </font><font style="vertical-align: inherit;">The JWT token that was received from the authorization server comes in and is validated using the public key. </font><font style="vertical-align: inherit;">For requests from the server, validation does not occur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custom Node-RED Nodes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When writing automation, it was required to implement one additional node and two to finalize. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I had to modify </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node-red-contrib-openzwave</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since my pull request was accepted only after 7 months, but now you can use the library from npm. The refinement consisted of throwing a node removal event. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kh/r4/nu/khr4nu0e2xikiinmz6wcxkslhea.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The MQTT node has also been finalized. In fact, the main refinement in it is pulling the id of the connected client and writing it back when sent to the queue. Here you can get by with the subflow functionality. It was also supposed to transfer any data to the input of the MQTT-node, but it was not useful.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ef/xu/mb/efxumb_9d6wk07dbzc5ippu3pec.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To control the curtains and water taps, a schedule node was required. </font><font style="vertical-align: inherit;">Available at that time in the library were too feature-rich and did not support a simple implementation using CRON. </font><font style="vertical-align: inherit;">My implementation is quite simple: a schedule can be taken either at the input of a node or set internally. </font><font style="vertical-align: inherit;">It is possible to cancel the schedule. </font><font style="vertical-align: inherit;">Under the hood, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node-schedule is used</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/ku/a1/qakua12yqbuuz8gkchotr2nj4ps.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Front</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each active component of the apartment, which is wound up in automation, is a module at the front. </font><font style="vertical-align: inherit;">Each module is self-contained and contains all the necessary components for rendering. </font><font style="vertical-align: inherit;">Modules are divided into two aggregations: static and Z-Wave. </font><font style="vertical-align: inherit;">Modules must implement one interface.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interface</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">export</span> interface INode {
    <span class="hljs-attr">id</span>: string;<font></font>
    type: NodeTypes;<font></font>
    name: string;<font></font>
    addWidget: ComponentClass&lt;AddProps&gt; | StatelessComponent&lt;AddProps&gt;;<font></font>
    model: INodeModelConstructor;<font></font>
    service?: INodeServiceConstructor;<font></font>
    smallComponent: ComponentClass&lt;WidgetProps&lt;any&gt;&gt; | StatelessComponent&lt;WidgetProps&lt;any&gt;&gt;;<font></font>
    bigComponent: ComponentClass&lt;WidgetProps&lt;any&gt;&gt; | StatelessComponent&lt;WidgetProps&lt;any&gt;&gt;;<font></font>
    dialogEditComponent: ComponentClass&lt;WidgetProps&lt;any&gt;&gt; | StatelessComponent&lt;WidgetProps&lt;any&gt;&gt;;<font></font>
    dialogViewComponent: ComponentClass&lt;WidgetProps&lt;any&gt;&gt; | StatelessComponent&lt;WidgetProps&lt;any&gt;&gt;;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementation example</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Widget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseWidget</span> <span class="hljs-title">implements</span> <span class="hljs-title">INode</span> </span>{
    <span class="hljs-attr">model</span>: INodeModelConstructor = Model;<font></font>
    manufacturerid: string = <span class="hljs-string">'0x0086'</span>;<font></font>
    producttype: string = <span class="hljs-string">'0x1a02'</span>;<font></font>
    productid: string = <span class="hljs-string">'0x0064'</span>;<font></font>
    addWidget: StatelessComponent&lt;AddProps&gt; = AddWidget;<font></font>
    service: INodeServiceConstructor = Service;<font></font>
    smallComponent: StatelessComponent&lt;WidgetProps&lt;Model&gt;&gt; = SmallComponent;<font></font>
    bigComponent: StatelessComponent&lt;WidgetProps&lt;Model&gt;&gt; = BigComponent;<font></font>
    dialogEditComponent: ComponentClass&lt;WidgetProps&lt;Model&gt;&gt; = DialogEditComponent;<font></font>
    dialogViewComponent: ComponentClass&lt;WidgetProps&lt;Model&gt;&gt; = DialogViewComponent;<font></font>
}<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Widget;</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For static modules - for example, air conditioners - you need to implement a data warehouse at the front. </font><font style="vertical-align: inherit;">Such an implementation is inconvenient, in a good way it needs to be changed to one repository. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Z-Wave-modules I organized a common repository and tracking of all changes on it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The module implements the display in two ways:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for "large" screens (tablet, computer);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for phones.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depending on the type of device, touch or mouse control will be selected. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The application is built using webpack + babel: according to the current settings, it is assembled for the last two versions of Firefox, Chrome, Chrome Android.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Features of source codes</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
All Flow are disabled, so as not to throw errors in the log. </font><font style="vertical-align: inherit;">The configuration node for Z-Wave is deleted: it is buggy if it does not find the Z-Wave controller, and drops the entire Node-RED. </font><font style="vertical-align: inherit;">It should look something like this:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nt/up/cf/ntupcfzfm3ths5v6h6ys6-hnv2s.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the work calendar loader to work, you need to register on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data.gov.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , get a token there and enter it after access_token:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fj/rs/rh/fjrsrhnxndutit6hgfrwic9kz5c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The weather forecast is downloaded from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">darksky.net</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> once every 15 minutes. </font><font style="vertical-align: inherit;">He also needs a token, you need to register and enter the token after forecast, to the coordinates:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bf/ka/kz/bfkakzodfw6mpsboylfszwjdurw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To send telegram notifications, you need to get your bot, enter it in the Telegram configuration node and write the chat id where necessary. </font><font style="vertical-align: inherit;">In the case of my Flow, this is subflow: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mm/gm/xu/mmgmxuevhgbi_i8gosfkcm5tuow.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sources are divided into front and back. </font><font style="vertical-align: inherit;">In the back part lies:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Authorize server.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT server.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custom Node-RED Modules.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exported Flows in one file, which can be either uploaded to your own account or a separate instance for tests.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A project for Node-RED, in which you need to install the modules and then only load the exported Flow (the modules are already in the project).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backup Mongo-base.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can find more detailed installation information in the readme file in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the github repository</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plans</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The plans are to use the microphone of a smartphone or wall-mounted tablet for voice control. </font><font style="vertical-align: inherit;">I plan to deploy my open-source system on a server based on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMU Sphinx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I also plan to assemble a module for taking and transmitting readings of plumbing and electricity meters. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also worth considering the use of accumulated statistics for various parameters in order to optimize automation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, I have achieved almost complete automation of the house to my needs - to maintain a comfortable climate and lighting in the house. Due to some automation, it was possible to reduce electricity consumption (about 1,500 ‚ÇΩ in winter compared to the same equipment without automation), both from the side of heating elements and from the side of lighting. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, there are still bugs in the algorithms, but I'll catch them someday, at least I'm moving in this direction. The system works stably, I do not see any brakes, despite the very low speed in the Z-Wave protocol.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the system will not pay for itself at the expense of savings, there is more a question of comfort. </font><font style="vertical-align: inherit;">Such automation is very damp in terms of little things like closing and opening curtains, controlling light. </font><font style="vertical-align: inherit;">When you are in an ordinary apartment, you sometimes forget to turn the lights on or off, and you don‚Äôt open the curtains at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I rarely adjust the climate system with my hands, but sometimes you need to turn the air conditioner on or off or adjust the temperature on the battery. </font><font style="vertical-align: inherit;">In general, I am satisfied with the resulting system: it allows less time to spend on any adjustments. </font><font style="vertical-align: inherit;">In the event of a controller failure, all functionality will remain in place (only automation will fall off). </font><font style="vertical-align: inherit;">The functionality of the water shutoff will also be preserved. </font><font style="vertical-align: inherit;">If I decide to sell the apartment, then I will easily remove all the automation. </font><font style="vertical-align: inherit;">Or leave it in place, but selling more.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489762/index.html">A simple example of parsing and data analytics for World of Tanks</a></li>
<li><a href="../en489764/index.html">‚ÄúThe Destination has a lot of guises ...‚Äù or we automate the control of a bulb using CANNY 3 tiny and a photoresistor</a></li>
<li><a href="../en489768/index.html">How œÄ combines colliding blocks and a quantum search algorithm</a></li>
<li><a href="../en489770/index.html">Video from MinskJS mitap: my report on browser extensions</a></li>
<li><a href="../en489772/index.html">Hackathon in Simferopol, Yandex. Dialogs and laws of chat-bot technology</a></li>
<li><a href="../en489776/index.html">The Ember Times - Issue 136</a></li>
<li><a href="../en489778/index.html">Old and new CSS. Web Design History</a></li>
<li><a href="../en489782/index.html">FizzBuzz 2.0: Pragmatic Questions for Programmers</a></li>
<li><a href="../en489784/index.html">February 27 - the start of the project for students of NX Bootcamp in Novosibirsk</a></li>
<li><a href="../en489786/index.html">Warm, tube and very dangerous</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>