<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüíª ü•á ‚öΩÔ∏è SHISHUA: le g√©n√©rateur de nombres pseudo-al√©atoires le plus rapide au monde üò® üê´ üëãüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a six mois, je voulais cr√©er le meilleur g√©n√©rateur de nombres pseudo-al√©atoires (PRNG) avec une architecture inhabituelle. Je pensais que le d√©b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SHISHUA: le g√©n√©rateur de nombres pseudo-al√©atoires le plus rapide au monde</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/498352/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/5p/ex/bl/5pexblhd_seedlgm8iidkfktef4.jpeg" width="400"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a six mois, je voulais cr√©er le meilleur g√©n√©rateur de nombres pseudo-al√©atoires (PRNG) avec une architecture inhabituelle. Je pensais que le d√©but serait facile et que vous travaillez, la t√¢che deviendra lentement plus complexe. Et j'ai pens√© que si je pouvais tout apprendre assez rapidement pour faire face aux plus difficiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ma grande surprise, la complexit√© n'a pas augment√© de fa√ßon lin√©aire. Les tests d'octets chi carr√© se sont r√©v√©l√©s tr√®s difficiles! Plus tard, il a √©t√© tout aussi difficile de passer des tests inflexibles. J'ai </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">publi√© les r√©sultats actuels</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour comprendre quelles autres difficult√©s m'attendent. Cependant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le test PractRand a √©chou√© √† ce moment-l√†</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, il a √©t√© tr√®s difficile de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©ussir le test BigCrush</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, il √©tait tr√®s difficile de transf√©rer 32 t√©raoctets de donn√©es lors du passage de PractRand. </font><font style="vertical-align: inherit;">La vitesse est devenue un probl√®me. </font><font style="vertical-align: inherit;">Il ne suffit pas de cr√©er un design qui g√©n√®re dix m√©gaoctets par seconde, car passer PractRand prendrait un mois. </font><font style="vertical-align: inherit;">Mais je dois admettre qu'il </font><font style="vertical-align: inherit;">√©tait tr√®s difficile de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">passer ce test √† une vitesse de gigaoctets par seconde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous montez √† une telle hauteur ... vous voulez savoir si vous pouvez vous rendre √† la fronti√®re de Pareto. </font><font style="vertical-align: inherit;">Vous voulez cr√©er le PRNG le plus rapide au monde, qui passera les tests statistiques les plus complexes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai r√©ussi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article pr√©c√©dent,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j'ai parl√© de ce que j'ai appris pour atteindre mon objectif. </font><font style="vertical-align: inherit;">Et ici, je vais vous dire comment fonctionne l'architecture finale.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objectif</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par l'√©vidence: la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vitesse d√©pend de la plateforme</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Je me suis concentr√© sur l'optimisation de l'architecture x86-64 moderne (processeurs Intel et AMD). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comparer les performances, la m√©trique </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classique est utilis√©e </font><font style="vertical-align: inherit;">: il s'agit du nombre de cycles de processeur d√©pens√©s pour g√©n√©rer un octet. </font><font style="vertical-align: inherit;">Cette m√©trique est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calcul√©e et compar√©e</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans toutes les ≈ìuvres cryptographiques. </font><font style="vertical-align: inherit;">Un cpb l√©g√®rement inf√©rieur dans le monde du logiciel ou du mat√©riel peut assurer la victoire dans la comp√©tition ou l'utilisation sur des sites Web √† travers le monde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour am√©liorer cpb, vous pouvez:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rez plus d'octets avec la m√™me quantit√© de travail,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ou faites moins de travail pour g√©n√©rer le m√™me nombre d'octets,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ou parall√©lisez le travail.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ferons tout ce qui pr√©c√®de. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon le premier point, nous devons produire plus de bits √† chaque it√©ration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'avais peur qu'on me dise: "S'il ne donne pas de num√©ros 32 bits, alors ce n'est pas le DSRP", ou la m√™me chose avec des num√©ros 64 bits. Ou: "Le PRNG ne devrait √™tre que pour l'architecture x86-64", comme si les instructions comme POPCNT ou les registres comme% xmm7 √©taient interdits.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, le PRNG est une ing√©nierie: les g√©n√©rateurs tentent depuis plusieurs d√©cennies de tirer tout ce qui est possible des processeurs! Lorsque ROL est apparu, ils ont commenc√© √† compter sur lui. Avec l'av√®nement des processeurs 64 bits, ils ont commenc√© √† s'appuyer sur% rax. Bien s√ªr, sur ARM, ces algorithmes peuvent fonctionner plus lentement (bien que cela reste √† voir), cependant, les PRN 64 bits √©taient activement utilis√©s avant m√™me que Android ne commence √† n√©cessiter la prise en charge du 64 bits en 2019! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, ce domaine se d√©veloppe avec le mat√©riel. Et aujourd'hui, les processeurs Intel et AMD dus √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AVX2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prennent d√©j√† en charge les op√©rations 256 bits. RC4 a produit 1 octet, drand48 pourrait produire 4 octets √† la fois, pcg64 - 8 octets, et maintenant nous pouvons imm√©diatement g√©n√©rer 32 octets.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8 octets peuvent √™tre un nombre 64 bits, et la plupart des langages de programmation ont des types int√©gr√©s pour cela. </font><font style="vertical-align: inherit;">Mais peu de langues fournissent des types pour 16 octets (une exception notable est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__uint128_t</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en C). </font><font style="vertical-align: inherit;">Encore moins de langues ont du type pour 32 octets (sauf internes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut donc dire adieu au prototype habituel de la fonction PRNG (exemple du benchmark Vigny </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HWD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="plaintext hljs">static uint64_t next(void);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lieu de cela, vous pouvez cr√©er un g√©n√©rateur qui remplit le tampon (exemple de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mon benchmark</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="plaintext hljs">void prng_gen(prng_state *s, __uint64_t buf[], __uint64_t size);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quels sont les inconv√©nients de cette solution? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si votre g√©n√©rateur produit 32 octets √† la fois, vous devez fournir au consommateur un tableau qui est un multiple de 32 (id√©alement align√© sur 32 octets). </font><font style="vertical-align: inherit;">Bien que vous puissiez vous en passer, nous allons simplement remplir le tampon. </font><font style="vertical-align: inherit;">Nous allons supprimer les donn√©es inutilis√©es et les remplir √† nouveau si n√©cessaire. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le d√©lai</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devient impr√©visible: certains appels ne feront que lire le tampon. </font><font style="vertical-align: inherit;">Mais en moyenne, tout sera pareil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous g√©n√©rons maintenant plus d'octets, effectuant la m√™me quantit√© de travail. </font><font style="vertical-align: inherit;">Comment la parall√©lisons-nous?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parall√©lisme</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les processeurs offrent un ensemble incroyable d'outils de parall√©lisation √† tous les niveaux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, ce sont des instructions SIMD (Single-Instruction, Multiple Data). Par exemple, AVX2 effectue simultan√©ment quatre ajouts 64 bits, ou huit ajouts 32 bits, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est utilis√© en cryptographie depuis une quinzaine d'ann√©es. La concurrence a fourni les performances incroyables du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ChaCha20</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il est utilis√© par les primitives les plus importantes qui n'utilisent pas AESNI. Par exemple, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NORX</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gimli sont</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con√ßus avec le parall√©lisme √† l'esprit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©cemment, l'int√©r√™t pour ce sujet a √©galement augment√© dans la communaut√© PRNG non cryptographique. En particulier, les primitives existantes qui n'ont pas √©t√© con√ßues pour SIMD peuvent √™tre √† la base de la cr√©ation de PRN tr√®s rapides.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque Sebastiano Vigna a fait la promotion de son architecture </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xoshiro256 ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la biblioth√®que standard Julia, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il a d√©couvert</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que les r√©sultats de huit instances PRNG comp√©titives et initialis√©es diff√©remment peuvent √™tre concat√©n√©es tr√®s rapidement si chaque op√©ration est effectu√©e simultan√©ment dans tous les PRNR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SIMD n'est qu'un des niveaux de parall√©lisation du processeur. Je recommande de lire l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article pr√©c√©dent sur ce sujet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> afin d'avoir une meilleure id√©e, mais je vais donner quelques explications. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les pipelines de processeurs</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permettent de traiter plusieurs instructions √† diff√©rentes √©tapes. Si vous organisez bien l'ordre de leur ex√©cution afin de r√©duire les d√©pendances entre les √©tapes, vous pouvez acc√©l√©rer le traitement des instructions.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'ex√©cution superscalaire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous permet de traiter simultan√©ment les parties informatiques des instructions. </font><font style="vertical-align: inherit;">Mais pour cela, ils ne devraient pas avoir de d√©pendances en lecture-√©criture. </font><font style="vertical-align: inherit;">Vous pouvez adapter l'architecture pour r√©duire le risque de temps d'arr√™t en enregistrant bien avant la lecture. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une ex√©cution extraordinaire</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet au processeur d'ex√©cuter des instructions non pas dans l'ordre de s√©quence, mais lorsqu'elles sont pr√™tes, m√™me si les instructions pr√©c√©dentes ne sont pas encore pr√™tes. </font><font style="vertical-align: inherit;">Mais pour cela, il ne devrait pas y avoir de d√©pendance en lecture-√©criture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous passons √† la mise en ≈ìuvre!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rons un sch√©ma appel√© semi-SHISHUA. </font><font style="vertical-align: inherit;">La provenance d'un tel nom deviendra progressivement apparente √† mesure que vous lirez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le sch√©ma ressemble √† ceci:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bd8/df1/b8f/bd8df1b8fcfae4897eb4b74f2c6e856f.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rez sa ligne par ligne.</font></font><br>
<br>
<pre><code class="plaintext hljs">typedef struct prng_state {<font></font>
  __m256i state[2];<font></font>
  __m256i output;<font></font>
  __m256i counter;<font></font>
} prng_state;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'√©tat est divis√© en deux parties, qui sont plac√©es dans le registre AVX2 (256 bits). Pour augmenter la vitesse, nous gardons le r√©sultat proche de l'√©tat lui-m√™me, mais il ne fait pas partie de l'√©tat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons √©galement un compteur 64 bits. Pour simplifier le calcul, c'est aussi un registre AVX2. Le fait est que AVX2 a une petite fonctionnalit√©: les registres ordinaires (% rax et similaires) ne peuvent pas √™tre transf√©r√©s directement vers SIMD via MOV, ils doivent passer par la RAM (le plus souvent via la pile), ce qui augmente le d√©lai et co√ªte deux instructions de processeur (MOV sur la pile, VMOV de la pile). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant la g√©n√©ration. Commen√ßons par charger, puis parcourons le tampon et remplissons-le avec 32 octets √† chaque it√©ration.</font></font><br>
<br>
<pre><code class="plaintext hljs">inline void prng_gen(prng_state *s, __uint64_t buf[], __uint64_t size) {<font></font>
  __m256i s0 = s-&gt;state[0], counter = s-&gt;counter,<font></font>
          s1 = s-&gt;state[1],       o = s-&gt;output;<font></font>
  for (__uint64_t i = 0; i &lt; size; i += 4) {<font></font>
    _mm256_storeu_si256((__m256i*)&amp;buf[i], o);<font></font>
    // ‚Ä¶<font></font>
  }<font></font>
  s-&gt;state[0] = s0; s-&gt;counter = counter;<font></font>
  s-&gt;state[1] = s1; s-&gt;output  = o;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque la fonction est en ligne, le remplissage imm√©diat du tampon au d√©marrage permet au processeur d'ex√©cuter imm√©diatement les instructions en fonction de cela gr√¢ce √† un m√©canisme d'ex√©cution extraordinaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä l'int√©rieur de la boucle, nous effectuons rapidement trois op√©rations d'√©tat:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ft</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHU</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ffle</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dd</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'o√π le nom SHISHUA!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premier quart de travail</font></font></h3><br>
<pre><code class="plaintext hljs">u0 = _mm256_srli_epi64(s0, 1);              u1 = _mm256_srli_epi64(s1, 3);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, l'AVX2 ne prend pas en charge les r√©volutions. </font><font style="vertical-align: inherit;">Mais je veux m√©langer les bits d'une position dans un nombre 64 bits avec les bits d'une autre position! </font><font style="vertical-align: inherit;">Et le changement est le meilleur moyen de r√©aliser cela. </font><font style="vertical-align: inherit;">Nous allons d√©caler d'un nombre impair, de sorte que chaque bit visite toutes les positions 64 bits, et non la moiti√© d'entre elles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendant le quart de travail, des bits sont perdus, ce qui entra√Æne la suppression d'informations de notre √©tat. </font><font style="vertical-align: inherit;">C'est mauvais, vous devez minimiser les pertes. </font><font style="vertical-align: inherit;">Les plus petits nombres impairs sont 1 et 3, nous utiliserons diff√©rentes valeurs de d√©calage pour augmenter l'√©cart entre les deux parties. </font><font style="vertical-align: inherit;">Cela aidera √† r√©duire la similitude de leur auto-corr√©lation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons d√©placer vers la droite, car les bits les plus √† droite ont la diffusion la plus faible lors de l'addition: par exemple, le bit le moins significatif dans A + B est juste le XOR des bits les moins significatifs A et B.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En remuant</font></font></h3><br>
<pre><code class="plaintext hljs">t0 = _mm256_permutevar8x32_epi32(s0, shu0); t1 = _mm256_permutevar8x32_epi32(s1, shu1);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utiliserons le mixage 32 bits, car cela donne une granularit√© diff√©rente par rapport aux op√©rations 64 bits que nous utilisons partout (l'alignement 64 bits est viol√©). Il peut √©galement s'agir d'une op√©ration transversale: d'autres shuffles peuvent d√©placer des bits dans les 128 bits √† gauche s'ils commencent √† gauche, ou dans les 128 bits √† droite s'ils commencent √† droite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√©lange de constantes:</font></font><br>
<br>
<pre><code class="plaintext hljs">__m256i shu0 = _mm256_set_epi32(4, 3, 2, 1, 0, 7, 6, 5),<font></font>
        shu1 = _mm256_set_epi32(2, 1, 0, 7, 6, 5, 4, 3);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que le m√©lange am√©liore vraiment le r√©sultat, nous d√©placerons les parties 32 bits faibles (faible dispersion) des ajouts 64 bits vers des positions fortes, de sorte que les ajouts suivants les enrichissent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La partie 32 bits bas de gamme du bloc 64 bits ne se d√©place jamais vers le m√™me bloc 64 bits que la partie d'ordre sup√©rieur. </font><font style="vertical-align: inherit;">Ainsi, les deux parties ne restent pas dans le m√™me morceau, ce qui am√©liore le m√©lange. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au final, chaque partie 32 bits passe par toutes les positions d'un cercle: de A √† B, de B √† C, ... de H √† A. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous avez peut-√™tre remarqu√© que le mixage le plus simple qui prend en compte toutes ces exigences est deux 256 bits chiffre d'affaires (tours de 96 bits et 160 bits √† droite, respectivement).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une addition</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutons des morceaux 64 bits √† partir de deux variables temporaires - d√©calage et mixage.</font></font><br>
<br>
<pre><code class="plaintext hljs">s0 = _mm256_add_epi64(t0, u0);              s1 = _mm256_add_epi64(t1, u1);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'addition est la principale source de dispersion: dans cette op√©ration, les bits sont combin√©s en combinaisons irr√©ductibles d'expressions XOR et AND r√©parties sur des positions 64 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le stockage du r√©sultat de l'addition dans un √©tat pr√©serve durablement cette dispersion.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonction de sortie</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'o√π tirons-nous la sortie? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est simple: la structure que nous avons cr√©√©e nous permet de g√©n√©rer deux parties ind√©pendantes de l'√©tat s0 et s1, qui ne s'affectent en aucune fa√ßon. </font><font style="vertical-align: inherit;">Appliquez XOR sur eux et obtenez un r√©sultat compl√®tement al√©atoire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour renforcer l'ind√©pendance entre les donn√©es auxquelles nous appliquons XOR, nous prenons un r√©sultat partiel: la partie d√©cal√©e d'un √©tat et la partie mixte d'un autre.</font></font><br>
<br>
<pre><code class="plaintext hljs">o = _mm256_xor_si256(u0, t1);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela revient √† r√©duire les d√©pendances en lecture-√©criture entre les instructions d'un processeur superscalaire, comme si u0 et t1 √©taient pr√™ts √† lire en s0 et s1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, discutez du compteur. Nous le traitons au d√©but du cycle. Tout d'abord, modifiez l'√©tat, puis augmentez la valeur du compteur:</font></font><br>
<br>
<pre><code class="plaintext hljs">s1 = _mm256_add_epi64(s1, counter);<font></font>
counter = _mm256_add_epi64(counter, increment);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi changeons-nous d'abord l'√©tat, puis mettons √† jour le compteur? s1 devient disponible plus t√¥t, ce qui r√©duit la probabilit√© que les instructions suivantes qui le lisent s'arr√™tent dans le pipeline du processeur. De plus, cette s√©quence permet d'√©viter la d√©pendance directe du compteur de lecture-√©criture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous appliquons le compteur √† s1, et non √† s0, car ils affectent tous les deux la sortie de toute fa√ßon, cependant, s1 perd plus de bits en raison du d√©calage, de sorte qu'il l'aide √† ¬´se remettre sur pied¬ª apr√®s le d√©calage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le compteur peut ne pas enregistrer le test PractRand. Son seul objectif est de fixer une limite inf√©rieure de 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">69</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">octets = 512 exbibytes pour la p√©riode PRNG: on ne recommence le cycle qu'apr√®s un mill√©naire de travail √† une vitesse de 10 gibytes par seconde. Il est peu probable qu'il soit trop lent pour une utilisation pratique dans les si√®cles √† venir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incr√©ment:</font></font><br>
<br>
<pre><code class="plaintext hljs">__m256i increment = _mm256_set_epi64x(1, 3, 5, 7);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les nombres impairs sont s√©lectionn√©s comme incr√©ments, car seuls les nombres premiers de base couvrent tout le cycle du champ fini GF (2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">64</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), et tous les nombres impairs sont premiers de 2. En d'autres termes, si vous incr√©mentez d'un entier pair dans la plage de 0 √† 4, revenant √† 0 apr√®s 4, il s'av√®re que la s√©quence 0-2-0-2- ..., qui ne conduira jamais √† 1 ou 3. Et l'incr√©ment impair passe par tous les entiers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tous les nombres 64 bits en √©tat, nous utiliserons des nombres impairs diff√©rents, ce qui les s√©parera davantage et augmentera l√©g√®rement le m√©lange. </font><font style="vertical-align: inherit;">J'ai choisi les plus petits nombres impairs pour qu'ils n'aient pas l'air magique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est ainsi que la transition d'√©tat et la fonction de sortie fonctionnent. </font><font style="vertical-align: inherit;">Comment les initialiser?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialisation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous initialisons l'√©tat en utilisant les chiffres hexad√©cimaux Œ¶, le nombre irrationnel le moins approxim√© par la fraction.</font></font><br>
<br>
<pre><code class="plaintext hljs">static __uint64_t phi[8] = {<font></font>
  0x9E3779B97F4A7C15, 0xF39CC0605CEDC834, 0x1082276BF3A27251, 0xF86C6A11D0C18E95,<font></font>
  0x2767F0B153D27B7F, 0x0347045B5BF1827F, 0x01886F0928403002, 0xC1D64BA40F335E36,<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenez une graine 256 bits. </font><font style="vertical-align: inherit;">Cela se fait souvent en cryptographie et ne nuit pas au travail des PRNG non cryptographiques:</font></font><br>
<br>
<pre><code class="plaintext hljs">prng_state prng_init(SEEDTYPE seed[4]) {<font></font>
  prng_state s;<font></font>
  // ‚Ä¶<font></font>
  return s;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne voulons pas red√©finir toute la partie de l'√©tat (s0 ou s1) avec ce nombre initial, il suffit d'en affecter la moiti√©. </font><font style="vertical-align: inherit;">De cette fa√ßon, nous √©viterons l'utilisation de nombres initiaux att√©nuants, qui provoquent accidentellement ou intentionnellement un √©tat initial faible connu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous ne modifions pas la moiti√© de chaque √©tat, nous gardons le contr√¥le sur 128 bits d'√©tat. </font><font style="vertical-align: inherit;">Une telle entropie est suffisante pour d√©marrer et maintenir une position forte.</font></font><br>
<br>
<pre><code class="plaintext hljs">s.state[0] = _mm256_set_epi64x(phi[3], phi[2] ^ seed[1], phi[1], phi[0] ^ seed[0]);<font></font>
s.state[1] = _mm256_set_epi64x(phi[7], phi[6] ^ seed[3], phi[5], phi[4] ^ seed[2]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous r√©p√©tons ( </font></font><code>ROUNDS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">plusieurs fois la </font><font style="vertical-align: inherit;">s√©quence suivante:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez les √©tapes ( </font></font><code>STEPS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) des it√©rations SHISHUA.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous attribuons une partie de l'√©tat √† un autre √©tat et l'autre partie √† la sortie.</font></font></li>
</ol><br>
<pre><code class="plaintext hljs">for (char i = 0; i &lt; ROUNDS; i++) {<font></font>
  prng_gen(&amp;s, buf, 4 * STEPS);<font></font>
  s.state[0] = s.state[1];<font></font>
  s.state[1] = s.output;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'attribution d'un r√©sultat de sortie augmente la dispersion des √©tats. </font><font style="vertical-align: inherit;">Lors de l'initialisation, le travail suppl√©mentaire et la corr√©lation des √©tats n'ont pas d'importance, car cette s√©rie d'op√©rations est effectu√©e une seule fois. </font><font style="vertical-align: inherit;">Nous ne nous int√©ressons qu'√† la dispersion lors de l'initialisation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir √©valu√© l'effet sur la corr√©lation des valeurs initiales, j'ai choisi </font></font><code>STEPS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font><font style="vertical-align: inherit;">pour la </font><font style="vertical-align: inherit;">valeur et </font></font><code>ROUNDS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 </font><font style="vertical-align: inherit;">pour </font><font style="vertical-align: inherit;">10. J'ai calcul√© la corr√©lation en calculant les anomalies ¬´inhabituelles¬ª et ¬´suspectes¬ª r√©sultant des outils de contr√¥le qualit√© PRNG dans PractRand.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est difficile de mesurer la vitesse pour plusieurs raisons:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La mesure de l'horloge</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'est peut-√™tre pas suffisamment pr√©cise.</font></font></li>
<li>    <strong></strong>,      , -  ,  -,       .</li>
<li>,        .        <strong></strong>   .</li>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>  </strong></a>:        ,       .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'utilise l'instruction du processeur RDTSC, qui calcule le nombre de cycles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que tout le monde puisse reproduire mes r√©sultats, j'utilise une machine virtuelle bas√©e sur le cloud. Cela ne change pas le niveau des r√©sultats de r√©f√©rence par rapport aux tests locaux. De plus, vous n'avez pas √† acheter le m√™me ordinateur que le mien. Enfin, il existe de nombreuses situations o√π le PRNG est lanc√© dans les nuages. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai choisi Google Cloud Platform N2 (processeur Intel) et N2D (processeur AMD). L'avantage de GCP est qu'il propose des serveurs avec des processeurs des deux fabricants. Dans cet article, nous nous concentrerons sur Intel, mais pour AMD, les r√©sultats seront dans le m√™me ordre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour approfondir le sujet, d√©barrassons-nous d'abord de l'ancien g√©n√©rateur cryptographique RC4. Impossible de parall√©liser le travail, j'ai</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7,5 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (cycles par octet g√©n√©r√©). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ex√©cutons</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un MCG tr√®s populaire et rapide: le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Lehmer128 PRNG</font></a><font style="vertical-align: inherit;"> le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">plus simple</font></a><font style="vertical-align: inherit;"> , qui r√©ussit le test BigCrush, a montr√© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,5 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wow, super! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous ex√©cuterons le dernier d√©veloppement, qui est utilis√© pour les tables de hachage rapides - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wyrand</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,41 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un peu mieux! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certains DSRP ne r√©ussissent pas le test PractRand de 32 t√©raoctets, mais ils fonctionnent tr√®s rapidement. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xoshiro256 +</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'a atteint que 512 m√©gaoctets, mais a montr√© une vitesse tr√®s √©lev√©e: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,34 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre d√©veloppement r√©cent de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RomuTrio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Elle pr√©tend √™tre le PRNG le plus rapide au monde - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,31 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, √ßa suffit. </font><font style="vertical-align: inherit;">Qu'est-ce que le semi-SHISHUA a montr√©? </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,14 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Deux fois plus vite que RomuTrio.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c84/f7a/c9f/c84f7ac9fcbc4d4a7b2400ae552522a4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cool. </font><font style="vertical-align: inherit;">Testez maintenant le g√©n√©rateur cryptographique ChaCha8. </font><font style="vertical-align: inherit;">Il a atteint ... </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,12 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SIMD est une vraie magie! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la communaut√© cryptographique, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce n'√©tait pas une surprise particuli√®re</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">ChaCha8 est extr√™mement facile √† parall√©liser. </font><font style="vertical-align: inherit;">Ceci est juste un compteur bien hach√© dans un √©tat diffus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et vous vous souvenez comment l'√©quipe linguistique de Julia a essay√© de combiner plusieurs instances de l'architecture de Vigny pour cr√©er un PRNG rapide bas√© sur SIMD? </font><font style="vertical-align: inherit;">Regardons leur r√©sultat en utilisant cette technique ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 pi√®ces de Xoshiro256 +</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,09 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Techniquement, mon ordinateur portable pourrait affecter les r√©sultats. Je ne sais pas pourquoi le d√©veloppement de l'√©quipe Julia est plus rapide que ChaCha8 dans GCP, mais plus lent lorsqu'il est test√© localement. Sur ma machine, semi-SHISHUA tourne plus vite que le d√©veloppement de l'√©quipe Julia, mais plus lentement que ChaCha8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est n√©cessaire de vaincre tous les concurrents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous vous demandez probablement d√©j√† pourquoi nous avons appel√© la version pr√©c√©dente du g√©n√©rateur semi-SHISHUA? Parce qu'il s'est av√©r√© facile de doubler la vitesse si vous ex√©cutez deux copies de semi-SHISHUA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semblable √† l'id√©e de la commande Julia, nous initialisons s√©par√©ment deux PRNG (quatre blocs d'un √©tat 256 bits), fournissant alternativement la sortie de leur travail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si nous cr√©ons plus d'√©tats, nous pouvons produire encore plus de donn√©es, en combinant quatre √©tats par paires:</font></font><br>
<br>
<pre><code class="plaintext hljs">o0 = _mm256_xor_si256(u0, t1);<font></font>
o1 = _mm256_xor_si256(u2, t3);<font></font>
o2 = _mm256_xor_si256(s0, s3);<font></font>
o3 = _mm256_xor_si256(s2, s1);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc obtenu SHISHUA, qui a montr√© une vitesse de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,06 cpb</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est deux fois plus rapide que le pr√©c√©dent concurrent le plus rapide au monde qui a r√©ussi le test PractRand de 32 t√©raoctets. </font><font style="vertical-align: inherit;">Le r√©sultat est sur le graphique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense que le d√©veloppement s'est r√©v√©l√© comp√©titif. </font><font style="vertical-align: inherit;">Cela fonctionne encore plus rapidement sur mon ordinateur portable - 0,03 cpb, mais je respecterai mes principes concernant le benchmark. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re que pendant quelques semaines encore mon g√©n√©rateur restera sur le podium des plus rapides du monde (veuillez le faire).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qualit√©</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le g√©n√©rateur passe honn√™tement BigCrush et le test PractRand de 32 t√©raoctets. Et tout cela gr√¢ce √† quatre flux de sortie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les inconv√©nients de l'architecture incluent son </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">irr√©versibilit√©</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cela peut √™tre vu en r√©duisant √† un √©tat 4 bits avec </font></font><code>s0 = [a, b]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>s1 = [c, d]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Avec un d√©calage, nous obtenons </font></font><code>[0, a]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>[0, d]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et en remuant, </font></font><code>[b, c]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>[d, a]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. De nouveaux </font></font><code>s0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©gaux </font></font><code>[b, c] + [0, a] = [b‚äï(a‚àßc), a‚äïc]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais </font></font><code>s1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©gaux </font></font><code>[d, a] + [0, c] = [d‚äï(a‚àßc), a‚äïc]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Si </font></font><code>a = ¬¨c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, alors, </font></font><code>a‚äïc = 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>a‚àßc = 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donc, </font></font><code>s0 = [b, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>s1 = [d, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Autrement dit, nous obtenons deux combinaisons de </font></font><code>a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui nous donnent le m√™me √©tat final. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre cas, ce n'est pas un probl√®me, car le compteur 64 bits fait √©galement partie de l'√©tat. Il s'av√®re que le cycle minimum de 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">71</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">octets (128 octets par transition d'√©tat), ce qui est √† une vitesse de 10 gibytes / sec. </font><font style="vertical-align: inherit;">durera sept mille ans. </font><font style="vertical-align: inherit;">Cela √©quilibre les √©tats perdus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, m√™me malgr√© l'irr√©versibilit√©, la p√©riode de transition moyenne entre les √âtats est de 2 ^ ((256 + 1) √∑ 2). </font><font style="vertical-align: inherit;">Cela donne un cycle moyen de </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 135</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> octets (√† une vitesse de 10 gibytes / sec. Il durera plus d'un billion de fois plus longtemps que l'univers n'existe). </font><font style="vertical-align: inherit;">M√™me si je crois que les cycles interm√©diaires sont surestim√©s, car ils ne nous disent rien sur la qualit√© du g√©n√©rateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici les r√©sultats de r√©f√©rence:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√©rateur</font></font></strong></th>
<th><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance</font></font></strong></th>
<th><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qualit√©</font></font></strong></th>
<th><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corr√©lation des semences</font></font></strong></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHISHUA</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,06</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; 32 TiB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; 256 Gio</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xoshiro256 + x8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,09</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 Kio</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 Kio</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ChaCha8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,12</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; 32 TiB?</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; 32 TiB?</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RomuTrio</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,31</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; 32 TiB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 Kio</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xoshiro256 +</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,34</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">512 Mio</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 Kio</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wyrand</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; 32 TiB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 Kio</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lehmer128</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,44</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; 32 TiB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 Kio</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RC4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.48</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 TiB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 Kio</font></font></td>
</tr>
</tbody></table></div><br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performances</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : nombre de cycles de processeur pass√©s sur un octet g√©n√©r√©. </font><font style="vertical-align: inherit;">Re√ßu sur les machines cloud N2 GCP et N2D (AMD), la commande est la m√™me.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qualit√©</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : niveau auquel le g√©n√©rateur ne r√©ussit pas le test PractRand. </font><font style="vertical-align: inherit;">S'il n'√©choue pas, il y a un signe&gt;. </font><font style="vertical-align: inherit;">Si le r√©sultat n'est pas prouv√©, il y a un point d'interrogation.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Corr√©lation des nombres de graines</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Travers√©e PractRand avec octets altern√©s de huit flux avec les nombres de graines 0, 1, 2, 4, 8, 16, 32, 64. Nous utilisons PractRand avec une double convolution et des tests avanc√©s.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ea7/3f6/f1d/ea73f6f1db25664622785ba127764dbc.png"></div><br>
</li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plus loin</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que dans notre cas il n'y ait aucun probl√®me d'irr√©versibilit√©, nous pouvons toujours am√©liorer SHISHUA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä mon avis, le PRNG id√©al a les propri√©t√©s suivantes:</font></font><br>
<br>
<ol>
<li><strong>      </strong>,     2<sup>1024</sup>.      10 /.    10<sup>282</sup>  ,   .    ¬´¬ª (  ).              ,       .  ,      128-  NEON   ARM?  ,      ,     .</li>
<li><strong>    </strong>.      ,   SHISHUA  XOR    .     ,     .</li>
<li><strong>  ,</strong>      2<sup>128</sup>    (     ).        SHISHUA,  ,  .  ,      ( )    (, , .  2).</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'initialisation d'√©tat a une dispersion parfaite</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : tous les bits du nombre initial affectent tous les bits de l'√©tat avec la m√™me probabilit√©. </font><font style="vertical-align: inherit;">Je veux en savoir plus sur SHISHUA.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'un des probl√®mes qui freinent le d√©veloppement des PRNG et de la cryptographie dans son ensemble est le manque de meilleurs outils √† usage g√©n√©ral. </font><font style="vertical-align: inherit;">J'ai besoin d'un outil qui puisse me donner imm√©diatement le r√©sultat de mesure exact afin que je puisse comparer diff√©rentes architectures √† la vol√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PractRand est g√©nial par rapport √† ce qu'il √©tait auparavant, cependant:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il ne permet pas d'√©valuer des g√©n√©rateurs de haute qualit√©, ce qui rend impossible leur comparaison les uns avec les autres. </font><font style="vertical-align: inherit;">Nous devons dire: "eh bien, apr√®s 32 t√©raoctets, il n'y a pas d'anomalies ..."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela prend des semaines pour l'ex√©cuter ...</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re que la situation s'am√©liorera consid√©rablement bient√¥t.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498332/index.html">Impl√©mentation d'une architecture de s√©curit√© sans confiance: deuxi√®me √©dition</a></li>
<li><a href="../fr498334/index.html">Comment organiser le processus de planification dans SAP Analytics Cloud</a></li>
<li><a href="../fr498340/index.html">√Ä propos de la nouvelle IDA Home (avis)</a></li>
<li><a href="../fr498346/index.html">GoLand 2020.1 - Prise en charge am√©lior√©e des modules Go, beaucoup de compl√©tion automatique et bien plus encore</a></li>
<li><a href="../fr498350/index.html">Le meilleur mat√©riel pour les entretiens d'embauche et les recherches d'emploi</a></li>
<li><a href="../fr498354/index.html">Comment traduire ¬´liste de souhaits¬ª en ¬´mat√©riel¬ª ou semi-semi-mobile semi-id√©al</a></li>
<li><a href="../fr498358/index.html">Apprenez le fran√ßais ou comment obtenir un adaptateur universel √† partir d'un scanner de diagnostic PSA</a></li>
<li><a href="../fr498360/index.html">√âvaluation des m√©triques de charge du serveur int√©gr√©</a></li>
<li><a href="../fr498362/index.html">Kingston conserve son leadership dans les livraisons de SSD: comment faire?</a></li>
<li><a href="../fr498366/index.html">Quels algorithmes les d√©veloppeurs Yandex impl√©mentent-ils chaque jour</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>